From 9c849f8449cfe141ed0afeb753d20ef07a4f4b9e Mon Sep 17 00:00:00 2001
From: Shan Hai <shan.hai@windriver.com>
Date: Mon, 12 Dec 2011 09:19:40 +0800
Subject: [PATCH] drivers/emgd: fix X window freeze on repeated suspend/resume operations

Inconsistency between ioremap/iounmap operations of EMGD driver causes memory
leak on suspend/resume and further causes froze of X window.

Code snippet from EMGD driver:
ioremap path:
#if !defined(NO_HARDWARE)
	gsPoulsboRegsCPUVaddr = OSMapPhysToLin(ARGUMENT_LIST);

iounmap path:
#if !(defined(NO_HARDWARE) || defined(__linux__))
        OSUnMapPhysToLin(gsPoulsboRegsCPUVaddr, OTHER_ARGUMENTS);

Both the OSMapPhysToLin and OSUnMapPhysToLin are OS independent, so the
defined(__linux__)) in the iounmap path is redundant and erroneous.

Signed-off-by: Shan Hai <shan.hai@windriver.com>
---
 .../emgd/pvr/services4/system/common/sysconfig.c   |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/gpu/drm/emgd/pvr/services4/system/common/sysconfig.c b/drivers/gpu/drm/emgd/pvr/services4/system/common/sysconfig.c
index 4f2f0ab..85abec3 100644
--- a/drivers/gpu/drm/emgd/pvr/services4/system/common/sysconfig.c
+++ b/drivers/gpu/drm/emgd/pvr/services4/system/common/sysconfig.c
@@ -1433,7 +1433,7 @@ static PVRSRV_ERROR SysUnmapRegisters(IMG_VOID)
 		psDeviceNodeList = psDeviceNodeList->psNext;
 	}
 
-#if !(defined(NO_HARDWARE) || defined(__linux__))
+#if !defined(NO_HARDWARE)
 
 	OSUnMapPhysToLin(gsPoulsboRegsCPUVaddr,
 				REG_SIZE,
-- 
1.7.0.4

