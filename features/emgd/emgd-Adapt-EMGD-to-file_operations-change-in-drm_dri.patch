From 6476aff219b7e6af6666fb0bec9860a2482de25a Mon Sep 17 00:00:00 2001
From: Donn Seeley <donn.seeley@windriver.com>
Date: Tue, 12 Jun 2012 10:06:24 -0600
Subject: [PATCH 06/19] emgd: Adapt EMGD to file_operations change in
 drm_driver.

The file_operations structure that was embedded in the drm_driver
structure is now gone, replaced by a pointer to broken-out static const
file_operations structure, as a consequence of this commit:

  commit e08e96de986ceb2c6b683df0bd0c4ddd4f91dcfd
  Author: Arjan van de Ven <arjan@infradead.org>
  Date:   Mon Oct 31 07:28:57 2011 -0700

  drm: Make the per-driver file_operations struct const

There are actually two drm_driver structures in EMGD, and we fixed both
of them.

Signed-off-by: Donn Seeley <donn.seeley@windriver.com>
---
 drivers/gpu/drm/emgd/emgd/drm/emgd_drv.c           |   30 +++++++++++---------
 .../emgd/pvr/services4/srvkm/env/linux/pvr_drm.c   |   22 +++++++-------
 2 files changed, 28 insertions(+), 24 deletions(-)

diff --git a/drivers/gpu/drm/emgd/emgd/drm/emgd_drv.c b/drivers/gpu/drm/emgd/emgd/drm/emgd_drv.c
index 2da7a2e..adc0e07 100644
--- a/drivers/gpu/drm/emgd/emgd/drm/emgd_drv.c
+++ b/drivers/gpu/drm/emgd/emgd/drm/emgd_drv.c
@@ -2352,6 +2352,21 @@ static const struct dev_pm_ops emgd_pm_ops = {
 static struct pci_driver emgd_pci_driver = EMGD_PCI_DRIVER;
 #endif
 
+static const struct file_operations emgd_driver_fops = {
+        .owner   = THIS_MODULE,
+        .open    = drm_open,
+        .release = drm_release,
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,32)
+        .unlocked_ioctl   = drm_ioctl,
+#else
+        .ioctl   = drm_ioctl,
+#endif
+        .mmap    = emgd_mmap,
+        .poll    = drm_poll,
+        .fasync  = drm_fasync,
+        .read    = drm_read,
+};
+
 /**
  * DRM Sub driver entry points
  */
@@ -2379,20 +2394,7 @@ static struct drm_driver driver = {
 	.get_reg_ofs        = drm_core_get_reg_ofs,
 #endif
 	.ioctls             = emgd_ioctl,
-	.fops = {
-		.owner   = THIS_MODULE,
-		.open    = drm_open,
-		.release = drm_release,
-#if LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,32)
-		.unlocked_ioctl   = drm_ioctl,
-#else
-		.ioctl   = drm_ioctl,
-#endif
-		.mmap    = emgd_mmap,
-		.poll    = drm_poll,
-		.fasync  = drm_fasync,
-		.read    = drm_read,
-	},
+	.fops		    = &emgd_driver_fops,
 #if LINUX_VERSION_CODE < KERNEL_VERSION(2,6,38)
 	.pci_driver          = EMGD_PCI_DRIVER,
 #endif
diff --git a/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/pvr_drm.c b/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/pvr_drm.c
index f31f989..62a7c4d 100644
--- a/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/pvr_drm.c
+++ b/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/pvr_drm.c
@@ -238,6 +238,17 @@ struct drm_ioctl_desc sPVRDrmIoctls[] = {
 
 static IMG_INT pvr_max_ioctl = DRM_ARRAY_SIZE(sPVRDrmIoctls);
 
+static const struct file_operations pvr_driver_fops =
+{
+        .owner = THIS_MODULE,
+        .open = drm_open,
+        .release = drm_release,
+        .ioctl = drm_ioctl,
+        .mmap = PVRMMap,
+        .poll = drm_poll,
+        .fasync = drm_fasync,
+};
+
 static struct drm_driver sPVRDrmDriver =
 {
 	.driver_features = 0,
@@ -251,16 +262,7 @@ static struct drm_driver sPVRDrmDriver =
 	.get_map_ofs = drm_core_get_map_ofs,
 	.get_reg_ofs = drm_core_get_reg_ofs,
 	.ioctls = sPVRDrmIoctls,
-	.fops =
-	{
-		.owner = THIS_MODULE,
-		.open = drm_open,
-		.release = drm_release,
-		.ioctl = drm_ioctl,
-		.mmap = PVRMMap,
-		.poll = drm_poll,
-		.fasync = drm_fasync,
-	},
+	.fops = &pvr_driver_fops,
 	.pci_driver =
 	{
 		.name = PVR_DRM_NAME,
-- 
1.7.9.7

