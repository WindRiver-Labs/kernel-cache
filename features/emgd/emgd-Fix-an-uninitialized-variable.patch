From 1c240278c7b8c51885669a28bf8b1e8150e2bf37 Mon Sep 17 00:00:00 2001
From: Donn Seeley <donn.seeley@windriver.com>
Date: Tue, 12 Jun 2012 10:12:53 -0600
Subject: [PATCH 07/19] emgd: Fix an uninitialized variable.

The compiler complained about "'i' may be used uninitialized"
in EMGD's emgd_bc_ts_bridge_uninit() function.  Looks like
someone did a cut-and-paste from emgd_bc_ts_bridge_init() into
emgd_bc_ts_bridge_uninit(), but the context in emgd_bc_ts_bridge_init()
was a loop indexed by 'i'. In emgd_bc_ts_bridge_uninit(), they sleazed
over the problem by declaring 'i', but not initializing it.  The problem
looks real, and I added code to compute the proper value of 'i'.  I have
no idea how to test this fix, but the fix can't be any worse than the
original code.

Signed-off-by: Donn Seeley <donn.seeley@windriver.com>
---
 .../3rdparty/emgd_bufferclass/emgd_bc_linux.c      |    6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/emgd/pvr/services4/3rdparty/emgd_bufferclass/emgd_bc_linux.c b/drivers/gpu/drm/emgd/pvr/services4/3rdparty/emgd_bufferclass/emgd_bc_linux.c
index 567caaf..8180488 100644
--- a/drivers/gpu/drm/emgd/pvr/services4/3rdparty/emgd_bufferclass/emgd_bc_linux.c
+++ b/drivers/gpu/drm/emgd/pvr/services4/3rdparty/emgd_bufferclass/emgd_bc_linux.c
@@ -652,13 +652,17 @@ static __inline int emgd_bc_ts_bridge_uninit(struct drm_device *drv, void* arg,
 	}
 
 	psDevInfo = (BC_DEVINFO *)GetAnchorPtr(psBridge->dev_id);
+	for (i = 0; i < BUFCLASS_DEVICE_MAX_ID; i++)
+		if (bc_video_id[i] == psBridge->dev_id)
+			break;
 
 	/* To disable buffer class device*/
 	emgd_bc_ts_set_state(psDevInfo, 0);	
 
 	if (EMGD_OK == BC_DestroyBuffers((void *)psDevInfo)) {
 		EMGD_DEBUG("Free Device -  %lu", psBridge->dev_id);
-		bc_video_id_usage[i] = 0,
+		if (i < BUFCLASS_DEVICE_MAX_ID)
+			bc_video_id_usage[i] = 0;
 		psBridge->rtn = 0;
 		err = 0;
 	} else {
-- 
1.7.9.7

