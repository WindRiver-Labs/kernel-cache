From da268cac9814865a098f30fff99b4368b0c42c17 Mon Sep 17 00:00:00 2001
From: Liang Li <liang.li@windriver.com>
Date: Thu, 14 Jul 2011 17:41:56 +0800
Subject: [PATCH 1/2] gpu/pvr: minor fixes for EMGD code

o emgd need drm_helper so select it by default

o fix the wrong position of the mutex definition
[
The wrong code piece is #ifdef'd by an undefined MACRO, the MACRO is
for 'debugging purpose', which is not enabled in Makefile. When enable
some debugging MACRO in the Makefile, build error will occur.
]

Signed-off-by: Liang Li <liang.li@windriver.com>
---
 drivers/gpu/drm/Kconfig                            |    1 +
 .../drm/emgd/pvr/services4/srvkm/env/linux/mm.c    |    8 +++-----
 2 files changed, 4 insertions(+), 5 deletions(-)

diff --git a/drivers/gpu/drm/Kconfig b/drivers/gpu/drm/Kconfig
index f623fbb..ce2e118 100644
--- a/drivers/gpu/drm/Kconfig
+++ b/drivers/gpu/drm/Kconfig
@@ -164,6 +164,7 @@ config DRM_SAVAGE
 config DRM_EMGD
        tristate "Intel EMGD"
        depends on DRM
+		select DRM_KMS_HELPER
        help
          Choose this option if you have a system that has support for Intel
          GMA500 CPU based on the PowerVR SGX535 core.  This includes the
diff --git a/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/mm.c b/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/mm.c
index 65912c2..1bdfe00 100644
--- a/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/mm.c
+++ b/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/mm.c
@@ -124,6 +124,9 @@ static off_t printMemoryRecords(IMG_CHAR * buffer, size_t size, off_t off);
 
 #endif
 
+#if defined(DEBUG_LINUX_MEM_AREAS) || defined(DEBUG_LINUX_MEMORY_ALLOCATIONS)
+static struct mutex g_sDebugMutex;
+#endif
 
 #if defined(DEBUG_LINUX_MEM_AREAS)
 typedef struct _DEBUG_LINUX_MEM_AREA_REC
@@ -143,11 +146,6 @@ static IMPLEMENT_LIST_INSERT(DEBUG_LINUX_MEM_AREA_REC)
 static IMPLEMENT_LIST_REMOVE(DEBUG_LINUX_MEM_AREA_REC)
 
 
-
-#if defined(DEBUG_LINUX_MEM_AREAS) || defined(DEBUG_LINUX_MEMORY_ALLOCATIONS)
-static struct mutex g_sDebugMutex;
-#endif
-
 static DEBUG_LINUX_MEM_AREA_REC *g_LinuxMemAreaRecords;
 static IMG_UINT32 g_LinuxMemAreaCount;
 static IMG_UINT32 g_LinuxMemAreaWaterMark;
-- 
1.7.0.2

