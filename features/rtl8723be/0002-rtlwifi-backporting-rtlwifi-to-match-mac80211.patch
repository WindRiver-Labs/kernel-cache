From 12ccf352f761cb28c5234142d09228cc783cd3eb Mon Sep 17 00:00:00 2001
From: Bin Yang <bin.yang@windriver.com>
Date: Wed, 16 Jul 2014 10:29:53 +0800
Subject: [PATCH 3/3] rtlwifi: backporting rtlwifi to match mac80211

the rtlwifi coming with linux 3.16-rc2 does not match against
existing mac80211 subsystem coming with linux 3.4.x.
Backporting the rtlwifi make it compatible with each other.

Signed-off-by: Bin Yang <bin.yang@windriver.com>
---
 drivers/net/wireless/rtlwifi/core.c | 35 +++++++++++++++++++++++++++++++++++
 1 file changed, 35 insertions(+)
 mode change 100644 => 100755 drivers/net/wireless/rtlwifi/core.c

diff --git a/drivers/net/wireless/rtlwifi/core.c b/drivers/net/wireless/rtlwifi/core.c
old mode 100644
new mode 100755
index e320b31..322637f
--- a/drivers/net/wireless/rtlwifi/core.c
+++ b/drivers/net/wireless/rtlwifi/core.c
@@ -1397,10 +1397,41 @@ static void rtl_op_flush(struct ieee80211_hw *hw, struct ieee80211_vif *vif,
 		rtlpriv->intf_ops->flush(hw, drop);
 }
 
+/*
+	back porting wrapper for old mac80211 version
+*/
+#define CONFIG_BACKPORT_FOR_MAC80211
+#ifdef CONFIG_BACKPORT_FOR_MAC80211
+
+static void wrap_rtl_op_tx(struct ieee80211_hw *hw,
+		      struct sk_buff *skb)
+{
+	struct ieee80211_tx_control tx_control;
+	struct ieee80211_tx_info *info = IEEE80211_SKB_CB(skb);
+
+	tx_control.sta = info->control.sta;
+
+	rtl_op_tx(hw, &tx_control, skb);
+}
+
+static void wrap_rtl_op_flush(struct ieee80211_hw *hw,
+			 u32 queues, bool drop)
+{
+	struct ieee80211_vif *vif=NULL;
+	//vif is not used at all
+	rtl_op_flush(hw, vif, queues, drop);
+}
+
+#endif /*CONFIG_BACKPORT_FOR_MAC80211*/
+
 const struct ieee80211_ops rtl_ops = {
 	.start = rtl_op_start,
 	.stop = rtl_op_stop,
+#ifdef CONFIG_BACKPORT_FOR_MAC80211
+	.tx = wrap_rtl_op_tx,
+#else
 	.tx = rtl_op_tx,
+#endif
 	.add_interface = rtl_op_add_interface,
 	.remove_interface = rtl_op_remove_interface,
 	.change_interface = rtl_op_change_interface,
@@ -1419,6 +1450,10 @@ const struct ieee80211_ops rtl_ops = {
 	.sw_scan_start = rtl_op_sw_scan_start,
 	.sw_scan_complete = rtl_op_sw_scan_complete,
 	.rfkill_poll = rtl_op_rfkill_poll,
+#ifdef CONFIG_BACKPORT_FOR_MAC80211
+	.flush = wrap_rtl_op_flush,
+#else
 	.flush = rtl_op_flush,
+#endif
 };
 EXPORT_SYMBOL_GPL(rtl_ops);
-- 
1.8.2.1

