From c96b78711cd006780fe2159669986865b4fe0e9d Mon Sep 17 00:00:00 2001
From: Hui Wang <Hui.Wang@windriver.com>
Date: Wed, 13 Apr 2011 11:39:15 +0800
Subject: [PATCH 4/4] gpu/pvr: fix several building problems

One of source file includes a non-existing header file, so fix it.

Original driver only can work as kernel module, so modify it and
make it can work as built-in driver.

Signed-off-by: Hui Wang <Hui.Wang@windriver.com>
---
 drivers/gpu/pvr/module.c                |   17 +++++++++--------
 drivers/gpu/pvr/omap3/sysutils_linux.c  |    2 +-
 drivers/gpu/pvr/omaplfb/omaplfb_linux.c |   14 +++++++-------
 3 files changed, 17 insertions(+), 16 deletions(-)

diff --git a/drivers/gpu/pvr/module.c b/drivers/gpu/pvr/module.c
index df1b49f..7e717a4 100644
--- a/drivers/gpu/pvr/module.c
+++ b/drivers/gpu/pvr/module.c
@@ -201,8 +201,9 @@ static LDM_DRV powervr_driver = {
 
 LDM_DEV *gpsPVRLDMDev;
 
-#if defined(MODULE) && defined(PVR_LDM_PLATFORM_MODULE)
-
+/* #if defined(MODULE) && defined(PVR_LDM_PLATFORM_MODULE),
+   we need it to work as built-in */
+#if defined(PVR_LDM_PLATFORM_MODULE)
 static IMG_VOID PVRSRVDeviceRelease(struct device unref__ *pDevice)
 {
 }
@@ -544,7 +545,7 @@ static int __init PVRCore_Init(IMG_VOID)
 		goto init_failed;
 	}
 
-#if defined(MODULE)
+/* #if defined(MODULE), we need it to work as built-in */
 	if ((error = platform_device_register(&powervr_device)) != 0)
 	{
 		platform_driver_unregister(&powervr_driver);
@@ -553,7 +554,7 @@ static int __init PVRCore_Init(IMG_VOID)
 
 		goto init_failed;
 	}
-#endif
+/* #endif */
 #endif 
 
 #if defined(PVR_LDM_PCI_MODULE)
@@ -636,9 +637,9 @@ sys_deinit:
 #endif
 
 #if defined (PVR_LDM_PLATFORM_MODULE)
-#if defined (MODULE)
+/* #if defined (MODULE), we need it to work as built-in */
 	platform_device_unregister(&powervr_device);
-#endif
+/* #endif */
 	platform_driver_unregister(&powervr_driver);
 #endif
 
@@ -705,9 +706,9 @@ static void __exit PVRCore_Cleanup(void)
 #endif
 
 #if defined (PVR_LDM_PLATFORM_MODULE)
-#if defined (MODULE)
+/* #if defined (MODULE), we need it to work as built-in */
 	platform_device_unregister(&powervr_device);
-#endif
+/* #endif */
 	platform_driver_unregister(&powervr_driver);
 #endif
 
diff --git a/drivers/gpu/pvr/omap3/sysutils_linux.c b/drivers/gpu/pvr/omap3/sysutils_linux.c
index bfb359b..43638e3 100644
--- a/drivers/gpu/pvr/omap3/sysutils_linux.c
+++ b/drivers/gpu/pvr/omap3/sysutils_linux.c
@@ -34,7 +34,7 @@
 #if (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,26))
 #include <linux/semaphore.h>
 #if (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,31))
-#include <plat/resource.h>
+/* #include <plat/resource.h>, kernel doesn't have this file */
 #else 
 #include <mach/resource.h>
 #endif 
diff --git a/drivers/gpu/pvr/omaplfb/omaplfb_linux.c b/drivers/gpu/pvr/omaplfb/omaplfb_linux.c
index fa52836..16ad0cb 100755
--- a/drivers/gpu/pvr/omaplfb/omaplfb_linux.c
+++ b/drivers/gpu/pvr/omaplfb/omaplfb_linux.c
@@ -358,7 +358,7 @@ static struct platform_driver omaplfb_driver = {
 	.shutdown	= OMAPLFBDriverShutdown_Entry,
 };
 
-#if defined(MODULE)
+/* #if defined(MODULE), we need it to work as built-in */
 
 static void OMAPLFBDeviceRelease_Entry(struct device unref__ *pDevice)
 {
@@ -375,7 +375,7 @@ static struct platform_device omaplfb_device = {
 	}
 };
 
-#endif  
+/* #endif */
 
 #endif	
 
@@ -399,7 +399,7 @@ static int __init OMAPLFB_Init(void)
 		goto ExitDeinit;
 	}
 
-#if defined(MODULE)
+/* #if defined(MODULE), we need it to work as built-in */
 	if ((error = platform_device_register(&omaplfb_device)) != 0)
 	{
 		platform_driver_unregister(&omaplfb_driver);
@@ -408,7 +408,7 @@ static int __init OMAPLFB_Init(void)
 
 		goto ExitDeinit;
 	}
-#endif
+/* #endif */
 
 #endif 
 
@@ -428,9 +428,9 @@ ExitDeinit:
 static IMG_VOID __exit OMAPLFB_Cleanup(IMG_VOID)
 {    
 #if defined (LDM_PLATFORM)
-#if defined (MODULE)
+/* #if defined (MODULE), we need it to work as built-in */
 	platform_device_unregister(&omaplfb_device);
-#endif
+/* #endif */
 	platform_driver_unregister(&omaplfb_driver);
 #endif
 
@@ -440,6 +440,6 @@ static IMG_VOID __exit OMAPLFB_Cleanup(IMG_VOID)
 	}
 }
 
-module_init(OMAPLFB_Init);
+late_initcall(OMAPLFB_Init);
 module_exit(OMAPLFB_Cleanup);
 
-- 
1.7.0.4

