From 629dff5f5cc650876c8e11bc0ec89c73d271ee45 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Wed, 19 Oct 2011 10:53:30 +0800
Subject: [PATCH] kernel/trace: add register/unregister_trace_clock for ftrace startup test

Trace clock should be registered when tracer do selftest, otherwise some
tracers fail to pass selftest and those tracers also can't work after that.

Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 kernel/trace/trace.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/kernel/trace/trace.c b/kernel/trace/trace.c
index 99d5885..d5a1907 100644
--- a/kernel/trace/trace.c
+++ b/kernel/trace/trace.c
@@ -768,7 +768,9 @@ __acquires(kernel_lock)
 		current_trace = type;
 		/* the test is responsible for initializing and enabling */
 		pr_info("Testing tracer %s: ", type->name);
+		register_trace_clock();
 		ret = type->selftest(type, tr);
+		unregister_trace_clock();
 		/* the test is responsible for resetting too */
 		current_trace = saved_tracer;
 		if (ret) {
-- 
1.7.0.4

