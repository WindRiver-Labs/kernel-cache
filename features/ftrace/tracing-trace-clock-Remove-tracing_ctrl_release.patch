From 61416bcaf0e8a2aa6615a07ff8cffb6ce7b33b7a Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Sun, 26 Sep 2010 07:29:49 -0700
Subject: [PATCH 1/2] tracing/trace-clock: Remove tracing_ctrl_release

The commit "tracing/ftrace: Fixes the trace_clock_local() for the boards
who use the jiffies based sched_clock()" used tracing_ctrl_release() to
release the trace clock for Lttng, but this function will be called when
tracing/tracing_enabled is closed, after enabling the tracer with the
following command:

$ echo 1 > /path/to/tracing/tracing_enabled

The trace clock will be released, as a result, the tracing will get the
low resolution timestamp and the user-space Ftrace will not benefit from
trace-clock-32-to-64.

For the selftests, because they don't open and close
tracing/tracing_enabled, so, tracing_ctrl_release() will not be executed
and the trace clock will not be released, so, no problem with selftests.

To release the trace clock for Lttng, we have only one method, that is,
switch to the nop tracer to remove all of the tracers from tracing, it
will unregister all of the tracers, therefore the
unregister_trace_clock() will be called and the trace clock will be
released.

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 kernel/trace/trace.c |    9 ---------
 1 files changed, 0 insertions(+), 9 deletions(-)

diff --git a/kernel/trace/trace.c b/kernel/trace/trace.c
index 375ac4a..45851e4 100644
--- a/kernel/trace/trace.c
+++ b/kernel/trace/trace.c
@@ -2711,14 +2711,6 @@ tracing_ctrl_write(struct file *filp, const char __user *ubuf,
 	return cnt;
 }
 
-static int tracing_ctrl_release(struct inode *inode, struct file *file)
-{
-	/* Release the trace clock when the debugfs is umounted */
-	unregister_trace_clock();
-
-	return 0;
-}
-
 static ssize_t
 tracing_set_trace_read(struct file *filp, char __user *ubuf,
 		       size_t cnt, loff_t *ppos)
@@ -3550,7 +3542,6 @@ static const struct file_operations tracing_ctrl_fops = {
 	.open		= tracing_open_generic,
 	.read		= tracing_ctrl_read,
 	.write		= tracing_ctrl_write,
-	.release	= tracing_ctrl_release,
 };
 
 static const struct file_operations set_tracer_fops = {
-- 
1.6.5.2

