From 4bdd593c0a91938d0ded4d3aefdcc8510f2321dd Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Thu, 30 Sep 2010 03:26:17 -0700
Subject: [PATCH 2/4] tracing/trace-clock: add trace_clock_read64_ns() for all of the tracers

Before, {register, unregister}_trace_clock() has only been called in
{register, unregister}_ftrace_function(). Since {register,
unregister}_ftrace_function() are not called for all of the tracers, the
other tracers will not benefit from trace_clock_read64_ns().

As we know, all of the tracers should be enabled/disabled by
tracing_{start, stop}, so, calling {register, unregister}_trace_clock()
in tracing_{start, stop} will make all of the tracers uses
trace_clock_read64_ns().

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 kernel/trace/ftrace.c |    2 --
 kernel/trace/trace.c  |    4 ++++
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/kernel/trace/ftrace.c b/kernel/trace/ftrace.c
index 3db9a9b..7b0d0ad 100644
--- a/kernel/trace/ftrace.c
+++ b/kernel/trace/ftrace.c
@@ -3101,7 +3101,6 @@ int register_ftrace_function(struct ftrace_ops *ops)
 	mutex_lock(&ftrace_lock);
 
 	ret = __register_ftrace_function(ops);
-	register_trace_clock();
 	ftrace_startup(0);
 
 	mutex_unlock(&ftrace_lock);
@@ -3121,7 +3120,6 @@ int unregister_ftrace_function(struct ftrace_ops *ops)
 	mutex_lock(&ftrace_lock);
 	ret = __unregister_ftrace_function(ops);
 	ftrace_shutdown(0);
-	unregister_trace_clock();
 	mutex_unlock(&ftrace_lock);
 
 	return ret;
diff --git a/kernel/trace/trace.c b/kernel/trace/trace.c
index 45851e4..2103acc 100644
--- a/kernel/trace/trace.c
+++ b/kernel/trace/trace.c
@@ -937,6 +937,8 @@ void tracing_start(void)
 	if (tracing_disabled)
 		return;
 
+	register_trace_clock();
+
 	spin_lock_irqsave(&tracing_start_lock, flags);
 	if (--trace_stop_count) {
 		if (trace_stop_count < 0) {
@@ -996,6 +998,8 @@ void tracing_stop(void)
 
  out:
 	spin_unlock_irqrestore(&tracing_start_lock, flags);
+
+	unregister_trace_clock();
 }
 
 void trace_stop_cmdline_recording(void);
-- 
1.6.5.2

