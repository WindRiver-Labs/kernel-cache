From 1c253bfd930a62c241a19a8dc0dc9024ec6f252a Mon Sep 17 00:00:00 2001
From: Brian Cavagnolo <brian@cozybit.com>
Date: Mon, 22 Sep 2008 11:46:49 -0700
Subject: [PATCH] add PPID field to ftrace

This is useful for reconstructing the process tree from task switching samples.

Signed-off-by: Brian Cavagnolo <brian@cozybit.com>
Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>

---
 kernel/trace/trace.c |    7 ++++---
 kernel/trace/trace.h |    1 +
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/kernel/trace/trace.c b/kernel/trace/trace.c
index dcff179..648bfce 100644
--- a/kernel/trace/trace.c
+++ b/kernel/trace/trace.c
@@ -819,6 +819,7 @@ tracing_generic_entry_update(struct trace_entry *entry, unsigned long flags)
 
 	entry->preempt_count	= pc & 0xff;
 	entry->pid		= (tsk) ? tsk->pid : 0;
+	entry->ppid		= (tsk) ? tsk->real_parent->pid : 0;
 	entry->t		= ftrace_now(raw_smp_processor_id());
 	entry->flags = (irqs_disabled_flags(flags) ? TRACE_FLAG_IRQS_OFF : 0) |
 		((pc & HARDIRQ_MASK) ? TRACE_FLAG_HARDIRQ : 0) |
@@ -1343,8 +1344,8 @@ static void print_lat_help_header(struct seq_file *m)
 
 static void print_func_help_header(struct seq_file *m)
 {
-	seq_puts(m, "#           TASK-PID   CPU#    TIMESTAMP  FUNCTION\n");
-	seq_puts(m, "#              | |      |          |         |\n");
+	seq_puts(m, "#           TASK-PID    PPID CPU#    TIMESTAMP  FUNCTION\n");
+	seq_puts(m, "#              | |         |  |          |         |\n");
 }
 
 
@@ -1573,7 +1574,7 @@ static int print_trace_fmt(struct trace_iterator *iter)
 	usec_rem = do_div(t, 1000000ULL);
 	secs = (unsigned long)t;
 
-	ret = trace_seq_printf(s, "%16s-%-5d ", comm, entry->pid);
+	ret = trace_seq_printf(s, "%16s-%-5d %5d ", comm, entry->pid, entry->ppid);
 	if (!ret)
 		return 0;
 	ret = trace_seq_printf(s, "[%02d] ", iter->cpu);
diff --git a/kernel/trace/trace.h b/kernel/trace/trace.h
index f69f867..9506845 100644
--- a/kernel/trace/trace.h
+++ b/kernel/trace/trace.h
@@ -72,6 +72,7 @@ struct trace_entry {
 	char			flags;
 	char			preempt_count;
 	int			pid;
+	int			ppid;
 	cycle_t			t;
 	union {
 		struct ftrace_entry		fn;
-- 
1.5.5.1

