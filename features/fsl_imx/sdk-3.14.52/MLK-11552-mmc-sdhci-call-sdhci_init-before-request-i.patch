From 75bbb8863ceea1fb5e810eb04c1c7c83a6bd7eca Mon Sep 17 00:00:00 2001
From: Haibo Chen <haibo.chen@freescale.com>
Date: Tue, 15 Sep 2015 15:25:12 +0800
Subject: [PATCH 1094/1221] MLK-11552 mmc: sdhci: call sdhci_init() before
 request irq in sd resume

In sdhci_init(), all irqs will be cleared, and then set the needed irqs.
So sdhci_init() should be called before request irq.

If not, some irqs may be triggled wrongly. For example, in i.MX7D LPSR
mode, when system resume, the reset value of register INT_SIGNAL_EN is
not zero, bit 8 is 1, which means SDIO card interrupt enable. And in this
case, the card still has no voltage supply, so the Data3 pin is low,
which always trigger the sd controller rise interrupt. Due to we already
request the irq, so system will always try to do the irq service, and has
no response to other event.

So this patch make sure only set the needed irqs before request irq.

Signed-off-by: Haibo Chen <haibo.chen@freescale.com>
[zou:Original patch taken from
git.freescale.com/imx/fsl-arm-yocto-bsp.git-b imx-3.14.52-1.1.0_ga]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/mmc/host/sdhci.c |   20 ++++++++++----------
 1 files changed, 10 insertions(+), 10 deletions(-)

diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.c
index 9f367fd..132e8e4 100644
--- a/drivers/mmc/host/sdhci.c
+++ b/drivers/mmc/host/sdhci.c
@@ -2698,16 +2698,6 @@ int sdhci_resume_host(struct sdhci_host *host)
 			host->ops->enable_dma(host);
 	}
 
-	if (!device_may_wakeup(mmc_dev(host->mmc))) {
-		ret = request_irq(host->irq, sdhci_irq, IRQF_SHARED,
-				  mmc_hostname(host->mmc), host);
-		if (ret)
-			return ret;
-	} else {
-		sdhci_disable_irq_wakeups(host);
-		disable_irq_wake(host->irq);
-	}
-
 	if ((host->mmc->pm_flags & MMC_PM_KEEP_POWER) &&
 	    (host->quirks2 & SDHCI_QUIRK2_HOST_OFF_CARD_ON)) {
 		/* Card keeps power but host controller does not */
@@ -2720,6 +2710,16 @@ int sdhci_resume_host(struct sdhci_host *host)
 		mmiowb();
 	}
 
+	if (!device_may_wakeup(mmc_dev(host->mmc))) {
+		ret = request_irq(host->irq, sdhci_irq, IRQF_SHARED,
+				  mmc_hostname(host->mmc), host);
+		if (ret)
+			return ret;
+	} else {
+		sdhci_disable_irq_wakeups(host);
+		disable_irq_wake(host->irq);
+	}
+
 	sdhci_enable_card_detection(host);
 
 	if (host->ops->platform_resume)
-- 
1.7.5.4

