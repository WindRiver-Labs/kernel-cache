From 3e3a963f6566419e299186ca5e889821fbf3d65a Mon Sep 17 00:00:00 2001
From: "Yadi.hu" <yadi.hu@windriver.com>
Date: Sun, 29 May 2016 18:59:17 -0700
Subject: [PATCH] rtc:fix system pm_power_off on rtc driver

After issuing "poweroff" or "shutdown -h 0" commands
the board is reports the following error message:

=====================================
[ BUG: lock held at task exit time! ]
-------------------------------------
halt/634 is exiting with locks still held!
1 lock held by halt/634:
 #0: (reboot_mutex){......}, at: SyS_reboot+0xcc/0x1d0

Before calling do_exit(0), there is a reboot_mutex lock that is taken
in reboot syscall. do_exit() function is , checking for any locks held
by the processor and if yes then it is printing a BUG_ON from
print_held_locks_bug() function along with the locks held information.
Even though the BUG triggers, the system is going to power off because
The hardware has been triggered and We will have already stopped all
other CPUs at this point.

Signed-off-by: Yadi.hu <yadi.hu@windriver.com>
---
 drivers/rtc/rtc-snvs.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/rtc/rtc-snvs.c b/drivers/rtc/rtc-snvs.c
index ede0750..2e242e5 100644
--- a/drivers/rtc/rtc-snvs.c
+++ b/drivers/rtc/rtc-snvs.c
@@ -272,6 +272,8 @@ static void snvs_poweroff(void)
 	 * high by press ONOFF. This is design limitation.
 	 */
 	/* clk_disable(clk_snvs); */
+	local_irq_disable();
+	while (1);
 }
 
 static int snvs_rtc_probe(struct platform_device *pdev)
-- 
1.7.5.4

