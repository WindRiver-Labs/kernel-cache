From df00b232e249c2c13f00963a1e93047f077fdb1c Mon Sep 17 00:00:00 2001
From: Richard Zhu <Richard.Zhu@freescale.com>
Date: Tue, 2 Jun 2015 15:23:59 +0800
Subject: [PATCH 0700/1221] MLK-11016 arm: clk: enable m4 root clk when m4
 core is running

M4 root clk shouldn't be turn off when M4 core is running

Signed-off-by: Richard Zhu <Richard.Zhu@freescale.com>
[zou:Original patch taken from
git.freescale.com/imx/fsl-arm-yocto-bsp.git-b imx-3.14.52-1.1.0_ga]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 arch/arm/mach-imx/clk-imx6sx.c |    3 ++-
 arch/arm/mach-imx/clk-imx7d.c  |    5 +++++
 arch/arm/mach-imx/src.c        |    9 ++++++++-
 3 files changed, 15 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-imx/clk-imx6sx.c b/arch/arm/mach-imx/clk-imx6sx.c
index 185034f..8431576 100644
--- a/arch/arm/mach-imx/clk-imx6sx.c
+++ b/arch/arm/mach-imx/clk-imx6sx.c
@@ -23,6 +23,7 @@
 
 #include "clk.h"
 #include "common.h"
+#include "hardware.h"
 
 #define CCM_CCGR_OFFSET(index)  (index * 2)
 #define CCDR    0x4
@@ -698,7 +699,7 @@ static int __init imx_amp_power_init(void)
 	int i;
 	void __iomem *shared_mem_base;
 
-	if (!imx_src_is_m4_enabled())
+	if (!(imx_src_is_m4_enabled() && cpu_is_imx6sx()))
 		return 0;
 
 	amp_power_mutex = imx_sema4_mutex_create(0, MCC_POWER_SHMEM_NUMBER);
diff --git a/arch/arm/mach-imx/clk-imx7d.c b/arch/arm/mach-imx/clk-imx7d.c
index a0e2a5a..9c55276 100644
--- a/arch/arm/mach-imx/clk-imx7d.c
+++ b/arch/arm/mach-imx/clk-imx7d.c
@@ -879,6 +879,11 @@ static void __init imx7d_clocks_init(struct device_node *ccm_node)
 	for (i = 0; i < ARRAY_SIZE(clks_init_on); i++)
 		clk_prepare_enable(clks[clks_init_on[i]]);
 
+	if (imx_src_is_m4_enabled()) {
+		imx_clk_set_parent(clks[IMX7D_ARM_M4_ROOT_SRC], clks[IMX7D_PLL_SYS_MAIN_240M_CLK]);
+		imx_clk_prepare_enable(clks[IMX7D_ARM_M4_ROOT_CLK]);
+	}
+
 	imx_clk_set_parent(clks[IMX7D_PLL_ARM_MAIN_BYPASS], clks[IMX7D_PLL_ARM_MAIN]);
 	imx_clk_set_parent(clks[IMX7D_PLL_DRAM_MAIN_BYPASS], clks[IMX7D_PLL_DRAM_MAIN]);
 	imx_clk_set_parent(clks[IMX7D_PLL_SYS_MAIN_BYPASS], clks[IMX7D_PLL_SYS_MAIN]);
diff --git a/arch/arm/mach-imx/src.c b/arch/arm/mach-imx/src.c
index 001d31f..a0d5f10 100644
--- a/arch/arm/mach-imx/src.c
+++ b/arch/arm/mach-imx/src.c
@@ -34,6 +34,7 @@
 #define SRC_GPR1_V2			0x074
 #define SRC_A7RCR0			0x004
 #define SRC_A7RCR1			0x008
+#define SRC_M4RCR			0x00C
 
 #define BP_SRC_A7RCR0_A7_CORE_RESET0	0
 #define BP_SRC_A7RCR1_A7_CORE1_ENABLE	1
@@ -167,8 +168,14 @@ void __init imx_src_init(void)
 	src_base = of_iomap(np, 0);
 	WARN_ON(!src_base);
 
-	if (cpu_is_imx7d())
+	if (cpu_is_imx7d()) {
+		val = readl_relaxed(src_base + SRC_M4RCR);
+		if ((val & BIT(3)) == BIT(3))
+			m4_is_enabled = true;
+		else
+			m4_is_enabled = false;
 		return;
+	}
 
 	imx_reset_controller.of_node = np;
 	if (IS_ENABLED(CONFIG_RESET_CONTROLLER))
-- 
1.7.5.4

