From 9b19d0f46bb78e185ece97f8d6a2cf87be38bb95 Mon Sep 17 00:00:00 2001
From: Liu Ying <Ying.Liu@freescale.com>
Date: Thu, 9 Apr 2015 12:43:36 +0800
Subject: [PATCH 0405/1221] MLK-10660-1 video: mxc ipuv3 fb: Fix
 _setup_disp_channel2 bailout in ->set_par

We should uninitialize ipu channel only for !on_the_fly cases in the bail-out
path of _setup_disp_channel2() in ->fb_set_par(), because we should be able to
keep the display path un-touched or un-impacted in the on_the_fly cases even if
we return failure from _setup_display_channel2().

Signed-off-by: Liu Ying <Ying.Liu@freescale.com>
[zou:Original patch taken from
git.freescale.com/imx/fsl-arm-yocto-bsp.git-b imx-3.14.52-1.1.0_ga]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/video/mxc/mxc_ipuv3_fb.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/video/mxc/mxc_ipuv3_fb.c b/drivers/video/mxc/mxc_ipuv3_fb.c
index 73b3e99..9099eee 100644
--- a/drivers/video/mxc/mxc_ipuv3_fb.c
+++ b/drivers/video/mxc/mxc_ipuv3_fb.c
@@ -1315,7 +1315,8 @@ static int mxcfb_set_par(struct fb_info *fbi)
 
 	retval = _setup_disp_channel2(fbi);
 	if (retval) {
-		ipu_uninit_channel(mxc_fbi->ipu, mxc_fbi->ipu_ch);
+		if (!on_the_fly)
+			ipu_uninit_channel(mxc_fbi->ipu, mxc_fbi->ipu_ch);
 		return retval;
 	}
 
-- 
1.7.5.4

