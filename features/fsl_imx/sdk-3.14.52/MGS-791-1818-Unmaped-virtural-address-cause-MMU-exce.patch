From 922ec56cb7895dabf423dfaf8eb4c63045856f54 Mon Sep 17 00:00:00 2001
From: Shawn Xiao <b49994@freescale.com>
Date: Tue, 14 Jul 2015 18:23:44 +0800
Subject: [PATCH 0958/1221] MGS-791 [#1818] Unmaped virtural address cause MMU
 exception

In the original GPU driver, there is no way to map the virtual memory
dynamically. All the MMU table is built on beginning. However, there is
a chance that the system alloc the memory whoes address is beyond the
original MMU table region. When such kind of virtual address is passed
to GPU, there will be MMU excetion because of lacking necessary mapping.

This patch adds the case of gcvFEATURE_MMU in the hardware feature check
function. So that the virtual memory can be mapped dynamically.

Date July 14, 2015

Signed-off-by: Shawn Xiao <b49994@freescale.com>
[zou:Original patch taken from
git.freescale.com/imx/fsl-arm-yocto-bsp.git-b imx-3.14.52-1.1.0_ga]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 .../hal/kernel/arch/gc_hal_kernel_hardware.c       |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/mxc/gpu-viv/hal/kernel/arch/gc_hal_kernel_hardware.c b/drivers/mxc/gpu-viv/hal/kernel/arch/gc_hal_kernel_hardware.c
index c5759a1..d4ff084 100644
--- a/drivers/mxc/gpu-viv/hal/kernel/arch/gc_hal_kernel_hardware.c
+++ b/drivers/mxc/gpu-viv/hal/kernel/arch/gc_hal_kernel_hardware.c
@@ -6994,6 +6994,10 @@ gckHARDWARE_IsFeatureAvailable(
         available = ((((gctUINT32) (Hardware->identity.chipMinorFeatures1)) >> (0 ? 31:31) & ((gctUINT32) ((((1 ? 31:31) - (0 ? 31:31) + 1) == 32) ? ~0 : (~(~0 << ((1 ? 31:31) - (0 ? 31:31) + 1)))))) == (0x1 & ((gctUINT32) ((((1 ? 31:31) - (0 ? 31:31) + 1) == 32) ? ~0 : (~(~0 << ((1 ? 31:31) - (0 ? 31:31) + 1)))))));
         break;
 
+    case gcvFEATURE_MMU:
+        available= ((((gctUINT32) (Hardware->identity.chipMinorFeatures1)) >> (0 ? 28:28) & ((gctUINT32) ((((1 ? 28:28) - (0 ? 28:28) + 1) == 32) ? ~0 : (~(~0 << ((1 ? 28:28) - (0 ? 28:28) + 1)))))) == (0x1 & ((gctUINT32) ((((1 ? 28:28) - (0 ? 28:28) + 1) == 32) ? ~0 : (~(~0 << ((1 ? 28:28) - (0 ? 28:28) + 1)))))));
+	break;
+
     default:
         gcmkFATAL("Invalid feature has been requested.");
         available = gcvFALSE;
-- 
1.7.5.4

