From 2f394dd686486bc3a2e67a00b1cf8c1b457393c0 Mon Sep 17 00:00:00 2001
From: czou <cao.zou@windriver.com>
Date: Fri, 28 Oct 2016 15:47:40 +0800
Subject: [PATCH] crypto: caam - fix memleak in sm_keystore_slot_expor

It fixed the kmemleak as follow:

unreferenced object 0xa91cd180 (size 64):
  comm "swapper/0", pid 1, jiffies 4294938000 (age 168.180s)
  hex dump (first 32 bytes):
    0f 0e 0d 0c 0b 0a 09 08 00 00 00 00 00 00 00 00 ................
    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
  backtrace:
    [<8084cda8>] kmemleak_alloc+0x40/0x74
    [<80142520>] __kmalloc+0x1fc/0x35c
    [<806c4678>] sm_keystore_slot_export+0x60/0x328
    [<806c5248>] caam_sm_example_init+0x5bc/0xa6c
    [<80c17a24>] caam_sm_test_init+0x50/0x60
    [<80009774>] do_one_initcall+0x114/0x1c4
    [<80bc3eb4>] kernel_init_freeable+0x190/0x28c
    [<8084bd60>] kernel_init+0x1c/0xf4
    [<8000f3c8>] ret_from_fork+0x14/0x2c
    [<ffffffff>] 0xffffffff

Signed-off-by: czou <cao.zou@windriver.com>
---
 drivers/crypto/caam/sm_store.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/crypto/caam/sm_store.c b/drivers/crypto/caam/sm_store.c
index 7fa13db..a777663 100644
--- a/drivers/crypto/caam/sm_store.c
+++ b/drivers/crypto/caam/sm_store.c
@@ -971,6 +971,7 @@ out:
 			 DMA_TO_DEVICE);
 	dma_unmap_single(dev, keymod_dma, SECMEM_KEYMOD_LEN, DMA_TO_DEVICE);
 	kfree(decapdesc);
+	kfree(lkeymod);
 
 	return retval;
 }
-- 
1.7.5.4

