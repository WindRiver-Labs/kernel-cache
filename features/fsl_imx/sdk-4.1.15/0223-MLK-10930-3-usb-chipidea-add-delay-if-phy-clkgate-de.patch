From 623f4a5fff09d60c2026083637e504055254e686 Mon Sep 17 00:00:00 2001
From: Li Jun <jun.li@freescale.com>
Date: Wed, 20 May 2015 14:59:23 +0800
Subject: [PATCH 0223/1691] MLK-10930-3 usb: chipidea: add delay if
 phy-clkgate-delay-us property is present

commit 623f4a5fff09d60c2026083637e504055254e686 from
git://git.freescale.com/imx/linux-2.6-imx.git imx_4.1.15_1.0.0_ga

For some platforms, time delay is required between putting PHY into low power
mode and gate PHY clock.

Signed-off-by: Li Jun <jun.li@freescale.com>
(cherry picked from commit ec0f2d7c8198f368d97ef070186c1b3b5a78bbea)
---
 drivers/usb/chipidea/core.c  | 7 +++++++
 include/linux/usb/chipidea.h | 1 +
 2 files changed, 8 insertions(+)

diff --git a/drivers/usb/chipidea/core.c b/drivers/usb/chipidea/core.c
index 494ed4c..4ddedf1 100644
--- a/drivers/usb/chipidea/core.c
+++ b/drivers/usb/chipidea/core.c
@@ -695,6 +695,10 @@ static int ci_get_platdata(struct device *dev,
 		platdata->flags |= CI_HDRC_OVERRIDE_RX_BURST;
 	}
 
+	if (of_find_property(dev->of_node, "phy-clkgate-delay-us", NULL))
+		of_property_read_u32(dev->of_node, "phy-clkgate-delay-us",
+					&platdata->phy_clkgate_delay_us);
+
 	return 0;
 }
 
@@ -1051,6 +1055,9 @@ static void ci_controller_suspend(struct ci_hdrc *ci)
 {
 	disable_irq(ci->irq);
 	ci_hdrc_enter_lpm(ci, true);
+	if (ci->platdata->phy_clkgate_delay_us)
+		usleep_range(ci->platdata->phy_clkgate_delay_us,
+				ci->platdata->phy_clkgate_delay_us + 50);
 	usb_phy_set_suspend(ci->usb_phy, 1);
 	ci->in_lpm = true;
 	enable_irq(ci->irq);
diff --git a/include/linux/usb/chipidea.h b/include/linux/usb/chipidea.h
index e39351f..d74c200 100644
--- a/include/linux/usb/chipidea.h
+++ b/include/linux/usb/chipidea.h
@@ -55,6 +55,7 @@ struct ci_hdrc_platform_data {
 	u32			ahb_burst_config;
 	u32			tx_burst_size;
 	u32			rx_burst_size;
+	u32			phy_clkgate_delay_us;
 };
 
 /* Default offset of capability registers */
-- 
1.9.1

