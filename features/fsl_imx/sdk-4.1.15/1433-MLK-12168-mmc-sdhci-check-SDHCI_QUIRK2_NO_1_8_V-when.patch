From 0aa8f29a4cc251512d65c0c370572d9c58797fe1 Mon Sep 17 00:00:00 2001
From: Dong Aisheng <aisheng.dong@nxp.com>
Date: Thu, 14 Jan 2016 20:33:17 +0800
Subject: [PATCH 1433/1691] MLK-12168 mmc: sdhci: check SDHCI_QUIRK2_NO_1_8_V
 when do voltage switch

commit 0aa8f29a4cc251512d65c0c370572d9c58797fe1 from
git://git.freescale.com/imx/linux-2.6-imx.git imx_4.1.15_1.0.0_ga

Currently when card type supports EXT_CSD_CARD_TYPE_DDR_1_8V which means
can work on DDR mode with either 3.3v IO or 1.8v IO voltage, unlike before,
currently MMC core will first try 1.8v then 3.3v.
And the host driver voltage switch code does not check NO_1_8_V quirk
which may set a wrong 1.8v and causes the card unwork.

Checking 1.8V quirk before setting it to avoid such issue.

Note: This is a quick workaround solution. Directly putting
the quirk check in host layer is not very good. (That quirk is
going to be deprecated) and current MMC core does not support
3.3V DDR mode well, need further restructure later.

Signed-off-by: Dong Aisheng <aisheng.dong@nxp.com>
---
 drivers/mmc/host/sdhci.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.c
index 6ec0e38..afbc8ac 100644
--- a/drivers/mmc/host/sdhci.c
+++ b/drivers/mmc/host/sdhci.c
@@ -1778,6 +1778,9 @@ static int sdhci_do_start_signal_voltage_switch(struct sdhci_host *host,
 
 		return -EAGAIN;
 	case MMC_SIGNAL_VOLTAGE_180:
+		if (host->quirks2 & SDHCI_QUIRK2_NO_1_8_V)
+			return -EIO;
+
 		if (!IS_ERR(mmc->supply.vqmmc)) {
 			ret = regulator_set_voltage(mmc->supply.vqmmc,
 					1700000, 1950000);
-- 
1.9.1

