From 8ef11f8a33282faad8f926d1329d08f75faeb903 Mon Sep 17 00:00:00 2001
From: Limeng <Meng.Li@windriver.com>
Date: Wed, 16 Mar 2016 14:59:20 +0800
Subject: [PATCH 1/2] driver: pci: pci-imx6: reset pcie core when link up fail

If there is no PCIE card inserted into PCIE interface, link up will fail.
In this case, original code will disable clock and regulator of pcie
controller and return -EINVAL from imx6_pcie_start_link() function,
and also cause probe exit exceptionally. Now, if you run kexec, the
second kernel will hang up because enters wrong case and access
pcie controller register without enabling pcie controller clock and
regulator.
So, call imx6_pcie_assert_core_reset() function to reset pcie core
when link up fail, so that the second kernel enters correct case when
initializing pcie controller.

Signed-off-by: Meng Li <Meng.Li@windriver.com>
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/pci/host/pci-imx6.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/pci/host/pci-imx6.c b/drivers/pci/host/pci-imx6.c
index dc4f7a1..85e3a59 100644
--- a/drivers/pci/host/pci-imx6.c
+++ b/drivers/pci/host/pci-imx6.c
@@ -515,6 +515,7 @@ static int imx6_pcie_wait_for_link(struct pcie_port *pp)
 			readl(pp->dbi_base + PCIE_PHY_DEBUG_R1));
 
 		if (!IS_ENABLED(CONFIG_PCI_IMX6_COMPLIANCE_TEST)) {
+			imx6_pcie_assert_core_reset(pp);
 			clk_disable_unprepare(imx6_pcie->pcie);
 			clk_disable_unprepare(imx6_pcie->pcie_bus);
 			clk_disable_unprepare(imx6_pcie->pcie_phy);
-- 
1.7.5.4

