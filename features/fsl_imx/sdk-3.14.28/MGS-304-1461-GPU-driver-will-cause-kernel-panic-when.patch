From 3b8b23bfb4efff5e9a5e004fbd0848801c911244 Mon Sep 17 00:00:00 2001
From: Loren Huang <b02279@freescale.com>
Date: Wed, 26 Nov 2014 11:59:38 +0800
Subject: [PATCH 0987/1543] MGS-304 [#1461]GPU driver will cause kernel panic
 when allocate memory failed

commit f5c8334068d95ac0457d32693a5ede615a0bebf5 from
git://git.freescale.com/imx/linux-2.6-imx.git

-The issue is triggered by suspend/resume test
when doing bonnie++ which will consume lots of
memory.

-The root cause is vivante didn't report the allocation
failure to uplevel correctly which cause the improper
free.

-Correct the free logic to fix this issue.

Date: Nov 26, 2014
Signed-off-by: Loren Huang <b02279@freescale.com>
Acked-by: Jason Liu
Tested-by: Peter Chen
(cherry picked from commit 2378f1c0b48f1c632a96c1e6c1107e2773f34170)
---
 .../gpu-viv/hal/os/linux/kernel/gc_hal_kernel_os.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/mxc/gpu-viv/hal/os/linux/kernel/gc_hal_kernel_os.c b/drivers/mxc/gpu-viv/hal/os/linux/kernel/gc_hal_kernel_os.c
index 5a79ff2..266df4b 100644
--- a/drivers/mxc/gpu-viv/hal/os/linux/kernel/gc_hal_kernel_os.c
+++ b/drivers/mxc/gpu-viv/hal/os/linux/kernel/gc_hal_kernel_os.c
@@ -1787,6 +1787,8 @@ OnError:
         /* Free LINUX_MDL. */
         gcmkVERIFY_OK(_DestroyMdl(mdl));
     }
+    *Physical = gcvNULL;
+    *Bytes = 0;
 
     if (locked)
     {
@@ -3720,6 +3722,7 @@ OnError:
         /* Free the memory. */
         _DestroyMdl(mdl);
     }
+    *Physical = gcvNULL;
 
     /* Return the status. */
     gcmkFOOTER_ARG("Os=0x%X Flag=%x Bytes=%lu", Os, Flag, Bytes);
-- 
1.7.5.4

