From c86fbc5641ba735baf924f7354197a471b38630f Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Fri, 28 Aug 2015 16:24:12 +0800
Subject: [PATCH 3/3] crypto: caam: fix a non-initialization of spin_lock

Since smpriv->kslock is never initialized, so do it to avoid the following:

the code is fine but needs lockdep annotation.
turning off the locking correctness validator.
CPU: 0 PID: 1 Comm: swapper/0 Not tainted 3.14.39ltsi-WR7.0.0.0_preempt-rt+ #306
[<80017e50>] (unwind_backtrace) from [<80012a38>] (show_stack+0x20/0x24)
[<80012a38>] (show_stack) from [<80886090>] (dump_stack+0x74/0xc0)
[<80886090>] (dump_stack) from [<80082a84>] (__lock_acquire+0x668/0x1c28)
[<80082a84>] (__lock_acquire) from [<80084760>] (lock_acquire+0xfc/0x218)
[<80084760>] (lock_acquire) from [<8088ec30>] (_raw_spin_lock+0x48/0x58)
[<8088ec30>] (_raw_spin_lock) from [<8061a6c8>] (sm_keystore_slot_load+0x3c/0x9c)
[<8061a6c8>] (sm_keystore_slot_load) from [<8061b58c>] (caam_sm_example_init+0x28c/0xaac)
[<8061b58c>] (caam_sm_example_init) from [<80febb9c>] (caam_sm_test_init+0x50/0x60)
[<80febb9c>] (caam_sm_test_init) from [<80008844>] (do_one_initcall+0xa4/0x144)
[<80008844>] (do_one_initcall) from [<80facda4>] (kernel_init_freeable+0x1d4/0x2cc)
[<80facda4>] (kernel_init_freeable) from [<808818a0>] (kernel_init+0x1c/0xf4)
[<808818a0>] (kernel_init) from [<8000e308>] (ret_from_fork+0x14/0x20)

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/crypto/caam/sm_store.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/crypto/caam/sm_store.c b/drivers/crypto/caam/sm_store.c
index 51c1f2e..a13ec5c 100644
--- a/drivers/crypto/caam/sm_store.c
+++ b/drivers/crypto/caam/sm_store.c
@@ -980,6 +980,8 @@ int caam_sm_startup(struct platform_device *pdev)
 		return -EINVAL;
 	}
 
+	spin_lock_init(&smpriv->kslock);
+
 	/* Save a pointer to the platform device for Secure Memory */
 	smpriv->sm_pdev = sm_pdev;
 	smdev = &sm_pdev->dev;
-- 
1.7.5.4

