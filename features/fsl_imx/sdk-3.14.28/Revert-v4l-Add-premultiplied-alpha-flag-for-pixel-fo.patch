From 44b305e7510f799e1a74bdaaab182e3855ad9421 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Wed, 22 Jul 2015 19:49:04 +0800
Subject: [PATCH 2/3] Revert "v4l: Add premultiplied alpha flag for pixel
 formats"

This reverts commit 2d8419c17fc4ebdc9defafde00831a93622a4a8f.
That commit changed the v4l ABI. Since we have to leverage some fsl
pre-built applications to verify some functions of vpu, we choose
to revert that commit to be compatible with these applications.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 Documentation/DocBook/media/v4l/pixfmt.xml |   28 +---------------------------
 drivers/media/v4l2-core/v4l2-ioctl.c       |    5 ++---
 include/uapi/linux/videodev2.h             |    7 +------
 3 files changed, 4 insertions(+), 36 deletions(-)

diff --git a/Documentation/DocBook/media/v4l/pixfmt.xml b/Documentation/DocBook/media/v4l/pixfmt.xml
index 840f377..72d72bd 100644
--- a/Documentation/DocBook/media/v4l/pixfmt.xml
+++ b/Documentation/DocBook/media/v4l/pixfmt.xml
@@ -107,12 +107,6 @@ see <xref linkend="colorspaces" />.</entry>
 information about formats. When not used drivers and applications must
 set this field to zero.</entry>
 	</row>
-	<row>
-	  <entry>__u32</entry>
-	  <entry><structfield>flags</structfield></entry>
-	    <entry>Flags set by the application or driver, see <xref
-linkend="format-flags" />.</entry>
-	</row>
       </tbody>
     </tgroup>
   </table>
@@ -198,15 +192,9 @@ codes can be used.</entry>
           and the number of valid entries in the
           <structfield>plane_fmt</structfield> array.</entry>
         </row>
-	<row>
-	  <entry>__u8</entry>
-	  <entry><structfield>flags</structfield></entry>
-	  <entry>Flags set by the application or driver, see <xref
-linkend="format-flags" />.</entry>
-	</row>
         <row>
           <entry>__u8</entry>
-          <entry><structfield>reserved[10]</structfield></entry>
+          <entry><structfield>reserved[11]</structfield></entry>
           <entry>Reserved for future extensions. Should be zeroed by the
            application.</entry>
         </row>
@@ -1052,18 +1040,4 @@ concatenated to form the JPEG stream. </para>
 	</tbody>
       </tgroup>
     </table>
-
-    <table frame="none" pgwide="1" id="format-flags">
-      <title>Format Flags</title>
-      <tgroup cols="3">
-	&cs-def;
-	<tbody valign="top">
-	  <row>
-	    <entry><constant>V4L2_PIX_FMT_FLAG_PREMUL_ALPHA</constant></entry>
-	    <entry>0x00000001</entry>
-	    <entry>The pixel values are premultiplied by the alpha channel value.</entry>
-	  </row>
-	</tbody>
-      </tgroup>
-    </table>
   </section>
diff --git a/drivers/media/v4l2-core/v4l2-ioctl.c b/drivers/media/v4l2-core/v4l2-ioctl.c
index 0ba6c3e..18b4e51 100644
--- a/drivers/media/v4l2-core/v4l2-ioctl.c
+++ b/drivers/media/v4l2-core/v4l2-ioctl.c
@@ -255,8 +255,7 @@ static void v4l_print_format(const void *arg, bool write_only)
 		pix = &p->fmt.pix;
 		pr_cont(", width=%u, height=%u, "
 			"pixelformat=%c%c%c%c, field=%s, "
-			"bytesperline=%u, sizeimage=%u, colorspace=%d, "
-			"flags %u\n",
+			"bytesperline=%u, sizeimage=%u, colorspace=%d\n",
 			pix->width, pix->height,
 			(pix->pixelformat & 0xff),
 			(pix->pixelformat >>  8) & 0xff,
@@ -264,7 +263,7 @@ static void v4l_print_format(const void *arg, bool write_only)
 			(pix->pixelformat >> 24) & 0xff,
 			prt_names(pix->field, v4l2_field_names),
 			pix->bytesperline, pix->sizeimage,
-			pix->colorspace, pix->flags);
+			pix->colorspace);
 		break;
 	case V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE:
 	case V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE:
diff --git a/include/uapi/linux/videodev2.h b/include/uapi/linux/videodev2.h
index aa84324..29c5e5d 100644
--- a/include/uapi/linux/videodev2.h
+++ b/include/uapi/linux/videodev2.h
@@ -282,7 +282,6 @@ struct v4l2_pix_format {
 	__u32          		sizeimage;
 	__u32			colorspace;	/* enum v4l2_colorspace */
 	__u32			priv;		/* private data, depends on pixelformat */
-	__u32			flags;		/* format flags (V4L2_PIX_FMT_FLAG_*) */
 };
 
 /*      Pixel format         FOURCC                          depth  Description  */
@@ -440,8 +439,6 @@ struct v4l2_pix_format {
 #define V4L2_PIX_FMT_SE401      v4l2_fourcc('S', '4', '0', '1') /* se401 janggu compressed rgb */
 #define V4L2_PIX_FMT_S5C_UYVY_JPG v4l2_fourcc('S', '5', 'C', 'I') /* S5C73M3 interleaved UYVY/JPEG */
 
-/* Flags */
-#define V4L2_PIX_FMT_FLAG_PREMUL_ALPHA	0x00000001
 /*
  *	F O R M A T   E N U M E R A T I O N
  */
@@ -1689,7 +1686,6 @@ struct v4l2_plane_pix_format {
  * @colorspace:		enum v4l2_colorspace; supplemental to pixelformat
  * @plane_fmt:		per-plane information
  * @num_planes:		number of planes for this format
- * @flags:		format flags (V4L2_PIX_FMT_FLAG_*)
  */
 struct v4l2_pix_format_mplane {
 	__u32				width;
@@ -1700,8 +1696,7 @@ struct v4l2_pix_format_mplane {
 
 	struct v4l2_plane_pix_format	plane_fmt[VIDEO_MAX_PLANES];
 	__u8				num_planes;
-	__u8				flags;
-	__u8				reserved[10];
+	__u8				reserved[11];
 } __attribute__ ((packed));
 
 /**
-- 
1.7.5.4

