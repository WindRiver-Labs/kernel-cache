From a747d38350496171dfb9d8efa37440f722967c52 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Wed, 22 Jul 2015 19:52:29 +0800
Subject: [PATCH 3/3] gpu-viv: use vmalloc help function to translate vmalloc
 space virtual address to physical

There is a help function vmalloc_to_page() to translate a vmalloc space
virtual address to page. We should use this function instead of
traversing the page table directly because pte_offset_map_lock()
can not be used with the kernel pte mapping.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 .../gpu-viv/hal/os/linux/kernel/gc_hal_kernel_os.c |   11 +++++++++++
 1 files changed, 11 insertions(+), 0 deletions(-)

diff --git a/drivers/mxc/gpu-viv/hal/os/linux/kernel/gc_hal_kernel_os.c b/drivers/mxc/gpu-viv/hal/os/linux/kernel/gc_hal_kernel_os.c
index 98bf39b..f451a70 100644
--- a/drivers/mxc/gpu-viv/hal/os/linux/kernel/gc_hal_kernel_os.c
+++ b/drivers/mxc/gpu-viv/hal/os/linux/kernel/gc_hal_kernel_os.c
@@ -366,6 +366,17 @@ _QueryProcessPageTable(
         return gcvSTATUS_NOT_FOUND;
     }
 
+   if (is_vmalloc_addr(Logical)) {
+	struct page *page;
+
+	page = vmalloc_to_page(Logical);
+	if (!page)
+		return gcvSTATUS_NOT_FOUND;
+
+	*Address = (page_to_pfn(page) << PAGE_SHIFT) | offset_in_page(Logical);
+	return gcvSTATUS_OK;
+   }
+
     pgd = pgd_offset(current->mm, logical);
     if (pgd_none(*pgd) || pgd_bad(*pgd))
     {
-- 
1.7.5.4

