From ee154a24865721233e6636825deb487c3015a75a Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 28 Jul 2015 20:02:57 +0800
Subject: [PATCH 1/3] video: mxc: fix a memory leak bug when reading edid

We may invoke fb_edid_to_monspecs() several times. So we need to
release the allocated modedb before invoking fb_edid_to_monspecs()
to fix a memory leak reported by kmemleak:
unreferenced object 0xb82b8000 (size 2048):
  comm "kworker/0:1", pid 98, jiffies 4294938387 (age 2542.070s)
  hex dump (first 32 bytes):
    00 00 00 00 3b 00 00 00 90 06 00 00 1a 04 00 00  ....;...........
    b5 1a 00 00 18 01 00 00 68 00 00 00 1e 00 00 00  ........h.......
  backtrace:
    [<8012a4a0>] __kmalloc+0x214/0x324
    [<803c4d00>] mxc_edid_parse_ext_blk+0x7f0/0x878
    [<803c4f78>] mxc_edid_read+0x1f0/0x214
    [<803c3f40>] mxc_hdmi_read_edid+0x64/0x394
    [<803c42d0>] hotplug_worker+0x60/0x2a0
    [<8004abc4>] process_one_work+0x288/0x468
    [<8004b9a8>] worker_thread+0x43c/0x550
    [<8005143c>] kthread+0xd0/0xe0
    [<8000e2f8>] ret_from_fork+0x14/0x20
    [<ffffffff>] 0xffffffff

Also remove a redundant init of fbi->monspecs before invoking
fb_edid_to_monspecs() since it will be init again in that function.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/video/mxc/mxc_edid.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/video/mxc/mxc_edid.c b/drivers/video/mxc/mxc_edid.c
index d791bfe..8269ee2 100644
--- a/drivers/video/mxc/mxc_edid.c
+++ b/drivers/video/mxc/mxc_edid.c
@@ -736,7 +736,7 @@ int mxc_edid_read(struct i2c_adapter *adp, unsigned short addr,
 		return extblknum;
 
 	/* edid first block parsing */
-	memset(&fbi->monspecs, 0, sizeof(fbi->monspecs));
+	fb_destroy_modedb(fbi->monspecs.modedb);
 	fb_edid_to_monspecs(edid, &fbi->monspecs);
 
 	if (extblknum) {
-- 
1.7.5.4

