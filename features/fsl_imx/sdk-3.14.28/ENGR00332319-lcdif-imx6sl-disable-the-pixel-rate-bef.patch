From f1e3ac2769e9162ea23d53539263ec7067755716 Mon Sep 17 00:00:00 2001
From: Robby Cai <r63905@freescale.com>
Date: Fri, 19 Sep 2014 18:38:08 +0800
Subject: [PATCH 0777/1543] ENGR00332319 lcdif: imx6sl: disable the pixel rate
 before call clk_set_rate

commit b3d0e9fdf6627fd0e36ed93ff3077305d26f664e from
git://git.freescale.com/imx/linux-2.6-imx.git

After the following commit is pushed, the lcdif framebuffer driver need
the adjustment.
93a9e3d0b88203cb523dd92e85590683d6a85fdf ENGR00318063-6:
ARM: imx6: add CLK_SET_RATE_GATE flag for PLL clocks

CLK_SET_RATE_GATE flag means "must be gated across rate change".

PLL5 video is the parent clock of the pixel clock, and only used by it.
This patch gates the clock before call clk_set_rate() to meet the requirement.

Signed-off-by: Robby Cai <r63905@freescale.com>
---
 drivers/video/mxsfb.c |   16 ++++++++++++++++
 1 files changed, 16 insertions(+), 0 deletions(-)

diff --git a/drivers/video/mxsfb.c b/drivers/video/mxsfb.c
index 59ea7e4..f7fae186 100644
--- a/drivers/video/mxsfb.c
+++ b/drivers/video/mxsfb.c
@@ -494,6 +494,22 @@ static void mxsfb_enable_controller(struct fb_info *fb_info)
 	clk_enable_disp_axi(host);
 
 	clk_set_rate(host->clk_pix, PICOS2KHZ(fb_info->var.pixclock) * 1000U);
+	ret =
+	    clk_set_rate(host->clk_pix,
+			 PICOS2KHZ(fb_info->var.pixclock) * 1000U);
+	if (ret) {
+		dev_err(&host->pdev->dev,
+			"lcd pixel rate set failed: %d\n", ret);
+
+		if (host->reg_lcd) {
+			ret = regulator_disable(host->reg_lcd);
+			if (ret)
+				dev_err(&host->pdev->dev,
+					"lcd regulator disable failed: %d\n",
+					ret);
+		}
+		return;
+	}
 	clk_prepare_enable(host->clk_pix);
 
 	/* Clean soft reset and clock gate bit if it was enabled  */
-- 
1.7.5.4

