From 3f9b4d42dbab5926dbdb9310b85a839f78b37026 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Wed, 29 Jul 2015 18:10:17 +0800
Subject: [PATCH 3/3] video: mxc: release the modelist memory in error path

This fixes a memory leak reported by kmemleak:
unreferenced object 0xbceff280 (size 64):
  comm "swapper/0", pid 1, jiffies 4294937575 (age 2550.170s)
  hex dump (first 32 bytes):
    24 72 a1 bc 24 72 a1 bc 7b 76 da 80 39 00 00 00  $r..$r..{v..9...
    20 03 00 00 e0 01 00 00 ad 90 00 00 28 00 00 00   ...........(...
  backtrace:
    [<8012aa80>] kmem_cache_alloc_trace+0x1e8/0x2f4
    [<803b37d0>] fb_add_videomode+0x58/0xac
    [<803c5550>] lcdif_init+0x140/0x15c
    [<803c5378>] mxc_dispdrv_gethandle+0x70/0xb0
    [<803c8e74>] mxcfb_probe+0x74c/0xcbc
    [<8042f908>] platform_drv_probe+0x58/0xa8
    [<8042dee0>] driver_probe_device+0xcc/0x214
    [<8042e0f4>] __driver_attach+0x78/0x9c
    [<8042c37c>] bus_for_each_dev+0x7c/0xa0
    [<8042d9ec>] driver_attach+0x28/0x30
    [<8042d614>] bus_add_driver+0xf4/0x1dc
    [<8042e7e0>] driver_register+0xac/0xf0
    [<8042f824>] __platform_driver_register+0x58/0x6c
    [<80f32af8>] mxcfb_init+0x18/0x20
    [<80008844>] do_one_initcall+0xa4/0x140
    [<80ef8d70>] kernel_init_freeable+0x1b4/0x2ac

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/video/mxc/mxc_ipuv3_fb.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/video/mxc/mxc_ipuv3_fb.c b/drivers/video/mxc/mxc_ipuv3_fb.c
index 1fbfc9d..dc36356 100644
--- a/drivers/video/mxc/mxc_ipuv3_fb.c
+++ b/drivers/video/mxc/mxc_ipuv3_fb.c
@@ -2500,6 +2500,7 @@ get_ipu_failed:
 	ipu_clear_usage(mxcfbi->ipu_id, mxcfbi->ipu_di);
 ipu_in_busy:
 init_dispdrv_failed:
+	fb_destroy_modelist(&fbi->modelist);
 	fb_dealloc_cmap(&fbi->cmap);
 	framebuffer_release(fbi);
 get_fb_option_failed:
-- 
1.7.5.4

