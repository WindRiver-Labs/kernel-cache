From 7d416c6f676b0987f9e86c8da993bd820c1d5977 Mon Sep 17 00:00:00 2001
From: Limeng <Meng.Li@windriver.com>
Date: Sun, 31 Jan 2016 20:57:48 +0800
Subject: [PATCH 1574/1594] media: mxc: fix a warning from v4l2 core module

Driver must initiallize capabilities and device_caps field of
structure struct v4l2_capability. Because In v4l2-ioctl.c file,
function v4l_querycap() will check these two fields with below code:
	/*
	 * Drivers MUST fill in device_caps, so check for this and
	 * warn if it was forgotten.
	 */
	WARN_ON(!(cap->capabilities & V4L2_CAP_DEVICE_CAPS) ||
		!cap->device_caps);
If these two fields are not initialized, below warning trace will output
during kernel boots up.
Detail warning information as below:
------------[ cut here ]------------
WARNING: CPU: 2 PID: 226 at
drivers/media/v4l2-core/v4l2-ioctl.c:1042 v4l_querycap+0)
Modules linked in:
CPU: 2 PID: 226 Comm: v4l_id Not tainted 4.1.15-WR7.0.0.0_standard #35
Hardware name: Freescale i.MX6 Quad/DualLite (Device Tree)
[<800191f0>] (unwind_backtrace) from [<80013644>] (show_stack+0x20/0x24)
[<80013644>] (show_stack) from [<8087d9a4>] (dump_stack+0x7c/0xc8)
[<8087d9a4>] (dump_stack) from [<80038674>] (warn_slowpath_common+0x98/0xc4)
[<80038674>] (warn_slowpath_common) from [<8003875c>] (warn_slowpath_null+0x2c/0x34)
[<8003875c>] (warn_slowpath_null) from [<80598b88>] (v4l_querycap+0x68/0x84)
[<80598b88>] (v4l_querycap) from [<8059a9f4>] (__video_do_ioctl+0x1ac/0x2b4)
[<8059a9f4>] (__video_do_ioctl) from [<8059a53c>] (video_usercopy+0x250/0x538)
[<8059a53c>] (video_usercopy) from [<8059a840>] (video_ioctl2+0x1c/0x24)
[<8059a840>] (video_ioctl2) from [<80594cfc>] (v4l2_ioctl+0x70/0xb4)
[<80594cfc>] (v4l2_ioctl) from [<80160f30>] (do_vfs_ioctl+0x500/0x5c0)
[<80160f30>] (do_vfs_ioctl) from [<8016104c>] (SyS_ioctl+0x5c/0x84)
[<8016104c>] (SyS_ioctl) from [<8000f320>] (ret_fast_syscall+0x0/0x3c)
---[ end trace 353e6344eda2a8ed ]---

Therefore, modify code to initialize capabilities and device_caps field of
structure struct v4l2_capability

Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/media/platform/mxc/output/mxc_pxp_v4l2.c |    4 +++-
 drivers/media/platform/mxc/output/mxc_vout.c     |    4 +++-
 drivers/media/platform/mxc/subdev/mx6s_capture.c |    4 +++-
 3 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c b/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c
index 8a3cda5..fc555e4 100644
--- a/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c
+++ b/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c
@@ -968,7 +968,9 @@ static int pxp_querycap(struct file *file, void *fh,
 
 	cap->capabilities = V4L2_CAP_VIDEO_OUTPUT |
 				V4L2_CAP_VIDEO_OUTPUT_OVERLAY |
-				V4L2_CAP_STREAMING;
+				V4L2_CAP_STREAMING | V4L2_CAP_DEVICE_CAPS;
+	cap->device_caps = V4L2_CAP_VIDEO_OUTPUT_OVERLAY |
+				V4L2_CAP_VIDEO_OUTPUT | V4L2_CAP_STREAMING;
 
 	return 0;
 }
diff --git a/drivers/media/platform/mxc/output/mxc_vout.c b/drivers/media/platform/mxc/output/mxc_vout.c
index 1d100b3..285f9ff 100644
--- a/drivers/media/platform/mxc/output/mxc_vout.c
+++ b/drivers/media/platform/mxc/output/mxc_vout.c
@@ -1028,7 +1028,9 @@ static int mxc_vidioc_querycap(struct file *file, void *fh,
 	strlcpy(cap->driver, VOUT_NAME, sizeof(cap->driver));
 	strlcpy(cap->card, vout->vfd->name, sizeof(cap->card));
 	cap->bus_info[0] = '\0';
-	cap->capabilities = V4L2_CAP_STREAMING | V4L2_CAP_VIDEO_OUTPUT;
+	cap->capabilities = V4L2_CAP_STREAMING | V4L2_CAP_VIDEO_OUTPUT |
+				V4L2_CAP_DEVICE_CAPS;
+	cap->device_caps = V4L2_CAP_VIDEO_OUTPUT | V4L2_CAP_STREAMING;
 
 	return 0;
 }
diff --git a/drivers/media/platform/mxc/subdev/mx6s_capture.c b/drivers/media/platform/mxc/subdev/mx6s_capture.c
index 352d059..b0c03c8 100644
--- a/drivers/media/platform/mxc/subdev/mx6s_capture.c
+++ b/drivers/media/platform/mxc/subdev/mx6s_capture.c
@@ -1469,7 +1469,9 @@ static int mx6s_vidioc_querycap(struct file *file, void  *priv,
 	snprintf(cap->bus_info, sizeof(cap->bus_info), "platform:%s",
 		 dev_name(csi_dev->dev));
 
-	cap->capabilities = V4L2_CAP_VIDEO_CAPTURE | V4L2_CAP_STREAMING;
+	cap->capabilities = V4L2_CAP_VIDEO_CAPTURE |
+				V4L2_CAP_STREAMING | V4L2_CAP_DEVICE_CAPS;
+	cap->device_caps = V4L2_CAP_VIDEO_CAPTURE | V4L2_CAP_STREAMING;
 	return 0;
 }
 
-- 
1.7.5.4

