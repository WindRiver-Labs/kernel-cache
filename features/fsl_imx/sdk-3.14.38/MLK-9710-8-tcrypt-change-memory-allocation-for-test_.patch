From 351baebae126610e7446e2145a4b0db47ceff944 Mon Sep 17 00:00:00 2001
From: Victoria Milhoan <vicki.milhoan@freescale.com>
Date: Wed, 5 Nov 2014 05:13:05 -0700
Subject: [PATCH 1531/1594] MLK-9710-8 tcrypt: change memory allocation for
 test_ahash_speed output buffer

commit e9e7da4fddd55090abf56cb94bec66deec2d4352 from
git://git.freescale.com/imx/linux-2.6-imx.git

Change allocation of the tcrypt module's test_ahash_speed() output buffer to
use kmalloc().  This avoids a segmentation fault when the buffer is used in a
dma_map_*() call.

Signed-off-by: Victoria Milhoan <vicki.milhoan@freescale.com>
(cherry picked from commit 3c8c56d1bd82433af6a565d183bdb632fd01a13a)
---
 crypto/tcrypt.c |    7 ++++---
 1 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/crypto/tcrypt.c b/crypto/tcrypt.c
index 1a28001..2184460 100644
--- a/crypto/tcrypt.c
+++ b/crypto/tcrypt.c
@@ -930,7 +930,8 @@ static void test_ahash_speed(const char *algo, unsigned int secs,
 	struct tcrypt_result tresult;
 	struct ahash_request *req;
 	struct crypto_ahash *tfm;
-	static char output[1024];
+	const int output_size = 1024;
+	char *output = kmalloc(output_size, GFP_KERNEL);
 	int i, ret;
 
 	tfm = crypto_alloc_ahash(algo, 0, 0);
@@ -943,9 +944,9 @@ static void test_ahash_speed(const char *algo, unsigned int secs,
 	printk(KERN_INFO "\ntesting speed of async %s (%s)\n", algo,
 			get_driver_name(crypto_ahash, tfm));
 
-	if (crypto_ahash_digestsize(tfm) > sizeof(output)) {
+	if (crypto_ahash_digestsize(tfm) > output_size) {
 		pr_err("digestsize(%u) > outputbuffer(%zu)\n",
-		       crypto_ahash_digestsize(tfm), sizeof(output));
+		       crypto_ahash_digestsize(tfm), output_size);
 		goto out;
 	}
 
-- 
1.7.5.4

