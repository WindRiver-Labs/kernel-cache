From 6fd9fc8cad7a7ba4e7cf6ddd6f8a9b28f386788c Mon Sep 17 00:00:00 2001
From: Limeng <Meng.Li@windriver.com>
Date: Fri, 18 Mar 2016 17:52:53 +0800
Subject: [PATCH] driver: watchdog: imx2_wdt: save new timeout value

When we test watchdog set timeout case with below command:
wdtTool -t 30
It returns information as below:
Default wdt timeout = 60.
Watchdog set timeout = 60.
Current wdt timeout = 60.
But the correct return information should be:
Default wdt timeout = 60.
Watchdog set timeout = 30.
Current wdt timeout = 30.

The reason is that function imx2_wdt_set_timeout() in file
imx2_wdt.c only sets register with new timeout value 30, it
does not save the new timeout value in the timeout field of
struct watchdog_device.

Therefore, add code to save new timeout value in function
imx2_wdt_set_timeout() when processing ioctl command
WDIOC_SETTIMEOUT.

Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/watchdog/imx2_wdt.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/watchdog/imx2_wdt.c b/drivers/watchdog/imx2_wdt.c
index 5753cc2..9333f36 100644
--- a/drivers/watchdog/imx2_wdt.c
+++ b/drivers/watchdog/imx2_wdt.c
@@ -183,6 +183,9 @@ static int imx2_wdt_set_timeout(struct watchdog_device *wdog,
 
 	regmap_update_bits(wdev->regmap, IMX2_WDT_WCR, IMX2_WDT_WCR_WT,
 			   WDOG_SEC_TO_COUNT(new_timeout));
+
+	wdog->timeout = new_timeout;
+
 	return 0;
 }
 
-- 
1.7.5.4

