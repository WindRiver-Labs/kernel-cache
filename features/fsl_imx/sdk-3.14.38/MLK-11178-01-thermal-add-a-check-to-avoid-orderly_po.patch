From b06f8f7a343b3a2a7af15ce290644d7d7f7ad179 Mon Sep 17 00:00:00 2001
From: Bai Ping <b51503@freescale.com>
Date: Fri, 26 Jun 2015 22:21:38 +0800
Subject: [PATCH 1255/1594] MLK-11178-01 thermal: add a check to avoid
 orderly_poweroff twice

commit 882ac79d77ca292c5c4256bf249da8f0afc2bce7 from
git://git.freescale.com/imx/linux-2.6-imx.git

When temperature >= the 'critical_trip' temperature, the common
framework code will call 'orderly_poweroff' function to power off
the system. During the power off procedure the thermal framework
will go on polling the temp, this will lead to recall the
'orderly_poweroff' again. In the first poweroff flow, some system
resource has been freezed, then if the secondary 'orderly_poweroff'
frees the resource again, it will lead to kernel dump.

Signed-off-by: Bai Ping <b51503@freescale.com>
---
 drivers/thermal/thermal_core.c |    4 ++++
 include/linux/thermal.h        |    1 +
 2 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/thermal/thermal_core.c b/drivers/thermal/thermal_core.c
index a3282bf..5dd12dd 100644
--- a/drivers/thermal/thermal_core.c
+++ b/drivers/thermal/thermal_core.c
@@ -383,7 +383,10 @@ static void handle_critical_trips(struct thermal_zone_device *tz,
 		dev_emerg(&tz->device,
 			  "critical temperature reached(%d C),shutting down\n",
 			  tz->temperature / 1000);
+		if (tz->poweroff)
+			return;
 		orderly_poweroff(true);
+		tz->poweroff = true;
 	}
 }
 
@@ -1524,6 +1527,7 @@ struct thermal_zone_device *thermal_zone_device_register(const char *type,
 	tz->trips = trips;
 	tz->passive_delay = passive_delay;
 	tz->polling_delay = polling_delay;
+	tz->poweroff = false;
 	/* A new thermal zone needs to be updated anyway. */
 	atomic_set(&tz->need_update, 1);
 
diff --git a/include/linux/thermal.h b/include/linux/thermal.h
index 2e7d0f7..d9c77fc 100644
--- a/include/linux/thermal.h
+++ b/include/linux/thermal.h
@@ -198,6 +198,7 @@ struct thermal_zone_device {
 	struct mutex lock;
 	struct list_head node;
 	struct delayed_work poll_queue;
+	bool poweroff;
 };
 
 /**
-- 
1.7.5.4

