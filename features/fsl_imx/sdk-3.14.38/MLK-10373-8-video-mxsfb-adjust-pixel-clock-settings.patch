From 359b1256f2d0dc276476e4f8a741b50b97872f99 Mon Sep 17 00:00:00 2001
From: Fancy Fang <chen.fang@freescale.com>
Date: Thu, 5 Mar 2015 16:17:21 +0800
Subject: [PATCH 0875/1594] MLK-10373-8 video: mxsfb: adjust pixel clock
 settings

commit 744ea9e02d6477b850709bcee9305252fe4e095a from
git://git.freescale.com/imx/linux-2.6-imx.git

In 7D platform, the lcdif controller registers should
be accessed when the pixel clock is enabled, otherwise
the bus will be hang. This is different from the IMX6
series. So the pixel clock enable/disable logic should
be adjusted concequently.

Signed-off-by: Fancy Fang <chen.fang@freescale.com>
---
 drivers/video/fbdev/mxsfb.c |   12 +++++++++++-
 1 files changed, 11 insertions(+), 1 deletions(-)

diff --git a/drivers/video/fbdev/mxsfb.c b/drivers/video/fbdev/mxsfb.c
index b2436e4..1969496 100644
--- a/drivers/video/fbdev/mxsfb.c
+++ b/drivers/video/fbdev/mxsfb.c
@@ -496,6 +496,10 @@ static void mxsfb_enable_controller(struct fb_info *fb_info)
 
 	if (host->clk_disp_axi)
 		clk_prepare_enable(host->clk_disp_axi);
+	/* the pixel clock should be disabled before
+	 * trying to set its clock rate successfully.
+	 */
+	clk_disable_unprepare(host->clk);
 	ret = clk_set_rate(host->clk,
 			 PICOS2KHZ(fb_info->var.pixclock) * 1000U);
 	if (ret) {
@@ -954,6 +958,13 @@ static int mxsfb_restore_mode(struct mxsfb_info *host)
 	mxsfb_enable_axi_clk(host);
 	clk_enable_disp_axi(host);
 
+	/* Enable pixel clock earlier since in 7D
+	 * the lcdif registers should be accessed
+	 * when the pixel clock is enabled, otherwise
+	 * the bus will be hang.
+	 */
+	clk_prepare_enable(host->clk);
+
 	/* Only restore the mode when the controller is running */
 	ctrl = readl(host->base + LCDC_CTRL);
 	if (!(ctrl & CTRL_RUN)) {
@@ -1037,7 +1048,6 @@ static int mxsfb_restore_mode(struct mxsfb_info *host)
 	line_count = fb_info->fix.smem_len / fb_info->fix.line_length;
 	fb_info->fix.ypanstep = 1;
 
-	clk_prepare_enable(host->clk);
 	host->enabled = 1;
 
 err:
-- 
1.7.5.4

