From 5ca089a6377dffc8143759a8b6d3f5903274e23a Mon Sep 17 00:00:00 2001
From: Peter Chen <peter.chen@freescale.com>
Date: Fri, 8 Nov 2013 10:14:18 +0800
Subject: [PATCH 1307/1594] ENGR00286926 usb: chipidea: imx: add
 release_bus_freq at failure path

commit 1dac5bb977be0ecfd98cab8d1fbb3ce6cb6b090c from
git://git.freescale.com/imx/linux-2.6-imx.git

If not, the request{release}_bus_freq will be mismatch if
fail occurs.

Signed-off-by: Peter Chen <peter.chen@freescale.com>
---
 drivers/usb/chipidea/ci_hdrc_imx.c |   13 ++++++++++---
 1 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/drivers/usb/chipidea/ci_hdrc_imx.c b/drivers/usb/chipidea/ci_hdrc_imx.c
index 31bd925..b928248 100644
--- a/drivers/usb/chipidea/ci_hdrc_imx.c
+++ b/drivers/usb/chipidea/ci_hdrc_imx.c
@@ -285,14 +285,16 @@ static int ci_hdrc_imx_probe(struct platform_device *pdev)
 	if (IS_ERR(data->usbmisc_data))
 		return PTR_ERR(data->usbmisc_data);
 
-	request_bus_freq(BUS_FREQ_HIGH);
 	ret = imx_get_clks(&pdev->dev);
 	if (ret)
 		return ret;
 
+	request_bus_freq(BUS_FREQ_HIGH);
 	ret = imx_prepare_enable_clks(&pdev->dev);
-	if (ret)
+	if (ret) {
+		release_bus_freq(BUS_FREQ_HIGH);
 		return ret;
+	}
 
 	data->phy = devm_usb_get_phy_by_phandle(&pdev->dev, "fsl,usbphy", 0);
 	if (IS_ERR(data->phy)) {
@@ -376,6 +378,7 @@ remove_charger:
 		imx6_usb_remove_charger(&data->charger);
 err_clk:
 	imx_disable_unprepare_clks(&pdev->dev);
+	release_bus_freq(BUS_FREQ_HIGH);
 	return ret;
 }
 
@@ -425,8 +428,10 @@ static int imx_controller_resume(struct device *dev)
 
 	request_bus_freq(BUS_FREQ_HIGH);
 	ret = imx_prepare_enable_clks(dev);
-	if (ret)
+	if (ret) {
+		release_bus_freq(BUS_FREQ_HIGH);
 		return ret;
+	}
 
 	data->in_lpm = false;
 
@@ -440,6 +445,8 @@ static int imx_controller_resume(struct device *dev)
 
 clk_disable:
 	imx_disable_unprepare_clks(dev);
+	release_bus_freq(BUS_FREQ_HIGH);
+
 	return ret;
 }
 
-- 
1.7.5.4

