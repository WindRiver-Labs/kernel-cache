From c4d388facd8648872ed9c9d40e9176b1f582bd86 Mon Sep 17 00:00:00 2001
From: Fugang Duan <b38611@freescale.com>
Date: Mon, 19 Jan 2015 17:16:35 +0800
Subject: [PATCH 0130/1594] MLK-10116 tty: serial: imx: fix flush buffer issue
 when module clock is at 4Mhz

commit c20e6d53071c3e47e4167ae5b7fcd4e54cfd0fd5 from
git://git.freescale.com/imx/linux-2.6-imx.git

In general, uart module clock require it is great than 80Mhz to match 5Mbps
baud rate. When test below 14Mhz module clock, software reset cause state
machines off normal. And for i.MX6SL evk board low power test, it set uart
module clock to 4Mhz, which cause console port print out messy code.
The patch just is workaround to fix console issue.

Signed-off-by: Fugang Duan <B38611@freescale.com>
---
 drivers/tty/serial/imx.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/tty/serial/imx.c b/drivers/tty/serial/imx.c
index a08be0a..ee38951 100644
--- a/drivers/tty/serial/imx.c
+++ b/drivers/tty/serial/imx.c
@@ -1315,6 +1315,10 @@ static void imx_flush_buffer(struct uart_port *port)
 		sport->dma_is_txing = false;
 	}
 
+	/* For console port, it is not necessary flush buffer and reset FIFO */
+	if (uart_console(port))
+		return;
+
 	/*
 	 * According to the Reference Manual description of the UART SRST bit:
 	 * "Reset the transmit and receive state machines,
-- 
1.7.5.4

