From b956ff25a593ffec831618be10ee797b814d85db Mon Sep 17 00:00:00 2001
From: Robin Gong <b38343@freescale.com>
Date: Thu, 14 Nov 2013 13:58:21 +0800
Subject: [PATCH 0670/1594] ENGR00287983-2 imx restart: add another WDOG2
 reset support for ldo-bypass

commit ba0090e8b35a57d7fcbd13aa7d51b1a0a4b96c42 from
git://git.freescale.com/imx/linux-2.6-imx.git

For ldo-bypass mode on i.MX6Q/DL sabresd board, we will use another WDOG2 to
reset external pmic to trigger POR event, rather than WDOG1 to trigger WDOG
event in ldo-enable mode. We need to consider it in common mxc_restart().
On i.MX6SL sabresd board we use WDOG1 to trigger WDOG event both ldo-bypass and
ldo-enable mode.

Signed-off-by: Robin Gong <b38343@freescale.com>
(cherry picked from commit ee07b144e1adff13d262e7f353f5804e3c2d3e06)
---
 drivers/watchdog/imx2_wdt.c |   15 +++++++++++++++
 1 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/drivers/watchdog/imx2_wdt.c b/drivers/watchdog/imx2_wdt.c
index 5e6d808..5753cc2 100644
--- a/drivers/watchdog/imx2_wdt.c
+++ b/drivers/watchdog/imx2_wdt.c
@@ -36,6 +36,7 @@
 #include <linux/regmap.h>
 #include <linux/timer.h>
 #include <linux/watchdog.h>
+#include "../../arch/arm/mach-imx/hardware.h"
 
 #define DRIVER_NAME "imx2-wdt"
 
@@ -90,6 +91,20 @@ static int imx2_restart_handler(struct notifier_block *this, unsigned long mode,
 	struct imx2_wdt_device *wdev = container_of(this,
 						    struct imx2_wdt_device,
 						    restart_handler);
+
+	/*
+	 * Some i.MX6 boards use WDOG2 to reset external pmic in bypass mode,
+	 * so do WDOG2 reset here. Do not set SRS, since we will
+	 * trigger external POR later. Use WDOG1 to reset in ldo-enable
+	 * mode. You can set it by "fsl,wdog-reset" in dts.
+	 * For i.MX6SX we have to trigger wdog-reset to reset QSPI-NOR flash to
+	 * workaround qspi-nor reboot issue whatever ldo-bypass or not.
+	 */
+	if (cpu_is_imx6q() || cpu_is_imx6dl() ||
+			cpu_is_imx6sl() || cpu_is_imx6sx() || cpu_is_imx7d()
+			|| cpu_is_imx6ul())
+		wcr_enable = 0x14;
+
 	/* Assert SRS signal */
 	regmap_write(wdev->regmap, 0, wcr_enable);
 	/*
-- 
1.7.5.4

