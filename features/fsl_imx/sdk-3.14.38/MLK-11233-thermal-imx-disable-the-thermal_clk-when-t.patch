From b4cebef1cef828f346f7539d6fdc723e0b9ee00a Mon Sep 17 00:00:00 2001
From: Bai Ping <b51503@freescale.com>
Date: Fri, 10 Jul 2015 21:21:52 +0800
Subject: [PATCH 1271/1594] MLK-11233 thermal: imx: disable the thermal_clk
 when thermal driver probe failed

commit cf33ff368784f614a5c384e7a75ae05ce70e03e5 from
git://git.freescale.com/imx/linux-2.6-imx.git

If the thermal driver probe failed after the thermal_clk has been enabled,
disable the thermal_clk before return.

Signed-off-by: Bai Ping <b51503@freescale.com>
(cherry picked from commit b1092d17017dcdcb2dbd7878cae34f06e2078abb)
---
 drivers/thermal/imx_thermal.c |   23 +++++++++++++++--------
 1 files changed, 15 insertions(+), 8 deletions(-)

diff --git a/drivers/thermal/imx_thermal.c b/drivers/thermal/imx_thermal.c
index 6d25025..18b3365 100644
--- a/drivers/thermal/imx_thermal.c
+++ b/drivers/thermal/imx_thermal.c
@@ -702,8 +702,10 @@ static int imx_thermal_probe(struct platform_device *pdev)
 	}
 
 	data->irq = platform_get_irq(pdev, 0);
-	if (data->irq < 0)
-		return data->irq;
+	if (data->irq < 0) {
+		ret = data->irq;
+		goto out;
+	}
 
 	platform_set_drvdata(pdev, data);
 
@@ -713,7 +715,7 @@ static int imx_thermal_probe(struct platform_device *pdev)
 	ret = imx_get_sensor_data(pdev);
 	if (ret) {
 		dev_err(&pdev->dev, "failed to get sensor data\n");
-		return ret;
+		goto out;
 	}
 
 	/* Make sure sensor is in known good state for measurements */
@@ -731,7 +733,7 @@ static int imx_thermal_probe(struct platform_device *pdev)
 			dev_err(&pdev->dev,
 				"failed to register cpufreq cooling device: %d\n",
 				ret);
-		return ret;
+		goto out;
 	}
 
 	data->cdev[1] = devfreq_cooling_register();
@@ -739,7 +741,8 @@ static int imx_thermal_probe(struct platform_device *pdev)
 		ret = PTR_ERR(data->cdev[1]);
 		dev_err(&pdev->dev,
 			"failed to register devfreq cooling device: %d\n", ret);
-		return ret;
+		cpufreq_cooling_unregister(data->cdev[0]);
+		goto out;
 	}
 
 	data->tz = thermal_zone_device_register("imx_thermal_zone",
@@ -752,10 +755,9 @@ static int imx_thermal_probe(struct platform_device *pdev)
 		ret = PTR_ERR(data->tz);
 		dev_err(&pdev->dev,
 			"failed to register thermal zone device %d\n", ret);
-		clk_disable_unprepare(data->thermal_clk);
 		cpufreq_cooling_unregister(data->cdev[0]);
 		devfreq_cooling_unregister(data->cdev[1]);
-		return ret;
+		goto out;
 	}
 
 	/* Enable measurements at ~ 10 Hz */
@@ -774,7 +776,9 @@ static int imx_thermal_probe(struct platform_device *pdev)
 			0, "imx_thermal", data);
 	if (ret < 0) {
 		dev_err(&pdev->dev, "failed to request alarm irq: %d\n", ret);
-		return ret;
+		cpufreq_cooling_unregister(data->cdev[0]);
+		devfreq_cooling_unregister(data->cdev[1]);
+		goto out;
 	}
 
 	data->irq_enabled = true;
@@ -786,6 +790,9 @@ static int imx_thermal_probe(struct platform_device *pdev)
 		register_busfreq_notifier(&thermal_notifier);
 
 	return 0;
+out:
+	clk_disable_unprepare(data->thermal_clk);
+	return ret;
 }
 
 static int imx_thermal_remove(struct platform_device *pdev)
-- 
1.7.5.4

