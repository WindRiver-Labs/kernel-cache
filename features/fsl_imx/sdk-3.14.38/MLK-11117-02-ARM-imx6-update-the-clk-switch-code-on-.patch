From 3edbb8350da40451c91d5c99c10450b1277d109a Mon Sep 17 00:00:00 2001
From: Bai Ping <b51503@freescale.com>
Date: Fri, 19 Jun 2015 01:33:04 +0800
Subject: [PATCH 1274/1594] MLK-11117-02 ARM: imx6: update the clk switch code
 on imx6ul

commit 00177b76f6db2859391310159d3f57f2d91a8057 from
git://git.freescale.com/imx/linux-2.6-imx.git

Due to the clk tree info for AXI/AHB updating on i.MX6UL, the
busfreq enter/exit on i.MX6UL also need to be updated to align
to these changes. The AXI/AHB should be source from pll2_bus, and
the AHB clock divider value need to be set to 4 to make sure when
exiting from low bus mode, the AHB clock is also the original rate.

Signed-off-by: Bai Ping <b51503@freescale.com>
(cherry picked from commit e19096fae5c9c692d8bb560db10771dee34b3c10)
---
 arch/arm/mach-imx/busfreq-imx.c |   11 +++++++++--
 1 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-imx/busfreq-imx.c b/arch/arm/mach-imx/busfreq-imx.c
index d3dc81b..072b3e4 100644
--- a/arch/arm/mach-imx/busfreq-imx.c
+++ b/arch/arm/mach-imx/busfreq-imx.c
@@ -268,12 +268,19 @@ static void exit_lpm_imx6_up(void)
 	 * lower ahb/ocram's freq first to avoid too high
 	 * freq during parent switch from OSC to pll3.
 	 */
-	imx_clk_set_rate(ahb_clk, LPAPM_CLK / 3);
+	if (cpu_is_imx6ul())
+		imx_clk_set_rate(ahb_clk, LPAPM_CLK / 4);
+	else
+		imx_clk_set_rate(ahb_clk, LPAPM_CLK / 3);
 	imx_clk_set_rate(ocram_clk, LPAPM_CLK / 2);
 	/* set periph_clk2 to pll3 */
 	imx_clk_set_parent(periph_clk2_sel, pll3);
+	/* set periph clk to from pll2_bus on i.MX6UL */
+	if (cpu_is_imx6ul())
+		imx_clk_set_parent(periph_pre_clk, pll2_bus);
 	/* set periph clk to from pll2_400 */
-	imx_clk_set_parent(periph_pre_clk, pll2_400);
+	else
+		imx_clk_set_parent(periph_pre_clk, pll2_400);
 	imx_clk_set_parent(periph_clk, periph_pre_clk);
 
 	if (ddr_type == MMDC_MDMISC_DDR_TYPE_DDR3)
-- 
1.7.5.4

