From a6a1203d6c7df2ffc0e0a46f0accca7d8d84d84c Mon Sep 17 00:00:00 2001
From: Robin Gong <b38343@freescale.com>
Date: Fri, 10 Oct 2014 14:55:19 +0800
Subject: [PATCH 0755/1594] MLK-9776: dma: imx-sdma: make sure BUG_ON
 workaround do not work in loop mode

commit 4c2175fd8b12a95f2a31e0b7cc4bf88aba44af14 from
git://git.freescale.com/imx/linux-2.6-imx.git

  The earlier patch for "ENGR00313512 dma: imx-sdma: A bungle of work around for
BUG ON issue" is better not applied for loop mode, since there is no any cookie
touch in loop mode which means never trigger the BUG_ON workaround. Otherwise,
if upper driver such as UART disable dma channel but the device still has sent
the data into the RXFIFO, bd buffer will be consumed quickly and then stop.That
will trigger "RX FIFO overrun", like below log:

imx-uart 21ec000.serial: Rx FIFO overrun
imx-uart 21ec000.serial: Rx FIFO overrun
imx-uart 21ec000.serial: Rx FIFO overrun
imx-uart 21ec000.serial: Rx FIFO overrun
imx-uart 21ec000.serial: Rx FIFO overrun
imx-uart 21ec000.serial: Rx FIFO overrun
imx-uart 21ec000.serial: Rx FIFO overrun
imx-uart 21ec000.serial: Rx FIFO overrun

Signed-off-by: Robin Gong <b38343@freescale.com>
(cherry picked from commit ac31647b11c3e441901fa116d74ebef9051e22e5)
---
 drivers/dma/imx-sdma.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/dma/imx-sdma.c b/drivers/dma/imx-sdma.c
index 680c369..6211cb1 100644
--- a/drivers/dma/imx-sdma.c
+++ b/drivers/dma/imx-sdma.c
@@ -711,7 +711,7 @@ static void sdma_tasklet(unsigned long data)
 	unsigned long flags;
 
 	spin_lock_irqsave(&sdmac->lock, flags);
-	if (sdmac->status != DMA_IN_PROGRESS) {
+	if (sdmac->status != DMA_IN_PROGRESS && sdmac->mode != SDMA_MODE_LOOP) {
 		spin_unlock_irqrestore(&sdmac->lock, flags);
 		return;
 	}
@@ -742,7 +742,7 @@ static irqreturn_t sdma_int_handler(int irq, void *dev_id)
 			sdma_update_channel_loop(sdmac);
 
 		spin_lock_irqsave(&sdmac->lock, flags);
-		if (sdmac->status == DMA_IN_PROGRESS)
+		if (sdmac->status == DMA_IN_PROGRESS || sdmac->mode == SDMA_MODE_LOOP)
 			tasklet_schedule(&sdmac->tasklet);
 		spin_unlock_irqrestore(&sdmac->lock, flags);
 
-- 
1.7.5.4

