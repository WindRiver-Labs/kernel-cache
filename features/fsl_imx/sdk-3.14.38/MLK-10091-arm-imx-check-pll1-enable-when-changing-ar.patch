From 5b73f29db676da2eec2032218b3abb5f00dec93a Mon Sep 17 00:00:00 2001
From: Bai Ping <b51503@freescale.com>
Date: Wed, 14 Jan 2015 22:46:10 +0800
Subject: [PATCH 1319/1594] MLK-10091 arm: imx: check pll1 enable when
 changing arm_podf

commit 2d22686e6adb0d7813d91d18a25d61827b47b153 from
git://git.freescale.com/imx/linux-2.6-imx.git

According to the hardware design, when changing the arm_podf divider,
make sure the pll1 has clk output. If the pll1 output is disabled before
changing the arm_podf, enbale and bypass the pll1 to make sure the
arm_podf can be successfully changed.

Signed-off-by: Bai Ping <b51503@freescale.com>
---
 arch/arm/mach-imx/clk-busy.c  |   10 +++++++++-
 arch/arm/mach-imx/clk-pllv3.c |   19 ++++++++++++++++++-
 arch/arm/mach-imx/clk.h       |    1 +
 3 files changed, 28 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-imx/clk-busy.c b/arch/arm/mach-imx/clk-busy.c
index ce03121..f45a2a9 100644
--- a/arch/arm/mach-imx/clk-busy.c
+++ b/arch/arm/mach-imx/clk-busy.c
@@ -1,5 +1,5 @@
 /*
- * Copyright 2012-2014 Freescale Semiconductor, Inc.
+ * Copyright 2012-2015 Freescale Semiconductor, Inc.
  * Copyright 2012 Linaro Ltd.
  *
  * The code contained herein is licensed under the GNU General Public
@@ -18,14 +18,22 @@
 #include <linux/err.h>
 #include "clk.h"
 
+#define ARM_PODF_BUSY	(0x1 << 16)
+
 static int clk_busy_wait(void __iomem *reg, u8 shift)
 {
 	unsigned long timeout = jiffies + msecs_to_jiffies(10);
 
+	u32 val = readl_relaxed(reg);
+	if (val & ARM_PODF_BUSY)
+		imx_enable_pll_arm(true);
+
 	while (readl_relaxed(reg) & (1 << shift))
 		if (time_after(jiffies, timeout))
 			return -ETIMEDOUT;
 
+	if (val & ARM_PODF_BUSY)
+		imx_enable_pll_arm(false);
 	return 0;
 }
 
diff --git a/arch/arm/mach-imx/clk-pllv3.c b/arch/arm/mach-imx/clk-pllv3.c
index f6eb541..d8deefa 100644
--- a/arch/arm/mach-imx/clk-pllv3.c
+++ b/arch/arm/mach-imx/clk-pllv3.c
@@ -1,5 +1,5 @@
 /*
- * Copyright 2012-2014 Freescale Semiconductor, Inc.
+ * Copyright 2012-2015 Freescale Semiconductor, Inc.
  * Copyright 2012 Linaro Ltd.
  *
  * The code contained herein is licensed under the GNU General Public
@@ -33,6 +33,7 @@
 #define BM_PLL_BYPASS		(0x1 << 16)
 #define ENET_PLL_POWER		(0x1 << 5)
 
+static void __iomem *pll_sys_base;
 /**
  * struct clk_pllv3 - IMX PLL clock version 3
  * @clk_hw:	 clock source
@@ -368,6 +369,7 @@ struct clk *imx_clk_pllv3(enum imx_pllv3_type type, const char *name,
 	switch (type) {
 	case IMX_PLLV3_SYS:
 		ops = &clk_pllv3_sys_ops;
+		pll_sys_base = base;
 		break;
 	case IMX_PLLV3_USB_VF610:
 		pll->div_shift = 1;
@@ -415,3 +417,18 @@ struct clk *imx_clk_pllv3(enum imx_pllv3_type type, const char *name,
 
 	return clk;
 }
+
+void imx_enable_pll_arm(bool enable)
+{
+	static u32 saved_pll_arm;
+	u32 val;
+
+	if (enable) {
+		saved_pll_arm = val = readl_relaxed(pll_sys_base);
+		val |= BM_PLL_ENABLE;
+		val |= BM_PLL_BYPASS;
+		writel_relaxed(val, pll_sys_base);
+	} else {
+		writel_relaxed(saved_pll_arm, pll_sys_base);
+	}
+}
diff --git a/arch/arm/mach-imx/clk.h b/arch/arm/mach-imx/clk.h
index 8bc6efd..7647849 100644
--- a/arch/arm/mach-imx/clk.h
+++ b/arch/arm/mach-imx/clk.h
@@ -9,6 +9,7 @@ extern spinlock_t imx_ccm_lock;
 void imx_check_clocks(struct clk *clks[], unsigned int count);
 
 extern void imx_cscmr1_fixup(u32 *val);
+extern void imx_enable_pll_arm(bool);
 extern struct imx_sema4_mutex *amp_power_mutex;
 extern struct imx_shared_mem *shared_mem;
 extern bool uart_from_osc;
-- 
1.7.5.4

