From 044991e1fa6b46553d68ac5b253f5299415b1589 Mon Sep 17 00:00:00 2001
From: Limeng <Meng.Li@windriver.com>
Date: Wed, 16 Mar 2016 14:59:20 +0800
Subject: [PATCH 2/3] driver: pci: pci-imx6: reset pcie core when link up fail

If there is no PCIE card inserted into PCIE interface, link up will fail.
In this case, original code will disable clock and regulator of pcie
controller and return -EINVAL from imx6_pcie_start_link() function,
and also cause probe exit exceptionally. Now, if you run kexec, the
second kernel will hang up because enters wrong case and access
pcie controller register without enabling pcie controller clock and
regulator.
So, call imx6_pcie_assert_core_reset() function to reset pcie core
when link up fail, so that the second kernel enters correct case when
initializing pcie controller.

Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/pci/host/pci-imx6.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/pci/host/pci-imx6.c b/drivers/pci/host/pci-imx6.c
index 0e54946..3dac70b 100644
--- a/drivers/pci/host/pci-imx6.c
+++ b/drivers/pci/host/pci-imx6.c
@@ -620,6 +620,7 @@ static int imx6_pcie_start_link(struct pcie_port *pp)
 out:
 	if (ret) {
 		dev_err(pp->dev, "Failed to bring link up!\n");
+		imx6_pcie_assert_core_reset(pp);
 		clk_disable_unprepare(imx6_pcie->pcie);
 		if (!IS_ENABLED(CONFIG_EP_MODE_IN_EP_RC_SYS)
 			&& !IS_ENABLED(CONFIG_RC_MODE_IN_EP_RC_SYS))
-- 
1.7.5.4

