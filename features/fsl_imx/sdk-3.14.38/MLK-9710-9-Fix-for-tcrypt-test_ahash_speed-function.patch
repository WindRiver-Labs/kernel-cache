From 4694fa2e4f611dfb9b8799f459e428b4bd7e5176 Mon Sep 17 00:00:00 2001
From: Winston Hudson <winston.hudson@freescale.com>
Date: Sun, 21 Jul 2013 15:18:38 -0700
Subject: [PATCH 1532/1594] MLK-9710-9 Fix for tcrypt test_ahash_speed
 function

commit 53459111ccfada38f3c02281cc1cfb24c9a979fa from
git://git.freescale.com/imx/linux-2.6-imx.git

This patch adds a null pointer check and explicitly frees memory in the
tcrypt.c function test_ahash_speed.

Signed-off-by: Winston Hudson <winston.hudson@freescale.com>
(cherry picked from commit 9bea544c31565260e5cbec2da14f4b2e89d21656)
---
 crypto/tcrypt.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/crypto/tcrypt.c b/crypto/tcrypt.c
index 2184460..eaa8765 100644
--- a/crypto/tcrypt.c
+++ b/crypto/tcrypt.c
@@ -934,10 +934,16 @@ static void test_ahash_speed(const char *algo, unsigned int secs,
 	char *output = kmalloc(output_size, GFP_KERNEL);
 	int i, ret;
 
+	if (!output) {
+		printk(KERN_INFO "\nUnable to allocate output buffer memory\n");
+		return;
+	}
+
 	tfm = crypto_alloc_ahash(algo, 0, 0);
 	if (IS_ERR(tfm)) {
 		pr_err("failed to load transform for %s: %ld\n",
 		       algo, PTR_ERR(tfm));
+		kfree(output);
 		return;
 	}
 
@@ -990,6 +996,7 @@ static void test_ahash_speed(const char *algo, unsigned int secs,
 	ahash_request_free(req);
 
 out:
+	kfree(output);
 	crypto_free_ahash(tfm);
 }
 
-- 
1.7.5.4

