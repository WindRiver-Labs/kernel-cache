From 0894edd71313e79e14ecd114bde4de4914e1f2e2 Mon Sep 17 00:00:00 2001
From: Fugang Duan <b38611@freescale.com>
Date: Mon, 4 Aug 2014 13:24:08 +0800
Subject: [PATCH 0121/1594] ENGR00329822-03 tty: serial: imx: separate DMA and
 flow control features

commit c21d59ec9d4242f16157a08a3401da6fdfd1165b from
git://git.freescale.com/imx/linux-2.6-imx.git

The current implenention is that DMA feature is dependent on hw flow
control feature. But Uart DMA feature has nothing related to flow
control feature, so separate them.

Signed-off-by: Fugang Duan <B38611@freescale.com>
(cherry picked from commit 05dc8b394aa5874fbb6a2d84d5e18b7c1227976b)
---
 drivers/tty/serial/imx.c |   13 +++++++------
 1 files changed, 7 insertions(+), 6 deletions(-)

diff --git a/drivers/tty/serial/imx.c b/drivers/tty/serial/imx.c
index c288f72..109c0a0 100644
--- a/drivers/tty/serial/imx.c
+++ b/drivers/tty/serial/imx.c
@@ -1160,7 +1160,13 @@ static int imx_startup(struct uart_port *port)
 	while (!(readl(sport->port.membase + UCR2) & UCR2_SRST) && (--i > 0))
 		udelay(1);
 
-	INIT_WORK(&sport->tsk_dma_tx, dma_tx_work);
+	/* Can we enable the DMA support? */
+	if (is_imx6q_uart(sport) && !uart_console(port)
+		&& !sport->dma_is_inited)
+		imx_uart_dma_init(sport);
+
+	if (sport->dma_is_inited)
+		INIT_WORK(&sport->tsk_dma_tx, dma_tx_work);
 
 	spin_lock_irqsave(&sport->port.lock, flags);
 
@@ -1356,11 +1362,6 @@ imx_set_termios(struct uart_port *port, struct ktermios *termios,
 			} else {
 				ucr2 |= UCR2_CTSC;
 			}
-
-			/* Can we enable the DMA support? */
-			if (is_imx6q_uart(sport) && !uart_console(port)
-				&& !sport->dma_is_inited)
-				imx_uart_dma_init(sport);
 		} else {
 			termios->c_cflag &= ~CRTSCTS;
 		}
-- 
1.7.5.4

