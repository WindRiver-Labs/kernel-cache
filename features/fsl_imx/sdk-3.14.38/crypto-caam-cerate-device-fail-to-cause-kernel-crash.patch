From 88826d5704ce9fc6fd725361d7a14d55dc359020 Mon Sep 17 00:00:00 2001
From: Limeng <Meng.Li@windriver.com>
Date: Wed, 2 Mar 2016 18:09:55 +0800
Subject: [PATCH 1593/1594] crypto: caam: cerate device fail to cause kernel
 crash

Original code to get sm devide using function of_platform_device_create(),
but it fails. Because sm devide has been created during parsing DTB.
So return NULL when call of_platform_device_create(), and then cause
kernel crash.

Detail crash core dump information as below:
Unable to handle kernel NULL pointer dereference at virtual address 00000058
pgd = 80004000
[00000058] *pgd=00000000
Internal error: Oops: 5 [#1] PREEMPT SMP ARM
Modules linked in:
CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.1.17-WR8.0.0.0_standard #3
Hardware name: Freescale i.MX6 Quad/DualLite (Device Tree)
task: a80d8000 ti: a80c2000 task.ti: a80c2000
PC is at caam_sm_example_init+0x28/0xa6c
LR is at caam_sm_test_init+0x50/0x60
pc : [<80684af4>]    lr : [<80c56a78>]    psr: a0000113
sp : a80c3d28  ip : a80c3e98  fp : a80c3e94
r10: 00000000  r9 : 80d5cb00  r8 : 80cb72e0
r7 : 80cb72e0  r6 : 00000000  r5 : 80c56a28  r4 : 00000000
r3 : a8356cd0  r2 : 00000000  r1 : 00000000  r0 : a826f000
Flags: NzCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment kernel
Control: 10c5387d  Table: 1000404a  DAC: 00000015
Process swapper/0 (pid: 1, stack limit = 0xa80c2210)
Stack: (0xa80c3d28 to 0xa80c4000)
3d20:                   a80c3e24 a88e0210 80a90ae1 00000000 a80c3e04 a80c3d48
3d40: 8046e000 8007a80c 80a9e38b a80c3e24 00000006 00000000 53425553 45545359
3d60: 6c703d4d 6f667461 44006d72 43495645 702b3d45 6674616c 3a6d726f 31303132
3d80: 2e303030 0030726a a80c3df4 a80c3d98 a80c3db4 a80c3da0 8005ce04 80073a28
3da0: a8603cc0 a8603cd2 a80c3e04 a80c3dc0 8038af4c 80389584 60000113 ff0a0005
3dc0: ffffffff 80a4dfab 80692f80 8069169c a80c3df4 a80c3de0 8005ce04 80073a28
3de0: 00000001 a80a2e5c a80c3e0c a80c3df8 8005cf10 8005cdfc a80a2e5c a80a2e5c
3e00: a81c5c34 808a065c a80c3e24 a80c3e18 808a065c 8005b7f4 a80c3e44 a80c3e28
3e20: 80895f94 808a0634 a80c3e60 ab644d34 80693fd0 80cb72e0 a80c3e5c a80c3e48
3e40: 80895fe8 80895f34 a826f010 ab644d34 a80c3e84 a80c3e60 8047013c 80895fd0
3e60: a80a2e5c 00000000 a80c3e94 a8603cc0 80c56a28 00000000 80cb72e0 80cb72e0
3e80: 80d5cb00 00000000 a80c3ea4 a80c3e98 80c56a78 80684ad8 a80c3f1c a80c3ea8
3ea0: 80009774 80c56a34 00000000 80cc2d14 60000113 80053d84 a80c3e00 a80c3ec8
3ec0: 80c03600 803881c8 abfff916 abfff91c a80c3f1c a80c3ee0 80053fc8 80c035f0
3ee0: 0000010c 00000006 00000006 0000010d 80c7b9b0 00000006 00000006 0000010d
3f00: 80ca9868 80c7b9cc 80d5cb00 80d5cb00 a80c3f94 a80c3f20 80c03eb0 8000966c
3f20: 00000006 00000006 80c035e4 96bb27ad b5bf9117 c7359ffb 35ebfb9e dc23ef77
3f40: 6fffdfd5 fe5b39fb a80d8540 80896364 00000000 808a0724 a80c3f74 a80c3f68
3f60: 808a0724 8005b7f4 a80c3f94 a80c3f78 80d5cb00 80896364 00000000 00000000
3f80: 00000000 00000000 a80c3fac a80c3f98 80896380 80c03d2c 00000000 80896364
3fa0: 00000000 a80c3fb0 8000f3c8 80896370 00000000 00000000 00000000 00000000
3fc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
3fe0: 00000000 00000000 00000000 00000000 00000013 00000000 7fef5c9e b73778df
[<80684af4>] (caam_sm_example_init) from [<80c56a78>] (caam_sm_test_init+0x50/0x60)
[<80c56a78>] (caam_sm_test_init) from [<80009774>] (do_one_initcall+0x114/0x1c4)
[<80009774>] (do_one_initcall) from [<80c03eb0>] (kernel_init_freeable+0x190/0x28c)
[<80c03eb0>] (kernel_init_freeable) from [<80896380>] (kernel_init+0x1c/0xf4)
[<80896380>] (kernel_init) from [<8000f3c8>] (ret_from_fork+0x14/0x2c)
Code: e3a03000 e50b3140 e5903068 e5934004 (e5943058)
---[ end trace 895a49303adc3173 ]---
Kernel panic - not syncing: Attempted to kill init! exitcode=0x0000000b

Modify code to get sm device with function of_find_device_by_node().

Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/crypto/caam/sm_store.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/crypto/caam/sm_store.c b/drivers/crypto/caam/sm_store.c
index 21d4d82..7fa13db 100644
--- a/drivers/crypto/caam/sm_store.c
+++ b/drivers/crypto/caam/sm_store.c
@@ -1013,7 +1013,7 @@ int caam_sm_startup(struct platform_device *pdev)
 	/* Create the dev */
 #ifdef CONFIG_OF
 	np = of_find_compatible_node(NULL, NULL, "fsl,imx6q-caam-sm");
-	sm_pdev = of_platform_device_create(np, "caam_sm", ctrldev);
+	sm_pdev = of_find_device_by_node(np);
 #else
 	sm_pdev = platform_device_register_data(ctrldev, "caam_sm", 0,
 						smpriv,
-- 
1.7.5.4

