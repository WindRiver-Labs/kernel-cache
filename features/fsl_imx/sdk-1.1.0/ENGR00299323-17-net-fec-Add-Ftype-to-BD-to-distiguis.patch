From c2996122916b88830a3c8a1a8b1e7ec3c914ae6f Mon Sep 17 00:00:00 2001
From: Fugang Duan <B38611@freescale.com>
Date: Mon, 20 Jan 2014 09:56:32 +0800
Subject: [PATCH 1036/1074] ENGR00299323-17 net:fec: Add Ftype to BD to
 distiguish three queues for AVB

Add Ftype field to BD to distiguish three queues for AVB:
0 -> Best Effort
1 -> ClassA
2 -> ClassB

Signed-off-by: Fugang Duan <B38611@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/net/ethernet/freescale/fec.h      |    1 +
 drivers/net/ethernet/freescale/fec_main.c |    3 +++
 2 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fec.h b/drivers/net/ethernet/freescale/fec.h
index a1685fc..66974db 100644
--- a/drivers/net/ethernet/freescale/fec.h
+++ b/drivers/net/ethernet/freescale/fec.h
@@ -336,6 +336,7 @@ struct bufdesc_ex {
 #define RCMR_CMP_2		(RCMR_CMP_CFG(4, 0) | RCMR_CMP_CFG(5, 1) | \
 				RCMR_CMP_CFG(6, 2) | RCMR_CMP_CFG(7, 3))
 #define RCMR_CMP(X)		((X == 1) ? RCMR_CMP_1 : RCMR_CMP_2)
+#define FEC_TX_BD_FTYPE(X)	((X & 0xF) << 20)
 
 /* ENET interrupt coalescing macro define */
 #define FEC_ITR_CLK_SEL		(0x1 << 30)
diff --git a/drivers/net/ethernet/freescale/fec_main.c b/drivers/net/ethernet/freescale/fec_main.c
index 54544c2..1863680 100644
--- a/drivers/net/ethernet/freescale/fec_main.c
+++ b/drivers/net/ethernet/freescale/fec_main.c
@@ -427,6 +427,9 @@ fec_enet_start_xmit(struct sk_buff *skb, struct net_device *ndev)
 			if (skb->ip_summed == CHECKSUM_PARTIAL)
 				ebdp->cbd_esc |= BD_ENET_TX_PINS;
 		}
+
+		if (id_entry->driver_data & FEC_QUIRK_HAS_AVB)
+			ebdp->cbd_esc |= FEC_TX_BD_FTYPE(queue);
 	}
 
 	/* Send it on its way.  Tell FEC it's ready, interrupt when done,
-- 
1.7.5.4

