From 990d395bd10837a7d8710b3d64563bb64f89aa28 Mon Sep 17 00:00:00 2001
From: Peter Chen <peter.chen@freescale.com>
Date: Thu, 9 Oct 2014 16:17:11 +0800
Subject: [PATCH 0935/1074] MLK-9670-1 usb: chipidea: imx: bug for trying to
 do suspend again when in low power mode

If the core's probe has failed, its suspend/resume API will not be called.
In that case, the glue layer needs to guarantee its low power state by
itself, eg, the controller may be already in low power mode when the
controller system suspend routine has been called since the core can't
resume controller any more.

When this bug occurs, it triggers below dump:

[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
------------[ cut here ]------------
WARNING: at drivers/clk/clk.c:842 clk_disable+0x18/0x24()
Modules linked in:
CPU: 0 PID: 725 Comm: sh Tainted: G        W    3.10.53-02271-gb01578a-dirty #3813
[<80013b00>] (unwind_backtrace+0x0/0xf4) from [<80011524>] (show_stack+0x10/0x14)
[<80011524>] (show_stack+0x10/0x14) from [<8002bd10>] (warn_slowpath_common+0x54/0x6c)
[<8002bd10>] (warn_slowpath_common+0x54/0x6c) from [<8002bdc4>] (warn_slowpath_null+0x1c/0x24)
[<8002bdc4>] (warn_slowpath_null+0x1c/0x24) from [<804ce3cc>] (clk_disable+0x18/0x24)
[<804ce3cc>] (clk_disable+0x18/0x24) from [<803ee724>] (imx_controller_suspend+0x38/0x74)
[<803ee724>] (imx_controller_suspend+0x38/0x74) from [<8031271c>] (platform_pm_suspend+0x2c/0x54)
[<8031271c>] (platform_pm_suspend+0x2c/0x54) from [<80317340>] (dpm_run_callback.isra.6+0x2c/0x74)
[<80317340>] (dpm_run_callback.isra.6+0x2c/0x74) from [<80318050>] (__device_suspend+0x104/0x230)
[<80318050>] (__device_suspend+0x104/0x230) from [<80318838>] (dpm_suspend+0x60/0x22c)
[<80318838>] (dpm_suspend+0x60/0x22c) from [<8005e678>] (suspend_devices_and_enter+0x50/0x3f0)
[<8005e678>] (suspend_devices_and_enter+0x50/0x3f0) from [<8005ec34>] (pm_suspend+0x21c/0x298)
[<8005ec34>] (pm_suspend+0x21c/0x298) from [<8005db4c>] (state_store+0x6c/0xbc)
[<8005db4c>] (state_store+0x6c/0xbc) from [<80271f8c>] (kobj_attr_store+0x14/0x20)
[<80271f8c>] (kobj_attr_store+0x14/0x20) from [<8011ea78>] (sysfs_write_file+0x160/0x190)
[<8011ea78>] (sysfs_write_file+0x160/0x190) from [<800c6b04>] (vfs_write+0xb4/0x194)
[<800c6b04>] (vfs_write+0xb4/0x194) from [<800c707c>] (SyS_write+0x3c/0x78)
[<800c707c>] (SyS_write+0x3c/0x78) from [<8000e080>] (ret_fast_syscall+0x0/0x30)
---[ end trace 1aee8e379489db2f ]---
------------[ cut here ]------------
WARNING: at drivers/clk/clk.c:751 clk_unprepare+0x14/0x1c()
Modules linked in:
CPU: 0 PID: 725 Comm: sh Tainted: G        W    3.10.53-02271-gb01578a-dirty #3813
[<80013b00>] (unwind_backtrace+0x0/0xf4) from [<80011524>] (show_stack+0x10/0x14)
[<80011524>] (show_stack+0x10/0x14) from [<8002bd10>] (warn_slowpath_common+0x54/0x6c)
[<8002bd10>] (warn_slowpath_common+0x54/0x6c) from [<8002bdc4>] (warn_slowpath_null+0x1c/0x24)
[<8002bdc4>] (warn_slowpath_null+0x1c/0x24) from [<804cf698>] (clk_unprepare+0x14/0x1c)
[<804cf698>] (clk_unprepare+0x14/0x1c) from [<803ee72c>] (imx_controller_suspend+0x40/0x74)
[<803ee72c>] (imx_controller_suspend+0x40/0x74) from [<8031271c>] (platform_pm_suspend+0x2c/0x54)
[<8031271c>] (platform_pm_suspend+0x2c/0x54) from [<80317340>] (dpm_run_callback.isra.6+0x2c/0x74)
[<80317340>] (dpm_run_callback.isra.6+0x2c/0x74) from [<80318050>] (__device_suspend+0x104/0x230)
[<80318050>] (__device_suspend+0x104/0x230) from [<80318838>] (dpm_suspend+0x60/0x22c)
[<80318838>] (dpm_suspend+0x60/0x22c) from [<8005e678>] (suspend_devices_and_enter+0x50/0x3f0)
[<8005e678>] (suspend_devices_and_enter+0x50/0x3f0) from [<8005ec34>] (pm_suspend+0x21c/0x298)
[<8005ec34>] (pm_suspend+0x21c/0x298) from [<8005db4c>] (state_store+0x6c/0xbc)
[<8005db4c>] (state_store+0x6c/0xbc) from [<80271f8c>] (kobj_attr_store+0x14/0x20)
[<80271f8c>] (kobj_attr_store+0x14/0x20) from [<8011ea78>] (sysfs_write_file+0x160/0x190)
[<8011ea78>] (sysfs_write_file+0x160/0x190) from [<800c6b04>] (vfs_write+0xb4/0x194)
[<800c6b04>] (vfs_write+0xb4/0x194) from [<800c707c>] (SyS_write+0x3c/0x78)
[<800c707c>] (SyS_write+0x3c/0x78) from [<8000e080>] (ret_fast_syscall+0x0/0x30)
---[ end trace 1aee8e379489db30 ]---

Signed-off-by: Peter Chen <peter.chen@freescale.com>
---
 drivers/usb/chipidea/ci_hdrc_imx.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/chipidea/ci_hdrc_imx.c b/drivers/usb/chipidea/ci_hdrc_imx.c
index 79da43b..9af016a 100644
--- a/drivers/usb/chipidea/ci_hdrc_imx.c
+++ b/drivers/usb/chipidea/ci_hdrc_imx.c
@@ -530,6 +530,9 @@ static int ci_hdrc_imx_suspend(struct device *dev)
 	int ret;
 	/* The core should make sure the controller is active now */
 	WARN_ON(data->in_lpm);
+	if (data->in_lpm)
+		/* The core's suspend doesn't run */
+		return 0;
 
 	if (device_may_wakeup(dev) && data->usbmisc_data) {
 		ret = imx_usbmisc_set_wakeup(data->usbmisc_data, true);
@@ -540,6 +543,7 @@ static int ci_hdrc_imx_suspend(struct device *dev)
 			return ret;
 		}
 	}
+
 	return imx_controller_suspend(dev);
 }
 
-- 
1.7.5.4

