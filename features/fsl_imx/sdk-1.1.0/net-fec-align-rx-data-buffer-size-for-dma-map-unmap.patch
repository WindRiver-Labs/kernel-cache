From 1a5cd2d51c2e8b9d8a55d6de2e7f78ac09259e8e Mon Sep 17 00:00:00 2001
From: Fugang Duan <B38611@freescale.com>
Date: Tue, 25 Feb 2014 09:35:13 +0800
Subject: [PATCH 1043/1074] net: fec: align rx data buffer size for dma
 map/unmap

commit b64bf4b7dded4febb8e1f319eb6b9d419cbbd856 upstream

Align allocated rx data buffer size for dma map/unmap, otherwise
kernel print warning when enable DMA_API_DEBUG.

Signed-off-by: Fugang Duan <B38611@freescale.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Fix context to apply to WRL kernel]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/net/ethernet/freescale/fec_main.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fec_main.c b/drivers/net/ethernet/freescale/fec_main.c
index 0d1332f..e083878 100644
--- a/drivers/net/ethernet/freescale/fec_main.c
+++ b/drivers/net/ethernet/freescale/fec_main.c
@@ -1047,7 +1047,8 @@ fec_enet_rx(struct net_device *ndev, int budget)
 			data = (__u8 *)__va(bdp->cbd_bufaddr);
 
 			dma_unmap_single(&fep->pdev->dev, bdp->cbd_bufaddr,
-					FEC_ENET_TX_FRSIZE, DMA_FROM_DEVICE);
+					FEC_ENET_RX_FRSIZE - FEC_ALIGNMENT,
+					DMA_FROM_DEVICE);
 
 			if (id_entry->driver_data & FEC_QUIRK_SWAP_FRAME)
 				swap_buffer(data, pkt_len);
@@ -1130,7 +1131,8 @@ fec_enet_rx(struct net_device *ndev, int budget)
 			}
 
 			bdp->cbd_bufaddr = dma_map_single(&fep->pdev->dev, data,
-					FEC_ENET_TX_FRSIZE, DMA_FROM_DEVICE);
+						FEC_ENET_RX_FRSIZE - FEC_ALIGNMENT,
+						DMA_FROM_DEVICE);
 			/* here dma mapping shouldn't be error, just avoid kernel dump */
 			if (dma_mapping_error(&fep->pdev->dev, bdp->cbd_bufaddr))
 				netdev_err(ndev, "Rx DMA memory map failed\n");
-- 
1.7.5.4

