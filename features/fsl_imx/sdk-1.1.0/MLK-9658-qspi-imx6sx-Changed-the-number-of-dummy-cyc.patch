From acee6079b30d59824568aee9a6346bcf497056b0 Mon Sep 17 00:00:00 2001
From: Allen Xu <b45815@freescale.com>
Date: Wed, 1 Oct 2014 16:57:25 -0500
Subject: [PATCH 0933/1074] MLK-9658 qspi: imx6sx: Changed the number of dummy
 cycle for S25FL128S QSPI

The number of dummy cycle for S25FL128S QSPI DDR Quad I/O Read depends
on the Latency codes in CR register.

Freq.(MHz)  LC       Mode     Dummy
<=50        11        1        3
<=66        00        1        6
<=66        01        1        7
<=66        10        1        8

Since S25FL128S QSPI default LC is 00 and freq is less than 66MHz, the
number of dummy cycle should be changed from 3 to 6.

The issue was covered because there is another bug, the PAD for Mode
should be PAD4 rather than PAD1 in previous implementation, so it took 3
extra cycles to send Mode, which coincidentally filled the 3 dummy clock
cycle gap.

The number of dummy cycle for 4-byte access has been changed as well.

Signed-off-by: Allen Xu <b45815@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/mtd/spi-nor/fsl-quadspi.c |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/drivers/mtd/spi-nor/fsl-quadspi.c b/drivers/mtd/spi-nor/fsl-quadspi.c
index 764189d..74a72f7 100644
--- a/drivers/mtd/spi-nor/fsl-quadspi.c
+++ b/drivers/mtd/spi-nor/fsl-quadspi.c
@@ -404,16 +404,16 @@ static void fsl_qspi_init_lut(struct fsl_qspi *q)
 		if (q->nor_size <= SZ_16M) {
 			cmd = OPCODE_DDR_QUAD_IO_READ;
 			addrlen = ADDR24BIT;
-			dummy = 3;
+			dummy = 6;
 		} else {
 			cmd = OPCODE_DDR_QUAD_IO_READ;
 			addrlen = ADDR32BIT;
-			dummy = 7;
+			dummy = 6;
 		}
 
 		writel(LUT0(CMD, PAD1, cmd) | LUT1(ADDR_DDR, PAD4, addrlen),
 			base + QUADSPI_LUT(lut_base));
-		writel(LUT0(MODE_DDR, PAD1, 4) | LUT1(DUMMY, PAD1, dummy),
+		writel(LUT0(MODE_DDR, PAD4, 0xff) | LUT1(DUMMY, PAD1, dummy),
 			base + QUADSPI_LUT(lut_base + 1));
 		writel(LUT0(READ_DDR, PAD4, rxfifo) | LUT1(JMP_ON_CS, PAD1, 0),
 			base + QUADSPI_LUT(lut_base + 2));
-- 
1.7.5.4

