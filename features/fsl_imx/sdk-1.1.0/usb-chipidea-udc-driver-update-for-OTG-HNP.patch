From 584b2a0aaa9254065792bf49cba1fb63d323308b Mon Sep 17 00:00:00 2001
From: Li Jun <B47624@freescale.com>
Date: Wed, 23 Apr 2014 15:56:47 +0800
Subject: [PATCH 0799/1074] usb: chipidea: udc: driver update for OTG HNP.

commit 95f5555fa0f0176da338e8f42bca08f236032832 upstream

Add b_hnp_enable request handling and enable gadget->is_otg

Signed-off-by: Peter Chen <peter.chen@freescale.com>
Acked-by: Peter Chen <peter.chen@freescale.com>
Signed-off-by: Li Jun <b47624@freescale.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
---
 drivers/usb/chipidea/udc.c |   10 +++++++++-
 1 files changed, 9 insertions(+), 1 deletions(-)

diff --git a/drivers/usb/chipidea/udc.c b/drivers/usb/chipidea/udc.c
index fe1016a..5f0c20d 100644
--- a/drivers/usb/chipidea/udc.c
+++ b/drivers/usb/chipidea/udc.c
@@ -1095,6 +1095,14 @@ __acquires(ci->lock)
 					default:
 						break;
 					}
+					break;
+				case USB_DEVICE_B_HNP_ENABLE:
+					if (ci_otg_is_fsm_mode(ci)) {
+						ci->gadget.b_hnp_enable = 1;
+						err = isr_setup_status_phase(
+									ci);
+					}
+					break;
 				default:
 					goto delegate;
 				}
@@ -1812,7 +1820,7 @@ static int udc_start(struct ci_hdrc *ci)
 	ci->gadget.ops          = &usb_gadget_ops;
 	ci->gadget.speed        = USB_SPEED_UNKNOWN;
 	ci->gadget.max_speed    = USB_SPEED_HIGH;
-	ci->gadget.is_otg       = 0;
+	ci->gadget.is_otg       = ci->is_otg ? 1 : 0;
 	ci->gadget.name         = ci->platdata->name;
 
 	INIT_LIST_HEAD(&ci->gadget.ep_list);
-- 
1.7.5.4

