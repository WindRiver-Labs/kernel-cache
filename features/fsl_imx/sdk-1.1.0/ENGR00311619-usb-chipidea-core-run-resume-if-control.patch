From 9d3fff0f6031af34340398ea4da710522857d052 Mon Sep 17 00:00:00 2001
From: Peter Chen <peter.chen@freescale.com>
Date: Thu, 3 Jul 2014 10:17:35 +0800
Subject: [PATCH 0889/1074] ENGR00311619 usb: chipidea: core: run resume if
 controller is at low power mode

Controller needs to be active during system suspend, otherwise the core
may run resume when the parent is still at suspend if other driver's
suspend fails, it occurs before parent's suspend has not started,
but the core suspend has finished.

Signed-off-by: Peter Chen <peter.chen@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/usb/chipidea/core.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/chipidea/core.c b/drivers/usb/chipidea/core.c
index a4d348b..25340db 100644
--- a/drivers/usb/chipidea/core.c
+++ b/drivers/usb/chipidea/core.c
@@ -843,6 +843,15 @@ static int ci_suspend(struct device *dev)
 	struct ci_hdrc *ci = dev_get_drvdata(dev);
 	int ret;
 
+	/*
+	 * Controller needs to be active during suspend, otherwise the core
+	 * may run resume when the parent is at suspend if other driver's
+	 * suspend fails, it occurs before parent's suspend has not started,
+	 * but the core suspend has finished.
+	 */
+	if (ci->in_lpm)
+		pm_runtime_resume(dev);
+
 	ret = ci_controller_suspend(dev);
 	if (ret)
 		return ret;
-- 
1.7.5.4

