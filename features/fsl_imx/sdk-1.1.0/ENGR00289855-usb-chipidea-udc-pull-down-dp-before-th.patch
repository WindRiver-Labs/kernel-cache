From e26e07fc960cb75f893c407e29b20056c168d3ac Mon Sep 17 00:00:00 2001
From: Peter Chen <peter.chen@freescale.com>
Date: Wed, 27 Nov 2013 15:35:42 +0800
Subject: [PATCH 0654/1074] ENGR00289855 usb: chipidea: udc: pull down dp
 before the charger detection

If rom code or bootloader has used usb before loading kernel, the dp
may still be pulled up, it will cause USB charger detection fail.

Signed-off-by: Peter Chen <peter.chen@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/usb/chipidea/udc.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/usb/chipidea/udc.c b/drivers/usb/chipidea/udc.c
index b010422..2bd6922 100644
--- a/drivers/usb/chipidea/udc.c
+++ b/drivers/usb/chipidea/udc.c
@@ -1501,10 +1501,12 @@ static int ci_udc_vbus_session(struct usb_gadget *_gadget, int is_active)
 		 * It can make disconnect interrupt (BSV 1->0) occur when
 		 * the cable is disconnected.
 		 */
-		if (is_active)
+		if (is_active) {
 			pm_runtime_get_sync(&_gadget->dev);
-		else
+			hw_write(ci, OP_USBCMD, USBCMD_RS, 0);
+		} else {
 			pm_runtime_put_sync(&_gadget->dev);
+		}
 
 		ret = ci->platdata->notify_event
 			(ci, CI_HDRC_CONTROLLER_CHARGER_EVENT);
-- 
1.7.5.4

