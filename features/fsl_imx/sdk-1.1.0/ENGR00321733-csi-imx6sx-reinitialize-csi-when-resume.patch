From 8a6fd1428a88b8d8b228842e40ca7fcd8fe02d87 Mon Sep 17 00:00:00 2001
From: Robby Cai <r63905@freescale.com>
Date: Tue, 8 Jul 2014 14:26:19 +0800
Subject: [PATCH 0890/1074] ENGR00321733 csi: imx6sx: reinitialize csi when
 resume

The CSI will be reset to initial state because dispmix takes effect
and power off specific modules when suspend. Hence the reinitialization
is needed when resume to make it work properly, otherwise the captured
images are not correct.

Signed-off-by: Robby Cai <r63905@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/media/platform/mxc/capture/fsl_csi.c |   41 ++++++++++++++++++++++++++
 1 files changed, 41 insertions(+), 0 deletions(-)

diff --git a/drivers/media/platform/mxc/capture/fsl_csi.c b/drivers/media/platform/mxc/capture/fsl_csi.c
index 602899d..0121234 100644
--- a/drivers/media/platform/mxc/capture/fsl_csi.c
+++ b/drivers/media/platform/mxc/capture/fsl_csi.c
@@ -419,6 +419,8 @@ static int csi_probe(struct platform_device *pdev)
 		return PTR_ERR(dcic_clk);
 	}
 
+	platform_set_drvdata(pdev, csi);
+
 	csi_clk_enable();
 	csihw_reset(csi);
 	csi_init_interface(csi);
@@ -431,13 +433,52 @@ err:
 
 static int csi_remove(struct platform_device *pdev)
 {
+	struct csi_soc *csi = platform_get_drvdata(pdev);
+
+	csi->online = false;
+	platform_set_drvdata(pdev, NULL);
+
 	return 0;
 }
 
+#ifdef CONFIG_PM_SLEEP
+static int csi_suspend(struct device *dev)
+{
+	struct csi_soc *csi = dev_get_drvdata(dev);
+
+	csi->online = false;
+
+	return 0;
+}
+
+static int csi_resume(struct device *dev)
+{
+	struct csi_soc *csi = dev_get_drvdata(dev);
+
+	csi_clk_enable();
+	csihw_reset(csi);
+	csi_init_interface(csi);
+	csi_dmareq_rff_disable(csi);
+	csi_clk_disable();
+
+	csi->online = true;
+
+	return 0;
+}
+#else
+#define	csi_suspend	NULL
+#define	csi_resume	NULL
+#endif
+
+static const struct dev_pm_ops csi_pm_ops = {
+	SET_SYSTEM_SLEEP_PM_OPS(csi_suspend, csi_resume)
+};
+
 static struct platform_driver csi_driver = {
 	.driver = {
 		   .name = "fsl_csi",
 		   .of_match_table = of_match_ptr(fsl_csi_dt_ids),
+		   .pm = &csi_pm_ops,
 		   },
 	.probe = csi_probe,
 	.remove = csi_remove,
-- 
1.7.5.4

