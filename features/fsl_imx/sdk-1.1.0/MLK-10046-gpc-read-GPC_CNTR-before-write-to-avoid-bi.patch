From 688c5ee45eafd43f879d797aa7dffb1855cc034f Mon Sep 17 00:00:00 2001
From: Sandor Yu <R01008@freescale.com>
Date: Sat, 20 Dec 2014 11:05:46 +0800
Subject: [PATCH 0557/1074] MLK-10046: gpc: read GPC_CNTR before write to
 avoid bits overwrite

On imx6sx, bit 17 and bit18 will power off/on VADC directly,
so read GPC_CNTR firstly before write to avoid touching other bits.

Signed-off-by: Sandor Yu <R01008@freescale.com>
(cherry picked from commit ce70fc330c33dd33a73e2f1c8d00f29ec4d68b1d)
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 arch/arm/mach-imx/gpc.c |    8 ++++++--
 1 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-imx/gpc.c b/arch/arm/mach-imx/gpc.c
index f19a35c..df02750 100644
--- a/arch/arm/mach-imx/gpc.c
+++ b/arch/arm/mach-imx/gpc.c
@@ -123,12 +123,14 @@ static void imx_disp_clk(bool enable)
 
 static void imx_gpc_dispmix_on(void)
 {
+	u32 val = readl_relaxed(gpc_base + GPC_CNTR);
+
 	if ((cpu_is_imx6sl() &&
 		imx_get_soc_revision() >= IMX_CHIP_REVISION_1_2) || cpu_is_imx6sx()) {
 		imx_disp_clk(true);
 
 		writel_relaxed(0x0, gpc_base + GPC_PGC_DISP_PGCR_OFFSET);
-		writel_relaxed(0x20, gpc_base + GPC_CNTR);
+		writel_relaxed(0x20 | val, gpc_base + GPC_CNTR);
 		while (readl_relaxed(gpc_base + GPC_CNTR) & 0x20)
 			;
 		writel_relaxed(0x1, gpc_base + GPC_PGC_DISP_SR_OFFSET);
@@ -139,6 +141,8 @@ static void imx_gpc_dispmix_on(void)
 
 static void imx_gpc_dispmix_off(void)
 {
+	u32 val = readl_relaxed(gpc_base + GPC_CNTR);
+
 	if ((cpu_is_imx6sl() &&
 		imx_get_soc_revision() >= IMX_CHIP_REVISION_1_2) || cpu_is_imx6sx()) {
 		imx_disp_clk(true);
@@ -148,7 +152,7 @@ static void imx_gpc_dispmix_off(void)
 		writel_relaxed(0xFFFFFFFF,
 				gpc_base + GPC_PGC_DISP_PDNSCR_OFFSET);
 		writel_relaxed(0x1, gpc_base + GPC_PGC_DISP_PGCR_OFFSET);
-		writel_relaxed(0x10, gpc_base + GPC_CNTR);
+		writel_relaxed(0x10 | val, gpc_base + GPC_CNTR);
 		while (readl_relaxed(gpc_base + GPC_CNTR) & 0x10)
 			;
 
-- 
1.7.5.4

