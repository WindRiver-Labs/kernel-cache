From ec3f13e15007e97d3997c6632125c3705af373b6 Mon Sep 17 00:00:00 2001
From: Richard Zhu <Richard.Zhu@freescale.com>
Date: Wed, 29 Oct 2014 16:15:06 +0800
Subject: [PATCH 0520/1074] MLK-9804 PCI: imx6: enable pcie on imx6sx
 sabreauto board

- enable pcie on imx6sx sabreauto board.
- replace set_gpio_value() by gpio_set_value_cansleep()

Signed-off-by: Richard Zhu <Richard.Zhu@freescale.com>
(cherry picked from commit 49f817d04a6fd6976390f174140f103fdc8e3fb5)
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 arch/arm/boot/dts/imx6sx-sabreauto.dts |   13 +++++++++++++
 drivers/pci/host/pci-imx6.c            |    6 +++---
 2 files changed, 16 insertions(+), 3 deletions(-)

diff --git a/arch/arm/boot/dts/imx6sx-sabreauto.dts b/arch/arm/boot/dts/imx6sx-sabreauto.dts
index 0b8cffd..de9752b 100644
--- a/arch/arm/boot/dts/imx6sx-sabreauto.dts
+++ b/arch/arm/boot/dts/imx6sx-sabreauto.dts
@@ -441,6 +441,14 @@
 		resets = <&max7310_reset>;
 	};
 
+	max7310_b: gpio@32 {
+		compatible = "maxim,max7310";
+		reg = <0x32>;
+		gpio-controller;
+		#gpio-cells = <2>;
+		resets = <&max7310_reset>;
+	};
+
 	mma8451@1c {
 		compatible = "fsl,mma8451";
 		reg = <0x1c>;
@@ -510,6 +518,11 @@
 	status = "okay";
 };
 
+&pcie {
+	reset-gpio = <&max7310_b 3 0>;
+	status = "okay";
+};
+
 &uart1 {
 	pinctrl-names = "default";
 	pinctrl-0 = <&pinctrl_uart1_1>;
diff --git a/drivers/pci/host/pci-imx6.c b/drivers/pci/host/pci-imx6.c
index 6555827..60d61fc 100644
--- a/drivers/pci/host/pci-imx6.c
+++ b/drivers/pci/host/pci-imx6.c
@@ -233,7 +233,7 @@ static int imx6_pcie_deassert_core_reset(struct pcie_port *pp)
 	int ret;
 
 	if (gpio_is_valid(imx6_pcie->power_on_gpio))
-		gpio_set_value(imx6_pcie->power_on_gpio, 1);
+		gpio_set_value_cansleep(imx6_pcie->power_on_gpio, 1);
 
 	regmap_update_bits(imx6_pcie->iomuxc_gpr, IOMUXC_GPR1,
 			IMX6Q_GPR1_PCIE_TEST_PD, 0 << 18);
@@ -269,9 +269,9 @@ static int imx6_pcie_deassert_core_reset(struct pcie_port *pp)
 
 	/* Some boards don't have PCIe reset GPIO. */
 	if (gpio_is_valid(imx6_pcie->reset_gpio)) {
-		gpio_set_value(imx6_pcie->reset_gpio, 0);
+		gpio_set_value_cansleep(imx6_pcie->reset_gpio, 0);
 		msleep(100);
-		gpio_set_value(imx6_pcie->reset_gpio, 1);
+		gpio_set_value_cansleep(imx6_pcie->reset_gpio, 1);
 	}
 	return 0;
 
-- 
1.7.5.4

