From 482a1967b36a43521e6c55587212ea5fdab9687b Mon Sep 17 00:00:00 2001
From: Shengjiu Wang <b02247@freescale.com>
Date: Mon, 12 May 2014 17:23:20 +0800
Subject: [PATCH 0824/1074] ENGR00313072 dma: sdma: sdma can't work for p2p in
 some case.

sdma can't work for p2p when "dma_request0 < 31, dma_request1 > 31".

The context parameter for p_2_p script is described in RM A.3.2.5.1
r0: LWML event mask, combined with bit28 of INFO
r1: HWML event mask, combined with bit29 of INFO
r7: INFO:  bit 28: LWML Event (0 - LWE in EVENTS, 1 - LWE in EVENTS2);
	   bit 29: HWML event (0 - HWE in EVENTS, 1 - HWE in EVENTS2);

In sdma_load_context(), we set r0 = event_mask1, r1 = event_mask0.
which means the event_mask1 is LWML event mask, event_mask0 is HWML event mask.
In sdma_config_channel() Event_id0 set the bit 28, which means event_id0 is
corresponding to event_mask1, event_id1 is corresponding to event_mask0.
So here we need to correct the wrong setting in sdma_config_channel(), for some
setting didn't follow this principle.

Signed-off-by: Shengjiu Wang <b02247@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/dma/imx-sdma.c |    8 ++++----
 1 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/dma/imx-sdma.c b/drivers/dma/imx-sdma.c
index 1bf69ce..372817c 100644
--- a/drivers/dma/imx-sdma.c
+++ b/drivers/dma/imx-sdma.c
@@ -950,14 +950,14 @@ static int sdma_config_channel(struct sdma_channel *sdmac)
 				sdmac->event_mask[1] |=
 						BIT(sdmac->event_id0 % 32);
 			} else {
-				sdmac->event_mask[1] |= 0;
-				sdmac->event_mask[0] |=
+				sdmac->event_mask[0] |= 0;
+				sdmac->event_mask[1] |=
 						BIT(sdmac->event_id0 % 32);
 			}
 			if (sdmac->event_id1 > 31) {
-				sdmac->event_mask[0] |= 0;
+				sdmac->event_mask[1] |= 0;
 				__set_bit(29, &sdmac->watermark_level);
-				sdmac->event_mask[1] |=
+				sdmac->event_mask[0] |=
 						BIT(sdmac->event_id1 % 32);
 			} else {
 				sdmac->event_mask[1] |= 0;
-- 
1.7.5.4

