From cd4407d43126fce0bc6730a607d239ef18fe0fe7 Mon Sep 17 00:00:00 2001
From: Fugang Duan <B38611@freescale.com>
Date: Tue, 25 Feb 2014 09:04:32 +0800
Subject: [PATCH 1042/1074] ENGR00300625-1 net: fec: avoid imx6sx enet-avb
 Last bit is not set

When imx6sx-arm2/sdb platform do suspend/resume with nfs rootfs,
there have warning like "rcv is not +last", which means the frame
BD last bit is not set.

The root cause: enet suspend will disable phy clock, phy link down,
after resume back, enet MAC redo initial and ready to tx/rx packet,
but phy still is not ready which is doing auto-negotiation.

So, when enet output clock to phy, or there have regulator control
phy power, after phy is ready and then re-init enet MAC.

Signed-off-by: Fugang Duan <B38611@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/net/ethernet/freescale/fec_main.c |   10 +++++++++-
 1 files changed, 9 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fec_main.c b/drivers/net/ethernet/freescale/fec_main.c
index 8706007..0d1332f 100644
--- a/drivers/net/ethernet/freescale/fec_main.c
+++ b/drivers/net/ethernet/freescale/fec_main.c
@@ -2781,6 +2781,13 @@ fec_suspend(struct device *dev)
 	if (fep->reg_phy)
 		regulator_disable(fep->reg_phy);
 
+	/*
+	 * enet supply clock to phy, when clock is disabled, link down
+	 * when phy regulator is disabled, phy link down
+	 */
+	if (fep->clk_enet_out || fep->reg_phy)
+		fep->link = 0;
+
 	return 0;
 }
 
@@ -2818,7 +2825,8 @@ fec_resume(struct device *dev)
 	}
 
 	if (netif_running(ndev)) {
-		fec_restart(ndev, fep->full_duplex);
+		if (!fep->clk_enet_out && !fep->reg_phy)
+			fec_restart(ndev, fep->full_duplex);
 		netif_device_attach(ndev);
 	}
 
-- 
1.7.5.4

