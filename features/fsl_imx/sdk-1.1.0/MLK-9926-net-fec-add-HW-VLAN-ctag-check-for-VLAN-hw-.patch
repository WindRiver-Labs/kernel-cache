From 220f954f5508ae6b01b69b35ad8ab2d85c844171 Mon Sep 17 00:00:00 2001
From: Fugang Duan <b38611@freescale.com>
Date: Thu, 27 Nov 2014 18:05:52 +0800
Subject: [PATCH 1069/1074] MLK-9926 net: fec: add HW VLAN ctag check for VLAN
 hw acceleration

Add HW VLAN ctag check for VLAN hw acceleration.

(cherry-picked from commit: 47828ce6f54d78f173e405d732b358362aa8dd51)

Signed-off-by: Fugang Duan <B38611@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/net/ethernet/freescale/fec_main.c |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fec_main.c b/drivers/net/ethernet/freescale/fec_main.c
index 578f882..abbea5c 100644
--- a/drivers/net/ethernet/freescale/fec_main.c
+++ b/drivers/net/ethernet/freescale/fec_main.c
@@ -1413,13 +1413,13 @@ fec_enet_rx(struct net_device *ndev, int budget)
 
 			/* If this is a VLAN packet remove the VLAN Tag */
 			vlan_packet_rcvd = false;
-			if (fep->bufdesc_ex && (ebdp->cbd_esc & BD_ENET_RX_VLAN)) {
+			if ((ndev->features & NETIF_F_HW_VLAN_CTAG_RX) &&
+				fep->bufdesc_ex && (ebdp->cbd_esc & BD_ENET_RX_VLAN)) {
 				/* Push and remove the vlan tag */
 				struct vlan_hdr *vlan_header =
 					(struct vlan_hdr *) (data + ETH_HLEN);
 				vlan_tag = ntohs(vlan_header->h_vlan_TCI);
-				if (ndev->features & NETIF_F_HW_VLAN_CTAG_RX)
-					pkt_len -= VLAN_HLEN;
+				pkt_len -= VLAN_HLEN;
 
 				vlan_packet_rcvd = true;
 			}
-- 
1.7.5.4

