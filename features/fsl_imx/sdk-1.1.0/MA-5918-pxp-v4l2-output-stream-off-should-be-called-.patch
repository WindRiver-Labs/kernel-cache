From e7acd31981e14387fdeb99e975b0e40799e6c673 Mon Sep 17 00:00:00 2001
From: Liu Xiaowen <b37945@freescale.com>
Date: Tue, 2 Dec 2014 14:34:44 +0800
Subject: [PATCH 0981/1074] MA-5918 pxp: v4l2: output: stream off should be
 called after stream on.

stream off should be called by pxp_close when stream is on.

Signed-off-by: Liu Xiaowen <b37945@freescale.com>
(cherry picked from commit 481208f831519db30b3e33ddabefdd1fc66417d9)
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/media/platform/mxc/output/mxc_pxp_v4l2.c |   19 +++++++++++++------
 1 files changed, 13 insertions(+), 6 deletions(-)

diff --git a/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c b/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c
index e2098cb..5d5dfd3 100644
--- a/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c
+++ b/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c
@@ -690,6 +690,11 @@ static int pxp_streamon(struct file *file, void *priv,
 	if (t != V4L2_BUF_TYPE_VIDEO_OUTPUT)
 		return -EINVAL;
 
+	if (pxp->s0_vbq.streaming) {
+		dev_err(&pxp->pdev->dev, "v4l2 output already run!");
+		return -EBUSY;
+	}
+
 	_get_cur_fb_blank(pxp);
 	set_fb_blank(FB_BLANK_UNBLANK);
 
@@ -710,12 +715,14 @@ static int pxp_streamoff(struct file *file, void *priv,
 	if ((t != V4L2_BUF_TYPE_VIDEO_OUTPUT))
 		return -EINVAL;
 
-	ret = videobuf_streamoff(&pxp->s0_vbq);
+	if (pxp->s0_vbq.streaming) {
+		ret = videobuf_streamoff(&pxp->s0_vbq);
 
-	pxp_show_buf(pxp, (unsigned long)pxp->fb.base);
+		pxp_show_buf(pxp, (unsigned long)pxp->fb.base);
 
-	if (pxp->fb_blank)
-		set_fb_blank(FB_BLANK_POWERDOWN);
+		if (pxp->fb_blank)
+			set_fb_blank(FB_BLANK_POWERDOWN);
+	}
 
 	return ret;
 }
@@ -1144,8 +1151,8 @@ out:
 static int pxp_close(struct file *file)
 {
 	struct pxps *pxp = video_get_drvdata(video_devdata(file));
-
-	pxp_streamoff(file, NULL, V4L2_BUF_TYPE_VIDEO_OUTPUT);
+	if (pxp->s0_vbq.streaming)
+		pxp_streamoff(file, NULL, V4L2_BUF_TYPE_VIDEO_OUTPUT);
 	videobuf_stop(&pxp->s0_vbq);
 	videobuf_mmap_free(&pxp->s0_vbq);
 	pxp->active = NULL;
-- 
1.7.5.4

