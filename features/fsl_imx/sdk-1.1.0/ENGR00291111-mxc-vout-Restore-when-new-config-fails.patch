From 04166951b1c5d926a30135dff7a135c89bdbc898 Mon Sep 17 00:00:00 2001
From: Liu Ying <Ying.Liu@freescale.com>
Date: Tue, 10 Dec 2013 17:28:09 +0800
Subject: [PATCH 0656/1074] ENGR00291111 mxc vout:Restore when new config
 fails

Users may call VIDIOC_S_CTRL and VIDIOC_S_CROP ioctrls
to change rotation and cropping settings when streaming.
The driver should restore the original settings if new
configuration fails, otherwise, it might break the
present pipeline.

This patch fixes the issue which can be reproduced by
this test case with a 1080P HDMI primary display:
gplay Mpeg4_SP1_480x260_24_1200_aac_48_128_2_terminator3.mp4
Type 't' to set rotation to 90.

Signed-off-by: Liu Ying <Ying.Liu@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/media/platform/mxc/output/mxc_vout.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/media/platform/mxc/output/mxc_vout.c b/drivers/media/platform/mxc/output/mxc_vout.c
index 05b9d93..bd7d1f0 100644
--- a/drivers/media/platform/mxc/output/mxc_vout.c
+++ b/drivers/media/platform/mxc/output/mxc_vout.c
@@ -1515,6 +1515,7 @@ static int mxc_vidioc_s_crop(struct file *file, void *fh,
 		if (ret < 0) {
 			v4l2_err(vout->vfd->v4l2_dev,
 					"vout check task failed\n");
+			memcpy(vout, pre_vout, sizeof(*vout));
 			goto done;
 		}
 
@@ -1683,6 +1684,7 @@ static int mxc_vidioc_s_ctrl(struct file *file, void *fh,
 		if (ret < 0) {
 			v4l2_err(vout->vfd->v4l2_dev,
 					"vout check task failed\n");
+			memcpy(vout, pre_vout, sizeof(*vout));
 			goto done;
 		}
 
-- 
1.7.5.4

