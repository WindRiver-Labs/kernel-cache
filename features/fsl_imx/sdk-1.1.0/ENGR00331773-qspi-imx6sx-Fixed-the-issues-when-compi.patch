From 243a3105c58da82c4b37bdc5f888134ffce7aca2 Mon Sep 17 00:00:00 2001
From: Allen Xu <b45815@freescale.com>
Date: Fri, 12 Sep 2014 07:17:38 -0500
Subject: [PATCH 0926/1074] ENGR00331773 qspi: imx6sx: Fixed the issues when
 compiled QSPI as a module

There were two issues when compiled QSPI as a module.

1. two functions in spi_nor.c has not been exported.
2. unregister mtd device count is wrong.

Signed-off-by: Allen Xu <b45815@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/mtd/spi-nor/fsl-quadspi.c |    4 ++--
 drivers/mtd/spi-nor/spi-nor.c     |    2 ++
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/mtd/spi-nor/fsl-quadspi.c b/drivers/mtd/spi-nor/fsl-quadspi.c
index 4709256..03fe903 100644
--- a/drivers/mtd/spi-nor/fsl-quadspi.c
+++ b/drivers/mtd/spi-nor/fsl-quadspi.c
@@ -1089,7 +1089,7 @@ static int fsl_qspi_probe(struct platform_device *pdev)
 	return 0;
 
 last_init_failed:
-	for (i = 0; i < q->nor_num; i++)
+	for (i = 0; i < FSL_QSPI_MAX_CHIP; i++)
 		mtd_device_unregister(&q->mtd[i]);
 
 irq_failed:
@@ -1105,7 +1105,7 @@ static int fsl_qspi_remove(struct platform_device *pdev)
 	struct fsl_qspi *q = platform_get_drvdata(pdev);
 	int i;
 
-	for (i = 0; i < q->nor_num; i++)
+	for (i = 0; i < FSL_QSPI_MAX_CHIP; i++)
 		mtd_device_unregister(&q->mtd[i]);
 
 	/* disable the hardware */
diff --git a/drivers/mtd/spi-nor/spi-nor.c b/drivers/mtd/spi-nor/spi-nor.c
index 1353cff..909a738 100644
--- a/drivers/mtd/spi-nor/spi-nor.c
+++ b/drivers/mtd/spi-nor/spi-nor.c
@@ -1086,6 +1086,7 @@ int spi_nor_scan(struct spi_nor *nor, const struct spi_device_id *id,
 				mtd->eraseregions[i].numblocks);
 	return 0;
 }
+EXPORT_SYMBOL_GPL(spi_nor_scan);
 
 const struct spi_device_id *spi_nor_match_id(char *name)
 {
@@ -1098,6 +1099,7 @@ const struct spi_device_id *spi_nor_match_id(char *name)
 	}
 	return NULL;
 }
+EXPORT_SYMBOL_GPL(spi_nor_match_id);
 
 MODULE_LICENSE("GPL");
 MODULE_AUTHOR("Huang Shijie <shijie8@gmail.com>");
-- 
1.7.5.4

