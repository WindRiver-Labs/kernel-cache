From 7a2eb3dec900a3c6f71ede82d86e749abe73a927 Mon Sep 17 00:00:00 2001
From: Huang Shijie <b32955@freescale.com>
Date: Tue, 15 Apr 2014 13:35:59 +0800
Subject: [PATCH 0793/1074] ENGR00308399 mtd: fsl-quadspi: quit if the M4 is
 using the quadspi

Detect if the quadspi is used by the M4.
If the M4 does use it, we quit.

Signed-off-by: Huang Shijie <b32955@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/mtd/spi-nor/fsl-quadspi.c |   13 +++++++++++++
 1 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/drivers/mtd/spi-nor/fsl-quadspi.c b/drivers/mtd/spi-nor/fsl-quadspi.c
index 090401a..8f5bf6b 100644
--- a/drivers/mtd/spi-nor/fsl-quadspi.c
+++ b/drivers/mtd/spi-nor/fsl-quadspi.c
@@ -882,6 +882,13 @@ static void fsl_qspi_unprep(struct spi_nor *nor, enum spi_nor_ops ops)
 	clk_disable(q->clk_en);
 }
 
+/* If the uboot enable the M4 to use the Quadspi, we should quit. */
+static bool fsl_m4_is_using(struct fsl_qspi *q)
+{
+	return (readl(q->iobase + QUADSPI_BUF0CR) ==
+			QUADSPI_BUFXCR_INVALID_MSTRID);
+}
+
 static int fsl_qspi_probe(struct platform_device *pdev)
 {
 	struct device_node *np = pdev->dev.of_node;
@@ -948,6 +955,12 @@ static int fsl_qspi_probe(struct platform_device *pdev)
 		goto map_failed;
 	}
 
+	if (fsl_m4_is_using(q)) {
+		dev_info(dev, "The M4 is using quadspi controller, we quit.\n");
+		ret = -EINVAL;
+		goto irq_failed;
+	}
+
 	/* find the irq */
 	ret = platform_get_irq(pdev, 0);
 	if (ret < 0) {
-- 
1.7.5.4

