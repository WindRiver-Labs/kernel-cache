From 74f4ae3f90af86da0620cb6484880d789d54ce12 Mon Sep 17 00:00:00 2001
From: Peter Chen <peter.chen@freescale.com>
Date: Sat, 29 Nov 2014 15:09:10 +0800
Subject: [PATCH 0975/1074] MLK-9932-1 usb: gadget: g_serial: fix oops during
 interrupt

We meet below oops at rare cases when we do g_serial test at SMP platform,
in our cases, the g_serial will be removed after some access.
gserial_disconnect may be called before the complete handler is called,
in this case, the port->port_usb is NULL at gs_start_tx, it matches
the below oops.

PC is at gs_start_tx+0x20/0x22c [u_serial]
LR is at gs_write_complete+0x60/0x88 [u_serial]
pc : [<7f095628>] lr : [<7f095894>] psr: 600e0193
sp : a83adc10 ip : 00000002 fp : a8849f80
r10: a803d64c r9 : a87dfeec r8 : a8849fbc
r7 : a803d64c r6 : a87dfeb0 r5 : a8849f80 r4 : a87dfe00
r3 : 00000000 r2 : 00000100 r1 : a8849c24 r0 : a87dfe00
Flags: nZCv IRQs off FIQs on Mode SVC_32 ISA ARM Segment kernel
Control: 10c53c7d Table: 38e0404a DAC: 00000015
Process kworker/0:2 (pid: 105, stack limit = 0xa83ac238)
Stack: (0xa83adc10 to 0xa83ae000)
dc00: 81299260 a87dfeb0 00000002 a803d64c
dc20: a8849f80 a87dfe00 a8849f80 a87dfeb0 a803d64c a8849fbc 00000002 a803d64c
dc40: a8849f80 7f095894 a8849fb4 00000002 a8849fbc a8849fbc a803d6a4 803ed524
dc60: a8849fb4 a8849680 00000009 00000001 80cc64e4 a803d010 a803d014 a803d684
dc80: a803d64c 00000009 803ec908 a803d170 00100000 38a9ea00 80d15d88 a803d010
dca0: a8009958 00000000 00000000 0000004b a8009900 80d1574f 00000001 803ea2f4
dcc0: 803ea2a4 a83cd140 a8009958 80079ab4 a8849b00 a8849b00 a95f9fc0 a8009900
dce0: a8009958 a83cd140 f4a00100 80bafa3c a8807000 a8807288 a8807000 80079c18
dd00: a8009900 a8009958 00000000 8007c948 8007c8c4 0000004b 0000004b 8007927c
dd20: 80cbbf00 8000e948 f4a0010c 80cc6914 a83add50 80008558 7f095ca0 8068484c
dd40: 400e0013 ffffffff a83add84 8000dc80 a87dfeb0 200e0013 a83add60 0000a556
dd60: a87dfe00 00000002 a87dfeb0 200e0013 80bafa3c a8807000 a8807288 a8807000
dd80: a8991d44 a83add98 7f095ca0 8068484c 400e0013 ffffffff 00000000 7f095ca0
dda0: a8808000 00000001 a8991c00 00001fff a8809000 802d59b0 00000a00 a8808000
ddc0: 00000001 802d5bec a83addf4 a8807270 00000000 a8991c00 a96bf562 a96bf462
dde0: 0000000a 000000bb a8807000 00000000 a8807000 802d7b64 80d1574f 400e0013
de00: a88072a0 80cc00c0 806ae500 a8009900 a8009958 a83cd140 f4a00100 a87dfe64
de20: a91c481c 806845b8 a8009900 80079c24 80cbbf00 0000004b 600e0193 800815c0
de40: 80cbbf00 0000004b 00000000 f4a00100 a87dfe64 8000e94c f4a0010c 80cc6914
de60: a83ade80 80008558 802db1d8 8068484c 800e0013 ffffffff a83adeb4 8000dc80
de80: a87dfe10 200e0013 00000000 00003193 a87dfe00 a8991c00 a87dfe10 a8faa500
dea0: a87dfe64 a91c491c 00000100 a87dfe00 a8991c00 a87dfe10 a8faa500 a87dfe64
dec0: a96bf51c 00000100 a96bf41c 802db1f4 802db118 a820e600 a87dfe00 81597840
dee0: 8159aa00 00000000 00000000 a83ac038 81597840 800436d4 a820e600 81597854
df00: a820e618 a83ac000 a83ac030 a820e600 81597854 a820e618 a83ac000 a83ac030
df20: 00000001 a83ac000 81597840 8004446c 80044220 00000000 00000000 80d15701
df40: a83adf64 a808fe98 00000000 a820e600 80044220 00000000 00000000 00000000
df60: 00000000 80049730 7cff2e7d 00000000 27dddefd a820e600 00000000 00000000
df80: a83adf80 a83adf80 00000000 00000000 a83adf90 a83adf90 a83adfac a808fe98
dfa0: 8004967c 00000000 00000000 8000e118 00000000 00000000 00000000 00000000
dfc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
dfe0: 00000000 00000000 00000000 00000000 00000013 00000000 e4b9dbff e5bdd7ff
[<7f095628>] (gs_start_tx+0x20/0x22c [u_serial]) from [<7f095894>] (gs_write_complete+0x60/0x88 [u_serial])
[<7f095894>] (gs_write_complete+0x60/0x88 [u_serial]) from [<803ed524>] (udc_irq+0x478/0xd20)
[<803ed524>] (udc_irq+0x478/0xd20) from [<803ea2f4>] (ci_irq+0x50/0x118)
[<803ea2f4>] (ci_irq+0x50/0x118) from [<80079ab4>] (handle_irq_event_percpu+0x54/0x17c)
[<80079ab4>] (handle_irq_event_percpu+0x54/0x17c) from [<80079c18>] (handle_irq_event+0x3c/0x5c)
[<80079c18>] (handle_irq_event+0x3c/0x5c) from [<8007c948>] (handle_fasteoi_irq+0x84/0x14c)
[<8007c948>] (handle_fasteoi_irq+0x84/0x14c) from [<8007927c>] (generic_handle_irq+0x2c/0x3c)
[<8007927c>] (generic_handle_irq+0x2c/0x3c) from [<8000e948>] (handle_IRQ+0x40/0x90)
[<8000e948>] (handle_IRQ+0x40/0x90) from [<80008558>] (gic_handle_irq+0x2c/0x5c)
[<80008558>] (gic_handle_irq+0x2c/0x5c) from [<8000dc80>] (__irq_svc+0x40/0x70)
Exception stack(0xa83add50 to 0xa83add98)
dd40: a87dfeb0 200e0013 a83add60 0000a556
dd60: a87dfe00 00000002 a87dfeb0 200e0013 80bafa3c a8807000 a8807288 a8807000
dd80: a8991d44 a83add98 7f095ca0 8068484c 400e0013 ffffffff
[<8000dc80>] (__irq_svc+0x40/0x70) from [<8068484c>] (_raw_spin_unlock_irqrestore+0x20/0x48)
[<8068484c>] (_raw_spin_unlock_irqrestore+0x20/0x48) from [<7f095ca0>] (gs_write+0x48/0x68 [u_serial])
[<7f095ca0>] (gs_write+0x48/0x68 [u_serial]) from [<802d59b0>] (do_output_char+0x148/0x1b8)
[<802d59b0>] (do_output_char+0x148/0x1b8) from [<802d5bec>] (process_echoes+0x184/0x2a8)
[<802d5bec>] (process_echoes+0x184/0x2a8) from [<802d7b64>] (n_tty_receive_buf+0xed8/0x101c)
[<802d7b64>] (n_tty_receive_buf+0xed8/0x101c) from [<802db1f4>] (flush_to_ldisc+0xdc/0x140)
[<802db1f4>] (flush_to_ldisc+0xdc/0x140) from [<800436d4>] (process_one_work+0xf8/0x360)
[<800436d4>] (process_one_work+0xf8/0x360) from [<8004446c>] (worker_thread+0x24c/0x3d4)
[<8004446c>] (worker_thread+0x24c/0x3d4) from [<80049730>] (kthread+0xb4/0xb8)
[<80049730>] (kthread+0xb4/0xb8) from [<8000e118>] (ret_from_fork+0x14/0x3c)
Code: e1a04000 e28020b0 e58d2004 e3a02c01 (e593705c)

Signed-off-by: Peter Chen <peter.chen@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/usb/gadget/u_serial.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/usb/gadget/u_serial.c b/drivers/usb/gadget/u_serial.c
index ad0aca8..7c29dd8 100644
--- a/drivers/usb/gadget/u_serial.c
+++ b/drivers/usb/gadget/u_serial.c
@@ -608,7 +608,8 @@ static void gs_write_complete(struct usb_ep *ep, struct usb_request *req)
 		/* FALL THROUGH */
 	case 0:
 		/* normal completion */
-		gs_start_tx(port);
+		if (port->port_usb)
+			gs_start_tx(port);
 		break;
 
 	case -ESHUTDOWN:
-- 
1.7.5.4

