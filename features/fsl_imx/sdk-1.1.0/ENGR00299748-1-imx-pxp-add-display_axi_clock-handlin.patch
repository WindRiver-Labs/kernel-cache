From ea5239a4726aa8d026fa46a9432150729ceed4da Mon Sep 17 00:00:00 2001
From: Robby Cai <R63905@freescale.com>
Date: Wed, 19 Feb 2014 18:05:48 +0800
Subject: [PATCH 0723/1074] ENGR00299748-1 imx: pxp: add display_axi_clock
 handling for imx6sx

The display axi clock is a clock gating newly added on imx6sx.
It need to be enabled for lcdif/pxp/csi/pcie to work.
It should be set as a placeholder on other SoCs.

Signed-off-by: Robby Cai <R63905@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/dma/pxp/pxp_dma_v2.c |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/drivers/dma/pxp/pxp_dma_v2.c b/drivers/dma/pxp/pxp_dma_v2.c
index fd36ab3..7b80787 100644
--- a/drivers/dma/pxp/pxp_dma_v2.c
+++ b/drivers/dma/pxp/pxp_dma_v2.c
@@ -57,6 +57,7 @@ struct pxp_dma {
 struct pxps {
 	struct platform_device *pdev;
 	struct clk *clk;
+	struct clk *clk_disp_axi;	/* may exist on some SoC for gating */
 	void __iomem *base;
 	int irq;		/* PXP IRQ to the CPU */
 
@@ -1025,6 +1026,8 @@ static void pxp_clk_enable(struct pxps *pxp)
 		return;
 	}
 
+	if (pxp->clk_disp_axi)
+		clk_prepare_enable(pxp->clk_disp_axi);
 	clk_prepare_enable(pxp->clk);
 	pxp->clk_stat = CLK_STAT_ON;
 
@@ -1046,6 +1049,8 @@ static void pxp_clk_disable(struct pxps *pxp)
 	if ((pxp->pxp_ongoing == 0) && list_empty(&head)) {
 		spin_unlock_irqrestore(&pxp->lock, flags);
 		clk_disable_unprepare(pxp->clk);
+		if (pxp->clk_disp_axi)
+			clk_disable_unprepare(pxp->clk_disp_axi);
 		pxp->clk_stat = CLK_STAT_OFF;
 	} else
 		spin_unlock_irqrestore(&pxp->lock, flags);
@@ -1635,6 +1640,9 @@ static int pxp_probe(struct platform_device *pdev)
 
 	pxp->pdev = pdev;
 
+	pxp->clk_disp_axi = devm_clk_get(&pdev->dev, "disp-axi");
+	if (IS_ERR(pxp->clk_disp_axi))
+		pxp->clk_disp_axi = NULL;
 	pxp->clk = devm_clk_get(&pdev->dev, "pxp-axi");
 
 	err = devm_request_irq(&pdev->dev, pxp->irq, pxp_irq, 0,
@@ -1694,6 +1702,8 @@ static int pxp_remove(struct platform_device *pdev)
 	cancel_work_sync(&pxp->work);
 	del_timer_sync(&pxp->clk_timer);
 	clk_disable_unprepare(pxp->clk);
+	if (pxp->clk_disp_axi)
+		clk_disable_unprepare(pxp->clk_disp_axi);
 	device_remove_file(&pdev->dev, &dev_attr_clk_off_timeout);
 	device_remove_file(&pdev->dev, &dev_attr_block_size);
 	dma_async_device_unregister(&(pxp->pxp_dma.dma));
-- 
1.7.5.4

