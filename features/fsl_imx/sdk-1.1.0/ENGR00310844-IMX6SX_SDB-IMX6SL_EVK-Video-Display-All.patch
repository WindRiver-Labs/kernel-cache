From 51655807953531bc3eabd91528797afae0429549 Mon Sep 17 00:00:00 2001
From: Fancy Fang <chen.fang@freescale.com>
Date: Fri, 9 May 2014 17:34:51 +0800
Subject: [PATCH 0820/1074] ENGR00310844 [IMX6SX_SDB/IMX6SL_EVK]Video Display:
 All the videos have a green line at the bottom
 when play with 'gplay' and 'gplay-1.0'

This issue is due to the incorrect settings for PXP_SCALE register.
On the previous settings, when the PXP need to do interpolation
operation in SCALE engine, it has out-of-range image access. So we
need to adjust the scaling settings to make this issue not happen
through sacrifising some unnoticed image precise.

Signed-off-by: Fancy Fang <chen.fang@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/dma/pxp/pxp_dma_v2.c |   33 +++++++++++++++++----------------
 1 files changed, 17 insertions(+), 16 deletions(-)

diff --git a/drivers/dma/pxp/pxp_dma_v2.c b/drivers/dma/pxp/pxp_dma_v2.c
index 02f55ef..89d5cf8 100644
--- a/drivers/dma/pxp/pxp_dma_v2.c
+++ b/drivers/dma/pxp/pxp_dma_v2.c
@@ -650,20 +650,13 @@ static int pxp_set_scaling(struct pxps *pxp)
 	u32 xscale, yscale, s0scale;
 	u32 decx, decy, xdec = 0, ydec = 0;
 	struct pxp_proc_data *proc_data = &pxp->pxp_conf_state.proc_data;
-
-	if (((proc_data->srect.width == proc_data->drect.width) &&
-	    (proc_data->srect.height == proc_data->drect.height)) ||
-	    ((proc_data->srect.width == 0) && (proc_data->srect.height == 0))) {
-		proc_data->scaling = 0;
-		__raw_writel(0x10001000, pxp->base + HW_PXP_PS_SCALE);
-		__raw_writel(0, pxp->base + HW_PXP_PS_CTRL);
-		goto out;
-	}
+	struct pxp_config_data *pxp_conf = &pxp->pxp_conf_state;
+	struct pxp_layer_param *s0_params = &pxp_conf->s0_param;
 
 	proc_data->scaling = 1;
 	decx = proc_data->srect.width / proc_data->drect.width;
 	decy = proc_data->srect.height / proc_data->drect.height;
-	if (decx > 0) {
+	if (decx > 1) {
 		if (decx >= 2 && decx < 4) {
 			decx = 2;
 			xdec = 1;
@@ -676,10 +669,18 @@ static int pxp_set_scaling(struct pxps *pxp)
 		}
 		xscale = proc_data->srect.width * 0x1000 /
 			 (proc_data->drect.width * decx);
-	} else
-		xscale = proc_data->srect.width * 0x1000 /
-			 proc_data->drect.width;
-	if (decy > 0) {
+	} else {
+		if (!is_yuv(s0_params->pixel_fmt) ||
+		    (s0_params->pixel_fmt == PXP_PIX_FMT_GREY) ||
+		    (s0_params->pixel_fmt == PXP_PIX_FMT_GY04) ||
+		    (s0_params->pixel_fmt == PXP_PIX_FMT_YUV444))
+			xscale = (proc_data->srect.width - 1) * 0x1000 /
+				 (proc_data->drect.width - 1);
+		else
+			xscale = (proc_data->srect.width - 2) * 0x1000 /
+				 (proc_data->drect.width - 1);
+	}
+	if (decy > 1) {
 		if (decy >= 2 && decy < 4) {
 			decy = 2;
 			ydec = 1;
@@ -693,8 +694,8 @@ static int pxp_set_scaling(struct pxps *pxp)
 		yscale = proc_data->srect.height * 0x1000 /
 			 (proc_data->drect.height * decy);
 	} else
-		yscale = proc_data->srect.height * 0x1000 /
-			 proc_data->drect.height;
+		yscale = (proc_data->srect.height - 1) * 0x1000 /
+			 (proc_data->drect.height - 1);
 
 	__raw_writel((xdec << 10) | (ydec << 8), pxp->base + HW_PXP_PS_CTRL);
 
-- 
1.7.5.4

