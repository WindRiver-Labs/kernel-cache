From 4455196902ad1f8b7090a307c62ef70b33d32b53 Mon Sep 17 00:00:00 2001
From: "Ye.Li" <B37916@freescale.com>
Date: Thu, 17 Jul 2014 17:46:16 +0800
Subject: [PATCH 1010/1074] ENGR00323027 MTD:QuadSPI: Remove the M4 checking
 workaround

The QuadSPI driver has a workaround to check if M4 is using QuadSPI NOR
flash. When M4 is running on QuadSPI NOR, the QuadSPI driver will quit.
This workaround has a bug when system booting from QuadSPI NOR.

Therefore, removed the workaround and disabled the QuadSPI driver in
MCC specific DTB. The MCC DTB will let the QuadSPI driver to disabled,
not conflict with M4.

Signed-off-by: Ye.Li <B37916@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 arch/arm/boot/dts/imx6sx-sdb-m4.dts |    3 +++
 drivers/mtd/spi-nor/fsl-quadspi.c   |   13 -------------
 2 files changed, 3 insertions(+), 13 deletions(-)

diff --git a/arch/arm/boot/dts/imx6sx-sdb-m4.dts b/arch/arm/boot/dts/imx6sx-sdb-m4.dts
index f990062..bfd2c14 100644
--- a/arch/arm/boot/dts/imx6sx-sdb-m4.dts
+++ b/arch/arm/boot/dts/imx6sx-sdb-m4.dts
@@ -80,3 +80,6 @@
 	fsl,shared-mem-size = <0x1000>;
 };
 
+&qspi2 {
+	status = "disabled";
+};
diff --git a/drivers/mtd/spi-nor/fsl-quadspi.c b/drivers/mtd/spi-nor/fsl-quadspi.c
index d2cd22e..0b61a2c 100644
--- a/drivers/mtd/spi-nor/fsl-quadspi.c
+++ b/drivers/mtd/spi-nor/fsl-quadspi.c
@@ -955,13 +955,6 @@ static void fsl_qspi_unprep(struct spi_nor *nor, enum spi_nor_ops ops)
 	mutex_unlock(&q->lock);
 }
 
-/* If the uboot enable the M4 to use the Quadspi, we should quit. */
-static bool fsl_m4_is_using(struct fsl_qspi *q)
-{
-	return (readl(q->iobase + QUADSPI_BUF0CR) ==
-			QUADSPI_BUFXCR_INVALID_MSTRID);
-}
-
 static int fsl_qspi_probe(struct platform_device *pdev)
 {
 	struct device_node *np = pdev->dev.of_node;
@@ -1016,12 +1009,6 @@ static int fsl_qspi_probe(struct platform_device *pdev)
 		goto map_failed;
 	}
 
-	if (fsl_m4_is_using(q)) {
-		dev_info(dev, "The M4 is using quadspi controller, we quit.\n");
-		ret = -EINVAL;
-		goto irq_failed;
-	}
-
 	/* find the irq */
 	ret = platform_get_irq(pdev, 0);
 	if (ret < 0) {
-- 
1.7.5.4

