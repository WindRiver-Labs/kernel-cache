From 6238221c2ae35f9995b2c367c67b8e469f0aabe3 Mon Sep 17 00:00:00 2001
From: Robby Cai <R63905@freescale.com>
Date: Sun, 22 Sep 2013 17:31:06 +0800
Subject: [PATCH 0192/1074] ENGR00280140 pxp/v4l2: restore the display content
 after video playback finishes

After finish video playback, the last frame remains on the display.
It's because the UI display start address (smem_start) has been changed when
do video playback but not changed back again after the playback finishes.
From the function call point of view,

 pxp_set_fbinfo()         // pxp->fb.base tracks right addr for UI framebuffer
 pxp_show_buf(toshow)     // smem_start changed to v4l2 display addr
 pxp_set_fbinfo()         // pxp->fb.base changed to v4l2 display addr
 pxp_show_buf(not toshow) // smem_start still equal to v4l2 display addr
                          // for pan_display

This patch fixes it by calling pxp_set_fbinfo once in open function.

Signed-off-by: Robby Cai <R63905@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/media/platform/mxc/output/mxc_pxp_v4l2.c |   24 +++++----------------
 1 files changed, 6 insertions(+), 18 deletions(-)

diff --git a/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c b/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c
index 355b925..d180431 100644
--- a/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c
+++ b/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c
@@ -291,12 +291,6 @@ static int pxp_show_buf(struct pxps *pxp, bool toshow)
 	struct fb_info *fbi = pxp->fbi;
 	int ret;
 
-	ret = pxp_set_fbinfo(pxp);
-	if (ret) {
-		dev_err(&pxp->pdev->dev, "failed to call pxp_set_fbinfo\n");
-		return ret;
-	}
-
 	console_lock();
 	fbi->fix.smem_start = toshow ?
 			pxp->outb_phys : (unsigned long)pxp->fb.base;
@@ -793,12 +787,6 @@ static int pxp_buf_prepare(struct videobuf_queue *q,
 					sizeof(struct pxp_layer_param));
 			} else if (pxp_conf->ol_param[0].combine_enable) {
 				/* Overlay */
-				ret = pxp_set_fbinfo(pxp);
-				if (ret) {
-					dev_err(&pxp->pdev->dev,
-						"call pxp_set_fbinfo failed");
-					goto fail;
-				}
 				pxp_conf->ol_param[0].paddr =
 						(dma_addr_t)pxp->fb.base;
 				pxp_conf->ol_param[0].width = pxp->fb.fmt.width;
@@ -1081,6 +1069,12 @@ out:
 	if (ret)
 		return ret;
 
+	ret = pxp_set_fbinfo(pxp);
+	if (ret) {
+		dev_err(&pxp->pdev->dev, "failed to call pxp_set_fbinfo\n");
+		return ret;
+	}
+
 	videobuf_queue_dma_contig_init(&pxp->s0_vbq,
 				&pxp_vbq_ops,
 				&pxp->pdev->dev,
@@ -1219,12 +1213,6 @@ static int pxp_probe(struct platform_device *pdev)
 		goto freevdev;
 	}
 
-	err = pxp_set_fbinfo(pxp);
-	if (err) {
-		dev_err(&pdev->dev, "failed to call pxp_set_fbinfo\n");
-		goto freevdev;
-	}
-
 	dev_info(&pdev->dev, "initialized\n");
 
 exit:
-- 
1.7.5.4

