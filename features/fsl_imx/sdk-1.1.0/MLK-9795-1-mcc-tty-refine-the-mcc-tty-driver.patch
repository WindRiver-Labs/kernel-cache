From 4ae2dbbbe30c03fec9303ce62c75e0e2abf592b2 Mon Sep 17 00:00:00 2001
From: Richard Zhu <Richard.Zhu@freescale.com>
Date: Tue, 4 Nov 2014 15:24:48 +0800
Subject: [PATCH 0954/1074] MLK-9795-1 mcc: tty: refine the mcc tty driver

- change the mcc tty driver to be platform driver, set
the dev node "imx6sx-mcc-tty".

Signed-off-by: Richard Zhu <Richard.Zhu@freescale.com>
[Original patch taken from git://git.freescale.com/imx/linux-2.6-imx.git]
Signed-off-by: Biyao Zhai <biyao.zhai@windriver.com>
---
 drivers/char/imx_mcc/imx_mcc_tty.c |   47 ++++++++++++++++++++++++++++++++++-
 1 files changed, 45 insertions(+), 2 deletions(-)

diff --git a/drivers/char/imx_mcc/imx_mcc_tty.c b/drivers/char/imx_mcc/imx_mcc_tty.c
index 28f8d7a..a40243c 100644
--- a/drivers/char/imx_mcc/imx_mcc_tty.c
+++ b/drivers/char/imx_mcc/imx_mcc_tty.c
@@ -17,6 +17,7 @@
 #include <linux/delay.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
+#include <linux/platform_device.h>
 #include <linux/slab.h>
 #include <linux/tty.h>
 #include <linux/tty_driver.h>
@@ -178,7 +179,7 @@ static const struct tty_operations imxmcctty_ops = {
 
 static struct tty_driver *mcctty_driver;
 
-static int __init imxmcctty_init(void)
+static int imx_mcc_tty_probe(struct platform_device *pdev)
 {
 	int ret;
 	struct mcctty_port *cport = &mcc_tty_port;
@@ -231,7 +232,7 @@ error:
 	return ret;
 }
 
-static void imxmcctty_exit(void)
+static int imx_mcc_tty_remove(struct platform_device *pdev)
 {
 	int ret = 0;
 	struct mcctty_port *cport = &mcc_tty_port;
@@ -250,7 +251,49 @@ static void imxmcctty_exit(void)
 	tty_unregister_driver(mcctty_driver);
 	tty_port_destroy(&cport->port);
 	put_tty_driver(mcctty_driver);
+
+	return ret;
+}
+
+static const struct of_device_id imx6sx_mcc_tty_ids[] = {
+	{ .compatible = "fsl,imx6sx-mcc-tty", },
+	{ /* sentinel */ }
+};
+
+static struct platform_driver imxmcctty_driver = {
+	.driver = {
+		.name = "imx6sx-mcc-tty",
+		.owner  = THIS_MODULE,
+		.of_match_table = imx6sx_mcc_tty_ids,
+		},
+	.probe = imx_mcc_tty_probe,
+	.remove = imx_mcc_tty_remove,
+};
+
+/*!
+ * Initialise the imxmcctty_driver.
+ *
+ * @return  The function always returns 0.
+ */
+
+static int __init imxmcctty_init(void)
+{
+	if (platform_driver_register(&imxmcctty_driver) != 0)
+		return -ENODEV;
+
+	printk(KERN_INFO "IMX MCC TTY driver module loaded\n");
+	return 0;
+}
+
+static void __exit imxmcctty_exit(void)
+{
+	/* Unregister the device structure */
+	platform_driver_unregister(&imxmcctty_driver);
 }
 
 module_init(imxmcctty_init);
 module_exit(imxmcctty_exit);
+
+MODULE_AUTHOR("Freescale Semiconductor, Inc.");
+MODULE_DESCRIPTION("MCC TTY driver");
+MODULE_LICENSE("GPL");
-- 
1.7.5.4

