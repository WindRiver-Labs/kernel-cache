From ec520b9718fe94eff6a0020faceeb96f754d8dec Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Mon, 26 Oct 2015 10:56:20 -0700
Subject: [PATCH] arm64: uprobe: fix compile for when define TIF_UPROBE to 5

TIF_UPROBE was defined as 4, but it has conflict with -rt kernel, 4 is used by
TIF_NEED_RESCHED_LAZY.

With this change, assembler raised an error:

arch/arm64/kernel/entry.S:621: Error: immediate out of range at operand 3 -- `and x2,x1,#((1<<1)|(1<<0)|(1<<2)|(1<<3)|(1<<5))'

Move #_TIF_WORK_MASK to x2, then call "and" instruction with register
instead of immediate.

Signed-off-by: Yang Shi <yang.shi@windriver.com>

diff --git a/arch/arm64/kernel/entry.S b/arch/arm64/kernel/entry.S
index f51ccf926c6d..93196d37ae03 100644
--- a/arch/arm64/kernel/entry.S
+++ b/arch/arm64/kernel/entry.S
@@ -614,7 +614,8 @@ ret_fast_syscall:
 	disable_irq				// disable interrupts
 	str	x0, [sp, #S_X0]			// returned x0
 	ldr	x1, [tsk, #TI_FLAGS]
-	and	x2, x1, #_TIF_WORK_MASK
+	mov	x2, #_TIF_WORK_MASK
+	and	x2, x1, x2
 	cbnz	x2, work_pending
 	enable_step_tsk x1, x2
 	kernel_exit 0
@@ -642,7 +643,8 @@ work_resched:
 ret_to_user:
 	disable_irq				// disable interrupts
 	ldr	x1, [tsk, #TI_FLAGS]
-	and	x2, x1, #_TIF_WORK_MASK
+	mov	x2, #_TIF_WORK_MASK
+	and	x2, x1, x2
 	cbnz	x2, work_pending
 	enable_step_tsk x1, x2
 no_work_pending:
-- 
2.5.0

