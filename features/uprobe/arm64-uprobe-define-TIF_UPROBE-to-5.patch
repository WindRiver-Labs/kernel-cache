From 56b284c06271fde33bf32c53482702875acbc050 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Wed, 30 Sep 2015 11:09:12 -0700
Subject: [PATCH 26/26] arm64: uprobe: define TIF_UPROBE to 5

TIF_UPROBE was defined as 4, but it has conflict with -rt kernel, 4 is used by
TIF_NEED_RESCHED_LAZY.

With this change, assembler raised an error:

arch/arm64/kernel/entry.S:621: Error: immediate out of range at operand 3 -- `and x2,x1,#((1<<1)|(1<<0)|(1<<2)|(1<<3)|(1<<5))'

Move #_TIF_WORK_MASK to x2, then call "and" instruction with register
instead of immediate.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/arm64/include/asm/thread_info.h | 2 +-
 arch/arm64/kernel/entry.S            | 6 ++++--
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/arch/arm64/include/asm/thread_info.h b/arch/arm64/include/asm/thread_info.h
index 2e0644e..c63c5b4 100644
--- a/arch/arm64/include/asm/thread_info.h
+++ b/arch/arm64/include/asm/thread_info.h
@@ -101,7 +101,7 @@ static inline struct thread_info *current_thread_info(void)
 #define TIF_NEED_RESCHED	1
 #define TIF_NOTIFY_RESUME	2	/* callback before returning to user */
 #define TIF_FOREIGN_FPSTATE	3	/* CPU's FP state is not current's */
-#define TIF_UPROBE		4	/* uprobe breakpoint or singlestep */
+#define TIF_UPROBE		5	/* uprobe breakpoint or singlestep */
 #define TIF_NOHZ		7
 #define TIF_SYSCALL_TRACE	8
 #define TIF_SYSCALL_AUDIT	9
diff --git a/arch/arm64/kernel/entry.S b/arch/arm64/kernel/entry.S
index 2a525d6..e9b85ce 100644
--- a/arch/arm64/kernel/entry.S
+++ b/arch/arm64/kernel/entry.S
@@ -611,7 +611,8 @@ ENDPROC(cpu_switch_to)
 ret_fast_syscall:
 	disable_irq				// disable interrupts
 	ldr	x1, [tsk, #TI_FLAGS]
-	and	x2, x1, #_TIF_WORK_MASK
+	mov	x2, #_TIF_WORK_MASK
+	and	x2, x1, x2
 	cbnz	x2, fast_work_pending
 	enable_step_tsk x1, x2
 	kernel_exit 0, ret = 1
@@ -640,7 +641,8 @@ work_resched:
 ret_to_user:
 	disable_irq				// disable interrupts
 	ldr	x1, [tsk, #TI_FLAGS]
-	and	x2, x1, #_TIF_WORK_MASK
+	mov	x2, #_TIF_WORK_MASK
+	and	x2, x1, x2
 	cbnz	x2, work_pending
 	enable_step_tsk x1, x2
 no_work_pending:
-- 
2.0.2

