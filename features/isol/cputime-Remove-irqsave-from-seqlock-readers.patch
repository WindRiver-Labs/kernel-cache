From b8134d06c7dd0172c6208bd86faf25a8bc556a46 Mon Sep 17 00:00:00 2001
From: Thomas Gleixner <tglx@linutronix.de>
Date: Fri, 15 Feb 2013 23:47:07 +0100
Subject: [PATCH] cputime: Remove irqsave from seqlock readers

commit cdc4e86b58a95005ef500916b4a8e91a0037a822 upstream.

The reader side code has no requirement to disable interrupts while
sampling data. The sequence counter is enough to ensure consistency.

Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Cc: Frederic Weisbecker <fweisbec@gmail.com>
Signed-off-by: Ingo Molnar <mingo@kernel.org>
Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/kernel/sched/cputime.c b/kernel/sched/cputime.c
index ccff275..9857329 100644
--- a/kernel/sched/cputime.c
+++ b/kernel/sched/cputime.c
@@ -729,18 +729,17 @@ void vtime_init_idle(struct task_struct *t)
 
 cputime_t task_gtime(struct task_struct *t)
 {
-	unsigned long flags;
 	unsigned int seq;
 	cputime_t gtime;
 
 	do {
-		seq = read_seqbegin_irqsave(&t->vtime_seqlock, flags);
+		seq = read_seqbegin(&t->vtime_seqlock);
 
 		gtime = t->gtime;
 		if (t->flags & PF_VCPU)
 			gtime += vtime_delta(t);
 
-	} while (read_seqretry_irqrestore(&t->vtime_seqlock, seq, flags));
+	} while (read_seqretry(&t->vtime_seqlock, seq));
 
 	return gtime;
 }
@@ -756,7 +755,6 @@ fetch_task_cputime(struct task_struct *t,
 		   cputime_t *u_src, cputime_t *s_src,
 		   cputime_t *udelta, cputime_t *sdelta)
 {
-	unsigned long flags;
 	unsigned int seq;
 	unsigned long long delta;
 
@@ -764,7 +762,7 @@ fetch_task_cputime(struct task_struct *t,
 		*udelta = 0;
 		*sdelta = 0;
 
-		seq = read_seqbegin_irqsave(&t->vtime_seqlock, flags);
+		seq = read_seqbegin(&t->vtime_seqlock);
 
 		if (u_dst)
 			*u_dst = *u_src;
@@ -788,7 +786,7 @@ fetch_task_cputime(struct task_struct *t,
 			if (t->vtime_snap_whence == VTIME_SYS)
 				*sdelta = delta;
 		}
-	} while (read_seqretry_irqrestore(&t->vtime_seqlock, seq, flags));
+	} while (read_seqretry(&t->vtime_seqlock, seq));
 }
 
 
-- 
1.8.1.2

