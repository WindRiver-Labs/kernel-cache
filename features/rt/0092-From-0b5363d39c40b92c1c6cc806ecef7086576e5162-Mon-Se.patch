From f0fa5db40bfc621d257ec2e8e05e64fd2addf093 Mon Sep 17 00:00:00 2001
From: Sebastian Siewior <bigeasy@linutronix.de>
Date: Fri, 5 Sep 2008 00:22:44 -0400
Subject: [PATCH] From 0b5363d39c40b92c1c6cc806ecef7086576e5162 Mon Sep 17 00:00:00 2001
 Date: Fri, 18 Apr 2008 17:02:23 +0200
 Subject: [PATCH] m68knommu: make timer interrupt non threaded
 Signed-off-by: Sebastian Siewior <bigeasy@linutronix.de>

---
 arch/m68knommu/kernel/process.c        |    6 ++++--
 arch/m68knommu/platform/coldfire/pit.c |    2 +-
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/arch/m68knommu/kernel/process.c b/arch/m68knommu/kernel/process.c
index 57678a5..8c6a9b9 100644
--- a/arch/m68knommu/kernel/process.c
+++ b/arch/m68knommu/kernel/process.c
@@ -77,9 +77,11 @@ void cpu_idle(void)
 		stop_critical_timings();
 		idle();
 		start_critical_timings();
-		preempt_enable_no_resched();
-		schedule();
+		local_irq_disable();
+		__preempt_enable_no_resched();
+		__schedule();
 		preempt_disable();
+		local_irq_enable();
 	}
 }
 
diff --git a/arch/m68knommu/platform/coldfire/pit.c b/arch/m68knommu/platform/coldfire/pit.c
index c5b9167..0867b76 100644
--- a/arch/m68knommu/platform/coldfire/pit.c
+++ b/arch/m68knommu/platform/coldfire/pit.c
@@ -119,7 +119,7 @@ static irqreturn_t pit_tick(int irq, void *dummy)
 
 static struct irqaction pit_irq = {
 	.name	 = "timer",
-	.flags	 = IRQF_DISABLED | IRQF_TIMER,
+	.flags	 = IRQF_DISABLED | IRQF_TIMER | IRQF_NODELAY,
 	.handler = pit_tick,
 };
 
-- 
1.6.0.90.g436ed

