From 80f29e550a67719ee343ba8f35814df1d144c52f Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Thu, 28 Aug 2014 21:03:38 -0400
Subject: [PATCH] rtmutex: fix up for conflict between stable and rt patches

The 3.10.49 stable release brought in four rtmutex patches with
their cherry picked IDs as:

commit 98be12bc23bbc2b3a193d38a6fb0bde647e083d7
commit d88b1b40b88f5684a0784f59d68bc378679c6cdf
commit 1201613a70dd34bd347ba2970919b3f1d5fbfb4a
commit 2371e977c84373011a8c66c9550fe09c79d6a1f7

These in turn conflicted with RT content (mainly the 1st one).
In the fast forward version of 3.10-rt, the fixup can be seen in
the merge commit:

  commit 5199a25812dba986ead61f29e36d33132cf6ed46
  Merge: a5863c9 d02dae4
  Author: Steven Rostedt (Red Hat) <rostedt@goodmis.org>
  Date:   Tue Aug 26 18:25:09 2014 -0400

      Merge tag 'v3.10.49' into v3.10-rt

      This is the 3.10.49 stable release

      Conflicts:
          kernel/rtmutex.c

more specifically we are interested in the manual additions that
are represented by this chunk:

@@@ -180,6 -194,11 +232,13 @@@ static void rt_mutex_wake_waiter(struc
   */
  int max_lock_depth = 1024;

+ static inline struct rt_mutex *task_blocked_on_lock(struct task_struct *p)
+ {
 -      return p->pi_blocked_on ? p->pi_blocked_on->lock : NULL;
++      struct rt_mutex_waiter *waiter = p->pi_blocked_on;
++
++      return rt_mutex_real_waiter(waiter) ? waiter->lock : NULL;
+ }
+

Here we update the code to match the implicit manual fixup done in
the above merge commit.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/kernel/rtmutex.c b/kernel/rtmutex.c
index 076b63985493..02eef9786dfd 100644
--- a/kernel/rtmutex.c
+++ b/kernel/rtmutex.c
@@ -214,7 +214,9 @@ int max_lock_depth = 1024;
 
 static inline struct rt_mutex *task_blocked_on_lock(struct task_struct *p)
 {
-	return p->pi_blocked_on ? p->pi_blocked_on->lock : NULL;
+	struct rt_mutex_waiter *waiter = p->pi_blocked_on;
+
+	return rt_mutex_real_waiter(waiter) ? waiter->lock : NULL;
 }
 
 /*
-- 
2.1.0

