From ac092546e82e60fe5d1c7515f3bd100d66658348 Mon Sep 17 00:00:00 2001
From: Mike Galbraith <efault@gmx.de>
Date: Tue, 30 Sep 2008 17:01:08 -0400
Subject: [PATCH] From efault@gmx.de Mon Jan 14 23:35:16 2008
 Date: Mon, 14 Jan 2008 09:27:40 +0100
 To: Steven Rostedt <rostedt@goodmis.org>
 Cc: Mariusz Kozlowski <m.kozlowski@tuxland.pl>,
      LKML <linux-kernel@vger.kernel.org>, RT <linux-rt-users@vger.kernel.org>,
      Ingo Molnar <mingo@elte.hu>, Thomas Gleixner <tglx@linutronix.de>
 Subject: Re: 2.6.24-rc7-rt1
     [ The following text is in the "utf-8" character set. ]
     [ Your display is set for the "iso-8859-1" character set.  ]
     [ Some characters may be displayed incorrectly. ]

On Sun, 2008-01-13 at 15:54 -0500, Steven Rostedt wrote:

> OK, -rt2 will take a bit more beating from me before I release it, so it
> might take some time to get it out (expect it out on Monday).

Ah, that reminds me (tests, yup) I still need the patchlet below to
resume from ram without black screen of death.  No idea why my P4 box
seems to be the only box in the rt galaxy affected.  (haven't poked at
it since the holidays)
---
 kernel/sched_rt.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/kernel/sched_rt.c b/kernel/sched_rt.c
index 2a23c73..b532379 100644
--- a/kernel/sched_rt.c
+++ b/kernel/sched_rt.c
@@ -39,6 +39,9 @@ static inline void rt_clear_overload(struct rq *rq)
 
 static void update_rt_migration(struct rq *rq)
 {
+	if (unlikely(num_online_cpus() == 1))
+		return;
+
 	if (rq->rt.rt_nr_migratory && (rq->rt.rt_nr_running > 1)) {
 		if (!rq->rt.overloaded) {
 			rt_set_overload(rq);
@@ -566,6 +569,7 @@ void dec_rt_tasks(struct sched_rt_entity *rt_se, struct rt_rq *rt_rq)
 #ifdef CONFIG_SMP
 	if (rt_se->nr_cpus_allowed > 1) {
 		struct rq *rq = rq_of_rt_rq(rt_rq);
+		BUG_ON(!rq->rt.rt_nr_migratory);
 		rq->rt.rt_nr_migratory--;
 	}
 
-- 
1.6.0.90.g436ed

