From 4924c2eeb8a9711f95bba723da89f291ad788dd7 Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Tue, 30 Sep 2008 16:56:54 -0400
Subject: [PATCH] patch rt-mutex-arm.patch

---
 arch/arm/kernel/entry-common.S |   12 +++++++-----
 arch/arm/kernel/process.c      |    6 ++++--
 2 files changed, 11 insertions(+), 7 deletions(-)

diff --git a/arch/arm/kernel/entry-common.S b/arch/arm/kernel/entry-common.S
index daebbf9..e26f647 100644
--- a/arch/arm/kernel/entry-common.S
+++ b/arch/arm/kernel/entry-common.S
@@ -57,7 +57,8 @@ work_pending:
 	b	ret_slow_syscall		@ Check work again
 
 work_resched:
-	bl	schedule
+	bl	__schedule
+
 /*
  * "slow" syscall return path.  "why" tells us if this was a real syscall.
  */
@@ -452,6 +453,7 @@ ENTRY(sys_oabi_call_table)
 #include "calls.S"
 #undef ABI
 #undef OBSOLETE
+#endif
 
 #ifdef CONFIG_FRAME_POINTER
 
@@ -501,11 +503,13 @@ mcount:
 	ldr	ip, =mcount_enabled	@ leave early, if disabled
 	ldr	ip, [ip]
 	cmp	ip, #0
-	moveq	pc,lr
+	moveq	pc, lr
 
 	mov	ip,  sp
 	stmdb   sp!, {r0 - r3, fp, ip, lr, pc}	@ create stack frame
 
+	mov	r2, =mcount_trace_function
+
 	ldr	r1, [fp, #-4]		@ get lr (the return address
 					@ of the caller of the
 					@ instrumented function)
@@ -514,7 +518,7 @@ mcount:
 
 	sub	fp, ip, #4		@ point fp at this frame
 
-	bl	__trace
+	bl	r2
 1:
 	ldmdb   fp, {r0 - r3, fp, sp, pc}	@ pop entry frame and return
 
@@ -560,5 +564,3 @@ arm_return_addr:
 
 #endif
 
-#endif
-
diff --git a/arch/arm/kernel/process.c b/arch/arm/kernel/process.c
index 8c8e2a6..049f10a 100644
--- a/arch/arm/kernel/process.c
+++ b/arch/arm/kernel/process.c
@@ -169,9 +169,11 @@ void cpu_idle(void)
 			idle();
 		leds_event(led_idle_end);
 		tick_nohz_restart_sched_tick();
-		preempt_enable_no_resched();
-		schedule();
+		local_irq_disable();
+		__preempt_enable_no_resched();
+		__schedule();
 		preempt_disable();
+		local_irq_enable();
 	}
 }
 
-- 
1.6.0.90.g436ed

