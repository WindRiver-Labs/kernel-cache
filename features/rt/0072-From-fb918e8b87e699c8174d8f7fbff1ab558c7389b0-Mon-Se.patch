From b904a482a5148866937f9eb9d987d09b991b1b52 Mon Sep 17 00:00:00 2001
From: Sebastian Siewior <bigeasy@linutronix.de>
Date: Wed, 17 Sep 2008 15:11:25 -0400
Subject: [PATCH] From fb918e8b87e699c8174d8f7fbff1ab558c7389b0 Mon Sep 17 00:00:00 2001
 Date: Fri, 18 Apr 2008 17:02:29 +0200
 Subject: [PATCH] m68knommu: make cmpxchg RT-safe
 Signed-off-by: Sebastian Siewior <bigeasy@linutronix.de>
 Signed-off-by: Thomas Gleixner <tglx@linutronix.de>

---
 arch/m68knommu/include/asm/system.h |    7 ++++---
 1 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/arch/m68knommu/include/asm/system.h b/arch/m68knommu/include/asm/system.h
index 40f49de..60c915d 100644
--- a/arch/m68knommu/include/asm/system.h
+++ b/arch/m68knommu/include/asm/system.h
@@ -2,9 +2,10 @@
 #define _M68KNOMMU_SYSTEM_H
 
 #include <linux/linkage.h>
+#include <linux/kernel.h>
+#include <linux/irqflags.h>
 #include <asm/segment.h>
 #include <asm/entry.h>
-
 /*
  * switch_to(n) should switch tasks to task ptr, first checking that
  * ptr isn't the current task, in which case it does nothing.  This
@@ -130,7 +131,7 @@ static inline unsigned long __xchg(unsigned long x, volatile void * ptr, int siz
 {
   unsigned long tmp, flags;
 
-  local_irq_save(flags);
+  raw_local_irq_save(flags);
 
   switch (size) {
   case 1:
@@ -152,7 +153,7 @@ static inline unsigned long __xchg(unsigned long x, volatile void * ptr, int siz
     : "=&d" (tmp) : "d" (x), "m" (*__xg(ptr)) : "memory");
     break;
   }
-  local_irq_restore(flags);
+  raw_local_irq_restore(flags);
   return tmp;
 }
 #else
-- 
1.6.0.90.g436ed

