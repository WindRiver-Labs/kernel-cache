From c361bd6ab154828057fce5e044224530a9826168 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Fri, 30 Oct 2015 13:14:33 -0700
Subject: [PATCH] sched: Use the proper LOCK_OFFSET for cond_resched()

RT does not increment preempt count when a 'sleeping' spinlock is
locked. Update PREEMPT_LOCK_OFFSET for that case.

Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
[Adjust context for 4.1.12 kernel]
Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 include/linux/preempt_mask.h | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/include/linux/preempt_mask.h b/include/linux/preempt_mask.h
index 5cb25f1..b1319bf 100644
--- a/include/linux/preempt_mask.h
+++ b/include/linux/preempt_mask.h
@@ -83,7 +83,11 @@
 /*
  * The preempt_count offset after spin_lock()
  */
+#if !defined(CONFIG_PREEMPT_RT_FULL)
 #define PREEMPT_LOCK_OFFSET	PREEMPT_DISABLE_OFFSET
+#else
+#define PREEMPT_LOCK_OFFSET	0
+#endif
 
 /*
  * The preempt_count offset needed for things like:
-- 
2.0.2

