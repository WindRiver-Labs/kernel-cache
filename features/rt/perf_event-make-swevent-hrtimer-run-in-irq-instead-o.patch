From 5136b68e62a1a623e3539282a726ac046a096060 Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Thu, 5 Jul 2012 15:57:34 +0800
Subject: [PATCH] perf_event: make swevent hrtimer run in irq instead of softirq

Otherwise we will get below dead lock:
Call Trace:
 [<c157b14c>] ? rt_spin_lock+0x2c/0x70
 [<c1579933>] schedule+0x13/0x30
 [<c10618f5>] hrtimer_wait_for_timer+0x55/0x90
 [<c105cab0>] ? autoremove_wake_function+0x0/0x50
 [<c1061947>] hrtimer_cancel+0x17/0x30
 [<c10bce2d>] perf_swevent_cancel_hrtimer+0x3d/0x50
 [<c10bce7b>] cpu_clock_perf_event_disable+0xb/0x20
 [<c10baf86>] event_sched_out+0x66/0xc0
 [<c10bb015>] group_sched_out+0x35/0x80
 [<c10bc352>] ctx_sched_out+0xb2/0xd0
 [<c1010406>] ? hw_perf_disable+0x46/0x50
 [<c10bfdaa>] perf_event_task_tick+0x8a/0x150
 [<c103ae77>] scheduler_tick+0x107/0x180
 [<c104e1e4>] update_process_times+0x34/0x60
 [<c106bf66>] tick_sched_timer+0x56/0x210
 [<c1060659>] ? __remove_hrtimer+0x39/0xc0
 [<c1060a9e>] __run_hrtimer+0x5e/0x1d0
 [<c106bf10>] ? tick_sched_timer+0x0/0x210
 [<c10610ca>] hrtimer_interrupt+0x23a/0x2e0
 [<c1005bf6>] ? dump_trace_extended+0x96/0xf0
 [<c1060e90>] ? hrtimer_interrupt+0x0/0x2e0
 [<c157c26e>] smp_apic_timer_interrupt+0x6e/0x145
 [<c157bd3f>] apic_timer_interrupt+0x2f/0x34
 [<c10c007b>] ? __perf_event_mmap+0x11b/0x290
 [<c1060480>] ? hrtimer_forward+0x130/0x1b0
 [<c10c21a7>] perf_swevent_hrtimer+0xd7/0x120
 [<c106bbe0>] ? tick_program_event+0x40/0x50
 [<c106095f>] run_hrtimer_softirq+0x7f/0x160
 [<c10c20d0>] ? perf_swevent_hrtimer+0x0/0x120
 [<c104639a>] run_ksoftirqd+0x11a/0x2b0
 [<c1046280>] ? run_ksoftirqd+0x0/0x2b0
 [<c105c774>] kthread+0x74/0x80
 [<c105c700>] ? kthread+0x0/0x80
 [<c100343a>] kernel_thread_helper+0x6/0x10

Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 kernel/perf_event.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/kernel/perf_event.c b/kernel/perf_event.c
index 5f279f0..35d2780 100644
--- a/kernel/perf_event.c
+++ b/kernel/perf_event.c
@@ -4345,6 +4345,8 @@ static void perf_swevent_start_hrtimer(struct perf_event *event)
 
 	hrtimer_init(&hwc->hrtimer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);
 	hwc->hrtimer.function = perf_swevent_hrtimer;
+	hwc->hrtimer.irqsafe = 1;
+
 	if (hwc->sample_period) {
 		u64 period;
 
-- 
1.7.0

