From: Steven Rostedt <srostedt@redhat.com>
Date: Tue, 27 Jan 2009 00:30:40 -0500
Subject: [PATCH] preempt-rt: do not allocate in smp_call_function

kmalloc can never be called with preemption disabled in PREEMPT_RT.

Signed-off-by: Steven Rostedt <srostedt@redhat.com>
(cherry picked from RT git commit 6eb0dd00265eaac6e566d96f23a32b552f188889)
---
 kernel/smp.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/kernel/smp.c b/kernel/smp.c
index f37ed97..64295d0 100644
--- a/kernel/smp.c
+++ b/kernel/smp.c
@@ -349,12 +349,15 @@ int smp_call_function_mask(cpumask_t mask, void (*func)(void *), void *info,
 		return smp_call_function_single(cpu, func, info, wait);
 	}
 
+#ifndef CONFIG_PREEMPT_RT
 	data = kmalloc(sizeof(*data), GFP_ATOMIC);
 	if (data) {
 		data->csd.flags = CSD_FLAG_ALLOC;
 		if (wait)
 			data->csd.flags |= CSD_FLAG_WAIT;
-	} else {
+	} else
+#endif
+	{
 		data = &d;
 		data->csd.flags = CSD_FLAG_WAIT;
 		wait = 1;
