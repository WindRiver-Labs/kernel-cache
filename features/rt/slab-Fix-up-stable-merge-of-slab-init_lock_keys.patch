From d4a50db855631bdcfa4cc5d0f72e3eaec94cd796 Mon Sep 17 00:00:00 2001
From: Steven Rostedt <srostedt@redhat.com>
Date: Tue, 16 Oct 2012 17:00:19 -0400
Subject: [PATCH] slab: Fix up stable merge of slab init_lock_keys()

There was a stable fix that moved the init_lock_keys() to after
the enable_cpucache(). But -rt changed this function to
init_cachep_lock_keys(). This moves the init afterwards to
match the stable fix.

Signed-off-by: Steven Rostedt <rostedt@goodmis.org>

diff --git a/mm/slab.c b/mm/slab.c
index 119969a7fc74..27a194c696e6 100644
--- a/mm/slab.c
+++ b/mm/slab.c
@@ -1763,15 +1763,12 @@ void __init kmem_cache_init_late(void)
 	/* 6) resize the head arrays to their final sizes */
 	mutex_lock(&cache_chain_mutex);
 	list_for_each_entry(cachep, &cache_chain, next) {
-		init_cachep_lock_keys(cachep);
 		if (enable_cpucache(cachep, GFP_NOWAIT))
 			BUG();
+		init_cachep_lock_keys(cachep);
 	}
 	mutex_unlock(&cache_chain_mutex);
 
-	/* Annotate slab for lockdep -- annotate the malloc caches */
-	init_lock_keys();
-
 	/* Done! */
 	g_cpucache_up = FULL;
 
-- 
1.9.0

