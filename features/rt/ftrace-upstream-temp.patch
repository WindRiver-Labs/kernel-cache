ftrace: header stubs for disabled ftrace

select header bits from ftrace-upstream
---
 include/linux/ftrace.h     |    8 ++++++++
 include/linux/tracepoint.h |    4 ++--
 init/main.c                |    1 +
 kernel/trace/trace.c       |    2 +-
 4 files changed, 12 insertions(+), 3 deletions(-)

diff --git a/include/linux/ftrace.h b/include/linux/ftrace.h
index e7b3050..fb8b93e 100644
--- a/include/linux/ftrace.h
+++ b/include/linux/ftrace.h
@@ -67,6 +67,9 @@ extern void ftrace_stub(unsigned long a0, unsigned long a1);
 void ftrace_enable(void);
 void ftrace_disable(void);
 
+extern void ftrace_disable_daemon(void);
+extern void ftrace_enable_daemon(void);
+
 /* totally disable ftrace - can not re-enable after this */
 void ftrace_kill(void);
 void __ftrace_kill(void);
@@ -121,6 +124,10 @@ static inline void ftrace_preempt_enable(int resched)
 # define function_trace_stop			0
 # define ftrace_stop()				do { } while (0)
 # define ftrace_start()				do { } while (0)
+# define ftrace_enable()			do { } while (0)
+# define ftrace_disable()			do { } while (0)
+# define ftrace_enable_daemon()			do { } while (0)
+# define ftrace_disable_daemon()		do { } while (0)
 #endif /* CONFIG_FTRACE */
 
 #ifdef CONFIG_DYNAMIC_FTRACE
@@ -170,6 +177,7 @@ void ftrace_enable_daemon(void);
 # define ftrace_set_filter(buf, len, reset)	do { } while (0)
 # define ftrace_disable_daemon()		do { } while (0)
 # define ftrace_enable_daemon()			do { } while (0)
+# define ftrace_event_irq(irq, um, ip)		do { } while (0)
 #endif /* CONFIG_DYNAMIC_FTRACE */
 
 static inline void tracer_disable(void)
diff --git a/include/linux/tracepoint.h b/include/linux/tracepoint.h
index e623a6f..142f787 100644
--- a/include/linux/tracepoint.h
+++ b/include/linux/tracepoint.h
@@ -40,14 +40,14 @@ struct tracepoint {
 	do {								\
 		void **it_func;						\
 									\
-		rcu_read_lock_sched();					\
+		preempt_disable();					\
 		it_func = rcu_dereference((tp)->funcs);			\
 		if (it_func) {						\
 			do {						\
 				((void(*)(proto))(*it_func))(args);	\
 			} while (*(++it_func));				\
 		}							\
-		rcu_read_unlock_sched();				\
+		preempt_enable();				\
 	} while (0)
 
 /*
diff --git a/init/main.c b/init/main.c
index 658efc8..bca9620 100644
--- a/init/main.c
+++ b/init/main.c
@@ -45,6 +45,7 @@
 #include <linux/interrupt.h>
 #include <linux/taskstats_kern.h>
 #include <linux/delayacct.h>
+#include <linux/ftrace.h>
 #include <linux/unistd.h>
 #include <linux/rmap.h>
 #include <linux/irq.h>
diff --git a/kernel/trace/trace.c b/kernel/trace/trace.c
index 5e745a3..6c66e49 100644
--- a/kernel/trace/trace.c
+++ b/kernel/trace/trace.c
@@ -1677,6 +1677,7 @@ lat_print_generic(struct trace_seq *s, struct trace_entry *entry, int cpu)
 }
 
 unsigned long preempt_mark_thresh = 100;
+static const char state_to_char[] = TASK_STATE_TO_CHAR_STR;
 
 static int task_state_char(unsigned long state)
 {
@@ -1698,7 +1699,6 @@ lat_print_timestamp(struct trace_seq *s, unsigned long long abs_usecs,
 		trace_seq_puts(s, " : ");
 }
 
-static const char state_to_char[] = TASK_STATE_TO_CHAR_STR;
 
 static int
 print_lat_fmt(struct trace_iterator *iter, unsigned int trace_idx, int cpu)
