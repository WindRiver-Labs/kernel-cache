From f7833fd7304d6e4934cbaa3b1571d348af98f709 Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Sat, 17 Sep 2016 12:23:28 -0400
Subject: [PATCH] rt: introduce down_write_killable_nested

Needed to build btrfs.

Reported-by: Mike Galbraith <umgwanakikbuti@gmail.com>
Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/include/linux/rwsem_rt.h b/include/linux/rwsem_rt.h
index df9771f00540..a157bba0738f 100644
--- a/include/linux/rwsem_rt.h
+++ b/include/linux/rwsem_rt.h
@@ -60,6 +60,7 @@ extern void rt__down_read(struct rw_semaphore *rwsem);
 extern void rt_down_read(struct rw_semaphore *rwsem);
 extern int  rt_down_write_trylock(struct rw_semaphore *rwsem);
 extern int  rt_down_write_killable(struct rw_semaphore *rwsem);
+extern int  rt_down_write_killable_nested(struct rw_semaphore *rwsem, int subclass);
 extern int  rt__down_read_trylock(struct rw_semaphore *rwsem);
 extern int  rt_down_read_trylock(struct rw_semaphore *rwsem);
 extern void __rt_up_read(struct rw_semaphore *rwsem);
@@ -111,6 +112,11 @@ static inline int down_write_killable(struct rw_semaphore *sem)
 	return rt_down_write_killable(sem);
 }
 
+static inline int down_write_killable_nested(struct rw_semaphore *sem, int subclass)
+{
+	return rt_down_write_killable_nested(sem, subclass);
+}
+
 static inline void __up_read(struct rw_semaphore *sem)
 {
 	__rt_up_read(sem);
diff --git a/kernel/locking/rt.c b/kernel/locking/rt.c
index c4e97e4e7dc2..3f8258ede6b0 100644
--- a/kernel/locking/rt.c
+++ b/kernel/locking/rt.c
@@ -375,6 +375,16 @@ void  rt_down_write_nested(struct rw_semaphore *rwsem, int subclass)
 }
 EXPORT_SYMBOL(rt_down_write_nested);
 
+int  rt_down_write_killable_nested(struct rw_semaphore *rwsem, int subclass)
+{
+	int ret = rt_mutex_lock_killable(&rwsem->lock);
+
+	if (ret)
+		rwsem_acquire(&rwsem->dep_map, subclass, 0, _RET_IP_);
+	return ret;
+}
+EXPORT_SYMBOL(rt_down_write_killable_nested);
+
 void rt_down_write_nested_lock(struct rw_semaphore *rwsem,
 			       struct lockdep_map *nest)
 {
-- 
2.5.0

