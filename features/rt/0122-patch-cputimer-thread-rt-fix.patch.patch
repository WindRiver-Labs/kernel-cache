From 8b070feab89932e6093e35b6aa1264fbc1476b5c Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Tue, 30 Sep 2008 16:57:16 -0400
Subject: [PATCH] patch cputimer-thread-rt-fix.patch

---
 kernel/posix-cpu-timers.c |   27 ++++++++++++++-------------
 1 files changed, 14 insertions(+), 13 deletions(-)

diff --git a/kernel/posix-cpu-timers.c b/kernel/posix-cpu-timers.c
index 5f89c37..b0e33da 100644
--- a/kernel/posix-cpu-timers.c
+++ b/kernel/posix-cpu-timers.c
@@ -1324,18 +1324,6 @@ void __run_posix_cpu_timers(struct task_struct *tsk)
 	LIST_HEAD(firing);
 	struct k_itimer *timer, *next;
 
-
-#define UNEXPIRED(clock) \
-		(cputime_eq(tsk->it_##clock##_expires, cputime_zero) || \
-		 cputime_lt(clock##_ticks(tsk), tsk->it_##clock##_expires))
-
-	if (UNEXPIRED(prof) && UNEXPIRED(virt) &&
-	    (tsk->it_sched_expires == 0 ||
-	     tsk->se.sum_exec_runtime < tsk->it_sched_expires))
-		return;
-
-#undef	UNEXPIRED
-
 	/*
 	 * Double-check with locks held.
 	 */
@@ -1460,6 +1448,19 @@ void run_posix_cpu_timers(struct task_struct *tsk)
 	BUG_ON(!irqs_disabled());
 	if(!per_cpu(posix_timer_task, cpu))
 		return;
+
+
+#define UNEXPIRED(clock) \
+		(cputime_eq(tsk->it_##clock##_expires, cputime_zero) || \
+		 cputime_lt(clock##_ticks(tsk), tsk->it_##clock##_expires))
+
+	if (UNEXPIRED(prof) && UNEXPIRED(virt) &&
+	    (tsk->it_sched_expires == 0 ||
+	     tsk->sum_exec_runtime < tsk->it_sched_expires))
+		return;
+
+#undef	UNEXPIRED
+
 	/* get per-cpu references */
 	tasklist = per_cpu(posix_timer_tasklist, cpu);
 
@@ -1478,7 +1479,7 @@ void run_posix_cpu_timers(struct task_struct *tsk)
 		per_cpu(posix_timer_tasklist, cpu) = tsk;
 	}
 	/* XXX signal the thread somehow */
-	wake_up_process(per_cpu(posix_timer_task,cpu));
+	wake_up_process(per_cpu(posix_timer_task, cpu));
 }
 
 
-- 
1.6.0.90.g436ed

