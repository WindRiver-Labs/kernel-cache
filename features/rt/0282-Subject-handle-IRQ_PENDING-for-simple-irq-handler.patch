From bf1a7e98838c1e0fd6cf0710ff4d53690cd9344b Mon Sep 17 00:00:00 2001
From: Steven Rostedt <srostedt@redhat.com>
Date: Tue, 30 Sep 2008 17:00:58 -0400
Subject: [PATCH] Subject: handle IRQ_PENDING for simple irq handler
 With the IO-APIC pcix hack (level=>edge masking), we can receive
 interrupts while masked. But these interrupts might be missed.

Also, normal "simple" interrupts might be missed too on leaving of
thread handler.

Signed-off-by: Steven Rostedt <srostedt@redhat.com>
---
 kernel/irq/manage.c |    7 +++++--
 1 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/kernel/irq/manage.c b/kernel/irq/manage.c
index 2c305c1..bc149f8 100644
--- a/kernel/irq/manage.c
+++ b/kernel/irq/manage.c
@@ -727,14 +727,17 @@ static void thread_simple_irq(irq_desc_t *desc)
 	unsigned int irq = desc - irq_desc;
 	irqreturn_t action_ret;
 
-	if (action && !desc->depth) {
+	do {
+		if (!action || desc->depth)
+			break;
+		desc->status &= ~IRQ_PENDING;
 		spin_unlock(&desc->lock);
 		action_ret = handle_IRQ_event(irq, action);
 		cond_resched_hardirq_context();
 		spin_lock_irq(&desc->lock);
 		if (!noirqdebug)
 			note_interrupt(irq, desc, action_ret);
-	}
+	} while (desc->status & IRQ_PENDING);
 	desc->status &= ~IRQ_INPROGRESS;
 }
 
-- 
1.6.0.90.g436ed

