From 871e2d51bb8f9f5a236254c62dad9e8980658875 Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Thu, 5 Feb 2009 17:08:38 -0500
Subject: [PATCH] mpic: irq_rover needs his lock to be a raw lock

Commit 591ffdd8f ("powerpc/mpic: Fix regression...") introduced
the irq_choose_cpu() which is called nested within the already
raw lock mpic_lock -- and as such, the new lock added within
irq_choose_cpu() also needs to be a raw lock, else you get these:

BUG: sleeping function called from invalid context init(1) at rtmutex.c:743
in_atomic():1 [00000001], irqs_disabled():1
Call Trace:
[df83fc20] [c0009de8] show_stack+0x6c/0x1a4 (unreliable)
[df83fc50] [c002f888] __might_sleep+0xf4/0xf8
[df83fc60] [c0334218] __rt_spin_lock+0xa4/0xa8
[df83fc70] [c001efb8] mpic_set_affinity+0x90/0x2bc
[df83fca0] [c0080c68] irq_select_affinity+0x6c/0x80
[df83fcb0] [c00818b0] setup_irq+0x2b0/0x3a0
[df83fcf0] [c0081a94] request_irq+0xf4/0x108
[df83fd20] [c020d7e4] serial8250_startup+0x678/0x698

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
---
 arch/powerpc/sysdev/mpic.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/sysdev/mpic.c b/arch/powerpc/sysdev/mpic.c
index 81dd128..1c4c6a0 100644
--- a/arch/powerpc/sysdev/mpic.c
+++ b/arch/powerpc/sysdev/mpic.c
@@ -711,7 +711,7 @@ static int irq_choose_cpu(unsigned int virt_irq)
 
 	if (cpus_equal(mask, CPU_MASK_ALL)) {
 		static int irq_rover;
-		static DEFINE_SPINLOCK(irq_rover_lock);
+		static DEFINE_RAW_SPINLOCK(irq_rover_lock);
 		unsigned long flags;
 
 		/* Round-robin distribution... */
-- 
1.6.0.4

