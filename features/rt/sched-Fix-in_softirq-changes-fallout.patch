From 0180c2bf3f37e18998bdfad1ae9ae89ec47ff3f8 Mon Sep 17 00:00:00 2001
From: Thomas Gleixner <tglx@linutronix.de>
Date: Tue, 23 Feb 2010 18:52:51 +0100
Subject: [PATCH] sched: Fix in_softirq() changes fallout

commit 534714781c652a7113b6c90479a781a6b510279e in tip.

WARNING: at kernel/sched.c:7158 cond_resched_softirq_context+0x37/0x86()
triggers now. Shut it up.

Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
---
 kernel/sched.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/kernel/sched.c b/kernel/sched.c
index 3286c87..73ec77a 100644
--- a/kernel/sched.c
+++ b/kernel/sched.c
@@ -5291,7 +5291,7 @@ EXPORT_SYMBOL(__cond_resched_softirq);
  */
 int __sched cond_resched_softirq_context(void)
 {
-	WARN_ON_ONCE(!in_softirq());
+	WARN_ON_ONCE(!in_softirq() && !(current->extra_flags & PFE_SOFTIRQ));
 
 	if (softirq_need_resched() && system_state == SYSTEM_RUNNING) {
 		raw_local_irq_disable();
-- 
1.7.0.4

