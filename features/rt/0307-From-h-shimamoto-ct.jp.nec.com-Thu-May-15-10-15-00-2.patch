From 59dc39bd04aeb6f8318fbbc400d5ca120ea0d61f Mon Sep 17 00:00:00 2001
From: Hiroshi Shimamoto <h-shimamoto@ct.jp.nec.com>
Date: Tue, 30 Sep 2008 17:01:31 -0400
Subject: [PATCH] From h-shimamoto@ct.jp.nec.com Thu May 15 10:15:00 2008
 Date: Mon, 28 Apr 2008 11:17:48 -0700
 To: Ingo Molnar <mingo@elte.hu>, Steven Rostedt <rostedt@goodmis.org>,
      Thomas Gleixner <tglx@linutronix.de>
 Cc: linux-kernel@vger.kernel.org, linux-rt-users@vger.kernel.org
 Subject: [PATCH -rt 3/4] x86: nmi_watchdog NMI needed for
     irq_show_regs_callback()
 The -rt kernel doesn't panic immediately when NMI lockup detected.
 Because the kernel waits show_regs on all cpus, but NMI is not come so
 frequently.

Signed-off-by: Hiroshi Shimamoto <h-shimamoto@ct.jp.nec.com>
---
 arch/x86/kernel/nmi.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/arch/x86/kernel/nmi.c b/arch/x86/kernel/nmi.c
index 4b88c88..721fe20 100644
--- a/arch/x86/kernel/nmi.c
+++ b/arch/x86/kernel/nmi.c
@@ -484,6 +484,13 @@ nmi_watchdog_tick(struct pt_regs *regs, unsigned reason)
 				if (i == cpu)
 					continue;
 				nmi_show_regs[i] = 1;
+			}
+
+			smp_send_nmi_allbutself();
+
+			for_each_online_cpu(i) {
+				if (i == cpu)
+					continue;
 				while (nmi_show_regs[i] == 1)
 					cpu_relax();
 			}
-- 
1.6.0.90.g436ed

