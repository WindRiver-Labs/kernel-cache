From 4d8d1267149717c08156025c24f74a56c5de4859 Mon Sep 17 00:00:00 2001
From: Olaf Hering <olaf@aepfle.de>
Date: Tue, 25 May 2010 00:04:28 +0200
Subject: [PATCH] fix undefined references to kernel_sem

commit 9846da2c9d0098bd3bbace16865aec9c463669a3 in tip.

protect kernel_sem access with CONFIG_LOCK_KERNEL
lib/kernel_lock.c is compiled conditionally.

Signed-off-by: Olaf Hering <olaf@aepfle.de>
LKML-Reference: <20100524220428.GA17771@aepfle.de>
Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
---
 init/main.c      |    4 ++++
 kernel/lockdep.c |    2 ++
 2 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/init/main.c b/init/main.c
index 0d67d3e..10e3f7c 100644
--- a/init/main.c
+++ b/init/main.c
@@ -646,9 +646,13 @@ asmlinkage void __init start_kernel(void)
 		 * the lockdep state, so release the one known lock and
 		 * acquire it again after the self-test is done.
 		 */
+#ifdef CONFIG_LOCK_KERNEL
 		mutex_release(&kernel_sem.dep_map, 1, _THIS_IP_);
+#endif
 		locking_selftest();
+#ifdef CONFIG_LOCK_KERNEL
 		mutex_acquire(&kernel_sem.dep_map, 0, 0, _THIS_IP_);
+#endif
 	}
 
 #ifdef CONFIG_BLK_DEV_INITRD
diff --git a/kernel/lockdep.c b/kernel/lockdep.c
index 32a21cc..7e04e83 100644
--- a/kernel/lockdep.c
+++ b/kernel/lockdep.c
@@ -3595,8 +3595,10 @@ void lockdep_init(void)
 	for (i = 0; i < CHAINHASH_SIZE; i++)
 		INIT_LIST_HEAD(chainhash_table + i);
 
+#ifdef CONFIG_LOCK_KERNEL
 	/* Hack alert ! */
 	lockdep_set_novalidate_class(&kernel_sem);
+#endif
 
 	lockdep_initialized = 1;
 }
-- 
1.7.0.4

