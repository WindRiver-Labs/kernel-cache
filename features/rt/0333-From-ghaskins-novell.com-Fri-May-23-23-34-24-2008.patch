From 87a15af5cb8b940d560b7177f7b54a080e0d16cd Mon Sep 17 00:00:00 2001
From: Gregory Haskins <ghaskins@novell.com>
Date: Fri, 5 Sep 2008 00:23:55 -0400
Subject: [PATCH] From ghaskins@novell.com Fri May 23 23:34:24 2008
 Date: Tue, 20 May 2008 10:49:31 -0400
 To: mingo@elte.hu, tglx@linutronix.de, rostedt@goodmis.org,
      linux-rt-users@vger.kernel.org
 Cc: linux-kernel@vger.kernel.org, sdietrich@novell.com, pmorreale@novell.com,
      mkohari@novell.com, ghaskins@novell.com
 Subject: [PATCH 4/5] adjust pi_lock usage in wakeup
     [ The following text is in the "utf-8" character set. ]
     [ Your display is set for the "iso-8859-1" character set.  ]
     [ Some characters may be displayed incorrectly. ]

In wakeup_next_waiter(), we take the pi_lock, and then find out whether
we have another waiter to add to the pending owner.  We can reduce
contention on the pi_lock for the pending owner if we first obtain the
pointer to the next waiter outside of the pi_lock.

Signed-off-by: Peter W. Morreale <pmorreale@novell.com>
Signed-off-by: Gregory Haskins <ghaskins@novell.com>
---
 kernel/rtmutex.c |   14 +++++++++-----
 1 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/kernel/rtmutex.c b/kernel/rtmutex.c
index 8c0b592..c98a2de 100644
--- a/kernel/rtmutex.c
+++ b/kernel/rtmutex.c
@@ -563,6 +563,7 @@ static void wakeup_next_waiter(struct rt_mutex *lock, int savestate)
 {
 	struct rt_mutex_waiter *waiter;
 	struct task_struct *pendowner;
+	struct rt_mutex_waiter *next;
 
 	spin_lock(&current->pi_lock);
 
@@ -625,6 +626,12 @@ static void wakeup_next_waiter(struct rt_mutex *lock, int savestate)
 	 * waiter with higher priority than pending-owner->normal_prio
 	 * is blocked on the unboosted (pending) owner.
 	 */
+
+	if (rt_mutex_has_waiters(lock))
+		next = rt_mutex_top_waiter(lock);
+	else
+		next = NULL;
+
 	spin_lock(&pendowner->pi_lock);
 
 	WARN_ON(!pendowner->pi_blocked_on);
@@ -633,12 +640,9 @@ static void wakeup_next_waiter(struct rt_mutex *lock, int savestate)
 
 	pendowner->pi_blocked_on = NULL;
 
-	if (rt_mutex_has_waiters(lock)) {
-		struct rt_mutex_waiter *next;
-
-		next = rt_mutex_top_waiter(lock);
+	if (next)
 		plist_add(&next->pi_list_entry, &pendowner->pi_waiters);
-	}
+
 	spin_unlock(&pendowner->pi_lock);
 }
 
-- 
1.6.0.90.g436ed

