From 6918cd4a120f197aa107e7d76f76bf77fbb7853f Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Thu, 15 May 2014 12:58:42 -0400
Subject: [PATCH] sched/rt: ratelimit throttling messages

Since printk_sched can only handle one message per tick (until
post 3.16) the message about how to use the sysctl knob is all
that will be emitted.  So remove that message and the counter
in favour of a ratelimit.  We leave the sysctl knob so that people
can still turn it off if desired.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/kernel/sched/rt.c b/kernel/sched/rt.c
index 02ecdf4d7fc5..4bf7d4a95dd7 100644
--- a/kernel/sched/rt.c
+++ b/kernel/sched/rt.c
@@ -889,16 +889,13 @@ static int sched_rt_runtime_exceeded(struct rt_rq *rt_rq)
 			rt_rq->rt_throttled = 1;
 
 			if (sched_rt_throttle_warn) {
-				static int __count = 0;
-
-				printk_sched("sched: RT throttling activated\n");
-				__count++;
-				if (__count == 10) {
-					printk_sched("sched: RT throttling msgs disabled.\n");	
-					printk_sched("Use \"echo 1 > /proc/sys/kernel/sched_rt_throttle_warn\" to re-enable.\n");
-					sched_rt_throttle_warn = 0;
-					__count = 0;
+				static unsigned long last = INITIAL_JIFFIES;
+
+				if (sched_rt_throttle_warn && time_after(jiffies, last + 10*HZ)) {
+					printk_sched("sched: RT throttling activated\n");
+					last = jiffies;
 				}
+
 			}
 		} else {
 			/*
-- 
1.9.0

