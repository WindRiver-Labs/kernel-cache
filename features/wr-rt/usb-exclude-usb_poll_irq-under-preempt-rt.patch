From 7f6434d40d49e7f5a00b5dcc5f1feadb1ddf9f2a Mon Sep 17 00:00:00 2001
From: Lans Zhang <jia.zhang@windriver.com>
Date: Mon, 2 Dec 2013 10:08:44 +0800
Subject: [PATCH] usb: exclude usb_poll_irq under preempt-rt

When using usb memory key to deploy wrlinux preempt-rt and usb console,
the following messages will appear.

kernel/rtmutex.c:658
in_atomic(): 0, irqs_disabled(): 1, pid: 36, name: kworker/1:1
Pid: 36, comm: kworker/1:1 Tainted: G           O 3.4.34-rt40-WR5.0.1.4_preempt-rt #1
Call Trace:
 [<c105461e>] __might_sleep+0xce/0xf0
 [<c14fe24c>] rt_spin_lock+0x1c/0x40
 [<c1056f65>] complete+0x25/0x60
 [<c14fde10>] ? rt_mutex_lock+0x20/0x50
 [<c135e1b0>] usb_stor_blocking_completion+0x10/0x20
 [<c13317b7>] usb_poll_irq_flush_helper+0x67/0xf0
 [<c1056ad4>] ? migrate_enable+0x74/0x170
 [<c10427f7>] process_one_work+0x107/0x410
 [<c1331750>] ? usb_get_hcd+0x30/0x30
 [<c1043045>] worker_thread+0x135/0x2e0
 [<c1042f10>] ? manage_workers.isra.26+0x200/0x200
 [<c1042f10>] ? manage_workers.isra.26+0x200/0x200
 [<c1047b83>] kthread+0x73/0x80
 [<c1047b10>] ? __init_kthread_worker+0x40/0x40
 [<c1505276>] kernel_thread_helper+0x6/0x10

The root cause is that usb_poll_irq is called under preempt-rt. We should exclude
usb_poll_irq under preempt-rt.

Signed-off-by: yzhu1 <yanjun.zhu@windriver.com>
Signed-off-by: Lans Zhang <jia.zhang@windriver.com>
---
 drivers/usb/core/hcd.c       | 4 ++++
 drivers/usb/serial/console.c | 2 ++
 2 files changed, 6 insertions(+)

diff --git a/drivers/usb/core/hcd.c b/drivers/usb/core/hcd.c
index 46a40e1..a0c7c13 100644
--- a/drivers/usb/core/hcd.c
+++ b/drivers/usb/core/hcd.c
@@ -2706,6 +2706,8 @@ usb_hcd_platform_shutdown(struct platform_device* dev)
 }
 EXPORT_SYMBOL_GPL(usb_hcd_platform_shutdown);
 
+#ifndef CONFIG_PREEMPT_RT_FULL
+
 /**
  * usb_poll_irq - run HCD to call all urb->complete's for a usb device
  * @udev: The usb device to poll
@@ -2766,6 +2768,8 @@ void usb_poll_irq_schedule_flush(void)
 }
 EXPORT_SYMBOL_GPL(usb_poll_irq_schedule_flush);
 
+#endif
+
 /*-------------------------------------------------------------------------*/
 
 #if defined(CONFIG_USB_MON) || defined(CONFIG_USB_MON_MODULE)
diff --git a/drivers/usb/serial/console.c b/drivers/usb/serial/console.c
index a727ccb..e24e37f 100644
--- a/drivers/usb/serial/console.c
+++ b/drivers/usb/serial/console.c
@@ -212,9 +212,11 @@ try_again:
 		/* poll the hcd device because the queue is full */
 		count -= retval;
 		buf += retval;
+#ifndef CONFIG_PREEMPT_RT_FULL
 		udelay(1);
 		usb_poll_irq(serial->dev);
 		usb_poll_irq_schedule_flush();
+#endif
 		goto try_again;
 	}
 	pr_debug("%s - return value : %d\n", __func__, retval);
-- 
1.8.4.93.g57e4c17

