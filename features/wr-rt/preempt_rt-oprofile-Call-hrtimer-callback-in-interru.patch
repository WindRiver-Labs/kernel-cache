From 0b2563aad51a44a7f632bf9774ed68056ec8db42 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Wed, 26 Sep 2012 10:58:14 -0700
Subject: [PATCH 2/3] preempt_rt: oprofile: Call hrtimer callback in interrupt
 context

Oprofile needs to get sample in an IRQ context. When oprofile working
in timer mode, it is driven by a hrtimer, and gets sample in the
hrtimer's callback routine. The callback must involved in an IRQ
context.

In preempt-rt, the callback of hrtimer called from the timer interrupt
context only if the timer set the irqsafe flag.

The patch sets the irqsafe flag for oprofile's hrtimer to make sure
the callback working in an IRQ context.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 drivers/oprofile/timer_int.c |    1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/oprofile/timer_int.c b/drivers/oprofile/timer_int.c
index 93404f7..8e73859 100644
--- a/drivers/oprofile/timer_int.c
+++ b/drivers/oprofile/timer_int.c
@@ -38,6 +38,7 @@ static void __oprofile_hrtimer_start(void *unused)
 		return;
 
 	hrtimer_init(hrtimer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);
+	hrtimer->irqsafe = 1;
 	hrtimer->function = oprofile_hrtimer_notify;
 
 	hrtimer_start(hrtimer, ns_to_ktime(TICK_NSEC),
-- 
1.7.9.7

