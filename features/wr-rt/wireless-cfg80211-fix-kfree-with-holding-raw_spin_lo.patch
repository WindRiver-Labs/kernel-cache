From 996253ba115e164c5e3ecc9f52aaae339b1db0b1 Mon Sep 17 00:00:00 2001
From: Lans Zhang <jia.zhang@windriver.com>
Date: Fri, 4 Jan 2013 12:13:08 +0800
Subject: [PATCH] wireless/cfg80211: fix kfree with holding raw_spin_lock for
 rt.

This fix is the continuation of d70245bbc
(rt: cfg80211: fix call trace of cfg80211 on -rt kernel) in case of
calling kfree with holding raw_spin_lock. The following call trace
will appear up with the above scenario:

BUG: sleeping function called from invalid context at /buildarea1/linux-windriver-r6
in_atomic(): 1, irqs_disabled(): 0, pid: 955, name: hostapd
Pid: 955, comm: hostapd Tainted: G        W    3.4.20-rt29-WR5.0.1.0_preempt-rt #3
Call Trace:
 [<ffffffff8206f14f>] __might_sleep+0xdf/0x110
 [<ffffffff827010f4>] rt_spin_lock+0x24/0x50
 [<ffffffff8214ac7b>] kfree+0xcb/0x320
 [<ffffffff82705569>] ? add_preempt_count+0xb9/0xf0
 [<ffffffffa00c7c3d>] cfg80211_mlme_register_mgmt+0x10d/0x1c0 [cfg80211]
 [<ffffffffa00ba4b7>] nl80211_register_mgmt+0x87/0xa0 [cfg80211]
 [<ffffffff8260ebbd>] genl_rcv_msg+0x22d/0x2b0
 [<ffffffff8260e990>] ? genl_rcv+0x40/0x40
 [<ffffffff8260dd89>] netlink_rcv_skb+0xa9/0xd0
 [<ffffffff8260e975>] genl_rcv+0x25/0x40
 [<ffffffff8260d72d>] netlink_unicast+0x18d/0x1e0
 [<ffffffff8260db56>] netlink_sendmsg+0x316/0x380
 [<ffffffff825cc507>] sock_sendmsg+0x127/0x1f0
 [<ffffffff825cc2a8>] ? sock_recvmsg+0x138/0x210
 [<ffffffff8232dd09>] ? prio_tree_left+0x59/0x70
 [<ffffffff8232e389>] ? prio_tree_next+0x229/0x260
 [<ffffffff825cdf84>] ? move_addr_to_kernel+0x54/0x70
 [<ffffffff825cca66>] __sys_sendmsg+0x396/0x3a0
 [<ffffffff825cab7d>] ? sock_do_ioctl+0x5d/0x70
 [<ffffffff825cae71>] ? sock_ioctl+0x81/0x2b0
 [<ffffffff82705479>] ? sub_preempt_count+0xa9/0xe0
 [<ffffffff825cf3f9>] sys_sendmsg+0x49/0x90
 [<ffffffff82708f7b>] system_call_fastpath+0x1a/0x1f

To fix this issue, it is preferred to move kfree out of the critical section
protected by raw_spin_lock.

Signed-off-by: Lans Zhang <jia.zhang@windriver.com>
---
 net/wireless/mlme.c |    7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/net/wireless/mlme.c b/net/wireless/mlme.c
index 6ae6a6c..6547f2f 100644
--- a/net/wireless/mlme.c
+++ b/net/wireless/mlme.c
@@ -649,10 +649,8 @@ int cfg80211_mlme_register_mgmt(struct wireless_dev *wdev, u32 snd_pid,
 		}
 	}
 
-	if (err) {
-		kfree(nreg);
+	if (err)
 		goto out;
-	}
 
 	memcpy(nreg->match, match_data, match_len);
 	nreg->match_len = match_len;
@@ -667,6 +665,9 @@ int cfg80211_mlme_register_mgmt(struct wireless_dev *wdev, u32 snd_pid,
  out:
 	raw_spin_unlock_bh(&wdev->mgmt_registrations_lock);
 
+	if (err)
+		kfree(nreg);
+
 	return err;
 }
 
-- 
1.7.9.7

