From b7b3edb6b69ca6a4f4ce93086944a975be17be20 Mon Sep 17 00:00:00 2001
From: chunguang yang <chunguang.yang@windriver.com>
Date: Tue, 31 Mar 2015 13:48:10 +0800
Subject: [PATCH] kdb: disable kdb_summary command in preempt context

kdb_summary in preempt context will cause calltrace like below.
so just disable it. the command offers some system info and
not affects any functionality of kdb.

Call Trace:
 <#DB> [<ffffffff81a85b67>] dump_stack+0x4e/0x7a
 [<ffffffff81080613>] __might_sleep+0xe3/0x160
 [<ffffffff81a8cb60>] rt_spin_lock+0x20/0x50
 [<ffffffff811c964d>] nr_blockdev_pages+0x1d/0x80
 [<ffffffff8112660c>] si_meminfo+0x3c/0x60
 [<ffffffff810e4f41>] kdb_summary+0x241/0x3d0
 [<ffffffff810e6aff>] kdb_parse+0x35f/0x6a0
 [<ffffffff810e7634>] kdb_main_loop+0x584/0x7c0
 [<ffffffff810ea30e>] kdb_stub+0x1de/0x450
 [<ffffffff810e028c>] kgdb_cpu_enter+0x30c/0x5b0
 [<ffffffff810e07b0>] kgdb_handle_exception+0x160/0x1d0
 [<ffffffff8103d18c>] __kgdb_notify+0x3c/0xd0
 [<ffffffff8103d235>] kgdb_notify+0x15/0x20
 [<ffffffff81078f1d>] notifier_call_chain+0x4d/0x70
 [<ffffffff810791c3>] atomic_notifier_call_chain+0x33/0x50
 [<ffffffff8107974e>] notify_die+0x2e/0x30
 [<ffffffff81003dcb>] do_int3+0x5b/0x100
 [<ffffffff81a8d505>] int3+0x25/0x40
 [<ffffffff810df9f4>] ? kgdb_breakpoint+0x14/0x20

Signed-off-by: chunguang yang <chunguang.yang@windriver.com>
---
 kernel/debug/kdb/kdb_main.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/kernel/debug/kdb/kdb_main.c b/kernel/debug/kdb/kdb_main.c
index 0b097c8..dd5c5cd 100644
--- a/kernel/debug/kdb/kdb_main.c
+++ b/kernel/debug/kdb/kdb_main.c
@@ -2429,6 +2429,7 @@ static int kdb_kill(int argc, const char **argv)
 	return 0;
 }
 
+#ifndef CONFIG_PREEMPT_RT_FULL
 struct kdb_tm {
 	int tm_sec;	/* seconds */
 	int tm_min;	/* minutes */
@@ -2538,6 +2539,7 @@ static int kdb_summary(int argc, const char **argv)
 		   val.totalram, val.freeram, val.bufferram);
 	return 0;
 }
+#endif
 
 /*
  * kdb_per_cpu - This function implements the 'per_cpu' command.
@@ -2832,8 +2834,10 @@ static void __init kdb_inittab(void)
 	  "Define a set of commands, down to endefcmd", 0, KDB_REPEAT_NONE);
 	kdb_register_repeat("kill", kdb_kill, "<-signal> <pid>",
 	  "Send a signal to a process", 0, KDB_REPEAT_NONE);
+#ifndef CONFIG_PREEMPT_RT_FULL
 	kdb_register_repeat("summary", kdb_summary, "",
 	  "Summarize the system", 4, KDB_REPEAT_NONE);
+#endif
 	kdb_register_repeat("per_cpu", kdb_per_cpu, "<sym> [<bytes>] [<cpu>]",
 	  "Display per_cpu variables", 3, KDB_REPEAT_NONE);
 	kdb_register_repeat("grephelp", kdb_grep_help, "",
-- 
1.7.5.4

