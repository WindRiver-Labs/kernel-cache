From 3d6b0a07727ef3d0d0664da915511ac2f39416ec Mon Sep 17 00:00:00 2001
From: Lans Zhang <jia.zhang@windriver.com>
Date: Fri, 4 Jan 2013 10:09:41 +0800
Subject: [PATCH] kgdb/usb-serial-console: use WARN_ON_NONRT in the path to
 usb_poll_irq.

A call trace is triggered when loading pl2303 driver with -rt kernel:

WARNING: at /home/dpdk/wrlinux/project/intel-xeon-core-preempt-rt/bitbake_build/tmp/work/intel_xeon_core-wrs-linux/linux-windriver-rt-3.4-r0/linux/drivers/usb/core/hcd.c:2639 usb_poll_irq+0x6b/0x80()
Hardware name: 2012 Client Platform
Modules linked in: iTCO_wdt snd_page_alloc soundcore evdev matroxfb_misc fan container thermal g450_pll matroxfb_g450 matroxfb_accel matroxfb_DAC1064 hwmon pl2303(+)
Pid: 757, comm: modprobe Not tainted 3.4.10-rt17-WR5.0.0.0_preempt-rt #1
Call Trace:
 [<ffffffff81034ecf>] warn_slowpath_common+0x7f/0xc0
 [<ffffffff81034f2a>] warn_slowpath_null+0x1a/0x20
 [<ffffffff8156735b>] usb_poll_irq+0x6b/0x80
 [<ffffffff8159c96c>] usb_do_console_write.isra.0+0x5c/0xd0
 [<ffffffff8159cb00>] usb_console_write+0x120/0x1a0
 [<ffffffff8179506d>] ? sub_preempt_count+0x9d/0xd0
 [<ffffffff81035581>] __call_console_drivers+0x91/0xb0
 [<ffffffff81035737>] _call_console_drivers+0x87/0x150
 [<ffffffff81035b14>] console_unlock+0x104/0x2a0
 [<ffffffff810364e8>] register_console+0x128/0x360
 [<ffffffff8159cba3>] usb_serial_console_init+0x23/0x40
 [<ffffffff8159ad20>] usb_serial_probe+0x1110/0x1310
 [<ffffffff81067de1>] ? get_parent_ip+0x11/0x50
 [<ffffffff8179100e>] ? _mutex_unlock+0xe/0x10
 [<ffffffff811b969f>] ? sysfs_addrm_finish+0x2f/0xc0
 [<ffffffff811b8ca5>] ? sysfs_link_sibling+0xa5/0xe0
 [<ffffffff81067de1>] ? get_parent_ip+0x11/0x50
 [<ffffffff81067de1>] ? get_parent_ip+0x11/0x50
 [<ffffffff8179506d>] ? sub_preempt_count+0x9d/0xd0
 [<ffffffff810691d7>] ? migrate_enable+0x87/0x1b0
 [<ffffffff8156ebb6>] usb_probe_interface+0xd6/0x1f0
 [<ffffffff8148db5e>] driver_probe_device+0x7e/0x220
 [<ffffffff8148ddab>] __driver_attach+0xab/0xb0
 [<ffffffff8148dd00>] ? driver_probe_device+0x220/0x220
 [<ffffffff8148bf0e>] bus_for_each_dev+0x5e/0x90
 [<ffffffff8148d67e>] driver_attach+0x1e/0x20
 [<ffffffff81598dc3>] usb_serial_register_drivers+0x263/0x520
 [<ffffffffa008d000>] ? 0xffffffffa008cfff
 [<ffffffffa008d017>] pl2303_driver_init+0x17/0x19 [pl2303]
 [<ffffffff810001cf>] do_one_initcall+0x3f/0x170
 [<ffffffff810967ac>] sys_init_module+0xaec/0x1de0
 [<ffffffff81799f2b>] sysenter_dispatch+0x7/0x1e

usb_poll_irq() is protected with irq-disabled context in non-rt
kernel. But this is not requried in -rt kernel. To prevent from
this warning, just use WARN_ON_NONRT instead.

Signed-off-by: Lans Zhang <jia.zhang@windriver.com>
---
 drivers/usb/core/hcd.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/usb/core/hcd.c b/drivers/usb/core/hcd.c
index ebe402b..6c7e6a9 100644
--- a/drivers/usb/core/hcd.c
+++ b/drivers/usb/core/hcd.c
@@ -2634,7 +2634,7 @@ void usb_poll_irq(struct usb_device *udev)
 {
 	struct usb_hcd *hcd;
 
-	WARN_ON_ONCE(!irqs_disabled());
+	WARN_ON_ONCE_NONRT(!irqs_disabled());
 	hcd = bus_to_hcd(udev->bus);
 	usb_poll_hcd_device = udev;
 	usb_hcd_irq(0, hcd);
-- 
1.7.9.7

