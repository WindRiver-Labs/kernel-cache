From 5efd1d9637964be8aa14d4e95c22e70592f2afd5 Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Tue, 22 Apr 2014 14:57:35 -0400
Subject: [PATCH 4/5] rt: don't have the throttling message be implicitly
 one-shot.

If a rogue RT process eats more of its allocated time than it should,
the throttling message is emitted.  However it is currently a one-shot
message, and yet there is nothing indicating that it is one shot.

Meaning that Joe User could see the message, and then adjust his
system configuration, and falsely conclude that he'd "fixed" the
issue since he no longer sees the message.  When in reality, a
reboot is currently required in order to re-enable it.

Rather than have it as one-shot, we ratelimit it to once per 10s.
And we add the ability for the end user to disable and re-enable
the messages without having to go through a reboot.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
---
 include/linux/sched/sysctl.h |  2 ++
 kernel/sched/rt.c            | 11 ++++++++++-
 kernel/sysctl.c              |  9 +++++++++
 3 files changed, 21 insertions(+), 1 deletion(-)

diff --git a/include/linux/sched/sysctl.h b/include/linux/sched/sysctl.h
index 596a0e007c62..48f1c27f21b6 100644
--- a/include/linux/sched/sysctl.h
+++ b/include/linux/sched/sysctl.h
@@ -85,6 +85,8 @@ static inline unsigned int get_sysctl_timer_migration(void)
 extern unsigned int sysctl_sched_rt_period;
 extern int sysctl_sched_rt_runtime;
 
+extern int sched_rt_throttle_warn;
+
 #ifdef CONFIG_CFS_BANDWIDTH
 extern unsigned int sysctl_sched_cfs_bandwidth_slice;
 #endif
diff --git a/kernel/sched/rt.c b/kernel/sched/rt.c
index 875b919c9523..7bc38307a6b9 100644
--- a/kernel/sched/rt.c
+++ b/kernel/sched/rt.c
@@ -9,6 +9,7 @@
 #include <linux/irq_work.h>
 
 int sched_rr_timeslice = RR_TIMESLICE;
+int sched_rt_throttle_warn = 1;
 
 static int do_sched_rt_period_timer(struct rt_bandwidth *rt_b, int overrun);
 
@@ -934,7 +935,15 @@ static int sched_rt_runtime_exceeded(struct rt_rq *rt_rq)
 		 */
 		if (likely(rt_b->rt_runtime)) {
 			rt_rq->rt_throttled = 1;
-			printk_deferred_once("sched: RT throttling activated\n");
+			if (sched_rt_throttle_warn) {
+				static unsigned long last = INITIAL_JIFFIES;
+
+				if (time_after(jiffies, last + 10*HZ)) {
+					printk_deferred("sched: RT throttling activated\n");
+					last = jiffies;
+				}
+
+			}
 		} else {
 			/*
 			 * In case we did anyway, make it go away,
diff --git a/kernel/sysctl.c b/kernel/sysctl.c
index c566b5614f96..21bfe098c7f7 100644
--- a/kernel/sysctl.c
+++ b/kernel/sysctl.c
@@ -415,6 +415,15 @@ static struct ctl_table kern_table[] = {
 		.proc_handler	= sched_rt_handler,
 	},
 	{
+		.procname	= "sched_rt_throttle_warn",
+		.data		= &sched_rt_throttle_warn,
+		.maxlen		= sizeof(int),
+		.mode		= 0644,
+		.proc_handler	= proc_dointvec_minmax,
+		.extra1		= &zero,
+		.extra2		= &one,
+	},
+	{
 		.procname	= "sched_rr_timeslice_ms",
 		.data		= &sched_rr_timeslice,
 		.maxlen		= sizeof(int),
-- 
2.1.4

