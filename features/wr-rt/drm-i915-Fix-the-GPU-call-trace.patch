From 57d6cb5c28c0cf063a2705363d0ac1e74ed06189 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Mon, 30 Sep 2013 15:43:06 +0800
Subject: [PATCH] drm/i915: Fix the GPU call trace

BUG: sleeping function called from invalid context at linux/kernel/rtmutex.c:659
in_atomic(): 1, irqs_disabled(): 0, pid: 798, name: Xorg
Preemption disabled at:[<ffffffff81452602>] i915_get_vblank_timestamp+0x42/0xa0

CPU: 3 PID: 798 Comm: Xorg Not tainted 3.10.10-rt3-WR6.0.0.0_preempt-rt #12
Hardware name: Intel Corporation Shark Bay Client platform/Basking Ridge, BIOS HSWLPTU1.86C.0109.R03.1301282

 000000000006000c ffff88023930ba68 ffffffff81856f5e ffff88023930ba80
 ffffffff8106f541 ffff88023b1c4040 ffff88023930ba98 ffffffff8185e170
 ffff88023b1c4000 ffff88023930bac8 ffffffff8144b437 0000000000000000
Call Trace:
 [<ffffffff81856f5e>] dump_stack+0x19/0x1b
 [<ffffffff8106f541>] __might_sleep+0xf1/0x170
 [<ffffffff8185e170>] rt_spin_lock+0x20/0x50
 [<ffffffff8144b437>] i915_read32+0x27/0x160
 [<ffffffff81451603>] i915_get_crtc_scanoutpos+0x63/0x1b0
 [<ffffffff81432904>] drm_calc_vbltimestamp_from_scanoutpos+0xf4/0x430
 [<ffffffff81070c8d>] ? get_parent_ip+0xd/0x50
 [<ffffffff81070d75>] ? add_preempt_count+0xa5/0xf0
 [<ffffffff81452602>] i915_get_vblank_timestamp+0x42/0xa0
 [<ffffffff81432cc8>] drm_get_last_vbltimestamp+0x48/0x70
 [<ffffffff81432d84>] vblank_disable_and_save+0x94/0x1a0
 [<ffffffff814338d6>] drm_vblank_off+0x46/0x190
 [<ffffffff8185e30e>] ? _mutex_unlock+0xe/0x10
 [<ffffffff8147284b>] ? intel_crtc_wait_for_pending_flips+0xfb/0x120
 [<ffffffff81478e5a>] haswell_crtc_disable+0x8a/0x2e0
 [<ffffffff8147c94f>] intel_crtc_update_dpms+0x6f/0xa0
 [<ffffffff8147ca1a>] intel_encoder_dpms+0x1a/0x30
 [<ffffffff8147fe78>] intel_connector_dpms+0x38/0x70
 [<ffffffff81440c78>] drm_mode_obj_set_property_ioctl+0x308/0x320
 [<ffffffff81440cc0>] drm_mode_connector_property_set_ioctl+0x30/0x40
 [<ffffffff8142f502>] drm_ioctl+0x522/0x670
 [<ffffffff81066805>] ? __remove_hrtimer+0x45/0xe0
 [<ffffffff81070c8d>] ? get_parent_ip+0xd/0x50
 [<ffffffff8115ddf5>] do_vfs_ioctl+0x325/0x5b0
 [<ffffffff81072994>] ? migrate_enable+0xd4/0x200
 [<ffffffff81052503>] ? __set_current_blocked+0x53/0x60
 [<ffffffff8115e101>] SyS_ioctl+0x81/0xa0
 [<ffffffff81052758>] ? SyS_rt_sigprocmask+0xb8/0xe0
 [<ffffffff8185f486>] system_call_fastpath+0x1a/0x1f

Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 drivers/gpu/drm/drm_irq.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/drm_irq.c b/drivers/gpu/drm/drm_irq.c
index f92da0a..bd2e8e2 100644
--- a/drivers/gpu/drm/drm_irq.c
+++ b/drivers/gpu/drm/drm_irq.c
@@ -631,7 +631,7 @@ int drm_calc_vbltimestamp_from_scanoutpos(struct drm_device *dev, int crtc,
 		/* Disable preemption to make it very likely to
 		 * succeed in the first iteration even on PREEMPT_RT kernel.
 		 */
-		preempt_disable();
+		preempt_disable_nort();
 
 		/* Get system timestamp before query. */
 		stime = ktime_get();
@@ -644,7 +644,7 @@ int drm_calc_vbltimestamp_from_scanoutpos(struct drm_device *dev, int crtc,
 		if (!drm_timestamp_monotonic)
 			mono_time_offset = ktime_get_monotonic_offset();
 
-		preempt_enable();
+		preempt_enable_nort();
 
 		/* Return as no-op if scanout query unsupported or failed. */
 		if (!(vbl_status & DRM_SCANOUTPOS_VALID)) {
-- 
1.8.4.93.g57e4c17

