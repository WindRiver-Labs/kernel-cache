From 351a38288215d8e24c9f05bb4d51278849b48530 Mon Sep 17 00:00:00 2001
From: Bruce Ashfield <bruce.ashfield@windriver.com>
Date: Mon, 31 May 2010 16:43:33 -0400
Subject: [PATCH] revoke: remove obselete operations

dir_notify, prepare_write, commit_write are no longer in the kernel.
So we can safely remove these from revoke.

Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 fs/revoke.c        |    2 +-
 fs/revoked_inode.c |   21 ---------------------
 2 files changed, 1 insertions(+), 22 deletions(-)

diff --git a/fs/revoke.c b/fs/revoke.c
index 6c8a621..1670887 100644
--- a/fs/revoke.c
+++ b/fs/revoke.c
@@ -392,7 +392,7 @@ static int do_revoke(struct inode *inode)
 	struct address_space *mapping = inode->i_mapping;
 	int err = 0;
 
-	if (current->fsuid != inode->i_uid && !capable(CAP_FOWNER))
+	if (current->cred->fsuid != inode->i_uid && !capable(CAP_FOWNER))
 		return -EPERM;
 
 	if (!inode->i_fop->revoke)
diff --git a/fs/revoked_inode.c b/fs/revoked_inode.c
index 77f9a1f..67acf81 100644
--- a/fs/revoked_inode.c
+++ b/fs/revoked_inode.c
@@ -146,11 +146,6 @@ static int revoked_file_check_flags(int flags)
 	return -EBADF;
 }
 
-static int revoked_file_dir_notify(struct file *file, unsigned long arg)
-{
-	return -EBADF;
-}
-
 static int revoked_file_flock(struct file *filp, int cmd, struct file_lock *fl)
 {
 	return -EBADF;
@@ -192,7 +187,6 @@ static const struct file_operations revoked_file_ops = {
 	.sendpage = revoked_file_sendpage,
 	.get_unmapped_area = revoked_file_get_unmapped_area,
 	.check_flags = revoked_file_check_flags,
-	.dir_notify = revoked_file_dir_notify,
 	.flock = revoked_file_flock,
 	.splice_write = revoked_file_splice_write,
 	.splice_read = revoked_file_splice_read,
@@ -220,7 +214,6 @@ static const struct file_operations revoked_special_file_ops = {
 	.sendpage = revoked_file_sendpage,
 	.get_unmapped_area = revoked_file_get_unmapped_area,
 	.check_flags = revoked_file_check_flags,
-	.dir_notify = revoked_file_dir_notify,
 	.flock = revoked_file_flock,
 	.splice_write = revoked_file_splice_write,
 	.splice_read = revoked_file_splice_read,
@@ -361,18 +354,6 @@ static int revoked_writepage(struct page *page, struct writeback_control *wbc)
 	return -EIO;
 }
 
-static int revoked_prepare_write(struct file *file, struct page *page,
-				 unsigned from, unsigned to)
-{
-	return -EIO;
-}
-
-static int revoked_commit_write(struct file *file, struct page *page,
-				unsigned from, unsigned to)
-{
-	return -EIO;
-}
-
 static ssize_t revoked_direct_IO(int rw, struct kiocb *iocb,
 				 const struct iovec *iov, loff_t offset,
 				 unsigned long nr_segs)
@@ -383,8 +364,6 @@ static ssize_t revoked_direct_IO(int rw, struct kiocb *iocb,
 static const struct address_space_operations revoked_aops = {
 	.readpage	= revoked_readpage,
 	.writepage	= revoked_writepage,
-	.prepare_write	= revoked_prepare_write,
-	.commit_write	= revoked_commit_write,
 	.direct_IO	= revoked_direct_IO,
 };
 
-- 
1.6.5.2

