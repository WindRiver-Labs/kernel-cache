From cc9bc424b53b3e31fc1f5d243ec130186d745bd4 Mon Sep 17 00:00:00 2001
From: Greg Moffatt <greg.moffatt@windriver.com>
Date: Wed, 16 Feb 2011 11:54:48 -0500
Subject: [PATCH 2/2] graphics: changes to integrate IEMGD into kernel

The introduction of the IEMGD driver required the following
changes:
- addition of the CONFIG_DRM_EMGD config option to the Kconfig
- integration of the emgd/ driver directory into the Makefile
- changes to the existing IEMGD makefile that came with the
  driver to enable it to build in the kernel
- change to the IEMGD driver file gtt.c to include a missing
  identifier, file_rss

Signed-off-by: Greg Moffatt <greg.moffatt@windriver.com>
---
 drivers/gpu/drm/Kconfig             |    8 ++
 drivers/gpu/drm/Makefile            |    1 +
 drivers/gpu/drm/emgd/Makefile       |  141 ++++++++---------------------------
 drivers/gpu/drm/emgd/emgd/gmm/gtt.c |    1 +
 4 files changed, 42 insertions(+), 109 deletions(-)

diff --git a/drivers/gpu/drm/Kconfig b/drivers/gpu/drm/Kconfig
index 305c590..dd716e4 100644
--- a/drivers/gpu/drm/Kconfig
+++ b/drivers/gpu/drm/Kconfig
@@ -157,3 +157,11 @@ config DRM_SAVAGE
 	help
 	  Choose this option if you have a Savage3D/4/SuperSavage/Pro/Twister
 	  chipset. If M is selected the module will be called savage.
+
+config DRM_EMGD
+	tristate "Intel EMGD"
+	depends on DRM
+	help
+	  Choose this option if you have a system that has support for Intel
+	  GMA500 CPU based on the PowerVR SGX535 core.  This includes the
+	  Intel Atom z-530 and E6xx eg20t.
diff --git a/drivers/gpu/drm/Makefile b/drivers/gpu/drm/Makefile
index abe3f44..0d15c07 100644
--- a/drivers/gpu/drm/Makefile
+++ b/drivers/gpu/drm/Makefile
@@ -33,4 +33,5 @@ obj-$(CONFIG_DRM_SAVAGE)+= savage/
 obj-$(CONFIG_DRM_VMWGFX)+= vmwgfx/
 obj-$(CONFIG_DRM_VIA)	+=via/
 obj-$(CONFIG_DRM_NOUVEAU) +=nouveau/
+obj-$(CONFIG_DRM_EMGD)  +=emgd/
 obj-y			+= i2c/
diff --git a/drivers/gpu/drm/emgd/Makefile b/drivers/gpu/drm/emgd/Makefile
index 7661da9..bd6821e 100755
--- a/drivers/gpu/drm/emgd/Makefile
+++ b/drivers/gpu/drm/emgd/Makefile
@@ -17,50 +17,38 @@
 # this program; if not, write to the Free Software Foundation, Inc., 
 # 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.
 #----------------------------------------------------------------------------
-export EGD_TOPLEVEL = DRM Driver
-
-KERNELVER ?= $(shell uname -r)
-KERNELDIR ?= /lib/modules/$(KERNELVER)/build
-INSTALLDIR ?= /lib/modules/$(KERNELVER)/kernel/drivers/gpu/drm/emgd
-
-BLUE = \033[34m
-OFF = \033[0m
-BUILD ?= release
-CONFIG_PVR_RELEASE ?= $(BUILD)
-CONFIG_DRM_EGD ?= m
-
-# Get the include paths pointed to the right place. 
-export  EMGD_MOD_DIR ?= $(CURDIR)
-
-PROJECT_INCLUDES = \
-	   -I$(EMGD_MOD_DIR)/include \
-	   -I$(EMGD_MOD_DIR)/emgd/display/mode/cmn \
-	   -I$(EMGD_MOD_DIR)/emgd/video/overlay/cmn \
-	   -I$(EMGD_MOD_DIR)/emgd/video/msvdx \
-	   -I$(EMGD_MOD_DIR)/emgd/include \
-	   -I$(EMGD_MOD_DIR)/emgd/cfg \
-	   -I$(EMGD_MOD_DIR)/emgd/pal/lpd \
-	   -I$(EMGD_MOD_DIR)/emgd/drm \
-	   -I$(KERNELDIR)/include/drm \
-	   -I$(EMGD_MOD_DIR)/pvr/include4 \
-	   -I$(EMGD_MOD_DIR)/pvr/services4/include \
-	   -I$(EMGD_MOD_DIR)/pvr/services4/include/env/linux \
-	   -I$(EMGD_MOD_DIR)/pvr/services4/srvkm/env/linux \
-	   -I$(EMGD_MOD_DIR)/pvr/services4/srvkm/include \
-	   -I$(EMGD_MOD_DIR)/pvr/services4/srvkm/bridged \
-	   -I$(EMGD_MOD_DIR)/pvr/services4/system/plb \
-	   -I$(EMGD_MOD_DIR)/pvr/services4/system/tnc \
-	   -I$(EMGD_MOD_DIR)/pvr/services4/system/include \
-	   -I$(EMGD_MOD_DIR)/pvr/services4/srvkm/hwdefs \
-	   -I$(EMGD_MOD_DIR)/pvr/services4/srvkm/bridged/sgx \
-	   -I$(EMGD_MOD_DIR)/pvr/services4/srvkm/devices/sgx \
-	   -I$(EMGD_MOD_DIR)/pvr/tools/intern/debug \
+# Modified to build in the WR-Linux kernel
+# Signed-off-by: Greg Moffatt <greg.moffatt@windriver.com>
+
+ccflags-y := \
+	   -Idrivers/gpu/drm/emgd/include \
+	   -Idrivers/gpu/drm/emgd/emgd/display/mode/cmn \
+	   -Idrivers/gpu/drm/emgd/emgd/video/overlay/cmn \
+	   -Idrivers/gpu/drm/emgd/emgd/video/msvdx \
+	   -Idrivers/gpu/drm/emgd/emgd/include \
+	   -Idrivers/gpu/drm/emgd/emgd/cfg \
+	   -Idrivers/gpu/drm/emgd/emgd/pal/lpd \
+	   -Idrivers/gpu/drm/emgd/emgd/drm \
+	   -Iinclude/drm \
+	   -Idrivers/gpu/drm/emgd/pvr/include4 \
+	   -Idrivers/gpu/drm/emgd/pvr/services4/include \
+	   -Idrivers/gpu/drm/emgd/pvr/services4/include/env/linux \
+	   -Idrivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux \
+	   -Idrivers/gpu/drm/emgd/pvr/services4/srvkm/include \
+	   -Idrivers/gpu/drm/emgd/pvr/services4/srvkm/bridged \
+	   -Idrivers/gpu/drm/emgd/pvr/services4/system/plb \
+	   -Idrivers/gpu/drm/emgd/pvr/services4/system/tnc \
+	   -Idrivers/gpu/drm/emgd/pvr/services4/system/include \
+	   -Idrivers/gpu/drm/emgd/pvr/services4/srvkm/hwdefs \
+	   -Idrivers/gpu/drm/emgd/pvr/services4/srvkm/bridged/sgx \
+	   -Idrivers/gpu/drm/emgd/pvr/services4/srvkm/devices/sgx \
+	   -Idrivers/gpu/drm/emgd/pvr/tools/intern/debug \
 	   -DSUPPORT_DRI_DRM_EXT \
 	   -DLINUX \
 	   -DPVR_BUILD_DIR="\"emgd\"" \
 	   -DPVR_BUILD_DATE="20100408" \
-	   -DPVR_BUILD_TYPE="\"$(CONFIG_PVR_RELEASE)\"" \
-	   -DBUILD=$(CONFIG_PVR_RELEASE) \
+	   -DPVR_BUILD_TYPE="\"release\"" \
+	   -DBUILD=release \
 	   -DPVR_SECURE_HANDLES \
 	   -DPVR_PROC_USE_SEQ_FILE \
 	   -DLDM_PCI \
@@ -94,24 +82,7 @@ PROJECT_INCLUDES = \
 	   -DSUPPORT_CPU_CACHED_BUFFERS \
 	   -DDEBUG_MESA_OGL_TRACE \
 	   -DSUPPORT_EGL_IMAGE_SYNC_DEPENDENCY \
-
-
-#       -Werror \
-	   -DSUPPORT_MEMINFO_IDS \
-
-ifeq "$(strip $(CONFIG_PVR_RELEASE))" "release"
-	ccflags-y += -DRELEASE
-else
-	# FIXME: Looks like this causes conflicts in the emgd code.
-	ccflags-y += -DDEBUG
-	ccflags-y += -DDEBUG_BUILD_TYPE 
-endif
-
-EXTRA_CFLAGS += $(PROJECT_INCLUDES)
-
-ifeq ($(PDUMP),1)
-	EXTRA_CFLAGS += -DPDUMP=1
-endif
+	   -DRELEASE
 
 EMGD_OBJS := \
 	emgd/drm/emgd_fb.o \
@@ -183,7 +154,7 @@ EMGD_OBJS := \
 	emgd/gmm/gtt.o \
 	emgd/utils/pci.o \
 	emgd/utils/memmap.o \
-	emgd/utils/math_fix.o \
+	emgd/utils/math_fix.o
 
 ENVDIR = pvr/services4/srvkm/env/linux
 COMMONDIR = pvr/services4/srvkm/common
@@ -192,16 +163,6 @@ SYSCONFIGDIR = pvr/services4/system/common
 SGXDIR = pvr/services4/srvkm/devices/sgx
 DISPCLASSDIR = pvr/services4/3rdparty/emgd_displayclass
 
-ifeq ($(PDUMP),1)
-DBGDRVDIR = pvr/tools/intern/debug/dbgdriv
-
-DBGDRV_OBJS = $(DBGDRVDIR)/linux/main.o \
-              $(DBGDRVDIR)/common/dbgdriv.o \
-              $(DBGDRVDIR)/common/ioctl.o \
-              $(DBGDRVDIR)/linux/hostfunc.o \
-              $(DBGDRVDIR)/common/hotkey.o
-endif
-
 ENV_OBJS = $(ENVDIR)/osfunc.o \
 	   $(ENVDIR)/mutils.o \
 	   $(ENVDIR)/mmap.o \
@@ -241,8 +202,6 @@ SYSCONFIG_OBJS = $(SYSCONFIGDIR)/sysconfig.o \
 	        pvr/services4/system/tnc/sysconfig.o \
 	        pvr/services4/system/plb/sysconfig.o \
 		$(SYSCONFIGDIR)/sysutils.o
-#		 $(SYSCONFIGDIR)/sysirq.o
-#	 	 $(SYSCONFIGDIR)/ospm_power.o \
 
 SGX_OBJS = $(SGXDIR)/sgxinit.o \
 	 $(SGXDIR)/sgxpower.o \
@@ -256,7 +215,6 @@ SGX_OBJS = $(SGXDIR)/sgxinit.o \
 DC_OBJS = $(DISPCLASSDIR)/emgd_dc.o \
 	  $(DISPCLASSDIR)/emgd_dc_linux.o
 
-
 emgd-y := \
 	$(DC_OBJS) \
 	$(EMGD_OBJS) \
@@ -264,41 +222,6 @@ emgd-y := \
 	$(COMMON_OBJS) \
 	$(BRIDGED_OBJS) \
 	$(SYSCONFIG_OBJS) \
-	$(SGX_OBJS) \
-
-ifeq ($(PDUMP),1)
-	emgd-y += $(DBGDRV_OBJS)
-endif
-
-obj-$(CONFIG_DRM_EGD) += emgd.o
-
-all:: clean modules
-
-modules::
-	@echo $(CURDIR) -- $(CONFIG_PVR_RELEASE)
-	@echo "$(MAKE) -C $(KERNELDIR) M=$(CURDIR) modules"
-	@$(MAKE) -C $(KERNELDIR) M=$(CURDIR) modules
-
-clean::
-	@rm -f $(emgd-y)
-	@rm -f emgd.o emgd.mod.* emgd.ko Module.* modules.order
-	@find . -name "*.cmd" -exec rm '{}' \;
-
-install::
-	install -o root -g root -m 755 -d $(INSTALLDIR)
-	install -o root -g root -m 744 emgd.ko $(INSTALLDIR)
-	/sbin/depmod -a
-
-uninstall::
-	rmmod $(INSTALLDIR)/emgd.ko
-	rm -rf $(INSTALLDIR)/emgd.ko
-	/sbin/depmod -a
-
-debug::
-	export CONFIG_PVR_RELEASE=debug; $(MAKE) modules
-
-package:: clean
-	@echo -e "$(BLUE)Packaging $(EGD_TOPLEVEL)$(OFF)";
-	mkdir -p $(EGD_PKG)/driver/
-	tar -C $(EMGD_MOD_DIR) --exclude "CVS" -czf $(EGD_PKG)/driver/emgd_drm.tgz *
+	$(SGX_OBJS)
 
+obj-$(CONFIG_DRM_EMGD) += emgd.o
diff --git a/drivers/gpu/drm/emgd/emgd/gmm/gtt.c b/drivers/gpu/drm/emgd/emgd/gmm/gtt.c
index 1123630..5cda3fb 100644
--- a/drivers/gpu/drm/emgd/emgd/gmm/gtt.c
+++ b/drivers/gpu/drm/emgd/emgd/gmm/gtt.c
@@ -64,6 +64,7 @@ static void emgd_cache_flush(void) {
 }
 
 static void invalidate_vma(unsigned long pg_offset, unsigned long bus_addr) {
+	int file_rss = 0;
 	int zap;
 	struct list_head *tmp;
 	struct client_list_struct *entry;
-- 
1.6.5.2

