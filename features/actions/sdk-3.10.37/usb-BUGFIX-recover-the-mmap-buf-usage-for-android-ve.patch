From 003d3ef8239f8e026154c7683b46b6e2609e9a94 Mon Sep 17 00:00:00 2001
From: liyuan <liyuan@actions-semi.com>
Date: Thu, 17 Dec 2015 14:17:24 +0800
Subject: [PATCH 43/62] usb: BUGFIX: recover the mmap buf usage for android
 vender uvc.

commit eb465dacc590131928c37e07f8433783245b149a from
https://github.com/xapp-le/kernel.git

Change-Id: I9fb08512cb92515f86e53a7953733c144812cd0f
---
 drivers/media/usb/uvc/uvc_queue_asoc.c      |    8 ++++++++
 drivers/media/v4l2-core/videobuf2-vmalloc.c |    3 +++
 2 files changed, 11 insertions(+), 0 deletions(-)

diff --git a/drivers/media/usb/uvc/uvc_queue_asoc.c b/drivers/media/usb/uvc/uvc_queue_asoc.c
index 5da226e..8fd865b 100755
--- a/drivers/media/usb/uvc/uvc_queue_asoc.c
+++ b/drivers/media/usb/uvc/uvc_queue_asoc.c
@@ -27,6 +27,11 @@
 
 #include "uvcvideo.h"  
 
+/*BUGFIX: recover the mmap buf usage for android vender uvc (author:liyuan,Add_code)*/
+extern  void *vb2_vmalloc_alloc(void *alloc_ctx, unsigned long size, gfp_t gfp_flags);
+extern  void vb2_vmalloc_put(void *buf_priv);
+extern  int vb2_vmalloc_mmap(void *buf_priv, struct vm_area_struct *vma);
+
 struct asoc_vb2_ion_buf {
 	void				*vaddr;
 	dma_addr_t			dma_addr;
@@ -120,6 +125,9 @@ struct vb2_mem_ops asoc_vb2_ion_memops=
 	.get_userptr	= asoc_vb2_ion_get_userptr,
 	.put_userptr	= asoc_vb2_ion_put_userptr,
 	.num_users	= asoc_vb2_ion_num_users,
+	.alloc		= vb2_vmalloc_alloc,
+	.put		= vb2_vmalloc_put,
+	.mmap		= vb2_vmalloc_mmap,
 };
 #endif
 
diff --git a/drivers/media/v4l2-core/videobuf2-vmalloc.c b/drivers/media/v4l2-core/videobuf2-vmalloc.c
index 657ab30..4f0fe3a 100644
--- a/drivers/media/v4l2-core/videobuf2-vmalloc.c
+++ b/drivers/media/v4l2-core/videobuf2-vmalloc.c
@@ -60,6 +60,7 @@ static void *vb2_vmalloc_alloc(void *alloc_ctx, unsigned long size,
 	atomic_inc(&buf->refcount);
 	return buf;
 }
+EXPORT_SYMBOL_GPL(vb2_vmalloc_alloc);
 
 static void vb2_vmalloc_put(void *buf_priv)
 {
@@ -70,6 +71,7 @@ static void vb2_vmalloc_put(void *buf_priv)
 		kfree(buf);
 	}
 }
+EXPORT_SYMBOL_GPL(vb2_vmalloc_put);
 
 static void *vb2_vmalloc_get_userptr(void *alloc_ctx, unsigned long vaddr,
 				     unsigned long size,
@@ -210,6 +212,7 @@ static int vb2_vmalloc_mmap(void *buf_priv, struct vm_area_struct *vma)
 
 	return 0;
 }
+EXPORT_SYMBOL_GPL(vb2_vmalloc_mmap);
 
 #ifdef CONFIG_HAS_DMA
 /*********************************************/
-- 
1.7.5.4

