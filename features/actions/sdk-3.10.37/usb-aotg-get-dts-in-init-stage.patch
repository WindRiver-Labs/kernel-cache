From bb44c3e2fbc25da700700ebb7283776059f27003 Mon Sep 17 00:00:00 2001
From: dengtaiping <dengtaiping@actions-semi.com>
Date: Thu, 17 Dec 2015 13:46:47 +0800
Subject: [PATCH 42/62] usb: aotg: get dts in init stage

commit da3a0601c359a889553e5650845d9c1d1fafae60 from
https://github.com/xapp-le/kernel.git

Change-Id: Id63e4c7e4331f750922252746ec145a805b0673f
---
 arch/arm/boot/dts/actduino.dtsi                    |    2 +
 arch/arm/boot/dts/actduino_bubble_gum.dts          |    4 +-
 arch/arm/boot/dts/actduino_bubble_gum_linux.dts    |    2 -
 arch/arm/boot/dts/actduino_bubble_gum_sdboot.dts   |    2 -
 .../boot/dts/actduino_bubble_gum_sdboot_linux.dts  |    2 -
 arch/arm/boot/dts/actduino_lemaker_guitar.dts      |    2 -
 .../arm/boot/dts/actduino_lemaker_guitar_linux.dts |    2 -
 arch/arm/boot/dts/actduino_probatch.dtsi           |    2 +
 arch/arm/boot/dts/actduino_s500_1080p.dts          |    2 -
 arch/arm/boot/dts/actduino_s500_720p.dts           |    2 -
 arch/arm/boot/dts/actduino_s500_lcd_1280x800.dts   |    2 -
 .../boot/dts/actduino_s500_lcd_1280x800_linux.dts  |    2 -
 .../boot/dts/actduino_s500_lcd_1280x800_sdboot.dts |    2 -
 .../actduino_s500_lcd_1280x800_sdboot_linux.dts    |    2 -
 .../boot/dts/actduino_s500_lcd_1280x800_uvc.dts    |    2 -
 arch/arm/boot/dts/actduino_s500_lcd_768x1024.dts   |    2 -
 .../boot/dts/actduino_s500_lcd_768x1024_linux.dts  |    2 -
 .../boot/dts/actduino_s500_lcd_768x1024_uvc.dts    |    2 -
 arch/arm/boot/dts/atm7059a.dtsi                    |    2 +
 arch/arm/boot/dts/atm7059a_evb.dts                 |    2 -
 drivers/usb/aotg/aotg_core.c                       |   87 +++++++++++++-------
 drivers/usb/aotg/aotg_mon.c                        |   57 -------------
 22 files changed, 63 insertions(+), 123 deletions(-)

diff --git a/arch/arm/boot/dts/actduino.dtsi b/arch/arm/boot/dts/actduino.dtsi
index 2c2b192..3fcd08b 100755
--- a/arch/arm/boot/dts/actduino.dtsi
+++ b/arch/arm/boot/dts/actduino.dtsi
@@ -280,6 +280,7 @@
 		compatible = "actions,owl-usb-2.0-0";
 		reg = <0xb0600000 0x1000>;
 		interrupts = < 0 24 0x4 >;
+		status = "disabled"; /*must disabled always although use it*/
 	};
 	
 	usb1: usb@b0700000 {
@@ -288,6 +289,7 @@
 		compatible = "actions,owl-usb-2.0-1";
 		reg = <0xb0700000 0x1000>;
 		interrupts = < 0 61 0x4 >;
+		status = "disabled"; /*must disabled always although use it*/
 	};
 
 	usb@b0400000 {
diff --git a/arch/arm/boot/dts/actduino_bubble_gum.dts b/arch/arm/boot/dts/actduino_bubble_gum.dts
index 99a34e3..fbaa5e696 100755
--- a/arch/arm/boot/dts/actduino_bubble_gum.dts
+++ b/arch/arm/boot/dts/actduino_bubble_gum.dts
@@ -1013,16 +1013,14 @@
 	};
 
 	usb@b0600000 {
-//		aotg_udc_enable = <1>;
+		aotg_udc_enable = <0>;
 		vbus_otg_en_gpio = <&gpio 36 1>; /*GPIO B4*/
 		port0_host_plug_detect = <3>;
-		status = "disabled";
 	};
 	
 	usb@b0700000 {
 		vbus_otg_en_gpio = <&gpio 36 1>; /*GPIO B4*/
 		port1_host_plug_detect = <3>;
-		status = "disabled";
 	};
 
 	usb@b0400000 {
diff --git a/arch/arm/boot/dts/actduino_bubble_gum_linux.dts b/arch/arm/boot/dts/actduino_bubble_gum_linux.dts
index 3b364ae..63b3b2b 100755
--- a/arch/arm/boot/dts/actduino_bubble_gum_linux.dts
+++ b/arch/arm/boot/dts/actduino_bubble_gum_linux.dts
@@ -1015,13 +1015,11 @@
 	usb@b0600000 {
 		vbus_otg_en_gpio = <&gpio 36 1>; /*GPIO B4*/
 		port0_host_plug_detect = <3>;
-		status = "disabled";
 	};
 	
 	usb@b0700000 {
 		vbus_otg_en_gpio = <&gpio 36 1>; /*GPIO B4*/
 		port1_host_plug_detect = <3>;
-		status = "disabled";
 	};
 
 	usb@b0400000 {
diff --git a/arch/arm/boot/dts/actduino_bubble_gum_sdboot.dts b/arch/arm/boot/dts/actduino_bubble_gum_sdboot.dts
index 728d5ad..003f737 100755
--- a/arch/arm/boot/dts/actduino_bubble_gum_sdboot.dts
+++ b/arch/arm/boot/dts/actduino_bubble_gum_sdboot.dts
@@ -1018,13 +1018,11 @@
 	usb@b0600000 {
 		vbus_otg_en_gpio = <&gpio 36 1>; /*GPIO B4*/
 		port0_host_plug_detect = <1>;
-		status = "okay";
 	};
 	
 	usb@b0700000 {
 		vbus_otg_en_gpio = <&gpio 36 1>; /*GPIO B4*/
 		port1_host_plug_detect = <1>;
-		status = "okay";
 	};
 
 	usb@b0400000 {
diff --git a/arch/arm/boot/dts/actduino_bubble_gum_sdboot_linux.dts b/arch/arm/boot/dts/actduino_bubble_gum_sdboot_linux.dts
index da26e15..36c4ac3 100755
--- a/arch/arm/boot/dts/actduino_bubble_gum_sdboot_linux.dts
+++ b/arch/arm/boot/dts/actduino_bubble_gum_sdboot_linux.dts
@@ -1018,13 +1018,11 @@
 	usb@b0600000 {
 		vbus_otg_en_gpio = <&gpio 36 1>; /*GPIO B4*/
 		port0_host_plug_detect = <1>;
-		status = "okay";
 	};
 	
 	usb@b0700000 {
 		vbus_otg_en_gpio = <&gpio 36 1>; /*GPIO B4*/
 		port1_host_plug_detect = <1>;
-		status = "okay";
 	};
 
 	usb@b0400000 {
diff --git a/arch/arm/boot/dts/actduino_lemaker_guitar.dts b/arch/arm/boot/dts/actduino_lemaker_guitar.dts
index 0257af8..28fdae3 100755
--- a/arch/arm/boot/dts/actduino_lemaker_guitar.dts
+++ b/arch/arm/boot/dts/actduino_lemaker_guitar.dts
@@ -1000,13 +1000,11 @@
 	usb@b0600000 { 
 		//vbus_otg_en_gpio = <&gpio 116 0>; /*GPIO D20*/ 
 		port0_host_plug_detect = <1>;
-		status = "okay";
 	}; 
 
 	usb@b0700000 { 
 		//vbus_otg_en_gpio = <&gpio 36 0>; /*GPIO B4*/
 		port1_host_plug_detect = <1>;
-		status = "okay";
 	};
 
 	monitor {
diff --git a/arch/arm/boot/dts/actduino_lemaker_guitar_linux.dts b/arch/arm/boot/dts/actduino_lemaker_guitar_linux.dts
index 4116b7b..dd18971 100755
--- a/arch/arm/boot/dts/actduino_lemaker_guitar_linux.dts
+++ b/arch/arm/boot/dts/actduino_lemaker_guitar_linux.dts
@@ -1000,12 +1000,10 @@
 	usb@b0600000 { 
 		//vbus_otg_en_gpio = <&gpio 116 0>; /*GPIO D20*/ 
 		port0_host_plug_detect = <1>;
-		status = "okay";
 	}; 
 	usb@b0700000 { 
 		//vbus_otg_en_gpio = <&gpio 36 0>; /*GPIO B4*/
 		port1_host_plug_detect = <1>;
-		status = "okay";
 	};
 
 	monitor {
diff --git a/arch/arm/boot/dts/actduino_probatch.dtsi b/arch/arm/boot/dts/actduino_probatch.dtsi
index e6acb24..f8f672f 100755
--- a/arch/arm/boot/dts/actduino_probatch.dtsi
+++ b/arch/arm/boot/dts/actduino_probatch.dtsi
@@ -247,6 +247,7 @@
 		compatible = "actions,owl-usb-2.0-0";
 		reg = <0xb0600000 0x1000>;
 		interrupts = < 0 24 0x4 >;
+		status = "disabled"; /*must disabled always although use it*/
 	};
 	
 	usb1: usb@b0700000 {
@@ -255,6 +256,7 @@
 		compatible = "actions,owl-usb-2.0-1";
 		reg = <0xb0700000 0x1000>;
 		interrupts = < 0 61 0x4 >;
+		status = "disabled"; /*must disabled always although use it*/
 	};
 
 	usb@b0400000 {
diff --git a/arch/arm/boot/dts/actduino_s500_1080p.dts b/arch/arm/boot/dts/actduino_s500_1080p.dts
index caede83..0f41651 100755
--- a/arch/arm/boot/dts/actduino_s500_1080p.dts
+++ b/arch/arm/boot/dts/actduino_s500_1080p.dts
@@ -986,11 +986,9 @@
   usb@b0600000 { 
      //vbus_otg_en_gpio = <&gpio 116 1>; /*GPIO D20*/ 
      port0_host_plug_detect = <2>;
-		 status = "okay";
    }; 
    usb@b0700000 { 
      vbus_otg_en_gpio =<&gpio 116 1>; /*GPIO D20*/ 
-		 status = "disabled";
    };
 
 	monitor {
diff --git a/arch/arm/boot/dts/actduino_s500_720p.dts b/arch/arm/boot/dts/actduino_s500_720p.dts
index c2cb89e..56c7a6b 100755
--- a/arch/arm/boot/dts/actduino_s500_720p.dts
+++ b/arch/arm/boot/dts/actduino_s500_720p.dts
@@ -986,11 +986,9 @@
   usb@b0600000 { 
      //vbus_otg_en_gpio = <&gpio 116 1>; /*GPIO D20*/ 
      port0_host_plug_detect = <2>;
-		 status = "okay";
    }; 
    usb@b0700000 { 
      vbus_otg_en_gpio =<&gpio 116 1>; /*GPIO D20*/ 
-		 status = "disabled";
    };
 
 	monitor {
diff --git a/arch/arm/boot/dts/actduino_s500_lcd_1280x800.dts b/arch/arm/boot/dts/actduino_s500_lcd_1280x800.dts
index 62e1d19..73aadfd 100755
--- a/arch/arm/boot/dts/actduino_s500_lcd_1280x800.dts
+++ b/arch/arm/boot/dts/actduino_s500_lcd_1280x800.dts
@@ -986,11 +986,9 @@
   usb@b0600000 { 
      //vbus_otg_en_gpio = <&gpio 116 1>; /*GPIO D20*/ 
      port0_host_plug_detect = <2>;
-		 status = "okay";
    }; 
    usb@b0700000 { 
      vbus_otg_en_gpio =<&gpio 116 1>; /*GPIO D20*/ 
-		 status = "disabled";
    };
 
 	monitor {
diff --git a/arch/arm/boot/dts/actduino_s500_lcd_1280x800_linux.dts b/arch/arm/boot/dts/actduino_s500_lcd_1280x800_linux.dts
index 569d3f8..f49687f 100755
--- a/arch/arm/boot/dts/actduino_s500_lcd_1280x800_linux.dts
+++ b/arch/arm/boot/dts/actduino_s500_lcd_1280x800_linux.dts
@@ -986,11 +986,9 @@
   usb@b0600000 { 
      //vbus_otg_en_gpio = <&gpio 116 1>; /*GPIO D20*/ 
      port0_host_plug_detect = <2>;
-		 status = "okay";
    }; 
    usb@b0700000 { 
      vbus_otg_en_gpio =<&gpio 116 1>; /*GPIO D20*/ 
-		 status = "disabled";
    };
 
 	monitor {
diff --git a/arch/arm/boot/dts/actduino_s500_lcd_1280x800_sdboot.dts b/arch/arm/boot/dts/actduino_s500_lcd_1280x800_sdboot.dts
index 8cc245e..d20fd4c 100755
--- a/arch/arm/boot/dts/actduino_s500_lcd_1280x800_sdboot.dts
+++ b/arch/arm/boot/dts/actduino_s500_lcd_1280x800_sdboot.dts
@@ -986,11 +986,9 @@
   usb@b0600000 { 
      //vbus_otg_en_gpio = <&gpio 116 1>; /*GPIO D20*/ 
      port0_host_plug_detect = <2>;
-		 status = "okay";
    }; 
    usb@b0700000 { 
      vbus_otg_en_gpio =<&gpio 116 1>; /*GPIO D20*/ 
-		 status = "disabled";
    };
 
 	monitor {
diff --git a/arch/arm/boot/dts/actduino_s500_lcd_1280x800_sdboot_linux.dts b/arch/arm/boot/dts/actduino_s500_lcd_1280x800_sdboot_linux.dts
index abf1890..8ea3efd 100755
--- a/arch/arm/boot/dts/actduino_s500_lcd_1280x800_sdboot_linux.dts
+++ b/arch/arm/boot/dts/actduino_s500_lcd_1280x800_sdboot_linux.dts
@@ -986,11 +986,9 @@
   usb@b0600000 { 
      //vbus_otg_en_gpio = <&gpio 116 1>; /*GPIO D20*/ 
      port0_host_plug_detect = <2>;
-		 status = "okay";
    }; 
    usb@b0700000 { 
      vbus_otg_en_gpio =<&gpio 116 1>; /*GPIO D20*/ 
-		 status = "disabled";
    };
 
 	monitor {
diff --git a/arch/arm/boot/dts/actduino_s500_lcd_1280x800_uvc.dts b/arch/arm/boot/dts/actduino_s500_lcd_1280x800_uvc.dts
index b812f34..5748a12 100755
--- a/arch/arm/boot/dts/actduino_s500_lcd_1280x800_uvc.dts
+++ b/arch/arm/boot/dts/actduino_s500_lcd_1280x800_uvc.dts
@@ -986,11 +986,9 @@
   usb@b0600000 { 
      //vbus_otg_en_gpio = <&gpio 116 0>; /*GPIO D20*/ 
      port0_host_plug_detect = <2>;
-		 status = "okay";
    }; 
    usb@b0700000 { 
      vbus_otg_en_gpio =<&gpio 116 0>; /*GPIO D20*/ 
-		 status = "disabled";
    };
 
 	monitor {
diff --git a/arch/arm/boot/dts/actduino_s500_lcd_768x1024.dts b/arch/arm/boot/dts/actduino_s500_lcd_768x1024.dts
index 63678da..2bdcb4f 100755
--- a/arch/arm/boot/dts/actduino_s500_lcd_768x1024.dts
+++ b/arch/arm/boot/dts/actduino_s500_lcd_768x1024.dts
@@ -986,11 +986,9 @@
   usb@b0600000 { 
      //vbus_otg_en_gpio = <&gpio 116 1>; /*GPIO D20*/ 
      port0_host_plug_detect = <2>;
-		 status = "okay";
    }; 
    usb@b0700000 { 
      vbus_otg_en_gpio =<&gpio 116 1>; /*GPIO D20*/ 
-		 status = "disabled";
    };
 
 	monitor {
diff --git a/arch/arm/boot/dts/actduino_s500_lcd_768x1024_linux.dts b/arch/arm/boot/dts/actduino_s500_lcd_768x1024_linux.dts
index 452079a..1c810fb 100755
--- a/arch/arm/boot/dts/actduino_s500_lcd_768x1024_linux.dts
+++ b/arch/arm/boot/dts/actduino_s500_lcd_768x1024_linux.dts
@@ -986,11 +986,9 @@
   usb@b0600000 { 
      //vbus_otg_en_gpio = <&gpio 116 1>; /*GPIO D20*/ 
      port0_host_plug_detect = <2>;
-		 status = "okay";
    }; 
    usb@b0700000 { 
      vbus_otg_en_gpio =<&gpio 116 1>; /*GPIO D20*/ 
-		 status = "disabled";
    };
 
 	monitor {
diff --git a/arch/arm/boot/dts/actduino_s500_lcd_768x1024_uvc.dts b/arch/arm/boot/dts/actduino_s500_lcd_768x1024_uvc.dts
index 4dbcadf..1245fd1 100755
--- a/arch/arm/boot/dts/actduino_s500_lcd_768x1024_uvc.dts
+++ b/arch/arm/boot/dts/actduino_s500_lcd_768x1024_uvc.dts
@@ -986,11 +986,9 @@
   usb@b0600000 { 
      //vbus_otg_en_gpio = <&gpio 116 0>; /*GPIO D20*/ 
      port0_host_plug_detect = <2>;
-		 status = "okay";
    }; 
    usb@b0700000 { 
      vbus_otg_en_gpio =<&gpio 116 0>; /*GPIO D20*/ 
-		 status = "disabled";
    };
 
 	monitor {
diff --git a/arch/arm/boot/dts/atm7059a.dtsi b/arch/arm/boot/dts/atm7059a.dtsi
index a996cbe..1e1ade4 100755
--- a/arch/arm/boot/dts/atm7059a.dtsi
+++ b/arch/arm/boot/dts/atm7059a.dtsi
@@ -272,6 +272,7 @@
 		compatible = "actions,owl-usb-2.0-0";
 		reg = <0xb0600000 0x1000>;
 		interrupts = < 0 24 0x4 >;
+		status = "disabled"; /*must disabled always although use it*/
 	};
 	
 	usb1: usb@b0700000 {
@@ -280,6 +281,7 @@
 		compatible = "actions,owl-usb-2.0-1";
 		reg = <0xb0700000 0x1000>;
 		interrupts = < 0 61 0x4 >;
+		status = "disabled"; /*must disabled always although use it*/
 	};
 
 	usb@b0400000 {
diff --git a/arch/arm/boot/dts/atm7059a_evb.dts b/arch/arm/boot/dts/atm7059a_evb.dts
index 82a32ee..8075b7f 100755
--- a/arch/arm/boot/dts/atm7059a_evb.dts
+++ b/arch/arm/boot/dts/atm7059a_evb.dts
@@ -935,11 +935,9 @@
 
 	usb@b0600000 {
 		vbus_otg_en_gpio = <&gpio 126 0>; /*GPIO D30*/
-		status = "disabled";
 	};
 	usb@b0700000 {
 		vbus_otg_en_gpio =<&gpio 125 0>; /*GPIO D29*/
-		status = "disabled";
 	};
 
 	usb@b0400000 {
diff --git a/drivers/usb/aotg/aotg_core.c b/drivers/usb/aotg/aotg_core.c
index b713e97..d309e97 100755
--- a/drivers/usb/aotg/aotg_core.c
+++ b/drivers/usb/aotg/aotg_core.c
@@ -340,39 +340,65 @@ struct of_device_id aotg_of_match[] = {
 };
 MODULE_DEVICE_TABLE(of, aotg_of_match);
 
-static int aotg_platform_device_init(struct platform_device *pdev)
+void aotg_get_dts(void)
 {
 	struct device_node *of_node;
 	enum of_gpio_flags flags;
-
-	of_node = of_find_compatible_node(NULL, NULL, aotg_of_match[pdev->id].compatible);
-	if (NULL == of_node) {
-		dev_err(&pdev->dev, "can't find usbh%d dts node\n",pdev->id);
-		return -1;
-	}
-
-	if (aotg_mode[pdev->id] == UDC_MODE)
-		return 0;
-
-	if (!of_find_property(of_node, "vbus_otg_en_gpio", NULL)) {
-		pr_info("can't find vbus_otg_en_gpio config\n");
-		vbus_otg_en_gpio[pdev->id][0] = -1;
-	} else {
-		vbus_otg_en_gpio[pdev->id][0] = of_get_named_gpio_flags(of_node, "vbus_otg_en_gpio",0, &flags);
-		vbus_otg_en_gpio[pdev->id][1] = flags & 0x01;
-		if (gpio_request(vbus_otg_en_gpio[pdev->id][0], aotg_of_match[pdev->id].compatible)) {
-			dev_dbg(&pdev->dev, "fail to request vbus gpio [%d]\n", vbus_otg_en_gpio[pdev->id][0]);
-			//return -3;
+	
+	of_node = of_find_compatible_node(NULL, NULL, "actions,owl-usb-2.0-0");
+	if (of_node) {
+		if (!of_find_property(of_node, "port0_host_plug_detect", NULL)) {
+			pr_info("can't find port0_host_plug_detect config\n");
+			port_host_plug_detect[0] = 0;
+		}	else {
+			port_host_plug_detect[0] = be32_to_cpup((const __be32 *)of_get_property(of_node,  "port0_host_plug_detect",NULL));
 		}
-		gpio_direction_output(vbus_otg_en_gpio[pdev->id][0], 1);
+		pr_info("port_host_plug_detect[0]:%d\n", port_host_plug_detect[0]);
+		
+		if (!of_find_property(of_node, "vbus_otg_en_gpio", NULL)) {
+			pr_debug("can't find vbus_otg0_en_gpio config\n");
+			vbus_otg_en_gpio[0][0] = -1;
+		}	else {
+			vbus_otg_en_gpio[0][0] = of_get_named_gpio_flags(of_node,  "vbus_otg_en_gpio",0, &flags);
+			vbus_otg_en_gpio[0][1] = flags & 0x01;
+			if (gpio_request(vbus_otg_en_gpio[0][0], aotg_of_match[0].compatible))
+				pr_debug("fail to request vbus gpio [%d]\n", vbus_otg_en_gpio[0][0]);
+			if (port_host_plug_detect[0] != 2)
+				gpio_direction_output(vbus_otg_en_gpio[0][0], !!port_host_plug_detect[0]);
+		}
+		pr_info("port0_vubs_en:%d\n",vbus_otg_en_gpio[0][0]);
+	}
+	else {
+		pr_debug("can't find usbh0 dts node\n");
 	}
 	
-	pr_info("vbus_otg_en_gpio:%d\n",vbus_otg_en_gpio[pdev->id][0]);
-	
-	aotg_power_onoff(pdev->id,1);
-
-	return 0;
-};
+	of_node = of_find_compatible_node(NULL, NULL, "actions,owl-usb-2.0-1");
+	if (of_node) {
+		if (!of_find_property(of_node, "port1_host_plug_detect", NULL)) {
+			pr_info("can't find port1_host_plug_detect config\n");
+			port_host_plug_detect[1] = 0;
+		}	else {
+			port_host_plug_detect[1] = be32_to_cpup((const __be32 *)of_get_property(of_node,  "port1_host_plug_detect",NULL));
+		}
+		pr_info("port_host_plug_detect[1]:%d\n", port_host_plug_detect[1]);
+		
+		if (!of_find_property(of_node, "vbus_otg_en_gpio", NULL)) {
+			printk("can't find vbus_otg1_en_gpio config\n");
+			vbus_otg_en_gpio[1][0] = -1;
+		}	else {
+			vbus_otg_en_gpio[1][0] = of_get_named_gpio_flags(of_node,  "vbus_otg_en_gpio",0, &flags);
+			vbus_otg_en_gpio[1][1] = flags & 0x01;
+			if (gpio_request(vbus_otg_en_gpio[1][0], aotg_of_match[1].compatible))
+				pr_debug("fail to request vbus gpio [%d]\n", vbus_otg_en_gpio[1][0]);
+			if (port_host_plug_detect[1] != 2)
+				gpio_direction_output(vbus_otg_en_gpio[1][0], !!port_host_plug_detect[1]);
+		}
+		pr_info("port1_vubs_en:%d\n",vbus_otg_en_gpio[1][0]);
+	}
+	else {
+		pr_debug("can't find usbh1 dts node\n");
+	}
+}
 
 int aotg_probe(struct platform_device *pdev)
 {
@@ -384,10 +410,8 @@ int aotg_probe(struct platform_device *pdev)
 	int irq;
 	int retval;
 
-	if (aotg_platform_device_init(pdev) <0) {
-		retval = -ENODEV;
-		goto err0;
-	}
+	if (aotg_mode[pdev->id] == HCD_MODE)
+		aotg_power_onoff(pdev->id,1);
 
 	res_mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);
 	if (!res_mem) {
@@ -888,6 +912,7 @@ static int __init aotg_init(void)
 	create_acts_hcd_proc();
 	platform_driver_register(&aotg_udc_driver);
 	create_acts_udc_proc();
+	aotg_get_dts();
 	aotg_udc_add();
 	start_mon_wq = create_singlethread_workqueue("aotg_start_mon_wq");
 	INIT_DELAYED_WORK(&start_mon_wker, aotg_uhost_mon_init);
diff --git a/drivers/usb/aotg/aotg_mon.c b/drivers/usb/aotg/aotg_mon.c
index 33ebdbd..d707647 100755
--- a/drivers/usb/aotg/aotg_mon.c
+++ b/drivers/usb/aotg/aotg_mon.c
@@ -246,63 +246,6 @@ static struct aotg_uhost_mon_t * aotg_uhost_mon_alloc(void)
 
 void aotg_uhost_mon_init(struct work_struct *w)
 {
-	struct device_node *of_node;
-	enum of_gpio_flags flags;
-	
-	of_node = of_find_compatible_node(NULL, NULL, "actions,owl-usb-2.0-0");
-	if (of_node) {
-		if (!of_find_property(of_node, "port0_host_plug_detect", NULL)) {
-			pr_info("can't find port0_host_plug_detect config\n");
-			port_host_plug_detect[0] = 0;
-		}	else {
-			port_host_plug_detect[0] = be32_to_cpup((const __be32 *)of_get_property(of_node,  "port0_host_plug_detect",NULL));
-		}
-		pr_info("port_host_plug_detect[0]:%d\n", port_host_plug_detect[0]);
-		
-		if (!of_find_property(of_node, "vbus_otg_en_gpio", NULL)) {
-			pr_debug("can't find vbus_otg0_en_gpio config\n");
-			vbus_otg_en_gpio[0][0] = -1;
-		}	else {
-			vbus_otg_en_gpio[0][0] = of_get_named_gpio_flags(of_node,  "vbus_otg_en_gpio",0, &flags);
-			vbus_otg_en_gpio[0][1] = flags & 0x01;
-			if (gpio_request(vbus_otg_en_gpio[0][0], aotg_of_match[0].compatible))
-				pr_debug("fail to request vbus gpio [%d]\n", vbus_otg_en_gpio[0][0]);
-			if (port_host_plug_detect[0] != 2)
-				gpio_direction_output(vbus_otg_en_gpio[0][0], !!port_host_plug_detect[0]);
-		}
-		pr_info("port0_vubs_en:%d\n",vbus_otg_en_gpio[0][0]);
-	}
-	else {
-		pr_debug("can't find usbh0 dts node\n");
-	}
-	
-	of_node = of_find_compatible_node(NULL, NULL, "actions,owl-usb-2.0-1");
-	if (of_node) {
-		if (!of_find_property(of_node, "port1_host_plug_detect", NULL)) {
-			pr_info("can't find port1_host_plug_detect config\n");
-			port_host_plug_detect[1] = 0;
-		}	else {
-			port_host_plug_detect[1] = be32_to_cpup((const __be32 *)of_get_property(of_node,  "port1_host_plug_detect",NULL));
-		}
-		pr_info("port_host_plug_detect[1]:%d\n", port_host_plug_detect[1]);
-		
-		if (!of_find_property(of_node, "vbus_otg_en_gpio", NULL)) {
-			printk("can't find vbus_otg1_en_gpio config\n");
-			vbus_otg_en_gpio[1][0] = -1;
-		}	else {
-			vbus_otg_en_gpio[1][0] = of_get_named_gpio_flags(of_node,  "vbus_otg_en_gpio",0, &flags);
-			vbus_otg_en_gpio[1][1] = flags & 0x01;
-			if (gpio_request(vbus_otg_en_gpio[1][0], aotg_of_match[1].compatible))
-				pr_debug("fail to request vbus gpio [%d]\n", vbus_otg_en_gpio[1][0]);
-			if (port_host_plug_detect[1] != 2)
-				gpio_direction_output(vbus_otg_en_gpio[1][0], !!port_host_plug_detect[1]);
-		}
-		pr_info("port1_vubs_en:%d\n",vbus_otg_en_gpio[1][0]);
-	}
-	else {
-		pr_debug("can't find usbh1 dts node\n");
-	}
-	
 	if (port_host_plug_detect[0]) {
 		aotg_uhost_mon0 = aotg_uhost_mon_alloc();
 		aotg_uhost_mon0->id = 0;
-- 
1.7.5.4

