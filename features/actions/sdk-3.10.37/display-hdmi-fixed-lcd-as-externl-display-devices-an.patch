From e002a73c2a682f8b857c7fecf8f9051a342f3659 Mon Sep 17 00:00:00 2001
From: wanghui <wanghui@actions-semi.com>
Date: Mon, 21 Dec 2015 19:29:05 +0800
Subject: [PATCH 45/62] display: hdmi: fixed lcd as externl display devices
 and enable hdmi

commit cefb6d5e3e4fa5eaf9da910b9eeb7dd0a7fb7ac6 from
https://github.com/xapp-le/kernel.git

Change-Id: I349d4c6d52cca63e81cf53375dba1fa54496f28a
---
 drivers/video/fbdev/owl/displays/hdmi/hdmi.c |    6 +++---
 drivers/video/fbdev/owl/fb/owlfb-sysfs.c     |   15 ++++++++++++---
 2 files changed, 15 insertions(+), 6 deletions(-)

diff --git a/drivers/video/fbdev/owl/displays/hdmi/hdmi.c b/drivers/video/fbdev/owl/displays/hdmi/hdmi.c
index 6d89429..b19c366 100755
--- a/drivers/video/fbdev/owl/displays/hdmi/hdmi.c
+++ b/drivers/video/fbdev/owl/displays/hdmi/hdmi.c
@@ -502,25 +502,25 @@ void hdmi_send_uevent(bool data)
 			HDMI_DEBUG("parse_edid end\n");		
 			if(hdmi.data.hpd_en){	
 				switch_set_state(&hdev, 1);	
+				atomic_set(&hdmi_status, 1);
 			}
 			if(hdmi.dssdev != NULL 
 				&& hdmi.dssdev->driver != NULL 
 				&& hdmi.dssdev->driver->hot_plug_nodify){
 				hdmi.dssdev->driver->hot_plug_nodify(hdmi.dssdev,data);	
 			}
-			atomic_set(&hdmi_status, 1);
 		}
 	}else{
 		if((atomic_read(&hdmi_status)==1)&&hdmi.data.send_uevent){
 			if(hdmi.data.hpd_en){
 				switch_set_state(&hdev, 0);	
+				atomic_set(&hdmi_status, 0);
 			}
 			if(hdmi.dssdev != NULL 
 				&& hdmi.dssdev->driver != NULL 
 				&& hdmi.dssdev->driver->hot_plug_nodify){
 				hdmi.dssdev->driver->hot_plug_nodify(hdmi.dssdev,data);	
 			}
-			atomic_set(&hdmi_status, 0);
 		}	
 	}		
 	mutex_unlock(&hdmi.ip_data.lock);
@@ -677,11 +677,11 @@ void owldss_hdmi_display_enable_hotplug(struct owl_dss_device *dssdev, bool enab
 	HDMI_DEBUG("owldss_hdmi_display_enable_hotplug  enable %d\n", enable);
 	hdmi.ip_data.ops->hpd_enable(&hdmi.ip_data, enable);
 	if(enable){
+		hdmi.data.hpd_en = 1;
 		if(hdmi.ip_data.ops->cable_check(&hdmi.ip_data)){
 			HDMI_DEBUG("owldss_hdmi_display_enable_hotplug  switch_set_state 1\n");
 			hdmi_send_uevent(1);
 		}
-		hdmi.data.hpd_en = 1;
 	}else{
 		if(hdmi.ip_data.ops->cable_check(&hdmi.ip_data)){
 			HDMI_DEBUG("owldss_hdmi_display_enable_hotplug  switch_set_state 0\n");
diff --git a/drivers/video/fbdev/owl/fb/owlfb-sysfs.c b/drivers/video/fbdev/owl/fb/owlfb-sysfs.c
index a87e46c..9247231 100755
--- a/drivers/video/fbdev/owl/fb/owlfb-sysfs.c
+++ b/drivers/video/fbdev/owl/fb/owlfb-sysfs.c
@@ -84,9 +84,18 @@ static ssize_t store_mirror_to_hdmi(struct device *dev,
 				dssdev->driver->enable(dssdev);	
 			}
 		}else{
-			dssdev->driver->get_vid(dssdev,&vid);
-			dssdev->driver->set_vid(dssdev,vid);		
-			dssdev->driver->enable(dssdev);	
+			if(dssdev->driver->get_vid)
+			{
+				dssdev->driver->get_vid(dssdev,&vid);
+			}
+			if(dssdev->driver->set_vid)
+			{
+				dssdev->driver->set_vid(dssdev,vid);
+			}
+			if(dssdev->driver->enable)
+			{
+				dssdev->driver->enable(dssdev);
+			}
 		}		
 		external_mgr->link_fbi	= fbi;
 		
-- 
1.7.5.4

