From 5dc1140f2c516157e4d9dd2e28dedf0625de236d Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E8=B0=A2=E5=8F=8C=E5=8F=8C?= <xieshsh@srv-pad-compile2.actions.com.cn>
Date: Wed, 30 Dec 2015 15:26:20 +0800
Subject: [PATCH 52/62] display: cvbs: Repair cvbs quick plug does not show

commit 0efdb9739248e6eadf305c63d83749341d46401d from
https://github.com/xapp-le/kernel.git

Change-Id: I0683ff974aed5264c1936bafbe473e5fbf3018ec
---
 drivers/video/fbdev/owl/displays/cvbs/cvbs.c |    4 +++-
 drivers/video/fbdev/owl/displays/hdmi/hdmi.c |    8 +++++++-
 drivers/video/fbdev/owl/fb/owlfb-ioctl.c     |    3 +++
 3 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/drivers/video/fbdev/owl/displays/cvbs/cvbs.c b/drivers/video/fbdev/owl/displays/cvbs/cvbs.c
index fa6a7a3..b8a6074 100755
--- a/drivers/video/fbdev/owl/displays/cvbs/cvbs.c
+++ b/drivers/video/fbdev/owl/displays/cvbs/cvbs.c
@@ -309,7 +309,8 @@ static void do_cvbs_in(struct work_struct *work)
 	DEBUG_CVBS("[%s start]\n", __func__);
 	if(cvbs.hot_plugin_enable)
 	{
-		set_cvbs_status(&cdev, 1);	
+		set_cvbs_status(&cdev, 1);
+		enable_cvbs_output();	
 	}		
 }
 
@@ -319,6 +320,7 @@ static void do_cvbs_out(struct work_struct *work)
 		if(cvbs.hot_plugin_enable)
 		{
 			set_cvbs_status(&cdev, 0);	
+			disable_cvbs_output();
 		}
 
 }
diff --git a/drivers/video/fbdev/owl/displays/hdmi/hdmi.c b/drivers/video/fbdev/owl/displays/hdmi/hdmi.c
index 88cfd80..55cc34c 100755
--- a/drivers/video/fbdev/owl/displays/hdmi/hdmi.c
+++ b/drivers/video/fbdev/owl/displays/hdmi/hdmi.c
@@ -758,7 +758,13 @@ void owldss_hdmi_display_get_overscan(struct owl_dss_device *dssdev, u16 * over_
 
 int owldss_hdmi_read_edid(struct owl_dss_device *dssdev, u8 * buffer , int len)
 {
-	int r = read_edid(buffer,len);
+	
+  int r = owldss_hdmi_display_get_cable_status(dssdev);
+  if(!r){
+         printk("owldss_hdmi_read_edid ~~~ error hdmi not connected \n");
+         return r;
+       }
+    r = read_edid(buffer,len);
 	if(r <= 0){
 		printk("owldss_hdmi_read_edid ~~~ error\n");
 	}
diff --git a/drivers/video/fbdev/owl/fb/owlfb-ioctl.c b/drivers/video/fbdev/owl/fb/owlfb-ioctl.c
index c614551..600e974 100755
--- a/drivers/video/fbdev/owl/fb/owlfb-ioctl.c
+++ b/drivers/video/fbdev/owl/fb/owlfb-ioctl.c
@@ -736,6 +736,9 @@ int owlfb_ioctl(struct fb_info *fbi, unsigned int cmd, unsigned long arg)
 	case OWLFB_CVBS_OFF:{
 		printk("ioctl OWLFB_CVBS_OFF\n");
 		atomic_set(&want_close_external_devices,true);
+		unlock_fb_info(fbi);
+		msleep(500);   
+		lock_fb_info(fbi);
 		break;
 	}
 	
-- 
1.7.5.4

