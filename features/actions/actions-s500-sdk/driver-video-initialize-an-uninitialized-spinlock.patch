From 100c5f4eb62508ea2c5f17203fc2e3ad6f8c0ab7 Mon Sep 17 00:00:00 2001
From: Limeng <Meng.Li@windriver.com>
Date: Mon, 16 Jan 2017 13:52:41 +0800
Subject: [PATCH 2/2] driver: video: initialize an uninitialized spinlock
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

In de_irq_init() function, the spinlock irq_lock is used without
initializing, If you enable lock debugging kernel configure as below:
CONFIG_DEBUG_SPINLOCK=y
CONFIG_DEBUG_MUTEXES=y
CONFIG_DEBUG_LOCK_ALLOC=y
CONFIG_PROVE_LOCKING=y
CONFIG_LOCKDEP=y
CONFIG_DEBUG_LOCKDEP=y
CONFIG_DEBUG_ATOMIC_SLEEP=y
CONFIG_DEBUG_LOCKING_API_SELFTESTS=y
CONFIG_LOCK_TORTURE_TEST=m
CONFIG_TRACE_IRQFLAGS=y
CONFIG_STACKTRACE=y

there will be core trace occurring as below:
BUG: spinlock bad magic on CPU#2, swapper/0/1
lock: owl_de_atm7059+0x20/0x98, .magic: 00000000, .owner: <none>/-1, .owner_cpu: 0
CPU: 2 PID: 1 Comm: swapper/0 Not tainted 4.1.21-WR8.0.0.0_standard #1
Hardware name: gs705a
[<c00191a8>] (unwind_backtrace) from [<c0013d28>] (show_stack+0x20/0x24)
[<c0013d28>] (show_stack) from [<c098fed8>] (dump_stack+0xa0/0xd8)
[<c098fed8>] (dump_stack) from [<c008e328>] (spin_dump+0x88/0x9c)
[<c008e328>] (spin_dump) from [<c008e370>] (spin_bug+0x34/0x38)
[<c008e370>] (spin_bug) from [<c008e410>] (do_raw_spin_lock+0x30/0x198)
[<c008e410>] (do_raw_spin_lock) from [<c099d078>] (_raw_spin_lock_irqsave+0x5c/0x68)
[<c099d078>] (_raw_spin_lock_irqsave) from [<c0d503a8>] (owl_de_probe+0x290/0x3c4)
[<c0d503a8>] (owl_de_probe) from [<c04e4da4>] (platform_drv_probe+0x58/0xa8)
[<c04e4da4>] (platform_drv_probe) from [<c04e28c0>] (driver_probe_device+0x104/0x26c)
[<c04e28c0>] (driver_probe_device) from [<c04e2afc>] (__driver_attach+0x80/0xa4)
[<c04e2afc>] (__driver_attach) from [<c04e0e58>] (bus_for_each_dev+0x7c/0xa0)
[<c04e0e58>] (bus_for_each_dev) from [<c04e235c>] (driver_attach+0x28/0x30)
[<c04e235c>] (driver_attach) from [<c04e1fa8>] (bus_add_driver+0xf4/0x1dc)
[<c04e1fa8>] (bus_add_driver) from [<c04e3c98>] (driver_register+0xac/0xf0)
[<c04e3c98>] (driver_register) from [<c04e4cc0>] (__platform_driver_register+0x58/0x6c)
[<c04e4cc0>] (__platform_driver_register) from [<c0d50020>] (owl_de_init+0x18/0x70)
[<c0d50020>] (owl_de_init) from [<c00097d4>] (do_one_initcall+0x114/0x1c8)
[<c00097d4>] (do_one_initcall) from [<c0d20f40>] (kernel_init_freeable+0x200/0x2fc)
[<c0d20f40>] (kernel_init_freeable) from [<c098af18>] (kernel_init+0x1c/0xf4)
[<c098af18>] (kernel_init) from [<c000f4a8>] (ret_from_fork+0x14/0x2c)
This issue is introduced by commit 91ad4ed00ed4
(“video: add owl video drivers”) when merge SDK patch related with
video driver.
So, initialize spinlock irq_lock to fix this issue.

Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/video/fbdev/owl/dss/de.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/video/fbdev/owl/dss/de.c b/drivers/video/fbdev/owl/dss/de.c
index 4302900..e2fe20d 100755
--- a/drivers/video/fbdev/owl/dss/de.c
+++ b/drivers/video/fbdev/owl/dss/de.c
@@ -916,6 +916,8 @@ static int __init owl_de_probe(struct platform_device *pdev) {
 		return -EINVAL;
 	}
 
+	spin_lock_init(&de_pdata->irq_lock);
+
 	/* set de hw id */
 	if (strcmp(match->compatible, "actions,atm7059tc-de") == 0)
 		de_pdata->id = DE_HW_ID_ATM7059TC;
-- 
1.7.5.4

