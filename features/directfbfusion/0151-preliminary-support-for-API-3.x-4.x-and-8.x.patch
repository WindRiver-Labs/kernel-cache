From bca5f2f5af4411729668a20073b3edb8699e2c8e Mon Sep 17 00:00:00 2001
From: Niels Roest <niels@directfb.org>
Date: Fri, 27 Feb 2009 16:37:35 +0100
Subject: [PATCH] preliminary support for API 3.x, 4.x and 8.x

3.x for DirectFB 1.0
4.x for DirectFB 1.1
8.x for DirectFB 1.2 and later

In Fusion Enter the master passes the requested APIs,
the slaves have to match (allowed is smaller minor).

For 1.0 compatibility, the macros FUSION_API_MAJOR
and _MINOR default to API 3.3.
---
 drivers/char/fusion/call.c      |    5 ++-
 drivers/char/fusion/fusiondev.c |   40 +++++++++++++++++++++++++++++++-------
 drivers/char/fusion/fusiondev.h |    4 +++
 drivers/char/fusion/fusionee.c  |   17 +++++++++++++--
 include/linux/fusion.h          |   18 ++++++++++++----
 5 files changed, 66 insertions(+), 18 deletions(-)

diff --git a/drivers/char/fusion/call.c b/drivers/char/fusion/call.c
index c3d16af..989eadd 100644
--- a/drivers/char/fusion/call.c
+++ b/drivers/char/fusion/call.c
@@ -306,8 +306,9 @@ fusion_call_return (FusionDev *dev, int fusion_id, FusionCallReturn *call_ret)
      while (l) {
           FusionCallExecution *execution = (FusionCallExecution*) l;
 
-          /* Check for call ID (should always match) and execution serial. */
-          if (execution->call_id != call_ret->call_id || execution->serial != call_ret->serial) {
+          if (    (execution->executed)
+               || (execution->call_id != call_ret->call_id)
+               || ((dev->api.major >= 4) && (execution->serial != call_ret->serial))    ) {
                l = l->prev;
                continue;
           }
diff --git a/drivers/char/fusion/fusiondev.c b/drivers/char/fusion/fusiondev.c
index 341917b..99b1159 100644
--- a/drivers/char/fusion/fusiondev.c
+++ b/drivers/char/fusion/fusiondev.c
@@ -141,7 +141,10 @@ fusiondev_stat_read_proc(char *buf, char **start, off_t offset,
      FusionDev *dev     = private;
      int        written = 0;
 
-     written += snprintf( buf, len,
+     if ( (dev->api.major != 0) || (dev->api.minor != 0) )
+          written += sprintf( buf, "Fusion API:%d.%d\n", dev->api.major, dev->api.minor );
+     
+     written += snprintf( buf + written, offset + len - written,
                           "lease/purchase   cede      attach     detach   dispatch      "
                           "ref up   ref down  prevail/swoop dismiss\n" );
      if (written < offset) {
@@ -150,7 +153,7 @@ fusiondev_stat_read_proc(char *buf, char **start, off_t offset,
      }
 
      if (written < len) {
-          written += snprintf( buf+written, len - written,
+          written += snprintf( buf+written, offset + len - written,
                                "%10d %10d  %10d %10d %10d  %10d %10d  %10d %10d\n",
                                dev->stat.property_lease_purchase,
                                dev->stat.property_cede,
@@ -865,16 +868,34 @@ reactor_ioctl (FusionDev *dev, Fusionee *fusionee,
                return 0;
 
           case _IOC_NR(FUSION_REACTOR_ATTACH):
-               if (copy_from_user (&attach,
-                                   (FusionReactorAttach*) arg, sizeof(attach)))
-                    return -EFAULT;
+               if (dev->api.major <= 4) {
+                    if (get_user (id, (int*) arg))
+                         return -EFAULT;
+
+                    attach.reactor_id = id;
+                    attach.channel    = 0;
+               }
+               else {
+                    if (copy_from_user (&attach,
+                                       (FusionReactorAttach*) arg, sizeof(attach)))
+                         return -EFAULT;
+               }
 
                return fusion_reactor_attach (dev, attach.reactor_id, attach.channel, fusion_id);
 
           case _IOC_NR(FUSION_REACTOR_DETACH):
-               if (copy_from_user (&detach,
-                                   (FusionReactorDetach*) arg, sizeof(detach)))
-                    return -EFAULT;
+               if (dev->api.major <= 4) {
+                    if (get_user (id, (int*) arg))
+                         return -EFAULT;
+
+                    detach.reactor_id = id;
+                    detach.channel    = 0;
+               }
+               else {
+                    if (copy_from_user (&detach,
+                                       (FusionReactorDetach*) arg, sizeof(detach)))
+                         return -EFAULT;
+               }
 
                return fusion_reactor_detach (dev, detach.reactor_id, detach.channel, fusion_id);
 
@@ -890,6 +911,9 @@ reactor_ioctl (FusionDev *dev, Fusionee *fusionee,
                if (dispatch.msg_size > 0x10000)
                     return -EMSGSIZE;
 
+               if (dev->api.major <= 4)
+                    dispatch.channel = 0;
+
                return fusion_reactor_dispatch (dev, dispatch.reactor_id, dispatch.channel,
                                                dispatch.self ? NULL : fusionee,
                                                dispatch.msg_size, dispatch.msg_data);
diff --git a/drivers/char/fusion/fusiondev.h b/drivers/char/fusion/fusiondev.h
index 20d6826..468ec6b 100644
--- a/drivers/char/fusion/fusiondev.h
+++ b/drivers/char/fusion/fusiondev.h
@@ -26,6 +26,10 @@
 struct __Fusion_FusionDev {
      int                    refs;
      int                    index;
+     struct {
+          int               major;
+          int               minor;
+     } api;
 
      struct semaphore       enter_lock;
      int                    enter_ok;
diff --git a/drivers/char/fusion/fusionee.c b/drivers/char/fusion/fusionee.c
index e79f33b..f8e361b 100644
--- a/drivers/char/fusion/fusionee.c
+++ b/drivers/char/fusion/fusionee.c
@@ -210,9 +210,6 @@ fusionee_enter( FusionDev   *dev,
                 FusionEnter *enter,
                 Fusionee    *fusionee )
 {
-     if (enter->api.major != FUSION_API_MAJOR || enter->api.minor > FUSION_API_MINOR)
-          return -ENOPROTOOPT;
-
      if (down_interruptible( &dev->enter_lock ))
           return -EINTR;
 
@@ -230,6 +227,20 @@ fusionee_enter( FusionDev   *dev,
           FUSION_ASSERT( dev->fusionee.last_id != 0 );
      }
 
+     if( dev->fusionee.last_id == 0 ) {
+          /* master determines Fusion API (if supported) */
+          int major = enter->api.major;
+          if( (major != 3) && (major != 4) && (major != 8) )
+               return -ENOPROTOOPT;
+
+          dev->api.major = enter->api.major;
+          dev->api.minor = enter->api.minor;
+     }
+     else {
+          if( (enter->api.major != dev->api.major) || (enter->api.minor > dev->api.minor) )
+               return -ENOPROTOOPT;
+     }
+
      fusionee->id = ++dev->fusionee.last_id;
 
      up( &dev->enter_lock );
diff --git a/include/linux/fusion.h b/include/linux/fusion.h
index 0052126..9081653 100644
--- a/include/linux/fusion.h
+++ b/include/linux/fusion.h
@@ -5,10 +5,16 @@
 
 /*
  * Fusion Kernel Device API Version
+ * Default behaviour: 3.3 -> DirectFB 1.0.x
  */
-#define FUSION_API_MAJOR      8         /* Increased if backward compatibility is dropped. */
-#define FUSION_API_MINOR      0         /* Increased if new features are added. */
-#define FUSION_API_MICRO      3         /* Micro release. Bugfixes. */
+#ifndef FUSION_API_MAJOR
+#undef FUSION_API_MAJOR
+#undef FUSION_API_MINOR
+#undef FUSION_API_MICRO
+#define FUSION_API_MAJOR      3
+#define FUSION_API_MINOR      3
+#define FUSION_API_MICRO      0
+#endif
 
 /*
  * The Fusion ID is a unique identifier for one process consisting of threads.
@@ -19,11 +25,13 @@ typedef unsigned long FusionID;
 
 /*
  * Entering a world
+ * API version (major/minor): master determines API of this world. slave has to follow.
+ * supported are API 3.x for DirectFB 1.0.x, API 4.x for DirectFB 1.1.x, and API 8.x for DirectFB 1.2.x and beyond.
  */
 typedef struct {
      struct {
-          int            major;         /* Must be set to FUSION_API_MAJOR before entering. */
-          int            minor;         /* Must be set to FUSION_API_MINOR before entering. */
+          int            major;
+          int            minor;
      } api;
 
      FusionID            fusion_id;     /* Returns the fusion id of the entering process. */
-- 
1.7.3.3

