From b9ed433797c8558c47e0acbace3912139fafee6e Mon Sep 17 00:00:00 2001
From: Denis Oliver Kropp <dok@directfb.org>
Date: Thu, 13 Feb 2003 19:14:15 +0000
Subject: [PATCH] Output total number of messages received by each fusionee in /proc.

---
 drivers/char/fusion/fusionee.c |   15 +++++++++++++--
 1 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/drivers/char/fusion/fusionee.c b/drivers/char/fusion/fusionee.c
index dc0dd87..47921e7 100644
--- a/drivers/char/fusion/fusionee.c
+++ b/drivers/char/fusion/fusionee.c
@@ -41,6 +41,8 @@ typedef struct {
 
   FusionFifo        messages;
 
+  int               msg_total;  /* Total number of messages received. */
+
   wait_queue_head_t wait;
 } Fusionee;
 
@@ -65,6 +67,7 @@ static void      unlock_fusionee (Fusionee *fusionee);
 static int         last_id        = 0;
 static FusionLink *fusionees      = NULL;
 static spinlock_t  fusionees_lock = SPIN_LOCK_UNLOCKED;
+static atomic_t    msg_total;
 
 /******************************************************************************/
 
@@ -81,8 +84,8 @@ fusionees_read_proc(char *buf, char **start, off_t offset,
     {
       Fusionee *fusionee = (Fusionee*) l;
 
-      written += sprintf(buf+written, "(%5d) 0x%08x (%3d messages waiting)\n",
-                         fusionee->pid, fusionee->id, fusionee->messages.count);
+      written += sprintf(buf+written, "(%5d) 0x%08x (%4d messages waiting, %4d messages total)\n",
+                         fusionee->pid, fusionee->id, fusionee->messages.count, fusionee->msg_total);
       if (written < offset)
         {
           offset -= written;
@@ -110,6 +113,8 @@ fusionees_read_proc(char *buf, char **start, off_t offset,
 int
 fusionee_init()
 {
+  atomic_set (&msg_total, 0);
+
   create_proc_read_entry("fusionees", 0, proc_fusion_dir,
                          fusionees_read_proc, NULL);
 
@@ -145,6 +150,8 @@ fusionee_reset()
   last_id   = 0;
   fusionees = NULL;
 
+  atomic_set (&msg_total, 0);
+
   spin_unlock (&fusionees_lock);
 }
 
@@ -225,6 +232,10 @@ fusionee_send_message (int id, FusionMessageType msg_type,
 
   fusion_fifo_put (&fusionee->messages, &message->link);
 
+  fusionee->msg_total++;
+
+  atomic_inc (&msg_total);
+
   wake_up_interruptible_all (&fusionee->wait);
 
   unlock_fusionee (fusionee);
-- 
1.7.3.3

