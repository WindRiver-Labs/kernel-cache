From 577218f85c7a93d79f53b518b2638908fe52d833 Mon Sep 17 00:00:00 2001
From: Denis Oliver Kropp <dok@shizo.zion.home>
Date: Tue, 14 Aug 2007 03:30:12 +0200
Subject: [PATCH] Align each on a 4 byte boundary if multiple messages are read at once.

---
 drivers/char/fusion/fusionee.c |   10 +++++++++-
 include/linux/fusion.h         |    2 +-
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/drivers/char/fusion/fusionee.c b/drivers/char/fusion/fusionee.c
index b4f1729..95707c3 100644
--- a/drivers/char/fusion/fusionee.c
+++ b/drivers/char/fusion/fusionee.c
@@ -385,7 +385,7 @@ fusionee_get_messages (FusionDev *dev,
      while (fusionee->messages.count) {
           FusionReadMessage  header;
           Message           *message = (Message*) fusionee->messages.first;
-          int                bytes   = message->size + sizeof(header);
+          int                bytes   = ((message->size + 3) & ~3) + sizeof(header);
 
           if (bytes > buf_size) {
                if (!written) {
@@ -409,6 +409,14 @@ fusionee_get_messages (FusionDev *dev,
                flush_messages( dev, &prev_msgs );
                return -EFAULT;
           }
+          
+          if (bytes > message->size + sizeof(header)) {
+               int pad = bytes - message->size - sizeof(header);
+               u8 *dst = buf + sizeof(header) + message->size;
+               
+               while (pad--)
+                    *dst++ = 0;
+          }
 
           written  += bytes;
           buf      += bytes;
diff --git a/include/linux/fusion.h b/include/linux/fusion.h
index d516f7a..88f7240 100644
--- a/include/linux/fusion.h
+++ b/include/linux/fusion.h
@@ -6,7 +6,7 @@
 /*
  * Fusion Kernel Device API Version
  */
-#define FUSION_API_MAJOR      6         /* Increased if backward compatibility is dropped. */
+#define FUSION_API_MAJOR      7         /* Increased if backward compatibility is dropped. */
 #define FUSION_API_MINOR      0         /* Increased if new features are added. */
 
 /*
-- 
1.7.3.3

