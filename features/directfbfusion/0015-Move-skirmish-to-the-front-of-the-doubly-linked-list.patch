From 3f342c13644672f27035a653c54234ae6d77198b Mon Sep 17 00:00:00 2001
From: Denis Oliver Kropp <dok@directfb.org>
Date: Mon, 13 Jan 2003 18:46:09 +0000
Subject: [PATCH] Move skirmish to the front of the doubly linked list each time it is locked. This nearly doubled the frame rate of ClanBomber2 on multi app core on my system.

---
 drivers/char/fusion/list.c     |   19 +++++++++++++++++++
 drivers/char/fusion/list.h     |    5 +++--
 drivers/char/fusion/skirmish.c |    2 ++
 3 files changed, 24 insertions(+), 2 deletions(-)

diff --git a/drivers/char/fusion/list.c b/drivers/char/fusion/list.c
index eef687e..9dd0380 100644
--- a/drivers/char/fusion/list.c
+++ b/drivers/char/fusion/list.c
@@ -41,3 +41,22 @@ fusion_list_remove (FusionLink **list, FusionLink *link)
 
      link->next = link->prev = NULL;
 }
+
+void
+fusion_list_move_to_front (FusionLink **list, FusionLink *link)
+{
+  if (*list == link)
+    return;
+
+  link->prev->next = link->next;
+
+  if (link->next)
+    link->next->prev = link->prev;
+
+  link->prev = NULL;
+  link->next = *list;
+
+  (*list)->prev = link;
+
+  *list = link;
+}
diff --git a/drivers/char/fusion/list.h b/drivers/char/fusion/list.h
index e9cf0bb..1e5bb58 100644
--- a/drivers/char/fusion/list.h
+++ b/drivers/char/fusion/list.h
@@ -23,8 +23,9 @@ typedef struct _FusionLink {
   struct _FusionLink *prev;
 } FusionLink;
 
-void fusion_list_prepend (FusionLink **list, FusionLink *link);
-void fusion_list_remove  (FusionLink **list, FusionLink *link);
+void fusion_list_prepend       (FusionLink **list, FusionLink *link);
+void fusion_list_remove        (FusionLink **list, FusionLink *link);
+void fusion_list_move_to_front (FusionLink **list, FusionLink *link);
 
 #define fusion_list_foreach(link, list)  for (link = list; link; link = link->next)
 
diff --git a/drivers/char/fusion/skirmish.c b/drivers/char/fusion/skirmish.c
index a44d265..d88bfef 100644
--- a/drivers/char/fusion/skirmish.c
+++ b/drivers/char/fusion/skirmish.c
@@ -340,6 +340,8 @@ lock_skirmish (int id)
 {
   FusionSkirmish *skirmish = lookup_skirmish (id);
 
+  fusion_list_move_to_front (&skirmishs, &skirmish->link);
+
   if (skirmish)
     {
       spin_lock (&skirmish->lock);
-- 
1.7.3.3

