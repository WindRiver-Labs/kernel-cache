From f488ce5bc3c45fa5769c643165205c6671f04740 Mon Sep 17 00:00:00 2001
From: Denis Oliver Kropp <dok@directfb.org>
Date: Fri, 28 Feb 2003 19:45:34 +0000
Subject: [PATCH] Ouput total messages sent and received.

---
 drivers/char/fusion/fusiondev.c |    2 +-
 drivers/char/fusion/fusionee.c  |   26 ++++++++++++++++++++------
 drivers/char/fusion/fusionee.h  |    2 +-
 drivers/char/fusion/reactor.c   |    2 +-
 4 files changed, 23 insertions(+), 9 deletions(-)

diff --git a/drivers/char/fusion/fusiondev.c b/drivers/char/fusion/fusiondev.c
index 10c128c..f5879ae 100644
--- a/drivers/char/fusion/fusiondev.c
+++ b/drivers/char/fusion/fusiondev.c
@@ -146,7 +146,7 @@ fusion_ioctl (struct inode *inode, struct file *file,
       if (send.msg_size > 0x10000)
         return -EMSGSIZE;
 
-      return fusionee_send_message (send.fusion_id, FMT_SEND, send.msg_id,
+      return fusionee_send_message (fusion_id, send.fusion_id, FMT_SEND, send.msg_id,
                                     send.msg_size, send.msg_data);
 
 
diff --git a/drivers/char/fusion/fusionee.c b/drivers/char/fusion/fusionee.c
index 47921e7..5a08b76 100644
--- a/drivers/char/fusion/fusionee.c
+++ b/drivers/char/fusion/fusionee.c
@@ -41,7 +41,8 @@ typedef struct {
 
   FusionFifo        messages;
 
-  int               msg_total;  /* Total number of messages received. */
+  int               rcv_total;  /* Total number of messages received. */
+  int               snd_total;  /* Total number of messages sent. */
 
   wait_queue_head_t wait;
 } Fusionee;
@@ -84,8 +85,8 @@ fusionees_read_proc(char *buf, char **start, off_t offset,
     {
       Fusionee *fusionee = (Fusionee*) l;
 
-      written += sprintf(buf+written, "(%5d) 0x%08x (%4d messages waiting, %4d messages total)\n",
-                         fusionee->pid, fusionee->id, fusionee->messages.count, fusionee->msg_total);
+      written += sprintf(buf+written, "(%5d) 0x%08x (%4d messages waiting, %5d received, %5d sent)\n",
+                         fusionee->pid, fusionee->id, fusionee->messages.count, fusionee->rcv_total, fusionee->snd_total);
       if (written < offset)
         {
           offset -= written;
@@ -194,18 +195,27 @@ fusionee_new (int *id)
 }
 
 int
-fusionee_send_message (int id, FusionMessageType msg_type,
+fusionee_send_message (int id, int recipient, FusionMessageType msg_type,
                        int msg_id, int msg_size, const void *msg_data)
 {
   Message  *message;
-  Fusionee *fusionee = lock_fusionee (id);
+  Fusionee *sender;
+  Fusionee *fusionee = lock_fusionee (recipient);
 
   if (!fusionee)
     return -EINVAL;
 
+  sender = lock_fusionee (id);
+  if (!sender)
+    {
+      unlock_fusionee (fusionee);
+      return -EIO;
+    }
+
   message = kmalloc (sizeof(Message), GFP_KERNEL);
   if (!message)
     {
+      unlock_fusionee (sender);
       unlock_fusionee (fusionee);
       return -ENOMEM;
     }
@@ -214,6 +224,7 @@ fusionee_send_message (int id, FusionMessageType msg_type,
   if (!message->data)
     {
       kfree (message);
+      unlock_fusionee (sender);
       unlock_fusionee (fusionee);
       return -ENOMEM;
     }
@@ -222,6 +233,7 @@ fusionee_send_message (int id, FusionMessageType msg_type,
     {
       kfree (message->data);
       kfree (message);
+      unlock_fusionee (sender);
       unlock_fusionee (fusionee);
       return -EFAULT;
     }
@@ -232,12 +244,14 @@ fusionee_send_message (int id, FusionMessageType msg_type,
 
   fusion_fifo_put (&fusionee->messages, &message->link);
 
-  fusionee->msg_total++;
+  fusionee->rcv_total++;
+  sender->snd_total++;
 
   atomic_inc (&msg_total);
 
   wake_up_interruptible_all (&fusionee->wait);
 
+  unlock_fusionee (sender);
   unlock_fusionee (fusionee);
 
   return 0;
diff --git a/drivers/char/fusion/fusionee.h b/drivers/char/fusion/fusionee.h
index 33a6c56..f709313 100644
--- a/drivers/char/fusion/fusionee.h
+++ b/drivers/char/fusion/fusionee.h
@@ -32,7 +32,7 @@ void fusionee_cleanup (void);
 
 int fusionee_new (int *id);
 
-int fusionee_send_message (int id, FusionMessageType msg_type,
+int fusionee_send_message (int id, int recipient, FusionMessageType msg_type,
                            int msg_id, int msg_size, const void *msg_data);
 
 int fusionee_get_messages (int id, void *buf, int buf_size, int block);
diff --git a/drivers/char/fusion/reactor.c b/drivers/char/fusion/reactor.c
index 2f2e48f..3b5955c 100644
--- a/drivers/char/fusion/reactor.c
+++ b/drivers/char/fusion/reactor.c
@@ -252,7 +252,7 @@ fusion_reactor_dispatch (int id, int fusion_id,
       if (node->fusion_id == fusion_id)
         continue;
 
-      fusionee_send_message (node->fusion_id, FMT_REACTOR,
+      fusionee_send_message (fusion_id, node->fusion_id, FMT_REACTOR,
                              reactor->id, msg_size, msg_data);
     }
 
-- 
1.7.3.3

