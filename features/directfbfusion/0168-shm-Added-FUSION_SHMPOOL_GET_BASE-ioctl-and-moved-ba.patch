From 516edb26353e17be86c281466669d2456202ffe8 Mon Sep 17 00:00:00 2001
From: Denis Oliver Kropp <dok@directfb.org>
Date: Wed, 3 Nov 2010 18:10:25 +0100
Subject: [PATCH] shm: Added FUSION_SHMPOOL_GET_BASE ioctl and moved bases to start of window.

---
 drivers/char/fusion/fusiondev.c |    6 ++++++
 drivers/char/fusion/shmpool.c   |    4 ++--
 drivers/char/fusion/shmpool.h   |   12 ++++++------
 include/linux/fusion.h          |    3 ++-
 4 files changed, 16 insertions(+), 9 deletions(-)

diff --git a/drivers/char/fusion/fusiondev.c b/drivers/char/fusion/fusiondev.c
index 2457bc1..a26d302 100644
--- a/drivers/char/fusion/fusiondev.c
+++ b/drivers/char/fusion/fusiondev.c
@@ -1024,6 +1024,12 @@ shmpool_ioctl(FusionDev * dev, Fusionee * fusionee,
 			return -EFAULT;
 
 		return fusion_shmpool_destroy(dev, id);
+
+	case _IOC_NR(FUSION_SHMPOOL_GET_BASE):
+		if (put_user((unsigned long)FUSION_SHM_BASE, (unsigned long *)arg))
+			return -EFAULT;
+
+		return 0;
 	}
 
 	return -ENOSYS;
diff --git a/drivers/char/fusion/shmpool.c b/drivers/char/fusion/shmpool.c
index 9954edc..5884fec 100644
--- a/drivers/char/fusion/shmpool.c
+++ b/drivers/char/fusion/shmpool.c
@@ -73,7 +73,7 @@ static void free_all_nodes(FusionSHMPool * shmpool);
 
 static DECLARE_MUTEX(addr_lock);
 static FusionLink *addr_entries;
-static void *addr_base = FUSION_SHM_BASE;
+static void *addr_base = FUSION_SHM_BASE + 0x80000;
 
 /******************************************************************************/
 
@@ -134,7 +134,7 @@ static void fusion_shmpool_destruct(FusionEntry * entry, void *ctx)
 	 * free trailing address space
 	 */
 
-	addr_base = FUSION_SHM_BASE;
+	addr_base = FUSION_SHM_BASE + 0x80000;
 
 	fusion_list_foreach(addr_entry, addr_entries) {
 		if (addr_entry->next_base > addr_base)
diff --git a/drivers/char/fusion/shmpool.h b/drivers/char/fusion/shmpool.h
index 8feebeb..f159b10 100644
--- a/drivers/char/fusion/shmpool.h
+++ b/drivers/char/fusion/shmpool.h
@@ -19,16 +19,16 @@
 #include "types.h"
 
 #if defined(__mips__)
-#define FUSION_SHM_BASE_32	0x50010000	/* virtual base address */
+#define FUSION_SHM_BASE_32	0x50000000	/* virtual base address */
 #elif defined(CONFIG_CPU_SH4)
-#define FUSION_SHM_BASE_32	0x30010000	/* virtual base address */
+#define FUSION_SHM_BASE_32	0x30000000	/* virtual base address */
 #else
-#define FUSION_SHM_BASE_32	0x20010000	/* virtual base address */
+#define FUSION_SHM_BASE_32	0x20000000	/* virtual base address */
 #endif
-#define FUSION_SHM_SIZE_32	0x1FFEF000	/* size of virtual address space */
+#define FUSION_SHM_SIZE_32	0x20000000	/* size of virtual address space */
 
-#define FUSION_SHM_BASE_64	0x523000010000LL	/* virtual base address */
-#define FUSION_SHM_SIZE_64	0x000FFFFEF000LL	/* size of virtual address space */
+#define FUSION_SHM_BASE_64	0x523000000000LL	/* virtual base address */
+#define FUSION_SHM_SIZE_64	0x001000000000LL	/* size of virtual address space */
 
 #define FUSION_SHM_BASE ((void*)(sizeof(void*)==4 ? (FUSION_SHM_BASE_32) : (FUSION_SHM_BASE_64)))
 #define FUSION_SHM_SIZE (sizeof(void*)==4 ? (FUSION_SHM_SIZE_32) : (FUSION_SHM_SIZE_64))
diff --git a/include/linux/fusion.h b/include/linux/fusion.h
index 18437dc..d9b9bb5 100644
--- a/include/linux/fusion.h
+++ b/include/linux/fusion.h
@@ -19,7 +19,7 @@
 
 /* Fusion supports all API versions up to this version */
 #define FUSION_API_MAJOR_PROVIDED 8
-#define FUSION_API_MINOR_PROVIDED 1
+#define FUSION_API_MINOR_PROVIDED 2
 #define FUSION_API_MICRO_PROVIDED 0
 
 /*
@@ -346,5 +346,6 @@ typedef struct {
 #define FUSION_SHMPOOL_DETACH                _IOW(FT_SHMPOOL,   0x02, int)
 #define FUSION_SHMPOOL_DISPATCH              _IOW(FT_SHMPOOL,   0x03, FusionSHMPoolDispatch)
 #define FUSION_SHMPOOL_DESTROY               _IOW(FT_SHMPOOL,   0x04, int)
+#define FUSION_SHMPOOL_GET_BASE              _IOR(FT_SHMPOOL,   0x05, unsigned long)
 
 #endif
-- 
1.7.3.3

