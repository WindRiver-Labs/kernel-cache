From fa5e6e27f325ccb56a56045dd9a1f02955ebeb83 Mon Sep 17 00:00:00 2001
From: Denis Oliver Kropp <dok@directfb.org>
Date: Wed, 1 Mar 2006 00:47:21 +0000
Subject: [PATCH] Show callers and number of waiters in proc.

---
 drivers/char/fusion/call.c     |   12 ++++++++++--
 drivers/char/fusion/skirmish.c |   12 +++++++++---
 2 files changed, 19 insertions(+), 5 deletions(-)

diff --git a/drivers/char/fusion/call.c b/drivers/char/fusion/call.c
index 99fc9d0..b2c0c9a 100644
--- a/drivers/char/fusion/call.c
+++ b/drivers/char/fusion/call.c
@@ -76,7 +76,7 @@ static int
 fusion_call_read_proc (char *buf, char **start, off_t offset,
                        int len, int *eof, void *private)
 {
-     FusionLink *l;
+     FusionLink *l, *e;
      FusionDev  *dev     = private;
      int         written = 0;
 
@@ -91,10 +91,18 @@ fusion_call_read_proc (char *buf, char **start, off_t offset,
                idle = ((FusionCallExecution*) call->executions)->executed;
 
           written += sprintf(buf+written,
-                             "(%5d) 0x%08x (%d calls) %s\n",
+                             "(%5d) 0x%08x (%d calls) %s",
                              call->pid, call->id, call->count,
                              idle ? "idle" : "executing");
 
+          fusion_list_foreach (e, call->executions) {
+               FusionCallExecution *exec = (FusionCallExecution *) e;
+
+               written += sprintf(buf+written, "  [0x%08x]", exec->caller);
+          }
+
+          written += sprintf(buf+written, "\n");
+
           if (written < offset) {
                offset -= written;
                written = 0;
diff --git a/drivers/char/fusion/skirmish.c b/drivers/char/fusion/skirmish.c
index 95bf350..5d4117c 100644
--- a/drivers/char/fusion/skirmish.c
+++ b/drivers/char/fusion/skirmish.c
@@ -47,9 +47,15 @@ fusion_skirmish_print( FusionEntry *entry,
 
      written = sprintf( buf, "%6dx total", skirmish->lock_total );
 
-     if (skirmish->lock_fid)
-          return sprintf( buf + written, ", now %dx by 0x%08x (%d)\n",
-                          skirmish->lock_count, skirmish->lock_fid, skirmish->lock_pid) + written;
+     if (skirmish->lock_fid) {
+          if (skirmish->entry.waiters)
+               return sprintf( buf + written, ", %dx [0x%08x] (%d)  %d WAITING\n",
+                               skirmish->lock_count, skirmish->lock_fid, skirmish->lock_pid,
+                               skirmish->entry.waiters ) + written;
+          else
+               return sprintf( buf + written, ", %dx [0x%08x] (%d)\n",
+                               skirmish->lock_count, skirmish->lock_fid, skirmish->lock_pid ) + written;
+     }
 
      return sprintf( buf + written, "\n" ) + written;
 }
-- 
1.7.3.3

