From 8df8b7046bad15ca2cb34755cdad533ffdcb7edf Mon Sep 17 00:00:00 2001
From: Denis Oliver Kropp <dok@directfb.org>
Date: Tue, 17 Aug 2004 20:00:32 +0000
Subject: [PATCH] Simplified timeout code.

Added recursive purchase and some more error checking.
---
 drivers/char/fusion/property.c |   75 +++++++++++++++++++++-------------------
 1 files changed, 39 insertions(+), 36 deletions(-)

diff --git a/drivers/char/fusion/property.c b/drivers/char/fusion/property.c
index d21781d..40b2538 100644
--- a/drivers/char/fusion/property.c
+++ b/drivers/char/fusion/property.c
@@ -164,26 +164,24 @@ fusion_property_lease( FusionDev *dev, int id, int fusion_id )
                     break;
 
                case FUSION_PROPERTY_PURCHASED:
-                    switch (timeout) {
-                         case -1:
-                              if (jiffies - property->purchase_stamp > HZ / 10) {
-                         case 0:
-                                   fusion_property_unlock( property );
-                                   return -EAGAIN;
-                              }
-                              else
-                                   timeout = HZ / 10;
-
-                              /* fall through */
-
-                         default:
-                              ret = fusion_property_wait( property, &timeout );
-                              if (ret)
-                                   return ret;
-
-                              break;
+                    if (property->lock_pid == current->pid) {
+                         fusion_property_unlock( property );
+                         return -EIO;
+                    }
+
+                    if (timeout == -1) {
+                         if (jiffies - property->purchase_stamp > HZ / 10) {
+                              fusion_property_unlock( property );
+                              return -EAGAIN;
+                         }
+
+                         timeout = HZ / 10;
                     }
 
+                    ret = fusion_property_wait( property, &timeout );
+                    if (ret)
+                         return ret;
+
                     break;
 
                default:
@@ -225,6 +223,11 @@ fusion_property_purchase( FusionDev *dev, int id, int fusion_id )
                     return 0;
 
                case FUSION_PROPERTY_LEASED:
+                    if (property->lock_pid == current->pid) {
+                         fusion_property_unlock( property );
+                         return -EIO;
+                    }
+
                     ret = fusion_property_wait( property, NULL );
                     if (ret)
                          return ret;
@@ -232,26 +235,26 @@ fusion_property_purchase( FusionDev *dev, int id, int fusion_id )
                     break;
 
                case FUSION_PROPERTY_PURCHASED:
-                    switch (timeout) {
-                         case -1:
-                              if (jiffies - property->purchase_stamp > HZ) {
-                         case 0:
-                                   fusion_property_unlock( property );
-                                   return -EAGAIN;
-                              }
-                              else
-                                   timeout = HZ;
-
-                              /* fall through */
-
-                         default:
-                              ret = fusion_property_wait( property, &timeout );
-                              if (ret)
-                                   return ret;
-
-                              break;
+                    if (property->lock_pid == current->pid) {
+                         property->count++;
+
+                         fusion_property_unlock( property );
+                         return 0;
                     }
 
+                    if (timeout == -1) {
+                         if (jiffies - property->purchase_stamp > HZ) {
+                              fusion_property_unlock( property );
+                              return -EAGAIN;
+                         }
+
+                         timeout = HZ;
+                    }
+
+                    ret = fusion_property_wait( property, &timeout );
+                    if (ret)
+                         return ret;
+
                     break;
 
                default:
-- 
1.7.3.3

