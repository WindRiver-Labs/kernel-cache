From 23b964f618d38e8b8a4bc0e50d5c707d4166a061 Mon Sep 17 00:00:00 2001
From: Denis Oliver Kropp <dok@directfb.org>
Date: Mon, 7 Feb 2011 14:25:11 +0100
Subject: [PATCH] mutex: Change to sema_init etc.

---
 drivers/char/fusion/entries.c   |    4 ++--
 drivers/char/fusion/fusiondev.c |    4 ++--
 drivers/char/fusion/fusionee.c  |    4 ++--
 drivers/char/fusion/shmpool.c   |    2 +-
 4 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/drivers/char/fusion/entries.c b/drivers/char/fusion/entries.c
index 11edd43..2a93db6 100644
--- a/drivers/char/fusion/entries.c
+++ b/drivers/char/fusion/entries.c
@@ -43,7 +43,7 @@ fusion_entries_init(FusionEntries * entries,
 	entries->class = class;
 	entries->ctx = ctx;
 
-	init_MUTEX(&entries->lock);
+	sema_init(&entries->lock, 1);
 }
 
 void fusion_entries_deinit(FusionEntries * entries)
@@ -225,7 +225,7 @@ int fusion_entry_create(FusionEntries * entries, int *ret_id, void *create_ctx)
 	entry->id = ++entries->ids;
 	entry->pid = current->pid;
 
-	init_MUTEX(&entry->lock);
+	sema_init(&entry->lock, 1);
 
 	init_waitqueue_head(&entry->wait);
 
diff --git a/drivers/char/fusion/fusiondev.c b/drivers/char/fusion/fusiondev.c
index a26d302..a29bdbc 100644
--- a/drivers/char/fusion/fusiondev.c
+++ b/drivers/char/fusion/fusiondev.c
@@ -71,7 +71,7 @@ static int fusion_major = FUSION_MAJOR;
 #define NUM_MINORS 8
 
 static FusionDev *fusion_devs[NUM_MINORS] = { 0 };
-static DECLARE_MUTEX(devs_lock);
+static struct semaphore devs_lock = __SEMAPHORE_INITIALIZER(devs_lock, 1);
 
 #if LINUX_VERSION_CODE < KERNEL_VERSION(2, 6, 0)
 static devfs_handle_t devfs_handles[NUM_MINORS];
@@ -194,7 +194,7 @@ static int fusiondev_init(FusionDev * dev)
 {
 	int ret;
 
-	init_MUTEX(&dev->enter_lock);
+	sema_init(&dev->enter_lock, 1);
 	init_waitqueue_head(&dev->enter_wait);
 
 	ret = fusionee_init(dev);
diff --git a/drivers/char/fusion/fusionee.c b/drivers/char/fusion/fusionee.c
index d187853..0271fca 100644
--- a/drivers/char/fusion/fusionee.c
+++ b/drivers/char/fusion/fusionee.c
@@ -114,7 +114,7 @@ int fusionee_init(FusionDev * dev)
 {
 	init_waitqueue_head(&dev->fusionee.wait);
 
-	init_MUTEX(&dev->fusionee.lock);
+	sema_init(&dev->fusionee.lock, 1);
 
 	create_proc_read_entry("fusionees", 0, dev->proc_dir,
 			       fusionees_read_proc, dev);
@@ -171,7 +171,7 @@ int fusionee_new(FusionDev * dev, bool force_slave, Fusionee ** ret_fusionee)
 	fusionee->force_slave = force_slave;
 	fusionee->mm = current->mm;
 
-	init_MUTEX(&fusionee->lock);
+	sema_init(&fusionee->lock, 1);
 
 	init_waitqueue_head(&fusionee->wait_receive);
 	init_waitqueue_head(&fusionee->wait_process);
diff --git a/drivers/char/fusion/shmpool.c b/drivers/char/fusion/shmpool.c
index 5884fec..cb18145 100644
--- a/drivers/char/fusion/shmpool.c
+++ b/drivers/char/fusion/shmpool.c
@@ -71,7 +71,7 @@ static void free_all_nodes(FusionSHMPool * shmpool);
 
 /******************************************************************************/
 
-static DECLARE_MUTEX(addr_lock);
+static struct semaphore addr_lock = __SEMAPHORE_INITIALIZER(addr_lock, 1);
 static FusionLink *addr_entries;
 static void *addr_base = FUSION_SHM_BASE + 0x80000;
 
-- 
1.7.3.3

