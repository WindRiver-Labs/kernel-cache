From 6ba4417231de5904882ca98c0e74471a34c0e879 Mon Sep 17 00:00:00 2001
From: Niels Roest <niels@directfb.org>
Date: Tue, 31 Mar 2009 12:22:39 +0200
Subject: [PATCH] 32-bit changes; changed address from ulong to pointer

---
 drivers/char/fusion/reactor.c |    4 ++--
 drivers/char/fusion/shmpool.c |   13 ++++++-------
 drivers/char/fusion/shmpool.h |    6 +++---
 3 files changed, 11 insertions(+), 12 deletions(-)

diff --git a/drivers/char/fusion/reactor.c b/drivers/char/fusion/reactor.c
index fe40cd9..35f3943 100644
--- a/drivers/char/fusion/reactor.c
+++ b/drivers/char/fusion/reactor.c
@@ -332,8 +332,8 @@ fusion_reactor_dispatch(FusionDev * dev, int id, int channel,
 		dispatch->call_arg = channel;
 
 		if (!reactor->call_ptr && msg_size == sizeof(ptr) &&
-		    (unsigned long)ptr >= FUSION_SHM_BASE &&
-		    (unsigned long)ptr < (FUSION_SHM_BASE + FUSION_SHM_SIZE))
+		    ptr >= FUSION_SHM_BASE &&
+		    ptr < (FUSION_SHM_BASE + FUSION_SHM_SIZE))
 			dispatch->call_ptr = ptr;
 		else
 			dispatch->call_ptr = reactor->call_ptr;
diff --git a/drivers/char/fusion/shmpool.c b/drivers/char/fusion/shmpool.c
index af63d14..9954edc 100644
--- a/drivers/char/fusion/shmpool.c
+++ b/drivers/char/fusion/shmpool.c
@@ -32,7 +32,7 @@
 
 typedef struct {
 	FusionLink link;
-	unsigned long next_base;
+	void *next_base;
 } AddrEntry;
 
 typedef struct {
@@ -73,11 +73,11 @@ static void free_all_nodes(FusionSHMPool * shmpool);
 
 static DECLARE_MUTEX(addr_lock);
 static FusionLink *addr_entries;
-static unsigned long addr_base = FUSION_SHM_BASE;
+static void *addr_base = FUSION_SHM_BASE;
 
 /******************************************************************************/
 
-static AddrEntry *add_addr_entry(unsigned long next_base)
+static AddrEntry *add_addr_entry(void *next_base)
 {
 	AddrEntry *entry = kmalloc(sizeof(AddrEntry), GFP_KERNEL);
 
@@ -107,11 +107,10 @@ fusion_shmpool_construct(FusionEntry * entry, void *ctx, void *create_ctx)
 	}
 
 	shmpool->max_size = poolnew->max_size;
-	shmpool->addr_base = poolnew->addr_base = (void *)addr_base;
+	shmpool->addr_base = poolnew->addr_base = addr_base;
 
-	addr_base =
-	    (addr_base + PAGE_ALIGN(poolnew->max_size) + PAGE_SIZE +
-	     0xffff) & ~0xffff;
+	addr_base += PAGE_ALIGN(poolnew->max_size) + PAGE_SIZE;
+	addr_base = (void*)((unsigned long)(addr_base + 0xffff) & ~0xffff);
 
 	shmpool->addr_entry = add_addr_entry(addr_base);
 
diff --git a/drivers/char/fusion/shmpool.h b/drivers/char/fusion/shmpool.h
index 46977ce..4f10d58 100644
--- a/drivers/char/fusion/shmpool.h
+++ b/drivers/char/fusion/shmpool.h
@@ -25,10 +25,10 @@
 #endif
 #define FUSION_SHM_SIZE_32	0x1FFEF000	/* size of virtual address space */
 
-#define FUSION_SHM_BASE_64	0x523000010000	/* virtual base address */
-#define FUSION_SHM_SIZE_64	0x000FFFFEF000	/* size of virtual address space */
+#define FUSION_SHM_BASE_64	0x523000010000LL	/* virtual base address */
+#define FUSION_SHM_SIZE_64	0x000FFFFEF000LL	/* size of virtual address space */
 
-#define FUSION_SHM_BASE (sizeof(void*)==4 ? (FUSION_SHM_BASE_32) : (FUSION_SHM_BASE_64))
+#define FUSION_SHM_BASE ((void*)(sizeof(void*)==4 ? (FUSION_SHM_BASE_32) : (FUSION_SHM_BASE_64)))
 #define FUSION_SHM_SIZE (sizeof(void*)==4 ? (FUSION_SHM_SIZE_32) : (FUSION_SHM_SIZE_64))
 
 /* module init/cleanup */
-- 
1.7.3.3

