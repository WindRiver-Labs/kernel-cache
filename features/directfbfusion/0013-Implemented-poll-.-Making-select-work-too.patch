From c8866f6c65c9da1a5719bcc6224e510a670964a1 Mon Sep 17 00:00:00 2001
From: Denis Oliver Kropp <dok@directfb.org>
Date: Thu, 5 Dec 2002 17:36:08 +0000
Subject: [PATCH] Implemented poll(). Making select() work, too.

---
 drivers/char/fusion/fusiondev.c |   10 ++++++++++
 drivers/char/fusion/fusionee.c  |   31 +++++++++++++++++++++++++++++++
 drivers/char/fusion/fusionee.h  |    3 +++
 3 files changed, 44 insertions(+), 0 deletions(-)

diff --git a/drivers/char/fusion/fusiondev.c b/drivers/char/fusion/fusiondev.c
index 2a5ce50..9f2e21c 100644
--- a/drivers/char/fusion/fusiondev.c
+++ b/drivers/char/fusion/fusiondev.c
@@ -20,6 +20,7 @@
 #include <linux/slab.h>
 #include <linux/miscdevice.h>
 #include <linux/proc_fs.h>
+#include <linux/poll.h>
 #include <linux/init.h>
 #include <asm/uaccess.h>
 
@@ -107,6 +108,14 @@ fusion_read (struct file *file, char *buf, size_t count, loff_t *ppos)
                                 !(file->f_flags & O_NONBLOCK));
 }
 
+static unsigned int
+fusion_poll (struct file *file, poll_table * wait)
+{
+  int fusion_id = (int) file->private_data;
+
+  return fusionee_poll (fusion_id, file, wait);
+}
+
 static int
 fusion_ioctl (struct inode *inode, struct file *file,
               unsigned int cmd, unsigned long arg)
@@ -345,6 +354,7 @@ static struct file_operations fusion_fops = {
   .open    = fusion_open,
   .release = fusion_release,
   .read    = fusion_read,
+  .poll    = fusion_poll,
   .ioctl   = fusion_ioctl
 };
 
diff --git a/drivers/char/fusion/fusionee.c b/drivers/char/fusion/fusionee.c
index 2b8ca56..b7a0eca 100644
--- a/drivers/char/fusion/fusionee.c
+++ b/drivers/char/fusion/fusionee.c
@@ -303,6 +303,37 @@ fusionee_get_messages (int id, void *buf, int buf_size, int block)
   return written;
 }
 
+unsigned int
+fusionee_poll (int id, struct file *file, poll_table * wait)
+{
+  Fusionee *fusionee = lock_fusionee (id);
+
+  if (!fusionee)
+    return -EINVAL;
+
+  unlock_fusionee (fusionee);
+
+
+  poll_wait (file, &fusionee->wait, wait);
+
+  
+  fusionee = lock_fusionee (id);
+
+  if (!fusionee)
+    return -EINVAL;
+
+  if (fusionee->messages.count)
+    {
+      unlock_fusionee (fusionee);
+
+      return POLLIN | POLLRDNORM;
+    }
+
+  unlock_fusionee (fusionee);
+
+  return 0;
+}
+
 int
 fusionee_destroy (int id)
 {
diff --git a/drivers/char/fusion/fusionee.h b/drivers/char/fusion/fusionee.h
index f1f28b0..44932b6 100644
--- a/drivers/char/fusion/fusionee.h
+++ b/drivers/char/fusion/fusionee.h
@@ -15,6 +15,7 @@
 #ifndef __FUSIONEE_H__
 #define __FUSIONEE_H__
 
+#include <linux/poll.h>
 #include <linux/fusion.h>
 
 #include "types.h"
@@ -36,6 +37,8 @@ int fusionee_send_message (int id, FusionMessageType msg_type,
 
 int fusionee_get_messages (int id, void *buf, int buf_size, int block);
 
+unsigned int fusionee_poll (int id, struct file *file, poll_table * wait);
+
 int fusionee_destroy (int id);
 
 #endif
-- 
1.7.3.3

