From 46aab5d24082162d98da03d5bd2b8e5ef98e3f4b Mon Sep 17 00:00:00 2001
From: Niels Roest <niels@directfb.org>
Date: Tue, 13 Jan 2009 18:57:02 +0100
Subject: [PATCH] fixes forever-wait in ioctl shutdown + small fix for interrupted shutdown

---
 drivers/char/fusion/call.c     |    4 +++-
 drivers/char/fusion/fusionee.c |    4 ++++
 2 files changed, 7 insertions(+), 1 deletions(-)

diff --git a/drivers/char/fusion/call.c b/drivers/char/fusion/call.c
index b2376cd..c3d16af 100644
--- a/drivers/char/fusion/call.c
+++ b/drivers/char/fusion/call.c
@@ -361,7 +361,9 @@ fusion_call_destroy (FusionDev *dev, int fusion_id, int call_id)
 
      do {
           /* Wait for all messages being processed. */
-          fusionee_wait_processing( dev, fusion_id, FMT_CALL, call_id );
+          ret = fusionee_wait_processing( dev, fusion_id, FMT_CALL, call_id );
+          if (ret)
+               return ret;
 
           /* Lookup call only, list still locked. */
           ret = lookup_call( dev, call_id, &call );
diff --git a/drivers/char/fusion/fusionee.c b/drivers/char/fusion/fusionee.c
index 7e91306..780b874 100644
--- a/drivers/char/fusion/fusionee.c
+++ b/drivers/char/fusion/fusionee.c
@@ -521,6 +521,10 @@ fusionee_poll (FusionDev   *dev,
 
      fusion_fifo_reset( &fusionee->prev_msgs );
 
+     /* if we have previous messages, fusionee_wait_processing() can be waiting */
+     if (prev_msgs.count)
+          wake_up_interruptible_all (&fusionee->wait);
+
      unlock_fusionee (fusionee);
 
      flush_messages( dev, &prev_msgs );
-- 
1.7.3.3

