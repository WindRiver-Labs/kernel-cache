From f1cbaa950fb255a583100fa9a6e68732435a2048 Mon Sep 17 00:00:00 2001
From: Wei Yang <Wei.Yang@windriver.com>
Date: Sat, 2 Feb 2013 10:19:24 +0800
Subject: [PATCH] ppc64/exception-64e: R14 and R15 are saved falsely in DSI
 exception

storage_fault_common corrupts r14 which leads to kernel crash like the following:

 Unable to handle kernel paging request for data at address 0xfffafa3f000
 Faulting instruction address: 0xc0000000000f0bf8
 Oops: Kernel access of bad area, sig: 11 [#1]
 PREEMPT SMP NR_CPUS=2 LTT NESTING LEVEL : 0
 P5020 DS
 Modules linked in: NIP: c0000000000f0bf8 LR: c0000000000f0cc8 CTR: 0000000000000001
 REGS: c0000000f9c4f490 TRAP: 0300   Not tainted  (2.6.34.10-grsec-WR4.3.0.0_cgl)
 MSR: 0000000080029000 <EE,ME,CE>  CR: 28004444  XER: 20000000
 DEAR: 00000fffafa3f000, ESR: 0000000000800000
 TASK = c0000000f927f440[901] 'writev01' THREAD: c0000000f9c4c000 CPU: 1
 Call Trace:
 [c0000000f9c4f710] [c0000000000f0cc8] .generic_file_buffered_write+0x368/0x370 (unreliable)
 [c0000000f9c4f850] [c0000000000f34a8] .__generic_file_aio_write+0x2a8/0x420
 [c0000000f9c4f960] [c0000000000f36cc] .generic_file_aio_write+0xac/0x150
 [c0000000f9c4fa10] [c00000000026b484] .nfs_file_write+0x114/0x2b0
 [c0000000f9c4fac0] [c0000000001395dc] .do_sync_readv_writev+0xbc/0x150
 [c0000000f9c4fc30] [c000000000139f24] .do_readv_writev+0xc4/0x240
 [c0000000f9c4fd70] [c00000000013a250] .SyS_writev+0x70/0x170
 [c0000000f9c4fe30] [c0000000000005a4] syscall_exit+0x0/0x2c

 To fix this corruption, we move the branch to save_nvgprs later
 in storage_fault_common to avoid save_nvgprs corrupts r14.

Signed-off-by: Yongli He <yongli.he@windriver.com>
---
 arch/powerpc/kernel/exceptions-64e.S |    4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/kernel/exceptions-64e.S b/arch/powerpc/kernel/exceptions-64e.S
index 911b6e1..37e91ad 100644
--- a/arch/powerpc/kernel/exceptions-64e.S
+++ b/arch/powerpc/kernel/exceptions-64e.S
@@ -661,7 +661,6 @@ storage_fault_common:
 	std	r14,_DAR(r1)
 	std	r15,_DSISR(r1)
 	addi	r3,r1,STACK_FRAME_OVERHEAD
-	bl	.save_nvgprs
 	mr	r4,r14
 	mr	r5,r15
 	ld	r14,PACA_EXGEN+EX_R14(r13)
@@ -670,7 +669,8 @@ storage_fault_common:
 	cmpdi	r3,0
 	bne-	1f
 	b	.ret_from_except_lite
-1:	mr	r5,r3
+1:	bl	.save_nvgprs
+	mr	r5,r3
 	addi	r3,r1,STACK_FRAME_OVERHEAD
 	ld	r4,_DAR(r1)
 	bl	.bad_page_fault
-- 
1.7.9.7

