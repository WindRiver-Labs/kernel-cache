From 4e049a0e4531946b39f7935205bf12e5b8c85c44 Mon Sep 17 00:00:00 2001
From: Joe MacDonald <joe.macdonald@windriver.com>
Date: Thu, 19 Jul 2012 14:55:53 -0400
Subject: [PATCH 6/6] grsec: Introduce config option for hardware NX

Due to potential performance impacts on P4-based systems, PAX rules out
the possibility of hardware-based paging on x86_32 systems entirely.  So
long as there is actual hardware-based paging, however, the impact is
negligible, therefore we will provide an option to get NX back on through
Kconfig.

Signed-off-by: Joe MacDonald <joe.macdonald@windriver.com>
---
 arch/x86/Kconfig |   13 +++++++++++++
 security/Kconfig |    2 +-
 2 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig
index 97c0730..9c7a482 100644
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@ -298,6 +298,19 @@ config SMP
 
 	  If you don't know what to do here, say N.
 
+config ARCH_HAS_HW_NX
+	bool "Platform has hardware-based Execute-Disable (NX)"
+	default n if X86_32
+	default y if X86_64
+	help
+	  If your target platform has hardware-based Execute Disable, also called
+	  No-eXecute, NX, Enhanced Virus Protection (AMD), or eXecute-Never (XN)
+	  on ARM platforms, and you wish to make use of this feature, you should
+	  say 'y' here.
+
+	  If your platform does not have some sort of hardware-based write-or-
+	  exeucte support, you should say 'n' here.
+
 config X86_X2APIC
 	bool "Support x2apic"
 	depends on X86_LOCAL_APIC && X86_64 && IRQ_REMAP
diff --git a/security/Kconfig b/security/Kconfig
index 8f62e86..1e5c4d6 100644
--- a/security/Kconfig
+++ b/security/Kconfig
@@ -381,7 +381,7 @@ config PAX_NOEXEC
 config PAX_PAGEEXEC
 	bool "Paging based non-executable pages"
 	default y if GRKERNSEC_CONFIG_AUTO
-	depends on PAX_NOEXEC && (!X86_32 || M586 || M586TSC || M586MMX || M686 || MPENTIUMII || MPENTIUMIII || MPENTIUMM || MCORE2 || MATOM || MPENTIUM4 || MPSC || MK7 || MK8 || MWINCHIPC6 || MWINCHIP2 || MWINCHIP3D || MVIAC3_2 || MVIAC7)
+	depends on PAX_NOEXEC && (ARCH_HAS_HW_NX || (!X86_32 || M586 || M586TSC || M586MMX || M686 || MPENTIUMII || MPENTIUMIII || MPENTIUMM || MCORE2 || MATOM || MPENTIUM4 || MPSC || MK7 || MK8 || MWINCHIPC6 || MWINCHIP2 || MWINCHIP3D || MVIAC3_2 || MVIAC7))
 	select S390_SWITCH_AMODE if S390
 	select S390_EXEC_PROTECT if S390
 	select ARCH_TRACK_EXEC_LIMIT if X86_32
-- 
1.7.9.7

