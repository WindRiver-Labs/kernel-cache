From 8e33e453c69d41c8b20c18e54fab540d7b5d69d6 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Fri, 14 Feb 2014 11:54:07 -0800
Subject: [PATCH 3/3] grsec: Use atomic operation interface to manipulate
 atomic variable

The files counter in pipe_inode_info is atomic variable, so it has to be
manipulated by atomic interface.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 fs/pipe.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/fs/pipe.c b/fs/pipe.c
index ca75e8c..6fe59de 100644
--- a/fs/pipe.c
+++ b/fs/pipe.c
@@ -731,7 +731,8 @@ static void put_pipe_info(struct inode *inode, struct pipe_inode_info *pipe)
 	int kill = 0;
 
 	spin_lock(&inode->i_lock);
-	if (!--pipe->files) {
+	atomic_dec(&pipe->files);
+	if (atomic_read(&pipe->files) == 0) {
 		inode->i_pipe = NULL;
 		kill = 1;
 	}
-- 
1.8.5.2.233.g932f7e4

