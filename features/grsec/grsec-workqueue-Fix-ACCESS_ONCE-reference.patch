From 6c0d1ea98eac0fa88aee98d6e86ddcae8f473637 Mon Sep 17 00:00:00 2001
From: Michel Thebeau <michel.thebeau@windriver.com>
Date: Wed, 5 Sep 2012 16:55:32 -0400
Subject: [PATCH] grsec/workqueue: Fix ACCESS_ONCE reference

This fix is replicated from "lttng: Fix ACCESS_ONCE references" which
states:

"PAX introduces a new macro, ACCESS_ONCE_RW that indicates we intend to
update the value we're referencing."

Upstream commit 6adebb0e1d4820435e0c6739b0de20a196cc20d5 on v3.4.12
adds an assignment with ACCESS_ONCE to kernel/workqueue.c:

+               ACCESS_ONCE(worker->flags) = worker_flags;

So refactor this reference as well.

Signed-off-by: Michel Thebeau <michel.thebeau@windriver.com>
---
 kernel/workqueue.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/kernel/workqueue.c b/kernel/workqueue.c
index 56f793d..1ef3e29 100644
--- a/kernel/workqueue.c
+++ b/kernel/workqueue.c
@@ -3445,7 +3445,7 @@ static int __cpuinit trustee_thread(void *__gcwq)
 		 */
 		worker_flags |= WORKER_REBIND;
 		worker_flags &= ~WORKER_ROGUE;
-		ACCESS_ONCE(worker->flags) = worker_flags;
+		ACCESS_ONCE_RW(worker->flags) = worker_flags;
 
 		/* queue rebind_work, wq doesn't matter, use the default one */
 		if (test_and_set_bit(WORK_STRUCT_PENDING_BIT,
-- 
1.7.9.7

