From 195cfe24bda4ba9a531ce783d49fd0ced5a1b7e5 Mon Sep 17 00:00:00 2001
From: Michel Thebeau <michel.thebeau@windriver.com>
Date: Mon, 28 Jan 2013 16:46:15 -0500
Subject: [PATCH] ptrace: remove references to previous_esp

Grsec commit "GRSecurity 2.9.1 -- 201207080925" moves the previous_esp
stack pointer from thread_info to irq_ctx.  While upstream commit
9d4f96299744ee7b8e2c4ad30ee915f1671e9fba "x86-32: Fix invalid stack
address while in softirq" wants to access the previous_esp for
kernel_stack_pointer().

Drop previous_esp from kernel_stack_pointer() until a new solution is
provided for 9d4f96299744ee7b8e2c4ad30ee915f1671e9fba.

Signed-off-by: Michel Thebeau <michel.thebeau@windriver.com>
---
 arch/x86/kernel/ptrace.c |    5 -----
 1 file changed, 5 deletions(-)

diff --git a/arch/x86/kernel/ptrace.c b/arch/x86/kernel/ptrace.c
index 07b3221..0c5906f 100644
--- a/arch/x86/kernel/ptrace.c
+++ b/arch/x86/kernel/ptrace.c
@@ -186,15 +186,10 @@ unsigned long kernel_stack_pointer(struct pt_regs *regs)
 {
 	unsigned long context = (unsigned long)regs & ~(THREAD_SIZE - 1);
 	unsigned long sp = (unsigned long)&regs->sp;
-	struct thread_info *tinfo;
 
 	if (context == (sp & ~(THREAD_SIZE - 1)))
 		return sp;
 
-	tinfo = (struct thread_info *)context;
-	if (tinfo->previous_esp)
-		return tinfo->previous_esp;
-
 	return (unsigned long)regs;
 }
 EXPORT_SYMBOL_GPL(kernel_stack_pointer);
-- 
1.7.9.7

