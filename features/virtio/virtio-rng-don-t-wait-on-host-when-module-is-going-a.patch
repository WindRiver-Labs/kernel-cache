From 4f1ff1a7858fa3e69c0967549b2d6c1bfc1c67e1 Mon Sep 17 00:00:00 2001
From: Amit Shah <amit.shah@redhat.com>
Date: Mon, 28 May 2012 12:18:41 +0530
Subject: [PATCH] virtio: rng: don't wait on host when module is going away

commit 4476987a9a4525db3ebe29538cc357ca589db4ac upstream.

No use waiting for input from host when the module is being removed.
We're going to remove the vq in the next step anyway, so just perform
any other steps for cleanup (currently none).

Signed-off-by: Amit Shah <amit.shah@redhat.com>
Signed-off-by: Rusty Russell <rusty@rustcorp.com.au>
Signed-off-by: Paul Barrette <paul.barrette@windriver.com>

diff --git a/drivers/char/hw_random/virtio-rng.c b/drivers/char/hw_random/virtio-rng.c
index ab7e254..0817b0a 100644
--- a/drivers/char/hw_random/virtio-rng.c
+++ b/drivers/char/hw_random/virtio-rng.c
@@ -117,6 +117,7 @@ static int virtrng_probe(struct virtio_device *vdev)
 static void __devexit virtrng_remove(struct virtio_device *vdev)
 {
 	vdev->config->reset(vdev);
+	busy = false;
 	hwrng_unregister(&virtio_hwrng);
 	vdev->config->del_vqs(vdev);
 	vq = NULL;
-- 
1.8.3.1

