From 6d910523731e22656713e3eefeca43acf048e077 Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Tue, 3 Sep 2013 10:06:36 -0400
Subject: [PATCH] Revert "virtio_net: fix race in RX VQ processing"

This reverts commit 40a017c96a98a29c9d39bf0ca34651288984e9ce.

This is a backport to the 3.4 codebase, which in turn conflicts
with some of the virtio_net cherrypicks that we take on later.
Revert it now, so that the default "un-backported" mainline
version can be applied after the cherrypicks.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/drivers/net/virtio_net.c b/drivers/net/virtio_net.c
index bc177b9..cbefe67 100644
--- a/drivers/net/virtio_net.c
+++ b/drivers/net/virtio_net.c
@@ -518,7 +518,7 @@ static int virtnet_poll(struct napi_struct *napi, int budget)
 {
 	struct virtnet_info *vi = container_of(napi, struct virtnet_info, napi);
 	void *buf;
-	unsigned int r, len, received = 0;
+	unsigned int len, received = 0;
 
 again:
 	while (received < budget &&
@@ -535,9 +535,8 @@ again:
 
 	/* Out of packets? */
 	if (received < budget) {
-		r = virtqueue_enable_cb_prepare(vi->rvq);
 		napi_complete(napi);
-		if (unlikely(virtqueue_poll(vi->rvq, r)) &&
+		if (unlikely(!virtqueue_enable_cb(vi->rvq)) &&
 		    napi_schedule_prep(napi)) {
 			virtqueue_disable_cb(vi->rvq);
 			__napi_schedule(napi);
-- 
1.8.3.1

