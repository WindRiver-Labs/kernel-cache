From dfe55226a746ba00f2302317315f150706bd96aa Mon Sep 17 00:00:00 2001
From: Bruce Ashfield <bruce.ashfield@windriver.com>
Date: Mon, 2 Feb 2009 12:01:02 -0500
Subject: [PATCH] ocd: powerpc hooks

Enable debug interrupt and add nops to allow OCD to better
work with BOOKE processors.

Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 arch/powerpc/include/asm/reg_booke.h |    4 ++++
 arch/powerpc/kernel/head_booke.h     |   10 ++++++++++
 2 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/reg_booke.h b/arch/powerpc/include/asm/reg_booke.h
index be980f4..33399ab 100644
--- a/arch/powerpc/include/asm/reg_booke.h
+++ b/arch/powerpc/include/asm/reg_booke.h
@@ -22,7 +22,11 @@
 #if defined (CONFIG_40x)
 #define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_IR|MSR_DR|MSR_CE)
 #elif defined(CONFIG_BOOKE)
+#ifdef CONFIG_WR_OCD_DEBUG
+#define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_CE|MSR_DE)
+#else
 #define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_CE)
+#endif	/* OCD */
 #endif
 
 /* Special Purpose Registers (SPRNs)*/
diff --git a/arch/powerpc/kernel/head_booke.h b/arch/powerpc/kernel/head_booke.h
index fce2df9..924a13f 100644
--- a/arch/powerpc/kernel/head_booke.h
+++ b/arch/powerpc/kernel/head_booke.h
@@ -159,9 +159,19 @@
 /*
  * Exception vectors.
  */
+#if defined (CONFIG_WR_OCD_DEBUG) && defined (CONFIG_BOOKE)
+#define	START_EXCEPTION(label)						     \
+        .align 5;              						     \
+label:									     \
+	nop;								     \
+	nop;								     \
+	nop;								     \
+	isync;
+#else
 #define	START_EXCEPTION(label)						     \
         .align 5;              						     \
 label:
+#endif
 
 #define FINISH_EXCEPTION(func)					\
 	bl	transfer_to_handler_full;			\
-- 
1.6.0.3

