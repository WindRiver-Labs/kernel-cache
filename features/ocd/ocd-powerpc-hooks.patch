From c633d4fe7bb246f190c4abb8fd676a0746162cc7 Mon Sep 17 00:00:00 2001
From: Bruce Ashfield <bruce.ashfield@windriver.com>
Date: Mon, 2 Feb 2009 12:01:02 -0500
Subject: [PATCH 2/3] ocd: powerpc hooks

Enable debug interrupt and add nops to allow OCD to better
work with BOOKE processors.

Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 arch/powerpc/include/asm/reg_booke.h |    8 ++++++--
 arch/powerpc/kernel/head_booke.h     |   10 ++++++++++
 2 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/include/asm/reg_booke.h b/arch/powerpc/include/asm/reg_booke.h
index 414d434..596f06d 100644
--- a/arch/powerpc/include/asm/reg_booke.h
+++ b/arch/powerpc/include/asm/reg_booke.h
@@ -29,8 +29,12 @@
 #define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_IR|MSR_DR|MSR_CE)
 #define MSR_USER	(MSR_KERNEL|MSR_PR|MSR_EE)
 #else
-#define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_CE)
-#define MSR_USER	(MSR_KERNEL|MSR_PR|MSR_EE)
+#ifdef CONFIG_WR_OCD_DEBUG
+#define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_CE|MSR_DE)
+#else
+#define MSR_KERNEL     (MSR_ME|MSR_RI|MSR_CE)
+#endif	/* OCD */
+#define MSR_USER       (MSR_KERNEL|MSR_PR|MSR_EE)
 #endif
 
 /* Special Purpose Registers (SPRNs)*/
diff --git a/arch/powerpc/kernel/head_booke.h b/arch/powerpc/kernel/head_booke.h
index c293894..13603d6 100644
--- a/arch/powerpc/kernel/head_booke.h
+++ b/arch/powerpc/kernel/head_booke.h
@@ -158,9 +158,19 @@
 /*
  * Exception vectors.
  */
+#if defined (CONFIG_WR_OCD_DEBUG) && defined (CONFIG_BOOKE)
+#define	START_EXCEPTION(label)						     \
+        .align 5;              						     \
+label:									     \
+	nop;								     \
+	nop;								     \
+	nop;								     \
+	isync;
+#else
 #define	START_EXCEPTION(label)						     \
         .align 5;              						     \
 label:
+#endif
 
 #define FINISH_EXCEPTION(func)					\
 	bl	transfer_to_handler_full;			\
-- 
1.6.5.2

