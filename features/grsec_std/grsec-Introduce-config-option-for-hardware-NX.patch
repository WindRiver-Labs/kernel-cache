From 3ba073735bcdf3e261e0ebaaf5d66540840a70c6 Mon Sep 17 00:00:00 2001
From: Joe MacDonald <joe.macdonald@windriver.com>
Date: Tue, 3 Apr 2012 23:42:12 +0800
Subject: [PATCH 1/5] grsec: Introduce config option for hardware NX

The Fish River Island 2 has hardware NX support even though it is a 32-bit
platform.  PAX assumes all 32-bit x86 platforms automatically exclude this
functionality.  As we've observed with other targets that have hardware NX
but disable the feature in PAX, the FRI2 displays certain boot and runtime
stability issues.  Therefore we'll allow this option to be enabled for
this board and enable it in our configuration.

Signed-off-by: Joe MacDonald <joe.macdonald@windriver.com>
---
 arch/x86/Kconfig |   13 +++++++++++++
 security/Kconfig |    2 +-
 2 files changed, 14 insertions(+), 1 deletions(-)

diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig
index 19d25fd..fca9570 100644
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@ -291,6 +291,19 @@ config SMP
 
 	  If you don't know what to do here, say N.
 
+config ARCH_HAS_HW_NX
+	bool "Platform has hardware-based Execute-Disable (NX)"
+	default n if X86_32
+	default y if X86_64
+	help
+	  If your target platform has hardware-based Execute Disable, also called
+	  No-eXecute, NX, Enhanced Virus Protection (AMD), or eXecute-Never (XN)
+	  on ARM platforms, and you wish to make use of this feature, you should
+	  say 'y' here.
+
+	  If your platform does not have some sort of hardware-based write-or-
+	  exeucte support, you should say 'n' here.
+
 config X86_X2APIC
 	bool "Support x2apic"
 	depends on X86_LOCAL_APIC && X86_64 && INTR_REMAP
diff --git a/security/Kconfig b/security/Kconfig
index f8a07c8..d9fa0b2 100644
--- a/security/Kconfig
+++ b/security/Kconfig
@@ -143,7 +143,7 @@ config PAX_NOEXEC
 
 config PAX_PAGEEXEC
 	bool "Paging based non-executable pages"
-	depends on PAX_NOEXEC && (!X86_32 || M586 || M586TSC || M586MMX || M686 || MPENTIUMII || MPENTIUMIII || MPENTIUMM || MCORE2 || MPENTIUM4 || MPSC || MK7 || MK8 || MWINCHIPC6 || MWINCHIP2 || MWINCHIP3D || MVIAC3_2 || MVIAC7)
+	depends on PAX_NOEXEC && (ARCH_HAS_HW_NX || (!X86_32 || M586 || M586TSC || M586MMX || M686 || MPENTIUMII || MPENTIUMIII || MPENTIUMM || MCORE2 || MPENTIUM4 || MPSC || MK7 || MK8 || MWINCHIPC6 || MWINCHIP2 || MWINCHIP3D || MVIAC3_2 || MVIAC7))
 	select S390_SWITCH_AMODE if S390
 	select S390_EXEC_PROTECT if S390
 	help
-- 
1.7.4.1

