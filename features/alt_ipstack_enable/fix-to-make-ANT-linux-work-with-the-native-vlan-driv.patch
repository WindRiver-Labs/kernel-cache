From 78b023be9c614712c8a67a571d6cec5fdfda91cf Mon Sep 17 00:00:00 2001
From: Jonas Rendel <Jonas.Rendel@windriver.com>
Date: Mon, 8 Dec 2008 14:49:55 +0100
Subject: [PATCH] allow ANT/linux work with the native vlan driver

Add hooks to allow the native vlan driver to work
with interpeak when the alternate IP stack support
is active.

Signed-off-by: Jonas Rendel <Jonas.Rendel@windriver.com>
Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 fs/proc/proc_sysctl.c |   34 +++++++++++++---------------------
 net/socket.c          |   15 +++++++++++++++
 net/sysctl_net.c      |    9 +++++++++
 3 files changed, 37 insertions(+), 21 deletions(-)

diff --git a/fs/proc/proc_sysctl.c b/fs/proc/proc_sysctl.c
index 96a5f39..99e273e 100644
--- a/fs/proc/proc_sysctl.c
+++ b/fs/proc/proc_sysctl.c
@@ -101,16 +101,6 @@ static struct dentry *proc_sys_lookup(struct inode *dir, struct dentry *dentry,
 		for (h = sysctl_head_next(NULL); h; h = sysctl_head_next(h)) {
 			if (h->attached_to != table)
 				continue;
-#ifdef CONFIG_INTERPEAK
-			/* If table represents a VR bound directory then */
-			/* check if is bound to the callers VR           */
-			if (h->attached_to->child != NULL && h->attached_to->extra2 != NULL) {
-			  unsigned short *vr = (unsigned short*)h->attached_to->extra2;
-
-			  if (*vr != current->vr)
-			    continue;
-			}
-#endif
 			p = find_in_table(h->attached_by, name);
 			if (p)
 				break;
@@ -236,6 +226,19 @@ static int scan(struct ctl_table_header *head, ctl_table *table,
 		if (!table->procname)
 			continue;
 
+#ifdef CONFIG_INTERPEAK
+		/* Check if table represents a VR bound directory. */
+		/* Then verify that it is bound to the callers VR. */
+
+		if (table->child != NULL && table->extra2 != NULL) {
+            unsigned short *vr = (unsigned short*)table->extra2;
+
+		  if (*vr != current->vr)
+		    continue;
+		}
+#endif /* CONFIG_INTERPEAK */
+
+
 		if (*pos < file->f_pos)
 			continue;
 
@@ -291,17 +294,6 @@ static int proc_sys_readdir(struct file *filp, void *dirent, filldir_t filldir)
 	for (h = sysctl_head_next(NULL); h; h = sysctl_head_next(h)) {
 		if (h->attached_to != table)
 			continue;
-#ifdef CONFIG_INTERPEAK
-		/* Check if table represents a VR bound directory. */
-		/* Then verify that it is bound to the callers VR. */
-
-		if (h->attached_to->child != NULL && h->attached_to->extra2 != NULL) {
-		  unsigned short *vr = (unsigned short*)h->attached_to->extra2;
-
-		  if (*vr != current->vr)
-		    continue;
-		}
-#endif /* CONFIG_INTERPEAK */
 
 		ret = scan(h, h->attached_by, &pos, filp, dirent, filldir);
 		if (ret) {
diff --git a/net/socket.c b/net/socket.c
index 437ddba..3b889c0 100644
--- a/net/socket.c
+++ b/net/socket.c
@@ -922,6 +922,21 @@ static long sock_ioctl(struct file *file, unsigned cmd, unsigned long arg)
 		default:
 			err = sock->ops->ioctl(sock, cmd, arg);
 
+#ifdef CONFIG_INTERPEAK
+            if (err == -ENOIOCTLCMD
+                && (cmd == SIOCGIFVLAN || cmd == SIOCSIFVLAN)) {
+                err = -ENOPKG;
+                if (!vlan_ioctl_hook)
+                    request_module("8021q");
+
+                mutex_lock(&vlan_ioctl_mutex);
+                if (vlan_ioctl_hook)
+                    err = vlan_ioctl_hook(net, argp);
+                mutex_unlock(&vlan_ioctl_mutex);
+                break;
+            }
+#endif /* CONFIG_INTERPEAK */
+
 			/*
 			 * If this ioctl is unknown try to hand it down
 			 * to the NIC driver.
diff --git a/net/sysctl_net.c b/net/sysctl_net.c
index 972201c..2f66ec3 100644
--- a/net/sysctl_net.c
+++ b/net/sysctl_net.c
@@ -115,6 +115,15 @@ struct ctl_table_header *register_net_sysctl_table(struct net *net,
 }
 EXPORT_SYMBOL_GPL(register_net_sysctl_table);
 
+#ifdef CONFIG_INTERPEAK
+struct ctl_table_header *do_register_net_sysctl_table(struct net *net,
+	const struct ctl_path *path, struct ctl_table *table)
+{
+    return register_net_sysctl_table(net, path, table);
+}
+EXPORT_SYMBOL(do_register_net_sysctl_table);
+#endif
+
 struct ctl_table_header *register_net_sysctl_rotable(const
 		struct ctl_path *path, struct ctl_table *table)
 {
-- 
1.6.0.3

