From c67d46a1e19a93369d4db2043f39e3399453ef19 Mon Sep 17 00:00:00 2001
From: Jonas Rendel <Jonas.Rendel@windriver.com>
Date: Mon, 8 Dec 2008 14:49:55 +0100
Subject: [PATCH] allow ANT/linux work with the native vlan driver

Add hooks to allow the native vlan driver to work
with interpeak when the alternate IP stack support
is active.

Signed-off-by: Jonas Rendel <Jonas.Rendel@windriver.com>
Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>

---
 net/socket.c |   15 +++++++++++++++
 1 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/net/socket.c b/net/socket.c
index 40a4b7e..0205305 100644
--- a/net/socket.c
+++ b/net/socket.c
@@ -922,6 +922,21 @@ static long sock_ioctl(struct file *file, unsigned cmd, unsigned long arg)
 		default:
 			err = sock->ops->ioctl(sock, cmd, arg);
 
+#ifdef CONFIG_INTERPEAK
+            if (err == -ENOIOCTLCMD
+                && (cmd == SIOCGIFVLAN || cmd == SIOCSIFVLAN)) {
+                err = -ENOPKG;
+                if (!vlan_ioctl_hook)
+                    request_module("8021q");
+
+                mutex_lock(&vlan_ioctl_mutex);
+                if (vlan_ioctl_hook)
+                    err = vlan_ioctl_hook(net, argp);
+                mutex_unlock(&vlan_ioctl_mutex);
+                break;
+            }
+#endif /* CONFIG_INTERPEAK */
+
 			/*
 			 * If this ioctl is unknown try to hand it down
 			 * to the NIC driver.
-- 
1.5.6

