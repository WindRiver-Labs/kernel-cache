From f695a39463f4525cb35c13365505ea25c60e701f Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Fri, 28 Jul 2017 12:59:24 +0800
Subject: [PATCH] fixed_phy: set bus->state as MDIOBUS_UNREGISTERED if
 mdiobus_register() fails

If mdiobus_register() fails we must set bus->state as MDIOBUS_UNREGISTERED.
Else mdiobus_free() wouldn't call put_device(), we would get the two
kmemleaks as below:

unreferenced object 0xffff800037811fc0 (size 64):
  comm "swapper/0", pid 1, jiffies 4294937730 (age 103.710s)
  hex dump (first 32 bytes):
    66 69 78 65 64 2d 30 00 2f 70 6c 61 74 66 6f 72  fixed-0./platfor
    6d 2f 46 69 78 65 64 20 4d 44 49 4f 20 62 75 73  m/Fixed MDIO bus
  backtrace:
    [<ffff8000001cddd0>] create_object+0xf8/0x258
    [<ffff8000009a0a58>] kmemleak_alloc+0x58/0xa0
    [<ffff8000001c0fb4>] __kmalloc_track_caller+0x19c/0x3c0
    [<ffff80000043c044>] kvasprintf+0x64/0xa8
    [<ffff80000042d7ac>] kobject_set_name_vargs+0x44/0xa8
    [<ffff800000519e3c>] dev_set_name+0x64/0x70
    [<ffff8000005ca478>] mdiobus_register+0x80/0x1f0
    [<ffff800000cf22a0>] fixed_mdio_bus_init+0xcc/0x108
    [<ffff8000000842f4>] do_one_initcall+0x94/0x1b0
    [<ffff800000cbcb84>] kernel_init_freeable+0x200/0x2d4
    [<ffff80000099f818>] kernel_init+0x20/0xe8
    [<ffff800000083c10>] ret_from_fork+0x10/0x40
    [<ffffffffffffffff>] 0xffffffffffffffff
unreferenced object 0xffff800037819800 (size 256):
  comm "swapper/0", pid 1, jiffies 4294937730 (age 103.710s)
  hex dump (first 32 bytes):
    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
  backtrace:
    [<ffff8000001cddd0>] create_object+0xf8/0x258
    [<ffff8000009a0a58>] kmemleak_alloc+0x58/0xa0
    [<ffff8000001be758>] kmem_cache_alloc_trace+0x2c8/0x358
    [<ffff80000051b81c>] device_private_init+0x2c/0x78
    [<ffff80000051bcc0>] device_add+0x458/0x558
    [<ffff80000051bde8>] device_register+0x28/0x38
    [<ffff8000005ca480>] mdiobus_register+0x88/0x1f0
    [<ffff800000cf22a0>] fixed_mdio_bus_init+0xcc/0x108
    [<ffff8000000842f4>] do_one_initcall+0x94/0x1b0
    [<ffff800000cbcb84>] kernel_init_freeable+0x200/0x2d4
    [<ffff80000099f818>] kernel_init+0x20/0xe8
    [<ffff800000083c10>] ret_from_fork+0x10/0x40
    [<ffffffffffffffff>] 0xffffffffffffffff

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/phy/fixed_phy.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/drivers/net/phy/fixed_phy.c b/drivers/net/phy/fixed_phy.c
index c6755ed..e487464 100644
--- a/drivers/net/phy/fixed_phy.c
+++ b/drivers/net/phy/fixed_phy.c
@@ -346,8 +346,10 @@ static int __init fixed_mdio_bus_init(void)
 	fmb->mii_bus->irq = fmb->irqs;
 
 	ret = mdiobus_register(fmb->mii_bus);
-	if (ret)
+	if (ret) {
+		fmb->mii_bus->state = MDIOBUS_UNREGISTERED;
 		goto err_mdiobus_alloc;
+	}
 
 	return 0;
 
-- 
1.7.5.4

