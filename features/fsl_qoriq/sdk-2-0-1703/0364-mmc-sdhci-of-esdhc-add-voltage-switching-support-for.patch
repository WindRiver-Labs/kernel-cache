From 0140c2d3c27e39097e37f5794377267b7aeab2b1 Mon Sep 17 00:00:00 2001
From: Yangbo Lu <yangbo.lu@nxp.com>
Date: Tue, 28 Feb 2017 15:11:43 +0800
Subject: [PATCH 364/388] mmc: sdhci-of-esdhc: add voltage switching support
 for ls1046a

There is a SDHC IO VSEL control register in the supplement configuration
unit in ls1046a. This is to support SDHC IO voltage switching. This patch
is to add ls1046a scfg support for voltage switching and fix the voltage
switching process.

Signed-off-by: Yangbo Lu <yangbo.lu@nxp.com>
[Original patch taken from SDK-V2.0-1703]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/mmc/host/sdhci-of-esdhc.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/drivers/mmc/host/sdhci-of-esdhc.c b/drivers/mmc/host/sdhci-of-esdhc.c
index 7295d29..7f37dfc 100644
--- a/drivers/mmc/host/sdhci-of-esdhc.c
+++ b/drivers/mmc/host/sdhci-of-esdhc.c
@@ -839,10 +839,12 @@ static void esdhc_set_uhs_signaling(struct sdhci_host *host, unsigned int uhs)
 static const struct of_device_id scfg_device_ids[] = {
 	{ .compatible = "fsl,t1040-scfg", },
 	{ .compatible = "fsl,ls1012a-scfg", },
+	{ .compatible = "fsl,ls1046a-scfg", },
 	{}
 };
 #define SCFG_SDHCIOVSELCR	0x408
 #define SDHCIOVSELCR_TGLEN	0x80000000
+#define SDHCIOVSELCR_VSELVAL	0x60000000
 #define SDHCIOVSELCR_SDHC_VS	0x00000001
 
 void esdhc_signal_voltage_switch(struct sdhci_host *host,
@@ -868,10 +870,20 @@ void esdhc_signal_voltage_switch(struct sdhci_host *host,
 		}
 		if (scfg_base) {
 			scfg_sdhciovselcr = SDHCIOVSELCR_TGLEN |
+					    SDHCIOVSELCR_VSELVAL;
+			iowrite32be(scfg_sdhciovselcr,
+				scfg_base + SCFG_SDHCIOVSELCR);
+
+			val |= ESDHC_VOLT_SEL;
+			sdhci_writel(host, val, ESDHC_PROCTL);
+			mdelay(5);
+
+			scfg_sdhciovselcr = SDHCIOVSELCR_TGLEN |
 					    SDHCIOVSELCR_SDHC_VS;
 			iowrite32be(scfg_sdhciovselcr,
 				scfg_base + SCFG_SDHCIOVSELCR);
 			iounmap(scfg_base);
+			break;
 		}
 		val |= ESDHC_VOLT_SEL;
 		sdhci_writel(host, val, ESDHC_PROCTL);
-- 
2.9.3

