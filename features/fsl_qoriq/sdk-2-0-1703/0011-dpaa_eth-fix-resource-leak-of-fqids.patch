From 89cb8ae642923f7664c925c4f0cd0b0efbbdf5db Mon Sep 17 00:00:00 2001
From: Ioana Ciornei <ioana.ciornei@nxp.com>
Date: Thu, 19 May 2016 14:40:55 +0300
Subject: [PATCH 011/388] dpaa_eth: fix resource leak of fqids

Fix resource leak of fqids in case of error

Signed-off-by: Ioana Ciornei <ioana.ciornei@nxp.com>
[Original patch taken from SDK-V2.0-1703]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_generic.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_generic.c b/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_generic.c
index d881817..959ecc8 100644
--- a/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_generic.c
+++ b/drivers/net/ethernet/freescale/sdk_dpaa/dpaa_eth_generic.c
@@ -995,6 +995,7 @@ static struct list_head *dpa_generic_fq_probe(struct platform_device *_of_dev,
 			  FQ_TYPE_RX_ERROR) ||
 			!dpa_fq_alloc(dev, fqids[1].start, fqids[1].count,
 				      list, FQ_TYPE_RX_DEFAULT)) {
+		kfree(fqids);
 		dev_err(dev, "Cannot allocate space for default frame queues\n");
 		return ERR_PTR(-ENOMEM);
 	}
@@ -1014,6 +1015,7 @@ static struct list_head *dpa_generic_fq_probe(struct platform_device *_of_dev,
 		if (!dpa_fq_alloc(dev, fqids[i].start, fqids[i].count, list,
 				  FQ_TYPE_TX)) {
 			dev_err(dev, "_dpa_fq_alloc() failed\n");
+			kfree(fqids);
 			return ERR_PTR(-ENOMEM);
 		}
 	}
@@ -1030,6 +1032,7 @@ static struct list_head *dpa_generic_fq_probe(struct platform_device *_of_dev,
 			if (!dpa_fq_alloc(dev, fqids[i].start, fqids[i].count, list,
 				  	  FQ_TYPE_RX_PCD)) {
 				dev_err(dev, "_dpa_fq_alloc() failed\n");
+				kfree(fqids);
 				return ERR_PTR(-ENOMEM);
 			}
 		}
-- 
2.9.3

