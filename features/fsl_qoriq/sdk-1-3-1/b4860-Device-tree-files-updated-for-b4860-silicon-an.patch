From 52efb2e262eb52ad84d013589244dc53a9ab4296 Mon Sep 17 00:00:00 2001
From: Shaveta Leekha <shaveta@freescale.com>
Date: Tue, 14 Aug 2012 13:36:25 +0000
Subject: [PATCH 052/227] b4860: Device tree files updated for b4860 silicon
 and b4860qds

- Add threads to the cpu nodes
- b4860si: add next level cache info for each cpu in dts
- Add i2c, pcie, sdhc and espi device tree nodes
        (b4860 pcie block is compatible with PCI Express version 2.4)
- add guts node
- Add IFC support in device tree
        Add support of IFC controller in b4860
        Also Create NOR entry and NAND flash partitions
        Add fpga entry
- add DMA support in device tree
- Add PAMU support to B4860QDS in Kconfig
- fsl_pamu: Add compatible for b4860 guts_node in qoriq_device_config

Signed-off-by: Shaveta Leekha <shaveta@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/boot/dts/b4860qds.dts          |  129 +++++++++++++++++++++++++++
 arch/powerpc/boot/dts/fsl/b4860si-post.dtsi |   55 ++++++++++++
 arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi  |   16 +++-
 arch/powerpc/platforms/85xx/Kconfig         |    1 +
 arch/powerpc/platforms/85xx/b4860_qds.c     |    1 +
 arch/powerpc/sysdev/fsl_pamu.c              |    3 +
 6 files changed, 201 insertions(+), 4 deletions(-)

diff --git a/arch/powerpc/boot/dts/b4860qds.dts b/arch/powerpc/boot/dts/b4860qds.dts
index 95ded39..bc79559 100644
--- a/arch/powerpc/boot/dts/b4860qds.dts
+++ b/arch/powerpc/boot/dts/b4860qds.dts
@@ -41,6 +41,63 @@
 	#size-cells = <2>;
 	interrupt-parent = <&mpic>;
 
+
+	ifc: localbus@ffe124000 {
+		reg = <0xf 0xfe124000 0 0x1000>;
+		ranges = <0 0 0xf 0xe8000000 0x08000000
+			  2 0 0xf 0xffa00000 0x00010000>;
+
+		nor@0,0 {
+			#address-cells = <1>;
+			#size-cells = <1>;
+			compatible = "cfi-flash";
+			reg = <0x0 0x0 0x8000000>;
+			/* TODO: Update bank-width depending upon
+			 * on-board Flash
+			 */
+			bank-width = <1>;
+			device-width = <1>;
+		};
+
+		nand@2,0 {
+			#address-cells = <1>;
+			#size-cells = <1>;
+			compatible = "fsl,ifc-nand";
+			reg = <0x2 0x0 0x10000>;
+
+			partition@0 {
+				/* This location must not be altered  */
+				/* 1MB for u-boot Bootloader Image */
+				reg = <0x0 0x00100000>;
+				label = "NAND U-Boot Image";
+				read-only;
+			};
+
+			partition@100000 {
+				/* 1MB for DTB Image */
+				reg = <0x00100000 0x00100000>;
+				label = "NAND DTB Image";
+			};
+
+			partition@200000 {
+				/* 10MB for Linux Kernel Image */
+				reg = <0x00200000 0x00A00000>;
+				label = "NAND Linux Kernel Image";
+			};
+
+			partition@e00000 {
+				/* 500MB for Root file System Image */
+				reg = <0x00e00000 0x1F400000>;
+				label = "NAND RFS Image";
+			};
+		};
+
+		board-control@3,0 {
+			compatible = "fsl,b4860qds-fpga", "fsl,fpga-qixis";
+			reg = <3 0 0x300>;
+		};
+	};
+
 	memory {
 		device_type = "memory";
 	};
@@ -48,7 +105,79 @@
 	soc: soc@ffe000000 {
 		ranges = <0x00000000 0xf 0xfe000000 0x1000000>;
 		reg = <0xf 0xfe000000 0 0x00001000>;
+		spi@110000 {
+			status = "disabled";
+			flash@0 {
+				#address-cells = <1>;
+				#size-cells = <1>;
+				compatible = "spansion,s25sl12801";
+				reg = <0>;
+				spi-max-frequency = <40000000>; /* input clock */
+				partition@0 {
+					/* This location must not be altered  */
+					/* 1MB for u-boot Bootloader Image */
+					label = "SPI U-Boot Image";
+					reg = <0x00000000 0x00100000>;
+					read-only;
+				};
+				partition@100000 {
+					/* 5MB for Linux Kernel Image */
+					label = "SPI Linux Kernel Image";
+					reg = <0x00100000 0x00500000>;
+				};
+				partition@600000 {
+					/* 1MB for DTB Image */
+					label = "SPI DTB Image";
+					reg = <0x00600000 0x00100000>;
+				};
+				partition@700000 {
+					/* 9MB for RFS Image */
+					label = "SPI RFS Image";
+					reg = <0x00700000 0x00900000>;
+				};
+			};
+		};
+
+		i2c@118000 {
+			eeprom@50 {
+				compatible = "at24,24c64";
+				reg = <0x50>;
+			};
+			eeprom@51 {
+				compatible = "at24,24c256";
+				reg = <0x51>;
+			};
+			eeprom@53 {
+				compatible = "at24,24c256";
+				reg = <0x53>;
+			};
+			eeprom@57 {
+				compatible = "at24,24c256";
+				reg = <0x57>;
+			};
+			rtc@68 {
+				compatible = "dallas,ds3232";
+				reg = <0x68>;
+				interrupts = <0x1 0x1 0 0>;
+			};
+		};
 	};
+
+	pci0: pcie@ffe200000 {
+		reg = <0xf 0xfe200000 0 0x10000>;
+		ranges = <0x02000000 0 0xe0000000 0xc 0x00000000 0x0 0x20000000
+			  0x01000000 0 0x00000000 0xf 0xf8000000 0x0 0x00010000>;
+		pcie@0 {
+			ranges = <0x02000000 0 0xe0000000
+				  0x02000000 0 0xe0000000
+				  0 0x20000000
+
+				  0x01000000 0 0x00000000
+				  0x01000000 0 0x00000000
+				  0 0x00010000>;
+		};
+	};
+
 };
 
 /include/ "fsl/b4860si-post.dtsi"
diff --git a/arch/powerpc/boot/dts/fsl/b4860si-post.dtsi b/arch/powerpc/boot/dts/fsl/b4860si-post.dtsi
index 828938c..41dadfb 100644
--- a/arch/powerpc/boot/dts/fsl/b4860si-post.dtsi
+++ b/arch/powerpc/boot/dts/fsl/b4860si-post.dtsi
@@ -32,6 +32,38 @@
  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
+&ifc {
+	#address-cells = <2>;
+	#size-cells = <1>;
+	compatible = "fsl,ifc", "simple-bus";
+	interrupts = <25 2 0 0>;
+};
+
+/* controller at 0x200000 */
+&pci0 {
+	compatible = "fsl,b4860-pcie", "fsl,qoriq-pcie-v2.4";
+	device_type = "pci";
+	#size-cells = <2>;
+	#address-cells = <3>;
+	bus-range = <0x0 0xff>;
+	interrupts = <20 2 0 0>;
+	pcie@0 {
+		#interrupt-cells = <1>;
+		#size-cells = <2>;
+		#address-cells = <3>;
+		device_type = "pci";
+		interrupts = <20 2 0 0>;
+		interrupt-map-mask = <0xf800 0 0 7>;
+		interrupt-map = <
+			/* IDSEL 0x0 */
+			0000 0 0 1 &mpic 40 1 0 0
+			0000 0 0 2 &mpic 1 1 0 0
+			0000 0 0 3 &mpic 2 1 0 0
+			0000 0 0 4 &mpic 3 1 0 0
+			>;
+	};
+};
+
 &soc {
 	#address-cells = <1>;
 	#size-cells = <1>;
@@ -87,8 +119,31 @@
 
 /include/ "qoriq-mpic.dtsi"
 
+	guts: global-utilities@e0000 {
+		compatible = "fsl,b4860-device-config";
+		reg = <0xe0000 0xe00>;
+		fsl,has-rstcr;
+		fsl,liodn-bits = <12>;
+	};
+
+/include/ "qoriq-dma-0.dtsi"
+/include/ "qoriq-dma-1.dtsi"
+
+/include/ "qoriq-espi-0.dtsi"
+	spi@110000 {
+		fsl,espi-num-chipselects = <4>;
+	};
+
+/include/ "qoriq-esdhc-0.dtsi"
+	sdhc@114000 {
+		sdhci,auto-cmd12;
+	};
 /include/ "qoriq-i2c-0.dtsi"
 /include/ "qoriq-i2c-1.dtsi"
 /include/ "qoriq-duart-0.dtsi"
 /include/ "qoriq-duart-1.dtsi"
+
+	L2: l2-cache-controller@c20000 {
+		next-level-cache = <&cpc>;
+	};
 };
diff --git a/arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi b/arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi
index 1420795..33bc600 100644
--- a/arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi
+++ b/arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi
@@ -46,6 +46,10 @@
 		serial1 = &serial1;
 		serial2 = &serial2;
 		serial3 = &serial3;
+		pci0 = &pci0;
+		dma0 = &dma0;
+		dma1 = &dma1;
+		sdhc = &sdhc;
 	};
 
 	cpus {
@@ -54,19 +58,23 @@
 
 		PowerPC,e6500@0 {
 			device_type = "cpu";
-			reg = <0>;
+			reg = <0 1>;
+			next-level-cache = <&L2>;
 		};
 		PowerPC,e6500@1 {
 			device_type = "cpu";
-			reg = <2>;
+			reg = <2 3>;
+			next-level-cache = <&L2>;
 		};
 		PowerPC,e6500@2 {
 			device_type = "cpu";
-			reg = <4>;
+			reg = <4 5>;
+			next-level-cache = <&L2>;
 		};
 		PowerPC,e6500@3 {
 			device_type = "cpu";
-			reg = <6>;
+			reg = <6 7>;
+			next-level-cache = <&L2>;
 		};
 	};
 };
diff --git a/arch/powerpc/platforms/85xx/Kconfig b/arch/powerpc/platforms/85xx/Kconfig
index 5adb87c..d2c0ca5 100644
--- a/arch/powerpc/platforms/85xx/Kconfig
+++ b/arch/powerpc/platforms/85xx/Kconfig
@@ -282,6 +282,7 @@ config B4860_QDS
 	select MPC8xxx_GPIO
 	select HAS_RAPIDIO
 	select PPC_EPAPR_HV_PIC
+	select HAS_FSL_PAMU
 	help
 	  This option enables support for the B4860 QDS board
 
diff --git a/arch/powerpc/platforms/85xx/b4860_qds.c b/arch/powerpc/platforms/85xx/b4860_qds.c
index bd6b4b9..038915b 100644
--- a/arch/powerpc/platforms/85xx/b4860_qds.c
+++ b/arch/powerpc/platforms/85xx/b4860_qds.c
@@ -93,6 +93,7 @@ define_machine(b4860_qds) {
 	.init_early		= corenet_ds_init_early,
 };
 
+machine_arch_initcall(b4860_qds, corenet_ds_publish_pci_device);
 machine_device_initcall(b4860_qds, declare_of_platform_devices);
 
 #ifdef CONFIG_SWIOTLB
diff --git a/arch/powerpc/sysdev/fsl_pamu.c b/arch/powerpc/sysdev/fsl_pamu.c
index 8baff2b4..2e36597 100644
--- a/arch/powerpc/sysdev/fsl_pamu.c
+++ b/arch/powerpc/sysdev/fsl_pamu.c
@@ -1034,6 +1034,9 @@ static struct of_device_id qoriq_device_config[] = {
 	{
 		.compatible = "fsl,t4240-device-config",
 	},
+	{
+		.compatible = "fsl,b4860-device-config",
+	},
 	{}
 };
 
-- 
1.7.9.7

