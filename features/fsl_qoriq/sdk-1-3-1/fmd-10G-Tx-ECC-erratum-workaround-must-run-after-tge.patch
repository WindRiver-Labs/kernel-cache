From 11a668c900b45d21b0c5ef0032e0eb548b855728 Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Tue, 13 Nov 2012 12:28:42 +0200
Subject: [PATCH 140/227] fmd: 10G Tx ECC erratum workaround must run after
 tgec_init()

The 10G Tx ECC interface erratum workaround must be performed
after tgec_init() and also after the interrupt handlers are
registered.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 .../dpa/NetCommSw/Peripherals/FM/MAC/tgec.c        |   24 ++++++++++----------
 1 file changed, 12 insertions(+), 12 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/tgec.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/tgec.c
index 6e4b5e3..1f1fbec 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/tgec.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/tgec.c
@@ -785,18 +785,6 @@ static t_Error TgecInit(t_Handle h_Tgec)
     FM_GetRevision(p_Tgec->fmMacControllerDriver.h_Fm, &p_Tgec->fmMacControllerDriver.fmRevInfo);
     CHECK_INIT_PARAMETERS(p_Tgec, CheckInitParameters);
 
-#ifdef FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
-    if (p_Tgec->fmMacControllerDriver.fmRevInfo.majorRev <= 6 /*fixed for rev3 */)
-    {
-        if (!p_Tgec->p_TgecDriverParam->skip_fman11_workaround &&
-            ((err = TgecTxEccWorkaround(p_Tgec)) != E_OK))
-        {
-            FreeInitResources(p_Tgec);
-            RETURN_ERROR(MAJOR, err, ("TgecTxEccWorkaround FAILED"));
-        }
-    }
-#endif /* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
-
     p_TgecDriverParam = p_Tgec->p_TgecDriverParam;
 
     MAKE_ENET_ADDR_FROM_UINT64(p_Tgec->addr, ethAddr);
@@ -861,6 +849,18 @@ static t_Error TgecInit(t_Handle h_Tgec)
     else if (p_Tgec->mdioIrq == 0)
         REPORT_ERROR(MINOR, E_NOT_SUPPORTED, (NO_MSG));
 
+#ifdef FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
+    if (p_Tgec->fmMacControllerDriver.fmRevInfo.majorRev <= 6 /*fixed for rev3 */)
+    {
+        if (!p_Tgec->p_TgecDriverParam->skip_fman11_workaround &&
+            ((err = TgecTxEccWorkaround(p_Tgec)) != E_OK))
+        {
+            FreeInitResources(p_Tgec);
+            RETURN_ERROR(MAJOR, err, ("TgecTxEccWorkaround FAILED"));
+        }
+    }
+#endif /* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
+
     XX_Free(p_TgecDriverParam);
     p_Tgec->p_TgecDriverParam = NULL;
 
-- 
1.7.9.7

