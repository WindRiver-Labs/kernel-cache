From 9adc3e805de6a8234b7730a88d5dd182465c34fb Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Tue, 30 Oct 2012 11:01:20 +0200
Subject: [PATCH 117/227] fmd: add function to set loopback for MEMAC
 interfaces

Added memac_set_loopback() to allow enabling/disabling
loopback at runtime for MEMAC interfaces.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 .../dpa/NetCommSw/Peripherals/FM/MAC/fman_memac.c  |   14 ++++++++++++++
 .../NetCommSw/Peripherals/FM/MAC/fsl_fman_memac.h  |    1 +
 2 files changed, 15 insertions(+)

diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/fman_memac.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/fman_memac.c
index d56b987..b8fc3c9 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/fman_memac.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/fman_memac.c
@@ -254,6 +254,20 @@ void memac_set_rx_ignore_pause_frames(struct memac_regs    *regs,bool enable)
     iowrite32be(tmp, &regs->command_config);
 }
 
+void memac_set_loopback(struct memac_regs *regs, bool enable)
+{
+    uint32_t tmp;
+
+    tmp = ioread32be(&regs->command_config);
+
+    if (enable)
+        tmp |= CMD_CFG_LOOPBACK_EN;
+    else
+        tmp &= ~CMD_CFG_LOOPBACK_EN;
+
+    iowrite32be(tmp, &regs->command_config);
+}
+
 #define GET_MEMAC_CNTR_64(bn) \
     (((uint64_t)ioread32be(&regs->bn ## _u) << 32) | \
             ioread32be(&regs->bn ## _l))
diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/fsl_fman_memac.h b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/fsl_fman_memac.h
index 515dbfc..2cba486 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/fsl_fman_memac.h
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/fsl_fman_memac.h
@@ -378,6 +378,7 @@ void memac_reset_counter(struct memac_regs *regs);
 void memac_reset(struct memac_regs *regs);
 void memac_set_hash_table(struct memac_regs *regs, uint32_t val);
 void memac_set_rx_ignore_pause_frames(struct memac_regs  *regs,bool enable);
+void memac_set_loopback(struct memac_regs *regs, bool enable);
 void memac_reset_counter(struct memac_regs *regs);
 
 
-- 
1.7.9.7

