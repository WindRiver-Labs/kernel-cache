From 7666edddcf4f9a042cc69f303d84db39a8d93038 Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Wed, 5 Dec 2012 18:36:18 -0600
Subject: [PATCH 222/227] powerpc/e6500: fully disable threads

smt-enabled=off doesn't actually stop the secondary thread from being
enabled, as that's done early in a hard-coded way.  This is a hack to
prevent that from happening with minimal side effects.

With this patch, if CONFIG_PPC_DISABLE_THREADS=y, threads are
unconditionally disabled, without regard to the kernel command line.  If
you want to enable threads, you must build with
CONFIG_PPC_DISABLE_THREADS=n.

Signed-off-by: Scott Wood <scottwood@freescale.com>
Signed-off-by: Andy Fleming <afleming@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/exceptions-64e.S   |    2 ++
 arch/powerpc/kernel/setup_64.c         |    5 ++++-
 arch/powerpc/platforms/Kconfig.cputype |    8 +++++++-
 3 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/kernel/exceptions-64e.S b/arch/powerpc/kernel/exceptions-64e.S
index 88860ed..8e0141b 100644
--- a/arch/powerpc/kernel/exceptions-64e.S
+++ b/arch/powerpc/kernel/exceptions-64e.S
@@ -1381,6 +1381,7 @@ BEGIN_FTR_SECTION
 	andi.	r3,r3,2
 	bne	1b
 
+#ifndef CONFIG_PPC_DISABLE_THREADS
 	/* Configure the MSR per the default */
 	LOAD_REG_IMMEDIATE(r3, MSR_KERNEL);
 	MTTMR(TMRN_IMSR1, 3);
@@ -1395,6 +1396,7 @@ BEGIN_FTR_SECTION
 	/* Release the other thread. It will spin until kick_cpu is called */
 	li	r3, 2
 	mtspr	SPRN_TENS, r3
+#endif
 END_FTR_SECTION_IFSET(CPU_FTR_SMT)
 
 	blr
diff --git a/arch/powerpc/kernel/setup_64.c b/arch/powerpc/kernel/setup_64.c
index 60d7afc..192aa59 100644
--- a/arch/powerpc/kernel/setup_64.c
+++ b/arch/powerpc/kernel/setup_64.c
@@ -129,6 +129,9 @@ static void setup_tlb_per_core(void)
 /* Look for ibm,smt-enabled OF option */
 static void check_smt_enabled(void)
 {
+#ifdef CONFIG_PPC_DISABLE_THREADS
+	smt_enabled_at_boot = 0;
+#else
 	struct device_node *dn;
 	const char *smt_option;
 
@@ -166,7 +169,7 @@ static void check_smt_enabled(void)
 			of_node_put(dn);
 		}
 	}
-
+#endif
 	setup_tlb_per_core();
 }
 
diff --git a/arch/powerpc/platforms/Kconfig.cputype b/arch/powerpc/platforms/Kconfig.cputype
index 2049cd7..0237166 100644
--- a/arch/powerpc/platforms/Kconfig.cputype
+++ b/arch/powerpc/platforms/Kconfig.cputype
@@ -148,9 +148,15 @@ config PPC_E6500_REV1_BUGS
           Do not define this if you are running on a simulator or rev2,
           and want features like hardware tablewalk.
 
+config PPC_DISABLE_THREADS
+	bool "Avoid the use of hardware threads"
+	help
+	  Define this if running e6500 rev1 to avoid bugs
+	  relating to hardware threads.
+
 config FSL_ERRATUM_A_006198
 	bool "Work around e6500 rev1 erratum A-006198"
-	depends on PPC_E500MC
+	depends on PPC_E500MC && !PPC_DISABLE_THREADS
 	help
 	  Define this if running e6500 rev1, to avoid a source
 	  of hangs due to CPU erratum A-006198.
-- 
1.7.9.7

