From 34af584710e9361252d00568d67956e0515424b2 Mon Sep 17 00:00:00 2001
From: Shengzhou Liu <Shengzhou.Liu@freescale.com>
Date: Thu, 15 Nov 2012 19:35:57 +0000
Subject: [PATCH 155/227] dpaa: fix kernel crash due to fsl_pq_mdio_lock

when using FMANv3, it uses mEMAC MDIO driver instead of fsl_pq_mdio
driver, so fsl_pq_mdio_bus->priv->mdio_lock will never be initialized.
Currently just the previous version of FMAN support TBI PHY
autonegotiation restart when lost link.

Unable to handle kernel paging request for data at address 0x00000020
Faulting instruction address: 0xc000000000444c48
Oops: Kernel access of bad area, sig: 11 [#1]
SMP NR_CPUS=24 T4240 QDS
Modules linked in:
NIP: c000000000444c48 LR: c00000000043f578 CTR: c00000000043f4f0
REGS: c00000017b507920 TRAP: 0300   Not tainted  (3.0.51-rt75-01706-g517fa10-dirty)
MSR: 0000000080029000 <EE,ME,CE>  CR: 24042022  XER: 00000000
DEAR: 0000000000000020, ESR: 0000000000000000
TASK = c00000017b503300[77] 'kworker/12:1' THREAD: c00000017b504000 CPU: 12
GPR00: c00000000043f578 c00000017b507ba0 c0000000009927e0 0000000000000000
GPR04: 0000000080029000 c0000000095c0448 0000000000000000 0000000000000001
GPR08: 0000000000000007 0000000000000000 c000000000999ea0 0000000000000000
GPR12: 0000000024042022 c00000000fffd000 000000007fb4ad68 0000000000000000
GPR16: 000000007fb4ae58 0000000000000000 0000000000000000 0000000000000000
GPR20: 000000007ffb0c24 000000007ffb09f4 000000007ff993ba 0000000000000000
GPR24: 0000000000000001 0000000000000000 0000000000000000 0000000000000000
GPR28: c00000017807cc00 c00000017807ce68 c0000000009147f8 c000000178167e18
NIP [c000000000444c48] .fsl_pq_mdio_lock+0x48/0x70
LR [c00000000043f578] .adjust_link+0x88/0x130

Signed-off-by: Shengzhou Liu <Shengzhou.Liu@freescale.com>
Signed-off-by: Andy Fleming <afleming@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/mac-api.c |    4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/mac-api.c b/drivers/net/ethernet/freescale/dpa/mac-api.c
index ab9ee76..e588b0f 100644
--- a/drivers/net/ethernet/freescale/dpa/mac-api.c
+++ b/drivers/net/ethernet/freescale/dpa/mac-api.c
@@ -430,14 +430,14 @@ static void adjust_link(struct net_device *net_dev)
 	t_Error	 err;
 
 	if (!phy_dev->link) {
-
+#if (DPAA_VERSION < 11)
 		fsl_pq_mdio_lock(NULL);
 
 		mac_priv = (struct mac_priv_s *)macdev_priv(mac_dev);
 		DtsecRestartTbiAN(mac_priv->mac);
 
 		fsl_pq_mdio_unlock(NULL);
-
+#endif
 		return;
 	}
 
-- 
1.7.9.7

