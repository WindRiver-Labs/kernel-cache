From e10c0b173a6f9f773ec6439e908cb75d21dff756 Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Tue, 12 Jun 2012 04:53:30 +0000
Subject: [PATCH 036/227] powerpc/e6500: kconfigize hw tablewalk and other
 rev1 bugs

Signed-off-by: Scott Wood <scottwood@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/mm/tlb_nohash.c           |    4 +---
 arch/powerpc/platforms/Kconfig.cputype |    9 +++++++++
 2 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/mm/tlb_nohash.c b/arch/powerpc/mm/tlb_nohash.c
index 616b79d..747cd7b 100644
--- a/arch/powerpc/mm/tlb_nohash.c
+++ b/arch/powerpc/mm/tlb_nohash.c
@@ -27,8 +27,6 @@
  *
  */
 
-//#define CONFIG_PPC_FSL_BUGGY_HW_TABLEWALK
-
 #include <linux/kernel.h>
 #include <linux/export.h>
 #include <linux/mm.h>
@@ -467,7 +465,7 @@ static void setup_page_sizes(void)
 		tlb1ps = mfspr(SPRN_TLB1PS);
 		eptcfg = mfspr(SPRN_EPTCFG);
 
-#ifndef CONFIG_PPC_FSL_BUGGY_HW_TABLEWALK
+#ifndef CONFIG_PPC_E6500_REV1_BUGS
 		if ((tlb1cfg & TLBnCFG_IND) && (tlb0cfg & TLBnCFG_PT))
 			book3e_htw_mode = PPC_HTW_FSL;
 
diff --git a/arch/powerpc/platforms/Kconfig.cputype b/arch/powerpc/platforms/Kconfig.cputype
index 425db18..eb74cf7 100644
--- a/arch/powerpc/platforms/Kconfig.cputype
+++ b/arch/powerpc/platforms/Kconfig.cputype
@@ -139,6 +139,15 @@ config PPC_E500MC
 	select PPC_FPU
 	depends on E500
 
+config PPC_E6500_REV1_BUGS
+	bool "Work around e6500 rev1 bugs"
+	depends on PPC_E500MC
+	help
+	  Define this if you need to be able to run on rev1 silicon.
+
+          Do not define this if you are running on a simulator or rev2,
+          and want features like hardware tablewalk.
+
 config PPC_FPU
 	bool
 	default y if PPC64
-- 
1.7.9.7

