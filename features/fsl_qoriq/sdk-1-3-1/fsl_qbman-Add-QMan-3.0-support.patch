From c50a375425ed8af54115da7e91d727f31dd29850 Mon Sep 17 00:00:00 2001
From: Hai-Ying Wang <Haiying.Wang@freescale.com>
Date: Wed, 25 Apr 2012 22:14:53 +0000
Subject: [PATCH 005/227] fsl_qbman: Add QMan 3.0 support

Signed-off-by: Haiying Wang <Haiying.Wang@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/staging/fsl_qbman/qman_config.c  |    4 ++--
 drivers/staging/fsl_qbman/qman_driver.c  |    2 ++
 drivers/staging/fsl_qbman/qman_private.h |    1 +
 3 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_qbman/qman_config.c b/drivers/staging/fsl_qbman/qman_config.c
index a7e8000..a13de15 100644
--- a/drivers/staging/fsl_qbman/qman_config.c
+++ b/drivers/staging/fsl_qbman/qman_config.c
@@ -514,7 +514,6 @@ static int qm_init_pfdr(struct qman *qm, u32 pfdr_start, u32 num)
 	qm_out(MCP(1), (pfdr_start + num - 16));
 	lwsync();
 	qm_out(MCR, MCR_INIT_PFDR);
-
 	/* Poll for the result */
 	do {
 		rslt = MCR_get_rslt(qm_in(MCR));
@@ -613,7 +612,6 @@ static int __init fsl_qman_init(struct device_node *node)
 	int ret, standby = 0;
 	u16 id;
 	u8 major, minor;
-
 	ret = of_address_to_resource(node, 0, &res);
 	if (ret) {
 		pr_err("Can't get %s property '%s'\n", node->full_name, "reg");
@@ -649,6 +647,8 @@ static int __init fsl_qman_init(struct device_node *node)
 			qman_ip_rev = QMAN_REV12;
 		else if ((major == 2) && (minor == 0))
 			qman_ip_rev = QMAN_REV20;
+		else if ((major == 3) && (minor == 0))
+			qman_ip_rev = QMAN_REV30;
 		else {
 			pr_warning("unknown Qman version, default to rev1.1\n");
 			qman_ip_rev = QMAN_REV11;
diff --git a/drivers/staging/fsl_qbman/qman_driver.c b/drivers/staging/fsl_qbman/qman_driver.c
index d96e61e..83a6563 100644
--- a/drivers/staging/fsl_qbman/qman_driver.c
+++ b/drivers/staging/fsl_qbman/qman_driver.c
@@ -165,6 +165,8 @@ static struct qm_portal_config * __init parse_pcfg(struct device_node *node)
 		ip_rev = QMAN_REV12;
 	else if (of_device_is_compatible(node, "fsl,qman-portal-2.0"))
 		ip_rev = QMAN_REV20;
+	else if (of_device_is_compatible(node, "fsl,qman-portal-3.0"))
+		ip_rev = QMAN_REV30;
 
 	if (!qman_ip_rev) {
 		if (ip_rev)
diff --git a/drivers/staging/fsl_qbman/qman_private.h b/drivers/staging/fsl_qbman/qman_private.h
index 915b2c0..2880319 100644
--- a/drivers/staging/fsl_qbman/qman_private.h
+++ b/drivers/staging/fsl_qbman/qman_private.h
@@ -127,6 +127,7 @@ struct qm_portal_config {
 #define QMAN_REV11 0x0101
 #define QMAN_REV12 0x0102
 #define QMAN_REV20 0x0200
+#define QMAN_REV30 0x0300
 extern u16 qman_ip_rev; /* 0 if uninitialised, otherwise QMAN_REVx */
 
 #ifdef CONFIG_FSL_QMAN_CONFIG
-- 
1.7.9.7

