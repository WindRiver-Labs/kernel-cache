From 6b885486c4041dfb910fdcd110e001e3936dbe12 Mon Sep 17 00:00:00 2001
From: Shengzhou Liu <Shengzhou.Liu@freescale.com>
Date: Thu, 15 Nov 2012 19:35:52 +0000
Subject: [PATCH 150/227] t4240qds/dts: add MDIO support for Ethernet on
 t4240qds

Add support for the muxing MDIO buses on the T4240QDS.
The MDIO nodes are used for the RGMII ports and each slot that
can hold an SGMII, XAUI.  U-Boot will dynamically update the
phy-handle pointers and node status of related slots according
to different serdes protocols and the presence of cards in slots.

Signed-off-by: Shengzhou Liu <Shengzhou.Liu@freescale.com>
Signed-off-by: Andy Fleming <afleming@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/boot/dts/t4240qds.dts |  258 +++++++++++++++++++++++++++++++-----
 1 file changed, 228 insertions(+), 30 deletions(-)

diff --git a/arch/powerpc/boot/dts/t4240qds.dts b/arch/powerpc/boot/dts/t4240qds.dts
index 4854c26..c208c36 100644
--- a/arch/powerpc/boot/dts/t4240qds.dts
+++ b/arch/powerpc/boot/dts/t4240qds.dts
@@ -41,6 +41,25 @@
 	#size-cells = <2>;
 	interrupt-parent = <&mpic>;
 
+	aliases {
+		phy_rgmii1 = &phyrgmii1;
+		phy_rgmii2 = &phyrgmii2;
+		phy_sgmii3 = &phy3;
+		phy_sgmii4 = &phy4;
+		phy_sgmii11 = &phy11;
+		phy_sgmii12 = &phy12;
+		emi1_rgmii = &t4240mdio0;
+		emi1_slot1 = &t4240mdio1;
+		emi1_slot2 = &t4240mdio2;
+		emi1_slot3 = &t4240mdio3;
+		emi1_slot4 = &t4240mdio4;
+		emi2_xauislot1 = &t4240xmdio1;
+		emi2_xauislot2 = &t4240xmdio2;
+		emi2_xauislot3 = &t4240xmdio3;
+		emi2_xauislot4 = &t4240xmdio4;
+		emi2_xfislot3 = &t4240xmdio3_xfi;
+	};
+
 	ifc: localbus@ffe124000 {
 		reg = <0xf 0xfe124000 0 0x2000>;
 		ranges = <0 0 0xf 0xe8000000 0x08000000
@@ -91,7 +110,7 @@
 		};
 
 		board-control@3,0 {
-			compatible = "fsl,t4240qds-fpga", "fsl,fpga-qixis";
+			compatible = "fsl,tetra-fpga", "fsl,fpga-qixis";
 			reg = <3 0 0x300>;
 		};
 	};
@@ -157,39 +176,55 @@
 			};
 		};
 
-		 fman0: fman@400000 {
+		fman0: fman@400000 {
 			enet0: ethernet@e0000 {
-				fixed-link = <1 1 1000 0 0 >;
+				phy-handle = <&phy5>;
 				phy-connection-type = "sgmii";
 			};
+
 			enet1: ethernet@e2000 {
-				fixed-link = <2 1 1000 0 0 >;
+				phy-handle = <&phy6>;
 				phy-connection-type = "sgmii";
 			};
+
 			enet2: ethernet@e4000 {
-				fixed-link = <3 1 1000 0 0 >;
+				phy-handle = <&phy7>;
 				phy-connection-type = "sgmii";
 			};
+
 			enet3: ethernet@e6000 {
-				fixed-link = <4 1 1000 0 0 >;
+				phy-handle = <&phy8>;
 				phy-connection-type = "sgmii";
 			};
+
 			enet4: ethernet@e8000 {
-				fixed-link = <5 1 1000 0 0 >;
-				phy-connection-type = "sgmii";
+				phy-handle = <&phyrgmii2>;
+				phy-connection-type = "rgmii";
 			};
+
 			enet5: ethernet@ea000 {
-				fixed-link = <6 1 1000 0 0 >;
+				phy-handle = <&phy2>;
 				phy-connection-type = "sgmii";
 			};
-			enet6: ethernet@f0000 {
-				fixed-link = <7 1 10000 0 0 >;
+
+			enet6: ethernet@f0000 { /* FM1@TSEC9/FM1@TGEC1 */
+				phy-handle = <&xauiphy1>;
 				phy-connection-type = "xgmii";
 			};
-			enet7: ethernet@f2000 {
-				fixed-link = <8 1 10000 0 0 >;
+
+			enet7: ethernet@f2000 { /* FM1@TSEC10/FM1@TGEC2 */
+				phy-handle = <&xauiphy2>;
 				phy-connection-type = "xgmii";
 			};
+
+			mdio@fc000 {
+				status = "disabled";
+			};
+
+			xmdio@fd000 {
+				status = "disabled";
+			};
+
 			fman0_oh2 {
 				status = "disabled";
 			};
@@ -206,46 +241,215 @@
 				status = "disabled";
 			};
 		};
+
 		fman1: fman@500000 {
 			enet8: ethernet@e0000 {
-				fixed-link = <11 1 1000 0 0 >;
+				phy-handle = <&phy13>;
 				phy-connection-type = "sgmii";
 			};
 
 			enet9: ethernet@e2000 {
-				fixed-link = <12 1 1000 0 0 >;
+				phy-handle = <&phy14>;
 				phy-connection-type = "sgmii";
 			};
 
 			enet10: ethernet@e4000 {
-				fixed-link = <13 1 1000 0 0 >;
+				phy-handle = <&phy15>;
 				phy-connection-type = "sgmii";
 			};
 
 			enet11: ethernet@e6000 {
-				fixed-link = <14 1 1000 0 0 >;
+				phy-handle = <&phy16>;
 				phy-connection-type = "sgmii";
 			};
 
 			enet12: ethernet@e8000 {
-				fixed-link = <15 1 1000 0 0 >;
-				phy-connection-type = "sgmii";
+				phy-handle = <&phyrgmii1>;
+				phy-connection-type = "rgmii";
 			};
 
 			enet13: ethernet@ea000 {
-				fixed-link = <16 1 1000 0 0 >;
+				phy-handle = <&phy10>;
 				phy-connection-type = "sgmii";
 			};
 
-			enet14: ethernet@f0000 {
-				fixed-link = <17 1 10000 0 0 >;
+			enet14: ethernet@f0000 { /* FM2@TSEC9/FM2@TGEC1 */
+				phy-handle = <&xauiphy3>;
 				phy-connection-type = "xgmii";
 			};
 
-			enet15: ethernet@f2000 {
-				fixed-link = <18 1 10000 0 0 >;
+			enet15: ethernet@f2000 { /* FM2@TSEC10/FM2@TGEC2 */
+				phy-handle = <&xauiphy4>;
 				phy-connection-type = "xgmii";
 			};
+
+			mdio0: mdio@fc000 {
+				/* For 10g interfaces */
+				t4240mdio0: mdio_onboard {
+					#address-cells = <1>;
+					#size-cells = <0>;
+					compatible = "fsl,tetra-mdio";
+					fsl,mdio-handle = <&mdio0>;
+					fsl,mdio-muxval = <0>;
+
+					phyrgmii1: ethernet-phy@1 { /* FM2.5 */
+						reg = <0x1>;
+					};
+					phyrgmii2: ethernet-phy@2 { /* FM1.5 */
+						reg = <0x2>;
+					};
+				};
+
+				t4240mdio1: mdio-slot1 {
+					#address-cells = <1>;
+					#size-cells = <0>;
+					compatible = "fsl,tetra-mdio";
+					fsl,mdio-handle = <&mdio0>;
+					fsl,mdio-muxval = <1>;
+					status = "disabled";
+
+					phy1: ethernet-phy@1c {
+						reg = <0x1c>;
+					};
+					phy2: ethernet-phy@1d {
+						reg = <0x1d>;
+					};
+					phy3: ethernet-phy@1e {
+						reg = <0x1e>;
+					};
+					phy4: ethernet-phy@1f {
+						reg = <0x1f>;
+					};
+				};
+
+				t4240mdio2: mdio-slot2 {
+					#address-cells = <1>;
+					#size-cells = <0>;
+					compatible = "fsl,tetra-mdio";
+					fsl,mdio-handle = <&mdio0>;
+					fsl,mdio-muxval = <2>;
+					status = "disabled";
+
+					phy5: ethernet-phy@1c {
+						reg = <0x1c>;
+					};
+					phy6: ethernet-phy@1d {
+						reg = <0x1d>;
+					};
+					phy7: ethernet-phy@1e {
+						reg = <0x1e>;
+					};
+					phy8: ethernet-phy@1f {
+						reg = <0x1f>;
+					};
+				};
+
+				t4240mdio3: mdio-slot3 {
+					#address-cells = <1>;
+					#size-cells = <0>;
+					compatible = "fsl,tetra-mdio";
+					fsl,mdio-handle = <&mdio0>;
+					fsl,mdio-muxval = <3>;
+					status = "disabled";
+
+					phy9: ethernet-phy@1c {
+						reg = <0x1c>;
+					};
+					phy10: ethernet-phy@1d {
+						reg = <0x1d>;
+					};
+					phy11: ethernet-phy@1e {
+						reg = <0x1e>;
+					};
+					phy12: ethernet-phy@1f {
+						reg = <0x1f>;
+					};
+				};
+
+				t4240mdio4: mdio-slot4 {
+					#address-cells = <1>;
+					#size-cells = <0>;
+					compatible = "fsl,tetra-mdio";
+					fsl,mdio-handle = <&mdio0>;
+					fsl,mdio-muxval = <4>;
+					status = "disabled";
+
+					phy13: ethernet-phy@1c {
+						reg = <0x1c>;
+					};
+					phy14: ethernet-phy@1d {
+						reg = <0x1d>;
+					};
+					phy15: ethernet-phy@1e {
+						reg = <0x1e>;
+					};
+					phy16: ethernet-phy@1f {
+						reg = <0x1f>;
+					};
+				};
+			};
+
+			xmdio0: xmdio@fd000 {
+				/* For 10g interfaces */
+				t4240xmdio1: xmdio-slot1 {
+					#address-cells = <1>;
+					#size-cells = <0>;
+					compatible = "fsl,tetra-mdio";
+					fsl,mdio-handle = <&xmdio0>;
+					fsl,mdio-muxval = <8>;
+
+					xauiphy1: ethernet-phy@0 {
+						reg = <0x0>;
+					};
+				};
+
+				t4240xmdio2: xmdio-slot2 {
+					#address-cells = <1>;
+					#size-cells = <0>;
+					compatible = "fsl,tetra-mdio";
+					fsl,mdio-handle = <&xmdio0>;
+					fsl,mdio-muxval = <8>;
+
+					xauiphy2: ethernet-phy@1 {
+						reg = <0x1>;
+					};
+				};
+
+				t4240xmdio3: xmdio-slot3 {
+					#address-cells = <1>;
+					#size-cells = <0>;
+					compatible = "fsl,tetra-mdio";
+					fsl,mdio-handle = <&xmdio0>;
+					fsl,mdio-muxval = <8>;
+
+					xauiphy3: ethernet-phy@2 {
+						reg = <0x2>;
+					};
+				};
+
+				t4240xmdio4: xmdio-slot4 {
+					#address-cells = <1>;
+					#size-cells = <0>;
+					compatible = "fsl,tetra-mdio";
+					fsl,mdio-handle = <&xmdio0>;
+					fsl,mdio-muxval = <8>;
+
+					xauiphy4: ethernet-phy@3 {
+						reg = <0x3>;
+					};
+				};
+
+				t4240xmdio3_xfi: xmdio_xfi_slot3 {
+					#address-cells = <1>;
+					#size-cells = <0>;
+					compatible = "fsl,tetra-mdio";
+					fsl,mdio-handle = <&xmdio0>;
+					fsl,mdio-muxval = <8>;
+					status = "disabled";
+
+				};
+			};
+
 			fman1_oh2 {
 				status = "disabled";
 			};
@@ -359,7 +563,6 @@
 		ethernet@4 {
 			compatible = "fsl,t4240-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet4>;
-			status = "disabled";
 		};
 		ethernet@5 {
 			compatible = "fsl,t4240-dpa-ethernet", "fsl,dpa-ethernet";
@@ -376,27 +579,22 @@
 		ethernet@8 {
 			compatible = "fsl,t4240-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet8>;
-			status = "disabled";
 		};
 		ethernet@9 {
 			compatible = "fsl,t4240-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet9>;
-			status = "disabled";
 		};
 		ethernet@10 {
 			compatible = "fsl,t4240-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet10>;
-			status = "disabled";
 		};
 		ethernet@11 {
 			compatible = "fsl,t4240-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet11>;
-			status = "disabled";
 		};
 		ethernet@12 {
 			compatible = "fsl,t4240-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet12>;
-			status = "disabled";
 		};
 		ethernet@13 {
 			compatible = "fsl,t4240-dpa-ethernet", "fsl,dpa-ethernet";
-- 
1.7.9.7

