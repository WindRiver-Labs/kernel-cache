From 29b19809ac15485c8f8995c6b5f4a5f4878658e4 Mon Sep 17 00:00:00 2001
From: Cristian Sovaiala <cristian.sovaiala@freescale.com>
Date: Fri, 12 Oct 2012 20:00:51 +0000
Subject: [PATCH 098/227] dpaa_eth: Disable recycling on FMan v3 based
 platforms

With FMan v3, recycling can only be made on a per queue basis
instead of per frame, so the existing mechanism can no longer
be used.
Temporarily disabling the recycling mechanism on T4/B4 platforms
until a new mechanism will be implemented according to the
constraints imposed by FMan v3.

Signed-off-by: Cristian Sovaiala <cristian.sovaiala@freescale.com>
Signed-off-by: Andy Fleming <afleming@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c    |    4 ++++
 drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c |    5 +++++
 2 files changed, 9 insertions(+)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 00eb051..e274086 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -1849,6 +1849,10 @@ int __hot dpa_tx(struct sk_buff *skb, struct net_device *net_dev)
 		goto fd_create_failed;
 	}
 
+#if (DPAA_VERSION >= 11)
+	fd.cmd &= ~FM_FD_CMD_FCO;
+#endif
+
 	if (fd.cmd & FM_FD_CMD_FCO) {
 		/* This skb is recycleable, and the fd generated from it
 		 * has been filled in accordingly */
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c
index 96890c3..63f0f63 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c
@@ -824,6 +824,11 @@ int __hot dpa_tx(struct sk_buff *skb, struct net_device *net_dev)
 		dev_kfree_skb(skb);
 		return NETDEV_TX_OK;
 	}
+
+#if (DPAA_VERSION >= 11)
+	fd.cmd &= ~FM_FD_CMD_FCO;
+#endif
+
 	if (fd.cmd & FM_FD_CMD_FCO) {
 		/*
 		 * Need to free the skb, but without releasing
-- 
1.7.9.7

