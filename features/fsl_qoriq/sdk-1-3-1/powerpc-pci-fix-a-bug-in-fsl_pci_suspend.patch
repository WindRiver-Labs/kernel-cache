From 261469469c5cb7465ea0e8752d304831bf1f7629 Mon Sep 17 00:00:00 2001
From: Chen-Hui Zhao <chenhui.zhao@freescale.com>
Date: Tue, 27 Nov 2012 16:36:58 +0000
Subject: [PATCH 188/227] powerpc/pci: fix a bug in fsl_pci_suspend()

When testing the sleep feature, the kernel outputs an error info.

  Oops: Kernel access of bad area, sig: 11 [#1]
  SMP NR_CPUS=8 P5040 DS
  Modules linked in:
  NIP: c001da6c LR: c001db88 CTR: 00000005
  REGS: eebf7c70 TRAP: 0300   Not tainted
  (3.0.51-rt75-01729-g8830417-dirty)
  MSR: 00029002 <EE,ME,CE>  CR: 22442428  XER: 00000000
  DEAR: f1084000, ESR: 00000000
  TASK = ee2d3030[1431] 'sh' THREAD: eebf6000 CPU: 1
  GPR00: 00000005 eebf7d20 ee2d3030 eebe1a80 000000d0 00000000 00000002
  eebf7c88
  GPR08: f1084000 00000000 eebe1a80 eebe1a80 24442482 100fa1a4 00000000
  00000000
  GPR16: 100f2834 c0248fac c051a310 c0550000 00000000 c0520000 c0552680
  c0526eb4
  GPR24: c0526ebc ee0c9468 c03d2ba0 c03d2b9c 00000000 ee0c9400 f106c000
  c055a140
  NIP [c001da6c] fsl_pci_suspend+0xcc/0x21c
  LR [c001db88] fsl_pci_suspend+0x1e8/0x21c
  Call Trace:
  [eebf7d20] [c001db88] fsl_pci_suspend+0x1e8/0x21c (unreliable)
  [eebf7d40] [c0244e6c] platform_pm_suspend+0x78/0x80
  [eebf7d50] [c0248c08] pm_op.isra.11+0x94/0x108
  [eebf7d80] [c0248ecc] __device_suspend+0xb8/0x198
  [eebf7dc0] [c0249c0c] dpm_suspend+0x7c/0x1cc
  [eebf7e20] [c024a014] dpm_suspend_start+0x38/0x4c
  [eebf7e40] [c006fc94] suspend_devices_and_enter+0x8c/0x214
  [eebf7e70] [c006ff00] enter_state+0xe4/0x110
  [eebf7e90] [c006f3d0] state_store+0xac/0x100
  [eebf7eb0] [c01e5af4] kobj_attr_store+0x24/0x3c
  [eebf7ec0] [c011da54] sysfs_write_file+0xf8/0x198
  [eebf7ef0] [c00c5154] vfs_write+0xa8/0x184
  [eebf7f10] [c00c548c] sys_write+0x4c/0x8c
  [eebf7f40] [c000eaf4] ret_from_syscall+0x0/0x3c

This bug introduced by this commit:
commit ae7861a5813a5193cdd257157cf77001d16b5dcd
Author: Prabhakar Kushwaha <prabhakar@freescale.com>
Date:   Wed Oct 10 12:33:24 2012 +0000

    powerpc/pci:Use IP block rev reg instead of compatible in suspend

Signed-off-by: Zhao Chenhui <chenhui.zhao@freescale.com>
Signed-off-by: Andy Fleming <afleming@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/sysdev/fsl_pci.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/arch/powerpc/sysdev/fsl_pci.c b/arch/powerpc/sysdev/fsl_pci.c
index 37e5917..8a9e04a 100644
--- a/arch/powerpc/sysdev/fsl_pci.c
+++ b/arch/powerpc/sysdev/fsl_pci.c
@@ -1025,7 +1025,7 @@ static int fsl_pci_suspend(struct platform_device *pdev, pm_message_t state)
 		return -ENOMEM;
 	}
 	hose->pci_pow = (struct pci_outbound_window_regs *)
-				(void *)pci + PCI_POW_PIW_OFFSET;
+				((void *)pci + PCI_POW_PIW_OFFSET);
 
 	hose->pci_piw = (struct pci_inbound_window_regs *)
 		((void *)hose->pci_pow + PCI_POW_PIW_SIZE) - 1;
-- 
1.7.9.7

