From 0bc239d9df56f3fa16556b6cf72296a8770f9ef0 Mon Sep 17 00:00:00 2001
From: Hai-Ying Wang <Haiying.Wang@freescale.com>
Date: Thu, 22 Nov 2012 00:45:48 +0000
Subject: [PATCH 177/227] fsl_qman: fix QCSP_IO_CFG setting for QMan V3

and fix the name for the LIO_CFG_LIODN_MASK

Signed-off-by: Andy Fleming <afleming@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/staging/fsl_qbman/qman_config.c |   21 +++++++++++++++------
 1 file changed, 15 insertions(+), 6 deletions(-)

diff --git a/drivers/staging/fsl_qbman/qman_config.c b/drivers/staging/fsl_qbman/qman_config.c
index 8b16ca4..269b4ee 100644
--- a/drivers/staging/fsl_qbman/qman_config.c
+++ b/drivers/staging/fsl_qbman/qman_config.c
@@ -834,7 +834,7 @@ int qman_init_ccsr(struct device_node *node)
 	return 0;
 }
 
-#define PID_CFG_LIODN_MASK 0x0fff0000
+#define LIO_CFG_LIODN_MASK 0x0fff0000
 void qman_liodn_fixup(u16 channel)
 {
 	static int done;
@@ -849,11 +849,11 @@ void qman_liodn_fixup(u16 channel)
 	else
 		before = qm_in(QCSP_LIO_CFG(idx));
 	if (!done) {
-		liodn_offset = before & PID_CFG_LIODN_MASK;
+		liodn_offset = before & LIO_CFG_LIODN_MASK;
 		done = 1;
 		return;
 	}
-	after = (before & (~PID_CFG_LIODN_MASK)) | liodn_offset;
+	after = (before & (~LIO_CFG_LIODN_MASK)) | liodn_offset;
 	if ((qman_ip_rev & 0xFF00) >= QMAN_REV30)
 		qm_out(REV3_QCSP_LIO_CFG(idx), after);
 	else
@@ -868,9 +868,18 @@ int qman_set_sdest(u16 channel, unsigned int cpu_idx)
 
 	if (!qman_have_ccsr())
 		return -ENODEV;
-	before = qm_in(QCSP_IO_CFG(idx));
-	after = (before & (~IO_CFG_SDEST_MASK)) | (cpu_idx << 16);
-	qm_out(QCSP_IO_CFG(idx), after);
+
+	if ((qman_ip_rev & 0xFF00) >= QMAN_REV30) {
+		before = qm_in(REV3_QCSP_IO_CFG(idx));
+		/* Each pair of vcpu share the same SRQ(SDEST) */
+		cpu_idx /= 2;
+		after = (before & (~IO_CFG_SDEST_MASK)) | (cpu_idx << 16);
+		qm_out(REV3_QCSP_IO_CFG(idx), after);
+	} else {
+		before = qm_in(QCSP_IO_CFG(idx));
+		after = (before & (~IO_CFG_SDEST_MASK)) | (cpu_idx << 16);
+		qm_out(QCSP_IO_CFG(idx), after);
+	}
 	return 0;
 }
 
-- 
1.7.9.7

