From 0eb1b2afced0b0ed474b57ac39307bd5c9f73fb1 Mon Sep 17 00:00:00 2001
From: Chen-Hui Zhao <chenhui.zhao@freescale.com>
Date: Tue, 20 Nov 2012 18:15:20 +0000
Subject: [PATCH 168/227] powerpc: disable second thread of one core before
 enabling it on e6500

If Thead 1 of one core is enabled, Writing the INIA register of this
thread is ignored on e6500. Therefore, disable Thread 1 before
enabling it, especially in the case of the cpu hotplug.

In the cpu hotplug code, fsl_enable_threads() will be called to restart
Thread 1 of Core 0.

Signed-off-by: Zhao Chenhui <chenhui.zhao@freescale.com>
Signed-off-by: Li Yang <leoli@freescale.com>
Signed-off-by: Andy Fleming <afleming@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/exceptions-64e.S |    8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/arch/powerpc/kernel/exceptions-64e.S b/arch/powerpc/kernel/exceptions-64e.S
index a325602..9a19a8c 100644
--- a/arch/powerpc/kernel/exceptions-64e.S
+++ b/arch/powerpc/kernel/exceptions-64e.S
@@ -1371,6 +1371,14 @@ _GLOBAL(init_core_book3e)
 
 _GLOBAL(fsl_enable_threads)
 BEGIN_FTR_SECTION
+	/* Disable the other thread */
+	li	r3,2
+	mtspr	SPRN_TENC,r3
+
+1:	mfspr	r3,SPRN_TENSR
+	andi.	r3,r3,2
+	bne	1b
+
 	/* Configure the MSR per the default */
 	LOAD_REG_IMMEDIATE(r3, MSR_KERNEL);
 	MTTMR(TMRN_IMSR1, 3);
-- 
1.7.9.7

