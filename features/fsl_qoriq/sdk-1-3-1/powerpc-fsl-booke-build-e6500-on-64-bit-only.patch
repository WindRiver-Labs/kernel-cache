From d4ea92d8d6d92ea6ab7251b854e584f1db05d180 Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Tue, 2 Oct 2012 06:20:25 +0000
Subject: [PATCH 083/227] powerpc/fsl-booke: build e6500 on 64-bit only.

Fixes build break on 32-bit (undefined reference to
.setup_altivec_ivors).  We don't support this anyway as it lacks thread,
tablewalk, and altivec support.

Signed-off-by: Scott Wood <scottwood@freescale.com>
Signed-off-by: Andy Fleming <afleming@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/cpu_setup_fsl_booke.S |    2 ++
 arch/powerpc/kernel/cputable.c            |    4 ++--
 arch/powerpc/platforms/85xx/Kconfig       |    6 ++++++
 3 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/kernel/cpu_setup_fsl_booke.S b/arch/powerpc/kernel/cpu_setup_fsl_booke.S
index 4ff0127..c07d538 100644
--- a/arch/powerpc/kernel/cpu_setup_fsl_booke.S
+++ b/arch/powerpc/kernel/cpu_setup_fsl_booke.S
@@ -53,12 +53,14 @@ _GLOBAL(__e500_dcache_setup)
 	isync
 	blr
 
+#ifdef CONFIG_PPC_BOOK3E_64
 _GLOBAL(__setup_cpu_e6500)
 	mflr	r6
 	bl	.setup_altivec_ivors
 	bl	__setup_cpu_e5500
 	mtlr	r6
 	blr
+#endif
 
 #ifdef CONFIG_PPC32
 _GLOBAL(__setup_cpu_e200)
diff --git a/arch/powerpc/kernel/cputable.c b/arch/powerpc/kernel/cputable.c
index af9f4f6d..fbb0dd9 100644
--- a/arch/powerpc/kernel/cputable.c
+++ b/arch/powerpc/kernel/cputable.c
@@ -2050,6 +2050,7 @@ static struct cpu_spec __initdata cpu_specs[] = {
 		.machine_check		= machine_check_e500mc,
 		.platform		= "ppce5500",
 	},
+#ifndef CONFIG_PPC32
 	{	/* e6500 */
 		.pvr_mask		= 0xffff0000,
 		.pvr_value		= 0x80400000,
@@ -2065,12 +2066,11 @@ static struct cpu_spec __initdata cpu_specs[] = {
 		.oprofile_cpu_type	= "ppc/e6500",
 		.oprofile_type		= PPC_OPROFILE_FSL_EMB,
 		.cpu_setup		= __setup_cpu_e6500,
-#ifndef CONFIG_PPC32
 		.cpu_restore		= __restore_cpu_e6500,
-#endif
 		.machine_check		= machine_check_e500mc,
 		.platform		= "ppce6500",
 	},
+#endif
 #ifdef CONFIG_PPC32
 	{	/* default match */
 		.pvr_mask		= 0x00000000,
diff --git a/arch/powerpc/platforms/85xx/Kconfig b/arch/powerpc/platforms/85xx/Kconfig
index 2a49034..2c46278 100644
--- a/arch/powerpc/platforms/85xx/Kconfig
+++ b/arch/powerpc/platforms/85xx/Kconfig
@@ -272,6 +272,8 @@ config P4080_DS
 
 endif # PPC32
 
+if PPC64
+
 config B4860_QDS
 	bool "Freescale B4860 QDS"
 	select DEFAULT_UIMAGE
@@ -286,6 +288,8 @@ config B4860_QDS
 	help
 	  This option enables support for the B4860 QDS board
 
+endif
+
 config P5020_DS
 	bool "Freescale P5020 DS"
 	select DEFAULT_UIMAGE
@@ -326,6 +330,7 @@ config P5040_DS
 	  This option enables support for the Freescale P5040 DS
 	  ("Super Hydra") reference board.
 
+if PPC64
 config T4240_QDS
 	bool "Freescale T4240 QDS"
 	select DEFAULT_UIMAGE
@@ -348,6 +353,7 @@ config T4240_RLT_ERRATUM
 	   This will enable a workaround for restoring zombie
 	   RLT entries. Only enable on rev1 E6500 parts
 
+endif
 endif # FSL_SOC_BOOKE
 
 config FSL_P4080_DS_MDIO
-- 
1.7.9.7

