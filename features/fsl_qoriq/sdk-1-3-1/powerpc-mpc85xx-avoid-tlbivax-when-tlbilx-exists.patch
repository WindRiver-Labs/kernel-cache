From 246c55901d70a0cdc30388d946917a8c0a6cd5af Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Tue, 2 Oct 2012 06:01:07 +0000
Subject: [PATCH 082/227] powerpc/mpc85xx: avoid tlbivax when tlbilx exists

Erratum A-004827 means that tlbivax is unusable on some chips (e.g. b4420).

Signed-off-by: Scott Wood <scottwood@freescale.com>
Signed-off-by: Andy Fleming <afleming@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/fsl_booke_entry_mapping.S |   15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/arch/powerpc/kernel/fsl_booke_entry_mapping.S b/arch/powerpc/kernel/fsl_booke_entry_mapping.S
index a92c79b..9638e50 100644
--- a/arch/powerpc/kernel/fsl_booke_entry_mapping.S
+++ b/arch/powerpc/kernel/fsl_booke_entry_mapping.S
@@ -60,6 +60,10 @@ skpinv:	addi	r6,r6,1				/* Increment */
 	cmpw	r6,r9				/* Are we done? */
 	bne	1b				/* If not, repeat */
 
+#ifdef CONFIG_PPC_E500MC
+	/* Some chips can't handle tlbivax due to erratum A-004827 */
+	tlbilxlpid
+#else
 	/* Invalidate TLB0 */
 	li	r6,0x04
 	tlbivax 0,r6
@@ -68,6 +72,7 @@ skpinv:	addi	r6,r6,1				/* Increment */
 	li	r6,0x0c
 	tlbivax 0,r6
 	TLBSYNC
+#endif
 
 /* 3. Setup a temp mapping and jump to it */
 	andi.	r5, r3, 0x1	/* Find an entry not used and is non-zero */
@@ -147,10 +152,15 @@ skpinv:	addi	r6,r6,1				/* Increment */
 	rlwinm	r6,r6,0,2,0	/* clear IPROT */
 	mtspr	SPRN_MAS1,r6
 	tlbwe
+#ifdef CONFIG_PPC_E500MC
+	/* Some chips can't handle tlbivax due to erratum A-004827 */
+	tlbilxlpid
+#else
 	/* Invalidate TLB1 */
 	li	r9,0x0c
 	tlbivax 0,r9
 	TLBSYNC
+#endif
 
 /* The mapping only needs to be cache-coherent on SMP */
 #ifdef CONFIG_SMP
@@ -229,7 +239,12 @@ next_tlb_setup:
 	rlwinm	r8,r8,0,2,0	/* clear IPROT */
 	mtspr	SPRN_MAS1,r8
 	tlbwe
+#ifdef CONFIG_PPC_E500MC
+	/* Some chips can't handle tlbivax due to erratum A-004827 */
+	tlbilxlpid
+#else
 	/* Invalidate TLB1 */
 	li	r9,0x0c
 	tlbivax 0,r9
 	TLBSYNC
+#endif
-- 
1.7.9.7

