From c42f1c1e0a7e8f0bb12150c70357cb262cb0735f Mon Sep 17 00:00:00 2001
From: Hai-Ying Wang <Haiying.Wang@freescale.com>
Date: Thu, 17 May 2012 20:13:14 +0000
Subject: [PATCH 020/227] fsl_pamu: search all cpu threads under cpu node

Signed-off-by: Haiying Wang <Haiying.Wang@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/sysdev/fsl_pamu.c |   12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/sysdev/fsl_pamu.c b/arch/powerpc/sysdev/fsl_pamu.c
index 3d7836e..2bad955 100644
--- a/arch/powerpc/sysdev/fsl_pamu.c
+++ b/arch/powerpc/sysdev/fsl_pamu.c
@@ -439,6 +439,8 @@ int pamu_set_stash_dest(struct device_node *node, unsigned int index,
 	int liodn;
 	const u32 *prop;
 	unsigned int i;
+	int psize;
+
 #ifdef CONFIG_FSL_PAMU_ERRATUM_A_004510
 	/*
 	 * The work-around says that we cannot have multiple writes to the
@@ -456,9 +458,13 @@ int pamu_set_stash_dest(struct device_node *node, unsigned int index,
 		return liodn;
 
 	for_each_node_by_type(node, "cpu") {
-		prop = of_get_property(node, "reg", NULL);
-		if (prop && (be32_to_cpup(prop) == cpu))
-			goto found_cpu;
+		prop = of_get_property(node, "reg", &psize);
+		if (prop) {
+			psize /= 4;
+			for (i = 0; i < psize; i++)
+				if (be32_to_cpup(prop++) == cpu)
+					goto found_cpu;
+		}
 	}
 
 	pr_err("fsl-pamu: could not find 'cpu' node %u\n", cpu);
-- 
1.7.9.7

