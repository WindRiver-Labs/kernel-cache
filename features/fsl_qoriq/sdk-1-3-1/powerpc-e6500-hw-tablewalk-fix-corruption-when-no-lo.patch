From dd1d2d4127e734dba648c6730ac34a70b5f887b0 Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Sat, 9 Jun 2012 06:00:37 +0000
Subject: [PATCH 034/227] powerpc/e6500: hw tablewalk: fix corruption when no
 lock needed

If the low bit is not set, that indicates the need for a TLB miss lock,
the next tlb entry was written to the wrong byte, corrupting pgdir_kernel.

This can happen when there's a TLB miss before threading is started
(e.g. serial port MMIO), or if threading is disabled.

Signed-off-by: Scott Wood <scottwood@freescale.com>
[Kevin: Original patch taken from fsl sdk 1.3.1
QorIQ-SDK-V1.3.1-SOURCE-20121220-yocto.iso.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/mm/tlb_low_64e.S |    6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/mm/tlb_low_64e.S b/arch/powerpc/mm/tlb_low_64e.S
index 7bd27ca..1a52e02 100644
--- a/arch/powerpc/mm/tlb_low_64e.S
+++ b/arch/powerpc/mm/tlb_low_64e.S
@@ -350,8 +350,8 @@ tlb_miss_common_fsl_htw:
 
 
 	mfspr	r10,SPRN_MAS0
-	rldicr	r15,r11,0,62
-	lwz	r15,0(r15)
+	rldicr	r16,r11,0,62
+	lwz	r15,0(r16)
 
 	ori	r14,r14,(BOOK3E_PAGESZ_4K << MAS3_SPSIZE_SHIFT)
 	mtspr	SPRN_MAS7_MAS3,r14
@@ -365,7 +365,7 @@ tlb_miss_common_fsl_htw:
 	cmpw	r10,r14
 	rlwinm	r10,r15,24,0xff		/* extract first */
 	iseleq	r14,r10,r14		/* if next == last use first */
-	stb	r14,PACA_TLB_ESEL_NEXT-1(r11)
+	stb	r14,PACA_TLB_ESEL_NEXT(r16)
 
 	tlbwe
 
-- 
1.7.9.7

