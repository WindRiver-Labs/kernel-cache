From df6ca8af9976811cea4d854efc47cfe17cbfd7e8 Mon Sep 17 00:00:00 2001
From: Dong Aisheng <dong.aisheng@linaro.org>
Date: Wed, 11 Jul 2012 15:16:37 +1000
Subject: [PATCH] of/preempt-rt: Improve prom_update_property() function

This hunk comes from the commit:
[
Subject: of: Improve prom_update_property() function

commit 475d0094293b51353e342d1198377967dbc48169 upstream

prom_update_property() currently fails if the property doesn't
actually exist yet which isn't what we want. Change to add-or-update
instead of update-only, then we can remove a lot duplicated lines.

Suggested-by: Grant Likely <grant.likely@secretlab.ca>
Signed-off-by: Dong Aisheng <dong.aisheng@linaro.org>
Acked-by: Rob Herring <rob.herring@calxeda.com>
Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
[Kevin: Just some minor context mods in order to port to 3.4 kernel.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
]

Signed-off-by: Michel Thebeau <michel.thebeau@windriver.com>
---
 drivers/of/base.c |    7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/drivers/of/base.c b/drivers/of/base.c
index f1e2e4c..3f9fe3f 100644
--- a/drivers/of/base.c
+++ b/drivers/of/base.c
@@ -1127,6 +1127,13 @@ int prom_update_property(struct device_node *np,
 	unsigned long flags;
 	int found = 0;
 
+	if (!newprop->name)
+		return -EINVAL;
+
+	oldprop = of_find_property(np, newprop->name, NULL);
+	if (!oldprop)
+		return prom_add_property(np, newprop);
+
 	raw_spin_lock_irqsave(&devtree_lock, flags);
 	next = &np->properties;
 	while (*next) {
-- 
1.7.9.7

