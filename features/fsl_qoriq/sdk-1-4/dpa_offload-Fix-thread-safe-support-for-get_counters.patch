From d95f4225e1993c662a8d36a08e92b6efad8af16f Mon Sep 17 00:00:00 2001
From: Anca Jeanina FLOAREA <anca.floarea@freescale.com>
Date: Tue, 28 May 2013 12:20:20 +0300
Subject: [PATCH 120/430] dpa_offload: Fix thread safe support for
 get_counters

The asynchronous call for dpa_stats_get_counters function
needs to allow multiple requests for the same counters
to be processed in parallel. The check counter parameters
must wait in blocking mode until the processing is complete
and not exit the function.

Signed-off-by: Anca Jeanina FLOAREA <anca.floarea@freescale.com>
Change-Id: I7785196842b165830066a4e6319d656ff288e643
Reviewed-on: http://git.am.freescale.net:8181/2725
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Zanoschi Aurelian-B43522 <Aurelian.Zanoschi@freescale.com>
Reviewed-by: Chereji Marian-Cornel-R27762 <marian.chereji@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[original patch is from QorIQ-SDK-V1.4-20130625-yocto]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_stats.c |    8 +-------
 1 files changed, 1 insertions(+), 7 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_stats.c b/drivers/staging/fsl_dpa_offload/dpa_stats.c
index 1ee7706..8a524f1 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_stats.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_stats.c
@@ -3080,13 +3080,7 @@ int dpa_stats_get_counters(struct dpa_stats_cnt_request_params params,
 		cnt_cb = &dpa_stats->cnts_cb[cnt_id];
 
 		/* Acquire counter lock */
-		err = mutex_trylock(&cnt_cb->lock);
-		if (err == 0) {
-			pr_err("Counter %d is being used\n", cnt_id);
-			unblock_sched_cnts(dpa_stats, params.cnts_ids,
-					   params.cnts_ids_len);
-			return -EBUSY;
-		}
+		mutex_lock(&cnt_cb->lock);
 
 		/* Check if counter control block is initialized */
 		if (cnt_cb->index == DPA_OFFLD_INVALID_OBJECT_ID) {
-- 
1.7.5.4

