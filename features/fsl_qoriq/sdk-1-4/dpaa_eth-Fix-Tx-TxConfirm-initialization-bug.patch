From b686407bd65ba266047cf70a425251532c408c19 Mon Sep 17 00:00:00 2001
From: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
Date: Wed, 5 Jun 2013 02:01:51 +0300
Subject: [PATCH 233/547] dpaa_eth: Fix Tx/TxConfirm initialization bug

Due to a bad iterator, the Txq initialization logic mangled the Tx
queues settings and their respective Tx Confirmation FQs assignments.

Aside from the obvious structural problem, this created a nasty
imbalance in transmit and confirmation FD processing, resulting in
sustained degradation of termination use-cases.

Signed-off-by: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
Change-Id: Id28a8499c16405d7d4df5d2e66f1ece241409144
Reviewed-on: http://git.am.freescale.net:8181/2861
Reviewed-by: Bucur Madalin-Cristian-B32716 <madalin.bucur@freescale.com>
Reviewed-by: Sovaiala Cristian-Constantin-B39531 <Cristian.Sovaiala@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch taken from QorIQ-SDK-V1.4-SOURCE-20130625-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index c7bb250..201d68e 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -3548,12 +3548,16 @@ static void dpa_setup_egress(struct dpa_priv_s *priv,
 	/* Allocate frame queues to all available CPUs no matter the number of
 	 * queues specified in device tree.
 	 */
-	for (i = 0; i < DPAA_ETH_TX_QUEUES; i++) {
+	for (i = 0, ptr = &fq->list; i < DPAA_ETH_TX_QUEUES; i++) {
 		iter = list_entry(ptr, struct dpa_fq, list);
 		priv->egress_fqs[i] = &iter->fq_base;
 
-		if (list_is_last(ptr, head))
+		if (list_is_last(ptr, head)) {
 			ptr = &fq->list;
+			continue;
+		}
+
+		ptr = ptr->next;
 	}
 }
 
-- 
1.8.4.93.g57e4c17

