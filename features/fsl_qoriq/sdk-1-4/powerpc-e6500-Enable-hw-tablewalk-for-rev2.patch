From 901833583c1d041c83ce5c24fe3f6b1d8232821d Mon Sep 17 00:00:00 2001
From: Yang Wei <Wei.Yang@windriver.com>
Date: Mon, 14 Oct 2013 11:01:01 +0800
Subject: [PATCH 1/3] powerpc/e6500: Enable hw tablewalk for rev2

hw tablewalk should be enabled in e6500 rev2 target, though
FSL_ERRATUM_A_005337(used to disable hw tablewalk for rev1)
is enabled.

Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 arch/powerpc/include/asm/reg.h |    2 ++
 arch/powerpc/mm/tlb_nohash.c   |    7 ++++++-
 2 files changed, 8 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/include/asm/reg.h b/arch/powerpc/include/asm/reg.h
index 360585d..bea04df 100644
--- a/arch/powerpc/include/asm/reg.h
+++ b/arch/powerpc/include/asm/reg.h
@@ -983,6 +983,8 @@
 #define PVR_8560	0x80200000
 #define PVR_VER_E500V1	0x8020
 #define PVR_VER_E500V2	0x8021
+#define PVR_VER_E6500	0x8040
+#define PVR_REV_E6500V1	0x0010
 /*
  * For the 8xx processors, all of them report the same PVR family for
  * the PowerPC core. The various versions of these processors must be
diff --git a/arch/powerpc/mm/tlb_nohash.c b/arch/powerpc/mm/tlb_nohash.c
index 7823c05..da343df 100644
--- a/arch/powerpc/mm/tlb_nohash.c
+++ b/arch/powerpc/mm/tlb_nohash.c
@@ -44,6 +44,7 @@
 #include <asm/code-patching.h>
 #include <asm/hugetlb.h>
 #include <asm/paca.h>
+#include <asm/reg.h>
 
 #include "mmu_decl.h"
 
@@ -465,7 +466,6 @@ static void setup_page_sizes(void)
 		tlb1ps = mfspr(SPRN_TLB1PS);
 		eptcfg = mfspr(SPRN_EPTCFG);
 
-#ifndef CONFIG_FSL_ERRATUM_A_005337
 		if ((tlb1cfg & TLBnCFG_IND) && (tlb0cfg & TLBnCFG_PT))
 			book3e_htw_mode = PPC_HTW_FSL;
 
@@ -476,6 +476,11 @@ static void setup_page_sizes(void)
 		 */
 		if (eptcfg != 2)
 			book3e_htw_mode = PPC_HTW_NONE;
+#ifdef CONFIG_FSL_ERRATUM_A_005337
+		 /*  For E6500, hw tablewalk is only unsupported for rev1 */
+		if ((PVR_VER(mfspr(SPRN_PVR)) != PVR_VER_E6500) || \
+			(PVR_REV(mfspr(SPRN_PVR)) == PVR_REV_E6500V1))
+			book3e_htw_mode = PPC_HTW_NONE;
 #endif
 
 		for (psize = 0; psize < MMU_PAGE_COUNT; ++psize) {
-- 
1.7.5.4

