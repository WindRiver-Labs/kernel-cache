From 0387a44e7266d6e4c155474ac40c7fa7bd62e40b Mon Sep 17 00:00:00 2001
From: Zhao Chenhui <chenhui.zhao@freescale.com>
Date: Fri, 23 Mar 2012 17:03:39 +0800
Subject: [PATCH 319/547] usb/fsl: enable USB wakeup

To enable USB wakeup feature,
 * Add a interrupt flag IRQF_NO_SUSPEND to avoid the USB interrupt
   disabled when suspending.
 * Set the USB module as a wakeup source.

Change-Id: I85b1b538175ded6e6f56f701d76f49da9884178f
Signed-off-by: Zhao Chenhui <chenhui.zhao@freescale.com>
Signed-off-by: Li Yang <leoli@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/1448
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch taken from QorIQ-SDK-V1.4-SOURCE-20130625-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/boot/dts/fsl/p1022si-post.dtsi | 2 ++
 arch/powerpc/boot/dts/fsl/pq3-power.dtsi    | 9 +++++++++
 drivers/usb/host/ehci-fsl.c                 | 7 ++++++-
 3 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/arch/powerpc/boot/dts/fsl/p1022si-post.dtsi b/arch/powerpc/boot/dts/fsl/p1022si-post.dtsi
index 12e88be..c6fff1d 100644
--- a/arch/powerpc/boot/dts/fsl/p1022si-post.dtsi
+++ b/arch/powerpc/boot/dts/fsl/p1022si-post.dtsi
@@ -206,10 +206,12 @@
 /include/ "pq3-usb2-dr-0.dtsi"
 	usb@22000 {
 		compatible = "fsl-usb2-dr-v1.6", "fsl-usb2-dr";
+		fsl,pmc-handle = <&usb1_clk>;
 	};
 /include/ "pq3-usb2-dr-1.dtsi"
 	usb@23000 {
 		compatible = "fsl-usb2-dr-v1.6", "fsl-usb2-dr";
+		fsl,pmc-handle = <&usb2_clk>;
 	};
 
 /include/ "pq3-esdhc-0.dtsi"
diff --git a/arch/powerpc/boot/dts/fsl/pq3-power.dtsi b/arch/powerpc/boot/dts/fsl/pq3-power.dtsi
index 5a760b3..9a55844 100644
--- a/arch/powerpc/boot/dts/fsl/pq3-power.dtsi
+++ b/arch/powerpc/boot/dts/fsl/pq3-power.dtsi
@@ -36,6 +36,15 @@ power@e0070 {
 	compatible = "fsl,mpc8548-pmc";
 	reg = <0xe0070 0x20>;
 
+	usb1_clk: soc-clk@8 {
+		fsl,pmcdr-mask = <0x08000000>;
+	};
+	usb2_clk: soc-clk@9 {
+		fsl,pmcdr-mask = <0x04000000>;
+	};
+	usb3_clk: soc-clk@10 {
+		fsl,pmcdr-mask = <0x02000000>;
+	};
 	etsec1_clk: soc-clk@24 {
 		fsl,pmcdr-mask = <0x00000080>;
 	};
diff --git a/drivers/usb/host/ehci-fsl.c b/drivers/usb/host/ehci-fsl.c
index 3be3df2..677f822 100644
--- a/drivers/usb/host/ehci-fsl.c
+++ b/drivers/usb/host/ehci-fsl.c
@@ -30,6 +30,7 @@
 #include <linux/err.h>
 #include <linux/platform_device.h>
 #include <linux/fsl_devices.h>
+#include <sysdev/fsl_soc.h>
 
 #include "ehci-fsl.h"
 
@@ -135,7 +136,7 @@ static int usb_hcd_fsl_probe(const struct hc_driver *driver,
 
 	/* Don't need to set host mode here. It will be done by tdi_reset() */
 
-	retval = usb_add_hcd(hcd, irq, IRQF_SHARED);
+	retval = usb_add_hcd(hcd, irq, IRQF_SHARED | IRQF_NO_SUSPEND);
 	if (retval != 0)
 		goto err4;
 
@@ -573,6 +574,8 @@ static int ehci_fsl_drv_suspend(struct device *dev)
 		return ehci_fsl_mpc512x_drv_suspend(dev);
 	}
 
+	mpc85xx_pmc_set_wake(dev, true);
+
 	ehci_prepare_ports_for_controller_suspend(hcd_to_ehci(hcd),
 			device_may_wakeup(dev));
 	if (!fsl_deep_sleep())
@@ -594,6 +597,8 @@ static int ehci_fsl_drv_resume(struct device *dev)
 		return ehci_fsl_mpc512x_drv_resume(dev);
 	}
 
+	mpc85xx_pmc_set_wake(dev, false);
+
 	ehci_prepare_ports_for_controller_resume(ehci);
 	if (!fsl_deep_sleep())
 		return 0;
-- 
1.8.4.93.g57e4c17

