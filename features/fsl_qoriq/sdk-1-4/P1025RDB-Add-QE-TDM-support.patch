From 2d7faa128195e38b78ce1b4b3d63283f69bc47c9 Mon Sep 17 00:00:00 2001
From: Jiucheng Xu <Jiucheng.Xu@freescale.com>
Date: Fri, 31 Aug 2012 17:05:38 +0000
Subject: [PATCH 042/547] P1025RDB: Add QE TDM support

The P1025RDB-PC have PMC sockets that support QE-TDM function.
The patch enable Quicc Engine and the related signals of QE-TDM.

Change-Id: Ia694253a9b16754aed41ae04e7c136905dea69d6
Signed-off-by: Jiucheng Xu <Jiucheng.Xu@freescale.com>
Signed-off-by: Xie Xiaobo <X.Xie@freescale.com>
Signed-off-by: Li Yang <leoli@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/908
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch taken from QorIQ-SDK-V1.4-SOURCE-20130625-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/platforms/85xx/mpc85xx_rdb.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/arch/powerpc/platforms/85xx/mpc85xx_rdb.c b/arch/powerpc/platforms/85xx/mpc85xx_rdb.c
index 939c5f3..86a1417 100644
--- a/arch/powerpc/platforms/85xx/mpc85xx_rdb.c
+++ b/arch/powerpc/platforms/85xx/mpc85xx_rdb.c
@@ -120,6 +120,10 @@ static void __init mpc85xx_rdb_setup_arch(void)
 
 		for_each_node_by_name(ucc, "ucc")
 			par_io_of_config(ucc);
+
+		/* To P1025 QE/TDM, the name of ucc nodes is "tdm@xxxx" */
+		for_each_node_by_name(ucc, "tdm")
+			par_io_of_config(ucc);
 #ifdef CONFIG_SPI_FSL_SPI
 		for_each_node_by_name(qe_spi, "spi")
 			par_io_of_config(qe_spi);
@@ -151,7 +155,7 @@ static void __init mpc85xx_rdb_setup_arch(void)
 #endif
 
 #ifdef CONFIG_FSL_UCC_TDM
-			if (machine_is(p1021_rdb_pc)) {
+			if (machine_is(p1021_rdb_pc) || machine_is(p1025_rdb)) {
 
 				/* Clear QE12 for releasing the LBCTL */
 				clrbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(12));
@@ -170,11 +174,13 @@ static void __init mpc85xx_rdb_setup_arch(void)
 #endif	/* CONFIG_FSL_UCC_TDM */
 
 #ifdef CONFIG_SPI_FSL_SPI
+		if (of_find_compatible_node(NULL, NULL, "fsl,mpc8569-qe-spi")) {
 			clrbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(12));
 			/*QE-SPI*/
 			setbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(6) |
 					  MPC85xx_PMUXCR_QE(9) |
 					  MPC85xx_PMUXCR_QE(10));
+		}
 #endif	/* CONFIG_SPI_FSL_SPI */
 			iounmap(guts);
 		}
-- 
1.8.4.93.g57e4c17

