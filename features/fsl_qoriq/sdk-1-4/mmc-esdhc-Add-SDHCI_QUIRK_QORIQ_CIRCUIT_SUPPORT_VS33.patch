From def2fe28efe5f2c0d357f239b43ca785b591fff8 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Fri, 28 Jun 2013 16:51:43 +0800
Subject: [PATCH 260/430] mmc: esdhc: Add
 SDHCI_QUIRK_QORIQ_CIRCUIT_SUPPORT_VS33 quirk
 support

On the t4240 platform, sdhci controller can only supports 1.8V
voltage, but the peripheral hardware circuit has capability to
support 3.3V voltage.

Signed-off-by: Jerry Huang <Chang-Ming.Huang@freescale.com>
Signed-off-by: Chunhe Lan <Chunhe.Lan@freescale.com>
Change-Id: Ib1d25b5f70575c615d64bf85f7fed2074f8d244d
Reviewed-on: http://git.am.freescale.net:8181/852
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>

[Original patch is from QorIQ-SDK-V1.4-20130625-yocto, just a minor
modification to port 3.4 kernel]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/mmc/host/sdhci-pltfm.c |    2 +-
 drivers/mmc/host/sdhci.c       |    2 +-
 include/linux/mmc/sdhci.h      |    8 ++++----
 3 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/drivers/mmc/host/sdhci-pltfm.c b/drivers/mmc/host/sdhci-pltfm.c
index d5e9182..504aad8 100644
--- a/drivers/mmc/host/sdhci-pltfm.c
+++ b/drivers/mmc/host/sdhci-pltfm.c
@@ -88,12 +88,12 @@ void sdhci_get_of_property(struct platform_device *pdev)
 
 		if (of_device_is_compatible(np, "fsl,t4240-esdhc")) {
 			host->quirks |= SDHCI_QUIRK_BROKEN_ADMA;
-			host->quirks |= SDHCI_QUIRK_QORIQ_CIRCUIT_SUPPORT_VS33;
 		}
 
 		if (of_device_is_compatible(np, "fsl,t4240-esdhc")) {
 			host->quirks2 |= SDHCI_QUIRK2_BROKEN_RESET_ALL;
 			host->quirks2 |= SDHCI_QUIRK2_LONG_TIME_CMD_COMPLETE_IRQ;
+			host->quirks2 |= SDHCI_QUIRK2_CIRCUIT_SUPPORT_VS33;
 		}
 
 		if (of_device_is_compatible(np, "fsl,p4860-rev1-esdhc") ||
diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.c
index f94c791..c3eaa2b 100644
--- a/drivers/mmc/host/sdhci.c
+++ b/drivers/mmc/host/sdhci.c
@@ -2703,7 +2703,7 @@ int sdhci_add_host(struct sdhci_host *host)
 	if (host->quirks & SDHCI_QUIRK_QORIQ_HOSTCAPBLT_ONLY_VS33)
 		caps[0] &= ~(SDHCI_CAN_VDD_180 | SDHCI_CAN_VDD_300);
 
-	if (host->quirks & SDHCI_QUIRK_QORIQ_CIRCUIT_SUPPORT_VS33)
+	if (host->quirks2 & SDHCI_QUIRK2_CIRCUIT_SUPPORT_VS33)
 		caps[0] = caps[0] | SDHCI_CAN_VDD_330;
 
 	if (host->quirks & SDHCI_QUIRK_FORCE_DMA)
diff --git a/include/linux/mmc/sdhci.h b/include/linux/mmc/sdhci.h
index b06bb8b..dd2adfb 100644
--- a/include/linux/mmc/sdhci.h
+++ b/include/linux/mmc/sdhci.h
@@ -93,10 +93,6 @@ struct sdhci_host {
  * has incorrect set 1.8V and 3.0V
  */
 #define SDHCI_QUIRK_QORIQ_HOSTCAPBLT_ONLY_VS33		(0x200000000U)
-/* Controller can only supports 1.8V, but the peripheral hardware
- * circuit has capability to support 3.3V
- */
-#define SDHCI_QUIRK_QORIQ_CIRCUIT_SUPPORT_VS33		(0x400000000U)
 
 	unsigned int quirks2;	/* More deviations from spec. */
 
@@ -108,6 +104,10 @@ struct sdhci_host {
 #define SDHCI_QUIRK2_BROKEN_RESET_ALL			(1<<3)
 /* Controller need long time to generate command complete interrupt */
 #define SDHCI_QUIRK2_LONG_TIME_CMD_COMPLETE_IRQ		(1<<4)
+/* Controller can only supports 1.8V, but the peripheral hardware
+ * circuit has capability to support 3.3V
+ */
+#define SDHCI_QUIRK2_CIRCUIT_SUPPORT_VS33		(1<<5)
 
 	int irq;		/* Device IRQ */
 	void __iomem *ioaddr;	/* Mapped address */
-- 
1.7.5.4

