From e107d96be5493c17b3a95e8ce4a8f75388a520b9 Mon Sep 17 00:00:00 2001
From: Jerry Huang <Chang-Ming.Huang@freescale.com>
Date: Thu, 28 Mar 2013 10:06:24 +0800
Subject: [PATCH 362/547] MMC/eSDHC: use CMD13 to detect card status for
 T42040QDS

The bit CDPL or CINS of register PRSSTAT can't reflect the card status on
on T4240QDS board. Therefore, CMD13 is used to detect the card status.

Change-Id: I832f858eb89e2db639bb8de8bf04781a85ba1c1b
Reviewed-on: http://git.am.freescale.net:8181/853
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch taken from QorIQ-SDK-V1.4-SOURCE-20130625-yocto.iso]
 Change SDHCI_QUIRK2_FORCE_CMD13_DETECT_CARD to (1<<7) to port 3.10
 kernel]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/mmc/host/sdhci-of-esdhc.c | 2 ++
 drivers/mmc/host/sdhci-pltfm.c    | 1 +
 include/linux/mmc/sdhci.h         | 1 +
 3 files changed, 4 insertions(+)

diff --git a/drivers/mmc/host/sdhci-of-esdhc.c b/drivers/mmc/host/sdhci-of-esdhc.c
index b4040fd..a9d523f 100644
--- a/drivers/mmc/host/sdhci-of-esdhc.c
+++ b/drivers/mmc/host/sdhci-of-esdhc.c
@@ -335,6 +335,8 @@ static int esdhc_of_get_cd(struct sdhci_host *host)
 
 	if (host->flags & SDHCI_DEVICE_DEAD)
 		return 0;
+	if (host->quirks2 & SDHCI_QUIRK2_FORCE_CMD13_DETECT_CARD)
+		return -ENOSYS;
 
 	sysctl = sdhci_be32bs_readl(host, SDHCI_CLOCK_CONTROL);
 
diff --git a/drivers/mmc/host/sdhci-pltfm.c b/drivers/mmc/host/sdhci-pltfm.c
index 968baa4..032558f 100644
--- a/drivers/mmc/host/sdhci-pltfm.c
+++ b/drivers/mmc/host/sdhci-pltfm.c
@@ -102,6 +102,7 @@ void sdhci_get_of_property(struct platform_device *pdev)
 			host->quirks2 |= SDHCI_QUIRK2_BROKEN_RESET_ALL;
 			host->quirks2 |= SDHCI_QUIRK2_LONG_TIME_CMD_COMPLETE_IRQ;
 			host->quirks2 |= SDHCI_QUIRK2_CIRCUIT_SUPPORT_VS33;
+			host->quirks2 |= SDHCI_QUIRK2_FORCE_CMD13_DETECT_CARD;
 		}
 
 		if (of_device_is_compatible(np, "fsl,p4860-rev1-esdhc") ||
diff --git a/include/linux/mmc/sdhci.h b/include/linux/mmc/sdhci.h
index fe36db4..66ce1fd 100644
--- a/include/linux/mmc/sdhci.h
+++ b/include/linux/mmc/sdhci.h
@@ -103,6 +103,7 @@ struct sdhci_host {
  * circuit has capability to support 3.3V
  */
 #define SDHCI_QUIRK2_CIRCUIT_SUPPORT_VS33		(1<<6)
+#define SDHCI_QUIRK2_FORCE_CMD13_DETECT_CARD		(1<<7)
 
 	int irq;		/* Device IRQ */
 	void __iomem *ioaddr;	/* Mapped address */
-- 
1.8.4.93.g57e4c17

