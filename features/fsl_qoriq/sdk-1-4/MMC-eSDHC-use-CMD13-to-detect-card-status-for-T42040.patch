From 704f0bb2693b774971f08fc62b5a7f2987a9d9ff Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Fri, 28 Jun 2013 16:54:02 +0800
Subject: [PATCH 261/430] MMC/eSDHC: use CMD13 to detect card status for
 T42040QDS

The bit CDPL or CINS of register PRSSTAT can't reflect the card status on
on T4240QDS board. Therefore, CMD13 is used to detect the card status.

Change-Id: I832f858eb89e2db639bb8de8bf04781a85ba1c1b
Reviewed-on: http://git.am.freescale.net:8181/853
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch is from QorIQ-SDK-V1.4-20130625-yocto, just a minor
modification to port 3.4 kernel]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/mmc/host/sdhci-of-esdhc.c |    2 ++
 drivers/mmc/host/sdhci-pltfm.c    |    1 +
 include/linux/mmc/sdhci.h         |    1 +
 3 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/mmc/host/sdhci-of-esdhc.c b/drivers/mmc/host/sdhci-of-esdhc.c
index c60ffb1..78b3c51 100644
--- a/drivers/mmc/host/sdhci-of-esdhc.c
+++ b/drivers/mmc/host/sdhci-of-esdhc.c
@@ -248,6 +248,8 @@ static int esdhc_of_get_cd(struct sdhci_host *host)
 	if (host->flags & SDHCI_DEVICE_DEAD)
 		present = 0;
 	else {
+		if (host->quirks2 & SDHCI_QUIRK2_FORCE_CMD13_DETECT_CARD)
+			return -ENOSYS;
 		int sysctl = sdhci_be32bs_readl(host, SDHCI_CLOCK_CONTROL);
 		/* Enable the controller clock to update the present state */
 		sdhci_be32bs_writel(host, sysctl | SDHCI_CLOCK_INT_EN,
diff --git a/drivers/mmc/host/sdhci-pltfm.c b/drivers/mmc/host/sdhci-pltfm.c
index 504aad8..5718157 100644
--- a/drivers/mmc/host/sdhci-pltfm.c
+++ b/drivers/mmc/host/sdhci-pltfm.c
@@ -94,6 +94,7 @@ void sdhci_get_of_property(struct platform_device *pdev)
 			host->quirks2 |= SDHCI_QUIRK2_BROKEN_RESET_ALL;
 			host->quirks2 |= SDHCI_QUIRK2_LONG_TIME_CMD_COMPLETE_IRQ;
 			host->quirks2 |= SDHCI_QUIRK2_CIRCUIT_SUPPORT_VS33;
+			host->quirks2 |= SDHCI_QUIRK2_FORCE_CMD13_DETECT_CARD;
 		}
 
 		if (of_device_is_compatible(np, "fsl,p4860-rev1-esdhc") ||
diff --git a/include/linux/mmc/sdhci.h b/include/linux/mmc/sdhci.h
index dd2adfb..5b7e0d8 100644
--- a/include/linux/mmc/sdhci.h
+++ b/include/linux/mmc/sdhci.h
@@ -108,6 +108,7 @@ struct sdhci_host {
  * circuit has capability to support 3.3V
  */
 #define SDHCI_QUIRK2_CIRCUIT_SUPPORT_VS33		(1<<5)
+#define SDHCI_QUIRK2_FORCE_CMD13_DETECT_CARD		(1<<6)
 
 	int irq;		/* Device IRQ */
 	void __iomem *ioaddr;	/* Mapped address */
-- 
1.7.5.4

