From 0c421281a6226b1134462f3a1d741fcf05072136 Mon Sep 17 00:00:00 2001
From: Haiying Wang <Haiying.Wang@freescale.com>
Date: Tue, 28 May 2013 17:37:51 -0400
Subject: [PATCH 162/430] fsl_bman: remove the extra kmalloc which causes
 memleak

because the later pointer assignments overwrite the results of the kmalloc.
This memleak can be detect after turning on kernel memleak detector.

Signed-off-by: Haiying Wang <Haiying.Wang@freescale.com>
Change-Id: If21cc0f8084271d9fe6f73e51dd3ad200ebdad67
Reviewed-on: http://git.am.freescale.net:8181/2747
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Pledge Roy-R01356 <roy.pledge@freescale.com>
Reviewed-by: Thorpe Geoff-R01361 <Geoff.Thorpe@freescale.com>
Reviewed-by: Ladouceur Jeffrey-R11498 <Jeffrey.Ladouceur@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[original patch is from QorIQ-SDK-V1.4-20130625-yocto]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/staging/fsl_qbman/bman_config.c |   12 ------------
 1 files changed, 0 insertions(+), 12 deletions(-)

diff --git a/drivers/staging/fsl_qbman/bman_config.c b/drivers/staging/fsl_qbman/bman_config.c
index 1a21756..7b5bc88 100644
--- a/drivers/staging/fsl_qbman/bman_config.c
+++ b/drivers/staging/fsl_qbman/bman_config.c
@@ -747,16 +747,6 @@ static int __devinit of_fsl_bman_probe(struct platform_device *ofdev)
 			goto del_group_3;
 	}
 
-	for (i = 0; i < (bman_pool_max + 1); i++) {
-		bman_dev_pool_count_attributes[i] =
-			kmalloc(sizeof(struct attribute), GFP_KERNEL);
-		if (!bman_dev_pool_count_attributes[i]) {
-			pr_err("cannot alloc for each"
-				" bman_dev_pool_count_attributes\n");
-			goto del_group_3;
-		}
-	}
-
 	for (i = 0; i < bman_pool_max; i++) {
 		ret = scnprintf((name_attrs_pool_count + i * 3), 3, "%d", i);
 		if (!ret)
@@ -779,8 +769,6 @@ static int __devinit of_fsl_bman_probe(struct platform_device *ofdev)
 	goto done;
 
 del_group_4:
-	for (i = 0; i < (bman_pool_max + 1); i++)
-		kfree(bman_dev_pool_count_attributes[i]);
 	kfree(bman_dev_pool_count_attributes);
 del_group_3:
 	kfree(dev_attr_buffer_pool_count);
-- 
1.7.5.4

