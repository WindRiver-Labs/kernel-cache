From 6f075a31fdf95355bc3dd7fb8a2aea1deeddbf1b Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Fri, 28 Jun 2013 14:52:56 +0800
Subject: [PATCH 238/430] Put the qemu_e500_pci check under
 CONFIG_PPC_QEMU_E500 check.

Check for qemu_e500_pci flag only if QEMU E500 platform has been enabled.

Signed-off-by: Varun Sethi <Varun.Sethi@freescale.com>
Change-Id: I7eacf87bccbd9442c76c851eb185f9b352b00905
Reviewed-on: http://git.am.freescale.net:8181/2439
Reviewed-by: Yoder Stuart-B08248 <stuart.yoder@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch is from QorIQ-SDK-V1.4-20130625-yocto, just
a minor modification to port 3.4 kernel]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/sysdev/fsl_pci.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/sysdev/fsl_pci.c b/arch/powerpc/sysdev/fsl_pci.c
index f4c461c..13760d1 100644
--- a/arch/powerpc/sysdev/fsl_pci.c
+++ b/arch/powerpc/sysdev/fsl_pci.c
@@ -334,7 +334,11 @@ static void setup_pci_atmu(struct pci_controller *hose)
 	mem_log = __ilog2_u64(sz);
 
 	/* PCIe can overmap inbound & outbound since RX & TX are separated */
+#ifdef CONFIG_PPC_QEMU_E500
+	if (early_find_capability(hose, 0, 0, PCI_CAP_ID_EXP) || qemu_e500_pci) {
+#else
 	if (early_find_capability(hose, 0, 0, PCI_CAP_ID_EXP)) {
+#endif
 		/* Size window to exact size if power-of-two or one size up */
 		if ((1ull << mem_log) != mem) {
 			if ((1ull << mem_log) > mem)
-- 
1.7.5.4

