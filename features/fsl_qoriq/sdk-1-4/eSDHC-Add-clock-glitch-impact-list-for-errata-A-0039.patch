From efbdee6c97076ce6a201151a4bcc5f2fc82970f3 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Fri, 28 Jun 2013 17:00:33 +0800
Subject: [PATCH 267/430] eSDHC: Add clock glitch impact list for errata
 A-003980

Add impact list for clock glitch errata.
A-003980: SDHC: Clock glitch is generated on the card clock when software
reset or clock divider change was implemented, all command will be timeout
in this situation. This issue can be occured when card setup and software
reset all command be issued.
As errata said, this issue only exist on below board:

T4240-R1.0 B4860-R1.0 P3041-R1.0
P3041-R2.0 P2041-R1.0 P2041-R1.1
P2041-R2.0 P1010-R1.0

Signed-off-by: Jerry Huang <Chang-Ming.Huang@freescale.com>
Signed-off-by: Haijun Zhang <Haijun.Zhang@freescale.com>
Change-Id: Ia4461974f7f08fe57997ca77036a0eeda57bea74
Reviewed-on: http://git.am.freescale.net:8181/918
Reviewed-by: Xie Xiaobo-R63061 <X.Xie@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch is from QorIQ-SDK-V1.4-20130625-yocto, just a minor
modification to port 3.4 kernel]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/mmc/host/sdhci-of-esdhc.c |   29 +++++++++++++++++++++++++++++
 drivers/mmc/host/sdhci-pltfm.c    |    6 ------
 2 files changed, 29 insertions(+), 6 deletions(-)

diff --git a/drivers/mmc/host/sdhci-of-esdhc.c b/drivers/mmc/host/sdhci-of-esdhc.c
index 8173f50..0be62ec 100644
--- a/drivers/mmc/host/sdhci-of-esdhc.c
+++ b/drivers/mmc/host/sdhci-of-esdhc.c
@@ -331,7 +331,35 @@ static void esdhc_of_platform_reset_exit(struct sdhci_host *host, u8 mask)
 	if (host->quirks2 & SDHCI_QUIRK2_BROKEN_RESET_ALL)
 		host->clock = clock;
 }
+static void esdhc_of_platform_init(struct sdhci_host *host)
+{
+	u32 vvn;
+
+	vvn = in_be32(host->ioaddr + SDHCI_SLOT_INT_STATUS);
+	vvn = (vvn & SDHCI_VENDOR_VER_MASK) >> SDHCI_VENDOR_VER_SHIFT;
+	if (vvn == VENDOR_V_22)
+		host->quirks2 |= SDHCI_QUIRK2_HOST_NO_CMD23;
 
+	if (vvn > VENDOR_V_22)
+		host->quirks &= ~SDHCI_QUIRK_NO_BUSY_IRQ;
+
+	/*
+	 * Check for A-005055: A glitch is generated on the card clock
+	 * due to software reset or a clock change
+	 * Impact list:
+	 * T4240-R1.0 B4860-R1.0 P3041-R1.0 P3041-R2.0 P2041-R1.0
+	 * P2041-R1.1 P2041-R2.0 P1010-R1.0
+	 */
+	if ((fsl_svr_is(SVR_T4240) && fsl_svr_rev_is(1, 0)) ||
+		(fsl_svr_is(SVR_B4860) && fsl_svr_rev_is(1, 0)) ||
+		(fsl_svr_is(SVR_P3041) && fsl_svr_rev_is(1, 0)) ||
+		(fsl_svr_is(SVR_P3041) && fsl_svr_rev_is(2, 0)) ||
+		(fsl_svr_is(SVR_P2041) && fsl_svr_rev_is(2, 0)) ||
+		(fsl_svr_is(SVR_P2041) && fsl_svr_rev_is(1, 1)) ||
+		(fsl_svr_is(SVR_P2041) && fsl_svr_rev_is(1, 0)) ||
+		(fsl_svr_is(SVR_P1010) && fsl_svr_rev_is(1, 0)))
+		host->quirks2 |= SDHCI_QUIRK2_BROKEN_RESET_ALL;
+}
 
 /* Return: none zero - the card is presetn; 0 - card is absent */
 static int esdhc_of_get_cd(struct sdhci_host *host)
@@ -372,6 +400,7 @@ static struct sdhci_ops sdhci_esdhc_ops = {
 	.get_min_clock = esdhc_of_get_min_clock,
 	.platform_reset_enter = esdhc_of_platform_reset_enter,
 	.platform_reset_exit = esdhc_of_platform_reset_exit,
+	.platform_init = esdhc_of_platform_init,
 #ifdef CONFIG_PM
 	.platform_suspend = esdhc_of_suspend,
 	.platform_resume = esdhc_of_resume,
diff --git a/drivers/mmc/host/sdhci-pltfm.c b/drivers/mmc/host/sdhci-pltfm.c
index 1d27044..0cc9729 100644
--- a/drivers/mmc/host/sdhci-pltfm.c
+++ b/drivers/mmc/host/sdhci-pltfm.c
@@ -87,18 +87,12 @@ void sdhci_get_of_property(struct platform_device *pdev)
 			host->quirks |= SDHCI_QUIRK_BROKEN_TIMEOUT_VAL;
 
 		if (of_device_is_compatible(np, "fsl,t4240-esdhc")) {
-			host->quirks2 |= SDHCI_QUIRK2_BROKEN_RESET_ALL;
 			host->quirks2 |= SDHCI_QUIRK2_LONG_TIME_CMD_COMPLETE_IRQ;
 			host->quirks2 |= SDHCI_QUIRK2_CIRCUIT_SUPPORT_VS33;
 			host->quirks2 |= SDHCI_QUIRK2_FORCE_CMD13_DETECT_CARD;
 			host->quirks |= SDHCI_QUIRK_BROKEN_ADMA;
 		}
 
-		if (of_device_is_compatible(np, "fsl,p4860-rev1-esdhc") ||
-		    of_device_is_compatible(np, "fsl,p1010-esdhc") ||
-		    of_device_is_compatible(np, "fsl,p2041-esdhc") ||
-		    of_device_is_compatible(np, "fsl,p3041-esdhc"))
-			host->quirks2 |= SDHCI_QUIRK2_BROKEN_RESET_ALL;
 
 		clk = of_get_property(np, "clock-frequency", &size);
 		if (clk && size == sizeof(*clk) && *clk)
-- 
1.7.5.4

