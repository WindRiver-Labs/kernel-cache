From eee5e521a45f30747d81240663b4b3b39a5ddf55 Mon Sep 17 00:00:00 2001
From: Alex Porosanu <alexandru.porosanu@freescale.com>
Date: Tue, 29 Jan 2013 16:45:51 +0000
Subject: [PATCH 070/547] crypto: caam - fix RNG init for SEC with RNG version
 greater than 4

For SEC including a RNG block with a version greater than 4,
special initialization must occur before any descriptor can be
submitted. Not only SEC with a version greater than 5.0 need
this, but also any SEC that has RNG block version ID greater
or equal to 4.

Example platforms: BSC 9131/9132 have SEC v4.4 but RNG 4

Signed-off-by: Alex Porosanu <alexandru.porosanu@freescale.com>
Signed-off-by: Andy Fleming <afleming@freescale.com>
Change-Id: I1613bba194fba7423764c785c20e7793c53502ca
Reviewed-on: http://git.am.freescale.net:8181/523
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch taken from QorIQ-SDK-V1.4-SOURCE-20130625-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/crypto/caam/ctrl.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/crypto/caam/ctrl.c b/drivers/crypto/caam/ctrl.c
index 1e69403..ff16eb2 100644
--- a/drivers/crypto/caam/ctrl.c
+++ b/drivers/crypto/caam/ctrl.c
@@ -305,10 +305,10 @@ static int caam_probe(struct platform_device *pdev)
 	}
 
 	/*
-	 * RNG4 based SECs (v5+) need special initialization prior
+	 * RNG4 based SECs need special initialization prior
 	 * to executing any descriptors
 	 */
-	if (of_device_is_compatible(nprop, "fsl,sec-v5.0")) {
+	if (get_rng_vid(topregs) >= 4) {
 		kick_trng(pdev);
 		ret = instantiate_rng(ctrlpriv->jrdev[0]);
 		if (ret) {
-- 
1.8.4.93.g57e4c17

