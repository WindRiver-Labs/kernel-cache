From 9410a9540f5d7d0512da927e58ea7adb26662515 Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Sat, 9 Jun 2012 06:00:37 +0000
Subject: [PATCH 009/547] powerpc/e6500: hw tablewalk: fix corruption when no
 lock needed

If the low bit is not set, that indicates the need for a TLB miss lock,
the next tlb entry was written to the wrong byte, corrupting pgdir_kernel.

This can happen when there's a TLB miss before threading is started
(e.g. serial port MMIO), or if threading is disabled.

Signed-off-by: Scott Wood <scottwood@freescale.com>
Change-Id: I135f16be6b529a1cdf4e204584d993e186024bf7
Reviewed-on: http://git.am.freescale.net:8181/509
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch taken from QorIQ-SDK-V1.4-SOURCE-20130625-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/mm/tlb_low_64e.S | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/mm/tlb_low_64e.S b/arch/powerpc/mm/tlb_low_64e.S
index 1e47dd5..eafbe10 100644
--- a/arch/powerpc/mm/tlb_low_64e.S
+++ b/arch/powerpc/mm/tlb_low_64e.S
@@ -408,8 +408,8 @@ tlb_miss_common_fsl_htw:
 
 
 	mfspr	r10,SPRN_MAS0
-	rldicr	r15,r11,0,62
-	lwz	r15,0(r15)
+	rldicr	r16,r11,0,62
+	lwz	r15,0(r16)
 
 	ori	r14,r14,(BOOK3E_PAGESZ_4K << MAS3_SPSIZE_SHIFT)
 	mtspr	SPRN_MAS7_MAS3,r14
@@ -423,7 +423,7 @@ tlb_miss_common_fsl_htw:
 	cmpw	r10,r14
 	rlwinm	r10,r15,24,0xff		/* extract first */
 	iseleq	r14,r10,r14		/* if next == last use first */
-	stb	r14,PACA_TLB_ESEL_NEXT-1(r11)
+	stb	r14,PACA_TLB_ESEL_NEXT(r16)
 
 	tlbwe
 
-- 
1.8.4.93.g57e4c17

