From 7e1739f35e55b1be66bff547e4a8e0c56480667a Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Thu, 27 Feb 2014 16:11:25 +0800
Subject: [PATCH] dpa:Add getting NIC statistics support for xgmac & memac

commit 543ea6c882c3 (dpa/ethtool: Add getting NIC statistics support)
introduce dpa_get_ethtool_stats() to dump statistics via NetCommSw's
interface.

We need add this feature to xgmac & memac, or the "ethtool -S ethX"
get following error:

Unable to handle kernel paging request for data at address 0x00000000
Faulting instruction address: 0xc0000000007081f0
Oops: Kernel access of bad area, sig: 11 [#1]
PREEMPT SMP NR_CPUS=8 B4 QDS
Modules linked in:

CPU: 1 PID: 1158 Comm: ethtool Not tainted 3.10.19-WR6.0.0.3_cgl #12
task: c0000000de34e040 ti: c0000000dea74000 task.ti: c0000000dea74000
NIP: c0000000007081f0 LR: c00000000086e9c0 CTR: c0000000007081c0
REGS: c0000000dea77740 TRAP: 0300   Not tainted  (3.10.19-WR6.0.0.3_cgl)
MSR: 0000000080029000 <CE,EE,ME>  CR: 82002482  XER: 00000000
SOFTE: 1
DEAR: 0000000000000000, ESR: 0000000000000000
GPR00: c00000000086e9c0 c0000000dea779c0 c000000000ffa958 c0000000f6c9de18
GPR04: c0000000f5b8b400 c0000000f5b8b400 c00000000100a958 c00000000100a958
GPR08: c000000000efa958 0000000000000000 c0000000007081c0 0000000000000001
GPR12: 0000000028002482 c00000000fffe400 0000000000000000 0000000000000000
GPR16: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
GPR20: 0000000000000000 0000000000000000 0000000000000000 c000000000f37680
GPR24: 0000000000000000 c000000000f37680 0000000040005012 c0000000f5b8b400
GPR28: c000000000f2d608 c0000000fb50e000 c0000000f5b8b400 c0000000fb50e000
NIP [c0000000007081f0] .dpa_get_ethtool_stats+0x30/0xc0

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/mac-api.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/mac-api.c b/drivers/net/ethernet/freescale/dpa/mac-api.c
index aa4eaa5..983b713 100644
--- a/drivers/net/ethernet/freescale/dpa/mac-api.c
+++ b/drivers/net/ethernet/freescale/dpa/mac-api.c
@@ -883,6 +883,7 @@ static void __cold setup_xgmac(struct mac_device *mac_dev)
 	mac_dev->uninit		= uninit;
 	mac_dev->set_tx_pause	= set_tx_pause;
 	mac_dev->set_rx_pause	= set_rx_pause;
+	mac_dev->get_stats	= mac_get_statistics;
 }
 
 static void __cold setup_memac(struct mac_device *mac_dev)
@@ -906,6 +907,7 @@ static void __cold setup_memac(struct mac_device *mac_dev)
 	mac_dev->fm_rtc_set_drift	= fm_rtc_set_drift;
 	mac_dev->fm_rtc_set_alarm	= fm_rtc_set_alarm;
 	mac_dev->fm_rtc_set_fiper	= fm_rtc_set_fiper;
+	mac_dev->get_stats		= mac_get_statistics;
 }
 
 void (*const mac_setup[])(struct mac_device *mac_dev) = {
-- 
1.7.5.4

