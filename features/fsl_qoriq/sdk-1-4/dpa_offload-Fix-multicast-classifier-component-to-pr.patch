From f3541aa2308ea12de0aa4de06856e9ba60120018 Mon Sep 17 00:00:00 2001
From: Radu Bulie <radu.bulie@freescale.com>
Date: Fri, 10 May 2013 12:18:36 +0000
Subject: [PATCH 106/430] dpa_offload: Fix multicast classifier component to
 proper release the locks for decriptor array

Descriptor array locks were not released correctly for actions of adding
or removing a multicast member.
This patch is related to CR ENGR260419

Change-Id: I440241fbfa6d4c8c9b0318b1ae89ddf6e2cad05a
Signed-off-by: Radu Bulie <radu.bulie@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/2595
Reviewed-by: Chereji Marian-Cornel-R27762 <marian.chereji@freescale.com>
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[original patch is from QorIQ-SDK-V1.4-20130625-yocto]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_classifier.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_classifier.c b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
index 1ca022c..da291de 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_classifier.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
@@ -7654,6 +7654,7 @@ int dpa_classif_mcast_add_member(int grpd,
 	lock_desc_table(&mcast_grp_array);
 	pgroup = desc_to_object(&mcast_grp_array, grpd);
 	if (!pgroup) {
+		release_desc_table(&mcast_grp_array);
 		pr_err("ERROR: %s, %s (%d): Invalid group descriptor "
 			"(grpd=%d).\n", __FILE__, __func__, __LINE__, grpd);
 		return -EINVAL;
@@ -7847,8 +7848,8 @@ int dpa_classif_mcast_remove_member(int grpd, int md)
 
 	lock_desc_table(&mcast_grp_array);
 	pgroup = desc_to_object(&mcast_grp_array, grpd);
-	release_desc_table(&mcast_grp_array);
 	if (!pgroup) {
+		release_desc_table(&mcast_grp_array);
 		pr_err("ERROR: %s, %s (%d): Invalid group descriptor "
 			"(grpd=%d).\n", __FILE__, __func__, __LINE__, grpd);
 		return -EINVAL;
-- 
1.7.5.4

