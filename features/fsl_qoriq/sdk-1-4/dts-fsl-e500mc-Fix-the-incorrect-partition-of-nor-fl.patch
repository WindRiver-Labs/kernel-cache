From a07b43d5d640f5b7be0a1d8401d5308bcf5d48d7 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Thu, 29 Aug 2013 17:42:35 +0800
Subject: [PATCH 4/4] dts/fsl-e500mc: Fix the incorrect partition of nor flash

1.Enlarge the partition of kernel to 5M.

2.Since the size of fs1 partition currently overlaps the alternate FMAN ucode
and alternate u-boot environment variable, so we need to separate two partition
for alternate FMAN ucode and u-boot env from fs1 partition.

3.The offset of current fman ucode partition should be
at 0x7f40000, so move it to correct address, and squash fs2 and fs3
partition.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/boot/dts/p2041rdb.dts |   30 ++++++++++++++++++------------
 arch/powerpc/boot/dts/p3041ds.dts  |   30 ++++++++++++++++++------------
 arch/powerpc/boot/dts/p4080ds.dts  |   30 ++++++++++++++++++------------
 3 files changed, 54 insertions(+), 36 deletions(-)

diff --git a/arch/powerpc/boot/dts/p2041rdb.dts b/arch/powerpc/boot/dts/p2041rdb.dts
index c81451e..1d25d2c 100644
--- a/arch/powerpc/boot/dts/p2041rdb.dts
+++ b/arch/powerpc/boot/dts/p2041rdb.dts
@@ -282,15 +282,25 @@
 			};
 			partition@20000 {
 				label = "kernel";
-				reg = <0x20000 0x300000>;
+				reg = <0x20000 0x500000>;
 			};
-			partition@320000 {
+			partition@520000 {
 				label = "dtb";
-				reg = <0x320000 0x20000>;
+				reg = <0x520000 0x20000>;
 			};
-			partition@340000 {
+			partition@540000 {
 				label = "fs1";
-				reg = <0x340000 0x3c40000>;
+				reg = <0x540000 0x3a00000>;
+			};
+			partition@3f40000 {
+				label = "alt-fman-firmware";
+				reg = <0x3f40000 0x20000>;
+				read-only;
+			};
+			partition@3f60000 {
+				label = "alt-uboot-env";
+				reg = <0x3f60000 0x20000>;
+				read-only;
 			};
 			partition@3f80000 {
 				label = "alt-u-boot";
@@ -304,17 +314,13 @@
 			};
 			partition@4020000 {
 				label = "fs2";
-				reg = <0x4020000  0x2fe0000>;
+				reg = <0x4020000  0x3f20000>;
 			};
-			partition@7000000 {
+			partition@7f40000 {
 				label = "fman-firmware";
-				reg = <0x7000000 0x20000>;
+				reg = <0x7f40000 0x20000>;
 				read-only;
 			};
-			partition@7020000 {
-				label = "fs3";
-				reg = <0x7020000  0xf40000>;
-			};
 			partition@7f60000 {
 				label = "u-boot env";
 				reg = <0x7f60000  0x20000>;
diff --git a/arch/powerpc/boot/dts/p3041ds.dts b/arch/powerpc/boot/dts/p3041ds.dts
index d743d0f..22968c2 100644
--- a/arch/powerpc/boot/dts/p3041ds.dts
+++ b/arch/powerpc/boot/dts/p3041ds.dts
@@ -271,15 +271,25 @@
 			};
 			partition@20000 {
 				label = "kernel";
-				reg = <0x20000 0x300000>;
+				reg = <0x20000 0x500000>;
 			};
-			partition@320000 {
+			partition@520000 {
 				label = "dtb";
-				reg = <0x320000 0x20000>;
+				reg = <0x520000 0x20000>;
 			};
-			partition@340000 {
+			partition@540000 {
 				label = "fs1";
-				reg = <0x340000 0x3c40000>;
+				reg = <0x540000 0x3a00000>;
+			};
+			partition@3f40000 {
+				label = "alt-fman-firmware";
+				reg = <0x3f40000 0x20000>;
+				read-only;
+			};
+			partition@3f60000 {
+				label = "alt-uboot-env";
+				reg = <0x3f60000 0x20000>;
+				read-only;
 			};
 			partition@3f80000 {
 				label = "alt-u-boot";
@@ -293,17 +303,13 @@
 			};
 			partition@4020000 {
 				label = "fs2";
-				reg = <0x4020000  0x2fe0000>;
+				reg = <0x4020000  0x3f20000>;
 			};
-			partition@7000000 {
+			partition@7f40000 {
 				label = "fman-firmware";
-				reg = <0x7000000 0x20000>;
+				reg = <0x7f40000 0x20000>;
 				read-only;
 			};
-			partition@7020000 {
-				label = "fs3";
-				reg = <0x7020000  0xf40000>;
-			};
 			partition@7f60000 {
 				label = "u-boot env";
 				reg = <0x7f60000  0x20000>;
diff --git a/arch/powerpc/boot/dts/p4080ds.dts b/arch/powerpc/boot/dts/p4080ds.dts
index aff5ac0..0e87d2c 100644
--- a/arch/powerpc/boot/dts/p4080ds.dts
+++ b/arch/powerpc/boot/dts/p4080ds.dts
@@ -294,15 +294,25 @@
 			};
 			partition@20000 {
 				label = "kernel";
-				reg = <0x20000 0x300000>;
+				reg = <0x20000 0x500000>;
 			};
-			partition@320000 {
+			partition@520000 {
 				label = "dtb";
-				reg = <0x320000 0x20000>;
+				reg = <0x520000 0x20000>;
 			};
-			partition@340000 {
+			partition@540000 {
 				label = "fs1";
-				reg = <0x340000 0x3c40000>;
+				reg = <0x540000 0x3a00000>;
+			};
+			partition@3f40000 {
+				label = "alt-fman-firmware";
+				reg = <0x3f40000 0x20000>;
+				read-only;
+			};
+			partition@3f60000 {
+				label = "alt-uboot-env";
+				reg = <0x3f60000 0x20000>;
+				read-only;
 			};
 			partition@3f80000 {
 				label = "alt-u-boot";
@@ -316,17 +326,13 @@
 			};
 			partition@4020000 {
 				label = "fs2";
-				reg = <0x4020000  0x2fe0000>;
+				reg = <0x4020000  0x3f20000>;
 			};
-			partition@7000000 {
+			partition@7f40000 {
 				label = "fman-firmware";
-				reg = <0x7000000 0x20000>;
+				reg = <0x7f40000 0x20000>;
 				read-only;
 			};
-			partition@7020000 {
-				label = "fs3";
-				reg = <0x7020000  0xf40000>;
-			};
 			partition@7f60000 {
 				label = "u-boot env";
 				reg = <0x7f60000  0x20000>;
-- 
1.7.5.4

