From 06e546a899aa225ef40c3c3cce577eb8a7676115 Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Sat, 9 Jun 2012 06:00:40 +0000
Subject: [PATCH 011/547] powerpc/e6500: hw tablewalk: check for NULL pmd entry

We need to check for a NULL entry at each level -- the last one was
forgotten. This resulted in an indirect entry getting loaded pointing
at NULL, which occasionally resulted in CCM errors.

Signed-off-by: Scott Wood <scottwood@freescale.com>
Change-Id: Iae39126af3fcfa2085b38c439a23a5cdfd46fcb3
Reviewed-on: http://git.am.freescale.net:8181/510
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch taken from QorIQ-SDK-V1.4-SOURCE-20130625-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/mm/tlb_low_64e.S | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/arch/powerpc/mm/tlb_low_64e.S b/arch/powerpc/mm/tlb_low_64e.S
index eafbe10..f2e1636 100644
--- a/arch/powerpc/mm/tlb_low_64e.S
+++ b/arch/powerpc/mm/tlb_low_64e.S
@@ -396,6 +396,10 @@ tlb_miss_common_fsl_htw:
 	bge	tlb_miss_fault_fsl_htw
 	ldx	r14,r14,r15		/* Grab pmd entry */
 
+	mfspr	r10,SPRN_MAS0
+	cmpdi	cr0,r14,0
+	bge	tlb_miss_fault_fsl_htw
+
 	/* Now we build the MAS for a 2M indirect page:
 	 *
 	 * MAS 0   :	ESEL needs to be filled by software round-robin
@@ -407,7 +411,6 @@ tlb_miss_common_fsl_htw:
 	 */
 
 
-	mfspr	r10,SPRN_MAS0
 	rldicr	r16,r11,0,62
 	lwz	r15,0(r16)
 
-- 
1.8.4.93.g57e4c17

