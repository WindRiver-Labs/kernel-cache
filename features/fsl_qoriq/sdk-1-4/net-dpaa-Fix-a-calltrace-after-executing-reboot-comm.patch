From 6cfba5e7724b929e1d210ddd6982624c08d8088d Mon Sep 17 00:00:00 2001
From: Yang Wei <Wei.Yang@windriver.com>
Date: Fri, 29 Nov 2013 16:58:22 +0800
Subject: [PATCH] net/dpaa: Fix a calltrace after executing reboot command

We need to check whether netdev is equal to NULL during
removing dpaa, as if we use usdpaa dtb we do not create
netdev when probing dpaa device node.

Rebooting... Unable to handle kernel paging request for data at address 0x000000f8
Faulting instruction address: 0xc0000000008402c4
Oops: Kernel access of bad area, sig: 11 [#1]
PREEMPT SMP NR_CPUS=24 LTT NESTING LEVEL : 0
T4240 QDS
Modules linked in:
NIP: c0000000008402c4 LR: c000000000842828 CTR: 0000000000000000
REGS: c000000538a1f5d0 TRAP: 0300   Not tainted  (3.4.43-grsec-WR5.0.1.9_cgl)
MSR: 0000000080029000 <CE,EE,ME>  CR: 22008442  XER: 20000000
SOFTE: 1
DEAR: 00000000000000f8, ESR: 0000000000800000
TASK = c00000053dac3f00[5886] 'reboot' THREAD: c000000538a1c000 CPU: 11
GPR00: 00000000000000f8 c000000538a1f850 c000000000dc1418 0000000000000000
GPR04: 0000000000000000 c000000000b191a8 0000000000000000 c00000000000a7ec
GPR08: 000000000000002a c000000538a1f8c0 0000000000000000 0000000000000000
GPR12: 0000000022008424 c00000000fffcc00 0000000000000000 0000000000000000
GPR16: 0000000000000000 0000000000000000 0000000010010000 0000000000000000
GPR20: 0000000000000001 0000000000000000 0000000010010000 000000001000263c
GPR24: 0000000010002900 0000000000000003 c000000000c43378 0000000010b25000
GPR28: 00000000000006c0 0000000000000000 c000000000d13508 0000000000000000
NIP [c0000000008402c4] .rollback_registered+0x24/0x60
LR [c000000000842828] .unregister_netdevice_queue+0x78/0xe0
Call Trace:
[c000000538a1f850] [c000000538a1f8e0] 0xc000000538a1f8e0 (unreliable)
[c000000538a1f8e0] [c000000000842828] .unregister_netdevice_queue+0x78/0xe0
[c000000538a1f970] [c0000000008428bc] .unregister_netdev+0x2c/0x50
[c000000538a1f9f0] [c0000000009b7490] .dpa_remove+0x54/0xb8
[c000000538a1fa80] [c0000000005712f0] .platform_drv_shutdown+0x40/0x60
[c000000538a1fb00] [c00000000056bd68] .device_shutdown+0x48/0x130
[c000000538a1fb90] [c00000000007eba4] .kernel_restart_prepare+0x54/0x70
[c000000538a1fc10] [c00000000007ebec] .kernel_restart+0x2c/0x80
[c000000538a1fc90] [c00000000007ee48] .SyS_reboot+0x1e8/0x2b0
[c000000538a1fe30] [c000000000000598] syscall_exit+0x0/0x60
Instruction dump:
ebc1fff0 ebe1fff8 4e800020 7c0802a6 f8010010 fbe1fff8 f821ff71 7c7f1b78
60000000 60000000 39210070 381f00f8 <f93f00f8> f93f0100 7d234b78 f8010078

Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 7f2be2f..399a58c 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -4269,9 +4269,12 @@ static int __devexit __cold dpa_remove(struct platform_device *of_dev)
 
 	dev = &of_dev->dev;
 	net_dev = dev_get_drvdata(dev);
+	dpaa_eth_sysfs_remove(dev);
+	if (!net_dev)
+		return 0;
+
 	priv = netdev_priv(net_dev);
 
-	dpaa_eth_sysfs_remove(dev);
 
 	dev_set_drvdata(dev, NULL);
 	unregister_netdev(net_dev);
-- 
1.7.5.4

