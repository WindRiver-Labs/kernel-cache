From 8ba9c8b2fa3f6c0bee9723fa37437c57e76ed74a Mon Sep 17 00:00:00 2001
From: Xie Xiaobo <r63061@freescale.com>
Date: Thu, 28 Mar 2013 18:10:33 +0800
Subject: [PATCH 310/547] powerpc/85xx: Adds IEEE1588 node in dts

The new property "fsl,ts-to-buffer" is introduced for
platforms which can get tx time stamp from skb buffer.
Some platforms, like mpc8572ds, can only get tx time stamp from
register, so these platforms have no this property.

Signed-off-by: Tang Yuantian <b29983@freescale.com>
Signed-off-by: Xie Xiaobo <X.Xie@freescale.com>
Change-Id: I4b2c9a7ad0c3a47c2c791ac7193f4ba5dc0c7627
Reviewed-on: http://git.am.freescale.net:8181/867
Reviewed-by: Manoil Claudiu-B08782 <claudiu.manoil@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch taken from QorIQ-SDK-V1.4-SOURCE-20130625-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 Documentation/devicetree/bindings/net/fsl-tsec-phy.txt | 12 ++++++++++++
 arch/powerpc/boot/dts/fsl/p1020si-post.dtsi            | 11 +++++++++++
 arch/powerpc/boot/dts/fsl/p1021si-post.dtsi            | 11 +++++++++++
 arch/powerpc/boot/dts/mpc8536ds.dtsi                   | 10 ++++++++++
 arch/powerpc/boot/dts/mpc8572ds.dtsi                   | 10 ++++++++++
 arch/powerpc/boot/dts/p1010rdb.dtsi                    | 11 +++++++++++
 arch/powerpc/boot/dts/p1022ds.dtsi                     | 10 ++++++++++
 arch/powerpc/boot/dts/p2020rdb-pc.dtsi                 | 11 +++++++++++
 8 files changed, 86 insertions(+)

diff --git a/Documentation/devicetree/bindings/net/fsl-tsec-phy.txt b/Documentation/devicetree/bindings/net/fsl-tsec-phy.txt
index 2c6be03..7d61c7e 100644
--- a/Documentation/devicetree/bindings/net/fsl-tsec-phy.txt
+++ b/Documentation/devicetree/bindings/net/fsl-tsec-phy.txt
@@ -92,6 +92,16 @@ Clock Properties:
   - fsl,tmr-fiper1   Fixed interval period pulse generator.
   - fsl,tmr-fiper2   Fixed interval period pulse generator.
   - fsl,max-adj      Maximum frequency adjustment in parts per billion.
+  - fsl,clock-source-select	 Value type: <u32>,
+                     select 1588 Timer reference clock source.
+                     0. External high precision timer reference
+                       clock (TSEC_1588_CLK_IN)
+                     1. eTSEC system clock
+                     2. eTSEC1 transmit clock
+                     3. RTC clock input.
+  - fsl,ts-to-buffer Value type <none>, if present, indicates that TSEC
+                     has ability to write time stamp of the transmitted
+					 frame to memory in the padding.
 
   These properties set the operational parameters for the PTP
   clock. You must choose these carefully for the clock to work right.
@@ -127,4 +137,6 @@ Example:
 		fsl,tmr-fiper1  = <0x3B9AC9F6>;
 		fsl,tmr-fiper2  = <0x00018696>;
 		fsl,max-adj     = <659999998>;
+		fsl,clock-source-select = <1>;
+		fsl,ts-to-buffer;
 	};
diff --git a/arch/powerpc/boot/dts/fsl/p1020si-post.dtsi b/arch/powerpc/boot/dts/fsl/p1020si-post.dtsi
index 684f664..2317af8 100644
--- a/arch/powerpc/boot/dts/fsl/p1020si-post.dtsi
+++ b/arch/powerpc/boot/dts/fsl/p1020si-post.dtsi
@@ -161,16 +161,27 @@
 /include/ "pq3-mpic.dtsi"
 /include/ "pq3-mpic-timer-B.dtsi"
 
+	ptp_timer: ptimer@b0e00 {
+		compatible = "fsl,gianfar-ptp-timer";
+		reg = <0xb0e00 0xb0>;
+		fsl,ts-to-buffer;
+		fsl,tmr-prsc = <0x2>;
+		fsl,clock-source-select = <1>;
+	};
+
 /include/ "pq3-etsec2-0.dtsi"
 	enet0: enet0_grp2: ethernet@b0000 {
+		ptimer-handle = <&ptp_timer>;
 	};
 
 /include/ "pq3-etsec2-1.dtsi"
 	enet1: enet1_grp2: ethernet@b1000 {
+		ptimer-handle = <&ptp_timer>;
 	};
 
 /include/ "pq3-etsec2-2.dtsi"
 	enet2: enet2_grp2: ethernet@b2000 {
+		ptimer-handle = <&ptp_timer>;
 	};
 
 	global-utilities@e0000 {
diff --git a/arch/powerpc/boot/dts/fsl/p1021si-post.dtsi b/arch/powerpc/boot/dts/fsl/p1021si-post.dtsi
index adb82fd..a02ea74 100644
--- a/arch/powerpc/boot/dts/fsl/p1021si-post.dtsi
+++ b/arch/powerpc/boot/dts/fsl/p1021si-post.dtsi
@@ -156,16 +156,27 @@
 /include/ "pq3-mpic.dtsi"
 /include/ "pq3-mpic-timer-B.dtsi"
 
+	ptp_timer: ptimer@b0e00 {
+		compatible = "fsl,gianfar-ptp-timer";
+		reg = <0xb0e00 0xb0>;
+		fsl,ts-to-buffer;
+		fsl,tmr-prsc = <0x2>;
+		fsl,clock-source-select = <1>;
+	};
+
 /include/ "pq3-etsec2-0.dtsi"
 	enet0: enet0_grp2: ethernet@b0000 {
+		ptimer-handle = <&ptp_timer>;
 	};
 
 /include/ "pq3-etsec2-1.dtsi"
 	enet1: enet1_grp2: ethernet@b1000 {
+		ptimer-handle = <&ptp_timer>;
 	};
 
 /include/ "pq3-etsec2-2.dtsi"
 	enet2: enet2_grp2: ethernet@b2000 {
+		ptimer-handle = <&ptp_timer>;
 	};
 
 	global-utilities@e0000 {
diff --git a/arch/powerpc/boot/dts/mpc8536ds.dtsi b/arch/powerpc/boot/dts/mpc8536ds.dtsi
index 7c3dde8..edb205f 100644
--- a/arch/powerpc/boot/dts/mpc8536ds.dtsi
+++ b/arch/powerpc/boot/dts/mpc8536ds.dtsi
@@ -190,10 +190,19 @@
 		phy_type = "ulpi";
 	};
 
+	ptp_timer: ptimer@24e00 {
+		compatible = "fsl,gianfar-ptp-timer";
+		reg = <0x24e00 0xb0>;
+		fsl,ts-to-buffer;
+		fsl,tmr-prsc = <0x2>;
+		fsl,clock-source-select = <1>;
+	};
+
 	enet0: ethernet@24000 {
 		tbi-handle = <&tbi0>;
 		phy-handle = <&phy1>;
 		phy-connection-type = "rgmii-id";
+		ptimer-handle = <&ptp_timer>;
 	};
 
 	mdio@24520 {
@@ -225,6 +234,7 @@
 		tbi-handle = <&tbi1>;
 		phy-handle = <&phy0>;
 		phy-connection-type = "rgmii-id";
+		ptimer-handle = <&ptp_timer>;
 	};
 
 	mdio@26520 {
diff --git a/arch/powerpc/boot/dts/mpc8572ds.dtsi b/arch/powerpc/boot/dts/mpc8572ds.dtsi
index 357490b..d877f42d 100644
--- a/arch/powerpc/boot/dts/mpc8572ds.dtsi
+++ b/arch/powerpc/boot/dts/mpc8572ds.dtsi
@@ -149,6 +149,7 @@
 		tbi-handle = <&tbi0>;
 		phy-handle = <&phy0>;
 		phy-connection-type = "rgmii-id";
+		ptimer-handle = <&ptp_timer>;
 	};
 
 	mdio@24520 {
@@ -201,10 +202,18 @@
 		fsl,max-adj = <499999999>;
 	};
 
+	ptp_timer: ptimer@24e00 {
+		compatible = "fsl,gianfar-ptp-timer";
+		reg = <0x24e00 0xb0>;
+		fsl,tmr-prsc = <0x2>;
+		fsl,clock-source-select = <1>;
+	};
+
 	enet1: ethernet@25000 {
 		tbi-handle = <&tbi1>;
 		phy-handle = <&phy1>;
 		phy-connection-type = "rgmii-id";
+		ptimer-handle = <&ptp_timer>;
 
 	};
 
@@ -219,6 +228,7 @@
 		tbi-handle = <&tbi2>;
 		phy-handle = <&phy2>;
 		phy-connection-type = "rgmii-id";
+		ptimer-handle = <&ptp_timer>;
 
 	};
 	mdio@26520 {
diff --git a/arch/powerpc/boot/dts/p1010rdb.dtsi b/arch/powerpc/boot/dts/p1010rdb.dtsi
index ec7c27a..0454771 100644
--- a/arch/powerpc/boot/dts/p1010rdb.dtsi
+++ b/arch/powerpc/boot/dts/p1010rdb.dtsi
@@ -227,20 +227,31 @@
 		};
 	};
 
+	ptp_timer: ptimer@b0e00 {
+		compatible = "fsl,gianfar-ptp-timer";
+		reg = <0xb0e00 0xb0>;
+		fsl,ts-to-buffer;
+		fsl,tmr-prsc = <0x2>;
+		fsl,clock-source-select = <1>;
+	};
+
 	enet0: ethernet@b0000 {
 		phy-handle = <&phy0>;
 		phy-connection-type = "rgmii-id";
+		ptimer-handle = <&ptp_timer>;
 	};
 
 	enet1: ethernet@b1000 {
 		phy-handle = <&phy1>;
 		tbi-handle = <&tbi0>;
 		phy-connection-type = "sgmii";
+		ptimer-handle = <&ptp_timer>;
 	};
 
 	enet2: ethernet@b2000 {
 		phy-handle = <&phy2>;
 		tbi-handle = <&tbi1>;
 		phy-connection-type = "sgmii";
+		ptimer-handle = <&ptp_timer>;
 	};
 };
diff --git a/arch/powerpc/boot/dts/p1022ds.dtsi b/arch/powerpc/boot/dts/p1022ds.dtsi
index 873da35..fb012c0 100644
--- a/arch/powerpc/boot/dts/p1022ds.dtsi
+++ b/arch/powerpc/boot/dts/p1022ds.dtsi
@@ -214,13 +214,23 @@
 		};
 	};
 
+	ptp_timer: ptimer@b0e00 {
+		compatible = "fsl,gianfar-ptp-timer";
+		reg = <0xb0e00 0xb0>;
+		fsl,ts-to-buffer;
+		fsl,tmr-prsc = <0x2>;
+		fsl,clock-source-select = <1>;
+	};
+
 	ethernet@b0000 {
 		phy-handle = <&phy0>;
 		phy-connection-type = "rgmii-id";
+		ptimer-handle = <&ptp_timer>;
 	};
 
 	ethernet@b1000 {
 		phy-handle = <&phy1>;
 		phy-connection-type = "rgmii-id";
+		ptimer-handle = <&ptp_timer>;
 	};
 };
diff --git a/arch/powerpc/boot/dts/p2020rdb-pc.dtsi b/arch/powerpc/boot/dts/p2020rdb-pc.dtsi
index c21d1c7..154fba4 100644
--- a/arch/powerpc/boot/dts/p2020rdb-pc.dtsi
+++ b/arch/powerpc/boot/dts/p2020rdb-pc.dtsi
@@ -223,19 +223,30 @@
 		fsl,max-adj = <249999999>;
 	};
 
+	ptp_timer: ptimer@24e00 {
+		compatible = "fsl,gianfar-ptp-timer";
+		reg = <0x24e00 0xb0>;
+		fsl,ts-to-buffer;
+		fsl,tmr-prsc = <0x2>;
+		fsl,clock-source-select = <1>;
+	};
+
 	enet0: ethernet@24000 {
 		fixed-link = <1 1 1000 0 0>;
 		phy-connection-type = "rgmii-id";
+		ptimer-handle = <&ptp_timer>;
 	};
 
 	enet1: ethernet@25000 {
 		tbi-handle = <&tbi0>;
 		phy-handle = <&phy0>;
 		phy-connection-type = "sgmii";
+		ptimer-handle = <&ptp_timer>;
 	};
 
 	enet2: ethernet@26000 {
 		phy-handle = <&phy1>;
 		phy-connection-type = "rgmii-id";
+		ptimer-handle = <&ptp_timer>;
 	};
 };
-- 
1.8.4.93.g57e4c17

