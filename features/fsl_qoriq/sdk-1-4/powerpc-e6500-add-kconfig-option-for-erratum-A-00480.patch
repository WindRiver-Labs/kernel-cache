From d7e24fbd825a7e6c1d259799f2771aa1a3f35d84 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Thu, 11 Jul 2013 14:56:47 +0800
Subject: [PATCH 338/430] powerpc/e6500: add kconfig option for erratum
 A-004801

Signed-off-by: Scott Wood <scottwood@freescale.com>
Change-Id: I4a8aca55e05837ffc68a2d4e3c249065c77c71ba
Reviewed-on: http://git.am.freescale.net:8181/2560
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>

[Original patch is from QorIQ-SDK-V1.4-20130625-yocto, just a minor
modification to port 3.4 kernel]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/mm/tlb_nohash_low.S       |    8 ++++++++
 arch/powerpc/platforms/Kconfig.cputype |   10 ++++++++++
 2 files changed, 18 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/mm/tlb_nohash_low.S b/arch/powerpc/mm/tlb_nohash_low.S
index 3b796b6..eb88794 100644
--- a/arch/powerpc/mm/tlb_nohash_low.S
+++ b/arch/powerpc/mm/tlb_nohash_low.S
@@ -327,6 +327,7 @@ ALT_MMU_FTR_SECTION_END_IFCLR(MMU_FTR_USE_TLBILX)
 	blr
 #elif defined(CONFIG_PPC_BOOK3E)
 
+#ifdef CONFIG_FSL_ERRATUM_A_004801
 .macro tlb_lock
 	ld	r7,PACA_TLB_PER_CORE_PTR(r13)
 	mtocrf	0x01,r7
@@ -355,6 +356,13 @@ ALT_MMU_FTR_SECTION_END_IFCLR(MMU_FTR_USE_TLBILX)
 	stb	r9,0(r8)
 1:
 .endm
+#else
+.macro tlb_lock
+.endm
+
+.macro tlb_unlock
+.endm
+#endif
 
 /*
  * New Book3E (>= 2.06) implementation
diff --git a/arch/powerpc/platforms/Kconfig.cputype b/arch/powerpc/platforms/Kconfig.cputype
index dd21a1d..04bf813 100644
--- a/arch/powerpc/platforms/Kconfig.cputype
+++ b/arch/powerpc/platforms/Kconfig.cputype
@@ -140,6 +140,16 @@ config PPC_E500MC
 	select COMMON_CLK
 	depends on E500
 
+config FSL_ERRATUM_A_004801
+	bool "Work around erratum A-004801"
+	depends on PPC_E500MC
+	default y
+	help
+	  This works around erratum A-004801 by having invalidations
+	  use the same lock as TLB writes.
+
+	  Say Y if if you need to be able to run on rev1 silicon.
+
 config FSL_ERRATUM_A_005337
 	bool "Work around erratum A-005337 (no hw tablewalk)"
 	depends on PPC_E500MC
-- 
1.7.5.4

