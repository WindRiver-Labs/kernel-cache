From e7f4ef53f7890ded73d06a76fd0efccdd8605d8e Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Thu, 16 May 2013 18:15:04 -0500
Subject: [PATCH 016/547] powerpc/e6500: add kconfig option for erratum
 A-004801

Signed-off-by: Scott Wood <scottwood@freescale.com>
Change-Id: I4a8aca55e05837ffc68a2d4e3c249065c77c71ba
Reviewed-on: http://git.am.freescale.net:8181/2560
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch taken from QorIQ-SDK-V1.4-SOURCE-20130625-yocto.iso
 The default value of FSL_ERRATUM_A_004801 is set to 'n'.]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/mm/tlb_nohash_low.S       |  8 ++++++++
 arch/powerpc/platforms/Kconfig.cputype | 10 ++++++++++
 2 files changed, 18 insertions(+)

diff --git a/arch/powerpc/mm/tlb_nohash_low.S b/arch/powerpc/mm/tlb_nohash_low.S
index 4f64fb1..caa03a0 100644
--- a/arch/powerpc/mm/tlb_nohash_low.S
+++ b/arch/powerpc/mm/tlb_nohash_low.S
@@ -314,6 +314,7 @@ ALT_MMU_FTR_SECTION_END_IFCLR(MMU_FTR_USE_TLBILX)
 	blr
 #elif defined(CONFIG_PPC_BOOK3E)
 
+#ifdef CONFIG_FSL_ERRATUM_A_004801
 .macro tlb_lock
 	ld	r7,PACA_TLB_PER_CORE_PTR(r13)
 	mtocrf	0x01,r7
@@ -342,6 +343,13 @@ ALT_MMU_FTR_SECTION_END_IFCLR(MMU_FTR_USE_TLBILX)
 	stb	r9,0(r8)
 1:
 .endm
+#else
+.macro tlb_lock
+.endm
+
+.macro tlb_unlock
+.endm
+#endif
 
 /*
  * New Book3E (>= 2.06) implementation
diff --git a/arch/powerpc/platforms/Kconfig.cputype b/arch/powerpc/platforms/Kconfig.cputype
index 27be19c..07e328e 100644
--- a/arch/powerpc/platforms/Kconfig.cputype
+++ b/arch/powerpc/platforms/Kconfig.cputype
@@ -164,6 +164,16 @@ config PPC_E500MC
 	  such as e5500/e6500), and must be disabled for running on
 	  e500v1 or e500v2.
 
+config FSL_ERRATUM_A_004801
+	bool "Work around erratum A-004801"
+	depends on PPC_E500MC
+	default n
+	help
+	  This works around erratum A-004801 by having invalidations
+	  use the same lock as TLB writes.
+
+	  Say Y if if you need to be able to run on rev1 silicon.
+
 config FSL_ERRATUM_A_005337
 	bool "Work around erratum A-005337 (no hw tablewalk)"
 	depends on PPC_E500MC
-- 
1.8.4.93.g57e4c17

