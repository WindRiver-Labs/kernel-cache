From 11bb3f725de6432a3d5b13a337b2f758fe416618 Mon Sep 17 00:00:00 2001
From: Yang Wei <Wei.Yang@windriver.com>
Date: Mon, 5 Aug 2013 09:58:59 +0800
Subject: [PATCH 295/430] powerpc/booke: Separate out
 restore_e5500/setup_e5500 routines.

commit 0778407f836d632cce90e5d9df490a7c5e6e398a upstream

For the 64 bit case separate out e5500 cpu_setup and cpu_restore functions.
The cpu_setup function (for the primary core) is passed the cpu_spec
pointer, which is not there in case of the cpu_restore function. Also, in
our case we will have to manipulate the CPU_FTR_EMB_HV flag on the primary
core.

Signed-off-by: Varun Sethi <Varun.Sethi@freescale.com>
Signed-off-by: Kumar Gala <galak@kernel.crashing.org>
Signed-off-by: Wei Yang <Wei.Yang@windriver.com>
---
 arch/powerpc/kernel/cpu_setup_fsl_booke.S |   15 +++++++--------
 1 files changed, 7 insertions(+), 8 deletions(-)

diff --git a/arch/powerpc/kernel/cpu_setup_fsl_booke.S b/arch/powerpc/kernel/cpu_setup_fsl_booke.S
index 4c4510f..50eaab3 100644
--- a/arch/powerpc/kernel/cpu_setup_fsl_booke.S
+++ b/arch/powerpc/kernel/cpu_setup_fsl_booke.S
@@ -111,6 +111,11 @@ _GLOBAL(__restore_cpu_e5500)
 	bl	.__setup_base_ivors
 	bl	.setup_perfmon_ivor
 	bl	.setup_doorbell_ivors
+	/*
+	 * We only want to touch IVOR38-41 if we're running on hardware
+	 * that supports category E.HV.  The architectural way to determine
+	 * this is MMUCFG[LPIDSIZE].
+	 */
 	mfspr	r10,SPRN_MMUCFG
 	rlwinm.	r10,r10,0,MMUCFG_LPIDSIZE
 	beq	1f
@@ -119,8 +124,7 @@ _GLOBAL(__restore_cpu_e5500)
 	blr
 
 _GLOBAL(__setup_cpu_e5500)
-	mr	r5, r4
-	mflr	r4
+	mflr	r5
 	bl	__e500_icache_setup
 	bl	__e500_dcache_setup
 	bl	.__setup_base_ivors
@@ -134,11 +138,6 @@ _GLOBAL(__setup_cpu_e5500)
 	rlwinm.	r10,r10,0,MMUCFG_LPIDSIZE
 	beq	1f
 	bl	.setup_ehv_ivors
-	b	2f
-1:	ld	r10,CPU_SPEC_FEATURES(r5)
-	LOAD_REG_IMMEDIATE(r9,CPU_FTR_EMB_HV)
-	andc	r10,r10,r9
-	std	r10,CPU_SPEC_FEATURES(r5)
-2:	mtlr    r4
+1:	mtlr    r5
 	blr
 #endif
-- 
1.7.5.4

