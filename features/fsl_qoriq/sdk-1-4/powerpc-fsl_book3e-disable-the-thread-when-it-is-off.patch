From 614dccdbd70969a9c047c3f787b4d6b5625eb157 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Mon, 25 Mar 2013 10:05:31 +0800
Subject: [PATCH 535/547] powerpc/fsl_book3e: disable the thread when it is
 offline

When a thread is offline, we should disable it instead of spin here.
This should improve the performance of other threads which is still
running.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/platforms/85xx/smp.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/arch/powerpc/platforms/85xx/smp.c b/arch/powerpc/platforms/85xx/smp.c
index a29dda8b..d4eb87b 100644
--- a/arch/powerpc/platforms/85xx/smp.c
+++ b/arch/powerpc/platforms/85xx/smp.c
@@ -199,6 +199,13 @@ static void __cpuinit smp_85xx_mach_cpu_die(void)
 
 	generic_set_cpu_dead(cpu);
 
+	if (cpu_has_feature(CPU_FTR_SMT)) {
+		cpu = cpu_thread_in_core(cpu);
+		cpu = 1 << cpu;
+		mb();
+		mtspr(SPRN_TENC, cpu);
+	}
+
 	while (1)
 		;
 }
-- 
1.8.4.93.g57e4c17

