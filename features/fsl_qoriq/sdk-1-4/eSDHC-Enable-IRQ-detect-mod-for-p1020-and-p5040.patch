From 4064917e101a5606ad71d93a8d2e7378a5a88722 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Fri, 28 Jun 2013 17:05:19 +0800
Subject: [PATCH 268/430] eSDHC: Enable IRQ detect mod for p1020 and p5040

Card insert and remove interrupt can be generate and work well.
So using IRQ mod for card detecting instead of polling mod.

This patch can avoid the call trace bug used to produce.
also can improve the performance for card data transfer.
Avoid no necessary frequent access to cpu and card.

Signed-off-by: Haijun Zhang <haijun.zhang@freescale.com>
Change-Id: I06b98f0bdc5208d0bf41a2ca79a78435b5c1bd27
Reviewed-on: http://git.am.freescale.net:8181/1218
Reviewed-by: Xie Xiaobo-R63061 <X.Xie@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch is from QorIQ-SDK-V1.4-20130625-yocto, just a minor
modification to port 3.4 kernel]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/mmc/host/sdhci-pltfm.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/mmc/host/sdhci-pltfm.c b/drivers/mmc/host/sdhci-pltfm.c
index 0cc9729..18accf8 100644
--- a/drivers/mmc/host/sdhci-pltfm.c
+++ b/drivers/mmc/host/sdhci-pltfm.c
@@ -93,6 +93,10 @@ void sdhci_get_of_property(struct platform_device *pdev)
 			host->quirks |= SDHCI_QUIRK_BROKEN_ADMA;
 		}
 
+		if (of_device_is_compatible(np, "fsl,p5040-esdhc") ||
+			of_device_is_compatible(np, "fsl,p4080-esdhc") ||
+			of_device_is_compatible(np, "fsl,p1020-esdhc"))
+			host->quirks &= ~SDHCI_QUIRK_BROKEN_CARD_DETECTION;
 
 		clk = of_get_property(np, "clock-frequency", &size);
 		if (clk && size == sizeof(*clk) && *clk)
-- 
1.7.5.4

