From 3b00f7503ce85525f448dcd1117de6fcf58df0e6 Mon Sep 17 00:00:00 2001
From: "Haijun.Zhang" <haijun.zhang@freescale.com>
Date: Thu, 18 Apr 2013 16:23:33 +0800
Subject: [PATCH 367/547] eSDHC: Enable IRQ detect mod for p1020 and p5040

Card insert and remove interrupt can be generate and work well.
So using IRQ mod for card detecting instead of polling mod.

This patch can avoid the call trace bug used to produce.
also can improve the performance for card data transfer.
Avoid no necessary frequent access to cpu and card.

Signed-off-by: Haijun Zhang <haijun.zhang@freescale.com>
Change-Id: I06b98f0bdc5208d0bf41a2ca79a78435b5c1bd27
Reviewed-on: http://git.am.freescale.net:8181/1218
Reviewed-by: Xie Xiaobo-R63061 <X.Xie@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch taken from QorIQ-SDK-V1.4-SOURCE-20130625-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/mmc/host/sdhci-pltfm.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/drivers/mmc/host/sdhci-pltfm.c b/drivers/mmc/host/sdhci-pltfm.c
index c982cc3..038f153 100644
--- a/drivers/mmc/host/sdhci-pltfm.c
+++ b/drivers/mmc/host/sdhci-pltfm.c
@@ -102,6 +102,10 @@ void sdhci_get_of_property(struct platform_device *pdev)
 			host->quirks |= SDHCI_QUIRK_BROKEN_ADMA;
 		}
 
+		if (of_device_is_compatible(np, "fsl,p5040-esdhc") ||
+			of_device_is_compatible(np, "fsl,p1020-esdhc"))
+			host->quirks &= ~SDHCI_QUIRK_BROKEN_CARD_DETECTION;
+
 		clk = of_get_property(np, "clock-frequency", &size);
 		if (clk && size == sizeof(*clk) && *clk)
 			pltfm_host->clock = be32_to_cpup(clk);
-- 
1.8.4.93.g57e4c17

