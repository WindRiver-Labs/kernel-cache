From 28567228b9aabdb2e464bf00601e38ff56466228 Mon Sep 17 00:00:00 2001
From: Wei Yang <Wei.Yang@windriver.com>
Date: Thu, 11 Jul 2013 14:14:47 +0800
Subject: [PATCH 383/430] b4qds: DPAA support in device trees of B4860 and
 B4420

B4860 has 6 1G SGMII and 2 10G interfaces
B4420 has 4 1G SGMII and no 10G

The QDS board has 2 on board SGMII PHYs and other 1G interfaces can be
exercised using SGMII Riser card mounted on a slot on AMC card.
10G interfaces can be used using XAUI riser cards on slots on AMC card.

Also included e6500_power_isa.dtsi in b4860/4420si-post.dtsi to match up with T4.

Signed-off-by: Sandeep Singh <sandeep@freescale.com>
Signed-off-by: Suresh Gupta  <suresh.gupta@freescale.com>
Signed-off-by: Poonam Aggrwal <poonam.aggrwal@freescale.com>
Change-Id: I58231f43a75ebfa63bb9c9b3f6717848f0f6f6ed
Reviewed-on: http://git.am.freescale.net:8181/1358
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch is from QorIQ-SDK-V1.4-20130625-yocto]
Signed-off-by: Wei Yang <Wei.Yang@windriver.com>
---
 arch/powerpc/boot/dts/b4420qds.dts          |   46 ++++++++-----
 arch/powerpc/boot/dts/b4860qds.dts          |   98 ++++++++++++++++++++-------
 arch/powerpc/boot/dts/fsl/b4420si-post.dtsi |   30 ++++++++
 arch/powerpc/boot/dts/fsl/b4420si-pre.dtsi  |   14 ++++
 arch/powerpc/boot/dts/fsl/b4860si-post.dtsi |    2 +
 arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi  |   15 ++++
 6 files changed, 165 insertions(+), 40 deletions(-)

diff --git a/arch/powerpc/boot/dts/b4420qds.dts b/arch/powerpc/boot/dts/b4420qds.dts
index bc2b03e..316e1b2 100644
--- a/arch/powerpc/boot/dts/b4420qds.dts
+++ b/arch/powerpc/boot/dts/b4420qds.dts
@@ -42,10 +42,10 @@
 	interrupt-parent = <&mpic>;
 
 	aliases{
-		ethernet0 = &enet0;
-		ethernet1 = &enet1;
-		ethernet2 = &enet2;
-		ethernet3 = &enet3;
+		phy_sgmii_10 = &phy_sgmii_10;
+		phy_sgmii_11 = &phy_sgmii_11;
+		phy_sgmii_1c = &phy_sgmii_1c;
+		phy_sgmii_1d = &phy_sgmii_1d;
 	};
 
 	ifc: localbus@ffe124000 {
@@ -162,22 +162,36 @@
 		};
 
 		fman0: fman@400000 {
-			enet0: ethernet@e0000 {
-				fixed-link = <1 1 1000 0 0 >;
+			fm1mac1: ethernet@e0000 {
+				phy-handle = <&phy_sgmii_10>;
 				phy-connection-type = "sgmii";
 			};
-			enet1: ethernet@e2000 {
-				fixed-link = <2 1 1000 0 0 >;
+			fm1mac2: ethernet@e2000 {
+				phy-handle = <&phy_sgmii_11>;
 				phy-connection-type = "sgmii";
 			};
-			enet2: ethernet@e4000 {
-				fixed-link = <3 1 1000 0 0 >;
+			fm1mac3: ethernet@e4000 {
+				phy-handle = <&phy_sgmii_1c>;
 				phy-connection-type = "sgmii";
 			};
-			enet3: ethernet@e6000 {
-				fixed-link = <4 1 1000 0 0 >;
+			fm1mac4: ethernet@e6000 {
+				phy-handle = <&phy_sgmii_1d>;
 				phy-connection-type = "sgmii";
 			};
+			mdio0: mdio@fc000 {
+				phy_sgmii_10: ethernet-phy@10 {
+					reg = <0x10>;
+				};
+				phy_sgmii_11: ethernet-phy@11 {
+					reg = <0x11>;
+				};
+				phy_sgmii_1c: ethernet-phy@1c {
+					reg = <0x1c>;
+				};
+				phy_sgmii_1d: ethernet-phy@1d {
+					reg = <0x1d>;
+				};
+			};
 		};
 	};
 
@@ -200,19 +214,19 @@
 		compatible = "fsl,b4420-dpaa", "fsl,dpaa";
 		ethernet@0 {
 			compatible = "fsl,b4420-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet0>;
+			fsl,fman-mac = <&fm1mac1>;
 		};
 		ethernet@1 {
 			compatible = "fsl,b4420-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet1>;
+			fsl,fman-mac = <&fm1mac2>;
 		};
 		ethernet@2 {
 			compatible = "fsl,b4420-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet2>;
+			fsl,fman-mac = <&fm1mac3>;
 		};
 		ethernet@3 {
 			compatible = "fsl,b4420-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet3>;
+			fsl,fman-mac = <&fm1mac4>;
 		};
 	};
 };
diff --git a/arch/powerpc/boot/dts/b4860qds.dts b/arch/powerpc/boot/dts/b4860qds.dts
index 57fe865..127a218 100644
--- a/arch/powerpc/boot/dts/b4860qds.dts
+++ b/arch/powerpc/boot/dts/b4860qds.dts
@@ -42,12 +42,14 @@
 	interrupt-parent = <&mpic>;
 
 	aliases{
-		ethernet0 = &enet0;
-		ethernet1 = &enet1;
-		ethernet2 = &enet2;
-		ethernet3 = &enet3;
-		ethernet4 = &enet4;
-		ethernet5 = &enet5;
+		phy_sgmii_11 = &phy_sgmii_11;
+		phy_sgmii_1c = &phy_sgmii_1c;
+		phy_sgmii_1d = &phy_sgmii_1d;
+		phy_sgmii_1e = &phy_sgmii_1e;
+		phy_sgmii_1f = &phy_sgmii_1f;
+
+		phy_xaui_slot1 = &phy_xaui_slot1;
+		phy_xaui_slot2 = &phy_xaui_slot2;
 	};
 
 	ifc: localbus@ffe124000 {
@@ -167,30 +169,70 @@
 		};
 
 		fman0: fman@400000 {
-			enet0: ethernet@e0000 {
-				fixed-link = <1 1 1000 0 0 >;
+			fm1mac1: ethernet@e0000 {
+				phy-handle = <&phy_sgmii_10>;
 				phy-connection-type = "sgmii";
 			};
-			enet1: ethernet@e2000 {
-				fixed-link = <2 1 1000 0 0 >;
+			fm1mac2: ethernet@e2000 {
+				phy-handle = <&phy_sgmii_11>;
 				phy-connection-type = "sgmii";
 			};
-			enet2: ethernet@e4000 {
-				fixed-link = <3 1 1000 0 0 >;
+			fm1mac3: ethernet@e4000 {
+				phy-handle = <&phy_sgmii_1c>;
 				phy-connection-type = "sgmii";
 			};
-			enet3: ethernet@e6000 {
-				fixed-link = <4 1 1000 0 0 >;
+			fm1mac4: ethernet@e6000 {
+				phy-handle = <&phy_sgmii_1d>;
 				phy-connection-type = "sgmii";
 			};
-			enet4: ethernet@e8000 {
-				fixed-link = <5 1 1000 0 0 >;
+			fm1mac5: ethernet@e8000 {
+				phy-handle = <&phy_sgmii_1e>;
 				phy-connection-type = "sgmii";
 			};
-			enet5: ethernet@ea000 {
-				fixed-link = <6 1 1000 0 0 >;
+			fm1mac6: ethernet@ea000 {
+				phy-handle = <&phy_sgmii_1f>;
 				phy-connection-type = "sgmii";
 			};
+			fm1mac9: ethernet@f0000 { /* FM1@TGEC2 */
+				phy-handle = <&phy_xaui_slot1>;
+				phy-connection-type = "xgmii";
+			};
+			fm1mac10: ethernet@f2000 { /* FM1@TGEC1 */
+				phy-handle = <&phy_xaui_slot2>;
+				phy-connection-type = "xgmii";
+			};
+			mdio0: mdio@fc000 {
+				phy_sgmii_10: ethernet-phy@10 {
+					reg = <0x10>;
+				};
+				phy_sgmii_11: ethernet-phy@11 {
+					reg = <0x11>;
+				};
+				phy_sgmii_1c: ethernet-phy@1c {
+					reg = <0x1c>;
+				};
+				phy_sgmii_1d: ethernet-phy@1d {
+					reg = <0x1d>;
+				};
+				phy_sgmii_1e: ethernet-phy@1e {
+					reg = <0x1e>;
+				};
+				phy_sgmii_1f: ethernet-phy@1f {
+					reg = <0x1f>;
+				};
+			};
+
+			xmdio0: mdio@fd000 {
+				/* For 10g interfaces */
+				phy_xaui_slot1: xaui-phy@slot1 {
+					compatible = "ethernet-phy-ieee802.3-c45";
+					reg = <0x7>; /* default switch setting on slot1 of AMC2PEX */
+				};
+				phy_xaui_slot2: xaui-phy@slot2 {
+					compatible = "ethernet-phy-ieee802.3-c45";
+					reg = <0x6>; /* default switch setting on slot1 of AMC2PEX */
+				};
+			};
 		};
 	};
 
@@ -224,27 +266,35 @@
 		compatible = "fsl,b4860-dpaa", "fsl,dpaa";
 		ethernet@0 {
 			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet0>;
+			fsl,fman-mac = <&fm1mac1>;
 		};
 		ethernet@1 {
 			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet1>;
+			fsl,fman-mac = <&fm1mac2>;
 		};
 		ethernet@2 {
 			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet2>;
+			fsl,fman-mac = <&fm1mac3>;
 		};
 		ethernet@3 {
 			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet3>;
+			fsl,fman-mac = <&fm1mac4>;
 		};
 		ethernet@4 {
 			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet4>;
+			fsl,fman-mac = <&fm1mac5>;
 		};
 		ethernet@5 {
 			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet5>;
+			fsl,fman-mac = <&fm1mac6>;
+		};
+		ethernet@8 {
+			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,fman-mac = <&fm1mac9>;
+		};
+		ethernet@9 {
+			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,fman-mac = <&fm1mac10>;
 		};
 	};
 };
diff --git a/arch/powerpc/boot/dts/fsl/b4420si-post.dtsi b/arch/powerpc/boot/dts/fsl/b4420si-post.dtsi
index 4cfdb8e..c8252fd 100644
--- a/arch/powerpc/boot/dts/fsl/b4420si-post.dtsi
+++ b/arch/powerpc/boot/dts/fsl/b4420si-post.dtsi
@@ -327,6 +327,11 @@
 		interrupts = <16 2 1 29>;
 	};
 
+/include/ "qoriq-rman-0.dtsi"
+	rman: rman@1e0000 {
+		fsl,qman-channels-id = <0x820 0x821>;
+	};
+
 /include/ "qoriq-fman3-0.dtsi"
 /include/ "qoriq-fman3-0-1g-0.dtsi"
 /include/ "qoriq-fman3-0-1g-1.dtsi"
@@ -353,6 +358,31 @@
 		port@ab000 {
 			fsl,qman-channel-id = <0x805>;
 		};
+		/* offline - 0 is not usable on B4860 */
+		/* offline - 1 */
+		port@82000 {
+			fsl,qman-channel-id = <0x809>;
+		};
+		/* offline - 2 */
+		port@83000 {
+			fsl,qman-channel-id = <0x80a>;
+		};
+		/* offline - 3 */
+		port@84000 {
+			fsl,qman-channel-id = <0x80b>;
+		};
+		/* offline - 4 */
+		port@85000 {
+			fsl,qman-channel-id = <0x80c>;
+		};
+		/* offline - 5 */
+		port@86000 {
+			fsl,qman-channel-id = <0x80d>;
+		};
+		/* offline - 6 */
+		port@87000 {
+			fsl,qman-channel-id = <0x80e>;
+		};
 	};
 
 /include/ "qoriq-mpic.dtsi"
diff --git a/arch/powerpc/boot/dts/fsl/b4420si-pre.dtsi b/arch/powerpc/boot/dts/fsl/b4420si-pre.dtsi
index c01eb90..95ac27b 100644
--- a/arch/powerpc/boot/dts/fsl/b4420si-pre.dtsi
+++ b/arch/powerpc/boot/dts/fsl/b4420si-pre.dtsi
@@ -33,6 +33,8 @@
  */
 
 /dts-v1/;
+/include/ "e6500_power_isa.dtsi"
+
 / {
 	compatible = "fsl,B4420";
 	#address-cells = <2>;
@@ -54,6 +56,13 @@
 
 		fman0 = &fman0;
 		crypto = &crypto;
+		qman = &qman;
+		bman = &bman;
+		ethernet0 = &fm1mac1;
+		ethernet1 = &fm1mac2;
+		ethernet2 = &fm1mac3;
+		ethernet3 = &fm1mac4;
+
 		sec_jr0 = &sec_jr0;
 		sec_jr1 = &sec_jr1;
 		sec_jr2 = &sec_jr2;
@@ -68,6 +77,11 @@
 	cpus {
 		#address-cells = <1>;
 		#size-cells = <0>;
+		/*
+		 * Temporarily add next-level-cache info in each cpu node so
+		 * that uboot can do L2 cache fixup. This can be removed once
+		 * u-boot can create cpu node with cache info.
+		 */
 
 		PowerPC,e6500@0 {
 			device_type = "cpu";
diff --git a/arch/powerpc/boot/dts/fsl/b4860si-post.dtsi b/arch/powerpc/boot/dts/fsl/b4860si-post.dtsi
index 9d6dc2c..b6b7552 100644
--- a/arch/powerpc/boot/dts/fsl/b4860si-post.dtsi
+++ b/arch/powerpc/boot/dts/fsl/b4860si-post.dtsi
@@ -522,6 +522,8 @@
 /include/ "qoriq-fman3-0-1g-3.dtsi"
 /include/ "qoriq-fman3-0-1g-4.dtsi"
 /include/ "qoriq-fman3-0-1g-5.dtsi"
+/include/ "qoriq-fman3-0-10g-0.dtsi"
+/include/ "qoriq-fman3-0-10g-1.dtsi"
 	fman0: fman@400000 {
 		interrupts = <
 			96 2 0 0
diff --git a/arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi b/arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi
index 7a769d6..47ab01a 100644
--- a/arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi
+++ b/arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi
@@ -33,6 +33,8 @@
  */
 
 /dts-v1/;
+/include/ "e6500_power_isa.dtsi"
+
 / {
 	compatible = "fsl,B4860";
 	#address-cells = <2>;
@@ -56,6 +58,14 @@
 		bman = &bman;
 
 		fman0 = &fman0;
+		ethernet0 = &fm1mac1;
+		ethernet1 = &fm1mac2;
+		ethernet2 = &fm1mac3;
+		ethernet3 = &fm1mac4;
+		ethernet4 = &fm1mac5;
+		ethernet5 = &fm1mac6;
+		ethernet8 = &fm1mac9;
+		ethernet9 = &fm1mac10;
 		crypto = &crypto;
 		sec_jr0 = &sec_jr0;
 		sec_jr1 = &sec_jr1;
@@ -72,6 +82,11 @@
 		#address-cells = <1>;
 		#size-cells = <0>;
 
+		/*
+		 * Temporarily add next-level-cache info in each cpu node so
+		 * that uboot can do L2 cache fixup. This can be removed once
+		 * u-boot can create cpu node with cache info.
+		 */
 		PowerPC,e6500@0 {
 			device_type = "cpu";
 			reg = <0 1>;
-- 
1.7.5.4

