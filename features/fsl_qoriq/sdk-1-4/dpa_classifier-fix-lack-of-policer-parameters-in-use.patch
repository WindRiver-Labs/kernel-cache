From 5ee3e8a57eea9dbfebbf5349e8546fcc1041a68a Mon Sep 17 00:00:00 2001
From: Anca Jeanina FLOAREA <anca.floarea@freescale.com>
Date: Thu, 16 May 2013 11:29:09 +0300
Subject: [PATCH 406/547] dpa_classifier: fix lack of policer parameters in
 user read operation

Policer parameters were not provided when user performs a read
operation for table action, in compat mode.

Signed-off-by: Anca Jeanina FLOAREA <anca.floarea@freescale.com>
Change-Id: Ib8a592ba4016a311b142573297d43ee7befb0d3e
Reviewed-on: http://git.am.freescale.net:8181/2542
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch taken from QorIQ-SDK-V1.4-SOURCE-20130625-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/staging/fsl_dpa_offload/wrp_dpa_classifier.c | 19 +++++++++++++------
 1 file changed, 13 insertions(+), 6 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_classifier.c b/drivers/staging/fsl_dpa_offload/wrp_dpa_classifier.c
index aa2017a..cc67eef 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_classifier.c
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_classifier.c
@@ -2508,12 +2508,19 @@ int dpa_cls_tbl_action_params_rcompatcpy(
 				kparam->enq_params.new_fqid;
 		uparam->enq_params.hmd = kparam->enq_params.hmd;
 
-		/*
-		 * Policer params structure address has no meaning in user
-		 * space
-		 */
-		uparam->enq_params.policer_params = 0;
-
+		if (kparam->enq_params.policer_params) {
+			BUG_ON(!compat_ptr(uparam->enq_params.policer_params));
+			if (copy_to_user(
+				compat_ptr(uparam->enq_params.policer_params),
+				kparam->enq_params.policer_params,
+				sizeof(struct dpa_cls_tbl_policer_params))) {
+				pr_err("ERROR: %s, %s (%d): Read failed: "
+					"policer params.\n", __FILE__, __func__,
+					__LINE__);
+				return -EBUSY;
+			}
+		} else
+			uparam->enq_params.policer_params = 0;
 		break;
 	case DPA_CLS_TBL_ACTION_NEXT_TABLE:
 		uparam->next_table_params.next_td =
-- 
1.8.4.93.g57e4c17

