From 5a7349a3e29108e39413635c71482af175cc17e3 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Fri, 2 Aug 2013 17:38:30 +0800
Subject: [PATCH 167/430] net/dpa: protect qman_irqsource_add/remove with
 preempt disabled

The qman_irqsource_add/remove are used to enable/disable a specific
interrupt source to assert the interrupt signal to the portal
which is bind to the current cpu. So we must make sure
that the pair of qman_irqsource_add/remove are run on the same
cpu.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 2f81760..b9a89db 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -2892,8 +2892,8 @@ fq_init_fail:
 
 fq_create_fail:
 	priv->egress_fqs[smp_processor_id()] = oldq;
-	local_bh_enable();
 	qman_irqsource_add(QM_PIRQ_DQRI);
+	local_bh_enable();
 	tx_unit_test_ran = true;
 	set_cpus_allowed_ptr(current, old_cpumask);
 	free_cpumask_var(old_cpumask);
-- 
1.7.5.4

