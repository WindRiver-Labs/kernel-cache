From dedad2fe2787d4810374023deab0b17e9c42852f Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Wed, 31 Oct 2012 14:02:56 +0800
Subject: [PATCH 463/547] net/dpa: protect qman_irqsource_add/remove with
 preempt disabled

The qman_irqsource_add/remove are used to enable/disable a specific
interrupt source to assert the interrupt signal to the portal
which is bind to the current cpu. So we must make sure
that the pair of qman_irqsource_add/remove are run on the same
cpu.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index c1e1638..7065cbe 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -2892,8 +2892,8 @@ fq_init_fail:
 
 fq_create_fail:
 	priv->egress_fqs[smp_processor_id()] = oldq;
-	local_bh_enable();
 	qman_irqsource_add(QM_PIRQ_DQRI);
+	local_bh_enable();
 	tx_unit_test_ran = true;
 	set_cpus_allowed_ptr(current, old_cpumask);
 	free_cpumask_var(old_cpumask);
-- 
1.8.4.93.g57e4c17

