From 62d508c8c56f0632c34259d3fc9a1cd55b2bb81a Mon Sep 17 00:00:00 2001
From: Varun Sethi <Varun.Sethi@freescale.com>
Date: Mon, 9 Jul 2012 18:28:21 +0530
Subject: [PATCH 294/430] powerpc/booke: Merge the 32 bit e5500/e500mc cpu
 setup code.

commit 2c71b0cc4a626d8bd02b88b3b92ce18be4d54c6d upstream

Merge the 32 bit cpu setup code for e500mc/e5500 and define the
"cpu_restore" routine (for e5500/e6500) only for the 64 bit case. The
cpu_restore routine is used in the 64 bit case for setting up the secondary
cores.

Signed-off-by: Varun Sethi <Varun.Sethi@freescale.com>
Signed-off-by: Kumar Gala <galak@kernel.crashing.org>
Signed-off-by: Wei Yang <Wei.Yang@windriver.com>
---
 arch/powerpc/kernel/cpu_setup_fsl_booke.S |   17 +++++------------
 arch/powerpc/kernel/cputable.c            |    2 ++
 2 files changed, 7 insertions(+), 12 deletions(-)

diff --git a/arch/powerpc/kernel/cpu_setup_fsl_booke.S b/arch/powerpc/kernel/cpu_setup_fsl_booke.S
index c07d538..4c4510f 100644
--- a/arch/powerpc/kernel/cpu_setup_fsl_booke.S
+++ b/arch/powerpc/kernel/cpu_setup_fsl_booke.S
@@ -84,6 +84,7 @@ _GLOBAL(__setup_cpu_e500v2)
 	mtlr	r4
 	blr
 _GLOBAL(__setup_cpu_e500mc)
+_GLOBAL(__setup_cpu_e5500)
 	mr	r5, r4
 	mflr	r4
 	bl	__e500_icache_setup
@@ -102,11 +103,11 @@ _GLOBAL(__restore_cpu_e6500)
 	blr
 #endif
 
+#ifdef CONFIG_PPC_BOOK3E_64
 _GLOBAL(__restore_cpu_e5500)
 	mflr	r4
 	bl	__e500_icache_setup
 	bl	__e500_dcache_setup
-#ifdef CONFIG_PPC_BOOK3E_64
 	bl	.__setup_base_ivors
 	bl	.setup_perfmon_ivor
 	bl	.setup_doorbell_ivors
@@ -114,11 +115,7 @@ _GLOBAL(__restore_cpu_e5500)
 	rlwinm.	r10,r10,0,MMUCFG_LPIDSIZE
 	beq	1f
 	bl	.setup_ehv_ivors
-1:
-#else
-	bl	__setup_e500mc_ivors
-#endif
-	mtlr	r4
+1:	mtlr    r4
 	blr
 
 _GLOBAL(__setup_cpu_e5500)
@@ -126,7 +123,6 @@ _GLOBAL(__setup_cpu_e5500)
 	mflr	r4
 	bl	__e500_icache_setup
 	bl	__e500_dcache_setup
-#ifdef CONFIG_PPC_BOOK3E_64
 	bl	.__setup_base_ivors
 	bl	.setup_perfmon_ivor
 	bl	.setup_doorbell_ivors
@@ -143,9 +139,6 @@ _GLOBAL(__setup_cpu_e5500)
 	LOAD_REG_IMMEDIATE(r9,CPU_FTR_EMB_HV)
 	andc	r10,r10,r9
 	std	r10,CPU_SPEC_FEATURES(r5)
-2:
-#else
-	bl	__setup_e500mc_ivors
-#endif
-	mtlr	r4
+2:	mtlr    r4
 	blr
+#endif
diff --git a/arch/powerpc/kernel/cputable.c b/arch/powerpc/kernel/cputable.c
index 2f955d5..9a74cf5 100644
--- a/arch/powerpc/kernel/cputable.c
+++ b/arch/powerpc/kernel/cputable.c
@@ -2049,7 +2049,9 @@ static struct cpu_spec __initdata cpu_specs[] = {
 		.oprofile_cpu_type	= "ppc/e500mc",
 		.oprofile_type		= PPC_OPROFILE_FSL_EMB,
 		.cpu_setup		= __setup_cpu_e5500,
+#ifndef CONFIG_PPC32
 		.cpu_restore		= __restore_cpu_e5500,
+#endif
 		.machine_check		= machine_check_e500mc,
 		.platform		= "ppce5500",
 		.l2cache_type		= PPC_L2_CACHE_CORE,
-- 
1.7.5.4

