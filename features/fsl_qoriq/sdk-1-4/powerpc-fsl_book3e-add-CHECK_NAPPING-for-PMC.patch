From a972e1eb9044294a5c14a3aa87f43d7c29c2599a Mon Sep 17 00:00:00 2001
From: Bin Jiang <bin.jiang@windriver.com>
Date: Wed, 25 Sep 2013 18:35:03 +0800
Subject: [PATCH 4/7] powerpc/fsl_book3e: add CHECK_NAPPING() for PMC.

In following case, the idle process will keep in loop:
1. idle process set _TLF_NAPPING and run into loop;
2. PMC interrupt comes in;
3. A missed decrementer interrupt is replayed in PMC interrupt context;
4. Hardware interrupt is enabled in decrementer interrupt handler;
5. An extern device interrupt comes in in decrementer interrupt context.
   It will call CHECK_NAPPING() to clear _TLF_NAPPING and set _LINK as
   _NIP. But now the _LINK is not idle process's but the decrementer
  interrupt handler's.

Since idle process's  _TLF_NAPPING is clear, all interrupts will consider
the idle process being in loop and don't handle it again. So idle process
will keep in loop.

Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/kernel/exceptions-64e.S | 1 +
 1 file changed, 1 insertion(+)

diff --git a/arch/powerpc/kernel/exceptions-64e.S b/arch/powerpc/kernel/exceptions-64e.S
index 533bf31..91e6d66 100644
--- a/arch/powerpc/kernel/exceptions-64e.S
+++ b/arch/powerpc/kernel/exceptions-64e.S
@@ -668,6 +668,7 @@ kernel_dbg_exc:
 	NORMAL_EXCEPTION_PROLOG(0x260, BOOKE_INTERRUPT_PERFORMANCE_MONITOR,
 				PROLOG_ADDITION_NONE)
 	EXCEPTION_COMMON(0x260, PACA_EXGEN, INTS_DISABLE)
+	CHECK_NAPPING();
 	addi	r3,r1,STACK_FRAME_OVERHEAD
 	bl	.performance_monitor_exception
 	b	.ret_from_except_lite
-- 
1.8.4.93.g57e4c17

