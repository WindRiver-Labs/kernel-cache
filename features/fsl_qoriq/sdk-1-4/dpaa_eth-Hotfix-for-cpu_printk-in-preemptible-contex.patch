From ede0c894a7e7179acfab9bae2e963aa6832d0d6a Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Thu, 1 Aug 2013 16:38:02 +0800
Subject: [PATCH 021/430] dpaa_eth: Hotfix for cpu_printk() in preemptible
 context

cpu_printk() is called, directly or indirectly, from many contexts, not
all of them preempt-safe. For instance, invoking ethtool on a
non-initialized interface while running PREEMPT_RT with
CONFIG_DEBUG_PREEMPT results in an oops.

Temporarily using raw_smp_processor_id() to address this. In the long
run, will get rid of the custom printing macros altogether.

Change-Id: I6a9db7d19cd84ab5b9613b7abde87e85fe0b73bc
Signed-off-by: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
(cherry picked from commit dfae81ab1bb804cc335971592242244262bc7b2e)
Reviewed-on: http://git.am.freescale.net:8181/1050
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[original patch is from QorIQ-SDK-V1.4-20130625-yocto]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 .../net/ethernet/freescale/dpa/dpaa_eth-common.h   |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth-common.h b/drivers/net/ethernet/freescale/dpa/dpaa_eth-common.h
index 73d5414..2e86dd5 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth-common.h
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth-common.h
@@ -43,7 +43,7 @@
 #define __hot
 
 #define cpu_printk(level, format, arg...) \
-	pr_##level("cpu%d: " format, smp_processor_id(), ##arg)
+	pr_##level("cpu%d: " format, raw_smp_processor_id(), ##arg)
 
 #define cpu_pr_emerg(format, arg...)	\
 	cpu_printk(emerg, format, ##arg)
-- 
1.7.5.4

