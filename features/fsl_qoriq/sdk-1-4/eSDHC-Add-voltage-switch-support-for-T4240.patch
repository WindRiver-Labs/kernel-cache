From 311f0486373e887b0f98e3eeab5bf7defc38f806 Mon Sep 17 00:00:00 2001
From: Haijun Zhang <haijun.zhang@freescale.com>
Date: Sun, 7 Apr 2013 11:09:58 +0800
Subject: [PATCH 264/430] eSDHC: Add voltage switch support for T4240

eSDHC host don't support voltage switch on and switch off.
So disable power on and power off.
Only T4240 can change voltage between 1.8v and 3.3v. So add
this function support.

Signed-off-by: Haijun Zhang <haijun.zhang@freescale.com>
Change-Id: I9d644777b5d66d2b44d2055bcd442b6738386bb9
Reviewed-on: http://git.am.freescale.net:8181/1091
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch is from QorIQ-SDK-V1.4-20130625-yocto, just a minor
modification to port 3.4 kernel]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/mmc/host/sdhci-esdhc.h    |    1 +
 drivers/mmc/host/sdhci-of-esdhc.c |   17 +++++++++++++++++
 2 files changed, 18 insertions(+), 0 deletions(-)

diff --git a/drivers/mmc/host/sdhci-esdhc.h b/drivers/mmc/host/sdhci-esdhc.h
index b87feb6..777a418 100644
--- a/drivers/mmc/host/sdhci-esdhc.h
+++ b/drivers/mmc/host/sdhci-esdhc.h
@@ -43,6 +43,7 @@
 #define ESDHC_DMA_SNOOP		0x00000040
 
 #define ESDHC_HOST_CONTROL_RES	0x01
+#define ESDHC_VOL_SEL		0x04
 
 static inline void esdhc_set_clock(struct sdhci_host *host, unsigned int clock)
 {
diff --git a/drivers/mmc/host/sdhci-of-esdhc.c b/drivers/mmc/host/sdhci-of-esdhc.c
index ccff028..73ad20d 100644
--- a/drivers/mmc/host/sdhci-of-esdhc.c
+++ b/drivers/mmc/host/sdhci-of-esdhc.c
@@ -141,6 +141,23 @@ static void esdhc_writeb(struct sdhci_host *host, u8 val, int reg)
 			(val & SDHCI_RESET_ALL))
 		val = SDHCI_RESET_CMD | SDHCI_RESET_DATA;
 
+	if (reg == SDHCI_POWER_CONTROL) {
+		/* eSDHC don't support gate off power */
+		if (!host->pwr || !val)
+			return;
+
+		if (fsl_svr_is(SVR_T4240)) {
+			u8 vol;
+
+			vol = sdhci_be32bs_readb(host, reg);
+			if (host->pwr == SDHCI_POWER_180)
+				vol &= ~ESDHC_VOL_SEL;
+			else
+				vol |= ESDHC_VOL_SEL;
+		} else
+			return;
+	}
+
 	sdhci_be32bs_writeb(host, val, reg);
 }
 
-- 
1.7.5.4

