From 4eee5ceccba11874359a3d65baf13e46c479370e Mon Sep 17 00:00:00 2001
From: Haijun Zhang <haijun.zhang@freescale.com>
Date: Sun, 7 Apr 2013 11:09:58 +0800
Subject: [PATCH 363/547] eSDHC: Add voltage switch support for T4240

eSDHC host don't support voltage switch on and switch off.
So disable power on and power off.
Only T4240 can change voltage between 1.8v and 3.3v. So add
this function support.

Signed-off-by: Haijun Zhang <haijun.zhang@freescale.com>
Change-Id: I9d644777b5d66d2b44d2055bcd442b6738386bb9
Reviewed-on: http://git.am.freescale.net:8181/1091
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch taken from QorIQ-SDK-V1.4-SOURCE-20130625-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/mmc/host/sdhci-esdhc.h    |  1 +
 drivers/mmc/host/sdhci-of-esdhc.c | 17 +++++++++++++++++
 2 files changed, 18 insertions(+)

diff --git a/drivers/mmc/host/sdhci-esdhc.h b/drivers/mmc/host/sdhci-esdhc.h
index 34b64f4..0f49164 100644
--- a/drivers/mmc/host/sdhci-esdhc.h
+++ b/drivers/mmc/host/sdhci-esdhc.h
@@ -42,6 +42,7 @@
 #define ESDHC_DMA_SNOOP		0x00000040
 
 #define ESDHC_HOST_CONTROL_RES	0x01
+#define ESDHC_VOL_SEL		0x04
 
 static inline void esdhc_set_clock(struct sdhci_host *host, unsigned int clock)
 {
diff --git a/drivers/mmc/host/sdhci-of-esdhc.c b/drivers/mmc/host/sdhci-of-esdhc.c
index a9d523f..07cd0c7 100644
--- a/drivers/mmc/host/sdhci-of-esdhc.c
+++ b/drivers/mmc/host/sdhci-of-esdhc.c
@@ -141,6 +141,23 @@ static void esdhc_writeb(struct sdhci_host *host, u8 val, int reg)
 			(val & SDHCI_RESET_ALL))
 		val = SDHCI_RESET_CMD | SDHCI_RESET_DATA;
 
+	if (reg == SDHCI_POWER_CONTROL) {
+		/* eSDHC don't support gate off power */
+		if (!host->pwr || !val)
+			return;
+
+		if (fsl_svr_is(SVR_T4240)) {
+			u8 vol;
+
+			vol = sdhci_be32bs_readb(host, reg);
+			if (host->pwr == SDHCI_POWER_180)
+				vol &= ~ESDHC_VOL_SEL;
+			else
+				vol |= ESDHC_VOL_SEL;
+		} else
+			return;
+	}
+
 	sdhci_be32bs_writeb(host, val, reg);
 }
 
-- 
1.8.4.93.g57e4c17

