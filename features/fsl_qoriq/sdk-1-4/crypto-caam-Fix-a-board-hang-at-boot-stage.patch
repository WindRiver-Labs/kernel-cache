From 6c15b66e19de8af6f4026da5885ad641c15eafa4 Mon Sep 17 00:00:00 2001
From: Wei Yang <Wei.Yang@windriver.com>
Date: Tue, 18 Dec 2012 19:00:58 +0800
Subject: [PATCH 508/547] crypto/caam: Fix a board hang at boot stage

caam_remove() is invoked when caam_probe() encounters hardware errors,
invoke dev_set_drvdata() to reset driver data of ctrldev to NULL
after invoking kfree() to release the private driver data of ctrldev,
simultaneously, check if the private driver data of ctrldev is NULL
among cammalg, caamhash and caamrng

Signed-off-by: Wei Yang <Wei.Yang@windriver.com>
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/crypto/caam/caamalg.c  | 3 +++
 drivers/crypto/caam/caamhash.c | 3 +++
 drivers/crypto/caam/caamrng.c  | 3 +++
 drivers/crypto/caam/ctrl.c     | 1 +
 4 files changed, 10 insertions(+)

diff --git a/drivers/crypto/caam/caamalg.c b/drivers/crypto/caam/caamalg.c
index 7a9052c..1050f46 100644
--- a/drivers/crypto/caam/caamalg.c
+++ b/drivers/crypto/caam/caamalg.c
@@ -2207,6 +2207,9 @@ static int __init caam_algapi_init(void)
 
 	ctrldev = &pdev->dev;
 	priv = dev_get_drvdata(ctrldev);
+	if (priv == NULL)
+		return -ENODEV;
+
 	of_node_put(dev_node);
 
 	INIT_LIST_HEAD(&priv->alg_list);
diff --git a/drivers/crypto/caam/caamhash.c b/drivers/crypto/caam/caamhash.c
index 98429b8..1170bd9 100644
--- a/drivers/crypto/caam/caamhash.c
+++ b/drivers/crypto/caam/caamhash.c
@@ -1829,6 +1829,9 @@ static int __init caam_algapi_hash_init(void)
 
 	ctrldev = &pdev->dev;
 	priv = dev_get_drvdata(ctrldev);
+	if (priv == NULL)
+		return -ENODEV;
+
 	of_node_put(dev_node);
 
 	INIT_LIST_HEAD(&priv->hash_list);
diff --git a/drivers/crypto/caam/caamrng.c b/drivers/crypto/caam/caamrng.c
index d1939a9..2d25f54 100644
--- a/drivers/crypto/caam/caamrng.c
+++ b/drivers/crypto/caam/caamrng.c
@@ -296,6 +296,9 @@ static int __init caam_rng_init(void)
 
 	ctrldev = &pdev->dev;
 	priv = dev_get_drvdata(ctrldev);
+	if (priv == NULL)
+		return -ENODEV;
+
 	of_node_put(dev_node);
 
 	caam_init_rng(&rng_ctx, priv->jrdev[0]);
diff --git a/drivers/crypto/caam/ctrl.c b/drivers/crypto/caam/ctrl.c
index 8c60b3d..f4798e3 100644
--- a/drivers/crypto/caam/ctrl.c
+++ b/drivers/crypto/caam/ctrl.c
@@ -51,6 +51,7 @@ static int caam_remove(struct platform_device *pdev)
 
 	kfree(ctrlpriv->jrdev);
 	kfree(ctrlpriv);
+	dev_set_drvdata(ctrldev, NULL);
 
 	return ret;
 }
-- 
1.8.4.93.g57e4c17

