From 605c8f8e35d2208e5818251a53675a5ea0042264 Mon Sep 17 00:00:00 2001
From: Horia Geanta <horia.geanta@freescale.com>
Date: Wed, 16 May 2012 14:22:24 +0000
Subject: [PATCH 20/27] gianfar: Fix data alignment of recycled skbs

Before returning the skbs to the recycling queue, skb->data must be
realigned to RXBUF_ALIGNMENT.
This also has the benefit of reserving more skb headroom in the first place
and thus avoiding cases (like IPsec in tunnel mode) where the skbs would
grow indefinitely due to gfar_new_skb - pskb_expand_head - gfar_free_skb
usage cycle.

Signed-off-by: Horia Geanta <horia.geanta@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/ethernet/freescale/gianfar.c |    1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/net/ethernet/freescale/gianfar.c b/drivers/net/ethernet/freescale/gianfar.c
index ee47293..a26f4c9 100644
--- a/drivers/net/ethernet/freescale/gianfar.c
+++ b/drivers/net/ethernet/freescale/gianfar.c
@@ -3485,6 +3485,7 @@ static void gfar_free_skb(struct sk_buff *skb)
 	}
 
 	skb_recycle(skb);
+	gfar_align_skb(skb);
 
 	cpu = get_cpu();
 	local = per_cpu_ptr(recycle_cntxt->local, cpu);
-- 
1.7.9.7

