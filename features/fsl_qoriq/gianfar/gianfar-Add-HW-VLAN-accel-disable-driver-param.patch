From 6c5243295799c389b070b54b8da281d56d23c4ef Mon Sep 17 00:00:00 2001
From: Claudiu Manoil <claudiu.manoil@freescale.com>
Date: Tue, 8 May 2012 15:22:11 +0300
Subject: [PATCH 18/27] gianfar: Add HW VLAN accel disable driver param

By default, HW VLAN support in driver is enabled.
If disabled, the driver will not advertise its HW
VLAN acceleration capabilities and Linux will
handle the VLAN tagging work itself.

Signed-off-by: Arun Pathak <arun.pathak@freescale.com>

Replaced compile time flag with driver parameter.
To disable vlan tagging in hardware:
- modprobe gianfar_driver hw_vlan_enabled=0
or
- append to bootargs 'gianfar_driver.hw_vlan_enabled=0'
This setting is visible under:
/sys/module/gianfar_driver/parameters/hw_vlan_enabled

Signed-off-by: Claudiu Manoil <claudiu.manoil@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/net/ethernet/freescale/gianfar.c |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/freescale/gianfar.c b/drivers/net/ethernet/freescale/gianfar.c
index 51e9170..6f8ac62 100644
--- a/drivers/net/ethernet/freescale/gianfar.c
+++ b/drivers/net/ethernet/freescale/gianfar.c
@@ -121,9 +121,11 @@
 
 const char gfar_driver_version[] = "1.3";
 static struct gfar_recycle_cntxt *gfar_global_recycle_cntxt;
+static bool hw_vlan_enabled = 1;
 static int tx_napi_enabled = 1;
 static int tx_napi_weight = GFAR_DEV_TX_WEIGHT;
 static int rx_napi_weight = GFAR_DEV_RX_WEIGHT;
+module_param(hw_vlan_enabled, bool, S_IRUGO);
 module_param(tx_napi_enabled, bool, S_IRUGO);
 module_param(tx_napi_weight, int, S_IRUGO);
 module_param(rx_napi_weight, int, S_IRUGO);
@@ -1316,7 +1318,7 @@ static int gfar_probe(struct platform_device *ofdev)
 			NETIF_F_RXCSUM | NETIF_F_HIGHDMA;
 	}
 
-	if (priv->device_flags & FSL_GIANFAR_DEV_HAS_VLAN) {
+	if ((priv->device_flags & FSL_GIANFAR_DEV_HAS_VLAN) && hw_vlan_enabled) {
 		dev->hw_features |= NETIF_F_HW_VLAN_TX | NETIF_F_HW_VLAN_RX;
 		dev->features |= NETIF_F_HW_VLAN_TX | NETIF_F_HW_VLAN_RX;
 	}
-- 
1.7.9.7

