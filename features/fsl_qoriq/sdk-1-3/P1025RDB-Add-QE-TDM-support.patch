From ed6ecf0add1f2877caf56e153b0656165ee6daa1 Mon Sep 17 00:00:00 2001
From: Jiucheng Xu <Jiucheng.Xu@freescale.com>
Date: Fri, 31 Aug 2012 17:05:38 +0000
Subject: [PATCH 162/162] P1025RDB: Add QE TDM support

The P1025RDB-PC have PMC sockets that support QE-TDM function.
The patch enable Quicc Engine and the related signals of QE-TDM.

Signed-off-by: Jiucheng Xu <Jiucheng.Xu@freescale.com>
Signed-off-by: Xie Xiaobo <X.Xie@freescale.com>
Signed-off-by: Li Yang <leoli@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.3-SOURCE-20121114-yocto.iso tarball.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/platforms/85xx/mpc85xx_rdb.c |    8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/arch/powerpc/platforms/85xx/mpc85xx_rdb.c b/arch/powerpc/platforms/85xx/mpc85xx_rdb.c
index 27ddf80..0f54c2f 100644
--- a/arch/powerpc/platforms/85xx/mpc85xx_rdb.c
+++ b/arch/powerpc/platforms/85xx/mpc85xx_rdb.c
@@ -126,6 +126,10 @@ static void __init mpc85xx_rdb_setup_arch(void)
 
 		for_each_node_by_name(ucc, "ucc")
 			par_io_of_config(ucc);
+
+		/* To P1025 QE/TDM, the name of ucc nodes is "tdm@xxxx" */
+		for_each_node_by_name(ucc, "tdm")
+			par_io_of_config(ucc);
 #ifdef CONFIG_SPI_FSL_SPI
 		for_each_node_by_name(qe_spi, "spi")
 			par_io_of_config(qe_spi);
@@ -157,7 +161,7 @@ static void __init mpc85xx_rdb_setup_arch(void)
 #endif
 
 #ifdef CONFIG_FSL_UCC_TDM
-			if (machine_is(p1021_rdb_pc)) {
+			if (machine_is(p1021_rdb_pc) || machine_is(p1025_rdb)) {
 
 				/* Clear QE12 for releasing the LBCTL */
 				clrbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(12));
@@ -176,11 +180,13 @@ static void __init mpc85xx_rdb_setup_arch(void)
 #endif	/* CONFIG_FSL_UCC_TDM */
 
 #ifdef CONFIG_SPI_FSL_SPI
+		if (of_find_compatible_node(NULL, NULL, "fsl,mpc8569-qe-spi")) {
 			clrbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(12));
 			/*QE-SPI*/
 			setbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(6) |
 					  MPC85xx_PMUXCR_QE(9) |
 					  MPC85xx_PMUXCR_QE(10));
+		}
 #endif	/* CONFIG_SPI_FSL_SPI */
 			iounmap(guts);
 		}
-- 
1.7.9.7

