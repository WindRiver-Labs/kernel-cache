From 4910d7a26bafe300f947094928ba4ff88b8484dc Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Thu, 13 Oct 2011 15:50:11 +0800
Subject: [PATCH] PowerPC:P50x0:Fix compile error when enable
 CONFIG_WR_OCD_DEBUG

Signed-offbled CONFIG_WR_OCD_DEBUG option, it will enable
CONFIG_BDI_SWITCH by default, which will need a variable called
abatron_pteptrs to store current context.

The patch adds a global variable with name abatron_pteptrs to fix
compile error.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/kernel/head_64.S    |   11 +++++++++++
 arch/powerpc/mm/tlb_nohash_low.S |    3 +--
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/kernel/head_64.S b/arch/powerpc/kernel/head_64.S
index 1213f1c..8350aba 100644
--- a/arch/powerpc/kernel/head_64.S
+++ b/arch/powerpc/kernel/head_64.S
@@ -824,3 +824,14 @@ empty_zero_page:
 	.globl	swapper_pg_dir
 swapper_pg_dir:
 	.space	PGD_TABLE_SIZE
+
+#ifdef CONFIG_PPC_BOOK3E
+/*
+ * Room for two PTE pointers, usually the kernel and current user pointers
+ * to their respective root page table.
+ */
+	.globl abatron_pteptrs
+abatron_pteptrs:
+        .space  16
+#endif
+
diff --git a/arch/powerpc/mm/tlb_nohash_low.S b/arch/powerpc/mm/tlb_nohash_low.S
index 7c63c0e..7fa4116 100644
--- a/arch/powerpc/mm/tlb_nohash_low.S
+++ b/arch/powerpc/mm/tlb_nohash_low.S
@@ -391,8 +391,7 @@ _GLOBAL(set_context)
 	/* Context switch the PTE pointer for the Abatron BDI2000.
 	 * The PGDIR is the second parameter.
 	 */
-	lis	r5, abatron_pteptrs@h
-	ori	r5, r5, abatron_pteptrs@l
+	LOAD_REG_IMMEDIATE(r5, abatron_pteptrs);
 	stw	r4, 0x4(r5)
 #endif
 	mtspr	SPRN_PID,r3
-- 
1.7.9.7

