From c2fb2812148182360f52f9d6efda97553f83d4f9 Mon Sep 17 00:00:00 2001
From: Stefan Szabo <szbs001@freescale.com>
Date: Wed, 8 Aug 2012 17:26:57 +0300
Subject: [PATCH 076/162] fmd: Revisited sysfs statistics

* Removed dummy 'pcd_enq_total_frame' statistics counter
* Added 'deq_3' entry to statistics

Signed-off-by: Stefan Szabo <szbs001@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.3-SOURCE-20121114-yocto.iso tarball.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 .../dpa/NetCommSw/src/wrapper/lnxwrp_sysfs.c       |    2 +-
 .../dpa/NetCommSw/src/wrapper/lnxwrp_sysfs.h       |    2 +-
 .../dpa/NetCommSw/src/wrapper/lnxwrp_sysfs_fm.c    |   36 +++++++++-----------
 .../NetCommSw/src/wrapper/lnxwrp_sysfs_fm_port.c   |    7 ++--
 4 files changed, 22 insertions(+), 25 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs.c
index bbce091..3f122b5 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs.c
@@ -41,7 +41,7 @@
 #include "lnxwrp_sysfs.h"
 
 uint8_t fm_find_statistic_counter_by_name(const char *attr_name,
-					  struct SysfsStats_t *sysfs_stats,
+					  const struct SysfsStats_t *sysfs_stats,
 					  uint8_t *offset)
 {
 	int i = 0;
diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs.h b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs.h
index d5ba46d..67cb2b0 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs.h
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs.h
@@ -61,7 +61,7 @@ struct SysfsStats_t {
 };
 
 uint8_t fm_find_statistic_counter_by_name(const char *attr_name,
-					  struct SysfsStats_t *sysfs_stats,
+					  const struct SysfsStats_t *sysfs_stats,
 					  uint8_t *offset);
 
 #endif /* LNXWRP_SYSFS_H_ */
diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs_fm.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs_fm.c
index 4eeb7fd..2cfc0b9 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs_fm.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs_fm.c
@@ -71,6 +71,10 @@ static const struct SysfsStats_t fmSysfsStats[] = {
 	 .statisticCounter = e_FM_COUNTERS_DEQ_2,
 	 },
 	{
+	 .statisticName = "deq_3",
+	 .statisticCounter = e_FM_COUNTERS_DEQ_3,
+	 },
+	{
 	 .statisticName = "deq_from_default",
 	 .statisticCounter = e_FM_COUNTERS_DEQ_FROM_DEFAULT,
 	 },
@@ -109,10 +113,6 @@ static const struct SysfsStats_t fmSysfsStats[] = {
 	 },
 	/* FM:PCD  statistics */
 	{
-	 .statisticName = "pcd_enq_total_frame",
-	 .statisticCounter = e_FM_COUNTERS_ENQ_TOTAL_FRAME,
-	 },
-	{
 	 .statisticName = "pcd_kg_total",
 	 .statisticCounter = e_FM_PCD_KG_COUNTERS_TOTAL,
 	 },
@@ -236,10 +236,9 @@ static ssize_t show_fm_dma_stats(struct device *dev,
 	if (!p_LnxWrpFmDev->active || !p_LnxWrpFmDev->h_Dev)
 		return -EIO;
 
-	counter =
-		fm_find_statistic_counter_by_name(attr->attr.name,
-						  (struct SysfsStats_t *)
-						  &fmSysfsStats[0], NULL);
+	counter = fm_find_statistic_counter_by_name(
+			attr->attr.name,
+			fmSysfsStats, NULL);
 
 	local_irq_save(flags);
 
@@ -293,10 +292,9 @@ static ssize_t show_fm_stats(struct device *dev,
 	if (!p_LnxWrpFmDev->active || !p_LnxWrpFmDev->h_Dev)
 		return -EIO;
 
-	counter =
-		fm_find_statistic_counter_by_name(attr->attr.name,
-						  (struct SysfsStats_t *)
-						  &fmSysfsStats[0], NULL);
+	counter = fm_find_statistic_counter_by_name(
+			attr->attr.name,
+			fmSysfsStats, NULL);
 
 	local_irq_save(flags);
 
@@ -324,13 +322,13 @@ static ssize_t show_fm_pcd_stats(struct device *dev,
 	if (WARN_ON(p_LnxWrpFmDev == NULL))
 		return -EINVAL;
 
-	if (!p_LnxWrpFmDev->active || !p_LnxWrpFmDev->h_Dev)
+	if (!p_LnxWrpFmDev->active || !p_LnxWrpFmDev->h_Dev ||
+			!p_LnxWrpFmDev->h_PcdDev)
 		return -EIO;
 
-	counter =
-		fm_find_statistic_counter_by_name(attr->attr.name,
-						  (struct SysfsStats_t *)
-						  &fmSysfsStats[0], NULL);
+	counter = fm_find_statistic_counter_by_name(
+			attr->attr.name,
+			fmSysfsStats, NULL);
 
 	local_irq_save(flags);
 
@@ -350,6 +348,7 @@ static DEVICE_ATTR(deq_total_frame, S_IRUGO, show_fm_stats, NULL);
 static DEVICE_ATTR(deq_0, S_IRUGO, show_fm_stats, NULL);
 static DEVICE_ATTR(deq_1, S_IRUGO, show_fm_stats, NULL);
 static DEVICE_ATTR(deq_2, S_IRUGO, show_fm_stats, NULL);
+static DEVICE_ATTR(deq_3, S_IRUGO, show_fm_stats, NULL);
 static DEVICE_ATTR(deq_from_default, S_IRUGO, show_fm_stats, NULL);
 static DEVICE_ATTR(deq_from_context, S_IRUGO, show_fm_stats, NULL);
 static DEVICE_ATTR(deq_from_fd, S_IRUGO, show_fm_stats, NULL);
@@ -361,7 +360,6 @@ static DEVICE_ATTR(read_buf_ecc_error, S_IRUGO, show_fm_dma_stats, NULL);
 static DEVICE_ATTR(write_buf_ecc_sys_error, S_IRUGO, show_fm_dma_stats, NULL);
 static DEVICE_ATTR(write_buf_ecc_fm_error, S_IRUGO, show_fm_dma_stats, NULL);
 /* FM:PCD */
-static DEVICE_ATTR(pcd_enq_total_frame, S_IRUGO, show_fm_pcd_stats, NULL);
 static DEVICE_ATTR(pcd_kg_total, S_IRUGO, show_fm_pcd_stats, NULL);
 static DEVICE_ATTR(pcd_plcr_yellow, S_IRUGO, show_fm_pcd_stats, NULL);
 static DEVICE_ATTR(pcd_plcr_red, S_IRUGO, show_fm_pcd_stats, NULL);
@@ -411,6 +409,7 @@ static struct attribute *fm_dev_stats_attributes[] = {
 	&dev_attr_deq_0.attr,
 	&dev_attr_deq_1.attr,
 	&dev_attr_deq_2.attr,
+	&dev_attr_deq_3.attr,
 	&dev_attr_deq_from_default.attr,
 	&dev_attr_deq_from_context.attr,
 	&dev_attr_deq_from_fd.attr,
@@ -420,7 +419,6 @@ static struct attribute *fm_dev_stats_attributes[] = {
 	&dev_attr_read_buf_ecc_error.attr,
 	&dev_attr_write_buf_ecc_sys_error.attr,
 	&dev_attr_write_buf_ecc_fm_error.attr,
-	&dev_attr_pcd_enq_total_frame.attr,
 	&dev_attr_pcd_kg_total.attr,
 	&dev_attr_pcd_plcr_yellow.attr,
 	&dev_attr_pcd_plcr_red.attr,
diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs_fm_port.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs_fm_port.c
index 8e058d7..97dacb7 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs_fm_port.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_sysfs_fm_port.c
@@ -128,10 +128,9 @@ static ssize_t show_fm_port_stats(struct device *dev,
 		return n;
 	}
 
-	counter =
-	    fm_find_statistic_counter_by_name(attr->attr.name,
-					      (struct SysfsStats_t *) &
-					      portSysfsStats[0], NULL);
+	counter = fm_find_statistic_counter_by_name(
+			attr->attr.name,
+			portSysfsStats, NULL);
 
 	if (counter == e_FM_PORT_COUNTERS_RX_LIST_DMA_ERR) {
 		uint32_t fmRev = 0;
-- 
1.7.9.7

