From 5cc1e55cabbc0bbede99d7a3657b5705d24c638b Mon Sep 17 00:00:00 2001
From: Stefan Szabo <szbs001@freescale.com>
Date: Thu, 9 Aug 2012 11:50:54 +0300
Subject: [PATCH 078/162] fmd: Fix: Spinlock not released on error paths

FMD LLD functions FM_PCD_MatchTableGetKeyCounter() and
FM_PCD_MatchTableFindNGetKeyStatistics() had error return
paths on which a previously acquired spinlock was never released.

Signed-off-by: Stefan Szabo <szbs001@freescale.com>
Signed-off-by: Floarea Anca Jeanina <B12569@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.3-SOURCE-20121114-yocto.iso tarball.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 .../dpa/NetCommSw/Peripherals/FM/Pcd/fm_cc.c       |    5 +++++
 1 file changed, 5 insertions(+)

diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Pcd/fm_cc.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Pcd/fm_cc.c
index d03375c..bed5e34 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Pcd/fm_cc.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Pcd/fm_cc.c
@@ -6327,12 +6327,14 @@ uint32_t FM_PCD_MatchTableGetKeyCounter(t_Handle h_CcNode, uint16_t keyIndex)
 
     if (keyIndex >= p_CcNode->numOfKeys)
     {
+        XX_UnlockIntrSpinlock(p_CcNode->h_Spinlock, intFlags);
         REPORT_ERROR(MAJOR, E_INVALID_STATE, ("The provided keyIndex exceeds the number of keys in this match table"));
         return 0;
     }
 
     if (!p_CcNode->keyAndNextEngineParams[keyIndex].p_StatsObj)
     {
+        XX_UnlockIntrSpinlock(p_CcNode->h_Spinlock, intFlags);
         REPORT_ERROR(MAJOR, E_INVALID_STATE, ("Statistics were not enabled for this key"));
         return 0;
     }
@@ -6392,8 +6394,11 @@ t_Error FM_PCD_MatchTableFindNGetKeyStatistics(t_Handle                 h_CcNode
 
     err = FindKeyIndex(p_CcNode, keySize, p_Key, p_Mask, &keyIndex);
     if (GET_ERROR_TYPE(err) != E_OK)
+    {
+        XX_UnlockIntrSpinlock(p_CcNode->h_Spinlock, intFlags);
         RETURN_ERROR(MAJOR, err, ("The received key and mask pair was not found in the "
                                   "match table of the provided node"));
+    }
 
     err = MatchTableGetKeyStatistics(p_CcNode,
                                      keyIndex,
-- 
1.7.9.7

