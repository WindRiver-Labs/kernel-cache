From cda4f7619d2c4ee6f1027fa06afdce2904f0b776 Mon Sep 17 00:00:00 2001
From: Xuelin Shi <b29237@freescale.com>
Date: Fri, 19 Oct 2012 16:58:40 +0000
Subject: [PATCH 115/162] DMA/RaidEngine: enable all RaidEngine channels

Only one channel will be the bootleneck of the performance of RAID
which causes 30% perfomance loss on P5040DS.

With multicore enablement under RAID4/5/6 kernel option, the situation
is more severe which would trigger below trace info and ext4 writeback lockup:

INFO: task jbd2/md0-8:2445 blocked for more than 120 seconds.
"echo 0 > /proc/sys/kernel/hung_task_timeout_secs" disables this message.
jbd2/md0-8      D 0000000000000000     0  2445      2 0x00000000
Call Trace:
[c0000001f99476a0] [0000000000001800] 0x1800 (unreliable)
[c0000001f9947870] [c000000000008e8c] .__switch_to+0xbc/0xf0
[c0000001f9947900] [c000000000695b58] .__schedule+0x278/0x630
[c0000001f9947b80] [c000000000696000] .schedule+0x30/0xe0
[c0000001f9947c00] [c0000000001e8618] .jbd2_journal_commit_transaction+0x198/0x1
6c0
[c0000001f9947df0] [c0000000001edae0] .kjournald2+0xd0/0x290
[c0000001f9947ed0] [c00000000006f59c] .kthread+0xbc/0xd0
[c0000001f9947f90] [c000000000015894] .kernel_thread+0x54/0x70
INFO: task flush-9:0:2449 blocked for more than 120 seconds.
"echo 0 > /proc/sys/kernel/hung_task_timeout_secs" disables this message.
flush-9:0       D 0000000000000000     0  2449      2 0x00000000
Call Trace:
[c0000001fc5f6e70] [c0000001fc5f6f10] 0xc0000001fc5f6f10 (unreliable)
[c0000001fc5f7040] [c000000000008e8c] .__switch_to+0xbc/0xf0
[c0000001fc5f70d0] [c000000000695b58] .__schedule+0x278/0x630
[c0000001fc5f7350] [c000000000696000] .schedule+0x30/0xe0
[c0000001fc5f73d0] [c000000000696120] .io_schedule+0x70/0xb0
[c0000001fc5f7460] [c0000000000b4020] .sleep_on_page+0x10/0x30
[c0000001fc5f74d0] [c00000000069680c] .__wait_on_bit_lock+0xdc/0x1a0
[c0000001fc5f7590] [c0000000000b3ff4] .__lock_page+0x54/0x70
[c0000001fc5f7650] [c0000000001ade08] .write_cache_pages_da+0x408/0x410
[c0000001fc5f77d0] [c0000000001ae110] .ext4_da_writepages+0x300/0x4c0
[c0000001fc5f7930] [c0000000000bf5b0] .do_writepages+0x40/0x90
[c0000001fc5f79a0] [c00000000012bb18] .writeback_single_inode+0xd8/0x3a0
[c0000001fc5f7a50] [c00000000012c58c] .writeback_sb_inodes+0x15c/0x260
[c0000001fc5f7b20] [c00000000012cf24] .writeback_inodes_wb+0x124/0x230
[c0000001fc5f7bf0] [c00000000012d380] .wb_writeback+0x350/0x3c0
[c0000001fc5f7d20] [c00000000012d590] .wb_do_writeback+0x1a0/0x280
[c0000001fc5f7e10] [c00000000012d728] .bdi_writeback_thread+0xb8/0x1e0
[c0000001fc5f7ed0] [c00000000006f59c] .kthread+0xbc/0xd0
[c0000001fc5f7f90] [c000000000015894] .kernel_thread+0x54/0x70
INFO: task iozone:2450 blocked for more than 120 seconds.
"echo 0 > /proc/sys/kernel/hung_task_timeout_secs" disables this message.
iozone          D 000000000ffd6f30     0  2450   2411 0x00000010
Call Trace:
[c0000001f84c6ae0] [c0000001f84c6b80] 0xc0000001f84c6b80 (unreliable)
[c0000001f84c6cb0] [c000000000008e8c] .__switch_to+0xbc/0xf0
[c0000001f84c6d40] [c000000000695b58] .__schedule+0x278/0x630
[c0000001f84c6fc0] [c000000000696000] .schedule+0x30/0xe0
[c0000001f84c7040] [c0000000004e5138] .get_active_stripe+0x588/0x6a0
[c0000001f84c7160] [c0000000004ea640] .make_request+0x1d0/0x860
[c0000001f84c72a0] [c0000000004f4de0] .md_make_request+0x110/0x2d0
[c0000001f84c7370] [c0000000002ad5f0] .generic_make_request+0x2a0/0x3a0
[c0000001f84c7450] [c0000000002ad774] .submit_bio+0x84/0x130
[c0000001f84c7520] [c0000000001af400] .ext4_io_submit+0x40/0x80
[c0000001f84c75a0] [c0000000001af690] .ext4_bio_write_page+0x250/0x5b0
[c0000001f84c76c0] [c0000000001a7ea4] .mpage_da_submit_io+0x494/0x540
[c0000001f84c78a0] [c0000000001ad690] .mpage_da_map_and_submit+0x200/0x4b0
[c0000001f84c7970] [c0000000001ae140] .ext4_da_writepages+0x330/0x4c0
[c0000001f84c7ad0] [c0000000000bf5b0] .do_writepages+0x40/0x90
[c0000001f84c7b40] [c0000000000b5248] .__filemap_fdatawrite_range+0x58/0x80
[c0000001f84c7bf0] [c0000000000b52d8] .filemap_write_and_wait_range+0x68/0xc0
[c0000001f84c7c90] [c000000000131ed8] .vfs_fsync_range+0x68/0xf0
[c0000001f84c7d30] [c000000000132018] .do_fsync+0x38/0x70
[c0000001f84c7dc0] [c000000000132438] .SyS_fsync+0x18/0x30
[c0000001f84c7e30] [c000000000000598] syscall_exit+0x0/0x2c

This patch would fix this issue.

Signed-off-by: Forrest Shi <b29237@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.3-SOURCE-20121114-yocto.iso tarball.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/dma/fsl_raid.c |    2 --
 1 file changed, 2 deletions(-)

diff --git a/drivers/dma/fsl_raid.c b/drivers/dma/fsl_raid.c
index bbc3b6e..21080ce 100644
--- a/drivers/dma/fsl_raid.c
+++ b/drivers/dma/fsl_raid.c
@@ -968,10 +968,8 @@ static int __devinit raide_probe(struct platform_device *ofdev)
 				"fsl,raideng-v1.0-job-ring")) {
 				re_jr_probe(ofdev, child, ridx++, off);
 				repriv->total_jrs++;
-				break;
 			}
 		}
-		break;
 	}
 
 	re_sw_desc_cache = kmem_cache_create("re_desc_cache",
-- 
1.7.9.7

