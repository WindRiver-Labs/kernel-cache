From 7d9d7aa91e70b9295d8a458bff6e83697daa9c9e Mon Sep 17 00:00:00 2001
From: Stefan Szabo <szbs001@freescale.com>
Date: Thu, 12 Jul 2012 16:24:40 +0300
Subject: [PATCH 031/162] fman_test: Added size checks to fmt_write()

Signed-off-by: Stefan Szabo <szbs001@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.3-SOURCE-20121114-yocto.iso tarball.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 .../dpa/NetCommSw/src/wrapper/fman_test.c          |   16 +++++++++++++---
 1 file changed, 13 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/fman_test.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/fman_test.c
index 08dda01..30dd75b 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/fman_test.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/fman_test.c
@@ -1448,13 +1448,18 @@ ssize_t fmt_write(
 
 	fmt_port = file->private_data;
 	if (!fmt_port || !fmt_port->valid) {
-		_fmt_err("fmt port not vald.\n");
+		_fmt_err("fmt port not valid.\n");
 		return -EINVAL;
 	}
 
     /* If Compat (32B UserSpace - 64B KernelSpace)  */
 #ifdef CONFIG_COMPAT
-	if (fmt_port->compat_test_type){
+	if (fmt_port->compat_test_type) {
+		if (size < sizeof(ioc_fmt_compat_buff_desc_t)) {
+			_fmt_err("invalid buff_desc size.\n");
+			return -EFAULT;
+		}
+
 		if (copy_from_user(&buff_desc_compat, buf,
 					sizeof(ioc_fmt_compat_buff_desc_t)))
 			return -EFAULT;
@@ -1475,8 +1480,13 @@ ssize_t fmt_write(
 	} else
 #endif
 	{
+		if (size < sizeof(ioc_fmt_buff_desc_t)) {
+			_fmt_err("invalid buff_desc size.\n");
+			return -EFAULT;
+		}
+
 		if (copy_from_user(&buff_desc, (ioc_fmt_buff_desc_t  *)buf,
-							sizeof(ioc_fmt_buff_desc_t)))
+					sizeof(ioc_fmt_buff_desc_t)))
 			return -EFAULT;
 	}
 
-- 
1.7.9.7

