From 245baeda8605817903909ff5a67c5008072d2210 Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Thu, 4 Oct 2012 19:47:52 +0000
Subject: [PATCH 086/162] fmd: P1023 resource allocation update

Updated resource allocation for P1023 to revert changes generated
by a LLD change that was reverted.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.3-SOURCE-20121114-yocto.iso tarball.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 .../freescale/dpa/NetCommSw/Peripherals/FM/fm.h    |    2 +-
 .../dpa/NetCommSw/src/wrapper/lnxwrp_fm.c          |    4 +++-
 .../dpa/NetCommSw/src/wrapper/lnxwrp_resources.c   |    7 ++++++-
 3 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/fm.h b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/fm.h
index 29e62b7..6522bda 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/fm.h
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/fm.h
@@ -133,7 +133,7 @@ switch(exception){                                          \
 
 #define DEFAULT_totalFifoSize(major)       (((major == 2) || (major == 5))  ?   \
                                             (100*KILOBYTE):((major == 6) ?      \
-                                            (288*KILOBYTE):((major == 4) ? (44*KILOBYTE):(122*KILOBYTE))))
+                                            (288*KILOBYTE):((major == 4) ? (48*KILOBYTE):(122*KILOBYTE))))
 
 #define DEFAULT_eccEnable                   FALSE
 #define DEFAULT_dispLimit                   0
diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_fm.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_fm.c
index 6405a2d..39593df 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_fm.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_fm.c
@@ -787,6 +787,8 @@ static t_Error InitFmDev(t_LnxWrpFmDev  *p_LnxWrpFmDev)
 #if defined(CONFIG_FMAN_RESOURCE_ALLOCATION_ALGORITHM) && defined(CONFIG_FMAN_P3040_P4080_P5020)
     /* Enable 14g w/ jumbo frames following HW suggestion. */
     FM_ConfigTotalFifoSize(p_LnxWrpFmDev->h_Dev, 128*KILOBYTE);
+#elif defined(CONFIG_FMAN_RESOURCE_ALLOCATION_ALGORITHM) && defined(CONFIG_FMAN_P1023)
+    FM_ConfigTotalFifoSize(p_LnxWrpFmDev->h_Dev, 48*KILOBYTE);
 #endif
 
     if (FM_Init(p_LnxWrpFmDev->h_Dev) != E_OK)
@@ -944,7 +946,7 @@ static int /*__devinit*/ fm_probe(struct platform_device *of_dev)
     /* for all other platforms: MURAM Space for fifosize=3/4 * MURAM_SIZE*/
     if(fm_precalculate_fifosizes(
         p_LnxWrpFmDev,
-        44*KILOBYTE)
+        48*KILOBYTE)
         != 0)
     return -EIO;
 #endif
diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_resources.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_resources.c
index 573ef3a..fcac0a7 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_resources.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_resources.c
@@ -385,8 +385,13 @@ int fm_precalculate_fifosizes(t_LnxWrpFmDev *p_LnxWrpFmDev, int muram_fifo_size)
 							buf_size) + 7;
 	}
 
+#ifdef CONFIG_FMAN_P1023
+	shared_ext_buff = 0;
+#else
+	/* changing these might reduce performance */
 	shared_ext_buff = num_10g_ports ? 32 : 16; /* LLD boundaries:
-					DEFAULT_PORT_extraSizeOfFifo */
+					DEFAULT_PORT_extraNumOfFifoBufs */
+#endif
 
 	/* TX ports will have minimum required buffers
 	   Calculus of the remaining buffers for all RX ports */
-- 
1.7.9.7

