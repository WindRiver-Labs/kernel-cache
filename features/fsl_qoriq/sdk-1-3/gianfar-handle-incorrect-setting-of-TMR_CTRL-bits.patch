From 8de050e4cf1d310959a55eae97e9b21a4af4419a Mon Sep 17 00:00:00 2001
From: Xie Xiaobo <X.Xie@freescale.com>
Date: Fri, 17 Aug 2012 15:28:37 +0000
Subject: [PATCH 093/162] gianfar: handle incorrect setting of TMR_CTRL bits

When set TMR_CTRL[CKSEL], the CKSEL bits value didn't be cleared firstly.
It will result in incorrect setting in TMR_CTRL register.
This patch fixed the issue.

Signed-off-by: Xie Xiaobo <X.Xie@freescale.com>`
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.3-SOURCE-20121114-yocto.iso tarball.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/ethernet/freescale/gianfar.h      |    1 +
 drivers/net/ethernet/freescale/gianfar_1588.c |    2 +-
 2 files changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/freescale/gianfar.h b/drivers/net/ethernet/freescale/gianfar.h
index f0ea552..b8e440b 100644
--- a/drivers/net/ethernet/freescale/gianfar.h
+++ b/drivers/net/ethernet/freescale/gianfar.h
@@ -194,6 +194,7 @@ extern const char gfar_driver_version[];
 #define GFAR_PTP_PROT_DONTCARE		0xFFFF
 
 /* 1588 Module Registers bits */
+#define TMR_CTRL_CKSEL_MASK	0x00000003
 #define TMR_CTRL_ENABLE		0x00000004
 #define TMR_RTPE		0x00008000
 #define TMR_CTRL_TCLK_MASK	0x03ff0000
diff --git a/drivers/net/ethernet/freescale/gianfar_1588.c b/drivers/net/ethernet/freescale/gianfar_1588.c
index 5d09891..bd6f2b1 100644
--- a/drivers/net/ethernet/freescale/gianfar_1588.c
+++ b/drivers/net/ethernet/freescale/gianfar_1588.c
@@ -662,7 +662,7 @@ int gfar_ptp_init(struct device_node *np, struct gfar_private *priv)
 	gfar_write(&(priv->ptimer->tmr_add), ptp_attr.freq_comp);
 
 	gfar_write(&(priv->ptimer->tmr_ctrl),
-		gfar_read(&(priv->ptimer->tmr_ctrl)) |
+		(gfar_read(&(priv->ptimer->tmr_ctrl)) & ~TMR_CTRL_CKSEL_MASK) |
 		TMR_CTRL_ENABLE | cksel | TMR_CTRL_FIPER_START);
 
 	/* initialize circular buffer for tx timestamps */
-- 
1.7.9.7

