From 8811d3bb3a96e7d689d73d1bb4b2157a0c38d458 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 18 Jan 2013 17:20:29 +0800
Subject: [PATCH] ppc64: get the constant expression properly

We really should use LOAD_REG_IMMEDIATE() to load the value of
the constant expression into register. And additonally, we should
copy thread info from the kernel stack coming from usr.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/exceptions-64e.S |    6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/kernel/exceptions-64e.S b/arch/powerpc/kernel/exceptions-64e.S
index 4c94296..fc57393 100644
--- a/arch/powerpc/kernel/exceptions-64e.S
+++ b/arch/powerpc/kernel/exceptions-64e.S
@@ -46,7 +46,7 @@
 	bne	1f;					\
 	mfspr	r14,SPRN_PIR;				\
 	slwi	r14,r14,3;				\
-	LOAD_REG_ADDR(r10, level##_STACK_BASE);		\
+	LOAD_REG_IMMEDIATE(r10, level##_STACK_BASE);	\
 	add	r10,r10,r14;				\
 	ld	r10,0(r10);				\
 	addi	r10,r10,THREAD_SIZE;			\
@@ -56,7 +56,7 @@
 #define BOOK3E_LOAD_EXC_LEVEL_STACK(level)		\
 	andi.	r10,r11,MSR_PR;				\
 	bne	1f;					\
-	LOAD_REG_ADDR(r10, level##_STACK_BASE);		\
+	LOAD_REG_IMMEDIATE(r10, level##_STACK_BASE);	\
 	ld	r10,0(r10);				\
 	addi	r10,r10,THREAD_SIZE;			\
 	std	r10,PACA_##level##_STACK(r13);
@@ -92,7 +92,7 @@
 #define	BOOK3E_STORE_EXC_LEVEL_THEAD_INFO(type)					\
 	andi.	r10,r11,MSR_PR;							\
 	bne	1f;								\
-	ld	r14,PACA_EX##type+EX_R1(r13);					\
+	ld	r14,PACAKSAVE(r13);						\
 	CURRENT_THREAD_INFO(r14, r14);						\
 	CURRENT_THREAD_INFO(r15, r1);						\
 	ld	r10,TI_FLAGS(r14);		     				\
-- 
1.7.9.7

