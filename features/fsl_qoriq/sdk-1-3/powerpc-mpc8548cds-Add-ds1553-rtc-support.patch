From 46cf9225eba1475f493742553dd5dd878f12e887 Mon Sep 17 00:00:00 2001
From: Jiang Bin <bin.jiang@windriver.com>
Date: Thu, 1 Nov 2012 16:39:57 +0800
Subject: [PATCH 3/6] powerpc/mpc8548cds: Add ds1553 rtc support

Add dts file and OF device for ds1553 rtc.

Signed-off-by: Jiang Bin <bin.jiang@windriver.com>
---
 arch/powerpc/boot/dts/mpc8548cds.dtsi     |    6 ++++++
 arch/powerpc/boot/dts/mpc8548cds_32b.dts  |    3 ++-
 arch/powerpc/boot/dts/mpc8548cds_36b.dts  |    3 ++-
 arch/powerpc/platforms/85xx/Kconfig       |    1 +
 arch/powerpc/platforms/85xx/mpc85xx_cds.c |    7 +++++++
 arch/powerpc/sysdev/of_rtc.c              |    1 +
 6 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/boot/dts/mpc8548cds.dtsi b/arch/powerpc/boot/dts/mpc8548cds.dtsi
index c61f525..9f7be4f 100644
--- a/arch/powerpc/boot/dts/mpc8548cds.dtsi
+++ b/arch/powerpc/boot/dts/mpc8548cds.dtsi
@@ -73,6 +73,12 @@
 		compatible = "fsl,mpc8548cds-fpga";
 		reg = <0x1 0x0 0x1000>;
 	};
+
+	rtc@2,0 {
+		device_type = "rtc";
+		compatible = "rtc-ds1553";
+		reg = <0x2 0x0 0x00002000>;
+	};
 };
 
 &board_soc {
diff --git a/arch/powerpc/boot/dts/mpc8548cds_32b.dts b/arch/powerpc/boot/dts/mpc8548cds_32b.dts
index 6fd6316..fe79791 100644
--- a/arch/powerpc/boot/dts/mpc8548cds_32b.dts
+++ b/arch/powerpc/boot/dts/mpc8548cds_32b.dts
@@ -24,7 +24,8 @@
 		reg = <0 0xe0005000 0 0x1000>;
 
 		ranges = <0x0 0x0 0x0 0xff000000 0x01000000
-			  0x1 0x0 0x0 0xf8004000 0x00001000>;
+			  0x1 0x0 0x0 0xf8004000 0x00001000
+			  0x2 0x0 0x0 0xf8000000 0x00002000>;
 
 	};
 
diff --git a/arch/powerpc/boot/dts/mpc8548cds_36b.dts b/arch/powerpc/boot/dts/mpc8548cds_36b.dts
index 10e551b..5f8c5d4 100644
--- a/arch/powerpc/boot/dts/mpc8548cds_36b.dts
+++ b/arch/powerpc/boot/dts/mpc8548cds_36b.dts
@@ -24,7 +24,8 @@
 		reg = <0xf 0xe0005000 0 0x1000>;
 
 		ranges = <0x0 0x0 0xf 0xff000000 0x01000000
-			  0x1 0x0 0xf 0xf8004000 0x00001000>;
+			  0x1 0x0 0xf 0xf8004000 0x00001000
+			  0x2 0x0 0xf 0xf8000000 0x00002000>;
 
 	};
 
diff --git a/arch/powerpc/platforms/85xx/Kconfig b/arch/powerpc/platforms/85xx/Kconfig
index 146ca3e..94e35a4 100644
--- a/arch/powerpc/platforms/85xx/Kconfig
+++ b/arch/powerpc/platforms/85xx/Kconfig
@@ -51,6 +51,7 @@ config MPC85xx_CDS
 	select DEFAULT_UIMAGE
 	select PPC_I8259
 	select HAS_RAPIDIO
+	select OF_RTC
 	help
 	  This option enables support for the MPC85xx CDS board
 
diff --git a/arch/powerpc/platforms/85xx/mpc85xx_cds.c b/arch/powerpc/platforms/85xx/mpc85xx_cds.c
index 9fd72b6..8b59a12 100644
--- a/arch/powerpc/platforms/85xx/mpc85xx_cds.c
+++ b/arch/powerpc/platforms/85xx/mpc85xx_cds.c
@@ -367,6 +367,13 @@ machine_arch_initcall(mpc85xx_cds, mpc85xxcds_publish_pci_device);
 
 machine_device_initcall(mpc85xx_cds, mpc85xx_common_publish_devices);
 
+static int __init mpc85xxcds_rtc_probe(void)
+{
+        of_instantiate_rtc();
+        return 0;
+}
+machine_device_initcall(mpc85xx_cds,mpc85xxcds_rtc_probe);
+
 define_machine(mpc85xx_cds) {
 	.name		= "MPC85xx CDS",
 	.probe		= mpc85xx_cds_probe,
diff --git a/arch/powerpc/sysdev/of_rtc.c b/arch/powerpc/sysdev/of_rtc.c
index c9e803f..4d68a51 100644
--- a/arch/powerpc/sysdev/of_rtc.c
+++ b/arch/powerpc/sysdev/of_rtc.c
@@ -19,6 +19,7 @@ static __initdata struct {
 	char *plat_name;
 } of_rtc_table[] = {
 	{ "ds1743-nvram", "rtc-ds1742" },
+	{ "rtc-ds1553", "rtc-ds1553" },
 };
 
 void __init of_instantiate_rtc(void)
-- 
1.7.9.7

