From 9116516cc3a580aca74a6359a8277d46a2640f36 Mon Sep 17 00:00:00 2001
From: Timur Tabi <timur@freescale.com>
Date: Mon, 16 Apr 2012 10:33:20 -0500
Subject: [PATCH 09/19] powerpc/85xx: add MDIO support for the P5040DS

Add support for the muxing MDIO buses on the P5040DS (Super Hydra).  This
includes MDIO and PHY nodes in the device tree, a virtual MDIO board
driver (superhydra_mdio.c), and miscellaneous other networking-related
device tree updates

The DTS contains virtual MDIO nodes for the RGMII ports and each slot that
can hold an SGMII or XAUI card.  U-Boot will update the phy-handle pointers.
The mux values are already correct in the DTS

Signed-off-by: Timur Tabi <timur@freescale.com>
Signed-off-by: Haiying Wang <Haiying.Wang@freescale.com>
[Yongli: Original patch taken from FSL
    QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Integrated-by: Yongli He <yongli.he@windriver.com>
---
 arch/powerpc/boot/dts/fsl/p5040si-post.dtsi |   58 ++++++
 arch/powerpc/boot/dts/fsl/p5040si-pre.dtsi  |    1 +
 arch/powerpc/boot/dts/p5040ds.dts           |  263 ++++++++++++++++++---------
 3 files changed, 241 insertions(+), 81 deletions(-)

diff --git a/arch/powerpc/boot/dts/fsl/p5040si-post.dtsi b/arch/powerpc/boot/dts/fsl/p5040si-post.dtsi
index 0a85fbc..6b52551 100644
--- a/arch/powerpc/boot/dts/fsl/p5040si-post.dtsi
+++ b/arch/powerpc/boot/dts/fsl/p5040si-post.dtsi
@@ -383,5 +383,63 @@
 		};
 	};
 
+/include/ "qoriq-fman-1.dtsi"
+/include/ "qoriq-fman-1-1g-0.dtsi"
+/include/ "qoriq-fman-1-1g-1.dtsi"
+/include/ "qoriq-fman-1-1g-2.dtsi"
+/include/ "qoriq-fman-1-1g-3.dtsi"
+/include/ "qoriq-fman-1-1g-4.dtsi"
+/include/ "qoriq-fman-1-10g-0.dtsi"
+	fman1: fman@500000 {
+		/* tx - 1g - 0 */
+		port@a8000 {
+			fsl,qman-channel-id = <0x61>;
+		};
+		/* tx - 1g - 1 */
+		port@a9000 {
+			fsl,qman-channel-id = <0x62>;
+		};
+		/* tx - 1g - 2 */
+		port@aa000 {
+			fsl,qman-channel-id = <0x63>;
+		};
+		/* tx - 1g - 3 */
+		port@ab000 {
+			fsl,qman-channel-id = <0x64>;
+		};
+		/* tx - 1g - 4 */
+		port@ac000 {
+			fsl,qman-channel-id = <0x65>;
+		};
+		/* tx - 10g - 0 */
+		port@b0000 {
+			fsl,qman-channel-id = <0x60>;
+		};
+		/* offline 0 */
+		port@81000 {
+			fsl,qman-channel-id = <0x66>;
+		};
+		/* offline 1 */
+		port@82000 {
+			fsl,qman-channel-id = <0x67>;
+		};
+		/* offline 2 */
+		port@83000 {
+			fsl,qman-channel-id = <0x68>;
+		};
+		/* offline 3 */
+		port@84000 {
+			fsl,qman-channel-id = <0x69>;
+		};
+		/* offline 4 */
+		port@85000 {
+			fsl,qman-channel-id = <0x6a>;
+		};
+		/* offline 5 */
+		port@86000 {
+			fsl,qman-channel-id = <0x6b>;
+		};
+	};
+
 /include/ "qoriq-raid1.0-0.dtsi"
 };
diff --git a/arch/powerpc/boot/dts/fsl/p5040si-pre.dtsi b/arch/powerpc/boot/dts/fsl/p5040si-pre.dtsi
index 816f078..d9d2514 100644
--- a/arch/powerpc/boot/dts/fsl/p5040si-pre.dtsi
+++ b/arch/powerpc/boot/dts/fsl/p5040si-pre.dtsi
@@ -82,6 +82,7 @@
 		bman = &bman;
 		qman = &qman;
 		fman0 = &fman0;
+		fman1 = &fman1;
 	};
 
 	cpus {
diff --git a/arch/powerpc/boot/dts/p5040ds.dts b/arch/powerpc/boot/dts/p5040ds.dts
index a60d125..9bee35b 100644
--- a/arch/powerpc/boot/dts/p5040ds.dts
+++ b/arch/powerpc/boot/dts/p5040ds.dts
@@ -42,28 +42,46 @@
 	interrupt-parent = <&mpic>;
 
 	aliases {
-		ethernet0 = &enet0;
-		ethernet1 = &enet1;
-		ethernet2 = &enet2;
-		ethernet3 = &enet3;
-		ethernet4 = &enet4;
-		ethernet5 = &enet5;
-		phy_rgmii_0 = &phy_rgmii_0;
-		phy_rgmii_1 = &phy_rgmii_1;
-/*		phy_sgmii_1c = &phy_sgmii_1c;
-		phy_sgmii_1d = &phy_sgmii_1d;
-		phy_sgmii_1e = &phy_sgmii_1e;
-		phy_sgmii_1f = &phy_sgmii_1f;
-		phy_xgmii_1 = &phy_xgmii_1;
-*/		phy_xgmii_2 = &phy_xgmii_slot_2;
-
-		emi1_rgmii = &hydra_rg;
-		emi1_sgmii_slot2 = &hydra_sg_slt2;
-		emi1_sgmii_slot3 = &hydra_sg_slt3;
-		emi1_sgmii_slot5 = &hydra_sg_slt5;
-		emi1_sgmii_slot6 = &hydra_sg_slt6;
-/*		emi2_xgmii_slot1 = &hydra_xg_slt1;*/
-		emi2_xgmii_slot2 = &hydra_xg_slt2;
+		ethernet0 = &fm1dtsec1;
+		ethernet1 = &fm1dtsec2;
+		ethernet2 = &fm1dtsec3;
+		ethernet3 = &fm1dtsec4;
+		ethernet4 = &fm1dtsec5;
+		ethernet5 = &fm1tgec;
+		ethernet6 = &fm2dtsec1;
+		ethernet7 = &fm2dtsec2;
+		ethernet8 = &fm2dtsec3;
+		ethernet9 = &fm2dtsec4;
+		ethernet10 = &fm2dtsec5;
+		ethernet11 = &fm2tgec;
+
+		phy_sgmii_slot2_1c = &phy_sgmii_slot2_1c;
+		phy_sgmii_slot2_1d = &phy_sgmii_slot2_1d;
+		phy_sgmii_slot2_1e = &phy_sgmii_slot2_1e;
+		phy_sgmii_slot2_1f = &phy_sgmii_slot2_1f;
+
+		phy_sgmii_slot3_1c = &phy_sgmii_slot3_1c;
+		phy_sgmii_slot3_1d = &phy_sgmii_slot3_1d;
+		phy_sgmii_slot3_1e = &phy_sgmii_slot3_1e;
+		phy_sgmii_slot3_1f = &phy_sgmii_slot3_1f;
+
+		phy_sgmii_slot5_1c = &phy_sgmii_slot5_1c;
+		phy_sgmii_slot5_1d = &phy_sgmii_slot5_1d;
+		phy_sgmii_slot5_1e = &phy_sgmii_slot5_1e;
+		phy_sgmii_slot5_1f = &phy_sgmii_slot5_1f;
+
+		phy_sgmii_slot6_1c = &phy_sgmii_slot6_1c;
+		phy_sgmii_slot6_1d = &phy_sgmii_slot6_1d;
+		phy_sgmii_slot6_1e = &phy_sgmii_slot6_1e;
+		phy_sgmii_slot6_1f = &phy_sgmii_slot6_1f;
+
+		hydra_rg = &hydra_rg;
+		hydra_sg_slot2 = &hydra_sg_slot2;
+		hydra_sg_slot3 = &hydra_sg_slot3;
+		hydra_sg_slot5 = &hydra_sg_slot5;
+		hydra_sg_slot6 = &hydra_sg_slot6;
+		hydra_xg_slot1 = &hydra_xg_slot1;
+		hydra_xg_slot2 = &hydra_xg_slot2;
 	};
 
 	memory {
@@ -134,9 +152,8 @@
 		};
 
 		fman0: fman@400000 {
-			enet0: ethernet@e0000 {
+			fm1dtsec1: ethernet@e0000 {
 				tbi-handle = <&tbi0>;
-				//phy-handle = <&phy_sgmii_1c>;
 				phy-connection-type = "sgmii";
 			};
 
@@ -156,8 +173,8 @@
 					#size-cells = <0>;
 					compatible = "fsl,hydra-mdio";
 					fsl,mdio-handle = <&mdio0>;
-					fsl,hydra-mdio-mux-val = <0x00>;
-					fsl,hydra-mdio-mux-mask = <0x00>;
+					fsl,hydra-mdio-mux-val = <0x08>;
+					fsl,hydra-mdio-mux-mask = <0x70>;
 					status = "disabled";
 
 					phy_rgmii_0: ethernet-phy@0 {
@@ -169,22 +186,17 @@
 				};
 
 				/*
-				 * Virtual MDIO for the four-port SGMII card.
-				 * The fsl,hydra-mdio-muxval property will be
-				 * fixed-up by U-Boot based on the slot that
-				 * the SGMII card is in.
-				 *
-				 * Note: we do not support DTSEC5 connected to
-				 * SGMII, so this is the only SGMII node.
+				 * Virtual MDIO for the four-port SGMII cards.
 				 */
+
 				/* This for Slot 2 */
-				hydra_sg_slt2: hydra-sg-slt2 {
+				hydra_sg_slot2: hydra-sg-slot2 {
 					#address-cells = <1>;
 					#size-cells = <0>;
 					compatible = "fsl,hydra-mdio";
 					fsl,mdio-handle = <&mdio0>;
-					fsl,hydra-mdio-mux-val = <0x00>;
-					fsl,hydra-mdio-mux-mask = <0x00>;
+					fsl,hydra-mdio-mux-val = <0x28>;
+					fsl,hydra-mdio-mux-mask = <0x70>;
 					status = "disabled";
 
 					phy_sgmii_slot2_1c: ethernet-phy@1c {
@@ -200,14 +212,15 @@
 						reg = <0x1f>;
 					};
 				};
+
 				/* This for Slot 3 */
-				hydra_sg_slt3: hydra-sg-slt3 {
+				hydra_sg_slot3: hydra-sg-slot3 {
 					#address-cells = <1>;
 					#size-cells = <0>;
 					compatible = "fsl,hydra-mdio";
 					fsl,mdio-handle = <&mdio0>;
-					fsl,hydra-mdio-mux-val = <0x00>;
-					fsl,hydra-mdio-mux-mask = <0x00>;
+					fsl,hydra-mdio-mux-val = <0x68>;
+					fsl,hydra-mdio-mux-mask = <0x70>;
 					status = "disabled";
 
 					phy_sgmii_slot3_1c: ethernet-phy@1c {
@@ -223,14 +236,15 @@
 						reg = <0x1f>;
 					};
 				};
+
 				/* This for Slot 5 */
-				hydra_sg_slt5: hydra-sg-slt5 {
+				hydra_sg_slot5: hydra-sg-slot5 {
 					#address-cells = <1>;
 					#size-cells = <0>;
 					compatible = "fsl,hydra-mdio";
 					fsl,mdio-handle = <&mdio0>;
-					fsl,hydra-mdio-mux-val = <0x00>;
-					fsl,hydra-mdio-mux-mask = <0x00>;
+					fsl,hydra-mdio-mux-val = <0x38>;
+					fsl,hydra-mdio-mux-mask = <0x70>;
 					status = "disabled";
 
 					phy_sgmii_slot5_1c: ethernet-phy@1c {
@@ -246,14 +260,15 @@
 						reg = <0x1f>;
 					};
 				};
+
 				/* This for Slot 6 */
-				hydra_sg_slt6: hydra-sg-slt6 {
+				hydra_sg_slot6: hydra-sg-slot6 {
 					#address-cells = <1>;
 					#size-cells = <0>;
 					compatible = "fsl,hydra-mdio";
 					fsl,mdio-handle = <&mdio0>;
-					fsl,hydra-mdio-mux-val = <0x00>;
-					fsl,hydra-mdio-mux-mask = <0x00>;
+					fsl,hydra-mdio-mux-val = <0x48>;
+					fsl,hydra-mdio-mux-mask = <0x70>;
 					status = "disabled";
 
 					phy_sgmii_slot6_1c: ethernet-phy@1c {
@@ -269,12 +284,10 @@
 						reg = <0x1f>;
 					};
 				};
-
 			};
 
-			enet1: ethernet@e2000 {
+			fm1dtsec2: ethernet@e2000 {
 				tbi-handle = <&tbi1>;
-				//phy-handle = <&phy_sgmii_1d>;
 				phy-connection-type = "sgmii";
 			};
 
@@ -285,9 +298,8 @@
 				};
 			};
 
-			enet2: ethernet@e4000 {
+			fm1dtsec3: ethernet@e4000 {
 				tbi-handle = <&tbi2>;
-				//phy-handle = <&phy_sgmii_1e>;
 				phy-connection-type = "sgmii";
 			};
 
@@ -298,28 +310,22 @@
 				};
 			};
 
-			enet3: ethernet@e6000 {
+			fm1dtsec4: ethernet@e6000 {
 				tbi-handle = <&tbi3>;
-				//phy-handle = <&phy_sgmii_1f>;
 				phy-connection-type = "sgmii";
 			};
 
 			mdio@e7120 {
 				#address-cells = <1>;
 				#size-cells = <0>;
-				compatible = "fsl,fman-tbi";
-				reg = <0xe7120 0xee0>;
-				interrupts = <100 1 0 0>;
-
 				tbi3: tbi-phy@8 {
 					reg = <8>;
 					device_type = "tbi-phy";
 				};
 			};
 
-			enet4: ethernet@e8000 {
+			fm1dtsec5: ethernet@e8000 {
 				tbi-handle = <&tbi4>;
-				/* GETH1 on the board */
 				phy-handle = <&phy_rgmii_0>;
 				phy-connection-type = "rgmii";
 			};
@@ -331,11 +337,7 @@
 				};
 			};
 
-			enet5: ethernet@f0000 {
-				/*
-				 * phy-handle will be updated by U-Boot to
-				 * reflect the actual slot the XAUI card is in.
-				 */
+			fm1tgec: ethernet@f0000 {
 				phy-handle = <&phy_xgmii_slot_2>;
 				phy-connection-type = "xgmii";
 			};
@@ -348,32 +350,107 @@
 			 * only one of the ethernet-phy nodes below will be
 			 * used.
 			 */
-			/* Adding parent xmdio node to add the 2nd mdio bus later */
 			xmdio0: mdio@f1000 {
-
-				hydra_xg_slt2: hydra-xg-slt2 {
+				/* FM2 10GEC1 is always on slot 1 */
+				hydra_xg_slot1: hydra-xg-slot1 {
 					#address-cells = <1>;
 					#size-cells = <0>;
 					compatible = "fsl,hydra-xmdio";
 					fsl,mdio-handle = <&xmdio0>;
 					fsl,hydra-mdio-mux-val = <0x00>;
-					fsl,hydra-mdio-mux-mask = <0x00>;
+					fsl,hydra-mdio-mux-mask = <0x06>;
 					status = "disabled";
 
-					/* FM1 10GEC1 is always on slot 2 */
-					/* XAUI card in slot 1 */
-					/*phy_xgmii_1: ethernet-phy@4 {
-						reg = <0x4>;
+					phy_xgmii_slot_1: ethernet-phy@0 {
+						reg = <4>;
 					};
-					*/
-					/* XAUI card in slot 2 */
-					phy_xgmii_slot_2: ethernet-phy@0 {
-						reg = <0x0>;
+				};
+
+				/* FM1 10GEC1 is always on slot 2 */
+				hydra_xg_slot2: hydra-xg-slot2 {
+					#address-cells = <1>;
+					#size-cells = <0>;
+					compatible = "fsl,hydra-xmdio";
+					fsl,mdio-handle = <&xmdio0>;
+					fsl,hydra-mdio-mux-val = <0x02>;
+					fsl,hydra-mdio-mux-mask = <0x06>;
+					status = "disabled";
+
+					phy_xgmii_slot_2: ethernet-phy@4 {
+						reg = <0>;
 					};
 				};
 			};
 
 		};
+
+		fman1: fman@500000 {
+			fm2dtsec1: ethernet@e0000 {
+				tbi-handle = <&tbi5>;
+				phy-connection-type = "sgmii";
+			};
+
+			mdio@e1120 {
+				tbi5: tbi-phy@8 {
+					reg = <8>;
+					device_type = "tbi-phy";
+				};
+			};
+
+			fm2dtsec2: ethernet@e2000 {
+				tbi-handle = <&tbi6>;
+				phy-connection-type = "sgmii";
+			};
+
+			mdio@e3120 {
+				tbi6: tbi-phy@8 {
+					reg = <8>;
+					device_type = "tbi-phy";
+				};
+			};
+
+			fm2dtsec3: ethernet@e4000 {
+				tbi-handle = <&tbi7>;
+				phy-connection-type = "sgmii";
+			};
+
+			mdio@e5120 {
+				tbi7: tbi-phy@8 {
+					reg = <8>;
+					device_type = "tbi-phy";
+				};
+			};
+
+			fm2dtsec4: ethernet@e6000 {
+				tbi-handle = <&tbi8>;
+				phy-connection-type = "sgmii";
+			};
+
+			mdio@e7120 {
+				tbi8: tbi-phy@8 {
+					reg = <8>;
+					device_type = "tbi-phy";
+				};
+			};
+
+			fm2dtsec5: ethernet@e8000 {
+				tbi-handle = <&tbi9>;
+				phy-handle = <&phy_rgmii_1>;
+				phy-connection-type = "rgmii";
+			};
+
+			mdio@e9120 {
+				tbi9: tbi-phy@8 {
+					reg = <8>;
+					device_type = "tbi-phy";
+				};
+			};
+
+			fm2tgec: ethernet@f0000 {
+				phy-handle = <&phy_xgmii_slot_1>;
+				phy-connection-type = "xgmii";
+			};
+		};
 	};
 
 	lbc: localbus@ffe124000 {
@@ -483,27 +560,51 @@
 
 		ethernet@0 {
 			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet0>;
+			fsl,fman-mac = <&fm1dtsec1>;
 		};
 		ethernet@1 {
 			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet1>;
+			fsl,fman-mac = <&fm1dtsec2>;
 		};
 		ethernet@2 {
 			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet2>;
+			fsl,fman-mac = <&fm1dtsec3>;
 		};
 		ethernet@3 {
 			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet3>;
+			fsl,fman-mac = <&fm1dtsec4>;
 		};
 		ethernet@4 {
 			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet4>;
+			fsl,fman-mac = <&fm1dtsec5>;
 		};
 		ethernet@5 {
 			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet5>;
+			fsl,fman-mac = <&fm1tgec>;
+		};
+		ethernet@6 {
+			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,fman-mac = <&fm2dtsec1>;
+		};
+		ethernet@7 {
+			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,fman-mac = <&fm2dtsec2>;
+		};
+		ethernet@8 {
+			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,fman-mac = <&fm2dtsec3>;
+		};
+		ethernet@9 {
+			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,fman-mac = <&fm2dtsec4>;
+		};
+		ethernet@10 {
+			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,fman-mac = <&fm2dtsec5>;
+		};
+		ethernet@11 {
+			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,fman-mac = <&fm2tgec>;
 		};
 	};
 };
-- 
1.7.9.7

