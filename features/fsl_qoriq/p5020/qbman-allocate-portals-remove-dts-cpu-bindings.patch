From ad8f0f498c3b419413c121eea8f0034e96d43c40 Mon Sep 17 00:00:00 2001
From: Geoff Thorpe <Geoff.Thorpe@freescale.com>
Date: Wed, 14 Mar 2012 04:49:42 +0000
Subject: [PATCH 06/19] qbman: allocate portals, remove dts cpu-bindings.

should be squashed into commit:884bebf98ab37514e9dad54dcc5683eb2dc761b3
bman: allocate portals, remove dts cpu-bindings.

This removes portal->cpu and portal->{kernel/usdpaa} associations from
the device trees, and changes the qbman driver initialisation model.
Portals are now "allocated" for initialisation and dynamically bound
to the required cpus. The default setup is to try to allocate a portal
for each cpu, and if that fails (there are fewer portals than cpus)
one of the cpus will share its portal with those cpus that don't have
one.

Bootargs "qportals" and "bportals" can be used to override the default
setup, however. As an example of the syntax;
       bportals=s0,1-3,s4
means that cpus 1,2,3 get their own "unshared" portals, cpus 0 and 4
get "shared" portals, and any other cpus will share from one of the
portals assigned to cpus 0 or 4, selected in a round-robin fashion.
(In this example, cpu 5 would share cpu 0's portal, cpu 6 would share
cpu4's portal, and cpu 7 would share cpu 0's portal.) If no cpus are
specified for sharing and sharing is required, one will be chosen by
the driver. If there are cpus are specified for sharing but sharing is
not required, the portals will be configured without sharing support
(this uses thinner locks).

Note that one consequence of this change is that we can't abuse the
device-tree to limit certain portals to certain pool channels for
application configuration, because we no longer know which portals will
be used for what. As such, the "fsl,qman-pool-channels" links are removed,
and the qman portal driver searches for the available pool channels
instead.

This also updates the PAMU driver to preconfigure portal stashing LIODNs
for L3 - the previous assumption of L1 assumed a cpu-assignment, which is
no longer the case.

Signed-off-by: Geoff Thorpe <Geoff.Thorpe@freescale.com>
[Yongli: Original patch taken from FSL
    QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Integrated-by: Yongli He <yongli.he@windriver.com>
---
 arch/powerpc/boot/dts/p5020ds-usdpaa.dts |  166 +++++++-----------------------
 arch/powerpc/boot/dts/p5020ds.dts        |  113 +-------------------
 2 files changed, 43 insertions(+), 236 deletions(-)

diff --git a/arch/powerpc/boot/dts/p5020ds-usdpaa.dts b/arch/powerpc/boot/dts/p5020ds-usdpaa.dts
index fbbf831..78952f1 100644
--- a/arch/powerpc/boot/dts/p5020ds-usdpaa.dts
+++ b/arch/powerpc/boot/dts/p5020ds-usdpaa.dts
@@ -1,7 +1,7 @@
 /*
  * P5020DS Device Tree Source
  *
- * Copyright 2010-2011 Freescale Semiconductor Inc.
+ * Copyright 2010-2012 Freescale Semiconductor Inc.
  *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions are met:
@@ -35,133 +35,47 @@
 /include/ "p5020ds.dts"
 
 / {
-	bman-portals@ff4000000 {
-		bman-portal@0 {
-			cpu-handle = <&cpu0>;
-		};
-		bman-portal@4000 {
-			cpu-handle = <&cpu1>;
-		};
-		bman-portal@8000 {
-			fsl,usdpaa-portal;
-			cpu-handle = <&cpu0>;
-		};
-		bman-portal@c000 {
-			fsl,usdpaa-portal;
-			cpu-handle = <&cpu1>;
-		};
-		bman-portal@10000 {
-		};
-		bman-portal@14000 {
-		};
-		bman-portal@18000 {
-		};
-		bman-portal@1c000 {
-		};
-		bman-portal@20000 {
-		};
-		bman-portal@24000 {
-		};
-		/* BPID 0 is used as dynamic FQID allocator */
-		buffer-pool@0 {
-			compatible = "fsl,p5020-bpool", "fsl,bpool";
-			fsl,bpid = <0>;
-			fsl,bpool-cfg = <0 0x100 0 1 0 0x100>;
-		};
-		/* NB: the bpool-ethernet-seeds is not set to avoid buffer seeding,
-		 * because apps seed these pools buffers which are determined only
-		 * at run-time.
-		 * HOWEVER, the kernel driver requires the buffer-size and also
-		 * mis-interprets things if the base-address is zero (hence the
-		 * bogus values).
-		 */
-		bp7: buffer-pool@7 {
-			compatible = "fsl,p5020-bpool", "fsl,bpool";
-			fsl,bpid = <7>;
-			fsl,bpool-ethernet-cfg = <0 0 0 192 0 0xdeadbeef>;
-			fsl,bpool-thresholds = <0x400 0xc00 0x0 0x0>;
-		};
-		bp8: buffer-pool@8 {
-			compatible = "fsl,p5020-bpool", "fsl,bpool";
-			fsl,bpid = <8>;
-			fsl,bpool-ethernet-cfg = <0 0 0 576 0 0xabbaf00d>;
-			fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
-		};
-		bp9: buffer-pool@9 {
-			compatible = "fsl,p5020-bpool", "fsl,bpool";
-			fsl,bpid = <9>;
-			fsl,bpool-ethernet-cfg = <0 0 0 1600 0 0xfeedabba>;
-			fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
-		};
-		bp10: buffer-pool@10 {
-			compatible = "fsl,p5020-bpool", "fsl,bpool";
-			fsl,bpid = <10>;
-			fsl,bpool-thresholds = <0x10 0x30 0x0 0x0>;
-		};
-		bp11: buffer-pool@11 {
-			compatible = "fsl,p5020-bpool", "fsl,bpool";
-			fsl,bpid = <11>;
-			fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
-		};
-		bp12: buffer-pool@12 {
-			compatible = "fsl,p5020-bpool", "fsl,bpool";
-			fsl,bpid = <12>;
-			fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
-		};
+	/* NB: "bpool-ethernet-seeds" is not set to avoid buffer seeding,
+	 * because apps seed these pools with buffers allocated at
+	 * run-time.
+	 * HOWEVER, the kernel driver requires the buffer-size so
+	 * "fsl,bpool-ethernet-cfg" is set. It also mis-interprets
+	 * things if the base-address is zero (hence the 0xdeadbeef
+	 * values).
+	 */
+	bp7: buffer-pool@7 {
+		compatible = "fsl,p5020-bpool", "fsl,bpool";
+		fsl,bpid = <7>;
+		fsl,bpool-ethernet-cfg = <0 0 0 192 0 0xdeadbeef>;
+		fsl,bpool-thresholds = <0x400 0xc00 0x0 0x0>;
 	};
 
-	qman-portals@ff4200000 {
-		qportal0: qman-portal@0 {
-			cpu-handle = <&cpu0>;
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3>;
-		};
-
-		qportal1: qman-portal@4000 {
-			cpu-handle = <&cpu1>;
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3>;
-		};
-
-		qportal2: qman-portal@8000 {
-			fsl,usdpaa-portal;
-			cpu-handle = <&cpu0>;
-			fsl,qman-pool-channels = <&qpool4 &qpool5 &qpool6
-						  &qpool7 &qpool8 &qpool9
-						  &qpool10 &qpool11 &qpool12
-						  &qpool13 &qpool14 &qpool15>;
-		};
-
-		qportal3: qman-portal@c000 {
-			fsl,usdpaa-portal;
-			cpu-handle = <&cpu1>;
-			fsl,qman-pool-channels = <&qpool4 &qpool5 &qpool6
-						  &qpool7 &qpool8 &qpool9
-						  &qpool10 &qpool11 &qpool12
-						  &qpool13 &qpool14 &qpool15>;
-		};
-
-		qportal4: qman-portal@10000 {
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3>;
-		};
-
-		qportal5: qman-portal@14000 {
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3>;
-		};
-
-		qportal6: qman-portal@18000 {
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3>;
-		};
-
-		qportal7: qman-portal@1c000 {
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3>;
-		};
-
-		qportal8: qman-portal@20000 {
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3>;
-		};
-
-		qportal9: qman-portal@24000 {
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3>;
-		};
+	bp8: buffer-pool@8 {
+		compatible = "fsl,p5020-bpool", "fsl,bpool";
+		fsl,bpid = <8>;
+		fsl,bpool-ethernet-cfg = <0 0 0 576 0 0xabbaf00d>;
+		fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
+	};
+	bp9: buffer-pool@9 {
+		compatible = "fsl,p5020-bpool", "fsl,bpool";
+		fsl,bpid = <9>;
+		fsl,bpool-ethernet-cfg = <0 0 0 1600 0 0xfeedabba>;
+		fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
+	};
+	bp10: buffer-pool@10 {
+		compatible = "fsl,p5020-bpool", "fsl,bpool";
+		fsl,bpid = <10>;
+		fsl,bpool-thresholds = <0x10 0x30 0x0 0x0>;
+	};
+	bp11: buffer-pool@11 {
+		compatible = "fsl,p5020-bpool", "fsl,bpool";
+		fsl,bpid = <11>;
+		fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
+	};
+	bp12: buffer-pool@12 {
+		compatible = "fsl,p5020-bpool", "fsl,bpool";
+		fsl,bpid = <12>;
+		fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
 	};
 
 	fsl,dpaa {
diff --git a/arch/powerpc/boot/dts/p5020ds.dts b/arch/powerpc/boot/dts/p5020ds.dts
index f89956c..c13f4a1 100644
--- a/arch/powerpc/boot/dts/p5020ds.dts
+++ b/arch/powerpc/boot/dts/p5020ds.dts
@@ -1,7 +1,7 @@
 /*
  * P5020DS Device Tree Source
  *
- * Copyright 2010-2011 Freescale Semiconductor Inc.
+ * Copyright 2010-2012 Freescale Semiconductor Inc.
  *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions are met:
@@ -71,119 +71,10 @@
 
 	bportals: bman-portals@ff4000000 {
 		ranges = <0x0 0xf 0xf4000000 0x200000>;
-		bman-portal@0 {
-			cpu-handle = <&cpu0>;
-		};
-		bman-portal@4000 {
-			cpu-handle = <&cpu1>;
-		};
-		bman-portal@8000 {
-		};
-		bman-portal@c000 {
-		};
-		bman-portal@10000 {
-		};
-		bman-portal@14000 {
-		};
-		bman-portal@18000 {
-		};
-		bman-portal@1c000 {
-		};
-		bman-portal@20000 {
-		};
-		bman-portal@24000 {
-		};
-
-		buffer-pool@0 {
-			compatible = "fsl,p5020-bpool", "fsl,bpool";
-			fsl,bpid = <0>;
-			fsl,bpool-cfg = <0 0x100 0 1 0 0x100>;
-		};
 	};
 
 	qportals: qman-portals@ff4200000 {
 		ranges = <0x0 0xf 0xf4200000 0x200000>;
-		qportal0: qman-portal@0 {
-			cpu-handle = <&cpu0>;
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3
-						  &qpool4 &qpool5 &qpool6
-						  &qpool7 &qpool8 &qpool9
-						  &qpool10 &qpool11 &qpool12
-						  &qpool13 &qpool14 &qpool15>;
-		};
-
-		qportal1: qman-portal@4000 {
-			cpu-handle = <&cpu1>;
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3
-						  &qpool4 &qpool5 &qpool6
-						  &qpool7 &qpool8 &qpool9
-						  &qpool10 &qpool11 &qpool12
-						  &qpool13 &qpool14 &qpool15>;
-		};
-
-		qportal2: qman-portal@8000 {
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3
-						  &qpool4 &qpool5 &qpool6
-						  &qpool7 &qpool8 &qpool9
-						  &qpool10 &qpool11 &qpool12
-						  &qpool13 &qpool14 &qpool15>;
-		};
-
-		qportal3: qman-portal@c000 {
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3
-						  &qpool4 &qpool5 &qpool6
-						  &qpool7 &qpool8 &qpool9
-						  &qpool10 &qpool11 &qpool12
-						  &qpool13 &qpool14 &qpool15>;
-		};
-
-		qportal4: qman-portal@10000 {
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3
-						  &qpool4 &qpool5 &qpool6
-						  &qpool7 &qpool8 &qpool9
-						  &qpool10 &qpool11 &qpool12
-						  &qpool13 &qpool14 &qpool15>;
-		};
-
-		qportal5: qman-portal@14000 {
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3
-						  &qpool4 &qpool5 &qpool6
-						  &qpool7 &qpool8 &qpool9
-						  &qpool10 &qpool11 &qpool12
-						  &qpool13 &qpool14 &qpool15>;
-		};
-
-		qportal6: qman-portal@18000 {
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3
-						  &qpool4 &qpool5 &qpool6
-						  &qpool7 &qpool8 &qpool9
-						  &qpool10 &qpool11 &qpool12
-						  &qpool13 &qpool14 &qpool15>;
-		};
-
-		qportal7: qman-portal@1c000 {
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3
-						  &qpool4 &qpool5 &qpool6
-						  &qpool7 &qpool8 &qpool9
-						  &qpool10 &qpool11 &qpool12
-						  &qpool13 &qpool14 &qpool15>;
-		};
-
-		qportal8: qman-portal@20000 {
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3
-						  &qpool4 &qpool5 &qpool6
-						  &qpool7 &qpool8 &qpool9
-						  &qpool10 &qpool11 &qpool12
-						  &qpool13 &qpool14 &qpool15>;
-		};
-
-		qportal9: qman-portal@24000 {
-			fsl,qman-pool-channels = <&qpool1 &qpool2 &qpool3
-						  &qpool4 &qpool5 &qpool6
-						  &qpool7 &qpool8 &qpool9
-						  &qpool10 &qpool11 &qpool12
-						  &qpool13 &qpool14 &qpool15>;
-		};
 	};
 
 	soc: soc@ffe000000 {
@@ -553,3 +444,5 @@
 };
 
 /include/ "fsl/p5020si-post.dtsi"
+
+/include/ "fsl/qoriq-dpaa-res1.dtsi"
-- 
1.7.9.7

