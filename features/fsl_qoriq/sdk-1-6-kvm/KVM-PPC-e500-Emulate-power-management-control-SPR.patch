From 4e8d900975c1f2ddab903ad103af92f56de678c1 Mon Sep 17 00:00:00 2001
From: Mihai Caraman <mihai.caraman@freescale.com>
Date: Thu, 12 Sep 2013 18:01:32 +0300
Subject: [PATCH] KVM: PPC: e500: Emulate power management control SPR

commit 4e8d900975c1f2ddab903ad103af92f56de678c1 git://git.freescale.com/ppc/sdk/linux.git

e6500 rev2 Linux guest uses power management SPR to enable idle
power down for a core and its devices setting up the idle count
period at boot time.
The host already controls the power management configuration and
the guest will benefit from them, so emulate the guest requests
as a nop.

Signed-off-by: Mihai Caraman <mihai.caraman@freescale.com>
Change-Id: Ic6be4493d89c82760500f21318ae326cabb74107
Reviewed-on: http://git.am.freescale.net:8181/4701
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Wood Scott-B07421 <scottwood@freescale.com>
Reviewed-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
Signed-off-by: Vu Tran <vu.tran@windriver.com>

diff --git a/arch/powerpc/kvm/e500_emulate.c b/arch/powerpc/kvm/e500_emulate.c
index fcbfde9..a3ac4fd 100644
--- a/arch/powerpc/kvm/e500_emulate.c
+++ b/arch/powerpc/kvm/e500_emulate.c
@@ -228,6 +228,10 @@ int kvmppc_core_emulate_mtspr(struct kvm_vcpu *vcpu, int sprn, ulong spr_val)
 				spr_val);
 		break;
 
+	case SPR_PWRMGTCR0:
+		/* Guest relies on host power management configurations */
+		break;
+
 	/* extra exceptions */
 	case SPRN_IVOR32:
 		vcpu->arch.ivor[BOOKE_IRQPRIO_SPE_UNAVAIL] = spr_val;
@@ -335,6 +339,10 @@ int kvmppc_core_emulate_mfspr(struct kvm_vcpu *vcpu, int sprn, ulong *spr_val)
 		*spr_val = 0;
 		break;
 
+	case SPR_PWRMGTCR0:
+		*spr_val = 0;
+		break;
+
 	case SPRN_MMUCFG:
 		*spr_val = vcpu->arch.mmucfg;
 		break;
-- 
1.9.1

