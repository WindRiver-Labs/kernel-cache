From cda99c320204f5bf5e4f5cc78b442be9020cdd62 Mon Sep 17 00:00:00 2001
From: Mihai Caraman <mihai.caraman@freescale.com>
Date: Fri, 26 Apr 2013 13:47:48 +0300
Subject: [PATCH] KVM: PPC: e500v2: Fix __write_host_tlbe() build breakage (2)

commit cda99c320204f5bf5e4f5cc78b442be9020cdd62 git://git.freescale.com/ppc/sdk/linux.git

Fix a leftwover build error on e500v2.

Signed-off-by: Mihai Caraman <mihai.caraman@freescale.com>
Change-Id: I8de7db48765ea20c8902431d95dc3009e6688068
Reviewed-on: http://git.am.freescale.net:8181/2141
Reviewed-by: Yoder Stuart-B08248 <stuart.yoder@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Signed-off-by: Vu Tran <vu.tran@windriver.com>

diff --git a/arch/powerpc/kvm/e500_mmu_host.c b/arch/powerpc/kvm/e500_mmu_host.c
index b5e0a85..64de70a 100644
--- a/arch/powerpc/kvm/e500_mmu_host.c
+++ b/arch/powerpc/kvm/e500_mmu_host.c
@@ -133,15 +133,21 @@ static inline void write_host_tlbe(struct kvmppc_vcpu_e500 *vcpu_e500,
 		int tlbsel, int sesel, struct kvm_book3e_206_tlb_entry *stlbe)
 {
 	u32 mas0;
+	/* We use a pointer here bacause LPID value can change dynamically */
+	uint32_t *lpid = NULL;
+
+#ifdef CONFIG_KVM_BOOKE_HV
+	lpid = &vcpu_e500->vcpu.arch.lpid;
+#endif
 
 	if (tlbsel == 0) {
 		mas0 = get_host_mas0(stlbe->mas2);
-		__write_host_tlbe(stlbe, mas0, &vcpu_e500->vcpu.arch.lpid);
+		__write_host_tlbe(stlbe, mas0, lpid);
 	} else {
 		__write_host_tlbe(stlbe,
 				  MAS0_TLBSEL(1) |
 				  MAS0_ESEL(to_htlb1_esel(sesel)),
-				  &vcpu_e500->vcpu.arch.lpid);
+				  lpid);
 	}
 }
 
@@ -185,7 +191,7 @@ void kvmppc_map_magic(struct kvm_vcpu *vcpu)
 	magic.mas8 = 0;
 
 	__write_host_tlbe(&magic, MAS0_TLBSEL(1) | MAS0_ESEL(tlbcam_index),
-			  &magic.mas8);
+			  NULL);
 	preempt_enable();
 }
 #endif
-- 
1.9.1

