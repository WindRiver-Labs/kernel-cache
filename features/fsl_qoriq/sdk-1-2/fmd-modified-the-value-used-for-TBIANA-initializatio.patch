From d6077cc0de6efd763d5b15ecdda82dff4d9da59d Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Thu, 3 Nov 2011 10:14:20 +0200
Subject: [PATCH 014/128] fmd: modified the value used for TBIANA
 initialization

The TBI ANA register must be programmed with the value 0x4001 for SGMII
autonegotiation. The previous value, 0x1a0 is fit only for 1000Base-X.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 .../dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c       |   14 ++++++--------
 .../dpa/NetCommSw/Peripherals/FM/MAC/dtsec.h       |    7 ++++++-
 2 files changed, 12 insertions(+), 9 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c
index 531fa89..f00adda 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c
@@ -1601,23 +1601,21 @@ static t_Error DtsecInit(t_Handle h_Dtsec)
         uint16_t            tmpReg16;
 
         /* Configure the TBI PHY Control Register */
-        tmpReg16 = PHY_TBICON_SPEED2 | PHY_TBICON_SRESET;
-
+        tmpReg16 = PHY_TBICON_CLK_SEL | PHY_TBICON_SRESET;
         DTSEC_MII_WritePhyReg(p_Dtsec, p_DtsecDriverParam->tbiPhyAddr, 17, tmpReg16);
 
-        tmpReg16 = PHY_TBICON_SPEED2;
-
+        tmpReg16 = PHY_TBICON_CLK_SEL;
         DTSEC_MII_WritePhyReg(p_Dtsec, p_DtsecDriverParam->tbiPhyAddr, 17, tmpReg16);
 
+        tmpReg16 = PHY_CR_SPEED1;
         if(!p_DtsecDriverParam->halfDuplex)
-            tmpReg16 |= PHY_CR_FULLDUPLEX | 0x8000 | PHY_CR_ANE;
-
+            tmpReg16 |= PHY_CR_FULLDUPLEX | PHY_CR_PHY_RESET | PHY_CR_ANE;
         DTSEC_MII_WritePhyReg(p_Dtsec, p_DtsecDriverParam->tbiPhyAddr, 0, tmpReg16);
 
-        tmpReg16 = 0x01a0;
+        tmpReg16 = PHY_TBIANA_SGMII;
         DTSEC_MII_WritePhyReg(p_Dtsec, p_DtsecDriverParam->tbiPhyAddr, 4, tmpReg16);
 
-        tmpReg16 = 0x1340;
+        tmpReg16 = PHY_CR_ANE | PHY_CR_RESET_AN | PHY_CR_FULLDUPLEX | PHY_CR_SPEED1;
         DTSEC_MII_WritePhyReg(p_Dtsec, p_DtsecDriverParam->tbiPhyAddr, 0, tmpReg16);
     }
 
diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.h b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.h
index 4bb7a86..3bd578e 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.h
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.h
@@ -322,14 +322,19 @@ typedef  uint32_t t_ErrorDisable;
 #define     VAL12BIT    0x00001000
 
 /* PHY Control Register */
+#define PHY_CR_PHY_RESET    0x8000
 #define PHY_CR_LOOPBACK     0x4000
 #define PHY_CR_SPEED0       0x2000
 #define PHY_CR_ANE          0x1000
+#define PHY_CR_RESET_AN     0x0200
 #define PHY_CR_FULLDUPLEX   0x0100
 #define PHY_CR_SPEED1       0x0040
 
 #define PHY_TBICON_SRESET   0x8000
-#define PHY_TBICON_SPEED2   0x0020
+#define PHY_TBICON_CLK_SEL  0x0020
+
+#define PHY_TBIANA_SGMII    0x4001
+#define PHY_TBIANA_1000X    0x01a0
 
 /* CAR1/2 bits */
 #define CAR1_TR64   0x80000000
-- 
1.7.9.7

