From 89662dddf824a9a5b140afe3e8791b9b9372ee59 Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Fri, 10 Feb 2012 22:20:16 +0000
Subject: [PATCH 073/128] fmd: added DtsecRestartTbiAN() function to restart
 TBI PHY autonegotiation.

DtsecRestartTbiAN() was added to allow restarting autonegotiation in the TBI PHYs.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 .../dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c       |   10 ++++++++++
 .../dpa/NetCommSw/inc/Peripherals/fm_mac_ext.h     |    9 +++++++++
 2 files changed, 19 insertions(+)

diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c
index f011143..e26d147 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c
@@ -1123,6 +1123,16 @@ static t_Error DtsecDelHashMacAddress(t_Handle h_Dtsec, t_EnetAddr *p_EthAddr)
     return E_OK;
 }
 
+void DtsecRestartTbiAN(t_Handle h_Dtsec)
+{
+    t_Dtsec         *p_Dtsec = (t_Dtsec *)h_Dtsec;
+
+    if (!p_Dtsec)
+	return;
+
+    DTSEC_MII_WritePhyReg(p_Dtsec, DEFAULT_tbiPhyAddr, 0,
+		PHY_CR_ANE | PHY_CR_RESET_AN | PHY_CR_FULLDUPLEX | PHY_CR_SPEED1);
+}
 
 /* .............................................................................. */
 
diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/inc/Peripherals/fm_mac_ext.h b/drivers/net/ethernet/freescale/dpa/NetCommSw/inc/Peripherals/fm_mac_ext.h
index bd5b891..87057a4 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/inc/Peripherals/fm_mac_ext.h
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/inc/Peripherals/fm_mac_ext.h
@@ -703,6 +703,15 @@ t_Error FM_MAC_MII_ReadPhyReg(t_Handle h_FmMac,  uint8_t phyAddr, uint8_t reg, u
 t_Error FM_MAC_DumpRegs(t_Handle h_FmMac);
 #endif /* (defined(DEBUG_ERRORS) && ... */
 
+/**************************************************************************//**
+ @Function      DtsecRestartTbiAN
+
+ @Description   Restart TBI autonegotiation for a given Dtsec TBI interface.
+
+ @Param[in]     h_Dtsec     -   A handle to the Dtsec.
+*//***************************************************************************/
+void DtsecRestartTbiAN(t_Handle h_Dtsec);
+
 /** @} */ /* end of FM_mac_runtime_control_grp group */
 /** @} */ /* end of FM_mac_grp group */
 /** @} */ /* end of FM_grp group */
-- 
1.7.9.7

