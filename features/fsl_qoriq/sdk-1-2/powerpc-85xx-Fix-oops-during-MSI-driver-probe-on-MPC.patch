From de77d0c1c99779194b45c17bf7ec8cf4ed61e528 Mon Sep 17 00:00:00 2001
From: Zhao Chenhui <chenhui.zhao@freescale.com>
Date: Fri, 17 Feb 2012 13:00:03 +0800
Subject: [PATCH 015/121] powerpc/85xx: Fix oops during MSI driver probe on
 MPC85xxCDS boards

MPC85xx chips report the wrong value in feature reporting register,
and that causes the following oops:

Unable to handle kernel paging request for data at address 0x00000c00
Faulting instruction address: 0xc0014c8c
Oops: Kernel access of bad area, sig: 11 [#1]
MPC85xx CDS
Modules linked in:
[...]
NIP [c0014c8c] mpic_set_irq_type+0x180/0x1bc
LR [c0014b2c] mpic_set_irq_type+0x20/0x1bc
Call Trace:
[cf439de0] [000000e0] 0xe0 (unreliable)
[cf439e00] [c0074eb4] __irq_set_trigger+0x70/0x124
[cf439e20] [c007612c] irq_set_irq_type+0x6c/0x74
[cf439e50] [c0005160] irq_create_of_mapping+0xe4/0x114
[cf439e80] [c03142c0] irq_of_parse_and_map+0x30/0x40
[cf439eb0] [c03142ec] of_irq_to_resource+0x1c/0x58
[cf439ec0] [c0314358] of_irq_count+0x30/0x50
[cf439ed0] [c0314a28] of_device_alloc+0x60/0x170
[cf439f20] [c0314b8c] of_platform_device_create+0x54/0x94

This patch fixes the issue by enabling MPIC_BROKEN_FRR_NIRQS quirk.

Signed-off-by: Zhao Chenhui <chenhui.zhao@freescale.com>
Signed-off-by: Li Yang <leoli@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/platforms/85xx/mpc85xx_cds.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/arch/powerpc/platforms/85xx/mpc85xx_cds.c b/arch/powerpc/platforms/85xx/mpc85xx_cds.c
index 11156fb..9740fc2 100644
--- a/arch/powerpc/platforms/85xx/mpc85xx_cds.c
+++ b/arch/powerpc/platforms/85xx/mpc85xx_cds.c
@@ -221,7 +221,7 @@ static struct irqaction mpc85xxcds_8259_irqaction = {
 static void __init mpc85xx_cds_pic_init(void)
 {
 	struct mpic *mpic;
-	mpic = mpic_alloc(NULL, 0, MPIC_BIG_ENDIAN,
+	mpic = mpic_alloc(NULL, 0, MPIC_BIG_ENDIAN | MPIC_BROKEN_FRR_NIRQS,
 			0, 256, " OpenPIC  ");
 	BUG_ON(mpic == NULL);
 	mpic_init(mpic);
-- 
1.7.9.7

