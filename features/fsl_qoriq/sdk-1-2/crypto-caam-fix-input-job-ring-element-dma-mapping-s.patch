From 3d1453e05f71dd34abf55377c24a98c16c5cf5ad Mon Sep 17 00:00:00 2001
From: Kim Phillips <kim.phillips@freescale.com>
Date: Fri, 22 Jun 2012 19:42:36 -0500
Subject: [PATCH 046/128] crypto: caam - fix input job ring element dma
 mapping size

commit a68d2595876c7cc56f122572fa0a3465d438fefc upstream

SEC4 h/w gets configured in 32- vs. 36-bit physical
addressing modes depending on the size of dma_addr_t,
which is not always equal to sizeof(u32 *).

Also fixed alignment of a dma_unmap call whilst in there.

Signed-off-by: Kim Phillips <kim.phillips@freescale.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
---
 drivers/crypto/caam/jr.c |   10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/drivers/crypto/caam/jr.c b/drivers/crypto/caam/jr.c
index fbe9d0c..c9d3b6f 100644
--- a/drivers/crypto/caam/jr.c
+++ b/drivers/crypto/caam/jr.c
@@ -359,7 +359,7 @@ static int caam_jr_init(struct device *dev)
 
 	/* Setup rings */
 	inpbusaddr = dma_map_single(dev, jrp->inpring,
-				    sizeof(u32 *) * JOBR_DEPTH,
+				    sizeof(dma_addr_t) * JOBR_DEPTH,
 				    DMA_BIDIRECTIONAL);
 	if (dma_mapping_error(dev, inpbusaddr)) {
 		dev_err(dev, "caam_jr_init(): can't map input ring\n");
@@ -374,9 +374,9 @@ static int caam_jr_init(struct device *dev)
 				    DMA_BIDIRECTIONAL);
 	if (dma_mapping_error(dev, outbusaddr)) {
 		dev_err(dev, "caam_jr_init(): can't map output ring\n");
-			dma_unmap_single(dev, inpbusaddr,
-					 sizeof(u32 *) * JOBR_DEPTH,
-					 DMA_BIDIRECTIONAL);
+		dma_unmap_single(dev, inpbusaddr,
+				 sizeof(dma_addr_t) * JOBR_DEPTH,
+				 DMA_BIDIRECTIONAL);
 		kfree(jrp->inpring);
 		kfree(jrp->outring);
 		kfree(jrp->entinfo);
@@ -429,7 +429,7 @@ int caam_jr_shutdown(struct device *dev)
 	dma_unmap_single(dev, outbusaddr,
 			 sizeof(struct jr_outentry) * JOBR_DEPTH,
 			 DMA_BIDIRECTIONAL);
-	dma_unmap_single(dev, inpbusaddr, sizeof(u32 *) * JOBR_DEPTH,
+	dma_unmap_single(dev, inpbusaddr, sizeof(dma_addr_t) * JOBR_DEPTH,
 			 DMA_BIDIRECTIONAL);
 	kfree(jrp->outring);
 	kfree(jrp->inpring);
-- 
1.7.9.7

