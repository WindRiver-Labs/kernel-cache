From 6c62c1ae95908cd9853416b845d6ee5879e95f94 Mon Sep 17 00:00:00 2001
From: Geoff Thorpe <Geoff.Thorpe@freescale.com>
Date: Tue, 3 Apr 2012 10:28:17 -0500
Subject: [PATCH 093/121] qman: use the pamu_get_liodn_count() interface

For correct operation in all environments (native, topaz, kvm) we must
query the number of configurable LIODNs for a QMan portal before
attempting to configure them.

Signed-off-by: Geoff Thorpe <Geoff.Thorpe@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/staging/fsl_qbman/qman_driver.c |   10 ++++++----
 1 file changed, 6 insertions(+), 4 deletions(-)

diff --git a/drivers/staging/fsl_qbman/qman_driver.c b/drivers/staging/fsl_qbman/qman_driver.c
index 8c0313e..d88a0e4 100644
--- a/drivers/staging/fsl_qbman/qman_driver.c
+++ b/drivers/staging/fsl_qbman/qman_driver.c
@@ -259,10 +259,12 @@ static struct qm_portal_config *get_pcfg(struct list_head *list)
 static void set_liodns(const struct qm_portal_config *pcfg, int cpu)
 {
 	unsigned int index = 0;
-	int ret;
-	do {
-		ret = pamu_set_stash_dest(pcfg->node, index++, cpu, 1);
-	} while (ret >= 0);
+	unsigned int liodn_cnt = pamu_get_liodn_count(pcfg->node);
+	while (index < liodn_cnt) {
+		int ret = pamu_set_stash_dest(pcfg->node, index++, cpu, 1);
+		if (ret < 0)
+			pr_warning("Failed to set QMan stashing LIODN\n");
+	}
 }
 #else
 #define set_liodns(pcfg, cpu) do { } while (0)
-- 
1.7.9.7

