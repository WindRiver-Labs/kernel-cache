From b7af6b59881471a83e9cc590569e9a1333ba4636 Mon Sep 17 00:00:00 2001
From: Stefan Szabo <szbs001@freescale.com>
Date: Mon, 2 Apr 2012 18:49:37 +0300
Subject: [PATCH 076/128] fmd: Revert port FIFO LLD defaults to those in GA4.3

This fixes a performance leak in FMD15 (LLD GA4.4)

Signed-off-by: Stefan Szabo <szbs001@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 .../dpa/NetCommSw/Peripherals/FM/Port/fm_port.c    |    5 ++++-
 .../dpa/NetCommSw/Peripherals/FM/Port/fm_port.h    |    7 +++++++
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Port/fm_port.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Port/fm_port.c
index 2b6cd93..d05b79a 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Port/fm_port.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Port/fm_port.c
@@ -2328,7 +2328,10 @@ t_Handle FM_PORT_Config(t_FmPortParams *p_FmPortParams)
 
     p_FmPort->maxFrameLength                                        = DEFAULT_PORT_maxFrameLength;
     /* resource distribution. */
-    p_FmPort->fifoBufs.num                                          = 0;
+
+    /* Patch for getting GA4.3 defaults */
+    p_FmPort->fifoBufs.num                                          = DEFAULT_PORT_sizeOfFifo(p_FmPort->portType);
+
     p_FmPort->fifoBufs.extra                                        = 0;
     p_FmPort->openDmas.num                                          = DEFAULT_PORT_numOfOpenDmas(p_FmPort->portType);
     p_FmPort->openDmas.extra                                        = DEFAULT_PORT_extraNumOfOpenDmas(p_FmPort->portType);
diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Port/fm_port.h b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Port/fm_port.h
index 18830f8..3151fe4 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Port/fm_port.h
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Port/fm_port.h
@@ -129,6 +129,13 @@
                  ((type) == e_FM_PORT_TYPE_TX) ||           \
                  ((type) == e_FM_PORT_TYPE_OH_OFFLINE_PARSING)) ? 1 : 0))
 
+#define DEFAULT_PORT_sizeOfFifo(type)                                   \
+    (uint32_t)((((type) == e_FM_PORT_TYPE_RX_10G) ||                    \
+                ((type) == e_FM_PORT_TYPE_TX_10G)) ? (16*KILOBYTE) :    \
+               ((((type) == e_FM_PORT_TYPE_RX) ||                       \
+                 ((type) == e_FM_PORT_TYPE_TX) ||                       \
+                 ((type) == e_FM_PORT_TYPE_OH_OFFLINE_PARSING)) ? (4*KILOBYTE) : (1536)))
+
 #define DEFAULT_PORT_txBdRingLength                 16
 #define DEFAULT_PORT_rxBdRingLength                 128
 #define DEFAULT_PORT_ImfwExtStructsMemId            0
-- 
1.7.9.7

