From 201560a10de7197a9855c1be3b3dbd470eb98572 Mon Sep 17 00:00:00 2001
From: Hongtao Jia <b38951@freescale.com>
Date: Tue, 13 Mar 2012 14:13:38 +0000
Subject: [PATCH 024/121] powerpc/fsl-pci: Fix repetitive pci-device-add issue
 for CoreNet platform

Common pci/pcie initialization has added the pci devices,
so remove them from the corenet platform. The patch fixes
the following call trace on corenet platform:

sysfs: cannot create duplicate filename '/devices/ffe200000.pcie'
------------[ cut here ]------------
WARNING: at fs/sysfs/dir.c:455
Modules linked in:
NIP: c0118564 LR: c0118564 CTR: c000f728
REGS: ea093d20 TRAP: 0700   Not tainted  (3.0.23-01127-g69e24e2-dirty)
MSR: 00029002 <EE,ME,CE>  CR: 22244022  XER: 00000000
TASK = ea0739b0[1] 'swapper' THREAD: ea092000 CPU: 2
GPR00: c0118564 ea093dd0 ea0739b0 00000048 00021002 ffffffff c0758c94 00004000
GPR08: c071fda4 00000000 c074e950 00000001 22244048 100a38d4 00000000 00000000
GPR16: c0000a00 00000014 3fffffff 03fe3000 00000015 00000000 c074a000 00000000
GPR24: 00000000 fffffff4 ea327454 ea093e38 ea1c5000 ea1c5000 ea327454 ffffffef
NIP [c0118564] sysfs_add_one+0x9c/0xb4
LR [c0118564] sysfs_add_one+0x9c/0xb4
Call Trace:
[ea093dd0] [c0118564] sysfs_add_one+0x9c/0xb4 (unreliable)
[ea093df0] [c01185ec] create_dir+0x70/0xf8
[ea093e30] [c0118730] sysfs_create_dir+0xa4/0xf0
[ea093e60] [c01f2ac0] kobject_add_internal+0xac/0x1e8
[ea093e80] [c01f2f88] kobject_add+0x80/0xc8
[ea093ec0] [c0250b50] device_add+0xd4/0x554
[ea093f10] [c04097b0] of_device_add+0x64/0x74
[ea093f20] [c0409e24] of_platform_device_create+0x64/0x94
[ea093f40] [c0409e74] of_platform_bus_create+0x20/0xa8
[ea093f60] [c0409fc4] of_platform_bus_probe+0xc8/0xec
[ea093f80] [c06dcd04] declare_of_platform_devices+0x24/0x164
[ea093fa0] [c06dd20c] __machine_initcall_p4080_ds_declare_of_platform_devices+0x2c/0x3c
[ea093fb0] [c0002150] do_one_initcall+0x148/0x1a8
[ea093fe0] [c06d2814] kernel_init+0x9c/0x120
[ea093ff0] [c000d314] kernel_thread+0x4c/0x68
Instruction dump:
4bfff2bd 7c7c1b78 4beff28d 38002f00 7c1c1b2e 7f83e378 809e0010 4beff1f1
7c641b78 3c60c064 38636170 4840b449 <0fe00000> 7fa3eb78 4bfa0b05 4bffff80
---[ end trace 75d2b1226921d2ff ]---

Signed-off-by: Jia Hongtao <B38951@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/platforms/85xx/corenet_ds.c |    6 ------
 1 file changed, 6 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/corenet_ds.c b/arch/powerpc/platforms/85xx/corenet_ds.c
index e471448..cbdd94a 100644
--- a/arch/powerpc/platforms/85xx/corenet_ds.c
+++ b/arch/powerpc/platforms/85xx/corenet_ds.c
@@ -91,12 +91,6 @@ static const struct of_device_id of_device_ids[] __devinitconst = {
 	{
 		.compatible	= "fsl,srio",
 	},
-	{
-		.compatible	= "fsl,p4080-pcie",
-	},
-	{
-		.compatible	= "fsl,qoriq-pcie-v2.2",
-	},
 	/* The following two are for the Freescale hypervisor */
 	{
 		.name		= "hypervisor",
-- 
1.7.9.7

