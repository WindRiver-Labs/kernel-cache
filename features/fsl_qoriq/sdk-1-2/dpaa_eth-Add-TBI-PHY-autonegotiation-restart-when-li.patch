From 85cdbb205df6a0d6655179eb397fab8e4a992c37 Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Fri, 10 Feb 2012 22:20:30 +0000
Subject: [PATCH 098/128] dpaa_eth: Add TBI PHY autonegotiation restart when
 link is lost

Add TBI PHY autonegotiation restart in adjust_link().
If the dtsec interface is brought up while having incoming traffic the TBI
PHY autonegotiation restart may be required to get the link up

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/mac-api.c |   16 ++++++++++++++--
 1 file changed, 14 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/mac-api.c b/drivers/net/ethernet/freescale/dpa/mac-api.c
index e752333..df24813 100644
--- a/drivers/net/ethernet/freescale/dpa/mac-api.c
+++ b/drivers/net/ethernet/freescale/dpa/mac-api.c
@@ -1,4 +1,4 @@
-/* Copyright 2008-2011 Freescale Semiconductor, Inc.
+/* Copyright 2008-2012 Freescale Semiconductor, Inc.
  *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions are met:
@@ -44,6 +44,8 @@
 #include "fm_mac_ext.h"
 #include "fm_rtc_ext.h"
 
+#include "fsl_pq_mdio.h"
+
 #define MAC_DESCRIPTION "FSL FMan MAC API based driver"
 
 MODULE_LICENSE("Dual BSD/GPL");
@@ -359,11 +361,21 @@ static void adjust_link(struct net_device *net_dev)
 	struct dpa_priv_s *priv = netdev_priv(net_dev);
 	struct mac_device *mac_dev = priv->mac_dev;
 	struct phy_device *phy_dev = mac_dev->phy_dev;
+	struct mac_priv_s *mac_priv;
 	int	 _errno;
 	t_Error	 err;
 
-	if (!phy_dev->link)
+	if (!phy_dev->link) {
+
+		fsl_pq_mdio_lock(NULL);
+
+		mac_priv = (struct mac_priv_s *)macdev_priv(mac_dev);
+		DtsecRestartTbiAN(mac_priv->mac);
+
+		fsl_pq_mdio_unlock(NULL);
+
 		return;
+	}
 
 	err = FM_MAC_AdjustLink(
 			((struct mac_priv_s *)macdev_priv(mac_dev))->mac,
-- 
1.7.9.7

