From db3989c002a5abb4375e1122a255a889366c7633 Mon Sep 17 00:00:00 2001
From: Chunhe Lan <Chunhe.Lan@freescale.com>
Date: Thu, 24 May 2012 11:17:38 +0000
Subject: [PATCH 033/121] edac: Use ccsr_pci structure instead of hardcoded
 define

There are some differences of register offset and definition between
pci and pcie error management registers. While, some other pci/pcie
error management registers are nearly the same.

To merge pci and pcie edac code into one, it is easier to use ccsr_pci
structure than the hardcoded define. So remove the hardcoded define and
add pci/pcie error management register in ccsr_pci structure.

Signed-off-by: Chunhe Lan <Chunhe.Lan@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/sysdev/fsl_pci.c |    4 +-
 arch/powerpc/sysdev/fsl_pci.h |   84 +++++++++++++++++++----------------------
 drivers/edac/mpc85xx_edac.h   |   13 +------
 3 files changed, 43 insertions(+), 58 deletions(-)

diff --git a/arch/powerpc/sysdev/fsl_pci.c b/arch/powerpc/sysdev/fsl_pci.c
index 9b05094..a3e8c0a 100644
--- a/arch/powerpc/sysdev/fsl_pci.c
+++ b/arch/powerpc/sysdev/fsl_pci.c
@@ -170,9 +170,9 @@ static void __init setup_pci_atmu(struct pci_controller *hose,
 	     fsl_svr_older_than(2, 1)) {
 		if (of_device_is_compatible(hose->dn, "fsl,mpc8540-pci")) {
 			/* disable OWMSV and ORMSV error capture */
-			setbits32(&pci->pcier.pecdr, OWMSV | ORMSV);
+			setbits32(&pci->pex_err_cap_dr, OWMSV | ORMSV);
 			/* disable OWMSV and ORMSV error reporting */
-			clrbits32(&pci->pcier.peer, OWMSV | ORMSV);
+			clrbits32(&pci->pex_err_en, OWMSV | ORMSV);
 		}
 	}
 
diff --git a/arch/powerpc/sysdev/fsl_pci.h b/arch/powerpc/sysdev/fsl_pci.h
index 582cde0..c4cef59 100644
--- a/arch/powerpc/sysdev/fsl_pci.h
+++ b/arch/powerpc/sysdev/fsl_pci.h
@@ -1,7 +1,7 @@
 /*
  * MPC85xx/86xx PCI Express structure define
  *
- * Copyright 2007,2011 Freescale Semiconductor, Inc
+ * Copyright 2007,2011,2012 Freescale Semiconductor, Inc
  *
  * This program is free software; you can redistribute  it and/or modify it
  * under  the terms of  the GNU General  Public License as published by the
@@ -14,6 +14,8 @@
 #ifndef __POWERPC_FSL_PCI_H
 #define __POWERPC_FSL_PCI_H
 
+#include <asm/pci-bridge.h>
+
 #define PCIE_LTSSM	0x0404		/* PCIE Link Training and Status */
 #define PCIE_LTSSM_L0	0x16		/* L0 state */
 #define PIWAR_EN		0x80000000	/* Enable */
@@ -43,45 +45,6 @@ struct pci_inbound_window_regs {
 	u8	res2[12];
 };
 
-/* PCI Error Management Registers */
-struct pci_err_regs {
-	/*   0x.e00 - PCI Error Detect Register */
-	__be32	pedr;
-	/*   0x.e04 - PCI Error Capture Disable Register */
-	__be32	pecdr;
-	/*   0x.e08 - PCI Error Interrupt Enable Register */
-	__be32	peer;
-	/*   0x.e0c - PCI Error Attributes Capture Register */
-	__be32	peattrcr;
-	/*   0x.e10 - PCI Error Address Capture Register */
-	__be32	peaddrcr;
-	/*   0x.e14 - PCI Error Extended Address Capture Register */
-	__be32	peextaddrcr;
-	/*   0x.e18 - PCI Error Data Low Capture Register */
-	__be32	pedlcr;
-	/*   0x.e1c - PCI Error Data High Capture Register */
-	__be32	pedhcr;
-	/*   0x.e20 - PCI Gasket Timer Register */
-	__be32	gas_timr;
-	u8	res21[4];
-};
-
-/* PCI Express Error Management Registers */
-struct pcie_err_regs {
-	/*  0x.e00 - PCI/PCIE error detect register */
-	__be32	pex_err_dr;
-	u8	res21[4];
-	/*  0x.e08 - PCI/PCIE error interrupt enable register */
-	__be32	pex_err_en;
-	u8	res22[4];
-	/*  0x.e10 - PCI/PCIE error disable register */
-	__be32	pex_err_disr;
-	u8	res23[12];
-	/*  0x.e20 - PCI/PCIE error capture status register */
-	__be32	pex_err_cap_stat;
-	u8	res24[4];
-};
-
 /* PCI/PCI Express IO block registers for 85xx/86xx */
 struct ccsr_pci {
 	__be32	config_addr;		/* 0x.000 - PCI/PCIE Configuration Address Register */
@@ -112,11 +75,42 @@ struct ccsr_pci {
  * define an inbound window base extended address register.
  */
 	struct pci_inbound_window_regs piw[4];
-/* PCI/PCI Express Error Management Registers */
-	union {
-		struct pci_err_regs pcier;
-		struct pcie_err_regs pexer;
-	};
+/* Merge PCI/PCI Express error management registers */
+	__be32	pex_err_dr;	  /* 0x.e00
+				   * - PCI/PCIE error detect register
+				   */
+	__be32	pex_err_cap_dr;	  /* 0x.e04
+				   * - PCI error capture disabled register
+				   * - PCIE has no this register
+				   */
+	__be32	pex_err_en;	  /* 0x.e08
+				   * - PCI/PCIE error interrupt enable register
+				   */
+	__be32	pex_err_attrib;	  /* 0x.e0c
+				   * - PCI error attributes capture register
+				   * - PCIE has no this register
+				   */
+	__be32	pex_err_disr;	  /* 0x.e10
+				   * - PCI error address capture register
+				   * - PCIE error disable register
+				   */
+	__be32	pex_err_ext_addr; /* 0x.e14
+				   * - PCI error extended addr capture register
+				   * - PCIE has no this register
+				   */
+	__be32	pex_err_dl;	  /* 0x.e18
+				   * - PCI error data low capture register
+				   * - PCIE has no this register
+				   */
+	__be32	pex_err_dh;	  /* 0x.e1c
+				   * - PCI error data high capture register
+				   * - PCIE has no this register
+				   */
+	__be32	pex_err_cap_stat; /* 0x.e20
+				   * - PCI gasket timer register
+				   * - PCIE error capture status register
+				   */
+	u8	res24[4];
 	__be32	pex_err_cap_r0;		/* 0x.e28 - PCIE error capture register 0 */
 	__be32	pex_err_cap_r1;		/* 0x.e2c - PCIE error capture register 0 */
 	__be32	pex_err_cap_r2;		/* 0x.e30 - PCIE error capture register 0 */
diff --git a/drivers/edac/mpc85xx_edac.h b/drivers/edac/mpc85xx_edac.h
index efb25bc..40f2994 100644
--- a/drivers/edac/mpc85xx_edac.h
+++ b/drivers/edac/mpc85xx_edac.h
@@ -1,5 +1,7 @@
 /*
  * Freescale MPC85xx Memory Controller kenel module
+ * Copyright (c) 2012 Freescale Semiconductor, Inc.
+ *
  * Author: Dave Jiang <djiang@mvista.com>
  *
  * 2006-2007 (c) MontaVista Software, Inc. This file is licensed under
@@ -132,17 +134,6 @@
 #define PCI_EDE_PERR_MASK	(PCI_EDE_TGT_PERR | PCI_EDE_MST_PERR | \
 				PCI_EDE_ADDR_PERR)
 
-#define MPC85XX_PCI_ERR_DR		0x0000
-#define MPC85XX_PCI_ERR_CAP_DR		0x0004
-#define MPC85XX_PCI_ERR_EN		0x0008
-#define MPC85XX_PCI_ERR_ATTRIB		0x000c
-#define MPC85XX_PCI_ERR_ADDR		0x0010
-#define MPC85XX_PCI_ERR_EXT_ADDR	0x0014
-#define MPC85XX_PCI_ERR_DL		0x0018
-#define MPC85XX_PCI_ERR_DH		0x001c
-#define MPC85XX_PCI_GAS_TIMR		0x0020
-#define MPC85XX_PCI_PCIX_TIMR		0x0024
-
 struct mpc85xx_mc_pdata {
 	char *name;
 	int edac_idx;
-- 
1.7.9.7

