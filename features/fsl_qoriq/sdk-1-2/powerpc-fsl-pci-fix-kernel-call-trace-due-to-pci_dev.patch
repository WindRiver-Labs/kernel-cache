From 8f80378967bcc20f8d9829ffd62f4e993c25c794 Mon Sep 17 00:00:00 2001
From: Shengzhou Liu <Shengzhou.Liu@freescale.com>
Date: Thu, 12 Apr 2012 15:14:48 +0800
Subject: [PATCH 025/121] powerpc/fsl-pci: fix kernel call trace due to
 pci_devs_phb_init()

pci_devs_phb_init() was called incorrectly before fsl_add_bridge(), which was caused
by patch "powerpc/fsl-pci: Unify pci/pcie initialization code".
Now we have it called after fsl_add_bridge() to fix below call trace on P5020-64b.

Call Trace:
[c0000000fb09f720] [c000000000332e78] .ata_host_activate+0x48/0x1a0 (unreliable)
[c0000000fb09f7d0] [c00000000034c098] .sil24_init_one+0x408/0x520
[c0000000fb09f8f0] [c00000000029fbd4] .pci_device_probe+0xa4/0xd0
[c0000000fb09f980] [c0000000002f1b50] .driver_probe_device+0xe0/0x230
[c0000000fb09fa20] [c0000000002f1dac] .__driver_attach+0x10c/0x110
[c0000000fb09fab0] [c0000000002f059c] .bus_for_each_dev+0x7c/0xd0
[c0000000fb09fb50] [c0000000002f1628] .driver_attach+0x28/0x40
[c0000000fb09fbd0] [c0000000002f1020] .bus_add_driver+0xd0/0x310
[c0000000fb09fc80] [c0000000002f233c] .driver_register+0x9c/0x1a0
[c0000000fb09fd20] [c00000000029ff94] .__pci_register_driver+0x64/0x140
[c0000000fb09fdc0] [c0000000008a5120] .sil24_init+0x24/0x3c
[c0000000fb09fe40] [c000000000000ea0] .do_one_initcall+0x60/0x1d0
[c0000000fb09ff00] [c000000000882a38] .kernel_init+0xbc/0x168
[c0000000fb09ff90] [c0000000000152c8] .kernel_thread+0x54/0x70
Instruction dump:
7c9d2378 7cb92b78 7cda3378 7cfc3b78 4bff87bd 7c781b79 40820114 2fbd0000
409e004c 7f390074 7b39d182 6b390001 <0b190000> 382100b0 7fe3fb78 7f84e378
---[ end trace 809e6cda5911fb31 ]---

Signed-off-by: Shengzhou Liu <Shengzhou.Liu@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image. Just minor context
mods in order to port to 3.4 kernel.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/platforms/85xx/corenet_ds.c |    6 ------
 arch/powerpc/sysdev/fsl_pci.c            |    3 +++
 2 files changed, 3 insertions(+), 6 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/corenet_ds.c b/arch/powerpc/platforms/85xx/corenet_ds.c
index cbdd94a..47bcde9 100644
--- a/arch/powerpc/platforms/85xx/corenet_ds.c
+++ b/arch/powerpc/platforms/85xx/corenet_ds.c
@@ -57,12 +57,6 @@ void __init corenet_ds_setup_arch(void)
 {
 	mpc85xx_smp_init();
 
-#ifdef CONFIG_PCI
-#ifdef CONFIG_PPC64
-	pci_devs_phb_init();
-#endif
-#endif
-
 #ifdef CONFIG_SWIOTLB
 	if (memblock_end_of_DRAM() > 0xffffffff)
 		ppc_swiotlb_enable = 1;
diff --git a/arch/powerpc/sysdev/fsl_pci.c b/arch/powerpc/sysdev/fsl_pci.c
index 49ca7e5..dc4f666 100644
--- a/arch/powerpc/sysdev/fsl_pci.c
+++ b/arch/powerpc/sysdev/fsl_pci.c
@@ -929,6 +929,9 @@ static int __devinit fsl_pci_probe(struct platform_device *pdev)
 		}
 #endif
 	}
+#ifdef CONFIG_PPC64
+	pci_devs_phb_init();
+#endif
 
 	return 0;
 }
-- 
1.7.9.7

