From 67de1c448608cd99b568ab08003fde32dacd722e Mon Sep 17 00:00:00 2001
From: Lian Minghuan-B31939 <Minghuan.Lian@freescale.com>
Date: Wed, 2 May 2012 16:28:19 +0000
Subject: [PATCH 067/121] RMan: adjust RMan uio interrupt handler

When RMan uio driver gets an interrupt, it will disable the interrupt.
Then the user space application will process the interrupt and re-enable
interrupt again.

Signed-off-by: Minghuan Lian <Minghuan.Lian@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/staging/fsl_rman/rman_uio_driver.c |    6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_rman/rman_uio_driver.c b/drivers/staging/fsl_rman/rman_uio_driver.c
index ddaad8c..5c73ed1 100644
--- a/drivers/staging/fsl_rman/rman_uio_driver.c
+++ b/drivers/staging/fsl_rman/rman_uio_driver.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2011 Freescale Semiconductor, Inc.
+ * Copyright (C) 2011-2012 Freescale Semiconductor, Inc.
  *
  * Author: Minghuan Lian <Minghuan.Lian@freescale.com>
  *
@@ -29,6 +29,7 @@
 static const char rman_uio_version[] = "Rman UIO driver v1.0";
 
 #define IB_INDEX_OFFSET 12
+#define MMIER 0x0420 /* Message manage Interrupt Enable Register*/
 #define MMEDR 0x0424 /* Message manager error detect register */
 #define MMEDR_CLEAR 0x800000FF
 
@@ -82,7 +83,8 @@ static irqreturn_t rman_uio_irq_handler(int irq, struct uio_info *dev_info)
 	status = in_be32(rmdev->global_regs + MMEDR);
 
 	if (status) {
-		out_be32(rmdev->global_regs + MMEDR, MMEDR_CLEAR);
+		/* disable interrupt */
+		out_be32(rmdev->global_regs + MMIER, 0);
 		return IRQ_HANDLED;
 	} else
 		return IRQ_NONE;
-- 
1.7.9.7

