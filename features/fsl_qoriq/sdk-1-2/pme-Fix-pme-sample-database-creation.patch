From e20f8e82082278750671492da5a661d009593a54 Mon Sep 17 00:00:00 2001
From: Jeffrey Ladouceur <Jeffrey.Ladouceur@freescale.com>
Date: Thu, 27 Oct 2011 10:39:22 -0400
Subject: [PATCH 009/128] pme: Fix pme sample database creation

The pme database content is dependent on the PME HW version.

Signed-off-by: Jeffrey Ladouceur <Jeffrey.Ladouceur@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/staging/fsl_pme2/pme2_sample_db.c |   36 +++++++++++++++++++++++++----
 1 file changed, 32 insertions(+), 4 deletions(-)

diff --git a/drivers/staging/fsl_pme2/pme2_sample_db.c b/drivers/staging/fsl_pme2/pme2_sample_db.c
index 4e56c7a..4ab2887 100644
--- a/drivers/staging/fsl_pme2/pme2_sample_db.c
+++ b/drivers/staging/fsl_pme2/pme2_sample_db.c
@@ -47,6 +47,9 @@ static u8 pme_db[] = {
 	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 	0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c,
 	0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+/* Rev 2.2 */
+/*	0x00, 0x0c, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00,
+	0x48, 0x41, 0x40, 0x20, 0x00, 0x11, */
 /* Rev 2.1 */
 	0x00, 0x0c, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00,
 	0x90, 0x41, 0x40, 0x20, 0x00, 0x11,
@@ -55,6 +58,9 @@ static u8 pme_db[] = {
 	0x20, 0x41, 0x40, 0x20, 0x00, 0x11, */
 	0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x98,
 	0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+/* Rev 2.0 */
+/*	0x00, 0x0d, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00,
+	0x48, 0x41, 0xff, 0x81, 0x00, 0x00, */
 /* Rev 2.1 */
 	0x00, 0x0d, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00,
 	0x90, 0x41, 0xff, 0x81, 0x00, 0x00,
@@ -124,6 +130,9 @@ static u8 pme_db[] = {
 static u8 db_read[] = {
 	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18,
 	0x11, 0x00, 0x00, 0x00, 0x00, 0x00,
+/* Rev 2.2 */
+/*	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00,
+	0x48, 0x41 */
 /* Rev 2.1 */
 	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00,
 	0x90, 0x41
@@ -135,6 +144,9 @@ static u8 db_read[] = {
 static u8 db_read_expected_result[] = {
 	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c,
 	0x11, 0x00, 0x00, 0x00, 0x00, 0x00,
+/* Rev 2.2 */
+/*	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00,
+	0x48, 0x41, 0x40, 0x20, 0x00, 0x11*/
 /* Rev 2.1 */
 	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00,
 	0x90, 0x41, 0x40, 0x20, 0x00, 0x11
@@ -285,8 +297,9 @@ int pme2_sample_db(void)
 		pr_err("sample_db: can't read pme revision %d\n", ret);
 		goto _finish_1;
 	}
-	/* If Rev 2.0...update database */
-	if ((pme_rev & 0x0000FFFF) == 0x00000200) {
+	/* If Rev 2.0, Rev 2.2...update database */
+	switch (pme_rev & 0x0000FFFF) {
+	case 0x00000200:
 		pr_info("sample_db: db for pme ver 2.0\n");
 		pme_db[133] = 0x01;
 		pme_db[134] = 0x20;
@@ -296,8 +309,23 @@ int pme2_sample_db(void)
 		db_read[22] = 0x20;
 		db_read_expected_result[21] = 0x01;
 		db_read_expected_result[22] = 0x20;
-	} else
-		pr_info("sample_db: db for pme ver 2.1 or greater\n");
+		break;
+	case 0x00000201:
+		pr_info("sample_db: db for pme ver 2.1\n");
+		break;
+	case 0x00000202:
+		pr_info("sample_db: db for pme ver 2.2\n");
+		pme_db[134] = 0x48;
+		pme_db[162] = 0x48;
+		db_read[22] = 0x48;
+		db_read_expected_result[22] = 0x48;
+		break;
+	default:
+		pr_err("sample_db: Unknown pme hw ver 0x%x\n",
+			pme_rev & 0x0000FFFF);
+		ret = -ENODEV;
+		goto _finish_1;
+	}
 	init_completion(&ctx.done);
 	ret = pme_ctx_init(&ctx.base_ctx,
 		PME_CTX_FLAG_EXCLUSIVE |
-- 
1.7.9.7

