From 0bfbe4deb4f3e68f0414153c2c04fdb963f771a4 Mon Sep 17 00:00:00 2001
From: Tudor Laurentiu <laurentiu.tudor@freescale.com>
Date: Thu, 17 May 2012 22:14:29 +0000
Subject: [PATCH 105/121] powerpc/watchdog: Don't enable interrupt on PPC64
 BookE

Critical interrupts are not handled on PPC64 BookE machines,
so when the first watchdog interrupt fires the machine will
freeze without a warning until it's rebooted by the second
watchdog trigger.
Plus, the interrupt isn't used anyway since the driver
expects a usermode app to ping the watchdog periodically.

Signed-off-by: Laurentiu Tudor <Laurentiu.Tudor@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/watchdog/booke_wdt.c |   17 +++++++++++++++++
 1 file changed, 17 insertions(+)

diff --git a/drivers/watchdog/booke_wdt.c b/drivers/watchdog/booke_wdt.c
index 056e6f8..9a026f5 100644
--- a/drivers/watchdog/booke_wdt.c
+++ b/drivers/watchdog/booke_wdt.c
@@ -92,6 +92,15 @@ static void __booke_wdt_set(void *data)
 
 	val = mfspr(SPRN_TCR);
 	val &= ~WDTP_MASK;
+
+#ifdef CONFIG_PPC_BOOK3E_64
+	/*
+	 * Crit ints are currently broken on PPC64 Book-E, so
+	 * just disable them for now.
+	 */
+	val &= ~TCR_WIE;
+#endif
+
 	val |= WDTP(booke_wdt_period);
 
 	mtspr(SPRN_TCR, val);
@@ -122,6 +131,14 @@ static void __booke_wdt_enable(void *data)
 	val &= ~WDTP_MASK;
 	val |= (TCR_WIE|TCR_WRC(WRC_CHIP)|WDTP(booke_wdt_period));
 
+#ifdef CONFIG_PPC_BOOK3E_64
+	/*
+	 * Crit ints are currently broken on PPC64 Book-E, so
+	 * just disable them for now.
+	 */
+	val &= ~TCR_WIE;
+#endif
+
 	mtspr(SPRN_TCR, val);
 }
 
-- 
1.7.9.7

