From bad2e180d43528a68ef07af78a81eeee6333e23e Mon Sep 17 00:00:00 2001
From: Xuelin Shi <b29237@freescale.com>
Date: Sat, 5 May 2012 14:12:05 +0000
Subject: [PATCH 120/121] DMA/RAIDENGINE: optimizing spinlock use to improve
 raid performace.

re_jr_tx_status(...) competed for the desc_lock with re_jr_dequeue(...) heavily.

when trying to make raid6 structure, the speed is very slow.
md0 : active raid6 sdd1[3] sdc1[2] sdb1[1] sda1[0]
      32129792 blocks level 6, 64k chunk, algorithm 2 [4/4] [UUUU]
            [===>.................]  resync = 19.9% (3201540/16064896) finish=97.9min
      speed=2187K/sec

Actually the lock in re_jr_tx_status could be removed and using an smp_mb().

This patch is similar as: http://linux.freescale.net/patchwork/patch/17645/

Signed-off-by: Xuelin Shi <b29237@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/dma/fsl_raid.c |    4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)

diff --git a/drivers/dma/fsl_raid.c b/drivers/dma/fsl_raid.c
index b55654d..f7db92c 100644
--- a/drivers/dma/fsl_raid.c
+++ b/drivers/dma/fsl_raid.c
@@ -278,10 +278,8 @@ static enum dma_status re_jr_tx_status(struct dma_chan *chan,
 
 	jr = container_of(chan, struct re_jr, chan);
 	last_used = chan->cookie;
-
-	spin_lock_bh(&jr->desc_lock);
+	smp_mb();
 	last_complete = jr->completed_cookie;
-	spin_unlock_bh(&jr->desc_lock);
 
 	dma_set_tx_state(txstate, last_complete, last_used, 0);
 
-- 
1.7.9.7

