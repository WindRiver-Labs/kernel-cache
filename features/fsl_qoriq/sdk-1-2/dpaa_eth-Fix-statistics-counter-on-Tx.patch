From d44f7a227a4a6c7a3ac6ce74229bfe97add9ca49 Mon Sep 17 00:00:00 2001
From: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Date: Thu, 26 Jan 2012 14:51:27 +0200
Subject: [PATCH 092/128] dpaa_eth: Fix statistics counter on Tx

A statistics counter was left incremented on Tx path, even if
transmit failed.

Signed-off-by: Ioana Radulescu <ruxandra.radulescu@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 5b64a68..f1dfc80 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -1349,8 +1349,10 @@ xmit_failed:
 	dma_unmap_single(dev, addr, dpa_bp->size, DMA_TO_DEVICE);
 
 dma_map_failed:
-	if (fd.cmd & FM_FD_CMD_FCO)
+	if (fd.cmd & FM_FD_CMD_FCO) {
 		(*percpu_priv->dpa_bp_count)--;
+		percpu_priv->tx_returned--;
+	}
 
 l3_l4_csum_failed:
 	dev_kfree_skb(skb);
-- 
1.7.9.7

