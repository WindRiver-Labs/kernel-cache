From 8d7a949e37cad9d4520c5f7a43e7e892b77dde86 Mon Sep 17 00:00:00 2001
From: Geoff Thorpe <Geoff.Thorpe@freescale.com>
Date: Wed, 14 Mar 2012 04:49:45 +0000
Subject: [PATCH 080/121] fsl_usdpaa_shmem: use memblock_alloc()

Rather than searching for an unreserved memory region, use
memblock_alloc(). This should fix the bug when running with non-zero
physical base address.

Signed-off-by: Geoff Thorpe <Geoff.Thorpe@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/misc/fsl_usdpaa_shmem.c |   36 +++++++++++-------------------------
 1 file changed, 11 insertions(+), 25 deletions(-)

diff --git a/drivers/misc/fsl_usdpaa_shmem.c b/drivers/misc/fsl_usdpaa_shmem.c
index a800199..93a6813 100644
--- a/drivers/misc/fsl_usdpaa_shmem.c
+++ b/drivers/misc/fsl_usdpaa_shmem.c
@@ -89,31 +89,17 @@ static struct miscdevice usdpaa_shmem_miscdev = {
 __init void fsl_usdpaa_shmem_init_early(void)
 {
 	u64 sz = (u64)PAGE_SIZE << (2 * CONFIG_FSL_USDPAA_SHMEM_LOG4);
-	u64 addr = (memblock_end_of_DRAM() - sz) & ~(sz - 1);
-	/* FIXME: if booting with 8GB of RAM, the upper memory region seems to
-	 * be unavailable because of some conflict with the ramdisk. Ensure that
-	 * we don't search above 6GB. */
-	if (addr >= 0x180000000ULL)
-		addr = (0x180000000ULL - sz) & ~(sz - 1);
-	/* Search downwards, looking for an appropriately-aligned region that
-	 * isn't already reserved. */
-	do {
-		if (!memblock_is_region_reserved(addr, sz))
-			goto found;
-		addr -= sz;
-		/* If we reach the lower 1GB, call off the search. */
-	} while (addr >= 0x40000000);
-	pr_err("Failed to reserve USDPAA region (sz:%llx)\n", sz);
-	return;
-found:
-	memblock_reserve(addr, sz);
-	usdpaa_phys_start = addr;
-	usdpaa_phys_size = sz;
-	usdpaa_pfn_start = (addr >> PAGE_SHIFT);
-	usdpaa_pfn_len = (sz >> PAGE_SHIFT);
-	usdpaa_tlbcam_index = tlbcam_index++;
-	pr_info("USDPAA region at %llx:%llx\n",
-		usdpaa_phys_start, usdpaa_phys_size);
+	u64 addr = memblock_alloc(sz, sz);
+	if (addr) {
+		usdpaa_phys_start = addr;
+		usdpaa_phys_size = sz;
+		usdpaa_pfn_start = (addr >> PAGE_SHIFT);
+		usdpaa_pfn_len = (sz >> PAGE_SHIFT);
+		usdpaa_tlbcam_index = tlbcam_index++;
+		pr_info("USDPAA region at %llx:%llx\n",
+			usdpaa_phys_start, usdpaa_phys_size);
+	} else
+		pr_err("Failed to reserve USDPAA region (sz:%llx)\n", sz);
 }
 
 static int __init usdpaa_shmem_init(void)
-- 
1.7.9.7

