From 395fe3d7a6b38bae1ef152bbe2a93010269974eb Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Wed, 31 Oct 2012 14:02:56 +0800
Subject: [PATCH] net/dpa: protect qman_irqsource_add/remove with preempt
 disabled

The qman_irqsource_add/remove are used to enable/disable a specific
interrupt source to assert the interrupt signal to the portal
which is bind to the current cpu. So we must make sure
that the pair of qman_irqsource_add/remove are run on the same
cpu.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 5aa773e..cd83f04 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -2225,8 +2225,8 @@ fq_init_fail:
 
 fq_create_fail:
 	priv->egress_fqs[smp_processor_id()] = oldq;
-	local_bh_enable();
 	qman_irqsource_add(QM_PIRQ_DQRI);
+	local_bh_enable();
 	tx_unit_test_ran = true;
 	set_cpus_allowed_ptr(current, old_cpumask);
 	free_cpumask_var(old_cpumask);
-- 
1.7.9.7

