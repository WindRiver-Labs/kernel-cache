From bd68c77a6ac33db5e1eb0ac73c149cb45d90df42 Mon Sep 17 00:00:00 2001
From: Timur Tabi <timur@freescale.com>
Date: Thu, 29 Mar 2012 15:37:58 -0500
Subject: [PATCH 055/121] powerpc/85xx: fsl-pamu: add function
 pamu_get_liodn_count()

Function pamu_get_liodn_count() allows drivers to query the number of LIODNs
that are defined in a given device tree node.

Signed-off-by: Timur Tabi <timur@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image. Remove the mods for
hypervisor support.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/sysdev/fsl_pamu.c |   32 ++++++++++++++++++++++++++++++++
 arch/powerpc/sysdev/fsl_pamu.h |    2 ++
 2 files changed, 34 insertions(+)

diff --git a/arch/powerpc/sysdev/fsl_pamu.c b/arch/powerpc/sysdev/fsl_pamu.c
index fd45102..feae293 100644
--- a/arch/powerpc/sysdev/fsl_pamu.c
+++ b/arch/powerpc/sysdev/fsl_pamu.c
@@ -479,6 +479,38 @@ found_cpu:
 }
 EXPORT_SYMBOL(pamu_set_stash_dest);
 
+/**
+ * pamu_get_liodn_count() - returns the number of LIODNs for a given node
+ * @node: the node to query
+ *
+ * This function returns the number of LIODNs in a given node.
+ *
+ * The function returns the number >= 0 on success, or a negative error code
+ * on failure.  Currently, an error code cannot be returned, but that may
+ * change in the future.  Callers are still expected to test for an error.
+ */
+int pamu_get_liodn_count(struct device_node *node)
+{
+	const u32 *prop;
+	int len;
+
+	prop = of_get_property(node, "fsl,liodn", &len);
+
+	if (!prop)
+		/*
+		 * KVM sets up default stashing but does not provide an
+		 * interface to the PAMU, so there are no PAMU nodes or LIODN
+		 * properties in the guest device tree.  Therefore, if the
+		 * LIODN property is missing, that doesn't mean that 'node' is
+		 * invalid.
+		 */
+		return 0;
+
+	return len / sizeof(uint32_t);
+}
+EXPORT_SYMBOL(pamu_get_liodn_count);
+
+
 static void __init setup_omt(struct ome *omt)
 {
 	struct ome *ome;
diff --git a/arch/powerpc/sysdev/fsl_pamu.h b/arch/powerpc/sysdev/fsl_pamu.h
index 4361b0b..cc9fac1 100644
--- a/arch/powerpc/sysdev/fsl_pamu.h
+++ b/arch/powerpc/sysdev/fsl_pamu.h
@@ -36,4 +36,6 @@
 int pamu_set_stash_dest(struct device_node *node, unsigned int index,
 	unsigned int cpu, unsigned int cache_level);
 
+int pamu_get_liodn_count(struct device_node *node);
+
 #endif
-- 
1.7.9.7

