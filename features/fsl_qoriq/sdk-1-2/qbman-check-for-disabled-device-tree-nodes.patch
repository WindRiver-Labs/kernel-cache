From e1281d84667a64b9a3452ead15058f00992901b8 Mon Sep 17 00:00:00 2001
From: Bharat Bhushan <r65777@freescale.com>
Date: Wed, 28 Mar 2012 16:17:18 +0530
Subject: [PATCH 090/121] qbman: check for disabled device tree nodes

BQMAN portal driver should not use portals which are disabled (have status = disabled property).
This looks like accidentally removed by patch "qbman: allocate portals, remove dts cpu-bindings."

Signed-off-by: Bharat Bhushan <bharat.bhushan@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/staging/fsl_qbman/bman_driver.c |    2 ++
 drivers/staging/fsl_qbman/qman_driver.c |    2 ++
 2 files changed, 4 insertions(+)

diff --git a/drivers/staging/fsl_qbman/bman_driver.c b/drivers/staging/fsl_qbman/bman_driver.c
index 827666a..f16a902 100644
--- a/drivers/staging/fsl_qbman/bman_driver.c
+++ b/drivers/staging/fsl_qbman/bman_driver.c
@@ -342,6 +342,8 @@ static __init int bman_init(void)
 	}
 	/* Step 1. See comments at the beginning of the file. */
 	for_each_compatible_node(dn, NULL, "fsl,bman-portal") {
+		if (!of_device_is_available(dn))
+			continue;
 		pcfg = parse_pcfg(dn);
 		if (pcfg)
 			list_add_tail(&pcfg->list, &unused_pcfgs);
diff --git a/drivers/staging/fsl_qbman/qman_driver.c b/drivers/staging/fsl_qbman/qman_driver.c
index 481b773..7ded5a0 100644
--- a/drivers/staging/fsl_qbman/qman_driver.c
+++ b/drivers/staging/fsl_qbman/qman_driver.c
@@ -424,6 +424,8 @@ static __init int qman_init(void)
 	}
 	/* Initialise portals. See bman_driver.c for comments */
 	for_each_compatible_node(dn, NULL, "fsl,qman-portal") {
+		if (!of_device_is_available(dn))
+			continue;
 		pcfg = parse_pcfg(dn);
 		if (pcfg) {
 			pcfg->public_cfg.pools = pools_sdqcr;
-- 
1.7.9.7

