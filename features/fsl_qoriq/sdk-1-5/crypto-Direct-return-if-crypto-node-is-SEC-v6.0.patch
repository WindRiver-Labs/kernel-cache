From c9f5d1ce8688f66f1ca84f43d72f4f63a9937ff1 Mon Sep 17 00:00:00 2001
From: Po Liu <Po.Liu@freescale.com>
Date: Wed, 6 Nov 2013 16:07:54 +0800
Subject: [PATCH 330/429] crypto: Direct return if crypto node is SEC v6.0

Current CAAM driver do not support SEC v6.0. Direct return ENODEV
if probe the fdt crypto node is sec v6.0.

Signed-off-by: Po Liu <Po.Liu@freescale.com>
Change-Id: I1acc2e54806816ca7037d794829987c4710a1aab
Reviewed-on: http://git.am.freescale.net:8181/6236
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Horia Ioan Geanta Neag <horia.geanta@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
Reviewed-by: Mingkai Hu <Mingkai.Hu@freescale.com>
[origin patch is from QorIQ-SDK-V1.5-20131219-yocto]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/crypto/caam/caamalg.c  |    3 +++
 drivers/crypto/caam/caamhash.c |    3 +++
 drivers/crypto/caam/caampkc.c  |    3 +++
 drivers/crypto/caam/caamrng.c  |    3 +++
 drivers/crypto/caam/ctrl.c     |    6 +++++-
 5 files changed, 17 insertions(+), 1 deletions(-)

diff --git a/drivers/crypto/caam/caamalg.c b/drivers/crypto/caam/caamalg.c
index ce66e90..6c2d314 100644
--- a/drivers/crypto/caam/caamalg.c
+++ b/drivers/crypto/caam/caamalg.c
@@ -2205,6 +2205,9 @@ static int __init caam_algapi_init(void)
 			return -ENODEV;
 	}
 
+	if (of_device_is_compatible(dev_node,"fsl,sec-v6.0"))
+		return -ENODEV;
+
 	pdev = of_find_device_by_node(dev_node);
 	if (!pdev)
 		return -ENODEV;
diff --git a/drivers/crypto/caam/caamhash.c b/drivers/crypto/caam/caamhash.c
index 1170bd9..ea31342 100644
--- a/drivers/crypto/caam/caamhash.c
+++ b/drivers/crypto/caam/caamhash.c
@@ -1823,6 +1823,9 @@ static int __init caam_algapi_hash_init(void)
 			return -ENODEV;
 	}
 
+	if (of_device_is_compatible(dev_node,"fsl,sec-v6.0"))
+		return -ENODEV;
+
 	pdev = of_find_device_by_node(dev_node);
 	if (!pdev)
 		return -ENODEV;
diff --git a/drivers/crypto/caam/caampkc.c b/drivers/crypto/caam/caampkc.c
index 5ab745f..e3c76cd 100644
--- a/drivers/crypto/caam/caampkc.c
+++ b/drivers/crypto/caam/caampkc.c
@@ -1412,6 +1412,9 @@ static int __init caam_pkc_init(void)
 			return -ENODEV;
 	}
 
+	if (of_device_is_compatible(dev_node,"fsl,sec-v6.0"))
+		return -ENODEV;
+
 	pdev = of_find_device_by_node(dev_node);
 	if (!pdev)
 		return -ENODEV;
diff --git a/drivers/crypto/caam/caamrng.c b/drivers/crypto/caam/caamrng.c
index 2d25f54..af923ca 100644
--- a/drivers/crypto/caam/caamrng.c
+++ b/drivers/crypto/caam/caamrng.c
@@ -290,6 +290,9 @@ static int __init caam_rng_init(void)
 			return -ENODEV;
 	}
 
+	if (of_device_is_compatible(dev_node,"fsl,sec-v6.0"))
+		return -ENODEV;
+
 	pdev = of_find_device_by_node(dev_node);
 	if (!pdev)
 		return -ENODEV;
diff --git a/drivers/crypto/caam/ctrl.c b/drivers/crypto/caam/ctrl.c
index c85023c..89ccc38 100644
--- a/drivers/crypto/caam/ctrl.c
+++ b/drivers/crypto/caam/ctrl.c
@@ -212,6 +212,11 @@ static int caam_probe(struct platform_device *pdev)
 #endif
 	u64 cha_vid;
 
+	nprop = pdev->dev.of_node;
+
+	if (of_device_is_compatible(nprop, "fsl,sec-v6.0"))
+		return -ENODEV;
+
 	ctrlpriv = kzalloc(sizeof(struct caam_drv_private), GFP_KERNEL);
 	if (!ctrlpriv)
 		return -ENOMEM;
@@ -219,7 +224,6 @@ static int caam_probe(struct platform_device *pdev)
 	dev = &pdev->dev;
 	dev_set_drvdata(dev, ctrlpriv);
 	ctrlpriv->pdev = pdev;
-	nprop = pdev->dev.of_node;
 
 	/* Get configuration properties from device tree */
 	/* First, get register page */
-- 
1.7.5.4

