From 8a83607efb5e363875214d1efd7a91540eb5b6aa Mon Sep 17 00:00:00 2001
From: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Date: Fri, 4 Oct 2013 12:51:22 +0300
Subject: [PATCH 200/383] dpaa_eth: Fix freeing of global buffer pool

In case an error is encountered during probe, don't actually free
the structure containing global buffer pool information unless its
reference count has reached zero.

Signed-off-by: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Change-Id: Ica7b995ecf31a878a9e7685ec905119f1c38f17b
Reviewed-on: http://git.am.freescale.net:8181/5186
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
Reviewed-by: Cristian-Constantin Sovaiala <Cristian.Sovaiala@freescale.com>
Reviewed-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
[Original patch taken from QorIQ-SDK-V1.5-SOURCE-20131219-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 48aabbe..5a8a6e4 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -862,7 +862,8 @@ mac_probe_failed:
 	if (net_dev)
 		free_netdev(net_dev);
 alloc_etherdev_mq_failed:
-	devm_kfree(dev, dpa_bp);
+	if (atomic_read(&dpa_bp->refs) == 0)
+		devm_kfree(dev, dpa_bp);
 
 	return err;
 }
-- 
1.7.5.4

