From 2f9218d9af003cf8706edac7878a7d109d48aaa9 Mon Sep 17 00:00:00 2001
From: Cristian Bercaru <cristian.bercaru@freescale.com>
Date: Mon, 25 Nov 2013 21:17:31 +0000
Subject: [PATCH 328/383] dpaa_eth: proxy: treat error when starting proxy
 port fails

The proxy interface start might fail because of various reasons. In some of
these cases, such as failing to start the mac device, the driver has to stop the
FMan ports.

Signed-off-by: Cristian Bercaru <cristian.bercaru@freescale.com>
Signed-off-by: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
Change-Id: I10e8d494760f9ec31efed9a0716b0306ce68959c
Reviewed-on: http://git.am.freescale.net:8181/6854
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Ruxandra Ioana Radulescu <ruxandra.radulescu@freescale.com>
Reviewed-by: Marian Cristian Rotariu <marian.rotariu@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
[Original patch taken from QorIQ-SDK-V1.5-SOURCE-20131219-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 .../net/ethernet/freescale/dpa/dpaa_eth_proxy.c    |    8 +++++++-
 1 files changed, 7 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
index 1c1a121..5b8af8d 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
@@ -218,10 +218,16 @@ int dpa_proxy_start(struct net_device *net_dev)
 		if (netif_msg_drv(priv))
 			netdev_err(net_dev, "mac_dev->start() = %d\n",
 					_errno);
-		return _errno;
+		goto port_enable_fail;
 	}
 
 	return _errno;
+
+port_enable_fail:
+	for_each_port_device(i, mac_dev->port_dev)
+		fm_port_disable(mac_dev->port_dev[i]);
+
+	return _errno;
 }
 
 int dpa_proxy_stop(struct proxy_device *proxy_dev, struct net_device *net_dev)
-- 
1.7.5.4

