From 502dd7a54590f1e4f695e466f057a4e6a70b93fd Mon Sep 17 00:00:00 2001
From: Mandy Lavi <mandy.lavi@freescale.com>
Date: Wed, 27 Nov 2013 13:07:31 +0200
Subject: [PATCH 375/429] fmd: memac: add tx_fifo_sections register
 initialization

B4/T4 rev2 introduced two new registers in memac block
named: RX_FIFO_SECTIONS and TX_FIFO_SECTIONS
TX_FIFO_SECTIONS[TX_AVAIL] field requires a specific (non default)
init value when working with 10g interface (0x19)

Change-Id: Ic577e24d10031b2f2f1697006a6d5be52db19f4e
Signed-off-by: Mandy Lavi <mandy.lavi@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/6882
Reviewed-by: Haiying Wang <Haiying.Wang@freescale.com>
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
[origin patch is from QorIQ-SDK-V1.5-20131219-yocto]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 .../freescale/fman/Peripherals/FM/MAC/fman_memac.c |   11 ++++++++++-
 .../freescale/fman/inc/flib/fsl_fman_memac.h       |    5 ++++-
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/fman_memac.c b/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/fman_memac.c
index ad0955d..213770a 100644
--- a/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/fman_memac.c
+++ b/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/fman_memac.c
@@ -209,7 +209,16 @@ int fman_memac_init(struct memac_regs *regs,
             tmp |= IF_MODE_RGMII | IF_MODE_RGMII_AUTO;
     }
     iowrite32be(tmp, &regs->if_mode);
-
+    
+    /* from RM: For 10G rate mac tx_fifo_sections[TX_AVAIL] should be 0x19 */
+    if (enet_interface == E_ENET_IF_XGMII || 
+        enet_interface == E_ENET_IF_XFI) {
+        tmp = ioread32be(&regs->tx_fifo_sections);
+        tmp &= 0xffff0000;
+        tmp |= 0x00000019;
+        iowrite32be(tmp, &regs->tx_fifo_sections);
+    }
+    
     /* clear all pending events and set-up interrupts */
     fman_memac_ack_event(regs, 0xffffffff);
     fman_memac_set_exception(regs, exceptions, TRUE);
diff --git a/drivers/net/ethernet/freescale/fman/inc/flib/fsl_fman_memac.h b/drivers/net/ethernet/freescale/fman/inc/flib/fsl_fman_memac.h
index 314463c..b7e4b18 100644
--- a/drivers/net/ethernet/freescale/fman/inc/flib/fsl_fman_memac.h
+++ b/drivers/net/ethernet/freescale/fman/inc/flib/fsl_fman_memac.h
@@ -168,7 +168,10 @@ struct memac_regs {
 	uint32_t command_config;	/* 0x008 Ctrl and cfg */
 	struct mac_addr mac_addr0;	/* 0x00C-0x010 MAC_ADDR_0...1 */
 	uint32_t maxfrm;		/* 0x014 Max frame length */
-	uint32_t res0018[5];
+	uint32_t res0018[1];
+	uint32_t rx_fifo_sections;	/* Receive FIFO configuration reg */
+	uint32_t tx_fifo_sections;	/* Transmit FIFO configuration reg */
+	uint32_t res0024[2];
 	uint32_t hashtable_ctrl;	/* 0x02C Hash table control */
 	uint32_t res0030[4];
 	uint32_t ievent;		/* 0x040 Interrupt event */
-- 
1.7.5.4

