From 423dc39d86792cf9f0d64266a27b06ccdd2d1fc6 Mon Sep 17 00:00:00 2001
From: Andrei Varvara <andrei.varvara@freescale.com>
Date: Thu, 24 Oct 2013 17:22:54 +0300
Subject: [PATCH 302/429] dpa_offload: Updated wrapper with support for
 getting the SEQ number

add two new IOC:
    - DPA_IPSEC_IOC_SA_REQUEST_SEQ_NUMBER
    - DPA_IPSEC_IOC_SA_GET_SEQ_NUMBER

Signed-off-by: Andrei Varvara <andrei.varvara@freescale.com>
Change-Id: I58bcfaac8b651e108d194984225211ed813b490f
Reviewed-on: http://git.am.freescale.net:8181/6039
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Marian-Cornel Chereji <marian.chereji@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
[origin patch is from QorIQ-SDK-V1.5-20131219-yocto]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h |   11 +++++
 drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c   |   42 +++++++++++++++++++++
 2 files changed, 53 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h b/drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h
index b1d5a3d..5bb549b 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h
@@ -211,6 +211,11 @@ struct ioc_dpa_ipsec_sa_modify_prm {
 	struct dpa_ipsec_sa_modify_prm modify_prm;
 };
 
+struct ioc_dpa_ipsec_sa_get_seq_num {
+	int sa_id;	/* security association id */
+	uint64_t seq;	/* where to write the SEQ number */
+};
+
 #ifdef CONFIG_COMPAT
 struct compat_dpa_ipsec_sa_modify_prm {
 	enum dpa_ipsec_sa_modify_type type;
@@ -303,4 +308,10 @@ struct ioc_compat_dpa_ipsec_sa_modify_prm {
 #define DPA_IPSEC_IOC_GET_STATS \
 	_IOR(DPA_IPSEC_IOC_MAGIC, 13, struct dpa_ipsec_stats)
 
+#define DPA_IPSEC_IOC_SA_REQUEST_SEQ_NUMBER \
+	_IOW(DPA_IPSEC_IOC_MAGIC, 14, int)
+
+#define DPA_IPSEC_IOC_SA_GET_SEQ_NUMBER \
+	_IOWR(DPA_IPSEC_IOC_MAGIC, 15, struct ioc_dpa_ipsec_sa_get_seq_num)
+
 #endif	/* __DPA_IPSEC_IOCTL_H */
diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
index 7b8e37a..c5ca467 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
@@ -1351,6 +1351,48 @@ free:
 		}
 		break;
 	}
+
+	case DPA_IPSEC_IOC_SA_REQUEST_SEQ_NUMBER: {
+		int sa_id;
+
+		if (copy_from_user(&sa_id, (int *)args, sizeof(int))) {
+			pr_err("Could not copy SA id\n");
+			return -EINVAL;
+		}
+
+		ret = dpa_ipsec_sa_request_seq_number(sa_id);
+		break;
+	}
+
+	case DPA_IPSEC_IOC_SA_GET_SEQ_NUMBER: {
+		struct ioc_dpa_ipsec_sa_get_seq_num prm;
+
+		if (copy_from_user(&prm,
+				   (struct ioc_dpa_ipsec_sa_get_seq_num *)args,
+				   sizeof(prm))) {
+			pr_err("Could not copy from user stats params\n");
+			return -EINVAL;
+		}
+
+		if (prm.sa_id < 0) {
+			pr_err("Invalid input SA id\n");
+			return -EINVAL;
+		}
+
+		ret = dpa_ipsec_sa_get_seq_number(prm.sa_id, &prm.seq);
+		if (ret < 0) {
+			pr_err("Get SEQ number for SA %d failed\n", prm.sa_id);
+			break;
+		}
+
+		if (copy_to_user((struct ioc_dpa_ipsec_sa_get_seq_num *)args,
+				 &prm, sizeof(prm))) {
+			pr_err("Could not copy SEQ number to user for SA %d\n", prm.sa_id);
+			return -EINVAL;
+		}
+		break;
+	}
+
 	default:
 		pr_err("Invalid DPA IPsec ioctl (0x%x)\n", cmd);
 		ret = -EINVAL;
-- 
1.7.5.4

