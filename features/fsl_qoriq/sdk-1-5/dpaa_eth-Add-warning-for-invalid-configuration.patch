From dfc63e872e674c4b8401b054849f1b459d72a956 Mon Sep 17 00:00:00 2001
From: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Date: Thu, 5 Dec 2013 16:56:19 +0200
Subject: [PATCH 406/429] dpaa_eth: Add warning for invalid configuration

If jumbo frames support is enabled, we must also have
FSL_FM_MAX_FRAME_SIZE set to 9600. Add a note in the description
of the Kconfig option and also issue a warning at boottime if
an invalid combination is detected.

Signed-off-by: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Change-Id: I188739b8c013fb3c5a90dea7b2ce61009a08ace6
Reviewed-on: http://git.am.freescale.net:8181/7102
Reviewed-by: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
Reviewed-by: Cristian-Constantin Sovaiala <Cristian.Sovaiala@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
Tested-by: Richard Schmitt <B43082@freescale.com>
[origin patch is from QorIQ-SDK-V1.5-20131219-yocto]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/Kconfig    |    4 +++-
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c |    9 +++++++++
 2 files changed, 12 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/Kconfig b/drivers/net/ethernet/freescale/dpa/Kconfig
index c09171a..218eca2 100644
--- a/drivers/net/ethernet/freescale/dpa/Kconfig
+++ b/drivers/net/ethernet/freescale/dpa/Kconfig
@@ -33,7 +33,9 @@ config FSL_DPAA_ETH_JUMBO_FRAME
 	---help---
 	  Optimize the DPAA Ethernet driver throughput for large frames
 	  termination traffic (e.g. 4K and above).
-	  NOTE: Using this option in combination with small frames increases
+	  NOTE: This option can only be used if FSL_FM_MAX_FRAME_SIZE
+	  is set to 9600 bytes.
+	  Using this option in combination with small frames increases
 	  significantly the driver's memory footprint and may even deplete
 	  the system memory.
 
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 2e55796..29b59f1 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -838,6 +838,15 @@ dpaa_eth_priv_probe(struct platform_device *_of_dev)
 	 */
 	dpa_bp->size = dpa_bp_size(&buf_layout[RX]);
 
+#ifdef CONFIG_FSL_DPAA_ETH_JUMBO_FRAME
+	/* We only want to use jumbo frame optimization if we actually have
+	 * L2 MAX FRM set for jumbo frames as well.
+	 */
+	if (fm_get_max_frm() < 9600)
+		dev_warn(dev,
+			"Invalid configuration: if jumbo frames support is on, FSL_FM_MAX_FRAME_SIZE should be set to 9600\n");
+#endif
+
 	INIT_LIST_HEAD(&priv->dpa_fq_list);
 
 	memset(&port_fqs, 0, sizeof(port_fqs));
-- 
1.7.5.4

