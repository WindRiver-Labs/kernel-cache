From dcd52f0b9503ce643d23663a6f6e448f831b11d8 Mon Sep 17 00:00:00 2001
From: Yang Wei <Wei.Yang@windriver.com>
Date: Sat, 11 Jan 2014 15:21:55 +0800
Subject: [PATCH 427/429] powerpc/e6500:Refactor erratum A-004801 patch

Since erratum A-004801 already is fixed in e6500 rev2.0,
so we are not neccessary to use tlb_lock/unlock to sync tlb operation.

Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 arch/powerpc/mm/tlb_nohash_low.S |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/mm/tlb_nohash_low.S b/arch/powerpc/mm/tlb_nohash_low.S
index eb88794..485b6d2 100644
--- a/arch/powerpc/mm/tlb_nohash_low.S
+++ b/arch/powerpc/mm/tlb_nohash_low.S
@@ -329,6 +329,11 @@ ALT_MMU_FTR_SECTION_END_IFCLR(MMU_FTR_USE_TLBILX)
 
 #ifdef CONFIG_FSL_ERRATUM_A_004801
 .macro tlb_lock
+    mfspr   r7, SPRN_PVR
+	lis r8, PVR_VER_E6500
+	ori r8, PVR_REV_E6500V1
+	cmpw r7, r8
+	bne 1f
 	ld	r7,PACA_TLB_PER_CORE_PTR(r13)
 	mtocrf	0x01,r7
 	addi	r8,r7,PACA_TLB_LOCK-1 /* -1 to compensate for low bit set */
@@ -349,6 +354,11 @@ ALT_MMU_FTR_SECTION_END_IFCLR(MMU_FTR_USE_TLBILX)
 .endm
 
 .macro tlb_unlock
+    mfspr   r7, SPRN_PVR
+	lis r8, PVR_VER_E6500
+	ori r8, PVR_REV_E6500V1
+	cmpw r7, r8
+	bne 1f
 	mtocrf	0x01,r7
 	bf	31,1f		/* no lock if TLB_PER_CORE_HAS_LOCK clear */
 	li	r9,0
-- 
1.7.5.4

