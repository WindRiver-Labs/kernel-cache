From e6c0ed7f3d5138702c980c5456d37d005ff4ce2e Mon Sep 17 00:00:00 2001
From: Yang Wei <Wei.Yang@windriver.com>
Date: Tue, 21 Jan 2014 17:12:14 +0800
Subject: [PATCH] powerpc64: use right toc section inside execption code of
 PPC64

When executing kernel module, the value of r2 is not equal to kernel toc,
so in order to get the right address of mcheckirq_ctx, dgbirq_ctx and critirq_ctx,
we must save r2 and then retore kernel toc from kernel_toc field of paca structure
before invoking LOAD_REG_ADDR.

Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 arch/powerpc/kernel/exceptions-64e.S |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/exceptions-64e.S b/arch/powerpc/kernel/exceptions-64e.S
index b65f931..e12e5d8 100644
--- a/arch/powerpc/kernel/exceptions-64e.S
+++ b/arch/powerpc/kernel/exceptions-64e.S
@@ -46,7 +46,10 @@
 	bne	1f;					\
 	mfspr	r14,SPRN_PIR;				\
 	slwi	r14,r14,3;				\
+	mr	r15, r2; /* save r2 */				\
+	ld	r2,PACATOC(r13);	/* get kernel TOC into r2 */	    \
 	LOAD_REG_ADDR(r10, level##_STACK_BASE);	\
+	mr	r2, r15;	/* restore TOC into r2 */	    \
 	add	r10,r10,r14;				\
 	ld	r10,0(r10);				\
 	addi	r10,r10,THREAD_SIZE;			\
-- 
1.7.5.4

