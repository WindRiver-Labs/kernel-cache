From 25ba763fc81e0b5d2149ee7acbddf71d3001981f Mon Sep 17 00:00:00 2001
From: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Date: Thu, 8 Aug 2013 16:17:47 +0300
Subject: [PATCH 190/429] dpaa_eth: Replace drain callback in dpa_bp structure

Instead use a callback for freeing individual buffers acquired from
the pool. This solution is more flexible and allows for simpler code
when new pools will be added to the driver.

Signed-off-by: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Change-Id: I52376b5dab53957e497b112df7c42ef18d7a9347
Reviewed-on: http://git.am.freescale.net:8181/4190
Reviewed-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/4467
Reviewed-by: Sovaiala Cristian-Constantin-B39531 <Cristian.Sovaiala@freescale.com>
[origin patch is from QorIQ-SDK-V1.5-20131219-yocto]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c      |    4 +++-
 drivers/net/ethernet/freescale/dpa/dpaa_eth.h      |   10 ++++++----
 .../net/ethernet/freescale/dpa/dpaa_eth_common.c   |   10 +++++++---
 .../ethernet/freescale/dpa/dpaa_eth_unit_test.c    |    2 +-
 4 files changed, 17 insertions(+), 9 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 3ecff91..efbb9c3 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -639,10 +639,12 @@ dpa_priv_bp_probe(struct device *dev)
 
 	dpa_bp->percpu_count = alloc_percpu(*dpa_bp->percpu_count);
 	dpa_bp->target_count = CONFIG_FSL_DPAA_ETH_MAX_BUF_COUNT;
-	dpa_bp->drain_cb = dpa_bp_drain;
 
 #ifdef CONFIG_FSL_DPAA_ETH_SG_SUPPORT
 	dpa_bp->seed_cb = dpa_bp_priv_seed;
+	dpa_bp->free_buf_cb = _dpa_bp_free_pf;
+#else
+	dpa_bp->free_buf_cb = _dpa_bp_free_skb;
 #endif /* CONFIG_FSL_DPAA_ETH_SG_SUPPORT */
 
 	return dpa_bp;
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.h b/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
index a677af2..4395e98 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
@@ -366,8 +366,10 @@ struct dpa_bp {
 	atomic_t refs;
 	/* some bpools need to be seeded before use by this cb */
 	int (*seed_cb)(struct dpa_bp *);
-	/* some bpools need to be emptied before freeing by this cb */
-	void (*drain_cb)(struct dpa_bp *);
+	/* some bpools need to be emptied before freeing; this cb is used
+	 * for freeing of individual buffers taken from the pool
+	 */
+	void (*free_buf_cb)(void *addr);
 };
 
 struct dpa_rx_errors {
@@ -703,7 +705,7 @@ void dpa_bp_default_buf_size_update(uint32_t size);
 uint32_t dpa_bp_default_buf_size_get(void);
 void dpa_bp_priv_non_sg_seed(struct dpa_bp *dpa_bp);
 
-static inline void _dpa_bp_free_buf(void *addr)
+static inline void _dpa_bp_free_skb(void *addr)
 {
 	struct sk_buff **skbh = addr;
 	struct sk_buff *skb;
@@ -712,7 +714,7 @@ static inline void _dpa_bp_free_buf(void *addr)
 	dev_kfree_skb_any(skb);
 }
 #else
-static inline void _dpa_bp_free_buf(void *addr)
+static inline void _dpa_bp_free_pf(void *addr)
 {
 	put_page(virt_to_head_page(addr));
 }
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.c
index 55c3db7..35046fd 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.c
@@ -720,7 +720,7 @@ void dpa_bp_drain(struct dpa_bp *bp)
 			dma_unmap_single(bp->dev, addr, bp->size,
 					DMA_BIDIRECTIONAL);
 
-			_dpa_bp_free_buf(phys_to_virt(addr));
+			bp->free_buf_cb(phys_to_virt(addr));
 		}
 	} while (num == 8);
 }
@@ -733,11 +733,15 @@ _dpa_bp_free(struct dpa_bp *dpa_bp)
 	if (!atomic_dec_and_test(&bp->refs))
 		return;
 
-	if (bp->drain_cb)
-		bp->drain_cb(bp);
+	if (bp->free_buf_cb)
+		dpa_bp_drain(bp);
 
 	dpa_bp_array[bp->bpid] = 0;
 	bman_free_pool(bp->pool);
+
+    if (bp->dev)
+		platform_device_unregister(to_platform_device(bp->dev));
+
 }
 
 void __cold __attribute__((nonnull))
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_unit_test.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_unit_test.c
index c831ee1..106887a 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_unit_test.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_unit_test.c
@@ -364,7 +364,7 @@ void dpa_unit_test_drain_default_pool(struct net_device *net_dev)
 					default_pool->size,
 					DMA_BIDIRECTIONAL);
 
-			_dpa_bp_free_buf(phys_to_virt(addr));
+			default_pool->free_buf_cb(phys_to_virt(addr));
 		}
 	} while (num == 8);
 
-- 
1.7.5.4

