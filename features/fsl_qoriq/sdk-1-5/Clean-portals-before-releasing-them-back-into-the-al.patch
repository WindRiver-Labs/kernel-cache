From 0eb9070fa8ece810e6b6595fc5611c211c491a10 Mon Sep 17 00:00:00 2001
From: Roy Pledge <Roy.Pledge@freescale.com>
Date: Tue, 29 Oct 2013 10:06:44 -0400
Subject: [PATCH 358/429] Clean portals before releasing them back into the
 alloctor

During USDPAA cleanup ERNs may be produced to any portal the process was using.
The cleanup code will service those portals until the FQs reach the retired state.
This patch makes sure the portals are reinitialize to a clean state before returning
them to the allocation pool

Signed-off-by: Roy Pledge <Roy.Pledge@freescale.com>
Change-Id: Ib4589b816d3259682f16ebacb5932194bc85e053
Reviewed-on: http://git.am.freescale.net:8181/6769
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Haiying Wang <Haiying.Wang@freescale.com>
Reviewed-by: Geoff Thorpe <Geoff.Thorpe@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
[origin patch is from QorIQ-SDK-V1.5-20131219-yocto]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/staging/fsl_qbman/fsl_usdpaa.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_qbman/fsl_usdpaa.c b/drivers/staging/fsl_qbman/fsl_usdpaa.c
index a427b6a..35171e9 100644
--- a/drivers/staging/fsl_qbman/fsl_usdpaa.c
+++ b/drivers/staging/fsl_qbman/fsl_usdpaa.c
@@ -580,8 +580,12 @@ static int usdpaa_release(struct inode *inode, struct file *filp)
 	list_for_each_entry_safe(portal, tmpportal, &ctx->portals, list) {
 		if (portal->user.type == usdpaa_portal_qman) {
 			/* Give the portal back to the allocator */
+			init_qm_portal(portal->qportal,
+				       &portal->qman_portal_low);
 			qm_put_unused_portal(portal->qportal);
 		} else {
+			init_bm_portal(portal->bportal,
+				       &portal->bman_portal_low);
 			bm_put_unused_portal(portal->bportal);
 		}
 		list_del(&portal->list);
-- 
1.7.5.4

