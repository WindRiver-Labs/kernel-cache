From d6fa8f96382fa9dd8a77056b3bc83b9af8d0ff78 Mon Sep 17 00:00:00 2001
From: Bin Jiang <bin.jiang@windriver.com>
Date: Tue, 18 Feb 2014 15:17:09 +0800
Subject: [PATCH] uio: align uio memory region

The uio memory region should be at page boundaries in order for
user mmap() to work. The region size is rounded to a multiple of
PAGE_SIZE.

Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/uio/uio.c |   18 ++++++++++++++++++
 1 files changed, 18 insertions(+), 0 deletions(-)

diff --git a/drivers/uio/uio.c b/drivers/uio/uio.c
index c6efb75..99e34f0 100644
--- a/drivers/uio/uio.c
+++ b/drivers/uio/uio.c
@@ -805,6 +805,22 @@ static void release_uio_class(void)
 	uio_major_cleanup();
 }
 
+static void uio_mem_region_align(struct uio_info *info)
+{
+	int mi;
+	struct uio_mem *mem;
+
+	for (mi = 0; mi < MAX_UIO_MAPS; mi++) {
+		mem = &info->mem[mi];
+		if (mem->size == 0)
+			break;
+		if (mem->memtype == UIO_MEM_PHYS) {
+			mem->addr = mem->addr & PAGE_MASK;
+			mem->size = PAGE_ALIGN(mem->size);
+		}
+	}
+}
+
 /**
  * uio_register_device - register a new userspace IO device
  * @owner:	module that creates the new device
@@ -823,6 +839,8 @@ int __uio_register_device(struct module *owner,
 	if (!parent || !info || !info->name || !info->version)
 		return -EINVAL;
 
+	uio_mem_region_align(info);
+
 	info->uio_dev = NULL;
 
 	idev = kzalloc(sizeof(*idev), GFP_KERNEL);
-- 
1.7.5.4

