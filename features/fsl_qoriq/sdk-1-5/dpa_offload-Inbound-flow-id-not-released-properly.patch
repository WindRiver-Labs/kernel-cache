From 4c0049d856b17867ce00a5a65ea91629907faacf Mon Sep 17 00:00:00 2001
From: Andrei Varvara <andrei.varvara@freescale.com>
Date: Mon, 25 Nov 2013 18:07:36 +0200
Subject: [PATCH 325/383] dpa_offload: Inbound flow id not released properly

unfortunately the fix I have done regarding the
release of inbound flow ID was not good enought.

Signed-off-by: Andrei Varvara <andrei.varvara@freescale.com>
Change-Id: I2aa02c83ff0476c1c1f961041e4871aec150a616
Reviewed-on: http://git.am.freescale.net:8181/6846
Reviewed-by: Marian-Cornel Chereji <marian.chereji@freescale.com>
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
[Original patch taken from QorIQ-SDK-V1.5-SOURCE-20131219-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index 739fe89..84a4497 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -3131,15 +3131,18 @@ static int put_sa(struct dpa_ipsec_sa *sa)
 
 	/* Release the flow ID - only for inbound SAs */
 	if (sa_is_inbound(sa) && !ignore_post_ipsec_action(dpa_ipsec) &&
-	    sa->inbound_flowid != INVALID_INB_FLOW_ID) {
+	    sa->inbound_flowid != INVALID_INB_FLOW_ID && !sa_is_parent(sa)) {
 		err = put_inbound_flowid(dpa_ipsec, sa->inbound_flowid);
 		if (err < 0) {
 			log_err("Could not put flow id in circular queue.\n");
+			mutex_unlock(&dpa_ipsec->lock);
 			return err;
 		}
 		sa->inbound_flowid = INVALID_INB_FLOW_ID;
 	}
 
+	sa->child_sa = NULL;
+
 	/* Mark as free index in used SA IDs vector of this DPA IPSEC instance*/
 	dpa_ipsec->used_sa_ids[sa->used_sa_index] = DPA_OFFLD_INVALID_OBJECT_ID;
 	dpa_ipsec->num_used_sas--;
@@ -3579,7 +3582,6 @@ static int remove_inbound_sa(struct dpa_ipsec_sa *sa)
 		mutex_lock(&sa->dpa_ipsec->sa_mng.sa_rekeying_headlist_lock);
 
 		child_sa->parent_sa = NULL;
-		sa->child_sa = NULL;
 
 		/* Remove the child SA from rekeying list */
 		if (child_sa->sa_rekeying_node.next != LIST_POISON1 &&
-- 
1.7.5.4

