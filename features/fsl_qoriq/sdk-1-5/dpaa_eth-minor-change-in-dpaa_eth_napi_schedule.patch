From a8f6a4030a9719860d5c09a11057f8185910ddd8 Mon Sep 17 00:00:00 2001
From: Yang Wei <Wei.Yang@windriver.com>
Date: Fri, 27 Dec 2013 16:41:43 +0800
Subject: [PATCH 105/429] dpaa_eth: minor change in dpaa_eth_napi_schedule()

Moved counter increment in inline function.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
Change-Id: Iee1981c67f0b3daed65276cd3a3addf74c91e264
Reviewed-on: http://git.am.freescale.net:8181/3658
Reviewed-by: Hamciuc Bogdan-BHAMCIU1 <bogdan.hamciuc@freescale.com>
Reviewed-by: Radulescu Ruxandra Ioana-B05472 <ruxandra.radulescu@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[origin patch is from QorIQ-SDK-V1.5-20131219-yocto]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c |   17 +++++------------
 drivers/net/ethernet/freescale/dpa/dpaa_eth.h |    1 +
 2 files changed, 6 insertions(+), 12 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 6bb81e6e..348b484 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -349,10 +349,8 @@ priv_rx_error_dqrr(struct qman_portal		*portal,
 
 	percpu_priv = per_cpu_ptr(priv->percpu_priv, smp_processor_id());
 
-	if (dpaa_eth_napi_schedule(percpu_priv)) {
-		percpu_priv->in_interrupt++;
+	if (dpaa_eth_napi_schedule(percpu_priv))
 		return qman_cb_dqrr_stop;
-	}
 
 	if (unlikely(dpaa_eth_refill_bpools(percpu_priv)))
 		/* Unable to refill the buffer pool due to insufficient
@@ -384,10 +382,8 @@ priv_rx_default_dqrr(struct qman_portal		*portal,
 	/* IRQ handler, non-migratable; safe to use __this_cpu_ptr here */
 	percpu_priv = __this_cpu_ptr(priv->percpu_priv);
 
-	if (unlikely(dpaa_eth_napi_schedule(percpu_priv))) {
-		percpu_priv->in_interrupt++;
+	if (unlikely(dpaa_eth_napi_schedule(percpu_priv)))
 		return qman_cb_dqrr_stop;
-	}
 
 	/* Vale of plenty: make sure we didn't run out of buffers */
 
@@ -417,10 +413,8 @@ priv_tx_conf_error_dqrr(struct qman_portal		*portal,
 
 	percpu_priv = per_cpu_ptr(priv->percpu_priv, smp_processor_id());
 
-	if (dpaa_eth_napi_schedule(percpu_priv)) {
-		percpu_priv->in_interrupt++;
+	if (dpaa_eth_napi_schedule(percpu_priv))
 		return qman_cb_dqrr_stop;
-	}
 
 	_dpa_tx_error(net_dev, priv, percpu_priv, &dq->fd, fq->fqid);
 
@@ -445,10 +439,9 @@ priv_tx_conf_default_dqrr(struct qman_portal		*portal,
 
 	/* Non-migratable context, safe to use __this_cpu_ptr */
 	percpu_priv = __this_cpu_ptr(priv->percpu_priv);
-	if (dpaa_eth_napi_schedule(percpu_priv)) {
-		percpu_priv->in_interrupt++;
+
+	if (dpaa_eth_napi_schedule(percpu_priv))
 		return qman_cb_dqrr_stop;
-	}
 
 	_dpa_tx_conf(net_dev, priv, percpu_priv, &dq->fd, fq->fqid);
 
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.h b/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
index 987c3b9..fed4109 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
@@ -521,6 +521,7 @@ static inline int dpaa_eth_napi_schedule(struct dpa_percpu_priv_s *percpu_priv)
 		int ret = qman_irqsource_remove(QM_PIRQ_DQRI);
 		if (likely(!ret)) {
 			napi_schedule(&percpu_priv->napi);
+			percpu_priv->in_interrupt++;
 			return 1;
 		}
 	}
-- 
1.7.5.4

