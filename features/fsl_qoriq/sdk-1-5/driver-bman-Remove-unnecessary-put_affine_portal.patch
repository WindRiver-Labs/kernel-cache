From b6e2498b718372ac5ed69af81a839b2418a77912 Mon Sep 17 00:00:00 2001
From: Yang Wei <Wei.Yang@windriver.com>
Date: Thu, 16 Jan 2014 14:56:10 +0800
Subject: [PATCH 2/2] driver/bman:Remove unnecessary put_affine_portal

When specifying "bportals" variable to kernel commandline,
the following call trace happens.

WARNING: at kernel/sched/core.c:3300
Modules linked in:
NIP: c000000000a1151c LR: c000000000a11500 CTR: c000000000025b20
REGS: c00000017956b740 TRAP: 0700   Not tainted
(3.4.43-grsec-WR5.0.1.0_cgl)
MSR: 0000000080029000 <CE,EE,ME>  CR: 28044022  XER: 20000000 SOFTE: 1
TASK = c000000179560000[1] 'swapper/0' THREAD: c000000179568000 CPU: 0
GPR00: 0000000000000000 c00000017956b9c0 c000000000f24970 0000000000000001
GPR04: 0000000000000000 0000000000000000 0000000000000005 000000000001ffff
GPR08: 0000000000000000 c000000001054d00 c0000000011008c8 0000000000000001
GPR12: 0000000024044042 c00000000fffa000 00000000ffffffff 000000007ffb0b14
GPR16: 0000000000000000 c000000003fdf168 c000000177035440 0000000000000100
GPR20: 0000000000000200 0000000000000008 0000000000000003 0000000000000012
GPR24: 0000000000000019 c00000017956bb98 c0000001770354c0 00000000ffffff01
GPR28: 0000000000000000 c000000179568000 c000000000e41528 0000000000000001
NIP [c000000000a1151c] .sub_preempt_count+0xec/0x110
LR [c000000000a11500] .sub_preempt_count+0xd0/0x110
Call Trace:
[c00000017956b9c0] [c000000000a17c90] .printk+0x11c/0x144 (unreliable)
[c00000017956ba60] [c000000000867f1c] .bman_create_affine_slave+0x7c/0xd0
[c00000017956baf0] [c000000000c8c88c] .bman_init+0x9f8/0xb48
[c00000017956bc30] [c000000000c8b6f8] .qbman_init+0x2c/0x1b8
[c00000017956bd90] [c000000000001498] .do_one_initcall+0x68/0x200
[c00000017956be50] [c000000000c59c20] .kernel_init+0x1a8/0x28c
[c00000017956bf90] [c000000000018f80] .original_kernel_thread+0x54/0x70

Since a SDK1.5's patch(fsl_bman: add cpu hotplug support) uses per_cpu
API instead of get_raw_affine_portal inside bman_create_affine_slave
function, so accordingly, put_affine_portal also should be removed.

Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/staging/fsl_qbman/bman_high.c |    1 -
 1 files changed, 0 insertions(+), 1 deletions(-)

diff --git a/drivers/staging/fsl_qbman/bman_high.c b/drivers/staging/fsl_qbman/bman_high.c
index 1ed408e..2e97c2b 100644
--- a/drivers/staging/fsl_qbman/bman_high.c
+++ b/drivers/staging/fsl_qbman/bman_high.c
@@ -325,7 +325,6 @@ struct bman_portal *bman_create_affine_slave(struct bman_portal *redirect,
 	BUG_ON(!redirect->config->public_cfg.is_shared);
 	p->irq_sources = 0;
 	p->sharing_redirect = redirect;
-	put_affine_portal();
 	return p;
 #else
 	BUG();
-- 
1.7.5.4

