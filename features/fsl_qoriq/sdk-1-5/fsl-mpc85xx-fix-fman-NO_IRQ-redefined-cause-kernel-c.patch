From 7545a15b8388f47181058e9aba9a17e9057feb00 Mon Sep 17 00:00:00 2001
From: Wang Dongsheng <dongsheng.wang@freescale.com>
Date: Wed, 4 Dec 2013 13:25:03 +0800
Subject: [PATCH 355/383] fsl/mpc85xx: fix fman NO_IRQ redefined cause kernel
 crash while booting

The issue is caused by the definition of NO_IRQ.
The fman driver redefined NO_IRQ in fman/inc/ncsw_ext.h. fm.c first include
ncsw_ext.h then include asm/mpc85xx.h, the asm/mpc85xx.h replace NO_IRQ
value to 0. But p_Fm->p_FmStateStruct->irq value get from ConfigureFmDev(),
at lnxwrp_fm.c the NO_IRQ is -1.

So remove include the linux standard header file in asm/mpc85xx.h as a workaround.

Signed-off-by: Wang Dongsheng <dongsheng.wang@freescale.com>
Change-Id: I89f760224cc1412bfefc0cecdbfa5a2b32b0ea94
Reviewed-on: http://git.am.freescale.net:8181/7050
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Tiefei Zang <roy.zang@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
[Original patch taken from QorIQ-SDK-V1.5-SOURCE-20131219-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/include/asm/mpc85xx.h |    5 -----
 arch/powerpc/sysdev/fsl_pci.c      |    1 +
 arch/powerpc/sysdev/fsl_pmc.c      |    2 +-
 arch/powerpc/sysdev/fsl_rcpm.c     |    2 +-
 include/linux/fsl_devices.h        |    3 +++
 5 files changed, 6 insertions(+), 7 deletions(-)

diff --git a/arch/powerpc/include/asm/mpc85xx.h b/arch/powerpc/include/asm/mpc85xx.h
index 43dd184..f3b24f3 100644
--- a/arch/powerpc/include/asm/mpc85xx.h
+++ b/arch/powerpc/include/asm/mpc85xx.h
@@ -9,7 +9,6 @@
  * (at your option) any later version.
  */
 
-#include <linux/suspend.h>
 
 #ifndef __ASM_PPC_MPC85XX_H
 #define __ASM_PPC_MPC85XX_H
@@ -91,9 +90,5 @@
 
 #define SVR_Unknown	0xFFFFFF
 
-#ifndef __ASSEMBLY__
-extern void set_pm_suspend_state(suspend_state_t state);
-extern suspend_state_t pm_suspend_state(void);
-#endif
 
 #endif
diff --git a/arch/powerpc/sysdev/fsl_pci.c b/arch/powerpc/sysdev/fsl_pci.c
index 0bf96b4..4b346fb 100644
--- a/arch/powerpc/sysdev/fsl_pci.c
+++ b/arch/powerpc/sysdev/fsl_pci.c
@@ -17,6 +17,7 @@
  * Free Software Foundation;  either version 2 of the  License, or (at your
  * option) any later version.
  */
+#include <linux/fsl_devices.h>
 #include <linux/kernel.h>
 #include <linux/pci.h>
 #include <linux/delay.h>
diff --git a/arch/powerpc/sysdev/fsl_pmc.c b/arch/powerpc/sysdev/fsl_pmc.c
index e8bc4db..778cf6f 100644
--- a/arch/powerpc/sysdev/fsl_pmc.c
+++ b/arch/powerpc/sysdev/fsl_pmc.c
@@ -16,6 +16,7 @@
 #include <linux/types.h>
 #include <linux/errno.h>
 #include <linux/export.h>
+#include <linux/fsl_devices.h>
 #include <linux/suspend.h>
 #include <linux/delay.h>
 #include <linux/device.h>
@@ -24,7 +25,6 @@
 
 #include <asm/switch_to.h>
 #include <asm/cacheflush.h>
-#include <asm/mpc85xx.h>
 
 #include <sysdev/fsl_soc.h>
 
diff --git a/arch/powerpc/sysdev/fsl_rcpm.c b/arch/powerpc/sysdev/fsl_rcpm.c
index 9382923..eec51ea 100644
--- a/arch/powerpc/sysdev/fsl_rcpm.c
+++ b/arch/powerpc/sysdev/fsl_rcpm.c
@@ -10,6 +10,7 @@
  */
 #include <linux/types.h>
 #include <linux/errno.h>
+#include <linux/fsl_devices.h>
 #include <linux/suspend.h>
 #include <linux/device.h>
 #include <linux/delay.h>
@@ -19,7 +20,6 @@
 #include <asm/io.h>
 #include <asm/cacheflush.h>
 #include <asm/fsl_guts.h>
-#include <asm/mpc85xx.h>
 
 struct ccsr_rcpm __iomem *rcpm1_regs;
 struct ccsr_rcpm_v2 __iomem *rcpm2_regs;
diff --git a/include/linux/fsl_devices.h b/include/linux/fsl_devices.h
index a522715..924c7df 100644
--- a/include/linux/fsl_devices.h
+++ b/include/linux/fsl_devices.h
@@ -27,6 +27,7 @@
 #define FSL_USB_VER_2_5		4
 
 #include <linux/types.h>
+#include <linux/suspend.h>
 
 /*
  * Some conventions on how we handle peripherals on Freescale chips
@@ -147,4 +148,6 @@ int fsl_deep_sleep(void);
 static inline int fsl_deep_sleep(void) { return 0; }
 #endif
 
+extern void set_pm_suspend_state(suspend_state_t state);
+extern suspend_state_t pm_suspend_state(void);
 #endif /* _FSL_DEVICE_H_ */
-- 
1.7.5.4

