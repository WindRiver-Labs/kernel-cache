From 7f741cfd32e8b9fd9702edc16d7b9c11a7cb3681 Mon Sep 17 00:00:00 2001
From: Bharat Bhushan <Bharat.Bhushan@freescale.com>
Date: Wed, 17 Apr 2013 10:33:43 +0530
Subject: [PATCH 145/429] Fix geometry configured status check

Checking dma_domain->win_cnt is not sufficient to conclude that
geometry it set.
Either it should check dma_domain->geom_size also or it should
check dma_domain->win_arr as this is allocated when geometry is set.

We are using dma_domain->win_arr pointer check in this patch.

Signed-off-by: Bharat Bhushan <bharat.bhushan@freescale.com>
Change-Id: I67418215ca6e9f495ec80d90a77a15a9cb766d90
Reviewed-on: http://git.am.freescale.net:8181/1487
Reviewed-by: Yoder Stuart-B08248 <stuart.yoder@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[origin patch is from QorIQ-SDK-V1.5-20131219-yocto]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/iommu/fsl_pamu_domain.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/iommu/fsl_pamu_domain.c b/drivers/iommu/fsl_pamu_domain.c
index 68610b6..f85da57 100644
--- a/drivers/iommu/fsl_pamu_domain.c
+++ b/drivers/iommu/fsl_pamu_domain.c
@@ -660,7 +660,7 @@ static int handle_attach_device(struct fsl_dma_domain *dma_domain,
 		 * for the domain. If yes, set the geometry for
 		 * the LIODN.
 		 */
-		if (dma_domain->win_cnt) {
+		if (dma_domain->win_arr) {
 			u32 win_cnt = dma_domain->win_cnt > 1 ? dma_domain->win_cnt : 0;
 			ret = pamu_set_liodn(liodn[i], dev, dma_domain,
 					      &domain->geometry,
-- 
1.7.5.4

