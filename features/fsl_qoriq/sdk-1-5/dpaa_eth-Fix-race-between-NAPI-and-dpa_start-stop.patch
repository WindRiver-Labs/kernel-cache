From 218e77c6b82df339b03d36df0c278d140368a0a4 Mon Sep 17 00:00:00 2001
From: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
Date: Mon, 25 Nov 2013 12:57:03 +0200
Subject: [PATCH 366/429] dpaa_eth: Fix race between NAPI and dpa_start/stop

While bringing the interface down, between dpa_stop() and napi_disable()
there might be frames still in the ingress (Rx, TxConfirm) queues.
This is only possible under high load, when ksoftirqd is running; in
such cases, though, we must allow for the ingress queues to drain before
we bring NAPI down, lest we permanently deplete our buffer pools and
freeze the interface.

Signed-off-by: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
Signed-off-by: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Change-Id: Ic0900da89824ee3b64a316ed2e863982c3bc2461
Reviewed-on: http://git.am.freescale.net:8181/6852
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Cristian-Constantin Sovaiala <Cristian.Sovaiala@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
[origin patch is from QorIQ-SDK-V1.5-20131219-yocto]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index e47c6d7..aa56230 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -529,6 +529,12 @@ static int __cold dpa_eth_priv_stop(struct net_device *net_dev)
 	struct dpa_priv_s *priv;
 
 	_errno = dpa_stop(net_dev);
+	/* Allow NAPI to consume any frame still in the Rx/TxConfirm
+	 * ingress queues. This is to avoid a race between the current
+	 * context and ksoftirqd which could leave NAPI disabled while
+	 * in fact there's still Rx traffic to be processed.
+	 */
+	usleep_range(5000, 10000);
 
 	priv = netdev_priv(net_dev);
 	dpaa_eth_napi_disable(priv);
-- 
1.7.5.4

