From 1fee40bb9fbb6f173a43a5ad85b563671f97fca7 Mon Sep 17 00:00:00 2001
From: Haiying Wang <Haiying.Wang@freescale.com>
Date: Tue, 15 Oct 2013 11:57:01 -0400
Subject: [PATCH 265/429] fsl_qman: confirm num_ceetms in qman_init

Signed-off-by: Haiying Wang <Haiying.Wang@freescale.com>
Change-Id: Ieff662d29203e37813ba9553e750e2777fc25591
Reviewed-on: http://git.am.freescale.net:8181/5631
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Thorpe Geoff-R01361 <Geoff.Thorpe@freescale.com>
Reviewed-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
[origin patch is from QorIQ-SDK-V1.5-20131219-yocto]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/staging/fsl_qbman/qman_driver.c |   11 +++++++++--
 1 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_qbman/qman_driver.c b/drivers/staging/fsl_qbman/qman_driver.c
index 72577ad..4f94e41 100644
--- a/drivers/staging/fsl_qbman/qman_driver.c
+++ b/drivers/staging/fsl_qbman/qman_driver.c
@@ -719,6 +719,15 @@ __init int qman_init(void)
 		qm_channel_pme = QMAN_CHANNEL_PME_REV3;
 	}
 
+	/*
+	 * Parse the ceetm node to get how many ceetm instances are supported
+	 * on the current silicon. num_ceetms must be confirmed before portals
+	 * are intiailized.
+	 */
+	num_ceetms = 0;
+	for_each_compatible_node(dn, NULL, "fsl,qman-ceetm")
+		num_ceetms++;
+
 	/* Parse pool channels into the SDQCR mask. (Must happen before portals
 	 * are initialised.) */
 	for_each_compatible_node(dn, NULL, "fsl,pool-channel-range") {
@@ -839,10 +848,8 @@ __init int qman_resource_init(void)
 	}
 
 	/* Parse CEETM */
-	num_ceetms = 0;
 	for_each_compatible_node(dn, NULL, "fsl,qman-ceetm") {
 		ret = fsl_ceetm_init(dn);
-		num_ceetms++;
 		if (ret)
 			return ret;
 	}
-- 
1.7.5.4

