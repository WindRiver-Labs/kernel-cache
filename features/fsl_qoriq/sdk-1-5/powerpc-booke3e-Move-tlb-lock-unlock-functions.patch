From a06ead016d62213ecf8e9a49c9decaf1b3ffafb3 Mon Sep 17 00:00:00 2001
From: Mihai Caraman <mihai.caraman@freescale.com>
Date: Sat, 2 Nov 2013 00:36:24 +0200
Subject: [PATCH 324/429] powerpc/booke3e: Move tlb lock/unlock functions

Move book3e_tlb_lock/unlock functions from hugetlbpages to mm to be
used from other kernel places.

Signed-off-by: Mihai Caraman <mihai.caraman@freescale.com>
Change-Id: Ibb941e4af5444ba99fcb3dcc20e331c850c8ba9f
Reviewed-on: http://git.am.freescale.net:8181/6225
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Scott Wood <scottwood@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
[origin patch is from QorIQ-SDK-V1.5-20131219-yocto]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 arch/powerpc/include/asm/mmu-book3e.h |    9 ++++++
 arch/powerpc/mm/fsl_booke_mmu.c       |   41 ++++++++++++++++++++++++++
 arch/powerpc/mm/hugetlbpage-book3e.c  |   51 ---------------------------------
 3 files changed, 50 insertions(+), 51 deletions(-)

diff --git a/arch/powerpc/include/asm/mmu-book3e.h b/arch/powerpc/include/asm/mmu-book3e.h
index eeabcdb..b4818b4 100644
--- a/arch/powerpc/include/asm/mmu-book3e.h
+++ b/arch/powerpc/include/asm/mmu-book3e.h
@@ -273,6 +273,15 @@ extern unsigned long linear_map_top;
  * return 1, indicating that the tlb requires preloading.
  */
 #define HUGETLB_NEED_PRELOAD
+
+void book3e_tlb_lock(void);
+void book3e_tlb_unlock(void);
+#else
+static inline void book3e_tlb_lock(void)
+{}
+
+static inline void book3e_tlb_unlock(void)
+{}
 #endif
 
 #endif /* !__ASSEMBLY__ */
diff --git a/arch/powerpc/mm/fsl_booke_mmu.c b/arch/powerpc/mm/fsl_booke_mmu.c
index 95c6ede..9b04663 100644
--- a/arch/powerpc/mm/fsl_booke_mmu.c
+++ b/arch/powerpc/mm/fsl_booke_mmu.c
@@ -250,3 +250,44 @@ void setup_initial_memory_limit(phys_addr_t first_memblock_base,
 	memblock_set_current_limit(min_t(u64, limit, 0x04000000));
 }
 #endif
+
+#if defined(CONFIG_PPC64)
+void book3e_tlb_lock(void)
+{
+	struct paca_struct *paca = get_paca();
+	struct tlb_per_core *percore;
+	unsigned long tmp;
+
+	if (!(paca->tlb_per_core_ptr & 1))
+		return;
+
+	percore = (struct tlb_per_core *)(paca->tlb_per_core_ptr & ~1UL);
+
+	asm volatile("1: lbarx %0, 0, %1;"
+		     "cmpdi %0, 0;"
+		     "bne 2f;"
+		     "li %0, 1;"
+		     "stbcx. %0, 0, %1;"
+		     "bne 1b;"
+		     "b 3f;"
+		     "2: lbzx %0, 0, %1;"
+		     "cmpdi %0, 0;"
+		     "bne 2b;"
+		     "b 1b;"
+		     "3:" : "=&r" (tmp) : "r" (&percore->lock) : "memory");
+}
+
+void book3e_tlb_unlock(void)
+{
+	struct paca_struct *paca = get_paca();
+	struct tlb_per_core *percore;
+
+	if (!(paca->tlb_per_core_ptr & 1))
+		return;
+
+	percore = (struct tlb_per_core *)(paca->tlb_per_core_ptr & ~1UL);
+
+	isync();
+	percore->lock = 0;
+}
+#endif
diff --git a/arch/powerpc/mm/hugetlbpage-book3e.c b/arch/powerpc/mm/hugetlbpage-book3e.c
index aa871f4..191cd3f 100644
--- a/arch/powerpc/mm/hugetlbpage-book3e.c
+++ b/arch/powerpc/mm/hugetlbpage-book3e.c
@@ -13,57 +13,6 @@ static inline int mmu_get_tsize(int psize)
 	return mmu_psize_defs[psize].enc;
 }
 
-#if defined(CONFIG_PPC_FSL_BOOK3E) && defined(CONFIG_PPC64)
-#include <asm/paca.h>
-
-static inline void book3e_tlb_lock(void)
-{
-	struct paca_struct *paca = get_paca();
-	struct tlb_per_core *percore;
-	unsigned long tmp;
-
-	if (!(paca->tlb_per_core_ptr & 1))
-		return;
-
-	percore = (struct tlb_per_core *)(paca->tlb_per_core_ptr & ~1UL);
-
-	asm volatile("1: lbarx %0, 0, %1;"
-		     "cmpdi %0, 0;"
-		     "bne 2f;"
-		     "li %0, 1;"
-		     "stbcx. %0, 0, %1;"
-		     "bne 1b;"
-		     "b 3f;"
-		     "2: lbzx %0, 0, %1;"
-		     "cmpdi %0, 0;"
-		     "bne 2b;"
-		     "b 1b;"
-		     "3:" : "=&r" (tmp) : "r" (&percore->lock) : "memory");
-}
-
-static inline void book3e_tlb_unlock(void)
-{
-	struct paca_struct *paca = get_paca();
-	struct tlb_per_core *percore;
-
-	if (!(paca->tlb_per_core_ptr & 1))
-		return;
-
-	percore = (struct tlb_per_core *)(paca->tlb_per_core_ptr & ~1UL);
-
-	isync();
-	percore->lock = 0;
-}
-#else
-static inline void book3e_tlb_lock(void)
-{
-}
-
-static inline void book3e_tlb_unlock(void)
-{
-}
-#endif
-
 #ifdef CONFIG_PPC_FSL_BOOK3E
 #ifdef CONFIG_PPC64
 static inline int tlb1_next(void)
-- 
1.7.5.4

