From 647e76d55f6df1376e365f3f7006b4229fa5cb68 Mon Sep 17 00:00:00 2001
From: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Date: Thu, 5 Dec 2013 13:50:03 +0200
Subject: [PATCH 363/383] fmd: Fix resource algorithm for jumbo frames

The algorithm does not allocate enough FIFO buffers for 1G Rx ports
to accomodate max size jumbo frames.

Try to fix this by taking into account not the L2 maximum frame, but
the maximum BMan pool buffer size (which consists of the L2 maximum
frame size + the max FD offset).

Signed-off-by: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Change-Id: Iac3a4d07b9ff77a2290427a59fd76d4844545ab4
Reviewed-on: http://git.am.freescale.net:8181/7101
Reviewed-by: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
Reviewed-by: Cristian-Constantin Sovaiala <Cristian.Sovaiala@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
Tested-by: Richard Schmitt <B43082@freescale.com>
[Original patch taken from QorIQ-SDK-V1.5-SOURCE-20131219-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 .../freescale/fman/src/wrapper/lnxwrp_resources.c  |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_resources.c b/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_resources.c
index b27016f..79aeb44 100644
--- a/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_resources.c
+++ b/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_resources.c
@@ -309,7 +309,10 @@ int fm_precalculate_fifosizes(t_LnxWrpFmDev *p_LnxWrpFmDev, int muram_fifo_size)
 	int min_rx_bufs = 0; /* minimum RX buffers required (see refman.) */
 
 	/* Buffer sizes calculus */
-	int max_frame_size = fm_get_max_frm();
+	/* Max frame size should also take into account the maximum possible
+	 * FD offset
+	*/
+	int max_frame_size = fm_get_max_frm() + 512;
 	int remaining_bufs = 0;
 	int rx_1g_bufs_ceil = 0, rx_2g5_bufs_ceil = 0, rx_10g_bufs_ceil = 0;
 	int rx_2g5_max_bufs = 0, rx_10g_max_bufs = 0;
-- 
1.7.5.4

