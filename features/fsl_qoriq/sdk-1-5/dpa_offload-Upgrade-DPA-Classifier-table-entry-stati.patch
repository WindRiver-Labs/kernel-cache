From 07f773a29267fe9a18882f28fd75c675994d86d9 Mon Sep 17 00:00:00 2001
From: Marian Chereji <marian.chereji@freescale.com>
Date: Tue, 24 Sep 2013 18:11:12 +0300
Subject: [PATCH 202/383] dpa_offload: Upgrade DPA Classifier table entry
 statistics

Upgraded the API functions

dpa_classif_table_get_entry_stats_by_key
dpa_classif_table_get_entry_stats_by_ref

to collect the key statistics, which gives packets counts as well as
bytes counts, instead of the old key counter which only gives a
packet counter.

Signed-off-by: Marian Chereji <marian.chereji@freescale.com>
Change-Id: I10ecf7b52f38d02b76aaf6ff7e0dc9dcd4852f94
Reviewed-on: http://git.am.freescale.net:8181/5202
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Floarea Anca Jeanina-B12569 <anca.floarea@freescale.com>
Reviewed-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
[Original patch taken from QorIQ-SDK-V1.5-SOURCE-20131219-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_classifier.c |   19 ++++++++++++++++---
 include/linux/fsl_dpa_classifier.h               |    5 ++++-
 2 files changed, 20 insertions(+), 4 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_classifier.c b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
index 5f7c7f7..507a526 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_classifier.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
@@ -1803,6 +1803,9 @@ static int table_get_entry_stats_by_ref(struct dpa_cls_table	*ptable,
 	uint8_t entry_index;
 	t_Handle cc_node;
 	struct dpa_cls_tbl_entry *index_entry;
+	t_FmPcdCcKeyStatistics key_stats;
+	t_Error err;
+	int ret = 0;
 
 	dpa_cls_dbg(("DEBUG: dpa_classifier %s (%d) -->\n", __func__,
 		__LINE__));
@@ -1830,13 +1833,23 @@ static int table_get_entry_stats_by_ref(struct dpa_cls_table	*ptable,
 	entry_index	= index_entry->entry_index;
 
 	cc_node = (t_Handle)ptable->int_cc_node[cc_node_index].cc_node;
-	stats->total_pkts = (unsigned long)
-		FM_PCD_MatchTableGetKeyCounter(cc_node,	entry_index);
+	err = FM_PCD_MatchTableGetKeyStatistics(cc_node, entry_index,
+								&key_stats);
+	if (err != E_OK) {
+		log_warn("FMan driver call failed - "
+			"FM_PCD_MatchTableGetKeyStatistics. Failed to acquire "
+			"key statistics.\n");
+		memset(stats, 0, sizeof(*stats));
+		ret = -EPERM;
+	} else {
+		stats->pkts	= key_stats.frameCount;
+		stats->bytes	= key_stats.byteCount;
+	}
 
 	dpa_cls_dbg(("DEBUG: dpa_classifier %s (%d) <--\n", __func__,
 		__LINE__));
 
-	return 0;
+	return ret;
 }
 
 int dpa_classif_table_get_params(int td, struct dpa_cls_tbl_params *params)
diff --git a/include/linux/fsl_dpa_classifier.h b/include/linux/fsl_dpa_classifier.h
index 6199aa0..f81909f 100644
--- a/include/linux/fsl_dpa_classifier.h
+++ b/include/linux/fsl_dpa_classifier.h
@@ -345,7 +345,10 @@ struct dpa_cls_tbl_entry_mod_params {
 struct dpa_cls_tbl_entry_stats {
 
 	/* The total number of packets that have hit the entry */
-	uint64_t		total_pkts;
+	uint32_t	pkts;
+
+	/* The total number of bytes that have hit the entry */
+	uint32_t	bytes;
 };
 
 
-- 
1.7.5.4

