From c827baff8d214ca87407d62a94f91efa913c1e59 Mon Sep 17 00:00:00 2001
From: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Date: Fri, 6 Dec 2013 12:13:07 +0200
Subject: [PATCH 370/383] fmd: Tweak again the FMan resource allocation
 algorithm

Reduce the FD offset taken into account when computing the maximum
buffer size. Without this change there is not enough MURAM for FMan
FIFOs in 14G configurations (like on P3041 and P5020 platforms).

This still covers (barely) the minimum FIFO size required for 1G
ports to work with jumbo frames optimization enabled.

Signed-off-by: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Change-Id: I28c09c0fb79de8d0c862cb7356cd9d387bd089ff
Reviewed-on: http://git.am.freescale.net:8181/7151
Reviewed-by: Madalin-Cristian Bucur <madalin.bucur@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
[Original patch taken from QorIQ-SDK-V1.5-SOURCE-20131219-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 .../freescale/fman/src/wrapper/lnxwrp_resources.c  |    8 ++++----
 1 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_resources.c b/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_resources.c
index 79aeb44..582d848 100644
--- a/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_resources.c
+++ b/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_resources.c
@@ -309,10 +309,10 @@ int fm_precalculate_fifosizes(t_LnxWrpFmDev *p_LnxWrpFmDev, int muram_fifo_size)
 	int min_rx_bufs = 0; /* minimum RX buffers required (see refman.) */
 
 	/* Buffer sizes calculus */
-	/* Max frame size should also take into account the maximum possible
-	 * FD offset
-	*/
-	int max_frame_size = fm_get_max_frm() + 512;
+	/* Max frame size should also take into account
+	 * a reasonable FD offset
+	 */
+	int max_frame_size = fm_get_max_frm() + 256;
 	int remaining_bufs = 0;
 	int rx_1g_bufs_ceil = 0, rx_2g5_bufs_ceil = 0, rx_10g_bufs_ceil = 0;
 	int rx_2g5_max_bufs = 0, rx_10g_max_bufs = 0;
-- 
1.7.5.4

