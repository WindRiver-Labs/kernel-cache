From 5d18539c6b225e2747c10e866737aec9db16f0b7 Mon Sep 17 00:00:00 2001
From: Zhao Qiang <B45475@freescale.com>
Date: Wed, 4 Dec 2013 16:44:54 +0800
Subject: [PATCH 397/429] powerpc/phy: add config function to enable interrupt
 for AT8033

AT8033 can't work well with auto-negotiation.
Add functions to config AT8033 to enable interrupt for auto-negotiation.

Signed-off-by: Zhao Qiang <B45475@freescale.com>
Change-Id: I6cf632e1436d377cc7bb65ef0113f2f16a97e324
Reviewed-on: http://git.am.freescale.net:8181/7057
Reviewed-by: Xiaobo Xie <X.Xie@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
Tested-by: Zhenhua Luo <zhenhua.luo@freescale.com>
[origin patch is from QorIQ-SDK-V1.5-20131219-yocto]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/net/phy/at803x.c |   29 ++++++++++++++++++++++++++++-
 1 files changed, 28 insertions(+), 1 deletions(-)

diff --git a/drivers/net/phy/at803x.c b/drivers/net/phy/at803x.c
index 88ecb85..3b2fa8b 100644
--- a/drivers/net/phy/at803x.c
+++ b/drivers/net/phy/at803x.c
@@ -27,6 +27,9 @@
 #define AT803X_MMD_ACCESS_CONTROL		0x0D
 #define AT803X_MMD_ACCESS_CONTROL_DATA		0x0E
 #define AT803X_FUNC_DATA			0x4003
+#define AT803X_INER		0x0012
+#define AT803X_INER_INIT	0xec00
+#define AT803X_INSR		0x0013
 
 MODULE_DESCRIPTION("Atheros 803x PHY driver");
 MODULE_AUTHOR("Matus Ujhelyi");
@@ -102,12 +105,34 @@ static int at803x_config_init(struct phy_device *phydev)
 
 	/* enable WOL */
 	at803x_set_wol_mac_addr(phydev);
-	status = phy_write(phydev, AT803X_INTR_ENABLE, AT803X_WOL_ENABLE);
+	status = phy_write(phydev, AT803X_INTR_ENABLE,
+			   AT803X_WOL_ENABLE | AT803X_INER_INIT);
 	status = phy_read(phydev, AT803X_INTR_STATUS);
 
 	return 0;
 }
 
+static int at803x_ack_interrupt(struct phy_device *phydev)
+{
+	int err;
+
+	err = phy_read(phydev, AT803X_INSR);
+
+	return (err < 0) ? err : 0;
+}
+
+static int at803x_config_intr(struct phy_device *phydev)
+{
+	int err;
+
+	if (phydev->interrupts == PHY_INTERRUPT_ENABLED)
+		err = phy_write(phydev, AT803X_INER, AT803X_INER_INIT);
+	else
+		err = phy_write(phydev, AT803X_INER, 0);
+
+	return err;
+}
+
 /* ATHEROS 8035 */
 static struct phy_driver at8035_driver = {
 	.phy_id		= 0x004dd072,
@@ -133,6 +158,8 @@ static struct phy_driver at8033_driver = {
 	.flags		= PHY_HAS_INTERRUPT,
 	.config_aneg	= &genphy_config_aneg,
 	.read_status	= &genphy_read_status,
+	.ack_interrupt	= &at803x_ack_interrupt,
+	.config_intr	= &at803x_config_intr,
 	.driver		= {
 		.owner = THIS_MODULE,
 	},
-- 
1.7.5.4

