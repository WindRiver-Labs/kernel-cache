From 951256be7533f1c6a7e151d9901cf4081a0fbef3 Mon Sep 17 00:00:00 2001
From: Bharat Bhushan <Bharat.Bhushan@freescale.com>
Date: Fri, 2 Aug 2013 15:13:03 +0530
Subject: [PATCH 121/429] powerpc: dying cpus spins by default

When a cpu is dying, the dying cpu finally runs ppc_md.cpu_die().
Default set the ppc_md.cpu_die points to generic_mach_cpu_die(), which set
the CPU state to CPU_DEAD and spins.

Also fix to dereference guts_regs only when it is not NULL.

Signed-off-by: Bharat Bhushan <bharat.bhushan@freescale.com>
Change-Id: I9372cb382d8306b429b9a94555c7e2123c53cd27
Reviewed-on: http://git.am.freescale.net:8181/3735
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Wood Scott-B07421 <scottwood@freescale.com>
Reviewed-by: Yoder Stuart-B08248 <stuart.yoder@freescale.com>
Reviewed-by: Rivera Jose-B46482 <Jose.G.Rivera@freescale.com>
[origin patch is from QorIQ-SDK-V1.5-20131219-yocto, for 85xx soc,
we do not need to set ppc_md.cpu_die points to generic_mach_cpu_die,
as it followingly would be set to smp_85xx_mach_cpu_die,
smp_85xx_mach_cpu_die does not depend on guts or RCPM.]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 arch/powerpc/platforms/85xx/smp.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/smp.c b/arch/powerpc/platforms/85xx/smp.c
index cfe40de..7288b4a 100644
--- a/arch/powerpc/platforms/85xx/smp.c
+++ b/arch/powerpc/platforms/85xx/smp.c
@@ -243,7 +243,7 @@ void platform_cpu_die(unsigned int cpu)
 		/* enter PH20 status */
 		setbits32(&((struct ccsr_rcpm_v2 *)guts_regs)->pcph20setr,
 				1 << cpu_core_index_of_thread(hw_cpu));
-	} else if (!rcpmv2) {
+	} else if (!rcpmv2 && guts_regs) {
 		rcpm = guts_regs;
 		/* Core Nap Operation */
 		setbits32(&rcpm->cnapcr, 1 << hw_cpu);
-- 
1.7.5.4

