From 0eb048770a389e776d556390367e4a25cd967db4 Mon Sep 17 00:00:00 2001
From: Bharat Bhushan <Bharat.Bhushan@freescale.com>
Date: Fri, 2 Aug 2013 15:13:03 +0530
Subject: [PATCH 126/383] powerpc: dying cpus spins by default

When a cpu is dying, the dying cpu finally runs ppc_md.cpu_die().
Default set the ppc_md.cpu_die points to generic_mach_cpu_die(), which set
the CPU state to CPU_DEAD and spins.

Also fix to dereference guts_regs only when it is not NULL.

Signed-off-by: Bharat Bhushan <bharat.bhushan@freescale.com>
Change-Id: I9372cb382d8306b429b9a94555c7e2123c53cd27
Reviewed-on: http://git.am.freescale.net:8181/3735
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Wood Scott-B07421 <scottwood@freescale.com>
Reviewed-by: Yoder Stuart-B08248 <stuart.yoder@freescale.com>
Reviewed-by: Rivera Jose-B46482 <Jose.G.Rivera@freescale.com>
[Original patch taken from QorIQ-SDK-V1.5-SOURCE-20131219-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/platforms/85xx/smp.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/smp.c b/arch/powerpc/platforms/85xx/smp.c
index b1a9aba..c6f80f8 100644
--- a/arch/powerpc/platforms/85xx/smp.c
+++ b/arch/powerpc/platforms/85xx/smp.c
@@ -246,7 +246,7 @@ void platform_cpu_die(unsigned int cpu)
 		/* enter PH20 status */
 		setbits32(&((struct ccsr_rcpm_v2 *)guts_regs)->pcph20setr,
 				1 << cpu_core_index_of_thread(hw_cpu));
-	} else if (!rcpmv2) {
+	} else if (!rcpmv2 && guts_regs) {
 		rcpm = guts_regs;
 		/* Core Nap Operation */
 		setbits32(&rcpm->cnapcr, 1 << hw_cpu);
@@ -679,6 +679,10 @@ void __init mpc85xx_smp_init(void)
 		smp_85xx_ops.cause_ipi = doorbell_cause_ipi;
 	}
 
+#ifdef CONFIG_HOTPLUG_CPU
+	ppc_md.cpu_die = generic_mach_cpu_die;
+#endif
+
 	np = of_find_matching_node(NULL, mpc85xx_smp_guts_ids);
 	if (np) {
 		if (of_device_is_compatible(np, "fsl,qoriq-rcpm-2.0"))
-- 
1.7.5.4

