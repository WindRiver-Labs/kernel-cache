From d1cb987ec9c3f39e62cfc29cc9d00575140b8ebf Mon Sep 17 00:00:00 2001
From: Shaohui Xie <Shaohui.Xie@freescale.com>
Date: Thu, 7 Nov 2013 13:37:02 +0800
Subject: [PATCH 294/383] T4240/dpa: skip reset FM for T4240 rev 2

Reset FM on T4 rev2.0 will lead to kernel hang if reading register
FMQM_GS after the reset, so temporarily skip the reset for T4240 rev2.0
till a better solution is available.

Change-Id: I66e7fe8394e73c472420886008a26c100daa382e
Signed-off-by: Shaohui Xie <Shaohui.Xie@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/6472
Reviewed-by: Richard Schmitt <B43082@freescale.com>
Tested-by: Richard Schmitt <B43082@freescale.com>
[Original patch taken from QorIQ-SDK-V1.5-SOURCE-20131219-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 .../ethernet/freescale/fman/Peripherals/FM/fm.c    |   13 ++++++++++---
 1 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c b/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c
index a44bdab..8cb96a0 100644
--- a/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c
+++ b/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c
@@ -47,6 +47,7 @@
 #include "fm_common.h"
 #include "fm_ipc.h"
 #include "fm.h"
+#include <asm/mpc85xx.h>
 
 
 /****************************************/
@@ -4347,9 +4348,15 @@ t_Error FM_Init(t_Handle h_Fm)
     /* Reset the FM if required. */
     if (p_FmDriverParam->resetOnInit)
     {
-        WRITE_UINT32(p_Fm->p_FmFpmRegs->fm_rstc, FPM_RSTC_FM_RESET);
-        CORE_MemoryBarrier();
-        XX_UDelay(100);
+	u32 svr = mfspr(SPRN_SVR);
+
+	if (SVR_SOC_VER(svr) == SVR_T4240 && SVR_REV(svr) > 0x10) {
+		DBG(WARNING, ("Hack: No FM reset!\n"));
+	} else {
+		WRITE_UINT32(p_Fm->p_FmFpmRegs->fm_rstc, FPM_RSTC_FM_RESET);
+		CORE_MemoryBarrier();
+		XX_UDelay(100);
+	}
 
         if (GET_UINT32(p_Fm->p_FmQmiRegs->fmqm_gs) & QMI_GS_HALT_NOT_BUSY)
         {
-- 
1.7.5.4

