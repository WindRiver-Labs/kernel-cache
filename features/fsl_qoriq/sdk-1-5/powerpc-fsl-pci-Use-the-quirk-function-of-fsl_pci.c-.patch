From 25171012d06614ec14b7cbf3b1ea6089b136c3d6 Mon Sep 17 00:00:00 2001
From: Chunhe Lan <Chunhe.Lan@freescale.com>
Date: Tue, 24 Sep 2013 16:29:28 +0800
Subject: [PATCH 230/429] powerpc/fsl-pci: Use the quirk function of fsl_pci.c
 instead of quirk function of quirks.c

In the fsl_pci.c, it has the quirk function: DECLARE_PCI_FIXUP_HEADER and
quirk_fsl_pcie_header. But for fixing the following notice information:

  pci 0000:00:00.0: ignoring class 0x0b2000 (doesn't match header type 01)

We use the DECLARE_PCI_FIXUP_EARLY and quirk_fsl_pcie_early instead of
DECLARE_PCI_FIXUP_HEADER and quirk_fsl_pcie_header.

This patch reverts commit 586c2c9eb2bc5da79d8e093b2b7dd98b5050e094:

Remove the DECLARE_PCI_FIXUP_EARLY and quirk_freescale_class function in
the quirks.c, because they have the same function as DECLARE_PCI_FIXUP_EARLY
and quirk_fsl_pcie_early function in the fsl_pci.c.

At the same time, in the fsl_pci.c quirk_fsl_pcie_early function can handle
both of the RC devices and EP devices.

Signed-off-by: Chunhe Lan <Chunhe.Lan@freescale.com>
Change-Id: Iee569a14eeedd9a09d4511494a59d07b03f63f95
Reviewed-on: http://git.am.freescale.net:8181/4898
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Zang Tiefei-R61911 <tie-fei.zang@freescale.com>
Reviewed-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
[origin patch is from QorIQ-SDK-V1.5-20131219-yocto]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 arch/powerpc/sysdev/fsl_pci.c |    5 +++--
 drivers/pci/quirks.c          |   10 ----------
 2 files changed, 3 insertions(+), 12 deletions(-)

diff --git a/arch/powerpc/sysdev/fsl_pci.c b/arch/powerpc/sysdev/fsl_pci.c
index c79c5f4..0a52fd2 100644
--- a/arch/powerpc/sysdev/fsl_pci.c
+++ b/arch/powerpc/sysdev/fsl_pci.c
@@ -38,7 +38,7 @@
 
 static int fsl_pcie_bus_fixup, is_mpc83xx_pci;
 
-static void __devinit quirk_fsl_pcie_header(struct pci_dev *dev)
+static void __devinit quirk_fsl_pcie_early(struct pci_dev *dev)
 {
 	u8 hdr_type;
 
@@ -614,7 +614,8 @@ no_bridge:
 }
 #endif /* CONFIG_FSL_SOC_BOOKE || CONFIG_PPC_86xx */
 
-DECLARE_PCI_FIXUP_HEADER(PCI_VENDOR_ID_FREESCALE, PCI_ANY_ID, quirk_fsl_pcie_header);
+DECLARE_PCI_FIXUP_EARLY(PCI_VENDOR_ID_FREESCALE, PCI_ANY_ID,
+			quirk_fsl_pcie_early);
 /* P2020DS board pull USB clk signal to Ground, we must prevent PCI to acess USB device on the Nvidia M1575 */
 DECLARE_PCI_FIXUP_HEADER(PCI_VENDOR_ID_AL, PCI_DEVICE_ID_AL_M5237, quirk_p2020ds_pci_header);
 DECLARE_PCI_FIXUP_HEADER(PCI_VENDOR_ID_AL, PCI_DEVICE_ID_AL_M5239, quirk_p2020ds_pci_header);
diff --git a/drivers/pci/quirks.c b/drivers/pci/quirks.c
index c792dd4..64c7f5b 100644
--- a/drivers/pci/quirks.c
+++ b/drivers/pci/quirks.c
@@ -2777,16 +2777,6 @@ DECLARE_PCI_FIXUP_EARLY(PCI_VENDOR_ID_INTEL, 0x342e, vtd_mask_spec_errors);
 DECLARE_PCI_FIXUP_EARLY(PCI_VENDOR_ID_INTEL, 0x3c28, vtd_mask_spec_errors);
 #endif
 
-#ifdef CONFIG_FSL_PCI
-static void quirk_freescale_class(struct pci_dev *dev)
-{
-	dev_info(&dev->dev, "Setting PCI class for FSL PCI host bridge\n");
-	dev->class = (PCI_CLASS_BRIDGE_PCI << 8) | (dev->class & 0xff);
-}
-DECLARE_PCI_FIXUP_EARLY(PCI_VENDOR_ID_FREESCALE, PCI_ANY_ID,
-			quirk_freescale_class);
-#endif
-
 static void __devinit fixup_ti816x_class(struct pci_dev* dev)
 {
 	/* TI 816x devices do not have class code set when in PCIe boot mode */
-- 
1.7.5.4

