From a2df6ff076d0343bb2ec556525ed6b53f4e59aa3 Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Tue, 25 Jun 2013 18:40:35 +0300
Subject: [PATCH 054/383] dpaa_eth: free buf_layout on error paths

The allocated buf_layout must be freed on all error paths.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
Change-Id: Icf2e68f90c28adcc99fdc56492942f3595033b21
Reviewed-on: http://git.am.freescale.net:8181/3093
Reviewed-by: Sovaiala Cristian-Constantin-B39531 <Cristian.Sovaiala@freescale.com>
Reviewed-by: Radulescu Ruxandra Ioana-B05472 <ruxandra.radulescu@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Original patch taken from QorIQ-SDK-V1.5-SOURCE-20131219-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c      |    1 +
 .../net/ethernet/freescale/dpa/dpaa_eth_proxy.c    |    4 +++-
 .../net/ethernet/freescale/dpa/dpaa_eth_shared.c   |    1 +
 3 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 8399fbe..ebc66e7 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -3255,6 +3255,7 @@ get_channel_failed:
 		dpa_bp_free(priv, priv->dpa_bp);
 bp_create_failed:
 fq_probe_failed:
+	devm_kfree(dev, buf_layout);
 alloc_failed:
 mac_probe_failed:
 	dev_set_drvdata(dev, NULL);
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
index 1f3e519..21dda6d 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
@@ -132,8 +132,10 @@ static int dpaa_eth_proxy_probe(struct platform_device *_of_dev)
 	if (!err)
 		err = dpa_fq_probe_mac(dev, &proxy_fq_list, &port_fqs, true,
 				       TX);
-	if (err < 0)
+	if (err < 0) {
+		devm_kfree(dev, buf_layout);
 		return err;
+	}
 
 	/* Proxy initializer - Just configures the MAC on behalf of
 	 * another partition.
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
index 2d06be1..76f5e50 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
@@ -771,6 +771,7 @@ get_channel_failed:
 		dpa_bp_free(priv, priv->dpa_bp);
 bp_create_failed:
 fq_probe_failed:
+	devm_kfree(dev, buf_layout);
 alloc_failed:
 mac_probe_failed:
 	dev_set_drvdata(dev, NULL);
-- 
1.7.5.4

