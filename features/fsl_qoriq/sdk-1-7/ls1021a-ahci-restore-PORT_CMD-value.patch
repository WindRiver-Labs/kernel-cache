From 721b830d12832287a38cce916c32e0fc6d655e38 Mon Sep 17 00:00:00 2001
From: Shaohui Xie <Shaohui.Xie@freescale.com>
Date: Thu, 20 Nov 2014 13:43:33 +0800
Subject: [PATCH 3/3] ls1021a: ahci: restore PORT_CMD value

The value changed after hard reset which caused interrupt cannot work,
restore the value after reset then the interrupt can work.

Signed-off-by: Shaohui Xie <Shaohui.Xie@freescale.com>
Change-Id: I095bf1c4029938e1ad6d0416aeea58463b2dcdf8
Reviewed-on: http://git.am.freescale.net:8181/31842
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Xiaobo Xie <X.Xie@freescale.com>
Reviewed-by: Zhengxiong Jin <Jason.Jin@freescale.com>
[Zhenbo: Original patch taken from FSL QorIQ SDK v1.8 SOURCE yocto.iso]
Signed-off-by: Zhenbo Gao <zhenbo.gao@windriver.com>
---
 drivers/ata/libahci.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/drivers/ata/libahci.c b/drivers/ata/libahci.c
index 36605ab..1335158 100644
--- a/drivers/ata/libahci.c
+++ b/drivers/ata/libahci.c
@@ -1426,15 +1426,19 @@ static int ahci_hardreset(struct ata_link *link, unsigned int *class,
 	const unsigned long *timing = sata_ehc_deb_timing(&link->eh_context);
 	struct ata_port *ap = link->ap;
 	struct ahci_port_priv *pp = ap->private_data;
+	void __iomem *port_mmio = ahci_port_base(link->ap);
 	u8 *d2h_fis = pp->rx_fis + RX_FIS_D2H_REG;
 	struct ata_taskfile tf;
 	bool online;
 	int rc;
+	u32 save_cmd, tmp;
 
 	DPRINTK("ENTER\n");
 
 	ahci_stop_engine(ap);
 
+	save_cmd = readl(port_mmio + PORT_CMD);
+
 	/* clear D2H reception area to properly wait for D2H FIS */
 	ata_tf_init(link->device, &tf);
 	tf.command = ATA_BUSY;
@@ -1443,6 +1447,11 @@ static int ahci_hardreset(struct ata_link *link, unsigned int *class,
 	rc = sata_link_hardreset(link, timing, deadline, &online,
 				 ahci_check_ready);
 
+	/* Revert the saved cmd value, if not match with original */
+	tmp = readl(port_mmio + PORT_CMD);
+	if (tmp != save_cmd)
+		writel(save_cmd, port_mmio + PORT_CMD);
+
 	ahci_start_engine(ap);
 
 	if (online)
-- 
1.7.5.4

