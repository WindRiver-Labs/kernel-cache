From b6ae5a8cd6ce15f9e350dda5ba60a30b2220291c Mon Sep 17 00:00:00 2001
From: Horia Geanta <horia.geanta@freescale.com>
Date: Mon, 21 Jul 2014 16:03:21 +0300
Subject: [PATCH 150/399] crypto: caam - fix DECO RSR polling

commit 8f1da7b945b65513fb02b75ce25040c67ce32726 upstream

RSR (Request Source Register) is not used when
virtualization is disabled, thus don't poll for Valid bit.

Besides this, if used, timeout has to be reinitialized.

Signed-off-by: Horia Geanta <horia.geanta@freescale.com>
Acked-by: Kim Phillips <kim.phillips@freescale.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
---
 drivers/crypto/caam/ctrl.c |   11 +++++++----
 1 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/drivers/crypto/caam/ctrl.c b/drivers/crypto/caam/ctrl.c
index d767be0..f89d8fd 100644
--- a/drivers/crypto/caam/ctrl.c
+++ b/drivers/crypto/caam/ctrl.c
@@ -92,12 +92,15 @@ static inline int run_descriptor_deco0(struct device *ctrldev, u32 *desc,
 	/* Set the bit to request direct access to DECO0 */
 	topregs = (struct caam_full __iomem *)ctrlpriv->ctrl;
 
-	if (ctrlpriv->virt_en == 1)
+	if (ctrlpriv->virt_en == 1) {
 		setbits32(&topregs->ctrl.deco_rsr, DECORSR_JR0);
 
-	while (!(rd_reg32(&topregs->ctrl.deco_rsr) & DECORSR_VALID) &&
-	       --timeout)
-		cpu_relax();
+		while (!(rd_reg32(&topregs->ctrl.deco_rsr) & DECORSR_VALID) &&
+		       --timeout)
+			cpu_relax();
+
+		timeout = 100000;
+	}
 
 	setbits32(&topregs->ctrl.deco_rq, DECORR_RQD0ENABLE);
 
-- 
1.7.5.4

