From 88554144e94e2c07d5d046dd28f298c9f64411d9 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Wed, 2 Sep 2015 10:27:13 +0800
Subject: [PATCH 2/3] can: flexcan: fix the access of register with the wrong
 endian mode

For the flexcan on powerpc platform, both the core and module are in
big endian mode (!core_is_little && !module_is_littel). In this case,
we should use the API for big endian mode instead of little endian.
Actually we shouldn't care about the core endian mode in a specific
driver since it will be handled correctly by the corresponding API.
All we need is to check the module endian mode. If it is in little
endian, the LE API should be used. If it is in big endian, then BE
API should be used.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/can/flexcan.c |   13 +++----------
 1 files changed, 3 insertions(+), 10 deletions(-)

diff --git a/drivers/net/can/flexcan.c b/drivers/net/can/flexcan.c
index 347f7d1..d1e191c 100644
--- a/drivers/net/can/flexcan.c
+++ b/drivers/net/can/flexcan.c
@@ -1389,7 +1389,7 @@ static int flexcan_probe(struct platform_device *pdev)
 	int err, irq;
 	u32 clock_freq = 0;
 	/* Default case for most ARM based FSL SoC having BE FlexCAN IP */
-	bool core_is_little = true, module_is_little = false;
+	bool module_is_little = false;
 
 	reg_xceiver = devm_regulator_get(&pdev->dev, "xceiver");
 	if (PTR_ERR(reg_xceiver) == -EPROBE_DEFER)
@@ -1445,20 +1445,13 @@ static int flexcan_probe(struct platform_device *pdev)
 
 	priv = netdev_priv(dev);
 
-	if (IS_ENABLED(CONFIG_CPU_BIG_ENDIAN))
-		core_is_little = false;
-
 	if (of_property_read_bool(dev->dev.of_node, "little-endian"))
 		module_is_little = true;
 
-	if ((core_is_little && module_is_little) ||
-	   (!core_is_little && !module_is_little)) {
+	if (module_is_little) {
 		priv->read = flexcan_read_le;
 		priv->write = flexcan_write_le;
-	}
-
-	if ((!core_is_little && module_is_little) ||
-	   (core_is_little && !module_is_little)) {
+	} else {
 		priv->read = flexcan_read_be;
 		priv->write = flexcan_write_be;
 	}
-- 
1.7.5.4

