From 261cc68407c66240fcfdacf460c0e0df206fb882 Mon Sep 17 00:00:00 2001
From: Jianchuan Wang <jianchuan.wang@windriver.com>
Date: Thu, 23 Apr 2015 15:55:49 +0800
Subject: [PATCH] fsl-t2xxx: Fix compile errors when disabling CONFIG_SMP

There are some compile errors when disabling CONFIG_SMP
- boot_cpuid isn't declared in the ics.c,it hints:

    | arch/powerpc/platforms/wsp/ics.c: In function 'wsp_ics_set_default_server':
    | arch/powerpc/platforms/wsp/ics.c:655:23: error: 'boot_cpuid' undeclared (first use in this function)
    |   np = of_get_cpu_node(boot_cpuid, NULL);
    |                        ^
    | arch/powerpc/platforms/wsp/ics.c:655:23: note: each undeclared identifier is reported only once for each function it appears in
    | arch/powerpc/platforms/wsp/ics.c:658:2: error: implicit declaration of function 'get_hard_smp_processor_id' [-Werror=implicit-function-declaration]
    |   hwid = get_hard_smp_processor_id(boot_cpuid);

- nr_cpu_ids isn't defined in the exceptions-64e.S/head_64.S, it hints:

    | arch/powerpc/kernel/head_64.S:231: undefined reference to `nr_cpu_ids'

Signed-off-by: Jianchuan Wang <jianchuan.wang@windriver.com>
---
 arch/powerpc/kernel/exceptions-64e.S |    4 ++++
 arch/powerpc/kernel/head_64.S        |    4 ++++
 arch/powerpc/kernel/setup_64.c       |    1 +
 arch/powerpc/platforms/wsp/ics.c     |    1 +
 4 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/exceptions-64e.S b/arch/powerpc/kernel/exceptions-64e.S
index 6d09348..8d3ee53 100644
--- a/arch/powerpc/kernel/exceptions-64e.S
+++ b/arch/powerpc/kernel/exceptions-64e.S
@@ -1669,8 +1669,12 @@ BEGIN_FTR_SECTION
 	LOAD_REG_ADDR(r8, paca)	/* Get the current paca */
 	ld	r8,0(r8)
 	li	r5,0
+#ifdef CONFIG_SMP
 	LOAD_REG_ADDR(r7, nr_cpu_ids)
 	lwz	r7,0(r7)
+#else
+	li  r7,1
+#endif
 11:	lhz	r6,PACAHWCPUID(r8)
 	cmpw	r6,r4
 	beq	12f
diff --git a/arch/powerpc/kernel/head_64.S b/arch/powerpc/kernel/head_64.S
index bc946c9..4b699f6 100644
--- a/arch/powerpc/kernel/head_64.S
+++ b/arch/powerpc/kernel/head_64.S
@@ -228,8 +228,12 @@ BEGIN_FTR_SECTION
 	ld	r3,0(r3)
 	mfspr	r4,SPRN_TIR	/* The thread0 cpu id plus TIR is the */
 	add	r3,r3,r4	/* logical id of the current thread. */
+#ifdef CONFIG_SMP
 	LOAD_REG_ADDR(r4, nr_cpu_ids)
 	lwz	r4,0(r4)
+#else
+	li r4,1
+#endif
 	cmpld	r3,r4
 	bge	.
 
diff --git a/arch/powerpc/kernel/setup_64.c b/arch/powerpc/kernel/setup_64.c
index 84e1457..5b7b3bd 100644
--- a/arch/powerpc/kernel/setup_64.c
+++ b/arch/powerpc/kernel/setup_64.c
@@ -75,6 +75,7 @@
 #endif
 
 int boot_cpuid = 0;
+EXPORT_SYMBOL_GPL(boot_cpuid);
 int spinning_secondaries;
 u64 ppc64_pft_size;
 
diff --git a/arch/powerpc/platforms/wsp/ics.c b/arch/powerpc/platforms/wsp/ics.c
index 9cd92e6..314f338 100644
--- a/arch/powerpc/platforms/wsp/ics.c
+++ b/arch/powerpc/platforms/wsp/ics.c
@@ -24,6 +24,7 @@
 #include <asm/io.h>
 #include <asm/irq.h>
 #include <asm/xics.h>
+#include <asm/smp.h>
 
 #include "wsp.h"
 #include "ics.h"
-- 
1.7.5.4

