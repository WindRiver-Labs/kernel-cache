From 5688a6b16e5ec870d7012f85afc936fa2b54ec9e Mon Sep 17 00:00:00 2001
From: "yadi.hu@windriver.com" <yadi.hu@windriver.com>
Date: Wed, 9 Sep 2015 14:26:33 +0800
Subject: [PATCH] qman: add sync protect when do kexec fast reboot

Signed-off-by: Hu <yadi.hu@windriver.com>
---
 drivers/staging/fsl_qbman/qman_config.c |    3 +++
 drivers/staging/fsl_qbman/qman_high.c   |   14 ++++++++++++++
 include/linux/fsl_qman.h                |    6 ++++++
 3 files changed, 23 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_qbman/qman_config.c b/drivers/staging/fsl_qbman/qman_config.c
index 1eea298..caf1089 100644
--- a/drivers/staging/fsl_qbman/qman_config.c
+++ b/drivers/staging/fsl_qbman/qman_config.c
@@ -1125,9 +1125,12 @@ void of_fsl_qman_shutdown(struct platform_device *ofdev)
 {
 	int cpu;
 	struct qman_portal *p;
+	unsigned long irqflags __maybe_unused; 
 	for_each_online_cpu(cpu) {
 		p = per_cpu_affine_portal(cpu);
+		qman_portal_lock(p,irqflags);
 		qman_static_dequeue_del_ex(p, ~0);
+		qman_portal_unlock(p,irqflags);
 	}
 	return;
 };
diff --git a/drivers/staging/fsl_qbman/qman_high.c b/drivers/staging/fsl_qbman/qman_high.c
index 09e9ab2..ea4aea5 100644
--- a/drivers/staging/fsl_qbman/qman_high.c
+++ b/drivers/staging/fsl_qbman/qman_high.c
@@ -419,6 +419,20 @@ static int qm_drain_dqrr(struct qm_portal *p)
 	qm_isr_status_clear(p, 0xffffffff);
 	return 0;
 }
+
+int qman_portal_lock(struct qman_portal *p,unsigned long irqflags)
+{
+    spin_lock_irqsave(&p->cgr_lock, irqflags);
+    return 0;
+
+}
+
+int qman_portal_unlock(struct qman_portal *p,unsigned long irqflags)
+{
+    spin_unlock_irqrestore(&p->cgr_lock, irqflags);
+    return 0;
+} 
+
 #else
 static inline int qm_drain_dqrr(struct qm_portal *p) { return 1; }
 #endif
diff --git a/include/linux/fsl_qman.h b/include/linux/fsl_qman.h
index 77d60c0..bcaba6b 100644
--- a/include/linux/fsl_qman.h
+++ b/include/linux/fsl_qman.h
@@ -1773,6 +1773,12 @@ void qman_static_dequeue_del_ex(struct qman_portal *p, u32 pools);
  */
 struct qman_portal *per_cpu_affine_portal(int cpu);
 
+#if defined(CONFIG_KEXEC)
+
+int qman_portal_lock(struct qman_portal *p,unsigned long irqflags);
+int qman_portal_unlock(struct qman_portal *p,unsigned long irqflags) ;
+#endif
+
 /**
  * qman_static_dequeue_get - return the portal's current SDQCR
  *
-- 
1.7.5.4

