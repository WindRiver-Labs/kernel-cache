From 2ba9e9301ff200c32ce8363441751fdc685848a3 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Mon, 25 Jan 2016 14:17:09 +0800
Subject: [PATCH 1/2] ppc: enable e6500 in PPC32

Enable e6500 in PPC32, but disable __restore_cpu_e6500 in 32bit mode.
This change refers to upstream commit 2c71b0cc4a62 ("powerpc/booke:
Merge the 32 bit e5500/e500mc cpu setup code.")

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/powerpc/kernel/cpu_setup_fsl_booke.S |    4 ++--
 arch/powerpc/kernel/cputable.c            |    6 ++++--
 2 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/arch/powerpc/kernel/cpu_setup_fsl_booke.S b/arch/powerpc/kernel/cpu_setup_fsl_booke.S
index 45bafd4..dac571a 100644
--- a/arch/powerpc/kernel/cpu_setup_fsl_booke.S
+++ b/arch/powerpc/kernel/cpu_setup_fsl_booke.S
@@ -123,7 +123,7 @@ _GLOBAL(setup_altivec_idle)
 2:
 	blr
 
-#ifdef CONFIG_PPC_BOOK3E_64
+#ifdef CONFIG_PPC_E500MC
 _GLOBAL(__setup_cpu_e6500)
 	mflr	r6
 #ifdef CONFIG_PPC64
@@ -140,7 +140,7 @@ _GLOBAL(__setup_cpu_e6500)
 	bl	__setup_cpu_e5500
 	mtlr	r6
 	blr
-#endif
+#endif /* CONFIG_PPC_E500MC */
 
 #ifdef CONFIG_PPC32
 _GLOBAL(__setup_cpu_e200)
diff --git a/arch/powerpc/kernel/cputable.c b/arch/powerpc/kernel/cputable.c
index 4e1b957..c8e9ec6 100644
--- a/arch/powerpc/kernel/cputable.c
+++ b/arch/powerpc/kernel/cputable.c
@@ -80,7 +80,9 @@ extern long __machine_check_early_realmode_p8(struct pt_regs *regs);
 extern void __setup_cpu_e5500(unsigned long offset, struct cpu_spec* spec);
 extern void __setup_cpu_e6500(unsigned long offset, struct cpu_spec* spec);
 extern void __restore_cpu_e5500(void);
+#ifndef CONFIG_PPC32
 extern void __restore_cpu_e6500(void);
+#endif /* CONFIG_PPC32 */
 #endif /* CONFIG_E500 */
 
 /* This table only contains "desktop" CPUs, it need to be filled with embedded
@@ -2117,7 +2119,6 @@ static struct cpu_spec __initdata cpu_specs[] = {
 		.l2cache_type		= PPC_L2_CACHE_CORE,
 		.cpu_flush_caches	= __flush_caches_e5500,
 	},
-#ifndef CONFIG_PPC32
 	{	/* e6500 */
 		.pvr_mask		= 0xffff0000,
 		.pvr_value		= 0x80400000,
@@ -2134,13 +2135,14 @@ static struct cpu_spec __initdata cpu_specs[] = {
 		.oprofile_cpu_type	= "ppc/e6500",
 		.oprofile_type		= PPC_OPROFILE_FSL_EMB,
 		.cpu_setup		= __setup_cpu_e6500,
+#ifndef CONFIG_PPC32
 		.cpu_restore		= __restore_cpu_e6500,
+#endif
 		.machine_check		= machine_check_e500mc,
 		.platform		= "ppce6500",
 		.l2cache_type		= PPC_L2_CACHE_CLUSTER,
 		.cpu_flush_caches	= __flush_caches_e6500,
 	},
-#endif
 #ifdef CONFIG_PPC32
 	{	/* default match */
 		.pvr_mask		= 0x00000000,
-- 
1.7.5.4

