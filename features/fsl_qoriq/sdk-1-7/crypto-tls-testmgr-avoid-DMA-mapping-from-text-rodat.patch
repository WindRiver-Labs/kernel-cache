From bab38b45e47c4d98f3f01159d8a686ec256cc6a1 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Thu, 12 Feb 2015 16:15:09 +0800
Subject: [PATCH 2/2] crypto: tls: testmgr - avoid DMA mapping from text,
 rodata, stack

This refer to upstream commit 29b77e5dd88e1b920e3e65681f0e7b961ebbdeb8.
It is to fix aead and hash, this patch is to fix tls.

With DMA_API_DEBUG set, following warnings are emitted
(tested on CAAM accelerator):
DMA-API: device driver maps memory from kernel text or rodata
DMA-API: device driver maps memory from stack
and the culprits are:
-key in __test_tls
-result in __test_tls

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 crypto/testmgr.c |   12 +++++++++++-
 1 files changed, 11 insertions(+), 1 deletions(-)

diff --git a/crypto/testmgr.c b/crypto/testmgr.c
index 440cdbf..88f86f2 100644
--- a/crypto/testmgr.c
+++ b/crypto/testmgr.c
@@ -875,6 +875,9 @@ static int __test_tls(struct crypto_aead *tfm, int enc,
 	iv = kzalloc(MAX_IVLEN, GFP_KERNEL);
 	if (!iv)
 		return ret;
+	key = kmalloc(MAX_KEYLEN, GFP_KERNEL);
+	if (!key)
+		goto out_noxbuf;
 	if (testmgr_alloc_buf(xbuf))
 		goto out_noxbuf;
 	if (testmgr_alloc_buf(axbuf))
@@ -920,7 +923,13 @@ static int __test_tls(struct crypto_aead *tfm, int enc,
 			memset(iv, 0, MAX_IVLEN);
 
 		crypto_aead_clear_flags(tfm, ~0);
-		key = template[i].key;
+		if (template[i].klen > MAX_KEYLEN) {
+			pr_err("alg: tls%s: setkey failed on test %d for %s: key size %d > %d\n",
+			d, i, algo, template[i].klen, MAX_KEYLEN);
+			ret = -EINVAL;
+			goto out;
+		}
+		memcpy(key, template[i].key, template[i].klen);
 
 		ret = crypto_aead_setkey(tfm, key, template[i].klen);
 		if (!ret == template[i].fail) {
@@ -1011,6 +1020,7 @@ out_nooutbuf:
 out_noaxbuf:
 	testmgr_free_buf(xbuf);
 out_noxbuf:
+	kfree(key);
 	kfree(iv);
 	return ret;
 }
-- 
1.7.5.4

