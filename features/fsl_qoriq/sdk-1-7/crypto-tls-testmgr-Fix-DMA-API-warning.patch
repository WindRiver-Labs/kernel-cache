From c1f12ac31acaa1ec7a5e8d52cd63a135372eb783 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Mon, 19 May 2014 09:51:33 -0700
Subject: [PATCH 1/2] crypto: tls: testmgr - Fix DMA-API warning

Refer to the upstream commit 9bac019dad8098a77cce555d929f678e22111783.
It is to fix aead, this patch is to fix tls.

With DMA-API debug enabled testmgr triggers a
"DMA-API: device driver maps memory from stack" warning,
when tested on a crypto HW accelerator.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 crypto/testmgr.c |    7 +++++--
 1 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/crypto/testmgr.c b/crypto/testmgr.c
index 4fa5374..440cdbf 100644
--- a/crypto/testmgr.c
+++ b/crypto/testmgr.c
@@ -867,16 +867,18 @@ static int __test_tls(struct crypto_aead *tfm, int enc,
 	void *input;
 	void *output;
 	void *assoc;
-	char iv[MAX_IVLEN];
+	char *iv;
 	char *xbuf[XBUFSIZE];
 	char *xoutbuf[XBUFSIZE];
 	char *axbuf[XBUFSIZE];
 
+	iv = kzalloc(MAX_IVLEN, GFP_KERNEL);
+	if (!iv)
+		return ret;
 	if (testmgr_alloc_buf(xbuf))
 		goto out_noxbuf;
 	if (testmgr_alloc_buf(axbuf))
 		goto out_noaxbuf;
-
 	if (diff_dst && testmgr_alloc_buf(xoutbuf))
 		goto out_nooutbuf;
 
@@ -1009,6 +1011,7 @@ out_nooutbuf:
 out_noaxbuf:
 	testmgr_free_buf(xbuf);
 out_noxbuf:
+	kfree(iv);
 	return ret;
 }
 
-- 
1.7.5.4

