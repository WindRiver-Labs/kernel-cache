From aa1f5da9d0bebed8025e4cd1af15aa4b4fc67b1c Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 13 Oct 2015 10:57:57 +0800
Subject: [PATCH 4/7] tdm: replace the deprecated idr helper functions

Fixes the following build warnings:
  drivers/tdm/tdm-core.c: In function 'tdm_add_adapter':
  drivers/tdm/tdm-core.c:204:2: warning: 'idr_pre_get' is deprecated (declared at include/linux/idr.h:155) [-Wdeprecated-declarations]
    if (idr_pre_get(&tdm_adapter_idr, GFP_KERNEL) == 0)
    ^
  drivers/tdm/tdm-core.c:208:2: warning: 'idr_get_new' is deprecated (declared at include/linux/idr.h:185) [-Wdeprecated-declarations]
    res = idr_get_new(&tdm_adapter_idr, adapter, &id);

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/tdm/tdm-core.c |   11 ++++++-----
 1 files changed, 6 insertions(+), 5 deletions(-)

diff --git a/drivers/tdm/tdm-core.c b/drivers/tdm/tdm-core.c
index 97bd338..1999499 100644
--- a/drivers/tdm/tdm-core.c
+++ b/drivers/tdm/tdm-core.c
@@ -201,17 +201,18 @@ int tdm_add_adapter(struct tdm_adapter *adapter)
 	}
 
 retry:
-	if (idr_pre_get(&tdm_adapter_idr, GFP_KERNEL) == 0)
-		return -ENOMEM;
+	idr_preload(GFP_KERNEL);
 
 	mutex_lock(&tdm_core_lock);
-	res = idr_get_new(&tdm_adapter_idr, adapter, &id);
+	id = idr_alloc(&tdm_adapter_idr, adapter, 0, 0, GFP_KERNEL);
 	mutex_unlock(&tdm_core_lock);
 
-	if (res < 0) {
+	idr_preload_end();
+
+	if (id < 0) {
 		if (res == -EAGAIN)
 			goto retry;
-		return res;
+		return id;
 	}
 
 	adapter->id = id;
-- 
1.7.5.4

