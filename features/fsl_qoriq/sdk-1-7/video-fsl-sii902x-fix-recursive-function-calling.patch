From 3779ea683cc2f99bb3a9339b94c880f8e1fd6f49 Mon Sep 17 00:00:00 2001
From: Xulin Sun <xulin.sun@windriver.com>
Date: Tue, 26 May 2015 16:36:53 +0800
Subject: [PATCH] video:fsl-sii902x: fix recursive function calling

If enable the HDMI, the below call trace would be output:

stack backtrace:
CPU: 0 PID: 41 Comm: kworker/0:1 Not tainted 3.14.29ltsi-WR7.0.0.0_cgl #12
Workqueue: events det_worker
[<80018794>] (unwind_backtrace) from [<80012b2c>] (show_stack+0x20/0x24)
[<80012b2c>] (show_stack) from [<807deca0>] (dump_stack+0x74/0xc0)
[<807deca0>] (dump_stack) from [<8007e168>] (__lock_acquire+0x668/0x1c28)
[<8007e168>] (__lock_acquire) from [<8007fe44>] (lock_acquire+0xfc/0x218)
[<8007fe44>] (lock_acquire) from [<807e5aac>] (down_read+0x50/0x64)
[<807e5aac>] (down_read) from [<80055e40>] (__blocking_notifier_call_chain+0x84/0xc0)
[<80055e40>] (__blocking_notifier_call_chain) from [<80055ea4>](blocking_notifier_call_chain+0x28/0x30)
[<80055ea4>] (blocking_notifier_call_chain) from [<8044f978>](fb_notifier_call_chain+0x28/0x30)
[<8044f978>] (fb_notifier_call_chain) from [<8044ff3c>](fb_blank+0x44/0x98)
[<8044ff3c>] (fb_blank) from [<8045970c>] (fbcon_blank+0x134/0x268)
[<8045970c>] (fbcon_blank) from [<80486770>](do_blank_screen+0x1a0/0x274)
[<80486770>] (do_blank_screen) from [<804577a8>](fbcon_fb_blanked+0x88/0xa8)
[<804577a8>] (fbcon_fb_blanked) from [<8045c664>](fbcon_event_notify+0x4e0/0x6f0)
[<8045c664>] (fbcon_event_notify) from [<807e9a30>](notifier_call_chain+0xe0/0x110)
[<807e9a30>] (notifier_call_chain) from [<80055e5c>](__blocking_notifier_call_chain+0xa0/0xc0)
[<80055e5c>] (__blocking_notifier_call_chain) from [<80055ea4>](blocking_notifier_call_chain+0x28/0x30)
[<80055ea4>] (blocking_notifier_call_chain) from [<8044f978>](fb_notifier_call_chain+0x28/0x30)
[<8044f978>] (fb_notifier_call_chain) from [<8044ff84>] (fb_blank+0x8c/0x98)
[<8044ff84>] (fb_blank) from [<8045efdc>] (det_worker+0xc0/0x1f4)
[<8045efdc>] (det_worker) from [<800480f8>] (process_one_work+0x2fc/0x688)
[<800480f8>] (process_one_work) from [<80049660>] (worker_thread+0x3f0/0x500)
[<80049660>] (worker_thread) from [<80050230>] (kthread+0xd8/0xec)
[<80050230>] (kthread) from [<8000e438>] (ret_from_fork+0x14/0x20)

The function calling relationship like below, it shows that fb_blank is recursive
called.
det_worker -> fb_blank -> fb_notifier_call_chain -> blocking_notifier_call_chain
-> __blocking_notifier_call_chain -> notifier_call_chain -> fbcon_event_notify
->fbcon_fb_blanked -> do_blank_screen -> fbcon_blank -> fb_blank

To avoid the recursive calling function fb_blank, with the flag set
"FBINFO_MISC_USEREVENT" to fbi as event request to fix this issue.

Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 drivers/video/fsl-sii902x.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/drivers/video/fsl-sii902x.c b/drivers/video/fsl-sii902x.c
index 7b0145f..5adf608 100644
--- a/drivers/video/fsl-sii902x.c
+++ b/drivers/video/fsl-sii902x.c
@@ -295,7 +295,9 @@ static void det_worker(struct work_struct *work)
 
 		/* make sure fb is powerdown */
 		console_lock();
+		fbi->flags |= FBINFO_MISC_USEREVENT;
 		fb_blank(fbi, FB_BLANK_POWERDOWN);
+		fbi->flags &= ~FBINFO_MISC_USEREVENT;
 		console_unlock();
 
 		if (monspecs->modedb_len > 0) {
@@ -328,13 +330,17 @@ static void det_worker(struct work_struct *work)
 		}
 
 		console_lock();
+		fbi->flags |= FBINFO_MISC_USEREVENT;
 		fb_blank(fbi, FB_BLANK_UNBLANK);
+		fbi->flags &= ~FBINFO_MISC_USEREVENT;
 		console_unlock();
 	} else {
 		sii902x->cable_plugin = 0;
 		sprintf(event_string, "EVENT=plugout");
 		console_lock();
+		fbi->flags |= FBINFO_MISC_USEREVENT;
 		fb_blank(fbi, FB_BLANK_POWERDOWN);
+		fbi->flags &= ~FBINFO_MISC_USEREVENT;
 		console_unlock();
 	}
 	kobject_uevent_env(&sii902x->client->dev.kobj,
-- 
1.7.5.4

