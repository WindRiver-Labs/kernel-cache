From 9ecec97c90f7b25d756f70259cdb252f4589f248 Mon Sep 17 00:00:00 2001
From: Bin Jiang <bin.jiang@windriver.com>
Date: Tue, 18 Feb 2014 15:17:09 +0800
Subject: [PATCH] uio: align uio memory region

The uio memory region should be at page boundaries in order for
user mmap() to work. The region size is rounded to a multiple of
PAGE_SIZE.

Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 drivers/uio/uio.c | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/drivers/uio/uio.c b/drivers/uio/uio.c
index a7647da..d207488 100644
--- a/drivers/uio/uio.c
+++ b/drivers/uio/uio.c
@@ -801,6 +801,22 @@ static void release_uio_class(void)
 	uio_major_cleanup();
 }
 
+static void uio_mem_region_align(struct uio_info *info)
+{
+	int mi;
+	struct uio_mem *mem;
+
+	for (mi = 0; mi < MAX_UIO_MAPS; mi++) {
+		mem = &info->mem[mi];
+		if (mem->size == 0)
+			break;
+		if (mem->memtype == UIO_MEM_PHYS) {
+			mem->addr = mem->addr & PAGE_MASK;
+			mem->size = PAGE_ALIGN(mem->size);
+		}
+	}
+}
+
 /**
  * uio_register_device - register a new userspace IO device
  * @owner:	module that creates the new device
@@ -819,6 +835,8 @@ int __uio_register_device(struct module *owner,
 	if (!parent || !info || !info->name || !info->version)
 		return -EINVAL;
 
+	uio_mem_region_align(info);
+
 	info->uio_dev = NULL;
 
 	idev = devm_kzalloc(parent, sizeof(*idev), GFP_KERNEL);
-- 
1.8.5.2.233.g932f7e4

