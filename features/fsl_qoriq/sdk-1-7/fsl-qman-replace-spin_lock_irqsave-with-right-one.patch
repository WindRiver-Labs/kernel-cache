From 7be290b4b435f72825d5fa5aa5f98dd6ba512d9f Mon Sep 17 00:00:00 2001
From: "yadi.hu@windriver.com" <yadi.hu@windriver.com>
Date: Wed, 21 Oct 2015 17:20:48 +0800
Subject: [PATCH] fsl qman:replace spin_lock_irqsave with right one

it is wrong to to use spin_lock_irqsave since irq status is actually
not saved and thus incorrect to restore it. in order to disable
interrupt, it is enough to just use spin_lock_irq routine.

Signed-off-by: Hu <yadi.hu@windriver.com>
---
 drivers/staging/fsl_qbman/qman_config.c |    5 ++---
 drivers/staging/fsl_qbman/qman_high.c   |    8 ++++----
 include/linux/fsl_qman.h                |    4 ++--
 3 files changed, 8 insertions(+), 9 deletions(-)

diff --git a/drivers/staging/fsl_qbman/qman_config.c b/drivers/staging/fsl_qbman/qman_config.c
index caf1089..127cc35 100644
--- a/drivers/staging/fsl_qbman/qman_config.c
+++ b/drivers/staging/fsl_qbman/qman_config.c
@@ -1125,12 +1125,11 @@ void of_fsl_qman_shutdown(struct platform_device *ofdev)
 {
 	int cpu;
 	struct qman_portal *p;
-	unsigned long irqflags __maybe_unused; 
 	for_each_online_cpu(cpu) {
 		p = per_cpu_affine_portal(cpu);
-		qman_portal_lock(p,irqflags);
+		qman_portal_lock(p);
 		qman_static_dequeue_del_ex(p, ~0);
-		qman_portal_unlock(p,irqflags);
+		qman_portal_unlock(p);
 	}
 	return;
 };
diff --git a/drivers/staging/fsl_qbman/qman_high.c b/drivers/staging/fsl_qbman/qman_high.c
index 3978a05..fd5feb1 100644
--- a/drivers/staging/fsl_qbman/qman_high.c
+++ b/drivers/staging/fsl_qbman/qman_high.c
@@ -420,16 +420,16 @@ static int qm_drain_dqrr(struct qm_portal *p)
 	return 0;
 }
 
-int qman_portal_lock(struct qman_portal *p,unsigned long irqflags)
+int qman_portal_lock(struct qman_portal *p)
 {
-    spin_lock_irqsave(&p->cgr_lock, irqflags);
+    spin_lock_irq(&p->cgr_lock);
     return 0;
 
 }
 
-int qman_portal_unlock(struct qman_portal *p,unsigned long irqflags)
+int qman_portal_unlock(struct qman_portal *p)
 {
-    spin_unlock_irqrestore(&p->cgr_lock, irqflags);
+    spin_unlock_irq(&p->cgr_lock);
     return 0;
 } 
 
diff --git a/include/linux/fsl_qman.h b/include/linux/fsl_qman.h
index 0b9d5be..4a004f7 100644
--- a/include/linux/fsl_qman.h
+++ b/include/linux/fsl_qman.h
@@ -1777,8 +1777,8 @@ struct qman_portal *per_cpu_affine_portal(int cpu);
 
 #if defined(CONFIG_KEXEC)
 
-int qman_portal_lock(struct qman_portal *p,unsigned long irqflags);
-int qman_portal_unlock(struct qman_portal *p,unsigned long irqflags) ;
+int qman_portal_lock(struct qman_portal *p);
+int qman_portal_unlock(struct qman_portal *p) ;
 #endif
 
 /**
-- 
1.7.5.4

