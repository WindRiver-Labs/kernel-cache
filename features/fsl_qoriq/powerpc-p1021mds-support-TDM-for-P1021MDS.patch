From d418933851477ef0c9f3e302e84ec2e9601e1f36 Mon Sep 17 00:00:00 2001
From: Wei Yang <Wei.Yang@windriver.com>
Date: Tue, 19 Mar 2013 17:38:49 +0800
Subject: [PATCH 12/21] powerpc/p1021mds: support TDM for P1021MDS

set bcsr and PMUXCR register to support TDM for P1021MDS

Signed-off-by: Wei Yang <Wei.Yang@windriver.com>
---
 arch/powerpc/platforms/85xx/mpc85xx_mds.c |   34 +++++++++++++++++++++++++++++
 1 files changed, 34 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/mpc85xx_mds.c b/arch/powerpc/platforms/85xx/mpc85xx_mds.c
index 2a469ab..ce7c615 100644
--- a/arch/powerpc/platforms/85xx/mpc85xx_mds.c
+++ b/arch/powerpc/platforms/85xx/mpc85xx_mds.c
@@ -228,9 +228,25 @@ static void __init mpc85xx_mds_reset_ucc_phys(void)
 		}
 	} else if (machine_is(p1021_mds)) {
 #define BCSR11_ENET_MICRST     (0x1 << 5)
+#define BCSR6_1588_TDMA         (0x1 << 7)
+#define BCSR6_UPC_EN            (0x1 << 4)
+#define BCSR6_TDMB_ENET1        (0x1)
+#define BCSR6_TDMC_NIBBLE       (0x1 << 1)
+#define BCSR6_TDMC_ENET5        (0x1 << 3)
+#define BCSR6_TDMD_UART1        (0x1 << 2)
+
 		/* Reset Micrel PHY */
 		clrbits8(&bcsr_regs[11], BCSR11_ENET_MICRST);
 		setbits8(&bcsr_regs[11], BCSR11_ENET_MICRST);
+#ifdef CONFIG_TDM
+			clrbits8(&bcsr_regs[6], BCSR6_1588_TDMA);
+			setbits8(&bcsr_regs[6], BCSR6_TDMB_ENET1 |
+						BCSR6_UPC_EN);
+			setbits8(&bcsr_regs[6], BCSR6_TDMC_ENET5);
+			clrbits8(&bcsr_regs[6], BCSR6_TDMC_NIBBLE);
+			setbits8(&bcsr_regs[6], BCSR6_TDMD_UART1);
+#endif /* CONFIG_TDM */
+
 #if defined CONFIG_ATM_UCC
 #define BCSR6_LBC_UPC          (0x1 << 5)
 #define BCSR6_UPC_EN           (0x1 << 4)
@@ -297,6 +313,24 @@ static void __init mpc85xx_mds_qe_init(void)
 			 */
 				setbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(0) |
 						  MPC85xx_PMUXCR_QE(3));
+#ifdef CONFIG_TDM
+
+			/* Clear QE12 for releasing the LBCTL */
+			clrbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(12));
+			/* TDMA */
+			setbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(5) |
+					  MPC85xx_PMUXCR_QE(11));
+			/* TDMB */
+			setbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(0) |
+					  MPC85xx_PMUXCR_QE(9));
+			/* TDMC */
+			 setbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(0));
+			/* TDMD */
+			setbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(8) |
+					  MPC85xx_PMUXCR_QE(7));
+
+#endif /* CONFIG_TDM */
+
 #if defined CONFIG_ATM_UCC
 			clrbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(12));
 			clrbits32(&guts->pmuxcr, MPC85xx_PMUXCR_QE(9));
-- 
1.7.0

