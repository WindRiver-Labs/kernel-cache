From af7d2fb7a32002d7562990345eeefc4d9ba76f68 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 5 Mar 2013 18:23:36 +0800
Subject: [PATCH 03/12] powerpc/85xx: release all the secondary cpus in kexec boot

In kexec boot, all the secondary cpus are spinning on a common
spinloop. So we should release them first before invoking
smp_generic_kick_cpu to kick off a specific cpu.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/platforms/85xx/smp.c |   13 ++++++++++---
 1 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/smp.c b/arch/powerpc/platforms/85xx/smp.c
index 066e060..1c7aa50 100644
--- a/arch/powerpc/platforms/85xx/smp.c
+++ b/arch/powerpc/platforms/85xx/smp.c
@@ -278,6 +278,7 @@ static int __cpuinit smp_85xx_kick_cpu(int nr)
 	int ret = 0;
 #if (defined(CONFIG_KEXEC) || defined(CONFIG_CRASH_DUMP)) && !defined(CONFIG_PPC32)
 	unsigned long *ptr;
+	static int secondary_cpus_released;
 #endif
 #ifdef CONFIG_PPC_E500MC
 	struct ccsr_rcpm __iomem *rcpm = guts_regs;
@@ -412,10 +413,16 @@ static int __cpuinit smp_85xx_kick_cpu(int nr)
 #if defined(CONFIG_KEXEC) || defined(CONFIG_CRASH_DUMP)
 	ptr  = (unsigned long *)((unsigned long)&__run_at_kexec);
 	/* We shouldn't access spin_table from the bootloader to up any
-	 * secondary cpu for kexec kernel, and kexec kernel already
-	 * know how to jump to generic_secondary_smp_init.
+	 * secondary cpu for kexec kernel, all secondary cpus are spinning
+	 * on a common spinloop. So we should release them by invoking
+	 * smp_release_cpus
 	 */
-	if (!*ptr) {
+	if (*ptr) {
+		if (!secondary_cpus_released) {
+			smp_release_cpus();
+			secondary_cpus_released = 1;
+		}
+	} else {
 #endif
 	out_be32(&spin_table->addr_h,
 		__pa(*(u64 *)generic_secondary_smp_init) >> 32);
-- 
1.7.0

