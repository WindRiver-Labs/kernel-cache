From 5caa03be10180f4978695bb2c80aea33a4267014 Mon Sep 17 00:00:00 2001
From: Claudiu Manoil <claudiu.manoil@freescale.com>
Date: Thu, 1 Aug 2013 10:07:05 +0300
Subject: [PATCH 06/50] gianfar: Remove unused field grp_id from gfar_priv_grp

commit 84915c646271abc6b87fed0477dc72278fe4f8a3 upstream

grp->grp_id is obsolete. It has no use in the current driver.
Remove it from gfar_priv_grp and put the 'rstat' member
in its place, in the 2nd cache line, as rstat needs fast access.

Also update struct gfar_priv_rx_q.

Signed-off-by: Claudiu Manoil <claudiu.manoil@freescale.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/ethernet/freescale/gianfar.c |    1 -
 drivers/net/ethernet/freescale/gianfar.h |   31 ++++++++---------------------
 2 files changed, 9 insertions(+), 23 deletions(-)

diff --git a/drivers/net/ethernet/freescale/gianfar.c b/drivers/net/ethernet/freescale/gianfar.c
index c735165..5683dd2 100644
--- a/drivers/net/ethernet/freescale/gianfar.c
+++ b/drivers/net/ethernet/freescale/gianfar.c
@@ -708,7 +708,6 @@ static int gfar_parse_group(struct device_node *np,
 			return -EINVAL;
 	}
 
-	grp->grp_id = priv->num_grps;
 	grp->priv = priv;
 	spin_lock_init(&grp->grplock);
 	if (priv->mode == MQ_MG_MODE) {
diff --git a/drivers/net/ethernet/freescale/gianfar.h b/drivers/net/ethernet/freescale/gianfar.h
index 10ccd14..8aba851 100644
--- a/drivers/net/ethernet/freescale/gianfar.h
+++ b/drivers/net/ethernet/freescale/gianfar.h
@@ -1029,7 +1029,7 @@ struct gfar_priv_rx_q {
 	struct	rxbd8 *rx_bd_base;
 	struct	rxbd8 *cur_rx;
 	struct	net_device *dev;
-	struct gfar_priv_napi_rx *napi_rx;
+	struct gfar_priv_grp *grp;
 	struct rx_q_stats stats;
 	u16	skb_currx;
 	u16	qindex;
@@ -1056,34 +1056,21 @@ struct gfar_irqinfo {
  *	@napi: the napi poll function
  *	@priv: back pointer to the priv structure
  *	@regs: the ioremapped register space for this group
- *	@grp_id: group id for this group
  *	@irqinfo: TX/RX/ER irq data for this group
  */
 
-
-struct gfar_priv_napi_rx {
-	struct	napi_struct napi __aligned(SMP_CACHE_BYTES);
-	struct gfar_priv_grp *grp;
+struct gfar_priv_grp {
+	spinlock_t grplock __attribute__ ((aligned (SMP_CACHE_BYTES)));
+	struct	napi_struct napi;
+	struct gfar_private *priv;
+	struct gfar __iomem *regs;
+	unsigned int rstat;
 	unsigned long num_rx_queues;
 	unsigned long rx_bit_map;
-	unsigned int rstat;
-};
-
-struct gfar_priv_napi_tx {
-	struct	napi_struct napi __aligned(SMP_CACHE_BYTES);
-	struct gfar_priv_grp *grp;
+	/* cacheline 3 */
+	unsigned int tstat;
 	unsigned long num_tx_queues;
 	unsigned long tx_bit_map;
-	unsigned int tstat;
-};
-
-struct gfar_priv_grp {
-	spinlock_t grplock __aligned(SMP_CACHE_BYTES);
-	struct gfar __iomem *regs;
-	struct gfar_private *priv;
-	struct gfar_priv_napi_rx *napi_rx;
-	struct gfar_priv_napi_tx *napi_tx;
-	unsigned int grp_id;
 
 	struct gfar_irqinfo *irqinfo[GFAR_NUM_IRQS];
 };
-- 
1.7.5.4

