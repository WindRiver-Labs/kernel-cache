From 21e24bd48ff2dbeeba6259038f8f6bb988a0fbca Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Tue, 25 Jun 2013 18:40:35 +0300
Subject: [PATCH 0400/1089] dpaa_eth: free buf_layout on error paths

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

The allocated buf_layout must be freed on all error paths.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
Change-Id: Icf2e68f90c28adcc99fdc56492942f3595033b21
Reviewed-on: http://git.am.freescale.net:8181/3093
Reviewed-by: Sovaiala Cristian-Constantin-B39531 <Cristian.Sovaiala@freescale.com>
Reviewed-by: Radulescu Ruxandra Ioana-B05472 <ruxandra.radulescu@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c        | 1 +
 drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c  | 4 +++-
 drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c | 1 +
 3 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index a534a30..e569fdd 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -3253,6 +3253,7 @@ get_channel_failed:
 		dpa_bp_free(priv, priv->dpa_bp);
 bp_create_failed:
 fq_probe_failed:
+	devm_kfree(dev, buf_layout);
 alloc_failed:
 mac_probe_failed:
 	dev_set_drvdata(dev, NULL);
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
index 1f3e519..21dda6d 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
@@ -132,8 +132,10 @@ static int dpaa_eth_proxy_probe(struct platform_device *_of_dev)
 	if (!err)
 		err = dpa_fq_probe_mac(dev, &proxy_fq_list, &port_fqs, true,
 				       TX);
-	if (err < 0)
+	if (err < 0) {
+		devm_kfree(dev, buf_layout);
 		return err;
+	}
 
 	/* Proxy initializer - Just configures the MAC on behalf of
 	 * another partition.
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
index 2d06be1..76f5e50 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
@@ -771,6 +771,7 @@ get_channel_failed:
 		dpa_bp_free(priv, priv->dpa_bp);
 bp_create_failed:
 fq_probe_failed:
+	devm_kfree(dev, buf_layout);
 alloc_failed:
 mac_probe_failed:
 	dev_set_drvdata(dev, NULL);
-- 
2.0.2

