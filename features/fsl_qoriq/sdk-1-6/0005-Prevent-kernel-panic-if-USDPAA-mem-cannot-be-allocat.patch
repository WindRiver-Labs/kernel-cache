From 3eb729134e017d61ae132fad2a014af00581957e Mon Sep 17 00:00:00 2001
From: Roy Pledge <Roy.Pledge@freescale.com>
Date: Wed, 23 Oct 2013 13:31:50 -0400
Subject: [PATCH 005/466] Prevent kernel panic if USDPAA mem cannot be
 allocated

USDPAA DMA memory is allocated very early in the boot process
using the memblock_alloc functions.  The old function would
call panic() in cases that the allocation would fail, but
no indication would be given on the console since the
drivers were not loaded yet.  This patch changes the function
called so that the panic will not occur and debug info can be
seen in the boot log.

Signed-off-by: Roy Pledge <Roy.Pledge@freescale.com>
Change-Id: I8ebe9eb826973ea8ef6d16ba6fc73512b779ab77
Reviewed-on: http://git.am.freescale.net:8181/5953
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Haiying Wang <Haiying.Wang@freescale.com>
Reviewed-by: Thorpe Geoff-R01361 <Geoff.Thorpe@freescale.com>
Reviewed-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/staging/fsl_qbman/fsl_usdpaa.c |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/drivers/staging/fsl_qbman/fsl_usdpaa.c b/drivers/staging/fsl_qbman/fsl_usdpaa.c
index e3d2d9a..0ec07e2 100644
--- a/drivers/staging/fsl_qbman/fsl_usdpaa.c
+++ b/drivers/staging/fsl_qbman/fsl_usdpaa.c
@@ -1499,7 +1499,9 @@ __init void fsl_usdpaa_init_early(void)
 		phys_size = 0;
 		return;
 	}
-	phys_start = memblock_alloc(phys_size, largest_page_size(phys_size));
+	phys_start = __memblock_alloc_base(phys_size, 
+					   largest_page_size(phys_size),
+					   MEMBLOCK_ALLOC_ACCESSIBLE );
 	if (!phys_start) {
 		pr_err("Failed to reserve USDPAA region (sz:%llx)\n",
 		       phys_size);
-- 
1.7.10.4

