From 73fdd28b260dd76fb518e9d805c7f692935f392b Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 5 Mar 2013 19:42:19 +0800
Subject: [PATCH 11/43] powerpc/fsl_book3e: don't tweak the PIR for the
 secondary thread in kexec boot

In general, we get the physical cpu id by tweaking the PIR register.
But in kexec boot, we already put the physical cpu id into r3, and
tweaking the PIR again will get the wrong value.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/kernel/head_64.S |   25 +++++++++++++++++++------
 1 files changed, 19 insertions(+), 6 deletions(-)

diff --git a/arch/powerpc/kernel/head_64.S b/arch/powerpc/kernel/head_64.S
index 97f47a0..153ff6f 100644
--- a/arch/powerpc/kernel/head_64.S
+++ b/arch/powerpc/kernel/head_64.S
@@ -191,17 +191,30 @@ exception_marker:
 #endif
 
 #ifdef CONFIG_PPC_BOOK3E
+/*
+ * In kexec boot, r3 = this processor's number (physical cpu id).
+ * For normal boot, we have to tweak the PIR to get the physical cpu id.
+*/
 _GLOBAL(fsl_secondary_thread_init)
 BEGIN_FTR_SECTION
 	/* Enable branch prediction */
-	lis     r3,BUCSR_INIT@h
-	ori     r3,r3,BUCSR_INIT@l
-	mtspr   SPRN_BUCSR,r3
+	lis     r4,BUCSR_INIT@h
+	ori     r4,r4,BUCSR_INIT@l
+	mtspr   SPRN_BUCSR,r4
 	isync
 
-	mfspr	r3, SPRN_PIR
-	rlwimi	r3, r3, 30, 2, 30
-	mtspr	SPRN_PIR, r3
+#if defined(CONFIG_KEXEC) || defined(CONFIG_CRASH_DUMP)
+	bl	.relative_toc
+	LOAD_REG_ADDR(r4, __run_at_kexec)
+	ld	r4,0(r4)
+	cmpdi	r4,0
+	bne	1f
+#endif
+	mfspr	r4, SPRN_PIR
+	rlwimi	r4, r4, 30, 2, 30
+	mtspr	SPRN_PIR, r4
+	mr	r3,r4
+1:
 END_FTR_SECTION_IFSET(CPU_FTR_SMT)
 #endif
 
-- 
1.7.5.4

