From 3a2d286788742428dc8eb4c09d001b5d94105ffa Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Wed, 25 Feb 2015 11:02:33 +0800
Subject: [PATCH 6/6] fsl: sata: Call irq_dispose_mapping() only when it is
 the last handler

Call irq_dispose_mapping() only when this is the last handler, else system
would report the below warnings during kexec.

remove_proc_entry: removing non-empty directory 'irq/69', leaking at least 'fsl-sata'
------------[ cut here ]------------
WARNING: at fs/proc/generic.c:562
Modules linked in:
CPU: 0 PID: 729 Comm: kexec Not tainted 3.10.62-ltsi-WR6.0.0.0_standard #193
task: c0000000f7c2e600 ti: c0000000e5374000 task.ti: c0000000e5374000
NIP: c000000000250c44 LR: c000000000250c40 CTR: c0000000005f69d0
REGS: c0000000e5377460 TRAP: 0700   Not tainted  (3.10.62-ltsi-WR6.0.0.0_standard)
MSR: 0000000080029000 <CE,EE,ME>  CR: 24088484  XER: 00000000
SOFTE: 1

GPR00: c000000000250c40 c0000000e53776e0 c0000000012af378 0000000000000055
GPR04: 0000000024088484 0000000000000056 c000000000d02070 c000000015900660
GPR08: c000000000cff378 0000000000000001 000000005263f6f4 0000000000000020
GPR12: 00000000000001e4 c000000001fff000 00000000100f0000 0000000000000001
GPR16: 0000000000000002 0000000000000000 0000000000000000 0000000000000000
GPR20: 0000000000000000 0000000000000000 ffffffffffffffff 0000000000000001
GPR24: 0000000000000002 c000000001551940 c0000000e5377810 c0000000e5377810
GPR28: c0000000f740dbb9 0000000000000002 c0000000f74e1630 c0000000f740db40
NIP [c000000000250c44] .remove_proc_entry+0x244/0x250
LR [c000000000250c40] .remove_proc_entry+0x240/0x250
Call Trace:
[c0000000e53776e0] [c000000000250c40] .remove_proc_entry+0x240/0x250 (unreliable)
[c0000000e53777a0] [c00000000011265c] .unregister_irq_proc+0xdc/0x100
[c0000000e5377840] [c000000000109c54] .free_desc+0x54/0xc0
[c0000000e53778d0] [c000000000109d2c] .irq_free_descs+0x6c/0xe0
[c0000000e5377960] [c0000000001112b8] .irq_dispose_mapping+0x88/0xa0
[c0000000e53779e0] [c0000000005c7270] .sata_fsl_remove+0x70/0xb0
[c0000000e5377a70] [c0000000005791ac] .platform_drv_shutdown+0x3c/0x60
[c0000000e5377af0] [c000000000573728] .device_shutdown+0x128/0x240
[c0000000e5377b90] [c0000000000880b4] .kernel_restart_prepare+0x54/0x70
[c0000000e5377c10] [c0000000000e5cac] .kernel_kexec+0x9c/0xd0
[c0000000e5377c90] [c000000000088404] .SyS_reboot+0x244/0x2d0
[c0000000e5377e30] [c000000000000718] syscall_exit+0x0/0x8c
Instruction dump:
ebe1fff8 4e800020 e8bf0038 3c62ff8d 3c82ff7b 3863e408 3884f2c8 38a50079
7f86e378 38e70079 487ebe9d 60000000 <0fe00000> 4bfffefc 60000000 7c0802a6
---[ end trace 4ad06b7717f604ef ]---

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/ata/sata_fsl.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/drivers/ata/sata_fsl.c b/drivers/ata/sata_fsl.c
index cf7ab97..8666010 100644
--- a/drivers/ata/sata_fsl.c
+++ b/drivers/ata/sata_fsl.c
@@ -1661,7 +1661,11 @@ static int sata_fsl_remove(struct platform_device *ofdev)
 
 	ata_host_detach(host);
 
-	irq_dispose_mapping(host_priv->irq);
+	/* Call irq_dispose_mapping() only when this is the last handler.
+	 * The better check point should be within irq_dispose_mapping().
+	*/
+	if (!irq_to_desc(host_priv->irq)->action)
+		irq_dispose_mapping(host_priv->irq);
 	iounmap(host_priv->hcr_base);
 	kfree(host_priv);
 
-- 
1.7.5.4

