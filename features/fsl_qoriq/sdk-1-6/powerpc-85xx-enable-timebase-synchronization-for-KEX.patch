From 09bf9a15a420f12d356cb624d390992c93dbb3f1 Mon Sep 17 00:00:00 2001
From: Xulin Sun <xulin.sun@windriver.com>
Date: Wed, 30 Oct 2013 16:54:51 +0800
Subject: [PATCH 17/43] powerpc/85xx: enable timebase synchronization for
 KEXEC

timebase synchronization among multiple cores was inhibited during the
booting system state since bootloader done this, but for KEXEC this caused
multiple cores have their separate timebase value and not on the same time line
for SMP to make KEXEC hang for P2020.

Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 arch/powerpc/platforms/85xx/smp.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/smp.c b/arch/powerpc/platforms/85xx/smp.c
index 6ddeb35..df3c98e 100644
--- a/arch/powerpc/platforms/85xx/smp.c
+++ b/arch/powerpc/platforms/85xx/smp.c
@@ -101,9 +101,11 @@ static void __cpuinit mpc85xx_give_timebase(void)
 {
 	unsigned long flags;
 
+#ifndef CONFIG_KEXEC
 	/* only do time base sync when system is running */
 	if (system_state == SYSTEM_BOOTING)
 		return;
+#endif
 	/*
 	 * If the booting thread is not the first thread of the core,
 	 * skip time base sync.
@@ -160,8 +162,10 @@ static void __cpuinit mpc85xx_take_timebase(void)
 {
 	unsigned long flags;
 
+#ifndef CONFIG_KEXEC
 	if (system_state == SYSTEM_BOOTING)
 		return;
+#endif
 
 	if (smt_capable() &&
 		cur_booting_core != cpu_first_thread_sibling(cur_booting_core))
-- 
1.7.5.4

