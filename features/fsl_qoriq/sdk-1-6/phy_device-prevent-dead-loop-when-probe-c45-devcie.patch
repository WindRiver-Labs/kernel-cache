From 498d6b2bd27d42f3b3aab031e5bdb4bd12261f5b Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Fri, 14 Nov 2014 15:17:24 +0800
Subject: [PATCH] phy_device:prevent dead loop when probe c45 devcie

commit 26f3aeb (net/phy: tune get_phy_c45_ids to support more c45 phy,
Shengzhou Liu <Shengzhou.Liu@freescale.com>) allow get_phy_c45_ids()
read device in package with address 0.

get_phy_c45_ids() run as follow:

for (i = 1;
          i < num_ids && c45_ids->devices_in_package == 0;
          i++) {
retry:
         ...
         //read mdio at address i to fill c45_ids->devices_in_package
         ...

         if ((c45_ids->devices_in_package & 0x1fffffff) == 0x1fffffff) {
             if (i) {
                 i = 0;// Probe zero Device
                 goto retry;
             }else {
                 /* no device there, let's get out of here */
                 *phy_id = 0xffffffff;
                 return 0;
             }
         }
}

Normally, it will get a non-zero value when reading
c45_ids->devices_in_package with i=0. Then the loop could break.

When booting second kernel in kexec/kdump, the
c45_ids->devices_in_package gets value 0 when i=0 on T2080RDB.

It lead loop set i=1, and try again, then probe zero device and jump to
retry label. This leads kernel trap in a dead loop.

The patch just force the loop break in above condition.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/net/phy/phy_device.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/net/phy/phy_device.c b/drivers/net/phy/phy_device.c
index 9038bb5..959ca04 100644
--- a/drivers/net/phy/phy_device.c
+++ b/drivers/net/phy/phy_device.c
@@ -240,6 +240,11 @@ retry:		reg_addr = MII_ADDR_C45 | i << 16 | 6;
 			return -EIO;
 		c45_ids->devices_in_package |= (phy_reg & 0xffff);
 
+		if ((i == 0) && (c45_ids->devices_in_package == 0)) {
+			*phy_id = 0xffffffff;
+			return 0;
+		}
+
 		if ((c45_ids->devices_in_package & 0x1fffffff) == 0x1fffffff) {
 			if (i) {
 				/*  If mostly Fs, there is no device there,
-- 
1.7.5.4

