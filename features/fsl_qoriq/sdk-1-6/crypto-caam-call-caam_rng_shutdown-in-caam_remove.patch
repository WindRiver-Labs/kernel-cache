From af158b7ba65c88ef8487b67b8520d759a32a5ba4 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Fri, 13 Feb 2015 13:29:45 +0800
Subject: [PATCH 05/10] crypto: caam: call caam_rng_shutdown in caam_remove

Call caam_rng_shutdown() in caam_remove() to free caam_rng resources.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/crypto/caam/caamrng.c |    7 +++++++
 drivers/crypto/caam/ctrl.c    |    4 ++++
 drivers/crypto/caam/intern.h  |    4 ++++
 3 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/drivers/crypto/caam/caamrng.c b/drivers/crypto/caam/caamrng.c
index 5c6c0e2..4ce2da9 100644
--- a/drivers/crypto/caam/caamrng.c
+++ b/drivers/crypto/caam/caamrng.c
@@ -334,6 +334,13 @@ static int __init caam_rng_init(void)
 	return hwrng_register(&caam_rng);
 }
 
+void caam_rng_shutdown(void)
+{
+	caam_jr_free(rng_ctx->jrdev);
+	hwrng_unregister(&caam_rng);
+	kfree(rng_ctx);
+}
+
 module_init(caam_rng_init);
 module_exit(caam_rng_exit);
 
diff --git a/drivers/crypto/caam/ctrl.c b/drivers/crypto/caam/ctrl.c
index cca7090..e93475d 100644
--- a/drivers/crypto/caam/ctrl.c
+++ b/drivers/crypto/caam/ctrl.c
@@ -273,6 +273,10 @@ static int caam_remove(struct platform_device *pdev)
 	struct caam_full __iomem *topregs;
 	int ring, ret = 0;
 
+#ifdef CONFIG_CRYPTO_DEV_FSL_CAAM_RNG_API
+	caam_rng_shutdown();
+#endif
+
 	ctrldev = &pdev->dev;
 	ctrlpriv = dev_get_drvdata(ctrldev);
 	topregs = (struct caam_full __iomem *)ctrlpriv->ctrl;
diff --git a/drivers/crypto/caam/intern.h b/drivers/crypto/caam/intern.h
index dce2a5e..999b47c 100644
--- a/drivers/crypto/caam/intern.h
+++ b/drivers/crypto/caam/intern.h
@@ -121,4 +121,8 @@ struct caam_drv_private {
 
 void caam_jr_algapi_init(struct device *dev);
 void caam_jr_algapi_remove(struct device *dev);
+
+#ifdef CONFIG_CRYPTO_DEV_FSL_CAAM_RNG_API
+extern void caam_rng_shutdown(void);
+#endif
 #endif /* INTERN_H */
-- 
1.7.5.4

