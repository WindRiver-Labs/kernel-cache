From 1653254882e8ec00626c287de89b8407991f209f Mon Sep 17 00:00:00 2001
From: Jeffrey Ladouceur <Jeffrey.Ladouceur@freescale.com>
Date: Fri, 23 May 2014 11:35:58 -0400
Subject: [PATCH 363/466] fsl_qbman: Fix DCP assignment for version of QMan

For QMan version 3.1.2 the DCE Channel number is different.
QMan contains a cfg revision number which is a direct correlation.
Add this attribute and fix up the dce channel number based on qman revision info.

Signed-off-by: Jeffrey Ladouceur <Jeffrey.Ladouceur@freescale.com>
Change-Id: I0ff79ec01f741fb71caf0a9d4f0a9f3760d64f15
Reviewed-on: http://git.am.freescale.net:8181/12851
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Haiying Wang <Haiying.Wang@freescale.com>
Reviewed-by: Geoff Thorpe <Geoff.Thorpe@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/staging/fsl_qbman/qman_config.c  |   12 ++++++++----
 drivers/staging/fsl_qbman/qman_driver.c  |   11 +++++++++++
 drivers/staging/fsl_qbman/qman_private.h |    7 +++++++
 include/linux/fsl_qman.h                 |    1 +
 4 files changed, 27 insertions(+), 4 deletions(-)

diff --git a/drivers/staging/fsl_qbman/qman_config.c b/drivers/staging/fsl_qbman/qman_config.c
index 2331cdb..a8a857b 100644
--- a/drivers/staging/fsl_qbman/qman_config.c
+++ b/drivers/staging/fsl_qbman/qman_config.c
@@ -340,12 +340,15 @@ static void qm_set_corenet_initiator(struct qman *qm)
 		CONFIG_FSL_QMAN_CI_SCHED_CFG_BMAN_W);
 }
 
-static void qm_get_version(struct qman *qm, u16 *id, u8 *major, u8 *minor)
+static void qm_get_version(struct qman *qm, u16 *id, u8 *major, u8 *minor,
+			u8 *cfg)
 {
 	u32 v = qm_in(IP_REV_1);
+	u32 v2 = qm_in(IP_REV_2);
 	*id = (v >> 16);
 	*major = (v >> 8) & 0xff;
 	*minor = v & 0xff;
+	*cfg = v2 & 0xff;
 }
 
 #if defined(CONFIG_KEXEC) || defined(CONFIG_CRASH_DUMP)
@@ -536,7 +539,7 @@ static int __init fsl_qman_init(struct device_node *node)
 	const char *s;
 	int ret, standby = 0;
 	u16 id;
-	u8 major, minor;
+	u8 major, minor, cfg;
 	ret = of_address_to_resource(node, 0, &res);
 	if (ret) {
 		pr_err("Can't get %s property '%s'\n", node->full_name, "reg");
@@ -561,8 +564,8 @@ static int __init fsl_qman_init(struct device_node *node)
 	}
 	/* Global configuration */
 	qm_node = node;
-	qm_get_version(qm, &id, &major, &minor);
-	pr_info("Qman ver:%04x,%02x,%02x\n", id, major, minor);
+	qm_get_version(qm, &id, &major, &minor, &cfg);
+	pr_info("Qman ver:%04x,%02x,%02x,%02x\n", id, major, minor, cfg);
 	if (!qman_ip_rev) {
 		if ((major == 1) && (minor == 0)) {
 			pr_err("QMAN rev1.0 on P4080 rev1 is not supported!\n");
@@ -582,6 +585,7 @@ static int __init fsl_qman_init(struct device_node *node)
 			pr_warn("unknown Qman version, default to rev1.1\n");
 			qman_ip_rev = QMAN_REV11;
 		}
+		qman_ip_cfg = cfg;
 	}
 
 	/* Unfortunately we have to reserve those memory used for Qman
diff --git a/drivers/staging/fsl_qbman/qman_driver.c b/drivers/staging/fsl_qbman/qman_driver.c
index 36f2aa6..806a7d5 100644
--- a/drivers/staging/fsl_qbman/qman_driver.c
+++ b/drivers/staging/fsl_qbman/qman_driver.c
@@ -40,6 +40,8 @@
  * where CCSR isn't available) */
 u16 qman_ip_rev;
 EXPORT_SYMBOL(qman_ip_rev);
+u8 qman_ip_cfg;
+EXPORT_SYMBOL(qman_ip_cfg);
 u16 qm_channel_pool1 = QMAN_CHANNEL_POOL1;
 EXPORT_SYMBOL(qm_channel_pool1);
 u16 qm_channel_caam = QMAN_CHANNEL_CAAM;
@@ -291,6 +293,7 @@ static __init int fsl_ceetm_init(struct device_node *node)
 static void qman_get_ip_revision(struct device_node *dn)
 {
 	u16 ip_rev = 0;
+	u8 ip_cfg = QMAN_REV_CFG_0;
 	for_each_compatible_node(dn, NULL, "fsl,qman-portal") {
 		if (!of_device_is_available(dn))
 			continue;
@@ -318,6 +321,7 @@ static void qman_get_ip_revision(struct device_node *dn)
 						"fsl,qman-portal-3.0.1")) {
 			ip_rev = QMAN_REV30;
 			qman_portal_max = 25;
+			ip_cfg = QMAN_REV_CFG_1;
 		} else if (of_device_is_compatible(dn,
 						"fsl,qman-portal-3.1.0")) {
 			ip_rev = QMAN_REV31;
@@ -326,14 +330,17 @@ static void qman_get_ip_revision(struct device_node *dn)
 						"fsl,qman-portal-3.1.1")) {
 			ip_rev = QMAN_REV31;
 			qman_portal_max = 25;
+			ip_cfg = QMAN_REV_CFG_1;
 		} else if (of_device_is_compatible(dn,
 						"fsl,qman-portal-3.1.2")) {
 			ip_rev = QMAN_REV31;
 			qman_portal_max = 18;
+			ip_cfg = QMAN_REV_CFG_2;
 		} else if (of_device_is_compatible(dn,
 						"fsl,qman-portal-3.1.3")) {
 			ip_rev = QMAN_REV31;
 			qman_portal_max = 10;
+			ip_cfg = QMAN_REV_CFG_3;
 		} else {
 			pr_warn("unknown QMan version in portal node,"
 				"default to rev1.1\n");
@@ -344,10 +351,12 @@ static void qman_get_ip_revision(struct device_node *dn)
 		if (!qman_ip_rev) {
 			if (ip_rev) {
 				qman_ip_rev = ip_rev;
+				qman_ip_cfg = ip_cfg;
 			} else {
 				pr_warn("unknown Qman version,"
 					" default to rev1.1\n");
 				qman_ip_rev = QMAN_REV11;
+				qman_ip_cfg = QMAN_REV_CFG_0;
 			}
 		} else if (ip_rev && (qman_ip_rev != ip_rev))
 			pr_warn("Revision=0x%04x, but portal '%s' has"
@@ -763,6 +772,8 @@ __init int qman_init(void)
 		qm_channel_caam = QMAN_CHANNEL_CAAM_REV3;
 		qm_channel_pme = QMAN_CHANNEL_PME_REV3;
 	}
+	if ((qman_ip_rev == QMAN_REV31) && (qman_ip_cfg == QMAN_REV_CFG_2))
+		qm_channel_dce = QMAN_CHANNEL_DCE_QMANREV312;
 
 	/*
 	 * Parse the ceetm node to get how many ceetm instances are supported
diff --git a/drivers/staging/fsl_qbman/qman_private.h b/drivers/staging/fsl_qbman/qman_private.h
index 0fbe573..a6bef0c7 100644
--- a/drivers/staging/fsl_qbman/qman_private.h
+++ b/drivers/staging/fsl_qbman/qman_private.h
@@ -192,7 +192,14 @@ struct qm_portal_config {
 #define QMAN_REV20 0x0200
 #define QMAN_REV30 0x0300
 #define QMAN_REV31 0x0301
+/* QMan REV_2 register contains the Cfg option */
+#define QMAN_REV_CFG_0 0x0
+#define QMAN_REV_CFG_1 0x1
+#define QMAN_REV_CFG_2 0x2
+#define QMAN_REV_CFG_3 0x3
+
 extern u16 qman_ip_rev; /* 0 if uninitialised, otherwise QMAN_REVx */
+extern u8 qman_ip_cfg;
 extern u32 qman_clk;
 extern u16 qman_portal_max;
 
diff --git a/include/linux/fsl_qman.h b/include/linux/fsl_qman.h
index b1a54e7..f6491c9 100644
--- a/include/linux/fsl_qman.h
+++ b/include/linux/fsl_qman.h
@@ -47,6 +47,7 @@ extern "C" {
 #define QMAN_CHANNEL_CAAM_REV3 0x840
 #define QMAN_CHANNEL_PME_REV3 0x860
 #define QMAN_CHANNEL_DCE 0x8a0
+#define QMAN_CHANNEL_DCE_QMANREV312 0x880
 extern u16 qm_channel_pool1;
 extern u16 qm_channel_caam;
 extern u16 qm_channel_pme;
-- 
1.7.10.4

