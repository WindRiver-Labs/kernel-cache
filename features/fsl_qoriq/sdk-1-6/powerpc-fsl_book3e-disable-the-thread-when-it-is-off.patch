From 282602ad7d2aed99a5c9bb3735c2de079ca24449 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Mon, 25 Mar 2013 10:05:31 +0800
Subject: [PATCH 41/43] powerpc/fsl_book3e: disable the thread when it is
 offline

When a thread is offline, we should disable it instead of spin here.
This should improve the performance of other threads which is still
running.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/platforms/85xx/smp.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/smp.c b/arch/powerpc/platforms/85xx/smp.c
index 3cef4eb..eedabd5 100644
--- a/arch/powerpc/platforms/85xx/smp.c
+++ b/arch/powerpc/platforms/85xx/smp.c
@@ -220,6 +220,13 @@ static void __cpuinit smp_85xx_mach_cpu_die(void)
 	if (is_core_down(cpu))
 		qoriq_pm_ops->cpu_enter_state(cpu, qoriq_cpu_die_state);
 
+	if (cpu_has_feature(CPU_FTR_SMT)) {
+		cpu = cpu_thread_in_core(cpu);
+		cpu = 1 << cpu;
+		mb();
+		mtspr(SPRN_TENC, cpu);
+	}
+
 	while (1)
 		;
 }
-- 
1.7.5.4

