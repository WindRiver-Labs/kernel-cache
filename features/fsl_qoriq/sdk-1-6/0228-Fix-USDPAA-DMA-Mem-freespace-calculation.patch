From fc7f0390cf7eac1a8bbffcda4a18c29172effce4 Mon Sep 17 00:00:00 2001
From: Roy Pledge <Roy.Pledge@freescale.com>
Date: Mon, 31 Mar 2014 13:49:28 -0400
Subject: [PATCH 228/466] Fix USDPAA DMA Mem freespace calculation

The USDPAA DMA freespace calculation should only count
segments with a reference count of zero as free

Signed-off-by: Roy Pledge <Roy.Pledge@freescale.com>
Change-Id: Ib8752f8ad6cb4179b371b6480f47e84033260efe
Reviewed-on: http://git.am.freescale.net:8181/10526
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Geoff Thorpe <Geoff.Thorpe@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/staging/fsl_qbman/fsl_usdpaa.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/staging/fsl_qbman/fsl_usdpaa.c b/drivers/staging/fsl_qbman/fsl_usdpaa.c
index 006360b..96d8f08 100644
--- a/drivers/staging/fsl_qbman/fsl_usdpaa.c
+++ b/drivers/staging/fsl_qbman/fsl_usdpaa.c
@@ -1061,7 +1061,8 @@ static long ioctl_dma_stats(struct ctx *ctx, void __user *arg)
 	result.total_bytes = phys_size;
 
 	list_for_each_entry(frag, &mem_list, list) {
-		result.free_bytes += frag->len;
+		if (frag->refs == 0)
+			result.free_bytes += frag->len;
 	}
 
 	return copy_to_user(arg, &result, sizeof(result)); }
-- 
1.7.10.4

