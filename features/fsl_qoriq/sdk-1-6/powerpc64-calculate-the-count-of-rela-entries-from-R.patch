From 3485de2c59ce5ee7396bd25730787854fe386c94 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Thu, 28 Nov 2013 12:45:09 +0800
Subject: [PATCH 15/43] powerpc64: calculate the count of rela entries from
 RELASZ and RELAENT

In the current kernel, we get the rela entries count from the
RELACOUNT entry in the dynamic table. But this entry only count for
the R_PPC64_RELATIVE relocation type. So it will not work if there are
other relocation types in the .rela.dyn section. We choose to calculate
the real count of rela entries by using the RELASZ and RELAENT entries
in the dynamic table.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/reloc_64.S |   18 +++++++++++++-----
 1 files changed, 13 insertions(+), 5 deletions(-)

diff --git a/arch/powerpc/kernel/reloc_64.S b/arch/powerpc/kernel/reloc_64.S
index d88736f..e373cf1 100644
--- a/arch/powerpc/kernel/reloc_64.S
+++ b/arch/powerpc/kernel/reloc_64.S
@@ -12,7 +12,8 @@
 #include <asm/ppc_asm.h>
 
 RELA = 7
-RELACOUNT = 0x6ffffff9
+RELASZ = 8
+RELAENT = 9
 R_PPC64_RELATIVE = 22
 
 /*
@@ -35,23 +36,30 @@ _GLOBAL(relocate)
 	 */
 	li	r7,0
 	li	r8,0
+	li	r4,0
 1:	ld	r6,0(r11)	/* get tag */
 	cmpdi	r6,0
 	beq	4f		/* end of list */
 	cmpdi	r6,RELA
-	bne	2f
+	bne	relasz
 	ld	r7,8(r11)	/* get RELA pointer in r7 */
 	b	3f
-2:	addis	r6,r6,(-RELACOUNT)@ha
-	cmpdi	r6,RELACOUNT@l
+relasz:	cmpdi	r6,RELASZ
+	bne	relaent
+	ld	r8,8(r11)	/* get RELASZ in r8 */
+	b	3f
+relaent:cmpdi	r6,RELAENT
 	bne	3f
-	ld	r8,8(r11)	/* get RELACOUNT value in r8 */
+	ld	r4,8(r11)	/* get RELAENT value in r4 */
 3:	addi	r11,r11,16
 	b	1b
 4:	cmpdi	r7,0		/* check we have both RELA and RELACOUNT */
 	cmpdi	cr1,r8,0
+	cmpdi	cr5,r4,0
 	beq	6f
 	beq	cr1,6f
+	beq	cr5,6f
+	divd	r8,r8,r4	/* RELA count */
 
 	/*
 	 * Work out linktime address of _stext and hence the
-- 
1.7.5.4

