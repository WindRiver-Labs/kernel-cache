From a9b6e443878d636792c4728c71ab0f40137163fe Mon Sep 17 00:00:00 2001
From: Wang Dongsheng <dongsheng.wang@freescale.com>
Date: Fri, 25 Apr 2014 13:28:18 +0800
Subject: [PATCH 393/466] fsl/pm: add api to get suspend state which is
 STANDBY or MEM

Add set_pm_suspend_state & pm_suspend_state functions to set/get
suspend state. When system going to sleep or deep sleep, devices
can get the system suspend state(STANDBY/MEM) through pm_suspend_state
function and to handle different situations.

Signed-off-by: Wang Dongsheng <dongsheng.wang@freescale.com>
Change-Id: Ibd369079f6f0777854d88d7e1af21f455eaf909e
Reviewed-on: http://git.am.freescale.net:8181/11530
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Yang Li <LeoLi@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/include/asm/fsl_pm.h      |    6 ++++++
 arch/powerpc/kernel/Makefile           |    1 +
 arch/powerpc/kernel/fsl_pm.c           |   26 ++++++++++++++++++++++++++
 arch/powerpc/platforms/85xx/common.c   |   13 -------------
 arch/powerpc/platforms/85xx/qoriq_pm.c |    5 +++++
 arch/powerpc/sysdev/fsl_pmc.c          |    7 ++++---
 6 files changed, 42 insertions(+), 16 deletions(-)
 create mode 100644 arch/powerpc/kernel/fsl_pm.c

diff --git a/arch/powerpc/include/asm/fsl_pm.h b/arch/powerpc/include/asm/fsl_pm.h
index d06adaa..bcdc018 100644
--- a/arch/powerpc/include/asm/fsl_pm.h
+++ b/arch/powerpc/include/asm/fsl_pm.h
@@ -13,6 +13,8 @@
 #ifdef	__KERNEL__
 
 #ifndef __ASSEMBLY__
+#include <linux/suspend.h>
+
 #define E500_PM_PH10	1
 #define E500_PM_PH15	2
 #define E500_PM_PH20	3
@@ -47,6 +49,10 @@ extern int fsl_enter_epu_deepsleep(void);
 extern void fsl_dp_enter_low(void __iomem *ccsr_base, void __iomem *dcsr_base,
 			     void __iomem *pld_base, int pld_flag);
 extern void fsl_booke_deep_sleep_resume(void);
+
+void set_pm_suspend_state(suspend_state_t state);
+suspend_state_t pm_suspend_state(void);
+
 #endif	/* __ASSEMBLY__ */
 
 #define T1040QDS_TETRA_FLAG	1
diff --git a/arch/powerpc/kernel/Makefile b/arch/powerpc/kernel/Makefile
index 4abfca3..777dc9d 100644
--- a/arch/powerpc/kernel/Makefile
+++ b/arch/powerpc/kernel/Makefile
@@ -61,6 +61,7 @@ obj-$(CONFIG_IBMEBUS)           += ibmebus.o
 obj-$(CONFIG_GENERIC_TBSYNC)	+= smp-tbsync.o
 obj-$(CONFIG_CRASH_DUMP)	+= crash_dump.o
 obj-$(CONFIG_FA_DUMP)		+= fadump.o
+obj-$(CONFIG_FSL_SOC)		+= fsl_pm.o
 ifeq ($(CONFIG_PPC32),y)
 obj-$(CONFIG_E500)		+= idle_e500.o
 endif
diff --git a/arch/powerpc/kernel/fsl_pm.c b/arch/powerpc/kernel/fsl_pm.c
new file mode 100644
index 0000000..1d19b85
--- /dev/null
+++ b/arch/powerpc/kernel/fsl_pm.c
@@ -0,0 +1,26 @@
+/*
+ * Freescale General Power Management Implementation
+ *
+ * Copyright 2014 Freescale Semiconductor, Inc.
+ * Author: Wang Dongsheng <dongsheng.wang@freescale.com>
+ *
+ * This program is free software; you can redistribute it and/or modify it
+ * under the terms of the GNU General Public License as published by the
+ * Free Software Foundation; either version 2 of the License, or (at your
+ * option) any later version.
+ */
+
+#include <linux/suspend.h>
+#include <asm/fsl_pm.h>
+
+static suspend_state_t pm_state;
+
+void set_pm_suspend_state(suspend_state_t state)
+{
+	pm_state = state;
+}
+
+suspend_state_t pm_suspend_state(void)
+{
+	return pm_state;
+}
diff --git a/arch/powerpc/platforms/85xx/common.c b/arch/powerpc/platforms/85xx/common.c
index f5c0f36..cad5a22 100644
--- a/arch/powerpc/platforms/85xx/common.c
+++ b/arch/powerpc/platforms/85xx/common.c
@@ -6,7 +6,6 @@
  * published by the Free Software Foundation.
  */
 #include <linux/of_platform.h>
-#include <linux/suspend.h>
 
 #include <asm/qe.h>
 #include <sysdev/cpm2_pic.h>
@@ -49,18 +48,6 @@ int __init mpc85xx_common_publish_devices(void)
 	return of_platform_bus_probe(NULL, mpc85xx_common_ids, NULL);
 }
 
-static suspend_state_t pm_state;
-
-void set_pm_suspend_state(suspend_state_t state)
-{
-	pm_state = state;
-}
-
-suspend_state_t pm_suspend_state(void)
-{
-	return pm_state;
-}
-
 #ifdef CONFIG_CPM2
 static void cpm2_cascade(unsigned int irq, struct irq_desc *desc)
 {
diff --git a/arch/powerpc/platforms/85xx/qoriq_pm.c b/arch/powerpc/platforms/85xx/qoriq_pm.c
index 4578a63..9f656e9 100644
--- a/arch/powerpc/platforms/85xx/qoriq_pm.c
+++ b/arch/powerpc/platforms/85xx/qoriq_pm.c
@@ -79,12 +79,15 @@ static int qoriq_suspend_enter(suspend_state_t state)
 
 static int qoriq_suspend_valid(suspend_state_t state)
 {
+	set_pm_suspend_state(state);
+
 	if (state == PM_SUSPEND_STANDBY && (sleep_modes & FSL_SLEEP))
 		return 1;
 
 	if (state == PM_SUSPEND_MEM && (sleep_modes & FSL_DEEP_SLEEP))
 		return 1;
 
+	set_pm_suspend_state(PM_SUSPEND_ON);
 	return 0;
 }
 
@@ -100,6 +103,7 @@ static int qoriq_suspend_begin(suspend_state_t state)
 
 static void qoriq_suspend_end(void)
 {
+	set_pm_suspend_state(PM_SUSPEND_ON);
 	fsl_dp_iounmap();
 }
 
@@ -128,6 +132,7 @@ static int __init qoriq_suspend_init(void)
 	}
 
 	suspend_set_ops(&qoriq_suspend_ops);
+	set_pm_suspend_state(PM_SUSPEND_ON);
 
 	return 0;
 }
diff --git a/arch/powerpc/sysdev/fsl_pmc.c b/arch/powerpc/sysdev/fsl_pmc.c
index 778cf6f..92454ce 100644
--- a/arch/powerpc/sysdev/fsl_pmc.c
+++ b/arch/powerpc/sysdev/fsl_pmc.c
@@ -22,7 +22,7 @@
 #include <linux/device.h>
 #include <linux/of_platform.h>
 #include <linux/pm.h>
-
+#include <asm/fsl_pm.h>
 #include <asm/switch_to.h>
 #include <asm/cacheflush.h>
 
@@ -165,14 +165,15 @@ static int pmc_suspend_enter(suspend_state_t state)
 
 static int pmc_suspend_valid(suspend_state_t state)
 {
+	set_pm_suspend_state(state);
 	if (((pmc_flag & PMC_SLEEP) && (state == PM_SUSPEND_STANDBY)) ||
 	    ((pmc_flag & PMC_DEEP_SLEEP) && (state == PM_SUSPEND_MEM))) {
 		set_pm_suspend_state(state);
 
 		return 1;
 	}
-	else
-		return 0;
+	set_pm_suspend_state(PM_SUSPEND_ON);
+	return 0
 }
 
 static void pmc_suspend_end(void)
-- 
1.7.10.4

