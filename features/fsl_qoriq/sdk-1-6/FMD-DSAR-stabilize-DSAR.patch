From fc83d16169b69039c73449ad23b7821a0b4c5baf Mon Sep 17 00:00:00 2001
From: Eyal Harari <Eyal.Harari@freesacle.com>
Date: Wed, 28 May 2014 18:35:34 +0300
Subject: [PATCH 1067/1089] FMD: DSAR: stabilize DSAR

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

Signed-off-by: Eyal Harari <Eyal.Harari@freesacle.com>
Change-Id: Ica2eaeb13ecd0a2ad3084ad427a3e2f2da86b21f
Reviewed-on: http://git.am.freescale.net:8181/13019
Reviewed-by: Mandy Lavi <Mandy.Lavi@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
Tested-by: Jose Rivera <German.Rivera@freescale.com>
---
 .../freescale/fman/Peripherals/FM/Port/fm_port.c      | 19 ++++++++-----------
 .../net/ethernet/freescale/fman/Peripherals/FM/fm.c   |  2 +-
 2 files changed, 9 insertions(+), 12 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fman/Peripherals/FM/Port/fm_port.c b/drivers/net/ethernet/freescale/fman/Peripherals/FM/Port/fm_port.c
index df05848..7359001 100644
--- a/drivers/net/ethernet/freescale/fman/Peripherals/FM/Port/fm_port.c
+++ b/drivers/net/ethernet/freescale/fman/Peripherals/FM/Port/fm_port.c
@@ -5799,9 +5799,10 @@ void FM_PORT_Dsar_enter_final(void)
 	// Issue graceful stop to HC port
 	FM_PORT_Disable(opXX);
 
-	// config auto response	
+	// config tx port
     p_FmPort->deepSleepVars.fmbm_tcfg = GET_UINT32(p_FmPortTx->p_FmPortBmiRegs->txPortBmiRegs.fmbm_tcfg);
-    WRITE_UINT32(p_FmPortTx->p_FmPortBmiRegs->txPortBmiRegs.fmbm_tcfg, GET_UINT32(p_FmPortTx->p_FmPortBmiRegs->txPortBmiRegs.fmbm_tcfg) | BMI_PORT_CFG_IM);
+    WRITE_UINT32(p_FmPortTx->p_FmPortBmiRegs->txPortBmiRegs.fmbm_tfdne, 0x005000C0);
+    WRITE_UINT32(p_FmPortTx->p_FmPortBmiRegs->txPortBmiRegs.fmbm_tcfg, GET_UINT32(p_FmPortTx->p_FmPortBmiRegs->txPortBmiRegs.fmbm_tcfg) | BMI_PORT_CFG_IM | BMI_PORT_CFG_EN);
     // ????
     p_FmPort->deepSleepVars.fmbm_tcmne = GET_UINT32(p_FmPortTx->p_FmPortBmiRegs->txPortBmiRegs.fmbm_tcmne);
     WRITE_UINT32(p_FmPortTx->p_FmPortBmiRegs->txPortBmiRegs.fmbm_tcmne, 0xE);
@@ -5834,23 +5835,19 @@ void FM_PORT_Dsar_enter_final(void)
 	if (fmGetSetParams.getParams.fmfp_extc != 0)
 	{
 		// clear
-		XX_Print("FM: Sync did not finish 0\n");
 		memset(&fmGetSetParams, 0, sizeof (t_FmGetSetParams));
 		fmGetSetParams.setParams.type = UPDATE_FPM_EXTC_CLEAR;
 		FmGetSetParams(p_FmPort->h_Fm, &fmGetSetParams);
 	}
 
-	// get
 	memset(&fmGetSetParams, 0, sizeof (t_FmGetSetParams));
-	fmGetSetParams.getParams.type = GET_FMFP_EXTC;
-	FmGetSetParams(p_FmPort->h_Fm, &fmGetSetParams);
-	while (fmGetSetParams.getParams.fmfp_extc != 0)
+	fmGetSetParams.getParams.type = GET_FMFP_EXTC | GET_FM_NPI;
+	do
 	{
-		// get
-		memset(&fmGetSetParams, 0, sizeof (t_FmGetSetParams));
-		fmGetSetParams.getParams.type = GET_FMFP_EXTC;
 		FmGetSetParams(p_FmPort->h_Fm, &fmGetSetParams);
-	}
+	} while (fmGetSetParams.getParams.fmfp_extc != 0 && fmGetSetParams.getParams.fm_npi == 0);
+	if (fmGetSetParams.getParams.fm_npi != 0)
+		XX_Print("FM: Sync did not finish\n");
 
         // check that all stoped
 	memset(&fmGetSetParams, 0, sizeof (t_FmGetSetParams));
diff --git a/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c b/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c
index 3f569b8..ccb6042 100644
--- a/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c
+++ b/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c
@@ -4189,7 +4189,7 @@ t_Error FmGetSetParams(t_Handle h_Fm, t_FmGetSetParams *p_Params)
 	if (p_Params->setParams.type & UPDATE_FPM_EXTC)
 		WRITE_UINT32(p_Fm->p_FmFpmRegs->fmfp_extc,0x80000000);
 	if (p_Params->setParams.type & UPDATE_FPM_EXTC_CLEAR)
-		WRITE_UINT32(p_Fm->p_FmFpmRegs->fmfp_extc,0x08000000);
+		WRITE_UINT32(p_Fm->p_FmFpmRegs->fmfp_extc,0x00800000);
 	if (p_Params->setParams.type & UPDATE_FPM_BRKC_SLP)
 	{	
 		if (p_Params->setParams.sleep)
-- 
2.0.2

