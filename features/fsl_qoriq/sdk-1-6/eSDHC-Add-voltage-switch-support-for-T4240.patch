From e21c2791984265cb1514423dd7dde4de88f133dd Mon Sep 17 00:00:00 2001
From: "Lu.Jiang" <lu.jiang@windriver.com>
Date: Thu, 4 Sep 2014 17:17:36 +0800
Subject: [PATCH 0141/1089] eSDHC: Add voltage switch support for T4240

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

eSDHC host don't support voltage switch on and switch off.
So disable power on and power off.
Only T4240 can change voltage between 1.8v and 3.3v. So add
this function support.

Signed-off-by: Haijun Zhang <haijun.zhang@freescale.com>
Change-Id: I9d644777b5d66d2b44d2055bcd442b6738386bb9
Reviewed-on: http://git.am.freescale.net:8181/1091
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Signed-off-by: Lu.Jiang <lu.jiang@windriver.com>
---
 drivers/mmc/host/sdhci-esdhc.h    |  1 +
 drivers/mmc/host/sdhci-of-esdhc.c | 17 +++++++++++++++++
 2 files changed, 18 insertions(+)

diff --git a/drivers/mmc/host/sdhci-esdhc.h b/drivers/mmc/host/sdhci-esdhc.h
index 44ac739..658308e 100644
--- a/drivers/mmc/host/sdhci-esdhc.h
+++ b/drivers/mmc/host/sdhci-esdhc.h
@@ -49,5 +49,6 @@
 #define ESDHC_DMA_SNOOP		0x00000040
 
 #define ESDHC_HOST_CONTROL_RES	0x01
+#define ESDHC_VOL_SEL		0x04
 
 #endif /* _DRIVERS_MMC_SDHCI_ESDHC_H */
diff --git a/drivers/mmc/host/sdhci-of-esdhc.c b/drivers/mmc/host/sdhci-of-esdhc.c
index 8209b26..951c9fb 100644
--- a/drivers/mmc/host/sdhci-of-esdhc.c
+++ b/drivers/mmc/host/sdhci-of-esdhc.c
@@ -148,6 +148,23 @@ static void esdhc_writeb(struct sdhci_host *host, u8 val, int reg)
 			(val & SDHCI_RESET_ALL))
 		val = SDHCI_RESET_CMD | SDHCI_RESET_DATA;
 
+	if (reg == SDHCI_POWER_CONTROL) {
+		/* eSDHC don't support gate off power */
+		if (!host->pwr || !val)
+			return;
+
+		if (fsl_svr_is(SVR_T4240)) {
+			u8 vol;
+
+			vol = sdhci_be32bs_readb(host, reg);
+			if (host->pwr == SDHCI_POWER_180)
+				vol &= ~ESDHC_VOL_SEL;
+			else
+				vol |= ESDHC_VOL_SEL;
+		} else
+			return;
+	}
+
 	sdhci_be32bs_writeb(host, val, reg);
 }
 
-- 
2.0.2

