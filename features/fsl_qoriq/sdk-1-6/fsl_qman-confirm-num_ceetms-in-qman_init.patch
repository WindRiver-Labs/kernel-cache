From 6a9cfb3b4b7d9adff1e9e450808ed87178413643 Mon Sep 17 00:00:00 2001
From: Haiying Wang <Haiying.Wang@freescale.com>
Date: Tue, 15 Oct 2013 11:57:01 -0400
Subject: [PATCH 0551/1089] fsl_qman: confirm num_ceetms in qman_init

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

Signed-off-by: Haiying Wang <Haiying.Wang@freescale.com>
Change-Id: Ieff662d29203e37813ba9553e750e2777fc25591
Reviewed-on: http://git.am.freescale.net:8181/5631
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Thorpe Geoff-R01361 <Geoff.Thorpe@freescale.com>
Reviewed-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
---
 drivers/staging/fsl_qbman/qman_driver.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_qbman/qman_driver.c b/drivers/staging/fsl_qbman/qman_driver.c
index 4119128..9d60ca1 100644
--- a/drivers/staging/fsl_qbman/qman_driver.c
+++ b/drivers/staging/fsl_qbman/qman_driver.c
@@ -717,6 +717,15 @@ __init int qman_init(void)
 		qm_channel_pme = QMAN_CHANNEL_PME_REV3;
 	}
 
+	/*
+	 * Parse the ceetm node to get how many ceetm instances are supported
+	 * on the current silicon. num_ceetms must be confirmed before portals
+	 * are intiailized.
+	 */
+	num_ceetms = 0;
+	for_each_compatible_node(dn, NULL, "fsl,qman-ceetm")
+		num_ceetms++;
+
 	/* Parse pool channels into the SDQCR mask. (Must happen before portals
 	 * are initialised.) */
 	for_each_compatible_node(dn, NULL, "fsl,pool-channel-range") {
@@ -837,10 +846,8 @@ __init int qman_resource_init(void)
 	}
 
 	/* Parse CEETM */
-	num_ceetms = 0;
 	for_each_compatible_node(dn, NULL, "fsl,qman-ceetm") {
 		ret = fsl_ceetm_init(dn);
-		num_ceetms++;
 		if (ret)
 			return ret;
 	}
-- 
2.0.2

