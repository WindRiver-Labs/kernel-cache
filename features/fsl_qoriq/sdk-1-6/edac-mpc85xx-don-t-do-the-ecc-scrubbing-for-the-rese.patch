From f9dcd19136e9d8eef54aede4ce7a66128a277acf Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Fri, 14 Nov 2014 10:46:18 +0800
Subject: [PATCH] edac: mpc85xx: don't do the ecc scrubbing for the reserved
 memory

On the mpc85xx platform, we use lwarx/stwcx pair to do a atomic
scrubbing when detecting a single bit ecc error. This method works
fine for normal memory. But for some reserved memories such as the
dedicated private memories for QMAN or BMAN, the cache coherence is
disabled for performance. If a single bit ecc error occurs in these
memory areas, the atomic scrubbing may conflict with the QMAN/BMAN
dma store access and then crash the data there.

In order to fix this issue, we choose to skip all the ecc scrubbing
for the reserved memories. We implement this by using the
ctl_page_to_phys callback of mem_ctl_info struct. If an ecc error
occurs in a reserved memory, we would return a invalid physical
address. This will cause the edac core to skip the ecc scrubbing.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/edac/mpc85xx_edac.c |   12 +++++++++++-
 1 files changed, 11 insertions(+), 1 deletions(-)

diff --git a/drivers/edac/mpc85xx_edac.c b/drivers/edac/mpc85xx_edac.c
index 0f00282..56de160 100644
--- a/drivers/edac/mpc85xx_edac.c
+++ b/drivers/edac/mpc85xx_edac.c
@@ -23,6 +23,7 @@
 
 #include <linux/of_platform.h>
 #include <linux/of_device.h>
+#include <linux/memblock.h>
 #include "edac_module.h"
 #include "edac_core.h"
 #include "mpc85xx_edac.h"
@@ -1023,6 +1024,15 @@ static void mpc85xx_init_csrows(struct mem_ctl_info *mci)
 	}
 }
 
+static unsigned long mpc85xx_ctl_page_to_phys(struct mem_ctl_info *mci,
+					      unsigned long page)
+{
+	if (memblock_is_reserved(page << PAGE_SHIFT))
+		return -1UL;
+
+	return page;
+}
+
 static int mpc85xx_mc_err_probe(struct platform_device *op)
 {
 	struct mem_ctl_info *mci;
@@ -1098,7 +1108,7 @@ static int mpc85xx_mc_err_probe(struct platform_device *op)
 	if (edac_op_state == EDAC_OPSTATE_POLL)
 		mci->edac_check = mpc85xx_mc_check;
 
-	mci->ctl_page_to_phys = NULL;
+	mci->ctl_page_to_phys = mpc85xx_ctl_page_to_phys;
 
 	mci->scrub_mode = SCRUB_SW_SRC;
 
-- 
1.7.5.4

