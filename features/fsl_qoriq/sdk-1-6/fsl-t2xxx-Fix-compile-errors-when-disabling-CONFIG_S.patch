From 95b3cf87e306a4ed9f182d160d5d88d13fe5be69 Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Thu, 27 Aug 2015 11:03:43 +0800
Subject: [PATCH 2/2] fsl-t2xxx: Fix compile errors when disabling CONFIG_SMP

the patch back port from:
wrl7 commit 2f38d3c92a586eb1e8ab579ff77f82c22ddb0cf9

There are some compile errors when disabling CONFIG_SMP
- boot_cpuid isn't declared in the ics.c,it hints:

    | arch/powerpc/platforms/wsp/ics.c: In function 'wsp_ics_set_default_server':
    | arch/powerpc/platforms/wsp/ics.c:655:23: error: 'boot_cpuid' undeclared (first use in this function)
    |   np = of_get_cpu_node(boot_cpuid, NULL);
    |                        ^
    | arch/powerpc/platforms/wsp/ics.c:655:23: note: each undeclared identifier is reported only once for each function it appears in
    | arch/powerpc/platforms/wsp/ics.c:658:2: error: implicit declaration of function 'get_hard_smp_processor_id' [-Werror=implicit-function-declaration]
    |   hwid = get_hard_smp_processor_id(boot_cpuid);

- nr_cpu_ids isn't defined in the exceptions-64e.S/head_64.S, it hints:

    | arch/powerpc/kernel/head_64.S:231: undefined reference to `nr_cpu_ids'

Signed-off-by: Jianchuan Wang <jianchuan.wang@windriver.com>
Signed-off-by: Li Wang <li.wang@windriver.com>
---
 arch/powerpc/kernel/exceptions-64e.S |    4 ++++
 arch/powerpc/kernel/head_64.S        |    4 ++++
 arch/powerpc/platforms/wsp/ics.c     |    1 +
 3 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/exceptions-64e.S b/arch/powerpc/kernel/exceptions-64e.S
index cde1038..127f49f 100644
--- a/arch/powerpc/kernel/exceptions-64e.S
+++ b/arch/powerpc/kernel/exceptions-64e.S
@@ -1667,8 +1667,12 @@ BEGIN_FTR_SECTION
 	LOAD_REG_ADDR(r8, paca)	/* Get the current paca */
 	ld	r8,0(r8)
 	li	r5,0
+#ifdef CONFIG_SMP
 	LOAD_REG_ADDR(r7, nr_cpu_ids)
 	lwz	r7,0(r7)
+#else
+	li  r7,1
+#endif
 11:	lhz	r6,PACAHWCPUID(r8)
 	cmpw	r6,r4
 	beq	12f
diff --git a/arch/powerpc/kernel/head_64.S b/arch/powerpc/kernel/head_64.S
index 8865af5..7c9e448 100644
--- a/arch/powerpc/kernel/head_64.S
+++ b/arch/powerpc/kernel/head_64.S
@@ -224,8 +224,12 @@ BEGIN_FTR_SECTION
 	ld	r3,0(r3)
 	mfspr	r4,SPRN_TIR	/* The thread0 cpu id plus TIR is the */
 	add	r3,r3,r4	/* logical id of the current thread. */
+#ifdef CONFIG_SMP
 	LOAD_REG_ADDR(r4, nr_cpu_ids)
 	lwz	r4,0(r4)
+#else
+	li r4,1
+#endif
 	cmpld	r3,r4
 	bge	.
 
diff --git a/arch/powerpc/platforms/wsp/ics.c b/arch/powerpc/platforms/wsp/ics.c
index 2d3b1dd..d6ee1e0 100644
--- a/arch/powerpc/platforms/wsp/ics.c
+++ b/arch/powerpc/platforms/wsp/ics.c
@@ -19,6 +19,7 @@
 #include <linux/spinlock.h>
 #include <linux/types.h>
 
+#include <asm/smp.h>
 #include <asm/io.h>
 #include <asm/irq.h>
 #include <asm/xics.h>
-- 
1.7.5.4

