From bdbcb0d604d8087503d38bf8f0aa289f502b61ed Mon Sep 17 00:00:00 2001
From: "Lu.Jiang" <lu.jiang@windriver.com>
Date: Mon, 15 Sep 2014 14:18:24 +0800
Subject: [PATCH 0834/1089] powerpc/phy: add config function to enable
 interrupt AT8033

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

AT8033 can't work well with auto-negotiation.
Add .config_intr and .ack_interrupt functions for at8033_driver
to config AT8033 to enable interrupt for auto-negotiation.

Signed-off-by: Zhao Qiang <B45475@freescale.com>
Change-Id: I47b539cf5fc9da52c6980e95e1bd105621abf102
Reviewed-on: http://git.am.freescale.net:8181/10282
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Xiaobo Xie <X.Xie@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
Signed-off-by: Lu.Jiang <lu.jiang@windriver.com>
---
 drivers/net/phy/at803x.c | 45 +++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 45 insertions(+)

diff --git a/drivers/net/phy/at803x.c b/drivers/net/phy/at803x.c
index bc71947..9061a66 100644
--- a/drivers/net/phy/at803x.c
+++ b/drivers/net/phy/at803x.c
@@ -27,6 +27,9 @@
 #define AT803X_MMD_ACCESS_CONTROL		0x0D
 #define AT803X_MMD_ACCESS_CONTROL_DATA		0x0E
 #define AT803X_FUNC_DATA			0x4003
+#define AT803X_INER				0x0012
+#define AT803X_INER_INIT			0xec00
+#define AT803X_INSR				0x0013
 #define AT803X_DEBUG_ADDR			0x1D
 #define AT803X_DEBUG_DATA			0x1E
 #define AT803X_DEBUG_SYSTEM_MODE_CTRL		0x05
@@ -191,6 +194,31 @@ static int at803x_config_init(struct phy_device *phydev)
 	return 0;
 }
 
+static int at803x_ack_interrupt(struct phy_device *phydev)
+{
+	int err;
+
+	err = phy_read(phydev, AT803X_INSR);
+
+	return (err < 0) ? err : 0;
+}
+
+static int at803x_config_intr(struct phy_device *phydev)
+{
+	int err;
+	int value;
+
+	value = phy_read(phydev, AT803X_INER);
+
+	if (phydev->interrupts == PHY_INTERRUPT_ENABLED)
+		err = phy_write(phydev, AT803X_INER,
+				(value | AT803X_INER_INIT));
+	else
+		err = phy_write(phydev, AT803X_INER, value);
+
+	return err;
+}
+
 static struct phy_driver at803x_driver[] = {
 {
 	/* ATHEROS 8035 */
@@ -210,6 +238,23 @@ static struct phy_driver at803x_driver[] = {
 		.owner = THIS_MODULE,
 	},
 }, {
+	/* ATHEROS 8033 */
+	.phy_id		= 0x004dd074,
+	.name		= "Atheros 8033 ethernet",
+	.phy_id_mask	= 0xffffffef,
+	.config_init	= at803x_config_init,
+	.suspend	= at803x_suspend,
+	.resume		= at803x_resume,
+	.features	= PHY_GBIT_FEATURES,
+	.flags		= PHY_HAS_INTERRUPT,
+	.config_aneg	= genphy_config_aneg,
+	.read_status	= genphy_read_status,
+	.ack_interrupt	= at803x_ack_interrupt,
+	.config_intr	= at803x_config_intr,
+	.driver		= {
+		.owner = THIS_MODULE,
+	},
+}, {
 	/* ATHEROS 8030 */
 	.phy_id		= 0x004dd076,
 	.name		= "Atheros 8030 ethernet",
-- 
2.0.2

