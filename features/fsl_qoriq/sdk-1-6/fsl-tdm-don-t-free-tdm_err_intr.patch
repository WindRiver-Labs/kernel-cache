From b76332cc2e3bc6f5f525a20ff5792fcca8e8b840 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Fri, 10 Apr 2015 13:48:16 +0800
Subject: [PATCH 2/3] fsl: tdm: don't free tdm_err_intr

No one calls request_irq() for tdm_err_intr, so we can't call free_irq()
for it, else we would get the below error during removing tdm modules:

Trying to free already-free IRQ 0
WARNING: at kernel/irq/manage.c:1250
Modules linked in: tdm_fsl(-) tdm_core
CPU: 0 PID: 848 Comm: rmmod Not tainted 3.10.62-ltsi-WR6.0.0.0_cgl #1
task: c57aba80 ti: c57e6000 task.ti: c57e6000
NIP: c00ea804 LR: c00ea804 CTR: c05e27b0
REGS: c57e7d60 TRAP: 0700 Not tainted (3.10.62-ltsi-WR6.0.0.0_cgl)
MSR: 00021000 <CE,ME> CR: 22000f84 XER: 00000000

GPR00: c00ea804 c57e7e10 c57aba80 00000021 00021000 00000022 c0bf2750 c14e336c
GPR08: 00000000 00000080 00000000 0000019a 42000f84 1002a3a0 00000000 00000000
GPR16: 00000000 00000000 10023088 1000d298 1000d258 1000d27c 1000d2b0 00000000
GPR24: 1000d294 00000800 00029000 ef805058 00000000 ef805000 c5c49cc0 ef805000
NIP [c00ea804] __free_irq+0x164/0x1c4
LR [c00ea804] __free_irq+0x164/0x1c4
Call Trace:
[c57e7e10] [c00ea804] __free_irq+0x164/0x1c4 (unreliable)
[c57e7e30] [c00ea954] free_irq+0x7c/0xdc
[c57e7e50] [f316e278] tdm_fsl_remove+0x68/0x2a0 [tdm_fsl]
[c57e7e80] [c052a740] __device_release_driver+0x74/0x120
[c57e7e90] [c052b154] driver_detach+0xd0/0xd4
[c57e7eb0] [c052a308] bus_remove_driver+0xac/0x114
[c57e7ed0] [c00bc734] SyS_delete_module+0x144/0x228
[c57e7f40] [c00110c4] ret_from_syscall+0x0/0x3c

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/tdm/device/tdm_fsl.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/drivers/tdm/device/tdm_fsl.c b/drivers/tdm/device/tdm_fsl.c
index fe8ad8d..ac6a431 100644
--- a/drivers/tdm/device/tdm_fsl.c
+++ b/drivers/tdm/device/tdm_fsl.c
@@ -805,7 +805,7 @@ err_tdminit:
 fail_adapter:
 	free_irq(priv->dmac_done_intr, priv);
 err_dmacdoneisr:
-	free_irq(priv->tdm_err_intr, priv);
+	/* free_irq(priv->tdm_err_intr, priv); */
 err_dmacdone_irqmap:
 	irq_dispose_mapping(priv->dmac_done_intr);
 err_dmacreg:
@@ -840,9 +840,13 @@ static int tdm_fsl_remove(struct platform_device *ofdev)
 	dev_set_drvdata(&ofdev->dev, NULL);
 
 	/* free the irqs and dispose their mapping */
+	/*
 	free_irq(priv->tdm_err_intr, priv);
+	*/
 	free_irq(priv->dmac_done_intr, priv);
+	/*
 	irq_dispose_mapping(priv->tdm_err_intr);
+	*/
 	irq_dispose_mapping(priv->dmac_done_intr);
 	iounmap(priv->tdm_regs);
 	iounmap(priv->dmac_regs);
-- 
1.7.5.4

