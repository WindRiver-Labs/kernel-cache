From 0d5bf645f78e24b814ee7b10b00f9b13c9fc8d26 Mon Sep 17 00:00:00 2001
From: Haijun Zhang <Haijun.Zhang@freescale.com>
Date: Wed, 7 May 2014 18:14:39 +0800
Subject: [PATCH 316/466] mmc:esdhc: disable trim feature on T4240QDS

The timeout value got from eMMC card on T4240QDS is
incorrect. Disable trim and use erase instead.

Remove quirk SDHCI_QUIRK_BROKEN_ADMA to enable ADMA on
T4240QDS.

Calculate the timeout based SD clock when we have qurik
SDHCI_QUIRK_DATA_TIMEOUT_USES_SDCLK.

Signed-off-by: Haijun Zhang <Haijun.Zhang@freescale.com>
Change-Id: I2eca7c1d00c89db8b2e257f60b6ef62971536f90
Reviewed-on: http://git.am.freescale.net:8181/11981
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Xiaobo Xie <X.Xie@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/mmc/core/core.c        |    5 ++++-
 drivers/mmc/host/sdhci-pltfm.c |    2 +-
 drivers/mmc/host/sdhci.c       |    3 +++
 include/linux/mmc/host.h       |    1 +
 include/linux/mmc/sdhci.h      |    1 +
 5 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/drivers/mmc/core/core.c b/drivers/mmc/core/core.c
index dc41be8..8974767 100644
--- a/drivers/mmc/core/core.c
+++ b/drivers/mmc/core/core.c
@@ -2105,8 +2105,11 @@ EXPORT_SYMBOL(mmc_can_erase);
 
 int mmc_can_trim(struct mmc_card *card)
 {
-	if (card->ext_csd.sec_feature_support & EXT_CSD_SEC_GB_CL_EN)
+	if ((card->ext_csd.sec_feature_support & EXT_CSD_SEC_GB_CL_EN) &&
+	    !(card->host->caps2 & MMC_CAP2_NO_TRIM)) {
 		return 1;
+	}
+
 	return 0;
 }
 EXPORT_SYMBOL(mmc_can_trim);
diff --git a/drivers/mmc/host/sdhci-pltfm.c b/drivers/mmc/host/sdhci-pltfm.c
index 8e66a56..4f297fe 100644
--- a/drivers/mmc/host/sdhci-pltfm.c
+++ b/drivers/mmc/host/sdhci-pltfm.c
@@ -101,7 +101,7 @@ void sdhci_get_of_property(struct platform_device *pdev)
 		if (of_device_is_compatible(np, "fsl,t4240-esdhc")) {
 			host->quirks2 |= SDHCI_QUIRK2_LONG_TIME_CMD_COMPLETE_IRQ;
 			host->quirks2 |= SDHCI_QUIRK2_FORCE_CMD13_DETECT_CARD;
-			host->quirks |= SDHCI_QUIRK_BROKEN_ADMA;
+			host->quirks2 |= SDHCI_QUIRK2_BROKEN_TRIM;
 		}
 
 		if (of_device_is_compatible(np, "fsl,p5020-esdhc") ||
diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.c
index 5ace86b..d6492bf 100644
--- a/drivers/mmc/host/sdhci.c
+++ b/drivers/mmc/host/sdhci.c
@@ -2881,6 +2881,9 @@ int sdhci_add_host(struct sdhci_host *host)
 		host->flags &= ~SDHCI_USE_SDMA;
 	}
 
+	if (host->quirks & SDHCI_QUIRK2_BROKEN_TRIM)
+		mmc->caps2 |= MMC_CAP2_NO_TRIM;
+
 	if ((host->version >= SDHCI_SPEC_200) &&
 		(caps[0] & SDHCI_CAN_DO_ADMA2))
 		host->flags |= SDHCI_USE_ADMA;
diff --git a/include/linux/mmc/host.h b/include/linux/mmc/host.h
index 3b0c33a..e07bd97 100644
--- a/include/linux/mmc/host.h
+++ b/include/linux/mmc/host.h
@@ -281,6 +281,7 @@ struct mmc_host {
 				 MMC_CAP2_PACKED_WR)
 #define MMC_CAP2_NO_PRESCAN_POWERUP (1 << 14)	/* Don't power up before scan */
 #define MMC_CAP2_SANITIZE	(1 << 15)		/* Support Sanitize */
+#define MMC_CAP2_NO_TRIM	(1 << 16)	/* Don't Support trim */
 
 	mmc_pm_flag_t		pm_caps;	/* supported pm features */
 
diff --git a/include/linux/mmc/sdhci.h b/include/linux/mmc/sdhci.h
index 63bbe44..33dd071 100644
--- a/include/linux/mmc/sdhci.h
+++ b/include/linux/mmc/sdhci.h
@@ -106,6 +106,7 @@ struct sdhci_host {
 #define SDHCI_QUIRK2_FORCE_CMD13_DETECT_CARD		(1<<7)
 /* Controller need to disable clock before reset all */
 #define SDHCI_QUIRK2_DISABLE_CLOCK_BEFORE_RESET		(1<<8)
+#define SDHCI_QUIRK2_BROKEN_TRIM			(1<<11)
 #define SDHCI_QUIRK2_CARD_ON_NEEDS_BUS_ON		(1<<9)
 /* Controller has weird bit setting for Protocol Control Register */
 #define SDHCI_QUIRK_QORIQ_PROCTL_WEIRD			(1<<10)
-- 
1.7.10.4

