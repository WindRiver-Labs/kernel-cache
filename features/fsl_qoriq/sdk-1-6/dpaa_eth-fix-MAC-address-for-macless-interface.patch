From e28fa9e61eafe03c8fdfe545c7714bfd6c18a589 Mon Sep 17 00:00:00 2001
From: Marian Rotariu <marian.rotariu@freescale.com>
Date: Wed, 6 Nov 2013 18:21:52 +0200
Subject: [PATCH 0574/1089] dpaa_eth: fix MAC address for macless interface

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

If a macless interface controls a MAC device it should ignore the
"local-mac-address" attribute from the device tree and use the 'native' MAC
address. The 'native' MAC address is the address that is set by uboot at kernel
boot-up.

Change-Id: Ie387ea5d82dd0cd5292439a66d09a182fd4b9a8a
Signed-off-by: Marian Rotariu <marian.rotariu@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/6313
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Cristian-Constantin Sovaiala <Cristian.Sovaiala@freescale.com>
Reviewed-by: Ruxandra Ioana Radulescu <ruxandra.radulescu@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
---
 .../net/ethernet/freescale/dpa/dpaa_eth_macless.c  | 25 +++++++++++++---------
 1 file changed, 15 insertions(+), 10 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_macless.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_macless.c
index 87215c3..119f891 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_macless.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_macless.c
@@ -217,21 +217,26 @@ static int dpa_macless_netdev_init(struct device_node *dpa_node,
 
 	net_dev->netdev_ops = &dpa_macless_ops;
 
-	/* Get the MAC address */
-	mac_addr = of_get_mac_address(dpa_node);
-	if (mac_addr == NULL) {
-		if (netif_msg_probe(priv))
-			dev_err(dev, "No MAC address found!\n");
-		return -EINVAL;
-	}
-
 	if (proxy_dev) {
 		struct mac_device *mac_dev = proxy_dev->mac_dev;
 		net_dev->mem_start = mac_dev->res->start;
 		net_dev->mem_end = mac_dev->res->end;
-	}
 
-	return dpa_netdev_init(dpa_node, net_dev, mac_addr, tx_timeout);
+		return dpa_netdev_init(dpa_node, net_dev, mac_dev->addr,
+				tx_timeout);
+	} else {
+		/* Get the MAC address from device tree */
+		mac_addr = of_get_mac_address(dpa_node);
+
+		if (mac_addr == NULL) {
+			if (netif_msg_probe(priv))
+				dev_err(dev, "No MAC address found!\n");
+			return -EINVAL;
+		}
+
+		return dpa_netdev_init(dpa_node, net_dev, mac_addr,
+				tx_timeout);
+	}
 }
 
 /* Probing of FQs for MACless ports */
-- 
2.0.2

