From c482e1081cc80bc165e13de59aad71719926e528 Mon Sep 17 00:00:00 2001
From: Vakul Garg <vakul@freescale.com>
Date: Tue, 28 May 2013 15:21:57 +0530
Subject: [PATCH 0320/1089] crypto: caam - sync 'struct caam_ctx' definition
 with JR driver

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

The change fixes overwriting of shared descriptors stored in caam
context structure. Also removed a duplicate macro definition of
DESC_JOB_IO_LEN which is defined in desc_constr.h.

Change-Id: I1019344986e16debb361ddfbccbb387717b46c4d
Signed-off-by: Vakul Garg <vakul@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/2737
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Geanta Neag Horia Ioan-B05471 <horia.geanta@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
---
 drivers/crypto/caam/caamalg_qi.c | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/drivers/crypto/caam/caamalg_qi.c b/drivers/crypto/caam/caamalg_qi.c
index 138e303..80d8935 100644
--- a/drivers/crypto/caam/caamalg_qi.c
+++ b/drivers/crypto/caam/caamalg_qi.c
@@ -28,13 +28,15 @@
 #define CAAM_MAX_IV_LENGTH		16
 
 /* length of descriptors text */
-#define DESC_JOB_IO_LEN			(CAAM_CMD_SZ * 5 + CAAM_PTR_SZ * 3)
-
 #define DESC_AEAD_BASE			(4 * CAAM_CMD_SZ)
 #define DESC_AEAD_ENC_LEN		(DESC_AEAD_BASE + 16 * CAAM_CMD_SZ)
 #define DESC_AEAD_DEC_LEN		(DESC_AEAD_BASE + 21 * CAAM_CMD_SZ)
 #define DESC_AEAD_GIVENC_LEN		(DESC_AEAD_ENC_LEN + 7 * CAAM_CMD_SZ)
 
+#define DESC_MAX_USED_BYTES		(DESC_AEAD_GIVENC_LEN + \
+					 CAAM_MAX_KEY_SIZE)
+#define DESC_MAX_USED_LEN		(DESC_MAX_USED_BYTES / CAAM_CMD_SZ)
+
 /* Set DK bit in class 1 operation if shared */
 static inline void append_dec_op1(u32 *desc, u32 type)
 {
@@ -102,9 +104,9 @@ enum optype {
  */
 struct caam_ctx {
 	struct device *jrdev;
-	u32 sh_desc_enc[MAX_SDLEN];
-	u32 sh_desc_dec[MAX_SDLEN];
-	u32 sh_desc_givenc[MAX_SDLEN];
+	u32 sh_desc_enc[DESC_MAX_USED_LEN];
+	u32 sh_desc_dec[DESC_MAX_USED_LEN];
+	u32 sh_desc_givenc[DESC_MAX_USED_LEN];
 	u32 class1_alg_type;
 	u32 class2_alg_type;
 	u32 alg_op;
-- 
2.0.2

