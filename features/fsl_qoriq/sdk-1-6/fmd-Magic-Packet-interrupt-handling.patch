From 954670403a3fce7084c7639e7fbb20652d90c513 Mon Sep 17 00:00:00 2001
From: Cristian Sovaiala <cristian.sovaiala@freescale.com>
Date: Tue, 25 Mar 2014 09:30:21 +0200
Subject: [PATCH 0832/1089] fmd: Magic Packet interrupt handling

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

Signed-off-by: Cristian Sovaiala <cristian.sovaiala@freescale.com>
Change-Id: If203b15d0f34b4ace5bd8cb911af1ebf93aa5621
Reviewed-on: http://git.am.freescale.net:8181/10396
Reviewed-by: Igal Liberman <Igal.Liberman@freescale.com>
Reviewed-by: Madalin-Cristian Bucur <madalin.bucur@freescale.com>
Tested-by: Madalin-Cristian Bucur <madalin.bucur@freescale.com>
(cherry picked from commit e8a3fbfddce62f064132632b16682f3dac093e77)
Reviewed-on: http://git.am.freescale.net:8181/10403
---
 .../freescale/fman/Peripherals/FM/MAC/memac.c      | 25 ++++++++++++++++++++++
 1 file changed, 25 insertions(+)

diff --git a/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/memac.c b/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/memac.c
index a162510..9169ff7 100644
--- a/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/memac.c
+++ b/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/memac.c
@@ -217,6 +217,24 @@ static void MemacErrException(t_Handle h_Memac)
         p_Memac->f_Exception(p_Memac->h_App, e_FM_MAC_EX_10G_1TX_ECC_ER);
     if (event & MEMAC_IEVNT_RX_ECC_ER)
         p_Memac->f_Exception(p_Memac->h_App, e_FM_MAC_EX_10G_RX_ECC_ER);
+}
+
+static void MemacException(t_Handle h_Memac)
+{
+    t_Memac     *p_Memac = (t_Memac *)h_Memac;
+    uint32_t    event, imask;
+
+    event = fman_memac_get_event(p_Memac->p_MemMap, 0xffffffff);
+    imask = fman_memac_get_interrupt_mask(p_Memac->p_MemMap);
+
+    /* Imask include both error and notification/event bits.
+       Leaving only error bits enabled by imask.
+       The imask error bits are shifted by 16 bits offset from
+       their corresponding location in the ievent - hence the >> 16 */
+    event &= ((imask & MEMAC_ALL_ERRS_IMASK) >> 16);
+
+    fman_memac_ack_event(p_Memac->p_MemMap, event);
+
     if (event & MEMAC_IEVNT_MGI)
         p_Memac->f_Exception(p_Memac->h_App, e_FM_MAC_EX_MAGIC_PACKET_INDICATION);
 }
@@ -956,6 +974,13 @@ static t_Error MemacInit(t_Handle h_Memac)
                    MemacErrException,
                    p_Memac);
 
+    FmRegisterIntr(p_Memac->fmMacControllerDriver.h_Fm,
+                   (portType == e_FM_MAC_10G) ? e_FM_MOD_10G_MAC : e_FM_MOD_1G_MAC,
+                   p_Memac->macId,
+                   e_FM_INTR_TYPE_NORMAL,
+                   MemacException,
+                   p_Memac);
+
     XX_Free(p_MemacDriverParam);
     p_Memac->p_MemacDriverParam = NULL;
 
-- 
2.0.2

