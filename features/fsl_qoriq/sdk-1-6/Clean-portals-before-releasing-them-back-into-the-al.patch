From a2ec4c7192afa3dff93b376489a50a725da0b787 Mon Sep 17 00:00:00 2001
From: Roy Pledge <Roy.Pledge@freescale.com>
Date: Tue, 29 Oct 2013 10:06:44 -0400
Subject: [PATCH 0993/1089] Clean portals before releasing them back into the
 alloctor

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

During USDPAA cleanup ERNs may be produced to any portal the process was using.
The cleanup code will service those portals until the FQs reach the retired state.
This patch makes sure the portals are reinitialize to a clean state before returning
them to the allocation pool

Signed-off-by: Roy Pledge <Roy.Pledge@freescale.com>
Change-Id: Ib4589b816d3259682f16ebacb5932194bc85e053
Reviewed-on: http://git.am.freescale.net:8181/6769
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Haiying Wang <Haiying.Wang@freescale.com>
Reviewed-by: Geoff Thorpe <Geoff.Thorpe@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
(cherry picked from commit ebe5afa136e096ed78d4ce94b5dad8327fdd134c)
Reviewed-on: http://git.am.freescale.net:8181/11730
Reviewed-by: Jeffrey Ladouceur <Jeffrey.Ladouceur@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
---
 drivers/staging/fsl_qbman/fsl_usdpaa.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/drivers/staging/fsl_qbman/fsl_usdpaa.c b/drivers/staging/fsl_qbman/fsl_usdpaa.c
index fbb2f29..e8f66ca 100644
--- a/drivers/staging/fsl_qbman/fsl_usdpaa.c
+++ b/drivers/staging/fsl_qbman/fsl_usdpaa.c
@@ -631,8 +631,12 @@ static int usdpaa_release(struct inode *inode, struct file *filp)
 	list_for_each_entry_safe(portal, tmpportal, &ctx->portals, list) {
 		if (portal->user.type == usdpaa_portal_qman) {
 			/* Give the portal back to the allocator */
+			init_qm_portal(portal->qportal,
+				       &portal->qman_portal_low);
 			qm_put_unused_portal(portal->qportal);
 		} else {
+			init_bm_portal(portal->bportal,
+				       &portal->bman_portal_low);
 			bm_put_unused_portal(portal->bportal);
 		}
 		list_del(&portal->list);
-- 
2.0.2

