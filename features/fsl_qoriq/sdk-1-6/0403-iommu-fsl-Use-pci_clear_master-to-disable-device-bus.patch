From c31a6d782f95e01ece89ea618c5c717342d9c1fa Mon Sep 17 00:00:00 2001
From: Varun Sethi <Varun.Sethi@freescale.com>
Date: Mon, 12 May 2014 15:22:05 +0530
Subject: [PATCH 403/466] iommu/fsl: Use pci_clear_master to disable device
 bus master capability.

Initially we were disabling the bus master capability by writing to the
PCI configuration space. We were not clearing the "is_busmaster" flag.
As a result when the device was assgined back to host, the bus master
capability of the pci bridge (to which the device was connected) were
not getting enabled. Once the device was assigned back to host, device
was facing DMA issues.

Now, we are using the pci_clear_master for disabling device bus master
capability. This routine clears the device bus master capability by
accessing the device configuration space and also clears the
"is_busmaster" flag.

Signed-off-by: Varun Sethi <Varun.Sethi@freescale.com>
Change-Id: Icda6f5551d8da43bec8f2b657846b7e3f9474290
Reviewed-on: http://git.am.freescale.net:8181/12224
Reviewed-by: Stuart Yoder <stuart.yoder@freescale.com>
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/iommu/fsl_pamu_domain.c |    3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/drivers/iommu/fsl_pamu_domain.c b/drivers/iommu/fsl_pamu_domain.c
index a94d390..e95d6b8 100644
--- a/drivers/iommu/fsl_pamu_domain.c
+++ b/drivers/iommu/fsl_pamu_domain.c
@@ -346,8 +346,7 @@ static void disable_device_dma(struct device_domain_info *info,
 	if (info->dev->bus == &pci_bus_type) {
 		struct pci_dev *pdev = NULL;
 		pdev = to_pci_dev(info->dev);
-		if (pci_is_enabled(pdev))
-			pci_disable_device(pdev);
+		pci_clear_master(pdev);
 	}
 #endif
 
-- 
1.7.10.4

