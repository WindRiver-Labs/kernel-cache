From 0c28db28bdb9065ff905e038b305d95c0602801c Mon Sep 17 00:00:00 2001
From: Cristian Sovaiala <cristian.sovaiala@freescale.com>
Date: Mon, 4 Nov 2013 16:58:18 +0200
Subject: [PATCH 018/466] dpaa_eth: Add support for Power Management in DPAA
 Proxy Driver

Implement Power Management suspend_noirq/resume_noirq specific
callbacks where we disable/enable the port.
The ports initialized by the Proxy Driver (and belonging to USDPAA)
do not have the AutoResponse capability enabled therefore we
always disable the port during the suspend sequence.

Signed-off-by: Cristian Sovaiala <cristian.sovaiala@freescale.com>
Change-Id: Id370d5319f886a7c51aca71f4f3d003568c1f629
Reviewed-on: http://git.am.freescale.net:8181/6845
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Ruxandra Ioana Radulescu <ruxandra.radulescu@freescale.com>
Reviewed-by: Marian Cristian Rotariu <marian.rotariu@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/7694
Reviewed-by: Madalin-Cristian Bucur <madalin.bucur@freescale.com>
Tested-by: Madalin-Cristian Bucur <madalin.bucur@freescale.com>
[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 .../net/ethernet/freescale/dpa/dpaa_eth_proxy.c    |   83 +++++++++++++++-----
 1 file changed, 65 insertions(+), 18 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
index 0f43364..6a89193 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
@@ -52,29 +52,57 @@ static uint8_t debug = -1;
 module_param(debug, byte, S_IRUGO);
 MODULE_PARM_DESC(debug, "Module/Driver verbosity level");
 
-/* forward declarations */
-static int dpaa_eth_proxy_probe(struct platform_device *_of_dev);
 static int __cold dpa_eth_proxy_remove(struct platform_device *of_dev);
+static struct proxy_device *proxy_dev;
 
-static const struct of_device_id dpa_proxy_match[] = {
-	{
-		.compatible	= "fsl,dpa-ethernet-init"
-	},
-	{}
-};
-MODULE_DEVICE_TABLE(of, dpa_proxy_match);
+#ifdef CONFIG_PM
 
-static struct platform_driver dpa_proxy_driver = {
-	.driver = {
-		.name		= KBUILD_MODNAME"-proxy",
-		.of_match_table	= dpa_proxy_match,
-		.owner		= THIS_MODULE,
-	},
-	.probe		= dpaa_eth_proxy_probe,
-	.remove		= dpa_eth_proxy_remove
+static int proxy_suspend_noirq(struct device *dev)
+{
+	struct mac_device	*mac_dev = proxy_dev->mac_dev;
+	int			err = 0;
+
+	err = fm_port_suspend(mac_dev->port_dev[RX]);
+	if (err)
+		goto port_suspend_failed;
+
+	err = fm_port_suspend(mac_dev->port_dev[TX]);
+	if (err)
+		err = fm_port_resume(mac_dev->port_dev[RX]);
+
+port_suspend_failed:
+	return err;
+}
+
+static int proxy_resume_noirq(struct device *dev)
+{
+	struct mac_device	*mac_dev = proxy_dev->mac_dev;
+	int			err = 0;
+
+	err = fm_port_resume(mac_dev->port_dev[TX]);
+	if (err)
+		goto port_resume_failed;
+
+	err = fm_port_resume(mac_dev->port_dev[RX]);
+	if (err)
+		err = fm_port_suspend(mac_dev->port_dev[TX]);
+
+port_resume_failed:
+	return err;
+}
+
+static const struct dev_pm_ops proxy_pm_ops = {
+	.suspend_noirq = proxy_suspend_noirq,
+	.resume_noirq = proxy_resume_noirq,
 };
 
-static struct proxy_device *proxy_dev;
+#define PROXY_PM_OPS (&proxy_pm_ops)
+
+#else /* CONFIG_PM */
+
+#define PROXY_PM_OPS NULL
+
+#endif /* CONFIG_PM */
 
 static int dpaa_eth_proxy_probe(struct platform_device *_of_dev)
 {
@@ -282,6 +310,25 @@ static int __cold dpa_eth_proxy_remove(struct platform_device *of_dev)
 	return 0;
 }
 
+static const struct of_device_id dpa_proxy_match[] = {
+	{
+		.compatible	= "fsl,dpa-ethernet-init"
+	},
+	{}
+};
+MODULE_DEVICE_TABLE(of, dpa_proxy_match);
+
+static struct platform_driver dpa_proxy_driver = {
+	.driver = {
+		.name		= KBUILD_MODNAME"-proxy",
+		.of_match_table	= dpa_proxy_match,
+		.owner		= THIS_MODULE,
+		.pm		= PROXY_PM_OPS,
+	},
+	.probe		= dpaa_eth_proxy_probe,
+	.remove		= dpa_eth_proxy_remove
+};
+
 static int __init __cold dpa_proxy_load(void)
 {
 	int	 _errno;
-- 
1.7.10.4

