From 595f305497633718c01adfb73565dfefe146e125 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 29 Apr 2014 16:25:38 +0800
Subject: [PATCH 43/43] powerpc/booke64: make sure the secondary thread get
 the correct physical id

The commit ("powerpc/fsl_book3e: set the correct physical id for the
secondary thread in cpu hotplug") change the method which we use to set
the physical id for the secondary thread. First we will store the
physical id of the first thread to a global variable __thread0_cpu_id,
and then release the secondary thread. The secondary thread will use
this value to calculate its physical id. So we must make sure that
the store to __thread0_cpu_id is performed to the secondary thread
before the instruction of the releasing of secondary thread. Add
a 'sync' for this purpose.

Reported-by: Yong Zhang <yong.zhang@windriver.com>
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/exceptions-64e.S |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/exceptions-64e.S b/arch/powerpc/kernel/exceptions-64e.S
index d4b3053..2a5a6ed 100644
--- a/arch/powerpc/kernel/exceptions-64e.S
+++ b/arch/powerpc/kernel/exceptions-64e.S
@@ -1679,6 +1679,7 @@ BEGIN_FTR_SECTION
 	rlwinm	r4,r4,0,0,30	/* Get the thread0 cpu id. */
 	LOAD_REG_ADDR(r5, __thread0_cpu_id)
 	std	r4,0(r5)
+	sync
 
 	/* Configure the MSR per the default */
 	LOAD_REG_IMMEDIATE(r4, MSR_KERNEL);
-- 
1.7.5.4

