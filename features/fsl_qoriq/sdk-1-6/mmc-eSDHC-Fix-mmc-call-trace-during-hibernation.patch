From 1904db2c772e030065bac3ec12c8d19cef00572b Mon Sep 17 00:00:00 2001
From: Haijun Zhang <Haijun.Zhang@freescale.com>
Date: Mon, 5 May 2014 16:26:47 +0800
Subject: [PATCH 0989/1089] mmc:eSDHC: Fix mmc call trace during hibernation

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

For removable card we avoid to invoke resume and suspend call back
function, because it's not safe in case card was removed and replaced
with a new one during suspend. But it's still need to judge the bus_ops
hook before we run it.

Signed-off-by: Haijun Zhang <Haijun.Zhang@freescale.com>
Change-Id: I1c2d26171a7ca02c2ecd2f029e37c5b715fb4105
Reviewed-on: http://git.am.freescale.net:8181/11804
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Xiaobo Xie <X.Xie@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
---
 drivers/mmc/core/bus.c | 18 +++++++++++-------
 1 file changed, 11 insertions(+), 7 deletions(-)

diff --git a/drivers/mmc/core/bus.c b/drivers/mmc/core/bus.c
index 64145a3..b35eb23 100644
--- a/drivers/mmc/core/bus.c
+++ b/drivers/mmc/core/bus.c
@@ -148,7 +148,7 @@ static int mmc_bus_suspend(struct device *dev)
 	struct mmc_driver *drv = to_mmc_driver(dev->driver);
 	struct mmc_card *card = mmc_dev_to_card(dev);
 	struct mmc_host *host = card->host;
-	int ret;
+	int ret = -ENODEV;
 
 	if (dev->driver && drv->suspend) {
 		ret = drv->suspend(card);
@@ -156,7 +156,9 @@ static int mmc_bus_suspend(struct device *dev)
 			return ret;
 	}
 
-	ret = host->bus_ops->suspend(host);
+	if (host->bus_ops->suspend)
+		ret = host->bus_ops->suspend(host);
+
 	return ret;
 }
 
@@ -165,12 +167,14 @@ static int mmc_bus_resume(struct device *dev)
 	struct mmc_driver *drv = to_mmc_driver(dev->driver);
 	struct mmc_card *card = mmc_dev_to_card(dev);
 	struct mmc_host *host = card->host;
-	int ret;
+	int ret = -ENODEV;
 
-	ret = host->bus_ops->resume(host);
-	if (ret)
-		pr_warn("%s: error %d during resume (card was removed?)\n",
-			mmc_hostname(host), ret);
+	if (host->bus_ops->resume) {
+		ret = host->bus_ops->resume(host);
+		if (ret)
+			pr_warn("%s: error %d during resume (card was removed?)\n",
+				mmc_hostname(host), ret);
+	}
 
 	if (dev->driver && drv->resume)
 		ret = drv->resume(card);
-- 
2.0.2

