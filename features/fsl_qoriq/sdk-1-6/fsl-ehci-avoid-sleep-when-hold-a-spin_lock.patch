From cb7d701e93e7b2d319e606acbe3e1b4de79a663f Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Thu, 16 Apr 2015 10:31:59 +0800
Subject: [PATCH] fsl: ehci: avoid sleep when hold a spin_lock

This fixes the below error:

BUG: scheduling while atomic: kworker/u2:1/48/0x00000002
CPU: 0 PID: 48 Comm: kworker/u2:1 Not tainted 3.10.62-ltsi-WR6.0.0.0_cgl
Workqueue: events_unbound async_run_entry_fn
Call Trace:
[c6211ae0] [c0008460] show_stack+0xfc/0x1c8 (unreliable)
[c6211b30] [c08a289c] __schedule_bug+0x54/0x6c
[c6211b40] [c0894324] __schedule+0x6cc/0x804
[c6211c60] [c08932a8] schedule_hrtimeout_range_clock+0x12c/0x1e0
[c6211ce0] [c005c7ec] usleep_range+0x44/0x54
[c6211d00] [c067dc88] ehci_bus_suspend+0x214/0x3f4
[c6211d50] [c06673c8] hcd_bus_suspend+0x78/0x154
[c6211d80] [c06748c8] generic_suspend+0x84/0x8c
[c6211d90] [c066c3f4] usb_suspend+0x210/0x304
[c6211dd0] [c065c368] usb_dev_suspend+0x28/0x38
[c6211de0] [c05330f4] dpm_run_callback.isra.12+0x30/0x90
[c6211df0] [c0533ef4] __device_suspend+0xd8/0x228
[c6211e30] [c0534084] async_suspend+0x40/0xd0
[c6211e50] [c007d470] async_run_entry_fn+0x5c/0x1d4
[c6211e80] [c006c288] process_one_work+0x158/0x41c
[c6211eb0] [c006cc20] worker_thread+0x134/0x3cc
[c6211ee0] [c0073f08] kthread+0xb4/0xb8
[c6211f40] [c00111fc] ret_from_kernel_thread+0x5c/0x64

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/usb/host/ehci-hub.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/usb/host/ehci-hub.c b/drivers/usb/host/ehci-hub.c
index c1c1960..ab34da2 100644
--- a/drivers/usb/host/ehci-hub.c
+++ b/drivers/usb/host/ehci-hub.c
@@ -270,8 +270,11 @@ static int ehci_bus_suspend (struct usb_hcd *hcd)
 		else if ((t1 & PORT_PE) && !(t1 & PORT_SUSPEND)) {
 			t2 |= PORT_SUSPEND;
 			set_bit(port, &ehci->bus_suspended);
-			if (ehci_has_fsl_susp_errata(ehci))
+			if (ehci_has_fsl_susp_errata(ehci)) {
+				spin_unlock_irq(&ehci->lock);
 				usleep_range(10000, 20000);
+				spin_lock_irq(&ehci->lock);
+			}
 		}
 
 		/* enable remote wakeup on all ports, if told to do so */
-- 
1.7.5.4

