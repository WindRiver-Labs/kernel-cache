From b566ddfb2fd3e54de751bbc3a108a06911af90a2 Mon Sep 17 00:00:00 2001
From: Zhao Chenhui <chenhui.zhao@freescale.com>
Date: Mon, 12 May 2014 19:58:16 +0800
Subject: [PATCH 22/57] powerpc/pm: add API for setting powerdown
 exception(Add DTS missing parts)

Add fsl_set_power_except() for setting powerdown exception when sleep.
The drivers can call this function to set the corresponding bits if
the devices will power down when sleep.

This patch also fixed an issue which is that FMan ports can not work after
wake-up from deep sleep using Wake-on-LAN. Set FMan bit and MAC bits of the
register IPPDEXPCR seperately, instead of setting them together.

Change-Id: I8f632efb8ca54a5d32deb7ee1d42b333fa66d5cd
Signed-off-by: Zhao Chenhui <chenhui.zhao@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/12219
Reviewed-by: Yang Li <LeoLi@freescale.com>
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>

[Original patch taken from QorIQ-SDK-V1.8-20150619-yocto.
 WRL8 ported a similar patch before, but I removed it in patch

"ppc: DTS: remove all t104* DTS files."

to align with SDK, readd it now. Just port the DTS changes.
Ignore the changes of "arch/powerpc/platforms/85xx/qoriq_pm.c"
and "arch/powerpc/include/asm/fsl_pm.h"
since they have been updated in previous patch.]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/powerpc/boot/dts/t1040rdb.dts    |   12 +++++++-----
 arch/powerpc/boot/dts/t1042rdb_pi.dts |    9 +++++++--
 arch/powerpc/boot/dts/t104xqds.dtsi   |   12 +++++++-----
 3 files changed, 21 insertions(+), 12 deletions(-)

diff --git a/arch/powerpc/boot/dts/t1040rdb.dts b/arch/powerpc/boot/dts/t1040rdb.dts
index 06182be..4b0c092 100644
--- a/arch/powerpc/boot/dts/t1040rdb.dts
+++ b/arch/powerpc/boot/dts/t1040rdb.dts
@@ -146,29 +146,36 @@
 		};
 
 		fman0: fman@400000 {
+			sleep = <&rcpm 0x00000008>;
+
 			enet0: ethernet@e0000 {
 				fixed-link = <0 1 1000 0 0>;
 				phy-connection-type = "sgmii";
+				sleep = <&rcpm 0x80000000>;
 			};
 
 			enet1: ethernet@e2000 {
 				fixed-link = <1 1 1000 0 0>;
 				phy-connection-type = "sgmii";
+				sleep = <&rcpm 0x40000000>;
 			};
 
 			enet2: ethernet@e4000 {
 				phy-handle = <&phy_sgmii_2>;
 				phy-connection-type = "sgmii";
+				sleep = <&rcpm 0x20000000>;
 			};
 
 			enet3: ethernet@e6000 {
 				phy-handle = <&phy_rgmii_0>;
 				phy-connection-type = "rgmii";
+				sleep = <&rcpm 0x10000000>;
 			};
 
 			enet4: ethernet@e8000 {
 				phy-handle = <&phy_rgmii_1>;
 				phy-connection-type = "rgmii";
+				sleep = <&rcpm 0x08000000>;
 			};
 
 			mdio0: mdio@fc000 {
@@ -317,27 +324,22 @@
 		ethernet@0 {
 			compatible = "fsl,t1040-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet0>;
-			sleep = <&rcpm 0x80000008>;
 		};
 		ethernet@1 {
 			compatible = "fsl,t1040-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet1>;
-			sleep = <&rcpm 0x40000008>;
 		};
 		ethernet@2 {
 			compatible = "fsl,t1040-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet2>;
-			sleep = <&rcpm 0x20000008>;
 		};
 		ethernet@3 {
 			compatible = "fsl,t1040-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet3>;
-			sleep = <&rcpm 0x10000008>;
 		};
 		ethernet@4 {
 			compatible = "fsl,t1040-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet4>;
-			sleep = <&rcpm 0x08000008>;
 		};
 		/* enable one offline port */
 		dpa-fman0-oh@2 {
diff --git a/arch/powerpc/boot/dts/t1042rdb_pi.dts b/arch/powerpc/boot/dts/t1042rdb_pi.dts
index f89fee9..3b5cf98 100644
--- a/arch/powerpc/boot/dts/t1042rdb_pi.dts
+++ b/arch/powerpc/boot/dts/t1042rdb_pi.dts
@@ -153,26 +153,33 @@
 		};
 
 		fman0: fman@400000 {
+			sleep = <&rcpm 0x00000008>;
+
 			enet0: ethernet@e0000 {
 				status = "disabled";
+				sleep = <&rcpm 0x80000000>;
 			};
 
 			enet1: ethernet@e2000 {
 				status = "disabled";
+				sleep = <&rcpm 0x40000000>;
 			};
 
 			enet2: ethernet@e4000 {
 				status = "disabled";
+				sleep = <&rcpm 0x20000000>;
 			};
 
 			enet3: ethernet@e6000 {
 				phy-handle = <&phy_rgmii_0>;
 				phy-connection-type = "rgmii";
+				sleep = <&rcpm 0x10000000>;
 			};
 
 			enet4: ethernet@e8000 {
 				phy-handle = <&phy_rgmii_1>;
 				phy-connection-type = "rgmii";
+				sleep = <&rcpm 0x08000000>;
 			};
 
 			mdio0: mdio@fc000 {
@@ -267,12 +274,10 @@
 		ethernet@3 {
 			compatible = "fsl,t1042-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet3>;
-			sleep = <&rcpm 0x10000008>;
 		};
 		ethernet@4 {
 			compatible = "fsl,t1042-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet4>;
-			sleep = <&rcpm 0x08000008>;
 		};
 	};
 };
diff --git a/arch/powerpc/boot/dts/t104xqds.dtsi b/arch/powerpc/boot/dts/t104xqds.dtsi
index b819ce0..69dff11 100644
--- a/arch/powerpc/boot/dts/t104xqds.dtsi
+++ b/arch/powerpc/boot/dts/t104xqds.dtsi
@@ -300,29 +300,36 @@
 		};
 
 		fman0: fman@400000 {
+			sleep = <&rcpm 0x00000008>;
+
 			enet0: ethernet@e0000 {
 				fixed-link = <0 1 1000 0 0>;
 				phy-connection-type = "sgmii";
+				sleep = <&rcpm 0x80000000>;
 			};
 
 			enet1: ethernet@e2000 {
 				fixed-link = <1 1 1000 0 0>;
 				phy-connection-type = "sgmii";
+				sleep = <&rcpm 0x40000000>;
 			};
 
 			enet2: ethernet@e4000 {
 				phy-handle = <&phy_s7_03>;
 				phy-connection-type = "sgmii";
+				sleep = <&rcpm 0x20000000>;
 			};
 
 			enet3: ethernet@e6000 {
 				phy-handle = <&rgmii_phy1>;
 				phy-connection-type = "rgmii";
+				sleep = <&rcpm 0x10000000>;
 			};
 
 			enet4: ethernet@e8000 {
 				phy-handle = <&rgmii_phy2>;
 				phy-connection-type = "rgmii";
+				sleep = <&rcpm 0x08000000>;
 			};
 
 			mdio0: mdio@fc000 {
@@ -342,27 +349,22 @@
 		ethernet@0 {
 			compatible = "fsl,t1040-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet0>;
-			sleep = <&rcpm 0x80000008>;
 		};
 		ethernet@1 {
 			compatible = "fsl,t1040-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet1>;
-			sleep = <&rcpm 0x40000008>;
 		};
 		ethernet@2 {
 			compatible = "fsl,t1040-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet2>;
-			sleep = <&rcpm 0x20000008>;
 		};
 		ethernet@3 {
 			compatible = "fsl,t1040-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet3>;
-			sleep = <&rcpm 0x10000008>;
 		};
 		ethernet@4 {
 			compatible = "fsl,t1040-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&enet4>;
-			sleep = <&rcpm 0x08000008>;
 		};
 		/* Enable one offline port as default to support HW based LAG */
 		dpa-fman0-oh@2 {
-- 
1.7.5.4

