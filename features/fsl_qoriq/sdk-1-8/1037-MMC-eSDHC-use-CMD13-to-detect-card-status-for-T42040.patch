From 5dc0f88414d0bb16c213aa23aa785d25e187e594 Mon Sep 17 00:00:00 2001
From: "Lu.Jiang" <lu.jiang@windriver.com>
Date: Thu, 4 Sep 2014 13:44:55 +0800
Subject: [PATCH 1037/1094] MMC/eSDHC: use CMD13 to detect card status for
 T42040QDS

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

The bit CDPL or CINS of register PRSSTAT can't reflect the card status on
on T4240QDS board. Therefore, CMD13 is used to detect the card status.

Change-Id: I832f858eb89e2db639bb8de8bf04781a85ba1c1b
Reviewed-on: http://git.am.freescale.net:8181/853
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Signed-off-by: Lu.Jiang <lu.jiang@windriver.com>
[Fix context to apply to WRL.]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/mmc/host/sdhci-of-esdhc.c | 2 ++
 drivers/mmc/host/sdhci-pltfm.c    | 1 +
 drivers/mmc/host/sdhci.h          | 1 +
 3 files changed, 4 insertions(+)

diff --git a/drivers/mmc/host/sdhci-of-esdhc.c b/drivers/mmc/host/sdhci-of-esdhc.c
index 9bf21fb..34504ad 100644
--- a/drivers/mmc/host/sdhci-of-esdhc.c
+++ b/drivers/mmc/host/sdhci-of-esdhc.c
@@ -321,6 +321,8 @@ static int esdhc_of_get_cd(struct sdhci_host *host)
 
 	if (host->flags & SDHCI_DEVICE_DEAD)
 		return 0;
+	if (host->quirks2 & SDHCI_QUIRK2_FORCE_CMD13_DETECT_CARD)
+		return -ENOSYS;
 
 	sysctl = sdhci_be32bs_readl(host, SDHCI_CLOCK_CONTROL);
 
diff --git a/drivers/mmc/host/sdhci-pltfm.c b/drivers/mmc/host/sdhci-pltfm.c
index 344a5a8..a0558e1 100644
--- a/drivers/mmc/host/sdhci-pltfm.c
+++ b/drivers/mmc/host/sdhci-pltfm.c
@@ -105,6 +105,7 @@ void sdhci_get_of_property(struct platform_device *pdev)
 		host->quirks2 |= SDHCI_QUIRK2_BROKEN_RESET_ALL;
 		host->quirks2 |= SDHCI_QUIRK2_LONG_TIME_CMD_COMPLETE_IRQ;
 		host->quirks2 |= SDHCI_QUIRK2_CIRCUIT_SUPPORT_VS33;
+		host->quirks2 |= SDHCI_QUIRK2_FORCE_CMD13_DETECT_CARD;
 	}
 
 	if (of_device_is_compatible(np, "fsl,p4860-rev1-esdhc") ||
diff --git a/drivers/mmc/host/sdhci.h b/drivers/mmc/host/sdhci.h
index 9e7972f..678f5a0 100644
--- a/drivers/mmc/host/sdhci.h
+++ b/drivers/mmc/host/sdhci.h
@@ -417,6 +417,7 @@ struct sdhci_host {
  * circuit has capability to support 3.3V
  */
 #define SDHCI_QUIRK2_CIRCUIT_SUPPORT_VS33		(1<<29)
+#define SDHCI_QUIRK2_FORCE_CMD13_DETECT_CARD		(1<<28)
 
 	int irq;		/* Device IRQ */
 	void __iomem *ioaddr;	/* Mapped address */
-- 
2.0.2

