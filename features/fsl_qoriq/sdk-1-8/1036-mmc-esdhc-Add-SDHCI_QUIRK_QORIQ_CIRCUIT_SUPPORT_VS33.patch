From c050ed4ed0903df34a5090bf5ef05a4a4b9f4afc Mon Sep 17 00:00:00 2001
From: "Lu.Jiang" <lu.jiang@windriver.com>
Date: Thu, 4 Sep 2014 13:42:58 +0800
Subject: [PATCH 1036/1094] mmc: esdhc: Add
 SDHCI_QUIRK_QORIQ_CIRCUIT_SUPPORT_VS33 quirk support

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

On the t4240 platform, sdhci controller can only supports 1.8V
voltage, but the peripheral hardware circuit has capability to
support 3.3V voltage.

Signed-off-by: Jerry Huang <Chang-Ming.Huang@freescale.com>
Signed-off-by: Chunhe Lan <Chunhe.Lan@freescale.com>
Change-Id: Ib1d25b5f70575c615d64bf85f7fed2074f8d244d
Reviewed-on: http://git.am.freescale.net:8181/852
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Signed-off-by: Lu.Jiang <lu.jiang@windriver.com>
[Fix context to apply to WRL.]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/mmc/host/sdhci-pltfm.c | 1 +
 drivers/mmc/host/sdhci.c       | 3 +++
 drivers/mmc/host/sdhci.h       | 4 ++++
 3 files changed, 8 insertions(+)

diff --git a/drivers/mmc/host/sdhci-pltfm.c b/drivers/mmc/host/sdhci-pltfm.c
index 02d00c0..344a5a8 100644
--- a/drivers/mmc/host/sdhci-pltfm.c
+++ b/drivers/mmc/host/sdhci-pltfm.c
@@ -104,6 +104,7 @@ void sdhci_get_of_property(struct platform_device *pdev)
 	if (of_device_is_compatible(np, "fsl,t4240-esdhc")) {
 		host->quirks2 |= SDHCI_QUIRK2_BROKEN_RESET_ALL;
 		host->quirks2 |= SDHCI_QUIRK2_LONG_TIME_CMD_COMPLETE_IRQ;
+		host->quirks2 |= SDHCI_QUIRK2_CIRCUIT_SUPPORT_VS33;
 	}
 
 	if (of_device_is_compatible(np, "fsl,p4860-rev1-esdhc") ||
diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.c
index bc32dc7..ea67624 100644
--- a/drivers/mmc/host/sdhci.c
+++ b/drivers/mmc/host/sdhci.c
@@ -2967,6 +2967,9 @@ int sdhci_add_host(struct sdhci_host *host)
 			host->caps1 :
 			sdhci_readl(host, SDHCI_CAPABILITIES_1);
 
+	if (host->quirks2 & SDHCI_QUIRK2_CIRCUIT_SUPPORT_VS33)
+		caps[0] = caps[0] | SDHCI_CAN_VDD_330;
+
 	if (host->quirks & SDHCI_QUIRK_FORCE_DMA)
 		host->flags |= SDHCI_USE_SDMA;
 	else if (!(caps[0] & SDHCI_CAN_DO_SDMA))
diff --git a/drivers/mmc/host/sdhci.h b/drivers/mmc/host/sdhci.h
index eb5127d..9e7972f 100644
--- a/drivers/mmc/host/sdhci.h
+++ b/drivers/mmc/host/sdhci.h
@@ -413,6 +413,10 @@ struct sdhci_host {
 #define SDHCI_QUIRK2_BROKEN_RESET_ALL			(1U<<31)
 /* Controller need long time to generate command complete interrupt */
 #define SDHCI_QUIRK2_LONG_TIME_CMD_COMPLETE_IRQ		(1<<30)
+/* Controller can only supports 1.8V, but the peripheral hardware
+ * circuit has capability to support 3.3V
+ */
+#define SDHCI_QUIRK2_CIRCUIT_SUPPORT_VS33		(1<<29)
 
 	int irq;		/* Device IRQ */
 	void __iomem *ioaddr;	/* Mapped address */
-- 
2.0.2

