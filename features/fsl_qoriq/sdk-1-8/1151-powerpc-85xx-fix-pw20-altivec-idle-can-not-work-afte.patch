From ad7496116956ab25951de73d723be38a677cc6b3 Mon Sep 17 00:00:00 2001
From: "Lu.Jiang" <lu.jiang@windriver.com>
Date: Thu, 11 Sep 2014 11:04:04 +0800
Subject: [PATCH 1151/1207] powerpc/85xx: fix pw20&altivec idle can not work
 after cpuhotplug restore

PW20 & AltiVec idle should be enabled, when the cpuhotplug restore.

Signed-off-by: Wang Dongsheng <dongsheng.wang@freescale.com>
Change-Id: Ib4d2ac24eedde0a6a814f3b5f0b42ca03e20494c
Reviewed-on: http://git.am.freescale.net:8181/4269
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Wood Scott-B07421 <scottwood@freescale.com>
Reviewed-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso,
fix content to apply to WRL kernel.]
Signed-off-by: Lu.Jiang <lu.jiang@windriver.com>
---
 arch/powerpc/kernel/cpu_setup_fsl_booke.S | 38 ++++++++++++++++++++++++++++---
 1 file changed, 35 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/kernel/cpu_setup_fsl_booke.S b/arch/powerpc/kernel/cpu_setup_fsl_booke.S
index dddba3e..bbadf22 100644
--- a/arch/powerpc/kernel/cpu_setup_fsl_booke.S
+++ b/arch/powerpc/kernel/cpu_setup_fsl_booke.S
@@ -53,23 +53,49 @@ _GLOBAL(__e500_dcache_setup)
 	isync
 	blr
 
+_GLOBAL(has_pw20_altivec_idle)
+	/* 0 false, 1 true */
+	li	r3, 0
+
+	/* PW20 & AltiVec idle feature only exists for E6500 */
+	mfspr	r0, SPRN_PVR
+	rlwinm	r4, r0, 16, 16, 31
+	lis	r12, 0
+	ori	r12, r12, PVR_VER_E6500@l
+	cmpw	r4, r12
+	bne	2f
+
+	/* Fix erratum, e6500 rev1 does not support PW20 & AltiVec idle */
+	rlwinm	r4, r0, 0, 16, 31
+	cmpwi	r4, 0x20
+	blt	2f
+	li	r3, 1
+2:
+	blr
+
 /*
  * FIXME - we haven't yet done testing to determine a reasonable default
  * value for PW20_WAIT_IDLE_BIT.
  */
 #define PW20_WAIT_IDLE_BIT		50 /* 1ms, TB frequency is 41.66MHZ */
 _GLOBAL(setup_pw20_idle)
+	mflr	r10
+	bl	.has_pw20_altivec_idle
+	mtlr	r10
+	cmpwi	r3, 0
+	beq	2f
+
 	mfspr	r3, SPRN_PWRMGTCR0
 
 	/* Set PW20_WAIT bit, enable pw20 state*/
 	ori	r3, r3, PWRMGTCR0_PW20_WAIT
-	li	r11, PW20_WAIT_IDLE_BIT
+	li      r11, PW20_WAIT_IDLE_BIT
 
 	/* Set Automatic PW20 Core Idle Count */
 	rlwimi	r3, r11, PWRMGTCR0_PW20_ENT_SHIFT, PWRMGTCR0_PW20_ENT
 
 	mtspr	SPRN_PWRMGTCR0, r3
-
+2:
 	blr
 
 /*
@@ -78,6 +104,12 @@ _GLOBAL(setup_pw20_idle)
  */
 #define AV_WAIT_IDLE_BIT		50 /* 1ms, TB frequency is 41.66MHZ */
 _GLOBAL(setup_altivec_idle)
+	mflr	r10
+	bl	.has_pw20_altivec_idle
+	mtlr	r10
+	cmpwi	r3, 0
+	beq	2f
+
 	mfspr	r3, SPRN_PWRMGTCR0
 
 	/* Enable Altivec Idle */
@@ -88,7 +120,7 @@ _GLOBAL(setup_altivec_idle)
 	rlwimi	r3, r11, PWRMGTCR0_AV_IDLE_CNT_SHIFT, PWRMGTCR0_AV_IDLE_CNT
 
 	mtspr	SPRN_PWRMGTCR0, r3
-
+2:
 	blr
 
 #ifdef CONFIG_PPC_E500MC
-- 
2.0.2

