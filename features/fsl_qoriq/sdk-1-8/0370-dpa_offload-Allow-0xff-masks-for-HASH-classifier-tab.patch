From e5ecdb5dfe57283012ec9be9c09ac448b2218980 Mon Sep 17 00:00:00 2001
From: Marian Chereji <marian.chereji@freescale.com>
Date: Tue, 24 Sep 2013 18:20:39 +0300
Subject: [PATCH 370/987] dpa_offload: Allow 0xff masks for HASH classifier
 table entries

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

As key masks are not supported in HASH tables, the DPA Classifier was
refusing to add an entry to a HASH table with a key that had
any mask (mask pointer not NULL). This was changed so that the DPA
Classifier can recognize a 0xff mask all over and ignore it. Any other
(more complex) mask will still be refused.

Change-Id: I0732d873fa5d10def4f2646c2bd248aadcffa736
Signed-off-by: Marian Chereji <marian.chereji@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/4911
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Bulie Radu-Andrei-B37577 <Radu.Bulie@freescale.com>
Reviewed-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
---
 drivers/staging/fsl_dpa_offload/dpa_classifier.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_classifier.c b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
index 5056b2e..3dc35bc 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_classifier.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
@@ -2567,8 +2567,12 @@ static int table_insert_entry_hash(struct dpa_cls_table		*cls_table,
 	}
 
 	if (key->mask) {
-		log_err("Key masks are not supported by HASH tables.\n");
-		return -EINVAL;
+		/* Only full 0xFF masks supported: */
+		for (j = 0; j < key->size; j++)
+			if (key->mask[j] ^ 0xff) {
+				log_err("Only key masks 0xff all over are supported by HASH tables.\n");
+				return -EINVAL;
+			}
 	}
 
 	memset(&key_params, 0, sizeof(t_FmPcdCcKeyParams));
-- 
1.9.1

