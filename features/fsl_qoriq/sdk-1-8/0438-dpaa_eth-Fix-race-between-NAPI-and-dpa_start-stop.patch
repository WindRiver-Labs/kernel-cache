From 6078a3716f53444e03ba4370f4198acd1133a5db Mon Sep 17 00:00:00 2001
From: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
Date: Mon, 25 Nov 2013 12:57:03 +0200
Subject: [PATCH 438/987] dpaa_eth: Fix race between NAPI and dpa_start/stop

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

While bringing the interface down, between dpa_stop() and napi_disable()
there might be frames still in the ingress (Rx, TxConfirm) queues.
This is only possible under high load, when ksoftirqd is running; in
such cases, though, we must allow for the ingress queues to drain before
we bring NAPI down, lest we permanently deplete our buffer pools and
freeze the interface.

Signed-off-by: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
Signed-off-by: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Change-Id: Ic0900da89824ee3b64a316ed2e863982c3bc2461
Reviewed-on: http://git.am.freescale.net:8181/6852
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Cristian-Constantin Sovaiala <Cristian.Sovaiala@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/7669
Reviewed-by: Madalin-Cristian Bucur <madalin.bucur@freescale.com>
Tested-by: Madalin-Cristian Bucur <madalin.bucur@freescale.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index c8bf6dd..669edeb 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -516,6 +516,12 @@ static int __cold dpa_eth_priv_stop(struct net_device *net_dev)
 	struct dpa_priv_s *priv;
 
 	_errno = dpa_stop(net_dev);
+	/* Allow NAPI to consume any frame still in the Rx/TxConfirm
+	 * ingress queues. This is to avoid a race between the current
+	 * context and ksoftirqd which could leave NAPI disabled while
+	 * in fact there's still Rx traffic to be processed.
+	 */
+	usleep_range(5000, 10000);
 
 	priv = netdev_priv(net_dev);
 	dpaa_eth_napi_disable(priv);
-- 
1.9.1

