From 2680598e4584f0394f06e5b9d738e3040b94775f Mon Sep 17 00:00:00 2001
From: Cristian Sovaiala <cristian.sovaiala@freescale.com>
Date: Fri, 22 Feb 2013 13:40:51 +0000
Subject: [PATCH 057/987] dpaa_eth: Add FQ taildrop threshold for mac-less
 devices

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

FQ taildrop threshold is set by each partition on its RX frame queues
which are the TX queues of the other partition.
It is safe to rely on one partition to set the FQ taildrop threshold
on behalf of the other partition because the ERN notifications will
be delivered to the portal enqueueing the frames.

Change-Id: I6a3ab6511a7e2bbe293cc68ddae4d17e075cf4fa
Signed-off-by: Cristian Sovaiala <cristian.sovaiala@freescale.com>
(cherry picked from commit 1c20f0e8cb943f31eb2ad8c626a4c9fd9c8421b6)
Reviewed-on: http://git.am.freescale.net:8181/1055
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c | 19 +++++++++++++++++++
 1 file changed, 19 insertions(+)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 3253243..339a9a7 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -96,6 +96,9 @@
  */
 #define DPA_CS_THRESHOLD_1G	0x06000000
 
+/* Size in bytes of the FQ taildrop threshold */
+#define DPA_FQ_TD		0x200000
+
 /* S/G table requires at least 256 bytes */
 #define SGT_BUFFER_SIZE		DPA_BP_SIZE(256)
 
@@ -640,6 +643,22 @@ _dpa_fq_alloc(struct list_head *list, struct dpa_fq *dpa_fq)
 		}
 
 		/*
+		 * For MAC-less devices we only get here for RX frame queues
+		 * initialization, which are the TX queues of the other
+		 * partition.
+		 * It is safe to rely on one partition to set the FQ taildrop
+		 * threshold for the TX queues of the other partition
+		 * because the ERN notifications will be received by the
+		 * partition doing qman_enqueue.
+		 */
+		if (!priv->mac_dev) {
+			initfq.we_mask |= QM_INITFQ_WE_TDTHRESH;
+			qm_fqd_taildrop_set(&initfq.fqd.td,
+					DPA_FQ_TD, 1);
+			initfq.fqd.fq_ctrl = QM_FQCTRL_TDE;
+		}
+
+		/*
 		 * Configure the Tx confirmation queue, now that we know
 		 * which Tx queue it pairs with.
 		 */
-- 
1.9.1

