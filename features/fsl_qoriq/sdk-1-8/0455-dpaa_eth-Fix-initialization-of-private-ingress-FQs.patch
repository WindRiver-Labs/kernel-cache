From 431cc6abe6c4036daed965e5260676bfc23f5e59 Mon Sep 17 00:00:00 2001
From: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
Date: Mon, 9 Dec 2013 16:59:54 +0200
Subject: [PATCH 455/987] dpaa_eth: Fix initialization of private ingress FQs

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

The code which places the driver's ingress FQs in the "ingress CGR" must
only be run by the private DPAA Ethernet driver, which is the only one
to create that CGR.

Signed-off-by: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/7183
Reviewed-by: Marian Cristian Rotariu <marian.rotariu@freescale.com>
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
Reviewed-by: Ruxandra Ioana Radulescu <ruxandra.radulescu@freescale.com>
Change-Id: Id99863aeb3f9eb1dc32cb0234623d087eae4a1d7
Reviewed-on: http://git.am.freescale.net:8181/7358
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/7691
Reviewed-by: Madalin-Cristian Bucur <madalin.bucur@freescale.com>
Tested-by: Madalin-Cristian Bucur <madalin.bucur@freescale.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c        | 8 +++++++-
 drivers/net/ethernet/freescale/dpa/dpaa_eth.h        | 1 +
 drivers/net/ethernet/freescale/dpa/dpaa_eth_common.c | 9 +++++----
 3 files changed, 13 insertions(+), 5 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index a7a5947..f549d44 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -686,7 +686,6 @@ dpa_priv_bp_probe(struct device *dev)
  * this CGR to generate enqueue rejections to FMan in order to drop the frames
  * before they reach our ingress queues and eat up memory.
  */
-#define DPA_INGRESS_CS_THRESHOLD	0x10000000
 static int dpaa_eth_priv_ingress_cgr_init(struct dpa_priv_s *priv)
 {
 	struct qm_mcc_initcgr initcgr;
@@ -722,6 +721,13 @@ static int dpaa_eth_priv_ingress_cgr_init(struct dpa_priv_s *priv)
 	pr_debug("Created ingress CGR %d for netdev with hwaddr %pM\n",
 		 priv->ingress_cgr.cgrid, priv->mac_dev->addr);
 
+	/* struct qman_cgr allows special cgrid values (i.e. outside the 0..255
+	 * range), but we have no common initialization path between the
+	 * different variants of the DPAA Eth driver, so we do it here rather
+	 * than modifying every other variant than "private Eth".
+	 */
+	priv->use_ingress_cgr = true;
+
 out_error:
 	return err;
 }
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.h b/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
index 88aa4d8..211288d 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
@@ -396,6 +396,7 @@ struct dpa_priv_s {
 		u32 cgr_congested_count;
 	} cgr_data;
 	/* Use a per-port CGR for ingress traffic. */
+	bool use_ingress_cgr;
 	struct qman_cgr ingress_cgr;
 
 #ifdef CONFIG_FSL_DPAA_TS
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.c
index 878b035..c6e6303 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.c
@@ -1279,10 +1279,11 @@ int dpa_fq_init(struct dpa_fq *dpa_fq, bool td_enable)
 		}
 #endif
 
-		/* Put all ingress queues in our "ingress CGR". */
-		if (dpa_fq->fq_type == FQ_TYPE_RX_DEFAULT ||
-				dpa_fq->fq_type == FQ_TYPE_RX_ERROR ||
-				dpa_fq->fq_type == FQ_TYPE_RX_PCD) {
+		/* Put all *private* ingress queues in our "ingress CGR". */
+		if (priv->use_ingress_cgr &&
+				(dpa_fq->fq_type == FQ_TYPE_RX_DEFAULT ||
+				 dpa_fq->fq_type == FQ_TYPE_RX_ERROR ||
+				 dpa_fq->fq_type == FQ_TYPE_RX_PCD)) {
 			initfq.we_mask |= QM_INITFQ_WE_CGID;
 			initfq.fqd.fq_ctrl |= QM_FQCTRL_CGE;
 			initfq.fqd.cgid = priv->ingress_cgr.cgrid;
-- 
1.9.1

