From 021269bb2baaf0383f3de3c19d8e5e5b60ecab55 Mon Sep 17 00:00:00 2001
From: Anca Jeanina Floarea <anca.floarea@freescale.com>
Date: Mon, 15 Sep 2014 16:34:40 +0300
Subject: [PATCH 811/987] dpa_offload: Check SA returned by get_sa_from_sa_id

In function dpa_ipsec_free the SA returned by function
get_sa_from_sa_id can be NULL in case of an error. Fixed
this by adding BUG_ON on returned SA.

Signed-off-by: Anca Jeanina Floarea <anca.floarea@freescale.com>
Change-Id: Id663dec2c47cd2eacce8c2a5ca1f00639df08bba
Reviewed-on: http://git.am.freescale.net:8181/18802
Reviewed-by: Marian-Cornel Chereji <marian.chereji@freescale.com>
Tested-by: Marian-Cornel Chereji <marian.chereji@freescale.com>
[Lu:Original patch taken from
QorIQ-SDK-V1.7-SOURCE-20141218-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index 3e14ca5..0c0c311 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -3657,6 +3657,7 @@ int dpa_ipsec_free(int dpa_ipsec_id)
 		sa_id = instance->used_sa_ids[i];
 		if (sa_id != DPA_OFFLD_INVALID_OBJECT_ID) {
 			sa = get_sa_from_sa_id(instance, sa_id);
+			BUG_ON(!sa);
 			if (sa_is_inbound(sa)) {
 				if (sa_is_child(sa))
 					remove_inbound_sa(sa->parent_sa);
-- 
1.9.1

