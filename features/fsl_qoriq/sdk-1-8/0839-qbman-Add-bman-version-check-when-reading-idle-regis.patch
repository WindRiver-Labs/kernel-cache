From eb17525171dd2d78d6de4c68422b0c484a5e11f3 Mon Sep 17 00:00:00 2001
From: Jeffrey Ladouceur <Jeffrey.Ladouceur@freescale.com>
Date: Tue, 2 Dec 2014 10:30:35 -0500
Subject: [PATCH 839/987] qbman: Add bman version check when reading idle
 register

The STATE_IDLE register was added to BMan hw version 2.1.0
Anything earlier than this will return undefined value.

This is required in order to not abort suspend phase due to false information

Change-Id: I055b37571fc7d500018e8a736cbfffc8e5920f3f
Signed-off-by: Jeffrey Ladouceur <Jeffrey.Ladouceur@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/24834
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Haiying Wang <Haiying.Wang@freescale.com>
Reviewed-by: Roy Pledge <roy.pledge@freescale.com>
Reviewed-by: Geoff Thorpe <Geoff.Thorpe@freescale.com>
Reviewed-by: Matthew Weigel <Matthew.Weigel@freescale.com>
[Lu:Original patch taken from
QorIQ-SDK-V1.7-SOURCE-20141218-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/staging/fsl_qbman/bman_config.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/drivers/staging/fsl_qbman/bman_config.c b/drivers/staging/fsl_qbman/bman_config.c
index 06c3a6b..b67e2f2 100644
--- a/drivers/staging/fsl_qbman/bman_config.c
+++ b/drivers/staging/fsl_qbman/bman_config.c
@@ -799,6 +799,12 @@ static int bman_pm_suspend_noirq(struct device *dev)
 	bm_err_isr_disable_write(bm, 0xffffffff);
 	bm_err_isr_status_clear(bm, 0xffffffff);
 
+	if (bman_ip_rev < BMAN_REV21) {
+#ifdef CONFIG_PM_DEBUG
+		pr_info("Bman version doesn't have STATE_IDLE\n");
+#endif
+		return 0;
+	}
 	idle_state = bm_in(STATE_IDLE);
 	if (!(idle_state & 0x1)) {
 		pr_err("Bman not idle 0x%x aborting\n", idle_state);
-- 
1.9.1

