From c7b1be691a5571dbd277041eb12d264ab8de3801 Mon Sep 17 00:00:00 2001
From: Shengzhou Liu <Shengzhou.Liu@freescale.com>
Date: Tue, 7 May 2013 11:04:08 +0800
Subject: [PATCH 171/987] fmd: update ptp timer config

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

There were three separated definitions for the ptp timer nominal clock
frequency in fmd, dpaa-eth and 1588 drivers.
Now we use an unified macro DPA_PTP_NOMINAL_FREQ_PERIOD_NS for
the ptp timer clock config instead of the previous separated settings.
To keep DPA_PTP_NOMINAL_FREQ_PERIOD_NS is power of 2 will lead to better
1588 performance with less calculation(save 10% CPU load).

Signed-off-by: Shengzhou Liu <Shengzhou.Liu@freescale.com>
Change-Id: I8dbcb11cd546c1c0ba1cf63afd26a4a2502d9365
Reviewed-on: http://git.am.freescale.net:8181/2215
Reviewed-by: Bucur Madalin-Cristian-B32716 <madalin.bucur@freescale.com>
Reviewed-by: Lavi Mandy-R52568 <Mandy.Lavi@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
---
 drivers/net/ethernet/freescale/fman/src/inc/wrapper/lnxwrp_fsl_fman.h | 3 +++
 drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm.c           | 2 +-
 2 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/freescale/fman/src/inc/wrapper/lnxwrp_fsl_fman.h b/drivers/net/ethernet/freescale/fman/src/inc/wrapper/lnxwrp_fsl_fman.h
index 595a7c7..8adf489 100644
--- a/drivers/net/ethernet/freescale/fman/src/inc/wrapper/lnxwrp_fsl_fman.h
+++ b/drivers/net/ethernet/freescale/fman/src/inc/wrapper/lnxwrp_fsl_fman.h
@@ -343,5 +343,8 @@ int fm_port_del_rate_limit(struct fm_port *port);
 /** @} */ /* end of FM_LnxKern_ctrl_grp group */
 /** @} */ /* end of FM_LnxKern_grp group */
 
+/* default values for initializing PTP 1588 timer clock */
+#define DPA_PTP_NOMINAL_FREQ_PERIOD_SHIFT 2 /* power of 2 for better performance */
+#define DPA_PTP_NOMINAL_FREQ_PERIOD_NS (1 << DPA_PTP_NOMINAL_FREQ_PERIOD_SHIFT) /* 4ns,250MHz */
 
 #endif /* __LNXWRP_FSL_FMAN_H */
diff --git a/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm.c b/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm.c
index a4f6166..dde00e5 100644
--- a/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm.c
+++ b/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm.c
@@ -922,7 +922,7 @@ static t_Error InitFmDev(t_LnxWrpFmDev  *p_LnxWrpFmDev)
         if(!(p_LnxWrpFmDev->h_RtcDev = FM_RTC_Config(&fmRtcParam)))
             RETURN_ERROR(MAJOR, E_INVALID_HANDLE, ("FM-RTC"));
 
-	if (FM_RTC_ConfigPeriod(p_LnxWrpFmDev->h_RtcDev, 5) != E_OK)
+	if (FM_RTC_ConfigPeriod(p_LnxWrpFmDev->h_RtcDev, DPA_PTP_NOMINAL_FREQ_PERIOD_NS) != E_OK)
 	    RETURN_ERROR(MAJOR, E_INVALID_STATE, ("FM-RTC"));
 
         if (FM_RTC_Init(p_LnxWrpFmDev->h_RtcDev) != E_OK)
-- 
1.9.1

