From 1730ea3f830264e581524b9ac1c29d02b83e429f Mon Sep 17 00:00:00 2001
From: Xulin Sun <xulin.sun@windriver.com>
Date: Wed, 30 Oct 2013 16:54:51 +0800
Subject: [PATCH 1180/1207] powerpc/85xx: enable timebase synchronization for
 KEXEC

timebase synchronization among multiple cores was inhibited during the
booting system state since bootloader done this, but for KEXEC this caused
multiple cores have their separate timebase value and not on the same time line
for SMP to make KEXEC hang for P2020.

Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 arch/powerpc/platforms/85xx/smp.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/arch/powerpc/platforms/85xx/smp.c b/arch/powerpc/platforms/85xx/smp.c
index e5cbbe4..bf09df9 100644
--- a/arch/powerpc/platforms/85xx/smp.c
+++ b/arch/powerpc/platforms/85xx/smp.c
@@ -102,9 +102,11 @@ static void __cpuinit mpc85xx_give_timebase(void)
 {
 	unsigned long flags;
 
+#ifndef CONFIG_KEXEC
 	/* only do time base sync when system is running */
 	if (system_state == SYSTEM_BOOTING)
 		return;
+#endif
 	/*
 	 * If the booting thread is not the first thread of the core,
 	 * skip time base sync.
@@ -161,8 +163,10 @@ static void __cpuinit mpc85xx_take_timebase(void)
 {
 	unsigned long flags;
 
+#ifndef CONFIG_KEXEC
 	if (system_state == SYSTEM_BOOTING)
 		return;
+#endif
 
 	if (smt_capable() &&
 		cur_booting_core != cpu_first_thread_sibling(cur_booting_core))
-- 
2.0.2

