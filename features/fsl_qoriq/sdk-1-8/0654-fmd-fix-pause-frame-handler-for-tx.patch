From 34702151b4231fdd22be9acfdf99853be0e14f37 Mon Sep 17 00:00:00 2001
From: Marian Rotariu <marian.rotariu@freescale.com>
Date: Wed, 23 Apr 2014 20:06:48 +0300
Subject: [PATCH 654/987] fmd: fix pause frame handler for tx

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

"Command Config" register for mEMAC gets corrupted being wrongfully initialized
with "TX FIFO Sections" register values.

Signed-off-by: Marian Rotariu <marian.rotariu@freescale.com>
Change-Id: Ifa6c0fe497e45e9864acd3ed9dbae2aa1af45a50
Reviewed-on: http://git.am.freescale.net:8181/11405
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Vakul Garg <vakul@freescale.com>
Reviewed-by: Mircea Pop <mircea.pop@freescale.com>
Reviewed-by: Madalin-Cristian Bucur <madalin.bucur@freescale.com>
(cherry picked from commit db26a2e672299a318b2b941ad28fddba8c38a747)
Reviewed-on: http://git.am.freescale.net:8181/11472
Tested-by: Madalin-Cristian Bucur <madalin.bucur@freescale.com>
---
 drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/fman_memac.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/fman_memac.c b/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/fman_memac.c
index 1fcb1ee..a79c208 100644
--- a/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/fman_memac.c
+++ b/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/fman_memac.c
@@ -284,6 +284,7 @@ void fman_memac_set_tx_pause_frames(struct memac_regs *regs,
 		GET_TX_EMPTY_DEFAULT_VALUE(tmp);
 		iowrite32be(tmp, &regs->tx_fifo_sections);
 
+		tmp = ioread32be(&regs->command_config);
 		tmp &= ~CMD_CFG_PFC_MODE;
 		priority = 0;
 	} else {
-- 
1.9.1

