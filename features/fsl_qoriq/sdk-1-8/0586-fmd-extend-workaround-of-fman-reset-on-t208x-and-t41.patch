From 910502422267906e29f9138da65b6a0dc4739fa1 Mon Sep 17 00:00:00 2001
From: Shengzhou Liu <Shengzhou.Liu@freescale.com>
Date: Wed, 11 Dec 2013 16:44:55 +0800
Subject: [PATCH 586/987] fmd: extend workaround of fman reset on t208x and
 t4160v2

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

The same hang issue was observed on T208x and T4160v2 also.
So extend the workaround for now.

Signed-off-by: Shengzhou Liu <Shengzhou.Liu@freescale.com>
Signed-off-by: Shaohui Xie <Shaohui.Xie@freescale.com>
Signed-off-by: Mandy Lavi <mandy.lavi@freescale.com>
Change-Id: If75d58a3d609f3607050c0cf306d9c86aa69cfaf
Reviewed-on: http://git.am.freescale.net:8181/7205
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
Tested-by: Jose Rivera <German.Rivera@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/9450
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
---
 arch/powerpc/include/asm/mpc85xx.h                      | 2 ++
 drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c | 5 ++++-
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/arch/powerpc/include/asm/mpc85xx.h b/arch/powerpc/include/asm/mpc85xx.h
index 213f3a8..1530a9d 100644
--- a/arch/powerpc/include/asm/mpc85xx.h
+++ b/arch/powerpc/include/asm/mpc85xx.h
@@ -58,6 +58,8 @@
 #define SVR_P5020	0x822000
 #define SVR_P5021	0X820500
 #define SVR_P5040	0x820400
+#define SVR_T2080	0x853000
+#define SVR_T2081	0x853100
 #define SVR_T4240	0x824000
 #define SVR_T4120	0x824001
 #define SVR_T4160	0x824100
diff --git a/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c b/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c
index dfc1cdb..14579f7 100644
--- a/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c
+++ b/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c
@@ -3516,7 +3516,10 @@ t_Error FM_Init(t_Handle h_Fm)
     {
 	u32 svr = mfspr(SPRN_SVR);
 
-	if (SVR_SOC_VER(svr) == SVR_T4240 && SVR_REV(svr) > 0x10) {
+	if (((SVR_SOC_VER(svr) == SVR_T4240 && SVR_REV(svr) > 0x10)) ||
+	    ((SVR_SOC_VER(svr) == SVR_T4160 && SVR_REV(svr) > 0x10)) ||
+	    (SVR_SOC_VER(svr) == SVR_T2080) ||
+	    (SVR_SOC_VER(svr) == SVR_T2081)) {
 		DBG(WARNING, ("Hack: No FM reset!\n"));
 	} else {
 		WRITE_UINT32(p_Fm->p_FmFpmRegs->fm_rstc, FPM_RSTC_FM_RESET);
-- 
1.9.1

