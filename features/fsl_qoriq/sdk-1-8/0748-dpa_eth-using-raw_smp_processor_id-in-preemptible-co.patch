From 7402705298d757d0017424abf1939ce6f17cc58f Mon Sep 17 00:00:00 2001
From: "Roy.Li" <rongqing.li@windriver.com>
Date: Thu, 6 Nov 2014 16:56:52 +0800
Subject: [PATCH 748/987] dpa_eth: using raw_smp_processor_id in preemptible
 context

dpa_get_queue_mapping() maybe called in preemptible context, so replace
smp_processor_id with raw_smp_processor_id in it

There was Call Trace/BUG information during the testing
[14590.585773] BUG: using smp_processor_id() in preemptible [00000000] code: arping/6288
[14590.592331] caller is .dpa_select_queue+0x18/0x30
[14590.595746] CPU: 2 PID: 6288 Comm: arping Not tainted 3.14.22-WR7.0.0.0_standard #1
[14590.602112] Call Trace:
[14590.603260] [c0000000ab473670] [c00000000000a804] .show_stack+0x168/0x278 (unreliable)
[14590.609904] [c0000000ab473760] [c000000000bbec88] .dump_stack+0x9c/0xfc
[14590.615256] [c0000000ab4737e0] [c0000000005c5fec] .debug_smp_processor_id+0x128/0x130
[14590.621807] [c0000000ab473870] [c0000000008048d4] .dpa_select_queue+0x18/0x30
[14590.627662] [c0000000ab4738e0] [c000000000b6c6e0] .packet_pick_tx_queue+0x60/0x108
[14590.633949] [c0000000ab473970] [c000000000b71090] .packet_sendmsg+0xdb8/0xf68
[14590.639807] [c0000000ab473ac0] [c000000000a31bac] .sock_sendmsg+0x94/0xf0
[14590.645313] [c0000000ab473c20] [c000000000a34ed0] .SyS_sendto+0x100/0x148
[14590.650822] [c0000000ab473d90] [c000000000a80650] .compat_sys_socketcall+0x21c/0x36

Signed-off-by: Roy.Li <rongqing.li@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.h | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.h b/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
index ca5ad85..9a0e6d5 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
@@ -608,13 +608,13 @@ static inline void _dpa_assign_wq(struct dpa_fq *fq)
 #ifdef CONFIG_FMAN_PFC
 #define dpa_get_queue_mapping(skb) \
 	(((skb)->priority < CONFIG_FMAN_PFC_COS_COUNT) ? \
-		((skb)->priority * dpa_num_cpus + smp_processor_id()) : \
+		((skb)->priority * dpa_num_cpus + raw_smp_processor_id()) : \
 		((CONFIG_FMAN_PFC_COS_COUNT - 1) * \
 			dpa_num_cpus + smp_processor_id()));
 
 #else
 #define dpa_get_queue_mapping(skb) \
-	smp_processor_id()
+	raw_smp_processor_id()
 #endif
 #else
 /* Use the queue selected by XPS */
-- 
1.9.1

