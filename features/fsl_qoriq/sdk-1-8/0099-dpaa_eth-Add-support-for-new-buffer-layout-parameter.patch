From 17354957968ebbfea7c13e24bf447ad729954ad9 Mon Sep 17 00:00:00 2001
From: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Date: Wed, 17 Apr 2013 19:42:36 +0000
Subject: [PATCH 099/987] dpaa_eth: Add support for new buffer layout
 parameters

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

The new chosen node mechanism allows a user to configure some extra
per port parameters related to buffer layout. Add support in the
ethernet driver to account for these new parameters and the changes
in FMD wrapper API.

Signed-off-by: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Change-Id: I54ef34be7b2ce1b644245816cbf234c8c6d8dcab
Reviewed-on: http://git.am.freescale.net:8181/1468
Reviewed-by: Bucur Madalin-Cristian-B32716 <madalin.bucur@freescale.com>
Reviewed-by: Sovaiala Cristian-Constantin-B39531 <Cristian.Sovaiala@freescale.com>
Reviewed-by: Bercaru Cristian-B43982 <cristian.bercaru@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth-common.h |  5 +++++
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c        |  8 ++++++++
 drivers/net/ethernet/freescale/dpa/dpaa_eth.h        | 15 +++++++++++----
 drivers/net/ethernet/freescale/dpa/offline_port.c    | 12 ++++++++++--
 4 files changed, 34 insertions(+), 6 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth-common.h b/drivers/net/ethernet/freescale/dpa/dpaa_eth-common.h
index ac34130..e33bf01 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth-common.h
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth-common.h
@@ -55,11 +55,14 @@ enum dpa_fq_type {
 #endif
 };
 
+/* TODO: This structure should be renamed & moved to the FMD wrapper */
 struct dpa_buffer_layout_s {
 	uint16_t	priv_data_size;
 	bool		parse_results;
 	bool		time_stamp;
 	bool		hash_results;
+	uint8_t		manip_extra_space;
+	uint16_t	data_align;
 };
 
 #define DPA_TX_PRIV_DATA_SIZE	16
@@ -77,6 +80,8 @@ struct dpa_buffer_layout_s {
 	param.hash_results = buf_layout->hash_results; \
 	param.frag_enable = false; \
 	param.time_stamp = buf_layout->time_stamp; \
+	param.manip_extra_space = buf_layout->manip_extra_space; \
+	param.data_align = buf_layout->data_align; \
 	fm_set_##type##_port_params(port, &param); \
 }
 
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index bf8d1c9..268075a 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -1487,12 +1487,18 @@ static struct dpa_bp *dpa_size2pool(struct dpa_priv_s *priv, size_t size)
 static void dpa_set_buffer_layout(struct dpa_priv_s *priv, struct fm_port *port,
 				  struct dpa_buffer_layout_s *layout, int type)
 {
+	struct fm_port_params params;
+
 	layout->priv_data_size = (type == RX ?
 			DPA_RX_PRIV_DATA_SIZE : DPA_TX_PRIV_DATA_SIZE);
 	layout->parse_results = true;
 	layout->hash_results = true;
 	if (priv && priv->tsu && priv->tsu->valid)
 		layout->time_stamp = true;
+
+	fm_port_get_buff_layout_ext_params(port, &params);
+	layout->manip_extra_space = params.manip_extra_space;
+	layout->data_align = params.data_align;
 }
 
 /**
@@ -3635,6 +3641,7 @@ dpaa_eth_init_tx_port(struct fm_port *port, struct dpa_fq *errq,
 {
 	struct fm_port_params tx_port_param;
 
+	memset(&tx_port_param, 0, sizeof(tx_port_param));
 	dpaa_eth_init_port(tx, port, tx_port_param, errq->fqid, defq->fqid,
 			   buf_layout);
 }
@@ -3647,6 +3654,7 @@ dpaa_eth_init_rx_port(struct fm_port *port, struct dpa_bp *bp, size_t count,
 	struct fm_port_params rx_port_param;
 	int i;
 
+	memset(&rx_port_param, 0, sizeof(rx_port_param));
 	count = min(ARRAY_SIZE(rx_port_param.pool_param), count);
 	rx_port_param.num_pools = count;
 	for (i = 0; i < count; i++) {
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.h b/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
index 60e165f..9c946aa 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
@@ -488,18 +488,25 @@ static inline int dpa_check_rx_mtu(struct sk_buff *skb, int mtu)
 
 static inline uint16_t dpa_get_headroom(struct dpa_buffer_layout_s *bl)
 {
+	uint16_t headroom;
 	/* The frame headroom must accomodate:
 	 * - the driver private data area
 	 * - parse results, hash results, timestamp if selected
+	 * - manip extra space
 	 * If either hash results or time stamp are selected, both will
 	 * be copied to/from the frame headroom, as TS is located between PR and
 	 * HR in the IC and IC copy size has a granularity of 16bytes
 	 * (see description of FMBM_RICP and FMBM_TICP registers in DPAARM)
+	 *
+	 * Also make sure the headroom is a multiple of data_align bytes
 	 */
-	return bl->priv_data_size +
-		(bl->parse_results ? DPA_PARSE_RESULTS_SIZE : 0) +
-		(bl->hash_results || bl->time_stamp ?
-		 DPA_TIME_STAMP_SIZE + DPA_HASH_RESULTS_SIZE : 0);
+	headroom = bl->priv_data_size +
+		   (bl->parse_results ? DPA_PARSE_RESULTS_SIZE : 0) +
+		   (bl->hash_results || bl->time_stamp ?
+		    DPA_TIME_STAMP_SIZE + DPA_HASH_RESULTS_SIZE : 0) +
+		   bl->manip_extra_space;
+
+	return bl->data_align ? ALIGN(headroom, bl->data_align) : headroom;
 }
 
 static inline uint16_t dpa_get_buffer_size(struct dpa_buffer_layout_s *bl,
diff --git a/drivers/net/ethernet/freescale/dpa/offline_port.c b/drivers/net/ethernet/freescale/dpa/offline_port.c
index bdde1b29..af00f85 100644
--- a/drivers/net/ethernet/freescale/dpa/offline_port.c
+++ b/drivers/net/ethernet/freescale/dpa/offline_port.c
@@ -97,12 +97,19 @@ static int __cold oh_free_pcd_fqids(struct device *dev, uint32_t base_fqid)
 	return 0;
 }
 
-static void oh_set_buffer_layout(struct dpa_buffer_layout_s *layout)
+static void oh_set_buffer_layout(struct fm_port *port,
+				 struct dpa_buffer_layout_s *layout)
 {
+	struct fm_port_params params;
+
 	layout->priv_data_size = DPA_TX_PRIV_DATA_SIZE;
 	layout->parse_results = true;
 	layout->hash_results = true;
 	layout->time_stamp = false;
+
+	fm_port_get_buff_layout_ext_params(port, &params);
+	layout->manip_extra_space = params.manip_extra_space;
+	layout->data_align = params.data_align;
 }
 
 static int
@@ -272,8 +279,9 @@ oh_port_probe(struct platform_device *_of_dev)
 		goto return_kfree;
 	}
 
-	oh_set_buffer_layout(&buf_layout);
+	oh_set_buffer_layout(oh_config->oh_port, &buf_layout);
 	/* Set Tx params */
+	memset(&oh_port_tx_params, 0, sizeof(oh_port_tx_params));
 	dpaa_eth_init_port(tx, oh_config->oh_port, oh_port_tx_params,
 		oh_config->error_fqid, oh_config->default_fqid, (&buf_layout));
 	/* Set PCD params */
-- 
1.9.1

