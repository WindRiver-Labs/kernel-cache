From b9ee4bce8156d2c6c67929f2302750dd8ab1652b Mon Sep 17 00:00:00 2001
From: Pan Jiafei <Jiafei.Pan@freescale.com>
Date: Fri, 12 Sep 2014 16:00:31 +0800
Subject: [PATCH 792/987] capwap: fragmentation using a seperate bp

This can avoid buffer pool is exhausted by others,
so that it can avoid deadlock for outbound OP.

Signed-off-by: Pan Jiafei <Jiafei.Pan@freescale.com>
Change-Id: I6fd1a604e0ae004837e02a4ac925360967da9827
Reviewed-on: http://git.am.freescale.net:8181/21441
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Jianhua Xie <jianhua.xie@freescale.com>
Reviewed-by: Shengzhou Liu <Shengzhou.Liu@freescale.com>
[Lu:Original patch taken from
QorIQ-SDK-V1.7-SOURCE-20141218-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/capwap/dpaa_capwap_domain.c     | 6 ++++++
 drivers/net/ethernet/freescale/dpa/capwap/dpaa_capwap_domain_ext.h | 5 +++++
 2 files changed, 11 insertions(+)

diff --git a/drivers/net/ethernet/freescale/dpa/capwap/dpaa_capwap_domain.c b/drivers/net/ethernet/freescale/dpa/capwap/dpaa_capwap_domain.c
index 419bde0..5251820 100644
--- a/drivers/net/ethernet/freescale/dpa/capwap/dpaa_capwap_domain.c
+++ b/drivers/net/ethernet/freescale/dpa/capwap/dpaa_capwap_domain.c
@@ -1084,6 +1084,12 @@ int add_out_tunnel(struct dpaa_capwap_domain *capwap_domain,
 		fm_pcd_manip_params->u.frag.hdr = HEADER_TYPE_CAPWAP;
 		fm_pcd_manip_params->u.frag.u.capwapFrag.sizeForFragmentation =
 			out_tunnel_params->size_for_fragment;
+		if (out_tunnel_params->frag_bp_enable) {
+			fm_pcd_manip_params->u.frag.u.capwapFrag.sgBpidEn =
+				TRUE;
+			fm_pcd_manip_params->u.frag.u.capwapFrag.sgBpid =
+				out_tunnel_params->frag_bp_id;
+		}
 		p_tunnel->h_capwap_frag =
 			FM_PCD_ManipNodeSet(capwap_domain->h_fm_pcd,
 					fm_pcd_manip_params);
diff --git a/drivers/net/ethernet/freescale/dpa/capwap/dpaa_capwap_domain_ext.h b/drivers/net/ethernet/freescale/dpa/capwap/dpaa_capwap_domain_ext.h
index b67d1f9..ad1e8e3 100644
--- a/drivers/net/ethernet/freescale/dpa/capwap/dpaa_capwap_domain_ext.h
+++ b/drivers/net/ethernet/freescale/dpa/capwap/dpaa_capwap_domain_ext.h
@@ -170,6 +170,11 @@ struct dpaa_capwap_domain_tunnel_out_params {
 					 * required and will be build by
 					 * the driver
 					 */
+	bool frag_bp_enable;	/* If set, Framentation will use a seperate
+				 * Buffer Pool. otherwise, fragmentation will
+				 * use the same buffer pool as input frame
+				 */
+	uint8_t	frag_bp_id;	/* Buffer Pool ID used by fragmentation */
 	bool dtls;		/* DTLS tunnel */
 	bool is_control;	/* true: control tunnel, false: data tunnel */
 
-- 
1.9.1

