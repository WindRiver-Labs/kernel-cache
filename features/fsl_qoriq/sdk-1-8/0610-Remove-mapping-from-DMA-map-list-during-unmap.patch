From 0bc8d745956028da6b943003a85fe8337318cb05 Mon Sep 17 00:00:00 2001
From: Roy Pledge <Roy.Pledge@freescale.com>
Date: Mon, 24 Mar 2014 13:52:40 -0400
Subject: [PATCH 610/987] Remove mapping from DMA map list during unmap

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

The DMA mapping record was not being removed from a
processes DMA map when dma_mem_destroy() is called.  This
made it impossible to remap the same named segment without
restarting the process

Signed-off-by: Roy Pledge <Roy.Pledge@freescale.com>
Change-Id: I2b92a022e6cb7815056567487688c39774a5008f
Reviewed-on: http://git.am.freescale.net:8181/10180
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Geoff Thorpe <Geoff.Thorpe@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
---
 drivers/staging/fsl_qbman/fsl_usdpaa.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/staging/fsl_qbman/fsl_usdpaa.c b/drivers/staging/fsl_qbman/fsl_usdpaa.c
index c7ba988..6788582 100644
--- a/drivers/staging/fsl_qbman/fsl_usdpaa.c
+++ b/drivers/staging/fsl_qbman/fsl_usdpaa.c
@@ -1030,6 +1030,8 @@ static long ioctl_dma_unmap(struct ctx *ctx, void __user *arg)
 	}
 	map = NULL;
 map_match:
+	list_del(&map->list);
+	compress_frags();
 	spin_unlock(&mem_lock);
 	if (map) {
 		unsigned long base = vma->vm_start;
-- 
1.9.1

