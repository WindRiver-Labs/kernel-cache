From b7cf3a2640d7f26135abe99eb3f2b9b4c945e00c Mon Sep 17 00:00:00 2001
From: Marian Chereji <marian.chereji@freescale.com>
Date: Thu, 20 Feb 2014 17:38:07 +0200
Subject: [PATCH 554/987] dpa_offload: Fix IPSec SA extended statistics enable
 problem on B4 platforms

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

The dpa_ipsec wrapper was not copying the extended SA statistics
enable attribute in kernel compatibility mode (32bit user space
applications, 64bit kernel). The effect was that the extended
SA statistics would permanently be disabled on B4 platforms, while
on P platforms they worked just fine. The defect was fixed by
copying the extended SA statistics enable attribute also when
the kernel is running in compatibility mode.

Signed-off-by: Marian Chereji <marian.chereji@freescale.com>
Signed-off-by: Radu Bulie <radu.bulie@freescale.com>
Change-Id: Ic2fca421dfdb57454ad03f231bfb2bf9f5358dd2
Reviewed-on: http://git.am.freescale.net:8181/8962
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Radu-Andrei Bulie <Radu.Bulie@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h | 1 +
 drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c   | 1 +
 2 files changed, 2 insertions(+)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h b/drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h
index 5bb549b..6e96a1b 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h
@@ -121,6 +121,7 @@ struct ioc_compat_sa_params {
 	uint8_t sa_bpid;
 	uint16_t sa_bufsize;
 	bool enable_stats;
+	bool enable_extended_stats;
 	struct ioc_compat_sa_crypto_params crypto_params;
 	enum dpa_ipsec_direction sa_dir;
 	union {
diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
index 9f0ffc0..1fab68f 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
@@ -145,6 +145,7 @@ static void compat_copy_sa_params(struct dpa_ipsec_sa_params *sa_prm,
 	sa_prm->sa_bpid = sa_compat_prm->sa_bpid;
 	sa_prm->sa_bufsize = sa_compat_prm->sa_bufsize;
 	sa_prm->enable_stats = sa_compat_prm->enable_stats;
+	sa_prm->enable_extended_stats = sa_compat_prm->enable_extended_stats;
 	sa_prm->sa_dir = sa_compat_prm->sa_dir;
 
 	/* copy crypto parameters (containing multiple pointers) */
-- 
1.9.1

