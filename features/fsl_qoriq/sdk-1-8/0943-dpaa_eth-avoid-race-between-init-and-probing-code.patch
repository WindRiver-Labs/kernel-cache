From e87a1e9cc34c0975cf2dc4dab1a25f3ae879fe2a Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Fri, 17 Apr 2015 16:14:54 +0300
Subject: [PATCH 943/987] dpaa_eth: avoid race between init and probing code

The generic driver debugfs root is now added in the
initialization code, at the end. Under certain conditions
the probing code gets to run before the debugfs root is
created resulting in errors.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
[Yang: Original patch taken from
QorIQ-SDK-V1.8-SOURCE-20150619-yocto.iso]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth_generic.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_generic.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_generic.c
index 27b7c8f..970e7c8 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_generic.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_generic.c
@@ -1521,6 +1521,10 @@ static int __init __cold dpa_generic_load(void)
 
 	pr_info(KBUILD_MODNAME ": " DPA_GENERIC_DESCRIPTION " (" VERSION ")\n");
 
+#ifdef CONFIG_FSL_DPAA_ETH_DEBUGFS
+	dpa_generic_debugfs_module_init();
+#endif /* CONFIG_FSL_DPAA_ETH_DEBUGFS */
+
 	/* initialise dpaa_eth mirror values */
 	dpa_rx_extra_headroom = fm_get_rx_extra_headroom();
 	dpa_max_frm = fm_get_max_frm();
@@ -1532,10 +1536,6 @@ static int __init __cold dpa_generic_load(void)
 			KBUILD_BASENAME".c", __LINE__, __func__, _errno);
 	}
 
-#ifdef CONFIG_FSL_DPAA_ETH_DEBUGFS
-	dpa_generic_debugfs_module_init();
-#endif /* CONFIG_FSL_DPAA_ETH_DEBUGFS */
-
 	pr_debug(KBUILD_MODNAME ": %s:%s() ->\n",
 		KBUILD_BASENAME".c", __func__);
 
-- 
1.9.1

