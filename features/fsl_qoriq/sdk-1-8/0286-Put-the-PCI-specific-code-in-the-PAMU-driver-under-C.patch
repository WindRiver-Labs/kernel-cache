From 5b465bc595b4954a91fa31a3ebf9fea21cf862f6 Mon Sep 17 00:00:00 2001
From: "Lu.Jiang" <lu.jiang@windriver.com>
Date: Fri, 5 Sep 2014 18:13:00 +0800
Subject: [PATCH 286/987] Put the PCI specific code in the PAMU driver under
 CONFIG_PCI.

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

This fixes the problem where the kernel build breaks, when PCI
support is disabled.

Signed-off-by: Varun Sethi <Varun.Sethi@freescale.com>
Signed-off-by: Lu.Jiang <lu.jiang@windriver.com>
[Fix context to apply to WRL.]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/iommu/fsl_pamu_domain.c | 22 ++++++++++++++++++++--
 1 file changed, 20 insertions(+), 2 deletions(-)

diff --git a/drivers/iommu/fsl_pamu_domain.c b/drivers/iommu/fsl_pamu_domain.c
index ced9c80..73a3bf1 100644
--- a/drivers/iommu/fsl_pamu_domain.c
+++ b/drivers/iommu/fsl_pamu_domain.c
@@ -661,6 +661,7 @@ static int fsl_pamu_attach_device(struct iommu_domain *domain,
 	const u32 *liodn;
 	u32 liodn_cnt;
 	int len, ret = 0;
+#ifdef CONFIG_PCI
 	struct pci_dev *pdev = NULL;
 	struct pci_controller *pci_ctl;
 
@@ -678,6 +679,7 @@ static int fsl_pamu_attach_device(struct iommu_domain *domain,
 		 */
 		dev = pci_ctl->parent;
 	}
+#endif
 
 	liodn = of_get_property(dev->of_node, "fsl,liodn", &len);
 	if (liodn) {
@@ -698,6 +700,7 @@ static void fsl_pamu_detach_device(struct iommu_domain *domain,
 	struct fsl_dma_domain *dma_domain = to_fsl_dma_domain(domain);
 	const u32 *prop;
 	int len;
+#ifdef CONFIG_PCI
 	struct pci_dev *pdev = NULL;
 	struct pci_controller *pci_ctl;
 
@@ -715,6 +718,7 @@ static void fsl_pamu_detach_device(struct iommu_domain *domain,
 		 */
 		dev = pci_ctl->parent;
 	}
+#endif
 
 	prop = of_get_property(dev->of_node, "fsl,liodn", &len);
 	if (prop)
@@ -876,6 +880,13 @@ static struct iommu_group *get_device_iommu_group(struct device *dev)
 	return group;
 }
 
+#ifdef CONFIG_PCI
+static void swap_pci_ref(struct pci_dev **from, struct pci_dev *to)
+{
+	pci_dev_put(*from);
+	*from = to;
+}
+
 static  bool check_pci_ctl_endpt_part(struct pci_controller *pci_ctl)
 {
 	u32 version;
@@ -955,13 +966,15 @@ static struct iommu_group *get_pci_device_group(struct pci_dev *pdev)
 
 	return group;
 }
+#endif
 
 static int fsl_pamu_add_device(struct device *dev)
 {
 	struct iommu_group *group = ERR_PTR(-ENODEV);
-	struct pci_dev *pdev;
 	const u32 *prop;
 	int ret = 0, len;
+#ifdef CONFIG_PCI
+	struct pci_dev *pdev;
 
 	/*
 	 * For platform devices we allocate a separate group for
@@ -976,6 +989,7 @@ static int fsl_pamu_add_device(struct device *dev)
 		group = get_pci_device_group(pdev);
 
 	} else {
+#endif
 		prop = of_get_property(dev->of_node, "fsl,liodn", &len);
 		if (prop)
 			group = get_device_iommu_group(dev);
@@ -1059,8 +1073,9 @@ static u32 fsl_pamu_get_windows(struct iommu_domain *domain)
 
 static struct iommu_domain *fsl_get_dev_domain(struct device *dev)
 {
-	struct pci_controller *pci_ctl;
 	struct device_domain_info *info;
+#ifdef CONFIG_PCI
+	struct pci_controller *pci_ctl;
 	struct pci_dev *pdev;
 
 	/*
@@ -1078,6 +1093,7 @@ static struct iommu_domain *fsl_get_dev_domain(struct device *dev)
 		 */
 		dev = pci_ctl->parent;
 	}
+#endif
 
 	info = dev->archdata.iommu_domain;
 	if (info && info->domain)
@@ -1113,7 +1129,9 @@ int __init pamu_domain_init(void)
 		return ret;
 
 	bus_set_iommu(&platform_bus_type, &fsl_pamu_ops);
+#ifdef CONFIG_PCI
 	bus_set_iommu(&pci_bus_type, &fsl_pamu_ops);
+#endif
 
 	return ret;
 }
-- 
1.9.1

