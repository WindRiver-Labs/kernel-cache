From b3f0b6409380bba802bf8b415ffa060688c612ba Mon Sep 17 00:00:00 2001
From: Chenhui Zhao <chenhui.zhao@freescale.com>
Date: Fri, 14 Mar 2014 17:19:57 +0800
Subject: [PATCH 1187/1207] powerpc/t104x: enable wakeup sources

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

Set the register IPPDEXPCR (IP Powerdown Exception Control Register) to
enable IP blocks which work as wakeup source when sleep/deep sleep.

Change-Id: Id95cb920cab90e12851995d039bd866e6388f8ae
Signed-off-by: Chenhui Zhao <chenhui.zhao@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/10711
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Yang Li <LeoLi@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
[Yang: delete modifications of dts files for t104x]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/powerpc/platforms/85xx/qoriq_pm.c | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/arch/powerpc/platforms/85xx/qoriq_pm.c b/arch/powerpc/platforms/85xx/qoriq_pm.c
index 88a6876..9f656e9 100644
--- a/arch/powerpc/platforms/85xx/qoriq_pm.c
+++ b/arch/powerpc/platforms/85xx/qoriq_pm.c
@@ -27,6 +27,22 @@ unsigned int sleep_pm_state;
 /* supported sleep modes by the present platform */
 static unsigned int sleep_modes;
 
+void qoriq_enable_wakeup_source(struct device *dev, void *data)
+{
+	u32 value[2];
+	u32 pw_mask;
+
+	if (!device_may_wakeup(dev))
+		return;
+
+	if (of_property_read_u32_array(dev->of_node, "sleep", value, 2))
+		return;
+
+	/* get the second value, it is a mask */
+	pw_mask = value[1];
+	qoriq_pm_ops->set_ip_power(1, pw_mask);
+}
+
 static int qoriq_suspend_enter(suspend_state_t state)
 {
 	int ret = 0;
@@ -77,6 +93,8 @@ static int qoriq_suspend_valid(suspend_state_t state)
 
 static int qoriq_suspend_begin(suspend_state_t state)
 {
+	dpm_for_each_dev(NULL, qoriq_enable_wakeup_source);
+
 	if (state == PM_SUSPEND_MEM)
 		return fsl_dp_iomap();
 
-- 
2.0.2

