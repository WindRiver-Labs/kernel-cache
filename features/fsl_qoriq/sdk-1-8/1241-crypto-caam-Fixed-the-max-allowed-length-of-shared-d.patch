From 31ed29dab38fdbb2d3ae614df5f404a2c0d6dac6 Mon Sep 17 00:00:00 2001
From: Vakul Garg <vakul@freescale.com>
Date: Tue, 28 May 2013 14:20:28 +0530
Subject: [PATCH 1241/1336] crypto: caam - Fixed the max allowed length of
 shared descriptor

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

The maximum allowed length of shared descriptor depends upon the size of
caam pointers in the job descriptor. This change automatically adjusts
the allowed size of shared descriptor based on pointer size supported on
different platforms.

Change-Id: Iff54096b170b56fcfb0be636b28ff5ea95bc73b8
Signed-off-by: Vakul Garg <vakul@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/2736
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Geanta Neag Horia Ioan-B05471 <horia.geanta@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
---
 drivers/crypto/caam/qi.h | 13 ++++++-------
 1 file changed, 6 insertions(+), 7 deletions(-)

diff --git a/drivers/crypto/caam/qi.h b/drivers/crypto/caam/qi.h
index 383b2e1..e0d9920 100644
--- a/drivers/crypto/caam/qi.h
+++ b/drivers/crypto/caam/qi.h
@@ -21,23 +21,22 @@
  * The job descriptor constructed by QI hardware has layout:
  *
  *	HEADER		(1 word)
- *	Shdesc ptr	(2 words)
+ *	Shdesc ptr	(1 or 2 words)
  *	SEQ_OUT_PTR	(1 word)
- *	Out ptr		(2 words)
+ *	Out ptr		(1 or 2 words)
  *	Out length	(1 word)
  *	SEQ_IN_PTR	(1 word)
- *	In ptr		(2 words)
+ *	In ptr		(1 or 2 words)
  *	In length	(1 word)
  *
  * The shdesc ptr is used to fetch shared descriptor contents
  * into deco buffer.
  *
  * Apart from shdesc contents, the total number of words that
- * get loaded in deco buffer are '11'. Hence remaining words in
- * deco buffer can be used for storing shared descriptor.
+ * get loaded in deco buffer are '8' or '11'. The remaining words
+ * in deco buffer can be used for storing shared descriptor.
  */
-
-#define MAX_SDLEN	(MAX_CAAM_DESCSIZE - 11)
+#define MAX_SDLEN	((CAAM_DESC_BYTES_MAX - DESC_JOB_IO_LEN)/CAAM_CMD_SZ)
 
 /*
  * This is the request structure the driver application should fill while
-- 
2.0.2

