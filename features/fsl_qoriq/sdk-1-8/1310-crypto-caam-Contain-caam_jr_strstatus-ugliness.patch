From 3ae09554f2ebdd7f5796d7e4d22a07bf00426abf Mon Sep 17 00:00:00 2001
From: Marek Vasut <marex@denx.de>
Date: Thu, 24 Apr 2014 20:05:12 +0200
Subject: [PATCH 1310/1336] crypto: caam - Contain caam_jr_strstatus() ugliness

commit fa9659cd4d3f40cead6263986cc235f3e67ab872 upstream

The tentacles of this function were firmly attached to various
places in the CAAM code. Just cut them, or this cthulhu function
will sprout them anew.

Signed-off-by: Marek Vasut <marex@denx.de>
Cc: Herbert Xu <herbert@gondor.apana.org.au>
Cc: Horia Geanta <horia.geanta@freescale.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
[Lu:
Squash additional fixes to avoid broken builds in Freescale SDK]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
[Yang: add missing part for upstream fa9659cd4d3f]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/crypto/caam/caamalg.c    | 14 ++++----------
 drivers/crypto/caam/caamalg_qi.c | 12 +++---------
 drivers/crypto/caam/caampkc.c    | 18 ++++++------------
 3 files changed, 13 insertions(+), 31 deletions(-)

diff --git a/drivers/crypto/caam/caamalg.c b/drivers/crypto/caam/caamalg.c
index 6fb9a95..f55aa31 100644
--- a/drivers/crypto/caam/caamalg.c
+++ b/drivers/crypto/caam/caamalg.c
@@ -2692,11 +2692,8 @@ static void tls_encrypt_done(struct device *jrdev, u32 *desc, u32 err,
 	edesc = (struct aead_edesc *)((char *)desc -
 		 offsetof(struct aead_edesc, hw_desc));
 
-	if (err) {
-		char tmp[CAAM_ERROR_STR_MAX];
-
-		dev_err(jrdev, "%08x: %s\n", err, caam_jr_strstatus(tmp, err));
-	}
+	if (err)
+		caam_jr_strstatus(jrdev, err);
 
 	aead_unmap(jrdev, edesc, req);
 
@@ -2737,11 +2734,8 @@ static void tls_decrypt_done(struct device *jrdev, u32 *desc, u32 err,
 		       req->cryptlen, 1);
 #endif
 
-	if (err) {
-		char tmp[CAAM_ERROR_STR_MAX];
-
-		dev_err(jrdev, "%08x: %s\n", err, caam_jr_strstatus(tmp, err));
-	}
+	if (err)
+		caam_jr_strstatus(jrdev, err);
 
 	aead_unmap(jrdev, edesc, req);
 
diff --git a/drivers/crypto/caam/caamalg_qi.c b/drivers/crypto/caam/caamalg_qi.c
index 3eb180e..414952d 100644
--- a/drivers/crypto/caam/caamalg_qi.c
+++ b/drivers/crypto/caam/caamalg_qi.c
@@ -983,9 +983,7 @@ static inline void aead_done(struct caam_drv_req *drv_req, u32 status)
 	qidev = caam_ctx->qidev;
 
 	if (status) {
-		char tmp[CAAM_ERROR_STR_MAX];
-		dev_err(qidev, "Rsp status: %#x: %s\n",
-			status, caam_jr_strstatus(tmp, status));
+		caam_jr_strstatus(qidev, status);
 		ecode = -EIO;
 	}
 
@@ -1009,9 +1007,7 @@ static inline void tls_encrypt_done(struct caam_drv_req *drv_req, u32 status)
 	qidev = caam_ctx->qidev;
 
 	if (status) {
-		char tmp[CAAM_ERROR_STR_MAX];
-		dev_err(qidev, "Rsp status: %#x: %s\n",
-			status, caam_jr_strstatus(tmp, status));
+		caam_jr_strstatus(qidev, status);
 		ecode = -EIO;
 	}
 
@@ -1038,9 +1034,7 @@ static inline void tls_decrypt_done(struct caam_drv_req *drv_req, u32 status)
 	qidev = caam_ctx->qidev;
 
 	if (status) {
-		char tmp[CAAM_ERROR_STR_MAX];
-		dev_err(qidev, "Rsp status: %#x: %s\n",
-			status, caam_jr_strstatus(tmp, status));
+		caam_jr_strstatus(qidev, status);
 		ecode = -EIO;
 	}
 
diff --git a/drivers/crypto/caam/caampkc.c b/drivers/crypto/caam/caampkc.c
index 173fc41..f98abfb 100644
--- a/drivers/crypto/caam/caampkc.c
+++ b/drivers/crypto/caam/caampkc.c
@@ -143,10 +143,8 @@ static void rsa_op_done(struct device *dev, u32 *desc, u32 err, void *context)
 	edesc = (struct rsa_edesc *)((char *)desc -
 				     offsetof(struct rsa_edesc, hw_desc));
 
-	if (err) {
-		char tmp[CAAM_ERROR_STR_MAX];
-		dev_err(dev, "%08x: %s\n", err, caam_jr_strstatus(tmp, err));
-	}
+	if (err)
+		caam_jr_strstatus(dev, err);
 
 	rsa_unmap(dev, edesc, req);
 	kfree(edesc);
@@ -269,10 +267,8 @@ static void dsa_op_done(struct device *dev, u32 *desc, u32 err, void *context)
 	edesc = (struct dsa_edesc_s *)((char *)desc -
 				     offsetof(struct dsa_edesc_s, hw_desc));
 
-	if (err) {
-		char tmp[CAAM_ERROR_STR_MAX];
-		dev_err(dev, "%08x: %s\n", err, caam_jr_strstatus(tmp, err));
-	}
+	if (err)
+		caam_jr_strstatus(dev, err);
 
 	dsa_unmap(dev, edesc, req);
 	kfree(edesc);
@@ -1225,10 +1221,8 @@ static void dh_op_done(struct device *dev, u32 *desc, u32 err, void *context)
 	edesc = (struct dh_edesc_s *)((char *)desc -
 				     offsetof(struct dh_edesc_s, hw_desc));
 
-	if (err) {
-		char tmp[CAAM_ERROR_STR_MAX];
-		dev_err(dev, "%08x: %s\n", err, caam_jr_strstatus(tmp, err));
-	}
+	if (err)
+		caam_jr_strstatus(dev, err);
 
 	dh_unmap(dev, edesc, req);
 	kfree(edesc);
-- 
2.0.2

