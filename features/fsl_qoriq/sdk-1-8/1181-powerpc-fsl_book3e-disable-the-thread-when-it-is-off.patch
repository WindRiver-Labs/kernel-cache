From 182bb6431c83c8f74f47573a774f24c57a577f74 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Mon, 25 Mar 2013 10:05:31 +0800
Subject: [PATCH 1181/1207] powerpc/fsl_book3e: disable the thread when it is
 offline

When a thread is offline, we should disable it instead of spin here.
This should improve the performance of other threads which is still
running.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/platforms/85xx/smp.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/arch/powerpc/platforms/85xx/smp.c b/arch/powerpc/platforms/85xx/smp.c
index bf09df9..5588c3e 100644
--- a/arch/powerpc/platforms/85xx/smp.c
+++ b/arch/powerpc/platforms/85xx/smp.c
@@ -221,6 +221,13 @@ static void __cpuinit smp_85xx_mach_cpu_die(void)
 	if (is_core_down(cpu))
 		qoriq_pm_ops->cpu_enter_state(cpu, qoriq_cpu_die_state);
 
+	if (cpu_has_feature(CPU_FTR_SMT)) {
+		cpu = cpu_thread_in_core(cpu);
+		cpu = 1 << cpu;
+		mb();
+		mtspr(SPRN_TENC, cpu);
+	}
+
 	while (1)
 		;
 }
-- 
2.0.2

