From ed9bde6691ad202f30ce85f4ea2372abea5c4949 Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Thu, 15 Jan 2015 14:07:45 +0200
Subject: [PATCH 872/987] dpaa_eth: release CGR ids after delete

Improper ordering of CGR release and delete operations lead
to QMan CGR list corruption.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
Change-Id: I7817210fbc71d5b7b414ba866c588e97e89e39f0
Reviewed-on: http://git.am.freescale.net:8181/28533
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Marian Cristian Rotariu <marian.rotariu@freescale.com>
[Yang: Original patch taken from
QorIQ-SDK-V1.8-SOURCE-20150619-yocto.iso]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 1953164..6694eec 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -1085,11 +1085,11 @@ pfc_mapping_failed:
 #endif
 	dpa_fq_free(dev, &priv->dpa_fq_list);
 fq_alloc_failed:
+	qman_delete_cgr_safe(&priv->ingress_cgr);
 	qman_release_cgrid(priv->ingress_cgr.cgrid);
-	qman_delete_cgr(&priv->ingress_cgr);
 rx_cgr_init_failed:
+	qman_delete_cgr_safe(&priv->cgr_data.cgr);
 	qman_release_cgrid(priv->cgr_data.cgr.cgrid);
-	qman_delete_cgr(&priv->cgr_data.cgr);
 tx_cgr_init_failed:
 add_channel_failed:
 get_channel_failed:
-- 
1.9.1

