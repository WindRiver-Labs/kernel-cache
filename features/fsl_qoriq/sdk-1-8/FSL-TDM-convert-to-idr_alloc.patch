From 837b3185835c9773625d481e564c76c24f6f26e9 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Wed, 3 Feb 2016 12:29:45 +0800
Subject: [PATCH 7/7] FSL: TDM: convert to idr_alloc()

idr_get_new*() and friends are about to be deprecated.  Convert to the
new idr_alloc() interface.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/tdm/tdm-core.c |    9 +++------
 1 files changed, 3 insertions(+), 6 deletions(-)

diff --git a/drivers/tdm/tdm-core.c b/drivers/tdm/tdm-core.c
index 861e6f2..d83bc14 100644
--- a/drivers/tdm/tdm-core.c
+++ b/drivers/tdm/tdm-core.c
@@ -195,18 +195,15 @@ static int tdm_register_adapter(struct tdm_adapter *adap)
  */
 int tdm_add_adapter(struct tdm_adapter *adapter)
 {
-	int id, res = TDM_E_OK;
+	int res = TDM_E_OK;
 	if (!adapter) {
 		pr_err("%s:Invalid handle\n", __func__);
 		return -EINVAL;
 	}
 
 retry:
-	if (__idr_pre_get(&tdm_adapter_idr, GFP_KERNEL) == 0)
-		return -ENOMEM;
-
 	mutex_lock(&tdm_core_lock);
-	res = __idr_get_new_above(&tdm_adapter_idr, adapter, 0, &id);
+	res = idr_alloc(&tdm_adapter_idr, adapter, 0, 0, GFP_KERNEL);
 	mutex_unlock(&tdm_core_lock);
 
 	if (res < 0) {
@@ -215,7 +212,7 @@ retry:
 		return res;
 	}
 
-	adapter->id = id;
+	adapter->id = res;
 	return tdm_register_adapter(adapter);
 }
 EXPORT_SYMBOL(tdm_add_adapter);
-- 
1.7.5.4

