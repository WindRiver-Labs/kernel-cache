From 01dfbe3cb0268628ea0601925bbac3437bd929f8 Mon Sep 17 00:00:00 2001
From: "Lu.Jiang" <lu.jiang@windriver.com>
Date: Tue, 16 Sep 2014 14:21:12 +0800
Subject: [PATCH 1167/1207] powerpc/booke3e: Move tlb lock/unlock functions

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

Move book3e_tlb_lock/unlock functions from hugetlbpages to mm to be
used from other kernel places.

Signed-off-by: Mihai Caraman <mihai.caraman@freescale.com>
(cherry picked and merged from sdk1.5 commit c84bbd80aebb40de4fcc7894759dfff8857d405c)
Change-Id: I89239824880e81c8257fe612cad903eebbb5adbe
Reviewed-on: http://git.am.freescale.net:8181/11559
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Stuart Yoder <stuart.yoder@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
Signed-off-by: Lu.Jiang <lu.jiang@windriver.com>
---
 arch/powerpc/include/asm/mmu-book3e.h |  9 +++++++
 arch/powerpc/mm/fsl_booke_mmu.c       | 41 ++++++++++++++++++++++++++++
 arch/powerpc/mm/hugetlbpage-book3e.c  | 51 -----------------------------------
 3 files changed, 50 insertions(+), 51 deletions(-)

diff --git a/arch/powerpc/include/asm/mmu-book3e.h b/arch/powerpc/include/asm/mmu-book3e.h
index 6f0cf4f..b9c9912 100644
--- a/arch/powerpc/include/asm/mmu-book3e.h
+++ b/arch/powerpc/include/asm/mmu-book3e.h
@@ -320,6 +320,15 @@ extern int book3e_htw_mode;
  * return 1, indicating that the tlb requires preloading.
  */
 #define HUGETLB_NEED_PRELOAD
+
+void book3e_tlb_lock(void);
+void book3e_tlb_unlock(void);
+#else
+static inline void book3e_tlb_lock(void)
+{}
+
+static inline void book3e_tlb_unlock(void)
+{}
 #endif
 
 #endif /* !__ASSEMBLY__ */
diff --git a/arch/powerpc/mm/fsl_booke_mmu.c b/arch/powerpc/mm/fsl_booke_mmu.c
index 7e78f4d..1a1c485 100644
--- a/arch/powerpc/mm/fsl_booke_mmu.c
+++ b/arch/powerpc/mm/fsl_booke_mmu.c
@@ -323,3 +323,44 @@ notrace void __init relocate_init(u64 dt_ptr, phys_addr_t start)
 }
 #endif
 #endif
+
+#if defined(CONFIG_PPC64)
+void book3e_tlb_lock(void)
+{
+	struct paca_struct *paca = get_paca();
+	struct tlb_core_data *percore;
+	unsigned long tmp;
+
+	if (!(paca->tcd_ptr & 1))
+		return;
+
+	percore = (struct tlb_core_data *)(paca->tcd_ptr & ~1UL);
+
+	asm volatile("1: lbarx %0, 0, %1;\n"
+		     "cmpdi %0, 0;\n"
+		     "bne 2f;\n"
+		     "li %0, 1;\n"
+		     "stbcx. %0, 0, %1;\n"
+		     "bne 1b;\n"
+		     "b 3f;\n"
+		     "2: lbzx %0, 0, %1;\n"
+		     "cmpdi %0, 0;\n"
+		     "bne 2b;\n"
+		     "b 1b;\n"
+		     "3:" : "=&r" (tmp) : "r" (&percore->lock) : "memory");
+}
+
+void book3e_tlb_unlock(void)
+{
+	struct paca_struct *paca = get_paca();
+	struct tlb_core_data *percore;
+
+	if (!(paca->tcd_ptr & 1))
+		return;
+
+	percore = (struct tlb_core_data *)(paca->tcd_ptr & ~1UL);
+
+	isync();
+	percore->lock = 0;
+}
+#endif
diff --git a/arch/powerpc/mm/hugetlbpage-book3e.c b/arch/powerpc/mm/hugetlbpage-book3e.c
index 8c94cff..a1f03ae 100644
--- a/arch/powerpc/mm/hugetlbpage-book3e.c
+++ b/arch/powerpc/mm/hugetlbpage-book3e.c
@@ -51,57 +51,6 @@ static inline int mmu_get_tsize(int psize)
 	return mmu_psize_defs[psize].enc;
 }
 
-#if defined(CONFIG_PPC_FSL_BOOK3E) && defined(CONFIG_PPC64)
-#include <asm/paca.h>
-
-static inline void book3e_tlb_lock(void)
-{
-	struct paca_struct *paca = get_paca();
-	struct tlb_per_core *percore;
-	unsigned long tmp;
-
-	if (!(paca->tlb_per_core_ptr & 1))
-		return;
-
-	percore = (struct tlb_per_core *)(paca->tlb_per_core_ptr & ~1UL);
-
-	asm volatile("1: lbarx %0, 0, %1;"
-		     "cmpdi %0, 0;"
-		     "bne 2f;"
-		     "li %0, 1;"
-		     "stbcx. %0, 0, %1;"
-		     "bne 1b;"
-		     "b 3f;"
-		     "2: lbzx %0, 0, %1;"
-		     "cmpdi %0, 0;"
-		     "bne 2b;"
-		     "b 1b;"
-		     "3:" : "=&r" (tmp) : "r" (&percore->lock) : "memory");
-}
-
-static inline void book3e_tlb_unlock(void)
-{
-	struct paca_struct *paca = get_paca();
-	struct tlb_per_core *percore;
-
-	if (!(paca->tlb_per_core_ptr & 1))
-		return;
-
-	percore = (struct tlb_per_core *)(paca->tlb_per_core_ptr & ~1UL);
-
-	isync();
-	percore->lock = 0;
-}
-#else
-static inline void book3e_tlb_lock(void)
-{
-}
-
-static inline void book3e_tlb_unlock(void)
-{
-}
-#endif
-
 static inline int book3e_tlb_exists(unsigned long ea, unsigned long pid)
 {
 	int found = 0;
-- 
2.0.2

