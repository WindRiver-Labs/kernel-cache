From a887f24ebf06c77e89478eed02eb7a7dd52a556e Mon Sep 17 00:00:00 2001
From: Zhao Chenhui <chenhui.zhao@freescale.com>
Date: Mon, 12 May 2014 19:58:16 +0800
Subject: [PATCH 1188/1207] powerpc/pm: add API for setting powerdown exception

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

Add fsl_set_power_except() for setting powerdown exception when sleep.
The drivers can call this function to set the corresponding bits if
the devices will power down when sleep.

This patch also fixed an issue which is that FMan ports can not work after
wake-up from deep sleep using Wake-on-LAN. Set FMan bit and MAC bits of the
register IPPDEXPCR seperately, instead of setting them together.

Change-Id: I8f632efb8ca54a5d32deb7ee1d42b333fa66d5cd
Signed-off-by: Zhao Chenhui <chenhui.zhao@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/12219
Reviewed-by: Yang Li <LeoLi@freescale.com>
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
[Yang: delete modifications of dts files for t104x.
And add fsl_pm.h file to lnxwrp_fm.c]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/powerpc/include/asm/fsl_pm.h                  |  1 +
 arch/powerpc/platforms/85xx/qoriq_pm.c             | 56 ++++++++++++++++++----
 .../freescale/fman/src/wrapper/lnxwrp_fm.c         |  1 +
 3 files changed, 50 insertions(+), 8 deletions(-)

diff --git a/arch/powerpc/include/asm/fsl_pm.h b/arch/powerpc/include/asm/fsl_pm.h
index 742cf22..8e6a656 100644
--- a/arch/powerpc/include/asm/fsl_pm.h
+++ b/arch/powerpc/include/asm/fsl_pm.h
@@ -61,6 +61,7 @@ unsigned long get_rcpm_version(void);
 void set_pm_suspend_state(suspend_state_t state);
 suspend_state_t pm_suspend_state(void);
 
+void fsl_set_power_except(struct device *dev, int on);
 #endif	/* __ASSEMBLY__ */
 
 #define T1040QDS_TETRA_FLAG	1
diff --git a/arch/powerpc/platforms/85xx/qoriq_pm.c b/arch/powerpc/platforms/85xx/qoriq_pm.c
index 9f656e9..155dc28 100644
--- a/arch/powerpc/platforms/85xx/qoriq_pm.c
+++ b/arch/powerpc/platforms/85xx/qoriq_pm.c
@@ -27,20 +27,54 @@ unsigned int sleep_pm_state;
 /* supported sleep modes by the present platform */
 static unsigned int sleep_modes;
 
-void qoriq_enable_wakeup_source(struct device *dev, void *data)
+/**
+ * fsl_set_power_except - set which IP block is not powerdown when sleep,
+ * such as MAC, USB, etc.
+ *
+ * @dev: a pointer to the struct device
+ * @on: if 1, do not power down; if 0, power down.
+ */
+void fsl_set_power_except(struct device *dev, int on)
 {
 	u32 value[2];
 	u32 pw_mask;
+	const phandle *phandle_prop;
+	struct device_node *mac_node;
+	int ret;
+
+	ret = of_property_read_u32_array(dev->of_node, "sleep", value, 2);
+	if (ret) {
+		/* search fman mac node */
+		phandle_prop = of_get_property(dev->of_node, "fsl,fman-mac",
+					       NULL);
+		if (phandle_prop == NULL)
+			goto err;
+
+		mac_node = of_find_node_by_phandle(*phandle_prop);
+		ret = of_property_read_u32_array(mac_node, "sleep", value, 2);
+		of_node_put(mac_node);
+		if (ret)
+			goto err;
+	}
 
-	if (!device_may_wakeup(dev))
-		return;
+	/* get the second value, it is a mask */
+	pw_mask = value[1];
+	qoriq_pm_ops->set_ip_power(on, pw_mask);
 
-	if (of_property_read_u32_array(dev->of_node, "sleep", value, 2))
+	return;
+
+err:
+	dev_err(dev, "Can not set wakeup sources\n");
+	return;
+}
+EXPORT_SYMBOL_GPL(fsl_set_power_except);
+
+void qoriq_set_wakeup_source(struct device *dev, void *enable)
+{
+	if (!device_may_wakeup(dev))
 		return;
 
-	/* get the second value, it is a mask */
-	pw_mask = value[1];
-	qoriq_pm_ops->set_ip_power(1, pw_mask);
+	fsl_set_power_except(dev, *((int *)enable));
 }
 
 static int qoriq_suspend_enter(suspend_state_t state)
@@ -93,7 +127,9 @@ static int qoriq_suspend_valid(suspend_state_t state)
 
 static int qoriq_suspend_begin(suspend_state_t state)
 {
-	dpm_for_each_dev(NULL, qoriq_enable_wakeup_source);
+	const int enable = 1;
+
+	dpm_for_each_dev((void *)&enable, qoriq_set_wakeup_source);
 
 	if (state == PM_SUSPEND_MEM)
 		return fsl_dp_iomap();
@@ -103,6 +139,10 @@ static int qoriq_suspend_begin(suspend_state_t state)
 
 static void qoriq_suspend_end(void)
 {
+	const int enable = 0;
+
+	dpm_for_each_dev((void *)&enable, qoriq_set_wakeup_source);
+
 	set_pm_suspend_state(PM_SUSPEND_ON);
 	fsl_dp_iounmap();
 }
diff --git a/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm.c b/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm.c
index 0c79565..f5e2ceb 100755
--- a/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm.c
+++ b/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm.c
@@ -60,6 +60,7 @@
 #include <asm/errno.h>
 #include <asm/qe.h>        /* For struct qe_firmware */
 #include <sysdev/fsl_soc.h>
+#include <asm/fsl_pm.h>
 #include <asm/fsl_guts.h>
 #include <linux/stat.h>	   /* For file access mask */
 #include <linux/skbuff.h>
-- 
2.0.2

