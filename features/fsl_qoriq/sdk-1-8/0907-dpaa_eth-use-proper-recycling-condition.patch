From 6053a228a771d57f61da4cea1396eeaf9e9fad41 Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Tue, 17 Mar 2015 10:55:57 +0200
Subject: [PATCH 907/987] dpaa_eth: use proper recycling condition

The condition that needs to be evaluated to determine if a certain
fd is to be recycled (buffers released in the buffer pool by HW)
is (fd.bpid != 0xff). Several places in the code were using the
previous condition (fd.cmd & FM_FD_CMD_FCO) that is always true
after the unification of the recycling and confirmation paths.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
Change-Id: I23789acc6879086f356ca9accfe400122fd4f0f3
Reviewed-on: http://git.am.freescale.net:8181/32879
Reviewed-by: Marian Cristian Rotariu <marian.rotariu@freescale.com>
[Yang: Original patch taken from
QorIQ-SDK-V1.8-SOURCE-20150619-yocto.iso]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c    | 4 ++--
 drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 35a491d..0e29ecb 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -299,7 +299,7 @@ static void _dpa_tx_error(struct net_device		*net_dev,
 	/* If we intended the buffers from this frame to go into the bpools
 	 * when the FMan transmit was done, we need to put it in manually.
 	 */
-	if (fd->cmd & FM_FD_CMD_FCO) {
+	if (fd->bpid != 0xff) {
 		dpa_fd_release(net_dev, fd);
 		return;
 	}
@@ -554,7 +554,7 @@ static void priv_ern(struct qman_portal	*portal,
 	 * when the FM was done, we need to put it in
 	 * manually.
 	 */
-	if (msg->ern.fd.cmd & FM_FD_CMD_FCO) {
+	if (msg->ern.fd.bpid != 0xff) {
 		dpa_fd_release(net_dev, &fd);
 		return;
 	}
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c
index 5867b60..6ec94ef 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c
@@ -967,7 +967,7 @@ int __hot dpa_tx(struct sk_buff *skb, struct net_device *net_dev)
 	return NETDEV_TX_OK;
 
 xmit_failed:
-	if (fd.cmd & FM_FD_CMD_FCO) {
+	if (fd.bpid != 0xff) {
 		(*countptr)--;
 		percpu_priv->tx_returned--;
 		dpa_fd_release(net_dev, &fd);
-- 
1.9.1

