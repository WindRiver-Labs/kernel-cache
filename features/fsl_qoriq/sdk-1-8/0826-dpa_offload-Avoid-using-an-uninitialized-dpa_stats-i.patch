From 77388ab3714009a2a6e518457c2e49c9e32f7fb6 Mon Sep 17 00:00:00 2001
From: Marian Chereji <marian.chereji@freescale.com>
Date: Sun, 5 Oct 2014 14:29:01 +0300
Subject: [PATCH 826/987] dpa_offload: Avoid using an uninitialized dpa_stats
 instance Id

The dpa_stats_init function failed to initialized the dpa_stats instance Id
by declaring it unused. This causes problems when using the rest of the
dpa_stats API as the instance Id is checked against negative values.

Change-Id: I43e460e84e2f22c995bcadf64d165b57ec6e789c
Signed-off-by: Marian Chereji <marian.chereji@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/20956
Reviewed-by: Anca Jeanina Floarea <anca.floarea@freescale.com>
[Lu:Original patch taken from
QorIQ-SDK-V1.7-SOURCE-20141218-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_stats.c | 20 ++++++++++++++------
 1 file changed, 14 insertions(+), 6 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_stats.c b/drivers/staging/fsl_dpa_offload/dpa_stats.c
index 6f099b1..08941dc 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_stats.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_stats.c
@@ -52,6 +52,11 @@
 
 #define DPA_STATS_US_CNT 0x80000000
 
+#define CHECK_INSTANCE_ZERO \
+		if (dpa_stats_id != 0) { \
+			log_err("DPA Stats supports only instance zero\n"); \
+			return -ENOSYS; \
+		}
 
 /* Global dpa_stats component */
 struct dpa_stats *gbl_dpa_stats;
@@ -3747,15 +3752,18 @@ int dpa_stats_init(const struct dpa_stats_params *params, int *dpa_stats_id)
 	struct dpa_stats *dpa_stats = NULL;
 	int err = 0;
 
-	/* Multiple DPA Stats instances are not currently supported */
-	unused(dpa_stats_id);
-
 	/* Sanity checks */
 	if (gbl_dpa_stats) {
 		log_err("DPA Stats component already initialized. Multiple DPA Stats instances are not supported.\n");
 		return -EPERM;
 	}
 
+	/*
+	 * Multiple DPA Stats instances are not currently supported. The only
+	 * supported instance instance is zero.
+	 */
+	*dpa_stats_id = 0;
+
 	/* Check user-provided parameters */
 	err = check_dpa_stats_params(params);
 	if (err < 0)
@@ -3825,7 +3833,7 @@ int dpa_stats_create_counter(int dpa_stats_id,
 	int err = 0, err_rb = 0;
 
 	/* multiple DPA Stats instances are not currently supported */
-	unused(dpa_stats_id);
+	CHECK_INSTANCE_ZERO;
 
 	if (!gbl_dpa_stats) {
 		log_err("DPA Stats component is not initialized\n");
@@ -3984,7 +3992,7 @@ int dpa_stats_create_class_counter(int dpa_stats_id,
 	int err = 0, err_rb = 0;
 
 	/* multiple DPA Stats instances are not currently supported */
-	unused(dpa_stats_id);
+	CHECK_INSTANCE_ZERO;
 
 	if (!gbl_dpa_stats) {
 		log_err("DPA Stats component is not initialized\n");
@@ -4539,7 +4547,7 @@ EXPORT_SYMBOL(dpa_stats_reset_counters);
 int dpa_stats_free(int dpa_stats_id)
 {
 	/* multiple DPA Stats instances are not currently supported */
-	unused(dpa_stats_id);
+	CHECK_INSTANCE_ZERO;
 
 	return free_resources();
 }
-- 
1.9.1

