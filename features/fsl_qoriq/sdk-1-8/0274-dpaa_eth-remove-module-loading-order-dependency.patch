From 676f46c24c2b80ab6c08a30789a1af782d89b029 Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Wed, 26 Jun 2013 17:53:07 +0300
Subject: [PATCH 274/987] dpaa_eth: remove module loading order dependency

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

The dpa_rx_extra_headroom and dpa_max_frm are set by each module
init functions so there is no chance they are used before being
initialized. Also use the dpa_rx_extra_headroom for SG driver.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
Change-Id: If521e1f41e4857b5d03963aaa9fb2fa898a2183c
Reviewed-on: http://git.am.freescale.net:8181/3095
Reviewed-by: Sovaiala Cristian-Constantin-B39531 <Cristian.Sovaiala@freescale.com>
Reviewed-by: Radulescu Ruxandra Ioana-B05472 <ruxandra.radulescu@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c         | 2 +-
 drivers/net/ethernet/freescale/dpa/dpaa_eth.h         | 7 +++----
 drivers/net/ethernet/freescale/dpa/dpaa_eth_macless.c | 4 +---
 drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c   | 4 +---
 drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c  | 5 ++---
 5 files changed, 8 insertions(+), 14 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index e569fdd..1590880 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -151,7 +151,7 @@ module_param(tx_timeout, ushort, S_IRUGO);
 MODULE_PARM_DESC(tx_timeout, "The Tx timeout in ms");
 
 /* dpaa_eth mirror for the FMan values */
-static int dpa_rx_extra_headroom;
+int dpa_rx_extra_headroom;
 int dpa_max_frm;
 
 static const char rtx[][3] = {
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.h b/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
index a5f5a00..b83d133 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.h
@@ -57,11 +57,10 @@
 #endif /* CONFIG_FSL_DPAA_ETH_DEBUGFS */
 #include "dpaa_eth_trace.h"
 
-#ifdef CONFIG_FSL_DPAA_ETH_SG_SUPPORT
-#define dpa_get_rx_extra_headroom() fm_get_rx_extra_headroom()
-#else
+extern int dpa_rx_extra_headroom;
+extern int dpa_max_frm;
+
 #define dpa_get_rx_extra_headroom() dpa_rx_extra_headroom
-#endif
 #define dpa_get_max_frm() dpa_max_frm
 
 /*
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_macless.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_macless.c
index 8d3621e..4eb9a46 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_macless.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_macless.c
@@ -407,11 +407,9 @@ static int __init __cold dpa_macless_load(void)
 
 	printk(KERN_INFO KBUILD_MODNAME ": " DPA_DESCRIPTION " (" VERSION ")\n");
 
-/* Todo: is it safe to remove these?
-	/ * Initialize dpaa_eth mirror values * /
+	/* Initialize dpaa_eth mirror values */
 	dpa_rx_extra_headroom = fm_get_rx_extra_headroom();
 	dpa_max_frm = fm_get_max_frm();
-*/
 
 	_errno = platform_driver_register(&dpa_macless_driver);
 	if (unlikely(_errno < 0)) {
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
index 21dda6d..454869a 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_proxy.c
@@ -172,11 +172,9 @@ static int __init __cold dpa_proxy_load(void)
 
 	printk(KERN_INFO KBUILD_MODNAME ": " DPA_DESCRIPTION " (" VERSION ")\n");
 
-/* Todo: is it safe to remove these?
-	/ * Initialize dpaa_eth mirror values * /
+	/* Initialize dpaa_eth mirror values */
 	dpa_rx_extra_headroom = fm_get_rx_extra_headroom();
 	dpa_max_frm = fm_get_max_frm();
-*/
 
 	_errno = platform_driver_register(&dpa_proxy_driver);
 	if (unlikely(_errno < 0)) {
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
index 76f5e50..8ab6a5c 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
@@ -805,11 +805,10 @@ static int __init __cold dpa_shared_load(void)
 
 	printk(KERN_INFO KBUILD_MODNAME ": " DPA_DESCRIPTION " (" VERSION ")\n");
 
-/* Todo: is it safe to remove these?
-	/ * Initialize dpaa_eth mirror values * /
+	/* Initialize dpaa_eth mirror values */
 	dpa_rx_extra_headroom = fm_get_rx_extra_headroom();
 	dpa_max_frm = fm_get_max_frm();
-*/
+
 	_errno = platform_driver_register(&dpa_shared_driver);
 	if (unlikely(_errno < 0)) {
 		pr_err(KBUILD_MODNAME
-- 
1.9.1

