From 66399dcf4ccff07b7b9b149fd1c6e4c62f62ce2c Mon Sep 17 00:00:00 2001
From: Sandeep Singh <sandeep@freescale.com>
Date: Fri, 14 Mar 2014 18:26:37 -0400
Subject: [PATCH 663/987] tdm: Add power management support for fsl tdm

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

Added suspend and resume function for tdm.

Signed-off-by: Sandeep Singh <sandeep@freescale.com>
Change-Id: I6b237693735a85f23f20c8a80fa1e5e446820281
Reviewed-on: http://git.am.freescale.net:8181/9810
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Xiaobo Xie <X.Xie@freescale.com>
Reviewed-by: Qiang Zhao <qiang.zhao@freescale.com>
Reviewed-by: Yashpal Dutta <yashpal.dutta@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
(cherry picked from commit 548f123adbc116cd39289ff08fce989a95fe6928)
Reviewed-on: http://git.am.freescale.net:8181/11318
---
 drivers/tdm/device/tdm_fsl.c | 30 ++++++++++++++++++++++++++++++
 1 file changed, 30 insertions(+)

diff --git a/drivers/tdm/device/tdm_fsl.c b/drivers/tdm/device/tdm_fsl.c
index 8140a06..8a8465b 100644
--- a/drivers/tdm/device/tdm_fsl.c
+++ b/drivers/tdm/device/tdm_fsl.c
@@ -845,6 +845,33 @@ static int tdm_fsl_remove(struct platform_device *ofdev)
 	return 0;
 }
 
+#ifdef CONFIG_PM
+static int fsl_tdm_suspend(struct device *dev)
+{
+	struct tdm_priv *priv = dev_get_drvdata(dev);
+	if (!priv)
+		return -EINVAL;
+
+	tdm_fsl_stop(priv);
+
+	return 0;
+}
+
+static int fsl_tdm_resume(struct device *dev)
+{
+	struct tdm_priv *priv = dev_get_drvdata(dev);
+	if (!priv)
+		return -EINVAL;
+
+	tdm_fsl_reg_init(priv);
+	tdm_fsl_enable(priv->adap);
+
+	return 0;
+}
+
+SIMPLE_DEV_PM_OPS(fsl_tdm_pm_ops, fsl_tdm_suspend, fsl_tdm_resume);
+#endif
+
 static const struct of_device_id fsl_tdm_match[] = {
 	{
 	 .compatible = "fsl,tdm1.0",
@@ -859,6 +886,9 @@ static struct platform_driver tdm_fsl_driver = {
 		.owner	= THIS_MODULE,
 		.name	= DRV_NAME,
 		.of_match_table	= fsl_tdm_match,
+#ifdef CONFIG_PM
+		.pm = &fsl_tdm_pm_ops,
+#endif
 
 	},
 	.probe		= tdm_fsl_probe,
-- 
1.9.1

