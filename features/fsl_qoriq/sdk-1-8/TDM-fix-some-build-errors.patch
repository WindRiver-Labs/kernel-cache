From c3f508088b21d7090ff27f474a6915f2d1ee613e Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Tue, 2 Feb 2016 13:01:43 +0800
Subject: [PATCH 3/7] TDM: fix some build errors

This is to avoid the below errors:

drivers/tdm/device/fsl_ucc_tdm.c:841:8: error: implicit declaration of
function 'of_address_to_resource' [-Werror=implicit-function-declaration]

drivers/tdm/tdm-core.c: In function 'tdm_add_adapter':
drivers/tdm/tdm-core.c:204:6: error: implicit declaration of function
'idr_pre_get' [-Werror=implicit-function-declaration]
   if (idr_pre_get(&tdm_adapter_idr, GFP_KERNEL) == 0)
       ^

drivers/tdm/tdm-core.c:208:8: error: implicit declaration of function
'idr_get_new' [-Werror=implicit-function-declaration]
   res = idr_get_new(&tdm_adapter_idr, adapter, &id);
       ^

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/tdm/device/fsl_ucc_tdm.c  |    2 ++
 drivers/tdm/device/tdm_fsl.c      |    2 ++
 drivers/tdm/line_ctrl/pq_mds_t1.c |    1 +
 drivers/tdm/tdm-core.c            |    4 ++--
 4 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/drivers/tdm/device/fsl_ucc_tdm.c b/drivers/tdm/device/fsl_ucc_tdm.c
index bbcf1e0..14a3756 100644
--- a/drivers/tdm/device/fsl_ucc_tdm.c
+++ b/drivers/tdm/device/fsl_ucc_tdm.c
@@ -37,6 +37,8 @@
 #include <linux/dma-mapping.h>
 #include <linux/spinlock.h>
 #include <linux/delay.h>
+#include <linux/of_address.h>
+#include <linux/of_irq.h>
 #include <sysdev/fsl_soc.h>
 #include <sysdev/fsl_soc.h>
 #include <linux/slab.h>
diff --git a/drivers/tdm/device/tdm_fsl.c b/drivers/tdm/device/tdm_fsl.c
index fe8ad8d..a4efccf 100644
--- a/drivers/tdm/device/tdm_fsl.c
+++ b/drivers/tdm/device/tdm_fsl.c
@@ -36,6 +36,8 @@
 #include <linux/init.h>
 #include <linux/platform_device.h>
 #include <linux/slab.h>
+#include <linux/of_address.h>
+#include <linux/of_irq.h>
 #include <linux/of_platform.h>
 #include <linux/io.h>
 #include <linux/tdm.h>
diff --git a/drivers/tdm/line_ctrl/pq_mds_t1.c b/drivers/tdm/line_ctrl/pq_mds_t1.c
index 641c9e1..9cbad3e 100644
--- a/drivers/tdm/line_ctrl/pq_mds_t1.c
+++ b/drivers/tdm/line_ctrl/pq_mds_t1.c
@@ -31,6 +31,7 @@
 #include <linux/param.h>
 #include <linux/delay.h>
 #include <linux/of.h>
+#include <linux/of_address.h>
 
 #include <linux/platform_device.h>
 #include <linux/init.h>
diff --git a/drivers/tdm/tdm-core.c b/drivers/tdm/tdm-core.c
index 97bd338..5d55905 100644
--- a/drivers/tdm/tdm-core.c
+++ b/drivers/tdm/tdm-core.c
@@ -201,11 +201,11 @@ int tdm_add_adapter(struct tdm_adapter *adapter)
 	}
 
 retry:
-	if (idr_pre_get(&tdm_adapter_idr, GFP_KERNEL) == 0)
+	if (__idr_pre_get(&tdm_adapter_idr, GFP_KERNEL) == 0)
 		return -ENOMEM;
 
 	mutex_lock(&tdm_core_lock);
-	res = idr_get_new(&tdm_adapter_idr, adapter, &id);
+	res = __idr_get_new_above(&tdm_adapter_idr, adapter, 0, &id);
 	mutex_unlock(&tdm_core_lock);
 
 	if (res < 0) {
-- 
1.7.5.4

