From 44ce52bd88a34c3649500331a63cbf15d16874fd Mon Sep 17 00:00:00 2001
From: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Date: Tue, 20 Aug 2013 19:02:32 +0300
Subject: [PATCH 384/987] dpaa_eth: No recycling if timestamp support is on

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

The timestamping code relies on Tx confirmation routine to get the
Tx timestamp of a frame. So if timestamp support is activated, don't
recycle frames at all.

Also fix a couple of compilation warnings when building with
timestamp support on.

Signed-off-by: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Change-Id: I5ee3a5b727e28ee337dc9da5c16ad0d1dabe4317
Reviewed-on: http://git.am.freescale.net:8181/4838
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Cristian-Constantin Sovaiala <Cristian.Sovaiala@freescale.com>
Reviewed-by: Bucur Madalin-Cristian-B32716 <madalin.bucur@freescale.com>
Reviewed-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c
index 2b3d1d5..67ff53d 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c
@@ -269,7 +269,7 @@ struct sk_buff *_dpa_cleanup_tx_fd(const struct dpa_priv_s *priv,
 	return skb;
 }
 
-#ifndef CONFIG_FSL_DPAA_TS
+#if (!defined(CONFIG_FSL_DPAA_TS) && !defined(CONFIG_FSL_DPAA_1588))
 static bool dpa_skb_is_recyclable(struct sk_buff *skb)
 {
 	/* No recycling possible if skb buffer is kmalloc'ed  */
@@ -317,7 +317,7 @@ static bool dpa_buf_is_recyclable(struct sk_buff *skb,
 
 	return false;
 }
-#endif /* CONFIG_FSL_DPAA_TS */
+#endif /* (!defined(CONFIG_FSL_DPAA_TS) && !defined(CONFIG_FSL_DPAA_1588)) */
 
 
 /* Build a linear skb around the received buffer.
@@ -607,10 +607,11 @@ static int __hot skb_to_contig_fd(struct dpa_priv_s *priv,
 	struct net_device *net_dev = priv->net_dev;
 	int err;
 	enum dma_data_direction dma_dir;
-	int *count_ptr = __this_cpu_ptr(dpa_bp->percpu_count);
 	unsigned char *buffer_start;
 
-#ifndef CONFIG_FSL_DPAA_TS
+#if (!defined(CONFIG_FSL_DPAA_TS) && !defined(CONFIG_FSL_DPAA_1588))
+	int *count_ptr = __this_cpu_ptr(dpa_bp->percpu_count);
+
 	/* Check recycling conditions; only if timestamp support is not
 	 * enabled, otherwise we need the fd back on tx confirmation
 	 */
-- 
1.9.1

