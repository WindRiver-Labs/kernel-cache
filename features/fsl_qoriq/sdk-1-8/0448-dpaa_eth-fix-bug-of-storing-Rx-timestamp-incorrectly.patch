From a28f77eefd6c79b7e84a39fd4bd0511b172e3ee1 Mon Sep 17 00:00:00 2001
From: "Lu.Jiang" <lu.jiang@windriver.com>
Date: Thu, 11 Sep 2014 17:01:27 +0800
Subject: [PATCH 448/987] dpaa_eth: fix bug of storing Rx timestamp incorrectly

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

Correct the position of storing 1588 timestamp in Rx path
in contig_fd_to_skb.

Signed-off-by: Shengzhou Liu <Shengzhou.Liu@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/6606
Reviewed-by: Madalin-Cristian Bucur <madalin.bucur@freescale.com>
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Ruxandra Ioana Radulescu <ruxandra.radulescu@freescale.com>
Reviewed-by: Thomas Trefny <Tom.Trefny@freescale.com>
Change-Id: Ia94a9b9c8313b3204a1f9b5d6e5a3410c2509c3a
Reviewed-on: http://git.am.freescale.net:8181/7351
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/7684
Tested-by: Madalin-Cristian Bucur <madalin.bucur@freescale.com>
Signed-off-by: Lu.Jiang <lu.jiang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c | 10 ++++------
 1 file changed, 4 insertions(+), 6 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c
index 93ce7f5..ac08dce 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_sg.c
@@ -351,12 +351,6 @@ static struct sk_buff *__hot contig_fd_to_skb(const struct dpa_priv_s *priv,
 	skb->truesize = SKB_TRUESIZE(dpa_fd_length(fd));
 #endif
 
-	/* do we need the timestamp for bad frames? */
-#ifdef CONFIG_FSL_DPAA_1588
-	if (priv->tsu && priv->tsu->valid && priv->tsu->hwts_rx_en_ioctl)
-		dpa_ptp_store_rxstamp(priv, skb, vaddr);
-#endif
-
 	/* Build the skb and adjust data and tail pointers, to make sure
 	 * forwarded skbs will have enough space on Tx if extra headers
 	 * are added.
@@ -374,6 +368,10 @@ static struct sk_buff *__hot contig_fd_to_skb(const struct dpa_priv_s *priv,
 				DPA_RX_PRIV_DATA_SIZE);
 	_dpa_process_parse_results(parse_results, fd, skb, use_gro);
 
+#ifdef CONFIG_FSL_DPAA_1588
+	if (priv->tsu && priv->tsu->valid && priv->tsu->hwts_rx_en_ioctl)
+		dpa_ptp_store_rxstamp(priv, skb, vaddr);
+#endif
 #ifdef CONFIG_FSL_DPAA_TS
 	if (priv->ts_rx_en)
 		dpa_get_ts(priv, RX, skb_hwtstamps(skb), vaddr);
-- 
1.9.1

