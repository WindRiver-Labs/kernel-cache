From be237540049901a26e03479af537e805b52dabce Mon Sep 17 00:00:00 2001
From: Zhao Chenhui <chenhui.zhao@freescale.com>
Date: Thu, 24 Apr 2014 14:47:59 +0800
Subject: [PATCH 1163/1207] powerpc/deepsleep: set MPIC to the mixed mode to
 avoid deep sleep issue

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

The deep sleep does not wake consistently on T1040 and T1042 with
the external proxy facility mode of MPIC (MPIC_ENABLE_COREINT),
so use the mixed mode of MPIC. Set mpic_get_irq() to ppc_md.get_irq
to enable the mixed mode.

Change-Id: I5eee6a15c845fb994c39d74a4e8140a610caf5f9
Signed-off-by: Zhao Chenhui <chenhui.zhao@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/11438
Reviewed-by: Yang Li <LeoLi@freescale.com>
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
---
 arch/powerpc/platforms/85xx/corenet_generic.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/arch/powerpc/platforms/85xx/corenet_generic.c b/arch/powerpc/platforms/85xx/corenet_generic.c
index bd61103..834509a 100644
--- a/arch/powerpc/platforms/85xx/corenet_generic.c
+++ b/arch/powerpc/platforms/85xx/corenet_generic.c
@@ -32,6 +32,7 @@
 #include <linux/of_platform.h>
 #include <sysdev/fsl_soc.h>
 #include <sysdev/fsl_pci.h>
+#include <asm/mpc85xx.h>
 #include "smp.h"
 #include "mpc85xx.h"
 
@@ -40,12 +41,23 @@
 void __init corenet_gen_pic_init(void)
 {
 	struct mpic *mpic;
+	u32 svr = mfspr(SPRN_SVR);
 	unsigned int flags = MPIC_BIG_ENDIAN | MPIC_SINGLE_DEST_CPU |
 		MPIC_NO_RESET;
 
 #ifdef CONFIG_QUICC_ENGINE
 	struct device_node *np;
 #endif
+	/*
+	 * The deep sleep does not wake consistently on T1040 and T1042 with
+	 * the external proxy facility mode of MPIC (MPIC_ENABLE_COREINT),
+	 * so use the mixed mode of MPIC. Set mpic_get_irq to ppc_md.get_irq
+	 * to enable the mixed mode of MPIC.
+	 */
+	if ((SVR_SOC_VER(svr) == SVR_T1040) ||
+	    (SVR_SOC_VER(svr) == SVR_T1042)) {
+		ppc_md.get_irq = mpic_get_irq;
+	}
 
 	if (ppc_md.get_irq == mpic_get_coreint_irq)
 		flags |= MPIC_ENABLE_COREINT;
-- 
2.0.2

