From 771d7d7e6d0f82da337e014984aab9734abe37a8 Mon Sep 17 00:00:00 2001
From: Anca Jeanina FLOAREA <anca.floarea@freescale.com>
Date: Tue, 28 May 2013 16:45:49 +0300
Subject: [PATCH 199/987] dpa_offload: Policer memory is freed every time

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

Policer memory must be released only in case the policy
direction is DPA_IPSEC_POL_DIR_PARAMS_ACT, otherwise the
memory will not be allocated.

Signed-off-by: Anca Jeanina FLOAREA <anca.floarea@freescale.com>
Change-Id: Idedfa2c08c4b6ab8179a6303ac296087a98fbbb8
Reviewed-on: http://git.am.freescale.net:8181/2744
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Varvara Andrei-B21317 <andrei.varvara@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
---
 drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
index 0faf3e7..3a16794 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
@@ -754,7 +754,7 @@ static int do_add_rem_policy_compat_ioctl(void *args, bool add_pol)
 	else
 		err = dpa_ipsec_sa_remove_policy(kprm.sa_id, &kprm.pol_params);
 
-	if (err < 0)
+	if (uprm.pol_params.dir_params.type == DPA_IPSEC_POL_DIR_PARAMS_ACT)
 		kfree(in_action->enq_params.policer_params);
 
 	return err;
-- 
1.9.1

