From 208a2b0a8138663631740d3a21876a352636dc02 Mon Sep 17 00:00:00 2001
From: "Haijun.Zhang" <haijun.zhang@freescale.com>
Date: Thu, 18 Apr 2013 16:23:33 +0800
Subject: [PATCH 1043/1094] eSDHC: Enable IRQ detect mod for p1020 and p5040

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

Card insert and remove interrupt can be generate and work well.
So using IRQ mod for card detecting instead of polling mod.

This patch can avoid the call trace bug used to produce.
also can improve the performance for card data transfer.
Avoid no necessary frequent access to cpu and card.

Signed-off-by: Haijun Zhang <haijun.zhang@freescale.com>
Change-Id: I06b98f0bdc5208d0bf41a2ca79a78435b5c1bd27
Reviewed-on: http://git.am.freescale.net:8181/1218
Reviewed-by: Xie Xiaobo-R63061 <X.Xie@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Fix context to apply to WRL.]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/mmc/host/sdhci-pltfm.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/drivers/mmc/host/sdhci-pltfm.c b/drivers/mmc/host/sdhci-pltfm.c
index ed50a05..ae939c6 100644
--- a/drivers/mmc/host/sdhci-pltfm.c
+++ b/drivers/mmc/host/sdhci-pltfm.c
@@ -108,6 +108,10 @@ void sdhci_get_of_property(struct platform_device *pdev)
 			host->quirks |= SDHCI_QUIRK_BROKEN_ADMA;
 	}
 
+	if (of_device_is_compatible(np, "fsl,p5040-esdhc") ||
+		of_device_is_compatible(np, "fsl,p1020-esdhc"))
+		host->quirks &= ~SDHCI_QUIRK_BROKEN_CARD_DETECTION;
+
 	clk = of_get_property(np, "clock-frequency", &size);
 	if (clk && size == sizeof(*clk) && *clk)
 		pltfm_host->clock = be32_to_cpup(clk);
-- 
2.0.2

