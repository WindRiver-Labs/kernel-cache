From 58fde7916f461474cec069b34868f7f6461bb278 Mon Sep 17 00:00:00 2001
From: Cristian Stoica <cristian.stoica@freescale.com>
Date: Tue, 23 Sep 2014 13:17:42 +0300
Subject: [PATCH 1306/1336] crypto: caamhash: fix jr alloc leak on error path

Memory allocated for ctx->jrdev is freed in all error paths except when
ahash_set_sh_desc(ahash) fails. Add a check for this case and free
memory as appropriate.

Signed-off-by: Cristian Stoica <cristian.stoica@freescale.com>
Change-Id: I1c4e45a8cfdc6d24d768e90a148bb398b3d09f52
Reviewed-on: http://git.am.freescale.net:8181/19803
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Horia Ioan Geanta Neag <horia.geanta@freescale.com>
Reviewed-by: Mircea Pop <mircea.pop@freescale.com>
Reviewed-by: Matthew Weigel <Matthew.Weigel@freescale.com>
[Lu:Original patch taken from
QorIQ-SDK-V1.7-SOURCE-20141218-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/crypto/caam/caamhash.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/crypto/caam/caamhash.c b/drivers/crypto/caam/caamhash.c
index 0a6b936..cd51879 100644
--- a/drivers/crypto/caam/caamhash.c
+++ b/drivers/crypto/caam/caamhash.c
@@ -1764,7 +1764,7 @@ static int caam_hash_cra_init(struct crypto_tfm *tfm)
 					 HASH_MSG_LEN + SHA256_DIGEST_SIZE,
 					 HASH_MSG_LEN + 64,
 					 HASH_MSG_LEN + SHA512_DIGEST_SIZE };
-	int ret = 0;
+	int ret;
 	u8 op_id;
 
 	/*
@@ -1793,7 +1793,8 @@ static int caam_hash_cra_init(struct crypto_tfm *tfm)
 				 sizeof(struct caam_hash_state));
 
 	ret = ahash_set_sh_desc(ahash);
-	return ret;
+	if (ret == 0)
+		return ret;
 
 out_err:
 	caam_jr_free(ctx->jrdev);
-- 
2.0.2

