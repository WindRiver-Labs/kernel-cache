From d546e667eabf9e38a30891dcd26f5d2f2e58c2ab Mon Sep 17 00:00:00 2001
From: Poonam Aggrwal <poonam.aggrwal@freescale.com>
Date: Wed, 14 Aug 2013 04:47:00 +0530
Subject: [PATCH 343/987] Updates to device trees for B4860 for DSP clusters
 and their L2 caches

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

B4860 has 1 PPC core cluster and 3 DSP core clusters.
Similarly B4420 has 1 PPC core cluster and 1 DSP core cluster.

Each DSP core cluster consists of 2 SC3900 cores and a shared L2 cache.

1. Add DSP clusters for B4420
2. Reorganized the L2 cache nodes such that they now appear in only the
soc specific dtsi files(b4860si-post.dtsi and b4420si-post.dtsi).
Earlier they were shown partly in common b4si-post.dtsi and si specific
b4860si-post.dtsi files .
3. Fixed an issue in b4860si-pre.dtsi, now DSP cluster correctly point to their
respective L2 caches

Signed-off-by: Poonam Aggrwal <poonam.aggrwal@freescale.com>
Signed-off-by: Shaveta Leekha <shaveta@freescale.com>
Change-Id: Ie09007f4c596fc5947e0b4b005225b8b1f9aa443
Reviewed-on: http://git.am.freescale.net:8181/4005
Reviewed-by: Sethi Varun-B16395 <Varun.Sethi@freescale.com>
Reviewed-by: Rivera Jose-B46482 <Jose.G.Rivera@freescale.com>
Tested-by: Rivera Jose-B46482 <Jose.G.Rivera@freescale.com>
[Fix context to apply to WRL.]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/powerpc/boot/dts/fsl/b4420si-post.dtsi |  8 ++++++++
 arch/powerpc/boot/dts/fsl/b4420si-pre.dtsi  | 23 +++++++++++++++++++++++
 arch/powerpc/boot/dts/fsl/b4860si-post.dtsi |  2 ++
 arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi  |  8 ++++----
 arch/powerpc/boot/dts/fsl/b4si-post.dtsi    |  5 -----
 5 files changed, 37 insertions(+), 9 deletions(-)

diff --git a/arch/powerpc/boot/dts/fsl/b4420si-post.dtsi b/arch/powerpc/boot/dts/fsl/b4420si-post.dtsi
index 752f401..db8f7b5 100644
--- a/arch/powerpc/boot/dts/fsl/b4420si-post.dtsi
+++ b/arch/powerpc/boot/dts/fsl/b4420si-post.dtsi
@@ -296,5 +296,13 @@
 
 	L2: l2-cache-controller@c20000 {
 		compatible = "fsl,b4420-l2-cache-controller";
+		reg = <0xc20000 0x1000>;
+		next-level-cache = <&cpc>;
+	};
+
+	L2_2: l2-cache-controller@c60000 {
+		compatible = "fsl,b4420-l2-cache-controller";
+		reg = <0xc60000 0x1000>;
+		next-level-cache = <&cpc>;
 	};
 };
diff --git a/arch/powerpc/boot/dts/fsl/b4420si-pre.dtsi b/arch/powerpc/boot/dts/fsl/b4420si-pre.dtsi
index 2ddf1d8..3d22217 100644
--- a/arch/powerpc/boot/dts/fsl/b4420si-pre.dtsi
+++ b/arch/powerpc/boot/dts/fsl/b4420si-pre.dtsi
@@ -92,4 +92,27 @@
 			fsl,portid-mapping = <0x80000000>;
 		};
 	};
+
+	dsp-clusters {
+		#address-cells = <1>;
+		#size-cells = <0>;
+
+		dsp-cluster0 {
+			#address-cells = <1>;
+			#size-cells = <0>;
+			compatible = "fsl,sc3900-cluster";
+			reg = <0>;
+
+			dsp0: dsp@0 {
+				compatible = "fsl,sc3900";
+				reg = <0>;
+				next-level-cache = <&L2_2>;
+			};
+			dsp1: dsp@1 {
+				compatible = "fsl,sc3900";
+				reg = <1>;
+				next-level-cache = <&L2_2>;
+			};
+		};
+	};
 };
diff --git a/arch/powerpc/boot/dts/fsl/b4860si-post.dtsi b/arch/powerpc/boot/dts/fsl/b4860si-post.dtsi
index f4f0bff..4838ab5 100644
--- a/arch/powerpc/boot/dts/fsl/b4860si-post.dtsi
+++ b/arch/powerpc/boot/dts/fsl/b4860si-post.dtsi
@@ -399,6 +399,8 @@
 
 	L2: l2-cache-controller@c20000 {
 		compatible = "fsl,b4860-l2-cache-controller";
+		reg = <0xc20000 0x1000>;
+		next-level-cache = <&cpc>;
 	};
 
 	L2_2: l2-cache-controller@c60000 {
diff --git a/arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi b/arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi
index e58fb10..8685333 100644
--- a/arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi
+++ b/arch/powerpc/boot/dts/fsl/b4860si-pre.dtsi
@@ -141,12 +141,12 @@
 			dsp2: dsp@2 {
 				compatible = "fsl,sc3900";
 				reg = <2>;
-				next-level-cache = <&L2_2>;
+				next-level-cache = <&L2_3>;
 			};
 			dsp3: dsp@3 {
 				compatible = "fsl,sc3900";
 				reg = <3>;
-				next-level-cache = <&L2_2>;
+				next-level-cache = <&L2_3>;
 			};
 		};
 
@@ -159,12 +159,12 @@
 			dsp4: dsp@4 {
 				compatible = "fsl,sc3900";
 				reg = <4>;
-				next-level-cache = <&L2_2>;
+				next-level-cache = <&L2_4>;
 			};
 			dsp5: dsp@5 {
 				compatible = "fsl,sc3900";
 				reg = <5>;
-				next-level-cache = <&L2_2>;
+				next-level-cache = <&L2_4>;
 			};
 		};
 	};
diff --git a/arch/powerpc/boot/dts/fsl/b4si-post.dtsi b/arch/powerpc/boot/dts/fsl/b4si-post.dtsi
index 31dca2e..01f5a7f 100644
--- a/arch/powerpc/boot/dts/fsl/b4si-post.dtsi
+++ b/arch/powerpc/boot/dts/fsl/b4si-post.dtsi
@@ -418,9 +418,4 @@
 		interrupts = <16 2 1 29>;
 	};
 
-	L2: l2-cache-controller@c20000 {
-		compatible = "fsl,b4-l2-cache-controller";
-		reg = <0xc20000 0x1000>;
-		next-level-cache = <&cpc>;
-	};
 };
-- 
1.9.1

