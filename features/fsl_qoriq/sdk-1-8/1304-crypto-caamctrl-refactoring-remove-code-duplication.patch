From c2608403dbe84a3759323a21290829bb220b12bc Mon Sep 17 00:00:00 2001
From: Cristian Stoica <cristian.stoica@freescale.com>
Date: Tue, 23 Sep 2014 13:59:21 +0300
Subject: [PATCH 1304/1336] crypto: caamctrl refactoring: remove code
 duplication

Both error and normal paths call clrbits32 before returning. Put this
call in a single place to avoid code duplication

Signed-off-by: Cristian Stoica <cristian.stoica@freescale.com>
(cherry picked from commit c75e03a2d47583e39f46c2925abd0ca79a693086)
Signed-off-by: Matthew Weigel <Matthew.Weigel@freescale.com>

Conflicts:
	drivers/crypto/caam/ctrl.c
Change-Id: I3c2ec1c34215b5d2a1ee036809beaeabf724ac48
Reviewed-on: http://git.am.freescale.net:8181/24179
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Matthew Weigel <Matthew.Weigel@freescale.com>
[Lu:Original patch taken from
QorIQ-SDK-V1.7-SOURCE-20141218-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/crypto/caam/ctrl.c | 15 +++++++--------
 1 file changed, 7 insertions(+), 8 deletions(-)

diff --git a/drivers/crypto/caam/ctrl.c b/drivers/crypto/caam/ctrl.c
index 7801e61..029c7c2 100644
--- a/drivers/crypto/caam/ctrl.c
+++ b/drivers/crypto/caam/ctrl.c
@@ -88,7 +88,7 @@ static inline int run_descriptor_deco0(struct device *ctrldev, u32 *desc,
 	struct caam_deco __iomem *deco = ctrlpriv->deco;
 	unsigned int timeout = 100000;
 	u32 deco_dbg_reg, flags;
-	int i;
+	int i, ret;
 
 
 	if (ctrlpriv->virt_en == 1) {
@@ -109,8 +109,8 @@ static inline int run_descriptor_deco0(struct device *ctrldev, u32 *desc,
 
 	if (!timeout) {
 		dev_err(ctrldev, "failed to acquire DECO 0\n");
-		clrbits32(&ctrl->deco_rq, DECORR_RQD0ENABLE);
-		return -ENODEV;
+		ret = -ENODEV;
+		goto out_err;
 	}
 
 	for (i = 0; i < desc_len(desc); i++)
@@ -146,13 +146,12 @@ static inline int run_descriptor_deco0(struct device *ctrldev, u32 *desc,
 	if (ctrlpriv->virt_en == 1)
 		clrbits32(&ctrl->deco_rsr, DECORSR_JR0);
 
+	ret = timeout ? 0 : -EAGAIN;
+
+out_err:
 	/* Mark the DECO as free */
 	clrbits32(&ctrl->deco_rq, DECORR_RQD0ENABLE);
-
-	if (!timeout)
-		return -EAGAIN;
-
-	return 0;
+	return ret;
 }
 
 /*
-- 
2.0.2

