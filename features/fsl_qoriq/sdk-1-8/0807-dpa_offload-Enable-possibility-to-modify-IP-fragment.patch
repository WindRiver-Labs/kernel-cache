From e80f74bb7c055eadb8b6675746197c20198a013c Mon Sep 17 00:00:00 2001
From: Marian Chereji <marian.chereji@freescale.com>
Date: Mon, 21 Jul 2014 18:01:56 +0300
Subject: [PATCH 807/987] dpa_offload: Enable possibility to modify IP
 fragmentation params in update HM

Possibility to modify at runtime the IP fragmentation params in the
update header manipulation operation (created via dpa_classif_set_update_hm)
was disabled from the DPA classifier driver. This change enables it.

Signed-off-by: Marian Chereji <marian.chereji@freescale.com>
Change-Id: I4ed91e941a810235503dc23f24b6ebb4e563be90
Reviewed-on: http://git.am.freescale.net:8181/15223
Reviewed-by: Anca Jeanina Floarea <anca.floarea@freescale.com>
[Lu:Original patch taken from
QorIQ-SDK-V1.7-SOURCE-20141218-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_classifier.c | 35 +++++++++++++++++++++++-
 1 file changed, 34 insertions(+), 1 deletion(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_classifier.c b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
index fe22df8..0899683 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_classifier.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
@@ -6665,6 +6665,12 @@ int dpa_classif_modify_update_hm(int hmd,
 		}
 	}
 
+	if (modify_flags & DPA_CLS_HM_UPDATE_MOD_IP_FRAG_MTU) {
+		pupdate_hm->update_params.ip_frag_params.mtu =
+				new_update_params->ip_frag_params.mtu;
+		update[1] = true;
+	}
+
 	if (update[0]) {
 		ret = update_hm_update_params(pupdate_hm);
 		if (ret == 0) {
@@ -6693,7 +6699,34 @@ int dpa_classif_modify_update_hm(int hmd,
 		}
 	}
 
-	/* update[1] not supported at this time */
+	if (update[1]) {
+		ret = update_hm_update_params(pupdate_hm);
+		if (ret == 0) {
+			t_FmPcdManipParams new_hm_node_params;
+
+			hm_node = pupdate_hm->hm_node[1];
+
+			/*
+			 * Have to make a copy of the manip node params because
+			 * ManipNodeReplace does not accept h_NextManip != NULL.
+			 */
+			memcpy(&new_hm_node_params, &hm_node->params,
+						sizeof(new_hm_node_params));
+			new_hm_node_params.h_NextManip = NULL;
+			error = FM_PCD_ManipNodeReplace(hm_node->node,
+							&new_hm_node_params);
+			if (error != E_OK) {
+				release_desc_table(&hm_array);
+				mutex_unlock(&pupdate_hm->access);
+				log_err("FMan driver call failed - "
+					"FM_PCD_ManipNodeReplace, while trying "
+					"to modify hmd=%d, manip node "
+					"handle=0x%p.\n", hmd, hm_node->node);
+				return -EBUSY;
+			}
+		}
+
+	}
 
 	release_desc_table(&hm_array);
 	mutex_unlock(&pupdate_hm->access);
-- 
1.9.1

