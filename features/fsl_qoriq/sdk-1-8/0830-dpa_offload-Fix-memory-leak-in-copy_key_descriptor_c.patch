From 06849394d73fe739244e06fcfafaed8ab43b866c Mon Sep 17 00:00:00 2001
From: Anca Jeanina Floarea <anca.floarea@freescale.com>
Date: Tue, 4 Nov 2014 16:13:07 +0200
Subject: [PATCH 830/987] dpa_offload: Fix memory leak in
 copy_key_descriptor_compatcpy

In case either the byte or the mask of a key are provided NULL,
the memory allocated for the lookup key descriptor needs to be
release.

Signed-off-by: Anca Jeanina Floarea <anca.floarea@freescale.com>
Change-Id: Ibb9b7ec28a93a87c82ab318b763866cf3d9f493a
Reviewed-on: http://git.am.freescale.net:8181/23131
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Marian-Cornel Chereji <marian.chereji@freescale.com>
Reviewed-by: Richard Schmitt <richard.schmitt@freescale.com>
[Lu:Original patch taken from
QorIQ-SDK-V1.7-SOURCE-20141218-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/staging/fsl_dpa_offload/wrp_dpa_stats.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_stats.c b/drivers/staging/fsl_dpa_offload/wrp_dpa_stats.c
index 48ed7ca..ad89d3d 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_stats.c
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_stats.c
@@ -2063,6 +2063,7 @@ static int copy_key_descriptor_compatcpy(
 		if (key.size == 0 || key.size > DPA_OFFLD_MAXENTRYKEYSIZE) {
 			log_err("Key size should be between %d and %d.\n", 1,
 				DPA_OFFLD_MAXENTRYKEYSIZE);
+			kfree(kparam);
 			return -EINVAL;
 		}
 	}
-- 
1.9.1

