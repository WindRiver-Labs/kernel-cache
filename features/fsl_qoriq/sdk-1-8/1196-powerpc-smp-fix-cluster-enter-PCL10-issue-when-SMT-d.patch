From 1d70d13c977156fe418b2d9ea2c1ef5957b921db Mon Sep 17 00:00:00 2001
From: Zhang Zhuoyu <Zhuoyu.Zhang@freescale.com>
Date: Fri, 7 Nov 2014 16:41:05 +0800
Subject: [PATCH 1196/1207] powerpc/smp: fix cluster enter PCL10 issue when SMT
 disable on e6500

When CPU SMT feature disabled on e6500, cluster can't enter PCL10.
This patch fix it.

Signed-off-by: Zhang Zhuoyu <Zhuoyu.Zhang@freescale.com>
Change-Id: I362be661ceefd78e5d8b1d6f36331add4e9ef0af
Reviewed-on: http://git.am.freescale.net:8181/23341
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Hongtao Jia <hongtao.jia@freescale.com>
Reviewed-by: Matthew Weigel <Matthew.Weigel@freescale.com>
[Lu:Original patch taken from
QorIQ-SDK-V1.7-SOURCE-20141218-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/platforms/85xx/smp.c | 7 ++-----
 1 file changed, 2 insertions(+), 5 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/smp.c b/arch/powerpc/platforms/85xx/smp.c
index 860b674..768dd73 100644
--- a/arch/powerpc/platforms/85xx/smp.c
+++ b/arch/powerpc/platforms/85xx/smp.c
@@ -419,15 +419,13 @@ static void init_cpu_cluster_map(void)
 {
 	struct device_node *l2_cache, *np;
 	int cpu, i;
-	char buf[20];
-	ptrdiff_t len = PTR_ALIGN(buf + PAGE_SIZE - 1, PAGE_SIZE) - buf;
 
-	for_each_cpu(cpu, cpu_present_mask) {
+	for_each_cpu(cpu, cpu_online_mask) {
 		l2_cache = cpu_to_l2cache(cpu);
 		if (!l2_cache)
 			continue;
 
-		for_each_cpu(i, cpu_present_mask) {
+		for_each_cpu(i, cpu_online_mask) {
 			np = cpu_to_l2cache(i);
 			if (!np)
 				continue;
@@ -438,7 +436,6 @@ static void init_cpu_cluster_map(void)
 			of_node_put(np);
 		}
 		of_node_put(l2_cache);
-		cpumask_scnprintf(buf, len-2, cpu_cluster_mask(cpu));
 	}
 }
 
-- 
2.0.2

