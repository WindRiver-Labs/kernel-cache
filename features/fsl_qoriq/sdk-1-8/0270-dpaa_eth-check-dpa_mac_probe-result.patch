From a567d083d4ec9641c3f4bdd44e80ed85fb3e94e3 Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Mon, 17 Jun 2013 16:30:41 +0300
Subject: [PATCH 270/987] dpaa_eth: check dpa_mac_probe() result

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

Check for NULL returns from dpa_mac_probe() when probing private
and shared interfaces.
If a MACless interface is mistakenly identified with the old
compatibility string "fsl,dpa-ethernet" instead of the required
"fsl,dpa-ethernet-macless" compatibility string the interface
is probed as private interface and dpa_mac_probe() fails.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
Change-Id: I221d00aafb6ba25f32b7a451610f1e6185bdb7ca
Reviewed-on: http://git.am.freescale.net:8181/3091
Reviewed-by: Sovaiala Cristian-Constantin-B39531 <Cristian.Sovaiala@freescale.com>
Reviewed-by: Radulescu Ruxandra Ioana-B05472 <ruxandra.radulescu@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c        | 3 ++-
 drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c | 2 +-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 33b7d9b..17c8ac4 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -3066,6 +3066,7 @@ out_error:
 }
 
 static const struct of_device_id dpa_match[];
+
 static int
 dpaa_eth_priv_probe(struct platform_device *_of_dev)
 {
@@ -3115,7 +3116,7 @@ dpaa_eth_priv_probe(struct platform_device *_of_dev)
 	priv->msg_enable = netif_msg_init(debug, -1);
 
 	mac_dev = dpa_mac_probe(_of_dev);
-	if (IS_ERR(mac_dev)) {
+	if (IS_ERR(mac_dev) || !mac_dev) {
 		err = PTR_ERR(mac_dev);
 		goto mac_probe_failed;
 	}
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
index 3bb60e8..2b75b1e 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
@@ -647,7 +647,7 @@ dpaa_eth_shared_probe(struct platform_device *_of_dev)
 	priv->msg_enable = netif_msg_init(debug, -1);
 
 	mac_dev = dpa_mac_probe(_of_dev);
-	if (IS_ERR(mac_dev)) {
+	if (IS_ERR(mac_dev) || !mac_dev) {
 		err = PTR_ERR(mac_dev);
 		goto mac_probe_failed;
 	}
-- 
1.9.1

