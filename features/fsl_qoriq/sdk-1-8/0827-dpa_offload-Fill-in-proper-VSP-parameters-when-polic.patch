From e74bf8b377054b4d4994019ad2e1a6cbff63cb39 Mon Sep 17 00:00:00 2001
From: Marian Chereji <marian.chereji@freescale.com>
Date: Fri, 24 Oct 2014 18:04:53 +0300
Subject: [PATCH 827/987] dpa_offload: Fill in proper VSP parameters when
 policer is enabled

There are 2 different VSP profile parameters in the FMD API that need to
be filled in depending whether the policer is enabled or disabled. The
dpa_classifier was filling in the enqueue VSP profile all the time, but
this was used only when the next action was "enqueue". When the next
action is "policer" the policer VSP profile must be filled in.

Change-Id: I09e2a6fad7216e7ce7b3c1190a4441b7a9825705
Signed-off-by: Marian Chereji <marian.chereji@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/22064
Reviewed-by: Francois Massot-Pellet <Francois.Massot-Pellet@freescale.com>
[Lu:Original patch taken from
QorIQ-SDK-V1.7-SOURCE-20141218-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_classifier.c | 13 +++++++++----
 1 file changed, 9 insertions(+), 4 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_classifier.c b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
index ffc9ce8..65bc333 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_classifier.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
@@ -3110,6 +3110,11 @@ static int action_to_next_engine_params(const struct dpa_cls_tbl_action *action,
 					policer_params->modify_policer_params;
 				next_engine_params->params.plcrParams.
 					newFqid = action->enq_params.new_fqid;
+#if (DPAA_VERSION >= 11)
+				next_engine_params->params.plcrParams.
+					newRelativeStorageProfileId =
+					action->enq_params.new_rel_vsp_id;
+#endif /* (DPAA_VERSION >= 11) */
 			} else {
 				next_engine_params->nextEngine = e_FM_PCD_DONE;
 				next_engine_params->params.enqueueParams.
@@ -3120,12 +3125,12 @@ static int action_to_next_engine_params(const struct dpa_cls_tbl_action *action,
 					next_engine_params->params.
 						enqueueParams.overrideFqid =
 						TRUE;
-			}
 #if (DPAA_VERSION >= 11)
-			next_engine_params->params.enqueueParams.
-				  newRelativeStorageProfileId =
-				      action->enq_params.new_rel_vsp_id;
+				next_engine_params->params.enqueueParams.
+					newRelativeStorageProfileId =
+					action->enq_params.new_rel_vsp_id;
 #endif
+			}
 		}
 
 		if (action->enq_params.hmd != DPA_OFFLD_DESC_NONE) {
-- 
1.9.1

