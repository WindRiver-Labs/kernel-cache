From 47c6bef23e8936670c5030e7e33e19a32a9b1ecb Mon Sep 17 00:00:00 2001
From: Roy Pledge <Roy.Pledge@freescale.com>
Date: Mon, 21 Jul 2014 10:47:03 -0400
Subject: [PATCH 837/987] Set affinity for USDPAA IRQs

Set the affinity of the USDPAA IRQ to match the affinity of the
calling process

Signed-off-by: Roy Pledge <Roy.Pledge@freescale.com>
Change-Id: I077a48ae5a77fe35a77dfae65c298fa6fa2aecda
Reviewed-on: http://git.am.freescale.net:8181/23675
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Geoff Thorpe <Geoff.Thorpe@freescale.com>
Reviewed-by: Jeffrey Ladouceur <Jeffrey.Ladouceur@freescale.com>
Reviewed-by: Matthew Weigel <Matthew.Weigel@freescale.com>
[Lu:Original patch taken from
QorIQ-SDK-V1.7-SOURCE-20141218-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/staging/fsl_qbman/fsl_usdpaa_irq.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/drivers/staging/fsl_qbman/fsl_usdpaa_irq.c b/drivers/staging/fsl_qbman/fsl_usdpaa_irq.c
index ca93593..1f8260b 100644
--- a/drivers/staging/fsl_qbman/fsl_usdpaa_irq.c
+++ b/drivers/staging/fsl_qbman/fsl_usdpaa_irq.c
@@ -81,6 +81,7 @@ static int usdpaa_irq_release(struct inode *inode, struct file *filp)
 	if (ctx->irq_set) {
 		/* Inhibit the IRQ */
 		out_be32(ctx->inhibit_addr, 0x1);
+		irq_set_affinity_hint(ctx->irq_num, NULL);
 		free_irq(ctx->irq_num, ctx);
 		ctx->irq_set = 0;
 		fput(ctx->usdpaa_filp);
@@ -139,6 +140,14 @@ static int map_irq(struct file *fp, struct usdpaa_ioctl_irq_map *irq_map)
 		fput(ctx->usdpaa_filp);
 		return ret;
 	}
+	ret = irq_set_affinity(ctx->irq_num, tsk_cpus_allowed(current));
+	if (ret)
+		pr_err("USDPAA irq_set_affinity() failed, ret= %d\n", ret);
+
+	ret = irq_set_affinity_hint(ctx->irq_num, tsk_cpus_allowed(current));
+	if (ret)
+		pr_err("USDPAA irq_set_affinity_hint() failed, ret= %d\n", ret);
+
 	return 0;
 }
 
-- 
1.9.1

