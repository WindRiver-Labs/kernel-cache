From dca4a25e9d6e550a2f79a675628dc4a5d0a890c2 Mon Sep 17 00:00:00 2001
From: "Lu.Jiang" <lu.jiang@windriver.com>
Date: Wed, 10 Sep 2014 13:40:51 +0800
Subject: [PATCH 355/987] Check for valid window before proceeding to set the
 stash or the omi attribute.

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

Signed-off-by: Varun Sethi <Varun.Sethi@freescale.com>
Change-Id: I6bbad9f1f1240fa23ae6997f5a0cdc6cb49228e1
Reviewed-on: http://git.am.freescale.net:8181/4035
Reviewed-by: Yoder Stuart-B08248 <stuart.yoder@freescale.com>
Reviewed-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
Tested-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
Signed-off-by: Lu.Jiang <lu.jiang@windriver.com>
---
 drivers/iommu/fsl_pamu_domain.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/drivers/iommu/fsl_pamu_domain.c b/drivers/iommu/fsl_pamu_domain.c
index 966dc7f..13b595b 100644
--- a/drivers/iommu/fsl_pamu_domain.c
+++ b/drivers/iommu/fsl_pamu_domain.c
@@ -785,6 +785,11 @@ static  int configure_domain_geometry(struct iommu_domain *domain, void *data)
 	return 0;
 }
 
+static inline int check_attr_window(u32 wnd, struct fsl_dma_domain *dma_domain)
+{
+	return ((~wnd != 0) && (wnd >= dma_domain->win_cnt));
+}
+
 /* Set the domain operation mapping attribute */
 static int configure_domain_op_map(struct fsl_dma_domain *dma_domain,
 				    void *data)
@@ -803,7 +808,8 @@ static int configure_domain_op_map(struct fsl_dma_domain *dma_domain,
 		return -ENODEV;
 	}
 
-	if (omi_attr->omi >= OMI_MAX) {
+	if (omi_attr->omi >= OMI_MAX ||
+		check_attr_window(omi_attr->window, dma_domain)) {
 		pr_err("Invalid operation mapping index\n");
 		spin_unlock_irqrestore(&dma_domain->domain_lock, flags);
 		return -EINVAL;
@@ -848,7 +854,8 @@ static int configure_domain_stash(struct fsl_dma_domain *dma_domain, void *data)
 
 	stash_id = get_stash_id(stash_attr->cache,
 					    stash_attr->cpu);
-	if (~stash_id == 0) {
+	if ((~stash_id == 0) ||
+		 check_attr_window(stash_attr->window, dma_domain)) {
 		pr_debug("Invalid stash attributes\n");
 		spin_unlock_irqrestore(&dma_domain->domain_lock, flags);
 		return -EINVAL;
-- 
1.9.1

