From 79f4cb1edb914c2e31cbea8d80fd447e529da5ff Mon Sep 17 00:00:00 2001
From: Jianchuan Wang <jianchuan.wang@windriver.com>
Date: Thu, 23 Apr 2015 15:55:49 +0800
Subject: [PATCH 1201/1207] fsl-t2xxx: Fix compile errors when disabling
 CONFIG_SMP

There are some compile errors when disabling CONFIG_SMP
- boot_cpuid isn't declared in the ics.c,it hints:

    | arch/powerpc/platforms/wsp/ics.c: In function 'wsp_ics_set_default_server':
    | arch/powerpc/platforms/wsp/ics.c:655:23: error: 'boot_cpuid' undeclared (first use in this function)
    |   np = of_get_cpu_node(boot_cpuid, NULL);
    |                        ^
    | arch/powerpc/platforms/wsp/ics.c:655:23: note: each undeclared identifier is reported only once for each function it appears in
    | arch/powerpc/platforms/wsp/ics.c:658:2: error: implicit declaration of function 'get_hard_smp_processor_id' [-Werror=implicit-function-declaration]
    |   hwid = get_hard_smp_processor_id(boot_cpuid);

- nr_cpu_ids isn't defined in the exceptions-64e.S/head_64.S, it hints:

    | arch/powerpc/kernel/head_64.S:231: undefined reference to `nr_cpu_ids'

Signed-off-by: Jianchuan Wang <jianchuan.wang@windriver.com>
[Yang: Fix context to apply to WRL.]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/powerpc/kernel/exceptions-64e.S | 4 ++++
 arch/powerpc/kernel/head_64.S        | 4 ++++
 2 files changed, 8 insertions(+)

diff --git a/arch/powerpc/kernel/exceptions-64e.S b/arch/powerpc/kernel/exceptions-64e.S
index 3a891a9..714c19e 100644
--- a/arch/powerpc/kernel/exceptions-64e.S
+++ b/arch/powerpc/kernel/exceptions-64e.S
@@ -1654,8 +1654,12 @@ BEGIN_FTR_SECTION
 	LOAD_REG_ADDR(r8, paca)	/* Get the current paca */
 	ld	r8,0(r8)
 	li	r5,0
+#ifdef CONFIG_SMP
 	LOAD_REG_ADDR(r7, nr_cpu_ids)
 	lwz	r7,0(r7)
+#else
+	li  r7,1
+#endif
 11:	lhz	r6,PACAHWCPUID(r8)
 	cmpw	r6,r4
 	beq	12f
diff --git a/arch/powerpc/kernel/head_64.S b/arch/powerpc/kernel/head_64.S
index 7a574aa..cea8ec6 100644
--- a/arch/powerpc/kernel/head_64.S
+++ b/arch/powerpc/kernel/head_64.S
@@ -230,8 +230,12 @@ _GLOBAL(fsl_secondary_thread_init)
 	ld	r3,0(r3)
 	mfspr	r4,SPRN_TIR	/* The thread0 cpu id plus TIR is the */
 	add	r3,r3,r4	/* logical id of the current thread. */
+#ifdef CONFIG_SMP
 	LOAD_REG_ADDR(r4, nr_cpu_ids)
 	lwz	r4,0(r4)
+#else
+	li r4,1
+#endif
 	cmpld	r3,r4
 	bge	.
 
-- 
2.0.2

