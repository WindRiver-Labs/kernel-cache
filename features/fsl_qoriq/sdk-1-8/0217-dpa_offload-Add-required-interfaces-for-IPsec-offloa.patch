From 9b80d0e02470eda984f9ffb4e6ea7e3f559da946 Mon Sep 17 00:00:00 2001
From: Marian Chereji <marian.chereji@freescale.com>
Date: Mon, 3 Jun 2013 15:01:20 +0300
Subject: [PATCH 217/987] dpa_offload: Add required interfaces for IPsec
 offloading USDPAA use-case

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

The ipsec_offload application needs 2 Mac-less interfaces and 2 physical
Ethernet interfaces in usdpaa.

Signed-off-by: Alexandru Badicioiu <b15898@freescale.com>
Signed-off-by: Marian Chereji <marian.chereji@freescale.com>
Change-Id: I7da4a92f72faa78cd4fb2d2cbaf2ab56b3aaf88c
Reviewed-on: http://git.am.freescale.net:8181/2864
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
---
 .../dts/b4420qds-usdpaa-shared-interfaces.dts      | 33 ++++++++------
 .../fsl_dpa_offload/dts/b4420qds-usdpaa.dts        | 52 +++++++++++++++++-----
 .../dts/b4860qds-usdpaa-shared-interfaces.dts      | 42 ++++++++++-------
 .../fsl_dpa_offload/dts/b4860qds-usdpaa.dts        | 42 ++++++++++-------
 .../dts/p4080ds-usdpaa-shared-interfaces.dts       | 31 ++++++++-----
 .../staging/fsl_dpa_offload/dts/p4080ds-usdpaa.dts | 28 ++++++++++++
 6 files changed, 157 insertions(+), 71 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dts/b4420qds-usdpaa-shared-interfaces.dts b/drivers/staging/fsl_dpa_offload/dts/b4420qds-usdpaa-shared-interfaces.dts
index 815703c..f141931 100644
--- a/drivers/staging/fsl_dpa_offload/dts/b4420qds-usdpaa-shared-interfaces.dts
+++ b/drivers/staging/fsl_dpa_offload/dts/b4420qds-usdpaa-shared-interfaces.dts
@@ -101,7 +101,7 @@
 		};
 		ethernet@2 {
 			compatible = "fsl,b4420-dpa-ethernet-init", "fsl,dpa-ethernet-init";
-			fsl,bman-buffer-pools = <&bp7 &bp8 &bp9>;
+			fsl,bman-buffer-pools = <&bp16>;
 			fsl,qman-frame-queues-rx = <0x54 1 0x55 1>;
 			fsl,qman-frame-queues-tx = <0x74 1 0x75 1>;
 		};
@@ -112,18 +112,25 @@
 			fsl,qman-frame-queues-tx = <0x7c 1 0x7d 1>;
 		};
 
-                /* ethernet@16 declared as MAC-less interface with no "fsl,fman-mac" property.
-                 * USDPAA will seed buffers to this buffer pool and initialize 8 TX Frame
-                 * queues. The ethernet driver will initialize 8 RX default Frame queues.
-                 * On receiving frame at this interface, the ethernet driver will do
-                 * kmap_atomic/kunmap_atomic for that frame. */
-               ethernet@16 {
-                        compatible = "fsl,b4420-dpa-ethernet", "fsl,dpa-ethernet";
-                        fsl,bman-buffer-pools = <&bp16>;
-                        fsl,qman-frame-queues-rx = <4000 8>;
-                        fsl,qman-frame-queues-tx = <4008 8>;
-                        local-mac-address = [00 11 22 33 44 55];
-                };
+		/* ethernet@16 declared as MAC-less interface with no "fsl,fman-mac" property.
+		 * USDPAA will seed buffers to this buffer pool and initialize 8 TX Frame
+		 * queues. The ethernet driver will initialize 8 RX default Frame queues.
+		 * On receiving frame at this interface, the ethernet driver will do
+		 * kmap_atomic/kunmap_atomic for that frame. */
+		ethernet@16 {
+			compatible = "fsl,b4420-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,bman-buffer-pools = <&bp16>;
+			fsl,qman-frame-queues-rx = <4000 8>;
+			fsl,qman-frame-queues-tx = <4008 8>;
+			local-mac-address = [00 11 22 33 44 55];
+		};
+		ethernet@17 {
+			compatible = "fsl,b4420-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,bman-buffer-pools = <&bp16>;
+			fsl,qman-frame-queues-rx = <5000 8>;
+			fsl,qman-frame-queues-tx = <5008 8>;
+			local-mac-address = [00 11 22 33 44 66];
+		};
 
 		dpa-fman0-oh@2 {
 			compatible = "fsl,dpa-oh";
diff --git a/drivers/staging/fsl_dpa_offload/dts/b4420qds-usdpaa.dts b/drivers/staging/fsl_dpa_offload/dts/b4420qds-usdpaa.dts
index 4cb9c2e..0b7b71b 100644
--- a/drivers/staging/fsl_dpa_offload/dts/b4420qds-usdpaa.dts
+++ b/drivers/staging/fsl_dpa_offload/dts/b4420qds-usdpaa.dts
@@ -78,6 +78,13 @@
 		fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
 	};
 
+	bp16: buffer-pool@16 {
+		compatible = "fsl,b4420-bpool", "fsl,bpool";
+		fsl,bpid = <16>;
+		fsl,bpool-ethernet-cfg = <0 2048 0 1728 0 0>;
+		fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
+	};
+
 	fsl,dpaa {
 		ethernet@0 {
 			compatible = "fsl,b4420-dpa-ethernet-init", "fsl,dpa-ethernet-init";
@@ -103,6 +110,27 @@
 			fsl,qman-frame-queues-rx = <0x56 1 0x57 1>;
 			fsl,qman-frame-queues-tx = <0x76 1 0x77 1>;
 		};
+
+		/* ethernet@16 declared as MAC-less interface with no "fsl,fman-mac" property.
+		 * USDPAA will seed buffers to this buffer pool and initialize 8 TX Frame
+		 * queues. The ethernet driver will initialize 8 RX default Frame queues.
+		 * On receiving frame at this interface, the ethernet driver will do
+		 * kmap_atomic/kunmap_atomic for that frame. */
+		ethernet@16 {
+			compatible = "fsl,b4420-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,bman-buffer-pools = <&bp16>;
+			fsl,qman-frame-queues-rx = <4000 8>;
+			fsl,qman-frame-queues-tx = <4008 8>;
+			local-mac-address = [00 11 22 33 44 55];
+		};
+		ethernet@17 {
+			compatible = "fsl,b4420-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,bman-buffer-pools = <&bp16>;
+			fsl,qman-frame-queues-rx = <5000 8>;
+			fsl,qman-frame-queues-tx = <5008 8>;
+			local-mac-address = [00 11 22 33 44 66];
+		};
+
 		dpa-fman0-oh@2 {
 			compatible = "fsl,dpa-oh";
 			/* Define frame queues for the OH port*/
@@ -111,17 +139,17 @@
 			fsl,bman-buffer-pools = <&bp9>;
 			fsl,fman-oh-port = <&fman0_oh2>;
 		};
-                dpa_fman0_oh3: dpa-fman0-oh@3 {
-                        compatible = "fsl,dpa-oh";
-                        fsl,qman-frame-queues-oh = <0x68 1 0x69 1>;
-                        fsl,bman-buffer-pools = <&bp9>;
-                        fsl,fman-oh-port = <&fman0_oh3>;
-                };
-                dpa_fman0_oh4: dpa-fman0-oh@4 {
-                        compatible = "fsl,dpa-oh";
-                        fsl,qman-frame-queues-oh = <0x70 1 0x71 1>;
-                        fsl,bman-buffer-pools = <&bp9>;
-                        fsl,fman-oh-port = <&fman0_oh4>;
-                };
+		dpa_fman0_oh3: dpa-fman0-oh@3 {
+			compatible = "fsl,dpa-oh";
+			fsl,qman-frame-queues-oh = <0x68 1 0x69 1>;
+			fsl,bman-buffer-pools = <&bp9>;
+			fsl,fman-oh-port = <&fman0_oh3>;
+		};
+		dpa_fman0_oh4: dpa-fman0-oh@4 {
+			compatible = "fsl,dpa-oh";
+			fsl,qman-frame-queues-oh = <0x70 1 0x71 1>;
+			fsl,bman-buffer-pools = <&bp9>;
+			fsl,fman-oh-port = <&fman0_oh4>;
+		};
 	};
 };
diff --git a/drivers/staging/fsl_dpa_offload/dts/b4860qds-usdpaa-shared-interfaces.dts b/drivers/staging/fsl_dpa_offload/dts/b4860qds-usdpaa-shared-interfaces.dts
index 7a9e1a0..537d3f2 100644
--- a/drivers/staging/fsl_dpa_offload/dts/b4860qds-usdpaa-shared-interfaces.dts
+++ b/drivers/staging/fsl_dpa_offload/dts/b4860qds-usdpaa-shared-interfaces.dts
@@ -111,11 +111,12 @@
 			fsl,qman-frame-queues-rx = <0x56 1 0x57 1>;
 			fsl,qman-frame-queues-tx = <0x76 1 0x77 1>;
 		};
-
-		/* ethernet@4 will be used as a normal Linux ethernet that
-		 * interfaces to the kernel network stack. All others will be
-		 * dedicated for use by usdpaa */
-
+		ethernet@4 {
+			compatible = "fsl,b4860-dpa-ethernet-init", "fsl,dpa-ethernet-init";
+			fsl,bman-buffer-pools = <&bp16>;
+			fsl,qman-frame-queues-rx = <0x58 1 0x59 1>;
+			fsl,qman-frame-queues-tx = <0x78 1 0x79 1>;
+		};
 		ethernet@5 {
 			compatible = "fsl,b4860-dpa-ethernet-init", "fsl,dpa-ethernet-init";
 			fsl,bman-buffer-pools = <&bp16>;
@@ -123,18 +124,25 @@
 			fsl,qman-frame-queues-tx = <0x7a 1 0x7b 1>;
 		};
 
-                /* ethernet@16 declared as MAC-less interface with no "fsl,fman-mac" property.
-                 * USDPAA will seed buffers to this buffer pool and initialize 8 TX Frame
-                 * queues. The ethernet driver will initialize 8 RX default Frame queues.
-                 * On receiving frame at this interface, the ethernet driver will do
-                 * kmap_atomic/kunmap_atomic for that frame. */
-               ethernet@16 {
-                        compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
-                        fsl,bman-buffer-pools = <&bp16>;
-                        fsl,qman-frame-queues-rx = <4000 8>;
-                        fsl,qman-frame-queues-tx = <4008 8>;
-                        local-mac-address = [00 11 22 33 44 55];
-                };
+		/* ethernet@16 declared as MAC-less interface with no "fsl,fman-mac" property.
+		 * USDPAA will seed buffers to this buffer pool and initialize 8 TX Frame
+		 * queues. The ethernet driver will initialize 8 RX default Frame queues.
+		 * On receiving frame at this interface, the ethernet driver will do
+		 * kmap_atomic/kunmap_atomic for that frame. */
+		ethernet@16 {
+			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,bman-buffer-pools = <&bp16>;
+			fsl,qman-frame-queues-rx = <4000 8>;
+			fsl,qman-frame-queues-tx = <4008 8>;
+			local-mac-address = [00 11 22 33 44 55];
+		};
+		ethernet@17 {
+			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,bman-buffer-pools = <&bp16>;
+			fsl,qman-frame-queues-rx = <5000 8>;
+			fsl,qman-frame-queues-tx = <5008 8>;
+			local-mac-address = [00 11 22 33 44 66];
+		};
 
 		dpa-fman0-oh@2 {
 			compatible = "fsl,dpa-oh";
diff --git a/drivers/staging/fsl_dpa_offload/dts/b4860qds-usdpaa.dts b/drivers/staging/fsl_dpa_offload/dts/b4860qds-usdpaa.dts
index 18d8456..70717b5 100644
--- a/drivers/staging/fsl_dpa_offload/dts/b4860qds-usdpaa.dts
+++ b/drivers/staging/fsl_dpa_offload/dts/b4860qds-usdpaa.dts
@@ -111,11 +111,12 @@
 			fsl,qman-frame-queues-rx = <0x56 1 0x57 1>;
 			fsl,qman-frame-queues-tx = <0x76 1 0x77 1>;
 		};
-
-		/* ethernet@4 will be used as a normal Linux ethernet that
-		 * interfaces to the kernel network stack. All others will be
-		 * dedicated for use by usdpaa */
-
+		ethernet@4 {
+			compatible = "fsl,b4860-dpa-ethernet-init", "fsl,dpa-ethernet-init";
+			fsl,bman-buffer-pools = <&bp7 &bp8 &bp9>;
+			fsl,qman-frame-queues-rx = <0x58 1 0x59 1>;
+			fsl,qman-frame-queues-tx = <0x78 1 0x79 1>;
+		};
 		ethernet@5 {
 			compatible = "fsl,b4860-dpa-ethernet-init", "fsl,dpa-ethernet-init";
 			fsl,bman-buffer-pools = <&bp7 &bp8 &bp9>;
@@ -123,18 +124,25 @@
 			fsl,qman-frame-queues-tx = <0x7a 1 0x7b 1>;
 		};
 
-	       /* ethernet@16 declared as MAC-less interface with no "fsl,fman-mac" property.
-                 * USDPAA will seed buffers to this buffer pool and initialize 8 TX Frame
-                 * queues. The ethernet driver will initialize 8 RX default Frame queues.
-                 * On receiving frame at this interface, the ethernet driver will do
-                 * kmap_atomic/kunmap_atomic for that frame. */
-               ethernet@16 {
-                        compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
-                        fsl,bman-buffer-pools = <&bp16>;
-                        fsl,qman-frame-queues-rx = <4000 8>;
-                        fsl,qman-frame-queues-tx = <4008 8>;
-                        local-mac-address = [00 11 22 33 44 55];
-                };
+		/* ethernet@16 declared as MAC-less interface with no "fsl,fman-mac" property.
+		 * USDPAA will seed buffers to this buffer pool and initialize 8 TX Frame
+		 * queues. The ethernet driver will initialize 8 RX default Frame queues.
+		 * On receiving frame at this interface, the ethernet driver will do
+		 * kmap_atomic/kunmap_atomic for that frame. */
+		ethernet@16 {
+			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,bman-buffer-pools = <&bp16>;
+			fsl,qman-frame-queues-rx = <4000 8>;
+			fsl,qman-frame-queues-tx = <4008 8>;
+			local-mac-address = [00 11 22 33 44 55];
+		};
+		ethernet@17 {
+			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,bman-buffer-pools = <&bp16>;
+			fsl,qman-frame-queues-rx = <5000 8>;
+			fsl,qman-frame-queues-tx = <5008 8>;
+			local-mac-address = [00 11 22 33 44 66];
+		};
 
 		dpa-fman0-oh@2 {
 			compatible = "fsl,dpa-oh";
diff --git a/drivers/staging/fsl_dpa_offload/dts/p4080ds-usdpaa-shared-interfaces.dts b/drivers/staging/fsl_dpa_offload/dts/p4080ds-usdpaa-shared-interfaces.dts
index 038e055..574f733 100644
--- a/drivers/staging/fsl_dpa_offload/dts/p4080ds-usdpaa-shared-interfaces.dts
+++ b/drivers/staging/fsl_dpa_offload/dts/p4080ds-usdpaa-shared-interfaces.dts
@@ -62,17 +62,17 @@
 		fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
 	};
 	bp16: buffer-pool@16 {
-                        compatible = "fsl,p4080-bpool", "fsl,bpool";
-                        fsl,bpid = <16>;
-                        fsl,bpool-ethernet-cfg = <0 2048 0 1728 0 0>;
-                        fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
-       };
+		compatible = "fsl,p4080-bpool", "fsl,bpool";
+		fsl,bpid = <16>;
+		fsl,bpool-ethernet-cfg = <0 2048 0 1728 0 0>;
+		fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
+	};
 	bp17: buffer-pool@17 {
-                        compatible = "fsl,p4080-bpool", "fsl,bpool";
-                        fsl,bpid = <17>;
-                        fsl,bpool-ethernet-cfg = <0 2048 0 1728 0 0>;
-                        fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
-       };
+		compatible = "fsl,p4080-bpool", "fsl,bpool";
+		fsl,bpid = <17>;
+		fsl,bpool-ethernet-cfg = <0 2048 0 1728 0 0>;
+		fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
+	};
 	fsl,dpaa {
 		ethernet@0 {
 			compatible = "fsl,p4080-dpa-ethernet-init", "fsl,dpa-ethernet-init";
@@ -105,13 +105,13 @@
 		};
 		ethernet@5 {
 			compatible = "fsl,p4080-dpa-ethernet-init", "fsl,dpa-ethernet-init";
-			fsl,bman-buffer-pools = <&bp7 &bp8 &bp9>;
+			fsl,bman-buffer-pools = <&bp16>;
 			fsl,qman-frame-queues-rx = <0x5c 1 0x5d 1>;
 			fsl,qman-frame-queues-tx = <0x7c 1 0x7d 1>;
 		};
 		ethernet@6 {
 			compatible = "fsl,p4080-dpa-ethernet-init", "fsl,dpa-ethernet-init";
-			fsl,bman-buffer-pools = <&bp7 &bp8 &bp9>;
+			fsl,bman-buffer-pools = <&bp16>;
 			fsl,qman-frame-queues-rx = <0x5e 1 0x5f 1>;
 			fsl,qman-frame-queues-tx = <0x7e 1 0x7f 1>;
 		};
@@ -150,6 +150,13 @@
 			fsl,qman-frame-queues-tx = <4008 8>;
 			local-mac-address = [00 11 22 33 44 55];
 		};
+		ethernet@17 {
+			compatible = "fsl,p4080-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,bman-buffer-pools = <&bp16>;
+			fsl,qman-frame-queues-rx = <5000 8>;
+			fsl,qman-frame-queues-tx = <5008 8>;
+			local-mac-address = [00 11 22 33 44 66];
+		};
 		dpa_fman1_oh1: dpa-fman1-oh@1 {
 			compatible = "fsl,dpa-oh";
 			fsl,qman-frame-queues-oh = <0x64 1 0x65 1>;
diff --git a/drivers/staging/fsl_dpa_offload/dts/p4080ds-usdpaa.dts b/drivers/staging/fsl_dpa_offload/dts/p4080ds-usdpaa.dts
index da0ca0f..2e69bbc 100644
--- a/drivers/staging/fsl_dpa_offload/dts/p4080ds-usdpaa.dts
+++ b/drivers/staging/fsl_dpa_offload/dts/p4080ds-usdpaa.dts
@@ -62,6 +62,13 @@
 		fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
 	};
 
+	bp16: buffer-pool@16 {
+		compatible = "fsl,p4080-bpool", "fsl,bpool";
+		fsl,bpid = <16>;
+		fsl,bpool-ethernet-cfg = <0 2048 0 1728 0 0>;
+		fsl,bpool-thresholds = <0x100 0x300 0x0 0x0>;
+	};
+
 	fsl,dpaa {
 		ethernet@0 {
 			compatible = "fsl,p4080-dpa-ethernet-init", "fsl,dpa-ethernet-init";
@@ -122,6 +129,27 @@
 			fsl,qman-frame-queues-rx = <0x66 1 0x67 1>;
 			fsl,qman-frame-queues-tx = <0x86 1 0x87 1>;
 		};
+
+		/* ethernet@16 declared as MAC-less interface with no "fsl,fman-mac" property.
+		 * USDPAA will seed buffers to this buffer pool and initialize 8 TX Frame
+		 * queues. The ethernet driver will initialize 8 RX default Frame queues.
+		 * On receiving frame at this interface, the ethernet driver will do
+		 * kmap_atomic/kunmap_atomic for that frame. */
+		ethernet@16 {
+			compatible = "fsl,p4080-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,bman-buffer-pools = <&bp16>;
+			fsl,qman-frame-queues-rx = <4000 8>;
+			fsl,qman-frame-queues-tx = <4008 8>;
+			local-mac-address = [00 11 22 33 44 55];
+		};
+		ethernet@17 {
+			compatible = "fsl,p4080-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,bman-buffer-pools = <&bp16>;
+			fsl,qman-frame-queues-rx = <5000 8>;
+			fsl,qman-frame-queues-tx = <5008 8>;
+			local-mac-address = [00 11 22 33 44 66];
+		};
+
 		dpa_fman1_oh1: dpa-fman1-oh@1 {
 			compatible = "fsl,dpa-oh";
 			fsl,qman-frame-queues-oh = <0x64 1 0x65 1>;
-- 
1.9.1

