From 688bed6732b556199f8036822282a6a4508ae8d3 Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Thu, 15 Jan 2015 18:45:24 +0200
Subject: [PATCH 874/987] dpaa_eth: remove Rx pool channel on unload

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
Change-Id: I2ca632118579b34a2c88ced0abb274cf20712976
Reviewed-on: http://git.am.freescale.net:8181/28552
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Marian Cristian Rotariu <marian.rotariu@freescale.com>
[Yang: Original patch taken from
QorIQ-SDK-V1.8-SOURCE-20150619-yocto.iso]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c        | 5 +++++
 drivers/net/ethernet/freescale/dpa/dpaa_eth_common.c | 6 ++++++
 drivers/net/ethernet/freescale/dpa/dpaa_eth_common.h | 1 +
 3 files changed, 12 insertions(+)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index 6694eec..35a491d 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -1173,6 +1173,11 @@ static void __exit __cold dpa_unload(void)
 	dpa_debugfs_module_exit();
 #endif /* CONFIG_FSL_DPAA_ETH_DEBUGFS */
 
+	/* Only one channel is used and needs to be relased after all
+	 * interfaces are removed
+	 */
+	dpa_release_channel();
+
 	pr_debug(KBUILD_MODNAME ": %s:%s() ->\n",
 		KBUILD_BASENAME".c", __func__);
 }
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.c
index 51c0a01..81a240d 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.c
@@ -1030,6 +1030,12 @@ int dpa_get_channel(void)
 }
 EXPORT_SYMBOL(dpa_get_channel);
 
+void dpa_release_channel(void)
+{
+	qman_release_pool(rx_pool_channel);
+}
+EXPORT_SYMBOL(dpa_release_channel);
+
 int dpaa_eth_add_channel(void *__arg)
 {
 	const cpumask_t *cpus = qman_affine_cpus();
diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.h b/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.h
index 3dbc3ea..40c9b28 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.h
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_common.h
@@ -181,6 +181,7 @@ int dpa_fq_probe_mac(struct device *dev, struct list_head *list,
 		     bool tx_conf_fqs_per_core,
 		     enum port_type ptype);
 int dpa_get_channel(void);
+void dpa_release_channel(void);
 int dpaa_eth_add_channel(void *__arg);
 int dpaa_eth_cgr_init(struct dpa_priv_s *priv);
 void dpa_fq_setup(struct dpa_priv_s *priv, const struct dpa_fq_cbs_t *fq_cbs,
-- 
1.9.1

