From fdb7350adc4212128cae85842f3c8c17687ea4b0 Mon Sep 17 00:00:00 2001
From: Emil Medve <Emilian.Medve@Freescale.com>
Date: Mon, 6 Jan 2014 14:39:38 -0600
Subject: [PATCH 469/987] fsl_qbman: Sync with the upstream PAMU driver

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

Signed-off-by: Emil Medve <Emilian.Medve@Freescale.com>
Change-Id: I034a28ca135f6e07a2419c83db1b2e63be37763f
Reviewed-on: http://git.am.freescale.net:8181/7708
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Emilian Medve <Emilian.Medve@freescale.com>
---
 drivers/staging/fsl_qbman/qman_driver.c  | 10 ++++------
 drivers/staging/fsl_qbman/qman_private.h |  1 +
 2 files changed, 5 insertions(+), 6 deletions(-)

diff --git a/drivers/staging/fsl_qbman/qman_driver.c b/drivers/staging/fsl_qbman/qman_driver.c
index 7768ca0..9e63b3e 100644
--- a/drivers/staging/fsl_qbman/qman_driver.c
+++ b/drivers/staging/fsl_qbman/qman_driver.c
@@ -479,7 +479,7 @@ static void portal_set_cpu(struct qm_portal_config *pcfg, int cpu)
 	int ret;
 	int window_count = 1;
 	struct iommu_domain_geometry geom_attr;
-	struct iommu_stash_attribute stash_attr;
+	struct pamu_stash_attribute stash_attr;
 
 	pcfg->iommu_domain = iommu_domain_alloc(&platform_bus_type);
 	if (!pcfg->iommu_domain) {
@@ -506,8 +506,7 @@ static void portal_set_cpu(struct qm_portal_config *pcfg, int cpu)
 		goto _iommu_domain_free;
 	}
 	stash_attr.cpu = cpu;
-	stash_attr.cache = IOMMU_ATTR_CACHE_L1;
-	stash_attr.window = ~(u32)0;
+	stash_attr.cache = PAMU_ATTR_CACHE_L1;
 	ret = iommu_domain_set_attr(pcfg->iommu_domain,
 				    DOMAIN_ATTR_FSL_PAMU_STASH,
 				    &stash_attr);
@@ -644,13 +643,12 @@ __setup("qportals=", parse_qportals);
 static void qman_portal_update_sdest(const struct qm_portal_config *pcfg,
 							unsigned int cpu)
 {
-	struct iommu_stash_attribute stash_attr;
+	struct pamu_stash_attribute stash_attr;
 	int ret;
 
 	if (pcfg->iommu_domain) {
 		stash_attr.cpu = cpu;
-		stash_attr.cache = IOMMU_ATTR_CACHE_L1;
-		stash_attr.window = ~(u32)0;
+		stash_attr.cache = PAMU_ATTR_CACHE_L1;
 		ret = iommu_domain_set_attr(pcfg->iommu_domain,
 				DOMAIN_ATTR_FSL_PAMU_STASH, &stash_attr);
 		if (ret < 0) {
diff --git a/drivers/staging/fsl_qbman/qman_private.h b/drivers/staging/fsl_qbman/qman_private.h
index 465c791..67422d5 100644
--- a/drivers/staging/fsl_qbman/qman_private.h
+++ b/drivers/staging/fsl_qbman/qman_private.h
@@ -32,6 +32,7 @@
 #include "dpa_sys.h"
 #include <linux/fsl_qman.h>
 #include <linux/iommu.h>
+#include <asm/fsl_pamu_stash.h>
 
 #if !defined(CONFIG_FSL_QMAN_FQ_LOOKUP) && defined(CONFIG_PPC64)
 #error "_PPC64 requires _FSL_QMAN_FQ_LOOKUP"
-- 
1.9.1

