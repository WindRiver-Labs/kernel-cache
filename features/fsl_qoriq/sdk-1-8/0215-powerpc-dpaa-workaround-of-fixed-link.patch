From c20ea6693daa3bc5500f729f7b99bf585a1012e2 Mon Sep 17 00:00:00 2001
From: Shaohui Xie <Shaohui.Xie@freescale.com>
Date: Thu, 23 May 2013 09:25:29 +0800
Subject: [PATCH 215/987] powerpc/dpaa: workaround of fixed-link

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

fixed-link does not work in 3.8.x, to make XFI work which has no PHY,
it's actually not necessary to use fixed-link, otherwise there will be
more work and code changes to make fixed-link work in 3.8.x. For now, if
driver does not find the phy_node of MAC, just set the mac_dev->phy_dev
= NULL and return 0; we can get XFI work and this won't break other
ethernet ports. It's only for SDK1.4, if we decide to bring fixed-link
back, it can be done after SDK1.4.

Signed-off-by: Shaohui Xie <Shaohui.Xie@freescale.com>
Change-Id: I930edbe76f5d739f7d6565d3a7f8a3aabf224db0
Reviewed-on: http://git.am.freescale.net:8181/2797
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Zang Tiefei-R61911 <tie-fei.zang@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
---
 drivers/net/ethernet/freescale/dpa/mac-api.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/mac-api.c b/drivers/net/ethernet/freescale/dpa/mac-api.c
index b43687f..501b082 100644
--- a/drivers/net/ethernet/freescale/dpa/mac-api.c
+++ b/drivers/net/ethernet/freescale/dpa/mac-api.c
@@ -529,10 +529,10 @@ static int memac_init_phy(struct net_device *net_dev)
 	mac_dev = priv->mac_dev;
 
 	if (macdev2enetinterface(mac_dev) == e_ENET_MODE_XGMII_10000) {
-		if (!mac_dev->phy_node)
-			phy_dev = phy_attach(net_dev, mac_dev->fixed_bus_id, 0,
-				mac_dev->phy_if);
-		else
+		if (!mac_dev->phy_node) {
+			mac_dev->phy_dev = NULL;
+			return 0;
+		} else
 			phy_dev = of_phy_attach(net_dev, mac_dev->phy_node, 0,
 				mac_dev->phy_if);
 	} else {
-- 
1.9.1

