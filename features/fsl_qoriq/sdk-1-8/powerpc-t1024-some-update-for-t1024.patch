From c1630f195ce78dcbec90873534d5803f5408f166 Mon Sep 17 00:00:00 2001
From: Shengzhou Liu <Shengzhou.Liu@freescale.com>
Date: Mon, 29 Sep 2014 17:22:43 +0800
Subject: [PATCH 42/57] powerpc/t1024: some update for t1024

- enable mixed mode of MPIC for deep sleep
- add deep sleep support for t1024
- add SDXC support for T1024QDS
- add TDM node in dts for Maxim DS26522 Riser card.

Signed-off-by: Wang Dongsheng <dongsheng.wang@freescale.com>
Signed-off-by: Xie Xiaobo <X.Xie@freescale.com>
Signed-off-by: Zhao Qiang <B45475@freescale.com>
Signed-off-by: Shengzhou Liu <Shengzhou.Liu@freescale.com>
Change-Id: I9cb45b4a02814a4f4cd0a320510361c424545d44
Reviewed-on: http://git.am.freescale.net:8181/21426
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
[Original patch taken from QorIQ-SDK-V1.8-20150619-yocto.]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/powerpc/boot/dts/fsl/t1023si-post.dtsi   |    1 +
 arch/powerpc/boot/dts/t1024rdb.dts            |   12 ++++++++++++
 arch/powerpc/boot/dts/t102xqds.dtsi           |   12 ++++++++++++
 arch/powerpc/platforms/85xx/corenet_generic.c |    3 ++-
 arch/powerpc/platforms/85xx/qoriq_pm.c        |   12 +++++++++++-
 drivers/mmc/host/sdhci-pltfm.c                |    1 +
 drivers/mmc/host/sdhci.c                      |    3 +++
 7 files changed, 42 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/boot/dts/fsl/t1023si-post.dtsi b/arch/powerpc/boot/dts/fsl/t1023si-post.dtsi
index 0bd63c4..ac86748 100644
--- a/arch/powerpc/boot/dts/fsl/t1023si-post.dtsi
+++ b/arch/powerpc/boot/dts/fsl/t1023si-post.dtsi
@@ -416,6 +416,7 @@
 		fsl,iommu-parent = <&pamu0>;
 		fsl,liodn-reg = <&guts 0x530>; /* eSDHCLIODNR */
 		sdhci,auto-cmd12;
+		no-1-8-v;
 		sleep = <&rcpm 0x00000080>;
 	};
 /include/ "qoriq-i2c-0.dtsi"
diff --git a/arch/powerpc/boot/dts/t1024rdb.dts b/arch/powerpc/boot/dts/t1024rdb.dts
index 2b463e8..8ed7f11 100644
--- a/arch/powerpc/boot/dts/t1024rdb.dts
+++ b/arch/powerpc/boot/dts/t1024rdb.dts
@@ -101,6 +101,18 @@
 				reg = <0>;
 				spi-max-frequency = <10000000>; /* input clock */
 			};
+
+			slic@1 {
+				compatible = "maxim,ds26522";
+				reg = <1>;
+				spi-max-frequency = <2000000>;
+			};
+
+			slic@2 {
+				compatible = "maxim,ds26522";
+				reg = <2>;
+				spi-max-frequency = <2000000>;
+			};
 		};
 
 		i2c@118000 {
diff --git a/arch/powerpc/boot/dts/t102xqds.dtsi b/arch/powerpc/boot/dts/t102xqds.dtsi
index 1de612c..03882ca 100644
--- a/arch/powerpc/boot/dts/t102xqds.dtsi
+++ b/arch/powerpc/boot/dts/t102xqds.dtsi
@@ -232,6 +232,18 @@
 				reg = <2>;
 				spi-max-frequency = <10000000>; /* input clock */
 			};
+
+			slic@2 {
+				compatible = "maxim,ds26522";
+				reg = <2>;
+				spi-max-frequency = <2000000>;
+			};
+
+			slic@3 {
+				compatible = "maxim,ds26522";
+				reg = <3>;
+				spi-max-frequency = <2000000>;
+			};
 		};
 
 		i2c@118000 {
diff --git a/arch/powerpc/platforms/85xx/corenet_generic.c b/arch/powerpc/platforms/85xx/corenet_generic.c
index 930af1d..e2f2eeb 100644
--- a/arch/powerpc/platforms/85xx/corenet_generic.c
+++ b/arch/powerpc/platforms/85xx/corenet_generic.c
@@ -55,7 +55,8 @@ void __init corenet_gen_pic_init(void)
 	 * to enable the mixed mode of MPIC.
 	 */
 	if ((SVR_SOC_VER(svr) == SVR_T1040) ||
-	    (SVR_SOC_VER(svr) == SVR_T1042)) {
+	    (SVR_SOC_VER(svr) == SVR_T1042) ||
+	    (SVR_SOC_VER(svr) == SVR_T1024)) {
 		ppc_md.get_irq = mpic_get_irq;
 	}
 
diff --git a/arch/powerpc/platforms/85xx/qoriq_pm.c b/arch/powerpc/platforms/85xx/qoriq_pm.c
index 155dc28..f1ec1bd 100644
--- a/arch/powerpc/platforms/85xx/qoriq_pm.c
+++ b/arch/powerpc/platforms/85xx/qoriq_pm.c
@@ -154,6 +154,16 @@ static const struct platform_suspend_ops qoriq_suspend_ops = {
 	.end = qoriq_suspend_end,
 };
 
+static const struct of_device_id deepsleep_matches[] = {
+	{
+		.compatible = "fsl,t1040-rcpm",
+	},
+	{
+		.compatible = "fsl,t1024-rcpm",
+	},
+	{},
+};
+
 static int __init qoriq_suspend_init(void)
 {
 	struct device_node *np;
@@ -165,7 +175,7 @@ static int __init qoriq_suspend_init(void)
 	if (np)
 		sleep_pm_state = PLAT_PM_LPM20;
 
-	np = of_find_compatible_node(NULL, NULL, "fsl,t1040-rcpm");
+	np = of_find_matching_node_and_match(NULL, deepsleep_matches, NULL);
 	if (np) {
 		fsl_enter_deepsleep = fsl_enter_epu_deepsleep;
 		sleep_modes |= FSL_DEEP_SLEEP;
diff --git a/drivers/mmc/host/sdhci-pltfm.c b/drivers/mmc/host/sdhci-pltfm.c
index f785e61..23ea68d 100644
--- a/drivers/mmc/host/sdhci-pltfm.c
+++ b/drivers/mmc/host/sdhci-pltfm.c
@@ -109,6 +109,7 @@ void sdhci_get_of_property(struct platform_device *pdev)
 
 	if (of_device_is_compatible(np, "fsl,p5020-esdhc") ||
 	    of_device_is_compatible(np, "fsl,p5040-esdhc") ||
+	    of_device_is_compatible(np, "fsl,t1024-esdhc") ||
 	    of_device_is_compatible(np, "fsl,t1040-esdhc"))
 		host->quirks2 |= SDHCI_QUIRK2_LONG_TIME_CMD_COMPLETE_IRQ;
 
diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.c
index 12a40f7..4f834bc 100644
--- a/drivers/mmc/host/sdhci.c
+++ b/drivers/mmc/host/sdhci.c
@@ -2958,6 +2958,9 @@ int sdhci_add_host(struct sdhci_host *host)
 	if (host->quirks2 & SDHCI_QUIRK2_CIRCUIT_SUPPORT_VS33)
 		caps[0] = caps[0] | SDHCI_CAN_VDD_330;
 
+	if (host->quirks2 & SDHCI_QUIRK2_NO_1_8_V)
+		caps[0] &= ~(SDHCI_CAN_VDD_300 | SDHCI_CAN_VDD_180);
+
 	if (host->quirks & SDHCI_QUIRK_FORCE_DMA)
 		host->flags |= SDHCI_USE_SDMA;
 	else if (!(caps[0] & SDHCI_CAN_DO_SDMA))
-- 
1.7.5.4

