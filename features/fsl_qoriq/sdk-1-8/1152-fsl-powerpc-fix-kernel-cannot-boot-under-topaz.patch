From 93e73081831bf75dfdffdc4be78e4ec1a16d552e Mon Sep 17 00:00:00 2001
From: "Lu.Jiang" <lu.jiang@windriver.com>
Date: Thu, 11 Sep 2014 11:05:47 +0800
Subject: [PATCH 1152/1207] fsl/powerpc: fix kernel cannot boot under topaz

[Original patch taken from QorIQ-SDK-V1.6-SOURCE-20140619-yocto.iso]

when we have embedded hypervisor functionality, the MMUCFG[LPIDSIZE]
is not zero, this is issue will occur.

asm functions (setup_altivec_idle + setup_pw20_idle) that overwrite
register r4. Register r4 holds the second parameter of the
setup___setup_cpu_e* functions and is a pointer to the cpu spec features.
Under baremetal the param is not used so the problem doesn't show up,
but under hypervisor it is used.

Signed-off-by: Wang Dongsheng <dongsheng.wang@freescale.com>
Tested-by: Laurentiu Tudor <Laurentiu.Tudor@freescale.com>
Change-Id: I0fe5f7814ff0a77988f3b8540933a522f3217679
Reviewed-on: http://git.am.freescale.net:8181/4789
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Tudor Laurentiu-B10716 <Laurentiu.Tudor@freescale.com>
Reviewed-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
Signed-off-by: Lu.Jiang <lu.jiang@windriver.com>
---
 arch/powerpc/kernel/cpu_setup_fsl_booke.S | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/arch/powerpc/kernel/cpu_setup_fsl_booke.S b/arch/powerpc/kernel/cpu_setup_fsl_booke.S
index bbadf22..a110b3f 100644
--- a/arch/powerpc/kernel/cpu_setup_fsl_booke.S
+++ b/arch/powerpc/kernel/cpu_setup_fsl_booke.S
@@ -59,15 +59,15 @@ _GLOBAL(has_pw20_altivec_idle)
 
 	/* PW20 & AltiVec idle feature only exists for E6500 */
 	mfspr	r0, SPRN_PVR
-	rlwinm	r4, r0, 16, 16, 31
+	rlwinm	r11, r0, 16, 16, 31
 	lis	r12, 0
 	ori	r12, r12, PVR_VER_E6500@l
-	cmpw	r4, r12
+	cmpw	r11, r12
 	bne	2f
 
 	/* Fix erratum, e6500 rev1 does not support PW20 & AltiVec idle */
-	rlwinm	r4, r0, 0, 16, 31
-	cmpwi	r4, 0x20
+	rlwinm	r11, r0, 0, 16, 31
+	cmpwi	r11, 0x20
 	blt	2f
 	li	r3, 1
 2:
-- 
2.0.2

