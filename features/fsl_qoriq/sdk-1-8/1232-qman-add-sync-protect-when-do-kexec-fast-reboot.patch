From af59cadff20f6c2df53358f73cc21662764964dd Mon Sep 17 00:00:00 2001
From: "yadi.hu@windriver.com" <yadi.hu@windriver.com>
Date: Wed, 9 Sep 2015 14:26:33 +0800
Subject: [PATCH 1232/1233] qman: add sync protect when do kexec fast reboot

Signed-off-by: Hu <yadi.hu@windriver.com>
---
 drivers/staging/fsl_qbman/qman_config.c |  3 +++
 drivers/staging/fsl_qbman/qman_high.c   | 14 ++++++++++++++
 include/linux/fsl_qman.h                |  6 ++++++
 3 files changed, 23 insertions(+)

diff --git a/drivers/staging/fsl_qbman/qman_config.c b/drivers/staging/fsl_qbman/qman_config.c
index 1ebbbb8..5c83836 100644
--- a/drivers/staging/fsl_qbman/qman_config.c
+++ b/drivers/staging/fsl_qbman/qman_config.c
@@ -1142,9 +1142,12 @@ void of_fsl_qman_shutdown(struct platform_device *ofdev)
 {
 	int cpu;
 	struct qman_portal *p;
+	unsigned long irqflags __maybe_unused; 
 	for_each_online_cpu(cpu) {
 		p = per_cpu_affine_portal(cpu);
+		qman_portal_lock(p,irqflags);
 		qman_static_dequeue_del_ex(p, ~0);
+		qman_portal_unlock(p,irqflags);
 	}
 	return;
 };
diff --git a/drivers/staging/fsl_qbman/qman_high.c b/drivers/staging/fsl_qbman/qman_high.c
index 5d8243d..3effe68 100644
--- a/drivers/staging/fsl_qbman/qman_high.c
+++ b/drivers/staging/fsl_qbman/qman_high.c
@@ -417,6 +417,20 @@ static int qm_drain_dqrr(struct qm_portal *p)
 	qm_isr_status_clear(p, 0xffffffff);
 	return 0;
 }
+
+int qman_portal_lock(struct qman_portal *p,unsigned long irqflags)
+{
+    spin_lock_irqsave(&p->cgr_lock, irqflags);
+    return 0;
+
+}
+
+int qman_portal_unlock(struct qman_portal *p,unsigned long irqflags)
+{
+    spin_unlock_irqrestore(&p->cgr_lock, irqflags);
+    return 0;
+} 
+
 #else
 static inline int qm_drain_dqrr(struct qm_portal *p) { return 1; }
 #endif
diff --git a/include/linux/fsl_qman.h b/include/linux/fsl_qman.h
index e3d0add7..7e0103b 100644
--- a/include/linux/fsl_qman.h
+++ b/include/linux/fsl_qman.h
@@ -1774,6 +1774,12 @@ void qman_static_dequeue_del_ex(struct qman_portal *p, u32 pools);
  */
 struct qman_portal *per_cpu_affine_portal(int cpu);
 
+#if defined(CONFIG_KEXEC)
+
+int qman_portal_lock(struct qman_portal *p,unsigned long irqflags);
+int qman_portal_unlock(struct qman_portal *p,unsigned long irqflags) ;
+#endif
+
 /**
  * qman_static_dequeue_get - return the portal's current SDQCR
  *
-- 
2.0.2

