From cce80905a5832db5f6fac5678529c8879b5b6ce2 Mon Sep 17 00:00:00 2001
From: Mandy Lavi <mandy.lavi@freescale.com>
Date: Thu, 23 Apr 2015 00:19:14 +0900
Subject: [PATCH 958/987] fmd: clear parser start offset for all cases

Change-Id: I408df80410abae8d39ed73299b4e5df2e76cc8ad
Signed-off-by: Mandy Lavi <mandy.lavi@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/35430
Reviewed-by: Liron Himi <Liron.Himi@freescale.com>
Reviewed-by: Honghua Yin <Hong-Hua.Yin@freescale.com>
Tested-by: Honghua Yin <Hong-Hua.Yin@freescale.com>
[Yang: Original patch taken from
QorIQ-SDK-V1.8-SOURCE-20150619-yocto.iso]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/freescale/fman/Peripherals/FM/Port/fm_port.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fman/Peripherals/FM/Port/fm_port.c b/drivers/net/ethernet/freescale/fman/Peripherals/FM/Port/fm_port.c
index 9b4f1ba..cdbe72c 100644
--- a/drivers/net/ethernet/freescale/fman/Peripherals/FM/Port/fm_port.c
+++ b/drivers/net/ethernet/freescale/fman/Peripherals/FM/Port/fm_port.c
@@ -1603,6 +1603,8 @@ static t_Error SetPcd(t_FmPort *p_FmPort, t_FmPortPcdParams *p_PcdParams)
                          (PRS_HDR_SW_PRS_EN | OFFLOAD_SW_PATCH_IPv6_LABEL));
         }
 
+        WRITE_UINT32(*p_BmiPrsStartOffset, 0);
+
         p_FmPort->privateInfo = 0;
     }
 
@@ -1672,13 +1674,13 @@ static t_Error DeletePcd(t_FmPort *p_FmPort)
         RETURN_ERROR(MAJOR, E_INVALID_OPERATION,
                      ("port has to be detached previousely"));
 
+    WRITE_UINT32(*p_BmiPrsStartOffset, 0);
+
     /* "cut" PCD out of the port's flow - go to BMI */
     /* WRITE_UINT32(*p_BmiNia, (p_FmPort->savedBmiNia & BMI_RFNE_FDCS_MASK) | (NIA_ENG_BMI | NIA_BMI_AC_ENQ_FRAME)); */
 
     if (p_FmPort->pcdEngines & FM_PCD_PRS)
     {
-        WRITE_UINT32(*p_BmiPrsStartOffset, 0);
-
         /* stop parser */
         WRITE_UINT32(p_FmPort->p_FmPortPrsRegs->pcac, PRS_CAC_STOP);
         /* wait for parser to be in idle state */
-- 
1.9.1

