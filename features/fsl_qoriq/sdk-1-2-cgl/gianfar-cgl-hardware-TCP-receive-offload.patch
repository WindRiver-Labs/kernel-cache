From 075108eb1e7f6ee653f34a785dbddc13953c4300 Mon Sep 17 00:00:00 2001
From: Claudiu Manoil <claudiu.manoil@freescale.com>
Date: Mon, 2 Apr 2012 16:47:28 +0000
Subject: [PATCH] gianfar/cgl: hardware TCP receive offload

This hunk comes from the commit:
[
Subject: gianfar: hardware TCP receive offload

Insert TCP stream rules into eTSEC filer table for offloading TCP receive.
eTSEC will accelerate TCP receive processing for a given stream as soon as
its data volume exceeds 1MB.

Signed-off-by: Jiajun Wu <b06378@freescale.com>
Signed-off-by: Claudiu Manoil <claudiu.manoil@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso image. Just some minor context
mods in order to port to 3.4 kernel.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
]

Signed-off-by: Michel Thebeau <michel.thebeau@windriver.com>
---
 include/linux/skbuff.h |    3 +++
 net/ipv4/tcp_ipv4.c    |    6 ++++++
 2 files changed, 9 insertions(+)

diff --git a/include/linux/skbuff.h b/include/linux/skbuff.h
index ed8aed1..2598de4 100644
--- a/include/linux/skbuff.h
+++ b/include/linux/skbuff.h
@@ -394,6 +394,9 @@ struct sk_buff {
 
 	struct sock		*sk;
 	struct net_device	*dev;
+#ifdef CONFIG_GFAR_HW_TCP_RECEIVE_OFFLOAD
+	struct net_device	*gfar_dev;
+#endif
 
 #ifdef CONFIG_BONDING_DEVINFO
 	struct net_device	*real_dev;
diff --git a/net/ipv4/tcp_ipv4.c b/net/ipv4/tcp_ipv4.c
index 8118f18..9823134 100644
--- a/net/ipv4/tcp_ipv4.c
+++ b/net/ipv4/tcp_ipv4.c
@@ -1743,6 +1743,12 @@ int tcp_v4_rcv(struct sk_buff *skb)
 #endif
 		goto no_tcp_socket;
 	}
+
+#ifdef CONFIG_GFAR_HW_TCP_RECEIVE_OFFLOAD
+	if (th->syn)
+		sk->init_seq = ntohl(th->seq);
+#endif
+
 process:
 	if (sk->sk_state == TCP_TIME_WAIT) {
 #ifdef CONFIG_GRKERNSEC_BLACKHOLE
-- 
1.7.9.7

