From 5a4da4f024d2deb23cb65a5067836196d5142a00 Mon Sep 17 00:00:00 2001
From: Bharat Bhushan <Bharat.Bhushan@freescale.com>
Date: Thu, 26 Nov 2015 20:58:59 +0530
Subject: [PATCH 0850/1429] vfio fsl-mc: Meaningful names for fsl-mc device
 handler

With this change we will find unique meaningful names in
/proc/interrupts

Signed-off-by: Bharat Bhushan <Bharat.Bhushan@freescale.com>
[Original patch taken from QorIQ-SDK-V2.0-20160527-yocto]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/vfio/fsl-mc/vfio_fsl_mc_intr.c    |    8 +++++++-
 drivers/vfio/fsl-mc/vfio_fsl_mc_private.h |    1 +
 2 files changed, 8 insertions(+), 1 deletions(-)

diff --git a/drivers/vfio/fsl-mc/vfio_fsl_mc_intr.c b/drivers/vfio/fsl-mc/vfio_fsl_mc_intr.c
index e33d205..d430cd7 100644
--- a/drivers/vfio/fsl-mc/vfio_fsl_mc_intr.c
+++ b/drivers/vfio/fsl-mc/vfio_fsl_mc_intr.c
@@ -324,6 +324,7 @@ int vfio_fsl_mc_configure_irq(struct vfio_fsl_mc_device *vdev,
 	struct fsl_mc_device *mc_dev = vdev->mc_dev;
 	struct fsl_mc_device_irq *irq = mc_dev->irqs[irq_index];
 	struct vfio_fsl_mc_irq *mc_irq = &vdev->mc_irqs[irq_index];
+	struct device *dev = &mc_dev->dev;
 
 	if (WARN_ON(!mc_irq->irq_initialized))
 		return -EOPNOTSUPP;
@@ -331,11 +332,15 @@ int vfio_fsl_mc_configure_irq(struct vfio_fsl_mc_device *vdev,
 	if (WARN_ON(mc_irq->irq_configured))
 		return -EINVAL;
 
+	mc_irq->name = kasprintf(GFP_KERNEL, "%s-%s-%d", "vfio-fsl-mc",
+				 dev_name(dev), irq->irq_number);
+
 	error = request_irq(irq->irq_number, vfio_fsl_mc_irq_handler,
-			    0, "VFIO Handler", vdev);
+			    0, mc_irq->name, vdev);
 	if (error < 0) {
 		dev_err(&mc_dev->dev,
 			"IRQ registration fails with error: %d\n", error);
+		kfree(mc_irq->name);
 		return error;
 	}
 
@@ -353,6 +358,7 @@ static void vfio_fsl_mc_unconfigure_irq(struct vfio_fsl_mc_device *vdev,
 	if (!vdev->mc_irqs[irq_index].irq_configured)
 		return;
 
+	kfree(vdev->mc_irqs[irq_index].name);
 	free_irq(irq->irq_number, vdev);
 	vdev->mc_irqs[irq_index].irq_configured = false;
 }
diff --git a/drivers/vfio/fsl-mc/vfio_fsl_mc_private.h b/drivers/vfio/fsl-mc/vfio_fsl_mc_private.h
index df83f36..001467f 100644
--- a/drivers/vfio/fsl-mc/vfio_fsl_mc_private.h
+++ b/drivers/vfio/fsl-mc/vfio_fsl_mc_private.h
@@ -19,6 +19,7 @@ struct vfio_fsl_mc_irq {
 	unsigned int		hw_irq_num;
 	u32			flags;
 	u32			count;
+	char			*name;
 	bool			irq_initialized;
 	bool			irq_configured;
 };
-- 
1.7.5.4

