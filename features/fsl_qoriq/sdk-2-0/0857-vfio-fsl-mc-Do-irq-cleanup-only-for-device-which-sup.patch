From 7acef4fe4736e2d78908b6de2fde868d5bb87c6f Mon Sep 17 00:00:00 2001
From: Bharat Bhushan <Bharat.Bhushan@freescale.com>
Date: Thu, 5 Nov 2015 16:11:36 +0530
Subject: [PATCH 0857/1383] vfio fsl-mc: Do irq cleanup only for device which
 supports interrupts

We initializes interrupts only for devices which supports interrupt and
so we should call irq-cleanup only if they are initialized.

Signed-off-by: Bharat Bhushan <Bharat.Bhushan@freescale.com>
[Original patch taken from QorIQ-SDK-V2.0-20160527-yocto]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/vfio/fsl-mc/vfio_fsl_mc.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/drivers/vfio/fsl-mc/vfio_fsl_mc.c b/drivers/vfio/fsl-mc/vfio_fsl_mc.c
index 473cf68..ffbe845 100644
--- a/drivers/vfio/fsl-mc/vfio_fsl_mc.c
+++ b/drivers/vfio/fsl-mc/vfio_fsl_mc.c
@@ -515,7 +515,9 @@ static int vfio_fsl_mc_remove(struct fsl_mc_device *mc_dev)
 		if (ret < 0)
 			dev_err(dev, "dprc_close(atomic-io) fails %d\n", ret);
 	} else {
-		vfio_fsl_mc_free_irqs(vdev);
+		if (mc_dev->obj_desc.irq_count)
+			vfio_fsl_mc_free_irqs(vdev);
+
 		mc_dev->mc_io = NULL;
 	}
 
-- 
2.8.1

