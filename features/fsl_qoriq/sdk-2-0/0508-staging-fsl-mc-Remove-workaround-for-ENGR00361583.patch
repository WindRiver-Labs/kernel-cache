From f5fbab580bfd60e086bd94c04f8406a1dd596239 Mon Sep 17 00:00:00 2001
From: Itai Katz <itai.katz@freescale.com>
Date: Tue, 28 Jul 2015 08:22:01 +0300
Subject: [PATCH 0508/1383] staging: fsl-mc: Remove workaround for ENGR00361583

ENGR00361583 was fixed in MC release 0.7.1 so the workaround can be removed.

Signed-off-by: Itai Katz <itai.katz@freescale.com>
[Original patch taken from QorIQ-SDK-V2.0-20160527-yocto]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/staging/fsl-mc/bus/mc-bus.c | 24 ++++++------------------
 1 file changed, 6 insertions(+), 18 deletions(-)

diff --git a/drivers/staging/fsl-mc/bus/mc-bus.c b/drivers/staging/fsl-mc/bus/mc-bus.c
index 4c337d6..4147f36 100644
--- a/drivers/staging/fsl-mc/bus/mc-bus.c
+++ b/drivers/staging/fsl-mc/bus/mc-bus.c
@@ -673,20 +673,16 @@ static void program_msi_at_mc(struct fsl_mc_device *mc_bus_dev,
 	if (WARN_ON(!owner_mc_dev))
 		return;
 
+	irq_cfg.paddr = irq->msi_paddr;
+	irq_cfg.val = irq->msi_value;
+	irq_cfg.user_irq_id = irq->irq_number;
+
 	if (owner_mc_dev == mc_bus_dev) {
 		/*
 		 * IRQ is for the mc_bus_dev's DPRC itself
 		 */
-		irq_cfg.paddr = irq->msi_paddr;
-		irq_cfg.val = irq->msi_value;
-		irq_cfg.user_irq_id = irq->irq_number;
-
-		/*
-		 * TODO: Add the MC_CMD_FLAG_PRI flag below when
-		 * a fix for CR:ENGR00361583 becomes available
-		 */
 		error = dprc_set_irq(mc_bus->atomic_mc_io,
-				     MC_CMD_FLAG_INTR_DIS,
+				     MC_CMD_FLAG_INTR_DIS | MC_CMD_FLAG_PRI,
 				     mc_bus->atomic_dprc_handle,
 				     irq->dev_irq_index,
 				     &irq_cfg);
@@ -695,10 +691,6 @@ static void program_msi_at_mc(struct fsl_mc_device *mc_bus_dev,
 				"dprc_set_irq() failed: %d\n", error);
 		}
 	} else {
-		irq_cfg.paddr = irq->msi_paddr;
-		irq_cfg.val = irq->msi_value;
-		irq_cfg.user_irq_id = irq->irq_number;
-
 		/* FIXME: We have only one DPIO register, we should set
 		 * MSI address = 0 only when no DPIO uses MSI interrupt.
 		 * Below is just a workaround, where we never set 0
@@ -707,12 +699,8 @@ static void program_msi_at_mc(struct fsl_mc_device *mc_bus_dev,
 		    (strncmp("dpio", owner_mc_dev->obj_desc.type, 4) == 0))
 			return;
 
-		/*
-		 * TODO: Add the MC_CMD_FLAG_PRI flag below when
-		 * a fix for CR:ENGR00361583 becomes available
-		 */
 		error = dprc_set_obj_irq(mc_bus->atomic_mc_io,
-					 MC_CMD_FLAG_INTR_DIS,
+					 MC_CMD_FLAG_INTR_DIS | MC_CMD_FLAG_PRI,
 					 mc_bus->atomic_dprc_handle,
 					 owner_mc_dev->obj_desc.type,
 					 owner_mc_dev->obj_desc.id,
-- 
2.8.1

