From 4cde35dbf285077f6e228d07bd7835660e4a2512 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Horia=20Geant=C4=83?= <horia.geanta@freescale.com>
Date: Tue, 3 Nov 2015 16:54:49 +0200
Subject: [PATCH 0517/1383] staging: fsl-mc: mark DPSECI as non-coherent
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

For LS2080 Rev.1, CAAM is not able to generate coherent transactions
(that is without SMMU intervention).

Signed-off-by: Horia GeantÄƒ <horia.geanta@freescale.com>
[Original patch taken from QorIQ-SDK-V2.0-20160527-yocto]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/staging/fsl-mc/bus/mc-bus.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl-mc/bus/mc-bus.c b/drivers/staging/fsl-mc/bus/mc-bus.c
index 594bde2..b12cd9b 100644
--- a/drivers/staging/fsl-mc/bus/mc-bus.c
+++ b/drivers/staging/fsl-mc/bus/mc-bus.c
@@ -618,10 +618,12 @@ int fsl_mc_device_add(struct dprc_obj_desc *obj_desc,
 			goto error_cleanup_dev;
 	}
 
-	/* DPAA2 devices on the mc-bus *are* dma-coherent.
+	/* DPAA2 devices on the mc-bus *are* dma-coherent,
+	 * with the noticeable exception of DPSECI.
 	 * FIXME: fill up @dma_base, @size, @iommu
 	 */
-	arch_setup_dma_ops(&mc_dev->dev, 0, 0, NULL, true);
+	if (strcmp(obj_desc->type, "dpseci"))
+		arch_setup_dma_ops(&mc_dev->dev, 0, 0, NULL, true);
 
 	/*
 	 * The device-specific probe callback will get invoked by device_add()
-- 
2.8.1

