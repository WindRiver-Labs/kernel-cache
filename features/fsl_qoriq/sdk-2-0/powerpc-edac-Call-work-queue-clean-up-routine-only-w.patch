From 6901f6683d4f0a62b26dd457f7905f0fb18ea52c Mon Sep 17 00:00:00 2001
From: Li Yang <leoli@freescale.com>
Date: Thu, 3 Dec 2015 17:09:27 -0600
Subject: [PATCH 0449/1429] powerpc/edac: Call work queue clean up routine
 only when edac_op_state is set to polling

For pci errors we set the edac op state to "interrupt" and thus do not
setup the work queue. While performing edac pci device cleanup, work
queue cleanup should only be performed if the op state is set to polling.

Signed-off-by: Varun Sethi <Varun.Sethi@freescale.com>
[Original patch taken from QorIQ-SDK-V2.0-20160527-yocto]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/edac/edac_pci.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/drivers/edac/edac_pci.c b/drivers/edac/edac_pci.c
index b4b3860..cec5b36 100644
--- a/drivers/edac/edac_pci.c
+++ b/drivers/edac/edac_pci.c
@@ -389,6 +389,7 @@ EXPORT_SYMBOL_GPL(edac_pci_add_device);
 struct edac_pci_ctl_info *edac_pci_del_device(struct device *dev)
 {
 	struct edac_pci_ctl_info *pci;
+	int op_state;
 
 	edac_dbg(0, "\n");
 
@@ -403,6 +404,8 @@ struct edac_pci_ctl_info *edac_pci_del_device(struct device *dev)
 		return NULL;
 	}
 
+	op_state = pci->op_state;
+
 	pci->op_state = OP_OFFLINE;
 
 	del_edac_pci_from_global_list(pci);
@@ -410,7 +413,8 @@ struct edac_pci_ctl_info *edac_pci_del_device(struct device *dev)
 	mutex_unlock(&edac_pci_ctls_mutex);
 
 	/* stop the workq timer */
-	edac_pci_workq_teardown(pci);
+	if (op_state == OP_RUNNING_POLL)
+		edac_pci_workq_teardown(pci);
 
 	edac_printk(KERN_INFO, EDAC_PCI,
 		"Removed device %d for %s %s: DEV %s\n",
-- 
1.7.5.4

