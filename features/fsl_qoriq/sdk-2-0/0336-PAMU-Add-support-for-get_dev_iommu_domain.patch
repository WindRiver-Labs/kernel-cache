From 422bd278aaf1a582ba0857081616c8098e2c1623 Mon Sep 17 00:00:00 2001
From: Codrin Ciubotariu <codrin.ciubotariu@nxp.com>
Date: Thu, 14 Jan 2016 12:13:17 +0200
Subject: [PATCH 0336/1383] PAMU: Add support for get_dev_iommu_domain()

PAMU window setup of MSI bank for direct assigned device using
VFIO depends on getting iommu domain.

Signed-off-by: Bharat Bhushan <Bharat.Bhushan@freescale.com>
Change-Id: I9c340ab7589ac6b8cee128f6e1598f48de6b0f77
Reviewed-on: http://git.am.freescale.net:8181/11893
Reviewed-by: Varun Sethi <Varun.Sethi@freescale.com>
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
[Original patch taken from QorIQ-SDK-V2.0-20160527-yocto]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/iommu/fsl_pamu_domain.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/drivers/iommu/fsl_pamu_domain.c b/drivers/iommu/fsl_pamu_domain.c
index 02fbe2d..8a6838b 100644
--- a/drivers/iommu/fsl_pamu_domain.c
+++ b/drivers/iommu/fsl_pamu_domain.c
@@ -1216,6 +1216,17 @@ static u32 fsl_pamu_get_windows(struct iommu_domain *domain)
 	return dma_domain->win_cnt;
 }
 
+static struct iommu_domain *fsl_get_dev_domain(struct device *dev)
+{
+	struct device_domain_info *info;
+
+	info = dev->archdata.iommu_domain;
+	if (info && info->domain)
+		return &info->domain->iommu_domain;
+
+	return NULL;
+}
+
 static const struct iommu_ops fsl_pamu_ops = {
 	.capable	= fsl_pamu_capable,
 	.domain_alloc	= fsl_pamu_domain_alloc,
@@ -1231,6 +1242,7 @@ static const struct iommu_ops fsl_pamu_ops = {
 	.domain_get_attr = fsl_pamu_get_domain_attr,
 	.add_device	= fsl_pamu_add_device,
 	.remove_device	= fsl_pamu_remove_device,
+	.get_dev_iommu_domain = fsl_get_dev_domain,
 };
 
 int __init pamu_domain_init(void)
-- 
2.8.1

