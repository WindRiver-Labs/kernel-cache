From f13a4324bd9fc3c5b1ece5895170e6d656b49690 Mon Sep 17 00:00:00 2001
From: Roy Pledge <roy.pledge@nxp.com>
Date: Thu, 25 May 2017 16:59:08 -0400
Subject: [PATCH] fsl_qbman/usdpaa: Invalidate software portals before use

Invalidate the cache for the software portals before using them
since the portals are non coherent. This ensures that the core
using the portal is seeing the most up to date information in
case the cache contained older data. This is important during
the cleanup phase if cleanup occurs on a differnt core than
what the application was using.

Signed-off-by: Roy Pledge <roy.pledge@nxp.com>
Signed-off-by: Haiqing Bai <Haiqing.Bai@windriver.com>
---
 drivers/staging/fsl_qbman/fsl_usdpaa.c |   16 ++++++++++++++++
 1 files changed, 16 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_qbman/fsl_usdpaa.c b/drivers/staging/fsl_qbman/fsl_usdpaa.c
index d2775b0..3b6c3cb 100644
--- a/drivers/staging/fsl_qbman/fsl_usdpaa.c
+++ b/drivers/staging/fsl_qbman/fsl_usdpaa.c
@@ -384,6 +384,13 @@ static int init_qm_portal(struct qm_portal_config *config,
 	/* Make sure interrupts are inhibited */
 	qm_out(IIR, 1);
 
+	/*
+	 * Invalidate the entire CE portal are to ensure no stale
+	 * cachelines are present
+	 */
+	for (i = 0; i < 0x4000; i += 64)
+		dcbi(portal->addr.addr_ce + i);
+
 	/* Initialize the DQRR.  This will stop any dequeue
 	   commands that are in progress */
 	if (qm_dqrr_init(portal, config, qm_dqrr_dpush, qm_dqrr_pvb,
@@ -432,9 +439,18 @@ static int init_qm_portal(struct qm_portal_config *config,
 static int init_bm_portal(struct bm_portal_config *config,
 			  struct bm_portal *portal)
 {
+	int i;
+
 	portal->addr.addr_ce = config->addr_virt[DPA_PORTAL_CE];
 	portal->addr.addr_ci = config->addr_virt[DPA_PORTAL_CI];
 
+	/*
+	 * Invalidate the entire CE portal are to ensure no stale
+	 * cachelines are present
+	 */
+	for (i = 0; i < 0x4000; i += 64)
+		dcbi(portal->addr.addr_ce + i);
+
 	if (bm_rcr_init(portal, bm_rcr_pvb, bm_rcr_cce)) {
 		pr_err("Bman RCR initialisation failed\n");
 	return 1;
-- 
1.7.5.4

