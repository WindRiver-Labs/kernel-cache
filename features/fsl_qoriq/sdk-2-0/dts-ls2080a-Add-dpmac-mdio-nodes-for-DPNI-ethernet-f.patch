From 26d3fee2a4ee7a68b7b96fc2cdb3e4ece1b0ef50 Mon Sep 17 00:00:00 2001
From: Rai Harninder-B01044 <harninder.rai@freescale.com>
Date: Tue, 3 Nov 2015 21:05:09 +0530
Subject: [PATCH 0063/1429] dts/ls2080a: Add dpmac/mdio nodes for DPNI
 ethernet functionality

Signed-off-by: Rai Harninder-B01044 <harninder.rai@freescale.com>
Signed-off-by: Kushwaha Prabhakar <prabhakar@freescale.com>
[Original patch taken from QorIQ-SDK-V2.0-20160527-yocto]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/arm64/boot/dts/freescale/fsl-ls2080a-qds.dts |  127 +++------------------
 arch/arm64/boot/dts/freescale/fsl-ls2080a-rdb.dts |   49 ++++----
 arch/arm64/boot/dts/freescale/fsl-ls2080a.dtsi    |   64 +++++++++++
 3 files changed, 102 insertions(+), 138 deletions(-)

diff --git a/arch/arm64/boot/dts/freescale/fsl-ls2080a-qds.dts b/arch/arm64/boot/dts/freescale/fsl-ls2080a-qds.dts
index ecf7ca0..fe5067e 100644
--- a/arch/arm64/boot/dts/freescale/fsl-ls2080a-qds.dts
+++ b/arch/arm64/boot/dts/freescale/fsl-ls2080a-qds.dts
@@ -190,75 +190,6 @@
 			   VSC8234 PHYs on the riser cards.
 			 */
 
-			/* Dirty HACK: making the phy _name_ unique, rather than
-			   relying on the uniqueness of the (dtc-generated) phandle
-			 */
-			mdio_mux0: mdio@0 {
-				reg = <0x0>;
-				#address-cells = <1>;
-				#size-cells = <0>;
-
-				mdio0_phy0: mdio_phy0@1c {
-					reg = <0x1c>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy1: mdio_phy1@1d {
-					reg = <0x1d>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy2: mdio_phy2@1e {
-					reg = <0x1e>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy3: mdio_phy3@1f {
-					reg = <0x1f>;
-					phy-connection-type = "sgmii";
-				};
-			};
-			mdio_mux1: mdio@20 {
-				reg = <0x20>;
-				#address-cells = <1>;
-				#size-cells = <0>;
-
-				mdio0_phy4: mdio_phy0@1c {
-					reg = <0x1c>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy5: mdio_phy1@1d {
-					reg = <0x1d>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy6: mdio_phy2@1e {
-					reg = <0x1e>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy7: mdio_phy3@1f {
-					reg = <0x1f>;
-					phy-connection-type = "sgmii";
-				};
-			};
-			mdio_mux2: mdio@40 {
-				reg = <0x40>;
-				#address-cells = <1>;
-				#size-cells = <0>;
-
-				mdio0_phy8: mdio_phy0@1c {
-					reg = <0x1c>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy9: mdio_phy1@1d {
-					reg = <0x1d>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy10: mdio_phy2@1e {
-					reg = <0x1e>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy11: mdio_phy3@1f {
-					reg = <0x1f>;
-					phy-connection-type = "sgmii";
-				};
-			};
 			mdio_mux3: mdio@60 {
 				reg = <0x60>;
 				#address-cells = <1>;
@@ -281,50 +212,20 @@
 					phy-connection-type = "sgmii";
 				};
 			};
-			mdio_mux4: mdio@80 {
-				reg = <0x80>;
-				#address-cells = <1>;
-				#size-cells = <0>;
-
-				mdio0_phy16: mdio_phy0@1c {
-					reg = <0x1c>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy17: mdio_phy1@1d {
-					reg = <0x1d>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy18: mdio_phy2@1e {
-					reg = <0x1e>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy19: mdio_phy3@1f {
-					reg = <0x1f>;
-					phy-connection-type = "sgmii";
-				};
-			};
-			mdio_mux5: mdio@a0 {
-				reg = <0xa0>;
-				#address-cells = <1>;
-				#size-cells = <0>;
-
-				mdio0_phy20: mdio_phy0@1c {
-					reg = <0x1c>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy21: mdio_phy1@1d {
-					reg = <0x1d>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy22: mdio_phy2@1e {
-					reg = <0x1e>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy23: mdio_phy3@1f {
-					reg = <0x1f>;
-					phy-connection-type = "sgmii";
-				};
-			};
 		};
 	};
 };
+
+/* Update DPMAC connections to external PHYs, under SerDes 0x2a_0x49. */
+&dpmac9 {
+	phy-handle = <&mdio0_phy12>;
+};
+&dpmac10 {
+	phy-handle = <&mdio0_phy13>;
+};
+&dpmac11 {
+	phy-handle = <&mdio0_phy14>;
+};
+&dpmac12 {
+	phy-handle = <&mdio0_phy15>;
+};
diff --git a/arch/arm64/boot/dts/freescale/fsl-ls2080a-rdb.dts b/arch/arm64/boot/dts/freescale/fsl-ls2080a-rdb.dts
index 3e1c863..fab7bbc 100644
--- a/arch/arm64/boot/dts/freescale/fsl-ls2080a-rdb.dts
+++ b/arch/arm64/boot/dts/freescale/fsl-ls2080a-rdb.dts
@@ -131,25 +131,20 @@
 };
 
 &emdio1 {
-	/* FIXME: Same dirty (and hopefully temporary) HACK about the
-	   PHY names as on the QDS board.
-	   This has to be changed. On emdio2 as well.
-	 */
-
 	/* CS4340 PHYs */
-	mdio0_phy0: mdio_phy0@10 {
+	mdio1_phy1: emdio1_phy@1 {
 		reg = <0x10>;
 		phy-connection-type = "xfi";
 	};
-	mdio0_phy1: mdio_phy1@11 {
+	mdio1_phy2: emdio1_phy@2 {
 		reg = <0x11>;
 		phy-connection-type = "xfi";
 	};
-	mdio0_phy2: mdio_phy2@12 {
+	mdio1_phy3: emdio1_phy@3 {
 		reg = <0x12>;
 		phy-connection-type = "xfi";
 	};
-	mdio0_phy3: mdio_phy3@13 {
+	mdio1_phy4: emdio1_phy@4 {
 		reg = <0x13>;
 		phy-connection-type = "xfi";
 	};
@@ -157,24 +152,28 @@
 
 &emdio2 {
 	/* AQR405 PHYs */
-	mdio1_phy0: mdio_phy4@0 {
+	mdio2_phy1: emdio2_phy@1 {
 		compatible = "ethernet-phy-ieee802.3-c45";
 		reg = <0x0>;
 		phy-connection-type = "xfi";
 	};
-	mdio1_phy1: mdio_phy5@1 {
-		compatible = "ethernet-phy-ieee802.3-c45";
-		reg = <0x1>;
-		phy-connection-type = "xfi";
-	};
-	mdio1_phy2: mdio_phy6@2 {
-		compatible = "ethernet-phy-ieee802.3-c45";
-		reg = <0x2>;
-		phy-connection-type = "xfi";
-	};
-	mdio1_phy3: mdio_phy7@3 {
-		compatible = "ethernet-phy-ieee802.3-c45";
-		reg = <0x3>;
-		phy-connection-type = "xfi";
-	};
+};
+
+/* Update DPMAC connections to external PHYs, under the assumption of
+ * SerDes 0x2a_0x41. This is currently the only SerDes supported on the board.
+ */
+&dpmac1 {
+	phy-handle = <&mdio1_phy1>;
+};
+&dpmac2 {
+	phy-handle = <&mdio1_phy2>;
+};
+&dpmac3 {
+	phy-handle = <&mdio1_phy3>;
+};
+&dpmac4 {
+	phy-handle = <&mdio1_phy4>;
+};
+&dpmac5 {
+	phy-handle = <&mdio2_phy1>;
 };
diff --git a/arch/arm64/boot/dts/freescale/fsl-ls2080a.dtsi b/arch/arm64/boot/dts/freescale/fsl-ls2080a.dtsi
index a2b73a4..f55ad79 100644
--- a/arch/arm64/boot/dts/freescale/fsl-ls2080a.dtsi
+++ b/arch/arm64/boot/dts/freescale/fsl-ls2080a.dtsi
@@ -618,6 +618,70 @@
 		 */
 		ranges = <0x0 0x0 0x0 0x8 0x0c000000 0x4000000
 			  0x1 0x0 0x0 0x8 0x18000000 0x8000000>;
+
+		/*
+		 * Define the maximum number of MACs present on the SoC.
+		 * They won't necessarily be all probed, since the
+		 * Data Path Layout file and the MC firmware can put fewer
+		 * actual DPMAC objects on the MC bus.
+		 */
+		dpmacs {
+			#address-cells = <1>;
+			#size-cells = <0>;
+
+			dpmac1: dpmac@1 {
+				compatible = "fsl,qoriq-mc-dpmac";
+				reg = <1>;
+			};
+			dpmac2: dpmac@2 {
+				compatible = "fsl,qoriq-mc-dpmac";
+				reg = <2>;
+			};
+			dpmac3: dpmac@3 {
+				compatible = "fsl,qoriq-mc-dpmac";
+				reg = <3>;
+			};
+			dpmac4: dpmac@4 {
+				compatible = "fsl,qoriq-mc-dpmac";
+				reg = <4>;
+			};
+			dpmac5: dpmac@5 {
+				compatible = "fsl,qoriq-mc-dpmac";
+				reg = <5>;
+			};
+			dpmac9: dpmac@9 {
+				compatible = "fsl,qoriq-mc-dpmac";
+				reg = <9>;
+			};
+			dpmac10: dpmac@10 {
+				compatible = "fsl,qoriq-mc-dpmac";
+				reg = <0xa>;
+			};
+			dpmac11: dpmac@11 {
+				compatible = "fsl,qoriq-mc-dpmac";
+				reg = <0xb>;
+			};
+			dpmac12: dpmac@12 {
+				compatible = "fsl,qoriq-mc-dpmac";
+				reg = <0xc>;
+			};
+			dpmac13: dpmac@13 {
+				compatible = "fsl,qoriq-mc-dpmac";
+				reg = <0xd>;
+			};
+			dpmac14: dpmac@14 {
+				compatible = "fsl,qoriq-mc-dpmac";
+				reg = <0xe>;
+			};
+			dpmac15: dpmac@15 {
+				compatible = "fsl,qoriq-mc-dpmac";
+				reg = <0xf>;
+			};
+			dpmac16: dpmac@16 {
+				compatible = "fsl,qoriq-mc-dpmac";
+				reg = <0x10>;
+			};
+		};
 	};
 
 	ccn@4000000 {
-- 
1.7.5.4

