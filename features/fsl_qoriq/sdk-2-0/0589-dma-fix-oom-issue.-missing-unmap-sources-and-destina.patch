From 60c651a7b236f6e8e1150bc2cb82e05a9fe991f8 Mon Sep 17 00:00:00 2001
From: Jia Hongtao <hongtao.jia@freescale.com>
Date: Sat, 19 Dec 2015 23:39:41 +0800
Subject: [PATCH 0589/1383] dma: fix oom issue. missing unmap sources and
 destinations while doing dequeue.

Signed-off-by: Xuelin Shi <xuelin.shi@freescale.com>
Change-Id: Ibf51682e6d2db57f00adb2bacab3d2b6d44690e0
Reviewed-on: http://git.am.freescale.net:8181/12191
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Yang Li <LeoLi@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>

cherry picked sha b4e5da71b85f97b4c7443188a7091bcfd5c6d9af from sdk/linux-devel master
Please review and update as necessary
[Original patch taken from QorIQ-SDK-V2.0-20160527-yocto]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/dma/fsldma.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/dma/fsldma.c b/drivers/dma/fsldma.c
index 300f821..8a27d7b 100644
--- a/drivers/dma/fsldma.c
+++ b/drivers/dma/fsldma.c
@@ -524,6 +524,8 @@ static dma_cookie_t fsldma_run_tx_complete_actions(struct fsldma_chan *chan,
 		}
 	}
 
+	dma_descriptor_unmap(txd);
+
 	/* Run any dependencies */
 	dma_run_dependencies(txd);
 
-- 
2.8.1

