From ef34025b5f98c01745276fefbb57aa71936b8ec2 Mon Sep 17 00:00:00 2001
From: Varun Sethi <Varun.Sethi@freescale.com>
Date: Mon, 12 May 2014 15:22:05 +0530
Subject: [PATCH 0337/1429] iommu/fsl: Use pci_clear_master to disable device
 bus master capability.

Initially we were disabling the bus master capability by writing to the
PCI configuration space. We were not clearing the "is_busmaster" flag.
As a result when the device was assgined back to host, the bus master
capability of the pci bridge (to which the device was connected) were
not getting enabled. Once the device was assigned back to host, device
was facing DMA issues.

Now, we are using the pci_clear_master for disabling device bus master
capability. This routine clears the device bus master capability by
accessing the device configuration space and also clears the
"is_busmaster" flag.

Signed-off-by: Varun Sethi <Varun.Sethi@freescale.com>
Change-Id: Icda6f5551d8da43bec8f2b657846b7e3f9474290
Reviewed-on: http://git.am.freescale.net:8181/12224
Reviewed-by: Stuart Yoder <stuart.yoder@freescale.com>
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Jose Rivera <German.Rivera@freescale.com>
[Original patch taken from QorIQ-SDK-V2.0-20160527-yocto]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/iommu/fsl_pamu_domain.c |    8 +-------
 1 files changed, 1 insertions(+), 7 deletions(-)

diff --git a/drivers/iommu/fsl_pamu_domain.c b/drivers/iommu/fsl_pamu_domain.c
index 8a6838b..4ede7ea 100644
--- a/drivers/iommu/fsl_pamu_domain.c
+++ b/drivers/iommu/fsl_pamu_domain.c
@@ -353,15 +353,9 @@ static void disable_device_dma(struct device_domain_info *info,
 #ifdef CONFIG_PCI
 	if (info->dev->bus == &pci_bus_type) {
 		struct pci_dev *pdev = NULL;
-		u16 pci_command;
 
 		pdev = to_pci_dev(info->dev);
-		pci_read_config_word(pdev, PCI_COMMAND, &pci_command);
-		/* disable device bus master capability */
-		if (pci_command & PCI_COMMAND_MASTER) {
-			pci_command &= ~PCI_COMMAND_MASTER;
-			pci_write_config_word(pdev, PCI_COMMAND, pci_command);
-		}
+		pci_clear_master(pdev);
 	}
 #endif
 
-- 
1.7.5.4

