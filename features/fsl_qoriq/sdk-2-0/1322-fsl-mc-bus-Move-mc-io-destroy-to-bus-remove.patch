From 0cfa2bb7333c34843a697e2f0b347fbfb3b0f574 Mon Sep 17 00:00:00 2001
From: Bharat Bhushan <Bharat.Bhushan@nxp.com>
Date: Tue, 26 Apr 2016 14:46:29 +0530
Subject: [PATCH 1322/1383] fsl mc-bus: Move mc-io destroy to bus remove

fsl_mc_device_add() is called when a new mc device is added and
fsl_mc_device_remove() is called when a mc device is removed.
Now mc portals (fsl_create_mc_io) are not created during device
addition i.e fsl_mc_device_add(). But mc portal are being destroyed
when an mc device are removed i.e fsl_mc_device_remove(), which is
not correct way of reverting what is done during device addition.

Now this leads to the problem with VFIO driver where we do not want
the portal to be destroyed when an mc-device is removed. VFIO
creates one mc-portal for all dprc-containers bound to it and it
destroys the mc portal when driver itself is removed.

This change moves the mc-portal destroy part to bus-remove for
mc-bus and dprc-driver remove for child DPRCs. This also makes
fsl_mc_device_remove() exactly reverting what is done in
fsl_mc_device_add() with respect to mc portal creation.

Signed-off-by: Bharat Bhushan <Bharat.Bhushan@nxp.com>
[Original patch taken from QorIQ-SDK-V2.0-20160527-yocto]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/staging/fsl-mc/bus/dprc-driver.c | 3 +++
 drivers/staging/fsl-mc/bus/mc-bus.c      | 7 +++----
 2 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/drivers/staging/fsl-mc/bus/dprc-driver.c b/drivers/staging/fsl-mc/bus/dprc-driver.c
index 0d65467..f8d8cbe 100644
--- a/drivers/staging/fsl-mc/bus/dprc-driver.c
+++ b/drivers/staging/fsl-mc/bus/dprc-driver.c
@@ -1045,6 +1045,9 @@ static int dprc_remove(struct fsl_mc_device *mc_dev)
 	if (fsl_mc_interrupts_supported())
 		fsl_mc_cleanup_irq_pool(mc_bus);
 
+	fsl_destroy_mc_io(mc_dev->mc_io);
+	mc_dev->mc_io = NULL;
+
 	if (&mc_dev->dev == fsl_mc_bus_type.dev_root)
 		fsl_mc_bus_type.dev_root = NULL;
 
diff --git a/drivers/staging/fsl-mc/bus/mc-bus.c b/drivers/staging/fsl-mc/bus/mc-bus.c
index 189ebae..f173b35 100644
--- a/drivers/staging/fsl-mc/bus/mc-bus.c
+++ b/drivers/staging/fsl-mc/bus/mc-bus.c
@@ -676,10 +676,6 @@ void fsl_mc_device_remove(struct fsl_mc_device *mc_dev)
 
 	if (strcmp(mc_dev->obj_desc.type, "dprc") == 0) {
 		mc_bus = to_fsl_mc_bus(mc_dev);
-		if (mc_dev->mc_io) {
-			fsl_destroy_mc_io(mc_dev->mc_io);
-			mc_dev->mc_io = NULL;
-		}
 
 		if (&mc_dev->dev == fsl_mc_bus_type.dev_root)
 			fsl_mc_bus_type.dev_root = NULL;
@@ -1254,6 +1250,9 @@ static int fsl_mc_bus_remove(struct platform_device *pdev)
 		irq_domain_remove(mc->irq_domain);
 
 	fsl_mc_device_remove(mc->root_mc_bus_dev);
+	fsl_destroy_mc_io(mc->root_mc_bus_dev->mc_io);
+	mc->root_mc_bus_dev->mc_io = NULL;
+
 	dev_info(&pdev->dev, "Root MC bus device removed");
 	return 0;
 }
-- 
2.8.1

