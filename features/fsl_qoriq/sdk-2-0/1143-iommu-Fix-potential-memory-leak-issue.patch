From 15cc5eaa6cf871eab5d32773650b13070180e1ab Mon Sep 17 00:00:00 2001
From: Bharat Bhushan <Bharat.Bhushan@freescale.com>
Date: Fri, 26 Feb 2016 21:09:03 +0530
Subject: [PATCH 1143/1383] iommu: Fix potential memory leak issue

The dma_domain->win_arr is allocated when geometry is set.
But if domain is destroyed then the allocated memory is not freed.

When the dma_domain is created again then dma_domain is
allocated again, so previous win_arr pointer is lost and never
freed.

Signed-off-by: Bharat Bhushan <Bharat.Bhushan@freescale.com>
[Original patch taken from QorIQ-SDK-V2.0-20160527-yocto]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/iommu/fsl_pamu_domain.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/iommu/fsl_pamu_domain.c b/drivers/iommu/fsl_pamu_domain.c
index 4ede7ea..a39d0598 100644
--- a/drivers/iommu/fsl_pamu_domain.c
+++ b/drivers/iommu/fsl_pamu_domain.c
@@ -477,6 +477,7 @@ static void fsl_pamu_domain_free(struct iommu_domain *domain)
 	dma_domain->enabled = 0;
 	dma_domain->mapped = 0;
 
+	kfree(dma_domain->win_arr);
 	kmem_cache_free(fsl_pamu_domain_cache, dma_domain);
 }
 
-- 
2.8.1

