From c8a9f5098e77e8fd044dfae735c9bb4035240489 Mon Sep 17 00:00:00 2001
From: yhe <yongli.he@windriver.com>
Date: Thu, 12 Jul 2012 15:11:44 +0800
Subject: [PATCH 18/23] powerpc/fsl-pci: Only scan PCI bus if configured as a
 host

commit c9f11c30374329a0d2a88cf05281ca49d8eca9ab upstream

We change fsl_add_bridge to return -ENODEV if the controller is working in
agent mode. Then check the return value of fsl_add_bridge to guarantee
that only successfully added host bus will be scanned.

Signed-off-by: Jia Hongtao <B38951@freescale.com>
Signed-off-by: Li Yang <leoli@freescale.com>
Signed-off-by: Kumar Gala <galak@kernel.crashing.org>
[Rebase this on current kernel context]
Integrated-by: Yongli He <yongli.he@windriver.com>
---
 arch/powerpc/platforms/85xx/mpc85xx_ds.c |   11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/mpc85xx_ds.c b/arch/powerpc/platforms/85xx/mpc85xx_ds.c
index 1fd91e9..95baa87 100644
--- a/arch/powerpc/platforms/85xx/mpc85xx_ds.c
+++ b/arch/powerpc/platforms/85xx/mpc85xx_ds.c
@@ -151,19 +151,22 @@ static void __init mpc85xx_ds_setup_arch(void)
 
 #ifdef CONFIG_PCI
 	for_each_node_by_type(np, "pci") {
+		int err;
 		if (of_device_is_compatible(np, "fsl,mpc8540-pci") ||
 		    of_device_is_compatible(np, "fsl,mpc8548-pcie") ||
 		    of_device_is_compatible(np, "fsl,p2020-pcie")) {
 			struct resource rsrc;
 			of_address_to_resource(np, 0, &rsrc);
 			if ((rsrc.start & 0xfffff) == primary_phb_addr)
-				fsl_add_bridge(np, 1);
+				err=fsl_add_bridge(np, 1);
 			else
-				fsl_add_bridge(np, 0);
+				err=fsl_add_bridge(np, 0);
 
 			hose = pci_find_hose_for_OF_device(np);
-			max = min(max, hose->dma_window_base_cur +
-					hose->dma_window_size);
+			if(!err)
+				max = min(max, hose->dma_window_base_cur +
+						hose->dma_window_size);
+
 		}
 	}
 
-- 
1.7.9.7

