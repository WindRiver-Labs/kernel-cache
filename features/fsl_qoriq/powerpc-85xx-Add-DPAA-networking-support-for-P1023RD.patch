From d867b95c64036adc301561a68532a3a69641a38a Mon Sep 17 00:00:00 2001
From: Wei Yang <Wei.Yang@windriver.com>
Date: Wed, 27 Mar 2013 17:19:49 +0800
Subject: [PATCH 21/21] powerpc/85xx: Add DPAA/networking support for P1023RDS/RDB

The original patch only supports P1023RDS, compared with the original
patch, only add DPAA support for P1023RDB.

Signed-off-by: Roy Zang <tie-fei.zang@freescale.com>
Signed-off-by: Kumar Gala <galak@kernel.crashing.org>
[QorIQ-SDK-V1.3.1-20121220-yocto image. Just some minor context
mods in order to port to 3.4 kernel]
Signed-off-by: Wei Yang <Wei.Yang@windriver.com>
---
 arch/powerpc/platforms/85xx/Makefile    |    2 +-
 arch/powerpc/platforms/85xx/p1023_rds.c |    5 +++++
 2 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/Makefile b/arch/powerpc/platforms/85xx/Makefile
index 96775e6..6130ba1 100644
--- a/arch/powerpc/platforms/85xx/Makefile
+++ b/arch/powerpc/platforms/85xx/Makefile
@@ -19,7 +19,7 @@ obj-$(CONFIG_MPC85xx_MDS) += mpc85xx_mds.o
 obj-$(CONFIG_MPC85xx_RDB) += mpc85xx_rdb.o
 obj-$(CONFIG_P1010_RDB)   += p1010rdb.o
 obj-$(CONFIG_P1022_DS)    += p1022_ds.o
-obj-$(CONFIG_P1023_RDS)   += p1023_rds.o
+obj-$(CONFIG_P1023_RDS)   += p1023_rds.o corenet_ds.o
 obj-$(CONFIG_P2041_RDB)   += p2041_rdb.o corenet_ds.o
 obj-$(CONFIG_P3041_DS)    += p3041_ds.o corenet_ds.o
 obj-$(CONFIG_P3060_QDS)   += p3060_qds.o corenet_ds.o
diff --git a/arch/powerpc/platforms/85xx/p1023_rds.c b/arch/powerpc/platforms/85xx/p1023_rds.c
index b7c9a44..557c187 100644
--- a/arch/powerpc/platforms/85xx/p1023_rds.c
+++ b/arch/powerpc/platforms/85xx/p1023_rds.c
@@ -35,6 +35,7 @@
 #include <sysdev/fsl_pci.h>
 
 #include "mpc85xx.h"
+#include "corenet_ds.h"
 
 /* ************************************************************************
  *
@@ -101,7 +102,9 @@ machine_arch_initcall(p1023_rds, p1023_rds_publish_pci_device);
 machine_arch_initcall(p1023_rdb, p1023_rds_publish_pci_device);
 
 machine_device_initcall(p1023_rds, mpc85xx_common_publish_devices);
+machine_device_initcall(p1023_rds, declare_of_platform_devices);
 machine_device_initcall(p1023_rdb, mpc85xx_common_publish_devices);
+machine_device_initcall(p1023_rdb, declare_of_platform_devices);
 
 static void __init mpc85xx_rds_pic_init(void)
 {
@@ -131,6 +134,7 @@ define_machine(p1023_rds) {
 	.restart		= fsl_rstcr_restart,
 	.calibrate_decr		= generic_calibrate_decr,
 	.progress		= udbg_progress,
+	.init_early     = corenet_ds_init_early,
 #ifdef CONFIG_PCI
 	.pcibios_fixup_bus	= fsl_pcibios_fixup_bus,
 #endif
@@ -153,6 +157,7 @@ define_machine(p1023_rdb) {
 	.restart		= fsl_rstcr_restart,
 	.calibrate_decr		= generic_calibrate_decr,
 	.progress		= udbg_progress,
+	.init_early     = corenet_ds_init_early,
 #ifdef CONFIG_PCI
 	.pcibios_fixup_bus	= fsl_pcibios_fixup_bus,
 #endif
-- 
1.7.0

