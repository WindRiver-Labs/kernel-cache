From 08513607ba6fee57d7f7a4ca17e3106c07cb16e9 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Mon, 25 Mar 2013 10:05:31 +0800
Subject: [PATCH 3/3] powerpc/fsl_book3e: disable the thread when it is offline

When a thread is offline, we should disable it instead of spin here.
This should improve the performance of other threads which is still
running.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/platforms/85xx/smp.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/smp.c b/arch/powerpc/platforms/85xx/smp.c
index ca9953b..cec8ac0 100644
--- a/arch/powerpc/platforms/85xx/smp.c
+++ b/arch/powerpc/platforms/85xx/smp.c
@@ -200,6 +200,13 @@ static void __cpuinit smp_85xx_mach_cpu_die(void)
 
 	generic_set_cpu_dead(cpu);
 
+	if (cpu_has_feature(CPU_FTR_SMT)) {
+		cpu = cpu_thread_in_core(cpu);
+		cpu = 1 << cpu;
+		mb();
+		mtspr(SPRN_TENC, cpu);
+	}
+
 	while (1)
 		;
 }
-- 
1.7.0

