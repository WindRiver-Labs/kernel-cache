From 1cd343e8928cc6e51725da421f7b8236daf6f3f7 Mon Sep 17 00:00:00 2001
From: Corey Minyard <cminyard@mvista.com>
Date: Wed, 22 Aug 2012 11:28:28 -0500
Subject: [PATCH 07/18] msa: Add some missing preempt disables

From the upstream project:
git://microstate.git.sourceforge.net/gitroot/microstate/linux-msa

MSA_NOW() requires preempt to be off.

Signed-off-by: Corey Minyard <cminyard@mvista.com>
---
 fs/proc/base.c | 4 ++++
 kernel/msa.c   | 6 ++++++
 2 files changed, 10 insertions(+)

diff --git a/fs/proc/base.c b/fs/proc/base.c
index 5830be5..0addabf 100644
--- a/fs/proc/base.c
+++ b/fs/proc/base.c
@@ -2975,7 +2975,9 @@ static int proc_tid_msa(struct task_struct *task, char *buffer)
 		now = msp1.last_change;
 		break;
 	default:
+		preempt_disable();
 		MSA_NOW(now);
+		preempt_enable();
 		tp[msp1.cur_state] += now - msp1.last_change;
 	}
 	return
@@ -3029,7 +3031,9 @@ static int proc_tgid_msa(struct task_struct *task, char *buffer)
 		return proc_tid_msa(task, buffer);
 
 	memset(&msp2, 0, sizeof msp2);
+	preempt_disable();
 	MSA_NOW(now);
+	preempt_enable();
 	read_lock(&tasklist_lock);
 	do {
 		msp1 = task->microstates;
diff --git a/kernel/msa.c b/kernel/msa.c
index b91da98..f207931 100644
--- a/kernel/msa.c
+++ b/kernel/msa.c
@@ -140,7 +140,9 @@ void msa_init(struct task_struct *p)
 	struct microstates *msp = &p->microstates;
 
 	memset(msp, 0, sizeof *msp);
+	preempt_disable();
 	MSA_NOW(msp->last_change);
+	preempt_enable();
 	msp->cur_state = MSA_UNINTERRUPTIBLE_SLEEP;
 	msp->next_state = MSA_ONCPU_SYS;
 }
@@ -461,7 +463,9 @@ SYSCALL_DEFINE3(msa, int, ntimers, int, which, msa_time_t __user *, timers)
 	case MSA_GET_NOW:
 		ntimers = 1;
 		tp = out.timers;
+		preempt_disable();
 		MSA_NOW(*tp);
+		preempt_enable();
 		break;
 
 	default:
@@ -509,7 +513,9 @@ static int msa_irq_time_seq_show(struct seq_file *f, void *v)
 	if (i == 0) {
 		msa_time_t now;
 		char cpuname[10];
+		preempt_disable();
 		MSA_NOW(now);
+		preempt_enable();
 		seq_printf(f, "Now: %15llu\n", now);
 		seq_printf(f, "     ");
 		for_each_present_cpu(cpu) {
-- 
1.8.0.1.264.g226dcb5

