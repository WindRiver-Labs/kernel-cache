From 0ee3211dd8dc23f18b10a9421fe52c59678d0976 Mon Sep 17 00:00:00 2001
From: Michel Thebeau <michel.thebeau@windriver.com>
Date: Wed, 22 May 2013 09:27:48 -0400
Subject: [PATCH] msa: make depend on not PREEMPT_RT_BASE

Locking in msa was not written with preempt-rt in mind, which causes
errors such as the following:
BUG: sleeping function called from invalid context at kernel/rtmutex.c:658
in_atomic(): 1, irqs_disabled(): 1, pid: 0, name: swapper/0
Call Trace:
[<ffffffff80809474>] dump_stack+0x1c/0x50
[<ffffffff801a9a44>] __might_sleep+0x12c/0x138
[<ffffffff80814b20>] rt_spin_lock+0x38/0x90
[<ffffffff801a35b4>] msa_start_irq+0x224/0x2d0
[<ffffffff80819b78>] do_IRQ+0x30/0x78
[<ffffffff80104278>] octeon_irq_ciu2+0xa8/0x140
[<ffffffff801057dc>] plat_irq_dispatch+0x84/0xd0

Force msa to be disabled on PREEMPT_RT_BASE kernels.

Signed-off-by: Michel Thebeau <michel.thebeau@windriver.com>
---
 arch/arm/Kconfig.debug  |    1 +
 arch/mips/Kconfig.debug |    1 +
 arch/x86/Kconfig.debug  |    1 +
 3 files changed, 3 insertions(+)

diff --git a/arch/arm/Kconfig.debug b/arch/arm/Kconfig.debug
index dad2c10..9e81e99 100644
--- a/arch/arm/Kconfig.debug
+++ b/arch/arm/Kconfig.debug
@@ -342,6 +342,7 @@ config ARM_KPROBES_TEST
 
 config MICROSTATE_ACCT
 	bool "Microstate accounting"
+	depends on !PREEMPT_RT_BASE
 	help
 	  This option causes the kernel to keep very accurate track of
 	  how long your threads spend on the runqueues, running, or asleep or
diff --git a/arch/mips/Kconfig.debug b/arch/mips/Kconfig.debug
index d2e3ee6..983a811 100644
--- a/arch/mips/Kconfig.debug
+++ b/arch/mips/Kconfig.debug
@@ -130,6 +130,7 @@ config SPINLOCK_TEST
 
 config MICROSTATE_ACCT
 	bool "Microstate accounting"
+	depends on !PREEMPT_RT_BASE
 	help
 	  This option causes the kernel to keep very accurate track of
 	  how long your threads spend on the runqueues, running, or asleep or
diff --git a/arch/x86/Kconfig.debug b/arch/x86/Kconfig.debug
index e2861ca..50e3229 100644
--- a/arch/x86/Kconfig.debug
+++ b/arch/x86/Kconfig.debug
@@ -7,6 +7,7 @@ source "lib/Kconfig.debug"
 
 config MICROSTATE_ACCT
 	bool "Microstate accounting"
+	depends on !PREEMPT_RT_BASE
 	help
 	  This option causes the kernel to keep very accurate track of
 	  how long your threads spend on the runqueues, running, or asleep or
-- 
1.7.9.7

