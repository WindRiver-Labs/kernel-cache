From 9c2a36e46191a41834a0d80c5c4828b6ea100e93 Mon Sep 17 00:00:00 2001
From: Razvan Stefanescu <razvan.stefanescu@freescale.com>
Date: Mon, 13 Jul 2015 14:35:54 +0300
Subject: [PATCH 159/214] dpaa2-evb: Set carrier state on port open

Sync carrier state with the one reported by MC on port open.

Signed-off-by: Razvan Stefanescu <razvan.stefanescu@freescale.com>
[Original patch extracted from FSL LS2085 SDK EAR5.0,
Layerscape2-SDK-SOURCE-20150828-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/staging/fsl-dpaa2/evb/evb.c | 43 +++++++++++++++++++++++++++++++++++++
 1 file changed, 43 insertions(+)

diff --git a/drivers/staging/fsl-dpaa2/evb/evb.c b/drivers/staging/fsl-dpaa2/evb/evb.c
index 1e3d58c..741d437 100644
--- a/drivers/staging/fsl-dpaa2/evb/evb.c
+++ b/drivers/staging/fsl-dpaa2/evb/evb.c
@@ -61,6 +61,47 @@ struct evb_priv {
 	int			dev_id;
 };
 
+static int _evb_port_carrier_state_sync(struct net_device *netdev)
+{
+	struct evb_port_priv		*port_priv = netdev_priv(netdev);
+	struct dpdmux_link_state	state;
+	int			err;
+
+	err = dpdmux_if_get_link_state(port_priv->evb_priv->mc_io,
+				     0,
+				     port_priv->evb_priv->mux_handle,
+				     port_priv->port_index, &state);
+	if (unlikely(err)) {
+		netdev_err(netdev, "dpdmux_if_get_link_state() err %d\n", err);
+		return err;
+	}
+
+	WARN_ONCE(state.up > 1, "Garbage read into link_state");
+
+	if (state.up)
+		netif_carrier_on(port_priv->netdev);
+	else
+		netif_carrier_off(port_priv->netdev);
+
+	return 0;
+}
+
+static int evb_port_open(struct net_device *netdev)
+{
+	int			err;
+
+	/* FIXME: enable port when support added */
+
+	err = _evb_port_carrier_state_sync(netdev);
+	if (err) {
+		netdev_err(netdev, "ethsw_port_carrier_state_sync err %d\n",
+			   err);
+		return err;
+	}
+
+	return 0;
+}
+
 static netdev_tx_t evb_dropframe(struct sk_buff *skb, struct net_device *dev)
 {
 	/* we don't support I/O for now, drop the frame */
@@ -612,6 +653,8 @@ error:
 }
 
 static const struct net_device_ops evb_port_ops = {
+	.ndo_open		= &evb_port_open,
+
 	.ndo_start_xmit		= &evb_dropframe,
 
 	.ndo_fdb_add		= &evb_port_fdb_add,
-- 
2.5.3

