From b9f8de71906abde01eb69a13061e9f9336bd71b1 Mon Sep 17 00:00:00 2001
From: Bharat Bhushan <Bharat.Bhushan@freescale.com>
Date: Wed, 1 Jul 2015 14:23:18 +0530
Subject: [PATCH 166/214] mc-bus: Fix to delete msi_list entry on cleanup

Delete list entry from msi_list was missing.
It was missing both in error condition in
fsl_mc_populate_irq_pool() and in IRQ teardown
of irq pool in fsl_mc_cleanup_irq_pool()

Signed-off-by: Bharat Bhushan <Bharat.Bhushan@freescale.com>
[Original patch extracted from FSL LS2085 SDK EAR5.0,
Layerscape2-SDK-SOURCE-20150828-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/staging/fsl-mc/bus/mc-bus.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl-mc/bus/mc-bus.c b/drivers/staging/fsl-mc/bus/mc-bus.c
index ffef959..4521720 100644
--- a/drivers/staging/fsl-mc/bus/mc-bus.c
+++ b/drivers/staging/fsl-mc/bus/mc-bus.c
@@ -902,8 +902,10 @@ int __must_check fsl_mc_populate_irq_pool(struct fsl_mc_bus *mc_bus,
 
 cleanup_msi_entries:
 	list_for_each_entry_safe(msi_entry, next_msi_entry,
-				 &mc_bus_dev->dev.msi_list, list)
+				 &mc_bus_dev->dev.msi_list, list) {
+		list_del(&msi_entry->list);
 		kfree(msi_entry);
+	}
 
 	devm_kfree(&mc_bus_dev->dev, irq_resources);
 	return error;
@@ -933,8 +935,10 @@ void fsl_mc_cleanup_irq_pool(struct fsl_mc_bus *mc_bus)
 
 	msi_domain_free_irqs(mc->irq_domain, &mc_bus->mc_dev.dev);
 	list_for_each_entry_safe(msi_entry, next_msi_entry,
-				 &mc_bus->mc_dev.dev.msi_list, list)
+				 &mc_bus->mc_dev.dev.msi_list, list) {
+		list_del(&msi_entry->list);
 		kfree(msi_entry);
+	}
 
 	devm_kfree(&mc_bus->mc_dev.dev, mc_bus->irq_resources);
 	res_pool->max_count = 0;
-- 
2.5.3

