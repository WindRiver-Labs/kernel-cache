From f0097be4b3ace57be66346d1a981610db845bc7f Mon Sep 17 00:00:00 2001
From: Razvan Stefanescu <razvan.stefanescu@freescale.com>
Date: Thu, 16 Jul 2015 12:10:31 +0300
Subject: [PATCH 157/214] dpaa2-ethsw: Set carrier state on probe

When probing the switch, sync ports carrier state with the one reported
by MC.

Signed-off-by: Razvan Stefanescu <razvan.stefanescu@freescale.com>
[Original patch extracted from FSL LS2085 SDK EAR5.0,
Layerscape2-SDK-SOURCE-20150828-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/staging/fsl-dpaa2/ethsw/switch.c | 32 ++++++++++++++++++++++++++++++++
 1 file changed, 32 insertions(+)

diff --git a/drivers/staging/fsl-dpaa2/ethsw/switch.c b/drivers/staging/fsl-dpaa2/ethsw/switch.c
index f69ad38..41a30f7 100644
--- a/drivers/staging/fsl-dpaa2/ethsw/switch.c
+++ b/drivers/staging/fsl-dpaa2/ethsw/switch.c
@@ -775,6 +775,30 @@ static const struct net_device_ops ethsw_ops = {
 /*--------------------------------------------------------------------------- */
 /* switch port netdevice ops */
 
+static int _ethsw_port_carrier_state_sync(struct net_device *netdev)
+{
+	struct ethsw_port_priv	*port_priv = netdev_priv(netdev);
+	struct dpsw_link_state	state;
+	int			err;
+
+	err = dpsw_if_get_link_state(port_priv->ethsw_priv->mc_io, 0,
+				     port_priv->ethsw_priv->dpsw_handle,
+				     port_priv->port_index, &state);
+	if (unlikely(err)) {
+		netdev_err(netdev, "dpsw_if_get_link_state() err %d\n", err);
+		return err;
+	}
+
+	WARN_ONCE(state.up > 1, "Garbage read into link_state");
+
+	if (state.up)
+		netif_carrier_on(port_priv->netdev);
+	else
+		netif_carrier_off(port_priv->netdev);
+
+	return 0;
+}
+
 static int ethsw_port_open(struct net_device *netdev)
 {
 	struct ethsw_port_priv	*port_priv = netdev_priv(netdev);
@@ -1450,6 +1474,14 @@ ethsw_probe(struct fsl_mc_device *sw_dev)
 		if (err)
 			dev_warn(&netdev->dev,
 				 "ethsw_port_fdb_add_mc err %d\n", err);
+
+
+		/* sync carrier state */
+		err = _ethsw_port_carrier_state_sync(port_netdev);
+		if (err)
+			netdev_err(netdev,
+				   "_ethsw_port_carrier_state_sync err %d\n",
+				   err);
 	}
 
 	/* the switch starts up enabled */
-- 
2.5.3

