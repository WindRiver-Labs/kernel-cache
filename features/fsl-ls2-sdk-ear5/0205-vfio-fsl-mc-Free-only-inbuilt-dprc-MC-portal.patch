From 102a7bcaa99ef8a9eb58c94b11510e49eafdff64 Mon Sep 17 00:00:00 2001
From: Bharat Bhushan <Bharat.Bhushan@freescale.com>
Date: Wed, 15 Apr 2015 16:22:19 +0530
Subject: [PATCH 205/214] vfio fsl-mc: Free only inbuilt dprc MC portal

When we bind a DPRC with vfio then we check if it has an
associated initialized MC portal or not. If there is an
initialized MC portal then we destroy and uses vfio allocated
and initialized MC portal. But this will leade to issues
if we unbind the DPRC and then bind again. We should not free
if this is the vfio allocated MC portal.

Signed-off-by: Bharat Bhushan <Bharat.Bhushan@freescale.com>
Change-Id: I054f511b0ec7f656696622db571144a988b01b81
Reviewed-on: http://git.am.freescale.net:8181/35000
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Stuart Yoder <stuart.yoder@freescale.com>
[Original patch extracted from FSL LS2085 SDK EAR5.0,
Layerscape2-SDK-SOURCE-20150828-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/vfio/fsl-mc/vfio_fsl_mc.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/vfio/fsl-mc/vfio_fsl_mc.c b/drivers/vfio/fsl-mc/vfio_fsl_mc.c
index 459c7f4..c600cc8 100644
--- a/drivers/vfio/fsl-mc/vfio_fsl_mc.c
+++ b/drivers/vfio/fsl-mc/vfio_fsl_mc.c
@@ -278,8 +278,8 @@ static int vfio_fsl_mc_probe(struct fsl_mc_device *mc_dev)
 	if (strcmp(mc_dev->obj_desc.type, "dprc") == 0) {
 		vdev->mc_dev = mc_dev;
 
-		/* Free existing MC portal if exists */
-		if (mc_dev->mc_io)
+		/* Free inbuilt dprc MC portal if exists */
+		if (mc_dev->mc_io  && (mc_dev->mc_io != vfio_mc_io))
 			fsl_destroy_mc_io(mc_dev->mc_io);
 
 		/* Use New Allocated MC Portal (DPMCP object) */
-- 
2.5.3

