From 6aaf6a59446fd2b98a150d33f7c7aeafef65e863 Mon Sep 17 00:00:00 2001
From: Bharat Bhushan <Bharat.Bhushan@freescale.com>
Date: Wed, 22 Jul 2015 16:08:19 +0530
Subject: [PATCH 169/214] mc-bus: Add a workaround to not set DPIO MSI address
 as NULL

We have only one MSI-address register for all DPIO and we should
set this to NULL only when no other DPIO using interrupt.

This is just a quick fix and will be replaced by proper solution.

Signed-off-by: Bharat Bhushan <Bharat.Bhushan@freescale.com>
[Original patch extracted from FSL LS2085 SDK EAR5.0,
Layerscape2-SDK-SOURCE-20150828-yocto.iso]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/staging/fsl-mc/bus/mc-bus.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/drivers/staging/fsl-mc/bus/mc-bus.c b/drivers/staging/fsl-mc/bus/mc-bus.c
index 85e59a6..4c337d6 100644
--- a/drivers/staging/fsl-mc/bus/mc-bus.c
+++ b/drivers/staging/fsl-mc/bus/mc-bus.c
@@ -699,6 +699,14 @@ static void program_msi_at_mc(struct fsl_mc_device *mc_bus_dev,
 		irq_cfg.val = irq->msi_value;
 		irq_cfg.user_irq_id = irq->irq_number;
 
+		/* FIXME: We have only one DPIO register, we should set
+		 * MSI address = 0 only when no DPIO uses MSI interrupt.
+		 * Below is just a workaround, where we never set 0
+		 * MSI address */
+		if (irq_cfg.paddr == 0x0 &&
+		    (strncmp("dpio", owner_mc_dev->obj_desc.type, 4) == 0))
+			return;
+
 		/*
 		 * TODO: Add the MC_CMD_FLAG_PRI flag below when
 		 * a fix for CR:ENGR00361583 becomes available
-- 
2.5.3

