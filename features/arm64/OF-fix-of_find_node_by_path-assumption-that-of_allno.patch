From 2bca5eac544f4b489ccea6b778c585869629388a Mon Sep 17 00:00:00 2001
From: Frank Rowand <frank.rowand@sonymobile.com>
Date: Sat, 14 Jun 2014 20:39:05 -0700
Subject: [PATCH 272/430] OF: fix of_find_node_by_path() assumption that
 of_allnodes is root

of_find_node_by_path() is borked because of_allnodes is not guaranteed to
contain the root of the tree after using any of the dynamic update functions
because some other nodes ends up as of_allnodes.

Fixes: c22e650e66b8 of: Make of_find_node_by_path() handle /aliases
Reported-by: pantelis.antoniou@konsulko.com
Signed-off-by: Frank Rowand <frank.rowand@sonymobile.com>
Signed-off-by: Rob Herring <robh@kernel.org>
(cherry picked from commit 99de64984c3a7c9bf56a50e6dcc51006c9485620)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/of/base.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/of/base.c b/drivers/of/base.c
index 10d70a7..0a277fb 100644
--- a/drivers/of/base.c
+++ b/drivers/of/base.c
@@ -1965,9 +1965,9 @@ int of_attach_node(struct device_node *np)
 
 	raw_spin_lock_irqsave(&devtree_lock, flags);
 	np->sibling = np->parent->child;
-	np->allnext = of_allnodes;
+	np->allnext = np->parent->allnext;
+	np->parent->allnext = np;
 	np->parent->child = np;
-	of_allnodes = np;
 	of_node_clear_flag(np, OF_DETACHED);
 	raw_spin_unlock_irqrestore(&devtree_lock, flags);
 
-- 
1.7.5.4

