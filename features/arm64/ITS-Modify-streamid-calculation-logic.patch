From b3c0d9c450ebbf3fd8204b0b71ea0185ed89078f Mon Sep 17 00:00:00 2001
From: Tirumalesh Chalamarla <tchalamarla@cavium.com>
Date: Wed, 18 Jun 2014 15:28:24 -0700
Subject: [PATCH 175/430] ITS: Modify streamid calculation logic

The commit comes from
  git://git.kernel.org/pub/scm/linux/kernel/git/rric/linux.git

pci stream id's needs to consided pci bridge number to be unique on the system.
only bus, devfn can't do the trick if system has multiple pci bridges.

Signed-off-by: Tirumalesh Chalamarla <tchalamarla@cavium.com>
Signed-off-by: Robert Richter <rrichter@cavium.com>
(cherry picked from commit b52358b1c2e7cc953787c085bd8168a95df6a27f)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/irqchip/irq-gic-v3-its.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/irqchip/irq-gic-v3-its.c b/drivers/irqchip/irq-gic-v3-its.c
index 6ad85d7..73cbd7c 100644
--- a/drivers/irqchip/irq-gic-v3-its.c
+++ b/drivers/irqchip/irq-gic-v3-its.c
@@ -1168,7 +1168,7 @@ static void its_msi_teardown_irq(struct msi_chip *chip, unsigned int irq)
 }
 
 /* FIXME: Use proper API once it is available in the kernel... */
-#define PCI_REQUESTER_ID(dev)	PCI_DEVID((dev)->bus->number, (dev)->devfn)
+#define PCI_REQUESTER_ID(dev)	((pci_domain_nr(dev->bus) << 16) | ((dev)->bus->number << 8) | (dev)->devfn)
 
 static int its_msi_get_vec_count(struct pci_dev *pdev, struct msi_desc *desc)
 {
-- 
1.7.5.4

