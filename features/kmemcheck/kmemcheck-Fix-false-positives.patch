From 8547c2f4ce14fc5eca40f37055bb122429c10867 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Mon, 1 Mar 2010 03:41:34 -0800
Subject: [PATCH 1/2] kmemcheck: Fix false positives

This bug reported by kmemcheck as follows:

WARNING: kmemcheck: Caught 8-bit read from uninitialized memory (de811460)
0000000000000000000000000000000000000000000000000000000000000000
 u u u u u u u u u u u u u u u u u u u u u u u u u u u u u u u u
 ^

Pid: 1, comm: swapper Not tainted (2.6.27.45-WR3.0.3zz_standard-00027-gc7664fb #2)
EIP: 0060:[<c043d646>] EFLAGS: 00010246 CPU: 0
EIP is at generic_create_cred+0x66/0xc0
EAX: 00000000 EBX: 00000001 ECX: fffefe3a EDX: 00000000
ESI: de811420 EDI: df055cd4 EBP: df055c84 ESP: c06050e8
 DS: 007b ES: 007b FS: 0000 GS: 0000 SS: 0068
CR0: 8005003b CR2: df00b030 CR3: 005f9000 CR4: 000006d0
DR0: 00000000 DR1: 00000000 DR2: 00000000 DR3: 00000000
DR6: ffff4ff0 DR7: 00000400
 [<c043cb19>] rpcauth_lookup_credcache+0x179/0x260
 [<c043d6ad>] generic_lookup_cred+0xd/0x10
 [<c043d553>] rpc_lookup_machine_cred+0x43/0x60
 [<c01f95fe>] nfs_get_client+0x29e/0x470
 [<c01fa50d>] nfs_create_server+0x8d/0x730
 [<c0204dbe>] nfs_get_sb+0x57e/0x9f0
 [<c0181b59>] vfs_kern_mount+0x59/0x120
 [<c0181c79>] do_kern_mount+0x39/0xe0
 [<c0199fd7>] do_new_mount+0x67/0x90
 [<c019aeca>] do_mount+0x1da/0x1f0
 [<c019af69>] sys_mount+0x89/0xc0
 [<c05b8953>] do_mount_root+0x26/0x9e
 [<c05b8d84>] mount_root+0xea/0xf3
 [<c05b8eda>] prepare_namespace+0x14d/0x1b3
 [<c05b8283>] kernel_init+0xbd/0xd6
 [<c0103673>] kernel_thread_helper+0x7/0x14
 [<ffffffff>] 0xffffffff

Signed-Off-By: Zumeng Chen <zumeng.chen@windriver.com>
---
 include/linux/sunrpc/auth.h |    3 +++
 net/sunrpc/auth_generic.c   |    2 ++
 2 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/include/linux/sunrpc/auth.h b/include/linux/sunrpc/auth.h
index 996df4d..7bc1084 100644
--- a/include/linux/sunrpc/auth.h
+++ b/include/linux/sunrpc/auth.h
@@ -17,6 +17,7 @@
 
 #include <asm/atomic.h>
 #include <linux/rcupdate.h>
+#include <linux/kmemcheck.h>
 
 /* size of the nodename buffer */
 #define UNX_MAXNODENAME	32
@@ -26,7 +27,9 @@ struct auth_cred {
 	uid_t	uid;
 	gid_t	gid;
 	struct group_info *group_info;
+	kmemcheck_bitfield_begin(flags);
 	unsigned char machine_cred : 1;
+	kmemcheck_bitfield_end(flags);
 };
 
 /*
diff --git a/net/sunrpc/auth_generic.c b/net/sunrpc/auth_generic.c
index 8f623b0..1772fd5 100644
--- a/net/sunrpc/auth_generic.c
+++ b/net/sunrpc/auth_generic.c
@@ -50,6 +50,7 @@ struct rpc_cred *rpc_lookup_machine_cred(void)
 		.machine_cred = 1,
 	};
 
+	kmemcheck_annotate_bitfield(&acred,flags);
 	dprintk("RPC:       looking up machine cred\n");
 	return generic_auth.au_ops->lookup_cred(&generic_auth, &acred, 0);
 }
@@ -87,6 +88,7 @@ generic_create_cred(struct rpc_auth *auth, struct auth_cred *acred, int flags)
 	if (gcred == NULL)
 		return ERR_PTR(-ENOMEM);
 
+	kmemcheck_annotate_bitfield(&(gcred->acred),flags);
 	rpcauth_init_cred(&gcred->gc_base, acred, &generic_auth, &generic_credops);
 	gcred->gc_base.cr_flags = 1UL << RPCAUTH_CRED_UPTODATE;
 
-- 
1.6.5.2

