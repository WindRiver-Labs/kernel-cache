From fe90b7b2e0c84c72153485fb5c3857443ca60cb5 Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Sat, 3 Jul 2010 01:06:09 +0800
Subject: [PATCH] wrnote: make the data structs consistent on mips64 n32 and o32 ABI

When saving NT_WR_PRPSINFO and NT_WR_PRSTATUS notes, "fs/wrnote.c"
uses data passed by "fs/binfmt_elf.c", in common cases, they use
consistent data structs: elf_prstatus and elf_prpsinfo, which are
defined in "include/linux/elfcore.h".

But on mips64 n32 or o32 ABI, "fs/binfmt_elf.c" uses different
structs elf_prstatus and elf_prpsinfo with "fs/wrnote.c", which
are defined in "arch/mips/kernel/binfmt_elfn32.c"
or "arch/mips/kernel/binfmt_elfo32.c". This leads "fs/wrnote.c"
save wrong data in core file.

To avoid saving wrong data, we overwrite the data structs in
"fs/wrnote.c" to make the data structs consistent with n32 and o32

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 fs/wrnote.c |   43 +++++++++++++++++++++++++++++++++++++++++++
 1 files changed, 43 insertions(+), 0 deletions(-)

diff --git a/fs/wrnote.c b/fs/wrnote.c
index 4d149bd..d02689b 100644
--- a/fs/wrnote.c
+++ b/fs/wrnote.c
@@ -22,6 +22,49 @@ modification history
 #include <linux/wrnote.h>	/* for WR note types */
 #include <linux/wrs_sys_info.h> /* for SYS_INFO macros */
 
+#if defined(CONFIG_64BIT) && (defined(CONFIG_MIPS32_N32) || defined(CONFIG_MIPS32_O32))
+#include <linux/compat.h>
+
+/* following should consist with  arch/mips/kernel/binfmt_elfo32.c
+ * and arch/mips/kernel/binfmt_elfn32.c
+ */
+
+#define elf_prstatus elf_prstatus32
+struct elf_prstatus32
+{
+	struct elf_siginfo pr_info;	/* Info associated with signal */
+	short	pr_cursig;		/* Current signal */
+	unsigned int pr_sigpend;	/* Set of pending signals */
+	unsigned int pr_sighold;	/* Set of held signals */
+	pid_t	pr_pid;
+	pid_t	pr_ppid;
+	pid_t	pr_pgrp;
+	pid_t	pr_sid;
+	struct compat_timeval pr_utime;	/* User time */
+	struct compat_timeval pr_stime;	/* System time */
+	struct compat_timeval pr_cutime;/* Cumulative user time */
+	struct compat_timeval pr_cstime;/* Cumulative system time */
+	elf_gregset_t pr_reg;	/* GP registers */
+	int pr_fpvalid;		/* True if math co-processor being used.  */
+};
+
+#define elf_prpsinfo elf_prpsinfo32
+struct elf_prpsinfo32
+{
+	char	pr_state;	/* numeric process state */
+	char	pr_sname;	/* char for pr_state */
+	char	pr_zomb;	/* zombie */
+	char	pr_nice;	/* nice val */
+	unsigned int pr_flag;	/* flags */
+	__kernel_uid_t	pr_uid;
+	__kernel_gid_t	pr_gid;
+	pid_t	pr_pid, pr_ppid, pr_pgrp, pr_sid;
+	/* Lots missing */
+	char	pr_fname[16];	/* filename of executable */
+	char	pr_psargs[ELF_PRARGSZ];	/* initial part of arg list */
+};
+#endif
+
 /* -------------------------------- defines --------------------------------- */
 
 #define WR_GET_SIZE	1	/* get note size info */
-- 
1.7.0.4

