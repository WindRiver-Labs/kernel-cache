From 59e21cf629654ee53722e7c2695eddefa238b86b Mon Sep 17 00:00:00 2001
From: Chris Torek <chris.torek@windriver.com>
Date: Tue, 27 Jan 2009 14:54:50 -0700
Subject: [PATCH] pad serial IPMI messages with extra zero bytes

The service processor on Sun CP3260 (Monza) board needs extra zero
bytes in order to see messages.  These are harmless on the other
systems so just add them always.

Signed-off-by: Chris Torek <chris.torek@windriver.com>
---
 drivers/char/ipmi/ipmi_serial_direct.c |   17 +++++++++++++++++
 1 files changed, 17 insertions(+), 0 deletions(-)

diff --git a/drivers/char/ipmi/ipmi_serial_direct.c b/drivers/char/ipmi/ipmi_serial_direct.c
index 728c72e..56955d0 100644
--- a/drivers/char/ipmi/ipmi_serial_direct.c
+++ b/drivers/char/ipmi/ipmi_serial_direct.c
@@ -256,6 +256,12 @@ static unsigned char ipmb_checksum(unsigned char *data, int size)
 #define DM_PACKET_HANDSHAKE	0xA6
 #define DM_DATA_ESCAPE_CHAR	0xAA
 
+/*
+ * This number came as a result of SunOS IPMI serial code
+ * investigation.
+ */
+#define SUN_CP3260_ZEROS_PADDING	100
+
 static void format_msg(struct ipmi_serial_codec_data *data,
 		       const unsigned char *msg, unsigned int msg_len)
 {
@@ -297,6 +303,17 @@ static void format_msg(struct ipmi_serial_codec_data *data,
 
 	}
 	c[len++] = 0xA5;
+
+	/*
+	 * Add zeros at the back of the packet. This is needed for Sun CP3260
+	 * Monza boards in order to get a reply from IPMC. Otherwise SIGIO
+	 * signal won't be delivered on Service Processor to the interested
+	 * parties and no reply from IPMC will be sent through the virtual
+	 * channel.
+	 */
+	for (i = 0; i < SUN_CP3260_ZEROS_PADDING; i++)
+		c[len++] = 0x0;
+
 	data->xmit_chars_len = len;
 	data->xmit_chars_pos = 0;
 }
-- 
1.6.0.3

