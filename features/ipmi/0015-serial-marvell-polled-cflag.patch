From b01dcb4517f657a91e77a979867998699df09cb4 Mon Sep 17 00:00:00 2001
From: Jonathan Fournier <jonathan.fournier@windriver.com>
Date: Wed, 3 Sep 2008 18:38:39 -0400
Subject: [PATCH] serial marvell polled cflag

The polled support relocates the assignment of the mpsc_reg.cons, but it
comes after the 1st port is registered.  So when that port gets registered,
it has no drv->cons setting, which in turn means that the cflag data that
was created based on the initial bootup settings of the port don't get
preserved/copied into the termios->c_cflag, and so you loose your baud
rate, etc etc.

The original comment was partially correct, in that if you set it too
early, then it tries to use it before the port is configured, so we
go back and fill in the port->cons values after 95% of init is done.

Signed-off-by: Wally Gleemer <Wally.Gleemer@windriver.com>
Integrated-by: Jonathan Fournier <jonathan.fournier@windriver.com>
---
 drivers/serial/mpsc.c |    8 ++++++--
 1 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/serial/mpsc.c b/drivers/serial/mpsc.c
index 160268c..638d59f 100644
--- a/drivers/serial/mpsc.c
+++ b/drivers/serial/mpsc.c
@@ -1902,13 +1902,17 @@ static void mpsc_polled_init(void)
 		spin_lock_init(&mpsc_ports[i].port.lock);
 
 		mpsc_ports[i].port.ops = &mpsc_pops;
+		mpsc_ports[i].port.cons = MPSC_CONSOLE;
 		mpsc_pollable_ports[i] = &mpsc_ports[i].port;
 	}
 	mpsc_reg.pollable_ports = mpsc_pollable_ports;
 	mpsc_reg.nr_pollable = MPSC_NUM_CTLRS;
 	/*
-	 * Wait until here to set cons, so the uart_add_one_port calls
-	 * won't do a console add before we are ready.
+	 * You shouldn't wait until here to set mpsc_reg.cons because the 1st
+	 * port through the uart_add_one_port call won't have a dev->cons
+	 * and hence port->cflags won't get copied to termios->c_cflags.
+	 * So you loose all settings the serial port was initialized with.
+	 * This is why we also assign MPSC_CONSOLE to each port above.
 	 */
 	mpsc_reg.cons = MPSC_CONSOLE;
 	uart_register_polled(&mpsc_reg);
-- 
1.5.5.1

