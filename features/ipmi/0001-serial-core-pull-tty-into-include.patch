From da1dfc8d616f57287e7c36bb8b3ee31db0d7e7b4 Mon Sep 17 00:00:00 2001
From: Jonathan Fournier <jonathan.fournier@windriver.com>
Date: Wed, 3 Sep 2008 18:38:25 -0400
Subject: [PATCH] serial core pull tty into include

Remove the requirement for a serial driver to know about the
tty layer by pulling the tty push into a function in the serial_core.h
file.  Also make the corresponding changes to the 8250 driver.

This is needed for a direct serial interface to be used by IPMI and a
common serial console driver (and probably other things like kgdb).
Since in those cases there is no tty layer, it is best to pull this up
into the serial core and handle not having a tty layer there.  Also,
it seems better if the individual serial drivers didn't need to know
about the tty layer.

Signed-off-by: Corey Minyard <minyard@acm.org>
Integrated-by: Jonathan Fournier <jonathan.fournier@windriver.com>
---
 drivers/serial/8250.c       |    5 +----
 include/linux/serial_core.h |    6 ++++++
 2 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/drivers/serial/8250.c b/drivers/serial/8250.c
index d725ca9..46a3110 100644
--- a/drivers/serial/8250.c
+++ b/drivers/serial/8250.c
@@ -30,8 +30,6 @@
 #include <linux/sysrq.h>
 #include <linux/delay.h>
 #include <linux/platform_device.h>
-#include <linux/tty.h>
-#include <linux/tty_flip.h>
 #include <linux/serial_reg.h>
 #include <linux/serial_core.h>
 #include <linux/serial.h>
@@ -1287,7 +1285,6 @@ static void serial8250_enable_ms(struct uart_port *port)
 static void
 receive_chars(struct uart_8250_port *up, unsigned int *status)
 {
-	struct tty_struct *tty = up->port.info->port.tty;
 	unsigned char ch, lsr = *status;
 	int max_count = 256;
 	char flag;
@@ -1355,7 +1352,7 @@ ignore_char:
 		lsr = serial_inp(up, UART_LSR);
 	} while ((lsr & (UART_LSR_DR | UART_LSR_BI)) && (max_count-- > 0));
 	spin_unlock(&up->port.lock);
-	tty_flip_buffer_push(tty);
+	uart_push(&up->port);
 	spin_lock(&up->port.lock);
 	*status = lsr;
 }
diff --git a/include/linux/serial_core.h b/include/linux/serial_core.h
index 3b2f6c0..779209f 100644
--- a/include/linux/serial_core.h
+++ b/include/linux/serial_core.h
@@ -552,6 +552,12 @@ uart_insert_char(struct uart_port *port, unsigned int status,
 		tty_insert_flip_char(tty, 0, TTY_OVERRUN);
 }
 
+static inline void
+uart_push(struct uart_port *port)
+{
+	tty_flip_buffer_push(port->info->tty);
+}
+
 /*
  *	UART_ENABLE_MS - determine if port should enable modem status irqs
  */
-- 
1.5.5.1

