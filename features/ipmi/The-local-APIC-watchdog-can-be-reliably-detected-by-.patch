From b457b194f686f3afd17b37b70c0e0a3e664b9771 Mon Sep 17 00:00:00 2001
From: Corey Minyard <cminyard@mvista.com>
Date: Mon, 3 May 2010 13:37:11 -0400
Subject: [PATCH] The local APIC watchdog can be reliably detected by the code, and
 is much more common, and may interfere with the IPMI NMI watchdog.
 So detect it first.

Signed-off-by: Corey Minyard <cminyard@mvista.com>
---
 arch/x86/kernel/apic/nmi.c |   23 ++++++++++++-----------
 1 files changed, 12 insertions(+), 11 deletions(-)

diff --git a/arch/x86/kernel/apic/nmi.c b/arch/x86/kernel/apic/nmi.c
index 395f571..42996a2 100644
--- a/arch/x86/kernel/apic/nmi.c
+++ b/arch/x86/kernel/apic/nmi.c
@@ -404,13 +404,21 @@ nmi_watchdog_tick(struct pt_regs *regs, unsigned reason)
 	int cpu = smp_processor_id();
 	int rc = 0;
 
-	/* check for other users first */
+	/* see if the local APIC nmi watchdog went off. */
+	if (__get_cpu_var(wd_enabled) && nmi_watchdog == NMI_LOCAL_APIC) {
+		rc = lapic_wd_event(nmi_hz);
+		if (rc)
+			goto skip_notify;
+	}
+
+	/* check for other users after the local APIC */
 	if (notify_die(DIE_NMI, "nmi", regs, reason, 2, SIGINT)
 			== NOTIFY_STOP) {
 		rc = 1;
 		touched = 1;
 	}
 
+ skip_notify:
 	sum = get_timer_irqs(cpu);
 
 	if (__get_cpu_var(nmi_touch)) {
@@ -463,22 +471,15 @@ nmi_watchdog_tick(struct pt_regs *regs, unsigned reason)
 		__this_cpu_write(alert_counter, 0);
 	}
 
-	/* see if the nmi watchdog went off */
-	if (!__get_cpu_var(wd_enabled))
-		return rc;
-	switch (nmi_watchdog) {
-	case NMI_LOCAL_APIC:
-		rc |= lapic_wd_event(nmi_hz);
-		break;
-	case NMI_IO_APIC:
+	/* see if the IO APIC nmi watchdog went off */
+	if (__get_cpu_var(wd_enabled) && (nmi_watchdog == NMI_IO_APIC))
 		/*
 		 * don't know how to accurately check for this.
 		 * just assume it was a watchdog timer interrupt
 		 * This matches the old behaviour.
 		 */
 		rc = 1;
-		break;
-	}
+
 	return rc;
 }
 
-- 
1.6.5.2

