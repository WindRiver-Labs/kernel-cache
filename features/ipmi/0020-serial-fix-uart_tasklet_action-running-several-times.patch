From a9636fbaaecd05ea23e4b3832c4f293f65fc54e2 Mon Sep 17 00:00:00 2001
From: Lans Zhang <jia.zhang@windriver.com>
Date: Fri, 11 Sep 2009 17:20:37 +0800
Subject: [PATCH] serial: fix uart_tasklet_action running several times simultaneously

uart_tasklet_action() is scheduled several times, which makes
tasklet_action() captures a BUG(). To fix the problem, uart_get()
never re-initilize a scheduled tasklet.

Signed-off-by: Lans Zhang <jia.zhang@windriver.com>
---
 drivers/serial/serial_core.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/serial/serial_core.c b/drivers/serial/serial_core.c
index 6230b28..501c2cc 100644
--- a/drivers/serial/serial_core.c
+++ b/drivers/serial/serial_core.c
@@ -1701,16 +1701,18 @@ static struct uart_state *uart_get(struct uart_driver *drv, int line)
 			 * Link the info into the other structures.
 			 */
 			state->port->info = state->info;
+#ifndef CONFIG_SERIAL_POLL_API
+			tasklet_init(&state->info->tlet, uart_tasklet_action,
+					(unsigned long)state);
+#endif
 		}
 
 #ifdef CONFIG_SERIAL_POLL_API
 	}
 
 	if (!(state->info->flags & UIF_TASKLET_SETUP)) {
-#endif
 		tasklet_init(&state->info->tlet, uart_tasklet_action,
 			     (unsigned long)state);
-#ifdef CONFIG_SERIAL_POLL_API
 		state->info->flags |= UIF_TASKLET_SETUP;
 	}
 #endif
-- 
1.6.3.3

