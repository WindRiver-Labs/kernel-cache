From 5b8b3aad6db03feb3904127fb628d00c0b59e9f5 Mon Sep 17 00:00:00 2001
From: Harry Ciao <qingtao.cao@windriver.com>
Date: Fri, 15 May 2009 11:36:57 +0800
Subject: [PATCH] OOM protection bytes in PAGE_SIZE

The total_vm is in the unit of PAGE_SIZE, so a process's OOM protection
bytes should be translated into PAGE_SIZE as well when comparing with
its total_vm.

Signed-off-by: Harry Ciao <qingtao.cao@windriver.com>
---
 mm/oom_kill.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/mm/oom_kill.c b/mm/oom_kill.c
index 839e3f1..8522a0e 100644
--- a/mm/oom_kill.c
+++ b/mm/oom_kill.c
@@ -84,7 +84,9 @@ unsigned long badness(struct task_struct *p, unsigned long uptime)
 	 * (these guys?) safe for a while until we determine that there are
 	 * *only* well-behaved processes left, then start killing the biggest
 	 * offenders of that bunch. */
-	if (p->mm->total_vm < p->mm->oom_protect_bytes) {
+
+	/* mm->total_vm in pages */
+	if (p->mm->total_vm < (p->mm->oom_protect_bytes / PAGE_SIZE)) {
 		task_unlock(p);
 		return 0;
 	}
-- 
1.6.3.3

