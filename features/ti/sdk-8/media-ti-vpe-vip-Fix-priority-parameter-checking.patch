From e7297235b6d3996fae3cf684edcab0ad5adb19b4 Mon Sep 17 00:00:00 2001
From: Benoit Parrot <bparrot@ti.com>
Date: Mon, 10 Nov 2014 12:14:17 -0600
Subject: [PATCH 1326/1587] media: ti-vpe: vip: Fix priority parameter
 checking

v4l2-compliance: default_oictl parameter checking was failing

Signed-off-by: Benoit Parrot <bparrot@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/media/platform/ti-vpe/vip.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/drivers/media/platform/ti-vpe/vip.c b/drivers/media/platform/ti-vpe/vip.c
index c6563a7..c3990ab 100644
--- a/drivers/media/platform/ti-vpe/vip.c
+++ b/drivers/media/platform/ti-vpe/vip.c
@@ -1514,6 +1514,14 @@ static int vip_s_selection(struct file *file, void *fh,
 static long vip_ioctl_default(struct file *file, void *fh, bool valid_prio,
 			      unsigned int cmd, void *arg)
 {
+	struct vip_stream *stream = file2stream(file);
+	struct vip_port *port = stream->port;
+
+	if (!valid_prio) {
+		vip_err(port->dev, "%s device busy\n", __func__);
+		return -EBUSY;
+	}
+
 	switch (cmd) {
 	default:
 		return -ENOTTY;
@@ -2022,6 +2030,7 @@ static int alloc_stream(struct vip_port *port, int stream_id, int vfl_type)
 	*vfd = vip_videodev;
 	vfd->v4l2_dev = &dev->v4l2_dev;
 	vfd->queue = q;
+	set_bit(V4L2_FL_USE_FH_PRIO, &vfd->flags);
 
 	vfd->lock = &dev->mutex;
 	video_set_drvdata(vfd, stream);
-- 
1.7.5.4

