From 2cd8d974a53bbde3a65bfd1541f52445d8489e73 Mon Sep 17 00:00:00 2001
From: Peter Ujfalusi <peter.ujfalusi@ti.com>
Date: Thu, 28 Aug 2014 17:26:06 +0000
Subject: [PATCH 1132/1587] ASoC: davinci-evm: Support for DRA7-EVM board

DRA7 uses sDMA compared to other platforms using the davinci-evm machine
driver.
sDMA (omap-pcm) platform driver is using dmaengine while eDMA still using
legacy DMA code.
Do not set .platform_of_node in case the .platform_name has been set in the
snd_soc_dai_link indicating that the machine is using omap-pcm for platform
driver.
On DRA7-EVM the audio clock is sourced from ATL2 clock and the board is
limited to 44.1KHz sampling rate.

Signed-off-by: Peter Ujfalusi <peter.ujfalusi@ti.com>
Signed-off-by: Darren Etheridge <detheridge@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 sound/soc/davinci/davinci-evm.c |   55 ++++++++++++++++++++++++++++++++++++++-
 1 files changed, 54 insertions(+), 1 deletions(-)

diff --git a/sound/soc/davinci/davinci-evm.c b/sound/soc/davinci/davinci-evm.c
index 3d0acba2a..b9010c9 100644
--- a/sound/soc/davinci/davinci-evm.c
+++ b/sound/soc/davinci/davinci-evm.c
@@ -49,6 +49,37 @@ static int evm_startup(struct snd_pcm_substream *substream)
 	return 0;
 }
 
+static int dra7xx_evm_startup(struct snd_pcm_substream *substream)
+{
+	snd_pcm_hw_constraint_minmax(substream->runtime,
+				     SNDRV_PCM_HW_PARAM_RATE, 44100, 44100);
+
+	return evm_startup(substream);
+}
+
+static int dra7xx_evm_hw_params(struct snd_pcm_substream *substream,
+				     struct snd_pcm_hw_params *params)
+{
+	struct snd_soc_pcm_runtime *rtd = substream->private_data;
+	struct snd_soc_dai *codec_dai = rtd->codec_dai;
+	struct snd_soc_dai *cpu_dai = rtd->cpu_dai;
+	struct snd_soc_card *soc_card = rtd->card;
+	struct snd_soc_card_drvdata_davinci *drvdata =
+		snd_soc_card_get_drvdata(soc_card);
+	int ret;
+
+	/* Set MCLK as clock source for tlv320aic3106 */
+	ret = snd_soc_dai_set_sysclk(codec_dai, 0, drvdata->sysclk,
+				     SND_SOC_CLOCK_IN);
+	if (ret < 0)
+		return ret;
+
+	/* Set McASP sysclk from AHCLKX sourced from ATL */
+	ret = snd_soc_dai_set_sysclk(cpu_dai, 0, drvdata->sysclk,
+				     SND_SOC_CLOCK_IN);
+	return ret;
+}
+
 static void evm_shutdown(struct snd_pcm_substream *substream)
 {
 	struct snd_soc_pcm_runtime *rtd = substream->private_data;
@@ -124,6 +155,12 @@ static struct snd_soc_ops evm_tda998x_ops = {
 	.hw_params = evm_tda998x_hw_params,
 };
 
+static struct snd_soc_ops dra7xx_ops = {
+	.startup = dra7xx_evm_startup,
+	.shutdown = evm_shutdown,
+	.hw_params = dra7xx_evm_hw_params,
+};
+
 /* davinci-evm machine dapm widgets */
 static const struct snd_soc_dapm_widget aic3x_dapm_widgets[] = {
 	SND_SOC_DAPM_HP("Headphone Jack", NULL),
@@ -421,6 +458,16 @@ static struct snd_soc_dai_link evm_dai_tda998x_hdmi = {
 			   SND_SOC_DAIFMT_IB_NF),
 };
 
+static struct snd_soc_dai_link dra7xx_evm_link = {
+	.name		= "TLV320AIC3X",
+	.stream_name	= "AIC3X",
+	.codec_dai_name	= "tlv320aic3x-hifi",
+	.ops            = &dra7xx_ops,
+	.init           = evm_aic3x_init,
+	.dai_fmt = SND_SOC_DAIFMT_DSP_B | SND_SOC_DAIFMT_CBS_CFS |
+		   SND_SOC_DAIFMT_IB_NF,
+};
+
 static const struct of_device_id davinci_evm_dt_ids[] = {
 	{
 		.compatible = "ti,da830-evm-audio",
@@ -430,6 +477,10 @@ static const struct of_device_id davinci_evm_dt_ids[] = {
 		.compatible = "ti,beaglebone-black-audio",
 		.data = &evm_dai_tda998x_hdmi,
 	},
+	{
+		.compatible = "ti,dra7xx-evm-audio",
+		.data = (void *) &dra7xx_evm_link,
+	},
 	{ /* sentinel */ }
 };
 MODULE_DEVICE_TABLE(of, davinci_evm_dt_ids);
@@ -460,7 +511,9 @@ static int davinci_evm_probe(struct platform_device *pdev)
 	if (!dai->cpu_of_node)
 		return -EINVAL;
 
-	dai->platform_of_node = dai->cpu_of_node;
+	/* Only set the platform_of_node if the platform_name is not set */
+	if (!dai->platform_name)
+		dai->platform_of_node = dai->cpu_of_node;
 
 	evm_soc_card.dev = &pdev->dev;
 	ret = snd_soc_of_parse_card_name(&evm_soc_card, "ti,model");
-- 
1.7.5.4

