From cf2941fbf780d15ed16efb3fb405ef5cc04a9090 Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Fri, 8 Aug 2014 16:55:41 -0500
Subject: [PATCH 0959/1587] ARM: OMAP2: sleep33xx: Adjust EMIF save sequencing
 during suspend

Adjust the sequence of the emif context save path and make sure to save
the EMIF_PWR_MGMT registers otherwise DDR2 systems are unable to resume.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 arch/arm/mach-omap2/sleep33xx.S |    8 +++++++-
 1 files changed, 7 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-omap2/sleep33xx.S b/arch/arm/mach-omap2/sleep33xx.S
index 7631cd5..e4e6be0 100644
--- a/arch/arm/mach-omap2/sleep33xx.S
+++ b/arch/arm/mach-omap2/sleep33xx.S
@@ -92,7 +92,10 @@ ENTRY(am33xx_do_wfi)
 
 	/* Need to load emif addr for context save and self refresh */
 	ldr	r0, emif_addr_virt
-	ldr	r1, [r0, #EMIF_SDRAM_REFRESH_CONTROL]
+	ldr     r1, [r0, #EMIF_POWER_MANAGEMENT_CONTROL]
+	str     r1, emif_pmcr_val
+	ldr     r1, [r0, #EMIF_POWER_MANAGEMENT_CTRL_SHDW]
+	str     r1, emif_pmcr_shdw_val
 
 	/* Only necessary if PER is losing context */
 	ldr	r2, wfi_flags
@@ -100,6 +103,7 @@ ENTRY(am33xx_do_wfi)
 	beq	skip_save_emif
 
 	/* Save EMIF configuration */
+	ldr	r1, [r0, #EMIF_SDRAM_REFRESH_CONTROL]
 	str	r1, emif_ref_ctrl_val
 	ldr	r1, [r0, #EMIF_SDRAM_TIMING_1]
 	str	r1, emif_timing1_val
@@ -376,6 +380,8 @@ emif_timing2_val:
 	.word	0xDEADBEEF
 emif_timing3_val:
 	.word	0xDEADBEEF
+emif_sdcfg_val:
+	.word   0xDEADBEEF
 emif_ref_ctrl_val:
 	.word	0xDEADBEEF
 emif_zqcfg_val:
-- 
1.7.5.4

