From 422b3fb1d1c40a6fe64ec3aacbf7766f808c9069 Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Wed, 30 Jul 2014 22:41:59 -0500
Subject: [PATCH 0914/1587] ARM: OMAP2+: Hookup AM437x PM

Required changes have been made to am33xx PM code so enable
use for am43xx.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 arch/arm/mach-omap2/Kconfig  |    1 +
 arch/arm/mach-omap2/Makefile |    2 ++
 arch/arm/mach-omap2/common.h |    4 +++-
 arch/arm/mach-omap2/io.c     |    2 ++
 arch/arm/mach-omap2/sram.c   |   15 +++++++++++++++
 5 files changed, 23 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-omap2/Kconfig b/arch/arm/mach-omap2/Kconfig
index 89848d9..aa4de75 100644
--- a/arch/arm/mach-omap2/Kconfig
+++ b/arch/arm/mach-omap2/Kconfig
@@ -68,6 +68,7 @@ config SOC_AM43XX
 	select MACH_OMAP_GENERIC
 	select HAVE_ARM_SCU
 	select MIGHT_HAVE_CACHE_L2X0
+	select WKUP_M3_RPROC if PM
 
 config SOC_DRA7XX
 	bool "TI DRA7XX"
diff --git a/arch/arm/mach-omap2/Makefile b/arch/arm/mach-omap2/Makefile
index 7814958..f8bcdb3 100644
--- a/arch/arm/mach-omap2/Makefile
+++ b/arch/arm/mach-omap2/Makefile
@@ -94,6 +94,7 @@ obj-$(CONFIG_ARCH_OMAP4)		+= pm44xx.o omap-mpuss-lowpower.o
 obj-$(CONFIG_SOC_OMAP5)			+= omap-mpuss-lowpower.o
 obj-$(CONFIG_SOC_DRA7XX)		+= omap-mpuss-lowpower.o
 obj-$(CONFIG_SOC_AM33XX)		+= pm33xx.o sleep33xx.o
+obj-$(CONFIG_SOC_AM43XX)		+= pm33xx.o sleep43xx.o
 obj-$(CONFIG_PM_DEBUG)			+= pm-debug.o
 
 obj-$(CONFIG_POWER_AVS_OMAP)		+= sr_device.o
@@ -102,6 +103,7 @@ obj-$(CONFIG_POWER_AVS_OMAP_CLASS3)    += smartreflex-class3.o
 AFLAGS_sleep24xx.o			:=-Wa,-march=armv6
 AFLAGS_sleep34xx.o			:=-Wa,-march=armv7-a$(plus_sec)
 AFLAGS_sleep33xx.o			:=-Wa,-march=armv7-a$(plus_sec)
+AFLAGS_sleep43xx.o			:=-Wa,-march=armv7-a$(plus_sec)
 
 endif
 
diff --git a/arch/arm/mach-omap2/common.h b/arch/arm/mach-omap2/common.h
index 978c14c..e5487d8 100644
--- a/arch/arm/mach-omap2/common.h
+++ b/arch/arm/mach-omap2/common.h
@@ -75,7 +75,8 @@ static inline int omap4_pm_init_early(void)
 }
 #endif
 
-#if defined(CONFIG_PM) && defined(CONFIG_SOC_AM33XX)
+#if defined(CONFIG_PM) && \
+	(defined(CONFIG_SOC_AM33XX) || defined(CONFIG_SOC_AM43XX))
 int am33xx_pm_init(void);
 #else
 static inline int am33xx_pm_init(void)
@@ -126,6 +127,7 @@ void omap3630_init_late(void);
 void am35xx_init_late(void);
 void ti81xx_init_late(void);
 void am33xx_init_late(void);
+void am43xx_init_late(void);
 void omap5_init_late(void);
 int omap2_common_pm_late_init(void);
 void dra7xx_init_early(void);
diff --git a/arch/arm/mach-omap2/io.c b/arch/arm/mach-omap2/io.c
index 8e95c24..8291e31 100644
--- a/arch/arm/mach-omap2/io.c
+++ b/arch/arm/mach-omap2/io.c
@@ -620,6 +620,8 @@ void __init am43xx_init_late(void)
 {
 	am43xx_opp_init();
 	omap_common_late_init();
+	am33xx_pm_init();
+	omap2_clk_enable_autoidle_all();
 }
 #endif
 
diff --git a/arch/arm/mach-omap2/sram.c b/arch/arm/mach-omap2/sram.c
index 83f5f3a..13cf863 100644
--- a/arch/arm/mach-omap2/sram.c
+++ b/arch/arm/mach-omap2/sram.c
@@ -298,6 +298,19 @@ static inline int am33xx_sram_init(void)
 }
 #endif
 
+#ifdef CONFIG_SOC_AM43XX
+static inline int am43xx_sram_init(void)
+{
+	am43xx_push_sram_idle();
+	return 0;
+}
+#else
+static inline int am43xx_sram_init(void)
+{
+	return 0;
+}
+#endif
+
 int __init omap_sram_init(void)
 {
 	omap_detect_sram();
@@ -309,6 +322,8 @@ int __init omap_sram_init(void)
 		omap243x_sram_init();
 	else if (soc_is_am33xx())
 		am33xx_sram_init();
+	else if (soc_is_am43xx())
+		am43xx_sram_init();
 	else if (cpu_is_omap34xx())
 		omap34xx_sram_init();
 
-- 
1.7.5.4

