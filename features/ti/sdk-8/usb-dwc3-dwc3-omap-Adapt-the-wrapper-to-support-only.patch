From be4b344a3472ca813bc9ebe91190c3fcb4d8d897 Mon Sep 17 00:00:00 2001
From: George Cherian <george.cherian@ti.com>
Date: Fri, 12 Sep 2014 15:31:03 +0530
Subject: [PATCH 1186/1587] usb: dwc3: dwc3-omap: Adapt the wrapper to support
 only ID pin detection

DRA7x boards have only ID pin detection. Change the UTMI states accordingly
using only ID pin changes. Since there are no VBUS detection logic
it's assumed to have VBUS/SESSION valid when ID-pin is float.

Signed-off-by: George Cherian <george.cherian@ti.com>
Signed-off-by: Sekhar Nori <nsekhar@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/usb/dwc3/dwc3-omap.c |   17 ++++++++++++++---
 1 files changed, 14 insertions(+), 3 deletions(-)

diff --git a/drivers/usb/dwc3/dwc3-omap.c b/drivers/usb/dwc3/dwc3-omap.c
index 478f7a3..72c0799 100644
--- a/drivers/usb/dwc3/dwc3-omap.c
+++ b/drivers/usb/dwc3/dwc3-omap.c
@@ -127,6 +127,7 @@ struct dwc3_omap {
 	u32			irq0_offset;
 
 	u32			dma_status:1;
+	u32			id_detect_only:1;
 
 	struct extcon_specific_cable_nb extcon_vbus_dev;
 	struct extcon_specific_cable_nb extcon_id_dev;
@@ -357,10 +358,15 @@ static int dwc3_omap_id_notifier(struct notifier_block *nb,
 {
 	struct dwc3_omap *omap = container_of(nb, struct dwc3_omap, id_nb);
 
-	if (event)
+	if (event) {
+		if (omap->id_detect_only)
+			dwc3_omap_set_mailbox(omap, OMAP_DWC3_VBUS_OFF);
 		dwc3_omap_set_mailbox(omap, OMAP_DWC3_ID_GROUND);
-	else
+	} else {
 		dwc3_omap_set_mailbox(omap, OMAP_DWC3_ID_FLOAT);
+		if (omap->id_detect_only)
+			dwc3_omap_set_mailbox(omap, OMAP_DWC3_VBUS_VALID);
+	}
 
 	return NOTIFY_DONE;
 }
@@ -438,8 +444,10 @@ static int dwc3_omap_extcon_register(struct dwc3_omap *omap)
 		ret = extcon_register_interest(&omap->extcon_vbus_dev,
 					       edev->name, "USB",
 					       &omap->vbus_nb);
-		if (ret < 0)
+		if (ret < 0) {
+			omap->id_detect_only = 1;
 			dev_vdbg(omap->dev, "failed to register notifier for USB\n");
+		}
 
 		omap->id_nb.notifier_call = dwc3_omap_id_notifier;
 		ret = extcon_register_interest(&omap->extcon_id_dev,
@@ -448,10 +456,13 @@ static int dwc3_omap_extcon_register(struct dwc3_omap *omap)
 		if (ret < 0)
 			dev_vdbg(omap->dev, "failed to register notifier for USB-HOST\n");
 
+
 		if (extcon_get_cable_state(edev, "USB") == true)
 			dwc3_omap_set_mailbox(omap, OMAP_DWC3_VBUS_VALID);
 		if (extcon_get_cable_state(edev, "USB-HOST") == true)
 			dwc3_omap_set_mailbox(omap, OMAP_DWC3_ID_GROUND);
+		else if (omap->id_detect_only)
+			dwc3_omap_set_mailbox(omap, OMAP_DWC3_VBUS_VALID);
 	}
 
 	return 0;
-- 
1.7.5.4

