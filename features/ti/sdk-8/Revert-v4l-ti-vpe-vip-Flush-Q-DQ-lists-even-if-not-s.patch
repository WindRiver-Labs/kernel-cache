From 25734398f8b61764649409abbfe0ff2ce91bca32 Mon Sep 17 00:00:00 2001
From: Jyri Sarha <jsarha@ti.com>
Date: Fri, 5 Dec 2014 16:00:06 +0200
Subject: [PATCH 1483/1587] Revert "v4l: ti-vpe: vip: Flush Q/DQ lists even if
 not streaming"

This reverts commit 18825b2da37fcd29afe0a476048dede554e3a6ed.

Signed-off-by: Jyri Sarha <jsarha@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/media/platform/ti-vpe/vip.c |   16 +++++++++-------
 1 files changed, 9 insertions(+), 7 deletions(-)

diff --git a/drivers/media/platform/ti-vpe/vip.c b/drivers/media/platform/ti-vpe/vip.c
index 3f8ce88..daef984 100644
--- a/drivers/media/platform/ti-vpe/vip.c
+++ b/drivers/media/platform/ti-vpe/vip.c
@@ -1868,6 +1868,14 @@ static int vip_stop_streaming(struct vb2_queue *vq)
 	struct vip_port *port = stream->port;
 	struct vip_dev *dev = port->dev;
 	struct vip_buffer *buf;
+	unsigned long flags;
+
+	if (!vb2_is_streaming(vq))
+		return 0;
+
+	spin_lock_irqsave(&dev->slock, flags);
+	vpdma_unmap_desc_buf(dev->shared->vpdma, &dev->desc_list.buf);
+	vpdma_reset_desc_list(&dev->desc_list);
 
 	disable_irqs(dev, dev->slice_id);
 
@@ -1885,13 +1893,7 @@ static int vip_stop_streaming(struct vb2_queue *vq)
 		list_del(&buf->list);
 		vb2_buffer_done(&buf->vb, VB2_BUF_STATE_ERROR);
 	}
-
-	if (!vb2_is_streaming(vq))
-		return 0;
-
-	vpdma_unmap_desc_buf(dev->shared->vpdma, &dev->desc_list.buf);
-	vpdma_reset_desc_list(&dev->desc_list);
-
+	spin_unlock_irqrestore(&dev->slock, flags);
 	return 0;
 }
 
-- 
1.7.5.4

