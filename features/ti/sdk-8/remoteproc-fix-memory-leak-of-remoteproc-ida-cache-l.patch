From 8acb46b17d09b6829144480f8751d3b95c3966ef Mon Sep 17 00:00:00 2001
From: Suman Anna <s-anna@ti.com>
Date: Tue, 11 Nov 2014 18:06:26 -0600
Subject: [PATCH 1398/1587] remoteproc: fix memory leak of remoteproc ida
 cache layers

The remoteproc core uses an static ida named rproc_dev_index for
assigning an automatic index number to a registered remoteproc.
The ida core may allocate some internal ida cache layers upon
any ida assignment, and all these layers are truely freed only
upon the ida destruction. The rproc_dev_index ida is not destroyed
at present, leading to a minor memory leak, if the remoteproc core
is built as a module and atleast one rproc device is registered
and unregistered.

Fix this by invoking ida_destroy() in the remoteproc core module
exit.

Signed-off-by: Suman Anna <s-anna@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/remoteproc/remoteproc_core.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/remoteproc/remoteproc_core.c b/drivers/remoteproc/remoteproc_core.c
index 3459057..a9e665f 100644
--- a/drivers/remoteproc/remoteproc_core.c
+++ b/drivers/remoteproc/remoteproc_core.c
@@ -1792,6 +1792,8 @@ module_init(remoteproc_init);
 
 static void __exit remoteproc_exit(void)
 {
+	ida_destroy(&rproc_dev_index);
+
 	rproc_exit_debugfs();
 }
 module_exit(remoteproc_exit);
-- 
1.7.5.4

