From 4e3f4dd393f80db04abfc1f116da836f07a22bf5 Mon Sep 17 00:00:00 2001
From: Tomi Valkeinen <tomi.valkeinen@ti.com>
Date: Mon, 10 Nov 2014 12:23:02 +0200
Subject: [PATCH 1318/1587] drm/omap: do omap_crtc_flush on dev_lastclose

We restore fbdev mode in dev_lastclose(), but we don't wait for the
modeset to be finished. This could cause problems if the modeset
operation is still going on in the background, but a new drm application
is started.

Add omap_crtc_flush() call after restoring the fbdev mode to avoid any
issues.

Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/gpu/drm/omapdrm/omap_drv.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/omapdrm/omap_drv.c b/drivers/gpu/drm/omapdrm/omap_drv.c
index 59c1c9d..6f166a0 100644
--- a/drivers/gpu/drm/omapdrm/omap_drv.c
+++ b/drivers/gpu/drm/omapdrm/omap_drv.c
@@ -594,6 +594,12 @@ static void dev_lastclose(struct drm_device *dev)
 		drm_modeset_unlock_all(dev);
 		if (ret)
 			DBG("failed to restore crtc mode");
+		/*
+		 * Flush crtcs to finish any pending work.
+		 * This makes sure the fbdev mode has been restored.
+		 */
+		for (i = 0; i < priv->num_crtcs; i++)
+			omap_crtc_flush(priv->crtcs[i]);
 	}
 }
 
-- 
1.7.5.4

