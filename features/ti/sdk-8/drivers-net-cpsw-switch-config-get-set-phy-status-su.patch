From e93c34707b85649237ae2d5f2274a789d5b16296 Mon Sep 17 00:00:00 2001
From: Mugunthan V N <mugunthanvnm@ti.com>
Date: Thu, 7 Aug 2014 21:54:42 +0530
Subject: [PATCH 0998/1587] drivers: net: cpsw: switch-config: get/set phy
 status support

Support for get/set individual switch port phy link status

Signed-off-by: Mugunthan V N <mugunthanvnm@ti.com>
Signed-off-by: Sekhar Nori <nsekhar@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/net/ethernet/ti/cpsw.c         |   38 ++++++++++++++++++++++++++++++++
 include/uapi/linux/net_switch_config.h |    3 ++
 2 files changed, 41 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/ti/cpsw.c b/drivers/net/ethernet/ti/cpsw.c
index 5be4ae9..9019720 100644
--- a/drivers/net/ethernet/ti/cpsw.c
+++ b/drivers/net/ethernet/ti/cpsw.c
@@ -1564,6 +1564,44 @@ static int cpsw_switch_config_ioctl(struct net_device *ndev,
 	case CONFIG_SWITCH_DEL_VLAN:
 		ret = cpsw_ale_del_vlan(priv->ale, config.vid, 0);
 		break;
+	case CONFIG_SWITCH_SET_PORT_CONFIG:
+	{
+		struct phy_device *phy = NULL;
+
+		if ((config.port == 1) || (config.port == 2))
+			phy = priv->slaves[config.port-1].phy;
+
+		if (!phy) {
+			dev_err(priv->dev, "Phy not Found\n");
+			ret = -EINVAL;
+			break;
+		}
+
+		config.ecmd.phy_address = phy->addr;
+		ret = phy_ethtool_sset(phy, &config.ecmd);
+		break;
+	}
+	case CONFIG_SWITCH_GET_PORT_CONFIG:
+	{
+		struct phy_device *phy = NULL;
+
+		if ((config.port == 1) || (config.port == 2))
+			phy = priv->slaves[config.port-1].phy;
+
+		if (!phy) {
+			dev_err(priv->dev, "Phy not Found\n");
+			ret = -EINVAL;
+			break;
+		}
+
+		config.ecmd.phy_address = phy->addr;
+		ret = phy_ethtool_gset(phy, &config.ecmd);
+		if (ret)
+			break;
+		ret = copy_to_user(ifrq->ifr_data, &config, sizeof(config));
+		break;
+	}
+
 	default:
 		ret = -EOPNOTSUPP;
 	}
diff --git a/include/uapi/linux/net_switch_config.h b/include/uapi/linux/net_switch_config.h
index 9165263..f3c0b11 100644
--- a/include/uapi/linux/net_switch_config.h
+++ b/include/uapi/linux/net_switch_config.h
@@ -26,6 +26,8 @@ enum {
 	CONFIG_SWITCH_DEL_MULTICAST,
 	CONFIG_SWITCH_ADD_VLAN,
 	CONFIG_SWITCH_DEL_VLAN,
+	CONFIG_SWITCH_SET_PORT_CONFIG,
+	CONFIG_SWITCH_GET_PORT_CONFIG,
 };
 
 struct net_switch_config {
@@ -38,6 +40,7 @@ struct net_switch_config {
 	unsigned char	untag_port;	/* Untag ports */
 	unsigned char	addr[6];
 	unsigned int	super;
+	struct ethtool_cmd ecmd;
 
 	unsigned int ret_type;   /* Return  Success/Failure */
 };
-- 
1.7.5.4

