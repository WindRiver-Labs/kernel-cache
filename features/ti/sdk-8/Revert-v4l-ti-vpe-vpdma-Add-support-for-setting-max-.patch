From 395b9417de36953328b6c770b84b614c6ea6cbf0 Mon Sep 17 00:00:00 2001
From: Jyri Sarha <jsarha@ti.com>
Date: Fri, 5 Dec 2014 16:00:07 +0200
Subject: [PATCH 1484/1587] Revert "v4l: ti-vpe: vpdma: Add support for
 setting max width height"

This reverts commit 079d3170d311c23844d95a093868f4708700adf9.

Signed-off-by: Jyri Sarha <jsarha@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/media/platform/ti-vpe/vip.c        |   23 +----------------
 drivers/media/platform/ti-vpe/vpdma.c      |   34 +++++++++++--------------
 drivers/media/platform/ti-vpe/vpdma.h      |   33 ++-----------------------
 drivers/media/platform/ti-vpe/vpdma_priv.h |   36 ++++++++++++++++++++++++++++
 drivers/media/platform/ti-vpe/vpe.c        |    3 +-
 5 files changed, 57 insertions(+), 72 deletions(-)

diff --git a/drivers/media/platform/ti-vpe/vip.c b/drivers/media/platform/ti-vpe/vip.c
index daef984..b7f1b26 100644
--- a/drivers/media/platform/ti-vpe/vip.c
+++ b/drivers/media/platform/ti-vpe/vip.c
@@ -944,7 +944,6 @@ static int add_out_dtd(struct vip_stream *stream, int srce_type)
 	struct v4l2_rect *c_rect = &port->c_rect;
 	struct vip_fmt *fmt = port->fmt;
 	int channel, plane = 0;
-	int max_width, max_height;
 	dma_addr_t dma_addr;
 	u32 flags;
 
@@ -982,27 +981,9 @@ static int add_out_dtd(struct vip_stream *stream, int srce_type)
 	 */
 	dma_addr = (dma_addr_t)NULL;
 
-	/*
-	 * Use VPDMA_MAX_SIZE1 or VPDMA_MAX_SIZE2 register for slice0/1
-	 */
-
-	if (dev->slice_id == VIP_SLICE1) {
-		vpdma_set_max_size(dev->shared->vpdma, VPDMA_MAX_SIZE1,
-			stream->width, stream->height);
-
-		max_width = MAX_OUT_WIDTH_REG1;
-		max_height = MAX_OUT_HEIGHT_REG1;
-	} else {
-		vpdma_set_max_size(dev->shared->vpdma, VPDMA_MAX_SIZE2,
-			stream->width, stream->height);
-
-		max_width = MAX_OUT_WIDTH_REG2;
-		max_height = MAX_OUT_HEIGHT_REG2;
-	}
-
+	vpdma_vip_set_max_size(dev->shared->vpdma, 1);
 	vpdma_rawchan_add_out_dtd(&dev->desc_list, c_rect->width, c_rect,
-		fmt->vpdma_fmt[plane], dma_addr, max_width, max_height,
-		channel, flags);
+		fmt->vpdma_fmt[plane], dma_addr, channel, flags);
 
 	return 0;
 }
diff --git a/drivers/media/platform/ti-vpe/vpdma.c b/drivers/media/platform/ti-vpe/vpdma.c
index 3905666..6c64618 100644
--- a/drivers/media/platform/ti-vpe/vpdma.c
+++ b/drivers/media/platform/ti-vpe/vpdma.c
@@ -492,21 +492,18 @@ void vpdma_update_dma_addr(struct vpdma_data *vpdma,
 }
 EXPORT_SYMBOL(vpdma_update_dma_addr);
 
-void vpdma_set_max_size(struct vpdma_data *vpdma, int reg_addr,
-		u32 width, u32 height)
+void vpdma_vip_set_max_size(struct vpdma_data *vpdma, int vip_num)
 {
-	if (reg_addr != VPDMA_MAX_SIZE1 && reg_addr != VPDMA_MAX_SIZE2
-		&& reg_addr != VPDMA_MAX_SIZE3)
-			reg_addr = VPDMA_MAX_SIZE1;
-
-	write_field_reg(vpdma, reg_addr, width - 1 ,
-		VPDMA_MAX_SIZE_WIDTH_MASK, VPDMA_MAX_SIZE_WIDTH_SHFT);
-
-	write_field_reg(vpdma, reg_addr, height - 1 ,
-		VPDMA_MAX_SIZE_HEIGHT_MASK, VPDMA_MAX_SIZE_HEIGHT_SHFT);
-
+	if (vip_num == 1) {
+		write_field_reg(vpdma, VPDMA_MAX_SIZE1, 1919,
+				VPDMA_MAX_SIZE_WIDTH_MASK,
+				VPDMA_MAX_SIZE_WIDTH_SHFT);
+		write_field_reg(vpdma, VPDMA_MAX_SIZE1, 1079,
+				VPDMA_MAX_SIZE_HEIGHT_MASK,
+				VPDMA_MAX_SIZE_HEIGHT_SHFT);
+	}
 }
-EXPORT_SYMBOL(vpdma_set_max_size);
+EXPORT_SYMBOL(vpdma_vip_set_max_size);
 
 static void dump_cfd(struct vpdma_cfd *cfd)
 {
@@ -684,25 +681,23 @@ static void dump_dtd(struct vpdma_dtd *dtd)
  * @c_rect: compose params of output image
  * @fmt: vpdma data format of the buffer
  * dma_addr: dma address as seen by VPDMA
- * max_width: enum for maximum width of data transfer
- * max_height: enum for maximum height of data transfer
  * chan: VPDMA channel
  * flags: VPDMA flags to configure some descriptor fileds
  */
 void vpdma_add_out_dtd(struct vpdma_desc_list *list, int width,
 		const struct v4l2_rect *c_rect,
 		const struct vpdma_data_format *fmt, dma_addr_t dma_addr,
-		int max_w, int max_h, enum vpdma_channel chan, u32 flags)
+		enum vpdma_channel chan, u32 flags)
 {
 	vpdma_rawchan_add_out_dtd(list, width, c_rect, fmt, dma_addr,
-				  max_w, max_h, chan_info[chan].num, flags);
+				  chan_info[chan].num, flags);
 }
 EXPORT_SYMBOL(vpdma_add_out_dtd);
 
 void vpdma_rawchan_add_out_dtd(struct vpdma_desc_list *list, int width,
 		const struct v4l2_rect *c_rect,
 		const struct vpdma_data_format *fmt, dma_addr_t dma_addr,
-		int max_w, int max_h, int raw_vpdma_chan, u32 flags)
+		int raw_vpdma_chan, u32 flags)
 {
 	int priority = 0;
 	int field = 0;
@@ -741,7 +736,8 @@ void vpdma_rawchan_add_out_dtd(struct vpdma_desc_list *list, int width,
 	dtd->pkt_ctl = dtd_pkt_ctl(!!(flags & VPDMA_DATA_MODE_TILED),
 				DTD_DIR_OUT, channel, priority, next_chan);
 	dtd->desc_write_addr = dtd_desc_write_addr(0, 0, 0, 0);
-	dtd->max_width_height = dtd_max_width_height(max_w, max_h);
+	dtd->max_width_height = dtd_max_width_height(MAX_OUT_WIDTH_1920,
+					MAX_OUT_HEIGHT_1080);
 	dtd->client_attr0 = 0;
 	dtd->client_attr1 = 0;
 
diff --git a/drivers/media/platform/ti-vpe/vpdma.h b/drivers/media/platform/ti-vpe/vpdma.h
index a4589ac..d591ca5 100644
--- a/drivers/media/platform/ti-vpe/vpdma.h
+++ b/drivers/media/platform/ti-vpe/vpdma.h
@@ -117,30 +117,6 @@ enum vpdma_frame_start_event {
 	VPDMA_FSEVENT_CHANNEL_ACTIVE,
 };
 
-/* max width configurations */
-enum vpdma_max_width {
-	MAX_OUT_WIDTH_UNLIMITED = 0,
-	MAX_OUT_WIDTH_REG1,
-	MAX_OUT_WIDTH_REG2,
-	MAX_OUT_WIDTH_REG3,
-	MAX_OUT_WIDTH_352,
-	MAX_OUT_WIDTH_768,
-	MAX_OUT_WIDTH_1280,
-	MAX_OUT_WIDTH_1920,
-};
-
-/* max height configurations */
-enum vpdma_max_height {
-	MAX_OUT_HEIGHT_UNLIMITED = 0,
-	MAX_OUT_HEIGHT_REG1,
-	MAX_OUT_HEIGHT_REG2,
-	MAX_OUT_HEIGHT_REG3,
-	MAX_OUT_HEIGHT_288,
-	MAX_OUT_HEIGHT_576,
-	MAX_OUT_HEIGHT_720,
-	MAX_OUT_HEIGHT_1080,
-};
-
 /*
  * VPDMA channel numbers
  */
@@ -222,12 +198,11 @@ void vpdma_add_sync_on_channel_ctd(struct vpdma_desc_list *list,
 void vpdma_add_out_dtd(struct vpdma_desc_list *list, int width,
 		const struct v4l2_rect *c_rect,
 		const struct vpdma_data_format *fmt, dma_addr_t dma_addr,
-		int max_w, int max_h, enum vpdma_channel chan, u32 flags);
+		enum vpdma_channel chan, u32 flags);
 void vpdma_rawchan_add_out_dtd(struct vpdma_desc_list *list, int width,
 		const struct v4l2_rect *c_rect,
 		const struct vpdma_data_format *fmt, dma_addr_t dma_addr,
-		int max_w, int max_h, int raw_vpdma_chan, u32 flags);
-
+		int raw_vpdma_chan, u32 flags);
 void vpdma_add_in_dtd(struct vpdma_desc_list *list, int width,
 		const struct v4l2_rect *c_rect,
 		const struct vpdma_data_format *fmt, dma_addr_t dma_addr,
@@ -246,9 +221,7 @@ void vpdma_set_line_mode(struct vpdma_data *vpdma, int line_mode,
 		enum vpdma_channel chan);
 void vpdma_set_frame_start_event(struct vpdma_data *vpdma,
 		enum vpdma_frame_start_event fs_event, enum vpdma_channel chan);
-void vpdma_set_max_size(struct vpdma_data *vpdma, int reg_addr,
-			u32 width, u32 height);
-
+void vpdma_vip_set_max_size(struct vpdma_data *vpdma, int vip_num);
 void vpdma_set_bg_color(struct vpdma_data *vpdma,
 			struct vpdma_data_format *fmt, u32 color);
 void vpdma_dump_regs(struct vpdma_data *vpdma);
diff --git a/drivers/media/platform/ti-vpe/vpdma_priv.h b/drivers/media/platform/ti-vpe/vpdma_priv.h
index 269051a..762b3fe 100644
--- a/drivers/media/platform/ti-vpe/vpdma_priv.h
+++ b/drivers/media/platform/ti-vpe/vpdma_priv.h
@@ -231,6 +231,42 @@ struct vpdma_dtd {
 #define DTD_MAX_HEIGHT_MASK	0x07
 #define DTD_MAX_HEIGHT_SHFT	0
 
+/* max width configurations */
+ /* unlimited width */
+#define	MAX_OUT_WIDTH_UNLIMITED		0
+/* as specified in max_size1 reg */
+#define MAX_OUT_WIDTH_REG1		1
+/* as specified in max_size2 reg */
+#define MAX_OUT_WIDTH_REG2		2
+/* as specified in max_size3 reg */
+#define	MAX_OUT_WIDTH_REG3		3
+/* maximum of 352 pixels as width */
+#define MAX_OUT_WIDTH_352		4
+/* maximum of 768 pixels as width */
+#define	MAX_OUT_WIDTH_768		5
+/* maximum of 1280 pixels width */
+#define	MAX_OUT_WIDTH_1280		6
+/* maximum of 1920 pixels as width */
+#define	MAX_OUT_WIDTH_1920		7
+
+/* max height configurations */
+ /* unlimited height */
+#define	MAX_OUT_HEIGHT_UNLIMITED	0
+/* as specified in max_size1 reg */
+#define MAX_OUT_HEIGHT_REG1		1
+/* as specified in max_size2 reg */
+#define MAX_OUT_HEIGHT_REG2		2
+/* as specified in max_size3 reg */
+#define	MAX_OUT_HEIGHT_REG3		3
+/* maximum of 288 lines as height */
+#define MAX_OUT_HEIGHT_288		4
+/* maximum of 576 lines as height */
+#define	MAX_OUT_HEIGHT_576		5
+/* maximum of 720 lines as height */
+#define	MAX_OUT_HEIGHT_720		6
+/* maximum of 1080 lines as height */
+#define	MAX_OUT_HEIGHT_1080		7
+
 static inline u32 dtd_type_ctl_stride(int type, bool notify, int field,
 			bool one_d, bool even_line_skip, bool odd_line_skip,
 			int line_stride)
diff --git a/drivers/media/platform/ti-vpe/vpe.c b/drivers/media/platform/ti-vpe/vpe.c
index 5091756..7677547 100644
--- a/drivers/media/platform/ti-vpe/vpe.c
+++ b/drivers/media/platform/ti-vpe/vpe.c
@@ -1044,8 +1044,7 @@ static void add_out_dtd(struct vpe_ctx *ctx, int port)
 		flags |= VPDMA_DATA_MODE_TILED;
 
 	vpdma_add_out_dtd(&ctx->desc_list, q_data->width, &q_data->c_rect,
-		vpdma_fmt, dma_addr, MAX_OUT_WIDTH_1920, MAX_OUT_HEIGHT_1080,
-		p_data->channel, flags);
+		vpdma_fmt, dma_addr, p_data->channel, flags);
 }
 
 static void add_in_dtd(struct vpe_ctx *ctx, int port)
-- 
1.7.5.4

