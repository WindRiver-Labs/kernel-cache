From be79efc9fcc53735443bf1903837e3338231e72d Mon Sep 17 00:00:00 2001
From: Misael Lopez Cruz <misael.lopez@ti.com>
Date: Fri, 7 Nov 2014 14:37:44 +0200
Subject: [PATCH 1367/1587] ASoC: omap-hdmi-audio: Use HDMI HW IP alias for
 the card

The HDMI sound uses a simple card created programatically, so
the preferred card id cannot be passed through an alias via DT.
The card id hint is taken from the HDMI HW IP's alias instead,
which does have a DT entry.

Signed-off-by: Misael Lopez Cruz <misael.lopez@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 sound/soc/omap/omap-hdmi-audio.c |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/sound/soc/omap/omap-hdmi-audio.c b/sound/soc/omap/omap-hdmi-audio.c
index 630537e..35bc89f 100644
--- a/sound/soc/omap/omap-hdmi-audio.c
+++ b/sound/soc/omap/omap-hdmi-audio.c
@@ -28,6 +28,7 @@
 #include <sound/asoundef.h>
 #include <sound/omap-pcm.h>
 #include <sound/omap-hdmi-audio.h>
+#include <sound/initval.h>
 #include <video/omapdss_hdmi_audio_data.h>
 
 #include <sound/simple_card.h>
@@ -286,6 +287,14 @@ int omap_hdmi_audio_register(struct omap_hdmi_audio *ha)
 		.codec_dai.name = "hdmi-hifi",
 	};
 	int ret;
+	int id = SNDRV_DEFAULT_IDX1;
+
+	/* Get the id of the parent (the HDMI HW IP) */
+	if (ha->dev->of_node) {
+		id = of_alias_get_id(ha->dev->of_node, "sound");
+		if (id < 0)
+			id = SNDRV_DEFAULT_IDX1;
+	}
 
 	ad = devm_kzalloc(ha->dev, sizeof(*ad), GFP_KERNEL);
 	if (!ad)
@@ -326,6 +335,7 @@ int omap_hdmi_audio_register(struct omap_hdmi_audio *ha)
 	card_info.cpu_dai.name = dev_name(ha->dev);
 	card_info.platform = dev_name(ha->dev);
 	card_info.codec = dev_name(&ad->codec_pdev->dev);
+	card_info.id_hint = id;
 
 	ad->card_pdev =
 		platform_device_register_data(ha->dev, "asoc-simple-card", 0,
-- 
1.7.5.4

