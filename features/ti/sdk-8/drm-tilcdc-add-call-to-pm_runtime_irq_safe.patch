From 90e89091fffae79fcdf97f6e02f72bba2d299ab2 Mon Sep 17 00:00:00 2001
From: "Etheridge, Darren" <detheridge@ti.com>
Date: Fri, 25 Apr 2014 03:36:35 +0000
Subject: [PATCH 0710/1587] drm/tilcdc add call to pm_runtime_irq_safe

set_scanout is called in irq context, which then calls pm_runtime_get_sync
which is not irq safe.  Adding a call to pm_runtime_irq_safe allows
pm_runtime_get_sync to be called from irq.  This eliminates a kernel oops from
occuring when modetest -v is used to do a flip test with pm enabled in the
kernel.

Signed-off-by: Darren Etheridge <detheridge@ti.com>
Reviewed-by: Felipe Balbi <balbi@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/gpu/drm/tilcdc/tilcdc_crtc.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/tilcdc/tilcdc_crtc.c b/drivers/gpu/drm/tilcdc/tilcdc_crtc.c
index d642d4a..fc692bf 100644
--- a/drivers/gpu/drm/tilcdc/tilcdc_crtc.c
+++ b/drivers/gpu/drm/tilcdc/tilcdc_crtc.c
@@ -664,6 +664,8 @@ struct drm_crtc *tilcdc_crtc_create(struct drm_device *dev)
 	tilcdc_crtc->dpms = DRM_MODE_DPMS_OFF;
 	init_waitqueue_head(&tilcdc_crtc->frame_done_wq);
 
+	pm_runtime_irq_safe(dev->dev);
+
 	ret = drm_flip_work_init(&tilcdc_crtc->unref_work, 16,
 			"unref", unref_worker);
 	if (ret) {
-- 
1.7.5.4

