From 40e05b34e89d23a3575d1a8778844730f044314f Mon Sep 17 00:00:00 2001
From: Tero Kristo <t-kristo@ti.com>
Date: Fri, 29 Aug 2014 16:06:20 +0300
Subject: [PATCH 1102/1587] ARM: AM43XX: PM: change RTC_SCRATCH1 register
 handling for rtc-only mode

RTC_SCRATCH1 now contains board type in bits 16-31, and this information
is populated by bootloader. Print a warning during boot if the contents
of this register are wrong, indicating a wrong bootloader version.

Signed-off-by: Tero Kristo <t-kristo@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 arch/arm/mach-omap2/pm33xx.c |    8 +++++---
 1 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/arch/arm/mach-omap2/pm33xx.c b/arch/arm/mach-omap2/pm33xx.c
index 282c70c..a75183a 100644
--- a/arch/arm/mach-omap2/pm33xx.c
+++ b/arch/arm/mach-omap2/pm33xx.c
@@ -632,8 +632,6 @@ int __init am33xx_pm_init(void)
 	else if (soc_is_am43xx())
 		am33xx_pm->ops = &am43xx_ops;
 
-	rtc_magic_val = RTC_REG_BOOT_MAGIC;
-
 	ret = am33xx_pm->ops->init();
 
 	if (ret)
@@ -669,7 +667,6 @@ int __init am33xx_pm_init(void)
 		if (of_find_property(np, "ti,needs-vtt-toggle", NULL) &&
 		    (!(of_property_read_u32(np, "ti,vtt-gpio-pin",
 							&temp)))) {
-			rtc_magic_val |= RTC_REG_DDR_TYPE_DDR3_0;
 			if (temp >= 0 && temp <= 31)
 				am33xx_pm->ipc.reg4 |=
 					((1 << VTT_STAT_SHIFT) |
@@ -707,6 +704,11 @@ int __init am33xx_pm_init(void)
 	pmx_dev = get_pinctrl_dev_from_devname("44e10800.pinmux");
 	omap_rtc = rtc_class_open("rtc0");
 
+	rtc_read_scratch(omap_rtc, RTC_SCRATCH_MAGIC_REG, &rtc_magic_val);
+
+	if ((rtc_magic_val & 0xffff) != RTC_REG_BOOT_MAGIC)
+		pr_warn("PM: Bootloader does not support rtc-only mode!\n");
+
 	rtc_write_scratch(omap_rtc, RTC_SCRATCH_MAGIC_REG, 0);
 	rtc_write_scratch(omap_rtc, RTC_SCRATCH_RESUME_REG,
 			  virt_to_phys(cpu_resume));
-- 
1.7.5.4

