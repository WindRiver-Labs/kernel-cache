From 4ef7889b62d9859edbde499e7f47ff949fdb447c Mon Sep 17 00:00:00 2001
From: Suman Anna <s-anna@ti.com>
Date: Tue, 4 Feb 2014 16:09:01 -0600
Subject: [PATCH 0996/1587] CLK: TI: DRA7: source IPU1 functional clock from
 CORE DPLL

The IPU1 functional clock is actually the output of a mux clock,
ipu1_gfclk_mux. The mux clock is sourced by default from the
DPLL_ABE_X2_CLK, and this results in a rather odd clock frequency
(361 MHz) for the IPU1 functional clock. Reconfigure the mux clock
to be sourced from CORE_IPU_ISS_BOOST_CLK (dpll_core_h22x2_ck), so
that both the IPU1 and IPU2 are running from the same clock and
clocked at the same nominal frequency of 425 MHz.

Signed-off-by: Suman Anna <s-anna@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/clk/ti/clk-7xx.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/drivers/clk/ti/clk-7xx.c b/drivers/clk/ti/clk-7xx.c
index 3f73a02..9b49cd2 100644
--- a/drivers/clk/ti/clk-7xx.c
+++ b/drivers/clk/ti/clk-7xx.c
@@ -308,6 +308,7 @@ int __init dra7xx_dt_clk_init(void)
 {
 	int rc;
 	struct clk *abe_dpll_mux, *sys_clkin2, *dpll_ck, *dss_deshdcp_ck;
+	struct clk *ipu1_gfclk, *ipu1_gfclk_parent;
 
 	ti_dt_clocks_register(dra7xx_clks);
 
@@ -333,5 +334,11 @@ int __init dra7xx_dt_clk_init(void)
 	if (rc)
 		pr_err("%s: failed to enable DESHDCP clock\n", __func__);
 
+	ipu1_gfclk = clk_get_sys(NULL, "ipu1_gfclk_mux");
+	ipu1_gfclk_parent = clk_get_sys(NULL, "dpll_core_h22x2_ck");
+	rc = clk_set_parent(ipu1_gfclk, ipu1_gfclk_parent);
+	if (rc)
+		pr_err("%s: failed to reparent ipu1_gfclk_mux\n", __func__);
+
 	return rc;
 }
-- 
1.7.5.4

