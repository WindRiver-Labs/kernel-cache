From 17dd6d83267017615811ad937bdbc2f878d498d7 Mon Sep 17 00:00:00 2001
From: "Franklin S. Cooper Jr" <fcooper@ti.com>
Date: Mon, 26 Jan 2015 13:50:09 -0600
Subject: [PATCH 1577/1587] omap_hwmod: (HACK) Workaround lack of proper sw
 supervised power domains support

* This (hack) patch is to temporarily work around the issue where sw supervised
  clock domains aren't properly being disabled in _deassert_hardreset. This
  results in the clock domain use count for gfx being imbalanced which prevents
  having the gfx clock from being powered down during suspend/standby.
* With this patch gfx demos, suspend and standby have been tested and is still
  working. Also the gfx domain has been properly disabled.
* The problem this patch is trying to resolve is discussed in more details
  under Defect D-02084.

Signed-off-by: Franklin S. Cooper Jr <fcooper@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 arch/arm/mach-omap2/omap_hwmod.c                   |    2 +-
 arch/arm/mach-omap2/omap_hwmod.h                   |    1 +
 .../mach-omap2/omap_hwmod_33xx_43xx_ipblock_data.c |    1 +
 3 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-omap2/omap_hwmod.c b/arch/arm/mach-omap2/omap_hwmod.c
index f22b4de..bd13b6e 100644
--- a/arch/arm/mach-omap2/omap_hwmod.c
+++ b/arch/arm/mach-omap2/omap_hwmod.c
@@ -1745,7 +1745,7 @@ static int _deassert_hardreset(struct omap_hwmod *oh, const char *name)
 	if (ret == -EBUSY)
 		pr_warning("omap_hwmod: %s: failed to hardreset\n", oh->name);
 
-	if (!ret) {
+	if (!ret && !(oh->flags & HWMOD_SW_SUP_WRKAROUND)) {
 		/*
 		 * Set the clockdomain to HW_AUTO, assuming that the
 		 * previous state was HW_AUTO.
diff --git a/arch/arm/mach-omap2/omap_hwmod.h b/arch/arm/mach-omap2/omap_hwmod.h
index cc1a121..4aad0f7 100644
--- a/arch/arm/mach-omap2/omap_hwmod.h
+++ b/arch/arm/mach-omap2/omap_hwmod.h
@@ -538,6 +538,7 @@ struct omap_hwmod_omap4_prcm {
 #define HWMOD_SWSUP_SIDLE_ACT			(1 << 12)
 #define HWMOD_NO_INIT				(1 << 13)
 #define HWMOD_NEEDS_REIDLE			(1 << 14)
+#define HWMOD_SW_SUP_WRKAROUND			(1 << 15)
 
 /*
  * omap_hwmod._int_flags definitions
diff --git a/arch/arm/mach-omap2/omap_hwmod_33xx_43xx_ipblock_data.c b/arch/arm/mach-omap2/omap_hwmod_33xx_43xx_ipblock_data.c
index 1ca9268..e1e3956 100644
--- a/arch/arm/mach-omap2/omap_hwmod_33xx_43xx_ipblock_data.c
+++ b/arch/arm/mach-omap2/omap_hwmod_33xx_43xx_ipblock_data.c
@@ -241,6 +241,7 @@ struct omap_hwmod am33xx_gfx_hwmod = {
 	.class		= &am33xx_gfx_hwmod_class,
 	.clkdm_name	= "gfx_l3_clkdm",
 	.main_clk	= "gfx_fck_div_ck",
+	.flags		= HWMOD_SW_SUP_WRKAROUND,
 	.prcm		= {
 		.omap4	= {
 			.modulemode	= MODULEMODE_SWCTRL,
-- 
1.7.5.4

