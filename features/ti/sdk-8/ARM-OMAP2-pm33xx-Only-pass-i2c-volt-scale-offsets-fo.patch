From 21d14ea1218c6bcdc5ef7bdf7814bcd34dc60546 Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Sat, 6 Dec 2014 02:19:06 +0000
Subject: [PATCH 1558/1587] ARM: OMAP2+: pm33xx: Only pass i2c volt scale
 offsets for DeepSleep

The offsets for i2c voltage scaling sequence were being set directly
into IPC register 5 and being passed for all PM operations. This is
incorrect as only DeepSleep0 should scale voltage, not standby or
cpuidle. Instead we should store the value when it is calculated
and only pass for DeepSleep operation, not cpuidle operation.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 arch/arm/mach-omap2/pm33xx.c |    5 ++++-
 arch/arm/mach-omap2/pm33xx.h |    1 +
 2 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-omap2/pm33xx.c b/arch/arm/mach-omap2/pm33xx.c
index 15a2851..95aef0e 100644
--- a/arch/arm/mach-omap2/pm33xx.c
+++ b/arch/arm/mach-omap2/pm33xx.c
@@ -115,6 +115,7 @@ int am33xx_do_sram_cpuidle(u32 wfi_flags, u32 m3_flags)
 		am33xx_pm->ipc.reg1 = IPC_CMD_IDLE;
 		am33xx_pm->ipc.reg2 = DS_IPC_DEFAULT;
 		am33xx_pm->ipc.reg3 = m3_flags;
+		am33xx_pm->ipc.reg5 = DS_IPC_DEFAULT;
 		wkup_m3_set_cmd(&am33xx_pm->ipc);
 		ret = wkup_m3_ping();
 		if (ret < 0)
@@ -341,9 +342,11 @@ static int am33xx_pm_begin(suspend_state_t state)
 	switch (state) {
 	case PM_SUSPEND_MEM:
 		am33xx_pm->ipc.reg1	= IPC_CMD_DS0;
+		am33xx_pm->ipc.reg5	= am33xx_pm->m3_i2c_sequence_offsets;
 		break;
 	case PM_SUSPEND_STANDBY:
 		am33xx_pm->ipc.reg1	= IPC_CMD_STANDBY;
+		am33xx_pm->ipc.reg5	= DS_IPC_DEFAULT;
 		break;
 	}
 
@@ -422,7 +425,7 @@ static void am33xx_scale_data_fw_cb(const struct firmware *fw, void *context)
 	val = (aux_base + hdr.sleep_offset);
 	val |= ((aux_base + hdr.wake_offset) << 16);
 
-	am33xx_pm->ipc.reg5 = val;
+	am33xx_pm->m3_i2c_sequence_offsets = val;
 
 release_sd_fw:
 	release_firmware(fw);
diff --git a/arch/arm/mach-omap2/pm33xx.h b/arch/arm/mach-omap2/pm33xx.h
index ca46244..48c3bf2 100644
--- a/arch/arm/mach-omap2/pm33xx.h
+++ b/arch/arm/mach-omap2/pm33xx.h
@@ -35,6 +35,7 @@ struct am33xx_pm_context {
 	struct am33xx_pm_ops	*ops;
 	u8			state;
 	u32			ver;
+	u32			m3_i2c_sequence_offsets;
 	const char		*sd_fw_name;
 };
 
-- 
1.7.5.4

