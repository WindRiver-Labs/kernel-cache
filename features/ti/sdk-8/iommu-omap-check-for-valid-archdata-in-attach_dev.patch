From 2ef0279d8588aca1303a0f55a2ab93c575c6cad6 Mon Sep 17 00:00:00 2001
From: Suman Anna <s-anna@ti.com>
Date: Tue, 5 Aug 2014 19:35:20 -0500
Subject: [PATCH 0968/1587] iommu/omap: check for valid archdata in attach_dev

A device is tied to an iommu through its archdata field, any device
requiring to be attached to an iommu_domain must have valid archdata
containing the necessary iommu information. This archdata information
to be added is SoC-specific. Add a check in the omap_iommu_attach_dev
to make sure that the device has non-NULL archdata before accessing
different SoC-specific fields of the archdata. This prevents a NULL
pointer dereference on any misconfigured devices.

Signed-off-by: Suman Anna <s-anna@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/iommu/omap-iommu.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/drivers/iommu/omap-iommu.c b/drivers/iommu/omap-iommu.c
index 031b247..4c03236 100644
--- a/drivers/iommu/omap-iommu.c
+++ b/drivers/iommu/omap-iommu.c
@@ -1106,6 +1106,12 @@ omap_iommu_attach_dev(struct iommu_domain *domain, struct device *dev)
 
 	spin_lock(&omap_domain->lock);
 
+	if (!arch_data) {
+		dev_err(dev, "device doesn't have an associated iommu\n");
+		ret = -EINVAL;
+		goto out;
+	}
+
 	/* only a single device is supported per domain for now */
 	if (omap_domain->iommu_dev) {
 		dev_err(dev, "iommu domain is already attached\n");
-- 
1.7.5.4

