From bb8fdee5f54c46358e2bc8098b60fe60bc8e54d2 Mon Sep 17 00:00:00 2001
From: Subramaniam Chanderashekarapuram <subramaniam.ca@ti.com>
Date: Wed, 29 Oct 2014 13:46:05 +0530
Subject: [PATCH 1291/1587] thermal: DRA7: fallback to restarting the system
 in case poweroff fails

Systems that do not support poweroff (for instance, DRA7), cannot
recover from a software triggered thermal shutdown. In such cases
fall back to restarting the system, and leave it to the bootloader
to handle the scenario.

[j-keerthy@ti.com] ported to 3.14 and tested
Signed-off-by: Keerthy <j-keerthy@ti.com>
Signed-off-by: Subramaniam Chanderashekarapuram <subramaniam.ca@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/thermal/thermal_core.c |   12 +++++++++++-
 1 files changed, 11 insertions(+), 1 deletions(-)

diff --git a/drivers/thermal/thermal_core.c b/drivers/thermal/thermal_core.c
index 284733e..c247855 100644
--- a/drivers/thermal/thermal_core.c
+++ b/drivers/thermal/thermal_core.c
@@ -361,6 +361,7 @@ static void handle_critical_trips(struct thermal_zone_device *tz,
 				int trip, enum thermal_trip_type trip_type)
 {
 	long trip_temp;
+	int ret;
 
 	tz->ops->get_trip_temp(tz, trip, &trip_temp);
 
@@ -375,7 +376,16 @@ static void handle_critical_trips(struct thermal_zone_device *tz,
 		dev_emerg(&tz->device,
 			  "critical temperature reached(%d C),shutting down\n",
 			  tz->temperature / 1000);
-		orderly_poweroff(true);
+
+		ret = orderly_poweroff(true);
+		/* in case poweroff failed, fallback to restarting the system */
+		if (ret) {
+			dev_emerg(&tz->device,
+				  "poweroff failed with reason %d restarting\n",
+				  ret);
+			/* pbias needs to be fixed to get the reboot working */
+			kernel_restart(NULL);
+		}
 	}
 }
 
-- 
1.7.5.4

