From 3391a161938dd317a3b01f65c55ecebdf2b97bdf Mon Sep 17 00:00:00 2001
From: George Cherian <george.cherian@ti.com>
Date: Tue, 16 Dec 2014 00:08:05 +0530
Subject: [PATCH 1556/1587] usb: host: xhci: Call suspend/resume depending on
 DRD state

It's quite possible that the system might enter suspend after switching
role from host to device. In such scenarios, the xhci platform device is
still valid but the HCD will be removed. With the help of DRD library
determine the state and call suspend/resume accordingly.

Signed-off-by: George Cherian <george.cherian@ti.com>
Signed-off-by: Sekhar Nori <nsekhar@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/usb/host/xhci-plat.c |   11 +++++++++--
 1 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/drivers/usb/host/xhci-plat.c b/drivers/usb/host/xhci-plat.c
index f0fafe3..8b08455 100644
--- a/drivers/usb/host/xhci-plat.c
+++ b/drivers/usb/host/xhci-plat.c
@@ -285,7 +285,11 @@ static int xhci_plat_suspend(struct device *dev)
 	 * reconsider this when xhci_plat_suspend enlarges its scope, e.g.,
 	 * also applies to runtime suspend.
 	 */
-	return xhci_suspend(xhci, device_may_wakeup(dev));
+
+	if (usb_drd_get_state(dev->parent) & DRD_HOST_ACTIVE)
+		return xhci_suspend(xhci, device_may_wakeup(dev));
+
+	return 0;
 }
 
 static int xhci_plat_resume(struct device *dev)
@@ -293,7 +297,10 @@ static int xhci_plat_resume(struct device *dev)
 	struct usb_hcd	*hcd = dev_get_drvdata(dev);
 	struct xhci_hcd	*xhci = hcd_to_xhci(hcd);
 
-	return xhci_resume(xhci, 0);
+	if (usb_drd_get_state(dev->parent) & DRD_HOST_ACTIVE)
+		return xhci_resume(xhci, 0);
+
+	return 0;
 }
 
 static const struct dev_pm_ops xhci_plat_pm_ops = {
-- 
1.7.5.4

