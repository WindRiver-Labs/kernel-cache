From 2f2cc96c7c88ded2a8c8291111deffc9ec7de4cd Mon Sep 17 00:00:00 2001
From: Tero Kristo <t-kristo@ti.com>
Date: Thu, 4 Sep 2014 10:57:57 +0300
Subject: [PATCH 1167/1587] ARM: AMx3xx: PM: disable rtc-only mode on devices
 without RTC module

Boot time access to the RTC will cause a hang on boards that don't have
RTC module. Fixed by checking the DTS status of RTC device in the PM
code before attempting to access the RTC.

Signed-off-by: Tero Kristo <t-kristo@ti.com>
Cc: Felipe Balbi <balbi@ti.com>
Cc: Dave Gerlach <d-gerlach@ti.com>
Cc: Keerthy <j-keerthy@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 arch/arm/mach-omap2/pm33xx.c |   23 +++++++++++++++--------
 1 files changed, 15 insertions(+), 8 deletions(-)

diff --git a/arch/arm/mach-omap2/pm33xx.c b/arch/arm/mach-omap2/pm33xx.c
index 9f1c670..52defbf 100644
--- a/arch/arm/mach-omap2/pm33xx.c
+++ b/arch/arm/mach-omap2/pm33xx.c
@@ -224,7 +224,7 @@ static int am33xx_pm_suspend(unsigned int state)
 
 	am33xx_pm->ops->pre_suspend(state);
 
-	if (state == PM_SUSPEND_MEM && enable_off_mode)
+	if (state == PM_SUSPEND_MEM && enable_off_mode && rtc_magic_val)
 		rtc_only_idle = 1;
 
 	if (rtc_only_idle) {
@@ -775,16 +775,23 @@ int __init am33xx_pm_init(void)
 	wkup_m3_set_ops(&am33xx_wkup_m3_ops);
 
 	pmx_dev = get_pinctrl_dev_from_devname("44e10800.pinmux");
-	omap_rtc = rtc_class_open("rtc0");
 
-	rtc_read_scratch(omap_rtc, RTC_SCRATCH_MAGIC_REG, &rtc_magic_val);
+	np = of_find_node_by_name(NULL, "rtc");
 
-	if ((rtc_magic_val & 0xffff) != RTC_REG_BOOT_MAGIC)
-		pr_warn("PM: Bootloader does not support rtc-only mode!\n");
+	if (of_device_is_available(np)) {
+		omap_rtc = rtc_class_open("rtc0");
 
-	rtc_write_scratch(omap_rtc, RTC_SCRATCH_MAGIC_REG, 0);
-	rtc_write_scratch(omap_rtc, RTC_SCRATCH_RESUME_REG,
-			  virt_to_phys(cpu_resume));
+		rtc_read_scratch(omap_rtc, RTC_SCRATCH_MAGIC_REG,
+				 &rtc_magic_val);
+
+		if ((rtc_magic_val & 0xffff) != RTC_REG_BOOT_MAGIC)
+			pr_warn("PM: bootloader does not support rtc-only!\n");
+
+		rtc_write_scratch(omap_rtc, RTC_SCRATCH_MAGIC_REG, 0);
+		rtc_write_scratch(omap_rtc, RTC_SCRATCH_RESUME_REG,
+				  virt_to_phys(cpu_resume));
+	} else
+		pr_warn("PM: no-rtc available, rtc-only mode disabled.\n");
 
 	return 0;
 
-- 
1.7.5.4

