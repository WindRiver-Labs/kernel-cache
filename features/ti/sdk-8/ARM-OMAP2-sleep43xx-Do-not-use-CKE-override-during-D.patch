From 11181254a5a08cbf87b2bc518e185d59a15fcf4e Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Wed, 7 Jan 2015 19:06:38 -0600
Subject: [PATCH 1574/1587] ARM: OMAP2+: sleep43xx: Do not use CKE override
 during DeepSleep

AM437x offers a CKE override register within the control module that
allows the SoC to take control of the CKE line from the EMIF in order to
forcibly hold it low during suspend in order to prevent glitches and
keep the DDR properly in self-refresh.

Previously this was used as described in the suspend and resume path but
more recently it has been shown to cause hangs during suspend, so remove
the toggling of the bits along with all support code as suspend seems to
work better without it.

Tested-by: Keerthy <j-keerthy@ti.com>
Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 arch/arm/mach-omap2/pm33xx.c    |    8 --------
 arch/arm/mach-omap2/pm33xx.h    |    3 ---
 arch/arm/mach-omap2/sleep43xx.S |   23 -----------------------
 3 files changed, 0 insertions(+), 34 deletions(-)

diff --git a/arch/arm/mach-omap2/pm33xx.c b/arch/arm/mach-omap2/pm33xx.c
index 95aef0e..a17a680 100644
--- a/arch/arm/mach-omap2/pm33xx.c
+++ b/arch/arm/mach-omap2/pm33xx.c
@@ -603,14 +603,6 @@ static int am43xx_suspend_init(void)
 		return -ENOMEM;
 	}
 
-	susp_params.cke_override_virt =
-		ioremap(AM43XX_CTRL_CKE_OVERRIDE, SZ_4);
-
-	if (!susp_params.cke_override_virt) {
-		pr_err("PM: Could not ioremap CKE override in Control Module\n");
-		return -ENOMEM;
-	}
-
 	/* Physical resume address to be used by ROM code */
 	am33xx_pm->ipc.reg0 = (AM33XX_OCMC_END -
 		am43xx_do_wfi_sz + am43xx_resume_offset + 0x4);
diff --git a/arch/arm/mach-omap2/pm33xx.h b/arch/arm/mach-omap2/pm33xx.h
index d8a3c3b..8c4f459 100644
--- a/arch/arm/mach-omap2/pm33xx.h
+++ b/arch/arm/mach-omap2/pm33xx.h
@@ -52,7 +52,6 @@ struct am33xx_suspend_params {
 	void __iomem *dram_sync;
 	void __iomem *rtc_base;
 	void __iomem *l2_base_virt;
-	void __iomem *cke_override_virt;
 };
 
 void wkup_m3_reset_data_pos(void);
@@ -83,8 +82,6 @@ void __iomem *omap_rtc_get_base_addr(void);
 
 #define AM43XX_CM_BASE			0x44DF0000
 
-#define AM43XX_CTRL_CKE_OVERRIDE	0x44E1131C
-
 #define AM43XX_CM_REGADDR(inst, reg)				\
 	AM33XX_L4_WK_IO_ADDRESS(AM43XX_CM_BASE + (inst) + (reg))
 
diff --git a/arch/arm/mach-omap2/sleep43xx.S b/arch/arm/mach-omap2/sleep43xx.S
index 6b00982..e0aba1c 100644
--- a/arch/arm/mach-omap2/sleep43xx.S
+++ b/arch/arm/mach-omap2/sleep43xx.S
@@ -65,7 +65,6 @@
  * 3) dram_sync_word - uncached word in SDRAM
  * 4) rtc_base_addr - ioremapped RTC base address
  * 5) l2_virt_base - L2CC ioremapped address for AM437x
- * 6) cke_override_virt - CKE override virtual address
  *
  * The code loads these values taking r0 value as reference to
  * the array in registers starting from r0, i.e emif_addr_virt
@@ -86,7 +85,6 @@ ENTRY(am43xx_do_wfi)
 	str	r3, dram_sync_word
 	str	r4, rtc_base_addr
 	str	r5, l2_base_virt
-	str	r6, cke_override_virt
 
 	ldr	r0, emif_addr_virt
 	/* Save EMIF configuration */
@@ -268,12 +266,6 @@ wait_emif_disable:
 	cmp	r2, r3
 	bne	wait_emif_disable
 
-	/*enable CKE override for both CKE0 and CKE1*/
-	/*ensures CKE stays low throughout sleep*/
-	ldr    r2, cke_override_virt
-	mov    r1, #0
-	str    r1, [r2]
-
 	ldr	r1, wfi_flags
 	tst	r1, #WFI_RTC_ONLY
 	beq	am43xx_deep_sleep_suspend
@@ -374,11 +366,6 @@ wait_emif_enable:
 	cmp	r2, r3
 	bne	wait_emif_enable
 
-	/* disable CKE override for both CKE0 and CKE1 */
-	ldr    r2, cke_override_virt
-	mov    r1, #3
-	str    r1, [r2]
-
 	/* Disable EMIF self-refresh */
 	ldr	r0, emif_addr_virt
 	ldr	r1, [r0, #EMIF_POWER_MANAGEMENT_CONTROL]
@@ -491,11 +478,6 @@ ddr_phy_ctrl_restore:
 	cmp	r2, #AM43XX_EMIF_PHY_CTRL_REG_COUNT
 	bne	ddr_phy_ctrl_restore
 
-	/*disable CKE override for both CKE0 and CKE1*/
-	ldr    r2, cke_override_phys
-	mov    r1, #3
-	str    r1, [r2]
-
 	/*
 	 * Toggle EMIF to exit refresh mode:
 	 * if EMIF lost context, PWR_MGT_CTRL is currently 0, writing disable
@@ -598,11 +580,6 @@ wfi_flags:
 rtc_base_addr:
 	.word	(0xdeadbeef)
 
-cke_override_virt:
-	.word	0xDEADBEEF
-cke_override_phys:
-	.word	AM43XX_CTRL_CKE_OVERRIDE
-
 am43xx_phys_emif_poweroff:
 	.word   (AM43XX_CM_BASE + AM43XX_PRM_DEVICE_INST + \
 		 AM43XX_PRM_EMIF_CTRL_OFFSET)
-- 
1.7.5.4

