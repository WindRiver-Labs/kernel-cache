From 98ed450ce36cd6eae67f6250ef1da96322ee2790 Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Wed, 30 Jul 2014 22:42:02 -0500
Subject: [PATCH 0917/1587] ARM: OMAP2+: AM43xx: Add support for IO Isolation

AM43xx support isolation of the many of the IOs so that control is taken
from the peripheral they are connected to and overridden by values
present in the CTRL_CONF_* registers for the pad in the control module.

The actual toggling happens from the wkup_m3, so use a DT property from the
wkup_m3 node to allow the PM code to communicate the necessity for
placing the IOs into isolation.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 arch/arm/mach-omap2/pm33xx.c |    3 +++
 arch/arm/mach-omap2/pm33xx.h |    2 ++
 2 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-omap2/pm33xx.c b/arch/arm/mach-omap2/pm33xx.c
index dd339f3..7cb33a5 100644
--- a/arch/arm/mach-omap2/pm33xx.c
+++ b/arch/arm/mach-omap2/pm33xx.c
@@ -463,6 +463,9 @@ int __init am33xx_pm_init(void)
 			else
 				pr_warn("PM: Invalid VTT GPIO(%d) pin\n", temp);
 		}
+
+		if (of_find_property(np, "ti,set-io-isolation", NULL))
+			am33xx_pm->ipc.reg4 |= (1 << IO_ISOLATION_STAT_SHIFT);
 	}
 
 	(void) clkdm_for_each(omap_pm_clkdms_setup, NULL);
diff --git a/arch/arm/mach-omap2/pm33xx.h b/arch/arm/mach-omap2/pm33xx.h
index 3464dbc..ac146aa 100644
--- a/arch/arm/mach-omap2/pm33xx.h
+++ b/arch/arm/mach-omap2/pm33xx.h
@@ -96,5 +96,7 @@ struct am33xx_suspend_params {
 #define VTT_STAT_MASK		(0x1 << 3)
 #define VTT_GPIO_PIN_SHIFT	(0x4)
 #define VTT_GPIO_PIN_MASK	(0x3f << 4)
+#define IO_ISOLATION_STAT_SHIFT (10)
+#define IO_ISOLATION_STAT_MASK  (0x1 << 10)
 
 #endif /* __ARCH_ARM_MACH_OMAP2_PM33XX_H */
-- 
1.7.5.4

