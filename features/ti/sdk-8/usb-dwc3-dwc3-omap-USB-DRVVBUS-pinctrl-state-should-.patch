From 6ced628ede27e60468e6b0172a48762e71f334b2 Mon Sep 17 00:00:00 2001
From: George Cherian <george.cherian@ti.com>
Date: Tue, 16 Dec 2014 00:08:06 +0530
Subject: [PATCH 1557/1587] usb: dwc3: dwc3-omap: USB DRVVBUS pinctrl state
 should be set from wrapper

The USB DRVVBUS pinctrl state should be changed from the wrapper driver
rather than from the PHY driver. While testing suspend with DRD enabled,
it is seen that we miss interrupts since the pin state is switched to
default later by the PHY driver where as the wrapper driver starts using
the pin before that.

To avoid this maintain pin states in wrapper driver.

Signed-off-by: George Cherian <george.cherian@ti.com>
[nsekhar@ti.com: updates to patch description]
Signed-off-by: Sekhar Nori <nsekhar@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/usb/dwc3/dwc3-omap.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/usb/dwc3/dwc3-omap.c b/drivers/usb/dwc3/dwc3-omap.c
index 5ebdd78..4ccdef7 100644
--- a/drivers/usb/dwc3/dwc3-omap.c
+++ b/drivers/usb/dwc3/dwc3-omap.c
@@ -637,6 +637,7 @@ static int dwc3_omap_suspend(struct device *dev)
 	omap->utmi_otg_status = dwc3_omap_read_utmi_status(omap);
 	dwc3_omap_disable_irqs(omap);
 
+	pinctrl_pm_select_sleep_state(dev);
 	return 0;
 }
 
@@ -644,13 +645,14 @@ static int dwc3_omap_resume(struct device *dev)
 {
 	struct dwc3_omap	*omap = dev_get_drvdata(dev);
 
-	dwc3_omap_write_utmi_status(omap, omap->utmi_otg_status);
-	dwc3_omap_enable_irqs(omap);
+	pinctrl_pm_select_default_state(dev);
 
 	pm_runtime_disable(dev);
 	pm_runtime_set_active(dev);
 	pm_runtime_enable(dev);
 
+	dwc3_omap_write_utmi_status(omap, omap->utmi_otg_status);
+	dwc3_omap_enable_irqs(omap);
 	return 0;
 }
 
-- 
1.7.5.4

