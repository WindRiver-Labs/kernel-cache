From fba76bfda0c907b35e4923cac077f9d737c0720e Mon Sep 17 00:00:00 2001
From: Eyal Reizer <eyalreizer@gmail.com>
Date: Wed, 26 Nov 2014 16:46:11 +0200
Subject: [PATCH 1465/1587] tty: serial: omap: add option for external uart
 select

In some platforms the uart pins can be selected by a GPIO.
The GPIO for the UART selection is passed through DT and is an optional
property.
When passed, the GPIO is set once, at probe time.

Signed-off-by: Eyal Reizer <eyalr@ti.com>
Signed-off-by: Sekhar Nori <nsekhar@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/tty/serial/omap-serial.c |   21 +++++++++++++++++++++
 1 files changed, 21 insertions(+), 0 deletions(-)

diff --git a/drivers/tty/serial/omap-serial.c b/drivers/tty/serial/omap-serial.c
index 60c8db0..04c9497 100644
--- a/drivers/tty/serial/omap-serial.c
+++ b/drivers/tty/serial/omap-serial.c
@@ -1631,6 +1631,9 @@ static int serial_omap_probe(struct platform_device *pdev)
 	int uartirq = 0;
 	int wakeirq = 0;
 	int ret;
+	enum of_gpio_flags flags;
+	int gpio_sel;
+	unsigned long gpio_flags;
 
 	/* The optional wakeirq may be specified in the board dts file */
 	if (pdev->dev.of_node) {
@@ -1646,6 +1649,24 @@ static int serial_omap_probe(struct platform_device *pdev)
 			return -EPROBE_DEFER;
 	}
 
+	/* Check if the UART needs to be selected */
+	gpio_sel = of_get_gpio_flags(pdev->dev.of_node, 0, &flags);
+	if (gpio_is_valid(gpio_sel)) {
+		dev_dbg(&pdev->dev, "using gpio %d for uart%d_sel\n",
+			gpio_sel, pdev->id);
+		gpio_flags = (flags & OF_GPIO_ACTIVE_LOW) ?
+			GPIOF_OUT_INIT_LOW : GPIOF_OUT_INIT_HIGH;
+		ret = devm_gpio_request_one(&pdev->dev, gpio_sel,
+					    gpio_flags, "uart_sel");
+		if (ret) {
+			dev_err(&pdev->dev, "gpio%d request failed, ret %d\n",
+				gpio_sel, ret);
+			return ret;
+		}
+	} else if (gpio_sel == -EPROBE_DEFER) {
+		return -EPROBE_DEFER;
+	}
+
 	up = devm_kzalloc(&pdev->dev, sizeof(*up), GFP_KERNEL);
 	if (!up)
 		return -ENOMEM;
-- 
1.7.5.4

