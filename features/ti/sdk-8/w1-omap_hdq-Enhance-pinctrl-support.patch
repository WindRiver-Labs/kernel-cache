From ec5643205182fb3b0957f810ccda8bc40e4bc294 Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Mon, 11 Aug 2014 16:45:02 -0500
Subject: [PATCH 1035/1587] w1: omap_hdq: Enhance pinctrl support

Update omap-hdq driver to set the state of the pins to:
- "sleep" on suspend
- "default" on resume

By optionally putting the pins into sleep state in the suspend callback
we can accomplish two things.
- minimize current leakage from pins and thus save power,
- prevent the IP from driving pins output in an uncontrolled manner,
which may happen if the power domain drops the domain regulator.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
Signed-off-by: Sekhar Nori <nsekhar@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/w1/masters/omap_hdq.c |   58 ++++++++++++++++++++++++++++++----------
 1 files changed, 43 insertions(+), 15 deletions(-)

diff --git a/drivers/w1/masters/omap_hdq.c b/drivers/w1/masters/omap_hdq.c
index 97a8412..a9f662e 100644
--- a/drivers/w1/masters/omap_hdq.c
+++ b/drivers/w1/masters/omap_hdq.c
@@ -74,21 +74,6 @@ struct hdq_data {
 static int omap_hdq_probe(struct platform_device *pdev);
 static int omap_hdq_remove(struct platform_device *pdev);
 
-static const struct of_device_id omap_hdq_dt_match[] = {
-	{ .compatible = "ti,am43xx-hdq"},
-	{},
-};
-MODULE_DEVICE_TABLE(of, omap_hdq_dt_match);
-
-static struct platform_driver omap_hdq_driver = {
-	.probe =	omap_hdq_probe,
-	.remove =	omap_hdq_remove,
-	.driver =	{
-		.name =	"omap_hdq",
-		.of_match_table = of_match_ptr(omap_hdq_dt_match),
-	},
-};
-
 static u8 omap_w1_read_byte(void *_hdq);
 static void omap_w1_write_byte(void *_hdq, u8 byte);
 static u8 omap_w1_reset_bus(void *_hdq);
@@ -585,6 +570,33 @@ static void omap_w1_write_byte(void *_hdq, u8 byte)
 	}
 }
 
+
+#ifdef CONFIG_PM
+#ifdef CONFIG_PM_RUNTIME
+static int omap_hdq_runtime_suspend(struct device *dev)
+{
+	pinctrl_pm_select_sleep_state(dev);
+
+	return 0;
+}
+
+static int omap_hdq_runtime_resume(struct device *dev)
+{
+	pinctrl_pm_select_default_state(dev);
+
+	return 0;
+}
+#endif /* CONFIG_PM_RUNTIME */
+
+static const struct dev_pm_ops omap_hdq_pm_ops = {
+	SET_RUNTIME_PM_OPS(omap_hdq_runtime_suspend,
+			   omap_hdq_runtime_resume, NULL)
+};
+#define OMAP_HDQ_PM_OPS (&omap_hdq_pm_ops)
+#else
+#define OMAP_HDQ_PM_OPS NULL
+#endif /* CONFIG_PM */
+
 static int omap_hdq_probe(struct platform_device *pdev)
 {
 	struct device *dev = &pdev->dev;
@@ -683,6 +695,22 @@ static int omap_hdq_remove(struct platform_device *pdev)
 	return 0;
 }
 
+static const struct of_device_id omap_hdq_dt_match[] = {
+	{ .compatible = "ti,am43xx-hdq"},
+	{},
+};
+MODULE_DEVICE_TABLE(of, omap_hdq_dt_match);
+
+static struct platform_driver omap_hdq_driver = {
+	.probe =	omap_hdq_probe,
+	.remove =	omap_hdq_remove,
+	.driver =	{
+		.name =	"omap_hdq",
+		.pm = OMAP_HDQ_PM_OPS,
+		.of_match_table = of_match_ptr(omap_hdq_dt_match),
+	},
+};
+
 module_platform_driver(omap_hdq_driver);
 
 module_param(w1_id, int, S_IRUSR);
-- 
1.7.5.4

