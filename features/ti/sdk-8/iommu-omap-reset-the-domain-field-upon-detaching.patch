From 75641b1c7fb8bc05ec578a1115404e0b00ce5eca Mon Sep 17 00:00:00 2001
From: Suman Anna <s-anna@ti.com>
Date: Thu, 2 Oct 2014 13:02:59 -0500
Subject: [PATCH 1265/1587] iommu/omap: reset the domain field upon detaching

The .domain field in omap_iommu struct is set properly when the
OMAP IOMMU device is attached to, but is never reset properly
on detach. Reset this properly so that the OMAP IOMMU debugfs
logic can depend on this field before allowing the debugfs
operations.

Signed-off-by: Suman Anna <s-anna@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/iommu/omap-iommu.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/iommu/omap-iommu.c b/drivers/iommu/omap-iommu.c
index 7adb815..43dbca3 100644
--- a/drivers/iommu/omap-iommu.c
+++ b/drivers/iommu/omap-iommu.c
@@ -1279,6 +1279,7 @@ attach_fail:
 		omap_iommu_detach(oiommu);
 		iommu->iommu_dev = NULL;
 		arch_data->iommu_dev = NULL;
+		oiommu->domain = NULL;
 	};
 init_fail:
 	omap_iommu_detach_fini(omap_domain);
@@ -1319,6 +1320,7 @@ static void _omap_iommu_detach_dev(struct omap_iommu_domain *omap_domain,
 		omap_iommu_detach(oiommu);
 		iommu->iommu_dev = NULL;
 		arch_data->iommu_dev = NULL;
+		oiommu->domain = NULL;
 	}
 
 	omap_iommu_detach_fini(omap_domain);
-- 
1.7.5.4

