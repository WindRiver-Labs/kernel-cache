From 4235051b62afe3a2952b82aa8bae84356ff51503 Mon Sep 17 00:00:00 2001
From: Suman Anna <s-anna@ti.com>
Date: Tue, 29 Jul 2014 16:47:44 -0500
Subject: [PATCH 0893/1587] mailbox/omap: fix node reference count in
 omap_mbox_of_xlate

The function of_find_node_by_phandle increments the reference
count for the node object, and should be used in tandem with
a matching of_node_put, after using the node. Fixup the
omap_mbox_of_xlate to add this missing of_node_put. The code
is rearranged slightly to invoke of_node_put only once.

Signed-off-by: Suman Anna <s-anna@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/mailbox/omap-mailbox.c |   12 +++++++-----
 1 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/drivers/mailbox/omap-mailbox.c b/drivers/mailbox/omap-mailbox.c
index f6ab095..66b83ca 100644
--- a/drivers/mailbox/omap-mailbox.c
+++ b/drivers/mailbox/omap-mailbox.c
@@ -637,17 +637,19 @@ static struct mbox_chan *omap_mbox_of_xlate(struct mbox_controller *controller,
 	struct omap_mbox_device *mdev;
 	struct omap_mbox *mbox;
 
+	mdev = container_of(controller, struct omap_mbox_device, controller);
+	if (WARN_ON(!mdev))
+		return NULL;
+
 	node = of_find_node_by_phandle(phandle);
 	if (!node) {
-		pr_err("could not find node phandle 0x%x\n", phandle);
+		pr_err("%s: could not find node phandle 0x%x\n",
+		       __func__, phandle);
 		return NULL;
 	}
 
-	mdev = container_of(controller, struct omap_mbox_device, controller);
-	if (WARN_ON(!mdev))
-		return NULL;
-
 	mbox = omap_mbox_device_find(mdev, node->name);
+	of_node_put(node);
 	return mbox ? mbox->chan : NULL;
 }
 
-- 
1.7.5.4

