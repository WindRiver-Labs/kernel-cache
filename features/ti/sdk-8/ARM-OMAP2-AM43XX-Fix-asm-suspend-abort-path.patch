From 38054e921554957a0d1c00728edb9ec9d47f2ae3 Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Fri, 8 Aug 2014 16:55:39 -0500
Subject: [PATCH 0957/1587] ARM: OMAP2+: AM43XX: Fix asm suspend abort path

During suspend abort path we must remove CKE override on EMIF otherwise
DDR will not be able to come out of self refresh correctly.

Also, remove write to EMIF_SDRAM_CONFIG register in abort path that was
mistakenly added.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 arch/arm/mach-omap2/sleep43xx.S |   15 +++++----------
 1 files changed, 5 insertions(+), 10 deletions(-)

diff --git a/arch/arm/mach-omap2/sleep43xx.S b/arch/arm/mach-omap2/sleep43xx.S
index d60e3fa..15fa9e2 100644
--- a/arch/arm/mach-omap2/sleep43xx.S
+++ b/arch/arm/mach-omap2/sleep43xx.S
@@ -314,6 +314,11 @@ wait_emif_enable:
 	cmp	r2, r3
 	bne	wait_emif_enable
 
+	/* disable CKE override for both CKE0 and CKE1 */
+	ldr    r2, cke_override_virt
+	mov    r1, #3
+	str    r1, [r2]
+
 	/* Disable EMIF self-refresh */
 	ldr	r0, emif_addr_virt
 	ldr	r1, [r0, #EMIF_POWER_MANAGEMENT_CONTROL]
@@ -322,16 +327,6 @@ wait_emif_enable:
 	str	r1, [r0, #EMIF_POWER_MANAGEMENT_CTRL_SHDW]
 
 	/*
-	 * A write to SDRAM CONFIG register triggers
-	 * an init sequence and hence it must be done
-	 * at the end for DDR2
-	 */
-	ldr r0, emif_addr_virt
-	add r0, r0, #EMIF_SDRAM_CONFIG
-	ldr r4, emif_sdcfg_val
-	str r4, [r0]
-
-	/*
 	 * Set SCTLR.C bit to allow data cache allocation
 	 */
 	mrc	p15, 0, r0, c1, c0, 0
-- 
1.7.5.4

