From b48e178d750b7c03c8898225294d5543556299fc Mon Sep 17 00:00:00 2001
From: Benoit Parrot <bparrot@ti.com>
Date: Thu, 20 Nov 2014 17:29:11 -0600
Subject: [PATCH 1456/1587] v4l: ti-vpe: vip: fix vip_set_clock_enable for
 multi slice

The vip_set_clock_enable function directly writes to the VIP_CLK_ENABLE
register without reading it first. This register is shared for enabling
clocks for both of the slices. Due to this, enabling one slice would
disable the other. Fix this by updating only the required bits.

Signed-off-by: Nikhil Devshatwar <nikhil.nd@ti.com>
Signed-off-by: Benoit Parrot <bparrot@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/media/platform/ti-vpe/vip.c |   18 ++++++++++++++----
 1 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/drivers/media/platform/ti-vpe/vip.c b/drivers/media/platform/ti-vpe/vip.c
index 44d1cca..e966d2e 100644
--- a/drivers/media/platform/ti-vpe/vip.c
+++ b/drivers/media/platform/ti-vpe/vip.c
@@ -365,13 +365,23 @@ static void vip_set_clock_enable(struct vip_dev *dev, bool on)
 {
 	u32 val = 0;
 
+	val = read_vreg(dev, VIP_CLK_ENABLE);
 	if (on) {
+		val |= VIP_VPDMA_CLK_ENABLE;
 		if (dev->slice_id == VIP_SLICE1)
-			val = VIP_VIP1_DATA_PATH_CLK_ENABLE |
-				VIP_VPDMA_CLK_ENABLE;
+			val |= VIP_VIP1_DATA_PATH_CLK_ENABLE;
 		else
-			val = VIP_VIP2_DATA_PATH_CLK_ENABLE |
-				VIP_VPDMA_CLK_ENABLE;
+			val |= VIP_VIP2_DATA_PATH_CLK_ENABLE;
+	} else {
+		if (dev->slice_id == VIP_SLICE1)
+			val &= ~VIP_VIP1_DATA_PATH_CLK_ENABLE;
+		else
+			val &= ~VIP_VIP2_DATA_PATH_CLK_ENABLE;
+
+		/* Both VIP are disabled then shutdown VPDMA also */
+		if (!(val & (VIP_VIP1_DATA_PATH_CLK_ENABLE|
+			     VIP_VIP2_DATA_PATH_CLK_ENABLE)))
+			val = 0;
 	}
 
 	write_vreg(dev, VIP_CLK_ENABLE, val);
-- 
1.7.5.4

