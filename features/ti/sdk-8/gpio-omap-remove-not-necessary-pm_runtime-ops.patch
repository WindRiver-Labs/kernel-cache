From d917638b40333c51bfd39218bbc908f666d91d1a Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Thu, 20 Mar 2014 14:59:07 +0800
Subject: [PATCH 2/2] gpio: omap: remove not necessary pm_runtime ops

This patch is to remove not properly usage in gpio irq handler,
and we have three reasons:

1 ) It will trigger flooded calltraces in rt kernel due to a lot of
    spin-lock in pm_runtime related function as follows:

    BUG: sleeping function called from invalid context at kernel/rtmutex.c:659
    in_atomic(): 1, irqs_disabled(): 128, pid: 0, name: swapper/0
    Preemption disabled at:[<  (null)>]   (null)

    CPU: 0 PID: 0 Comm: swapper/0 Not tainted 3.10.19-rt11-WR6.0.0.0_preempt-rt #3
    [<c0018b9c>] (unwind_backtrace+0x0/0x100) from [<c0013910>] (show_stack+0x20/0x24)
    [<c0013910>] (show_stack+0x20/0x24) from [<c07eecd4>] (dump_stack+0x24/0x28)
    [<c07eecd4>] (dump_stack+0x24/0x28) from [<c007972c>] (__might_sleep+0x118/0x174)
    [<c007972c>] (__might_sleep+0x118/0x174) from [<c07f381c>] (rt_spin_lock+0x2c/0x38)
    [<c07f381c>] (rt_spin_lock+0x2c/0x38) from [<c0473eb0>] (__pm_runtime_resume+0x64/0x9c)
    [<c0473eb0>] (__pm_runtime_resume+0x64/0x9c) from [<c039cd84>] (gpio_irq_handler+0x64/0x228)
    [<c039cd84>] (gpio_irq_handler+0x64/0x228) from [<c00c081c>] (generic_handle_irq+0x3c/0x4c)
    [<c00c081c>] (generic_handle_irq+0x3c/0x4c) from [<c000fc98>] (handle_IRQ+0x50/0xa0)
    [<c000fc98>] (handle_IRQ+0x50/0xa0) from [<c0008864>] (omap3_intc_handle_irq+0x78/0x84)
    [<c0008864>] (omap3_intc_handle_irq+0x78/0x84) from [<c000e880>] (__irq_svc+0x40/0x84)
    Exception stack(0xc0b87e28 to 0xc0b87e70)
    7e20:                   00000001 c0b95a48 c0b86000 00008222 00000000 c1124140
    7e40: ddc724c0 00000002 ddbaa800 c0b928f8 00000000 c0b87e7c c0b87e80 c0b87e70
    7e60: c00789e4 c07f3e98 600f0013 ffffffff
    [<c000e880>] (__irq_svc+0x40/0x84) from [<c07f3e98>] (_raw_spin_unlock_irq+0x34/0x64)
    [<c07f3e98>] (_raw_spin_unlock_irq+0x34/0x64) from [<c00789e4>] (finish_task_switch+0x64/0x104)
    [<c00789e4>] (finish_task_switch+0x64/0x104) from [<c07f20ec>] (__schedule+0x2fc/0x58c)
    [<c07f20ec>] (__schedule+0x2fc/0x58c) from [<c07f23bc>] (schedule+0x40/0xac)
    [<c07f23bc>] (schedule+0x40/0xac) from [<c07f2a38>] (schedule_preempt_disabled+0x20/0x2c)
    [<c07f2a38>] (schedule_preempt_disabled+0x20/0x2c) from [<c009028c>] (cpu_startup_entry+0x114/0x2ac)
    [<c009028c>] (cpu_startup_entry+0x114/0x2ac) from [<c07e22b4>] (rest_init+0x94/0x98)
    [<c07e22b4>] (rest_init+0x94/0x98) from [<c0aefb68>] (start_kernel+0x354/0x360)
    wlcore: firmware booted (Rev 6.3.10.0.133)
    IPv6: ADDRCONF(NETDEV_UP): wlan0: link is not ready

2 ) No operations on bank->dev are involved in the irq handler.

3 ) Geneally speaking, the irq handler is not supposed to process
    this kind issue, unless for hardware design flaws.

So I remove this mal-usage of pm_runtime on gpio-omap.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpio/gpio-omap.c |    2 --
 1 files changed, 0 insertions(+), 2 deletions(-)

diff --git a/drivers/gpio/gpio-omap.c b/drivers/gpio/gpio-omap.c
index 9962da4..b6815bf 100644
--- a/drivers/gpio/gpio-omap.c
+++ b/drivers/gpio/gpio-omap.c
@@ -738,7 +738,6 @@ static void gpio_irq_handler(unsigned int irq, struct irq_desc *desc)
 
 	bank = irq_get_handler_data(irq);
 	isr_reg = bank->base + bank->regs->irqstatus;
-	pm_runtime_get_sync(bank->dev);
 
 	if (WARN_ON(!isr_reg))
 		goto exit;
@@ -794,7 +793,6 @@ static void gpio_irq_handler(unsigned int irq, struct irq_desc *desc)
 exit:
 	if (!unmasked)
 		chained_irq_exit(chip, desc);
-	pm_runtime_put(bank->dev);
 }
 
 static void gpio_irq_shutdown(struct irq_data *d)
-- 
1.7.5.4

