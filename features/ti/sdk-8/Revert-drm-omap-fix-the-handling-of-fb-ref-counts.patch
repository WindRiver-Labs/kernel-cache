From 094635d8e05c1b70b1d50ce8519f4e60d70c2018 Mon Sep 17 00:00:00 2001
From: Tomi Valkeinen <tomi.valkeinen@ti.com>
Date: Wed, 3 Sep 2014 19:25:48 +0000
Subject: [PATCH 1148/1587] Revert "drm/omap: fix the handling of fb ref
 counts"

This reverts commit 2ec07ba724943da09ba8b11bfcc10d81d06a4600.

Commit 2ec07ba724943da09ba8b11bfcc10d81d06a4600, which was backported
from mainline (f2d022aa421ca903a30f63b04528064b7eceaf5e), does not work
correctly.

The original commit was made to fix fb refcount issue on top of
mainline, which contains the new primary-plane support for drm. However,
our kernel does not have the primary-plane support, and the commit
actually breaks fb refcounting.

The issue shows when unloading omapdrm, which causes a WARN to be
printed as the root fb still has references. After reverting the patch,
the problem disappears.

Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ti.com>
Signed-off-by: Darren Etheridge <detheridge@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/gpu/drm/omapdrm/omap_plane.c |   10 +++++-----
 1 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/drivers/gpu/drm/omapdrm/omap_plane.c b/drivers/gpu/drm/omapdrm/omap_plane.c
index 6af3398..b1dd6b9 100644
--- a/drivers/gpu/drm/omapdrm/omap_plane.c
+++ b/drivers/gpu/drm/omapdrm/omap_plane.c
@@ -225,11 +225,6 @@ int omap_plane_mode_set(struct drm_plane *plane,
 		omap_plane->apply_done_cb.arg = arg;
 	}
 
-	if (plane->fb)
-		drm_framebuffer_unreference(plane->fb);
-
-	drm_framebuffer_reference(fb);
-
 	plane->fb = fb;
 	plane->crtc = crtc;
 
@@ -246,6 +241,11 @@ static int omap_plane_update(struct drm_plane *plane,
 	struct omap_plane *omap_plane = to_omap_plane(plane);
 	omap_plane->enabled = true;
 
+	if (plane->fb)
+		drm_framebuffer_unreference(plane->fb);
+
+	drm_framebuffer_reference(fb);
+
 	/* omap_plane_mode_set() takes adjusted src */
 	switch (omap_plane->win.rotation & 0xf) {
 	case BIT(DRM_ROTATE_90):
-- 
1.7.5.4

