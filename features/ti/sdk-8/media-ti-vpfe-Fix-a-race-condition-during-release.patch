From a76d4c347ffeb575138f6960834028738adfb6d5 Mon Sep 17 00:00:00 2001
From: Benoit Parrot <bparrot@ti.com>
Date: Fri, 7 Nov 2014 12:52:22 -0600
Subject: [PATCH 1319/1587] media: ti-vpfe: Fix a race condition during
 release

There was a race condition where during cleanup/release operationx
on-going streaming would cause a kernel panic beacuse the hardware
module was disabled prematurely with IRQ still pending.

Signed-off-by: Benoit Parrot <bparrot@ti.com>
[zou: Original patch taken from
ti-sdk-am335x-evm-08.00.00.00-Linux-x86-Install.bin]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/media/platform/ti-vpfe/vpfe.c |   11 ++++++++---
 1 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/drivers/media/platform/ti-vpfe/vpfe.c b/drivers/media/platform/ti-vpfe/vpfe.c
index f8e4400..108fb46 100644
--- a/drivers/media/platform/ti-vpfe/vpfe.c
+++ b/drivers/media/platform/ti-vpfe/vpfe.c
@@ -1744,20 +1744,25 @@ static void vpfe_stop_isif_capture(struct vpfe_device *dev)
 static int vpfe_release(struct file *file)
 {
 	struct vpfe_device *dev = video_drvdata(file);
+	bool fh_singular = v4l2_fh_is_singular_file(file);
+	int ret;
 
 	vpfe_dbg(2, dev, "vpfe_release\n");
 
+	/* the release helper will cleanup any on-going streaming */
+	ret = vb2_fop_release(file);
+
 	/*
-	 * If this is the last open file.
+	 * If this was the last open file.
 	 * Then de-initialize hw module.
 	 */
-	if (v4l2_fh_is_singular_file(file)) {
+	if (fh_singular) {
 		mutex_lock(&dev->lock);
 		isif_close(&dev->vpfe_isif, dev->pdev);
 		mutex_unlock(&dev->lock);
 	}
 
-	return vb2_fop_release(file);
+	return ret;
 }
 
 static int vpfe_querycap(struct file *file, void  *priv,
-- 
1.7.5.4

