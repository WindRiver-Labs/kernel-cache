From 9d9660bcb56881bafe7d8a786de00f9729b7e6ba Mon Sep 17 00:00:00 2001
From: Samuel Ortiz <sameo@linux.intel.com>
Date: Fri, 10 May 2013 15:53:29 +0200
Subject: [PATCH 12/44] NFC: Remove and free all SEs when releasing an NFC
 device

Signed-off-by: Samuel Ortiz <sameo@linux.intel.com>
(cherry picked from commit e34c6e21f7fa009b12318c561b38171755989e1e)
---
 net/nfc/core.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/net/nfc/core.c b/net/nfc/core.c
index bb5f16c..5b60b9d 100644
--- a/net/nfc/core.c
+++ b/net/nfc/core.c
@@ -820,11 +820,19 @@ EXPORT_SYMBOL(nfc_remove_se);
 static void nfc_release(struct device *d)
 {
 	struct nfc_dev *dev = to_nfc_dev(d);
+	struct nfc_se *se, *n;
 
 	pr_debug("dev_name=%s\n", dev_name(&dev->dev));
 
 	nfc_genl_data_exit(&dev->genl_data);
 	kfree(dev->targets);
+
+	list_for_each_entry_safe(se, n, &dev->secure_elements, list) {
+			nfc_genl_se_removed(dev, se->idx);
+			list_del(&se->list);
+			kfree(se);
+	}
+
 	kfree(dev);
 }
 
-- 
1.8.4.93.g57e4c17

