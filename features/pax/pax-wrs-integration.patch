From a45536b84ed8e1a9e4d7908c3c34c869be27a503 Mon Sep 17 00:00:00 2001
From: auto commit <unknown@unknown>
Date: Fri, 11 Jul 2008 14:59:08 -0400
Subject: [PATCH] auto_msg: importing pax-wrs-integration.patch

This is an automatic import of patch pax-wrs-integration.patch, no headers were
detected and a default message was constructed
---
 arch/x86/kernel/immediate.c |    2 +-
 kernel/module.c             |    6 +++---
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/arch/x86/kernel/immediate.c b/arch/x86/kernel/immediate.c
index 94aad5e..989b348 100644
--- a/arch/x86/kernel/immediate.c
+++ b/arch/x86/kernel/immediate.c
@@ -146,7 +146,7 @@ static int imv_notifier(struct notifier_block *nb,
 	enum die_val die_val = (enum die_val) val;
 	struct die_args *args = data;
 
-	if (!args->regs || user_mode_vm(args->regs))
+	if (!args->regs || user_mode(args->regs))
 		return NOTIFY_DONE;
 
 	if (die_val == DIE_INT3) {
diff --git a/kernel/module.c b/kernel/module.c
index 3d6a994..8c4172b 100644
--- a/kernel/module.c
+++ b/kernel/module.c
@@ -2458,12 +2458,12 @@ sys_init_module(void __user *umod,
 	module_put(mod);
 	unwind_remove_table(mod->unwind_info, 1);
 #ifdef USE_IMMEDIATE
-	if(mod->module_init_rx)
+	if(mod->module_init_rw)
 		imv_unref(mod->immediate, mod->immediate + mod->num_immediate,
-			mod->module_init_rx, mod->init_size_rx);
+			mod->module_init_rw, mod->init_size_rw);
 	else
 		imv_unref(mod->immediate, mod->immediate + mod->num_immediate,
-			mod->module_init_tx, mod->init_size_tx);
+			mod->module_init_rx, mod->init_size_rx);
 
 #endif
 	module_free(mod, mod->module_init_rw);
-- 
1.5.5.1

