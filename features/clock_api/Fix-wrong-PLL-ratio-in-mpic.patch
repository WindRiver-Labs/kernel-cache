From 76d5df3bf2c8aea9cfc0db5abd3b23ee5d4b4bbd Mon Sep 17 00:00:00 2001
From: Liang Li <Liang.Li@windriver.com>
Date: Sat, 23 Aug 2008 18:34:07 +0800
Subject: [PATCH] Fix wrong hard code PLL ratio in mpic for sbc8560

The original HWTimer implementation of mpic was
hard coded the PLL ratio to 2/5.It is improper to
hard code a ratio to source code since the PLL
ratio in sbc8560 board is determined by switches
on the board.

The MPC85xx boards have the same definition of HID1
register,so this patch use CONFIG_MPC85xx to
conditional modify the original code.

Signed-off-by: Liang Li <Liang.Li@windriver.com>
---
 arch/powerpc/sysdev/mpic.c |   14 ++++++++++++++
 1 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/sysdev/mpic.c b/arch/powerpc/sysdev/mpic.c
index 6cbe5fc..51612ae 100644
--- a/arch/powerpc/sysdev/mpic.c
+++ b/arch/powerpc/sysdev/mpic.c
@@ -270,7 +270,14 @@ static inline void _mpic_irq_write(struct mpic *mpic, unsigned int src_no,
 #include <linux/delay.h>
 
 #define TIMER_DEFAULT_DIVISOR 8
+#ifdef CONFIG_MPC85xx
+static int pll_divisor[4]={1,2,1,2};
+static int pll_dividend[4]={2,5,3,7};
+static int pll_index=1;
+#define PROC_PLL_RATIO pll_divisor[pll_index]/pll_dividend[pll_index]
+#else
 #define PROC_PLL_RATIO 2/5
+#endif
 
 static unsigned long mpic_hwtimer_freq = 0;
 
@@ -1493,6 +1500,13 @@ void __init mpic_init(struct mpic *mpic)
 
 
 #ifdef CONFIG_HWTIMER_HOOKS
+#ifdef CONFIG_MPC85xx
+	uint phid1;
+	phid1=mfspr(SPRN_HID1);
+	pll_index=((phid1 >> 24) & 0x3f) - 4;
+	if(pll_index < 0 || pll_index >3)
+		pll_index=1;	/*As DEFAULT setting*/
+#endif
 	mpic_timer_chip.typename = mpic->name;
 	mpic_hwtimer_freq = mpic_hwtimer_data.def_freq;
 	register_hwtimer(&mpic_hwtimer);
-- 
1.5.5.1

