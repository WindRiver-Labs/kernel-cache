Add clock API support for broadcom1250.

wrs_severity: critical
wrs_scope: bsp

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 b/arch/mips/sibyte/sb1250/time.c |   42 +++++++++++++++++++++++++++++++++++++++
 1 files changed, 42 insertions(+)
---

--- a/arch/mips/sibyte/sb1250/time.c
+++ b/arch/mips/sibyte/sb1250/time.c
@@ -53,6 +53,36 @@ extern int sb1250_steal_irq(int irq);
 
 static cycle_t sb1250_hpt_read(void);
 
+#ifdef CONFIG_HWTIMER_HOOKS
+#include <linux/hwtimer.h>
+
+int sb1250_timer_get_freq(void)
+{
+	return HZ;
+}
+
+static struct hwtimer_data sb1250_timer_data = {
+	.name = "SB1250 timer",
+	.desc = "SB1250 Kernel jiffy timer",
+	.def_freq = HZ,
+	.min_freq = HZ,
+	.max_freq = HZ
+};
+
+static DECLARE_HWTIMER_LOCK(sb1250_timer_lock);
+
+static struct hwtimer sb1250_timer = {
+	.data = &sb1250_timer_data,
+	.set_freq = NULL,
+	.get_freq = sb1250_timer_get_freq,
+	.start = NULL,
+	.stop = NULL,
+	.lock = &sb1250_timer_lock,
+	.hook = NULL,
+	.hook_data = NULL
+};
+#endif /* CONFIG_HWTIMER_HOOKS */
+
 void __init sb1250_hpt_setup(void)
 {
 	int cpu = smp_processor_id();
@@ -100,6 +130,11 @@ void sb1250_time_init(void)
 	if (cpu > 2) {
 		BUG();
 	}
+	
+#ifdef CONFIG_HWTIMER_HOOKS
+	if (cpu == 0)
+		register_hwtimer(&sb1250_timer);
+#endif /* CONFIG_HWTIMER_HOOKS */
 
 	sb1250_mask_irq(cpu, irq);
 
@@ -145,6 +180,13 @@ void sb1250_timer_interrupt(void)
 		       IOADDR(A_SCD_TIMER_REGISTER(cpu, R_SCD_TIMER_CFG)));
 
 	if (cpu == 0) {
+#ifdef CONFIG_HWTIMER_HOOKS
+		spin_lock(sb1250_timer.lock);
+		if (sb1250_timer.hook != NULL)
+			(sb1250_timer.hook)(sb1250_timer.hook_data);
+		spin_unlock(sb1250_timer.lock);
+#endif /* CONFIG_HWTIMER_HOOKS */
+
 		/*
 		 * CPU 0 handles the global timer interrupt job
 		 */
