Add clock API support for Cavium Octeon.

wrs_severity: critical
wrs_scope: bsp

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 b/arch/mips/cavium-octeon/setup.c |   45 +++++++++++++++++++++++++++++++++++++-
 1 files changed, 44 insertions(+), 1 deletion(-)
---

--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -49,6 +49,36 @@ extern asmlinkage void octeon_handle_irq
 static uint64_t CYCLES_PER_JIFFY;
 static int ECC_REPORT_SINGLE_BIT_ERRORS = 0;
 
+#ifdef CONFIG_HWTIMER_HOOKS
+#include <linux/hwtimer.h>
+
+int octeon_timer_get_freq(void)
+{
+       return HZ;
+}
+
+static struct hwtimer_data octeon_timer_data = {
+       .name = "Cavium Octeon timer",
+       .desc = "Cavium Octeon Kernel jiffy timer",
+       .def_freq = HZ,
+       .min_freq = HZ,
+       .max_freq = HZ
+};
+
+static DECLARE_HWTIMER_LOCK(octeon_timer_lock);
+
+static struct hwtimer octeon_timer = {
+       .data = &octeon_timer_data,
+       .set_freq = NULL,
+       .get_freq = octeon_timer_get_freq,
+       .start = NULL,
+       .stop = NULL,
+       .lock = &octeon_timer_lock,
+       .hook = NULL,
+       .hook_data = NULL
+};
+#endif /* CONFIG_HWTIMER_HOOKS */
+
 /**
  * Return the version string. Generated from CVS tags. Turns
  * NAME_V_V_V_build_B into "V.V.V, build B". If the tag isn't of
@@ -231,8 +261,16 @@ static irqreturn_t octeon_main_timer_int
 {
     if (read_c0_count() - read_c0_compare() >= 0)
     {
-        if (smp_processor_id() == 0)
+        if (smp_processor_id() == 0) {
+#ifdef CONFIG_HWTIMER_HOOKS
+               spin_lock(octeon_timer.lock);
+               if (octeon_timer.hook != NULL)
+                       (octeon_timer.hook)(octeon_timer.hook_data);
+               spin_unlock(octeon_timer.lock);
+#endif /* CONFIG_HWTIMER_HOOKS */
+
             timer_interrupt(irq, NULL);
+	}
         else
         {
             octeon_timer_ack();
@@ -255,6 +293,11 @@ static void __init octeon_timer_setup(st
     irq->flags |= IRQF_SHARED;
     setup_irq(7, irq);
 
+#ifdef CONFIG_HWTIMER_HOOKS
+       if (smp_processor_id() == 0)
+               register_hwtimer(&octeon_timer);
+#endif /* CONFIG_HWTIMER_HOOKS */
+
     write_c0_compare(read_c0_count() + CYCLES_PER_JIFFY);
 }
 
