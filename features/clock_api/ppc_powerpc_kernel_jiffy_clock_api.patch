From 314d646d3e6fea64d06bd7fb1ce55c94a5429498 Mon Sep 17 00:00:00 2001
From: auto commit <unknown@unknown>
Date: Thu, 3 Jul 2008 16:42:03 -0400
Subject: [PATCH] kernel jiffy clock API drivers for wrs_sbc405gp, wrs_sbc85x0

amcc_yosemite_440ep,xilinx_ml300, xilinx_ml403, mot_atca6101, fsl_hpcii.

wrs_severity: new_functionality
wrs_scope: driver

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 arch/powerpc/kernel/time.c |   48 ++++++++++++++++++++++++++++++++++++++++++++
 1 files changed, 48 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/time.c b/arch/powerpc/kernel/time.c
index e2ee66b..f84d4cf 100644
--- a/arch/powerpc/kernel/time.c
+++ b/arch/powerpc/kernel/time.c
@@ -857,6 +857,43 @@ static int decrementer_set_next_event(unsigned long evt,
 	return 0;
 }
 
+#if defined(CONFIG_HWTIMER_HOOKS) && ( defined(CONFIG_PPC_MAPLE) )
+ #define HWTIMER_USE_JIFFY 1
+#endif
+
+#if defined(HWTIMER_USE_JIFFY)
+
+#include <linux/hwtimer.h>
+
+static int powerpc_timer_get_freq(void)
+{
+       return HZ;
+}
+
+static struct hwtimer_data powerpc_timer_data = {
+       name: "PowerPC timer",
+       desc: "PowerPC kernel jiffy timer",
+       def_freq: HZ,
+       min_freq: HZ,
+       max_freq: HZ
+};
+
+static DECLARE_HWTIMER_LOCK(powerpc_timer_lock);
+
+static struct hwtimer powerpc_timer = {
+       data: &powerpc_timer_data,
+       set_freq: NULL,
+       get_freq: powerpc_timer_get_freq,
+       start: NULL,
+       stop: NULL,
+       lock: &powerpc_timer_lock,
+       hook: NULL,
+       hook_data: NULL
+};
+
+#endif  /*  CONFIG_HWTIMER_HOOKS */
+
+
 static void decrementer_set_mode(enum clock_event_mode mode,
 				 struct clock_event_device *dev)
 {
@@ -867,6 +904,13 @@ static void decrementer_set_mode(enum clock_event_mode mode,
 static void register_decrementer_clockevent(int cpu)
 {
 	struct clock_event_device *dec = &per_cpu(decrementers, cpu).event;
+#if defined(HWTIMER_USE_JIFFY)
+		spin_lock(powerpc_timer.lock);
+		if (powerpc_timer.hook != NULL) {
+			(powerpc_timer.hook) (powerpc_timer.hook_data);
+		}
+		spin_unlock(powerpc_timer.lock);
+#endif  /*  CONFIG_HWTIMER_HOOKS */
 
 	*dec = decrementer_clockevent;
 	dec->cpumask = cpumask_of_cpu(cpu);
@@ -881,6 +925,10 @@ static void __init init_decrementer_clockevent(void)
 {
 	int cpu = smp_processor_id();
 
+#if defined(HWTIMER_USE_JIFFY)
+	register_hwtimer(&powerpc_timer);
+#endif  /*  CONFIG_HWTIMER_HOOKS */
+
 	decrementer_clockevent.mult = div_sc(ppc_tb_freq, NSEC_PER_SEC,
 					     decrementer_clockevent.shift);
 	decrementer_clockevent.max_delta_ns =
-- 
1.5.5.1

