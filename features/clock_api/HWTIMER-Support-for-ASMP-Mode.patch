From b219888b009387e19d9e2fd6457ce4ff32423232 Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Tue, 21 Oct 2008 10:11:49 +0800
Subject: [PATCH] HWTIMER Support for ASMP Mode

Add HWTIMER support for ASMP Mode.
HWTIMER can work on both core0 and core1.

Signed-off-by: Li Wang <li.wang@windriver.com>
---
 arch/powerpc/sysdev/mpic.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/sysdev/mpic.c b/arch/powerpc/sysdev/mpic.c
index 51612ae..d3e13c1 100644
--- a/arch/powerpc/sysdev/mpic.c
+++ b/arch/powerpc/sysdev/mpic.c
@@ -281,7 +281,11 @@ static int pll_index=1;
 
 static unsigned long mpic_hwtimer_freq = 0;
 
+#ifdef CONFIG_ASMP
+#define mpic_hwtimer_index (raw_asmp_processor_id())
+#else
 static int mpic_hwtimer_index = 0;
+#endif
 static int mpic_hwtimer_irq = 0;
 static DECLARE_HWTIMER_LOCK(mpic_hwtimer_lock);
 static struct hwtimer_data mpic_hwtimer_data;
@@ -327,7 +331,11 @@ static int mpic_hwtimer_start(void)
 	mpic_write(mpic->tmregs,
 		   mpic_hwtimer_index * MPIC_INFO(TIMER_STRIDE) +
 		   MPIC_INFO(TIMER_DESTINATION),
+#ifdef CONFIG_ASMP
+		   1 << raw_asmp_processor_id());
+#else
 		   1);
+#endif
 
 	/* Set ticks. */
 	mpic_write(mpic->tmregs,
-- 
1.6.0.90.g436ed

