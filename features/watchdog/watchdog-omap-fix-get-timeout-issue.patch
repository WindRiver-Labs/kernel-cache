From 80f7bceb755c6a65cde9d5fd327a6e5ab3b71f84 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Tue, 14 Aug 2012 11:14:32 +0800
Subject: [PATCH] watchdog: omap: fix get timeout issue

There are two fixes in this patch as follows:

1. In omap_wdt_set_timeout, new_timeout may be changed and will be set
   to timer_margin by omap_wdt_adjust_timeout, which is a temporary and
   middle variable; And then timer_margin will be transferred to a proper
   pre_margin to drive the watchdog timer, so we save timer_margin in
   wdt_dev->timeout as an interface to ioctl(watchdog_dev.c) after having
   finished omap_wdt_set_timeout;

2. In omap_wdt_probe, we initialize timer_margin as TIMER_MARGIN_DEFAULT in
   omap_wdt_adjust_timeout. Because omap_wdt_start will take timer_margin
   as a parameter to call omap_wdt_set_timeout to open /dev/watchdog, if
   timer_margin(new_timeout in omap_wdt_set_timeout) is zero, then it will
   be set to wdt_dev->timeout without the above first fix, although no impact
   on pre_margin due to omap_wdt_adjust_timeout. So in this case, GET_TIMEOUT
   will be failure in watchdog_dev.c because of zero timeout.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/watchdog/omap_wdt.c |    4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/watchdog/omap_wdt.c b/drivers/watchdog/omap_wdt.c
index cc5bc3e..6d8911d 100644
--- a/drivers/watchdog/omap_wdt.c
+++ b/drivers/watchdog/omap_wdt.c
@@ -126,7 +126,7 @@ static int omap_wdt_set_timeout(struct watchdog_device *wdt_dev,
 		cpu_relax();
 
 	omap_wdt_enable(omap_wdev);
-	wdt_dev->timeout = new_timeout;
+	wdt_dev->timeout = timer_margin;
 	pm_runtime_put_sync(omap_wdev->dev);
 	return 0;
 }
@@ -234,7 +234,7 @@ static int __devinit omap_wdt_probe(struct platform_device *pdev)
 	omap_wdev = &omap_drvdata->wdt;
 	omap_wdev->info = &omap_wdt_info;
 	omap_wdev->ops = &omap_wdt_ops;
-	omap_wdev->timeout = TIMER_MARGIN_DEFAULT;
+	omap_wdt_adjust_timeout(timer_margin);
 	omap_wdev->min_timeout = 1;
 	omap_wdev->max_timeout = TIMER_MARGIN_MAX;
 #ifdef CONFIG_WATCHDOG_NOWAYOUT
-- 
1.7.9.7

