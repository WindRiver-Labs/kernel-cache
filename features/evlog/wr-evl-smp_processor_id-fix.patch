wr-evl smp processor id fix 

evl_mk_rechdr generated a BUG when debugging PREEMPT was enabled since the
call to smp_processor_id() was in a preemptible context.  Use the proper
facility for getting the CPU id.

Signed-off-by: Joe MacDonald <joe.macdonald@windriver.com>
Integrated-by: Yongli he   <yongli.he@windriver.com>

---
 
diff --git a/drivers/scsi/sd.h b/drivers/scsi/sd.h
index 95b9f06..8c23ece 100644
--- a/drivers/scsi/sd.h
+++ b/drivers/scsi/sd.h
@@ -62,11 +62,14 @@ static inline struct scsi_disk *scsi_disk(struct gendisk *disk)
 }
 
 #define sd_printk(prefix, sdsk, fmt, a...)				\
-        (sdsk)->disk ?							\
-	sdev_printk(prefix, (sdsk)->device, "[%s] " fmt,		\
-		    (sdsk)->disk->disk_name, ##a) :			\
-	sdev_printk(prefix, (sdsk)->device, fmt, ##a)
-
+     do{ 								\
+        if((sdsk)->disk)					        \
+	  sdev_printk(prefix, (sdsk)->device, "[%s] " fmt,		\
+	   	    (sdsk)->disk->disk_name, ##a);			\
+        else                                                            \
+	  sdev_printk(prefix, (sdsk)->device, fmt, ##a);                \
+     }while(0)
+ 
 /*
  * A DIF-capable target device can be formatted with different
  * protection schemes.  Currently 0 through 3 are defined:
diff --git a/include/scsi/scsi_device.h b/include/scsi/scsi_device.h
index 291d56a..3e05ed7 100644
--- a/include/scsi/scsi_device.h
+++ b/include/scsi/scsi_device.h
@@ -204,10 +204,13 @@ struct scsi_dh_data {
 	dev_printk(prefix, &(sdev)->sdev_gendev, fmt, ##a)
 
 #define scmd_printk(prefix, scmd, fmt, a...)				\
-        (scmd)->request->rq_disk ?					\
+    do{          							\
+        if((scmd)->request->rq_disk)					\
 	sdev_printk(prefix, (scmd)->device, "[%s] " fmt,		\
-		    (scmd)->request->rq_disk->disk_name, ##a) :		\
-	sdev_printk(prefix, (scmd)->device, fmt, ##a)
+		    (scmd)->request->rq_disk->disk_name, ##a); 		\
+        else								\
+	  sdev_printk(prefix, (scmd)->device, fmt, ##a); 		\
+    }while(0)
 
 enum scsi_target_state {
 	STARGET_CREATED = 1,
diff --git a/kernel/evlbuf.c b/kernel/evlbuf.c
index 4507298..383c6c0 100644
--- a/kernel/evlbuf.c
+++ b/kernel/evlbuf.c
@@ -31,7 +31,7 @@
 #include <linux/string.h>
 #include <linux/interrupt.h>
 #include <asm/uaccess.h>
-#include <asm/semaphore.h>
+#include <linux/semaphore.h>
 #include <linux/module.h>
 #include <linux/ctype.h>
 #include <linux/evlog.h>
@@ -234,9 +234,9 @@ evl_mk_rechdr(struct kern_log_entry *rec_hdr,
 	rec_hdr->log_uid		=  current->uid;
 	rec_hdr->log_gid		=  current->gid;
 	rec_hdr->log_pid		=  current->pid;
-	rec_hdr->log_pgrp		=  process_group(current);
+	rec_hdr->log_pgrp		=  task_pgrp_nr(current);
 	rec_hdr->log_flags		=  (__u32) flags;
-	rec_hdr->log_processor		=  (__s32) smp_processor_id();
+	rec_hdr->log_processor		=  (__s32) get_cpu(); put_cpu();
 
 	strlcpy(rec_hdr->log_facility, facility, FACILITY_MAXLEN);
 
