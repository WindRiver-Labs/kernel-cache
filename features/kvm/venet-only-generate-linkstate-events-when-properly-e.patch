From 3e8fed729e19740d45a33dcacdff967d2fc2157e Mon Sep 17 00:00:00 2001
From: Gregory Haskins <ghaskins@novell.com>
Date: Wed, 3 Feb 2010 11:31:02 -0500
Subject: [PATCH 110/119] venet: only generate linkstate events when properly enabled

We currently try to generate an EVQ::LINKSTATE event regardless of
the actual state of the EVQ.  This can cause a host side oops when
the guest does not enable EVQ.

Signed-off-by: Gregory Haskins <ghaskins@novell.com>
---
 kernel/vbus/devices/venet/device.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/kernel/vbus/devices/venet/device.c b/kernel/vbus/devices/venet/device.c
index d12257b..dc2bf95 100644
--- a/kernel/vbus/devices/venet/device.c
+++ b/kernel/vbus/devices/venet/device.c
@@ -401,7 +401,8 @@ evq_send_linkstatus(struct venetdev *priv, bool status)
 		.state = status ? 1 : 0,
 	};
 
-	evq_send_event(priv, &event.header, true);
+	if (priv->vbus.evq.linkstate)
+		evq_send_event(priv, &event.header, true);
 }
 
 static void
-- 
1.6.5.2

