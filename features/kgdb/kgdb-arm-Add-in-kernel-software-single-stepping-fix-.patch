From 33961f348037934fb109146feb65596d854bb942 Mon Sep 17 00:00:00 2001
From: Wally Gleemer <wally.gleemer@windriver.com>
Date: Fri, 10 Aug 2012 22:24:48 -0500
Subject: [PATCH 18/31] kgdb,arm: Add in kernel software single stepping fix
 for kdb

Add ARM software single stepping

Signed-off-by: Wally Gleemer <wally.gleemer@windriver.com>
Signed-off-by: Jason Wessel <jason.wessel@windriver.com>
---
 arch/arm/kernel/kgdb.c |    5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/arch/arm/kernel/kgdb.c b/arch/arm/kernel/kgdb.c
index 89a2aba..d9bf3e1 100644
--- a/arch/arm/kernel/kgdb.c
+++ b/arch/arm/kernel/kgdb.c
@@ -287,7 +287,10 @@ static int kgdb_brk_fn(struct pt_regs *regs, unsigned int instr)
 		regs->ARM_cpsr |= stepped_cpsr_it_mask;
 	}
 	stepped_opcode = 0;
-	kgdb_handle_exception(1, SIGTRAP, 0, regs);
+	if ((long)stepped_address == regs->ARM_pc)
+		kgdb_handle_exception(0, SIGTRAP, 0, regs);
+	else
+		kgdb_handle_exception(1, SIGTRAP, 0, regs);
 
 	return 0;
 }
-- 
1.7.9.7

