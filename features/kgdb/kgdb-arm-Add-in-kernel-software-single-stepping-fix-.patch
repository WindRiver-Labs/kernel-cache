From 8fe8ddae2da830e57ce368e5b8d7658425215d36 Mon Sep 17 00:00:00 2001
From: Wally Gleemer <wally.gleemer@windriver.com>
Date: Wed, 16 Oct 2013 14:51:07 -0500
Subject: [PATCH 14/28] kgdb,arm: Add in kernel software single stepping fix
 for kdb

Add ARM software single stepping

Signed-off-by: Wally Gleemer <wally.gleemer@windriver.com>
Signed-off-by: Jason Wessel <jason.wessel@windriver.com>
Signed-off-by: He Zhe <zhe.he@windriver.com>
---
 arch/arm/kernel/kgdb.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/arch/arm/kernel/kgdb.c b/arch/arm/kernel/kgdb.c
index 7ee8739..d5f686e 100644
--- a/arch/arm/kernel/kgdb.c
+++ b/arch/arm/kernel/kgdb.c
@@ -289,7 +289,10 @@ static int kgdb_brk_fn(struct pt_regs *regs, unsigned int instr)
 		regs->ARM_cpsr |= stepped_cpsr_it_mask;
 	}
 	stepped_opcode = 0;
-	kgdb_handle_exception(1, SIGTRAP, 0, regs);
+	if ((long)stepped_address == regs->ARM_pc)
+		kgdb_handle_exception(0, SIGTRAP, 0, regs);
+	else
+		kgdb_handle_exception(1, SIGTRAP, 0, regs);
 
 	return 0;
 }
-- 
2.0.2

