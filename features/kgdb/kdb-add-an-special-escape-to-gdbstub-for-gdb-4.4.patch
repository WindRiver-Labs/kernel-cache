From 7fcd7705b2f8f0684e16fcd8766ada12f61da7e4 Mon Sep 17 00:00:00 2001
From: Dongdong Deng <dongdong.deng@windriver.com>
Date: Wed, 22 Dec 2010 17:26:20 +0800
Subject: [PATCH] kdb: add an special escape to gdbstub for gdb 4.4

gdb v4.4 introduce the `qRelocInsn' feature at 2010-05, and the
first order send to kgdb was changed to "$qSupported:qRelocInsn+#9a"
from "$?#3f".

Adding the special escape for "$qSupported:qRelocInsn+#9a" to kdb,
therefor kdb could switch to gdbstub automatic when gdb4.4 try to
connect to kdb.

Signed-off-by: Dongdong Deng <dongdong.deng@windriver.com>
---
 kernel/debug/kdb/kdb_io.c |   11 ++++++++++-
 1 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/kernel/debug/kdb/kdb_io.c b/kernel/debug/kdb/kdb_io.c
index 8bda910..6367f80 100644
--- a/kernel/debug/kdb/kdb_io.c
+++ b/kernel/debug/kdb/kdb_io.c
@@ -37,7 +37,9 @@ static void kgdb_transition_check(char *buffer)
 	if (strncmp(buffer, "$?#3f", slen) != 0 &&
 	    strncmp(buffer, "$Hc-1#09", slen) != 0 &&
 	    strncmp(buffer, "$qSupported#37", slen) != 0 &&
-	    strncmp(buffer, "+$qSupported#37", slen) != 0) {
+	    strncmp(buffer, "+$qSupported#37", slen) != 0 &&
+	    strncmp(buffer, "$qSupported:qRe", slen) != 0 &&
+	    strncmp(buffer, "+$qSupported:qRe", slen) != 0) {
 		KDB_STATE_SET(KGDB_TRANS);
 		kdb_printf("%s", buffer);
 	}
@@ -407,6 +409,13 @@ poll_again:
 				KDB_STATE_SET(DOING_KGDB2);
 				return buffer;
 			}
+			if (lastchar - buffer >= 15 &&
+				strcmp(lastchar - 15,
+				"$qSupported:qRe") == 0) {
+				strcpy(buffer, "kgdb");
+				KDB_STATE_SET(DOING_KGDB2);
+				return buffer;
+			}
 		}
 		break;
 	}
-- 
1.7.0

