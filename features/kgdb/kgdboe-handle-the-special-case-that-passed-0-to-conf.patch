From cb1b291f3fb9500a40d9cb0df5f7ae756b1c125d Mon Sep 17 00:00:00 2001
From: dongdong deng <ddeng@pek-lpgbuild3.wrs.com>
Date: Wed, 8 Sep 2010 05:44:48 -0700
Subject: [PATCH 23/31] kgdboe: handle the special case that passed '\0' to
 configure_kgdboe()

configure_kgdboe() should return "-EINVAL", and prompt the kgdboe usage
to user when passed '\0' to it. (When the passed arguments is '\0', the
option_setup() will return 1 to configure_kgdboe().)

If the kgdboe didn't initialize, the cleanup_kgdboe() should do nothing.

EX:
$ insmod kgdboe.ko
kgdboe: configuration incorrect - kgdboe not loaded.
Usage: kgdboe=[src-port]@[src-ip]/[dev],[tgt-port]@<tgt-ip>/<tgt-macaddr>
insmod: error inserting '/tmp/kgdboe.ko': -1 Invalid parameters

Signed-off-by: Dongdong Deng <dongdong.deng@windriver.com>
Signed-off-by: Jason Wessel <jason.wessel@windriver.com>
---
 drivers/net/ethernet/kgdboe.c |    7 +------
 1 file changed, 1 insertion(+), 6 deletions(-)

diff --git a/drivers/net/ethernet/kgdboe.c b/drivers/net/ethernet/kgdboe.c
index 8c85912..1e13b70 100644
--- a/drivers/net/ethernet/kgdboe.c
+++ b/drivers/net/ethernet/kgdboe.c
@@ -169,10 +169,7 @@ __setup("kgdboe=", option_setup);
 /* With our config string set by some means, configure kgdboe. */
 static int configure_kgdboe(void)
 {
-	if (option_setup(config))
-		return 0;
-
-	if (!configured) {
+	if (option_setup(config) || !configured) {
 		printk(KERN_ERR "kgdboe: configuration incorrect - " \
 		       "kgdboe not loaded.\n");
 		printk(KERN_ERR "  Usage: kgdboe=[src-port]@[src-ip]/[dev]," \
@@ -258,8 +255,6 @@ static int param_set_kgdboe_var(const char *kmessage, struct kernel_param *kp)
 		cleanup_kgdboe();
 		configured = 0;
 	}
-	if (config[0] == '\0')
-		return 0;
 
 	configure_kgdboe();
 
-- 
1.7.9.7

