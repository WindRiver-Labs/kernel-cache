From ff4f9e88c41a8c615cbba46bd88f29f30ab925b0 Mon Sep 17 00:00:00 2001
From: dongdong deng <ddeng@pek-lpgbuild3.wrs.com>
Date: Wed, 8 Sep 2010 05:44:48 -0700
Subject: [PATCH] kgdboe: handle the special case that passed '\0' to configure_kgdboe()

configure_kgdboe() should return "-EINVAL", and prompt the kgdboe usage
to user when passed '\0' to it. (When the passed arguments is '\0', the
option_setup() will return 1 to configure_kgdboe().)

If the kgdboe didn't initialize, the cleanup_kgdboe() should do nothing.

EX:
$ insmod kgdboe.ko
kgdboe: configuration incorrect - kgdboe not loaded.
Usage: kgdboe=[src-port]@[src-ip]/[dev],[tgt-port]@<tgt-ip>/<tgt-macaddr>
insmod: error inserting '/tmp/kgdboe.ko': -1 Invalid parameters

Signed-off-by: Dongdong Deng <dongdong.deng@windriver.com>
---
 drivers/net/kgdboe.c |    7 +------
 1 files changed, 1 insertions(+), 6 deletions(-)

diff --git a/drivers/net/kgdboe.c b/drivers/net/kgdboe.c
index f1a9483..d2f9ec2 100644
--- a/drivers/net/kgdboe.c
+++ b/drivers/net/kgdboe.c
@@ -170,10 +170,7 @@ __setup("kgdboe=", option_setup);
 /* With our config string set by some means, configure kgdboe. */
 static int configure_kgdboe(void)
 {
-	if (option_setup(config))
-		return 0;
-
-	if (!configured) {
+	if (option_setup(config) || !configured) {
 		printk(KERN_ERR "kgdboe: configuration incorrect - kgdboe not "
 		       "loaded.\n");
 		printk(KERN_ERR "  Usage: kgdboe=[src-port]@[src-ip]/[dev],"
@@ -261,8 +258,6 @@ static int param_set_kgdboe_var(const char *kmessage, struct kernel_param *kp)
 		cleanup_kgdboe();
 		configured = 0;
 	}
-	if (config[0] == '\0')
-		return 0;
 
 	configure_kgdboe();
 
-- 
1.6.5.2

