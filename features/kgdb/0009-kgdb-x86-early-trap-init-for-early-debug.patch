From 30cc9133e9d0f76c1acd427ed11ff5be8a8c9a32 Mon Sep 17 00:00:00 2001
From: Jan Kiszka <jan.kiszka@web.de>
Date: Wed, 10 Sep 2008 11:38:25 -0500
Subject: [PATCH] kgdb, x86: early trap init for early debug

Allow the x86 arch to have early exception processing for the purpose
of debugging via the kgdb8250 driver.

Signed-off-by: Jason Wessel <jason.wessel@windriver.com>
Signed-off-by: Jan Kiszka <jan.kiszka@web.de>
---
 arch/x86/kernel/setup.c     |    1 +
 arch/x86/kernel/traps_32.c  |   12 +++++++++---
 arch/x86/kernel/traps_64.c  |   10 +++++++++-
 include/asm-x86/processor.h |    2 ++
 4 files changed, 21 insertions(+), 4 deletions(-)

diff --git a/arch/x86/kernel/setup.c b/arch/x86/kernel/setup.c
index 362d4e7..c40e16e 100644
--- a/arch/x86/kernel/setup.c
+++ b/arch/x86/kernel/setup.c
@@ -601,6 +601,7 @@ void __init setup_arch(char **cmdline_p)
 	printk(KERN_INFO "Command line: %s\n", boot_command_line);
 #endif
 
+	early_trap_init();
 	early_cpu_init();
 	early_ioremap_init();
 
diff --git a/arch/x86/kernel/traps_32.c b/arch/x86/kernel/traps_32.c
index 03df8e4..5f585c1 100644
--- a/arch/x86/kernel/traps_32.c
+++ b/arch/x86/kernel/traps_32.c
@@ -1173,6 +1173,15 @@ asmlinkage void math_emulate(long arg)
 
 #endif /* CONFIG_MATH_EMULATION */
 
+/* Set of traps needed for early debugging. */
+void __init early_trap_init(void)
+{
+	set_intr_gate(1, &debug);
+	set_system_intr_gate(3, &int3); /* int3 can be called from all */
+	set_intr_gate(14, &page_fault);
+	load_idt(&idt_descr);
+}
+
 void __init trap_init(void)
 {
 	int i;
@@ -1186,9 +1195,7 @@ void __init trap_init(void)
 #endif
 
 	set_trap_gate(0, &divide_error);
-	set_intr_gate(1, &debug);
 	set_intr_gate(2, &nmi);
-	set_system_intr_gate(3, &int3); /* int3 can be called from all */
 	set_system_gate(4, &overflow); /* int4 can be called from all */
 	set_trap_gate(5, &bounds);
 	set_trap_gate(6, &invalid_op);
@@ -1199,7 +1206,6 @@ void __init trap_init(void)
 	set_trap_gate(11, &segment_not_present);
 	set_trap_gate(12, &stack_segment);
 	set_trap_gate(13, &general_protection);
-	set_intr_gate(14, &page_fault);
 	set_trap_gate(15, &spurious_interrupt_bug);
 	set_trap_gate(16, &coprocessor_error);
 	set_trap_gate(17, &alignment_check);
diff --git a/arch/x86/kernel/traps_64.c b/arch/x86/kernel/traps_64.c
index 513caac..e7af35e 100644
--- a/arch/x86/kernel/traps_64.c
+++ b/arch/x86/kernel/traps_64.c
@@ -1144,6 +1144,15 @@ asmlinkage void math_state_restore(void)
 }
 EXPORT_SYMBOL_GPL(math_state_restore);
 
+/* Set of traps needed for early debugging. */
+void __init early_trap_init(void)
+{
+	set_intr_gate(1, &debug);
+	set_intr_gate(3, &int3);
+	set_intr_gate(14, &page_fault);
+	load_idt((const struct desc_ptr *)&idt_descr);
+}
+
 void __init trap_init(void)
 {
 	set_intr_gate(0, &divide_error);
@@ -1160,7 +1169,6 @@ void __init trap_init(void)
 	set_intr_gate(11, &segment_not_present);
 	set_intr_gate_ist(12, &stack_segment, STACKFAULT_STACK);
 	set_intr_gate(13, &general_protection);
-	set_intr_gate(14, &page_fault);
 	set_intr_gate(15, &spurious_interrupt_bug);
 	set_intr_gate(16, &coprocessor_error);
 	set_intr_gate(17, &alignment_check);
diff --git a/include/asm-x86/processor.h b/include/asm-x86/processor.h
index 4df3e2f..7fd02ac 100644
--- a/include/asm-x86/processor.h
+++ b/include/asm-x86/processor.h
@@ -754,6 +754,8 @@ static inline void wbinvd_halt(void)
 extern void enable_sep_cpu(void);
 extern int sysenter_setup(void);
 
+extern void early_trap_init(void);
+
 /* Defined in head.S */
 extern struct desc_ptr		early_gdt_descr;
 
-- 
1.5.5.1

