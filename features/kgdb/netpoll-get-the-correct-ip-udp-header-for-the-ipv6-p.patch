From c31bdeea8725051f616831a178aa10a6d0b1ee62 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 19 Nov 2013 16:18:00 +0800
Subject: [PATCH 1/3] netpoll: get the correct ip/udp header for the ipv6
 packets

The helper functions ipv6_hdr() and udp_hdr() can't be used here since
the skb->network_header and skb->transport_header are not initialized
yet in this case. We also need to bail out if the it is not a UDP
packet.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 net/core/netpoll.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/net/core/netpoll.c b/net/core/netpoll.c
index 6eb5793..e455f96 100644
--- a/net/core/netpoll.c
+++ b/net/core/netpoll.c
@@ -862,10 +862,12 @@ int __netpoll_rx(struct sk_buff *skb, struct netpoll_info *npinfo)
 			goto out;
 		if (pskb_trim_rcsum(skb, len + sizeof(struct ipv6hdr)))
 			goto out;
-		ip6h = ipv6_hdr(skb);
+		ip6h = (struct ipv6hdr *)skb->data;
 		if (!pskb_may_pull(skb, sizeof(struct udphdr)))
 			goto out;
-		uh = udp_hdr(skb);
+		if (ip6h->nexthdr != IPPROTO_UDP)
+			goto out;
+		uh = (struct udphdr *)(((char *)ip6h) + sizeof(*ip6h));
 		ulen = ntohs(uh->len);
 		if (ulen != skb->len)
 			goto out;
-- 
1.8.4.93.g57e4c17

