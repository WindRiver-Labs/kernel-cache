From 42cf57661164afc2b0b916b8dbd41aa11d4f794f Mon Sep 17 00:00:00 2001
From: Chris Torek <chris.torek@windriver.com>
Date: Fri, 24 Apr 2009 23:40:44 +0800
Subject: [PATCH] kgdb: only wait on a specific cpu when kgdb_single_step is not set

The system can hang indefinitely if single stepping is set and a task
migrates.  Make use of the kgdb_single_step variable to control when to
wait for a processor where no task migration will occur.

Signed-off-by: Jason Wessel <jason.wessel@windriver.com>
---
 kernel/kgdb.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/kernel/kgdb.c b/kernel/kgdb.c
index d93e565..4462291 100644
--- a/kernel/kgdb.c
+++ b/kernel/kgdb.c
@@ -1481,7 +1481,8 @@ acquirelock:
 	 * instance of the exception handler wanted to come into the
 	 * debugger on a different CPU via a single step
 	 */
-	if (atomic_read(&kgdb_cpu_doing_single_step) != -1 &&
+	if (kgdb_single_step &&
+		 atomic_read(&kgdb_cpu_doing_single_step) != -1 &&
 	    atomic_read(&kgdb_cpu_doing_single_step) != cpu) {
 
 		atomic_set(&kgdb_active, -1);
-- 
1.6.0.4

