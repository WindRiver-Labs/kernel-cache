From 6e66367b8e401c8bed3131ea69fc711d2edcc55e Mon Sep 17 00:00:00 2001
From: Dongdong Deng <dongdong.deng@windriver.com>
Date: Fri, 13 Aug 2010 02:55:04 -0700
Subject: [PATCH] kdb: add an special escape for WR WorkBench

Once the KDB was enabled, the kdb_mode will be set by default.

As the first order sent out by WorkBench is "$Hc-1#09", Adding
an special escape for "$Hc-1#09" to kdb, so that kdb could switch
to kgdb_mode automatic when WorkBench try to connect to kdb.

Signed-off-by: Dongdong Deng <dongdong.deng@windriver.com>
---
 kernel/debug/kdb/kdb_io.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/kernel/debug/kdb/kdb_io.c b/kernel/debug/kdb/kdb_io.c
index c9b7f4f..8bda910 100644
--- a/kernel/debug/kdb/kdb_io.c
+++ b/kernel/debug/kdb/kdb_io.c
@@ -35,6 +35,7 @@ static void kgdb_transition_check(char *buffer)
 {
 	int slen = strlen(buffer);
 	if (strncmp(buffer, "$?#3f", slen) != 0 &&
+	    strncmp(buffer, "$Hc-1#09", slen) != 0 &&
 	    strncmp(buffer, "$qSupported#37", slen) != 0 &&
 	    strncmp(buffer, "+$qSupported#37", slen) != 0) {
 		KDB_STATE_SET(KGDB_TRANS);
@@ -394,6 +395,12 @@ poll_again:
 				KDB_STATE_SET(DOING_KGDB);
 				return buffer;
 			}
+			if (lastchar - buffer >= 8 &&
+			    strcmp(lastchar - 8, "$Hc-1#09") == 0) {
+				strcpy(buffer, "kgdb");
+				KDB_STATE_SET(DOING_KGDB2);
+				return buffer;
+			}
 			if (lastchar - buffer >= 14 &&
 			    strcmp(lastchar - 14, "$qSupported#37") == 0) {
 				strcpy(buffer, "kgdb");
-- 
1.6.5.2

