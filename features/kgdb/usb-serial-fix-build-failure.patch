From a6b7430f2c9929df7e0d0dff30ccb68da46fb167 Mon Sep 17 00:00:00 2001
From: He Zhe <zhe.he@windriver.com>
Date: Fri, 26 Sep 2014 07:31:53 +0000
Subject: [PATCH 26/28] usb-serial: fix build failure

As usb_serial_get_by_index has been replaced by usb_serial_port_get_by_minor,
change them accordingly.

Signed-off-by: He Zhe <zhe.he@windriver.com>
---
 drivers/usb/serial/usb-serial.c | 21 +++++++++++----------
 1 file changed, 11 insertions(+), 10 deletions(-)

diff --git a/drivers/usb/serial/usb-serial.c b/drivers/usb/serial/usb-serial.c
index fa43ef2..0edb8f4 100644
--- a/drivers/usb/serial/usb-serial.c
+++ b/drivers/usb/serial/usb-serial.c
@@ -1213,16 +1213,16 @@ static int serial_poll_init(struct tty_driver *driver, int line,
 	int flow = 'n';
 #endif
 
-	serial = usb_serial_get_by_index(line);
-	if (!serial)
+	port = usb_serial_port_get_by_minor(line);
+	if (!port)
 		return -1;
 
+	serial = port->serial;
 	if (!serial->type->poll_get_char) {
 		mutex_unlock(&serial->disc_mutex);
 		return -1;
 	}
 
-	port = serial->port[line - serial->minor];
 	if (rx_callback + 1 == 0)
 		port->poll_rx_cb = NULL;
 	else
@@ -1251,12 +1251,11 @@ static int serial_poll_get_char(struct tty_driver *driver, int line)
 	struct urb *urb;
 	int ret = -1;
 
-	serial = serial_table[line];
-	if (!serial)
+	port = usb_serial_port_get_by_minor(line);
+	if (!port)
 		return -1;
 
-	port = serial->port[line - serial->minor];
-
+	serial = port->serial;
 	if (serial->type->poll_get_char)
 		ret = serial->type->poll_get_char(port);
 	if (ret != -2)
@@ -1288,15 +1287,17 @@ static void serial_poll_put_char(struct tty_driver *driver, int line, char ch)
 	char buf[2];
 	int retval;
 
-	serial = serial_table[line];
+	port = usb_serial_port_get_by_minor(line);
+	if (!port)
+		return -1;
+
+	serial = port->serial;
 	if (!serial)
 		return;
 
 	if (serial->dev->state == USB_STATE_NOTATTACHED)
 		return;
 
-	port = serial->port[line - serial->minor];
-
 	if (!port->port.count)
 		return;
 
-- 
2.0.2

