From 6f1ed88619451737352f1885882bd4750b447b3f Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Thu, 6 Jun 2013 11:18:37 -0700
Subject: [PATCH] trace: Adopt trace_clock_local on NUMA

Since trace_clock_global is too expensive on NUMA machine, so add use_numa
runtime flag to check if NUMA is enabled or not. When NUMA is enabled, adopt
trace_clock_local for tracing.

Signed-off-by: Yang Shi <yang.shi@windriver.com>

diff --git a/arch/x86/include/asm/numa.h b/arch/x86/include/asm/numa.h
index bfacd2c..8adf0b1 100644
--- a/arch/x86/include/asm/numa.h
+++ b/arch/x86/include/asm/numa.h
@@ -20,6 +20,8 @@
 
 extern int numa_off;
 
+extern int use_numa;
+
 /*
  * __apicid_to_node[] stores the raw mapping between physical apicid and
  * node and is used to initialize cpu_to_node mapping.
diff --git a/arch/x86/mm/numa.c b/arch/x86/mm/numa.c
index c1e8394..c50fd5e 100644
--- a/arch/x86/mm/numa.c
+++ b/arch/x86/mm/numa.c
@@ -21,6 +21,8 @@
 #include "numa_internal.h"
 
 int __initdata numa_off;
+int use_numa = 1;
+
 nodemask_t numa_nodes_parsed __initdata;
 
 struct pglist_data *node_data[MAX_NUMNODES] __read_mostly;
@@ -612,6 +614,8 @@ static int __init dummy_numa_init(void)
 	node_set(0, numa_nodes_parsed);
 	numa_add_memblk(0, 0, PFN_PHYS(max_pfn));
 
+	use_numa = 0;
+
 	return 0;
 }
 
diff --git a/kernel/trace/ring_buffer.c b/kernel/trace/ring_buffer.c
index f23dadf..3f0bf7b 100644
--- a/kernel/trace/ring_buffer.c
+++ b/kernel/trace/ring_buffer.c
@@ -22,6 +22,9 @@
 
 #include <asm/local.h>
 #include <asm/kvm_para.h>
+#ifdef CONFIG_NUMA
+#include <asm/numa.h>
+#endif
 #include "trace.h"
 
 /*
@@ -1167,7 +1170,14 @@ struct ring_buffer *__ring_buffer_alloc(unsigned long size, unsigned flags,
 
 	buffer->pages = DIV_ROUND_UP(size, BUF_PAGE_SIZE);
 	buffer->flags = flags;
+#ifdef CONFIG_NUMA
+	if (use_numa)
+		buffer->clock = trace_clock_local;
+	else
+		buffer->clock = trace_clock_global;
+#else
 	buffer->clock = trace_clock_global;
+#endif
 	buffer->reader_lock_key = key;
 
 	/* need at least two pages */
-- 
1.8.3.1

