From 38badba63e7d17332679301eff22335b4823c9e6 Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Fri, 12 Jul 2013 15:09:55 -0400
Subject: [PATCH] kvm/lapic: temporarily mask irqsafe flag

A partial revert of:

  commit 5345ad1661edb624aeca87f5fb08abccd4414f68
  Author: Thomas Gleixner <tglx@linutronix.de>
  Date:   Sun Dec 18 13:31:32 2011 +0100

      kvm: Make lapic hrtimer irq safe

      Avoid going through the softirq.

It seems that forcing events to be handled in irq context
is causing guest hangs that look like dropped timer events.
Bisect led to this change.  Needs more investigation.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/arch/x86/kvm/lapic.c b/arch/x86/kvm/lapic.c
index 671aa5d..655bc35 100644
--- a/arch/x86/kvm/lapic.c
+++ b/arch/x86/kvm/lapic.c
@@ -1562,7 +1562,9 @@ int kvm_create_lapic(struct kvm_vcpu *vcpu)
 	hrtimer_init(&apic->lapic_timer.timer, CLOCK_MONOTONIC,
 		     HRTIMER_MODE_ABS);
 	apic->lapic_timer.timer.function = apic_timer_fn;
+#if 0
 	apic->lapic_timer.timer.irqsafe = 1;
+#endif
 	apic->lapic_timer.t_ops = &lapic_timer_ops;
 	apic->lapic_timer.kvm = vcpu->kvm;
 	apic->lapic_timer.vcpu = vcpu;
-- 
1.8.3.1

