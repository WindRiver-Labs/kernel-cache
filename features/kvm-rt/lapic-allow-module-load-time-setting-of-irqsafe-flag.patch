From b7cfe1e805a9d4f652ec6f92ebbbed0168efc732 Mon Sep 17 00:00:00 2001
From: Nam Ninh <nam.ninh@windriver.com>
Date: Mon, 19 Aug 2013 12:10:54 -0400
Subject: [PATCH] lapic: allow module load time setting of irqsafe flag

Useful for debugging and benchmark testing of the impact of
running the portion of the timer code from irq context vs.
softirq context.

For example, when ksoftirqd/N on core N is responsible for
timer work, and there is a higher priority RT thread also
running on core N, the timers will not complete unless the
priority of the ksoftirqd/N is chrt'd to be above the RT
process.

Signed-off-by: Nam Ninh <nam.ninh@windriver.com>
Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/arch/x86/kvm/lapic.c b/arch/x86/kvm/lapic.c
index fea0f81..9d98066 100644
--- a/arch/x86/kvm/lapic.c
+++ b/arch/x86/kvm/lapic.c
@@ -74,6 +74,10 @@
 static unsigned int min_timer_period_us = 500;
 module_param(min_timer_period_us, uint, S_IRUGO | S_IWUSR);
 
+static int lapic_irqsafe = 1;
+module_param(lapic_irqsafe, int, S_IRUGO | S_IWUSR);
+MODULE_PARM_DESC(lapic_irqsafe, "Set lapic hrtimer callback in irq mode");
+
 static inline void apic_set_reg(struct kvm_lapic *apic, int reg_off, u32 val)
 {
 	*((u32 *) (apic->regs + reg_off)) = val;
@@ -1560,9 +1564,7 @@ int kvm_create_lapic(struct kvm_vcpu *vcpu)
 	hrtimer_init(&apic->lapic_timer.timer, CLOCK_MONOTONIC,
 		     HRTIMER_MODE_ABS);
 	apic->lapic_timer.timer.function = apic_timer_fn;
-#if 0
-	apic->lapic_timer.timer.irqsafe = 1;
-#endif
+	apic->lapic_timer.timer.irqsafe = lapic_irqsafe;
 	apic->lapic_timer.t_ops = &lapic_timer_ops;
 	apic->lapic_timer.kvm = vcpu->kvm;
 	apic->lapic_timer.vcpu = vcpu;
-- 
1.8.3.1

