From 60b62b23c02b5c7899e8ce98fa63396aa4e2924f Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Thu, 25 Sep 2014 10:51:35 -0400
Subject: [PATCH] uio: update ifdef to match current RT Kconfig variable

The use of CONFIG_PREEMPT_RT has been gone for a while; replaced
by CONFIG_PREEMPT_RT_BASE and CONFIG_PREEMPT_RT_FULL.  The rest
of the file/patch is already using the FULL variant, so this
part relating to threaded IRQ handling should be as well.

In doing so, it reveals in_hardirq does not exist; the proper
call/macro is hardirq_count.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/drivers/uio/uio.c b/drivers/uio/uio.c
index 051ba02b771d..a20e4ea934f3 100644
--- a/drivers/uio/uio.c
+++ b/drivers/uio/uio.c
@@ -417,8 +417,8 @@ static irqreturn_t __uio_event_notify(struct uio_device *idev)
 	atomic_inc(&idev->event);
 	swait_wake_interruptible(&idev->wait);
 
-#ifdef CONFIG_PREEMPT_RT
-	if (in_hardirq()) {
+#ifdef CONFIG_PREEMPT_RT_FULL
+	if (hardirq_count()) {
 		if (waitqueue_active(&idev->poll_wait) || idev->async_queue)
 			return IRQ_WAKE_THREAD;
 		return IRQ_HANDLED;
-- 
2.1.0

