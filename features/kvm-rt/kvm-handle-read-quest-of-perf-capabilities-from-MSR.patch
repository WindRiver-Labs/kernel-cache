From a3714f6452e12268697f6f4562e2c1dd1d9b1a7e Mon Sep 17 00:00:00 2001
From: Nam Ninh <nam.ninh@windriver.com>
Date: Mon, 24 Nov 2014 10:13:28 -0500
Subject: [PATCH] kvm: handle read request of perf capabilities from MSR

On Canoe Pass, we occationally see this warning when we run a guest
on OVP host:
[91234.021762] kvm [3889]: vcpu0 unhandled rdmsr: 0x345

This request is to read the perf capabilities from MSR offset 0x345,
but the MSR read handler does not handle it, so we see the warning.
This patch simply reads the KVM native capabilities and returns it
to the guest.

Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.c
index 922799e4ab1a..a3f71dddcca2 100644
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@ -2493,6 +2493,9 @@ int kvm_get_msr_common(struct kvm_vcpu *vcpu, u32 msr, u64 *pdata)
 			return 1;
 		data = vcpu->arch.osvw.status;
 		break;
+	case MSR_IA32_PERF_CAPABILITIES:
+		rdmsrl(MSR_IA32_PERF_CAPABILITIES, data);
+		break;
 	default:
 		if (kvm_pmu_msr(vcpu, msr))
 			return kvm_pmu_get_msr(vcpu, msr, pdata);
-- 
2.1.0

