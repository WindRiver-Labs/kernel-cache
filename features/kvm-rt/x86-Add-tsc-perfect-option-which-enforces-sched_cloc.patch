From a6634ec5b0af6e1b2a5e5ab99de682917b78df7a Mon Sep 17 00:00:00 2001
From: Thomas Gleixner <tglx@linutronix.de>
Date: Thu, 12 Apr 2012 09:51:08 +0100
Subject: [PATCH] x86: Add tsc=perfect option which enforces
 sched_clock_stable

The sched_clock dance with updating local clocks can be avoided even
if the CPU does not have all the magic features.

Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Signed-off-by: Michael Barabanov <michael.barabanov@windriver.com>

diff --git a/arch/x86/kernel/tsc.c b/arch/x86/kernel/tsc.c
index fc0a147..c581004 100644
--- a/arch/x86/kernel/tsc.c
+++ b/arch/x86/kernel/tsc.c
@@ -109,6 +109,10 @@ static int __init tsc_setup(char *str)
 {
 	if (!strcmp(str, "reliable"))
 		tsc_clocksource_reliable = 1;
+	if (!strcmp(str, "perfect")) {
+		tsc_clocksource_reliable = 1;
+		set_sched_clock_stable();
+	}
 	if (!strncmp(str, "noirqtime", 9))
 		no_sched_irq_time = 1;
 	return 1;
-- 
1.7.9.5

