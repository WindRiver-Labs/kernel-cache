From 99756fcbb497620a1470a34402d0008de6c1ce0e Mon Sep 17 00:00:00 2001
From: kopal <kopal@broadcom.com>
Date: Wed, 3 Dec 2014 12:15:52 +0530
Subject: [PATCH 1046/1532] nae: added API to change MAC address of an
 interface using ifconfig.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/netlib/include/export_sym.h |  1 +
 .../netlogic/lib/netlib/include/netsoc_haliface.h  |  1 +
 .../netlogic/lib/netlib/include/netsoc_libiface.h  |  1 +
 arch/mips/netlogic/lib/netlib/src/netsoc_api.c     | 22 ++++++++
 arch/mips/netlogic/lib/netlib/src/netsoc_nae.c     | 62 ++++++++++++++++++++++
 5 files changed, 87 insertions(+)

diff --git a/arch/mips/netlogic/lib/netlib/include/export_sym.h b/arch/mips/netlogic/lib/netlib/include/export_sym.h
index da812b8..50c767c 100644
--- a/arch/mips/netlogic/lib/netlib/include/export_sym.h
+++ b/arch/mips/netlogic/lib/netlib/include/export_sym.h
@@ -8,6 +8,7 @@ EXPORT_SYMBOL(cntx2netport);
 
 EXPORT_SYMBOL(netsoc_mac_disable);
 EXPORT_SYMBOL(netsoc_mac_enable);
+EXPORT_SYMBOL(netsoc_setup_hwaddr);
 EXPORT_SYMBOL(netsoc_get_phy_status);
 EXPORT_SYMBOL(netsoc_start_autoneg);
 EXPORT_SYMBOL(netsoc_init_ext_phy);
diff --git a/arch/mips/netlogic/lib/netlib/include/netsoc_haliface.h b/arch/mips/netlogic/lib/netlib/include/netsoc_haliface.h
index 5501d1c..ad2082a 100644
--- a/arch/mips/netlogic/lib/netlib/include/netsoc_haliface.h
+++ b/arch/mips/netlogic/lib/netlib/include/netsoc_haliface.h
@@ -63,6 +63,7 @@ extern int __netsoc_config_flow_control(net_port_t *netport, uint32_t enable);
 extern int __netsoc_flow_control_status(nae_t *nae, uint32_t port);
 extern int __netsoc_config_frame_size(net_port_t *netport, uint32_t size);
 extern void __netsoc_mac_enable(net_port_t *netport);
+extern void __netsoc_setup_hwaddr(net_port_t *netport, unsigned char *dev_addr);
 extern void __netsoc_mac_disable(net_port_t *netport);
 extern int __netsoc_reset_and_load_ucore(nae_t *nae, uint32_t ucore_mask, unsigned int *opcodes, uint32_t num_opcodes);
 extern int __netsoc_restart_ucore_using_fdt(nae_t *nae, void *fdt);
diff --git a/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h b/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h
index 0c56dcf..c47fb58 100644
--- a/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h
+++ b/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h
@@ -534,6 +534,7 @@ extern void netsoc_get_port_stats(net_port_t *netport, dev_stat_t* dev_stat);
 extern int netsoc_port_stats_clear(net_port_t *netport);
 extern int netsoc_mac_disable(net_port_t *netport);
 extern int netsoc_mac_enable(net_port_t *netport);
+extern int netsoc_setup_hwaddr(net_port_t *netport, unsigned char *dev_addr);
 extern int netsoc_close_port(net_port_t *netport);
 extern net_port_t *netsoc_open_port(nae_t *nae, uint32_t port);
 extern void netsoc_map_interface_to_lifo(nae_t *nae,  int hw_port_id, uint32_t lifo_mask);
diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_api.c b/arch/mips/netlogic/lib/netlib/src/netsoc_api.c
index 3bfd666..c44d30d 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_api.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_api.c
@@ -356,6 +356,28 @@ int netsoc_close_port(net_port_t *netport)
 }
 
 /**
+* @brief netsoc_setup_hwaddr function is used to change MAC addr of the port
+* 
+* @param [in] netport pointer to net_port_t
+*
+* @return
+*       - NETSOC_API_SUCCESS on success
+*       - < 0 on error
+* 
+* @ingroup hal_nae
+*
+*/
+
+int netsoc_setup_hwaddr(net_port_t *netport, unsigned char *dev_addr)
+{
+       if (netport == NULL)
+                return -NAE_PORT_INSTANCE_INVALID;
+
+       __netsoc_setup_hwaddr(netport, dev_addr);
+       return NETSOC_API_SUCCESS;
+}
+
+/**
 * @brief netsoc_mac_enable function is used to enable mac
 * 
 * @param [in] netport pointer to net_port_t 
diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
index 29e884e..29be39d3 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
@@ -3072,6 +3072,68 @@ int __netsoc_flow_control_status(nae_t *nae, uint32_t port)
 	}
 	return 0;
 }
+
+/**
+* @brief netsoc_setup_hwaddr function is used to change the MAC address of an interface.
+*
+* @return
+*       - none
+*
+* @ingroup hal_nae
+*
+*/
+void __netsoc_setup_hwaddr(net_port_t *netport, unsigned char *dev_addr)
+{
+	nae_t *nae = netport->nae;
+	unsigned int mac_base;
+	
+	switch(netport->iftype) {
+                case SGMII_IF:
+			mac_base = netsoc_get_macreg_base_for_gmac(nae->mac_base, netport->hw_port_id);
+			netsoc_write_mac_reg(mac_base, MAC_ADDR0_LO,
+                	                	(dev_addr[5] << 24) |
+						(dev_addr[4] << 16) |
+						(dev_addr[3] << 8)  |
+						(dev_addr[2]));
+			netsoc_write_mac_reg(mac_base, MAC_ADDR0_HI,
+                                		(dev_addr[1] << 24) |
+                                		(dev_addr[0] << 16));
+		
+			break;
+		case XAUI_IF:
+		case XFI_IF:
+		case RXAUI_IF:
+			mac_base = __netsoc_get_xgmac_base(netport);
+			netsoc_write_mac_reg(mac_base, MAC_ADDR0_LO,
+                		                (dev_addr[5] << 24) |
+                                		(dev_addr[4] << 16) |
+                                		(dev_addr[3] << 8)  |
+                                		(dev_addr[2]));
+
+			netsoc_write_mac_reg(mac_base, MAC_ADDR0_HI,
+                                		(dev_addr[1] << 24) |
+                                		(dev_addr[0] << 16));
+
+			break;
+		case XLAUI_IF:
+			mac_base = netsoc_get_macreg_base_for_xlgmac(nae->mac_base, netport->hw_port_id);
+			netsoc_write_mac_reg(mac_base, XLAUI_MAC_ADDR_0,
+                		                (dev_addr[5] << 24) |
+                                		(dev_addr[4] << 16) |
+                                		(dev_addr[3] << 8)  |
+                                		(dev_addr[2]));
+
+			netsoc_write_mac_reg(mac_base, XLAUI_MAC_ADDR_1,
+                                		(dev_addr[1] << 24) |
+                                		(dev_addr[0] << 16));
+
+			break;
+		case INTERLAKEN_IF:
+			break;
+
+        }
+}
+
 /**
 * @brief nlm_hal_mac_enable function is used to enable an interface at the MAC level.
 *
-- 
1.9.1

