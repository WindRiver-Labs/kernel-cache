From d5482aad3a343f9c098d38bc52247b4b178861f1 Mon Sep 17 00:00:00 2001
From: kopal <kopal@broadcom.com>
Date: Thu, 21 Mar 2013 17:12:17 +0530
Subject: [PATCH 1397/1532] XMC: Added timer support for autonegotiation

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/broadcom/nae/xlpge_main.c |  1 +
 drivers/net/ethernet/broadcom/nae/xlpge_nae.c  | 22 ++++++++++++++++++++--
 2 files changed, 21 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_main.c b/drivers/net/ethernet/broadcom/nae/xlpge_main.c
index 4808854..358d7b1 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_main.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_main.c
@@ -69,6 +69,7 @@ static int __init brcmxlp_nae_init(void)
 	xlpge_eeprom_init();
 	/* TODO:XXX Move to pci init? */
 	nlm_xlp_nae_init();
+	init_phy_state_timer(NULL);
 
 	return pci_register_driver(&brcmxlp_nae_driver);
 }
diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_nae.c b/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
index c6e023a..dc0f9b3 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
@@ -35,7 +35,7 @@
 #include <linux/clocksource.h>
 #include <linux/timecompare.h>
 #include <linux/proc_fs.h>
-
+#include <linux/timer.h>
 #include <asm/netlogic/xlp.h>
 #include <asm/netlogic/msgring.h>
 #include <asm/netlogic/hal/nlm_hal_fmn.h>
@@ -76,7 +76,7 @@ static int enable_jumbo = 0;
 module_param(enable_jumbo, int, 0);
 static struct p2p_desc_mem p2p_desc_mem[NR_CPUS] __cacheline_aligned;
 static unsigned int phys_cpu_map[NLM_MAX_NODES];
-
+struct timer_list phy_int_timer;
 #ifdef CONFIG_NLM_ENABLE_LOAD_BALANCING
 struct file_operations nlm_load_balance_proc_fops = {
 	.owner = THIS_MODULE,
@@ -655,6 +655,24 @@ void nlm_xlp_nae_remove(void)
 	nlm_nae_remove_procentries();
 }
 
+static void phy_st_timer_handler(unsigned long data)
+{
+        struct timer_list *timer = &phy_int_timer;
+        nlm_hal_restart_an(0, 0);
+
+        timer->expires = jiffies + (HZ * 2);
+        add_timer(timer);
+}
+void init_phy_state_timer(void *data)
+{
+
+        struct timer_list *timer = &phy_int_timer;
+        init_timer(timer);
+        timer->expires = jiffies + 10;
+        timer->data = 0;
+        timer->function = phy_st_timer_handler;
+        add_timer(timer);
+}
 void nlm_xlp_mac_set_enable(struct dev_data *priv, int flag)
 {
 	int inf;
-- 
1.9.1

