From 0e56d33c3d1303a20467e23911c3f416e3f6d032 Mon Sep 17 00:00:00 2001
From: Virendra Pathak <vpathak@broadcom.com>
Date: Wed, 27 Nov 2013 16:08:29 +0530
Subject: [PATCH 0877/1532] nae: Guest ID mapping for Descriptor Queue

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/netlib/src/netsoc_nae.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
index bb22edd..a94ad39 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
@@ -36,6 +36,8 @@
 #include "netsoc_libiface.h"
 #include "ext_phy.h"
 
+/*#define KVM_GUEST_MODE_EN	1*/
+
 static unsigned int ucore_shared_scratch[NLM_MAX_NODES][XLP9XX_MAX_NAE_PERNODE][256];
 static unsigned int ucore_shared_scratch_words[NLM_MAX_NODES][XLP9XX_MAX_NAE_PERNODE];
 
@@ -4032,6 +4034,11 @@ static int __netsoc_config_freein_fifo(nae_t *nae)
                                         ((start & 0x1ff)  << 8) | /* fcStart */
                                         (i  & 0x1f);
 
+#ifdef KVM_GUEST_MODE_EN
+				netsoc_write_nae_reg(nae->nae_base, 0x91, 1);
+				netsoc_api_print(NETSOC_APIDBG_CONFIG, "Freein fifo cfg %d, guestid: %d\n", 1, 1);
+#endif
+
                                 netsoc_write_nae_reg(nae->nae_base, FREE_IN_FIFO_CFG, reg);
                                 netsoc_api_print(NETSOC_APIDBG_CONFIG, "Freein fifo cfg %d fcstart %d size %d\n", i, start, size);
                                 start += size;
@@ -4039,6 +4046,10 @@ static int __netsoc_config_freein_fifo(nae_t *nae)
                 }
         }
 
+#ifdef KVM_GUEST_MODE_EN 
+	netsoc_write_nae_reg(nae->nae_base, 0x90, 0);
+#endif
+
 	for(i=0; i < freein_fifo_total_queues; i++) {
 		if (i == 0)
 			minsz = nae->freein_fifo_onchip_num_descs[i];
-- 
1.9.1

