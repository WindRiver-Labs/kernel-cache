From 4d9b4a0474cab7e3bfa09d6b5b82433dd332152f Mon Sep 17 00:00:00 2001
From: Vikas Gupta <vikas.gupta@broadcom.com>
Date: Tue, 9 Dec 2014 19:53:54 +0530
Subject: [PATCH 1051/1532] xlp2xx xmdio: Increase the divisor value in case of
 higher NAE freq.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/netlib/src/netsoc_nae.c | 18 ++++++++++++++----
 1 file changed, 14 insertions(+), 4 deletions(-)

diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
index 29be39d3..106cc8b 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
@@ -118,8 +118,18 @@ static uint32_t nae_get_INT_MDIO_DIV(void)
 	return ((0x7F << INT_MDIO_CTRL_XDIV_POS) | (2 << INT_MDIO_CTRL_MCDIV_POS));
 }
 
-static uint32_t nae_get_EXT_XG_MDIO_DIV(void)
+static uint32_t nae_get_EXT_XG_MDIO_DIV(nae_t* nae)
 {
+        const uint64_t mhz = 1000000;
+        uint64_t nae_freq;
+	if(is_nlm_xlp2xx()){
+		nae_freq = nlm_hal_xlp2xx_get_clkdev_frq(nae->node, XLP2XX_CLKDEVICE_NAE);
+		NLM_HAL_DO_DIV(nae_freq, mhz);
+		if(nae_freq > 250)
+			cl45_div = 3; /*increase the divisor if higher NAE freq on xlp2xx*/
+		else
+			cl45_div = 2;	
+	}
 	return ((0x7F << EXT_XG_MDIO_CTRL_XDIV_POS) | (cl45_div << EXT_XG_MDIO_CTRL_MCDIV_POS));
 }
 
@@ -436,11 +446,11 @@ int __netsoc_ext_xgmac_mdio_reset(nae_t *nae, int bus)
 	uint64_t mac_base = netsoc_get_macreg_base_for_mdio(nae->mac_base);
 
         netsoc_write_mac_reg(mac_base, EXT_XG0_MDIO_CTRL + (bus * 4),
-				 nae_get_EXT_XG_MDIO_DIV()
+				 nae_get_EXT_XG_MDIO_DIV(nae)
                                 | EXT_XG_MDIO_CTRL_RST );
 
         netsoc_write_mac_reg(mac_base, EXT_XG0_MDIO_CTRL + (bus * 4),
-				 nae_get_EXT_XG_MDIO_DIV()
+				 nae_get_EXT_XG_MDIO_DIV(nae)
                                 );
 	return NETSOC_API_SUCCESS;
 }
@@ -1802,7 +1812,7 @@ static int __netsoc_xgmac_mdio_write(nae_t *nae, uint32_t bus,
 			| (dev_addr << EXT_XG_MDIO_CTRL_REG_POS)
 			| (regidx << EXT_XG_MDIO_CTRL_OP_POS)
 			/* load = 0 */
-			| nae_get_EXT_XG_MDIO_DIV()
+			| nae_get_EXT_XG_MDIO_DIV(nae)
 			| (EXT_XG_MDIO_CTRL_TA << EXT_XG_MDIO_CTRL_TA_POS)
 			| (MDIO_MIIM_CMD_10G_MMD << EXT_XG_MDIO_CTRL_MIIM_POS);
 
-- 
1.9.1

