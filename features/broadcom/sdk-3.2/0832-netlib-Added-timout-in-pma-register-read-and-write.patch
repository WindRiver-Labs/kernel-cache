From c1ad82e58399c0add3a1075639b7b966ac568ec4 Mon Sep 17 00:00:00 2001
From: Jayanthi A <jayanthi.annadurai@broadcom.com>
Date: Mon, 4 Nov 2013 10:38:20 -0800
Subject: [PATCH 0832/1532] netlib: Added timout in pma register read and write

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/netlib/include/netsoc_nae.h | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/arch/mips/netlogic/lib/netlib/include/netsoc_nae.h b/arch/mips/netlogic/lib/netlib/include/netsoc_nae.h
index e55ad10..3a584f4 100644
--- a/arch/mips/netlogic/lib/netlib/include/netsoc_nae.h
+++ b/arch/mips/netlogic/lib/netlib/include/netsoc_nae.h
@@ -262,16 +262,19 @@ static inline uint32_t __netsoc_indirect_pma_register_read(nae_t *nae, int block
 {
         uint32_t val = 0;
 	uint64_t mac_base = netsoc_get_macreg_base_for_phy(nae->mac_base, block);
+	int timeout = 10000;
 
         val = netsoc_read_mac_reg(mac_base, lane_ctrl);
         val |= (1<<30) | (1<<17) | (1<<16);
         val = val | (pma_reg_addr<<8);
         netsoc_write_mac_reg(mac_base, lane_ctrl, val);
-        while(1){
+        while(--timeout){
                 val = netsoc_read_mac_reg(mac_base, lane_ctrl);
                 if(val & (1<<18))
                         break;
         }
+	if (!timeout)
+		nlm_print("\nERROR: __netsoc_indirect_pma_register_read failed \n");
         return (val&0xff);
 }
 
@@ -297,6 +300,7 @@ static inline void __netsoc_indirect_pma_register_wite(nae_t *nae, int block, in
 {
         uint32_t val = 0,i;
 	uint64_t mac_base = netsoc_get_macreg_base_for_phy(nae->mac_base, block);
+	int timeout = 10000;
 
         val = netsoc_read_mac_reg(mac_base, lane_ctrl);
         val |= (1<<30) | (1<<17);
@@ -305,11 +309,14 @@ static inline void __netsoc_indirect_pma_register_wite(nae_t *nae, int block, in
 
         for (i=0; i<2; i++) {
                 netsoc_write_mac_reg(mac_base, lane_ctrl, val);
-                while(1) {
+                while(--timeout) {
                         val = netsoc_read_mac_reg(mac_base, lane_ctrl);
                         if(val & (1<<18))
                         break;
                 }
+		if (!timeout)
+	                nlm_print("\nERROR: __netsoc_indirect_pma_register_wite failed \n");
+		timeout = 10000;
         }
 }
 
-- 
1.9.1

