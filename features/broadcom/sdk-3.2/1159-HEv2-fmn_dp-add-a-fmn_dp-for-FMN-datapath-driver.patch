From 0523b5a75fb05cfc2e3130dbeebfb6ecef4b6991 Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Tue, 9 Jul 2013 09:33:54 -0700
Subject: [PATCH 1159/1532] HEv2: fmn_dp: add a fmn_dp (for FMN datapath)
 driver

  o For HALX based application, HAL APIs should not be used.
    fmn_dp driver can be used to provide an processor type, which
    will be used by fmn itself or other APIs to differentiate
    different processor-actions.
  o Given a local VC, in virtualized environment, the receive VC
    cannot be simply calculated based on host cpuid as the guest
    host cpuid may not match root host cpuid.
    fmn_dp provides API to get the real receive VC, given a
    local VC.
  o Also added a preliminary dma_dp (dma datapath) application.
  o Both fmn_dp and dma_dp have not hooked up with build
    infrastructure yet.
[Based on SDK 3.2]
Delete the KVM support in fmn_main.c

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/misc/netlogic/fmn_dp/fmn_kernel_iface.h |  61 ++++++++++++
 drivers/misc/netlogic/fmn_dp/fmn_main.c         | 123 ++++++++++++++++++++++++
 2 files changed, 184 insertions(+)
 create mode 100644 drivers/misc/netlogic/fmn_dp/fmn_kernel_iface.h
 create mode 100644 drivers/misc/netlogic/fmn_dp/fmn_main.c

diff --git a/drivers/misc/netlogic/fmn_dp/fmn_kernel_iface.h b/drivers/misc/netlogic/fmn_dp/fmn_kernel_iface.h
new file mode 100644
index 0000000..13d58a8
--- /dev/null
+++ b/drivers/misc/netlogic/fmn_dp/fmn_kernel_iface.h
@@ -0,0 +1,61 @@
+/*-
+ * Copyright (c) 2003-2013 Broadcom Corporation
+ * All Rights Reserved
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in
+ *    the documentation and/or other materials provided with the
+ *    distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY BROADCOM ``AS IS'' AND ANY EXPRESS OR
+ * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+ * ARE DISCLAIMED. IN NO EVENT SHALL BROADCOM OR CONTRIBUTORS BE LIABLE
+ * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
+ * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
+ * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+ * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN
+ * IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ *
+ * #BRCM_2# */
+
+#ifndef __FMN_KERNEL_IFACE__
+#define __FMN_KERNEL_IFACE__
+
+#define FMN_DP_MAJOR        125
+
+/* Supported values */
+enum processor_type {
+	PROC_XLP8XX = 0,
+	PROC_XLP3XX,
+	PROC_XLP2XX,
+	PROC_XLP9XX,
+};
+
+typedef struct fmn_dp_ioctl {
+	union {
+		struct {
+			enum processor_type type;
+		} pr_type;
+		struct {
+			int cpu_id;
+			int local_queue_id;
+			int queue_id;
+		} recv_q;
+	} u;
+} fmn_dp_ioctl_t;
+
+enum fmn_dp_ops {
+        GET_PROCESSOR_TYPE = 0,
+	GET_RECV_QUEUE,
+};
+
+#endif
diff --git a/drivers/misc/netlogic/fmn_dp/fmn_main.c b/drivers/misc/netlogic/fmn_dp/fmn_main.c
new file mode 100644
index 0000000..09dafba
--- /dev/null
+++ b/drivers/misc/netlogic/fmn_dp/fmn_main.c
@@ -0,0 +1,123 @@
+/*-
+ * Copyright (c) 2003-2013 Broadcom Corporation
+ * All Rights Reserved
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in
+ *    the documentation and/or other materials provided with the
+ *    distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY BROADCOM ``AS IS'' AND ANY EXPRESS OR
+ * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+ * ARE DISCLAIMED. IN NO EVENT SHALL BROADCOM OR CONTRIBUTORS BE LIABLE
+ * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
+ * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
+ * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+ * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN
+ * IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ *
+ * #BRCM_2# */
+
+#include <linux/module.h>
+#include <linux/moduleparam.h>
+#include <linux/kernel.h>
+#include <linux/init.h>
+#include <linux/slab.h>
+#include <linux/fs.h>
+#include <linux/mm.h>
+
+#include <asm/cpu.h>
+#include <asm/mipsregs.h>
+
+#include "libfdt.h"
+#include "fmn_kernel_iface.h"
+
+static long fmn_ioctl(struct file *filp, unsigned int cmd, unsigned long data)
+{
+	int rc;
+	fmn_dp_ioctl_t *param;
+
+	param = (fmn_dp_ioctl_t *)data;
+	rc = 0;
+
+	switch(cmd) {
+	case GET_PROCESSOR_TYPE:
+	{
+		int chip = read_c0_prid() & 0xff00;
+
+		switch(chip) {
+		case PRID_IMP_NETLOGIC_XLP8XX:
+			param->u.pr_type.type = PROC_XLP8XX;
+			break;
+		case PRID_IMP_NETLOGIC_XLP3XX:
+			param->u.pr_type.type = PROC_XLP3XX;
+			break;
+		case PRID_IMP_NETLOGIC_XLP2XX:
+			param->u.pr_type.type = PROC_XLP2XX;
+			break;
+		case PRID_IMP_NETLOGIC_XLP9XX:
+			param->u.pr_type.type = PROC_XLP9XX;
+			break;
+		default:
+			rc = -1;
+		}
+		break;
+	}
+	case GET_RECV_QUEUE:
+	{
+		param->u.recv_q.queue_id =
+			(param->u.recv_q.cpu_id << 2) + param->u.recv_q.local_queue_id;
+		break;
+	}
+	default:
+		rc = -1;
+		break;
+
+	}
+	
+	return rc;
+}
+
+static const struct file_operations fmn_ops = {
+	.owner  = THIS_MODULE,
+	.unlocked_ioctl = fmn_ioctl,
+#ifdef CONFIG_COMPAT
+	.compat_ioctl = fmn_ioctl,
+#endif
+};
+
+static int __init brcm_fmn_dp_init (void)
+{
+	int i;
+
+	i = register_chrdev(FMN_DP_MAJOR, "fmn_dp", &fmn_ops);
+	if (i < 0)
+	{
+		printk(KERN_ERR "fmn_dp: unable to register %d", FMN_DP_MAJOR);
+		return i;
+	}
+
+	return 0;
+}
+
+static void __exit brcm_fmn_dp_exit (void)
+{
+	printk ("brcm fmn datapath driver exit...\n");
+}
+
+module_init(brcm_fmn_dp_init);
+module_exit(brcm_fmn_dp_exit);
+
+MODULE_AUTHOR("Broadcom");
+MODULE_DESCRIPTION("FMN Data Path Driver");
+MODULE_LICENSE("Proprietary");
+MODULE_VERSION("0.1");
-- 
1.9.1

