From 6beafe385bcf65b6a245d7d12afbdc7f915cd7a0 Mon Sep 17 00:00:00 2001
From: Jayanthi A <jayanthi.annadurai@broadcom.com>
Date: Sat, 12 Oct 2013 22:46:28 -0700
Subject: [PATCH 0814/1532] netlib: Fixed rx buffer size for XFI

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/netlib/include/netsoc_common.h | 2 +-
 arch/mips/netlogic/lib/netlib/src/netsoc_nae.c        | 5 ++++-
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/arch/mips/netlogic/lib/netlib/include/netsoc_common.h b/arch/mips/netlogic/lib/netlib/include/netsoc_common.h
index 7464f16..7e420dc 100644
--- a/arch/mips/netlogic/lib/netlib/include/netsoc_common.h
+++ b/arch/mips/netlogic/lib/netlib/include/netsoc_common.h
@@ -354,7 +354,7 @@ static inline uint32_t update_prsr_seq_fifo_size(nae_t *nae, uint32_t *size)
 
 static inline uint32_t update_rx_buf_size(nae_t *nae, uint32_t *size)
 {
-	*size = (((current_netsoc->ingress.max_rx_fifo / 16) / nae->num_contexts) >> 2);
+	*size = (((current_netsoc->ingress.max_rx_fifo) / nae->num_contexts) >> 2);
 	return 0;
 }
 
diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
index aa8ffda..a99df36 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
@@ -1351,6 +1351,7 @@ void __netsoc_config_ingress_fifo(nae_t *nae)
 		//TODO: Verify the values
 		   case XFI_IF:
 			fifo_xoff_thresh = 12;
+			rx_buf_size = nae->ports[port].rx_buf_size;
 			//TODO: check thgrp
 			thrgrp = 3;
 			break;
@@ -1367,8 +1368,10 @@ void __netsoc_config_ingress_fifo(nae_t *nae)
 			break;
                 }
 
-		if (nae->sgmii_complex_map == 0)
+		if (nae->sgmii_complex_map == 0) {
 			update_rx_buf_size(nae, &rx_buf_size);
+			nae->ports[port].rx_buf_size = rx_buf_size;
+		}
 
 		offset = max_lanes = get_max_lanes(nae->ports[port].iftype);
 
-- 
1.9.1

