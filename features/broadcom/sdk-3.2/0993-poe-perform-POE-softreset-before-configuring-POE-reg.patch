From d198a540d1ec6e00604318e54eb5bd62bf64a87c Mon Sep 17 00:00:00 2001
From: Prasanna Mumbai <prasanna.mumbai@broadcom.com>
Date: Wed, 9 Jul 2014 04:09:04 -0700
Subject: [PATCH 0993/1532] poe: perform POE softreset before configuring POE
 registers

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/netlib/include/netsoc_dev.h      | 1 +
 arch/mips/netlogic/lib/netlib/include/netsoc_poe.h      | 9 +++++++++
 arch/mips/netlogic/lib/syslib/include/nlm_hal_xlp_dev.h | 1 +
 3 files changed, 11 insertions(+)

diff --git a/arch/mips/netlogic/lib/netlib/include/netsoc_dev.h b/arch/mips/netlogic/lib/netlib/include/netsoc_dev.h
index 1cfa776..efae472 100644
--- a/arch/mips/netlogic/lib/netlib/include/netsoc_dev.h
+++ b/arch/mips/netlogic/lib/netlib/include/netsoc_dev.h
@@ -473,6 +473,7 @@ enum poe_stats_reg {
 #define POE_DISTR_CLASS_DROP_EN	0x20B	
 #define POE_DISTR_VEC_DROP_EN	0x20C
 #define POE_DISTRVEC_DROP_TIMER	0x20D
+#define POE_RESET	0x213
 
 #define EXT_FBP_START_ADDR       0x1800
 #define MAX_POE_EXT_MSG_STORAGE  (58 << 10) /* 58K entries */
diff --git a/arch/mips/netlogic/lib/netlib/include/netsoc_poe.h b/arch/mips/netlogic/lib/netlib/include/netsoc_poe.h
index db59378..7d001b8 100644
--- a/arch/mips/netlogic/lib/netlib/include/netsoc_poe.h
+++ b/arch/mips/netlogic/lib/netlib/include/netsoc_poe.h
@@ -293,6 +293,7 @@ static inline int __netsoc_poe_read_class_map(poe_t *poe)
 static inline void __netsoc_reset_poe(poe_t *poe)
 {
         int reset_bit = 10;
+	uint64_t poe_pcie_base = poe->pcie_base;
 
         if (is_nlm_xlp3xx() || is_nlm_xlp2xx()) {
                 reset_bit = 7;
@@ -306,14 +307,22 @@ static inline void __netsoc_reset_poe(poe_t *poe)
         else
                 reset_bit = 10;
 
+	netsoc_api_print(NETSOC_APIDBG_DEFAULT, "%s %d\n",__func__, __LINE__);
 
         /* POE reset in the SYS_RESET register */
         nlm_hal_write_sys_reg(poe->node, SYS_RESET, (1 << reset_bit));
         nlm_mdelay(1);
 
+	netsoc_api_print(NETSOC_APIDBG_DEFAULT, "%s %d\n",__func__, __LINE__);
         nlm_hal_write_sys_reg(poe->node, SYS_RESET, (0 << reset_bit));
         nlm_mdelay(1);
 
+	if (is_nlm_xlp9xx_ax())
+	{
+		netsoc_api_print(NETSOC_APIDBG_DEFAULT, "%s %d\n",__func__, __LINE__);
+		netsoc_write_poe_pcie_reg(poe_pcie_base, POE_RESET, 0x1);
+	}
+
         return;
 }
 
diff --git a/arch/mips/netlogic/lib/syslib/include/nlm_hal_xlp_dev.h b/arch/mips/netlogic/lib/syslib/include/nlm_hal_xlp_dev.h
index 3faad78..b7d31f7c 100644
--- a/arch/mips/netlogic/lib/syslib/include/nlm_hal_xlp_dev.h
+++ b/arch/mips/netlogic/lib/syslib/include/nlm_hal_xlp_dev.h
@@ -208,6 +208,7 @@ extern int is_nlm_xlp(unsigned int chipid, unsigned int rev,  unsigned int ext);
 #define is_nlm_xlp2xx()	    is_nlm_xlp(0x2000, XLP_REVISION_ANY,  0)
 #define is_nlm_xlp2xx_b0()	    is_nlm_xlp(0x2000, XLP_REVISION_B0,  0)
 #define is_nlm_xlp9xx()	    is_nlm_xlp(0x9000, XLP_REVISION_ANY,  0)
+#define is_nlm_xlp9xx_ax()	is_nlm_xlp(0x9000, XLP_REVISION_AX,  0)
 
 #define is_nlm_xlp5xx_B(rev)      ( is_nlm_xlp(0x5000, rev, CPU_EXTPID_XLP_5XX_BASE))
 #define is_nlm_xlp532_B(rev)      ( is_nlm_xlp(0x5084, rev, CPU_EXTPID_XLP_5XX_BASE))
-- 
1.9.1

