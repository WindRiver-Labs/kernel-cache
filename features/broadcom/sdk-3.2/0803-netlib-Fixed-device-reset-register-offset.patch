From 3edf9fbd7ae73052915984c2400533a2ea1328bb Mon Sep 17 00:00:00 2001
From: Jayanthi A <jayanthi.annadurai@broadcom.com>
Date: Fri, 4 Oct 2013 21:57:50 -0700
Subject: [PATCH 0803/1532] netlib: Fixed device reset register offset

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 .../netlogic/lib/netlib/include/netsoc_haliface.h  |  1 +
 arch/mips/netlogic/lib/netlib/include/netsoc_nae.h | 30 ++++++++++++----------
 2 files changed, 18 insertions(+), 13 deletions(-)

diff --git a/arch/mips/netlogic/lib/netlib/include/netsoc_haliface.h b/arch/mips/netlogic/lib/netlib/include/netsoc_haliface.h
index 03f02a3..491169b 100644
--- a/arch/mips/netlogic/lib/netlib/include/netsoc_haliface.h
+++ b/arch/mips/netlogic/lib/netlib/include/netsoc_haliface.h
@@ -32,6 +32,7 @@
 #define __BRCM_NETSOC_HALIFACE_H
 
 #include "nlm_hal.h"
+#include "xlp9xx_sys.h"
 #include "netsoc_dev.h"
 #include "nlm_nae.h"
 #include "nlm_hal_nae.h"
diff --git a/arch/mips/netlogic/lib/netlib/include/netsoc_nae.h b/arch/mips/netlogic/lib/netlib/include/netsoc_nae.h
index 5e9f241..51f4d76 100644
--- a/arch/mips/netlogic/lib/netlib/include/netsoc_nae.h
+++ b/arch/mips/netlogic/lib/netlib/include/netsoc_nae.h
@@ -187,26 +187,30 @@ static inline void __netsoc_reset_nae(nae_t *nae)
 {
         int reset_bit = 9;
         /* Reset NAE */
-
-        if (is_nlm_xlp3xx() || is_nlm_xlp2xx())	{
-                reset_bit = 6;
-        }
-        else if (is_nlm_xlp9xx()) {
+	
+	if (is_nlm_xlp9xx()) {
                 if (nae->nae_id == 0)
                     reset_bit = 21;
                 else
                     reset_bit = 22;
+		nlm_hal_write_sys_reg(nae->node, SYS_SYSDEVICERESET, (1 << reset_bit));
+		nlm_mdelay(1);
+		nlm_hal_write_sys_reg(nae->node, SYS_SYSDEVICERESET, 0);
+		nlm_mdelay(1);
         }
-        else
-                reset_bit = 9;
-
-        nlm_hal_write_sys_reg(nae->node, SYS_RESET, (1 << reset_bit));
-        nlm_mdelay(1);
+	else {
+        	if (is_nlm_xlp3xx() || is_nlm_xlp2xx())	{
+                	reset_bit = 6;
+        	}
+        	else
+                	reset_bit = 9;
 
-        nlm_hal_write_sys_reg(nae->node, SYS_RESET, (0 << reset_bit));
-        nlm_mdelay(1);
+        	nlm_hal_write_sys_reg(nae->node, SYS_RESET, (1 << reset_bit));
+        	nlm_mdelay(1);
 
-//        nae->nae_reset_done = 1;	FIXME J
+        	nlm_hal_write_sys_reg(nae->node, SYS_RESET, (0 << reset_bit));
+        	nlm_mdelay(1);
+	}
 }
 
 
-- 
1.9.1

