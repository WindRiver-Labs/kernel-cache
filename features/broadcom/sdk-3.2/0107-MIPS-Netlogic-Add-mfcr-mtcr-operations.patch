From cd39320685517b53fa90aac2f2b4820ace5997b7 Mon Sep 17 00:00:00 2001
From: Jayachandran C <jchandra@broadcom.com>
Date: Tue, 8 Apr 2014 16:17:16 +0530
Subject: [PATCH 0107/1532] MIPS: Netlogic: Add mfcr/mtcr operations

The core control registers of XLR/XLP processors are configured
using control registers in the core which can be accessed by using
the MFCR and MTCR custom opcodes.

Add support for 32-bit and 64-bit versions of these to mips-extns.h
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/include/asm/netlogic/mips-extns.h | 58 +++++++++++++++++++++++++++++
 1 file changed, 58 insertions(+)

diff --git a/arch/mips/include/asm/netlogic/mips-extns.h b/arch/mips/include/asm/netlogic/mips-extns.h
index 06f1f75..a216637 100644
--- a/arch/mips/include/asm/netlogic/mips-extns.h
+++ b/arch/mips/include/asm/netlogic/mips-extns.h
@@ -292,4 +292,62 @@ do {									\
 			: : "Jr" (value));				\
 })
 
+#ifdef CONFIG_64BIT
+static inline uint64_t nlm_mfcr(uint32_t reg)
+{
+	uint64_t res;
+
+	__asm__ __volatile__(
+		".set\tpush\n\t"
+		".set\tarch=xlr\n\t"
+		"mfcr\t%0, %1\n\t"
+		".set\tpop\n"
+		: "=r" (res)
+		: "r"(reg));
+	return res;
+}
+
+static inline void nlm_mtcr(uint32_t reg, uint64_t val)
+{
+	__asm__ __volatile__(
+		".set\tpush\n\t"
+		".set\tarch=xlr\n\t"
+		"mtcr\t%0, %1\n\t"
+		".set\tpop\n"
+		: : "r" (val), "r"(reg));
+}
+#else
+static inline  uint64_t nlm_mfcr(uint32_t reg)
+{
+	uint64_t val;
+
+	__asm__ __volatile__ (
+		".set\tpush\n\t"
+		".set\tarch=xlr\n\t"
+		"mfcr\t%M0, %1\n\t"
+		"dsll\t%L0, %M0, 32\n\t"
+		"dsra\t%M0, %M0, 32\n\t"
+		"dsra\t%L0, %L0, 32\n\t"
+		".set\tpop\n"
+		: "=r"(val)
+		: "r"(reg));
+
+	return val;
+}
+
+static inline void nlm_mtcr(uint32_t reg, uint64_t val)
+{
+	__asm__ __volatile__ (
+		".set\tpush\n\t"
+		".set\tarch=xlr\n\t"
+		"dsll\t%L0, %L0, 32\n\t"
+		"dsrl\t%L0, %L0, 32\n\t"
+		"dsll\t%M0, %M0, 32\n\t"
+		"or\t%L0, %L0, %M0\n\t"
+		"mtcr\t%L0, %1\n"
+		".set\tpop\n"
+		: : "r"(val), "r"(reg));
+}
+#endif
+
 #endif /*_ASM_NLM_MIPS_EXTS_H */
-- 
1.9.1

