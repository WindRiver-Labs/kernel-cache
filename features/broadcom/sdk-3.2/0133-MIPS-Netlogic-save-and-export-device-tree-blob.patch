From 9b71a44793b1f17899175eb4f5715ecd75173c24 Mon Sep 17 00:00:00 2001
From: Jayachandran C <jchandra@broadcom.com>
Date: Fri, 8 Mar 2013 20:35:01 +0530
Subject: [PATCH 0133/1532] MIPS: Netlogic: save and export device tree blob

Save a copy of the device tree blob passed in by bootloader. Export it
so that the custom kmods can use it.
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/xlp/dt.c | 31 +++++++++++++++++++++----------
 1 file changed, 21 insertions(+), 10 deletions(-)

diff --git a/arch/mips/netlogic/xlp/dt.c b/arch/mips/netlogic/xlp/dt.c
index 97d974b..a9bf5d8 100644
--- a/arch/mips/netlogic/xlp/dt.c
+++ b/arch/mips/netlogic/xlp/dt.c
@@ -33,6 +33,7 @@
  */
 
 #include <linux/kernel.h>
+#include <linux/export.h>
 #include <linux/bootmem.h>
 
 #include <linux/of_fdt.h>
@@ -81,23 +82,33 @@ void __init *xlp_dt_init(void *fdtp)
 	return fdtp;
 }
 
+/* Provide FDT blob if the modules need it */
+void *nlm_fdt_blob;
+EXPORT_SYMBOL(nlm_fdt_blob);
+
+EXPORT_SYMBOL(initial_boot_params); /* deprecated */
+
 void __init device_tree_init(void)
 {
-	unsigned long base, size;
+	unsigned long dt_size;
+	void	*blob;
 
 	if (!initial_boot_params)
-		return;
+		panic("No device tree!\n");
 
-	base = virt_to_phys((void *)initial_boot_params);
-	size = be32_to_cpu(initial_boot_params->totalsize);
-
-	/* Before we do anything, lets reserve the dt blob */
-	reserve_bootmem(base, size, BOOTMEM_DEFAULT);
+	/*
+	 * boot mem available now, make a copy of the blob, and
+	 * update initial_boot_params to point there.
+	 */
+	dt_size = be32_to_cpu(initial_boot_params->totalsize);
+	blob = early_init_dt_alloc_memory_arch(dt_size, 8);
+	if (blob == NULL)
+		panic("Could not allocate initial_boot_params\n");
+	memcpy(blob, initial_boot_params, dt_size);
+	nlm_fdt_blob = initial_boot_params = blob;
+	pr_info("fdt copied to %p, size %ld\n", blob, dt_size);
 
 	unflatten_device_tree();
-
-	/* free the space reserved for the dt blob */
-	free_bootmem(base, size);
 }
 
 static struct of_device_id __initdata xlp_ids[] = {
-- 
1.9.1

