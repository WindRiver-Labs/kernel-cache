From 79a840f1b6b61159c36018ae0a529d1f4e9f1896 Mon Sep 17 00:00:00 2001
From: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Date: Thu, 21 Oct 2010 21:24:13 -0700
Subject: [PATCH 1315/1532] NAE: Override POE distvec based on cpumask

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/broadcom/nae/init_nae.c   | 5 ++++-
 drivers/net/ethernet/broadcom/nae/net_common.h | 2 +-
 drivers/net/ethernet/broadcom/nae/xlp_nae.c    | 3 ++-
 3 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/broadcom/nae/init_nae.c b/drivers/net/ethernet/broadcom/nae/init_nae.c
index 737be88..dcd96fd 100644
--- a/drivers/net/ethernet/broadcom/nae/init_nae.c
+++ b/drivers/net/ethernet/broadcom/nae/init_nae.c
@@ -385,7 +385,7 @@ static void deflate_frin_fifo_carving(void)
 	}
 }
 
-int initialize_nae(void)
+int initialize_nae(uint32_t cm0, uint32_t cm1, uint32_t cm2, uint32_t cm3)
 {
 	int i = 0;
 
@@ -449,5 +449,8 @@ int initialize_nae(void)
 	printk("FRIN desc carving after HAL initialization...\n");
 	print_frin_desc_carving();
 
+	printk("Overriding HAL POE configuration based on current active cpumask\n");
+	nlm_hal_init_poe_distvec(0, cm0, cm1, cm2, cm3, (1 << nae_cfg.rx_vc));
+
 	return 0;
 }
diff --git a/drivers/net/ethernet/broadcom/nae/net_common.h b/drivers/net/ethernet/broadcom/nae/net_common.h
index 878f081..ad3cfa0 100644
--- a/drivers/net/ethernet/broadcom/nae/net_common.h
+++ b/drivers/net/ethernet/broadcom/nae/net_common.h
@@ -179,7 +179,7 @@ struct nae_config {
 extern struct nae_config nae_cfg;
 extern int cntx2port[];
 
-extern int initialize_nae(void);
+extern int initialize_nae(uint32_t cm0, uint32_t cm1, uint32_t cm2, uint32_t cm3);
 extern void nlm_xlp_msgring_int_handler(unsigned int irq, struct pt_regs *regs);
 
 #endif
diff --git a/drivers/net/ethernet/broadcom/nae/xlp_nae.c b/drivers/net/ethernet/broadcom/nae/xlp_nae.c
index f64c6a3..d12d091 100755
--- a/drivers/net/ethernet/broadcom/nae/xlp_nae.c
+++ b/drivers/net/ethernet/broadcom/nae/xlp_nae.c
@@ -399,7 +399,8 @@ static void nlm_xlp_nae_init(void)
 	       debug, frin_desc_thres, naecfg_hack, drop_uboot_pkt);
 	printk("rely_on_firmware_config = %d\n", rely_on_firmware_config);
 
-	if (initialize_nae()) return;
+	if (initialize_nae(cpumask_to_uint32(&cpu_present_map), 0, 0, 0))
+		return;
 
 	nae_fb_vc = nae_cfg.fb_vc;
 	nae_rx_vc = nae_cfg.rx_vc;
-- 
1.9.1

