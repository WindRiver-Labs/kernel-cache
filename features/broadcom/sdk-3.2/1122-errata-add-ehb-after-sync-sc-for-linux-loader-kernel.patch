From 3c2aaae60e9d194f61cee3912d0a4364bcf8c4bd Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Wed, 26 Sep 2012 12:40:14 -0700
Subject: [PATCH 1122/1532] errata: add ehb after sync/sc for linux-loader
 kernel module

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/misc/netlogic/linux-loader/xlr_lib_platform.h | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/drivers/misc/netlogic/linux-loader/xlr_lib_platform.h b/drivers/misc/netlogic/linux-loader/xlr_lib_platform.h
index adcd9ab..8ee6b2c 100644
--- a/drivers/misc/netlogic/linux-loader/xlr_lib_platform.h
+++ b/drivers/misc/netlogic/linux-loader/xlr_lib_platform.h
@@ -75,7 +75,8 @@ static __inline__ void lib_spin_lock(lib_spinlock_t *lock)
 	    " li\t%1, 1\n\t"
 	    "sc\t%1, %0\n\t"
 	    "beqz\t%1, 1b\n\t"
-	    " sync\n\t"
+	    " nop\n\t"
+	    " ehb\n\t"
 	    ".set\treorder"
 	    : "=m" (lock->lock), "=&r" (tmp)
 	    : "m" (lock->lock)
@@ -87,6 +88,7 @@ static __inline__ void lib_spin_unlock(lib_spinlock_t *lock)
 	__asm__ __volatile__(
 	    ".set\tnoreorder\t\t\t# spin_unlock\n\t"
 	    "sync\n\t"
+	    "ehb\n\t"
 	    "sw\t$0, %0\n\t"
 	    ".set\treorder"
 	    : "=m" (lock->lock)
-- 
1.9.1

