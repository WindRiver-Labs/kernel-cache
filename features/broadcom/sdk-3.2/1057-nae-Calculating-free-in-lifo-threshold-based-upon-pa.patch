From d942fba00e60fb79ddd0a034974bd9d3df91f817 Mon Sep 17 00:00:00 2001
From: Vikas Gupta <vikas.gupta@broadcom.com>
Date: Thu, 11 Dec 2014 14:56:19 +0530
Subject: [PATCH 1057/1532] nae: Calculating free-in-lifo threshold based upon
 parser threshold

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/netlib/src/netsoc_nae.c | 26 ++++++++++++++------------
 1 file changed, 14 insertions(+), 12 deletions(-)

diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
index 106cc8b..3ad39eb 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
@@ -4119,7 +4119,7 @@ int __netsoc_pcs_init(nae_t *nae)
 
 static int __netsoc_config_freein_fifo(nae_t *nae)
 {
-	uint32_t reg, size, spillsz, guest_id;
+	uint32_t reg, size, spillsz, guest_id,parseq_th;
         int start = 0, i,  th_hi, th_lo, minsz;
         uint64_t spill_addr, spill_mem_addr, spill_mem_size;
         int freein_fifo_total_queues = nae->frin_total_queue;
@@ -4235,6 +4235,10 @@ static int __netsoc_config_freein_fifo(nae_t *nae)
                                 netsoc_api_print(NETSOC_APIDBG_CONFIG, "Freein fifo cfg %d fcstart %d size %d\n", i, start, size);
                                 start += size;
                         }
+			if(start > current_netsoc->ingress.max_frin_lifo){
+                        	netsoc_api_print(NETSOC_APIDBG_ERROR, "ERROR : Number of on-chip entries incrased as compared to available\n");
+	                        return -NETSOC_API_PARAM_INVALID;
+			}
                 }
         }
 
@@ -4245,21 +4249,19 @@ static int __netsoc_config_freein_fifo(nae_t *nae)
 		if ((nae->freein_fifo_onchip_num_descs[i]) && (nae->freein_fifo_onchip_num_descs[i]) < minsz)
 			minsz = nae->freein_fifo_onchip_num_descs[i];
 	}
-	minsz /= 2;
 
         if(spillsz) {
-		if (IS_NLM_XLP9XX_FAMILY) {
-			th_hi = minsz / 4;
-			th_lo = minsz / 2;
-		}
-		else {
-	                th_hi = 6; /* Defualt value */
-        	        th_lo = 0xe; /* Default value */
+        	parseq_th = netsoc_read_nae_reg(nae->nae_base , RX_FREE_LIFO_TH) & 0xff;
+		th_lo = parseq_th/2 +1 ; /*minimum entries should be parseq_th/2+1*/	
+		th_hi = 6; /*putting default*/
+		if((th_lo + th_hi) > (minsz/2)){
+                        netsoc_api_print(NETSOC_APIDBG_ERROR, "ERROR : Threshold values are not in range with total on chip Free-in configuration\n");
+                        return -NETSOC_API_PARAM_INVALID;
 		}
-                /* spill credits [27:24] has to be 2 */
-                reg = (2 << 24) | th_lo | (th_hi << 12);
+		 /* spill credits [27:24] has to be 2 */
+		reg = (2 << 24) | th_lo | (th_hi << 12);
                 netsoc_write_nae_reg(nae->nae_base, FREE_FIFO_THRESHOLD_CFG, reg);
-
+	
 		netsoc_api_print(NETSOC_APIDBG_CONFIG, "Freein fifo spill thrhi %d thrlo %d\n",th_hi, th_lo);
                 if(spill_mem_addr && ((spill_addr << 6) > (spill_mem_addr + spill_mem_size))) {
                         netsoc_api_print(NETSOC_APIDBG_ERROR, "ERROR : Spill address range overflow\n");
-- 
1.9.1

