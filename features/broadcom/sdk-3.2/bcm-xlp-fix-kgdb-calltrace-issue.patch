From 76f9698cb72dfe53f86878968ea5f19625c69564 Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Fri, 24 Apr 2015 14:40:52 +0800
Subject: [PATCH] bcm-xlp: fix kgdb calltrace issue

We need to use raw_spin_lock_irqsave/raw_spin_lock_irqrestore to replace
spin_lock_irqsave/spin_lock_irqrestore, else system would report the
call trace as below:

BUG: sleeping function called from invalid context at kernel/rtmutex.c:797
in_atomic(): 1, irqs_disabled(): 1, pid: 1051, name: sh
Preemption disabled at:[<          (null)>]           (null)

CPU: 0 PID: 1051 Comm: sh Not tainted 3.10.62-ltsi-rt55-WR6.0.0.0_preempt-rt #6
Stack : 0000000000000000 000000000000004f 0000000000000000 0000000000000000
	  0000000000000004 ffffffffc0e00000 0000000000000000 0000000000000000
	  ffffffffc1250000 0000000000000000 000000000000004f 0000000000000006
	  c0000007f38ef6d0 ffffffffc02b65f0 0000000000000000 0000000000000000
	  0000000000000000 0000000000000000 ffffffffc1230000 ffffffffc1230000
	  ffffffffc0c2df68 ffffffffc0dffd57 ffffffffc122c988 c0000007ebe96cf8
	  000000000000041b 0000000000000000 ffffffffc1260000 ffffffffc1260000
	  c0000007f38ef750 c0000007f38ef660 c0000007f38ef778 ffffffffc0b0b870
	  c0000007f38ef7b0 ffffffffc02b8278 c0000007ebe96940 ffffffffc0c2df68
	  0000000000000000 ffffffffc0288350 0000000000000000 0000000000000000
	  ...
Call Trace:
[<ffffffffc0288350>] show_stack+0xd8/0xf8
[<ffffffffc0b0b870>] rt_spin_lock+0x38/0x98
[<ffffffffc02984f4>] nlm_kgdb_smp_hook+0xac/0x150
[<ffffffffc033e02c>] kgdb_cpu_enter+0x604/0x858
[<ffffffffc033e634>] kgdb_handle_exception+0x1c4/0x220
[<ffffffffc0298028>] kgdb_mips_notify+0xe8/0x218
[<ffffffffc02ed1dc>] notifier_call_chain+0x6c/0xd0
[<ffffffffc02ed650>] atomic_notifier_call_chain+0x48/0x70
[<ffffffffc02ede34>] notify_die+0x3c/0x58
[<ffffffffc0288630>] do_trap_or_bp+0x58/0x1d8
[<ffffffffc02828e4>] resume_userspace_check+0x0/0x10
[<ffffffffc029842c>] breakinst+0x0/0x1c
[<ffffffffc033d254>] kgdb_breakpoint+0x44/0x70

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/kernel/kgdb.c |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/mips/kernel/kgdb.c b/arch/mips/kernel/kgdb.c
index f65801d..c01b5a4 100644
--- a/arch/mips/kernel/kgdb.c
+++ b/arch/mips/kernel/kgdb.c
@@ -52,7 +52,7 @@ static unsigned long mipsGetNpc(struct pt_regs *pRegs);
 #include <asm/netlogic/mips-extns.h>
 #include <asm/netlogic/common.h>
 #include <asm/netlogic/interrupt.h>
-DEFINE_SPINLOCK(nlm_kgdb_lock);
+DEFINE_RAW_SPINLOCK(nlm_kgdb_lock);
 #endif
 
 static struct hard_trap_info {
@@ -251,11 +251,11 @@ void nlm_kgdb_smp_hook(void)
         if (!cpus)
                 return;
 
-        spin_lock_irqsave(&nlm_kgdb_lock, flags);
+        raw_spin_lock_irqsave(&nlm_kgdb_lock, flags);
         for (i = 0; i < NR_CPUS; i++)
                 if (cpu_online(i) && i != cpu)
                         mp_ops->send_ipi_single(i, SMP_CALL_KGDB_HOOK);
-        spin_unlock_irqrestore(&nlm_kgdb_lock, flags);
+        raw_spin_unlock_irqrestore(&nlm_kgdb_lock, flags);
 }
 
 void nlm_kgdb_call_nmi_hook(unsigned int irq, struct pt_regs *regs)
-- 
1.7.5.4

