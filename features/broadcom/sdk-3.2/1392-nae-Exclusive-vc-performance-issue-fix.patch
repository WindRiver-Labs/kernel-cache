From 8c265bdb9071ae882860a9e8188ee2f3616229bd Mon Sep 17 00:00:00 2001
From: Hareesh R <hareeshr@broadcom.com>
Date: Thu, 17 Jan 2013 20:08:21 +0530
Subject: [PATCH 1392/1532] nae : Exclusive vc performance issue fix

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/broadcom/nae/xlpge_rx.c | 13 +++++++++----
 1 file changed, 9 insertions(+), 4 deletions(-)

diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_rx.c b/drivers/net/ethernet/broadcom/nae/xlpge_rx.c
index 74eced3..5df5c24 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_rx.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_rx.c
@@ -849,13 +849,18 @@ static void nlm_xlp_nae_msgring_handler(uint32_t vc, uint32_t src_id,
 
 static int xlp_nae_napi_poll(int vc, int budget)
 {
-	int rx_pkts = 0;
+	int rx_pkts = 0, rx, i;
 	int cpu = hard_smp_processor_id();
 
 	Message("%s in vc %d budget %d\n", __func__, vc, budget);
 
-	xlp_poll_upper(cpu);
-	rx_pkts = xlp_poll_lower(budget, cpu);
+	for(i =0; i < budget; i++) {
+		xlp_poll_upper(cpu);
+		rx = xlp_poll_lower(1, cpu);
+		if(!rx)
+			break;
+		rx_pkts += rx;
+	}
 
 	return rx_pkts;
 }
@@ -925,7 +930,7 @@ extern int nlm_xlp_register_napi_final_handler(int major,
 int nlm_xlp_enable_napi(void)
 {
 	if (exclusive_vc) {
-		printk("Registering exclusive napi vc handler\n");
+		printk("Registering exclusive napi vc handler....\n");
 		nlm_xlp_register_napi_vc_handler(nae_rx_vc, xlp_nae_napi_poll);
 		nlm_xlp_register_napi_vc_handler(nae_fb_vc, xlp_nae_napi_poll);
 
-- 
1.9.1

