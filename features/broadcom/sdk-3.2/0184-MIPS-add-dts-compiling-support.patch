From bd416585b6dd8ce494bd9406e8b3795733b72a7e Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Tue, 28 May 2013 15:59:17 +0800
Subject: [PATCH 0184/1532] MIPS: add dts compiling support

Allows to put the dts file to arch/mips/boot/dts/ and compile it with
the following command:

$ make <dts-file-name>.dtb

It is based on the powerpc implementation.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/Kconfig       | 3 +++
 arch/mips/Makefile      | 7 ++++++-
 arch/mips/boot/Makefile | 7 +++++++
 3 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index cd30c38..4738ed5 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -2419,6 +2419,9 @@ config STACKTRACE_SUPPORT
 	bool
 	default y
 
+config DTC
+	def_bool y
+
 source "init/Kconfig"
 
 source "kernel/Kconfig.freezer"
diff --git a/arch/mips/Makefile b/arch/mips/Makefile
index dd58a04..b81f649 100644
--- a/arch/mips/Makefile
+++ b/arch/mips/Makefile
@@ -266,6 +266,8 @@ vmlinux.32: vmlinux
 
 #obj-$(CONFIG_KPROBES)		+= kprobes.o
 
+boot := arch/$(ARCH)/boot
+
 #
 # The 64-bit ELF tools are pretty broken so at this time we generate 64-bit
 # ELF files from 32-bit files by conversion.
@@ -285,7 +287,7 @@ vmlinuz vmlinuz.bin vmlinuz.ecoff vmlinuz.srec: $(vmlinux-32) FORCE
 	   VMLINUX_LOAD_ADDRESS=$(load-y) 32bit-bfd=$(32bit-bfd) $@
 
 
-CLEAN_FILES += vmlinux.32 vmlinux.64
+CLEAN_FILES += vmlinux.32 vmlinux.64 *.dtb
 
 archprepare:
 ifdef CONFIG_MIPS32_N32
@@ -310,6 +312,9 @@ archclean:
 	$(Q)$(MAKE) $(clean)=arch/mips/boot/compressed
 	$(Q)$(MAKE) $(clean)=arch/mips/lasat
 
+%.dtb:
+	$(Q)$(MAKE) ARCH=mips $(build)=$(boot) $(patsubst %,$(boot)/%,$@)
+
 define archhelp
 	echo '  install              - install kernel into $(INSTALL_PATH)'
 	echo '  vmlinux.ecoff        - ECOFF boot image'
diff --git a/arch/mips/boot/Makefile b/arch/mips/boot/Makefile
index 851261e..784a719 100644
--- a/arch/mips/boot/Makefile
+++ b/arch/mips/boot/Makefile
@@ -40,3 +40,10 @@ quiet_cmd_srec = OBJCOPY $@
       cmd_srec = $(OBJCOPY) -S -O srec $(strip-flags) $(VMLINUX) $@
 $(obj)/vmlinux.srec: $(VMLINUX) FORCE
 	$(call if_changed,srec)
+
+# Rule to build device tree blobs
+DTS_FLAGS ?= -p 1024
+dtstree		:= $(srctree)/$(src)/dts
+
+$(obj)/%.dtb: $(src)/dts/%.dts FORCE
+	$(call if_changed_dep,dtc)
-- 
1.9.1

