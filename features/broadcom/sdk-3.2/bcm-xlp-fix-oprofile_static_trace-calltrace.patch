From 9c159df56365bed0f88b89a547131b27d4d00784 Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Mon, 27 Apr 2015 17:02:10 +0800
Subject: [PATCH 2/2] bcm-xlp: fix oprofile_static_trace calltrace

When testing oprofile_static_trace, it occurs the
calltrace, and the reason is similar to the upstream commit
cf5b2d23a75c("MIPS: oprofile: Fix BUG due to smp_processor_id()
in preemptible code."). So we use boot_cpu_type() to replace
the current_cpu_type(). The calltrace is as below:

[ 3148.070000] BUG: using smp_processor_id() in preemptible [00000000] code: oprofiled/23187
[ 3148.070000] caller is mipsxx_reg_setup+0x120/0x1b8
[ 3148.080000] CPU: 0 PID: 23187 Comm: oprofiled Tainted: P W O 3.10.62-ltsi-WR6.0.0.0_standard #1
[ 3148.090000] Stack : c000000107fff8f8 0000000040808000 ffffffffc02b4d0c 0000000000000000
0000000000000000 0000000000000000 0000000000000000 0000000000000000
0000000000000000 0000000000000000 0000000000000000 00000000f0000000
c000000107fff958 ffffffffc02b4cfc 0000000000000000 0000000000000000
0000000000000000 ffffffffc1230000 ffffffffc122c968 ffffffffc1230000
ffffffffc0c45848 ffffffffc0e06397 ffffffffc122c968 c000000106a903b0
0000000000005a93 0000000000000000 8000000000000000 000000000000004b
c000000107fff9d8 c000000107fff8e8 c000000107fffa00 ffffffffc07269d4
c000000107fffa38 ffffffffc02b6828 c000000106a90000 ffffffffc0c45848
0000000000000000 ffffffffc0288208 0000000000000000 0000000000000000
...
[ 3148.150000] Call Trace:
[ 3148.150000] [<ffffffffc0288208>] show_stack+0xd8/0xf8
[ 3148.160000] [<ffffffffc07269d4>] debug_smp_processor_id+0xf4/0x110
[ 3148.160000] [<ffffffffc0986fd0>] mipsxx_reg_setup+0x120/0x1b8
[ 3148.160000] [<ffffffffc0986688>] op_mips_setup+0x38/0x68
[ 3148.170000] [<ffffffffc0982d30>] oprofile_setup+0x70/0x148
[ 3148.170000] [<ffffffffc0984f24>] event_buffer_open+0x84/0x110
[ 3148.180000] [<ffffffffc03f716c>] do_dentry_open+0x1f4/0x318
[ 3148.180000] [<ffffffffc03f72d4>] finish_open+0x44/0x70
[ 3148.180000] [<ffffffffc040af60>] do_last.isra.40+0x2d0/0xd88
[ 3148.190000] [<ffffffffc040bad4>] path_openat.isra.41+0xbc/0x4e0
[ 3148.200000] [<ffffffffc040cf94>] do_filp_open+0x4c/0xc0
[ 3148.200000] [<ffffffffc03f8ac8>] do_sys_open+0x130/0x220
[ 3148.200000] [<ffffffffc028e044>] handle_sys64+0x44/0x68

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/oprofile/op_model_mipsxx.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/arch/mips/oprofile/op_model_mipsxx.c b/arch/mips/oprofile/op_model_mipsxx.c
index 3608422..4f6d2de 100644
--- a/arch/mips/oprofile/op_model_mipsxx.c
+++ b/arch/mips/oprofile/op_model_mipsxx.c
@@ -211,7 +211,7 @@ static void mipsxx_reg_setup(struct op_counter_config *ctr)
 			reg.control[i] |= M_PERFCTL_EXL;
 		if (boot_cpu_type() == CPU_XLR)
 			reg.control[i] |= M_PERFCTL_COUNT_ALL_THREADS;
-		if (current_cpu_type() == CPU_XLP)
+		if (boot_cpu_type() == CPU_XLP)
 			reg.control[i] |= M_XLP_PERFCTL_COUNT_ALL_THREADS;
 		if (cpu_has_64bit_perfcntr())
 			reg.counter64[i] = 0x8000000000000000 - ctr[i].count;
-- 
1.7.5.4

