From c47bdddc21f6fdccadb26c0fb5484775eb3da788 Mon Sep 17 00:00:00 2001
From: Vikas Gupta <vikas.gupta@broadcom.com>
Date: Fri, 28 Feb 2014 23:55:52 +0530
Subject: [PATCH 0900/1532] nae: API added to configure on chip entries for
 free in LIFOs.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/netlib/include/export_sym.h |  1 +
 .../netlogic/lib/netlib/include/netsoc_libiface.h  |  1 +
 arch/mips/netlogic/lib/netlib/include/netsoc_nae.h | 33 ++++++++++++++++++++++
 arch/mips/netlogic/lib/netlib/src/netsoc_api.c     |  6 ++++
 arch/mips/netlogic/lib/netlib/src/netsoc_nae.c     |  4 +--
 5 files changed, 43 insertions(+), 2 deletions(-)

diff --git a/arch/mips/netlogic/lib/netlib/include/export_sym.h b/arch/mips/netlogic/lib/netlib/include/export_sym.h
index f76ff6d..b3605b0 100644
--- a/arch/mips/netlogic/lib/netlib/include/export_sym.h
+++ b/arch/mips/netlogic/lib/netlib/include/export_sym.h
@@ -35,6 +35,7 @@ EXPORT_SYMBOL(netsoc_get_txq_base);
 EXPORT_SYMBOL(netsoc_drain_frinq);
 EXPORT_SYMBOL(netsoc_drain_all_frinq);
 EXPORT_SYMBOL(netsoc_get_free_desc);
+EXPORT_SYMBOL(netsoc_set_config_free_desc);
 EXPORT_SYMBOL(netsoc_get_free_spill_desc);
 EXPORT_SYMBOL(netsoc_configure_frinq_spill);
 EXPORT_SYMBOL(netsoc_config_poe_ext_storage);
diff --git a/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h b/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h
index ead8e83..582dfb4 100644
--- a/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h
+++ b/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h
@@ -537,6 +537,7 @@ extern int netsoc_configure_frinq_guestid(nae_t *nae, uint32_t frin_qnum, uint32
 extern int netsoc_configure_frinq_spill(nae_t *nae, uint32_t frin_qnum, frin_lifo_config_t *frin_config);
 extern int netsoc_get_free_spill_desc(nae_t *nae, uint32_t frin_qnum);
 extern int netsoc_get_free_desc(nae_t *nae, uint32_t frin_qnum);
+extern void netsoc_set_config_free_desc(nae_t *nae, uint32_t size, uint32_t start, uint32_t frin_qnum);
 extern int netsoc_drain_all_frinq(nae_t *nae);
 extern int netsoc_drain_frinq(nae_t *nae, uint32_t frin_q);
 extern int netsoc_get_frinq_base(nae_t *nae);
diff --git a/arch/mips/netlogic/lib/netlib/include/netsoc_nae.h b/arch/mips/netlogic/lib/netlib/include/netsoc_nae.h
index 937deb7..11d6ca1 100644
--- a/arch/mips/netlogic/lib/netlib/include/netsoc_nae.h
+++ b/arch/mips/netlogic/lib/netlib/include/netsoc_nae.h
@@ -167,6 +167,39 @@ static inline uint32_t __netsoc_get_free_desc(nae_t *nae, uint32_t frin_qnum)
 	return num_onchip_desc;
 }
 
+static inline uint32_t __netsoc_get_config_free_desc(nae_t *nae, uint32_t frin_qnum)
+{
+	uint32_t val, num_onchip_desc;
+
+	val = netsoc_read_nae_reg(nae->nae_base, RX_ERRINJ_CTRL1);
+	val &= ~(1<<31);
+	netsoc_write_nae_reg(nae->nae_base, RX_ERRINJ_CTRL1, val);
+
+	netsoc_write_nae_reg(nae->nae_base, FREE_IN_FIFO_CFG, (frin_qnum | (1<<31)));
+
+	val = netsoc_read_nae_reg(nae->nae_base, FREE_IN_FIFO_CFG);
+	num_onchip_desc = (((val >> 20) & 0x3ff) << 1);
+
+	return num_onchip_desc;
+}
+
+static inline void __netsoc_set_config_free_desc(nae_t *nae, uint32_t size, uint32_t start, uint32_t frin_qnum)
+{
+	uint32_t reg, th_hi;
+        start = start/2;
+        size = size/2;
+        reg = ((size  & 0x3ff ) << 20) | /* fcSize */
+                ((start & 0x1ff)  << 8) | /* fcStart */
+                ( frin_qnum & 0x1f);
+
+        th_hi = size/2;
+        netsoc_write_nae_reg(nae->nae_base, FREE_IN_FIFO_CFG, reg);
+        reg = (2 << 24) | 0xe | (th_hi << 12);
+        netsoc_write_nae_reg(nae->nae_base, FREE_FIFO_THRESHOLD_CFG, reg);
+
+	return;
+}
+
 static inline uint64_t __netsoc_read_spill_base(nae_t *nae, uint32_t frin_qnum)
 {
 	uint64_t spill_base;
diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_api.c b/arch/mips/netlogic/lib/netlib/src/netsoc_api.c
index 12d101b..fcffeb8 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_api.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_api.c
@@ -986,6 +986,12 @@ int netsoc_get_free_desc(nae_t *nae, uint32_t frin_qnum)
 	return __netsoc_get_free_desc(nae, frin_qnum);
 }
 
+
+void netsoc_set_config_free_desc(nae_t *nae, uint32_t size, uint32_t start, uint32_t frin_qnum)
+{
+        return __netsoc_set_config_free_desc(nae, size, start, frin_qnum);
+}
+
 /**
 * @brief netsoc_get_free_spill_desc function is used to return the number of
 *        descriptors available in spill memory
diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
index 3b2224a..7ffb2ea 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
@@ -4103,8 +4103,8 @@ static int __netsoc_config_freein_fifo(nae_t *nae)
         }
 
 	for(i=0; i < freein_fifo_total_queues; i++) {
-		netsoc_api_print(NETSOC_APIDBG_CONFIG,"LIFO[%d] onchip %d spill %d \n",i,
-			__netsoc_get_free_desc(nae, i), __netsoc_get_free_spill_desc(nae, i));
+		netsoc_api_print(NETSOC_APIDBG_CONFIG,"LIFO[%d] configured onchip %d spill %d \n",i,
+			__netsoc_get_config_free_desc(nae, i), __netsoc_get_free_spill_desc(nae, i));
 	}
 
         return NETSOC_API_SUCCESS;
-- 
1.9.1

