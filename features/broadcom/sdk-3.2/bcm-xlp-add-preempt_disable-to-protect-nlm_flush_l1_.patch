From 01c8ad467e65a90a778b2b4cecf23c6c5ac2d8a2 Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Mon, 27 Apr 2015 20:17:17 +0800
Subject: [PATCH] bcm-xlp: add preempt_disable to protect nlm_flush_l1_icache

When using kgdboc, kgdb_mips_notify will call nlm_flush_l1_icache to flush
icache, but it is not preemption-safe. If CONFIG_PREEMPT is enabled
then nlm_flush_l1_icache can be called from preemptible state. So we add the
pair preempt_disable/preempt_enable to protect nlm_flush_l1_icache from
being preempted, else will occur the calltrace as below:

BUG: using smp_processor_id() in preemptible [00000000 00000000] code: moduledebug/1097
caller is nlm_flush_l1_icache+0x60/0x1b8
CPU: 0 PID: 1097 Comm: moduledebug Tainted: G W O 3.10.62-ltsi-rt55-WR6.0.0.0_preempt-rt #1
Stack : 0000000000000000 0000000000000063 0000000000000000 0000000000000001
0000000000000004 ffffffffc0e00000 0000000000000000 0000000000000001
ffffffffc1250000 0000000000000000 0000000000000063 0000000000000006
c000000366a7f880 ffffffffc02b85a0 0000000000000000 0000000000000001
0000000000000000 0000000000000000 ffffffffc1230000 ffffffffc1230000
ffffffffc0c334e0 ffffffffc0dffd17 ffffffffc122ca08 c000000365789d40
0000000000000449 0000000000000000 ffffffffc0b0ec18 ffffffffe0000300
c000000366a7f900 c000000366a7f810 c000000366a7f928 ffffffffc0719664
c000000366a7f960 ffffffffc02ba228 c000000365789988 ffffffffc0c334e0
0000000000000000 ffffffffc02889c8 0000000000000000 0000000000000000
...
Call Trace:
[<ffffffffc02889c8>] show_stack+0xd8/0xf8
[<ffffffffc0719664>] debug_smp_processor_id+0x124/0x150
[<ffffffffc02a4b10>] nlm_flush_l1_icache+0x60/0x1b8
[<ffffffffc02988a4>] kgdb_mips_notify+0x104/0x218
[<ffffffffc02ef18c>] notifier_call_chain+0x6c/0xd0
[<ffffffffc02ef600>] atomic_notifier_call_chain+0x48/0x70
[<ffffffffc02efde4>] notify_die+0x3c/0x58
[<ffffffffc0288cc8>] do_trap_or_bp+0x58/0x1d8
[<ffffffffc0282e64>] resume_userspace_check+0x0/0x10
[<ffffffffe0000328>] putABreakPointHere+0x28/0x60 [module_debug_example]
[<ffffffffe0000080>] moduleTestLoop+0x80/0xe0 [module_debug_example]
[<ffffffffc02e740c>] kthread+0xbc/0xc8
[<ffffffffc0282eec>] ret_from_kernel_thread+0x14/0x1c

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/kernel/kgdb.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/arch/mips/kernel/kgdb.c b/arch/mips/kernel/kgdb.c
index 5a7984a..f65801d 100644
--- a/arch/mips/kernel/kgdb.c
+++ b/arch/mips/kernel/kgdb.c
@@ -440,7 +440,9 @@ static int kgdb_mips_notify(struct notifier_block *self, unsigned long cmd,
 
 	/* In SMP mode, __flush_cache_all does IPI */
 #ifdef CONFIG_CPU_XLP
+        preempt_disable();
         nlm_flush_l1_icache();
+        preempt_enable();
 #else
 	local_irq_enable();
 	__flush_cache_all();
-- 
1.7.5.4

