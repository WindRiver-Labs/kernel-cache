From f2251c9de51bdc61a40ccae89f564a6fd73c2706 Mon Sep 17 00:00:00 2001
From: Abhishek Joshi <abjoshi@broadcom.com>
Date: Tue, 11 Feb 2014 12:31:59 +0530
Subject: [PATCH 0929/1532] xlp5xx: added support for dtre init on xlp5xx

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/syslib/src/nlm_hal.c | 22 +++++++++++++++-------
 1 file changed, 15 insertions(+), 7 deletions(-)

diff --git a/arch/mips/netlogic/lib/syslib/src/nlm_hal.c b/arch/mips/netlogic/lib/syslib/src/nlm_hal.c
index 5bdceb9..37b0c73 100644
--- a/arch/mips/netlogic/lib/syslib/src/nlm_hal.c
+++ b/arch/mips/netlogic/lib/syslib/src/nlm_hal.c
@@ -968,7 +968,13 @@ static void nlm_hal_dtr_9xx_init(void *fdt)
 
 	frequency = nlm_hal_get_fdt_freq(fdt, NLM_DTRE);
 	if (frequency) {
-	xlp9xx_set_soc_frequency(node, XLP9XX_CLKDEV_GDX, (frequency * mhz));
+		if((is_nlm_xlp9xx())) {
+			xlp9xx_set_soc_frequency(node, XLP9XX_CLKDEV_GDX, (frequency * mhz));
+		}
+		else if((is_nlm_xlp5xx())) {
+			//ToDo: to be changed with 5xx specific frequency settings. Use default soc frequency for now
+			//xlp9xx_set_soc_frequency(node, XLP9XX_CLKDEV_GDX, (frequency * mhz));
+		}
 	}
 
 #ifdef DEBUG
@@ -977,8 +983,9 @@ static void nlm_hal_dtr_9xx_init(void *fdt)
 	nlm_print ("Channel control0 0x%x\n", nlm_hal_read_32bit_reg (base0, XLP_DTR_CHANNEL_CONTROL_REG_0));
 	nlm_print ("Channel control1 0x%x\n", nlm_hal_read_32bit_reg (base0, XLP_DTR_CHANNEL_CONTROL_REG_1));
 #endif
+	if((is_nlm_xlp9xx())) {/*since 5xx has only one dtre block, we skip this in 5xx case*/
 
-	/* for engine DTRE1 */
+		/* for engine DTRE1 */
 
 	/* Enable Master Control register */
 	val = nlm_hal_read_32bit_reg (base1, XLP_DTR_MASTER_CONTROL_REG);
@@ -988,11 +995,12 @@ static void nlm_hal_dtr_9xx_init(void *fdt)
 	nlm_hal_write_32bit_reg (base1, XLP_DTR_CHANNEL_CONTROL_REG_1, 0x3fe);
 
 #ifdef DEBUG
-	nlm_print ("Base Register 0x%llx\n", (unsigned long long)base1);
-	nlm_print ("Master control 0x%x\n", nlm_hal_read_32bit_reg (base1, XLP_DTR_MASTER_CONTROL_REG));
-	nlm_print ("Channel control0 0x%x\n", nlm_hal_read_32bit_reg (base1, XLP_DTR_CHANNEL_CONTROL_REG_0));
-	nlm_print ("Channel control1 0x%x\n", nlm_hal_read_32bit_reg (base1, XLP_DTR_CHANNEL_CONTROL_REG_1));
+		nlm_print ("Base Register 0x%llx\n", (unsigned long long)base1);
+		nlm_print ("Master control 0x%x\n", nlm_hal_read_32bit_reg (base1, XLP_DTR_MASTER_CONTROL_REG));
+		nlm_print ("Channel control0 0x%x\n", nlm_hal_read_32bit_reg (base1, XLP_DTR_CHANNEL_CONTROL_REG_0));
+		nlm_print ("Channel control1 0x%x\n", nlm_hal_read_32bit_reg (base1, XLP_DTR_CHANNEL_CONTROL_REG_1));
 #endif
+	}
 
 }
 
@@ -1009,7 +1017,7 @@ void nlm_hal_dtr_init(void *fdt)
     uint64_t base = nlm_hal_get_dev_base (XLP_DTR_NODE, XLP_DTR_BUS, XLP_DTR_DEVICE, XLP_DTR_FUNC);
     int frequency = 0, node = 0;
 
-    if (is_nlm_xlp9xx())
+    if(IS_NLM_XLP9XX_FAMILY) /*since 9xx is closely related to 5xx, same function is used to initialize dtre*/
     {
 	    nlm_hal_dtr_9xx_init(fdt);
 	    return;
-- 
1.9.1

