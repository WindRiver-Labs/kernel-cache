From dd84350862f30d5e3353ae1d8a392fd8af800751 Mon Sep 17 00:00:00 2001
From: Rahul Gupta <guptar@broadcom.com>
Date: Mon, 16 Sep 2013 22:51:55 -0700
Subject: [PATCH 1424/1532] Hybrid NAE and NAT: Added support for hybrid-nae
 and nat for xlp9xx.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/broadcom/nae/xlpge_rx.c | 34 +++++++++++++++++++++++++++-
 1 file changed, 33 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_rx.c b/drivers/net/ethernet/broadcom/nae/xlpge_rx.c
index bf1f815..50a33f1 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_rx.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_rx.c
@@ -589,6 +589,35 @@ static inline void nlm_update_flow_stats(unsigned int *prepad,
 
 #endif
 
+static int inline valid_buffer_lifo(int cpu, uint64_t msg1, uint32_t src_id)
+{
+		int qid = 0;
+		int lifo = (msg1>>60) & 0xf;
+		int nae_id = (src_id>>7)&0x1;
+		nae_t *nae;
+		unsigned long mflags;
+		int ret;
+		int node = (src_id >> 10) & 0x3;
+		uint64_t addr = msg1 & 0xffffffffc0ULL;
+
+		if(is_nlm_xlp9xx()){
+				nae = get_nae(node, nae_id);
+				if(!(nae->freein_fifo_dom_mask & (1<<lifo))){
+						printk("Error Packet: Cpu %d, msg1 %#lx, lifo %d, Owner fifo mask %#lx\n", 
+										cpu, msg1, lifo, nae->freein_fifo_dom_mask);
+						msgrng_access_enable(mflags);
+						qid = nae->frin_queue_base + lifo;
+						for (;;) {
+								ret = xlp_message_send_1(qid, 0, (addr & 0xffffffffffULL));
+								if (!ret) break;
+						}
+						msgrng_access_disable(mflags);
+						return 0;
+				}
+		}
+		return 1;
+}
+
 static inline void process_rx_packets(int cpu, unsigned int src_id, 
 		unsigned long long msg0, unsigned long long msg1, unsigned long long msg2)
 {
@@ -609,6 +638,10 @@ static inline void process_rx_packets(int cpu, unsigned int src_id,
 
 	/* Rx packet */
 	addr	= msg1 & 0xffffffffc0ULL;
+
+	if(!valid_buffer_lifo(cpu, msg1, src_id))
+		return;
+
 	len	= (msg1 >> 40) & 0x3fff;
 	if((is_nlm_xlp3xx() || is_nlm_xlp2xx() ||is_nlm_xlp9xx())){ 
 		context = (msg1 >> 54) & 0x3f;
@@ -618,7 +651,6 @@ static inline void process_rx_packets(int cpu, unsigned int src_id,
 		
 	node = (src_id >> 10) & 0x3;
 
-
 	vaddr = (uint64_t)(unsigned long)bus_to_virt(addr);
 	nae_cfg = (nae_t*)mac_get_nae_back_ptr(vaddr);
 	port = nae_cfg->cntx2port[context]; 
-- 
1.9.1

