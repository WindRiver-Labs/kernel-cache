From b91876808bfff6e2080a250e96865c62315cf826 Mon Sep 17 00:00:00 2001
From: kopal <kopal@broadcom.com>
Date: Thu, 16 Oct 2014 15:53:45 +0530
Subject: [PATCH 1462/1532] ethtool: Fix for Link status for XLAUI/XFI in
 ethtool.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/broadcom/nae/xlpge_ethtool.c | 25 ++++++++++-------------
 1 file changed, 11 insertions(+), 14 deletions(-)

diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_ethtool.c b/drivers/net/ethernet/broadcom/nae/xlpge_ethtool.c
index ab53f1d..d30815c 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_ethtool.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_ethtool.c
@@ -75,14 +75,18 @@ static struct {
 static int xlp_get_settings(struct net_device *dev, struct ethtool_cmd *cmd)
 {
 	struct dev_data *priv = netdev_priv(dev);
+	uint32_t speed, duplex;
 	net_port_t* nae_port = priv->nae_port;
+	
+	netsoc_get_phy_status(nae_port, &speed, &duplex);
+	
 	if (priv->type != SGMII_IF) {
 		if(priv->type == XLAUI_IF) {
 			cmd->supported = SUPPORTED_FIBRE;
 			cmd->advertising = SUPPORTED_FIBRE;
-			cmd->speed = SPEED_40000;
+			cmd->speed = speed;
 			cmd->port = PORT_FIBRE;
-			cmd->duplex = DUPLEX_FULL;
+			cmd->duplex = duplex;
 			cmd->phy_address = priv->port;
 			cmd->autoneg = AUTONEG_DISABLE;
 			cmd->maxtxpkt = 0;
@@ -93,9 +97,9 @@ static int xlp_get_settings(struct net_device *dev, struct ethtool_cmd *cmd)
 		
 			cmd->supported = SUPPORTED_FIBRE | SUPPORTED_10000baseT_Full;
 			cmd->advertising = SUPPORTED_FIBRE | SUPPORTED_10000baseT_Full;
-			cmd->speed = SPEED_10000;
+			cmd->speed = speed;
 			cmd->port = PORT_FIBRE;
-			cmd->duplex = DUPLEX_FULL;
+			cmd->duplex = duplex;
 			cmd->phy_address = priv->port;
 			cmd->autoneg = AUTONEG_DISABLE;
 			cmd->maxtxpkt = 0;
@@ -116,16 +120,9 @@ static int xlp_get_settings(struct net_device *dev, struct ethtool_cmd *cmd)
 
 	cmd->advertising = priv->advertising;
 
-	//nlm_hal_status_ext_phy( priv->node, priv->phy.addr, &mii_info);
-	netsoc_get_phy_status(nae_port, (uint32_t *)&cmd->duplex, (uint32_t *)&cmd->speed);
-        //priv->speed = mii_info.speed;
-        //cmd->duplex = mii_info.duplex;
-	cmd->speed = (priv->speed == xlp_mac_speed_1000) ? SPEED_1000 :
-			(priv->speed == xlp_mac_speed_100) ?
-				SPEED_100 : SPEED_10;
-
+	cmd->speed = speed;
+	cmd->duplex = duplex;
 	cmd->port = PORT_TP;
-	//cmd->phy_address = mii_info.phyaddr;
 	cmd->phy_address = priv->phy.addr;
 	cmd->transceiver = XCVR_INTERNAL;
 	cmd->autoneg  = 1; /*Autoneg is always enabled by default*/
@@ -311,7 +308,7 @@ static u32 xlp_get_link(struct net_device *dev)
 	uint32_t duplex, speed;
 	spin_lock_irqsave(&priv->lock, flags);
 
-	netsoc_get_phy_status(nae_port, &duplex, &speed);
+	netsoc_get_phy_status(nae_port, &speed, &duplex);
 
 	spin_unlock_irqrestore(&priv->lock, flags);
 	if(nae_port->link_stat==1)
-- 
1.9.1

