From d5f1b88af706b9f62cdc8cda07716468f315c65c Mon Sep 17 00:00:00 2001
From: Saswat Dash <saswat.dash@broadcom.com>
Date: Tue, 18 Mar 2014 09:59:41 +0530
Subject: [PATCH 1210/1532] halx net: fixed HALX_CMD_OPEN_PORT ioctl case

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/misc/netlogic/halx_netio/halx_netio_main.c | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/drivers/misc/netlogic/halx_netio/halx_netio_main.c b/drivers/misc/netlogic/halx_netio/halx_netio_main.c
index a084557..4aa8f1d 100644
--- a/drivers/misc/netlogic/halx_netio/halx_netio_main.c
+++ b/drivers/misc/netlogic/halx_netio/halx_netio_main.c
@@ -130,14 +130,20 @@ static long halx_netio_ioctl(struct file *filp, unsigned int cmd, unsigned long
 	{
 		uint64_t ret = 0;
 		unsigned long phy_ctx_dom_data = 0;
-		unsigned long *ctx_dom_data = (unsigned long *)kmalloc(sizeof(unsigned long), GFP_KERNEL);
+		halx_port_op_t *u_ctx = NULL;
+		halx_port_op_t *ctx_dom_data = (halx_port_op_t *)kmalloc(sizeof(halx_port_op_t), GFP_KERNEL);
 
 		if (ctx_dom_data == NULL) {
 			printk(KERN_ERR "halx_netio: kmalloc returning NULL in HALX_CMD_OPEN_PORT\n");
 			return -1;
 		}
 
-		retval = copy_from_user(ctx_dom_data, (unsigned long *)argp, sizeof(unsigned long));
+		retval = copy_from_user(&u_ctx, argp, sizeof(&u_ctx));
+		if (retval) {
+			printk(KERN_ERR "%s %d: %d bytes not copied from userspace\n", __func__, __LINE__, retval);
+		}
+
+		retval = copy_from_user(ctx_dom_data, u_ctx, sizeof(halx_port_op_t));
 		if (retval) {
 			printk(KERN_ERR "%s %d: %d bytes not copied from userspace\n", __func__, __LINE__, retval);
 		}
@@ -150,7 +156,7 @@ static long halx_netio_ioctl(struct file *filp, unsigned int cmd, unsigned long
 			printk(KERN_ERR "halx_netio: failure to HALX OPEN PORT\n");
 			rc = -1;
 		} else {
-			retval = copy_to_user((unsigned long *)argp, ctx_dom_data, sizeof(unsigned long));
+			retval = copy_to_user(u_ctx, ctx_dom_data, sizeof(halx_port_op_t));
  			if (retval) {
                                 printk("halx_netio: halif %d bytes not copied to user space\n",retval);
                         }
-- 
1.9.1

