From 8c699def62da809042f42344ab519be2566a1f2b Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Fri, 17 Apr 2015 14:07:42 +0800
Subject: [PATCH] bcm-xlp: fix cpu_hotplug offline issue

__irq_work_run needs to run with IRQs disabled, but IRQs were
enabled by unconditional local_irq_enable() in nlm_cpu_disable()
during CPU_HOTPLUG, this would result in the below error.
On the other hand, nlm_cpu_disable()->fixup_irqs()->irq_cpu_offline()
has already called raw_spin_lock_irqsave/restore(), so remove
local_irq_disable/enable() in nlm_cpu_disable().

processorKernel bug detected[#1]:
CPU: 1 PID: 11 Comm: migration/1 Tainted: G        W    3.10.62-ltsi-WR6.0.0.0_cgl #5
task: c000000360e6ef40 ti: c000000361070000 task.ti: c000000361070000
$ 0   : 0000000000000000 ffffffffc0b9364c 0000000000000001 c00000003ae40fe8
$ 4   : 0000000000000008 0000000000000008 0000000000000001 ffffffffc0ea0000
$ 8   : c000000079db0000 c00000003ae22818 0000000000000020 000000000000037e
$12   : c00000036107fbe0 000000004000f800 0000000000000000 0000000003bd0000
$16   : ffffffffc1090fe8 ffffffffc0f0e3f0 0000000000000000 0000000000000008
$20   : 0000000000000001 0000000000000003 0000000000000001 000000005400f8e1
$24   : 0000000000000000 ffffffffc02fb408
$28   : c000000361070000 c00000036107fb78 c00000036107fb78 ffffffffc0389328
Hi    : 0000000000003ad0
Lo    : 0000000000000154
epc   : ffffffffc038935c __irq_work_run+0x8c/0x150
    Tainted: G        W
ra    : ffffffffc0389328 __irq_work_run+0x58/0x150
Status: 5400f8e3KX SX UX KERNEL EXL IE
Cause : 00800034
PrId  : 000c1005 (Netlogic XLP)
Modules linked in:
Process migration/1 (pid: 11, threadinfo=c000000361070000, task=c000000360e6ef40, tls=0000000000000000)
Stack : ffffffffc0f10000 ffffffffc0f0e3f0 0000000000000000 0000000000000008
  0000000000000001 0000000000000003 c00000036107fbb8 ffffffffc038946c
  0000000000000001 0000000000000001 ffffffffffffffe6 ffffffffffffffe5
  c00000036107fbe8 ffffffffc0b9364c 0000000000000002 c00000036e76fc68
  c00000036e76fc08 0000000000000004 0000000000000002 0000000000000001
  c00000036107fc28 ffffffffc02b6b24 c00000036107fc38 ffffffffc0b7224c
  c00000036e76fb78 0000000000000003 c00000036107fc58 ffffffffc0339264
  c00000036e76fb78 c00000003ae30bc8 c00000003ae30bd0 ffffffffc0f10000
  ffffffffc0cd0808 ffffffffc0cd0778 c00000036e76fc08 ffffffffc03390e8
  c00000036107fca8 ffffffffc033900c ffffffffc02e1110 ffffffffc02f572c
  ...
Call Trace:
[<ffffffffc038935c>] __irq_work_run+0x8c/0x150
[<ffffffffc038946c>] irq_work_cpu_notify+0x4c/0x90

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/common/smp.c |    2 --
 1 files changed, 0 insertions(+), 2 deletions(-)

diff --git a/arch/mips/netlogic/common/smp.c b/arch/mips/netlogic/common/smp.c
index e890fc2..dae1be0 100644
--- a/arch/mips/netlogic/common/smp.c
+++ b/arch/mips/netlogic/common/smp.c
@@ -179,9 +179,7 @@ static int nlm_cpu_disable(void)
 	set_cpu_online(cpu, false);
 	cpu_clear(cpu, cpu_callin_map);
 
-	local_irq_disable();
 	fixup_irqs(cpu, 0);
-	local_irq_enable();
 
 	flush_cache_all();
 	local_flush_tlb_all();
-- 
1.7.5.4

