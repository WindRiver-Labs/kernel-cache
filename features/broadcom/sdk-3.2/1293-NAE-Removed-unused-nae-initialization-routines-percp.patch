From e05e0df1589962056b7935fe57df5e3683f9e4b7 Mon Sep 17 00:00:00 2001
From: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Date: Sun, 5 Sep 2010 01:19:38 -0700
Subject: [PATCH 1293/1532] NAE: Removed unused nae initialization routines,
 percpu stats are now for NR_CPUS

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/broadcom/nae/init_nae.c     | 135 +----------------------
 drivers/net/ethernet/broadcom/nae/ucore_loader.c |   1 +
 drivers/net/ethernet/broadcom/nae/xlp_hw.c       |   1 -
 drivers/net/ethernet/broadcom/nae/xlp_nae.c      |  18 +--
 drivers/net/ethernet/broadcom/nae/xlp_nae.h      |   3 +-
 5 files changed, 13 insertions(+), 145 deletions(-)

diff --git a/drivers/net/ethernet/broadcom/nae/init_nae.c b/drivers/net/ethernet/broadcom/nae/init_nae.c
index e20cb85..12484dd 100644
--- a/drivers/net/ethernet/broadcom/nae/init_nae.c
+++ b/drivers/net/ethernet/broadcom/nae/init_nae.c
@@ -1,85 +1,9 @@
 #include <linux/types.h>
 #include <linux/kernel.h>
 #include <asm/netlogic/hal/nlm_hal_nae.h>
-#include "reg.h"
 #include "net_common.h"
 
-#define XLP_NAE_UCODE_IO_OFFSET		0x90000000d0010000ULL
-#define CODESIZE_PER_UCORE 		(4<<10)
-#define NAE_MAX_MESSAGE_SIZE(x)		((x&0x1)<<1)
-#define RESET_MAX_MESSAGE_SIZE		~(0x1<<1)
-#define NAE_FRINDESCCLSIZE(x)		((x&0xff)<< 4)
-#define RESET_FRINDESCCLSIZE		~((0xff)<< 4)
-#define NAE_RX_STATUS_MASK(x)		((x&0x3f) << 24)
-#define RESET_RX_STATUS_MASK		~((0x3f) << 24)
 #define VAL_UCORE_RESET(x)		((x&0xffff)<<8)
-#define read_gmac_reg(idx, reg) 	nlm_hal_read_mac_reg(((idx&0xff)>>2), (idx& 0x3), reg)
-#define write_gmac_reg(idx, reg, val) 	nlm_hal_write_mac_reg(((idx&0xff)>>2), (idx& 0x3), reg, val)
-
-
-/*
- * reset netior softreset
- * GMAC reset
- * RX interface Credit
- */
-int init_gmac(unsigned int inf)
-{
-	unsigned int mac_cfg1 = 0 ;
-	unsigned int  mac_cfg2 = 0 ;
-	unsigned int netwk_inf  = 0;
-
-	mac_cfg1 = read_gmac_reg(inf  , INF_MAC_CONFIG1);
-	mac_cfg2 = read_gmac_reg(inf, INF_MAC_CONFIG2);
-	netwk_inf  = read_gmac_reg(inf, INF_NETWK_INF_CTRL_REG);
-
-	nlm_hal_write_nae_iface_reg(0xf, NETIOR_SOFTRESET, 0);
-
-	/* Sofreset set bit 11 to 0 */
-	write_gmac_reg(inf , INF_NETWK_INF_CTRL_REG,  netwk_inf & 0xfffff7ff);
-
-
-	/* RX interface  NETIOR interface credit counter */
-	nlm_hal_write_nae_iface_reg(0xf, NETIOR_MISC_REG2_ADDR , 0x0421084 );
-	nlm_hal_write_nae_iface_reg(0xf, NETIOR_MISC_REG1_ADDR , 0x00fffff );
-	nlm_hal_write_nae_iface_reg(0xf, NETIOR_MISC_REG1_ADDR , 0x0);
-
-	/* set softreset */
-	write_gmac_reg(inf, INF_MAC_CONFIG1, INF_SOFTRESET(1)|
-                                             INF_RX_ENABLE(1)|
-                                             INF_TX_ENABLE(1));
-
-	mac_cfg1 = read_gmac_reg(inf, INF_MAC_CONFIG1);
-	write_gmac_reg(inf, INF_MAC_CONFIG2, mac_cfg2|
-                            INF_PREMBL_LEN(0x7)|
-                            INF_IFMODE(0x2)|
-                            INF_FULLDUP(1));
-
-	/* reset softreset */
-	write_gmac_reg(inf , INF_MAC_CONFIG1, mac_cfg1 & ~(INF_SOFTRESET(1)));
-	netwk_inf = read_gmac_reg(inf, INF_NETWK_INF_CTRL_REG);
-	write_gmac_reg(inf, INF_NETWK_INF_CTRL_REG, netwk_inf | STATS_EN(1) | TX_EN(1) | SPEED(0));
-
-	return 0;
-}
-
-/*
- *	EGRESS -> IOR credit configuration
- *
- *
- */
-int init_tx_if_credit( uint32_t credit_val, uint32_t if_bmask)
-{
-	int tx_config;
-
-	tx_config = 0;
-	nlm_hal_write_nae_reg(TX_IORCRDT_INIT, credit_val);
-	tx_config = nlm_hal_read_nae_reg(TX_CONFIG);
-	nlm_hal_write_nae_reg(TX_CONFIG, tx_config | (TXINITIORCR(0x7ffff & if_bmask)));
-	nlm_hal_write_nae_reg(TX_CONFIG, tx_config & ~(TXINITIORCR(0x7ffff & if_bmask)));
-	return 0;
-}
-
-
 /*
  * uCore code
  * configure Interface to ucore
@@ -93,67 +17,10 @@ int init_ucore(uint32_t ucore_mask, int if_num)
 
 	ucore_cfg = 0;
 	nlm_hal_write_nae_reg(UCORE_IFACE_MASK_CFG,
-        ucore_spray_config(if_num, ucore_mask, CMD_WRITE));
+			      ucore_spray_config(if_num, ucore_mask, CMD_WRITE));
 	ucore_cfg = nlm_hal_read_nae_reg(RX_UCORE_CFG);
 	nlm_hal_write_nae_reg(RX_UCORE_CFG, ucore_cfg & (~VAL_UCORE_RESET(ucore_mask)));
 
 	return 0;
 }
 
-/* Egress Config
- *      Configure Qvc to interface mapping
- *      524 queue (476 - 999)
- *      VFBID to Destination Station ID
- *      Credit Configuration between stages
- *      Credit Configuration between interface N Egress bock
- *      Context(NAE parlance ,means Queue in FMN)Memory
- *      Setup to carve the Entry to Queue .
- *      (Note Stage 1 configuration is obsolete .)
- *      Trasmit Drr (reg 0x44 to 0x4d are  scheduler configuration)
- *
- *       Defaults:
- *              Queue: 0 to 17 queue map to corresponding interface
- *              VFBID: Dest Station ID = VFBID
- *              Context memory setup : NOT CLEAR NO NUMBERS available
- *              Scheduler : round robin
- */
-
-/*
- *                      40 - 23b|15 - 13| 12 - 9|
- *                      bar addr|block |interface
- */
-void init_ingress(void)
-{
-	unsigned int rx_cfg;
-
-	rx_cfg = nlm_hal_read_nae_reg(RX_CONFIG);
-
-	nlm_hal_write_nae_reg(RX_CONFIG, (rx_cfg &
-                                          RESET_MAX_MESSAGE_SIZE &
-                                          RESET_FRINDESCCLSIZE &
-                                          RESET_RX_STATUS_MASK) |
-                                          NAE_RX_ENABLE 	|
-                                          NAE_MAX_MESSAGE_SIZE(0x3)|
-                                          NAE_RX_STATUS_MASK(0x3f)|
-                                          NAE_FRINDESCCLSIZE(26));
-}
-
-/* Ingress Config
- *      20 queue (1000 - 1019)
- *      RxConfig : set the Free in desc default
- *      Interface to context mapping
- *      set valid active interface
- *      calendar slots
- *      parser configuration
- *      Parser se
- *
- *
- */
-void init_egress(void)
-{
-	uint32_t tx_cfg;
-
-	tx_cfg =  nlm_hal_read_nae_reg(TX_CONFIG);
-	nlm_hal_write_nae_reg( TX_CONFIG, tx_cfg|NAE_TX_ENABLE);
-
-}
diff --git a/drivers/net/ethernet/broadcom/nae/ucore_loader.c b/drivers/net/ethernet/broadcom/nae/ucore_loader.c
index ade9b73..3cc2e3e 100644
--- a/drivers/net/ethernet/broadcom/nae/ucore_loader.c
+++ b/drivers/net/ethernet/broadcom/nae/ucore_loader.c
@@ -1,6 +1,7 @@
 #include <linux/types.h>
 #include <linux/mm.h>
 #include <asm/netlogic/hal/nlm_hal_nae.h>
+
 #include "ucore_loader.h"
 #include "ucore_apps.c"
 
diff --git a/drivers/net/ethernet/broadcom/nae/xlp_hw.c b/drivers/net/ethernet/broadcom/nae/xlp_hw.c
index c5f51fa..fc0c681 100755
--- a/drivers/net/ethernet/broadcom/nae/xlp_hw.c
+++ b/drivers/net/ethernet/broadcom/nae/xlp_hw.c
@@ -440,7 +440,6 @@ static void nlm_xlp_mac_mii_write(struct dev_data *priv, int phyaddr, int regidx
 	return;
 }
 
-
 static struct ethtool_ops xlp_ethtool_ops= {
         .get_settings           = xlp_get_settings,
         .set_settings           = xlp_set_settings,
diff --git a/drivers/net/ethernet/broadcom/nae/xlp_nae.c b/drivers/net/ethernet/broadcom/nae/xlp_nae.c
index 744c6b2a..ad9794e 100755
--- a/drivers/net/ethernet/broadcom/nae/xlp_nae.c
+++ b/drivers/net/ethernet/broadcom/nae/xlp_nae.c
@@ -277,6 +277,7 @@ static inline void nlm_xlp_free_skb(struct xlp_msg *msg)
 	struct dev_data *priv;
 	int cpu = hard_smp_processor_id();
 	unsigned long tmp;
+
 	tmp = (unsigned long)(msg->entry[0] & 0xffffffffffULL);
 	skb = (struct sk_buff *)bus_to_virt(tmp);
 
@@ -634,7 +635,7 @@ static int  nlm_xlp_nae_open (struct net_device *dev)
 	priv->stats.multicast	= 0;
 	priv->stats.collisions	= 0;
 
-	for(i = 0; i < 8; i++)
+	for(i = 0; i < NR_CPUS; i++)
 	{
 		priv->cpu_stats[i].tx_packets	= 0;
 		priv->cpu_stats[i].txc_packets	= 0;
@@ -678,7 +679,7 @@ static int nlm_xlp_nae_start_xmit(struct sk_buff *skb, struct net_device *dev)
 {
 	struct dev_data *priv = netdev_priv(dev);
 	unsigned long mflags = 0;
-	int cpu = 0, ret = 0;
+	int cpu = hard_smp_processor_id(), ret = 0;
 	struct xlp_msg msg =  { {0, 0, 0, 0} };
 
 	if(!skb)
@@ -1025,21 +1026,22 @@ static int xlp_mac_proc_read(char *page, char **start, off_t off,
 	struct dev_data *priv = 0;
 
 
-	for(i=0; i< MAX_GMAC_PORT; i++) {
+	for (i = 0; i < MAX_GMAC_PORT; i++) {
+
 		dev = dev_mac[i];
-		if(dev == 0)
-			continue;
+
+		if(dev == 0) continue;
 
 		priv = netdev_priv(dev);
 
 		len += sprintf(page + len,
-			       "per port:  %d %lx %lx %lx %lx\n",
+			       "per port-%d: %lu %lu %lu %lu\n",
 			       i,
 			       priv->stats.rx_packets, priv->stats.rx_bytes,
 			       priv->stats.tx_packets, priv->stats.tx_bytes);
 	}
-	for(cpu=0;cpu<8;cpu++) {
-		len += sprintf(page + len, "per cpu:  %d %lx %lx %lx %lx\n",
+	for (cpu = 0; cpu < NR_CPUS ; cpu++) {
+		len += sprintf(page + len, "per cpu-%d: %lu %lu %lu %lu\n",
 			       cpu,
 			       priv->cpu_stats[cpu].tx_packets,
 			       priv->cpu_stats[cpu].txc_packets,
diff --git a/drivers/net/ethernet/broadcom/nae/xlp_nae.h b/drivers/net/ethernet/broadcom/nae/xlp_nae.h
index 8c4528e..8af7295 100644
--- a/drivers/net/ethernet/broadcom/nae/xlp_nae.h
+++ b/drivers/net/ethernet/broadcom/nae/xlp_nae.h
@@ -1,7 +1,6 @@
 #ifndef _XLP_NAE_H
 #define _XLP_NAE_H
 
-#define MAX_CPUS		8
 #define MAC_MAX_FRAME_SIZE      1600
 #define MAC_SKB_BACK_PTR_SIZE   SMP_CACHE_BYTES
 
@@ -54,7 +53,7 @@ struct dev_data
 {
         struct net_device *dev;
         struct net_device_stats stats;
-        struct cpu_stat cpu_stats[MAX_CPUS];
+        struct cpu_stat cpu_stats[NR_CPUS];
         struct timer_list link_timer;
         struct napi_struct napi;
         spinlock_t lock;
-- 
1.9.1

