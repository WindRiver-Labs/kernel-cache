From 213ab8d160a0f182ba0fc280e3a30515502b8219 Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Wed, 29 Apr 2015 15:07:56 +0800
Subject: [PATCH 2/2] bcm-xlp: adjust hyperexec kmod Makefile and Kconfig

Adjust hyperexec kernel module's Makefile and Kconfig for
two reasons. One is because original dependency in Kconfig
and Makefile is not correct and the description is not
identical to SDK's. The other is now we do not support
hyperexec kernel module unless the nae which is network
module, so we make other modules not to built into kernel.

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/crypto/Kconfig                       |    2 +-
 drivers/misc/netlogic/Kconfig                |   53 ++++++++++++++++++-------
 drivers/misc/netlogic/Makefile               |   14 +++---
 drivers/misc/netlogic/fdtconf/Makefile       |    2 +-
 drivers/misc/netlogic/netl7driver/Makefile   |    2 +-
 drivers/misc/netlogic/nlmcrypto/Makefile     |    3 +-
 drivers/misc/netlogic/soc_interface/Makefile |    2 +-
 drivers/net/ethernet/broadcom/Kconfig        |    2 +-
 8 files changed, 52 insertions(+), 28 deletions(-)

diff --git a/drivers/crypto/Kconfig b/drivers/crypto/Kconfig
index 43d21c9..a1e4c5a 100644
--- a/drivers/crypto/Kconfig
+++ b/drivers/crypto/Kconfig
@@ -388,7 +388,7 @@ config CRYPTO_DEV_ATMEL_SHA
 
 config CRYPTO_DEV_XLP_SAE
         tristate "Broadcom xlp SAE driver"
-        depends on NLM_XLP_BOARD
+        depends on NLM_XLP_BOARD && XLP_SOC_INTERFACE && XLP_FDT && NLM_RCPL
         select CRYPTO_AEAD
         select CRYPTO_BLKCIPHER
         select CRYPTO_HASH
diff --git a/drivers/misc/netlogic/Kconfig b/drivers/misc/netlogic/Kconfig
index aa3913b..739e113 100644
--- a/drivers/misc/netlogic/Kconfig
+++ b/drivers/misc/netlogic/Kconfig
@@ -3,11 +3,29 @@
 #
 menu "Netlogic specific driver"
 
-config XLP_CDE
-	tristate "broadcom xlp CDE driver"
+config XLP_FDT
+	tristate "XLP FDT Configuration Module"
 	depends on NLM_XLP_BOARD
 	default y
 	help
+	  <http://support.broadcom.com>
+
+	  To compile this driver as a module, choose M here.
+
+config XLP_SOC_INTERFACE
+	tristate "XLP SoC Interface Module"
+	depends on NLM_XLP_BOARD && XLP_FDT
+	default y
+	help
+	  <http://support.broadcom.com>
+
+	  To compile this driver as a module, choose M here.
+
+config XLP_CDE
+	tristate "XLP CDE Module"
+	depends on NLM_XLP_BOARD && XLP_SOC_INTERFACE && XLP_FDT && NLM_RCPL
+	default y
+	help
 	  This driver supports broadcom's compression/decompression Engine.
 	  For more information on xlp CDE driver, please visit
 
@@ -16,8 +34,8 @@ config XLP_CDE
 	  To compile this driver as a module, choose M here.
 
 config XLP_NETL7
-	tristate "Broadcom xlp netl7 driver"
-	depends on NLM_XLP_BOARD
+	tristate "XLP Netl7 Module"
+	depends on NLM_XLP_BOARD && NLM_RCPL
 	default m
 	help
 	  This driver supports Broadcom regex driver.
@@ -30,29 +48,29 @@ config XLP_NETL7
 	  To compile this driver as a module, choose M here.
 
 config XLP_CMEM
-	tristate "XLP cmem driver"
-	depends on NLM_XLP_BOARD
+	tristate "XLP CMEM Module"
+	depends on NLM_XLP_BOARD && NLM_RCPL
 	default y
 	help
 	  This driver supports cmem.
 
 config XLP_FMN_DP
-	tristate "XLP FMN Data Path Driver"
-	depends on NLM_XLP_BOARD
+	tristate "XLP FMN DP Module"
+	depends on NLM_XLP_BOARD && NLM_RCPL
 	default y
 	help
 	  This driver supports fmn data path.
 
 config XLP_PPM
-	tristate "Broadcom Packet Pool Manager"
-	depends on NLM_XLP_BOARD
+	tristate "XLP Packet Memory Module"
+	depends on NLM_XLP_BOARD && NLM_RCPL
 	default m
 	help
 	  This driver supports Manage Packet Pool.
 
 config XLP_NMIPROF
-	tristate "XLP NMIProf support"
-	depends on NLM_XLP_BOARD
+	tristate "XLP NMIPROF Module"
+	depends on NLM_XLP_BOARD && NLM_RCPL
 	default m
 	help
 	  NMIProf is a simple and accurate profiler for XLP cpus.
@@ -60,9 +78,14 @@ config XLP_NMIPROF
 	  NMIProf uses NMI interrupts generated by the XLP PIC to get accurate profiling
 	  information of a CPU.
 
-config NLM_XLP_CRYPTO
-	tristate "NLM XLP Crypto"
-	depends on NLM_XLP_BOARD
+config XLP_CRYPTO
+	tristate "XLP NLMCrypto Module"
+	depends on NLM_XLP_BOARD && NLM_RCPL
+	default n
+
+config NLM_ADMA
+	tristate "XLP Dtre Module"
+	depends on NLM_XLP_BOARD && XLP_SOC_INTERFACE && XLP_FDT && NLM_RCPL
 	default n
 
 endmenu
diff --git a/drivers/misc/netlogic/Makefile b/drivers/misc/netlogic/Makefile
index f1dcb15..234bf01 100644
--- a/drivers/misc/netlogic/Makefile
+++ b/drivers/misc/netlogic/Makefile
@@ -1,10 +1,10 @@
-obj-$(CONFIG_NLM_XLP_BOARD)	+= fdtconf/
-obj-$(CONFIG_NLM_XLP_BOARD)	+= soc_interface/
-obj-$(CONFIG_NLM_XLP_BOARD)	+= nlmcrypto/
-obj-$(CONFIG_NLM_XLP_BOARD)	+= nmiprof/
-obj-$(CONFIG_NLM_XLP_BOARD)	+= pkt_pool_mem/
-obj-$(CONFIG_NLM_XLP_BOARD)	+= fmn_dp/
-obj-$(CONFIG_NLM_XLP_BOARD)	+= cmem/
+obj-$(CONFIG_XLP_FDT)		+= fdtconf/
+obj-$(CONFIG_XLP_SOC_INTERFACE)	+= soc_interface/
+obj-$(CONFIG_XLP_CRYPTO)	+= nlmcrypto/
+obj-$(CONFIG_XLP_NMIPROF)	+= nmiprof/
+obj-$(CONFIG_XLP_PPM)		+= pkt_pool_mem/
+obj-$(CONFIG_XLP_FMN_DP)	+= fmn_dp/
+obj-$(CONFIG_XLP_CMEM)		+= cmem/
 obj-$(CONFIG_XLP_CDE)		+= nlm_cde/
 obj-$(CONFIG_XLP_NETL7)		+= netl7driver/
 obj-$(CONFIG_NLM_ADMA)		+= dtre/
diff --git a/drivers/misc/netlogic/fdtconf/Makefile b/drivers/misc/netlogic/fdtconf/Makefile
index 3ae79db..7f356633 100644
--- a/drivers/misc/netlogic/fdtconf/Makefile
+++ b/drivers/misc/netlogic/fdtconf/Makefile
@@ -3,5 +3,5 @@ ccflags-y += -Iarch/mips/netlogic/lib/syslib/include
 ccflags-y += -Iarch/mips/netlogic/lib/fmnlib
 ccflags-y += -Iarch/mips/netlogic/lib/fdt/libfdt
 
-obj-$(CONFIG_NLM_XLP_BOARD) += fdt_conf.o
+obj-$(CONFIG_XLP_FDT) += fdt_conf.o
 fdt_conf-objs += fdtconf.o
diff --git a/drivers/misc/netlogic/netl7driver/Makefile b/drivers/misc/netlogic/netl7driver/Makefile
index dcd8ca5..25f6e67 100644
--- a/drivers/misc/netlogic/netl7driver/Makefile
+++ b/drivers/misc/netlogic/netl7driver/Makefile
@@ -4,5 +4,5 @@ ccflags-y += -Iarch/mips/netlogic/lib/fdt/libfdt
 ccflags-y += -Iarch/mips/netlogic/lib/fdt/libfdt/contrib
 ccflags-y += -Iarch/mips/netlogic/lib/syslib/include
 
-obj-$(CONFIG_NLM_XLP_BOARD) 	+= netl7driver.o
+obj-$(CONFIG_XLP_NETL7) 	+= netl7driver.o
 nae-objs 	:= xlp_nae.o init_nae.o xlp_hw.o
diff --git a/drivers/misc/netlogic/nlmcrypto/Makefile b/drivers/misc/netlogic/nlmcrypto/Makefile
index a7194de..fb15bd0 100644
--- a/drivers/misc/netlogic/nlmcrypto/Makefile
+++ b/drivers/misc/netlogic/nlmcrypto/Makefile
@@ -6,6 +6,7 @@ ccflags-y += -Iarch/mips/netlogic/lib/fmnlib
 ccflags-y += -Iarch/mips/netlogic/lib/syslib/include
 ccflags-y += -Iarch/mips/netlogic/lib/seclib
 ccflags-y += -Idrivers/netlogic/nlmcrypto
+ccflags-y += -Idrivers/crypto/sae/
 
-obj-$(CONFIG_NLM_XLP_BOARD) 	+= nlmcrypto.o
+obj-$(CONFIG_XLP_CRYPTO) 	+= nlmcrypto.o
 nlmcrypto-objs 	:= cryptodrv.o init.o
diff --git a/drivers/misc/netlogic/soc_interface/Makefile b/drivers/misc/netlogic/soc_interface/Makefile
index 317088a..95f19c8 100644
--- a/drivers/misc/netlogic/soc_interface/Makefile
+++ b/drivers/misc/netlogic/soc_interface/Makefile
@@ -3,5 +3,5 @@ ccflags-y += -Iarch/mips/netlogic/lib/syslib/include
 ccflags-y += -Iarch/mips/netlogic/lib/fmnlib
 ccflags-y += -Iarch/mips/netlogic/lib/fdt/libfdt
 
-obj-$(CONFIG_NLM_XLP_BOARD) += soc_interface.o
+obj-$(CONFIG_XLP_SOC_INTERFACE) += soc_interface.o
 soc_interface-objs += on_chip.o cpu_proc.o libfdt-wrapper.o
diff --git a/drivers/net/ethernet/broadcom/Kconfig b/drivers/net/ethernet/broadcom/Kconfig
index 910a922..9bf5e18 100644
--- a/drivers/net/ethernet/broadcom/Kconfig
+++ b/drivers/net/ethernet/broadcom/Kconfig
@@ -18,7 +18,7 @@ config NET_VENDOR_BROADCOM
 
 config XLP_NAE_SUPPORT
 	tristate "Enable Netlogic XLP NAE support"
-	depends on NLM_XLP_BOARD
+	depends on NLM_XLP_BOARD && XLP_SOC_INTERFACE
 	default y
 	help
 	 This option enables XLP Network Acceleration engine support.
-- 
1.7.5.4

