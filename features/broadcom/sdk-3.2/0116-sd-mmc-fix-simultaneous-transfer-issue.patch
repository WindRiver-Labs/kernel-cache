From 1a1675804c06a46d676357b8bae6a5f10c3b131c Mon Sep 17 00:00:00 2001
From: Kamlakant Patel <kamlakant.patel@broadcom.com>
Date: Sun, 19 Oct 2014 18:05:10 +0530
Subject: [PATCH 0116/1532] sd/mmc: fix simultaneous transfer issue

Signed-off-by: Kamlakant Patel <kamlakant.patel@broadcom.com>
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/mmc/host/sdhci.c | 25 ++++++++++++++++++++++++-
 1 file changed, 24 insertions(+), 1 deletion(-)

diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.c
index 6ea7d41..259dece 100644
--- a/drivers/mmc/host/sdhci.c
+++ b/drivers/mmc/host/sdhci.c
@@ -188,8 +188,13 @@ static void sdhci_reset(struct sdhci_host *host, u8 mask)
 
 	if (host->quirks & SDHCI_QUIRK_NO_CARD_NO_RESET) {
 		if (!(sdhci_readl(host, SDHCI_PRESENT_STATE) &
-			SDHCI_CARD_PRESENT))
+			SDHCI_CARD_PRESENT)) {
+#ifdef CONFIG_CPU_XLP
+			sdhci_writeb(host, mask, SDHCI_SOFTWARE_RESET);
+			udelay(100);
+#endif
 			return;
+		}
 	}
 
 	if (host->quirks & SDHCI_QUIRK_RESTORE_IRQS_AFTER_RESET)
@@ -1322,6 +1327,16 @@ static int sdhci_set_power(struct sdhci_host *host, unsigned short power)
  *                                                                           *
 \*****************************************************************************/
 
+/**
+ * On Netlogic XLP platform, while doing transfers on both the slots
+ * simultaneously, hardware generates CRC error. This is a software workaround
+ * to avoid the CRC error.
+ */
+
+#ifdef CONFIG_CPU_XLP
+static DEFINE_MUTEX(sdhci_cmd_inprogress);
+#endif
+
 static void sdhci_request(struct mmc_host *mmc, struct mmc_request *mrq)
 {
 	struct sdhci_host *host;
@@ -1329,6 +1344,10 @@ static void sdhci_request(struct mmc_host *mmc, struct mmc_request *mrq)
 	unsigned long flags;
 	u32 tuning_opcode;
 
+#ifdef CONFIG_CPU_XLP
+	mutex_lock(&sdhci_cmd_inprogress);
+#endif
+
 	host = mmc_priv(mmc);
 
 	sdhci_runtime_pm_get(host);
@@ -2168,6 +2187,10 @@ static void sdhci_tasklet_finish(unsigned long param)
 	mmiowb();
 	spin_unlock_irqrestore(&host->lock, flags);
 
+#ifdef CONFIG_CPU_XLP
+	mutex_unlock(&sdhci_cmd_inprogress);
+#endif
+
 	mmc_request_done(host->mmc, mrq);
 	sdhci_runtime_pm_put(host);
 }
-- 
1.9.1

