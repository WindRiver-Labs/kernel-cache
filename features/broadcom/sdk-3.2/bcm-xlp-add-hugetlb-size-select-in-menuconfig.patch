From 81cf2a218f2ce95473cf54c2aee9d1c49b4cc713 Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Wed, 28 Jan 2015 10:59:07 +0800
Subject: [PATCH 03/14] bcm-xlp: add hugetlb size select in menuconfig

In SDK 3.2, the hugetlb page size is bind to page size.In kernel there
are 3 type page sizes (4K, 16K, 64K), so expand 3 types to 7 types.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/include/asm/mipsregs.h |   24 +++++++++++++++++++++
 arch/mips/include/asm/page.h     |   21 ++++++++++++++++++
 arch/mips/netlogic/Kconfig       |   43 ++++++++++++++++++++++++++++++++++++++
 3 files changed, 88 insertions(+), 0 deletions(-)

diff --git a/arch/mips/include/asm/mipsregs.h b/arch/mips/include/asm/mipsregs.h
index 3d0074e..964ab75 100644
--- a/arch/mips/include/asm/mipsregs.h
+++ b/arch/mips/include/asm/mipsregs.h
@@ -231,6 +231,29 @@
 /*
  * Default huge tlb size for a given kernel configuration
  */
+
+#ifdef CONFIG_NLM_XLP_BOARD
+
+#ifdef CONFIG_HUGE_PAGE_SIZE_128K
+#define PM_HUGE_MASK   PM_64K
+#elif defined(CONFIG_HUGE_PAGE_SIZE_512K)
+#define PM_HUGE_MASK   PM_256K
+#elif defined(CONFIG_HUGE_PAGE_SIZE_2M)
+#define PM_HUGE_MASK   PM_1M
+#elif defined(CONFIG_HUGE_PAGE_SIZE_8M)
+#define PM_HUGE_MASK   PM_4M
+#elif defined(CONFIG_HUGE_PAGE_SIZE_32M)
+#define PM_HUGE_MASK   PM_16M
+#elif defined(CONFIG_HUGE_PAGE_SIZE_128M)
+#define PM_HUGE_MASK   PM_64M
+#elif defined(CONFIG_HUGE_PAGE_SIZE_512M)
+#define PM_HUGE_MASK   PM_256M
+#else
+#error Bad page size configuration for hugetlbfs!
+#endif
+
+#else
+
 #ifdef CONFIG_PAGE_SIZE_4KB
 #define PM_HUGE_MASK	PM_1M
 #elif defined(CONFIG_PAGE_SIZE_8KB)
@@ -245,6 +268,7 @@
 #error Bad page size configuration for hugetlbfs!
 #endif
 
+#endif
 /*
  * Values used for computation of new tlb entries
  */
diff --git a/arch/mips/include/asm/page.h b/arch/mips/include/asm/page.h
index f59552f..869729f 100644
--- a/arch/mips/include/asm/page.h
+++ b/arch/mips/include/asm/page.h
@@ -34,7 +34,28 @@
 #define PAGE_MASK	(~((1 << PAGE_SHIFT) - 1))
 
 #ifdef CONFIG_MIPS_HUGE_TLB_SUPPORT
+
+#ifdef CONFIG_NLM_XLP_BOARD
+#ifdef CONFIG_HUGE_PAGE_SIZE_128K
+#define HPAGE_SHIFT     (PL_64K + 1)
+#elif defined(CONFIG_HUGE_PAGE_SIZE_512K)
+#define HPAGE_SHIFT     (PL_256K + 1)
+#elif defined(CONFIG_HUGE_PAGE_SIZE_2M)
+#define HPAGE_SHIFT     (PL_1M + 1)
+#elif defined(CONFIG_HUGE_PAGE_SIZE_8M)
+#define HPAGE_SHIFT     (PL_4M + 1)
+#elif defined(CONFIG_HUGE_PAGE_SIZE_32M)
+#define HPAGE_SHIFT     (PL_16M + 1)
+#elif defined(CONFIG_HUGE_PAGE_SIZE_128M)
+#define HPAGE_SHIFT     (PL_64M + 1)
+#elif defined(CONFIG_HUGE_PAGE_SIZE_512M)
+#define HPAGE_SHIFT     (PL_256M + 1)
+#else
+#error no proper huge page size defined!
+#endif
+#else
 #define HPAGE_SHIFT	(PAGE_SHIFT + PAGE_SHIFT - 3)
+#endif
 #define HPAGE_SIZE	(_AC(1,UL) << HPAGE_SHIFT)
 #define HPAGE_MASK	(~(HPAGE_SIZE - 1))
 #define HUGETLB_PAGE_ORDER	(HPAGE_SHIFT - PAGE_SHIFT)
diff --git a/arch/mips/netlogic/Kconfig b/arch/mips/netlogic/Kconfig
index e0f73d8..34288ad 100644
--- a/arch/mips/netlogic/Kconfig
+++ b/arch/mips/netlogic/Kconfig
@@ -95,6 +95,49 @@ config NLM_ENABLE_COP2
 	  This option enables cop2 access for both user and kernel space.
 endif
 
+if NLM_XLP_BOARD
+choice
+	prompt "XLP Board Huge page size"
+	default HUGE_PAGE_SIZE_8M
+
+	config HUGE_PAGE_SIZE_128K
+	bool "128KB"
+	help
+	  Using 128KB as the hugetlb page size
+
+	config HUGE_PAGE_SIZE_512K
+	bool "512KB"
+	help
+	  Using 512KB as the hugetlb page size
+
+	config HUGE_PAGE_SIZE_2M
+	bool "2MB"
+	help
+	  Using 2MB as the hugetlb page size
+
+	config HUGE_PAGE_SIZE_8M
+	bool "8MB"
+	help
+	  Using 8MB as the hugetlb page size
+
+	config HUGE_PAGE_SIZE_32M
+	bool "32MB"
+	help
+	  Using 32MB as the hugetlb page size
+
+	config HUGE_PAGE_SIZE_128M
+	bool "128MB"
+	help
+	  Using 128MB as the hugetlb page size
+
+	config HUGE_PAGE_SIZE_512M
+	bool "512MB"
+	help
+	  Using 512MB as the hugetlb page size
+
+endchoice
+endif
+
 config IOMMU_HELPER
 	bool
 
-- 
1.7.5.4

