From 0f991a1a1b6de764b9c96599f4726573d6d4c082 Mon Sep 17 00:00:00 2001
From: Kevin Joseph James <kevin.james@broadcom.com>
Date: Thu, 4 Sep 2014 02:14:36 -0700
Subject: [PATCH 1050/1532] poe: populate rxclass in enqueue mode for NETSOC
 VER 1

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/netlib/src/netsoc_v1_msg.c | 23 ++++++++++++++++-------
 1 file changed, 16 insertions(+), 7 deletions(-)

diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_v1_msg.c b/arch/mips/netlogic/lib/netlib/src/netsoc_v1_msg.c
index 0c5d85b..afe657e 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_v1_msg.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_v1_msg.c
@@ -207,8 +207,9 @@ int netsoc_v1_enq_pkt_recv(uint32_t rxvc, uint64_t *addr, uint32_t *len, pkt_rec
         uint64_t msg0, msg1, msg2;
 	uint32_t size,code,src_id, node, id;
 	int rx_status;
+	net_port_t *local_port;
 
-        if(fmn_msg_recv_3(rxvc,
+	if(fmn_msg_recv_3(rxvc,
                               &src_id,
                               &size,
                               &code,
@@ -243,17 +244,25 @@ int netsoc_v1_enq_pkt_recv(uint32_t rxvc, uint64_t *addr, uint32_t *len, pkt_rec
 			*addr = netv1_rx_addr(msg2);
 			*len = netv1_rx_len(msg2);
 			netv1_nae_decode_rxpktinfo(msg2, &pkt_info->nae.rx);
-			netv1_poe_decode_msg(msg0, msg1, rcvd_enq_info);
-#ifdef NETSOC_MSG_DEBUG
-			fmndbg("RXNAE:type %d cntxt %d len %d addr 0x%llx err %d frinq %d\n",pkt_info->nae.rx.type,
-					pkt_info->nae.rx.context,*len,*addr,pkt_info->nae.rx.error, pkt_info->nae.rx.frin_qnum);
-                        fmndbg("RXPOE:fid16 0x%x fid32 0x%x\n",rcvd_enq_info->fid16, rcvd_enq_info->fid32);
-#endif
 		}
+
 		node = NETV1_GET_NODE(src_id);
 		id = NETV1_GET_BLOCK_ID(src_id);
 		pkt_info->port = *(cntx2netport[node][id] + pkt_info->nae.rx.context);
 		
+		if (size != 1) {
+
+			local_port = (net_port_t *)pkt_info->port;
+			netv1_poe_decode_msg(msg0, msg1, rcvd_enq_info);
+			rcvd_enq_info->rxclass = (uint32_t)(src_id - local_port->poe_queue_base);
+#ifdef NETSOC_MSG_DEBUG
+                        fmndbg("RXNAE:type %d cntxt %d len %d addr 0x%llx err %d frinq %d\n",pkt_info->nae.rx.type,
+                                        pkt_info->nae.rx.context,*len,*addr,pkt_info->nae.rx.error, pkt_info->nae.rx.frin_qnum);
+                        fmndbg("RXPOE:fid16 0x%x fid32 0x%x rx-class %d srcid %d poe_base %d\n",rcvd_enq_info->fid16,
+					rcvd_enq_info->fid32, rcvd_enq_info->rxclass, src_id, local_port->poe_queue_base);
+#endif
+
+		}
                 return 0;
 }
 
-- 
1.9.1

