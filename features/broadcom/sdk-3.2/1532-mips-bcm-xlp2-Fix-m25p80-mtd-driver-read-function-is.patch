From 8030aa9c0fce1aa88bb368d8277d5e1955a36965 Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Sun, 15 Feb 2015 13:03:43 +0800
Subject: [PATCH 1532/1532] mips: bcm-xlp2: Fix m25p80 mtd driver read function
 issue

When use "fdisk -l" to show mtd devices, the spi nor flash n25p128a13
(which use driver m25p80.c) will enter a deadless loop and hang the
system.

It happened because when the function "m25p80_read_ext" call the
routine "m25p80_read", it passes the fourth argument "actual_len"
with the type "u32", but in the function "m25p80", the fourth
argument's type is size_t which is 8-byte size.So when m25p80 writes
a 8-byte data to "actual_len", the function "m25p80_read_ext" get
the corrupt value which is 4-byte.

When change the actual_len type is size_t which is same to the function
m25p80_read's argument type, it works OK.

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/mtd/devices/m25p80.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/mtd/devices/m25p80.c b/drivers/mtd/devices/m25p80.c
index d16e550..e728f28 100644
--- a/drivers/mtd/devices/m25p80.c
+++ b/drivers/mtd/devices/m25p80.c
@@ -518,7 +518,7 @@ static int m25p80_read_ext(struct mtd_info *mtd, loff_t from, size_t len,
 	u32 addr = from;
 	u32 offset = from;
 	u32 read_len = 0;
-	u32 actual_len = 0;
+	size_t actual_len = 0;
 	u32 read_count = 0;
 	u32 rem_bank_len = 0;
 	u8 bank = 0;
-- 
1.9.1

