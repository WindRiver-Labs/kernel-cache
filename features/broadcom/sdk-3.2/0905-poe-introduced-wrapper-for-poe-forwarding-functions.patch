From 364eec8c0b0008106fae7b51b0887cb344c99749 Mon Sep 17 00:00:00 2001
From: Abhishek Joshi <abjoshi@broadcom.com>
Date: Fri, 7 Mar 2014 20:47:21 +0530
Subject: [PATCH 0905/1532] poe: introduced wrapper for poe forwarding
 functions

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/netlib/include/netsoc_msgiface.h | 3 +++
 arch/mips/netlogic/lib/netlib/src/netsoc_msg.c          | 8 ++++++--
 arch/mips/netlogic/lib/netlib/src/netsoc_v1_msg.c       | 6 +++---
 3 files changed, 12 insertions(+), 5 deletions(-)

diff --git a/arch/mips/netlogic/lib/netlib/include/netsoc_msgiface.h b/arch/mips/netlogic/lib/netlib/include/netsoc_msgiface.h
index 7de26a3..6c23b03 100644
--- a/arch/mips/netlogic/lib/netlib/include/netsoc_msgiface.h
+++ b/arch/mips/netlogic/lib/netlib/include/netsoc_msgiface.h
@@ -45,6 +45,7 @@ extern int (*pkt_recv)(uint32_t rxvc, uint64_t *addr, uint32_t *len, pkt_recv_in
 extern int (*poe_send_deq2nae)(net_port_t *port, poe_enq_info_t *rcvd_enq_info, uint32_t rxmsg);
 extern int (*poe_send_deq)(net_port_t *port, poe_enq_info_t *rcvd_enq_info);
 extern int (*poe_send_resp)(net_port_t *port, poe_fwd_mode_t fwd_mode, poe_enq_info_t *rcvd_enq_info, poe_resp_t *resp);
+extern int (*poe_send_resp_fwddest_2)(net_port_t *port, poe_enq_info_t *rcvd_enq_info, poe_resp_t *resp, uint64_t fwdmsg1, uint64_t fwdmsg2);
 
 extern int (*poe_send_resp_cpu_enq)(net_port_t *port, poe_resp_t *resp, uint64_t *fwdmsg, int size);
 extern int (*poe_send_resp_reenq_fwd)(net_port_t *port, poe_fwd_mode_t fwd_mode, poe_enq_info_t *rcvd_enq_info, poe_resp_t *resp, uint64_t *fwdmsg, int size);
@@ -59,6 +60,8 @@ extern int (*poe_send_resp_reenq_fwd)(net_port_t *port, poe_fwd_mode_t fwd_mode,
 #define netsoc_poe_send_resp_cpu_enq		poe_send_resp_cpu_enq
 #define netsoc_poe_send_resp_reenq_fwd		poe_send_resp_reenq_fwd
 
+#define netsoc_poe_send_resp_fwddest_2		poe_send_resp_fwddest_2
+
 /**
 * @brief netsoc_nae_send_freein_buf function is used to send a freein buffer to NAE free in descriptor queue
 * 
diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_msg.c b/arch/mips/netlogic/lib/netlib/src/netsoc_msg.c
index 1020b9e..a225ecc 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_msg.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_msg.c
@@ -40,6 +40,7 @@ int (*pkt_recv)(uint32_t rxvc, uint64_t *addr, uint32_t *len, pkt_recv_info_t *p
 int (*poe_send_deq2nae)(net_port_t *port, poe_enq_info_t *rcvd_enq_info, uint32_t rxmsg);
 int (*poe_send_deq)(net_port_t *port, poe_enq_info_t *rcvd_enq_info);
 int (*poe_send_resp)(net_port_t *port, poe_fwd_mode_t fwd_mode, poe_enq_info_t *rcvd_enq_info, poe_resp_t *resp);
+int (*poe_send_resp_fwddest_2)(net_port_t *port, poe_enq_info_t *rcvd_enq_info, poe_resp_t *resp, uint64_t fwdmsg1, uint64_t fwdmsg2);
 
 int (*poe_send_resp_cpu_enq)(net_port_t *port, poe_resp_t *resp, uint64_t *fwdmsg, int size);
 int (*poe_send_resp_reenq_fwd)(net_port_t *port, poe_fwd_mode_t fwd_mode, poe_enq_info_t *rcvd_enq_info, poe_resp_t *resp, uint64_t *fwdmsg, int size);
@@ -53,6 +54,7 @@ extern int netsoc_v1_poe_send_resp(net_port_t *port, poe_fwd_mode_t fwd_mode, po
 extern int netsoc_v1_poe_send_resp_cpu_enq(net_port_t *port, poe_resp_t *resp, uint64_t *fwdmsg, int size);
 extern int netsoc_v1_poe_send_resp_reenq_fwd(net_port_t *port, poe_fwd_mode_t fwd_mode, poe_enq_info_t *rcvd_enq_info, poe_resp_t *resp, uint64_t *fwdmsg, int size);
 extern int netsoc_get_poe_cpuclass_map(poe_t *poe);
+extern int netsoc_v1_poe_send_resp_fwddest_2 (net_port_t *port, poe_enq_info_t *rcvd_enq_info, poe_resp_t *resp, uint64_t fwdmsg1, uint64_t fwdmsg2);
 
 
 /**
@@ -732,7 +734,7 @@ int netsoc_v0_poe_send_resp_reenq_fwd(net_port_t *port, poe_fwd_mode_t fwd_mode,
 }
 
 /**
-* @brief netsoc_poe_send_resp_fwddest_2 function is used to forward enqueued packet to different destination using 
+* @brief netsoc_v0_poe_send_resp_fwddest_2 function is used to forward a two entry message from poe to different destination using
 *        fixed destination method  
 * 
 * @param [in] port Pointer to net_port_t
@@ -748,7 +750,7 @@ int netsoc_v0_poe_send_resp_reenq_fwd(net_port_t *port, poe_fwd_mode_t fwd_mode,
 * 
 */
 
-int netsoc_poe_send_resp_fwddest_2(net_port_t *port, poe_enq_info_t *rcvd_enq_info, poe_resp_t *resp, uint64_t fwdmsg1, uint64_t fwdmsg2)
+int netsoc_v0_poe_send_resp_fwddest_2(net_port_t *port, poe_enq_info_t *rcvd_enq_info, poe_resp_t *resp, uint64_t fwdmsg1, uint64_t fwdmsg2)
 {
         uint64_t msg0;
         msg0 = poe_txdesc_fwd_dest(rcvd_enq_info->descaddr, rcvd_enq_info->fid16, resp->next_dest);
@@ -915,6 +917,7 @@ void update_netsoc_msgiface(int version)
         poe_send_resp = netsoc_v0_poe_send_resp;        
         poe_send_resp_cpu_enq = netsoc_v0_poe_send_resp_cpu_enq;
         poe_send_resp_reenq_fwd = netsoc_v0_poe_send_resp_reenq_fwd;
+	poe_send_resp_fwddest_2 = netsoc_v0_poe_send_resp_fwddest_2;
      }
      else {
         enq_pkt_recv = netsoc_v1_enq_pkt_recv;
@@ -925,6 +928,7 @@ void update_netsoc_msgiface(int version)
         poe_send_resp = netsoc_v1_poe_send_resp;
         poe_send_resp_cpu_enq = netsoc_v1_poe_send_resp_cpu_enq;
         poe_send_resp_reenq_fwd = netsoc_v1_poe_send_resp_reenq_fwd;
+	poe_send_resp_fwddest_2 = netsoc_v1_poe_send_resp_fwddest_2;
      }
 
 }
diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_v1_msg.c b/arch/mips/netlogic/lib/netlib/src/netsoc_v1_msg.c
index edb8f9d3..0c5d85b 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_v1_msg.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_v1_msg.c
@@ -535,8 +535,8 @@ int netsoc_v1_poe_send_resp_reenq_fwd(net_port_t *port, poe_fwd_mode_t fwd_mode,
 }
 
 /**
-* @brief netsoc_v1_poe_send_resp_fwddest_2 function is used to forward enqueued packet to different destination using 
-*        fixed destination method  
+* @brief netsoc_v1_poe_send_resp_fwddest_2 function is used to forward a 2 entry message from poe to a different destination using
+*        fixed destination method
 * 
 * @param [in] port Pointer to net_port_t
 * @param [in] rcvd_enq_info Pointer to poe_enq_info_t.  
@@ -554,7 +554,7 @@ int netsoc_v1_poe_send_resp_reenq_fwd(net_port_t *port, poe_fwd_mode_t fwd_mode,
 int netsoc_v1_poe_send_resp_fwddest_2(net_port_t *port, poe_enq_info_t *rcvd_enq_info, poe_resp_t *resp, uint64_t fwdmsg1, uint64_t fwdmsg2)
 {
         uint64_t msg0;
-        msg0 = netv1_poe_txdesc_fwd(rcvd_enq_info->descaddr, rcvd_enq_info->fid16, resp->next_dest);
+	msg0 = netv1_poe_txdesc_0(rcvd_enq_info->descaddr, rcvd_enq_info->fid16, resp->next_dest, POE_FWD_DEST_NOENQ);
 #ifdef NETSOC_MSG_DEBUG
         fmndbg("%s msg0 0x%llx Q: %d \n",__func__, msg0, (port->poe_queue_base + rcvd_enq_info->rxclass));
 #endif
-- 
1.9.1

