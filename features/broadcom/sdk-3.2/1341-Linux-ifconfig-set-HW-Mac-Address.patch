From 1467c7e580f3cad8f19fa86904e0594f34bec499 Mon Sep 17 00:00:00 2001
From: Sreenidhi BR <sreenidhibr@netlogicmicro.com>
Date: Fri, 27 Jan 2012 16:48:15 +0530
Subject: [PATCH 1341/1532] Linux ifconfig set HW Mac Address.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/broadcom/nae/xlp_nae.c | 31 ++++++++++++++++++++++++++++-
 1 file changed, 30 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/broadcom/nae/xlp_nae.c b/drivers/net/ethernet/broadcom/nae/xlp_nae.c
index 9c19e79..bc6913d 100755
--- a/drivers/net/ethernet/broadcom/nae/xlp_nae.c
+++ b/drivers/net/ethernet/broadcom/nae/xlp_nae.c
@@ -357,6 +357,7 @@ static int  nlm_xlp_nae_ioctl (struct net_device *dev, struct ifreq *rq, int cmd
 static int  nlm_xlp_nae_change_mtu(struct net_device *dev, int new_mtu);
 static void  nlm_xlp_nae_tx_timeout (struct net_device *dev);
 static void xlp_mac_setup_hwaddr(struct dev_data *priv);
+static int nlm_xlp_nae_set_hwaddr(struct net_device *dev, void *p);
 
 #ifdef  ENABLE_NAE_PIC_INT
 static irqreturn_t nlm_xlp_nae_int_handler(int irq, void * dev_id);
@@ -385,7 +386,7 @@ static const struct net_device_ops nlm_xlp_nae_ops = {
 	.ndo_do_ioctl	= nlm_xlp_nae_ioctl,
 	.ndo_tx_timeout = nlm_xlp_nae_tx_timeout,
 	.ndo_change_mtu	= nlm_xlp_nae_change_mtu,
-	.ndo_set_mac_address	= eth_mac_addr,
+	.ndo_set_mac_address	= nlm_xlp_nae_set_hwaddr,
 	.ndo_get_stats = nlm_xlp_mac_get_stats,
 };
 
@@ -1255,6 +1256,34 @@ static void  nlm_xlp_nae_tx_timeout (struct net_device *dev)
 	return;
 }
 
+static int nlm_xlp_nae_set_hwaddr(struct net_device *dev, void *p)
+{
+	struct sockaddr *addr = (struct sockaddr *)p;
+	struct dev_data *priv = netdev_priv(dev);
+	int rc = 0;
+
+	rc = eth_mac_addr(dev, p);
+
+	if (rc)
+		return rc;
+
+	if (priv->type == SGMII_IF)
+	{
+		nlm_hal_write_mac_reg(priv->block, priv->index, MAC_ADDR0_LO, 
+				(addr->sa_data[5] << 24) | 
+				(addr->sa_data[4] << 16) | 
+				(addr->sa_data[3] << 8) | 
+				(addr->sa_data[2]));
+
+		nlm_hal_write_mac_reg(priv->block, priv->index, MAC_ADDR0_HI, 
+				(addr->sa_data[1] << 24) | 
+				(addr->sa_data[0] << 16));
+	}
+
+	return rc;
+}
+
+
 #ifdef ENABLE_NAE_PIC_INT
 /**********************************************************************
  * nlm_xlp_nae_int_handler -  interrupt handler
-- 
1.9.1

