From 59c16d051804cda18e110d0f309899df64574a64 Mon Sep 17 00:00:00 2001
From: Debayan Ghosh <debayan.ghosh@broadcom.com>
Date: Fri, 1 Aug 2014 19:50:33 +0530
Subject: [PATCH 0999/1532] netlib: skipping mgmt lifo for guest

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/netlib/src/netsoc_nae.c | 26 ++++++++++++++++++++++++--
 1 file changed, 24 insertions(+), 2 deletions(-)

diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
index cb29995..8639e59 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
@@ -4000,11 +4000,22 @@ static int __netsoc_config_freein_fifo(nae_t *nae)
         int freein_fifo_total_queues = nae->frin_total_queue;
         void *buf;
 
+	uint32_t mgmt_port_mask = 0, port;
+
+	/* Obtaining the mgmt port mask from nae */
+	for (port = 0 ; port < nae->num_ports; port++) {
+		if(nae->ports[port].mgmt) {
+			mgmt_port_mask |= (1 << nae->ports[port].hw_port_id);
+		}
+	}
+	netsoc_api_print(NETSOC_APIDBG_GLOBAL,"num_ports: %d mgmt port mask: 0x%x\n",nae->num_ports,mgmt_port_mask);
+
         /* Add the unused onchip rxfreein-fifo spaces to the used fifos
          if port fifo mode is selected */
         if(nae->port_fifo_en) {
                 int i, fifo, sfifo;
                 unsigned int blk_cmplx_map;
+
                 /* Xaui/rxaui/interlaken uses only one fifo per complex */
                 blk_cmplx_map = nae->xaui_complex_map |  nae->rxaui_complex_map |
                          nae->xlgmac_complex_map | nae->ilk_complex_map;
@@ -4099,8 +4110,19 @@ static int __netsoc_config_freein_fifo(nae_t *nae)
                                         (i  & 0x1f);
 
 #ifdef KVM_GUEST_MODE_EN
-				netsoc_write_nae_reg(nae->nae_base, 0x91, 1);
-				netsoc_api_print(NETSOC_APIDBG_CONFIG, "Freein fifo cfg %d, guestid: %d\n", 1, 1);
+				{
+					uint32_t guest_id = 1;
+
+					if(mgmt_port_mask & (1 << i)){
+						guest_id = 0;
+						netsoc_api_print(NETSOC_APIDBG_CONFIG, "Skipping guest fifo cfg for mgmt port %d \n", i);
+					}
+					else
+					{
+						netsoc_api_print(NETSOC_APIDBG_CONFIG, "Freein fifo cfg %d, guestid: %d \n", 1, 1);
+					}
+					netsoc_write_nae_reg(nae->nae_base, 0x91, guest_id);
+				}
 #endif
 
                                 netsoc_write_nae_reg(nae->nae_base, FREE_IN_FIFO_CFG, reg);
-- 
1.9.1

