From b8371c8ac591ede4ee2e2b499e075d8a8d2550b7 Mon Sep 17 00:00:00 2001
From: Kevin James <kevinj@broadcom.com>
Date: Tue, 18 Feb 2014 02:43:26 -0800
Subject: [PATCH 1217/1532] fmn: Fix for generating local destination vc in
 multinode

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/misc/netlogic/soc_interface/on_chip.c | 10 ++++++----
 1 file changed, 6 insertions(+), 4 deletions(-)

diff --git a/drivers/misc/netlogic/soc_interface/on_chip.c b/drivers/misc/netlogic/soc_interface/on_chip.c
index b86c2cd..cf3e18d 100644
--- a/drivers/misc/netlogic/soc_interface/on_chip.c
+++ b/drivers/misc/netlogic/soc_interface/on_chip.c
@@ -38,6 +38,8 @@
 #include <linux/timer.h>
 #include <linux/proc_fs.h>
 
+#include <asm/netlogic/mips-extns.h>
+
 #include "nlm_msgring.h"
 #include "nlm_xlp.h"
 #include "nlm_debug.h"
@@ -1067,10 +1069,10 @@ void nlm_enable_vc_intr(void)
 	for(cpu=0; cpu<NR_CPUS; cpu++){
                 if(!cpumask_test_cpu(cpu, &phys_cpu_present_map))
                         continue;
-		node = cpu / 32;
+		node = nlm_nodeid();
 		for(i=0; i<NLM_MAX_VC_PER_THREAD; i++)
 		{
-			vc_index = (i + cpu*NLM_MAX_VC_PER_THREAD) & 0x7f;
+			vc_index = (i + (cpu % NLM_MAX_CPU_PER_NODE)*NLM_MAX_VC_PER_THREAD);
 			if(nlm_cpu_vc_mask[cpu] & (1<<i)){
 				/*enable interrupts*/
 				nlm_hal_enable_vc_intr(node, vc_index);
@@ -1090,9 +1092,9 @@ void nlm_enable_vc_intr_9xx(void)
         for(cpu=0; cpu < NR_CPUS; cpu++){
                 if(!cpumask_test_cpu(cpu, &phys_cpu_present_map))
                         continue;
-                node = cpu / NLM_MAX_CPU_PER_NODE_9XX;
+                node = nlm_nodeid();
                 for(i = 0; i < NLM_MAX_VC_PER_THREAD_9XX; i++) {
-                        vc_index = (i + cpu * NLM_MAX_VC_PER_THREAD_9XX) & NLM_MAX_VC_MASK_9XX;
+			vc_index = (i + (cpu % NLM_MAX_CPU_PER_NODE_9XX)*NLM_MAX_VC_PER_THREAD_9XX);
                         if(nlm_cpu_vc_mask[cpu] & (1<<i)){
                                 /*enable interrupts*/
                                 nlm_hal_enable_vc_intr(node, vc_index);
-- 
1.9.1

