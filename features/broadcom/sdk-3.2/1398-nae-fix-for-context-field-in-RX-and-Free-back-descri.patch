From d9af032d0ad68f96adf5aad41a5a5dfef0f6a090 Mon Sep 17 00:00:00 2001
From: Vikas Gupta <vikas.gupta@broadcom.com>
Date: Thu, 21 Mar 2013 16:13:40 +0530
Subject: [PATCH 1398/1532] nae: fix for context field in RX and Free back
 descriptor.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/broadcom/nae/xlpge_rx.c | 15 ++++++++++++---
 1 file changed, 12 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_rx.c b/drivers/net/ethernet/broadcom/nae/xlpge_rx.c
index 352db3a..15ee9fd 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_rx.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_rx.c
@@ -75,8 +75,12 @@ inline void process_tx_complete(int cpu, uint32_t src_id, uint64_t msg0)
         /* Process Transmit Complete, addr is the skb pointer */
         addr = msg0 & 0xffffffffffULL;
 
-        /* context field is currently unused */
-        context = (msg0 >> 40) & 0x3fff;
+	if((is_nlm_xlp3xx() || is_nlm_xlp2xx())){ 
+        	context = (msg0 >> 40) & 0x3f;
+	}
+	else{
+        	context = (msg0 >> 40) & 0x3ff;
+	}
         node = (src_id >> 10) & 0x3;
         port = *(cntx2port[node] + context);
 
@@ -598,7 +602,12 @@ static inline void process_rx_packets(int cpu, unsigned int src_id,
 	/* Rx packet */
 	addr	= msg1 & 0xffffffffc0ULL;
 	len	= (msg1 >> 40) & 0x3fff;
-	context = (msg1 >> 54) & 0x3ff;
+	if((is_nlm_xlp3xx() || is_nlm_xlp2xx())){ 
+		context = (msg1 >> 54) & 0x3f;
+	}else{
+		context = (msg1 >> 54) & 0x3ff;
+	}
+		
 	node = (src_id >> 10) & 0x3;
 
 	Message("%s in cpu %d src_id %d len %d context %d node %d err %d\n",
-- 
1.9.1

