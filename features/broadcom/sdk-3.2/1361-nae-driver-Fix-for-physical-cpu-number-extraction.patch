From 72cc0afea72c8c70b0795175ce875e29b1473290 Mon Sep 17 00:00:00 2001
From: Hareesh R <hareeshr@broadcom.com>
Date: Mon, 14 May 2012 20:01:17 +0530
Subject: [PATCH 1361/1532] nae driver : Fix for physical cpu number extraction

Fix for a typo in  physical cpu number extration
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/broadcom/nae/xlp_nae.c | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/broadcom/nae/xlp_nae.c b/drivers/net/ethernet/broadcom/nae/xlp_nae.c
index 25ec751..cd16cb5 100755
--- a/drivers/net/ethernet/broadcom/nae/xlp_nae.c
+++ b/drivers/net/ethernet/broadcom/nae/xlp_nae.c
@@ -537,8 +537,10 @@ static void dump_skbuff (struct sk_buff *skb)
 /* Get the hardware replenishment queue id */
 static int get_hw_frfifo_queue_id(int rxnode, nlm_nae_config_ptr nae_cfg, int cpu, unsigned int truesize)
 {
+	/* We have to use the logical map here as the below arrays are indexed by logical cpu id
+	 */
 	int qid;
-	int node_cpu = cpu % NLM_NCPUS_PER_NODE;
+	int node_cpu = __cpu_number_map[cpu] % NLM_NCPUS_PER_NODE;
 
 	qid = cpu_2_normal_frfifo[rxnode][node_cpu];
 	if (enable_jumbo)
@@ -554,9 +556,11 @@ static int get_hw_frfifo_queue_id(int rxnode, nlm_nae_config_ptr nae_cfg, int cp
 
 static int mac_refill_frin_skb(int node, int cpu, uint64_t paddr, unsigned int bufsize)
 {
+	/* We have to use the logical map here as the below arrays are indexed by logical cpu id
+	 */
 	int ret, code, qid;
 	nlm_nae_config_ptr nae_cfg;
-	int node_cpu = cpu % NLM_NCPUS_PER_NODE;
+	int node_cpu = __cpu_number_map[cpu] % NLM_NCPUS_PER_NODE;
 	unsigned long __attribute__ ((unused)) mflags;
 
 
@@ -1150,7 +1154,7 @@ static void nlm_xlp_nae_init(void)
 
 	/*Disable interrupts for VC - 0-127*/
 	for(i=0; i<NR_CPUS; i++){
-	        if(!cpu_isset(cpu, phys_cpu_present_map))
+	        if(!cpu_isset(i, phys_cpu_present_map))
                         continue;
 		phys_cpu_map[i / NLM_NCPUS_PER_NODE] |= (1 << (i % NLM_NCPUS_PER_NODE));
 	}
-- 
1.9.1

