From d13119a15b8a12f8bfdb656a9af7184284d3c0af Mon Sep 17 00:00:00 2001
From: Alok Agrawat <alok@broadcom.com>
Date: Thu, 20 Mar 2014 03:18:01 -0700
Subject: [PATCH 0912/1532] ilk-8xx : Fixed lane alignment issue 8xx-ilk
 comple-2.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h | 4 ++--
 arch/mips/netlogic/lib/netlib/src/netsoc_nae.c          | 7 +++----
 2 files changed, 5 insertions(+), 6 deletions(-)

diff --git a/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h b/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h
index f115794..cc82297 100644
--- a/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h
+++ b/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h
@@ -327,8 +327,8 @@ static inline void netsoc_api_writeq(uint64_t base, uint32_t index, uint64_t val
 #define netsoc_get_macreg_base_for_lanecfg(mac_base) \
         NETSOC_MAC_OFFSET(mac_base, BLOCK_7, LANE_CFG)
 
-#define netsoc_get_macreg_base_for_ilk(mac_base, hwport) \
-	NETSOC_MAC_OFFSET(mac_base, (hwport / XLP_ILK_MAX_LANES), INTERLAKEN)
+#define netsoc_get_macreg_base_for_ilk(mac_base, block) \
+	NETSOC_MAC_OFFSET(mac_base, (block), INTERLAKEN)
  	
 #define netsoc_get_macreg_base_for_xgmac0(mac_base, hwport) \
         NETSOC_MAC_OFFSET(mac_base, (hwport / MAX_PORTS_PERBLOCK), XGMAC0)
diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
index ad714b0..45c1c92 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
@@ -2435,8 +2435,8 @@ static void __netsoc_config_interlaken(net_port_t *netport, int num_lanes)
         volatile uint32_t txctrl = 0, genctrl = 0;
         volatile uint32_t val = 0;
 	nae_t *nae = netport->nae;
-	uint64_t mac_base = netsoc_get_macreg_base_for_ilk(nae->mac_base, netport->hw_port_id);
 	uint32_t blk = netport->hw_port_id / 4;
+	uint64_t mac_base = netsoc_get_macreg_base_for_ilk(nae->mac_base, blk);
 
         if (!((blk == 0) || (blk == 2)))
                 return;
@@ -2506,8 +2506,7 @@ static void __netsoc_config_ilk_loopback(net_port_t *netport, int num_lanes)
         volatile uint8_t prbsctrl = 0;
 	nae_t *nae = netport->nae;
         int i = 0, blk = netport->hw_port_id / 4;
-	uint64_t mac_base = netsoc_get_macreg_base_for_ilk(nae->mac_base,
-				netport->hw_port_id);
+	uint64_t mac_base = netsoc_get_macreg_base_for_ilk(nae->mac_base, blk);
 
         if (!((blk == 0) || (blk == 2)))
                 return;
@@ -4118,7 +4117,7 @@ static int is_ilk_lanealigned(nae_t *nae , int blk)
 {
         int i = 0, retval = 1;
         volatile uint32_t status = 0;
-	uint64_t macbase = netsoc_get_macreg_base_for_ilk(nae->mac_base, blk*4);
+	uint64_t macbase = netsoc_get_macreg_base_for_ilk(nae->mac_base, blk);
 
         // check lanes are aligned
         do {
-- 
1.9.1

