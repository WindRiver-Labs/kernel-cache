From 1d013d5f85e9a83102fbdd2c67407795a51f21a3 Mon Sep 17 00:00:00 2001
From: johuang <john.huang@broadcom.com>
Date: Tue, 25 Feb 2014 10:21:22 -0800
Subject: [PATCH 0933/1532] 5xx: Added the support of API is_xlp5xx()

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c | 17 ++++++++++++++---
 1 file changed, 14 insertions(+), 3 deletions(-)

diff --git a/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c b/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c
index e41dbdf..6443e0c 100644
--- a/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c
+++ b/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c
@@ -332,12 +332,23 @@ static inline int xlp3xx_get_num_of_cores(uint32_t core_mask, uint32_t epid)
 
 static inline int is_xlp5xx(uint8_t num_cores, uint8_t num_threads, uint32_t rev, uint32_t exttype)
 {
-	uint32_t pid;
+	uint32_t pid, cfg3;
+	uint8_t epid;
+	int ncores, nthreads;
+	
 	pid=get_proc_id();
-	/*TODO : Add information about for efuse i.e number of cores/threads*/
 	if( pid == CHIP_PROCESSOR_ID_XLP_5XX )
 	{
-		return 1;
+		cfg3 = efuse_cfg3();
+		epid = (uint8_t) ((cfg3 >>27) & 0x7);
+		ncores   = (8 - bitcount(efuse_cfg6() & 0xFF));
+		nthreads =  4 - ((cfg3 >> 24) & 3);
+		
+		if (exttype == epid)
+		{
+			if ((num_cores * num_threads) == CPU_NUM_ANY) return 1;
+			else if ((ncores == num_cores) && (nthreads == num_threads)) return 1;
+		}
 	}
 	return 0;
 }
-- 
1.9.1

