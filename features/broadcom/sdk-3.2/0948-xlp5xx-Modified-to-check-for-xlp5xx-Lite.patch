From 703208f0e80ac0f3a46a8d08ad492926e9235109 Mon Sep 17 00:00:00 2001
From: ajesh <ajesh@broadcom.com>
Date: Mon, 26 May 2014 12:47:58 +0530
Subject: [PATCH 0948/1532] xlp5xx: Modified to check for xlp5xx Lite

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 .../netlogic/lib/syslib/src/nlm_hal_cpu_info.c     | 38 +++++++++++++++++++---
 1 file changed, 33 insertions(+), 5 deletions(-)

diff --git a/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c b/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c
index ca0190f..bcb4bb3 100644
--- a/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c
+++ b/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c
@@ -123,6 +123,11 @@ static __inline__ int get_nlm_xlp9xx_rev(void)
 	return nlm_read_prid() & 0xff;
 }
 
+static __inline__ int get_nlm_xlp5xx_rev(void)
+{
+    return nlm_read_prid() & 0xff;
+}
+
 static __inline__ int get_nlm_xlp8xx_rev(void)
 {
 	return nlm_read_prid() & 0xff;
@@ -164,6 +169,20 @@ static __inline__ int is_nlm_xlp8xx_rev_xx(uint32_t rev)
 /***************************************************************************************
 * match the chip revision with 'rev'
  * rev:  revision number
+****************************************************************************************/
+static __inline__ int is_nlm_xlp5xx_rev_xx(uint32_t rev)
+{   
+    int sw_rev = get_nlm_xlp5xx_rev();
+    
+	if( rev==sw_rev)    return 1;
+    if( rev==XLP_REVISION_ANY)          return 1;
+
+    return 0;
+}
+
+/***************************************************************************************
+* match the chip revision with 'rev'
+ * rev:  revision number
 		single match: XLP_REVISION_A0 etc
 		multi-match:  XLP_REVISION_AX/_BX/_XX
 ****************************************************************************************/
@@ -332,9 +351,12 @@ static inline int xlp3xx_get_num_of_cores(uint32_t core_mask, uint32_t epid)
 
 static inline int is_xlp5xx(uint8_t num_cores, uint8_t num_threads, uint32_t rev, uint32_t exttype)
 {
-	uint32_t pid;
+	uint32_t pid, threaden;
 	uint8_t epid;
-	int ncores, nthreads;
+	int ret, ncores, nthreads;
+
+	ret = is_nlm_xlp5xx_rev_xx(rev);
+    if(ret!=1)  return 0;	
 	
 	pid=get_proc_id();
 	if( pid == CHIP_PROCESSOR_ID_XLP_5XX )
@@ -345,10 +367,16 @@ static inline int is_xlp5xx(uint8_t num_cores, uint8_t num_threads, uint32_t rev
 
 		epid = (uint8_t) ((cfg3 >>27) & 0x7);
 		ncores   = (8 - bitcount(cfg6 & 0xFF));
-		nthreads =  4 - ((cfg3 >> 24) & 3);
 
-		if (rev == XLP_REVISION_ANY)
-			return 1;
+		threaden = ((cfg3 >> 24) & 3);
+        if((threaden == 0x1) || (threaden == 0x2))
+        {
+ 	       nthreads = 2;
+        }
+        else
+        {
+           nthreads =  4 - ((cfg3 >> 24) & 3);
+    	}
 
 		if (exttype == epid)
 		{
-- 
1.9.1

