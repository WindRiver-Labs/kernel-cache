From dd3e2d5dee272827aa6890a863d938064005bb8d Mon Sep 17 00:00:00 2001
From: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Date: Thu, 30 Sep 2010 15:35:48 -0700
Subject: [PATCH 0200/1532] Added support for 32 way 3-domain configuration,
 needs 4GB ram

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/boot/dts/linux.dts    |  2 +-
 arch/mips/boot/dts/multi-os.dts | 57 +++++++++++++++++++++++++++++++++--------
 arch/mips/boot/dts/netos.dts    |  8 +++---
 3 files changed, 52 insertions(+), 15 deletions(-)

diff --git a/arch/mips/boot/dts/linux.dts b/arch/mips/boot/dts/linux.dts
index 174fbfd..0d76454 100644
--- a/arch/mips/boot/dts/linux.dts
+++ b/arch/mips/boot/dts/linux.dts
@@ -38,7 +38,7 @@
 				sharedcfg = <0x1f000000>;
 			};
 			memory {
-				reg = <0x04000000 0x0C000000	// 192M at 64M
+				reg = <0x01000000 0x0B000000	// 176M at 16M
 					0x20000000 0x10000000>;  // 256M at 512M
 			};
 			pic {
diff --git a/arch/mips/boot/dts/multi-os.dts b/arch/mips/boot/dts/multi-os.dts
index 5086177..6468ad6 100644
--- a/arch/mips/boot/dts/multi-os.dts
+++ b/arch/mips/boot/dts/multi-os.dts
@@ -14,8 +14,8 @@
 		hypervisor-name = "Xen";
 		cpu_possible_map = <0xff>;
 		is_dom0_hvm = <1>;
-		bootargs = "ncores=2 dom0_loadaddr=0x78000000 dom0_size=0x1c000000 dom0_cpumask=0x0f -- ";
-		domain_heap = <0x50000000 0x20000000>;
+		bootargs = "ncores=8 dom0_loadaddr=0xf8000000 dom0_size=0x1c000000 dom0_cpumask=0x0f -- ";
+		domain_heap = <0x30000000 0x20000000>; /* 0.75 GB -> 1.25 GB */
 	};
 	doms {
 		#address-cells = <1>;
@@ -49,13 +49,13 @@
 			os = "netos";
 
 			heap-size = <0x0 0x2000000>;                   // 32M
-			shared-mem = <0x0 0x40000000 0x0 0x08000000>;  // 128M @ 1GB
+			shared-mem = <0x0 0xe0000000 0x0 0x04000000>;  // 3584MB -> 3648 MB (64MB)
 
 			#address-cells = <1>;
 			#size-cells = <1>;
 
 			app-bootcmd = "ampload";
-			app-loadaddr = "0x74000000";
+			app-loadaddr = "0xf4000000"; // 3.75 GB + 64 MB
 
 			kernel {
 				/* Kernel Memory allocated from xen domain-heap */
@@ -69,7 +69,7 @@
 			};
 
 			cpu {
-				onlinemask = <0x30>;
+				onlinemask = <0xf0>;
                                 nae-rx-vc = <0>;
                                 nae-fb-vc = <1>;
 			};
@@ -78,7 +78,7 @@
 				sharedcfg = <0x1f000000>;
 			};
 			memory {
-				reg = <0x30000000 0x08000000>;  // 128M @ 768M
+				reg = <0x50000000 0x10000000>;  // 1280M -> 1536M (256M)
 			};
 		};
 		dom@2 {
@@ -86,13 +86,13 @@
 			os = "netos";
 
 			heap-size = <0x0 0x2000000>;                   // 32M
-			shared-mem = <0x0 0x48000000 0x0 0x08000000>;  // 128M @ 1.128GB
+			shared-mem = <0x0 0xe4000000 0x0 0x04000000>;  // 3648MB -> 3712 (64MB)
 
 			#address-cells = <1>;
 			#size-cells = <1>;
 
 			app-bootcmd = "smpload";
-			app-loadaddr = "0x74000000";
+			app-loadaddr = "0xf4000000"; // 3.75 GB + 64 MB
 
 			kernel {
 				/* Kernel Memory allocated from xen domain-heap */
@@ -106,7 +106,7 @@
 			};
 
 			cpu {
-				onlinemask = <0xC0>;
+				onlinemask = <0x000fff00>;
                                 nae-rx-vc = <0>;
                                 nae-fb-vc = <1>;
 			};
@@ -115,7 +115,44 @@
 				sharedcfg = <0x1f000000>;
 			};
 			memory {
-				reg = <0x38000000 0x08000000>;  // 128M @ 896M
+				reg = <0x60000000 0x30000000>;  // 1536M -> 2304M (768M)
+			};
+		};
+		dom@3 {
+			device_type = "domain";
+			os = "netos";
+
+			heap-size = <0x0 0x2000000>;                   // 32M
+			shared-mem = <0x0 0xe8000000 0x0 0x04000000>;  // 3712MB -> 3776 MB (64MB)
+
+			#address-cells = <1>;
+			#size-cells = <1>;
+
+			app-bootcmd = "ampload";
+			app-loadaddr = "0xf4000000"; // 3.75 GB + 64 MB
+
+			kernel {
+				/* Kernel Memory allocated from xen domain-heap */
+				size = <0x02000000>;  // 32M
+
+				/* Location in Dom0 ramdisk */
+				location = "/tmp/xen/netos.elf";
+
+				/* Domain destroy currently doesn't work with hyperexec */
+				dom_destroy_hack = <0>;
+			};
+
+			cpu {
+				onlinemask = <0xfff00000>;
+                                nae-rx-vc = <0>;
+                                nae-fb-vc = <1>;
+			};
+			uart {
+				id = <0>;
+				sharedcfg = <0x1f000000>;
+			};
+			memory {
+				reg = <0x90000000 0x30000000>;  // 2304M -> 3072M (768MB)
 			};
 		};
 	};
diff --git a/arch/mips/boot/dts/netos.dts b/arch/mips/boot/dts/netos.dts
index 3e64338..152c7cb 100644
--- a/arch/mips/boot/dts/netos.dts
+++ b/arch/mips/boot/dts/netos.dts
@@ -25,14 +25,14 @@
 			device_type = "domain";
 			os = "netos";
 
-			heap-size = <0x0 0x4000000>; // 64M
-			shared-mem = <0x0 0x40000000 0x0 0x08000000>; // 128M @ 1GB
+			heap-size = <0x0 0x2000000>; // 32M
+			shared-mem = <0x0 0xe0000000 0x0 0x10000000>; // 128M @ 3.5GB
 
 			#address-cells = <1>;
 			#size-cells = <1>;
 
 			app-bootcmd = "smpload";
-			app-loadaddr = "0x74000000";
+			app-loadaddr = "0xf0000000"; // 3.75GB
 
 			kernel {
 				/* Kernel Memory allocated from xen domain-heap */
@@ -54,7 +54,7 @@
 				id = <0>;
 			};
 			memory {
-				reg = <0x30000000 0x20000000>;  // 128M @ 768M
+				reg = <0x20000000 0xa0000000>;  // 2560M @ 512M
 			};
 		};
 	};
-- 
1.9.1

