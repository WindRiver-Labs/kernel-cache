From 2d1fcc444db3417867b5bf58996a1db806b27b59 Mon Sep 17 00:00:00 2001
From: Tanmay Jagdale <tanmayj@broadcom.com>
Date: Thu, 19 Jun 2014 17:06:35 +0530
Subject: [PATCH 1230/1532] pktmem: use memory allocated by linux kernel

Removed static memory configurations for pktmem.
Memory is allocated/reserved for the pktmem application by the linux kernel.
Amount of memory needed for pktmem can be specified in the 'chosen' section
of the dts file.
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c | 24 +++++++++++++++++++++--
 1 file changed, 22 insertions(+), 2 deletions(-)

diff --git a/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c b/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c
index f138797..fd5fd78 100644
--- a/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c
+++ b/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c
@@ -298,6 +298,8 @@ static inline int get_fdt_prop(void *fdt, const char* node_path,
 }
 
 extern void *initial_boot_params;
+extern unsigned long pktmem_start_address;
+extern unsigned long pktmem_size;
 
 /* see "pktmem" section in DTS file for providing memory */
 
@@ -339,8 +341,26 @@ static int __init brcm_xlp_ppm_init (void)
 	}
 	else
 	{
-		printk(KERN_ERR "brcm_pktmem: unable to read pktmem from DTB.\n");
-		return -1;
+		if (pktmem_start_address == 0) {
+			printk(KERN_ERR "brcm_pktmem: unable to read pktmem from DTB.\n");
+			return -1;
+		}
+		printk("Using memory allocated by linux kernel\n");
+		mem_pool_data[0].next = NULL;
+		memset(mem_pool_data[node].shr_id, '\0', 64);
+		mem_pool_data[0].in_use = 0;
+
+		mem_pool_data[node].start = pktmem_start_address;
+		mem_pool_data[node].size = pktmem_size;
+
+		for (i = 1; i < MAX_NODES; i++) {
+			mem_pool_data[i].next = NULL;
+			memset(mem_pool_data[i].shr_id, '\0', 64);
+			mem_pool_data[i].in_use = 0;
+
+			mem_pool_data[i].start = 0x0;
+			mem_pool_data[i].size = 0x0;
+		}
 	}
 
 
-- 
1.9.1

