From c50a9923116c05a2dfc88acb024726ce65a5b521 Mon Sep 17 00:00:00 2001
From: Vikas Gupta <vikas.gupta@broadcom.com>
Date: Thu, 6 Feb 2014 01:29:23 -0800
Subject: [PATCH 0924/1532] xlp5xx: added cpu id check

	TODO: Need to add support for  revision, number of cores check.
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 .../netlogic/lib/syslib/include/nlm_hal_xlp_dev.h  | 25 ++++++++++++++++++++++
 .../netlogic/lib/syslib/src/nlm_hal_cpu_info.c     | 18 ++++++++++++++++
 2 files changed, 43 insertions(+)

diff --git a/arch/mips/netlogic/lib/syslib/include/nlm_hal_xlp_dev.h b/arch/mips/netlogic/lib/syslib/include/nlm_hal_xlp_dev.h
index 260187a..f4bea70 100644
--- a/arch/mips/netlogic/lib/syslib/include/nlm_hal_xlp_dev.h
+++ b/arch/mips/netlogic/lib/syslib/include/nlm_hal_xlp_dev.h
@@ -54,6 +54,7 @@
 #define CHIP_PROCESSOR_ID_XLP_3XX    0x11
 #define CHIP_PROCESSOR_ID_XLP_2XX    0x12
 #define CHIP_PROCESSOR_ID_XLP_9XX    0x15
+#define CHIP_PROCESSOR_ID_XLP_5XX    0x13
 
 /*XLP 8XX  A0,A1,A2 chip support*/
 #define CHIP_PROCESSOR_ID_XLP_832   CHIP_PROCESSOR_ID_XLP_8_4_XX
@@ -115,6 +116,12 @@
 #define CPU_EXTPID_XLP_3XX_INV   0xFE  	 /* invalid */
 #define CPU_EXTPID_XLP_3XX_ANY   0xFF	 /* Any 3XX */
 
+/*XLP 5XX series*/
+#define CPU_EXTPID_XLP_5XX_NONE  0x00
+#define CPU_EXTPID_XLP_5XX_BASE  0x00
+
+#define CPU_EXTPID_XLP_5XX_L    0x01
+
 #ifndef __ASSEMBLY__
 #ifndef __XLP_CHIPID_MACROS__
 #define __XLP_CHIPID_MACROS__
@@ -202,6 +209,24 @@ extern int is_nlm_xlp(unsigned int chipid, unsigned int rev,  unsigned int ext);
 #define is_nlm_xlp2xx_b0()	    is_nlm_xlp(0x2000, XLP_REVISION_B0,  0)
 #define is_nlm_xlp9xx()	    is_nlm_xlp(0x9000, XLP_REVISION_ANY,  0)
 
+#define is_nlm_xlp5xx_B(rev)      ( is_nlm_xlp(0x5000, rev, CPU_EXTPID_XLP_5XX_BASE))
+#define is_nlm_xlp532_B(rev)      ( is_nlm_xlp(0x5084, rev, CPU_EXTPID_XLP_5XX_BASE))
+#define is_nlm_xlp524_B(rev)      ( is_nlm_xlp(0x5064, rev, CPU_EXTPID_XLP_5XX_BASE))
+#define is_nlm_xlp516_B(rev)      ( is_nlm_xlp(0x5044, rev, CPU_EXTPID_XLP_5XX_BASE))
+
+#define is_nlm_xlp5xx_L(rev)      ( is_nlm_xlp(0x5000, rev, CPU_EXTPID_XLP_5XX_L))
+#define is_nlm_xlp532_L(rev)      ( is_nlm_xlp(0x5084, rev, CPU_EXTPID_XLP_5XX_L))
+#define is_nlm_xlp524_L(rev)      ( is_nlm_xlp(0x5064, rev, CPU_EXTPID_XLP_5XX_L))
+#define is_nlm_xlp516_L(rev)      ( is_nlm_xlp(0x5044, rev, CPU_EXTPID_XLP_5XX_L))
+
+#define is_nlm_xlp532_rev(rev) (is_nlm_xlp532_B(rev) || is_nlm_xlp532_L(rev))
+#define is_nlm_xlp524_rev(rev) (is_nlm_xlp524_B(rev) || is_nlm_xlp524_L(rev))
+#define is_nlm_xlp516_rev(rev) (is_nlm_xlp516_B(rev) || is_nlm_xlp516_L(rev))
+
+#define is_nlm_xlp532() is_nlm_xlp532_rev(XLP_REVISION_ANY)
+#define is_nlm_xlp524() is_nlm_xlp524_rev(XLP_REVISION_ANY)
+#define is_nlm_xlp516() is_nlm_xlp516_rev(XLP_REVISION_ANY)
+
 #endif /*__XLP_CHIPID_MACROS__ */
 
 #endif /* __ASSEMBLY__ */
diff --git a/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c b/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c
index 3f27ae4..db7d1d6 100644
--- a/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c
+++ b/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c
@@ -330,6 +330,18 @@ static inline int xlp3xx_get_num_of_cores(uint32_t core_mask, uint32_t epid)
 	return ncores;
 }
 
+static inline int is_xlp5xx(uint8_t num_cores, uint8_t num_threads, uint32_t rev, uint32_t exttype)
+{
+	uint32_t pid;
+	pid=get_proc_id();
+	/*TODO : Add information about for efuse i.e number of cores/threads*/
+	if( pid == CHIP_PROCESSOR_ID_XLP_5XX )
+	{
+		return 1;
+	}
+
+}
+
 static inline int is_xlp3xx(uint8_t num_cores, uint8_t num_threads, uint32_t rev, uint32_t exttype)
 {
 	uint32_t pid, cfg0, core_mask;
@@ -438,6 +450,12 @@ int is_nlm_xlp(unsigned int chipid, unsigned int rev, unsigned int exttype)
 		b_rc=is_xlp4xx(num_cpu, rev);
 		if( b_rc==1 )	return 1;
 	}
+	
+	if ( group==5 )
+	{
+		b_rc=is_xlp5xx(num_cores, num_threads_per_core, rev, exttype);
+		return b_rc;
+	}
 
 	if ( group==3 )
 	{
-- 
1.9.1

