From fb9e23655cb6e73283832fb488e104378fb15d19 Mon Sep 17 00:00:00 2001
From: Jayachandran C <jchandra@broadcom.com>
Date: Fri, 26 Jul 2013 09:58:11 +0530
Subject: [PATCH 0131/1532] MIPS: Netlogic: Fix XLP TLBP bug

On XLP, we see tlbp returning nomatch even when there was a
tlb Load/Store exception on a TLB which is present.
Work around by returning.
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/mm/tlbex.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/arch/mips/mm/tlbex.c b/arch/mips/mm/tlbex.c
index b29cad1..c967255 100644
--- a/arch/mips/mm/tlbex.c
+++ b/arch/mips/mm/tlbex.c
@@ -1870,6 +1870,14 @@ build_r4000_tlbchange_handler_head(u32 **p, struct uasm_label **l,
 	iPTE_LW(p, wr.r1, wr.r2); /* get even pte */
 	if (!m4kc_tlbp_war())
 		build_tlb_probe_entry(p);
+
+	/* XLP can give spurious tlbp fails! eret and hope for best */
+	if (current_cpu_type() == CPU_XLP) {
+		uasm_i_mfc0(p, wr.r3, C0_INDEX);
+		uasm_il_bltz(p, r, wr.r3, label_leave);
+		uasm_i_nop(p);
+	}
+
 	return wr;
 }
 
-- 
1.9.1

