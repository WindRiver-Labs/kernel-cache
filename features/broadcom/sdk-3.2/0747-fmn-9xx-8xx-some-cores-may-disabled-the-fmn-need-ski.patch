From 87f1fbaeb37e4326075c34875c80e557194710e6 Mon Sep 17 00:00:00 2001
From: Wei Zhang <wezhang@broadcom.com>
Date: Fri, 21 Jun 2013 14:09:36 -0700
Subject: [PATCH 0747/1532] fmn: 9xx/8xx some cores may disabled, the fmn need
 skip on those cores

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c | 24 +++++++++++++++++-----
 1 file changed, 19 insertions(+), 5 deletions(-)

diff --git a/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c b/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
index df16cf0..89a76cd 100644
--- a/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
+++ b/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
@@ -739,6 +739,19 @@ void stids_toskip(int node) {
 	enable_interface(RSA,    (nlm_hal_read_sys_reg(node, EFUSE_DEVICE_CFG2)) & 0x1ff);
 }
 
+static int  fmn_9xx_is_vc_valid(int node, unsigned int base_vc)
+{
+	volatile uint32_t * fuse = xlp9xx_cpu_io_mmio(node, (6<<15) | (1<<12) );
+	uint32_t cfg6 = fuse[0xc6]; //FUSE_DEVICECFG6
+	uint32_t nCore = 20 - bitcount(cfg6);
+
+	if( base_vc == XLP_9XX_INVALID_STATION ) return 0;
+	if( XLP_9XX_PCIE0_VC_BASE <= base_vc   ) return 1;
+	if( base_vc < (XLP_CPU0_VC_LIMIT - XLP_CPU0_VC_BASE + 1)*nCore ) return 1; //core enabled
+
+	return 0;
+}
+
 static void nlm_hal_write_fmn_credit(int node, int max_nodes) 
 {
 	int src, qid, hndl = 0, dst_node;
@@ -765,7 +778,8 @@ static void nlm_hal_write_fmn_credit(int node, int max_nodes)
 		/* go through each valid station */
 		for(hndl = 0; hndl < XLP_MSG_HANDLE_MAX; hndl++) {
 			int base_vc = fmn_config->base_vc;
-			if (base_vc != XLP_9XX_INVALID_STATION) {
+			if ( fmn_9xx_is_vc_valid(node, base_vc) )
+			{
 				int station;
 
 				/* configure credits from this base station to all other appropriate VC's */
@@ -775,8 +789,8 @@ static void nlm_hal_write_fmn_credit(int node, int max_nodes)
 					/* go through all valid stations and all valid vc's */
 					for (station = 0; station < XLP_MSG_HANDLE_MAX; station++) {
 						qid = xlp9xx_fmn_config[station].base_vc;
-						if (qid == XLP_9XX_INVALID_STATION)
-							continue;
+						if ( fmn_9xx_is_vc_valid(node, qid) == 0 ) continue;
+
 						for (; qid <= xlp9xx_fmn_config[station].vc_limit; qid++) {
 							/* FIXME: define/config fmn_cfg_value properly for XLP9XX */
 #if 0
@@ -1004,8 +1018,8 @@ int nlm_hal_setup_outq(int node, int max_nodes)
 
 		for (station = 0; station < XLP_MSG_HANDLE_MAX; station++) {
 			qid = xlp9xx_fmn_config[station].base_vc;
-			if (qid == XLP_9XX_INVALID_STATION)
-				continue;
+			if ( fmn_9xx_is_vc_valid(node, qid) == 0 ) continue;
+
 			for (; qid <= xlp9xx_fmn_config[station].vc_limit; qid++) {
 				/* enable output queue and setup on-chip output queue */
 				val = (1ULL << 63) | (qid << 6) | (qid << 0);
-- 
1.9.1

