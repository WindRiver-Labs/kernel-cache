From 34bf90d67d34c74f911be8139b77c86948a4f486 Mon Sep 17 00:00:00 2001
From: Prasanna Mumbai <prasanna.mumbai@broadcom.com>
Date: Fri, 13 Sep 2013 09:44:04 +0530
Subject: [PATCH 1181/1532] pktpool: add locking mechanism for ioctl
 serialization

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c b/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c
index 2b50884..dd3676e 100644
--- a/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c
+++ b/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c
@@ -12,6 +12,8 @@
 #define MAX_NODES 	8
 #define MB(x) 		(x*1024*1024)
 #define PKTMEM_MAJOR 	123
+static DEFINE_SPINLOCK(ioctl_lock);
+
 
 typedef struct memory_pool 
 {
@@ -176,7 +178,7 @@ static long pktmem_ioctl (struct file *fptr, unsigned int cmd, unsigned long dp)
 #ifdef PKTMEM_DEBUG
 	printk("pktmem: icoctl enter, cmd %d.\n", cmd);
 #endif
-
+	spin_lock(&ioctl_lock);
 	dptr = (brcm_devmem_ioctl_t *)dp;
 	rc = 0;
 
@@ -206,7 +208,7 @@ static long pktmem_ioctl (struct file *fptr, unsigned int cmd, unsigned long dp)
 	print_memory(dptr);
 	printk("pktmem: ioctl returns rc %d.\n", rc);
 #endif
-
+	spin_unlock(&ioctl_lock);
 	return rc;
 }
 
-- 
1.9.1

