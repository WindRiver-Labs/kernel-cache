From 30a8e222c7dd41d0461112c0b9fd4c718d279fd6 Mon Sep 17 00:00:00 2001
From: kopal <kopal@broadcom.com>
Date: Wed, 3 Dec 2014 12:10:51 +0530
Subject: [PATCH 1469/1532] nae: added support to change MAC address of an
 interface using ifconfig.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/broadcom/nae/xlpge_nae.c | 40 +++++++++++++--------------
 1 file changed, 20 insertions(+), 20 deletions(-)

diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_nae.c b/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
index 24ecd10..c7b2aaa 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
@@ -1357,35 +1357,35 @@ static void  nlm_xlp_nae_tx_timeout (struct net_device *dev)
 	nae_print(NAE_DBG_ERROR, "%s: Transmit timed out\n", dev->name);
 	return;
 }
-#if 0
+
+/***********************************************************************
+ * nlm_xlp_nae_set_hwaddr -  called when when the MAC address
+ * needs to be changed.
+ * @dev  -  this is per device based function
+ *
+ ***********************************************************************/
+
 static int nlm_xlp_nae_set_hwaddr(struct net_device *dev, void *p)
 {
-	struct sockaddr *addr = (struct sockaddr *)p;
 	struct dev_data *priv = netdev_priv(dev);
 	int rc = 0;
+	ulong flags;
 
-	rc = eth_mac_addr(dev, p);
-
-	if (rc)
-		return rc;
+	net_port_t* nae_port = priv->nae_port;
 
-	if (priv->type == SGMII_IF) {
-	  nlm_hal_write_mac_reg(priv->node, priv->block, priv->index,
-				MAC_ADDR0_LO,
-				(addr->sa_data[5] << 24) |
-				(addr->sa_data[4] << 16) |
-				(addr->sa_data[3] << 8) |
-				(addr->sa_data[2]));
+	rc = eth_mac_addr(dev, p); 
 
-	  nlm_hal_write_mac_reg(priv->node, priv->block, priv->index,
-				MAC_ADDR0_HI,
-				(addr->sa_data[1] << 24) |
-				(addr->sa_data[0] << 16));
-	}
+        if (rc)
+                return rc;
+	
+       	spin_lock_irqsave(&priv->lock, flags); 
+	
+	netsoc_setup_hwaddr(nae_port, dev->dev_addr);
 
+	spin_unlock_irqrestore(&priv->lock, flags);
+	
 	return rc;
 }
-#endif
 
 #ifdef ENABLE_NAE_PIC_INT
 /**********************************************************************
@@ -1428,7 +1428,7 @@ static const struct net_device_ops nlm_xlp_nae_ops = {
 	.ndo_do_ioctl			= nlm_xlp_nae_ioctl,
 	.ndo_tx_timeout 		= nlm_xlp_nae_tx_timeout,
 	.ndo_change_mtu			= nlm_xlp_nae_change_mtu,
-	//.ndo_set_mac_address		= nlm_xlp_nae_set_hwaddr,
+	.ndo_set_mac_address		= nlm_xlp_nae_set_hwaddr,
 	.ndo_get_stats 			= nlm_xlp_mac_get_stats,
 	.ndo_select_queue		= nlm_select_queue,
 };
-- 
1.9.1

