From 52df46d4ec2dd835a0b9456ca8e08ef6d88aaa38 Mon Sep 17 00:00:00 2001
From: Hareesh Ramachandran <hareesh@london.(none)>
Date: Thu, 2 Feb 2012 01:58:53 -0800
Subject: [PATCH 1100/1532] Calling vfbid set function instead of taking from
 dts

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/misc/netlogic/nae-perf/xlp_nae.c | 21 +++++++++++++++++++++
 1 file changed, 21 insertions(+)

diff --git a/drivers/misc/netlogic/nae-perf/xlp_nae.c b/drivers/misc/netlogic/nae-perf/xlp_nae.c
index 63fd23e..ed9ecf8 100755
--- a/drivers/misc/netlogic/nae-perf/xlp_nae.c
+++ b/drivers/misc/netlogic/nae-perf/xlp_nae.c
@@ -1154,6 +1154,26 @@ static int nlm_xlp_napi_setup(void)
 
 
 
+static int nlm_initialize_vfbid(void)
+{
+	int cpu =0, tblidx, i = 0;
+	uint32_t vfbid_tbl[128];
+
+	/* freeback bucket vc based on hard cpu id */	
+	for (tblidx = 0; tblidx < 32 ; tblidx++, cpu++) {
+		vfbid_tbl[tblidx] = (cpu * 4) + nae_fb_vc;
+	}
+	/* from 32 points to  hard replenish */
+	for(tblidx = 32; tblidx < (32 + frin_total_queue); tblidx++, i++) {
+		vfbid_tbl[tblidx] = frin_queue_base + i;
+	}
+	/* NULL FBID Should map to cpu0 to detect NAE send message errors*/
+	vfbid_tbl[127] = 0;
+	nlm_config_vfbid_table(0, 0, 128, vfbid_tbl);    
+}
+
+
+
 
 /**********************************************************************
  * nlm_xlp_nae_init -  xlp_nae device driver init function
@@ -1222,6 +1242,7 @@ static void nlm_xlp_nae_init(void)
 
 	printk("nae_cfg frin_queue_base %d, frin_total_queue %d\n",nae_cfg->frin_queue_base, nae_cfg->frin_total_queue);
 
+	nlm_initialize_vfbid();
 	for(i = 0; i < nae_cfg->num_ports; i++)
 	{
 		/* Register only valid ports which are management */
-- 
1.9.1

