From 7cc83e04c853f2952e144ad2f639a3fb71a6747b Mon Sep 17 00:00:00 2001
From: Rahul Jain <rajain@netlogicmicro.com>
Date: Wed, 15 Feb 2012 10:19:19 +0530
Subject: [PATCH 1107/1532] nae-perf: mtu should always be cache aligned

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/misc/netlogic/nae-perf/xlp_nae.c | 8 +++-----
 1 file changed, 3 insertions(+), 5 deletions(-)

diff --git a/drivers/misc/netlogic/nae-perf/xlp_nae.c b/drivers/misc/netlogic/nae-perf/xlp_nae.c
index 8da70d48..1e5f51b 100755
--- a/drivers/misc/netlogic/nae-perf/xlp_nae.c
+++ b/drivers/misc/netlogic/nae-perf/xlp_nae.c
@@ -1312,7 +1312,7 @@ static void nlm_xlp_nae_init(void)
 	/* Update RX_CONFIG for desc size */
 	if(enable_jumbo)
 	{
-		nlm_hal_init_ingress (node, ETH_JUMBO_DATA_LEN+ETH_HLEN+ETH_FCS_LEN);
+		nlm_hal_init_ingress (node, (ETH_JUMBO_DATA_LEN+ETH_HLEN+ETH_FCS_LEN+SMP_CACHE_BYTES) & ~(SMP_CACHE_BYTES - 1));
 		num_cpu_share_freein = 4;
 		if (is_nlm_xlp8xx())
 			jumbo_freein_offset = (frin_total_queue - NUM_XLP8XX_MGMT_PORTS)/2;
@@ -1320,8 +1320,7 @@ static void nlm_xlp_nae_init(void)
 			jumbo_freein_offset = frin_total_queue/2;
 	}
 	else
-		nlm_hal_init_ingress (node, ETH_DATA_LEN+ETH_HLEN+ETH_FCS_LEN);
-
+		nlm_hal_init_ingress (node, (ETH_DATA_LEN+ETH_HLEN+ETH_FCS_LEN+SMP_CACHE_BYTES) & ~(SMP_CACHE_BYTES - 1));
 
 	printk("nae_cfg frin_queue_base %d, frin_total_queue %d\n",nae_cfg->frin_queue_base, nae_cfg->frin_total_queue);
 	printk("jumbo_freein_offset %d, num_cpu_share_freein %d\n",jumbo_freein_offset, num_cpu_share_freein);
@@ -1869,8 +1868,7 @@ static int nlm_xlp_nae_change_mtu(struct net_device *dev, int new_mtu)
 
 	spin_lock_irqsave(&priv->lock, flags);
 
-	local_mtu = new_mtu + ETH_HLEN + ETH_FCS_LEN;
-	local_mtu = (local_mtu + SMP_CACHE_BYTES) & ~(SMP_CACHE_BYTES - 1);
+	local_mtu = (new_mtu+ETH_HLEN+ETH_FCS_LEN+SMP_CACHE_BYTES) & ~(SMP_CACHE_BYTES - 1);
 
 	if(priv->type==SGMII_IF){
 		nlm_hal_set_sgmii_framesize(priv->node, priv->block, priv->index, local_mtu);
-- 
1.9.1

