From 4609931c56f0a2eb513147566f59db98a13927b4 Mon Sep 17 00:00:00 2001
From: Subhendu Sekhar Behera <sbehera@broadcom.com>
Date: Wed, 10 Dec 2014 18:48:25 +0530
Subject: [PATCH 0178/1532] cpld reset: move cpld version read to smp call for
 Multinode

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/xlp/cpld.c | 15 +++++++++------
 1 file changed, 9 insertions(+), 6 deletions(-)

diff --git a/arch/mips/netlogic/xlp/cpld.c b/arch/mips/netlogic/xlp/cpld.c
index 259d67c..7787da8 100644
--- a/arch/mips/netlogic/xlp/cpld.c
+++ b/arch/mips/netlogic/xlp/cpld.c
@@ -107,14 +107,14 @@ static void xlp_write_cpld_reg(struct xlp_cpld_data *cpld, void __iomem *reg,
 	}
 }
 
-static void xlp_print_cpld_version(struct platform_device *pdev,
-	struct xlp_cpld_data *cpld)
+static void xlp_print_cpld_version(void *data)
 {
 	u32 rev;
 	u32 maj, min;
+	struct platform_device *pdev = data;
 
-	rev = xlp_read_cpld_reg(cpld, cpld->version_reg);
-	switch (cpld->reg_io_width) {
+	rev = xlp_read_cpld_reg(&cpld_data, cpld_data.version_reg);
+	switch (cpld_data.reg_io_width) {
 	case 1:
 		min = 0;
 		maj = rev;
@@ -196,8 +196,11 @@ static int xlp_of_cpld_probe(struct platform_device *pdev)
 	_machine_restart = (void (*)(char *))xlp_of_cpld_linux_exit;
 	_machine_halt = xlp_of_cpld_linux_exit;
 	pm_power_off = xlp_of_cpld_linux_exit;
-
-	xlp_print_cpld_version(pdev, &cpld_data);
+#ifdef CONFIG_NLM_MULTINODE
+	smp_call_function_any(cpumask_of_node(0), xlp_print_cpld_version, pdev, 0);
+#else
+	xlp_print_cpld_version(pdev);
+#endif
 	return 0;
 }
 
-- 
1.9.1

