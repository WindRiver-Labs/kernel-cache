From b4027aa23ffc72a338136b6d82bf27f9e82a4747 Mon Sep 17 00:00:00 2001
From: Jayanthi A <jayanthi.annadurai@broadcom.com>
Date: Wed, 13 Nov 2013 16:04:55 -0800
Subject: [PATCH 0843/1532] netlib: Fixed interlaken calendar configuration

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/netlib/src/netsoc_config.c | 21 ++++++++++++++-------
 arch/mips/netlogic/lib/netlib/src/netsoc_nae.c    |  6 ------
 2 files changed, 14 insertions(+), 13 deletions(-)

diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_config.c b/arch/mips/netlogic/lib/netlib/src/netsoc_config.c
index d59c136..37ad0c8 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_config.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_config.c
@@ -367,7 +367,7 @@ int __netsoc_update_ucore_srclist(nae_t *nae, ucore_config_t *ucore_src, uint32_
 	return 0;
 }
 
-int __netsoc_update_context_mapping(nae_t *nae, net_port_t **cntx)
+static int __netsoc_update_context_mapping(nae_t *nae, net_port_t **cntx)
 {
         uint32_t max_ports, context, i, ctxsize, offset;
 	uint32_t poe_queue_base;
@@ -429,10 +429,11 @@ int __netsoc_update_context_mapping(nae_t *nae, net_port_t **cntx)
                         nae->cntx2port[context] = i;
 			cntx[context] = port;
                         nae->ports[i].num_free_desc /= ctxsize;
-                        nae->ports[i].num_channels = ctxsize;
+                        nae->ports[i].num_channels = 1;
                         nae->ports[i].ext_phy_addr = 0;             //cortina logical port id
                         txq = nae->ports[i].txq;
 
+		        netsoc_api_print(NETSOC_APIDBG_TRACE, "context %d ctxsize %d\n",context, ctxsize);
                         for(offset=1; offset < ctxsize; offset++) {
                                 port_num = nae->num_ports;
                                 nae->cntx2port[context + offset] = port_num;
@@ -451,11 +452,10 @@ int __netsoc_update_context_mapping(nae_t *nae, net_port_t **cntx)
 #endif
                         //if(nae->ports[i].iftype == RXAUI_IF)
                           //      nae->ports[i].iftype = XAUI_IF; /*initialization done for RXAUI. Now it`ll be considered as XAUI.*/
-
+			netsoc_api_print(NETSOC_APIDBG_TRACE, "context %d ctxsize %d\n",context, ctxsize);
                         for(offset=0; offset < ctxsize; offset++) {
                                 nae->cntx2port[context + offset] = i; /* logical port */
 				cntx[context + offset] = &nae->ports[i];
-	                        netsoc_api_print(NETSOC_APIDBG_TRACE, "save ctx:%d port:%d\n", context+offset, i);
 			}
 #ifdef NLM_HAL_LINUX_KERNEL
                }
@@ -608,8 +608,6 @@ int __netsoc_parse_and_init(void *fdt, int dom_id)
 				netsoc_api_print(NETSOC_APIDBG_ERROR,"%s: parse nae fdt failed\n",__func__);
 				return -1;
 			}
-			// update context mapping based on the port configuration
-			//__netsoc_update_context_mapping(nae, cntx2netport[node][id]);
 			
 			if (id == 0)
 				nae->pcie_base = nlm_hal_get_dev_base(node, bus, XLP_NAE_DEVICE, XLP_NAE_FUNC);
@@ -668,8 +666,17 @@ int __netsoc_parse_and_init(void *fdt, int dom_id)
 		}
 	}
 
+	retval  = __netsoc_init();
+	for(node = 0; node < max_nodes; node++) {
+        	for(id = 0;id < max_nae; id++) {
+			nae = xlp_nae[node][id];
+			if (nae != NULL)
+				__netsoc_update_context_mapping(nae, cntx2netport[node][id]);
+		}
+	}
+                //
 	dump_context_config();
 	// Initialize all networking soc blocks
-	return __netsoc_init();
+	return retval;
 }
 
diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
index 0a3a8a7..1389f86 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
@@ -39,7 +39,6 @@
 static unsigned int ucore_shared_scratch[NLM_MAX_NODES][XLP9XX_MAX_NAE_PERNODE][256];
 static unsigned int ucore_shared_scratch_words[NLM_MAX_NODES][XLP9XX_MAX_NAE_PERNODE];
 
-extern int __netsoc_update_context_mapping(nae_t *nae, net_port_t **cntx);
 extern net_port_t **cntx2netport[NLM_MAX_NODES][MAX_POE_BLOCKS];
 
 
@@ -4080,9 +4079,6 @@ static int __netsoc_init_all_ports(nae_t *nae)
 			netsoc_api_print(NETSOC_APIDBG_PORT, "Failed to initialize node %d nae %d port %d\n",nae->node, nae->nae_id, port);
 			while(1);
 		}
-		if ((nae->ports[port].iftype == INTERLAKEN_IF) && (nae->ports[port].ext_phy_addr == 0)) {
-			nae->ports[port].num_channels = 1;
-		}
 		context += contexts_allocated;
 	}
 	return NETSOC_API_SUCCESS;
@@ -4192,8 +4188,6 @@ int __netsoc_init_nae(nae_t *nae)
                 __netsoc_init_ingress(nae, 0);
                 __netsoc_init_egress(nae);
 
-		__netsoc_update_context_mapping(nae, cntx2netport[nae->node][nae->nae_id]);
-
 		if (nae->parser_enable)
 			__netsoc_enable_nae_hwparser(nae);
 
-- 
1.9.1

