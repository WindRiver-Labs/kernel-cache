From 76049aa838bb7a7f3ffde4513503145dc9d22d38 Mon Sep 17 00:00:00 2001
From: Vikas Gupta <vikasg@netlogicmicro.com>
Date: Fri, 4 Nov 2011 17:52:41 +0530
Subject: [PATCH 1087/1532] 1) Added interlaken support 2) change MTU not
 supported by interlaken 3) XAUI and SGMII MTU is set by HAL APIs.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/misc/netlogic/nae_jumbo/xlp_nae_jumbo.c | 19 ++++++++++++++-----
 1 file changed, 14 insertions(+), 5 deletions(-)

diff --git a/drivers/misc/netlogic/nae_jumbo/xlp_nae_jumbo.c b/drivers/misc/netlogic/nae_jumbo/xlp_nae_jumbo.c
index cbe72b3..ce13b29 100755
--- a/drivers/misc/netlogic/nae_jumbo/xlp_nae_jumbo.c
+++ b/drivers/misc/netlogic/nae_jumbo/xlp_nae_jumbo.c
@@ -781,6 +781,14 @@ static void nlm_xlp_nae_init(void)
 				break;	
 			case INTERLAKEN_IF:
 				priv->index = INTERLAKEN;
+				if (nae_cfg.ports[i].hw_port_id == 0) {
+                                       if (dev_alloc_name(dev, "ilk0-%d") < 0)
+                                                printk("alloc name failed \n");
+                                }
+                                else {
+                                        if (dev_alloc_name(dev, "ilk8-%d") < 0)
+                                                printk("alloc name failed \n");
+                                }
 				break;
 			default:
 				priv->index=0;
@@ -1166,23 +1174,24 @@ static int nlm_xlp_nae_change_mtu(struct net_device *dev, int new_mtu)
 	struct dev_data *priv = netdev_priv(dev);
 	unsigned long flags;
 	unsigned long local_jumbo_mtu;
-	printk("Setting mtu %d bytes \n", new_mtu);
 
 	if ((new_mtu > (DEFAULT_JUMBO_MTU * MAX_SKB_FRAGS)) || (new_mtu < MIN_ETH_FRAME_SIZE)) {
 		return -EINVAL;
 	}
+	if(priv->type==INTERLAKEN_IF){
+		return -EINVAL;
+	}
+	printk("Setting mtu %d bytes \n", new_mtu);
 
 	spin_lock_irqsave(&priv->lock, flags);
 
 	local_jumbo_mtu = new_mtu + ETH_HLEN + ETH_FCS_LEN;
 	local_jumbo_mtu = (local_jumbo_mtu + SMP_CACHE_BYTES) & ~(SMP_CACHE_BYTES - 1);
 	if(priv->type==SGMII_IF){
-		nlm_hal_write_mac_reg(priv->block, priv->index, MAX_FRM, local_jumbo_mtu);
-		printk("Max frame len set = %d bytes\n",  nlm_hal_read_mac_reg(priv->block, priv->index, MAX_FRM));
+		nlm_hal_set_sgmii_framesize(priv->block, priv->index, local_jumbo_mtu);
 	}
 	if(priv->type==XAUI_IF){
-		nlm_hal_write_mac_reg(priv->block, priv->index, XAUI_MAX_FRAME_LEN, (((local_jumbo_mtu/4)<<16) | local_jumbo_mtu));
-		printk("Max frame len set = %d bytes\n", nlm_hal_read_mac_reg(priv->block, XGMAC, XAUI_MAX_FRAME_LEN) & (0xffff));
+		nlm_hal_set_xaui_framesize(priv->block, local_jumbo_mtu, local_jumbo_mtu);
 	}
 
 	dev->mtu = new_mtu;
-- 
1.9.1

