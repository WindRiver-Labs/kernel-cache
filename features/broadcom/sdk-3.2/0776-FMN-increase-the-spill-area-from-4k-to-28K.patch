From 149db82a488567286b97e82241ecee212878bf37 Mon Sep 17 00:00:00 2001
From: Prasanna Mumbai <prasanna.mumbai@broadcom.com>
Date: Wed, 21 Aug 2013 10:26:57 +0530
Subject: [PATCH 0776/1532] FMN: increase the spill area from 4k to 28K

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c | 27 ++++++++++++++++------
 1 file changed, 20 insertions(+), 7 deletions(-)

diff --git a/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c b/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
index cb90103..8b135ea 100644
--- a/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
+++ b/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
@@ -1037,13 +1037,26 @@ int nlm_hal_setup_outq(int node, int max_nodes)
 				 * In our configuration, each VC: 4KB
 				 */
 				if (nlm_node_cfg.fmn_cfg[node]->fmn_spill_base != 0ULL) {
-					uint64_t base = (spill_base >> 18) + (qid >> 6);
-					/* carve the total fmn_spill area into all 32 VC's here */
-					val |= (1ULL << 62)       /* enable spill */
-						| (base << 29)    /* fmn base */
-						| (qid << 23) /* the last 64 cache line chunk */
-						| (qid << 17)  /* the first 64 cache line chunk */
-						;
+				/* carve the total fmn_spill area into all 32 VC's here */
+				q_spill_pages = fmn_cfg_value[qid] / (FMN_Q_PAGE_SIZE);
+				/* if spill_start + qsize crosses 256MB boundary, configuration will be wrong as
+				   only 17-12 bits only considered for spill last */
+				if(((spill_base & (FMN_MAX_Q_SIZE - 1)) +  fmn_cfg_value[qid]) > FMN_MAX_Q_SIZE)
+					spill_base = (spill_base + FMN_MAX_Q_SIZE - 1) & (~(FMN_MAX_Q_SIZE - 1));
+
+				val |= ( ((spill_base >> 18) & 0x3fffff) << 29); /* [39:18] of q_spill_base */
+
+				q_spill_start_page = (spill_base >> 12) & 0x3f; /* [17:12] of q_spill_base */
+				val |= (q_spill_start_page << 17);
+				val |= ( (q_spill_start_page + q_spill_pages - 1) << 23);
+
+#ifdef FMN_DEBUG
+				nlm_print("qid %d sb: %lx ss: %lx sl: %lx sqsize %d sqpages %d\n",
+					qid, ((val >> 29) & 0x3fffff), ((val >> 17) & 0x3f), ((val >> 23) & 0x3f),
+					fmn_cfg_value[qid], (int)q_spill_pages);
+#endif
+				spill_base +=  fmn_cfg_value[qid];
+
 				}
 #endif
 
-- 
1.9.1

