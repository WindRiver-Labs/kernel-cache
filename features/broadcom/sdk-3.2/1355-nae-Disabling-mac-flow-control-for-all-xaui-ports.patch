From b59bf88c91d0474224626760db19deeccc061274 Mon Sep 17 00:00:00 2001
From: Hareesh R <hareeshr@broadcom.com>
Date: Fri, 27 Apr 2012 00:54:42 -0700
Subject: [PATCH 1355/1532] nae: Disabling mac flow control for all xaui ports

HAL enables flow control by default. TCP performance is very low when flow
control is enabled. So disabling this from nae driver for now.
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/broadcom/nae/xlp_hw.c  | 6 ++++++
 drivers/net/ethernet/broadcom/nae/xlp_nae.c | 9 +++++++--
 2 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/broadcom/nae/xlp_hw.c b/drivers/net/ethernet/broadcom/nae/xlp_hw.c
index d75ce9b..6406810 100755
--- a/drivers/net/ethernet/broadcom/nae/xlp_hw.c
+++ b/drivers/net/ethernet/broadcom/nae/xlp_hw.c
@@ -504,6 +504,12 @@ void nlm_xlp_mac_set_enable(struct dev_data *priv, int flag)
 			}
 		}
 		nlm_hal_mac_enable(priv->node, inf, priv->type);
+		/* disabling the flow control */
+		if(priv->type == XAUI_IF) {
+			unsigned int xaui_cfg=nlm_hal_read_mac_reg(priv->node, inf, XGMAC, XAUI_CONFIG_1);
+			xaui_cfg &= (~(XAUI_CONFIG_TCTLEN | XAUI_CONFIG_RCTLEN));
+			nlm_hal_write_mac_reg(priv->node, inf, XGMAC, XAUI_CONFIG_1, xaui_cfg);
+		}
 	} else {
 		nlm_hal_mac_disable(priv->node, inf, priv->type);
 	}
diff --git a/drivers/net/ethernet/broadcom/nae/xlp_nae.c b/drivers/net/ethernet/broadcom/nae/xlp_nae.c
index 11472d3..2dae935 100755
--- a/drivers/net/ethernet/broadcom/nae/xlp_nae.c
+++ b/drivers/net/ethernet/broadcom/nae/xlp_nae.c
@@ -823,7 +823,8 @@ static void xlp_poll_upper(int cpu)
 	uint32_t src_id = 0, size, code;
 	unsigned long __attribute__ ((unused)) mflags;
 
-	if(nae_rx_vc == nae_fb_vc)
+	/* In non-exlusivevc , this vc can be shared with some other moduels */
+	if((nae_rx_vc == nae_fb_vc) || (!exclusive_vc))
 		return;
 	
 	while (1) {
@@ -910,7 +911,7 @@ static void nlm_xlp_nae_msgring_handler(uint32_t vc, uint32_t src_id,
 }
 
 /*
- * Main NAE poll loop
+ * Main NAE napi poll loop for exclusive vc handler
  */
 
 static int xlp_nae_napi_poll(int vc, int budget)
@@ -926,6 +927,9 @@ static int xlp_nae_napi_poll(int vc, int budget)
 	return rx_pkts;
 }
 
+/*
+ * Main NAE  poll loop for kthread model
+ */
 static int xlp_nae_poll(void *buf)
 {
 	//unsigned int count=0;
@@ -1169,6 +1173,7 @@ static void nlm_xlp_nae_init(void)
 
 	if(!enable_napi) {
 		nlm_xlp_disable_napi();
+		exclusive_vc = 1;
 		/*spawn percpu kthread*/
 		nlm_spawn_kthread();
 	}
-- 
1.9.1

