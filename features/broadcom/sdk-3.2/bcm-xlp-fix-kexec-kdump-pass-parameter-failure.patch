From d4d4cce6aa2c55d23fb0e7168925da649110ba8c Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Mon, 27 Apr 2015 14:04:57 +0800
Subject: [PATCH] bcm-xlp: fix kexec/kdump pass parameter failure

When booting the second kernel of kexec/kdump, the first kernel
use "--append=" to pass parameter but it always failed. So add
the implementation of passing parameters to the second kernel.

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/netlogic/xlp/setup.c |   18 +++++++++++++++++-
 1 files changed, 17 insertions(+), 1 deletions(-)

diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index d847ad2..6416a86 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -53,6 +53,7 @@
 uint64_t nlm_io_base;
 EXPORT_SYMBOL(nlm_io_base);
 
+char kexec_cmdline[MAX_PROP_LEN] __initdata;
 struct nlm_soc_info nlm_nodes[NLM_NR_NODES];
 cpumask_t nlm_cpumask = CPU_MASK_CPU0;
 unsigned int nlm_threads_per_core;
@@ -122,7 +123,10 @@ void __init plat_mem_setup(void)
 
 	/* memory and bootargs from DT */
 	early_init_devtree(initial_boot_params);
-
+#ifdef CONFIG_KEXEC
+	if (is_kexec_boot())
+		strncpy(arcs_cmdline, kexec_cmdline, MAX_PROP_LEN);
+#endif
 	if (boot_mem_map.nr_map == 0) {
 		pr_info("Using DRAM BARs for memory map.\n");
 		xlp_init_mem_from_bars();
@@ -189,6 +193,15 @@ void nlm_percpu_init(int hwcpuid)
 
 #ifdef CONFIG_KEXEC
 extern void nlm_kexec_init(void);
+void nlm_kexec_cmdline_init(void)
+{
+	void *kexec_cmdline_addr;
+
+	kexec_cmdline_addr = (void *)kexec_cmdline_addr(fw_arg0);
+	if (is_kexec_boot()) {
+		strncpy(kexec_cmdline, (char *)kexec_cmdline_addr, MAX_PROP_LEN);
+	}
+}
 #endif
 void __init prom_init(void)
 {
@@ -202,6 +215,9 @@ void __init prom_init(void)
 	nlm_init_boot_cpu();
 	xlp_mmu_init();
 	nlm_node_init(0);
+#ifdef CONFIG_KEXEC
+	nlm_kexec_cmdline_init();
+#endif
 	xlp_dt_init((void *)(long)fw_arg0);
 
 	/* Update reset entry point with CPU init code */
-- 
1.7.5.4

