From d3fb8d9f5ac86c3d6f52470a988d0de7f00dc430 Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Thu, 5 Mar 2015 13:36:52 +0800
Subject: [PATCH] filescontrol.c: protect files_fdtable with
 rcu_read_lock/unlock()

Otherwise, we get below call trace:

[ INFO: suspicious RCU usage. ]
3.14.29ltsi-WR7.0.0.0_standard #1 Not tainted
-------------------------------
fs/filescontrol.c:87 suspicious rcu_dereference_check() usage!

other info that might help us debug this:

rcu_scheduler_active = 1, debug_locks = 0
4 locks held by lxc-start/3784:
 #0:  (sb_writers#7){.+.+.+}, at: [<ffffffff811c783b>] vfs_write+0x19b/0x1b0
 #1:  (cgroup_mutex){+.+.+.}, at: [<ffffffff810eb01b>] cgroup_lock_live_group+0x1b/0x40
 #2:  (&sig->group_rwsem){++++++}, at: [<ffffffff810ef1b2>] attach_task_by_pid+0xd2/0x450
 #3:  (&(&p->alloc_lock)->rlock){+.+...}, at: [<ffffffff8122f9d9>] files_cgroup_can_attach+0x49/0x100

stack backtrace:
CPU: 0 PID: 3784 Comm: lxc-start Not tainted 3.14.29ltsi-WR7.0.0.0_standard #1
Hardware name: Dell Inc. OptiPlex 755                 /0Y255C, BIOS A11 08/04/2008
 0000000000000001 ffff88004efffd18 ffffffff81ac6ad0 ffff880075688000
 ffff88004efffd48 ffffffff810a94b7 ffff880000108590 ffff880000108580
 0000000000000000 ffff88004efffdf8 ffff88004efffd68 ffffffff8122f60f
Call Trace:
 [<ffffffff81ac6ad0>] dump_stack+0x4e/0x7a
 [<ffffffff810a94b7>] lockdep_rcu_suspicious+0xe7/0x120
 [<ffffffff8122f60f>] files_cgroup_count_fds+0x9f/0xd0
 [<ffffffff8122f9e5>] files_cgroup_can_attach+0x55/0x100
 [<ffffffff810eea63>] cgroup_attach_task+0x283/0x820
 [<ffffffff810ee8a0>] ? cgroup_attach_task+0xc0/0x820
 [<ffffffff810ef3e8>] attach_task_by_pid+0x308/0x450
 [<ffffffff810ef1e7>] ? attach_task_by_pid+0x107/0x450
 [<ffffffff810ef546>] cgroup_tasks_write+0x16/0x20
 [<ffffffff810ebc18>] cgroup_file_write+0x128/0x1c0
 [<ffffffff811c7756>] vfs_write+0xb6/0x1b0
 [<ffffffff811c80ad>] SyS_write+0x4d/0xc0
 [<ffffffff81adb756>] system_call_fastpath+0x1a/0x1f

Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 fs/filescontrol.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/fs/filescontrol.c b/fs/filescontrol.c
index 0ba8ffa..b6a7480 100644
--- a/fs/filescontrol.c
+++ b/fs/filescontrol.c
@@ -84,9 +84,11 @@ u64 files_cgroup_count_fds(struct files_struct *files)
 	struct fdtable *fdt;
 	int retval = 0;
 
+	rcu_read_lock();
 	fdt = files_fdtable(files);
 	for (i = 0; i < DIV_ROUND_UP(fdt->max_fds, BITS_PER_LONG); i++)
 		retval += hweight64((__u64)fdt->open_fds[i]);
+	rcu_read_unlock();
 	return retval;
 }
 
-- 
1.7.5.4

