From 2aad9886efadbee44ecb096bc168eb6612b7722a Mon Sep 17 00:00:00 2001
From: Johannes Berg <johannes.berg@intel.com>
Date: Thu, 29 Nov 2012 01:25:20 +0100
Subject: [PATCH 28/34] cfg80211: fix BSS struct IE access races

Upstream: 9caf03640279e

When a BSS struct is updated, the IEs are currently
overwritten or freed. This can lead to races if some
other CPU is accessing the BSS struct and using the
IEs concurrently.

Fix this by always allocating the IEs in a new struct
that holds the data and length and protecting access
to this new struct with RCU.

Signed-off-by: Johannes Berg <johannes.berg@intel.com>
[ywei: fix context conflict]
Signed-off-by: Yunguo Wei <yunguo.wei@windriver.com>
---
 drivers/net/wireless/mwifiex/sta_ioctl.c | 18 ++++++++++++++----
 1 file changed, 14 insertions(+), 4 deletions(-)

diff --git a/drivers/net/wireless/mwifiex/sta_ioctl.c b/drivers/net/wireless/mwifiex/sta_ioctl.c
index 7e5600f..4b7d115 100644
--- a/drivers/net/wireless/mwifiex/sta_ioctl.c
+++ b/drivers/net/wireless/mwifiex/sta_ioctl.c
@@ -190,10 +190,11 @@ int mwifiex_fill_new_bss_desc(struct mwifiex_private *priv,
 int mwifiex_bss_start(struct mwifiex_private *priv, struct cfg80211_bss *bss,
 		      struct cfg80211_ssid *req_ssid)
 {
-	int ret;
+	int ret, beacon_ie_len;
 	struct mwifiex_adapter *adapter = priv->adapter;
 	struct mwifiex_bssdescriptor *bss_desc = NULL;
 	u8 *beacon_ie = NULL;
+	const struct cfg80211_bss_ies *ies;
 
 	priv->scan_block = false;
 
@@ -206,8 +207,17 @@ int mwifiex_bss_start(struct mwifiex_private *priv, struct cfg80211_bss *bss,
 			return -ENOMEM;
 		}
 
-		beacon_ie = kmemdup(bss->information_elements,
-					bss->len_beacon_ies, GFP_KERNEL);
+		rcu_read_lock();
+		ies = rcu_dereference(bss->ies);
+		if (WARN_ON(!ies)) {
+			/* should never happen */
+			rcu_read_unlock();
+			return -EINVAL;
+		}
+		beacon_ie = kmemdup(ies->data, ies->len, GFP_ATOMIC);
+		beacon_ie_len = ies->len;
+		rcu_read_unlock();
+
 		if (!beacon_ie) {
 			kfree(bss_desc);
 			dev_err(priv->adapter->dev, " failed to alloc beacon_ie\n");
@@ -215,7 +225,7 @@ int mwifiex_bss_start(struct mwifiex_private *priv, struct cfg80211_bss *bss,
 		}
 
 		ret = mwifiex_fill_new_bss_desc(priv, bss->bssid, bss->signal,
-						beacon_ie, bss->len_beacon_ies,
+						beacon_ie, bss->ies->len,
 						bss->beacon_interval,
 						bss->capability,
 						*(u8 *)bss->priv, bss_desc);
-- 
1.8.1.2

