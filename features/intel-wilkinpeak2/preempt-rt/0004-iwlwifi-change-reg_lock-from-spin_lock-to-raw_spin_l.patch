From 2b581a06f95f1e1037e75375f76b10e634fcff1b Mon Sep 17 00:00:00 2001
From: Yunguo Wei <yunguo.wei@windriver.com>
Date: Thu, 15 Aug 2013 12:11:56 +0800
Subject: [PATCH 39/41] iwlwifi: change reg_lock from spin_lock to
 raw_spin_lock

iwl_pcie_nic_init() calls iwl_pcie_apm_init while holding the irq_lock,
since irq_lock is a raw_spin_lock, the following call trace is shown:

BUG: sleeping function called from invalid context at
/home/ywei/workspace/projects/0809-wifi-pt/bitbake_build/tmp/work/intel_xeon_core_haswell-wrs-linux/linux-windriver-3.4-r0/linux/kernel/rtmutex.c:658
in_atomic(): 1, irqs_disabled(): 1, pid: 1028, name: modprobe
 [<ffffffff81070fbe>] __might_sleep+0xce/0x100
 [<ffffffff81824a34>] rt_spin_lock+0x24/0x50
 [<ffffffffa00c4ff1>] iwl_trans_pcie_set_bits_mask+0x41/0x80 [iwlwifi]
 [<ffffffffa00c5bfe>] iwl_pcie_apm_init+0x4e/0x210 [iwlwifi]
 [<ffffffff81824ebd>] ? _raw_spin_lock_irqsave+0x1d/0x50
 [<ffffffffa00c6358>] iwl_trans_pcie_start_fw+0xe8/0x770 [iwlwifi]
 [<ffffffff8104770e>] ? local_bh_enable+0x4e/0x160
 [<ffffffffa0017037>] iwl_mvm_init+0x37/0x59 [iwlmvm]
 [<ffffffff810002b2>] do_one_initcall+0x122/0x170
 [<ffffffff810a2ab4>] sys_init_module+0xee4/0x1e90
 [<ffffffff8182c5d6>] system_call_fastpath+0x1a/0x1f

Signed-off-by: Yunguo Wei <yunguo.wei@windriver.com>
---
 drivers/net/wireless/iwlwifi/pcie/internal.h |  2 +-
 drivers/net/wireless/iwlwifi/pcie/trans.c    | 12 ++++++------
 2 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/drivers/net/wireless/iwlwifi/pcie/internal.h b/drivers/net/wireless/iwlwifi/pcie/internal.h
index bcdc137..710cc51 100644
--- a/drivers/net/wireless/iwlwifi/pcie/internal.h
+++ b/drivers/net/wireless/iwlwifi/pcie/internal.h
@@ -312,7 +312,7 @@ struct iwl_trans_pcie {
 	unsigned long wd_timeout;
 
 	/*protect hw register */
-	spinlock_t reg_lock;
+	raw_spinlock_t reg_lock;
 };
 
 /**
diff --git a/drivers/net/wireless/iwlwifi/pcie/trans.c b/drivers/net/wireless/iwlwifi/pcie/trans.c
index a795221..9689663 100644
--- a/drivers/net/wireless/iwlwifi/pcie/trans.c
+++ b/drivers/net/wireless/iwlwifi/pcie/trans.c
@@ -840,7 +840,7 @@ static bool iwl_trans_pcie_grab_nic_access(struct iwl_trans *trans, bool silent,
 	int ret;
 	struct iwl_trans_pcie *trans_pcie = IWL_TRANS_GET_PCIE_TRANS(trans);
 
-	spin_lock_irqsave(&trans_pcie->reg_lock, *flags);
+	raw_spin_lock_irqsave(&trans_pcie->reg_lock, *flags);
 
 	/* this bit wakes up the NIC */
 	__iwl_trans_pcie_set_bit(trans, CSR_GP_CNTRL,
@@ -876,7 +876,7 @@ static bool iwl_trans_pcie_grab_nic_access(struct iwl_trans *trans, bool silent,
 			WARN_ONCE(1,
 				  "Timeout waiting for hardware access (CSR_GP_CNTRL 0x%08x)\n",
 				  val);
-			spin_unlock_irqrestore(&trans_pcie->reg_lock, *flags);
+			raw_spin_unlock_irqrestore(&trans_pcie->reg_lock, *flags);
 			return false;
 		}
 	}
@@ -911,7 +911,7 @@ static void iwl_trans_pcie_release_nic_access(struct iwl_trans *trans,
 	 * scheduled on different CPUs (after we drop reg_lock).
 	 */
 	mmiowb();
-	spin_unlock_irqrestore(&trans_pcie->reg_lock, *flags);
+	raw_spin_unlock_irqrestore(&trans_pcie->reg_lock, *flags);
 }
 
 static int iwl_trans_pcie_read_mem(struct iwl_trans *trans, u32 addr,
@@ -1028,9 +1028,9 @@ static void iwl_trans_pcie_set_bits_mask(struct iwl_trans *trans, u32 reg,
 	struct iwl_trans_pcie *trans_pcie = IWL_TRANS_GET_PCIE_TRANS(trans);
 	unsigned long flags;
 
-	spin_lock_irqsave(&trans_pcie->reg_lock, flags);
+	raw_spin_lock_irqsave(&trans_pcie->reg_lock, flags);
 	__iwl_trans_pcie_set_bits_mask(trans, reg, mask, value);
-	spin_unlock_irqrestore(&trans_pcie->reg_lock, flags);
+	raw_spin_unlock_irqrestore(&trans_pcie->reg_lock, flags);
 }
 
 static const char *get_fh_string(int cmd)
@@ -1494,7 +1494,7 @@ struct iwl_trans *iwl_trans_pcie_alloc(struct pci_dev *pdev,
 	trans_lockdep_init(trans);
 	trans_pcie->trans = trans;
 	raw_spin_lock_init(&trans_pcie->irq_lock);
-	spin_lock_init(&trans_pcie->reg_lock);
+	raw_spin_lock_init(&trans_pcie->reg_lock);
 	init_waitqueue_head(&trans_pcie->ucode_write_waitq);
 
 	/* W/A - seems to solve weird behavior. We need to remove this if we
-- 
1.8.1.2

