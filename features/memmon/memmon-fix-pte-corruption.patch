From 231595a03b605855a4998328c67cd2e4637b78b8 Mon Sep 17 00:00:00 2001
From: Yongli He <yongli.he@windriver.com>
Date: Mon, 4 Aug 2008 16:34:17 +0800
Subject: [PATCH] memmon:fix pte corruption

Signed-off-by: Cao Qingtao <qingtao.cao@windriver.com>
Integrated-by: Yongli he   <yongli.he@windriver.com>
---
 mm/memmon.c |    9 ++++-----
 1 files changed, 4 insertions(+), 5 deletions(-)

diff --git a/mm/memmon.c b/mm/memmon.c
index 5957493..57b2834 100644
--- a/mm/memmon.c
+++ b/mm/memmon.c
@@ -531,11 +531,6 @@ int memmon_collect_data(struct mm_struct *mm, struct memmon_info *args)
 			__put_user(addr, buf);
 			buf++;
 
-			/* Handle option to stop early. */
-			if ((page_count == entries) &&
-				(options & STOP_WHEN_BUF_FULL))
-				addr=end+1;
-
 			/* Handle option to clean the page. */
 			if (options & CLEAN_STORED_PAGES)
 				need_clean=1;
@@ -560,6 +555,10 @@ int memmon_collect_data(struct mm_struct *mm, struct memmon_info *args)
 #endif
               }
 
+		/* Handle option to stop early. */
+		if ((page_count == entries) && (options & STOP_WHEN_BUF_FULL))
+			addr=end+1;
+
 unmap_continue:
 		if (ptep)
 			pte_unmap(ptep);
-- 
1.5.5.1

