From 3bec49b52799007bd07d3d5842ca7a2df9a6f0a5 Mon Sep 17 00:00:00 2001
From: Ivar Holmqvist <ivarholmqvist@gmail.com>
Date: Tue, 17 Jul 2012 18:37:22 +0200
Subject: [PATCH 19/22] qsp-ppc: Changed from specifying mtd physmap in config to dts.

[Original patch is from simics-pkg-12514-4.8.1-linux64.tar]

Signed-off-by: Ruan Zhengwang <zhengwang.ruan@windriver.com>
---
 arch/powerpc/boot/dts/qsp.dts      |   20 ++++++++++++++++++++
 arch/powerpc/configs/qsp_defconfig |   10 ++++------
 2 files changed, 24 insertions(+), 6 deletions(-)

diff --git a/arch/powerpc/boot/dts/qsp.dts b/arch/powerpc/boot/dts/qsp.dts
index ca396a6..5fcf712 100644
--- a/arch/powerpc/boot/dts/qsp.dts
+++ b/arch/powerpc/boot/dts/qsp.dts
@@ -1443,6 +1443,26 @@
 		reg = <0x0 0x20000000>;
 	};
 
+	flash@0xd0000000 {
+		#address-cells = <2>;
+		#size-cells = <1>;
+		compatible = "simple-bus";
+		ranges = <0 0 0xd0000000 0x10000000>;
+		qsp_flash@0,0 {
+					compatible = "qsp-flash";
+					bank-width = <2>;
+					reg = <0 0x00000000 0x10000000>;
+					#address-cells = <1>;
+					#size-cells = <1>;
+					partition@0 {
+						label = "entire_flash";
+						reg = <0x00000000 0x10000000>;
+					};
+
+
+				   };
+	 };
+
 	soc@0xe0000000 {
 		#address-cells = <2>;
 		#size-cells = <1>;
diff --git a/arch/powerpc/configs/qsp_defconfig b/arch/powerpc/configs/qsp_defconfig
index 116873e..b1a1109 100644
--- a/arch/powerpc/configs/qsp_defconfig
+++ b/arch/powerpc/configs/qsp_defconfig
@@ -493,8 +493,8 @@ CONFIG_PREVENT_FIRMWARE_BUILD=y
 CONFIG_MTD=y
 # CONFIG_MTD_TESTS is not set
 # CONFIG_MTD_REDBOOT_PARTS is not set
-# CONFIG_MTD_CMDLINE_PARTS is not set
-# CONFIG_MTD_OF_PARTS is not set
+CONFIG_MTD_CMDLINE_PARTS=y
+CONFIG_MTD_OF_PARTS=y
 # CONFIG_MTD_AR7_PARTS is not set
 
 #
@@ -538,10 +538,8 @@ CONFIG_MTD_QSP_FLASH=y
 #
 # CONFIG_MTD_COMPLEX_MAPPINGS is not set
 CONFIG_MTD_PHYSMAP=y
-CONFIG_MTD_PHYSMAP_COMPAT=y
-CONFIG_MTD_PHYSMAP_START=0xd0000000
-CONFIG_MTD_PHYSMAP_LEN=0x10000000
-CONFIG_MTD_PHYSMAP_BANKWIDTH=4
+# CONFIG_MTD_PHYSMAP_COMPAT is not set
+CONFIG_MTD_PHYSMAP_OF=y
 # CONFIG_MTD_PLATRAM is not set
 
 #
-- 
1.7.1

