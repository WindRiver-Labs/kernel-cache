From a8f82935b1619334b1a175d87357b7831f3ae494 Mon Sep 17 00:00:00 2001
From: Ivar Holmqvist <ivarholmqvist@gmail.com>
Date: Tue, 17 Jul 2012 18:38:35 +0200
Subject: [PATCH 18/22] qsp-flash: Allow PHYSMAP_OF (i.e specifying physaddr of flash in dts) support for qsp-flash.

[Original patch is from simics-pkg-12514-4.8.1-linux64.tar]

Signed-off-by: Ruan Zhengwang <zhengwang.ruan@windriver.com>
---
 drivers/mtd/chips/qsp-flash.c |    2 +-
 drivers/mtd/maps/Kconfig      |    2 +-
 drivers/mtd/maps/physmap_of.c |    4 ++++
 3 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/mtd/chips/qsp-flash.c b/drivers/mtd/chips/qsp-flash.c
index c5f1781..6683671 100644
--- a/drivers/mtd/chips/qsp-flash.c
+++ b/drivers/mtd/chips/qsp-flash.c
@@ -46,7 +46,7 @@ static unsigned long qsp_flash_unmapped_area(struct mtd_info *, unsigned long,
 
 static struct mtd_chip_driver qsp_flash_chipdrv = {
 	.probe	= qsp_flash_probe,
-	.name	= "qsp-flash",
+	.name	= "qsp-probe",
 	.module	= THIS_MODULE
 };
 
diff --git a/drivers/mtd/maps/Kconfig b/drivers/mtd/maps/Kconfig
index b5529f2..630cf32 100644
--- a/drivers/mtd/maps/Kconfig
+++ b/drivers/mtd/maps/Kconfig
@@ -67,7 +67,7 @@ config MTD_PHYSMAP_BANKWIDTH
 
 config MTD_PHYSMAP_OF
 	tristate "Flash device in physical memory map based on OF description"
-	depends on OF && (MTD_CFI || MTD_JEDECPROBE || MTD_ROM)
+	depends on OF && (MTD_CFI || MTD_JEDECPROBE || MTD_ROM || MTD_QSP_FLASH)
 	help
 	  This provides a 'mapping' driver which allows the NOR Flash and
 	  ROM driver code to communicate with chips which are mapped
diff --git a/drivers/mtd/maps/physmap_of.c b/drivers/mtd/maps/physmap_of.c
index 2e6fb68..7171fac 100644
--- a/drivers/mtd/maps/physmap_of.c
+++ b/drivers/mtd/maps/physmap_of.c
@@ -324,6 +324,10 @@ static struct of_device_id of_flash_match[] = {
 		.type		= "rom",
 		.compatible	= "direct-mapped"
 	},
+	{
+		.compatible     = "qsp-flash",
+		.data	= (void *)"qsp-probe"
+	},
 	{ },
 };
 MODULE_DEVICE_TABLE(of, of_flash_match);
-- 
1.7.1

