From f653ca28e591c05e6d183d53438ed2cf93366908 Mon Sep 17 00:00:00 2001
From: Pravin B Shelar <pshelar@nicira.com>
Date: Fri, 22 Feb 2013 07:30:30 +0000
Subject: [PATCH 32/39] IP_GRE: Fix IP-Identification.

commit 490ab08127cebc25e3a260a74556b56ce5f47c0f upstream.

GRE-GSO generates ip fragments with id 0,2,3,4... for every
GSO packet, which is not correct. Following patch fixes it
by setting ip-header id unique id of fragments are allowed.
As Eric Dumazet suggested it is optimized by using inner ip-header
whenever inner packet is ipv4.

[ Michel: keep only the definition of tunnel_ip_select_ident() for use
by vxlan ]

Signed-off-by: Michel Thebeau <michel.thebeau@windriver.com>
Signed-off-by: Pravin B Shelar <pshelar@nicira.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
---
 include/net/ipip.h |   19 +++++++++++++++++++
 1 file changed, 19 insertions(+)

diff --git a/include/net/ipip.h b/include/net/ipip.h
index a32654d..994672b 100644
--- a/include/net/ipip.h
+++ b/include/net/ipip.h
@@ -64,4 +64,23 @@ struct ip_tunnel_prl_entry {
 
 #define IPTUNNEL_XMIT() __IPTUNNEL_XMIT(txq, stats)
 
+#ifdef CONFIG_VXLAN
+static inline void tunnel_ip_select_ident(struct sk_buff *skb,
+					  const struct iphdr  *old_iph,
+					  struct dst_entry *dst)
+{
+	struct iphdr *iph = ip_hdr(skb);
+
+	if (iph->frag_off & htons(IP_DF))
+		iph->id	= 0;
+	else {
+		/* Use inner packet iph-id if possible. */
+		if (skb->protocol == htons(ETH_P_IP) && old_iph->id)
+			iph->id	= old_iph->id;
+		else
+			__ip_select_ident(iph, dst,
+					  (skb_shinfo(skb)->gso_segs ?: 1) - 1);
+	}
+}
+#endif /* CONFIG_VXLAN */
 #endif
-- 
1.7.9.7

