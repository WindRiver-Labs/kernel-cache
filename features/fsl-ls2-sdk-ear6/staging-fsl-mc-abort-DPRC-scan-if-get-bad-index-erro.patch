From 52a80e2c110096b5c279e66a4a2b95ca3f25f7d9 Mon Sep 17 00:00:00 2001
From: Stuart Yoder <stuart.yoder@freescale.com>
Date: Fri, 17 Jul 2015 13:42:44 -0500
Subject: [PATCH 097/452] staging: fsl-mc: abort DPRC scan if get bad index
 error

If we receive an -ENXIO error back from dprc_get_obj during
a bus scan it means that indexes have changed in the DPRC
and we need to abort.  Whatever the change was will force
a new rescan.

Signed-off-by: Stuart Yoder <stuart.yoder@freescale.com>
[Xulin: Original patch taken from FSL LS2085 SDK EAR6.0,
LS2085A-SDK-SOURCE-20160304-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 drivers/staging/fsl-mc/bus/dprc-driver.c |   13 ++++++++++++-
 1 files changed, 12 insertions(+), 1 deletions(-)

diff --git a/drivers/staging/fsl-mc/bus/dprc-driver.c b/drivers/staging/fsl-mc/bus/dprc-driver.c
index 1a5eeaf..05afa9f 100644
--- a/drivers/staging/fsl-mc/bus/dprc-driver.c
+++ b/drivers/staging/fsl-mc/bus/dprc-driver.c
@@ -309,6 +309,16 @@ int dprc_scan_objects(struct fsl_mc_device *mc_bus_dev,
 					     0,
 					     mc_bus_dev->mc_handle,
 					     i, obj_desc);
+
+			/*
+			 * -ENXIO means object index was invalid.
+			 *  This is caused when the DPRC was changed at
+			 *  the MC during the scan.  In this case,
+			 *  abort the current scan.
+			 */
+			if (error == -ENXIO)
+				return error;
+
 			if (error < 0) {
 				dev_err(&mc_bus_dev->dev,
 					"dprc_get_obj(i=%d) failed: %d\n",
@@ -451,7 +461,8 @@ static irqreturn_t dprc_irq0_handler_thread(int irq_num, void *arg)
 
 		error = dprc_scan_objects(mc_dev, NULL, &irq_count);
 		if (error < 0) {
-			dev_err(dev, "dprc_scan_objects() failed: %d\n", error);
+			if (error != -ENXIO) /* don't need to report aborted scan */
+				dev_err(dev, "dprc_scan_objects() failed: %d\n", error);
 			goto out;
 		}
 
-- 
1.7.5.4

