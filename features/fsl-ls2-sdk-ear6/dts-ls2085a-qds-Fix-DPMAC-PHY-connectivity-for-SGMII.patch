From 7e23bb8366dcabda13b15bcbc59c4b1032cccd2a Mon Sep 17 00:00:00 2001
From: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
Date: Fri, 24 Jul 2015 21:44:05 +0300
Subject: [PATCH 249/452] dts/ls2085a-qds: Fix DPMAC-PHY connectivity for
 SGMII riser card

Define DPMAC-PHY links by adding a phy-handle property to those DPMAC
nodes that the current SerDes (0x2a_0x49 in this particular case)
enables.
Also remove nodes for all but one SGMII riser card, in order to quiesce
some of the quite spurious boot errors. The remaining node seems to
match some existing QDS configurations around, and it serves as
an example for future updates.

Signed-off-by: Bogdan Hamciuc <bogdan.hamciuc@freescale.com>
[Xulin: Original patch taken from FSL LS2085 SDK EAR6.0,
LS2085A-SDK-SOURCE-20160304-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 arch/arm64/boot/dts/freescale/fsl-ls2085a-qds.dts |  135 +++------------------
 1 files changed, 18 insertions(+), 117 deletions(-)

diff --git a/arch/arm64/boot/dts/freescale/fsl-ls2085a-qds.dts b/arch/arm64/boot/dts/freescale/fsl-ls2085a-qds.dts
index 49aa2a4..f962250 100644
--- a/arch/arm64/boot/dts/freescale/fsl-ls2085a-qds.dts
+++ b/arch/arm64/boot/dts/freescale/fsl-ls2085a-qds.dts
@@ -171,7 +171,7 @@
 		#address-cells = <1>;
 		#size-cells = <1>;
 		compatible = "fsl,tetra-fpga", "fsl,fpga-qixis", "simple-bus";
-		reg = <3 0 0x300>;		/* TODO check address */
+		reg = <3 0 0x300>;
 		ranges = <0 3 0 0x300>;
 
 		mdio_mux_emi1 {
@@ -183,81 +183,12 @@
 			#address-cells=<1>;
 			#size-cells = <0>;
 
-			/* Child MDIO buses, one for each riser card:
+			/* Child MDIO buses, one for each riser card available
+			   on PCIe slots:
 			   reg = 0x0, 0x20, 0x40, 0x60, 0x80, 0xa0.
-
-			   VSC8234 PHYs on the riser cards.
-			 */
-
-			/* Dirty HACK: making the phy _name_ unique, rather than
-			   relying on the uniqueness of the (dtc-generated) phandle
 			 */
-			mdio_mux0: mdio@0 {
-				reg = <0x0>;
-				#address-cells = <1>;
-				#size-cells = <0>;
-
-				mdio0_phy0: mdio_phy0@1c {
-					reg = <0x1c>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy1: mdio_phy1@1d {
-					reg = <0x1d>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy2: mdio_phy2@1e {
-					reg = <0x1e>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy3: mdio_phy3@1f {
-					reg = <0x1f>;
-					phy-connection-type = "sgmii";
-				};
-			};
-			mdio_mux1: mdio@20 {
-				reg = <0x20>;
-				#address-cells = <1>;
-				#size-cells = <0>;
-
-				mdio0_phy4: mdio_phy0@1c {
-					reg = <0x1c>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy5: mdio_phy1@1d {
-					reg = <0x1d>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy6: mdio_phy2@1e {
-					reg = <0x1e>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy7: mdio_phy3@1f {
-					reg = <0x1f>;
-					phy-connection-type = "sgmii";
-				};
-			};
-			mdio_mux2: mdio@40 {
-				reg = <0x40>;
-				#address-cells = <1>;
-				#size-cells = <0>;
 
-				mdio0_phy8: mdio_phy0@1c {
-					reg = <0x1c>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy9: mdio_phy1@1d {
-					reg = <0x1d>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy10: mdio_phy2@1e {
-					reg = <0x1e>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy11: mdio_phy3@1f {
-					reg = <0x1f>;
-					phy-connection-type = "sgmii";
-				};
-			};
+			/* This one is for PCIe Slot 4 */
 			mdio_mux3: mdio@60 {
 				reg = <0x60>;
 				#address-cells = <1>;
@@ -280,50 +211,20 @@
 					phy-connection-type = "sgmii";
 				};
 			};
-			mdio_mux4: mdio@80 {
-				reg = <0x80>;
-				#address-cells = <1>;
-				#size-cells = <0>;
-
-				mdio0_phy16: mdio_phy0@1c {
-					reg = <0x1c>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy17: mdio_phy1@1d {
-					reg = <0x1d>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy18: mdio_phy2@1e {
-					reg = <0x1e>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy19: mdio_phy3@1f {
-					reg = <0x1f>;
-					phy-connection-type = "sgmii";
-				};
-			};
-			mdio_mux5: mdio@a0 {
-				reg = <0xa0>;
-				#address-cells = <1>;
-				#size-cells = <0>;
-
-				mdio0_phy20: mdio_phy0@1c {
-					reg = <0x1c>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy21: mdio_phy1@1d {
-					reg = <0x1d>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy22: mdio_phy2@1e {
-					reg = <0x1e>;
-					phy-connection-type = "sgmii";
-				};
-				mdio0_phy23: mdio_phy3@1f {
-					reg = <0x1f>;
-					phy-connection-type = "sgmii";
-				};
-			};
 		};
 	};
 };
+
+/* Update DPMAC connections to external PHYs, under SerDes 0x2a_0x49. */
+&dpmac9 {
+	phy-handle = <&mdio0_phy12>;
+};
+&dpmac10 {
+	phy-handle = <&mdio0_phy13>;
+};
+&dpmac11 {
+	phy-handle = <&mdio0_phy14>;
+};
+&dpmac12 {
+	phy-handle = <&mdio0_phy15>;
+};
-- 
1.7.5.4

