From 441566ce87e3b7456b704aebd83abed5999b3ec7 Mon Sep 17 00:00:00 2001
From: Allan Stephens <allan.stephens@windriver.com>
Date: Wed, 10 Nov 2010 22:22:25 -0800
Subject: [PATCH 19/22] tipc: Improve handling of invalid link tolerance values

commit 82b285ab78a12281035ff0a0dc56c9d6d10562e5 from
http://tipc.cslab.ericsson.net/cgi-bin/gitweb.cgi?p=people/allan/tipc.git;a=shortlog;h=tipc1.7

Enhances TIPC link code to ignore an invalid link tolerance value
contained in an incoming LINK_PROTOCOL message, rather than
processing the value and potentially causing a divide-by-zero error.
Also adds a compile-time check that catches attempts to redefine
TIPC's minimum link tolerance value in a manner that might result
in a divide-by-zero error at run-time.

Signed-off-by: Allan Stephens <allan.stephens@windriver.com>
Integrated-by: Howard Xu <Hao.Xu@windriver.com>
---
 net/tipc/tipc_link.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/net/tipc/tipc_link.c b/net/tipc/tipc_link.c
index 42d666d..ba1ee7d 100644
--- a/net/tipc/tipc_link.c
+++ b/net/tipc/tipc_link.c
@@ -2941,10 +2941,17 @@ static void link_check_defragm_bufs(struct link *l_ptr)
 
 static void link_set_supervision_props(struct link *l_ptr, u32 tolerance)
 {
+	if ((tolerance < TIPC_MIN_LINK_TOL) || (tolerance > TIPC_MAX_LINK_TOL))
+		return;
+
 	l_ptr->tolerance = tolerance;
 	l_ptr->continuity_interval =
 		((tolerance / 4) > 500) ? 500 : tolerance / 4;
 	l_ptr->abort_limit = tolerance / (l_ptr->continuity_interval / 4);
+
+#if (TIPC_MIN_LINK_TOL < 16)
+	#error "TIPC_MIN_LINK_TOL is too small (abort limit may be NaN)"
+#endif
 }
 
 
-- 
1.6.5.2

