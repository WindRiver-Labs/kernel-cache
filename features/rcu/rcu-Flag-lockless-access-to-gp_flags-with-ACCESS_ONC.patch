From 4c28702b8ba7ece39174a6f87f38cebb7d48201f Mon Sep 17 00:00:00 2001
From: "Paul E. McKenney" <paulmck@linux.vnet.ibm.com>
Date: Thu, 8 Aug 2013 22:26:23 -0700
Subject: [PATCH] rcu: Flag lockless access to ->gp_flags with ACCESS_ONCE()

commit 591c6d1710cd73824057d08eda302cf2a7cfd18a upstream.

This commit applies ACCESS_ONCE() to an outside-of-lock access to
->gp_flags.  Although it is hard to imagine any sane compiler messing
this particular case up, the documentation benefits are substantial.
Plus the definition of "sane compiler" grows ever looser.

Signed-off-by: Paul E. McKenney <paulmck@linux.vnet.ibm.com>
Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/kernel/rcutree.c b/kernel/rcutree.c
index d9055cfdec3b..bf845c9a806f 100644
--- a/kernel/rcutree.c
+++ b/kernel/rcutree.c
@@ -1528,7 +1528,7 @@ static int __noreturn rcu_gp_kthread(void *arg)
 		/* Handle grace-period start. */
 		for (;;) {
 			swait_event_interruptible(rsp->gp_wq,
-						 rsp->gp_flags &
+						 ACCESS_ONCE(rsp->gp_flags) &
 						 RCU_GP_FLAG_INIT);
 			if (rcu_gp_init(rsp))
 				break;
-- 
1.9.0

