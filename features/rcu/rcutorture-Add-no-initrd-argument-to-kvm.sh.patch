From 73931b5ee92d013b7b7d62927cca2a8dfdf3a9d3 Mon Sep 17 00:00:00 2001
From: "Paul E. McKenney" <paulmck@linux.vnet.ibm.com>
Date: Tue, 15 Oct 2013 10:42:25 -0700
Subject: [PATCH] rcutorture: Add --no-initrd argument to kvm.sh

commit 73931b5ee92d013b7b7d62927cca2a8dfdf3a9d3 upstream.

This commit adds the --no-initrd argument to kvm.sh, which permits
initrd to be contained in a root partition specified by the --bootargs
argument.  Without --no-initrd, the kernel build expects an initrd
directory in the same rcutorture directory that contains bin and configs.

Signed-off-by: Paul E. McKenney <paulmck@linux.vnet.ibm.com>
Cc: Greg KH <gregkh@linuxfoundation.org>

diff --git a/tools/testing/selftests/rcutorture/bin/kvm-build.sh b/tools/testing/selftests/rcutorture/bin/kvm-build.sh
index 07bbecc..618ef2c 100755
--- a/tools/testing/selftests/rcutorture/bin/kvm-build.sh
+++ b/tools/testing/selftests/rcutorture/bin/kvm-build.sh
@@ -47,7 +47,7 @@ mkdir $T
 
 cat ${config_template} | grep -v CONFIG_RCU_TORTURE_TEST > $T/config
 cat << ___EOF___ >> $T/config
-CONFIG_INITRAMFS_SOURCE="$KVM/initrd"
+CONFIG_INITRAMFS_SOURCE="$RCU_INITRD"
 CONFIG_VIRTIO_PCI=y
 CONFIG_VIRTIO_CONSOLE=y
 ___EOF___
diff --git a/tools/testing/selftests/rcutorture/bin/kvm.sh b/tools/testing/selftests/rcutorture/bin/kvm.sh
index 7d6ca33..a833160 100644
--- a/tools/testing/selftests/rcutorture/bin/kvm.sh
+++ b/tools/testing/selftests/rcutorture/bin/kvm.sh
@@ -31,8 +31,9 @@ scriptname=$0
 args="$*"
 
 dur=30
-KVM=`pwd`/tools/testing/selftests/rcutorture; export KVM
-builddir=${KVM}/b1
+KVM="`pwd`/tools/testing/selftests/rcutorture"; export KVM
+builddir="${KVM}/b1"
+RCU_INITRD="$KVM/initrd"; export RCU_INITRD
 resdir=""
 configs=""
 ds=`date +%Y.%m.%d-%H:%M:%S`
@@ -49,6 +50,7 @@ usage () {
 	echo "       --interactive"
 	echo "       --kversion vN.NN"
 	echo "       --mac nn:nn:nn:nn:nn:nn"
+	echo "       --no-initrd"
 	echo "       --qemu-args qemu-system-..."
 	echo "       --qemu-cmd qemu-system-..."
 	echo "       --results absolute-pathname"
@@ -122,6 +124,9 @@ do
 		RCU_QEMU_MAC=$2; export RCU_QEMU_MAC
 		shift
 		;;
+	--no-initrd)
+		RCU_INITRD=""; export RCU_INITRD
+		;;
 	--qemu-args)
 		checkarg --qemu-args "-qemu args" $# "$2" '^-' '^error'
 		RCU_QEMU_ARG="$2"
-- 
1.8.2.3

