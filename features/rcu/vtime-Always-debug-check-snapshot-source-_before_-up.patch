From fa91fbe46516e696c9476e7ab5785dcd5a6c3a4f Mon Sep 17 00:00:00 2001
From: Frederic Weisbecker <fweisbec@gmail.com>
Date: Mon, 15 Jul 2013 16:35:55 +0200
Subject: [PATCH] vtime: Always debug check snapshot source _before_ updating
 it

commit af2350bd12096dfd04e1090b90bfecea1f75f84e upstream.

The vtime delta update performed by get_vtime_delta() always check
that the source of the snapshot is valid.

Meanhile the snapshot updaters that rely on get_vtime_delta() also
set the new snapshot origin. But some of them do this right before
the call to get_vtime_delta(), making its debug check useless.

This is easily fixable by moving the snapshot origin update after
the call to get_vtime_delta(). The order doesn't matter there.

Signed-off-by: Frederic Weisbecker <fweisbec@gmail.com>
Cc: Steven Rostedt <rostedt@goodmis.org>
Cc: Paul E. McKenney <paulmck@linux.vnet.ibm.com>
Cc: Ingo Molnar <mingo@kernel.org>
Cc: Thomas Gleixner <tglx@linutronix.de>
Cc: Peter Zijlstra <peterz@infradead.org>
Cc: Borislav Petkov <bp@alien8.de>
Cc: Li Zhong <zhong@linux.vnet.ibm.com>
Cc: Mike Galbraith <efault@gmx.de>
Cc: Kevin Hilman <khilman@linaro.org>
Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/kernel/sched/cputime.c b/kernel/sched/cputime.c
index 95afd717493b..c383a48db253 100644
--- a/kernel/sched/cputime.c
+++ b/kernel/sched/cputime.c
@@ -667,9 +667,9 @@ void vtime_gen_account_irq_exit(struct task_struct *tsk)
 {
 	raw_spin_lock(&tsk->vtime_lock);
 	write_seqcount_begin(&tsk->vtime_seq);
+	__vtime_account_system(tsk);
 	if (context_tracking_in_user())
 		tsk->vtime_snap_whence = VTIME_USER;
-	__vtime_account_system(tsk);
 	write_seqcount_end(&tsk->vtime_seq);
 	raw_spin_unlock(&tsk->vtime_lock);
 }
@@ -691,8 +691,8 @@ void vtime_user_enter(struct task_struct *tsk)
 {
 	raw_spin_lock(&tsk->vtime_lock);
 	write_seqcount_begin(&tsk->vtime_seq);
-	tsk->vtime_snap_whence = VTIME_USER;
 	__vtime_account_system(tsk);
+	tsk->vtime_snap_whence = VTIME_USER;
 	write_seqcount_end(&tsk->vtime_seq);
 	raw_spin_unlock(&tsk->vtime_lock);
 }
-- 
1.9.0

