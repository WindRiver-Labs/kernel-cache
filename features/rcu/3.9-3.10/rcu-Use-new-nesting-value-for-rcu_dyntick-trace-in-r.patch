From 64a7d7090ad6cb1ac08696bfe28f33b9e5b749e4 Mon Sep 17 00:00:00 2001
From: Li Zhong <zhong@linux.vnet.ibm.com>
Date: Tue, 27 Nov 2012 13:58:27 +0800
Subject: [PATCH] rcu: Use new nesting value for rcu_dyntick trace in
 rcu_eqs_enter_common

commit 1bdc2b7d243dc8b9aadfc8002a69cf911e9e3e72 upstream.

This patch uses the real new value of dynticks_nesting instead of 0 in
rcu_eqs_enter_common().

Signed-off-by: Li Zhong <zhong@linux.vnet.ibm.com>
Signed-off-by: Paul E. McKenney <paulmck@linux.vnet.ibm.com>
Reviewed-by: Josh Triplett <josh@joshtriplett.org>
Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/kernel/rcutree.c b/kernel/rcutree.c
index f40b387..a477b83 100644
--- a/kernel/rcutree.c
+++ b/kernel/rcutree.c
@@ -347,7 +347,7 @@ static struct rcu_node *rcu_get_root(struct rcu_state *rsp)
 static void rcu_eqs_enter_common(struct rcu_dynticks *rdtp, long long oldval,
 				bool user)
 {
-	trace_rcu_dyntick("Start", oldval, 0);
+	trace_rcu_dyntick("Start", oldval, rdtp->dynticks_nesting);
 	if (!user && !is_idle_task(current)) {
 		struct task_struct *idle = idle_task(smp_processor_id());
 
-- 
1.8.1.2

