From d0f277ea37b7c1eda96605ac82cc3f52bf1919eb Mon Sep 17 00:00:00 2001
From: Thomas Gleixner <tglx@linutronix.de>
Date: Thu, 21 Feb 2013 18:17:42 +0100
Subject: [PATCH] irq: Sanitize invoke_softirq

commit facd8b80c67a3cf64a467c4a2ac5fb31f2e6745b upstream.

With the irq protection in irq_exit, we can remove the #ifdeffery and
the bh_disable/enable dance in invoke_softirq()

Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Cc: Frederic Weisbecker <fweisbec@gmail.com>
Cc: Peter Zijlstra <peterz@infradead.org>
Cc: Ingo Molnar <mingo@kernel.org>
Cc: Paul E. McKenney <paulmck@linux.vnet.ibm.com>
Cc: Linus Torvalds <torvalds@linuxfoundation.org>
Link: http://lkml.kernel.org/r/alpine.LFD.2.02.1302202155320.22263@ionos
[PG: minor conflicts with RT_FULL ifdef/endif additions]
Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/kernel/softirq.c b/kernel/softirq.c
index 8e5fa56..707a5fb 100644
--- a/kernel/softirq.c
+++ b/kernel/softirq.c
@@ -743,17 +743,9 @@ static inline void invoke_softirq(void)
 #ifndef CONFIG_PREEMPT_RT_FULL
 	if (!force_irqthreads) {
 		lockdep_softirq_from_hardirq();
-#ifdef __ARCH_IRQ_EXIT_IRQS_DISABLED
 		__do_softirq();
-#else
-		do_softirq();
-#endif
-	} else {
-		__local_bh_disable((unsigned long)__builtin_return_address(0),
-				SOFTIRQ_OFFSET);
+	} else
 		wakeup_softirqd();
-		__local_bh_enable(SOFTIRQ_OFFSET);
-	}
 #else /* PREEMPT_RT_FULL */
 	unsigned long flags;
 
-- 
1.8.5.1

