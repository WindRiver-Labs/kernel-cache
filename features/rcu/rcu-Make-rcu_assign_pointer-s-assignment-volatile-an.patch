From fdab98d5c8e14668a14f2d877118acfe104fcd97 Mon Sep 17 00:00:00 2001
From: Josh Triplett <josh@joshtriplett.org>
Date: Sun, 1 Sep 2013 16:42:52 -0700
Subject: [PATCH] rcu: Make rcu_assign_pointer's assignment volatile and
 type-safe

commit 9d162cd06349dfee6b4f254b3abf1355cf0aee43 upstream.

The rcu_assign_pointer() primitive needs to use ACCESS_ONCE to make
the assignment to the destination pointer volatile, to protect against
compilers too clever for their own good.

Signed-off-by: Josh Triplett <josh@joshtriplett.org>
Signed-off-by: Paul E. McKenney <paulmck@linux.vnet.ibm.com>
Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/include/linux/rcupdate.h b/include/linux/rcupdate.h
index e3ee678..569efcb 100644
--- a/include/linux/rcupdate.h
+++ b/include/linux/rcupdate.h
@@ -570,7 +570,7 @@ static inline void rcu_preempt_sleep_check(void)
 #define __rcu_assign_pointer(p, v, space) \
 	do { \
 		smp_wmb(); \
-		(p) = (typeof(*v) __force space *)(v); \
+		ACCESS_ONCE(p) = (typeof(*(v)) __force space *)(v); \
 	} while (0)
 
 
-- 
1.8.2.3

