From 08a709792d8711a7516a8a11bd3cac4aa9a1796d Mon Sep 17 00:00:00 2001
From: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
Date: Tue, 7 Apr 2015 11:32:02 +0200
Subject: [PATCH 0197/1077] drm/i915: use kref_put_mutex in
 i915_gem_request_unreference__unlocked

commit b833bb61fd905a8d2c7392d1bc5fedf34921e251 upstream.

Signed-off-by: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 drivers/gpu/drm/i915/i915_drv.h | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_drv.h b/drivers/gpu/drm/i915/i915_drv.h
index b3b750b..e374306 100644
--- a/drivers/gpu/drm/i915/i915_drv.h
+++ b/drivers/gpu/drm/i915/i915_drv.h
@@ -2149,14 +2149,14 @@ i915_gem_request_unreference(struct drm_i915_gem_request *req)
 static inline void
 i915_gem_request_unreference__unlocked(struct drm_i915_gem_request *req)
 {
-	if (req && !atomic_add_unless(&req->ref.refcount, -1, 1)) {
-		struct drm_device *dev = req->ring->dev;
+	struct drm_device *dev;
+
+	if (!req)
+		return;
 
-		mutex_lock(&dev->struct_mutex);
-		if (likely(atomic_dec_and_test(&req->ref.refcount)))
-			i915_gem_request_free(&req->ref);
+	dev = req->ring->dev;
+	if (kref_put_mutex(&req->ref, i915_gem_request_free, &dev->struct_mutex))
 		mutex_unlock(&dev->struct_mutex);
-	}
 }
 
 static inline void i915_gem_request_assign(struct drm_i915_gem_request **pdst,
-- 
2.0.2

