From 91f17ddee42d1571f624e5faecc67bab9c3659bd Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ville=20Syrj=C3=A4l=C3=A4?= <ville.syrjala@linux.intel.com>
Date: Mon, 24 Feb 2014 17:02:09 +0200
Subject: [PATCH 279/479] drm/i915: Drop the forcewake count inc/dec around
 register read on VLV
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

commit fc9d83f7475ec3164ee80582555f4fe8a7847319 upstream.

VLV is the only platform where we increment/decrement the forcewake
count around register access. Drop the inc/dec on VLV to make the
forcewake code a bit more unified.

The inc/dec are not necessary since we hold the uncore lock around
the whole operation.

Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
Reviewed-by: Deepak S <deepak.s@intel.com>
Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 drivers/gpu/drm/i915/intel_uncore.c | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_uncore.c b/drivers/gpu/drm/i915/intel_uncore.c
index 37ffd5f..d98ff8e 100644
--- a/drivers/gpu/drm/i915/intel_uncore.c
+++ b/drivers/gpu/drm/i915/intel_uncore.c
@@ -518,22 +518,22 @@ gen6_read##x(struct drm_i915_private *dev_priv, off_t reg, bool trace) { \
 static u##x \
 vlv_read##x(struct drm_i915_private *dev_priv, off_t reg, bool trace) { \
 	unsigned fwengine = 0; \
-	unsigned *fwcount; \
+	unsigned fwcount; \
 	REG_READ_HEADER(x); \
 	if (FORCEWAKE_VLV_RENDER_RANGE_OFFSET(reg)) {   \
 		fwengine = FORCEWAKE_RENDER;            \
-		fwcount = &dev_priv->uncore.fw_rendercount;    \
+		fwcount = dev_priv->uncore.fw_rendercount;    \
 	}                                               \
 	else if (FORCEWAKE_VLV_MEDIA_RANGE_OFFSET(reg)) {       \
 		fwengine = FORCEWAKE_MEDIA;             \
-		fwcount = &dev_priv->uncore.fw_mediacount;     \
+		fwcount = dev_priv->uncore.fw_mediacount;     \
 	}  \
 	if (fwengine != 0) {		\
-		if ((*fwcount)++ == 0) \
+		if (fwcount == 0) \
 			(dev_priv)->uncore.funcs.force_wake_get(dev_priv, \
 								fwengine); \
 		val = __raw_i915_read##x(dev_priv, reg); \
-		if (--(*fwcount) == 0) \
+		if (fwcount == 0) \
 			(dev_priv)->uncore.funcs.force_wake_put(dev_priv, \
 							fwengine); \
 	} else { \
-- 
2.0.2

