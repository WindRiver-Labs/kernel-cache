From 212ade4d05a35f461a632003e78b58e6ce4d86fd Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ville=20Syrj=C3=A4l=C3=A4?= <ville.syrjala@linux.intel.com>
Date: Mon, 24 Feb 2014 17:02:08 +0200
Subject: [PATCH 278/479] drm/i915: Fix VLV forcewake after reset
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

commit ee7fa12ce4683e92e3ab0c43c36af5fb5f6b1054 upstream.

Use the render/media specific forcewake counts to properly restore the
forcewake status after a GPU reset on VLV.

Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
Reviewed-by: Deepak S <deepak.s@intel.com>
Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 drivers/gpu/drm/i915/intel_uncore.c | 20 ++++++++++++++++----
 1 file changed, 16 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_uncore.c b/drivers/gpu/drm/i915/intel_uncore.c
index 9cd463c..37ffd5f 100644
--- a/drivers/gpu/drm/i915/intel_uncore.c
+++ b/drivers/gpu/drm/i915/intel_uncore.c
@@ -984,10 +984,22 @@ static int gen6_do_reset(struct drm_device *dev)
 	intel_uncore_forcewake_reset(dev);
 
 	/* If reset with a user forcewake, try to restore, otherwise turn it off */
-	if (dev_priv->uncore.forcewake_count)
-		dev_priv->uncore.funcs.force_wake_get(dev_priv, FORCEWAKE_ALL);
-	else
-		dev_priv->uncore.funcs.force_wake_put(dev_priv, FORCEWAKE_ALL);
+	if (IS_VALLEYVIEW(dev)) {
+		if (dev_priv->uncore.fw_rendercount)
+			dev_priv->uncore.funcs.force_wake_get(dev_priv, FORCEWAKE_RENDER);
+		else
+			dev_priv->uncore.funcs.force_wake_put(dev_priv, FORCEWAKE_RENDER);
+
+		if (dev_priv->uncore.fw_mediacount)
+			dev_priv->uncore.funcs.force_wake_get(dev_priv, FORCEWAKE_MEDIA);
+		else
+			dev_priv->uncore.funcs.force_wake_put(dev_priv, FORCEWAKE_MEDIA);
+	} else {
+		if (dev_priv->uncore.forcewake_count)
+			dev_priv->uncore.funcs.force_wake_get(dev_priv, FORCEWAKE_ALL);
+		else
+			dev_priv->uncore.funcs.force_wake_put(dev_priv, FORCEWAKE_ALL);
+	}
 
 	/* Restore fifo count */
 	dev_priv->uncore.fifo_count = __raw_i915_read32(dev_priv, GTFIFOCTL) & GT_FIFO_FREE_ENTRIES_MASK;
-- 
2.0.2

