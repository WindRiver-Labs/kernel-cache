From 6a2e9f8a2c3fcf7dbdc342ea4b64529b5309268e Mon Sep 17 00:00:00 2001
From: Mika Kuoppala <mika.kuoppala@linux.intel.com>
Date: Fri, 31 Jan 2014 17:00:28 +0200
Subject: [PATCH 153/479] drm/i915: check for oom when allocating
 private_default_ctx

commit 7f76b23aae21890b28cf415a4f8123523a7abb24 upstream.

Found with smatch

Signed-off-by: Mika Kuoppala <mika.kuoppala@intel.com>
Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 drivers/gpu/drm/i915/i915_gem_context.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/drivers/gpu/drm/i915/i915_gem_context.c b/drivers/gpu/drm/i915/i915_gem_context.c
index 985c1ed..19fd362 100644
--- a/drivers/gpu/drm/i915/i915_gem_context.c
+++ b/drivers/gpu/drm/i915/i915_gem_context.c
@@ -489,6 +489,10 @@ int i915_gem_context_open(struct drm_device *dev, struct drm_file *file)
 		/* Cheat for hang stats */
 		file_priv->private_default_ctx =
 			kzalloc(sizeof(struct i915_hw_context), GFP_KERNEL);
+
+		if (file_priv->private_default_ctx == NULL)
+			return -ENOMEM;
+
 		file_priv->private_default_ctx->vm = &dev_priv->gtt.base;
 		return 0;
 	}
-- 
2.0.2

