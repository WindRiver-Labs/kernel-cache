From 8618df3652058afb0ae8e0efe541ca967130fa5b Mon Sep 17 00:00:00 2001
From: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
Date: Mon, 1 Jun 2015 12:49:56 +0200
Subject: [PATCH 0644/1077] drm/i915: calculate primary visibility changes
 instead of calling from set_config

commit fb9d6cf8c29bfcb0b3c602f7ded87f128d730382 upstream.

This should be much cleaner, with the same effects.

Signed-off-by: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
Reviewed-by: Matt Roper <matthew.d.roper@intel.com>
Signed-off-by: Jani Nikula <jani.nikula@intel.com>
Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 drivers/gpu/drm/i915/intel_display.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/i915/intel_display.c b/drivers/gpu/drm/i915/intel_display.c
index a09cc0c..5e76bbf 100644
--- a/drivers/gpu/drm/i915/intel_display.c
+++ b/drivers/gpu/drm/i915/intel_display.c
@@ -13609,7 +13609,7 @@ intel_check_primary_plane(struct drm_plane *plane,
 			if (IS_BROADWELL(dev))
 				intel_crtc->atomic.wait_vblank = true;
 
-			if (crtc_state)
+			if (crtc_state && !needs_modeset(&crtc_state->base))
 				intel_crtc->atomic.post_enable_primary = true;
 		}
 
-- 
2.0.2

