From 35c2a5627c6171cc6b170b1e744f7fded39f4121 Mon Sep 17 00:00:00 2001
From: Daniel Vetter <daniel.vetter@ffwll.ch>
Date: Wed, 18 Dec 2013 17:46:18 +0100
Subject: [PATCH 048/479] drm/i915: Don't check for NEEDS_GTT when deciding the
 address space

commit a7c1d426ef335ccfb6bd567a3f616fa232418fa2 upstream.

This means something different and is only relevant for gen6 and the
reason why we cant use anything else than aliasing ppgtt there.

Note that the currently implemented logic for secure batches is
broken: Userspace wants the buffer both in ppgtt (for self-referencing
relocations) and in ggtt (for priveledge operations).

This is the same issue the command parser is also facing.
Unfortunately our coverage for corner-cases of self-referencing
batches is spotty.

Note that this will break vsync'ed Xv and DRI2 copies.

Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 drivers/gpu/drm/i915/i915_gem_execbuffer.c | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gem_execbuffer.c b/drivers/gpu/drm/i915/i915_gem_execbuffer.c
index df6835b..aaad5dc 100644
--- a/drivers/gpu/drm/i915/i915_gem_execbuffer.c
+++ b/drivers/gpu/drm/i915/i915_gem_execbuffer.c
@@ -137,8 +137,7 @@ eb_lookup_vmas(struct eb_vmas *eb,
 		/* If we have secure dispatch, or the userspace assures us that
 		 * they know what they're doing, use the GGTT VM.
 		 */
-		if (exec[i].flags & EXEC_OBJECT_NEEDS_GTT ||
-		    ((args->flags & I915_EXEC_SECURE) &&
+		if (((args->flags & I915_EXEC_SECURE) &&
 		    (i == (args->buffer_count - 1))))
 			bind_vm = &dev_priv->gtt.base;
 
-- 
2.0.2

