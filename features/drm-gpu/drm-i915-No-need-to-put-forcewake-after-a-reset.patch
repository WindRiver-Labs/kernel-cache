From 47a2a6e61dfa6ae352d8dbbeb10adfaf6088b935 Mon Sep 17 00:00:00 2001
From: Mika Kuoppala <mika.kuoppala@linux.intel.com>
Date: Wed, 5 Mar 2014 18:08:18 +0200
Subject: [PATCH 307/479] drm/i915: No need to put forcewake after a reset

commit 5babf0fc26ae5596c2c113702568167fb7f8cf9b upstream.

As we now have intel_uncore_forcewake_reset() no need
to do explicit put after reset.

v2: rebase

Signed-off-by: Mika Kuoppala <mika.kuoppala@intel.com>
Reviewed-by: Ben Widawsky <ben@bwidawsk.net>
Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 drivers/gpu/drm/i915/intel_uncore.c | 19 ++++++++-----------
 1 file changed, 8 insertions(+), 11 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_uncore.c b/drivers/gpu/drm/i915/intel_uncore.c
index e196ced..202e2b2 100644
--- a/drivers/gpu/drm/i915/intel_uncore.c
+++ b/drivers/gpu/drm/i915/intel_uncore.c
@@ -954,6 +954,7 @@ static int gen6_do_reset(struct drm_device *dev)
 	struct drm_i915_private *dev_priv = dev->dev_private;
 	int	ret;
 	unsigned long irqflags;
+	u32 fw_engine = 0;
 
 	/* Hold uncore.lock across reset to prevent any register access
 	 * with forcewake not set correctly
@@ -973,25 +974,21 @@ static int gen6_do_reset(struct drm_device *dev)
 
 	intel_uncore_forcewake_reset(dev);
 
-	/* If reset with a user forcewake, try to restore, otherwise turn it off */
+	/* If reset with a user forcewake, try to restore */
 	if (IS_VALLEYVIEW(dev)) {
 		if (dev_priv->uncore.fw_rendercount)
-			dev_priv->uncore.funcs.force_wake_get(dev_priv, FORCEWAKE_RENDER);
-		else
-			dev_priv->uncore.funcs.force_wake_put(dev_priv, FORCEWAKE_RENDER);
+			fw_engine |= FORCEWAKE_RENDER;
 
 		if (dev_priv->uncore.fw_mediacount)
-			dev_priv->uncore.funcs.force_wake_get(dev_priv, FORCEWAKE_MEDIA);
-		else
-			dev_priv->uncore.funcs.force_wake_put(dev_priv, FORCEWAKE_MEDIA);
+			fw_engine |= FORCEWAKE_MEDIA;
 	} else {
 		if (dev_priv->uncore.forcewake_count)
-			dev_priv->uncore.funcs.force_wake_get(dev_priv, FORCEWAKE_ALL);
-		else
-			dev_priv->uncore.funcs.force_wake_put(dev_priv, FORCEWAKE_ALL);
+			fw_engine = FORCEWAKE_ALL;
 	}
 
-	/* Restore fifo count */
+	if (fw_engine)
+		dev_priv->uncore.funcs.force_wake_get(dev_priv, fw_engine);
+
 	if (IS_GEN6(dev) || IS_GEN7(dev))
 		dev_priv->uncore.fifo_count =
 			__raw_i915_read32(dev_priv, GTFIFOCTL) &
-- 
2.0.2

