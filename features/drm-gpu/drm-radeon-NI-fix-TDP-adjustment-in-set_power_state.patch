From 45e7d76d4150842d95255c83c028f57896987664 Mon Sep 17 00:00:00 2001
From: Alex Deucher <alexander.deucher@amd.com>
Date: Thu, 27 Jun 2013 19:08:23 -0400
Subject: [PATCH 561/904] drm/radeon/NI: fix TDP adjustment in set_power_state

commit 728cf6bb4d0d4723794dabf87b76efa3c36916ab upstream

Fixes hangs with DPM in some cases.

Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
---
 drivers/gpu/drm/radeon/ni_dpm.c | 18 +++++++++++-------
 1 file changed, 11 insertions(+), 7 deletions(-)

diff --git a/drivers/gpu/drm/radeon/ni_dpm.c b/drivers/gpu/drm/radeon/ni_dpm.c
index 5a43cb5..777d17e 100644
--- a/drivers/gpu/drm/radeon/ni_dpm.c
+++ b/drivers/gpu/drm/radeon/ni_dpm.c
@@ -3719,7 +3719,7 @@ void ni_dpm_disable(struct radeon_device *rdev)
 	ni_update_current_ps(rdev, boot_ps);
 }
 
-int ni_power_control_set_level(struct radeon_device *rdev)
+static int ni_power_control_set_level(struct radeon_device *rdev)
 {
 	struct radeon_ps *new_ps = rdev->pm.dpm.requested_ps;
 	int ret;
@@ -3736,7 +3736,9 @@ int ni_power_control_set_level(struct radeon_device *rdev)
 	ret = rv770_resume_smc(rdev);
 	if (ret)
 		return ret;
-	rv770_set_sw_state(rdev);
+	ret = rv770_set_sw_state(rdev);
+	if (ret)
+		return ret;
 
 	return 0;
 }
@@ -3801,11 +3803,6 @@ int ni_dpm_set_power_state(struct radeon_device *rdev)
 		DRM_ERROR("ni_program_memory_timing_parameters failed\n");
 		return ret;
 	}
-	ret = ni_populate_smc_tdp_limits(rdev, new_ps);
-	if (ret) {
-		DRM_ERROR("ni_populate_smc_tdp_limits failed\n");
-		return ret;
-	}
 	ret = rv770_resume_smc(rdev);
 	if (ret) {
 		DRM_ERROR("rv770_resume_smc failed\n");
@@ -3828,6 +3825,13 @@ int ni_dpm_set_power_state(struct radeon_device *rdev)
 		return ret;
 	}
 
+	/* update tdp */
+	ret = ni_power_control_set_level(rdev);
+	if (ret) {
+		DRM_ERROR("ni_power_control_set_level failed\n");
+		return ret;
+	}
+
 #if 0
 	/* XXX */
 	ret = ni_unrestrict_performance_levels_after_switch(rdev);
-- 
1.8.4.93.g57e4c17

