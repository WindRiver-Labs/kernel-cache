From 0985ab6d087e26fff808e94840d6cf8d966bee79 Mon Sep 17 00:00:00 2001
From: Thomas Gleixner <tglx@linutronix.de>
Date: Wed, 26 Aug 2009 16:17:59 +0200
Subject: [PATCH 10/22] genirq: Do not mask edge ONESHOT interrupts

commit 7f072a34719f7064189fd40d41f1b98d6bdbf653 from linux-2.6-tip

Edge type oneshot interrupts should not be masked for forced
threading. We might lose interrupts.

Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
[drop already applied hunk found in 2.6.34]
Integrated-by: Mark Asselstine <mark.asselstine@windriver.com>
---
 kernel/irq/chip.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/kernel/irq/chip.c b/kernel/irq/chip.c
index a791af0..0154bd0 100644
--- a/kernel/irq/chip.c
+++ b/kernel/irq/chip.c
@@ -582,7 +582,12 @@ handle_edge_irq(unsigned int irq, struct irq_desc *desc)
 {
 	raw_spin_lock(&desc->lock);
 
-	desc->status &= ~(IRQ_REPLAY | IRQ_WAITING);
+	/*
+	 * Edge irqs can be requested with IRQF_ONESHOT set. RT
+	 * (ab)uses this for enforced irq threading, but we do not
+	 * want to mask edge type interrupts. Clear the oneshot flag.
+	 */
+	desc->status &= ~(IRQ_REPLAY | IRQ_WAITING | IRQ_ONESHOT);
 
 	/*
 	 * If we're currently running this IRQ, or its disabled,
-- 
1.7.0

