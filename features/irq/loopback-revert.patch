From: rt-users <linux-rt-users@vger.kernel.org>  
Subject: revert loopback commit

revert this commit:

 commit 58f539740b1ccfc5ef4e509ec2efe82621b546e3
 Author: Eric Dumazet <dada1@cosmosbay.com>
 Date:   Fri Oct 20 00:32:41 2006 -0700

    [NET]: Can use __get_cpu_var() instead of per_cpu() in loopback driver.
    
    As BHs are off in loopback_xmit(), preemption cannot occurs, so we can
    use __get_cpu_var() instead of per_cpu() (and avoid a
    preempt_enable()/preempt_disable() pair)
    
    Signed-off-by: Eric Dumazet <dada1@cosmosbay.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

---
 drivers/net/loopback.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/net/loopback.c b/drivers/net/loopback.c
index 3b43bfd..dfe1184 100644
--- a/drivers/net/loopback.c
+++ b/drivers/net/loopback.c
@@ -87,11 +87,11 @@ static int loopback_xmit(struct sk_buff *skb, struct net_device *dev)
 #endif
 	dev->last_rx = jiffies;
 
-	/* it's OK to use per_cpu_ptr() because BHs are off */
 	pcpu_lstats = dev->ml_priv;
-	lb_stats = per_cpu_ptr(pcpu_lstats, smp_processor_id());
+	lb_stats = per_cpu_ptr(pcpu_lstats, get_cpu());
 	lb_stats->bytes += skb->len;
 	lb_stats->packets++;
+	put_cpu();
 
 	netif_rx(skb);
 
