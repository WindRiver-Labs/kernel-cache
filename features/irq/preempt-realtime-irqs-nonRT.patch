From: Paul Gortmaker <paul.gortmaker@windriver.com>

preempt-realtime-irqs: extract non-RT part from original patch

This portion was in the original preempt-realtime-irqs.patch but
is clearly not specific to the full realtime behaviour.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>


---
 kernel/irq/handle.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/kernel/irq/handle.c b/kernel/irq/handle.c
index 1628934..c90b0f5 100644
--- a/kernel/irq/handle.c
+++ b/kernel/irq/handle.c
@@ -246,6 +246,13 @@ unsigned int __do_IRQ(unsigned int irq)
 		desc->chip->end(irq);
 		return 1;
 	}
+	/*
+	 * If the task is currently running in user mode, don't
+	 * detect soft lockups.  If CONFIG_DETECT_SOFTLOCKUP is not
+	 * configured, this should be optimized out.
+	 */
+	if (user_mode(get_irq_regs()))
+		touch_softlockup_watchdog();
 
 	spin_lock(&desc->lock);
 	if (desc->chip->ack)
