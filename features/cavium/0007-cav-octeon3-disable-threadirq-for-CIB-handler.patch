From 2e65589a31b9991e4ead77171cb66540b96aea54 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Thu, 27 Feb 2014 14:15:34 +0800
Subject: [PATCH 7/7] cav-octeon3: disable threadirq for CIB handler

Disable threadirq for octeon3's central-interrupt unit handler. Else system
will Oops as below:

Oops[#1]:
task: ffffffff80bfd5f0 ti: ffffffff80ba0000 task.ti: ffffffff80ba0000
$ 0   : 0000000000000000 ffffffff801a7880 ffffffff80eb0000 0000000000000001
$ 4   : 0000000000000000 0000000000000001 0000000000000000 ffffffff80bfd5f0
$ 8   : 0000000000000050 ffffffff80bfe090 0000000000000000 0000000000000080
$12   : ffffffff80ba3b78 0000000000000000 0000000054000000 000000000000001e
$16   : 0000000000000000 ffffffff80af3918 ffffffff80103bc8 0000000000000000
$20   : 0000000000000059 0000000000000000 0000000000000059 ffffffff80ad1ac0
$24   : 0000000003bf0000 0000000000000000
$28   : ffffffff80ba0000 ffffffff80ba3b60 ffffffff80ba3b60 ffffffff801a7880
Hi    : 0000000000000058
Lo    : 0000000000000000
epc   : ffffffff801bc88c wake_up_process+0x24/0x70
    Not tainted
ra    : ffffffff801a7880 kthread_create_on_node+0xa8/0x120
Status: 14101ce2        KX SX UX KERNEL EXL
Cause : 40808008
BadVA : 0000000000000000
PrId  : 000d9600 (Cavium Octeon III)
Modules linked in:
Process swapper/0 (pid: 0, threadinfo=ffffffff80ba0000, task=ffffffff80bfd5f0
Stack : ffffffff80af3918 ffffffff80ba0000 ffffffff80ba3b80 ffffffff801a7880
          ffffffff80212e70 800000004ec0f000 ffffffff00000000 ffffffff80d00000
          0000000080d1c270 00000000dead4ead ffffffff00000000 ffffffffffffffff
          ffffffff80eb05f8 0000000000000000 0000000000000000 ffffffff80afeda8
          ffffffff80ba3be0 ffffffff80ba3be0 ffffffff80c3c990 ffffffff80c3c990
          800000004ec0f000 0000000000000080 ffffffff80bb0b00 800000004ec0f000
          ffffffff80ba3c50 ffffffff80214040 0000000000000059 ffffffff80ad1ac0
          0000000008000000 0000000000000080 0000000000000000 ffffffff801dfc74
          800000004ec0e060 800000004ec0f000 ffffffff80bb0b00 ffffffff80103bc8
          0000000000000000 800000004ec0e120 0000000000000000 0000000000000059
          ...
Call Trace:
[<ffffffff801bc88c>] wake_up_process+0x24/0x70
[<ffffffff801a7880>] kthread_create_on_node+0xa8/0x120
[<ffffffff80214040>] __setup_irq+0x1a8/0x568
[<ffffffff802144e0>] request_threaded_irq+0xe0/0x1e0
[<ffffffff80cb2580>] octeon_irq_init_cib+0x1ac/0x208
[<ffffffff80ce6df0>] of_irq_init+0x2ac/0x2ec
[<ffffffff80cb5f44>] init_IRQ+0x54/0x88
[<ffffffff80cac884>] start_kernel+0x268/0x52c

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/octeon-irq.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-irq.c b/arch/mips/cavium-octeon/octeon-irq.c
index c9ccecf..53acb5f 100644
--- a/arch/mips/cavium-octeon/octeon-irq.c
+++ b/arch/mips/cavium-octeon/octeon-irq.c
@@ -2756,7 +2756,7 @@ static int __init octeon_irq_init_cib(struct device_node *ciu_node,
 		return -ENOMEM;
 	}
 
-	r = request_irq(parent_irq, octeon_irq_cib_handler, 0,
+	r = request_irq(parent_irq, octeon_irq_cib_handler, IRQF_NO_THREAD,
 			"cib", cib_domain);
 	if (r) {
 		pr_err("request_irq cib failed %d\n", r);
-- 
1.7.0.4

