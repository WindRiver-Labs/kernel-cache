From c4116707428efb37b35651f2effee6fb7aaeee2c Mon Sep 17 00:00:00 2001
From: Prem Mallappa <prem.mallappa@gmail.com>
Date: Fri, 25 Oct 2013 17:59:32 +0530
Subject: [PATCH 319/382] edac/octeon_edac-lmc: Fix kernel panic when 1 DDR present

Based on SDK octeon3_3.10.

Add check to see if DDR is available.

Signed-off-by: Prem Mallappa <pmallappa@caviumnetworks.com>
Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/edac/octeon_edac-lmc.c |   12 ++++++++++++
 1 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/drivers/edac/octeon_edac-lmc.c b/drivers/edac/octeon_edac-lmc.c
index 8905370..fe88280 100644
--- a/drivers/edac/octeon_edac-lmc.c
+++ b/drivers/edac/octeon_edac-lmc.c
@@ -108,6 +108,18 @@ static int octeon_lmc_edac_probe(struct platform_device *pdev)
 
 	if (OCTEON_IS_OCTEON1PLUS()) {
 		union cvmx_lmcx_mem_cfg0 cfg0;
+		cvmx_l2c_cfg_t l2c_cfg;
+		int present = 0;
+
+		l2c_cfg.u64 = cvmx_read_csr(CVMX_L2C_CFG);
+
+		if (mc == 0)
+			present = l2c_cfg.s.dpres0;
+		else
+			present = l2c_cfg.s.dpres1;
+
+		if (!present)
+			return -ENXIO;
 
 		cfg0.u64 = cvmx_read_csr(CVMX_LMCX_MEM_CFG0(0));
 		if (!cfg0.s.ecc_ena) {
-- 
1.7.0.4

