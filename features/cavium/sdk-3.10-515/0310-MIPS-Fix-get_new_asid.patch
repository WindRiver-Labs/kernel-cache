From 14ec4927dca1d19317e4b7f6b5f7c712be09698e Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Tue, 22 Oct 2013 15:22:01 -0700
Subject: [PATCH 310/382] MIPS: Fix get_new_asid().

Based on SDK octeon3_3.10.

It wasn't properly updating the asid_cache, so repeated ASIDs were
produced.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/mmu_context.h |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/arch/mips/include/asm/mmu_context.h b/arch/mips/include/asm/mmu_context.h
index b2ed536..0ebe616 100644
--- a/arch/mips/include/asm/mmu_context.h
+++ b/arch/mips/include/asm/mmu_context.h
@@ -125,6 +125,7 @@ get_new_asid(unsigned long cpu)
 		if (!asid)		/* fix version if needed */
 			asid = ASID_FIRST_VERSION;
 	}
+	asid_cache(cpu) = asid;
 	return asid;
 }
 
@@ -132,7 +133,7 @@ static inline void
 get_new_mmu_context(struct mm_struct *mm, unsigned long cpu)
 {
 	unsigned long asid = get_new_asid(cpu);
-	cpu_context(cpu, mm) = asid_cache(cpu) = asid;
+	cpu_context(cpu, mm) = asid;
 }
 
 #else /* CONFIG_MIPS_MT_SMTC */
-- 
1.7.0.4

