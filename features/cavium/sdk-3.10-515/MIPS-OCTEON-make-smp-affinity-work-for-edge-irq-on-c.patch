From 2fd700d3b6482b1156c17514f327afa4b3b8c415 Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Thu, 22 Aug 2013 14:52:13 +0800
Subject: [PATCH 5/5] MIPS: OCTEON: make smp affinity work for edge irq on
 cn68XX interrupt controller

Round robin irq dispatch is realized for level irq,
but for edge irq it doesn't work because handle_edge_irq()
only call ->ack() for normal edge irq handling. To
make it work, realize the same mechanism in ->ack()
function.

Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 arch/mips/cavium-octeon/octeon-irq.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-irq.c b/arch/mips/cavium-octeon/octeon-irq.c
index ae47ce1..4d20cc0 100644
--- a/arch/mips/cavium-octeon/octeon-irq.c
+++ b/arch/mips/cavium-octeon/octeon-irq.c
@@ -1657,8 +1657,13 @@ static void octeon_irq_ciu2_ack(struct irq_data *data)
 	cd = irq_data_get_irq_chip_data(data);
 	mask = 1ull << (cd->bit);
 
+	/* To make smp affinity work for edge irq, realize round robin
+	 * dispatch here.
+	 */
+	octeon_irq_ciu2_disable_local(data);
 	en_addr = CVMX_CIU2_RAW_PPX_IP2_WRKQ(coreid) + (0x1000ull * cd->line);
 	cvmx_write_csr(en_addr, mask);
+	octeon_irq_ciu2_enable(data);
 
 }
 
-- 
1.7.5.4

