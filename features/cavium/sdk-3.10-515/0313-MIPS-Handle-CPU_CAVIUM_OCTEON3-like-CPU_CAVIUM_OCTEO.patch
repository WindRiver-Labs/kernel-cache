From 59d120fb51050bdb342a94154846fe63bcd1c5ba Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Tue, 22 Oct 2013 16:25:26 -0700
Subject: [PATCH 313/382] MIPS: Handle CPU_CAVIUM_OCTEON3 like CPU_CAVIUM_OCTEON2 in clear_page.

Based on SDK octeon3_3.10.

Both OCTEON3 and OCTEON2 use the same instrucitons for this.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/mm/page.c |    9 ++-------
 1 files changed, 2 insertions(+), 7 deletions(-)

diff --git a/arch/mips/mm/page.c b/arch/mips/mm/page.c
index b3afd48..402dfe4 100644
--- a/arch/mips/mm/page.c
+++ b/arch/mips/mm/page.c
@@ -284,7 +284,8 @@ void __cpuinit build_clear_page(void)
 	memset(labels, 0, sizeof(labels));
 	memset(relocs, 0, sizeof(relocs));
 
-	if (current_cpu_data.cputype == CPU_CAVIUM_OCTEON2) {
+	if (current_cpu_data.cputype == CPU_CAVIUM_OCTEON2 ||
+	    current_cpu_data.cputype == CPU_CAVIUM_OCTEON3) {
 		const unsigned int wb_nudge = 26;
 
 		pg_addiu(&buf, T0, A0, PAGE_SIZE);
@@ -292,25 +293,19 @@ void __cpuinit build_clear_page(void)
 		UASM_i_ADDIU(&buf, A1, A0, 128);
 		uasm_l_clear_pref(&l, buf);
 		uasm_i_zcbt(&buf, A0);
-		uasm_i_pref(&buf, wb_nudge, 0, A0);
 		UASM_i_ADDIU(&buf, A0, A0, 256);
 		uasm_i_zcbt(&buf, A1);
-		uasm_i_pref(&buf, wb_nudge, 0, A1);
 		UASM_i_ADDIU(&buf, A1, A1, 256);
 		uasm_i_zcbt(&buf, A0);
-		uasm_i_pref(&buf, wb_nudge, 0, A0);
 		UASM_i_ADDIU(&buf, A0, A0, 256);
 		uasm_i_zcbt(&buf, A1);
 		uasm_i_pref(&buf, wb_nudge, 0, A1);
 		UASM_i_ADDIU(&buf, A1, A1, 256);
 		uasm_i_zcbt(&buf, A0);
-		uasm_i_pref(&buf, wb_nudge, 0, A0);
 		UASM_i_ADDIU(&buf, A0, A0, 256);
 		uasm_i_zcbt(&buf, A1);
-		uasm_i_pref(&buf, wb_nudge, 0, A1);
 		UASM_i_ADDIU(&buf, A1, A1, 256);
 		uasm_i_zcbt(&buf, A0);
-		uasm_i_pref(&buf, wb_nudge, 0, A0);
 		UASM_i_ADDIU(&buf, A0, A0, 256);
 		uasm_i_zcbt(&buf, A1);
 		uasm_i_pref(&buf, wb_nudge, 0, A1);
-- 
1.7.0.4

