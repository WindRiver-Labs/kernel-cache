From 58dd41cc2c8ea2f94327a252015b320333527a4f Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 5 Jun 2013 15:43:49 -0700
Subject: [PATCH 214/382] mips/kvm: Enable MIPS VZ in Kconfig/Makefile

Based on SDK octeon3_3.10.

Also let CPU_CAVIUM_OCTEON select KVM.

Signed-off-by: David Daney <david.daney@cavium.com>
Acked-by: Ralf Baechle <ralf@linux-mips.org>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/Kconfig      |    1 +
 arch/mips/kvm/Kconfig  |   12 +++++++++++-
 arch/mips/kvm/Makefile |    1 +
 3 files changed, 13 insertions(+), 1 deletions(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index 4d97a6c..4c8d043 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -1416,6 +1416,7 @@ config CPU_CAVIUM_OCTEON
 	select LIBFDT
 	select USE_OF
 	select USB_EHCI_BIG_ENDIAN_MMIO
+	select HAVE_KVM
 	help
 	  The Cavium Octeon processor is a highly integrated chip containing
 	  many ethernet hardware widgets for networking tasks. The processor
diff --git a/arch/mips/kvm/Kconfig b/arch/mips/kvm/Kconfig
index 0f2b16e..4fe6746 100644
--- a/arch/mips/kvm/Kconfig
+++ b/arch/mips/kvm/Kconfig
@@ -21,7 +21,7 @@ config KVM
 
 config KVM_MIPS_TE
 	tristate "Kernel-based Virtual Machine (KVM) 32-bit trap-and-emulate"
-	depends on HAVE_KVM
+	depends on HAVE_KVM && 32BIT
 	select KVM
 	select ANON_INODES
 	select KVM_MMIO
@@ -48,6 +48,16 @@ config KVM_MIPS_DEBUG_COP0_COUNTERS
 
 	  If unsure, say N.
 
+config KVM_MIPS_VZ
+	bool "Kernel-based Virtual Machine (KVM) using hardware MIPS-VZ support"
+	depends on HAVE_KVM && !FAST_ACCESS_TO_THREAD_POINTER
+	select KVM
+	select EXPORT_UASM
+	---help---
+	  Support for hosting Guest kernels on hardware with the
+	  MIPS-VZ hardware module.
+
+
 source drivers/vhost/Kconfig
 
 endif # VIRTUALIZATION
diff --git a/arch/mips/kvm/Makefile b/arch/mips/kvm/Makefile
index 9f15b88..b227185 100644
--- a/arch/mips/kvm/Makefile
+++ b/arch/mips/kvm/Makefile
@@ -13,3 +13,4 @@ kvm_mipste-objs		:= kvm_mips_emul.o kvm_locore.o kvm_mips_int.o \
 
 obj-$(CONFIG_KVM)		+= $(common-objs) kvm_mips.o
 obj-$(CONFIG_KVM_MIPS_TE)	+= kvm_mipste.o
+obj-$(CONFIG_KVM_MIPS_VZ)	+= kvm_mipsvz.o kvm_mipsvz_guest.o
-- 
1.7.0.4

