From 53833e7ec8c33111c50a0e2e4be8fb791856a35c Mon Sep 17 00:00:00 2001
From: Chandrakala Chavva <cchavva@caviumnetworks.com>
Date: Thu, 17 Oct 2013 10:38:20 -0700
Subject: [PATCH 298/382] MIPS: OCTEON: Enable tlb parity error for O3

Based on SDK octeon3_3.10.

The meaning of cvmmemctl[44] changed, 0 means enabled.

Bug #8300

Signed-off-by: Chandrakala Chavva <cchavva@caviumnetworks.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/setup.c |    5 +++--
 arch/mips/kernel/genex.S        |    8 ++++++++
 2 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index 3e6d1eb..1613c2b 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -494,9 +494,10 @@ void octeon_user_io_init(void)
 	cvmmemctl.s.cvmsegenau = 0;
 
 	/* Enable TLB parity error reporting on OCTEON II */
-	if (current_cpu_type() == CPU_CAVIUM_OCTEON2 ||
-	    current_cpu_type() == CPU_CAVIUM_OCTEON3)
+	if (current_cpu_type() == CPU_CAVIUM_OCTEON2)
 		cvmmemctl.s.tlbperrena = 1;
+	else if (current_cpu_type() == CPU_CAVIUM_OCTEON3)
+		cvmmemctl.s.tlbperrena = 0;
 
 	write_c0_cvmmemctl(cvmmemctl.u64);
 
diff --git a/arch/mips/kernel/genex.S b/arch/mips/kernel/genex.S
index 3c25de6..3d70d5b 100644
--- a/arch/mips/kernel/genex.S
+++ b/arch/mips/kernel/genex.S
@@ -404,10 +404,18 @@ NESTED(nmi_handler, PT_SIZE, sp)
 	.macro	__build_clear_mce
 #ifdef CONFIG_CPU_CAVIUM_OCTEON
 	/* Disable TLB Parity checks. */
+	mfc0	t2, $15,0
+	and	t2, 0xff00
+	dli	t0, 0x9500
+	/* In Octeon3 setting bit 44 disables TLB parity */
+	slt	t2, t2, t0
 	dmfc0	t0, $11, 7
 	dli	t1, (1 << 44)
 	or	t0, t0, t1
+	beqz	t2, 11f
+	nop
 	xor	t0, t0, t1
+11:
 	dmtc0	t0, $11, 7
 #endif
 	__build_clear_cli
-- 
1.7.0.4

