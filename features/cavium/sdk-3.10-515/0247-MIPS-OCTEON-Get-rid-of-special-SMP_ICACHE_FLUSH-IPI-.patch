From 1ed27bb8eef60cfe63e0ec960550a9517cea6178 Mon Sep 17 00:00:00 2001
From: Chandrakala Chavva <cchavva@caviumnetworks.com>
Date: Wed, 21 Aug 2013 22:34:30 -0700
Subject: [PATCH 247/382] MIPS: OCTEON: Get rid of special SMP_ICACHE_FLUSH IPI message.

Based on SDK octeon3_3.10.

Use a normal cross-CPU function call instead.  The overhead is very
slightly higher, and the SMP_ICACHE_FLUSH is fairly rare (27 per CPU
per Second doing a complete GCC bootstrap).  So we can simplify things
by getting rid of the special case.  This also allows us to use the
same cache management code in a virtualized kernel where there not so
many mailboxes available.

Signed-off-by: Chandrakala Chavva <cchavva@caviumnetworks.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/mm/c-octeon.c |    7 +++----
 1 files changed, 3 insertions(+), 4 deletions(-)

diff --git a/arch/mips/mm/c-octeon.c b/arch/mips/mm/c-octeon.c
index ae1ce4b..df1f41e 100644
--- a/arch/mips/mm/c-octeon.c
+++ b/arch/mips/mm/c-octeon.c
@@ -55,7 +55,7 @@ static void octeon_local_flush_icache(void)
 static void octeon_local_flush_icache_all(void)
 {
 	mb();
-	octeon_local_flush_icache(NULL);
+	octeon_local_flush_icache();
 }
 
 /*
@@ -76,8 +76,8 @@ static void octeon_local_flush_icache_range(unsigned long start,
  */
 static void octeon_flush_icache_all_cores(struct vm_area_struct *vma)
 {
-	extern void octeon_send_ipi_single(int cpu, unsigned int action);
 #ifdef CONFIG_SMP
+	extern struct plat_smp_ops *mp_ops;	/* private */
 	int cpu;
 	cpumask_t mask;
 #endif
@@ -97,8 +97,7 @@ static void octeon_flush_icache_all_cores(struct vm_area_struct *vma)
 	else
 		mask = *cpu_online_mask;
 	cpumask_clear_cpu(cpu, &mask);
-	for_each_cpu(cpu, &mask)
-		octeon_send_ipi_single(cpu, SMP_ICACHE_FLUSH);
+	mp_ops->send_ipi_mask(&mask, SMP_ICACHE_FLUSH);
 
 	preempt_enable();
 #endif
-- 
1.7.0.4

