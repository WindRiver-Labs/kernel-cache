From 4d418063e4d10be00de692781ce5747eeee74120 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Tue, 27 Nov 2012 10:42:26 -0800
Subject: [PATCH 115/382] MIPS: OCTEON: Only use SAA instructions for CONFIG_CAVIUM_OCTEON2

Based on SDK octeon3_3.10.

On OCTEON Plus we seem to be getting:

WARNING: at kernel/rcutree.c:362 rcu_idle_enter_common.isra.31+0x104/0x110()
Modules linked in: ipv6 at24
Call Trace:
[<ffffffff80523c28>] dump_stack+0x8/0x34
[<ffffffff8014d9d0>] warn_slowpath_common+0x78/0xa8
[<ffffffff801aa884>] rcu_idle_enter_common.isra.31+0x104/0x110
[<ffffffff801ac550>] rcu_irq_exit+0xa0/0x100
[<ffffffff801045d4>] plat_irq_dispatch+0x64/0xe0
[<ffffffff801298ac>] ret_from_irq+0x0/0x4
[<ffffffff80129b60>] r4k_wait+0x20/0x40
[<ffffffff8012bbb8>] cpu_idle+0x88/0xb8

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 .../asm/mach-cavium-octeon/cpu-feature-overrides.h |   11 +++--------
 1 files changed, 3 insertions(+), 8 deletions(-)

diff --git a/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h b/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h
index 8226a08..0349d3b 100644
--- a/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h
+++ b/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h
@@ -45,9 +45,11 @@
 #define cpu_has_ic_fills_f_dc	0
 #define cpu_has_64bits		1
 #define cpu_has_octeon_cache	1
-#define cpu_has_saa		octeon_has_saa()
 #ifdef CONFIG_CAVIUM_OCTEON2
 #define cpu_has_octeon2_isa     1
+#define cpu_has_saa		1
+#else
+#define cpu_has_saa		0
 #endif
 #define cpu_has_mips32r1	0
 #define cpu_has_mips32r2	0
@@ -76,13 +78,6 @@
 #define ARCH_HAS_USABLE_BUILTIN_POPCOUNT 1
 #endif
 
-static inline int octeon_has_saa(void)
-{
-	int id;
-	asm volatile ("mfc0 %0, $15,0" : "=r" (id));
-	return id >= 0x000d0300;
-}
-
 /*
  * The last 256MB are reserved for device to device mappings and the
  * BAR1 hole.
-- 
1.7.0.4

