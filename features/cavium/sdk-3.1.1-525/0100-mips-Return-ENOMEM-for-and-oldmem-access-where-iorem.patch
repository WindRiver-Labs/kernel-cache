From c3440a474623389a867dcd19e538021ad5d27a3e Mon Sep 17 00:00:00 2001
From: Corey Minyard <cminyard@mvista.com>
Date: Mon, 3 Feb 2014 10:19:27 -0600
Subject: [PATCH 100/122] mips: Return ENOMEM for and oldmem access where
 ioremap fails

Source: Cavium Networks, Inc
MR: 5283
Type: Defect Fix
Disposition: Needs submitting to k.org
ChangeID: 6eecf1222d598a67f4cddf6bfc684d96dc2aab5d
Description:

If ioremap fails, you shouldn't really try to access the memory.  Return
ENOMEM like x86_64 does.

Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/kernel/crash_dump.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/arch/mips/kernel/crash_dump.c b/arch/mips/kernel/crash_dump.c
index 8152ed5..044f08b 100644
--- a/arch/mips/kernel/crash_dump.c
+++ b/arch/mips/kernel/crash_dump.c
@@ -34,6 +34,8 @@ ssize_t copy_oldmem_page(unsigned long pfn, char *buf,
 		return 0;
 
 	vaddr = ioremap(pfn << PAGE_SHIFT, PAGE_SIZE);
+	if (!vaddr)
+		return -ENOMEM;
 
 	if (!userbuf) {
 		memcpy(buf, (vaddr + offset), csize);
-- 
1.8.2.1

