From 0e1a4f2a498d41f66deeb7690ecd26fd3b91200a Mon Sep 17 00:00:00 2001
From: Corey Minyard <cminyard@mvista.com>
Date: Sat, 1 Feb 2014 01:10:28 -0600
Subject: [PATCH 101/122] kdump mips: Add necessary items for core extraction

Source: Cavium Networks, Inc
MR: 5283
Type: Enhancement
Disposition: Needs submitting to k.org
ChangeID: 5f42965dcc5034f8ba678ccec39a43a990e6662e
Description:

MIPS is quite complicated dealing with pages, there are lots of options
and lots of values that are dynamically calculated.  We need to pass those
in so a vmcore file can be properly generated from a kdump.

Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/kernel/machine_kexec.c | 30 ++++++++++++++++++++++++++++++
 1 file changed, 30 insertions(+)

diff --git a/arch/mips/kernel/machine_kexec.c b/arch/mips/kernel/machine_kexec.c
index 992e184..e3dc83f 100644
--- a/arch/mips/kernel/machine_kexec.c
+++ b/arch/mips/kernel/machine_kexec.c
@@ -12,6 +12,7 @@
 
 #include <asm/cacheflush.h>
 #include <asm/page.h>
+#include <asm/pgtable.h>
 
 extern const unsigned char relocate_new_kernel[];
 extern const size_t relocate_new_kernel_size;
@@ -108,3 +109,32 @@ machine_kexec(struct kimage *image)
 #endif
 	((noretfun_t) reboot_code_buffer)();
 }
+
+void arch_crash_save_vmcoreinfo(void)
+{
+	VMCOREINFO_NUMBER(PAGE_SHIFT);
+	VMCOREINFO_NUMBER(PGD_ORDER);
+#if defined(CONFIG_32BIT) || !defined(CONFIG_PAGE_SIZE_64KB)
+	VMCOREINFO_NUMBER(PMD_ORDER);
+#endif
+	VMCOREINFO_NUMBER(PTE_ORDER);
+	VMCOREINFO_NUMBER(_PAGE_PRESENT);
+#ifdef CONFIG_MIPS_HUGE_TLB_SUPPORT
+	VMCOREINFO_NUMBER(_PAGE_HUGE);
+#endif
+#ifdef CONFIG_64BIT
+#ifdef CONFIG_MAPPED_KERNEL
+	VMCOREINFO_ADDRESS(_text);
+	VMCOREINFO_ADDRESS(_end);
+	VMCOREINFO_ADDRESS(phys_to_kernel_offset);
+#endif
+	VMCOREINFO_ADDRESS(CKSEG0);
+	VMCOREINFO_ADDRESS(CKSSEG);
+#else /* CONFIG_64BIT */
+	VMCOREINFO_ADDRESS(PAGE_OFFSET);
+	VMCOREINFO_ADDRESS(PHYS_OFFSET);
+#endif /* CONFIG_64BIT */
+
+	VMCOREINFO_ADDRESS(IO_BASE);
+	VMCOREINFO_NUMBER(_PFN_SHIFT);
+}
-- 
1.8.2.1

