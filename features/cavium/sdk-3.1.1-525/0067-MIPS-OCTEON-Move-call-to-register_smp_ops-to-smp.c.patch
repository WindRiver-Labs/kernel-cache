From 613d76cd6d547a39d3a74b47038a1c1d75948470 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 22 Aug 2013 12:20:29 -0700
Subject: [PATCH 067/122] MIPS: OCTEON: Move call to register_smp_ops() to
 smp.c

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: e1204ad31de5ca1180be9512ab10e5af211da0b1
Description:

In order to keep all SMP related code together.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/cavium-octeon/setup.c       | 2 +-
 arch/mips/cavium-octeon/smp.c         | 5 +++++
 arch/mips/include/asm/octeon/octeon.h | 6 ++++++
 3 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index 9a70487..5d684db 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -825,7 +825,7 @@ void __init prom_init(void)
 #endif
 
 	octeon_user_io_init();
-	register_smp_ops(&octeon_smp_ops);
+	octeon_setup_smp();
 
 	labi = phys_to_virt(LABI_ADDR_IN_BOOTLOADER);
 	if (labi->labi_signature == LABI_SIGNATURE)
diff --git a/arch/mips/cavium-octeon/smp.c b/arch/mips/cavium-octeon/smp.c
index 1810eb8..b72cf0c 100644
--- a/arch/mips/cavium-octeon/smp.c
+++ b/arch/mips/cavium-octeon/smp.c
@@ -486,3 +486,8 @@ struct plat_smp_ops octeon_smp_ops = {
 	.cpu_die		= octeon_cpu_die,
 #endif
 };
+
+void __init octeon_setup_smp(void)
+{
+	register_smp_ops(&octeon_smp_ops);
+}
diff --git a/arch/mips/include/asm/octeon/octeon.h b/arch/mips/include/asm/octeon/octeon.h
index f11def7..12827b2 100644
--- a/arch/mips/include/asm/octeon/octeon.h
+++ b/arch/mips/include/asm/octeon/octeon.h
@@ -277,6 +277,12 @@ static inline int octeon_error_tree_disable(enum cvmx_error_groups group, int un
 
 int octeon_i2c_cvmx2i2c(unsigned int cvmx_twsi_bus_num);
 
+#ifdef CONFIG_SMP
+void octeon_setup_smp(void);
+#else
+static inline void octeon_setup_smp(void) {}
+#endif
+
 extern struct semaphore octeon_bootbus_sem;
 
 /* Octeon multiplier save/restore routines from octeon_switch.S */
-- 
1.8.2.1

