From 3801ad728923ba5ceb099d486ae5501aa5453165 Mon Sep 17 00:00:00 2001
From: Peter Swain <peter.swain@cavium.com>
Date: Thu, 14 Nov 2013 17:05:17 -0800
Subject: [PATCH 091/122] MIPS: octeon-power-throttle: allow booting in
 low-power mode

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 9381636a7867c92fb4dc34f4e34d48d041e40dff
Description:

Add a boot-time power limit as percentage,
set with bootparam, like
	octeon_power_throttle.start=85
Useful for situations where full-throttle boot would exceed power budget.

Individual cores' power can be throttled up/down after boot.

Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/cavium-octeon/octeon-power-throttle.c | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/arch/mips/cavium-octeon/octeon-power-throttle.c b/arch/mips/cavium-octeon/octeon-power-throttle.c
index b086dd2..addaf85 100644
--- a/arch/mips/cavium-octeon/octeon-power-throttle.c
+++ b/arch/mips/cavium-octeon/octeon-power-throttle.c
@@ -21,6 +21,7 @@
 #include <linux/init.h>
 #include <linux/smp.h>
 #include <linux/cpu.h>
+#include <linux/moduleparam.h>
 
 #include <asm/byteorder.h>
 #include <asm/octeon/octeon.h>
@@ -56,6 +57,15 @@ union octeon_power_throttle_bits {
 	} s;
 };
 
+/*
+ * Boot-time power limit as percentage,
+ * set with bootparam: octeon_power_throttle.start=85
+ * Useful for situations where full-throttle boot would exceed power budget.
+ * Individual cores' power can be throttled up/down after boot.
+ */
+static int boot_powlim = 100;
+module_param_named(start, boot_powlim, int, 0444);
+
 /* IPI calls to ask target CPU to access own registers ... */
 static inline void read_my_power_throttle(void *info)
 {
@@ -91,8 +101,9 @@ static void octeon_power_throttle_init_cpu(int cpu)
 	r.s.distag = 0;		/* MBZ */
 	r.s.period = 2;		/* 256 cycles */
 	r.s.minthr = 0;
+	/* start at max allowed speed, subject to bootparams */
 	r.s.maxthr = 0xff;
-	r.s.powlim = 0xff;	/* start full speed */
+	r.s.powlim = 0xff * boot_powlim / 100;
 
 	octeon_power_throttle_csr_op(cpu, &r, true);
 }
-- 
1.8.2.1

