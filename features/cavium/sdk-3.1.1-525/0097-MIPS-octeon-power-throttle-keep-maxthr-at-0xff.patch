From edcc385eb7cf0f3062fd0aeaeb03e096dc4a9ab9 Mon Sep 17 00:00:00 2001
From: Peter Swain <peter.swain@cavium.com>
Date: Wed, 4 Dec 2013 12:28:26 -0800
Subject: [PATCH 097/122] MIPS: octeon-power-throttle: keep maxthr at 0xff

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 995e0a095e4c1f5d1b16f5e139e7ae2bfae0b6c5
Description:

Commit 8606f7 dropped maxthr when booting with low power,
but this causes problemx on cn71xx.
Revert that gratuitous change & explore further.

Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/cavium-octeon/octeon-power-throttle.c | 11 +++++------
 1 file changed, 5 insertions(+), 6 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-power-throttle.c b/arch/mips/cavium-octeon/octeon-power-throttle.c
index a300917..23827d3 100644
--- a/arch/mips/cavium-octeon/octeon-power-throttle.c
+++ b/arch/mips/cavium-octeon/octeon-power-throttle.c
@@ -114,16 +114,15 @@ static void octeon_power_throttle_init_cpu(int cpu)
 	if (throttle_op(cpu, &r, false))
 		return;
 
+	if (cpu == 0)
+		pr_debug("old power_throttle %llx\n",
+			r.raw);
+
 	r.s.ovrrd = 0;		/* MBZ */
 	r.s.distag = 0;		/* MBZ */
 	r.s.period = 2;		/* 256 cycles */
 	r.s.minthr = 0;
-
-	/*
-	 * allow instantaneous power to peak above HRM default
-	 * of (maxpow - adj), even if powlim holds average to that.
-	 */
-	r.s.maxthr = r.s.maxpow;
+	r.s.maxthr = 0xff;
 
 	/* limit average power to boot_powlim% of max power */
 	if (boot_powlim >= 0)
-- 
1.8.2.1

