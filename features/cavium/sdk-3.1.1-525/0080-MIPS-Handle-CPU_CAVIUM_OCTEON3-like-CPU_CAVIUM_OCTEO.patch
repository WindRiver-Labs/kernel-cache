From a6106c642b1a2e648410b3ed289272a4d068cfad Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Tue, 22 Oct 2013 16:25:26 -0700
Subject: [PATCH 080/122] MIPS: Handle CPU_CAVIUM_OCTEON3 like
 CPU_CAVIUM_OCTEON2 in clear_page.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 4825667f16b938bb703edaf9e5b1eb6106c6bc01
Description:

Both OCTEON3 and OCTEON2 use the same instrucitons for this.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/mm/page.c | 9 ++-------
 1 file changed, 2 insertions(+), 7 deletions(-)

diff --git a/arch/mips/mm/page.c b/arch/mips/mm/page.c
index 0b0bc3e..6d37249 100644
--- a/arch/mips/mm/page.c
+++ b/arch/mips/mm/page.c
@@ -261,7 +261,8 @@ void build_clear_page(void)
 	memset(labels, 0, sizeof(labels));
 	memset(relocs, 0, sizeof(relocs));
 
-	if (current_cpu_data.cputype == CPU_CAVIUM_OCTEON2) {
+	if (current_cpu_data.cputype == CPU_CAVIUM_OCTEON2 ||
+	    current_cpu_data.cputype == CPU_CAVIUM_OCTEON3) {
 		const unsigned int wb_nudge = 26;
 
 		pg_addiu(&buf, T0, A0, PAGE_SIZE);
@@ -269,25 +270,19 @@ void build_clear_page(void)
 		UASM_i_ADDIU(&buf, A1, A0, 128);
 		uasm_l_clear_pref(&l, buf);
 		uasm_i_zcbt(&buf, A0);
-		uasm_i_pref(&buf, wb_nudge, 0, A0);
 		UASM_i_ADDIU(&buf, A0, A0, 256);
 		uasm_i_zcbt(&buf, A1);
-		uasm_i_pref(&buf, wb_nudge, 0, A1);
 		UASM_i_ADDIU(&buf, A1, A1, 256);
 		uasm_i_zcbt(&buf, A0);
-		uasm_i_pref(&buf, wb_nudge, 0, A0);
 		UASM_i_ADDIU(&buf, A0, A0, 256);
 		uasm_i_zcbt(&buf, A1);
 		uasm_i_pref(&buf, wb_nudge, 0, A1);
 		UASM_i_ADDIU(&buf, A1, A1, 256);
 		uasm_i_zcbt(&buf, A0);
-		uasm_i_pref(&buf, wb_nudge, 0, A0);
 		UASM_i_ADDIU(&buf, A0, A0, 256);
 		uasm_i_zcbt(&buf, A1);
-		uasm_i_pref(&buf, wb_nudge, 0, A1);
 		UASM_i_ADDIU(&buf, A1, A1, 256);
 		uasm_i_zcbt(&buf, A0);
-		uasm_i_pref(&buf, wb_nudge, 0, A0);
 		UASM_i_ADDIU(&buf, A0, A0, 256);
 		uasm_i_zcbt(&buf, A1);
 		uasm_i_pref(&buf, wb_nudge, 0, A1);
-- 
1.8.2.1

