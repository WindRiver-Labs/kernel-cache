From d78ee2db47cc3be34262bb9460af91cc0e8575d2 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 23 Jun 2011 17:57:08 -0700
Subject: [PATCH 001/122] MIPS: Octeon: Fast access thread pointer

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 44bd4500d12226ac979de82e2a30b2c2993f8612
Description:

If CONFIG_FAST_ACCESS_TO_THREAD_POINTER is enabled, then deploy the
FAST_ACCESS_THREAD_OFFSET and the FAST_ACCESS_THREAD_REGISTER to
bounce through the reserved hardware cache area for speed.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/include/asm/mipsregs.h | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/arch/mips/include/asm/mipsregs.h b/arch/mips/include/asm/mipsregs.h
index bbc3dd4..7f03f02 100644
--- a/arch/mips/include/asm/mipsregs.h
+++ b/arch/mips/include/asm/mipsregs.h
@@ -668,6 +668,21 @@
 #define MIPS_FPIR_F64		(_ULCAST_(1) << 22)
 
 /*
+ * These defines are used on Octeon to implement fast access to the
+ * thread pointer from userspace. Octeon uses a 64bit location in
+ * CVMSEG to store the thread pointer for quick access.
+ *
+ * TLB refill uses location -8, fast access is -16 (both from the top
+ * of the area.
+ */
+#ifdef CONFIG_FAST_ACCESS_TO_THREAD_POINTER
+#define FAST_ACCESS_THREAD_OFFSET			\
+	(CONFIG_CAVIUM_OCTEON_CVMSEG_SIZE*128-16-32768)
+#define FAST_ACCESS_THREAD_REGISTER			\
+	(*(unsigned long *)(FAST_ACCESS_THREAD_OFFSET))
+#endif
+
+/*
  * Bits in the MIPS32 Memory Segmentation registers.
  */
 #define MIPS_SEGCFG_PA_SHIFT	9
-- 
1.8.2.1

