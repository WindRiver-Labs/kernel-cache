From 1ed83bca3365928ff4e4617e04a2cf4d02af2bb0 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 9 May 2014 13:18:03 -0400
Subject: [PATCH 111/122] MIPS: OCTEON: Add ciu_node for CIU3

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 04a6cd7ac055ebc29f3ce0f79cc9c91cd8949c52
Description:

Add ciu_node for CIU3.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/cavium-octeon/octeon-irq.c  | 3 +++
 arch/mips/include/asm/octeon/octeon.h | 1 +
 2 files changed, 4 insertions(+)

diff --git a/arch/mips/cavium-octeon/octeon-irq.c b/arch/mips/cavium-octeon/octeon-irq.c
index a68cff9..bb7795f 100644
--- a/arch/mips/cavium-octeon/octeon-irq.c
+++ b/arch/mips/cavium-octeon/octeon-irq.c
@@ -40,6 +40,7 @@ static DEFINE_PER_CPU(struct octeon_ciu3_info *, octeon_ciu3_info);
 /* Information for each ciu3 in the system */
 struct octeon_ciu3_info {
 	u64			ciu3_addr;
+	int			node;
 	struct irq_domain	*domain[MAX_CIU3_DOMAINS];
 };
 
@@ -2218,6 +2219,7 @@ int octeon_irq_ciu3_mapx(struct irq_domain *d, unsigned int virq,
 	cd->intsn = hw;
 	cd->current_cpu = -1;
 	cd->ciu3_addr = ciu3_info->ciu3_addr;
+	cd->ciu_node = ciu3_info->node;
 
 	irq_set_chip_and_handler(virq, chip, octeon_irq_handle_trigger);
 	irq_set_chip_data(virq, cd);
@@ -2690,6 +2692,7 @@ static int __init octeon_irq_init_ciu3(struct device_node *ciu_node,
 	node = (base_addr >> 36) & 3;
 
 	ciu3_info->ciu3_addr = base_addr;
+	ciu3_info->node = node;
 
 	consts.u64 = cvmx_read_csr(base_addr + CIU3_CONST);
 
diff --git a/arch/mips/include/asm/octeon/octeon.h b/arch/mips/include/asm/octeon/octeon.h
index 952c39d..4754343 100644
--- a/arch/mips/include/asm/octeon/octeon.h
+++ b/arch/mips/include/asm/octeon/octeon.h
@@ -226,6 +226,7 @@ struct octeon_ciu_chip_data {
 		};
 	};
 	int current_cpu;	/* Next CPU expected to take this irq */
+	int ciu_node; /* NUMA node number of the CIU */
 };
 
 extern void octeon_write_lcd(const char *s);
-- 
1.8.2.1

