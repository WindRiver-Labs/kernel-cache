From 8f8dd93f37957c9f31404308b5b34839b82ba5ed Mon Sep 17 00:00:00 2001
From: Carlos Munoz <carlos.munoz@caviumnetworks.com>
Date: Fri, 13 Feb 2015 13:59:11 +0530
Subject: [PATCH 038/132] spi: spi-octeon.c: Allow faster speeds on octeonIII
 boards.

Commit 6b18a8b70414d74e52b4e09fd1b916b89c39059e from
git://git.yoctoproject.org/linux-yocto-3.14

Signed-off-by: Carlos Munoz <carlos.munoz@caviumnetworks.com>
Signed-off-by: Abhishek Paliwal <abhishek.paliwal@aricent.com>
[Original patch taken from OCTEON-SDK 3.1.1-544.]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/spi/spi-octeon.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/drivers/spi/spi-octeon.c b/drivers/spi/spi-octeon.c
index e99d6a9..88ce506 100644
--- a/drivers/spi/spi-octeon.c
+++ b/drivers/spi/spi-octeon.c
@@ -25,6 +25,7 @@
 #define OCTEON_SPI_MAX_BYTES 9
 
 #define OCTEON_SPI_MAX_CLOCK_HZ 16000000
+#define OCTEON_SPI_MAX_CLOCK_HZ_7XXX    25000000        /** Max clock for O3 */
 
 struct octeon_spi {
 	u64 register_base;
@@ -67,6 +68,14 @@ static int octeon_spi_do_transfer(struct octeon_spi *p,
 
 	speed_hz = xfer->speed_hz ? : spi->max_speed_hz;
 
+	if (OCTEON_IS_OCTEON3()) {
+		if (speed_hz > OCTEON_SPI_MAX_CLOCK_HZ_7XXX)
+			speed_hz = OCTEON_SPI_MAX_CLOCK_HZ_7XXX;
+	} else {
+		if (speed_hz > OCTEON_SPI_MAX_CLOCK_HZ)
+			speed_hz = OCTEON_SPI_MAX_CLOCK_HZ;
+	}
+
 	clkdiv = octeon_get_io_clock_rate() / (2 * speed_hz);
 
 	mpi_cfg.u64 = 0;
-- 
1.9.1

