From 39e9f07d7b69596e0193175d6e2223ee99829bf3 Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Tue, 23 Dec 2014 15:17:52 +0800
Subject: [PATCH] OCTEON: fix octeon3 eth driver xmit sync problem

When call octeon3_eth_ndo_start_xmit, it needs the synchronization "spin_lock"
to protect the ndo_start_xmit routine from the register resources competition.

An address error occurred when lack of synchronization proctection, would lead
following calltrace:

Kernel unaligned instruction access[#1]:
CPU: 0 PID: 356 Comm: kworker/0:1 Not tainted 3.10.55-ltsi-rt55-WR6.0.0.15_preempt-rt #1
Workqueue: rpciod rpc_async_schedule
task: 800000002db6ae40 ti: 800000002d404000 task.ti: 800000002d404000
$ 0 : 0000000000000000 ffffffff8061ae24 2000510000080000 ffffffff80d70000
$ 4 : ffffffffffffa420 ffffffffffffa400 0000000000000000 0000000000000000
$ 8 : 0000000000000051 0000000000000548 800000002eaee610 00000000380595a0
$12 : 0000000000000000 ffffffff8053d94c 0000000000000010 0000000000000000
$16 : 0000000000000009 0008a000263e3c28 0901c0002e4953e0 ffffffffffff8118
$20 : ffffffffffff8120 0000000000000128 0000000000000118 80000000263e3c00
$24 : 0000000000000000 ffffffff807bad50
$28 : 800000002d404000 800000002d407790 800000002d407790 ffffffff8061ae24
Hi : 000000000a3d6ca5
Lo : eb851eb86e146fe7
epc : ffffffff8061ac5c octeon3_eth_ndo_start_xmit+0x4e4/0x750
    Not tainted
ra : ffffffff8061ae24 octeon3_eth_ndo_start_xmit+0x6ac/0x750
Status: 14009ce3	KX SX UX KERNEL EXL IE
Cause : 00800014
BadVA : ffffffffffffa420
PrId : 000d9500 (Cavium Octeon III)
Modules linked in:
Process kworker/0:1 (pid: 356, threadinfo=800000002d404000, task=800000002db6ae40, tls=0000000000000000)
Stack : 800000002e494000 800000002e4953e0 0000000000000000 0000000000000000
0000000000000000 000000000000000c 0000000060005853 800000002e494000
0000000000000000 00000000000005ea 80000000263e3c00 800000002e001200
ffffffff8094e220 0000000000000014 800000002d407810 ffffffff80776754
800000002d407820 ffffffff801bf580 80000000263e3c00 ffffffff80c89d80
ffffffff80b064c8 800000002e494000 800000002e001200 0000000000000000
fffffffffffffff0 0000000000000014 800000002d407870 ffffffff80776dec
800000002c631000 000000000000000e 80000000263e3c00 0000000000000000
800000002c631198 800000002c631168 fffffffffffffff0 0000000000000014
800000002d4078c0 ffffffff807b8260 80e0b21452c9c406 e80b1272e2e926a8
...
Call Trace:
[<ffffffff8061ac5c>] octeon3_eth_ndo_start_xmit+0x4e4/0x750
[<ffffffff80776754>] dev_hard_start_xmit+0x30c/0x5f8
[<ffffffff80776dec>] dev_queue_xmit+0x3ac/0x5a0
[<ffffffff807b8260>] ip_finish_output2+0x1d0/0x448
[<ffffffff807b8d58>] ip_fragment+0x738/0x958
[<ffffffff807b938c>] ip_finish_output+0x414/0x528
[<ffffffff807bba44>] ip_send_skb+0x2c/0xc0
[<ffffffff807e6280>] udp_send_skb+0x370/0x4f8
[<ffffffff807e6458>] udp_push_pending_frames+0x50/0x78
[<ffffffff807e9d30>] udp_sendpage+0x178/0x200
[<ffffffff807f4f88>] inet_sendpage+0xd0/0x160
[<ffffffff80885964>] xs_sendpages+0x294/0x2d8
[<ffffffff80885b98>] xs_udp_send_request+0x58/0x140
[<ffffffff80882d34>] xprt_transmit+0x74/0x2b8
[<ffffffff808802f0>] call_transmit+0x180/0x260
[<ffffffff8088986c>] __rpc_execute+0x8c/0x458
[<ffffffff80889c70>] rpc_async_schedule+0x38/0x68
[<ffffffff801a5f3c>] process_one_work+0x18c/0x4e0
[<ffffffff801a6e94>] worker_thread+0x184/0x4b8
[<ffffffff801af128>] kthread+0xb8/0xc0
[<ffffffff80155644>] ret_from_kernel_thread+0x14/0x1c

Code: 7ca2cc07 2405a400 00852025 <fc820000> 8c62d360 10400008 00000000 0000008f dc068100
---[ end trace 0000000000000002 ]---

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index 640ca61..3b7ffef 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -214,6 +214,7 @@ struct octeon3_ethernet {
 	atomic64_t buffers_needed;
 	atomic64_t tx_backlog;
 	char cacheline_pad2[CVMX_CACHE_LINE_SIZE];
+	spinlock_t xmit_lock;
 };
 
 static DEFINE_MUTEX(octeon3_eth_init_mutex);
@@ -1710,6 +1711,8 @@ static int octeon3_eth_ndo_start_xmit(struct sk_buff *skb, struct net_device *ne
 		}
 	}
 
+	spin_lock(&priv->xmit_lock);
+
 	/* Adjust the port statistics. */
 	atomic64_inc(&priv->tx_packets);
 	atomic64_add(skb->len, &priv->tx_octets);
@@ -1857,6 +1860,7 @@ static int octeon3_eth_ndo_start_xmit(struct sk_buff *skb, struct net_device *ne
 			dev_kfree_skb_any(skb);
 		}
 	}
+	spin_unlock(&priv->xmit_lock);
 
 	return NETDEV_TX_OK;
 skip_xmit:
@@ -1988,6 +1992,7 @@ static int octeon3_eth_probe(struct platform_device *pdev)
 	priv->xiface = cvmx_helper_node_interface_to_xiface(pd->numa_node, pd->interface);
 	priv->port_index = pd->port;
 	spin_lock_init(&priv->stat_lock);
+	spin_lock_init(&priv->xmit_lock);
 	netdev->netdev_ops = &octeon3_eth_netdev_ops;
 
 	if (register_netdev(netdev) < 0) {
-- 
1.7.5.4

