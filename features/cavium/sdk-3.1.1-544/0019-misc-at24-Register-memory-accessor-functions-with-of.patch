From 96298fc90c96f20ebf037e3c0d96a523e4b9ba73 Mon Sep 17 00:00:00 2001
From: Aaron Williams <aaron.williams@cavium.com>
Date: Fri, 13 Feb 2015 12:48:16 +0530
Subject: [PATCH 019/132] misc/at24: Register memory accessor functions with
 of_memory_accessor

Commit 5f9ff11e3bd47cdb7d051d2f0dd4505e03815eaf from
git://git.yoctoproject.org/linux-yocto-3.14

The at24 module will now register its memory accessor functions with its
device tree entry so that other modules may call these functions based on
the device tree node.

Signed-off-by: Aaron Williams <aaron.williams@cavium.com>
Signed-off-by: Leonid Rosenboim <lrosenboim@caviumnetworks.com>
Signed-off-by: Abhishek Paliwal <abhishek.paliwal@aricent.com>
[Original patch taken from OCTEON-SDK 3.1.1-544.]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/misc/eeprom/at24.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/drivers/misc/eeprom/at24.c b/drivers/misc/eeprom/at24.c
index 2d3db81..1ae3067 100644
--- a/drivers/misc/eeprom/at24.c
+++ b/drivers/misc/eeprom/at24.c
@@ -23,6 +23,7 @@
 #include <linux/of.h>
 #include <linux/i2c.h>
 #include <linux/platform_data/at24.h>
+#include <linux/of_memory_accessor.h>
 
 /*
  * I2C EEPROMs from most vendors are inexpensive and mostly interchangeable.
@@ -660,6 +661,9 @@ static int at24_probe(struct i2c_client *client, const struct i2c_device_id *id)
 	if (chip.setup)
 		chip.setup(&at24->macc, chip.context);
 
+	if (client->dev.of_node)
+		of_memory_accessor_register(&client->dev, &at24->macc);
+
 	return 0;
 
 err_clients:
@@ -678,6 +682,9 @@ static int at24_remove(struct i2c_client *client)
 	at24 = i2c_get_clientdata(client);
 	sysfs_remove_bin_file(&client->dev.kobj, &at24->bin);
 
+	if (client->dev.of_node)
+		of_memory_accessor_remove(&client->dev);
+
 	for (i = 1; i < at24->num_addresses; i++)
 		i2c_unregister_device(at24->client[i]);
 
-- 
1.9.1

