From ac8a2f8c4d904562cdab70888a4811de6ad13092 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 25 Sep 2014 14:31:35 -0700
Subject: [PATCH 156/202] MIPS: OCTEON: Try to allocate at least 64MB of DMA32
 memory.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.1-544]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/cavium-octeon/setup.c | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index 3bdcf97..368b379 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -1013,10 +1013,13 @@ void __init plat_mem_setup(void)
 		mem_alloc_size = MAX_MEMORY;
 
 	cvmx_bootmem_lock();
+	limit_max = 0xffffffffull;
+	limit_min = 0;
 	while ((boot_mem_map.nr_map < BOOT_MEM_MAP_MAX)
 		&& (total < MAX_MEMORY)) {
-		limit_max = ~0ull;		/* unlimitted */
-		limit_min = 0;
+		/* Try to get 64MB of 32=bit memory */
+		if (total >= 64 * (1<<20))
+			limit_max = ~0ull;		/* unlimitted */
 
 		memory = cvmx_bootmem_phy_alloc(mem_alloc_size,
 				limit_min, limit_max, 0x100000,
@@ -1045,7 +1048,10 @@ void __init plat_mem_setup(void)
 				add_memory_region(memory, size, BOOT_MEM_RAM);
 			total += mem_alloc_size;
 		} else {
-			break;
+			if (limit_max < ~0ull)
+				limit_max = ~0ull;		/* unlimitted */
+			else
+				break;
 		}
 	}
 	cvmx_bootmem_unlock();
-- 
1.8.2.1

