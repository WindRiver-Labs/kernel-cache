From ca799ed7ab6d05ead9f189b0dc9dd492082ae3c2 Mon Sep 17 00:00:00 2001
From: Chandrakala Chavva <cchavva@caviumnetworks.com>
Date: Fri, 13 Feb 2015 11:53:24 +0530
Subject: [PATCH 009/132] MIPS/EDAC: Poll for all error bis in L2C_INT CSR.

Commit c8c240df389c04fdeadf686a45daeeae4f6c43f0 from
git://git.yoctoproject.org/linux-yocto-3.14

Signed-off-by: Chandrakala Chavva <cchavva@caviumnetworks.com>
Signed-off-by: Abhishek Paliwal <abhishek.paliwal@aricent.com>
[Original patch taken from OCTEON-SDK 3.1.1-544.]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/edac/octeon_edac-l2c.c | 49 ++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 49 insertions(+)

diff --git a/drivers/edac/octeon_edac-l2c.c b/drivers/edac/octeon_edac-l2c.c
index 64f1f85..f0e2b61 100644
--- a/drivers/edac/octeon_edac-l2c.c
+++ b/drivers/edac/octeon_edac-l2c.c
@@ -62,9 +62,58 @@ static void _octeon_l2c_poll_oct2(struct edac_device_ctl_info *l2c, int tad)
 {
 	union cvmx_l2c_err_tdtx err_tdtx, err_tdtx_reset;
 	union cvmx_l2c_err_ttgx err_ttgx, err_ttgx_reset;
+	union cvmx_l2c_int_reg l2c_int_reg;
+	bool l2c_clear = false;
 	char buf1[64];
 	char buf2[80];
 
+	/* Poll for L2C bigrd/bigwr/holewr/holerd */
+	l2c_int_reg.u64 = cvmx_read_csr(CVMX_L2C_INT_REG);
+	if (l2c_int_reg.s.bigrd) {
+		snprintf(buf1, sizeof(buf1),
+			"Read reference past L2C_BIG_CTL[MAXDRAM] occurred:");
+		l2c_clear = true;
+	}
+	if (l2c_int_reg.s.bigwr) {
+		snprintf(buf1, sizeof(buf1),
+			"Write reference past L2C_BIG_CTL[MAXDRAM] occurred:");
+		l2c_clear = true;
+	}
+	if (l2c_int_reg.s.vrtpe) {
+		snprintf(buf1, sizeof(buf1),
+			"L2C_VRT_MEM read found a parity error");
+		l2c_clear = true;
+	}
+	if (l2c_int_reg.s.vrtadrng) {
+		snprintf(buf1, sizeof(buf1),
+			"Address outside of virtualization range");
+		l2c_clear = true;
+	}
+	if (l2c_int_reg.s.vrtidrng) {
+		snprintf(buf1, sizeof(buf1),
+			"Virtualization ID out of range");
+		l2c_clear = true;
+	}
+	if (l2c_int_reg.s.vrtwr) {
+		snprintf(buf1, sizeof(buf1),
+			"Virtualization ID prevented a write");
+		l2c_clear = true;
+	}
+	if (l2c_int_reg.s.holewr) {
+		snprintf(buf1, sizeof(buf1),
+			"Write reference to 256MB hole occurred:");
+		l2c_clear = true;
+	}
+	if (l2c_int_reg.s.holerd) {
+		snprintf(buf1, sizeof(buf1),
+			"Read reference to 256MB hole occurred:");
+		l2c_clear = true;
+	}
+	if (l2c_clear) {
+		edac_device_handle_ce(l2c, tad, 1, buf1);
+		cvmx_write_csr(CVMX_L2C_INT_REG, l2c_int_reg.u64);
+	}
+
 	err_tdtx_reset.u64 = 0;
 	err_tdtx.u64 = cvmx_read_csr(CVMX_L2C_ERR_TDTX(tad));
 	if (err_tdtx.s.dbe || err_tdtx.s.sbe ||
-- 
1.9.1

