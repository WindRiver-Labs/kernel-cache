From fc6cd41a65fb16f09986227bd22dda3e5c945a2d Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 13 Feb 2015 11:48:37 +0530
Subject: [PATCH 007/132] MIPS/OCTEON: TLB parity error handling

Commit 9e9612e1906d2b7f297ef3025adddf1e51c3d03a from
git://git.yoctoproject.org/linux-yocto-3.14

We need to temporarily disable TLB Parity checks early in the handler
so we don't get into an endless loop.

The meaning of cvmmemctl[44] changed, 0 means enabled.

Bug #8300

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Leonid Rosenboim <lrosenboim@caviumnetworks.com>
Signed-off-by: Chandrakala Chavva <cchavva@caviumnetworks.com>
Signed-off-by: Abhishek Paliwal <abhishek.paliwal@aricent.com>
[Original patch taken from OCTEON-SDK 3.1.1-544.]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/kernel/genex.S | 20 ++++++++++++++++++++
 1 file changed, 20 insertions(+)

diff --git a/arch/mips/kernel/genex.S b/arch/mips/kernel/genex.S
index af42e70..765d96a 100644
--- a/arch/mips/kernel/genex.S
+++ b/arch/mips/kernel/genex.S
@@ -354,6 +354,26 @@ NESTED(nmi_handler, PT_SIZE, sp)
 	TRACE_IRQS_OFF
 	.endm
 
+	.macro  __build_clear_mce
+#ifdef CONFIG_CPU_CAVIUM_OCTEON
+	/* Disable TLB Parity checks. */
+	mfc0    t2, $15,0
+	and     t2, 0xff00
+	dli     t0, 0x9500
+	/* In Octeon3 setting bit 44 disables TLB parity */
+	slt     t2, t2, t0
+	dmfc0   t0, $11, 7
+	dli     t1, (1 << 44)
+	or      t0, t0, t1
+	beqz    t2, 11f
+	nop
+	xor     t0, t0, t1
+11 :
+	dmtc0   t0, $11, 7
+#endif
+	__build_clear_cli
+	.endm
+
 	.macro	__build_clear_fpe
 	.set	push
 	/* gas fails to assemble cfc1 for some archs (octeon).*/ \
-- 
1.9.1

