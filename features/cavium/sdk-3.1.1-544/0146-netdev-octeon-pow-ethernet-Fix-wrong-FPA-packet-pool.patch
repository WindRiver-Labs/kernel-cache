From 5f81cb8dd43b564e4c2cd7dc6b0b5dc2af7336b8 Mon Sep 17 00:00:00 2001
From: Bin Jiang <bin.jiang@windriver.com>
Date: Thu, 25 Dec 2014 17:22:29 +0800
Subject: [PATCH 146/148] netdev: octeon-pow-ethernet: Fix wrong FPA packet
 pool

Run octeon-pow-ethernet and there are following call trace:
epc : 000100000078000d 0x100000078000d
ra : ffffffff80211ecc handle_irq_event_percpu+0x84/0x2f8
Status: 10008ce2 KX SX UX KERNEL EXL
Cause : 00800410
BadVA : 000100000078000d
PrId : 000d9109 (Cavium Octeon II)
Modules linked in: octeon_pow_ethernet
Call Trace:
[<ffffffff802121a8>] handle_irq_event+0x68/0xb0
[<ffffffff80215c44>] handle_level_irq+0xdc/0x160
[<ffffffff80211394>] generic_handle_irq+0x4c/0x68
[<ffffffff809093a4>] do_IRQ+0x2c/0x40
[<ffffffff8021cd00>] rcu_irq_exit+0xa0/0xd8
[<ffffffff801060f4>] octeon_irq_ciu2+0xac/0x140
[<ffffffff801073e0>] plat_irq_dispatch+0x98/0xe8
[<ffffffff801580e0>] ret_from_irq+0x0/0x4
[<ffffffff801d76b4>] cpu_startup_entry+0x164/0x2c0
[<ffffffff802d4718>] SyS_poll+0x0/0x178

The contents of irqaction variable is overwritten with bad value and
causes the above call trace.

The IPD WQE pool is too small to store skb data. The skb data may
overflow the pool and overwirte irqaction variable.
Use IPD PACKET pool to store skb data.

Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/net/ethernet/octeon/octeon-pow-ethernet.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/octeon/octeon-pow-ethernet.c b/drivers/net/ethernet/octeon/octeon-pow-ethernet.c
index 28bfa2c..08d39aa 100644
--- a/drivers/net/ethernet/octeon/octeon-pow-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon-pow-ethernet.c
@@ -26,6 +26,7 @@
 #include <asm/octeon/cvmx-wqe.h>
 #include <asm/octeon/cvmx-pow-defs.h>
 #include <asm/octeon/cvmx-sso-defs.h>
+#include <asm/octeon/cvmx-ipd.h>
 
 #define VIRTUAL_PORT    63	/* Value to put in work->ipprt */
 #define CN78XX_SSO_INTSN_EXE 0x61
@@ -756,7 +757,8 @@ static int __init octeon_pow_mod_init(void)
 		fpa_packet_pool_size = (cvmx_read_csr(CVMX_IPD_PACKET_MBUFF_SIZE) & 0xfff) * 8;
 
 		/* Read the work queue pool */
-		fpa_packet_pool = fpa_wqe_pool = cvmx_read_csr(CVMX_IPD_WQE_FPA_QUEUE) & 7;
+		fpa_packet_pool = cvmx_ipd_cfg.packet_pool.pool_num;
+		fpa_wqe_pool = cvmx_read_csr(CVMX_IPD_WQE_FPA_QUEUE) & 7;
 	}
 
 	if (register_netdev(octeon_pow_oct_dev) < 0) {
-- 
1.8.2.1

