From 2ddb25fb89723c492e35c62ffa45af004bc9dc82 Mon Sep 17 00:00:00 2001
From: Vinita Gupta <vgupta@caviumnetworks.com>
Date: Thu, 25 Sep 2014 12:31:12 -0700
Subject: [PATCH 155/202] netdev:mips: separated interface enabled from port
 enable

Took interface enable code out from bgx_probe and added
bgx_port_init in bgx_port_probe.

Signed-off-by: Vinita Gupta <vgupta@caviumnetworks.com>
[Original patch taken from Cavium SDK 3.1.1-544]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/net/ethernet/octeon/octeon-bgx-nexus.c | 4 +++-
 drivers/net/ethernet/octeon/octeon-bgx-port.c  | 7 +++++++
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/octeon/octeon-bgx-nexus.c b/drivers/net/ethernet/octeon/octeon-bgx-nexus.c
index 0c16f38..c4332e7 100644
--- a/drivers/net/ethernet/octeon/octeon-bgx-nexus.c
+++ b/drivers/net/ethernet/octeon/octeon-bgx-nexus.c
@@ -34,6 +34,7 @@
 #include <asm/octeon/cvmx-helper.h>
 #include <asm/octeon/cvmx-helper-util.h>
 #include <asm/octeon/cvmx-helper-cfg.h>
+#include <asm/octeon/cvmx-helper-bgx.h>
 #include <asm/octeon/cvmx-bgxx-defs.h>
 
 #include "octeon-bgx.h"
@@ -64,7 +65,8 @@ static int bgx_probe(struct platform_device *pdev)
 	interface = (addr >> 24) & 0xf;
 	numa_node = (addr >> 36) & 0x7;
 
-	__cvmx_helper_packet_hardware_enable(cvmx_helper_node_interface_to_xiface(numa_node, interface));
+	__cvmx_helper_bgx_probe(cvmx_helper_node_interface_to_xiface(numa_node, interface));
+
 	/* Assign 8 CAM entries per LMAC */
 	for (i = 0; i < 32; i++) {
 		union cvmx_bgxx_cmr_rx_adrx_cam adr_cam;
diff --git a/drivers/net/ethernet/octeon/octeon-bgx-port.c b/drivers/net/ethernet/octeon/octeon-bgx-port.c
index be28232b..7681923 100644
--- a/drivers/net/ethernet/octeon/octeon-bgx-port.c
+++ b/drivers/net/ethernet/octeon/octeon-bgx-port.c
@@ -39,6 +39,7 @@
 #include <asm/octeon/cvmx-helper-util.h>
 #include <asm/octeon/cvmx-helper-cfg.h>
 #include <asm/octeon/cvmx-bgxx-defs.h>
+#include <asm/octeon/cvmx-helper-bgx.h>
 
 #include "octeon-bgx.h"
 
@@ -466,6 +467,12 @@ static int bgx_port_probe(struct platform_device *pdev)
 		cvmx_helper_set_port_phy_present(priv->xiface, priv->index, true);
 
 	r = dev_set_drvdata(&pdev->dev, priv);
+
+	if (priv->phy_np)
+		__cvmx_helper_bgx_port_init(priv->ipd_port, 1);
+	else
+		__cvmx_helper_bgx_port_init(priv->ipd_port, 0);
+
 	if (r)
 		goto err;
 
-- 
1.8.2.1

