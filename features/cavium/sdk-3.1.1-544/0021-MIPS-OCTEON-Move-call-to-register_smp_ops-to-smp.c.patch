From 170a37566b2433d4eeab804f9d909c171527b922 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 13 Feb 2015 12:49:11 +0530
Subject: [PATCH 021/132] MIPS: OCTEON: Move call to register_smp_ops() to
 smp.c...

Commit 830d7d9be38cf9494d376f941f6e838d500ccf57 from
git://git.yoctoproject.org/linux-yocto-3.14

... in order to keep all SMP related code together.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Abhishek Paliwal <abhishek.paliwal@aricent.com>
[Original patch taken from OCTEON-SDK 3.1.1-544.]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/setup.c       | 6 ++++--
 arch/mips/cavium-octeon/smp.c         | 6 ++++++
 arch/mips/include/asm/octeon/octeon.h | 6 ++++++
 3 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index 9b11a3b..c830020 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -595,8 +595,10 @@ void octeon_user_io_init(void)
 	cvmmemctl.s.cvmsegenau = 0;
 
 	/* Enable TLB parity error reporting on OCTEON II */
-	if (OCTEON_IS_OCTEON2() || OCTEON_IS_OCTEON3())
+	if (OCTEON_IS_OCTEON2())
 		cvmmemctl.s.tlbperrena = 1;
+	if (OCTEON_IS_OCTEON3())
+		cvmmemctl.s.tlbperrena = 0;
 
 	write_c0_cvmmemctl(cvmmemctl.u64);
 
@@ -899,7 +901,7 @@ void __init prom_init(void)
 #endif
 
 	octeon_user_io_init();
-	register_smp_ops(&octeon_smp_ops);
+	octeon_setup_smp();
 }
 
 /* Exclude a single page from the regions obtained in plat_mem_setup. */
diff --git a/arch/mips/cavium-octeon/smp.c b/arch/mips/cavium-octeon/smp.c
index 56f5d08..eaa2f99 100644
--- a/arch/mips/cavium-octeon/smp.c
+++ b/arch/mips/cavium-octeon/smp.c
@@ -388,3 +388,9 @@ struct plat_smp_ops octeon_smp_ops = {
 	.cpu_die		= octeon_cpu_die,
 #endif
 };
+
+void __init octeon_setup_smp(void)
+{
+	register_smp_ops(&octeon_smp_ops);
+}
+
diff --git a/arch/mips/include/asm/octeon/octeon.h b/arch/mips/include/asm/octeon/octeon.h
index 6f16191..944c2b6 100644
--- a/arch/mips/include/asm/octeon/octeon.h
+++ b/arch/mips/include/asm/octeon/octeon.h
@@ -352,6 +352,12 @@ extern void octeon_fixup_irqs(void);
 
 int octeon_i2c_cvmx2i2c(unsigned int cvmx_twsi_bus_num);
 
+#ifdef CONFIG_SMP
+void octeon_setup_smp(void);
+#else
+static inline void octeon_setup_smp(void) {}
+#endif
+
 extern struct semaphore octeon_bootbus_sem;
 
 extern void (*octeon_scache_init)(void);
-- 
1.9.1

