From 569c27bdfba2ddd4229b6893c5f8d8d9eb53748e Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 3 Oct 2014 12:42:41 -0700
Subject: [PATCH 166/202] MIPS: OCTEON: Fix saving of CVMSEG per-task state.

By disabling CVMSEGENAU in octeon_prepare_arch_switch() we were
inadvertently disabling the saving of the CVMSEG state in the resume()
function.

The fix: Let resume() handle saving of the CVMSEG state, and clearing
of CVMSEGENAU.  The do_ade() handler will then conditionally enable
CVMSEGENAU.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.1-544]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/kernel/octeon-cpu.c | 1 -
 arch/mips/kernel/unaligned.c  | 5 +++++
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/arch/mips/kernel/octeon-cpu.c b/arch/mips/kernel/octeon-cpu.c
index a08c4ad..37bddd0 100644
--- a/arch/mips/kernel/octeon-cpu.c
+++ b/arch/mips/kernel/octeon-cpu.c
@@ -48,7 +48,6 @@ void octeon_prepare_arch_switch(struct task_struct *next)
 
 #if defined(CONFIG_CAVIUM_OCTEON_USER_IO_PER_PROCESS)
 	cvmmemctl.s.xkioenau = test_tsk_thread_flag(group_leader, TIF_XKPHYS_IO_EN) ? 1 : 0;
-	cvmmemctl.s.cvmsegenau = test_tsk_thread_flag(group_leader, TIF_XKPHYS_IO_EN) ? 1 : 0;
 #endif
 	write_c0_cvmmemctl(cvmmemctl.u64);
 }
diff --git a/arch/mips/kernel/unaligned.c b/arch/mips/kernel/unaligned.c
index d99a93f..bc64783 100644
--- a/arch/mips/kernel/unaligned.c
+++ b/arch/mips/kernel/unaligned.c
@@ -1644,6 +1644,11 @@ asmlinkage void do_ade(struct pt_regs *regs)
 
 	if ((regs->cp0_badvaddr >= CVMSEG_IO && regs->cp0_badvaddr < CVMSEG_IO_END) ||
 	    (regs->cp0_badvaddr >= CVMSEG_BASE && regs->cp0_badvaddr < CVMSEG_BASE + cvmseg_size)) {
+#if defined(CONFIG_CAVIUM_OCTEON_USER_IO_PER_PROCESS)
+		struct task_struct *group_leader = current->group_leader;
+		if (!test_tsk_thread_flag(group_leader, TIF_XKPHYS_IO_EN))
+			goto sigbus;
+#endif
 		preempt_disable();
 		cvmmemctl = __read_64bit_c0_register($11, 7);
 		/* Make sure all async operations are done */
-- 
1.8.2.1

