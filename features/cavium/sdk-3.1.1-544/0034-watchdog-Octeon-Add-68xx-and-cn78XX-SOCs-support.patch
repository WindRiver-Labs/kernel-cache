From 499c1e8530d6991310d81f8877833d362ca29d60 Mon Sep 17 00:00:00 2001
From: Carlos Munoz <carlos.munoz@caviumnetworks.com>
Date: Fri, 13 Feb 2015 13:48:42 +0530
Subject: [PATCH 034/148] watchdog: Octeon: Add 68xx and cn78XX SOCs support.

Commit 065e02b58ab482c9802ecf1ae7b3f7393bff119c from
git://git.yoctoproject.org/linux-yocto-3.14

Signed-off-by: Carlos Munoz <carlos.munoz@caviumnetworks.com>
Signed-off-by: Abhishek Paliwal <abhishek.paliwal@aricent.com>
---
 drivers/watchdog/octeon-wdt-nmi.S | 40 +++++++++++++++++++++++++++++++--------
 1 file changed, 32 insertions(+), 8 deletions(-)

diff --git a/drivers/watchdog/octeon-wdt-nmi.S b/drivers/watchdog/octeon-wdt-nmi.S
index 8a900a5..a253837 100644
--- a/drivers/watchdog/octeon-wdt-nmi.S
+++ b/drivers/watchdog/octeon-wdt-nmi.S
@@ -3,20 +3,38 @@
  * License.  See the file "COPYING" in the main directory of this archive
  * for more details.
  *
- * Copyright (C) 2007 Cavium Networks
+ * Copyright (C) 2007 - 2012 Cavium, Inc.
  */
 #include <asm/asm.h>
 #include <asm/regdef.h>
 
-#define SAVE_REG(r)	sd $r, -32768+6912-(32-r)*8($0)
+#define CVMSEG_BASE -32768
+#define CVMSEG_SIZE (54 * 128)
+
+#define SAVE_REG(r)	sd $r, CVMSEG_BASE + CVMSEG_SIZE - ((32 - r) * 8)($0)
 
         NESTED(octeon_wdt_nmi_stage2, 0, sp)
 	.set 	push
 	.set 	noreorder
 	.set 	noat
-	/* Save all registers to the top CVMSEG. This shouldn't
+	/* Clear Dcache so cvmseg works right. */
+	cache   1,0($0)
+	/* Use K0 to do a read/modify/write of CVMMEMCTL */
+	dmfc0   k0, $11, 7
+	/* Clear out the size of CVMSEG */
+	dins    k0, $0, 0, 6
+	/* Set CVMSEG to its largest value */
+	ori     k0, k0, 0x1c0 | 54
+	/* Store the CVMMEMCTL value */
+	dmtc0   k0, $11, 7
+	/* Restore K0 from the debug scratch register */
+	dmfc0   k0, $31
+
+	/*
+	 * Save all registers to the top CVMSEG. This shouldn't
 	 * corrupt any state used by the kernel. Also all registers
-	 * should have the value right before the NMI. */
+	 * should have the value right before the NMI.
+	 */
 	SAVE_REG(0)
 	SAVE_REG(1)
 	SAVE_REG(2)
@@ -49,16 +67,22 @@
 	SAVE_REG(29)
 	SAVE_REG(30)
 	SAVE_REG(31)
+	/* Write zero to all CVMSEG locations per Core-15169 */
+	dli     a0, CVMSEG_SIZE - (33 * 8)
+1 :	sd      zero, CVMSEG_BASE(a0)
+	daddiu  a0, a0, -8
+	bgez    a0, 1b
+	nop
 	/* Set the stack to begin right below the registers */
-	li	sp, -32768+6912-32*8
+	dli     sp, CVMSEG_BASE + CVMSEG_SIZE - (32 * 8)
 	/* Load the address of the third stage handler */
-	dla	a0, octeon_wdt_nmi_stage3
+	dla      $25, octeon_wdt_nmi_stage3
 	/* Call the third stage handler */
-	jal	a0
+	jal	$25
 	/* a0 is the address of the saved registers */
 	 move	a0, sp
 	/* Loop forvever if we get here. */
-1:	b	1b
+2 :	b	2b
 	nop
 	.set pop
 	END(octeon_wdt_nmi_stage2)
-- 
1.8.2.1

