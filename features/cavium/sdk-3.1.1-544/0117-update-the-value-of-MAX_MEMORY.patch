From 811c940874f9994972b681a75ca1e2806f12b3ec Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Thu, 30 Aug 2012 17:44:50 +0800
Subject: [PATCH 117/132] update the value of MAX_MEMORY

get the correct value of MAX_MEMORY from bootinfo structure

Signed-off-by: Jack Tan <jack.tan@windriver.com>
[Remove totalram_pages, since it will be calculated in MM]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/cavium-octeon/setup.c | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index 33376c19..8dfc053 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -586,6 +586,7 @@ void __init prom_init(void)
 	 */
 	octeon_boot_desc_ptr = (struct octeon_boot_descriptor *)fw_arg3;
 	octeon_bootinfo = phys_to_virt(octeon_boot_desc_ptr->cvmx_desc_vaddr);
+	max_memory = (uint64_t)octeon_bootinfo->dram_size << 20;
 	cvmx_bootmem_init(octeon_bootinfo->phy_mem_desc_addr);
 
 	sysinfo = cvmx_sysinfo_get();
@@ -1124,7 +1125,6 @@ void __init mach_bootmem_init(void)
 		if (is_usable && (nd->startmempfn == 0 || start < nd->startmempfn))
 			nd->startmempfn = start;
 	}
-	totalram_pages = 0;
 
 	for_each_online_node(node) {
 		unsigned long bootmap_size;
@@ -1156,7 +1156,6 @@ void __init mach_bootmem_init(void)
 				       PFN_DOWN(boot_mem_map.map[i].addr),
 				       PFN_UP(boot_mem_map.map[i].addr + boot_mem_map.map[i].size));
 			if (!is_init) {
-				totalram_pages += PFN_DOWN(boot_mem_map.map[i].size);
 				memblock_add_node(boot_mem_map.map[i].addr, boot_mem_map.map[i].size, node);
 				free_bootmem_node(NODE_DATA(node), boot_mem_map.map[i].addr, boot_mem_map.map[i].size);
 			}
-- 
1.9.1

