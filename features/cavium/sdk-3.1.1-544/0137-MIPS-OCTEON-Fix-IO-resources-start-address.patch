From bded016499b2dea9acac26ddf10c2a4f4e265a58 Mon Sep 17 00:00:00 2001
From: Chandrakala Chavva <cchavva@localhost.localdomain>
Date: Mon, 25 Aug 2014 14:35:46 -0700
Subject: [PATCH 137/202] MIPS:OCTEON: Fix IO resources start address

Fixed io_resource start address for each PCIe port and also the
total ioport_resources size.

Signed-off-by: Chandrakala Chavva <cchavva@localhost.localdomain>
[Original patch taken from Cavium SDK 3.1.1-544]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/pci/pcie-octeon.c | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/arch/mips/pci/pcie-octeon.c b/arch/mips/pci/pcie-octeon.c
index 45662cb..754ec6c2 100644
--- a/arch/mips/pci/pcie-octeon.c
+++ b/arch/mips/pci/pcie-octeon.c
@@ -576,8 +576,7 @@ static int __init octeon_pcie_setup(void)
 	set_io_port_base(CVMX_ADD_IO_SEG(cvmx_pcie_get_io_base_address(0)));
 	ioport_resource.start = 0;
 	ioport_resource.end =
-		cvmx_pcie_get_io_base_address(CVMX_PCIE_PORTS-1) -
-		cvmx_pcie_get_io_base_address(0) + cvmx_pcie_get_io_size(1) - 1;
+		(cvmx_pcie_get_io_size(0) * CVMX_PCIE_PORTS) - 1;
 
 	/*
 	 * Create a dummy PCIe controller to swallow up bus 0. IDT bridges
@@ -682,7 +681,7 @@ static int __init octeon_pcie_setup(void)
 					octeon_pcie[port].controller.io_offset =
 						cvmx_pcie_get_io_base_address(port) - cvmx_pcie_get_io_base_address(port - 1);
 					octeon_pcie[port].io.start =
-						cvmx_pcie_get_io_base_address(port) - cvmx_pcie_get_io_base_address(port - 1);
+						cvmx_pcie_get_io_base_address(port) & ((1ull << 34) - 1);
 					octeon_pcie[port].io.end = octeon_pcie[port].io.start + cvmx_pcie_get_io_size(port) - 1;
 				}
 				msleep(100); /* Some devices need extra time */
-- 
1.8.2.1

