From 9b8994134437b507c8e44da778d43bb5ca14db4d Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 8 May 2014 18:23:03 -0400
Subject: [PATCH 075/202] netdev: octeon3-ethernet: Enable HW checksums.

l4ptr must be set even if not generating L4 checksums.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.1-544]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index 06d73b8..ded66f4 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -552,7 +552,7 @@ static int octeon3_eth_napi(struct napi_struct *napi, int budget)
 	return rx_count;
 }
 
-#define BROKEN_SIMULATOR_CSUM 1
+/* #define BROKEN_SIMULATOR_CSUM 1 */
 
 static int octeon3_eth_ndo_init(struct net_device *netdev)
 {
@@ -816,6 +816,7 @@ static int octeon3_eth_ndo_start_xmit(struct sk_buff *skb, struct net_device *ne
 		send_hdr.s.l3ptr = ETH_HLEN;
 		send_hdr.s.ckl3 = 1;
 		l4_hdr = ip_hdr(skb)->protocol;
+		send_hdr.s.l4ptr = ETH_HLEN + (4 * ip_hdr(skb)->ihl);
 		break;
 	case __constant_htons(ETH_P_IPV6):
 		l4_hdr = ipv6_hdr(skb)->nexthdr;
-- 
1.8.2.1

