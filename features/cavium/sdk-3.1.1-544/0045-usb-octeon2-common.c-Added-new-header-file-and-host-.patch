From 878b99a6ed04cf76f37a8328d5a9a4a67546a837 Mon Sep 17 00:00:00 2001
From: Abhishek Paliwal <abhishek.paliwal@aricent.com>
Date: Fri, 13 Feb 2015 13:56:33 +0530
Subject: [PATCH 045/148] usb: octeon2-common.c: Added new header file and host
 host controller

Commit 50f2a1390db2d47b755a3f4a85df7f55e26a9795 from
git://git.yoctoproject.org/linux-yocto-3.14

reset for kexec/kdump to work and only reset EHCI/OHCI on OCTEON2 devices.

We were getting bus errors on non-OCTEON2 with this code.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Vinita Gupta <vgupta@caviumnetworks.com>
Signed-off-by: Abhishek Paliwal <abhishek.paliwal@aricent.com>
---
 drivers/usb/host/octeon2-common.c | 28 ++++++++++++++++++++++++++++
 1 file changed, 28 insertions(+)

diff --git a/drivers/usb/host/octeon2-common.c b/drivers/usb/host/octeon2-common.c
index f52fa3b..b1e0537 100644
--- a/drivers/usb/host/octeon2-common.c
+++ b/drivers/usb/host/octeon2-common.c
@@ -14,6 +14,7 @@
 
 #include <asm/octeon/octeon.h>
 #include <asm/octeon/cvmx-uctlx-defs.h>
+#include <asm/octeon/cvmx-uahcx-defs.h>
 
 static DEFINE_MUTEX(octeon2_usb_clocks_mutex);
 
@@ -233,3 +234,30 @@ void octeon2_usb_clocks_stop(void)
 	mutex_unlock(&octeon2_usb_clocks_mutex);
 }
 EXPORT_SYMBOL(octeon2_usb_clocks_stop);
+
+static int __init octeon2_usb_reset(void)
+{
+	union cvmx_uctlx_clk_rst_ctl clk_rst_ctl;
+	union cvmx_uahcx_ehci_usbcmd ehci_usbcmd;
+	union cvmx_uahcx_ohci0_hccommandstatus ohci_usbcmd;
+
+	if (!OCTEON_IS_OCTEON2())
+		return 0;
+
+	clk_rst_ctl.u64 = cvmx_read_csr(CVMX_UCTLX_CLK_RST_CTL(0));
+	if (clk_rst_ctl.s.hrst) {
+		ehci_usbcmd.u32 = cvmx_read64_uint32(CVMX_UAHCX_EHCI_USBCMD(0));
+		ehci_usbcmd.s.rs = 0;
+		cvmx_write64_uint32(CVMX_UAHCX_EHCI_USBCMD(0), ehci_usbcmd.u32);
+		mdelay(2);
+		ehci_usbcmd.s.hcreset = 1;
+		cvmx_write64_uint32(CVMX_UAHCX_EHCI_USBCMD(0), ehci_usbcmd.u32);
+		ohci_usbcmd.u32 = cvmx_read64_uint32(CVMX_UAHCX_OHCI0_HCCOMMANDSTATUS(0));
+		ohci_usbcmd.s.hcr = 1;
+		cvmx_write64_uint32(CVMX_UAHCX_OHCI0_HCCOMMANDSTATUS(0), ohci_usbcmd.u32);
+	}
+	return 0;
+}
+
+arch_initcall(octeon2_usb_reset);
+
-- 
1.8.2.1

