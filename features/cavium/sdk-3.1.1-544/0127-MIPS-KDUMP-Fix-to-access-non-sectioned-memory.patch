From a77b2ecb3944f343e4e15d8e23923405494ffee0 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 13 Feb 2015 15:32:36 +0530
Subject: [PATCH 127/148] MIPS: KDUMP: Fix to access non-sectioned memory

Commit 5c429ae4ade1cc8d7e71db5a273dd7c6f0d2c2c3 from
git://git.yoctoproject.org/linux-yocto-3.14

When booted with initramfs, percpu crash_notes ends up in memory that is not accessible by crashkernel

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Prem Mallappa <pmallappa@caviumnetworks.com>
Signed-off-by: Abhishek Paliwal <abhishek.paliwal@aricent.com>
---
 arch/mips/kernel/crash_dump.c | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/arch/mips/kernel/crash_dump.c b/arch/mips/kernel/crash_dump.c
index f291cf9..8152ed5 100644
--- a/arch/mips/kernel/crash_dump.c
+++ b/arch/mips/kernel/crash_dump.c
@@ -3,6 +3,8 @@
 #include <linux/crash_dump.h>
 #include <asm/uaccess.h>
 #include <linux/slab.h>
+#include <linux/errno.h>
+#include <linux/io.h>
 
 static void *kdump_buf_page;
 
@@ -31,19 +33,20 @@ ssize_t copy_oldmem_page(unsigned long pfn, char *buf,
 	if (!csize)
 		return 0;
 
-	vaddr = kmap_atomic_pfn(pfn);
+	vaddr = ioremap(pfn << PAGE_SHIFT, PAGE_SIZE);
 
 	if (!userbuf) {
 		memcpy(buf, (vaddr + offset), csize);
-		kunmap_atomic(vaddr);
+		iounmap(vaddr);
 	} else {
 		if (!kdump_buf_page) {
 			pr_warning("Kdump: Kdump buffer page not allocated\n");
 
 			return -EFAULT;
 		}
+
 		copy_page(kdump_buf_page, vaddr);
-		kunmap_atomic(vaddr);
+		iounmap(vaddr);
 		if (copy_to_user(buf, (kdump_buf_page + offset), csize))
 			return -EFAULT;
 	}
-- 
1.8.2.1

