From ca2e576760325a26e4947631dbd40a129bddd0eb Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Mon, 8 Dec 2014 16:47:24 +0800
Subject: [PATCH 144/148] mips: OCTEON: Workround for kexec/kdump networking in
 cn78xx

For the limitation of octeon3 ethernet hardware, the network can't be
reset in the second kexec/kdump kernel. So add followings to start
networking as a workaround:
1. If the pko is enabled when booting the second kernel, don't
   initialize the pko hardware.

2. Before boot the second kdump kernel, use the function
   "cvmx_helper_shutdown_cmr_cn78xx" to disable tx/rx ports of
   SGMII interface.

3. When boot the second kernel, there are some warnings as below:
   "Already enabled intsn: 0xxxxxx".
   It's because the errbit intsn have been enabled in first boot,
   so run disable before enable it.

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 .../cavium-octeon/executive/cvmx-helper-pko3.c     |  9 ++++++++-
 arch/mips/cavium-octeon/executive/cvmx-helper.c    | 22 ++++++++++++++++++++++
 arch/mips/cavium-octeon/octeon-error-tree.c        |  6 +++++-
 arch/mips/cavium-octeon/setup.c                    |  2 ++
 drivers/net/ethernet/octeon/octeon3-ethernet.c     | 11 ++++++++++-
 5 files changed, 47 insertions(+), 3 deletions(-)

diff --git a/arch/mips/cavium-octeon/executive/cvmx-helper-pko3.c b/arch/mips/cavium-octeon/executive/cvmx-helper-pko3.c
index ae77de4..2e465d3 100644
--- a/arch/mips/cavium-octeon/executive/cvmx-helper-pko3.c
+++ b/arch/mips/cavium-octeon/executive/cvmx-helper-pko3.c
@@ -1029,7 +1029,12 @@ int cvmx_helper_pko3_init_interface(int xiface)
 int __cvmx_helper_pko3_init_global(unsigned int node, uint16_t gaura)
 {
 	int res;
+#if defined(CONFIG_KEXEC) || defined(CONFIG_CRASH_DUMP)
+	cvmx_pko_enable_t pko_enable;
 
+	pko_enable.u64 = cvmx_read_csr_node(node, CVMX_PKO_ENABLE);
+	if (!pko_enable.s.enable) {
+#endif
 	res = cvmx_pko3_hw_init_global(node, gaura);
 	if(res < 0) {
 		cvmx_dprintf("ERROR: %s:failed block initialization\n",
@@ -1040,7 +1045,9 @@ int __cvmx_helper_pko3_init_global(unsigned int node, uint16_t gaura)
 	/* configure channel level */
 	cvmx_pko_setup_channel_credit_level(node,
 		cvmx_pko_default_channel_level);
-
+#if defined(CONFIG_KEXEC) || defined(CONFIG_CRASH_DUMP)
+	}
+#endif
 	/* add NULL MAC/DQ setup */
 	res = __cvmx_pko3_config_null_interface(node);
 	if (res < 0)
diff --git a/arch/mips/cavium-octeon/executive/cvmx-helper.c b/arch/mips/cavium-octeon/executive/cvmx-helper.c
index 78a6b73..3e41074 100644
--- a/arch/mips/cavium-octeon/executive/cvmx-helper.c
+++ b/arch/mips/cavium-octeon/executive/cvmx-helper.c
@@ -1911,6 +1911,28 @@ static int __cvmx_helper_shutdown_packet_io_global_cn78xx(int node)
 	return result;
 }
 
+void cvmx_helper_shutdown_cmr_cn78xx(void)
+{
+	int num_interfaces = cvmx_helper_get_number_of_interfaces();
+	int interface;
+	int index;
+	int num_ports = 4;
+	/* Shut down all interfaces and disable TX and RX on all ports */
+	for (interface = 0; interface < num_interfaces; interface++) {
+		switch (cvmx_helper_interface_get_mode(interface)) {
+			case CVMX_HELPER_INTERFACE_MODE_SGMII:
+				for (index = 0; index < num_ports; index++)
+					if ((cvmx_read_csr(CVMX_BGXX_CMRX_CONFIG(index, interface)) & 0xe000) == 0xe000){
+						cvmx_write_csr(CVMX_BGXX_CMRX_CONFIG(index, interface), 0);
+						mdelay(1);
+					}
+			break;
+		default:
+			break;
+		}
+	}
+}
+
 /**
  * Undo the initialization performed in
  * cvmx_helper_initialize_packet_io_global(). After calling this routine and the
diff --git a/arch/mips/cavium-octeon/octeon-error-tree.c b/arch/mips/cavium-octeon/octeon-error-tree.c
index 3181e6c..6b574af 100644
--- a/arch/mips/cavium-octeon/octeon-error-tree.c
+++ b/arch/mips/cavium-octeon/octeon-error-tree.c
@@ -325,7 +325,11 @@ static int __init octeon_error_tree_init78(void)
 	for (i = 0; error_array_cn78xxp1[i].intsn < 0xfffff; i++)
 		/* Just count them... */;
 	octeon_78xx_tree_size = i;
-
+#if defined(CONFIG_KEXEC) || defined(CONFIG_CRASH_DUMP)
+	for (i = 0; error_array_cn78xxp1[i].intsn < 0xfffff; i++)
+		if (error_array_cn78xxp1[i].error_group != CVMX_ERROR_GROUP_ETHERNET)
+			octeon_ciu3_errbits_disable_intsn(0, error_array_cn78xxp1[i].intsn);
+#endif
 	for (i = 0; error_array_cn78xxp1[i].intsn < 0xfffff; i++)
 		if (error_array_cn78xxp1[i].error_group != CVMX_ERROR_GROUP_ETHERNET)
 			octeon_ciu3_errbits_enable_intsn(0, error_array_cn78xxp1[i].intsn);
diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index c93fa0d..7101b0e 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -156,8 +156,10 @@ static void octeon_shutdown(void)
 #endif
 }
 
+extern void cvmx_helper_shutdown_cmr_cn78xx(void);
 static void octeon_crash_shutdown(struct pt_regs *regs)
 {
+	cvmx_helper_shutdown_cmr_cn78xx();
 	octeon_generic_shutdown();
 	default_machine_crash_shutdown(regs);
 }
diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index 2e3e370..3ac218a 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -1947,7 +1947,16 @@ static int octeon3_eth_probe(struct platform_device *pdev)
 	int r;
 
 	struct bgx_platform_data *pd = dev_get_platdata(&pdev->dev);
-
+#if defined(CONFIG_KEXEC) || defined(CONFIG_CRASH_DUMP)
+	static bool cvmx_res_clear = false;
+	if (cvmx_res_clear == false) {
+		cvmx_bootmem_phy_named_block_free("cvmx-global-resources",CVMX_BOOTMEM_FLAG_NO_LOCKING);
+		cvmx_bootmem_phy_named_block_free("cvmx_pko3_global_dq_table",CVMX_BOOTMEM_FLAG_NO_LOCKING);
+		cvmx_bootmem_phy_named_block_free("cvmx-app-config",CVMX_BOOTMEM_FLAG_NO_LOCKING);
+		cvmx_bootmem_phy_named_block_free("cvmx-app-id",CVMX_BOOTMEM_FLAG_NO_LOCKING);
+		cvmx_res_clear = true;
+	}
+#endif
 	r = octeon3_eth_global_init(pd->numa_node);
 	if (r)
 		return r;
-- 
1.8.2.1

