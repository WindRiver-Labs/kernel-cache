From 456d08e039cbc96e613ddf4aca0a13767d7dd7f1 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 25 Sep 2014 09:22:22 -0700
Subject: [PATCH 153/202] MIPS: Allow sub-architecture 'machines' to override
 bootmem initialization.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.1-544]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/include/asm/mach-generic/mach_bootmem.h | 1 +
 arch/mips/kernel/setup.c                          | 9 ++++++++-
 2 files changed, 9 insertions(+), 1 deletion(-)
 create mode 100644 arch/mips/include/asm/mach-generic/mach_bootmem.h

diff --git a/arch/mips/include/asm/mach-generic/mach_bootmem.h b/arch/mips/include/asm/mach-generic/mach_bootmem.h
new file mode 100644
index 0000000..710cecc
--- /dev/null
+++ b/arch/mips/include/asm/mach-generic/mach_bootmem.h
@@ -0,0 +1 @@
+/* Empty */
diff --git a/arch/mips/kernel/setup.c b/arch/mips/kernel/setup.c
index a1eb5c8..dac7217 100644
--- a/arch/mips/kernel/setup.c
+++ b/arch/mips/kernel/setup.c
@@ -35,6 +35,8 @@
 #include <asm/smp-ops.h>
 #include <asm/prom.h>
 
+#include <mach_bootmem.h>
+
 struct cpuinfo_mips cpu_data[NR_CPUS] __read_mostly;
 
 EXPORT_SYMBOL(cpu_data);
@@ -283,11 +285,16 @@ static unsigned long __init init_initrd(void)
  * Initialize the bootmem allocator. It also setup initrd related data
  * if needed.
  */
-#ifdef CONFIG_SGI_IP27
+#if defined(CONFIG_SGI_IP27) || defined(mach_bootmem_init)
+
+#ifndef mach_bootmem_init
+static void mach_bootmem_init(void) {}
+#endif
 
 static void __init bootmem_init(void)
 {
 	init_initrd();
+	mach_bootmem_init();
 	finalize_initrd();
 }
 
-- 
1.8.2.1

