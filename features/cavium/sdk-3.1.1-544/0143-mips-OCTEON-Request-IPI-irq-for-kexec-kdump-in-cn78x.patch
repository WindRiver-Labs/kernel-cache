From f55b2704187694d47eee6bb537323fffd4fb24c9 Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Fri, 5 Dec 2014 14:50:31 +0800
Subject: [PATCH 143/148] mips: OCTEON: Request IPI irq for kexec/kdump in
 cn78xx

Fixed handling IPI in secondary cores for cn78xx.

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/smp.c    | 15 +++++++++++++++
 arch/mips/kernel/machine_kexec.c |  2 ++
 2 files changed, 17 insertions(+)

diff --git a/arch/mips/cavium-octeon/smp.c b/arch/mips/cavium-octeon/smp.c
index b96fad9..b8ffcd2 100644
--- a/arch/mips/cavium-octeon/smp.c
+++ b/arch/mips/cavium-octeon/smp.c
@@ -460,6 +460,14 @@ static irqreturn_t octeon_78xx_icache_flush_interrupt(int irq, void *dev_id)
 	return IRQ_HANDLED;
 }
 
+#ifdef CONFIG_KEXEC
+static irqreturn_t octeon_78xx_kdump_interrupt(int irq, void *dev_id)
+{
+	octeon_crash_dump();
+	return IRQ_HANDLED;
+}
+#endif
+
 /*
  * Callout to firmware before smp_init
  */
@@ -480,6 +488,13 @@ static void octeon_78xx_prepare_cpus(unsigned int max_cpus)
 			octeon_78xx_icache_flush_interrupt)) {
 		panic("Cannot request_irq for ICache-Flush");
 	}
+#ifdef CONFIG_KEXEC
+	if (request_irq(OCTEON_IRQ_MBOX0 + 3, octeon_78xx_kdump_interrupt,
+			IRQF_PERCPU | IRQF_NO_THREAD, "kdump-crash",
+			octeon_78xx_kdump_interrupt)) {
+		panic("Cannot request_irq for kdump-crash");
+	}
+#endif
 }
 
 static void octeon_78xx_send_ipi_single(int cpu, unsigned int action)
diff --git a/arch/mips/kernel/machine_kexec.c b/arch/mips/kernel/machine_kexec.c
index 992e184..1d66ed6 100644
--- a/arch/mips/kernel/machine_kexec.c
+++ b/arch/mips/kernel/machine_kexec.c
@@ -105,6 +105,8 @@ machine_kexec(struct kimage *image)
 		(void *)(kexec_smp_wait - relocate_new_kernel);
 	smp_wmb();
 	atomic_set(&kexec_ready_to_reboot, 1);
+	printk("Delay 10ms for other cpus enter correct state\n");
+	mdelay(10);
 #endif
 	((noretfun_t) reboot_code_buffer)();
 }
-- 
1.8.2.1

