From b8c38c78ba35070df77975fc6324b73b225dcdd0 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 26 Jun 2014 16:28:17 -0700
Subject: [PATCH 112/202] MIPS: Load invalid TLB entries on VM size overflow.

A real fault will be generated on subsequent TLBL/TLBM/TLBS
Exceptions.

This allows the TLB Refill handler to work without having to leave
Guest mode, just load "Invalid" entries, and return.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.1-544]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/mm/tlbex.c | 13 ++++++++-----
 1 file changed, 8 insertions(+), 5 deletions(-)

diff --git a/arch/mips/mm/tlbex.c b/arch/mips/mm/tlbex.c
index 46aa751..09956b4 100644
--- a/arch/mips/mm/tlbex.c
+++ b/arch/mips/mm/tlbex.c
@@ -937,17 +937,20 @@ build_get_pgd_vmalloc64(u32 **p, struct uasm_label **l, struct uasm_reloc **r,
 		 * to mimic that here by taking a load/istream page
 		 * fault.
 		 */
-		UASM_i_LA(p, ptr, (unsigned long)tlb_do_page_fault_0);
-		uasm_i_jr(p, ptr);
-
+		UASM_i_MTC0(p, 0, C0_ENTRYLO0); /* Invalid */
+		UASM_i_MTC0(p, 0, C0_ENTRYLO1); /* Invalid */
+		build_tlb_write_entry(p, l, r, tlb_random);
 		if (mode == refill_scratch) {
 			if (scratch_reg > 0)
 				UASM_i_MFC0(p, 1, 31, scratch_reg);
 			else
 				UASM_i_LW(p, 1, scratchpad_offset(0), 0);
-		} else {
-			uasm_i_nop(p);
 		}
+#ifdef CONFIG_KVM_MIPS_VZ
+		UASM_i_MFC0(p, K0, 31, 2);
+		UASM_i_MFC0(p, K1, 31, 3);
+#endif
+		uasm_i_eret(p); /* return from trap */
 	}
 }
 
-- 
1.8.2.1

