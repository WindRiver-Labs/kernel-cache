From 93928dc5706442635587241c0c06ad4abb544878 Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Wed, 17 Feb 2016 14:02:34 +0800
Subject: [PATCH] MIPS: OCTEON: perf: Replace current_cpu_type() with
 OCTEON_IS_OCTEON3()

The current_cpu_type() function calls smp_processor_id in preemptible
context. So replace current_cpu_type() with OCTEON_IS_OCTEON3() or else
it will occurr calltrace as below:

BUG: using smp_processor_id() in preemptible [00000000 00000000] code: cat/2699
caller is proc_perf_show+0x5a4/0xbf8
CPU: 0 PID: 2699 Comm: cat Not tainted 3.10.62-ltsi-rt55-WR6.0.0.0_preempt-rt #1
Stack : 0000000000000000 0000000000000050 0000000000000000 0000000000000001
0000000000000004 ffffffff813b0000 0000000000000000 0000000000000001
ffffffff815b0000 0000000000000000 0000000000000050 0000000000000006
80000001ff1efb60 ffffffff80897a74 0000000000000000 0000000000000000
0000000000000001 0000000000000000 ffffffff81590000 ffffffff81590000
ffffffff811cc6c0 ffffffff812f6777 ffffffff8158c7e8 80000001ff2183a0
0000000000000a8b 0000000000000000 0000015d2e0df618 0000000000000003
80000001ff1efbe0 80000001ff1efaf0 80000001ff1efc08 ffffffff80cdf4f8
80000001ff1efc40 ffffffff80899668 80000001ff218000 ffffffff811cc6c0
0000000000000000 ffffffff8086eb38 0000000000000000 0000000000000000
...
Call Trace:
[<ffffffff8086eb38>] show_stack+0xd8/0xf8
[<ffffffff80cdf4f8>] debug_smp_processor_id+0x128/0x150
[<ffffffff808658ec>] proc_perf_show+0x5a4/0xbf8
[<ffffffff80a06070>] seq_read+0x220/0x4b8
[<ffffffff80a47c54>] proc_reg_read+0x7c/0xc8
[<ffffffff809d9aa0>] vfs_read+0xb0/0x1b8
[<ffffffff809da608>] SyS_read+0x68/0xd8
[<ffffffff8087da00>] handle_sys+0x120/0x144

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/perf_counters.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/arch/mips/cavium-octeon/perf_counters.c b/arch/mips/cavium-octeon/perf_counters.c
index 223be3d..685892e 100644
--- a/arch/mips/cavium-octeon/perf_counters.c
+++ b/arch/mips/cavium-octeon/perf_counters.c
@@ -472,7 +472,7 @@ static int proc_perf_show(struct seq_file *m, void *v)
 
 			/* Check if LMC controller is enabled. */
 			ctl2.u64 = cvmx_read_csr(CVMX_LMCX_DLL_CTL2(tad));
-			if (current_cpu_type() == CPU_CAVIUM_OCTEON3) {
+			if (OCTEON_IS_OCTEON3()) {
 				if (ctl2.cn70xx.quad_dll_ena == 0)
 					continue;
 			} else if (ctl2.cn63xx.quad_dll_ena == 0)
-- 
1.7.5.4

