From 3e380ddae2265be8f09273c2a5baf1e1b4e1b2e3 Mon Sep 17 00:00:00 2001
From: Radha Mohan Chintakuntla <rchintakuntla@cavium.com>
Date: Fri, 27 Feb 2015 11:48:15 -0800
Subject: [PATCH 108/184] pci, thunderx: Fix devm_kfree/kfree misuse

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from THUNDERX Tree
ChangeID: 53ac24c94a3230e2a572b9de31c052399ce1bd94
Description:

The ThunderX PCIe driver does

 foo = devm_kzalloc(...);
 [...]
 kfree(foo);

Unfortunately devm functions and normal slab allocations are completely
different concepts. With the above construct, the end result is memory
corruption because

 a) we free a devm pool chunk that be used for more than foo
 b) the address is unaligned to the slab it's on, so on next kzalloc()
   the allocated pointer will be unaligned and hence stretch into the
   next slab object

This patch changes the code to use the devm_kfree() function instead, as
was probably intended from the beginning.

Signed-off-by: Alexander Graf <agraf@suse.de>
Acked-by: Radha Mohan Chintakuntla <rchintakuntla@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/pci/host/pcie-thunder.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/pci/host/pcie-thunder.c b/drivers/pci/host/pcie-thunder.c
index 2769420..a729bd5 100644
--- a/drivers/pci/host/pcie-thunder.c
+++ b/drivers/pci/host/pcie-thunder.c
@@ -217,7 +217,7 @@ err_pci:
 	devm_ioremap_release(pcie->dev, pcie->cfg_base);
 err_ioremap:
 	of_node_put(pcie->node);
-	kfree(pcie);
+	devm_kfree(&pdev->dev, pcie);
 	return ret;
 }
 
-- 
1.9.1

