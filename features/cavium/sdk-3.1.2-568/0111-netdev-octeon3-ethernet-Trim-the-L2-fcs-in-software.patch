From 3db489b9a2cfcd7ce6e99b46ac090c9788107672 Mon Sep 17 00:00:00 2001
From: Carlos Munoz <cmunoz@caviumnetworks.com>
Date: Fri, 10 Apr 2015 12:59:28 -0700
Subject: [PATCH 111/184] netdev: octeon3-ethernet: Trim the L2 fcs in
 software.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 853804813867a8be82c7642764daa8f3cef1f275
Description:

Signed-off-by: Carlos Munoz <cmunoz@caviumnetworks.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index 8a4168a..b1ca495 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -1216,6 +1216,8 @@ static int octeon3_eth_rx_one(struct octeon3_rx *rx, bool is_async,
 	skb->len = packet_len;
 	len_remaining = packet_len;
 	if (segments == 1) {
+		/* Strip the ethernet fcs */
+		skb->len -= 4;
 		skb_set_tail_pointer(skb, skb->len);
 	} else {
 		bool first_frag = true;
@@ -1253,7 +1255,11 @@ static int octeon3_eth_rx_one(struct octeon3_rx *rx, bool is_async,
 			first_frag = false;
 			current_skb->data = data;
 		}
+
+		/* Strip the ethernet fcs */
+		pskb_trim(skb, skb->len - 4);
 	}
+
 	if (likely(priv->netdev->flags & IFF_UP)) {
 		skb_checksum_none_assert(skb);
 		skb->protocol = eth_type_trans(skb, priv->netdev);
@@ -1607,6 +1613,7 @@ static int octeon3_eth_ndo_init(struct net_device *netdev)
 	pki_prt_cfg.style_cfg.parm_cfg.lenerr_en = true;
 	pki_prt_cfg.style_cfg.parm_cfg.maxerr_en = false;
 	pki_prt_cfg.style_cfg.parm_cfg.minerr_en = false;
+	pki_prt_cfg.style_cfg.parm_cfg.fcs_strip = false;
 	pki_prt_cfg.style_cfg.parm_cfg.ip6_udp_opt = false;
 	pki_prt_cfg.style_cfg.parm_cfg.ip6_udp_opt = false;
 	pki_prt_cfg.style_cfg.parm_cfg.wqe_skip = 1 * 128;
-- 
1.9.1

