From 4171f5ae1b21b372f0684c4f4068a9d4edb1ca05 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Sat, 5 Jul 2014 18:05:50 -0700
Subject: [PATCH 809/974] MIPS: OCTEON: Use non-threaded hander for chainging
 to PCIe WAR interrupts.

The PREEMPT_RT kernel uses threaded handlers by default resulting in:

WARNING: at kernel/irq/handle.c:148 handle_irq_event_percpu+0x1dc/0x1f0()
irq 15 handler irq_default_primary_handler+0x0/0x8 enabled interrupts
Modules linked in: m25p80
CPU: 49 PID: 908 Comm: irq/74-inta-war Not tainted 3.10.56-rt50-Cavium-Octeon+ #1
Stack : 0000000000000280 ffffffff808e0000 ffffffff837f0000 ffffffff808e0000
          0000000000000001 ffffffff801a64f0 ffffffff837f0000 ffffffff80176db8
          0000000000000006 ffffffff837f0000 ffffffff808e0000 ffffffff80177728
          0000000000000000 0000000000000000 0000000000000000 ffffffff83800000
          ffffffff837f5be8 ffffffff837f0000 ffffffff807a2fb8 ffffffff808455f7
          ffffffff837f5be8 80000008043346b0 000000000000038c 0000000000000031
          0000000000000000 ffffffff807aa068 ffffffff807aa050 ffffffff8064b27c
          800000080428fb98 800000080428fa90 ffffffff807aa050 ffffffff80174fb0
          8000000804334350 ffffffff807a2fb8 0000000000000031 000000000000038c
          0000000000000000 ffffffff801549f8 0000000000000000 0000000000000000
          ...
Call Trace:
[<ffffffff801549f8>] show_stack+0x68/0x80
[<ffffffff80174fb0>] warn_slowpath_common+0x78/0xa8
[<ffffffff80175080>] warn_slowpath_fmt+0x38/0x48
ohci_hcd: USB 1.1 'Open' Host Controller (OHCI) Driver
[<ffffffff801cc354>] handle_irq_event_percpu+0x1dc/0x1f0
[<ffffffff801cc3d0>] handle_irq_event+0x68/0xa8
[<ffffffff801cf52c>] handle_simple_irq+0x9c/0x108
[<ffffffff801cb7e0>] generic_handle_irq+0x28/0x48
[<ffffffff80561a10>] pcie_17400_handler+0x18/0x108
[<ffffffff801cd4f4>] irq_forced_thread_fn+0x2c/0x88
[<ffffffff801cd218>] irq_thread+0x138/0x180
[<ffffffff8019a954>] kthread+0xa4/0xb0
[<ffffffff8014fae4>] ret_from_kernel_thread+0x14/0x1c

To fix it, we must specify IRQF_NO_THREAD.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/pci/pcie-octeon.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/arch/mips/pci/pcie-octeon.c b/arch/mips/pci/pcie-octeon.c
index 8ac5e01..ef42dc7 100644
--- a/arch/mips/pci/pcie-octeon.c
+++ b/arch/mips/pci/pcie-octeon.c
@@ -161,7 +161,7 @@ static int __init octeon_pcie78xx_pcibios_map_irq(const struct pci_dev *dev,
 	irqd_set_trigger_type(irq_get_irq_data(irq), IRQ_TYPE_EDGE_RISING);
 
 	irq_set_status_flags(irq, IRQ_NOAUTOEN);
-	rv = request_irq(irq, pcie_17400_handler, 0, "inta-war", cd);
+	rv = request_irq(irq, pcie_17400_handler, IRQF_NO_THREAD, "inta-war", cd);
 	if (WARN(rv, "request_irq failed.\n"))
 		goto err;
 
-- 
2.6.2

