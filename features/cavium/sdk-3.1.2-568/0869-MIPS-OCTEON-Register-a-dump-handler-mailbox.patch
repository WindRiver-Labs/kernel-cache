From b506c46b5e58ba81768f8036a90a910df53e37f3 Mon Sep 17 00:00:00 2001
From: Corey Minyard <cminyard@mvista.com>
Date: Sun, 6 Jul 2014 18:05:50 -0700
Subject: [PATCH 869/974] MIPS:OCTEON: Register a dump handler mailbox

This makes sure all processors except the one doing kexec are
shut down when doing a kexec.

Signed-off-by: Corey Minyard <cminyard@mvista.com>
Cc: Arun Chandran <achandran@mvista.com>
Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/smp.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/arch/mips/cavium-octeon/smp.c b/arch/mips/cavium-octeon/smp.c
index 4440c8c..cec7b57 100644
--- a/arch/mips/cavium-octeon/smp.c
+++ b/arch/mips/cavium-octeon/smp.c
@@ -273,6 +273,12 @@ static void __cpuinit octeon_init_secondary(void)
 	octeon_irq_setup_secondary();
 }
 
+static irqreturn_t octeon_78xx_smp_dump_interrupt(int irq, void *dev_id)
+{
+	octeon_crash_dump();
+	return IRQ_HANDLED;
+}
+
 /**
  * Callout to firmware before smp_init
  *
@@ -486,6 +492,11 @@ static void octeon_78xx_prepare_cpus(unsigned int max_cpus)
 			octeon_78xx_icache_flush_interrupt)) {
 		panic("Cannot request_irq for ICache-Flush");
 	}
+	if (request_irq(OCTEON_IRQ_MBOX0 + 3, octeon_78xx_smp_dump_interrupt,
+			IRQF_PERCPU | IRQF_NO_THREAD, "SMP-Dump",
+			octeon_78xx_smp_dump_interrupt)) {
+		panic("Cannot request_irq for SMP-Dump");
+	}
 }
 
 static void octeon_78xx_send_ipi_single(int cpu, unsigned int action)
-- 
2.6.2

