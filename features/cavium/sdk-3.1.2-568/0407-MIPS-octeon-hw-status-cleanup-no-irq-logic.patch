From 9ac79e794797fda5c9b2849c992567f308ae20ae Mon Sep 17 00:00:00 2001
From: Peter Swain <peter.swain@cavium.com>
Date: Thu, 14 Nov 2013 15:28:39 -0800
Subject: [PATCH 407/974] MIPS: octeon-hw-status: cleanup no-irq logic

Fixed another merge mess (stray '!', remove DEBUG),
and reformatted the whole root_created block.
Much finger-fumbling today.
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/octeon-hw-status.c | 44 +++++++++++++++++-------------
 1 file changed, 25 insertions(+), 19 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-hw-status.c b/arch/mips/cavium-octeon/octeon-hw-status.c
index 2972472..de06f09 100644
--- a/arch/mips/cavium-octeon/octeon-hw-status.c
+++ b/arch/mips/cavium-octeon/octeon-hw-status.c
@@ -1,4 +1,3 @@
-#define DEBUG
 /*
  * This file is subject to the terms and conditions of the GNU General Public
  * License.  See the file "COPYING" in the main directory of this archive
@@ -426,28 +425,35 @@ int octeon_hw_status_add_source(struct octeon_hw_status_reg *chain0)
 	WARN(oflow, pr_fmt("Reference count overflowed!\n"));
 	warn_mismatch(&match);
 
-	if (root_created && !root->irq) {
-		WARN(rv, pr_fmt("handler for irq %d already set\n"),
-			root->irq);
-	} else if (root_created) {
-		/* register an interrupt handler */
-		root->irq = irq_create_mapping(NULL, root->hwint);
-		if (!root->irq) {
-			rv = -ENXIO;
-			goto bye;
+	if (root_created) {
+		if (root->irq) {
+			WARN(rv, pr_fmt("handler for irq %d already set\n"),
+				root->irq);
+		} else {
+			/* register an interrupt handler */
+			root->irq = irq_create_mapping(NULL, root->hwint);
+
+			if (!root->irq) {
+				WARN(rv, pr_fmt("cannot map handler"
+					" for hwint %d\n"),
+					(int) root->hwint);
+				rv = -ENXIO;
+				goto bye;
+			}
+
+			rv = request_threaded_irq(root->irq, NULL,
+					octeon_hw_status_irq, IRQF_ONESHOT,
+					"octeon-hw-status", root);
+			WARN(rv, pr_fmt("request_threaded_irq failed:"
+				" irq %d, err %d\n"),
+				root->irq, rv);
 		}
 
-		rv = request_threaded_irq(root->irq, NULL, octeon_hw_status_irq,
-					  IRQF_ONESHOT, "octeon-hw-status",
-					  root);
-		WARN(rv, pr_fmt("request_threaded_irq failed: irq %d, err %d\n"),
-			root->irq, rv);
+		if (count_debug)
+			pr_debug("%d/%d created root\n",
+			       (int)root->hwint, root->irq);
 	}
 
-	if (count_debug && root_created)
-		pr_debug("%d/%d created root\n",
-		       (int)root->hwint, root->irq);
-
 	/* notifies on leaf creation, not intermediate nodes */
 	ohsd.reg = w->reg;
 	ohsd.bit = w->bit;
-- 
2.6.2

