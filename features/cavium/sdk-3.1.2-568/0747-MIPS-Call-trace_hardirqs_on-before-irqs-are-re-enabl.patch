From 8f4357210e6e5abf99df9258776864105cacc66f Mon Sep 17 00:00:00 2001
From: Andreas Herrmann <andreas.herrmann@caviumnetworks.com>
Date: Fri, 4 Jul 2014 18:05:50 -0700
Subject: [PATCH 747/974] MIPS: Call trace_hardirqs_on before irqs are
 re-enabled in syscall_exit_work

Otherwise following warning is triggered when CONFIG_TRACE_IRQFLAGS=y

 [  278.973617] WARNING: at /home/reasand/projects/repos/cv/linux-base/trunk/kernel/linux-octeon-sdk/kernel/lockdep.c:2580 syscall_exit_work+0x30/0x44()
 [  278.987176] DEBUG_LOCKS_WARN_ON(!irqs_disabled())
 [  278.991714] Modules linked in:
 [  278.994972] CPU: 1 PID: 1311 Comm: lkvm-sdk-static Not tainted 3.10.14-sdk-mipsvz-00782-gd06f965 #51
       ...

or under KVM

 [    1.950000] WARNING: at /home/reasand/projects/repos/cv/linux-base/trunk/kernel/linux-octeon-sdk/kernel/lockdep.c:2580 syscall_exit_work+0x30/0x44()
 [    1.950000] DEBUG_LOCKS_WARN_ON(!irqs_disabled())
 [    1.950000] Modules linked in:
 [    1.950000] CPU: 0 PID: 1 Comm: init Not tainted 3.10.14-00781-gc9c0807-dirty #57
      ...

trace_hardirqs_on needs to be used before irqs are enabled otherwise
we'll trigger above warning(s) for sure. (the saved IRQ state won't
match the hardware state -- see comments in trace_hardirqs_on_caller).

Signed-off-by: Andreas Herrmann <andreas.herrmann@caviumnetworks.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/kernel/entry.S | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/arch/mips/kernel/entry.S b/arch/mips/kernel/entry.S
index 1b6ee6e..b77cd25 100644
--- a/arch/mips/kernel/entry.S
+++ b/arch/mips/kernel/entry.S
@@ -208,11 +208,12 @@ syscall_exit_work:
 	li	t0, _TIF_WORK_SYSCALL_EXIT
 	and	t0, a2			# a2 is preloaded with TI_FLAGS
 	beqz	t0, work_pending	# trace bit set?
-	local_irq_enable		# could let syscall_trace_leave()
+					# could let syscall_trace_leave()
 					# call schedule() instead
 #ifdef CONFIG_TRACE_IRQFLAGS
 	jal	trace_hardirqs_on
 #endif
+	local_irq_enable
 	move	a0, sp
 	jal	syscall_trace_leave
 	b	resume_userspace
-- 
2.6.2

