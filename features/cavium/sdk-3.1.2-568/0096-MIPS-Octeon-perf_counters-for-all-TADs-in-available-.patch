From 02215f6068854a7a54903213e2d86f4db20e6cde Mon Sep 17 00:00:00 2001
From: Venkat Subbiah <venkat.subbiah@cavium.com>
Date: Mon, 19 Nov 2012 14:28:36 -0800
Subject: [PATCH 096/974] MIPS: Octeon: perf_counters for all TADs in available
 LMC controllers

Check all 4 TADs for 68XX chips.

Signed-off-by: Venkat Subbiah <venkat.subbiah@cavium.com>
Signed-off-by: Leonid Rosenboim <lrosenboim@caviumnetworks.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/perf_counters.c |  8 +++++++-
 arch/mips/include/asm/octeon/cvmx-l2c.h | 13 ++++++++++---
 2 files changed, 17 insertions(+), 4 deletions(-)

diff --git a/arch/mips/cavium-octeon/perf_counters.c b/arch/mips/cavium-octeon/perf_counters.c
index cf23d80..8f385bb 100644
--- a/arch/mips/cavium-octeon/perf_counters.c
+++ b/arch/mips/cavium-octeon/perf_counters.c
@@ -379,7 +379,13 @@ static int proc_perf_show(struct seq_file *m, void *v)
 		int tad;
 		dram_operations = 0;
 		dram_clocks = 0;
-		for (tad = 0; tad < 1; tad++) {
+		for (tad = 0; tad < CVMX_L2C_TADS; tad++) {
+			union cvmx_lmcx_dll_ctl2 ctl2;
+
+			/* Check if LMC controller is enabled. */
+			ctl2.u64 = cvmx_read_csr(CVMX_LMCX_DLL_CTL2(tad));
+			if (ctl2.s.quad_dll_ena == 0)
+				continue;
 			dram_operations += cvmx_read_csr
 					(CVMX_LMCX_OPS_CNT(tad));
 			dram_clocks += cvmx_read_csr
diff --git a/arch/mips/include/asm/octeon/cvmx-l2c.h b/arch/mips/include/asm/octeon/cvmx-l2c.h
index 11c0a8f..f403316 100644
--- a/arch/mips/include/asm/octeon/cvmx-l2c.h
+++ b/arch/mips/include/asm/octeon/cvmx-l2c.h
@@ -46,6 +46,16 @@
 #define CVMX_L2C_ALIAS_MASK (CVMX_L2C_IDX_MASK << CVMX_L2C_TAG_ADDR_ALIAS_SHIFT)
 #define CVMX_L2C_MEMBANK_SELECT_SIZE  4096
 
+/* Maximium number of TADs */
+#define CVMX_L2C_MAX_TADS     4
+/* Maximium number of L2C performance counters */
+#define CVMX_L2C_MAX_PCNT     4
+
+/* Number of L2C Tag-and-data sections (TADs) that are connected to LMC. */
+#define CVMX_L2C_TADS  ((OCTEON_IS_MODEL(OCTEON_CN68XX)) ? 4 : 1)
+/* Number of L2C IOBs connected to LMC. */
+#define CVMX_L2C_IOBS  ((OCTEON_IS_MODEL(OCTEON_CN68XX)) ? 2 : 1)
+
 /* Defines for Virtualizations, valid only from Octeon II onwards. */
 #define CVMX_L2C_VRT_MAX_VIRTID_ALLOWED ((OCTEON_IS_MODEL(OCTEON_CN63XX)) ? 64 : 0)
 #define CVMX_L2C_VRT_MAX_MEMSZ_ALLOWED ((OCTEON_IS_MODEL(OCTEON_CN63XX)) ? 32 : 0)
@@ -62,9 +72,6 @@ union cvmx_l2c_tag {
 	} s;
 };
 
-/* Number of L2C Tag-and-data sections (TADs) that are connected to LMC. */
-#define CVMX_L2C_TADS  1
-
   /* L2C Performance Counter events. */
 enum cvmx_l2c_event {
 	CVMX_L2C_EVENT_CYCLES		=  0,
-- 
2.6.2

