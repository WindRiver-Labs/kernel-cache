From 36da17ca94ba3190a8bb7969b2ddd9304852f9a4 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 20 Feb 2014 13:46:59 -0800
Subject: [PATCH 598/974] mmc: octeon_mmc: Try to avoid OOPs

We are seeing:

CPU 1 Unable to handle kernel paging request at virtual address 0000000000000018, epc == ffffffff805613a0, ra == ffffffff80561cdc
Oops[#1]:
CPU: 1 PID: 6 Comm: kworker/u4:0 Not tainted 3.10.14-Cavium-Octeon+ #1101
Workqueue: kmmcd mmc_rescan
task: 80000001e0153e10 ti: 80000001e0200000 task.ti: 80000001e0200000
$ 0   : 0000000000000000 0000000014109ce1 80000001e0097d98 0000000000000000
$ 4   : 80000001ef083f00 80000001e0097e60 1000000a036b036b ffffffffffff00fe
$ 8   : 0000000010000003 80000001e0153e68 0000000000000000 80000001e00b1180
$12   : 80000001e020ffe0 0000000000009c00 000000000000000e 80000001e0160000
$16   : 80000001e020fbd8 80000001e020fbd8 80000001ef083b80 ffffffff806bf6d0
$20   : 80000001e020fc48 0000000000000000 0000000000000000 80000001e0097d98
$24   : 0000000000000001 ffffffff801bbfe8
$28   : 80000001e0200000 80000001e020fb48 0000000000000001 ffffffff80561cdc
Hi    : 0000000000000000
Lo    : 1182df070759fa63
epc   : ffffffff805613a0 octeon_mmc_switch_to+0x30/0x148
    Not tainted
ra    : ffffffff80561cdc octeon_mmc_request+0xcc/0xb38
Status: 14109ce3	KX SX UX KERNEL EXL IE
Cause : 0080000c
BadVA : 0000000000000018
PrId  : 000d9500 (Cavium Octeon III)
Modules linked in: m25p80
Process kworker/u4:0 (pid: 6, threadinfo=80000001e0200000, task=80000001e0153e10, tls=0000000000000000)
Stack : 0000000000000000 0000000000000001 ffffffff801b7898 0000000000100100
	  80000001ef083b80 80000001e020fbd8 80000001e020fbf8 ffffffff806bf6d0
	  ffffffff806bf6e0 0000000000000000 0000000000000000 ffffffff80960000
	  0000000000000001 ffffffff8054fd68 80000001e020fc48 80000001ef083b80
	  0000000000000000 ffffffff8054fe70 0000000000000000 80000001e020fc48
	  0000000000000000 0000000000000000 0000000000000000 0000000000000000
	  80000001e020fc08 80000001e020fc08 ffffffff8054fcf8 0000000000000000
	  80000001ef083b80 0000000000000000 0000000000000000 ffffffff80559c0c
	  0000003480000c08 0000000000000000 0000000000000000 0000019500000000
	  0000000000000000 0000000000000000 80000001e020fbd8 0000000000000003
	  ...
Call Trace:
[<ffffffff805613a0>] octeon_mmc_switch_to+0x30/0x148
[<ffffffff80561cdc>] octeon_mmc_request+0xcc/0xb38
[<ffffffff8054fd68>] mmc_wait_for_req+0x68/0xf8
[<ffffffff8054fe70>] mmc_wait_for_cmd+0x78/0xb0
[<ffffffff80559c0c>] mmc_io_rw_direct_host+0x9c/0x150
[<ffffffff8055a1fc>] sdio_reset+0x8c/0xa0
[<ffffffff80551eb4>] mmc_rescan+0x264/0x328
[<ffffffff801a17e8>] process_one_work+0x160/0x490
[<ffffffff801a1fb8>] worker_thread+0x150/0x3f0
[<ffffffff801a8630>] kthread+0xb8/0xc0
[<ffffffff8014f9a4>] ret_from_kernel_thread+0x14/0x1c

Presumably caused by setting host->slot[id] outside of the locked
region of code.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/mmc/host/octeon_mmc.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/mmc/host/octeon_mmc.c b/drivers/mmc/host/octeon_mmc.c
index 740ef07..04c970d 100644
--- a/drivers/mmc/host/octeon_mmc.c
+++ b/drivers/mmc/host/octeon_mmc.c
@@ -1108,6 +1108,7 @@ static int __init octeon_init_slot(struct octeon_mmc_host *host, int id,
 
 	/* Only a single user of the bootbus at a time. */
 	octeon_mmc_acquire_bus(host);
+	host->slot[id] = slot;
 
 	octeon_mmc_switch_to(slot);
 	/* Initialize MMC Block. */
@@ -1115,7 +1116,6 @@ static int __init octeon_init_slot(struct octeon_mmc_host *host, int id,
 
 	octeon_mmc_release_bus(host);
 
-	host->slot[id] = slot;
 	ret = mmc_add_host(mmc);
 	octeon_mmc_dbg("mmc_add_host returned %d\n", ret);
 
-- 
2.6.2

