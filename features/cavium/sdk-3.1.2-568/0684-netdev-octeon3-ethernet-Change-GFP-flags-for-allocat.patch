From ccbec1a9f758ddc959c2c6b6bd64a2cb53bce1f0 Mon Sep 17 00:00:00 2001
From: Andreas Herrmann <andreas.herrmann@caviumnetworks.com>
Date: Wed, 9 Jul 2014 18:05:50 -0700
Subject: [PATCH 684/974] netdev: octeon3-ethernet: Change GFP flags for
 allocation when holding RCU lock

This addresses

[  107.833694] BUG: sleeping function called from invalid context at mm/slab.c:3054
[  107.841089] in_atomic(): 0, irqs_disabled(): 0, pid: 1247, name: oct3_eth/0:0
[  107.848230] INFO: lockdep is turned off.
[  107.852152] CPU: 31 PID: 1247 Comm: oct3_eth/0:0 Not tainted 3.10.14-sdk-mipsvz-00697-g2fc4051 #290
[  107.861197] Stack : 0000000040808000 ffffffff80184818 53b67d5417c13d8b ba919dd6f48a4024
[  107.861197]    ff4e985e51a86d11 8061000acb7ba7fd be21444c388b1d30 5e22838c0bad9cbc
[  107.861197]    0000006c980e8ef3 1800268d22ed30d5 ffffffff19ddf0b2 fffffffffffffff4
[  107.861197]    6a29f942d196421c e59bacfa2de5f9e2 0000000000000000 0000000000000000
[  107.861197]    ffffffff86700000 ffffffff866f0000 ffffffff808e6b08 ffffffff809c76f7
[  107.861197]    ffffffff866ecdb8 800000040cd84f60 00000000000004df 000000000000001f
[  107.861197]    ffffffff80aa0000 80000004007ba800 ffffffff86f72ec8 ffffffff80762354
[  107.861197]    80000003f7cd7b68 80000003f7cd7a60 ffffffff80aa0000 ffffffff80253430
[  107.861197]    800000040cd84c38 ffffffff808e6b08 000000000000001f 00000000000004df
[  107.861197]    0000000000000000 ffffffff801549d8 0000000000000000 0000000000000000
[  107.861197]    ...
[  107.926749] Call Trace:
[  107.929200] [<ffffffff801549d8>] show_stack+0xb8/0xd8
[  107.934258] [<ffffffff80253430>] kmem_cache_alloc+0x160/0x188
[  107.940005] [<ffffffff805dad90>] __alloc_skb+0x50/0x190
[  107.945236] [<ffffffff80532ad0>] octeon3_eth_replentish_rx+0x90/0x158
[  107.951676] [<ffffffff80534570>] octeon3_eth_tx_complete_worker+0x1e0/0x580
[  107.958642] [<ffffffff801ad4d8>] kthread+0xb8/0xc0
[  107.963438] [<ffffffff8014f754>] ret_from_kernel_thread+0x14/0x1c

Signed-off-by: Andreas Herrmann <andreas.herrmann@caviumnetworks.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index 5632aa5..cbfa3b7 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -324,7 +324,7 @@ static void octeon3_eth_replentish_rx(struct octeon3_ethernet *priv, int count)
 
 	for (i = 0; i < count; i++) {
 		void **buf;
-		skb = __alloc_skb(packet_buffer_size, GFP_KERNEL, 0, priv->numa_node);
+		skb = __alloc_skb(packet_buffer_size, GFP_ATOMIC, 0, priv->numa_node);
 		if (!skb) {
 			pr_err("WARNING: octeon3_eth_replentish_rx out of memory\n");
 			break;
-- 
2.6.2

