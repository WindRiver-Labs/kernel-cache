From 87b7b6596d35c7532396c123e8ab80e180504ddd Mon Sep 17 00:00:00 2001
From: Carlos Munoz <cmunoz@caviumnetworks.com>
Date: Tue, 23 Dec 2014 12:06:49 -0800
Subject: [PATCH 044/184] netdev: octeon3-ethernet: Allow cpus to bind to the
 maximum number of napis per node.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 5a97910272dbbe46a5e87ddf0d2a20011ff58284
Description:

Signed-off-by: Carlos Munoz <cmunoz@caviumnetworks.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index 0abb717b..39c59cf 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -850,7 +850,7 @@ static struct sk_buff *octeon3_eth_work_to_skb(void *w)
 static int octeon3_napi_alloc_cpu(int	node)
 {
 	int				cpu;
-	int				min_cnt = MAX_NAPI_PER_CPU;
+	int				min_cnt = MAX_NAPIS_PER_NODE;
 	int				min_cpu = -EBUSY;
 
 	for_each_cpu(cpu, cpumask_of_node(node)) {
@@ -1591,6 +1591,7 @@ static int octeon3_eth_ndo_open(struct net_device *netdev)
  err4:
 	bitmap_clear(priv->rx_cxt[i].napi_idx_bitmap, idx, 1);
  err3:
+	irq_set_affinity_hint(rx->rx_irq, NULL);
 	free_irq(rx->rx_irq, rx);
  err2:
 	irq_dispose_mapping(rx->rx_irq);
-- 
1.9.1

