From 95a05ac88820d98b7280e79b88d1882af4bd0ac6 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 12 Jun 2015 15:42:11 -0700
Subject: [PATCH 124/184] MIPS: OCTEON: Don't change CIU3 IDT mapping while a
 source is enabled.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 56cfacba248f1d88e941bff791cf3be567378dc1
Description:

The HRM states that CIU3_ISC_CTL[EN] must be cleared as a separate
operation.  We missed doing this in one spot.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/octeon-irq.c | 11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-irq.c b/arch/mips/cavium-octeon/octeon-irq.c
index dc5881f..d099a91 100644
--- a/arch/mips/cavium-octeon/octeon-irq.c
+++ b/arch/mips/cavium-octeon/octeon-irq.c
@@ -2500,19 +2500,22 @@ static void octeon_irq_ciu3_mbox_set_enable(struct irq_data *data, int cpu, bool
 {
 	struct octeon_ciu3_info *ciu3_info;
 	unsigned int intsn;
-	unsigned int idt;
-	u64 isc_ctl_addr;
+	u64 isc_ctl_addr, isc_w1c_addr;
+	union cvmx_ciu3_iscx_ctl isc_ctl;
 	unsigned int mbox = data->irq - OCTEON_IRQ_MBOX0;
 
 	intsn = octeon_irq_ciu3_mbox_intsn_for_cpu(cpu, mbox);
 	ciu3_info = per_cpu(octeon_ciu3_info, cpu);
+	isc_w1c_addr = ciu3_info->ciu3_addr + CIU3_ISC_W1C(intsn);
 	isc_ctl_addr = ciu3_info->ciu3_addr + CIU3_ISC_CTL(intsn);
 
-	idt = per_cpu(octeon_irq_ciu3_idt_ip3, cpu);
+	isc_ctl.u64 = 0;
+	isc_ctl.s.en = 1;
 
+	cvmx_write_csr(isc_w1c_addr, isc_ctl.u64);
 	cvmx_write_csr(isc_ctl_addr, 0);
 	if (en) {
-		union cvmx_ciu3_iscx_ctl isc_ctl;
+		unsigned int idt = per_cpu(octeon_irq_ciu3_idt_ip3, cpu);
 		isc_ctl.u64 = 0;
 		isc_ctl.s.en = 1;
 		isc_ctl.s.idt = idt;
-- 
1.9.1

