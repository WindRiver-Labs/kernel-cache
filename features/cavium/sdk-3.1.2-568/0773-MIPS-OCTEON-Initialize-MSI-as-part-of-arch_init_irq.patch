From 0d10b91237041848ed008d5d9344cc0683ff6a81 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Sat, 19 Jul 2014 18:05:50 -0700
Subject: [PATCH 773/974] MIPS: OCTEON: Initialize MSI as part of
 arch_init_irq().

MSI needs large ranges of contiguous irq values.  Move initialization
very early so that the irq space is not as fragmented.  The result is
a smaller overall range of active irq numbers.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/octeon-irq.c | 5 +++++
 arch/mips/pci/msi-octeon.c           | 1 -
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/arch/mips/cavium-octeon/octeon-irq.c b/arch/mips/cavium-octeon/octeon-irq.c
index 6ccc00e..94363fc 100644
--- a/arch/mips/cavium-octeon/octeon-irq.c
+++ b/arch/mips/cavium-octeon/octeon-irq.c
@@ -3134,6 +3134,8 @@ static struct of_device_id __initdata ciu_types[] = {
 	{}
 };
 
+int octeon_msi_initialize(void);
+
 void __init arch_init_irq(void)
 {
 #ifdef CONFIG_SMP
@@ -3144,6 +3146,9 @@ void __init arch_init_irq(void)
 	}
 #endif
 	of_irq_init(ciu_types);
+#ifdef CONFIG_PCI_MSI
+	octeon_msi_initialize();
+#endif
 }
 
 asmlinkage void plat_irq_dispatch(void)
diff --git a/arch/mips/pci/msi-octeon.c b/arch/mips/pci/msi-octeon.c
index 2eb46bd..b13d962 100644
--- a/arch/mips/pci/msi-octeon.c
+++ b/arch/mips/pci/msi-octeon.c
@@ -780,4 +780,3 @@ int __init octeon_msi_initialize(void)
 	}
 	return 0;
 }
-subsys_initcall(octeon_msi_initialize);
-- 
2.6.2

