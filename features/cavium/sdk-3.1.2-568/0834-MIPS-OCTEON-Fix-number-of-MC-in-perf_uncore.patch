From 1c22454de0b94e8ebab25bf222e5befcb3e6a097 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Sun, 6 Jul 2014 18:05:50 -0700
Subject: [PATCH 834/974] MIPS: OCTEON: Fix number of MC in perf_uncore.

The number of memory controllers is not the same as the number of
TADs, set it based on chip model.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/perf_uncore.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/arch/mips/cavium-octeon/perf_uncore.c b/arch/mips/cavium-octeon/perf_uncore.c
index 74afc15..8c69799 100644
--- a/arch/mips/cavium-octeon/perf_uncore.c
+++ b/arch/mips/cavium-octeon/perf_uncore.c
@@ -98,6 +98,7 @@ static int lim_cvmx_lmcx(void)
 {
 	int lim = 0;
 	int tad;
+	int possible;
 
 	/*
 	 * Prepare to walk over all _enabled_ LMC banks:
@@ -107,7 +108,12 @@ static int lim_cvmx_lmcx(void)
 	 */
 	if (OCTEON_IS_OCTEON1PLUS())
 		return 1;
-	for (tad = 0; tad < CVMX_L2C_TADS; tad++) {
+	possible = 1;
+	if (OCTEON_IS_MODEL(OCTEON_CN73XX) || OCTEON_IS_MODEL(OCTEON_CN75XX))
+		possible = 2;
+	else if (OCTEON_IS_MODEL(OCTEON_CN68XX) || OCTEON_IS_MODEL(OCTEON_CN78XX))
+		possible = 4;
+	for (tad = 0; tad < possible; tad++) {
 		union cvmx_lmcx_dll_ctl2 ctl2;
 		ctl2.u64 = cvmx_read_csr(CVMX_LMCX_DLL_CTL2(tad));
 		if (current_cpu_type() == CPU_CAVIUM_OCTEON3) {
-- 
2.6.2

