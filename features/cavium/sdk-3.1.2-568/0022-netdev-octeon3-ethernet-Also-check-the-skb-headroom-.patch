From 0de816ffcdecd7adaebe5c3a7bddf698633e36a1 Mon Sep 17 00:00:00 2001
From: Carlos Munoz <cmunoz@caviumnetworks.com>
Date: Wed, 19 Nov 2014 10:17:43 -0800
Subject: [PATCH 022/184] netdev: octeon3-ethernet: Also check the skb headroom
 and skb size to determine if skb is recyclable.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 6dc6de349bdcbe52bb9342aa74192f8da565d76d
Description:

Signed-off-by: Carlos Munoz <cmunoz@caviumnetworks.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 14 ++++++++------
 1 file changed, 8 insertions(+), 6 deletions(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index 0b9a7ea..2278285 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -1691,12 +1691,14 @@ static int octeon3_eth_ndo_start_xmit(struct sk_buff *skb, struct net_device *ne
 			frag_count++;
 
 	/* Check if the skb can be recycled (freed back to the fpa) */
-	if (likely(recycle_skbs) &&
-	    likely(skb_shinfo(skb)->nr_frags == 0) &&
-	    likely(skb_shared(skb) == 0) &&
-	    likely(skb_cloned(skb) == 0) &&
-	    likely(frag_count == 0) &&
-	    likely(skb->fclone == SKB_FCLONE_UNAVAILABLE)) {
+	if (recycle_skbs &&
+	    skb_shinfo(skb)->nr_frags == 0 &&
+	    skb_shared(skb) == 0 &&
+	    skb_cloned(skb) == 0 &&
+	    frag_count == 0 &&
+	    skb_headroom(skb) >= 128 &&
+	    skb_end_offset(skb) >= packet_buffer_size &&
+	    skb->fclone == SKB_FCLONE_UNAVAILABLE) {
 		uint64_t	magic;
 
 		buf = (void **)PTR_ALIGN(skb->head, 128);
-- 
1.9.1

