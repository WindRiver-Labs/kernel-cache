From f80c6c2f3768761b48f0cbef4f739981a4184607 Mon Sep 17 00:00:00 2001
From: Peter Swain <pswain@cavium.com>
Date: Tue, 10 Nov 2015 14:28:18 -0800
Subject: [PATCH 165/184] mips: octeon: add TDM feature & IRQ

Map Octeon's TDM IRQ on chips which support it.

Signed-off-by: Peter Swain <pswain@cavium.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/octeon-irq.c           |  6 ++++++
 arch/mips/include/asm/mach-cavium-octeon/irq.h |  1 +
 arch/mips/include/asm/octeon/octeon-feature.h  | 12 ++++++++++++
 3 files changed, 19 insertions(+)

diff --git a/arch/mips/cavium-octeon/octeon-irq.c b/arch/mips/cavium-octeon/octeon-irq.c
index 88b2659..1fa41b4 100644
--- a/arch/mips/cavium-octeon/octeon-irq.c
+++ b/arch/mips/cavium-octeon/octeon-irq.c
@@ -1598,6 +1598,12 @@ static int __init octeon_irq_init_ciu(
 			goto err;
 	}
 
+	if (octeon_has_feature(OCTEON_FEATURE_TDM)) {
+		r = octeon_irq_force_ciu_mapping(ciu_domain, OCTEON_IRQ_TDM, 0, 57);
+		if (r)
+			goto err;
+	}
+
 	/* CIU_1 */
 	r = irq_alloc_descs_from(OCTEON_IRQ_WDOG0, 16, 0);
 	WARN_ON(r < 0);
diff --git a/arch/mips/include/asm/mach-cavium-octeon/irq.h b/arch/mips/include/asm/mach-cavium-octeon/irq.h
index f5557e3..23e72c8 100644
--- a/arch/mips/include/asm/mach-cavium-octeon/irq.h
+++ b/arch/mips/include/asm/mach-cavium-octeon/irq.h
@@ -60,6 +60,7 @@ enum octeon_irq {
 	OCTEON_IRQ_SRIO1,
 	OCTEON_IRQ_SRIO2,
 	OCTEON_IRQ_SRIO3,
+	OCTEON_IRQ_TDM,
 	OCTEON_IRQ_USB0,
 	OCTEON_IRQ_USB1
 };
diff --git a/arch/mips/include/asm/octeon/octeon-feature.h b/arch/mips/include/asm/octeon/octeon-feature.h
index bfe5c54..1ddb9de 100644
--- a/arch/mips/include/asm/octeon/octeon-feature.h
+++ b/arch/mips/include/asm/octeon/octeon-feature.h
@@ -178,6 +178,8 @@ typedef enum {
 				/**<  Octeon has OCX */
 	OCTEON_FEATURE_TSO,
 				/**< Octeon has tcp segmentation offload */
+	OCTEON_FEATURE_TDM,
+				/**< Octeon has PCM/TDM support */
 	OCTEON_MAX_FEATURE
 } octeon_feature_t;
 
@@ -492,6 +494,16 @@ static inline int octeon_has_feature_OCTEON_FEATURE_TSO(void)
 	return OCTEON_IS_MODEL(OCTEON_CN73XX);
 }
 
+static inline int octeon_has_feature_OCTEON_FEATURE_TDM(void)
+{
+	return OCTEON_IS_MODEL(OCTEON_CN30XX)
+		|| OCTEON_IS_MODEL(OCTEON_CN31XX)
+		|| OCTEON_IS_MODEL(OCTEON_CN50XX)
+		|| OCTEON_IS_MODEL(OCTEON_CN61XX)
+		|| OCTEON_IS_MODEL(OCTEON_CNF71XX)
+		|| OCTEON_IS_MODEL(OCTEON_CN70XX);
+}
+
 /*
  * bit map for octeon features
  */
-- 
1.9.1

