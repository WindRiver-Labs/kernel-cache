From 7dc05cc236c5501cda05921632898c30ff4f8d3c Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 26 Feb 2014 13:46:59 -0800
Subject: [PATCH 602/974] MIPS: Load invalid TLB entries on VM size overflow.

A real fault will be generated on subsequent TLBL/TLBM/TLBS
Exceptions.

This allows the TLB Refill handler to work without having to leave
Guest mode, just load "Invalid" entries, and return.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/mm/tlbex.c | 13 ++++++++-----
 1 file changed, 8 insertions(+), 5 deletions(-)

diff --git a/arch/mips/mm/tlbex.c b/arch/mips/mm/tlbex.c
index 0a10693..4265984 100644
--- a/arch/mips/mm/tlbex.c
+++ b/arch/mips/mm/tlbex.c
@@ -937,17 +937,20 @@ build_get_pgd_vmalloc64(u32 **p, struct uasm_label **l, struct uasm_reloc **r,
 		 * to mimic that here by taking a load/istream page
 		 * fault.
 		 */
-		UASM_i_LA(p, ptr, (unsigned long)tlb_do_page_fault_0);
-		uasm_i_jr(p, ptr);
-
+		UASM_i_MTC0(p, 0, C0_ENTRYLO0); /* Invalid */
+		UASM_i_MTC0(p, 0, C0_ENTRYLO1); /* Invalid */
+		build_tlb_write_entry(p, l, r, tlb_random);
 		if (mode == refill_scratch) {
 			if (scratch_reg > 0)
 				UASM_i_MFC0(p, 1, 31, scratch_reg);
 			else
 				UASM_i_LW(p, 1, scratchpad_offset(0), 0);
-		} else {
-			uasm_i_nop(p);
 		}
+#ifdef CONFIG_KVM_MIPS_VZ
+		UASM_i_MFC0(p, K0, 31, 2);
+		UASM_i_MFC0(p, K1, 31, 3);
+#endif
+		uasm_i_eret(p); /* return from trap */
 	}
 }
 
-- 
2.6.2

