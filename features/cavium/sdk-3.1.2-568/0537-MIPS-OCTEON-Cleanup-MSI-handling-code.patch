From 14aaca4e9957224547001d6fa941fe606c078341 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 13 Feb 2014 13:46:59 -0800
Subject: [PATCH 537/974] MIPS: OCTEON: Cleanup MSI handling code.

No functional change.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/pci/msi-octeon.c | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/arch/mips/pci/msi-octeon.c b/arch/mips/pci/msi-octeon.c
index 7249bb8..fc9a71f 100644
--- a/arch/mips/pci/msi-octeon.c
+++ b/arch/mips/pci/msi-octeon.c
@@ -318,13 +318,13 @@ int arch_setup_msi_irq(struct pci_dev *dev, struct msi_desc *desc)
 		if (msi_to_irq[msi])
 			irq = msi_to_irq[msi];
 		else {
-			cd = kzalloc(sizeof(*cd), GFP_KERNEL);
+			cd = kzalloc_node(sizeof(*cd), GFP_KERNEL, node);
+			if (!cd)
+				return -ENOMEM;
 			cd->msi = msi;
 			cd->hwmsi = hwmsi;
-
-			if ((irq = irq_alloc_descs(-1, 1, 1, node)) < 0) {
-				WARN(1, "arch_setup_msi_irq: Unable to find a "
-				     "free irq\n");
+			irq = irq_alloc_descs(-1, 1, 1, node);
+			if (WARN(irq < 0, "arch_setup_msi_irq: Unable to find a free irq\n")) {
 				clear_bit(msi, msi_free_irq_bitmap[node]);
 				kfree(cd);
 				return -ENOSPC;
-- 
2.6.2

