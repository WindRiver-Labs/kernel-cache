From e8d31b1329ab52209e9e029c00f33d1354d4a24b Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Mon, 3 Nov 2014 16:30:48 -0800
Subject: [PATCH 005/184] gpio: gpio-octeon: Add support for multiple GPIO
 controllers.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 879dcd03096e0f635cf6111289faf73568650a87
Description:

In a NUMA configuration, each node will have a GPIO controller.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/gpio/gpio-octeon.c | 14 ++++++++++----
 1 file changed, 10 insertions(+), 4 deletions(-)

diff --git a/drivers/gpio/gpio-octeon.c b/drivers/gpio/gpio-octeon.c
index 54ff1e5..c0239fe 100644
--- a/drivers/gpio/gpio-octeon.c
+++ b/drivers/gpio/gpio-octeon.c
@@ -7,9 +7,8 @@
  */
 
 #include <linux/of_device.h>
-#include <linux/kernel.h>
 #include <linux/module.h>
-#include <linux/gpio.h>
+#include <linux/of_gpio.h>
 #include <linux/io.h>
 
 #include <asm/octeon/octeon.h>
@@ -135,19 +134,26 @@ static int octeon_gpio_probe(struct platform_device *pdev)
 	pdev->dev.platform_data = chip;
 	chip->label = "octeon-gpio";
 	chip->dev = &pdev->dev;
+	chip->of_node = pdev->dev.of_node;
 	chip->owner = THIS_MODULE;
-	chip->base = 0;
+	/*
+	 * Node zero is at base of 0, other nodes are automatically
+	 * allocated.
+	 */
+	chip->base = of_node_to_nid(chip->of_node) ? -1 : 0;
 	chip->can_sleep = false;
 	chip->ngpio = 20;
 	chip->direction_input = octeon_gpio_dir_in;
 	chip->get = octeon_gpio_get;
 	chip->direction_output = octeon_gpio_dir_out;
 	chip->set = octeon_gpio_set;
+	chip->of_gpio_n_cells = 2;
+	chip->of_xlate = of_gpio_simple_xlate;
 	err = gpiochip_add(chip);
 	if (err)
 		goto out;
 
-	dev_info(&pdev->dev, "OCTEON GPIO driver probed.\n");
+	dev_info(&pdev->dev, "OCTEON GPIO: base = %d\n", chip->base);
 out:
 	return err;
 }
-- 
1.9.1

