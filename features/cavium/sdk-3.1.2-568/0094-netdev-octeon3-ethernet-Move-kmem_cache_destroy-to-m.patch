From b1349e72fd87ffa1cef6810edec689402abc8c68 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 5 Mar 2015 15:04:35 -0800
Subject: [PATCH 094/184] netdev: octeon3-ethernet: Move kmem_cache_destroy()
 to module_exit function.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 97a60e878c385bdc687007b65de00c18b2ecc0e2
Description:

This is the easiest way to ensure that it is done last.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index aa49c50..8a4168a 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -2348,9 +2348,6 @@ static int octeon3_eth_global_exit(int node)
 	cvmx_fpa3_release_pool(oen->sso_pool);
 	kfree(oen->sso_pool_stack);
 
-	/* Destroy the memory cache used by sso and pko */
-	kmem_cache_destroy(octeon3_eth_sso_pko_cache);
-
 	return 0;
 }
 
@@ -2429,6 +2426,10 @@ static void __exit octeon3_eth_exit(void)
 		return;
 
 	platform_driver_unregister(&octeon3_eth_driver);
+
+	/* Destroy the memory cache used by sso and pko */
+	if (octeon3_eth_sso_pko_cache)
+		kmem_cache_destroy(octeon3_eth_sso_pko_cache);
 }
 module_exit(octeon3_eth_exit);
 
-- 
1.9.1

