From 92529dc56fca189bb7764f596220bb2669374fbf Mon Sep 17 00:00:00 2001
From: Peter Swain <pswain@cavium.com>
Date: Sat, 29 Aug 2015 18:02:51 -0700
Subject: [PATCH 142/184] mips: octeon_mmc: work around legacy u-boot device
 trees

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: b27da6aec6a698f3aaccf6283f13e97e1f321a97
Description:

Upcoming fixes to octeon ciu3 irq processing will break mmc driver
unless IRQs for 73/75/78xx processors are correctly marked edge-triggered.

Fix to allow deployment of new kernels with legacy u-boot images.

Signed-off-by: Peter Swain <pswain@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/mmc/host/octeon_mmc.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/mmc/host/octeon_mmc.c b/drivers/mmc/host/octeon_mmc.c
index 1c697be..4faf841 100644
--- a/drivers/mmc/host/octeon_mmc.c
+++ b/drivers/mmc/host/octeon_mmc.c
@@ -1162,6 +1162,9 @@ static int octeon_mmc_probe(struct platform_device *pdev)
 			mmc_irq[i] = platform_get_irq(pdev, i);
 			if (mmc_irq[i] < 0)
 				return mmc_irq[i];
+
+			/* work around legacy u-boot device trees */
+			irq_set_irq_type(mmc_irq[i], IRQ_TYPE_EDGE_RISING);
 		}
 	} else {
 		host->need_bootbus_lock = true;
-- 
1.9.1

