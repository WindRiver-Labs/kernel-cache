From 19c1b9897b15a9e81c2b028132b26a0d9fcbc3c0 Mon Sep 17 00:00:00 2001
From: Corey Minyard <cminyard@mvista.com>
Date: Fri, 6 Mar 2015 12:00:39 -0600
Subject: [PATCH 099/184] MIPS:OCTEON: Register a dump handler mailbox

Source: Cavium Networks, Inc.
MR: 14145
Type: Defect Fix
Disposition: Merged from Octeon Tree
ChangeID: 3df57be4306fe29bcf51d1aa3a24fd15df0c4fad
Description:

This makes sure all processors except the one doing kexec are
shut down when doing a kexec.

Signed-off-by: Corey Minyard <cminyard@mvista.com>
Cc: Arun Chandran <achandran@mvista.com>
Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/smp.c | 26 ++++++++++++--------------
 1 file changed, 12 insertions(+), 14 deletions(-)

diff --git a/arch/mips/cavium-octeon/smp.c b/arch/mips/cavium-octeon/smp.c
index e43d380..e7082e3 100644
--- a/arch/mips/cavium-octeon/smp.c
+++ b/arch/mips/cavium-octeon/smp.c
@@ -272,6 +272,14 @@ static void octeon_init_secondary(void)
 	octeon_irq_setup_secondary();
 }
 
+static irqreturn_t octeon_78xx_smp_dump_interrupt(int irq, void *dev_id)
+{
+#ifdef CONFIG_KEXEC
+	octeon_crash_dump();
+#endif
+	return IRQ_HANDLED;
+}
+
 /**
  * Callout to firmware before smp_init
  *
@@ -451,14 +459,6 @@ static irqreturn_t octeon_78xx_icache_flush_interrupt(int irq, void *dev_id)
 	return IRQ_HANDLED;
 }
 
-#ifdef CONFIG_KEXEC
-static irqreturn_t octeon_78xx_kdump_interrupt(int irq, void *dev_id)
-{
-	octeon_crash_dump();
-	return IRQ_HANDLED;
-}
-#endif
-
 /*
  * Callout to firmware before smp_init
  */
@@ -479,13 +479,11 @@ static void octeon_78xx_prepare_cpus(unsigned int max_cpus)
 			octeon_78xx_icache_flush_interrupt)) {
 		panic("Cannot request_irq for ICache-Flush");
 	}
-#ifdef CONFIG_KEXEC
-	if (request_irq(OCTEON_IRQ_MBOX0 + 3, octeon_78xx_kdump_interrupt,
-			IRQF_PERCPU | IRQF_NO_THREAD, "kdump-crash",
-			octeon_78xx_kdump_interrupt)) {
-		panic("Cannot request_irq for kdump-crash");
+	if (request_irq(OCTEON_IRQ_MBOX0 + 3, octeon_78xx_smp_dump_interrupt,
+			IRQF_PERCPU | IRQF_NO_THREAD, "SMP-Dump",
+			octeon_78xx_smp_dump_interrupt)) {
+		panic("Cannot request_irq for SMP-Dump");
 	}
-#endif
 }
 
 static void octeon_78xx_send_ipi_single(int cpu, unsigned int action)
-- 
1.9.1

