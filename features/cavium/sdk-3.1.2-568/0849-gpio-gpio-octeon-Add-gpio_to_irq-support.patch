From 80153eb941f854c4c25eea264cc7a29edb271392 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 25 Jul 2014 18:05:50 -0700
Subject: [PATCH 849/974] gpio: gpio-octeon: Add gpio_to_irq() support.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/gpio/gpio-octeon.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/drivers/gpio/gpio-octeon.c b/drivers/gpio/gpio-octeon.c
index d1bf2cb..606eebb 100644
--- a/drivers/gpio/gpio-octeon.c
+++ b/drivers/gpio/gpio-octeon.c
@@ -9,6 +9,7 @@
 #include <linux/of_device.h>
 #include <linux/module.h>
 #include <linux/of_gpio.h>
+#include <linux/of_irq.h>
 #include <linux/io.h>
 
 #include <asm/octeon/octeon.h>
@@ -80,6 +81,20 @@ static int octeon_gpio_get(struct gpio_chip *chip, unsigned offset)
 	return ((1ull << offset) & read_bits) != 0;
 }
 
+static int octeon_gpio_to_irq(struct gpio_chip *chip, unsigned offset)
+{
+	u32 intspec[2];
+
+	if (offset >= 16)
+		return -ENXIO;
+
+	intspec[0] = offset;
+	intspec[1] = 8; /* level, active low */
+
+	return irq_create_of_mapping(chip->of_node,
+				     intspec, ARRAY_SIZE(intspec));
+}
+
 static struct of_device_id octeon_gpio_match[] = {
 	{
 		.compatible = "cavium,octeon-3860-gpio",
@@ -145,6 +160,7 @@ static int octeon_gpio_probe(struct platform_device *pdev)
 	chip->set = octeon_gpio_set;
 	chip->of_gpio_n_cells = 2;
 	chip->of_xlate = of_gpio_simple_xlate;
+	chip->to_irq = octeon_gpio_to_irq;
 	err = gpiochip_add(chip);
 	if (err)
 		goto out;
-- 
2.6.2

