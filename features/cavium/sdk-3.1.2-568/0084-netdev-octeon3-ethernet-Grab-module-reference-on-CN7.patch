From 3f346731c7925e45f17943b4666d95a01ef0cbdf Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 26 Feb 2015 10:26:11 -0800
Subject: [PATCH 084/184] netdev: octeon3-ethernet: Grab module reference on
 CN78XX_PASS1_0.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: ffeef2cb54e09a93181c4aa873681837867a8a78
Description:

This chip cannot initialize its network hardware twice, so taking a
reference prevents the module from being unloaded, thus ensuring that
multiple initialization is not attempted.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index e444fc3..aa49c50 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -794,6 +794,7 @@ static int octeon3_eth_global_init(unsigned int node)
 	unsigned int sso_intsn;
 	struct octeon3_ethernet_node *oen;
 	union cvmx_fpa_gen_cfg fpa_cfg;
+
 	mutex_lock(&octeon3_eth_init_mutex);
 
 	oen = octeon3_eth_node + node;
@@ -801,6 +802,13 @@ static int octeon3_eth_global_init(unsigned int node)
 	if (oen->init_done)
 		goto done;
 
+	/* CN78XX-P1.0 cannot un-initialize PKO, so get a module
+	 * reference to prevent it from being unloaded.
+	 */
+	if (OCTEON_IS_MODEL(OCTEON_CN78XX_PASS1_0))
+		if (!try_module_get(THIS_MODULE))
+			pr_err("ERROR: Could not obtain module reference for CN78XX-P1.0\n");
+
 	__cvmx_export_app_config_to_named_block(CVMX_APP_CONFIG);
 
 	INIT_LIST_HEAD(&oen->device_list);
@@ -2420,9 +2428,6 @@ static void __exit octeon3_eth_exit(void)
 	if (!OCTEON_IS_MODEL(OCTEON_CN78XX))
 		return;
 
-	if (OCTEON_IS_MODEL(OCTEON_CN78XX_PASS1_0))
-		pr_err("ERROR: rmmod of this driver is not supported on CN78XX-P1.0\n");
-
 	platform_driver_unregister(&octeon3_eth_driver);
 }
 module_exit(octeon3_eth_exit);
-- 
1.9.1

