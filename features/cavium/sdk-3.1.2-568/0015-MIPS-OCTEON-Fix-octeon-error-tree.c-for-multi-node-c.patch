From e43bdd41ca659cce9a7bd799e958337533e2e8eb Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Tue, 4 Nov 2014 14:26:51 -0800
Subject: [PATCH 015/184] MIPS: OCTEON: Fix octeon-error-tree.c for multi-node
 cn78XX.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: c65e803e92cc1ba0d19bbbcf118ba93ca85d55a5
Description:

Register error interrupts on all nodes.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/octeon-error-tree.c | 15 ++++++++-------
 1 file changed, 8 insertions(+), 7 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-error-tree.c b/arch/mips/cavium-octeon/octeon-error-tree.c
index 6b574af..4b1ae25 100644
--- a/arch/mips/cavium-octeon/octeon-error-tree.c
+++ b/arch/mips/cavium-octeon/octeon-error-tree.c
@@ -303,21 +303,21 @@ static void octeon_error_tree_handler78(int node, int intsn)
 	if (error_array_cn78xxp1[idx].intsn == intsn) {
 		snprintf(msg, sizeof(msg), error_array_cn78xxp1[idx].err_mesg,
 			 error_array_cn78xxp1[idx].block_csr, error_array_cn78xxp1[idx].block_csr_bitpos);
-		pr_err("%s\n", msg);
+		pr_err("Node-%d: %s\n", node, msg);
 		if (error_array_cn78xxp1[idx].block_csr) {
 			u64 clear_addr;
 			clear_addr = 0x8000000000000000ull | error_array_cn78xxp1[idx].block_csr;
-			cvmx_write_csr(clear_addr, 1ull << error_array_cn78xxp1[idx].block_csr_bitpos);
+			cvmx_write_csr_node(node, clear_addr, 1ull << error_array_cn78xxp1[idx].block_csr_bitpos);
 		}
 	} else {
 		pr_err("ERROR: Unknown intsn 0x%x\n", intsn);
-		octeon_ciu3_errbits_disable_intsn(0, intsn);
+		octeon_ciu3_errbits_disable_intsn(node, intsn);
 	}
 }
 
 static int __init octeon_error_tree_init78(void)
 {
-	int i;
+	int i, node;
 	if (disable || !octeon_has_feature(OCTEON_FEATURE_CIU3))
 		return 0;
 
@@ -330,9 +330,10 @@ static int __init octeon_error_tree_init78(void)
 		if (error_array_cn78xxp1[i].error_group != CVMX_ERROR_GROUP_ETHERNET)
 			octeon_ciu3_errbits_disable_intsn(0, error_array_cn78xxp1[i].intsn);
 #endif
-	for (i = 0; error_array_cn78xxp1[i].intsn < 0xfffff; i++)
-		if (error_array_cn78xxp1[i].error_group != CVMX_ERROR_GROUP_ETHERNET)
-			octeon_ciu3_errbits_enable_intsn(0, error_array_cn78xxp1[i].intsn);
+	for_each_online_node(node)
+		for (i = 0; error_array_cn78xxp1[i].intsn < 0xfffff; i++)
+			if (error_array_cn78xxp1[i].error_group != CVMX_ERROR_GROUP_ETHERNET)
+				octeon_ciu3_errbits_enable_intsn(node, error_array_cn78xxp1[i].intsn);
 
 	return 0;
 }
-- 
1.9.1

