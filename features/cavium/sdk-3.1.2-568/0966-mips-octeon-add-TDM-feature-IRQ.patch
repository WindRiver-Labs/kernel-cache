From eb1f9e0657f9dafc8a4ff3e186c89d2a2d11cc95 Mon Sep 17 00:00:00 2001
From: Peter Swain <pswain@cavium.com>
Date: Tue, 10 Nov 2015 17:25:24 -0800
Subject: [PATCH 966/974] mips: octeon: add TDM feature & IRQ

Map Octeon's TDM IRQ on chips which support it.

Signed-off-by: Peter Swain <pswain@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/executive/octeon-feature.c |  1 +
 arch/mips/cavium-octeon/octeon-irq.c               |  6 ++++++
 arch/mips/include/asm/mach-cavium-octeon/irq.h     |  3 ++-
 arch/mips/include/asm/octeon/octeon-feature.h      | 12 ++++++++++++
 4 files changed, 21 insertions(+), 1 deletion(-)

diff --git a/arch/mips/cavium-octeon/executive/octeon-feature.c b/arch/mips/cavium-octeon/executive/octeon-feature.c
index 7732124..d881b47 100644
--- a/arch/mips/cavium-octeon/executive/octeon-feature.c
+++ b/arch/mips/cavium-octeon/executive/octeon-feature.c
@@ -145,6 +145,7 @@ void __init octeon_feature_init(void)
 	OCTEON_FEATURE_SET(OCTEON_FEATURE_BGX_MIX);
 	OCTEON_FEATURE_SET(OCTEON_FEATURE_BGX_XCV);
 	OCTEON_FEATURE_SET(OCTEON_FEATURE_TSO);
+	OCTEON_FEATURE_SET(OCTEON_FEATURE_TDM);
 	val = OCTEON_FEATURE_SUCCESS;
 
 feature_check:
diff --git a/arch/mips/cavium-octeon/octeon-irq.c b/arch/mips/cavium-octeon/octeon-irq.c
index 33ff357f..7058a9e 100644
--- a/arch/mips/cavium-octeon/octeon-irq.c
+++ b/arch/mips/cavium-octeon/octeon-irq.c
@@ -1580,6 +1580,12 @@ static int __init octeon_irq_init_ciu(struct device_node *ciu_node, struct devic
 			goto err;
 	}
 
+	if (octeon_has_feature(OCTEON_FEATURE_TDM)) {
+		r = octeon_irq_force_ciu_mapping(ciu_domain, OCTEON_IRQ_TDM, 0, 57);
+		if (r)
+			goto err;
+	}
+
 	/* CIU_1 */
 	r = irq_alloc_descs_from(OCTEON_IRQ_WDOG0, 16, 0);
 	WARN_ON(r < 0);
diff --git a/arch/mips/include/asm/mach-cavium-octeon/irq.h b/arch/mips/include/asm/mach-cavium-octeon/irq.h
index 87ff55b..1116a03 100644
--- a/arch/mips/include/asm/mach-cavium-octeon/irq.h
+++ b/arch/mips/include/asm/mach-cavium-octeon/irq.h
@@ -57,7 +57,8 @@ enum octeon_irq {
 	OCTEON_IRQ_SRIO0,
 	OCTEON_IRQ_SRIO1,
 	OCTEON_IRQ_SRIO2,
-	OCTEON_IRQ_SRIO3
+	OCTEON_IRQ_SRIO3,
+	OCTEON_IRQ_TDM,
 };
 
 #endif
diff --git a/arch/mips/include/asm/octeon/octeon-feature.h b/arch/mips/include/asm/octeon/octeon-feature.h
index c47ba41..794ee3e 100644
--- a/arch/mips/include/asm/octeon/octeon-feature.h
+++ b/arch/mips/include/asm/octeon/octeon-feature.h
@@ -180,6 +180,8 @@ typedef enum {
 				/**< Octeon has BGX XCV RGMII support */
 	OCTEON_FEATURE_TSO,
 				/**< Octeon has tcp segmentation offload */
+	OCTEON_FEATURE_TDM,
+				/**< Octeon has PCM/TDM support */
 	OCTEON_MAX_FEATURE
 } octeon_feature_t;
 
@@ -527,6 +529,16 @@ static inline int octeon_has_feature_OCTEON_FEATURE_TSO(void)
 	return OCTEON_IS_MODEL(OCTEON_CN73XX);
 }
 
+static inline int octeon_has_feature_OCTEON_FEATURE_TDM(void)
+{
+	return OCTEON_IS_MODEL(OCTEON_CN30XX)
+		|| OCTEON_IS_MODEL(OCTEON_CN31XX)
+		|| OCTEON_IS_MODEL(OCTEON_CN50XX)
+		|| OCTEON_IS_MODEL(OCTEON_CN61XX)
+		|| OCTEON_IS_MODEL(OCTEON_CNF71XX)
+		|| OCTEON_IS_MODEL(OCTEON_CN70XX);
+}
+
 /*
  * bit map for octeon features
  */
-- 
2.6.2

