From c260561ac63441af1ca924d7ff5e69e58ce3076a Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Tue, 5 Jul 2011 18:08:59 -0700
Subject: [PATCH 128/974] MIPS: Octeon: Allow TLB modify handlers to use
 scratchpad for temporary register save.

If C0_KScratch registers are not available use CPU local scratchpad
instead of CPU local memory.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/mm/tlbex.c | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/arch/mips/mm/tlbex.c b/arch/mips/mm/tlbex.c
index 054c48d..458f9ed 100644
--- a/arch/mips/mm/tlbex.c
+++ b/arch/mips/mm/tlbex.c
@@ -55,7 +55,9 @@ struct tlb_reg_save {
 	unsigned long b;
 } ____cacheline_aligned_in_smp;
 
+#ifndef TEMPORARY_SCRATCHPAD_FOR_KERNEL_OFFSET
 static struct tlb_reg_save handler_reg_save[NR_CPUS];
+#endif
 
 static inline int r45k_bvahwbug(void)
 {
@@ -335,10 +337,11 @@ static struct work_registers __cpuinit build_get_work_registers(u32 **p)
 {
 	struct work_registers r;
 
+#ifndef TEMPORARY_SCRATCHPAD_FOR_KERNEL_OFFSET
 	int smp_processor_id_reg;
 	int smp_processor_id_sel;
 	int smp_processor_id_shift;
-
+#endif
 	if (scratch_reg > 0) {
 		/* Save in CPU local C0_KScratch? */
 		UASM_i_MTC0(p, 1, 31, scratch_reg);
@@ -347,6 +350,13 @@ static struct work_registers __cpuinit build_get_work_registers(u32 **p)
 		r.r3 = 1;
 		return r;
 	}
+#ifdef TEMPORARY_SCRATCHPAD_FOR_KERNEL_OFFSET
+	UASM_i_SW(p, 1, TEMPORARY_SCRATCHPAD_FOR_KERNEL_OFFSET(0), 0);
+	r.r1 = K0;
+	r.r2 = K1;
+	r.r3 = 1;
+	return r;
+#else
 
 	if (num_possible_cpus() > 1) {
 #ifdef CONFIG_MIPS_PGD_C0_CONTEXT
@@ -385,6 +395,7 @@ static struct work_registers __cpuinit build_get_work_registers(u32 **p)
 	r.r2 = 1;
 	r.r3 = 2;
 	return r;
+#endif /* TEMPORARY_SCRATCHPAD_FOR_KERNEL_OFFSET */
 }
 
 static void __cpuinit build_restore_work_registers(u32 **p)
@@ -393,9 +404,13 @@ static void __cpuinit build_restore_work_registers(u32 **p)
 		UASM_i_MFC0(p, 1, 31, scratch_reg);
 		return;
 	}
+#ifdef TEMPORARY_SCRATCHPAD_FOR_KERNEL_OFFSET
+	UASM_i_LW(p, 1, TEMPORARY_SCRATCHPAD_FOR_KERNEL_OFFSET(0), 0);
+#else
 	/* K0 already points to save area, restore $1 and $2  */
 	UASM_i_LW(p, 1, offsetof(struct tlb_reg_save, a), K0);
 	UASM_i_LW(p, 2, offsetof(struct tlb_reg_save, b), K0);
+#endif /* TEMPORARY_SCRATCHPAD_FOR_KERNEL_OFFSET */
 }
 
 #ifndef CONFIG_MIPS_PGD_C0_CONTEXT
-- 
2.6.2

