From 68a17f490ba9a5fc252b30083b0c03ce3d376328 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Tue, 29 Jul 2014 18:05:50 -0700
Subject: [PATCH 730/974] MIPS: OCTEON: Implement of_node_to_nid()

More NUMA support needed by device drivers.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/octeon-numa.c              | 25 ++++++++++++++++++++++
 .../mips/include/asm/mach-cavium-octeon/topology.h |  5 +++++
 2 files changed, 30 insertions(+)

diff --git a/arch/mips/cavium-octeon/octeon-numa.c b/arch/mips/cavium-octeon/octeon-numa.c
index 80ee965..5c3dc1a 100644
--- a/arch/mips/cavium-octeon/octeon-numa.c
+++ b/arch/mips/cavium-octeon/octeon-numa.c
@@ -12,6 +12,7 @@
 #include <linux/nodemask.h>
 #include <linux/bootmem.h>
 #include <linux/swap.h>
+#include <linux/of.h>
 
 #include <asm/sections.h>
 
@@ -105,3 +106,27 @@ void __init mem_init(void)
 	       datasize >> 10,
 	       initsize >> 10);
 }
+
+int of_node_to_nid(struct device_node *np)
+{
+	int ret = 0;
+	struct device_node *node = of_node_get(np);
+
+	do {
+		if (strcmp("soc", node->name) == 0) {
+			int rc;
+			u32 msbits = 0;
+
+			rc = of_property_read_u32_index(node, "ranges",	2, &msbits);
+			if (rc == -EINVAL)
+				WARN_ONCE(true, "Missing ranges property<%s>\n", node->full_name);
+			ret = (msbits >> 4) & 1;
+			break;
+		}
+		node = of_get_next_parent(node);
+	} while (node);
+
+	of_node_put(node);
+	return ret;
+}
+EXPORT_SYMBOL(of_node_to_nid);
diff --git a/arch/mips/include/asm/mach-cavium-octeon/topology.h b/arch/mips/include/asm/mach-cavium-octeon/topology.h
index 76a8c2a..5a0a586 100644
--- a/arch/mips/include/asm/mach-cavium-octeon/topology.h
+++ b/arch/mips/include/asm/mach-cavium-octeon/topology.h
@@ -30,6 +30,11 @@ static inline struct cpumask *cpumask_of_pcibus(struct pci_bus *bus)
 {
 	return cpumask_of_node(pcibus_to_node(bus));
 }
+
+struct device_node;
+int of_node_to_nid(struct device_node *np);
+#define of_node_to_nid of_node_to_nid
+
 #endif /* CONFIG_NUMA */
 
 static inline int pa_to_nid(u64 pa)
-- 
2.6.2

