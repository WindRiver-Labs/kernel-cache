From 4ae66c9178271881b98cdf4e7d3c134e2aef6647 Mon Sep 17 00:00:00 2001
From: Carlos Munoz <cmunoz@caviumnetworks.com>
Date: Mon, 13 Jul 2015 16:51:47 -0700
Subject: [PATCH 127/184] netdev: octeon3-ethernet: CN73XX has 64 SSO groups.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: abf8ce940d2100602546752c42e7effb633ca60c
Description:

Signed-off-by: Carlos Munoz <cmunoz@caviumnetworks.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index d8a0a53..eb8c0462 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -367,7 +367,7 @@ static void octeon3_eth_sso_pass1_limit(int node, int	grp)
 	 * many sso groups are used by code outside this driver we take the
 	 * worst case approach and assume all 256 sso groups must be supported.
 	 */
-	max_thr = 1264 / CVMX_SSO_NUM_XGRP;
+	max_thr = 1264 / cvmx_sso_num_xgrp();
 	if (max_thr < 4)
 		max_thr = 4;
 	rsvd_thr = max_thr - 1;
@@ -420,6 +420,7 @@ static int octeon3_eth_sso_init(unsigned int node, int aura)
 	union cvmx_sso_xaq_aura xaq_aura;
 	union cvmx_sso_err0 err0;
 	union cvmx_sso_grpx_pri grp_pri;
+	int max_grps;
 	int i;
 	int rv = 0;
 
@@ -437,7 +438,8 @@ static int octeon3_eth_sso_init(unsigned int node, int aura)
 	xaq_aura.s.node = node;
 	cvmx_write_csr_node(node, CVMX_SSO_XAQ_AURA, xaq_aura.u64);
 
-	for (i = 0; i < 256; i++) {
+	max_grps = cvmx_sso_num_xgrp();
+	for (i = 0; i < max_grps; i++) {
 		u64 phys;
 		void *mem = cvmx_fpa3_alloc(__cvmx_fpa3_gaura(node, aura));
 		if (!mem) {
@@ -475,6 +477,7 @@ static void octeon3_eth_sso_shutdown(unsigned int node)
 	union cvmx_sso_aw_cfg		aw_cfg;
 	cvmx_sso_grpx_aq_cnt_t		aq_cnt;
 	cvmx_sso_aw_status_t		aw_status;
+	int				max_grps;
 	int				i;
 
 	oen = octeon3_eth_node + node;
@@ -487,7 +490,8 @@ static void octeon3_eth_sso_shutdown(unsigned int node)
 	cvmx_write_csr_node(node, CVMX_SSO_AW_CFG, aw_cfg.u64);
 
 	/* Extract the fpa buffers */
-	for (i = 0; i < 256; i++) {
+	max_grps = cvmx_sso_num_xgrp();
+	for (i = 0; i < max_grps; i++) {
 		cvmx_sso_xaqx_head_ptr_t	head;
 		cvmx_sso_xaqx_tail_ptr_t	tail;
 		u64				addr;
-- 
1.9.1

