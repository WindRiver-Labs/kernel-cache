From 426353619af7c854a2c39ce0c24480c1252009a3 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Sat, 26 Jul 2014 18:05:50 -0700
Subject: [PATCH 852/974] netdev: octeon3-ethernet: Grab module reference on
 CN78XX_PASS1_0.

This chip cannot initialize its network hardware twice, so taking a
reference prevents the module from being unloaded, thus ensuring that
multiple initialization is not attempted.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index 47eec60..7a7fc01 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -789,6 +789,7 @@ static int octeon3_eth_global_init(unsigned int node)
 	unsigned int sso_intsn;
 	struct octeon3_ethernet_node *oen;
 	union cvmx_fpa_gen_cfg fpa_cfg;
+
 	mutex_lock(&octeon3_eth_init_mutex);
 
 	oen = octeon3_eth_node + node;
@@ -796,6 +797,13 @@ static int octeon3_eth_global_init(unsigned int node)
 	if (oen->init_done)
 		goto done;
 
+	/* CN78XX-P1.0 cannot un-initialize PKO, so get a module
+	 * reference to prevent it from being unloaded.
+	 */
+	if (OCTEON_IS_MODEL(OCTEON_CN78XX_PASS1_0))
+		if (!try_module_get(THIS_MODULE))
+			pr_err("ERROR: Could not obtain module reference for CN78XX-P1.0\n");
+
 	__cvmx_export_app_config_to_named_block(CVMX_APP_CONFIG);
 
 	INIT_LIST_HEAD(&oen->device_list);
@@ -2404,9 +2412,6 @@ static void __exit octeon3_eth_exit(void)
 	if (!OCTEON_IS_MODEL(OCTEON_CN78XX))
 		return;
 
-	if (OCTEON_IS_MODEL(OCTEON_CN78XX_PASS1_0))
-		pr_err("ERROR: rmmod of this driver is not supported on CN78XX-P1.0\n");
-
 	platform_driver_unregister(&octeon3_eth_driver);
 }
 module_exit(octeon3_eth_exit);
-- 
2.6.2

