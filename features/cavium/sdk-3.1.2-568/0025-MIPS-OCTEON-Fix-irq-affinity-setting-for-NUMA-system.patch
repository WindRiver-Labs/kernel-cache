From 7789dd20519bd718b64956e015713b07b5828bf9 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 19 Nov 2014 09:27:26 -0800
Subject: [PATCH 025/184] MIPS: OCTEON: Fix irq affinity setting for NUMA
 systems.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: c3e4e3f9ace6253c304ada07622f22a8bc2643b0
Description:

The affinity for a given irq may only be to CPUs on the node
containing the corresponding CIU3 block.

Also simplify getting node information for chip data.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/octeon-irq.c | 13 ++++++++-----
 1 file changed, 8 insertions(+), 5 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-irq.c b/arch/mips/cavium-octeon/octeon-irq.c
index d94535b..32a751c 100644
--- a/arch/mips/cavium-octeon/octeon-irq.c
+++ b/arch/mips/cavium-octeon/octeon-irq.c
@@ -2209,12 +2209,15 @@ int octeon_irq_ciu3_set_affinity(struct irq_data *data,
 	union cvmx_ciu3_iscx_ctl isc_ctl;
 	union cvmx_ciu3_iscx_w1c isc_w1c;
 	u64 isc_ctl_addr;
-	bool enable_one = !irqd_irq_disabled(data) && !irqd_irq_masked(data);
-	struct octeon_ciu_chip_data *cd;
 	int cpu;
+	bool enable_one = !irqd_irq_disabled(data) && !irqd_irq_masked(data);
+	struct octeon_ciu_chip_data *cd = irq_data_get_irq_chip_data(data);
+
+	if (!cpumask_subset(dest, cpumask_of_node(cd->ciu_node)))
+		return -EINVAL;
 
 	if (!enable_one)
-		return 0;
+		return IRQ_SET_MASK_OK;
 
 	cd = irq_data_get_irq_chip_data(data);
 	cpu = cpumask_first(dest);
@@ -2233,7 +2236,7 @@ int octeon_irq_ciu3_set_affinity(struct irq_data *data,
 	cvmx_write_csr(isc_ctl_addr, isc_ctl.u64);
 	cvmx_read_csr(isc_ctl_addr);
 
-	return 0;
+	return IRQ_SET_MASK_OK;
 }
 #endif
 
@@ -2301,7 +2304,7 @@ int octeon_irq_ciu3_mapx(struct irq_domain *d, unsigned int virq,
 {
 	struct octeon_ciu3_info *ciu3_info = d->host_data;
 	struct octeon_ciu_chip_data *cd = kzalloc_node(sizeof(*cd), GFP_KERNEL,
-						       of_node_to_nid(d->of_node));
+						       ciu3_info->node);
 	if (!cd)
 		return -ENOMEM;
 	cd->intsn = hw;
-- 
1.9.1

