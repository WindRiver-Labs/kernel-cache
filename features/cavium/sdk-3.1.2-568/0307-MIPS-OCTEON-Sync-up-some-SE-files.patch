From a81a40f36e77ad7826458b9642a608a968756116 Mon Sep 17 00:00:00 2001
From: Chandrakala Chavva <cchavva@caviumnetworks.com>
Date: Wed, 25 Sep 2013 10:29:21 -0700
Subject: [PATCH 307/974] MIPS:OCTEON: Sync up some SE files.

[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/executive/cvmx-pcie.c | 26 ++++++++++++++------------
 arch/mips/include/asm/octeon/cvmx-app-init.h  |  6 +++---
 2 files changed, 17 insertions(+), 15 deletions(-)

diff --git a/arch/mips/cavium-octeon/executive/cvmx-pcie.c b/arch/mips/cavium-octeon/executive/cvmx-pcie.c
index b451cf9..38d8010 100644
--- a/arch/mips/cavium-octeon/executive/cvmx-pcie.c
+++ b/arch/mips/cavium-octeon/executive/cvmx-pcie.c
@@ -42,7 +42,7 @@
  *
  * Interface to PCIe as a host(RC) or target(EP)
  *
- * <hr>$Revision: 88224 $<hr>
+ * <hr>$Revision: 88618 $<hr>
  */
 #ifdef CVMX_BUILD_FOR_LINUX_KERNEL
 #include <asm/octeon/cvmx.h>
@@ -801,6 +801,19 @@ static int __cvmx_pcie_rc_initialize_link_gen2(int pcie_port)
 	cvmx_pciercx_cfg032_t pciercx_cfg032;
 	cvmx_pciercx_cfg448_t pciercx_cfg448;
 
+	/* For CN7XXX we must turn the PEM on */
+	if (OCTEON_IS_OCTEON3()) {
+		cvmx_pemx_on_t pemx_on;
+
+		pemx_on.u64 = cvmx_read_csr(CVMX_PEMX_ON(pcie_port));
+		pemx_on.s.pemon = 1;
+		cvmx_write_csr(CVMX_PEMX_ON(pcie_port), pemx_on.u64);
+		if (CVMX_WAIT_FOR_FIELD64(CVMX_PEMX_ON(pcie_port), cvmx_pemx_on_t, pemoor, ==, 1, 100000)) {
+			cvmx_dprintf("PCIe: Port %d PEM not on, skipping\n", pcie_port);
+			return -1;
+		}
+	}
+
 	/* Bring up the link */
 	pem_ctl_status.u64 = cvmx_read_csr(CVMX_PEMX_CTL_STATUS(pcie_port));
 	pem_ctl_status.s.lnk_enb = 1;
@@ -1080,17 +1093,6 @@ static int __cvmx_pcie_rc_initialize_gen2(int pcie_port)
 		break;
 	case -1:
 	default:
-		if (OCTEON_IS_OCTEON3()) {
-			union cvmx_pemx_on pemx_on;
-			pemx_on.u64 = cvmx_read_csr(CVMX_PEMX_ON(pcie_port));
-			if (pemx_on.s.pemoor == 0) {
-				/* Reset PCIe PIPE out of reset */
-				pemx_on.s.pemon = 1;
-				cvmx_write_csr(CVMX_PEMX_ON(pcie_port), pemx_on.u64);
-				/* Wait until pcie resets the pipe */
-				cvmx_wait_usec(2000);
-			}
-		}
 		/* Bring the PCIe out of reset */
 		ciu_soft_prst.u64 = cvmx_read_csr(ciu_soft_prst_reg);
 		/* After a chip reset the PCIe will also be in reset. If it
diff --git a/arch/mips/include/asm/octeon/cvmx-app-init.h b/arch/mips/include/asm/octeon/cvmx-app-init.h
index 8ce64d9..1f75ff4 100644
--- a/arch/mips/include/asm/octeon/cvmx-app-init.h
+++ b/arch/mips/include/asm/octeon/cvmx-app-init.h
@@ -41,7 +41,7 @@
  * @file
  * Header file for simple executive application initialization.  This defines
  * part of the ABI between the bootloader and the application.
- * <hr>$Revision: 88074 $<hr>
+ * <hr>$Revision: 88298 $<hr>
  *
  */
 
@@ -271,7 +271,7 @@ enum cvmx_board_types_enum {
 	CVMX_BOARD_TYPE_IW_EVB = 52,
 	CVMX_BOARD_TYPE_CNF71XX_REF = 53,
 	CVMX_BOARD_TYPE_MOONSHOT = 54,
-	CVMX_BOARD_TYPE_EVB7000_SFF = 55,
+	CVMX_BOARD_TYPE_EVB7000_INTERPOSER = 55,
 	CVMX_BOARD_TYPE_EVB7000 = 56,
 	CVMX_BOARD_TYPE_MAX,
 	/* NOTE:  256-257 are being used by a customer. */
@@ -395,7 +395,7 @@ static inline const char *cvmx_board_type_to_string(enum cvmx_board_types_enum t
 		    ENUM_BRD_TYPE_CASE(CVMX_BOARD_TYPE_IW_EVB)
 		    ENUM_BRD_TYPE_CASE(CVMX_BOARD_TYPE_CNF71XX_REF)
 		    ENUM_BRD_TYPE_CASE(CVMX_BOARD_TYPE_MOONSHOT)
-		    ENUM_BRD_TYPE_CASE(CVMX_BOARD_TYPE_EVB7000_SFF)
+		    ENUM_BRD_TYPE_CASE(CVMX_BOARD_TYPE_EVB7000_INTERPOSER)
 		    ENUM_BRD_TYPE_CASE(CVMX_BOARD_TYPE_EVB7000)
 		    ENUM_BRD_TYPE_CASE(CVMX_BOARD_TYPE_MAX)
 
-- 
2.6.2

