From 94eca85203fd020a1f80d66e46b9ea0a9b99d562 Mon Sep 17 00:00:00 2001
From: Carlos Munoz <cmunoz@caviumnetworks.com>
Date: Fri, 27 Mar 2015 14:36:36 -0700
Subject: [PATCH 109/184] netdev: octeon-bgx-nexus: Unreset the mix interface
 in the bgx.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: b1bc880e8b11631cc0755085147fa0c4d50af70a
Description:

Signed-off-by: Carlos Munoz <cmunoz@caviumnetworks.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/ethernet/octeon/octeon-bgx-nexus.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/drivers/net/ethernet/octeon/octeon-bgx-nexus.c b/drivers/net/ethernet/octeon/octeon-bgx-nexus.c
index bca5c5a..ec106f7 100644
--- a/drivers/net/ethernet/octeon/octeon-bgx-nexus.c
+++ b/drivers/net/ethernet/octeon/octeon-bgx-nexus.c
@@ -165,6 +165,7 @@ static int bgx_probe(struct platform_device *pdev)
 		bool is_mix = false;
 		bool is_pki = false;
 		union cvmx_bgxx_cmrx_config cmr_config;
+		cvmx_bgxx_cmr_global_config_t global_config;
 		struct pdev_list_item *pdev_item;
 
 		if (!of_device_is_compatible(child, "cavium,octeon-7890-bgx-port"))
@@ -185,6 +186,21 @@ static int bgx_probe(struct platform_device *pdev)
 		cmr_config.s.mix_en = is_mix ? 1 : 0;
 		cvmx_write_csr_node(numa_node, CVMX_BGXX_CMRX_CONFIG(port, interface), cmr_config.u64);
 
+		/* Unreset the mix bgx interface or it will interfare with the
+		 * other ports.
+		 */
+		if (is_mix) {
+			global_config.u64 = cvmx_read_csr_node(numa_node,
+					CVMX_BGXX_CMR_GLOBAL_CONFIG(interface));
+			if (!port)
+				global_config.s.cmr_mix0_reset = 0;
+			else if (port == 1)
+				global_config.s.cmr_mix1_reset = 0;
+			cvmx_write_csr_node(numa_node,
+				    CVMX_BGXX_CMR_GLOBAL_CONFIG(interface),
+					    global_config.u64);
+		}
+
 		snprintf(id, sizeof(id), "%llx.%u.ethernet-mac", (unsigned long long)addr, port);
 		new_dev = of_platform_device_create(child, id, &pdev->dev);
 		if (!new_dev) {
-- 
1.9.1

