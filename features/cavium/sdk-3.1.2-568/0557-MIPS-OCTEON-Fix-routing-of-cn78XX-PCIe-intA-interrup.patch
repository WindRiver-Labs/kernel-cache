From 2d6c14af0c13d9e03846e19963b7ef21b3e574a1 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Sun, 23 Feb 2014 13:46:59 -0800
Subject: [PATCH 557/974] MIPS: OCTEON: Fix routing of cn78XX PCIe intA
 interrupts.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/pci/pcie-octeon.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/arch/mips/pci/pcie-octeon.c b/arch/mips/pci/pcie-octeon.c
index f22260c..45662cb 100644
--- a/arch/mips/pci/pcie-octeon.c
+++ b/arch/mips/pci/pcie-octeon.c
@@ -81,10 +81,13 @@ static struct irq_chip pcie_17400_chip = {
 #endif
 };
 
+static int pcie_17400_irqs[4][4];
+
 static irqreturn_t pcie_17400_handler(int irq, void *data)
 {
 	u64 int_sum;
 	struct pcie_17400_chip_data *cd = data;
+
 	generic_handle_irq(cd->irq);
 
 	int_sum = cvmx_read_csr_node(cd->node, CVMX_PEMX_INT_SUM(cd->pem));
@@ -118,6 +121,8 @@ static int __init octeon_pcie78xx_pcibios_map_irq(const struct pci_dev *dev,
 	c = dev->bus->sysdata;
 	pcie = container_of(c, struct octeon_pcie_interface, controller);
 
+	pin--; /* Adjust from 1 based to 0 based pinA */
+
 	intsn = 0xc003c + pin + (0x1000 * pcie->pem);
 
 	d = octeon_irq_get_block_domain(pcie->node, intsn >> 12);
@@ -126,6 +131,10 @@ static int __init octeon_pcie78xx_pcibios_map_irq(const struct pci_dev *dev,
 
 	if (!OCTEON_IS_MODEL(OCTEON_CN78XX_PASS1_X))
 		return irq;
+
+	if (pcie_17400_irqs[pin][pcie->pem])
+		return pcie_17400_irqs[pin][pcie->pem];
+
 	/* Else use the PCIE-17400 WAR */
 	cd = kzalloc_node(sizeof(*cd), GFP_KERNEL, pcie->node);
 	if (!cd)
@@ -151,6 +160,7 @@ static int __init octeon_pcie78xx_pcibios_map_irq(const struct pci_dev *dev,
 
 	irq_set_chip_and_handler(cd->irq, &pcie_17400_chip, handle_simple_irq);
 	irq_set_chip_data(cd->irq, cd);
+	pcie_17400_irqs[pin][pcie->pem] = cd->irq;
 
 	return cd->irq;
 
-- 
2.6.2

