From bc808e575b67ae626ad91c82e26562a792b63bf2 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 17 Oct 2013 18:21:07 -0700
Subject: [PATCH 341/974] MIPS: paravirt: Handle SMP_ICACHE_FLUSH IPI message

Needed on OCTEON systems.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/include/asm/mach-paravirt/irq.h |  1 +
 arch/mips/paravirt/paravirt-irq.c         |  8 ++++----
 arch/mips/paravirt/paravirt-smp.c         | 11 +++++++++++
 3 files changed, 16 insertions(+), 4 deletions(-)

diff --git a/arch/mips/include/asm/mach-paravirt/irq.h b/arch/mips/include/asm/mach-paravirt/irq.h
index 9b4d35e..c3c92b6 100644
--- a/arch/mips/include/asm/mach-paravirt/irq.h
+++ b/arch/mips/include/asm/mach-paravirt/irq.h
@@ -15,5 +15,6 @@
 
 #define MIPS_IRQ_MBOX0 (MIPS_CPU_IRQ_BASE + 32)
 #define MIPS_IRQ_MBOX1 (MIPS_CPU_IRQ_BASE + 33)
+#define MIPS_IRQ_MBOX2 (MIPS_CPU_IRQ_BASE + 34)
 
 #endif /* __ASM_MACH_PARAVIRT_IRQ_H__ */
diff --git a/arch/mips/paravirt/paravirt-irq.c b/arch/mips/paravirt/paravirt-irq.c
index fca5494..3d0e521 100644
--- a/arch/mips/paravirt/paravirt-irq.c
+++ b/arch/mips/paravirt/paravirt-irq.c
@@ -13,7 +13,7 @@
 
 #include <asm/io.h>
 
-#define MBOX_BITS_PER_CPU 2
+#define MBOX_BITS_PER_CPU 3
 
 int cpunum_for_cpu(int cpu)
 {
@@ -273,7 +273,7 @@ void irq_mbox_ipi(int cpu, unsigned int actions)
 	unsigned int cpuid = cpunum_for_cpu(cpu);
 	u32 mask;
 
-	WARN_ON(actions >= (1 << MBOX_BITS_PER_CPU));
+	WARN(actions >= (1 << MBOX_BITS_PER_CPU), "actions: %x\n", actions);
 
 	mask = actions << (cpuid * MBOX_BITS_PER_CPU);
 	__raw_writel(mask, mips_irq_chip + mips_irq_chip_reg_raw_w1s + sizeof(u32));
@@ -336,7 +336,7 @@ static void __init irq_pci_init(void)
 	for (i = 0; i < 4; i++)
 		irq_set_chip_and_handler(i + MIPS_IRQ_PCIA, &irq_chip_pci, handle_level_irq);
 
-	for (i = 0; i < 2; i++)
+	for (i = 0; i < MBOX_BITS_PER_CPU; i++)
 		irq_set_chip_and_handler(i + MIPS_IRQ_MBOX0, &irq_chip_mbox, handle_percpu_irq);
 
 
@@ -351,7 +351,7 @@ static void irq_pci_dispatch(void)
 
 	if (!en) {
 		en = __raw_readl(mips_irq_chip + mips_irq_chip_reg_src + (cpuid * mips_irq_cpu_stride) + sizeof(u32));
-		en = (en >> (2 * cpuid)) & 3;
+		en = (en >> (MBOX_BITS_PER_CPU * cpuid)) & ((1u << MBOX_BITS_PER_CPU) - 1);
 
 		if (!en)
 			spurious_interrupt();
diff --git a/arch/mips/paravirt/paravirt-smp.c b/arch/mips/paravirt/paravirt-smp.c
index 52f86eb..b0ee1ab 100644
--- a/arch/mips/paravirt/paravirt-smp.c
+++ b/arch/mips/paravirt/paravirt-smp.c
@@ -123,6 +123,12 @@ static irqreturn_t paravirt_function_interrupt(int irq, void *dev_id)
 	return IRQ_HANDLED;
 }
 
+static irqreturn_t paravirt_icache_interrupt(int irq, void *dev_id)
+{
+	asm("synci	0($0)");  /* Only used for OCTEON */
+	return IRQ_HANDLED;
+}
+
 static void paravirt_prepare_cpus(unsigned int max_cpus)
 {
 	if (request_irq(MIPS_IRQ_MBOX0, paravirt_reched_interrupt,
@@ -135,6 +141,11 @@ static void paravirt_prepare_cpus(unsigned int max_cpus)
 			paravirt_function_interrupt)) {
 		panic("Cannot request_irq for SMP-Call");
 	}
+	if (request_irq(MIPS_IRQ_MBOX2, paravirt_icache_interrupt,
+			IRQF_PERCPU | IRQF_NO_THREAD, "ICache Inv",
+			paravirt_icache_interrupt)) {
+		panic("Cannot request_irq for ICache Inv");
+	}
 }
 
 struct plat_smp_ops paravirt_smp_ops = {
-- 
2.6.2

