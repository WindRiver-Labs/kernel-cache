From ff686610b39c9ca318c9d82a1be63c5806477967 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Tue, 12 Sep 2017 11:23:34 +0800
Subject: [PATCH 1/2] octeon: perf_counters.c: use OCTEON_IS_OCTEON3() to
 replace current_cpu_type()

current_cpu_type() using smp_processor_id() in preemptible code.
Replace it to avoid the below calltrace:

BUG: using smp_processor_id() in preemptible [00000000] code: cat/3088
caller is proc_perf_show+0x4fc/0xc20
CPU: 36 PID: 3088 Comm: cat Not tainted 4.1.21-WR8.0.0.0_standard #1
Stack : ffffffff81680000 ffffffff81201ce8 ffffffff81680000 ffffffff810ab2f4
 0000000000000024 ffffffff812ec7b0 ffffffff812ec7b0 ffffffff81572790
 0000000000000000 ffffffff808e8c80 0000000000000044 0000000000000024
 ffffffff81370000 ffffffff808e9578 0000000000000000 ffffffff81660000
 0000000000000000 ffffffff8091dac0 ffffffff8165a478 000000000000000b
 ffffffff808e9980 ffffffff815727b0 ffffffff81201eb8 0000000000000024
 0000000000000c10 ffffffff8165a478 ffffffff812f0000 0000000000002000
 0000000000000000 8000000402ae3ad0 8000000402ae3bf8 ffffffff810a505c
 ffffffff812f2387 ffffffff811f8348 80000004093a5e80 ffffffff808ea744
 0000000000000030 ffffffff80875bb0 0000000000000024 0000000000000c10
 ...
Call Trace:
[<ffffffff80875bb0>] show_stack+0xe8/0x108
[<ffffffff810a505c>] dump_stack+0xa4/0xdc
[<ffffffff80d3bf30>] check_preemption_disabled+0x110/0x118
[<ffffffff8086addc>] proc_perf_show+0x4fc/0xc20
[<ffffffff80a2b660>] seq_read+0x1e8/0x4b8
[<ffffffff80a6cfcc>] proc_reg_read+0x74/0xa8
[<ffffffff80a00d0c>] vfs_read+0x8c/0x150
[<ffffffff80a018a4>] SyS_read+0x64/0xe8
[<ffffffff80882404>] handle_sysn32+0x44/0x70

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/perf_counters.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/arch/mips/cavium-octeon/perf_counters.c b/arch/mips/cavium-octeon/perf_counters.c
index 223be3d..685892e 100755
--- a/arch/mips/cavium-octeon/perf_counters.c
+++ b/arch/mips/cavium-octeon/perf_counters.c
@@ -472,7 +472,7 @@ static int proc_perf_show(struct seq_file *m, void *v)
 
 			/* Check if LMC controller is enabled. */
 			ctl2.u64 = cvmx_read_csr(CVMX_LMCX_DLL_CTL2(tad));
-			if (current_cpu_type() == CPU_CAVIUM_OCTEON3) {
+			if (OCTEON_IS_OCTEON3()) {
 				if (ctl2.cn70xx.quad_dll_ena == 0)
 					continue;
 			} else if (ctl2.cn63xx.quad_dll_ena == 0)
-- 
1.7.5.4

