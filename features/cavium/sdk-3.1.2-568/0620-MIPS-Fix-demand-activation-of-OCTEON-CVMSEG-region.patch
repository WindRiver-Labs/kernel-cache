From 87dc2cd707219d59a53d428f9252c45a9adb3254 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 16 Jul 2014 14:39:04 -0700
Subject: [PATCH 620/974] MIPS: Fix demand activation of OCTEON CVMSEG region.

OCTEON III processors can use several addresses in the CVMSEG_IO
range, so enable them all.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/kernel/unaligned.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/arch/mips/kernel/unaligned.c b/arch/mips/kernel/unaligned.c
index ec2c005..3475cfa 100644
--- a/arch/mips/kernel/unaligned.c
+++ b/arch/mips/kernel/unaligned.c
@@ -1634,13 +1634,13 @@ asmlinkage void do_ade(struct pt_regs *regs)
 	 * app.
 	 */
 	const unsigned long CVMSEG_BASE	= 0xffffffffffff8000ul;
-	const unsigned long CVMSEG_IO	= 0xffffffffffffa200ul;
+	const unsigned long CVMSEG_IO		= 0xffffffffffffa000ul;
+	const unsigned long CVMSEG_IO_END	= 0xffffffffffffc000ul;
 	u64 cvmmemctl			= __read_64bit_c0_register($11, 7);
 	unsigned long cvmseg_size	= (cvmmemctl & 0x3f) * 128;
 
-	if ((regs->cp0_badvaddr == CVMSEG_IO) ||
-	    ((regs->cp0_badvaddr >= CVMSEG_BASE) &&
-	     (regs->cp0_badvaddr < CVMSEG_BASE + cvmseg_size))) {
+	if ((regs->cp0_badvaddr >= CVMSEG_IO && regs->cp0_badvaddr < CVMSEG_IO_END) ||
+	    (regs->cp0_badvaddr >= CVMSEG_BASE && regs->cp0_badvaddr < CVMSEG_BASE + cvmseg_size)) {
 		preempt_disable();
 		cvmmemctl = __read_64bit_c0_register($11, 7);
 		/* Make sure all async operations are done */
-- 
2.6.2

