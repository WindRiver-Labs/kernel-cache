From d85a9b86dec2e4921e366fa847c2ee8eb6de3fe5 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Sat, 5 Jul 2014 18:05:50 -0700
Subject: [PATCH 863/974] netdev: octeon3-ethernet: Move kmem_cache_destroy()
 to module_exit function.

This is the easiest way to ensure that it is done last.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index 7a7fc01..dd19d3f 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -2332,9 +2332,6 @@ static int octeon3_eth_global_exit(int node)
 	cvmx_fpa3_release_pool(oen->sso_pool);
 	kfree(oen->sso_pool_stack);
 
-	/* Destroy the memory cache used by sso and pko */
-	kmem_cache_destroy(octeon3_eth_sso_pko_cache);
-
 	return 0;
 }
 
@@ -2413,6 +2410,10 @@ static void __exit octeon3_eth_exit(void)
 		return;
 
 	platform_driver_unregister(&octeon3_eth_driver);
+
+	/* Destroy the memory cache used by sso and pko */
+	if (octeon3_eth_sso_pko_cache)
+		kmem_cache_destroy(octeon3_eth_sso_pko_cache);
 }
 module_exit(octeon3_eth_exit);
 
-- 
2.6.2

