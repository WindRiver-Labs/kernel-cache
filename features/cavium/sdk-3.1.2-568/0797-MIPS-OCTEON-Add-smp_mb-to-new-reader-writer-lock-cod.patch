From 47d230a5d56d975fcf978897f5da6f993a6fa4be Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Sat, 12 Jul 2014 18:05:50 -0700
Subject: [PATCH 797/974] MIPS: OCTEON: Add smp_mb() to new reader/writer lock
 code arch_read_unlock().

Empirical evidence suggests that this is needed.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/include/asm/spinlock.h | 1 +
 1 file changed, 1 insertion(+)

diff --git a/arch/mips/include/asm/spinlock.h b/arch/mips/include/asm/spinlock.h
index 24ee9a9..e13cb81 100644
--- a/arch/mips/include/asm/spinlock.h
+++ b/arch/mips/include/asm/spinlock.h
@@ -262,6 +262,7 @@ static inline void arch_read_unlock(arch_rwlock_t *rw)
 {
 	int dec = -1;
 
+	smp_mb();
 	__asm__ __volatile__(
 		"saa	%[dec], (%[rw])			\n"
 		"	pref	26, 0(%[rw]) #nudge	\n"
-- 
2.6.2

