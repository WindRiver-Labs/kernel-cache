From 8392438d53e9e2ed21bfc2b29b318e9fff3fb474 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 25 Jul 2014 18:05:50 -0700
Subject: [PATCH 692/974] MIPS: OCTEON: Try to allocate at least 64MB of DMA32
 memory.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/setup.c | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index f4b2a0f..a2be65f1 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -1006,10 +1006,13 @@ void __init plat_mem_setup(void)
 		mem_alloc_size = MAX_MEMORY;
 
 	cvmx_bootmem_lock();
+	limit_max = 0xffffffffull;
+	limit_min = 0;
 	while ((boot_mem_map.nr_map < BOOT_MEM_MAP_MAX)
 		&& (total < MAX_MEMORY)) {
-		limit_max = ~0ull;		/* unlimitted */
-		limit_min = 0;
+		/* Try to get 64MB of 32=bit memory */
+		if (total >= 64 * (1<<20))
+			limit_max = ~0ull;		/* unlimitted */
 
 		memory = cvmx_bootmem_phy_alloc(mem_alloc_size,
 				limit_min, limit_max, 0x100000,
@@ -1038,7 +1041,10 @@ void __init plat_mem_setup(void)
 				add_memory_region(memory, size, BOOT_MEM_RAM);
 			total += mem_alloc_size;
 		} else {
-			break;
+			if (limit_max < ~0ull)
+				limit_max = ~0ull;		/* unlimitted */
+			else
+				break;
 		}
 	}
 	cvmx_bootmem_unlock();
-- 
2.6.2

