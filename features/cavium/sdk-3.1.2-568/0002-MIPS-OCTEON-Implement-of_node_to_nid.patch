From 1837336c61528607af31ec707f308bae4040b1ca Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 29 Oct 2014 16:13:25 -0700
Subject: [PATCH 002/184] MIPS: OCTEON: Implement of_node_to_nid()

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 684b82f38f90a47a209c4018628ed007d5ac6cae
Description:

More NUMA support needed by device drivers.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/octeon-numa.c              | 25 ++++++++++++++++++++++
 .../mips/include/asm/mach-cavium-octeon/topology.h |  5 +++++
 2 files changed, 30 insertions(+)

diff --git a/arch/mips/cavium-octeon/octeon-numa.c b/arch/mips/cavium-octeon/octeon-numa.c
index 1a3e3cb..2751e5b 100644
--- a/arch/mips/cavium-octeon/octeon-numa.c
+++ b/arch/mips/cavium-octeon/octeon-numa.c
@@ -12,6 +12,7 @@
 #include <linux/nodemask.h>
 #include <linux/bootmem.h>
 #include <linux/swap.h>
+#include <linux/of.h>
 
 #include <asm/sections.h>
 
@@ -100,3 +101,27 @@ void __init mem_init(void)
 	       datasize >> 10,
 	       initsize >> 10);
 }
+
+int of_node_to_nid(struct device_node *np)
+{
+	int ret = 0;
+	struct device_node *node = of_node_get(np);
+
+	do {
+		if (strcmp("soc", node->name) == 0) {
+			int rc;
+			u32 msbits = 0;
+
+			rc = of_property_read_u32_index(node, "ranges",	2, &msbits);
+			if (rc == -EINVAL)
+				WARN_ONCE(true, "Missing ranges property<%s>\n", node->full_name);
+			ret = (msbits >> 4) & 1;
+			break;
+		}
+		node = of_get_next_parent(node);
+	} while (node);
+
+	of_node_put(node);
+	return ret;
+}
+EXPORT_SYMBOL(of_node_to_nid);
diff --git a/arch/mips/include/asm/mach-cavium-octeon/topology.h b/arch/mips/include/asm/mach-cavium-octeon/topology.h
index 76a8c2a..5a0a586 100644
--- a/arch/mips/include/asm/mach-cavium-octeon/topology.h
+++ b/arch/mips/include/asm/mach-cavium-octeon/topology.h
@@ -30,6 +30,11 @@ static inline struct cpumask *cpumask_of_pcibus(struct pci_bus *bus)
 {
 	return cpumask_of_node(pcibus_to_node(bus));
 }
+
+struct device_node;
+int of_node_to_nid(struct device_node *np);
+#define of_node_to_nid of_node_to_nid
+
 #endif /* CONFIG_NUMA */
 
 static inline int pa_to_nid(u64 pa)
-- 
1.9.1

