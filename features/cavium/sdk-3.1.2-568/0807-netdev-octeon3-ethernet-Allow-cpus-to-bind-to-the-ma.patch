From dd776ceb8aa2929ad14410043ec8e4ed36a524db Mon Sep 17 00:00:00 2001
From: Carlos Munoz <cmunoz@caviumnetworks.com>
Date: Wed, 23 Jul 2014 18:05:50 -0700
Subject: [PATCH 807/974] netdev: octeon3-ethernet: Allow cpus to bind to the
 maximum number of napis per node.

Signed-off-by: Carlos Munoz <cmunoz@caviumnetworks.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index f739680..70b1e7f 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -842,7 +842,7 @@ static struct sk_buff *octeon3_eth_work_to_skb(void *w)
 static int octeon3_napi_alloc_cpu(int	node)
 {
 	int				cpu;
-	int				min_cnt = MAX_NAPI_PER_CPU;
+	int				min_cnt = MAX_NAPIS_PER_NODE;
 	int				min_cpu = -EBUSY;
 
 	for_each_cpu(cpu, cpumask_of_node(node)) {
@@ -1588,6 +1588,7 @@ static int octeon3_eth_ndo_open(struct net_device *netdev)
  err4:
 	bitmap_clear(priv->rx_cxt[i].napi_idx_bitmap, idx, 1);
  err3:
+	irq_set_affinity_hint(rx->rx_irq, NULL);
 	free_irq(rx->rx_irq, rx);
  err2:
 	irq_dispose_mapping(rx->rx_irq);
-- 
2.6.2

