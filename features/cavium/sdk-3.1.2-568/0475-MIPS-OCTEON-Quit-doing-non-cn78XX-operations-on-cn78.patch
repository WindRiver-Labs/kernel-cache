From 95dd8d4f48d8ec6f6d29d866e8b1f7741af72ac9 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 7 Feb 2014 13:46:59 -0800
Subject: [PATCH 475/974] MIPS/OCTEON: Quit doing non-cn78XX operations on
 cn78XX

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/setup.c |  4 +--
 arch/mips/cavium-octeon/smp.c   | 62 ++++-------------------------------------
 2 files changed, 8 insertions(+), 58 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index 2d54438..af06b56 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -536,7 +536,7 @@ void octeon_user_io_init(void)
 		/* 4096 cycles */
 		nm_tim.s.nw_tim = 3;
 		cvmx_write_csr(CVMX_SSO_NW_TIM, nm_tim.u64);
-	} else {
+	} else if (!OCTEON_IS_MODEL(OCTEON_CN78XX)){
 		union cvmx_pow_nw_tim nm_tim;
 		nm_tim.u64 = 0;
 		/* 4096 cycles */
@@ -742,7 +742,7 @@ void __init prom_init(void)
 	if (OCTEON_IS_MODEL(OCTEON_CN38XX_PASS2) ||
 	    OCTEON_IS_MODEL(OCTEON_CN31XX))
 		cvmx_write_csr(CVMX_CIU_SOFT_BIST, 0);
-	else
+	else if (!OCTEON_IS_MODEL(OCTEON_CN78XX))
 		cvmx_write_csr(CVMX_CIU_SOFT_BIST, 1);
 
 	/* Default to 64MB in the simulator to speed things up */
diff --git a/arch/mips/cavium-octeon/smp.c b/arch/mips/cavium-octeon/smp.c
index dfa29bd..d2755e9 100644
--- a/arch/mips/cavium-octeon/smp.c
+++ b/arch/mips/cavium-octeon/smp.c
@@ -202,7 +202,6 @@ static void octeon_smp_setup(void)
 #ifdef CONFIG_HOTPLUG_CPU
 	unsigned int num_cores = cvmx_octeon_num_cores();
 	struct cvmx_app_hotplug_global *hgp;
-	char hexstr[CVMX_MIPS_MAX_CORES/4+1];
 	unsigned long t;
 #endif
 	struct cvmx_sysinfo *sysinfo = cvmx_sysinfo_get();
@@ -277,13 +276,13 @@ static void octeon_smp_setup(void)
 		octeon_hotplug_entry_addr = 0;
 		return;
 	}
-
+#if 0
 	/* Convert coremask to string for printing */
 	cvmx_coremask_bmp2str(&hgp->avail_coremask, hexstr);
 
 	/* Print the available coremask on to the console */
 	pr_info("Cavium Hotplug: Available coremask 0x%s\n", hexstr);
-
+#endif
 	/* Set global ptr for use by other functions */
 	octeon_hotplug_global_ptr = hgp;
 #endif
@@ -391,7 +390,6 @@ static void octeon_cpus_done(void)
 {
 #ifdef CONFIG_HOTPLUG_CPU
 	struct cvmx_app_hotplug_global *hgp;
-	char hexstr[CVMX_MIPS_MAX_CORES/4+1];
 	unsigned int cpu;
 
 	hgp = octeon_hotplug_global_ptr;
@@ -404,13 +402,14 @@ static void octeon_cpus_done(void)
 		if (!cpu_online(cpu))
 			set_cpu_present(cpu, true);
 	}
-
+#if 0
 	/* Convert coremask to string for printing */
 	cvmx_coremask_bmp2str(&hgp->avail_coremask, hexstr);
 
 	/* Print the available coremask on to the console */
 	pr_info("Cavium Hotplug: Available coremask 0x%s\n", hexstr);
 #endif
+#endif
 }
 
 #ifdef CONFIG_HOTPLUG_CPU
@@ -420,54 +419,6 @@ DEFINE_PER_CPU(int, cpu_state);
 
 extern void fixup_irqs(void);
 
-/*
- * Convert coremask to a printable hex string
- * Same function by name and purpose is also found in cvmx-coremask.c
- * but with a different implementation.
- */
-int cvmx_coremask_bmp2str(const cvmx_coremask_t *pcm, char *hexstr)
-{
-	int core;
-	char *p;
-	unsigned int i;
-	unsigned int nibbles;
-	unsigned int num_cores = cvmx_octeon_num_cores();
-	static const char hextab[16] = {
-		'0', '1', '2', '3', '4', '5', '6', '7', '8', '9',
-		'a', 'b', 'c', 'd', 'e', 'f'};
-
-	if (num_cores >= CVMX_MIPS_MAX_CORES)
-		return -1;
-
-	p = hexstr;
-
-	/* round-up num_cores to modulus 4 */
-	num_cores += 3;
-	num_cores &= ~3;
-
-	/* Calculate nibble count */
-	nibbles = num_cores >> 2;
-
-	/* Clear the buffer */
-	for (i = 0; i <= nibbles; i++)
-		p[i] = '\0';
-
-	/* Place core bits into nibbles, 4 bits per nibble */
-	for (core = num_cores - 1; core >= 0; core--) {
-		if (cvmx_coremask_is_core_set(pcm, core))
-			p[nibbles - (core>>2) - 1] |= 1 << (core & 3);
-	}
-
-	/* Convert each nibble into a hex char */
-	for (i = 0; i < nibbles; i++)
-		p[i] = hextab[p[i] & 0xf];
-
-	p[i] = '\0';
-
-	/* return the number if buffer bytes touched */
-	return nibbles+1;
-}
-
 static int octeon_cpu_disable(void)
 {
 	unsigned int cpu = smp_processor_id();
@@ -489,7 +440,6 @@ static void octeon_cpu_die(unsigned int cpu)
 	int coreid = cpu_logical_map(cpu);
 	int node;
 	struct cvmx_app_hotplug_global *hgp = octeon_hotplug_global_ptr;
-	char hexstr[CVMX_MIPS_MAX_CORES/4+3];
 
 	BUG_ON(!hgp);
 
@@ -501,11 +451,11 @@ static void octeon_cpu_die(unsigned int cpu)
 	cvmx_spinlock_unlock(&hgp->hotplug_global_lock);
 
 	mb();
-
+#if 0
 	/* Convert coremask to string for printing */
 	cvmx_coremask_bmp2str(&hgp->avail_coremask, hexstr);
 	pr_info("Reset core %d. Available Coremask = 0x%s\n", coreid, hexstr);
-
+#endif
 	/* Covert coreid to node/core spec and send NMI to target core */
 	node = cvmx_coremask_core_to_node(coreid);
 	coreid = cvmx_coremask_core_on_node(coreid);
-- 
2.6.2

