From b46f17a2d81428b7ae773b12870e1192b39db2a3 Mon Sep 17 00:00:00 2001
From: Sunil Goutham <sgoutham@cavium.com>
Date: Wed, 4 Jun 2014 12:52:18 +0530
Subject: [PATCH 067/184] ITS: Fixed crash while ITS mapping recreation

Source: Cavium Networks, Inc.
MR: 13384
Type: Integration
Disposition: Merged from THUNDERX Tree
ChangeID: 2612a9565c67bb27e5b2fadc8d92048bab19fa24
Description:

Issue: When MSI-X interrupts are teared down ITS device is freed, but not removed
from the list. Due to this when ITS is asked to recreate the MSI-X irq mapping
ITS device is not created again and uses the freed one itself. This is resulting
in crash.

Signed-off-by: Sunil Goutham <sgoutham@cavium.com>
Signed-off-by: Robert Richter <rrichter@cavium.com>
(cherry picked from commit e106c89e86f5decc6655f6f3a2e8d8682b1e4be0)

Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/irqchip/irq-gic-v3-its.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/irqchip/irq-gic-v3-its.c b/drivers/irqchip/irq-gic-v3-its.c
index 9a791dd..003ef93 100644
--- a/drivers/irqchip/irq-gic-v3-its.c
+++ b/drivers/irqchip/irq-gic-v3-its.c
@@ -1384,6 +1384,7 @@ static void its_irq_domain_free(struct irq_domain *domain, unsigned int virq,
 
 		/* Unmap device/itt */
 		its_send_mapd(its_dev, 0);
+		list_del(&its_dev->entry);
 		its_free_device(its_dev);
 	}
 
-- 
1.9.1

