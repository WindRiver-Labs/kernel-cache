From 871fad6fd5cb4de4315e39b2abc026af78e45fcc Mon Sep 17 00:00:00 2001
From: Chandrakala Chavva <cchavva@caviumnetworks.com>
Date: Mon, 18 Jan 2016 12:44:35 -0800
Subject: [PATCH 11/13] MIPS/EDAC: Use correct fields for printing error
 message for O3 model

Signed-off-by: Chandrakala Chavva <cchavva@caviumnetworks.com>
[Original patch taken from patch set for OCTEON SDK 3.1.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/edac/octeon_edac-l2c.c |   28 ++++++++++++++++++++++++----
 drivers/edac/octeon_edac-lmc.c |   14 ++++++++++----
 2 files changed, 34 insertions(+), 8 deletions(-)

diff --git a/drivers/edac/octeon_edac-l2c.c b/drivers/edac/octeon_edac-l2c.c
index e5c8a1f..25d00e2 100644
--- a/drivers/edac/octeon_edac-l2c.c
+++ b/drivers/edac/octeon_edac-l2c.c
@@ -184,6 +184,7 @@ static void _octeon_l2c_poll_oct3(struct edac_device_ctl_info *l2c, int tad)
 {
 	union cvmx_l2c_tqdx_err tqdx_err;
 	union cvmx_l2c_ttgx_err ttgx_err;
+	union cvmx_l2c_tadx_err l2c_err;
 	union cvmx_l2c_tadx_int l2c_reset;
 	int way, l2idx;
 
@@ -238,10 +239,16 @@ static void _octeon_l2c_poll_oct3(struct edac_device_ctl_info *l2c, int tad)
 	}
 
 	ttgx_err.u64 = cvmx_read_csr(CVMX_L2C_TTGX_ERR(tad));
-	way = OCTEON_IS_MODEL(OCTEON_CN70XX) ? ttgx_err.cn70xx.way
-				: ttgx_err.cn78xx.way;
-	l2idx = OCTEON_IS_MODEL(OCTEON_CN70XX) ? ttgx_err.cn70xx.l2idx
-				: ttgx_err.cn78xx.l2idx;
+	if (OCTEON_IS_MODEL(OCTEON_CN70XX)) {
+		way = ttgx_err.cn70xx.way;
+		l2idx = ttgx_err.cn70xx.l2idx;
+	} else if (OCTEON_IS_MODEL(OCTEON_CN78XX)) {
+		way = ttgx_err.cn78xx.way;
+		l2idx = ttgx_err.cn78xx.l2idx;
+	} else {
+		way = ttgx_err.cn73xx.way;
+		l2idx = ttgx_err.cn73xx.l2idx;
+	}
 
 	if (ttgx_err.s.tagdbe || ttgx_err.s.tagsbe)
 		snprintf(buf1, sizeof(buf1),
@@ -260,6 +267,19 @@ static void _octeon_l2c_poll_oct3(struct edac_device_ctl_info *l2c, int tad)
 		l2c_reset.cn70xx.tagsbe = 1;
 		edac_device_handle_ce(l2c, tad, 0, buf2);
 	}
+
+	l2c_err.u64 = cvmx_read_csr(CVMX_L2C_TADX_ERR(tad));
+	if (l2c_err.s.bigrd) {
+		snprintf(buf1, sizeof(buf1),
+			"Read reference past L2C_BIG_CTL[MAXDRAM] occurred:");
+		l2c_reset.cn70xx.bigrd = true;
+	}
+	if (l2c_err.s.bigwr) {
+		snprintf(buf1, sizeof(buf1),
+			"Write reference past L2C_BIG_CTL[MAXDRAM] occurred:");
+		l2c_reset.cn70xx.bigwr = true;
+	}
+
 	if (l2c_reset.u64)
 		cvmx_write_csr(CVMX_L2C_TADX_INT(tad), l2c_reset.u64);
 }
diff --git a/drivers/edac/octeon_edac-lmc.c b/drivers/edac/octeon_edac-lmc.c
index aec7e78..8be5351 100644
--- a/drivers/edac/octeon_edac-lmc.c
+++ b/drivers/edac/octeon_edac-lmc.c
@@ -63,10 +63,16 @@ static void octeon_lmc_edac_poll_o2(struct mem_ctl_info *mci)
 	if (int_reg.s.sec_err || int_reg.s.ded_err) {
 		union cvmx_lmcx_fadr fadr;
 		fadr.u64 = cvmx_read_csr(CVMX_LMCX_FADR(mci->mc_idx));
-		snprintf(msg, sizeof(msg),
-			 "DIMM %d rank %d bank %d row %d col %d",
-			 fadr.cn61xx.fdimm, fadr.cn61xx.fbunk,
-			 fadr.cn61xx.fbank, fadr.cn61xx.frow, fadr.cn61xx.fcol);
+		if (OCTEON_IS_OCTEON3())
+			snprintf(msg, sizeof(msg),
+				"DIMM %d rank %d bank %d row %d col %d",
+				fadr.cn70xx.fdimm, fadr.cn70xx.fbunk,
+				fadr.cn70xx.fbank, fadr.cn70xx.frow, fadr.cn70xx.fcol);
+		else
+			snprintf(msg, sizeof(msg),
+				"DIMM %d rank %d bank %d row %d col %d",
+				fadr.cn61xx.fdimm, fadr.cn61xx.fbunk,
+				fadr.cn61xx.fbank, fadr.cn61xx.frow, fadr.cn61xx.fcol);
 	}
 
 	if (int_reg.s.sec_err) {
-- 
1.7.5.4

