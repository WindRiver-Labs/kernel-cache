From 4f5f6ee08cee93f25a908ef7a7f3fb0d3929e7f6 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 19 Nov 2014 10:07:29 -0800
Subject: [PATCH 027/184] MIPS: OCTEON: Implement pcibus_to_node().

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: d6f55056113ec68f8ec6d2fa29a4d87cf1cd0e7a
Description:

Move definition to pcie-octeon.c, and make it actually return the
node.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 .../mips/include/asm/mach-cavium-octeon/topology.h | 11 ++++-----
 arch/mips/pci/pcie-octeon.c                        | 28 ++++++++++++++++++++++
 2 files changed, 32 insertions(+), 7 deletions(-)

diff --git a/arch/mips/include/asm/mach-cavium-octeon/topology.h b/arch/mips/include/asm/mach-cavium-octeon/topology.h
index 2e6a1b5..aabd875 100644
--- a/arch/mips/include/asm/mach-cavium-octeon/topology.h
+++ b/arch/mips/include/asm/mach-cavium-octeon/topology.h
@@ -1,6 +1,10 @@
 #ifndef _ASM_MACH_CAVIUM_OCTEON_TOPOLOGY_H
 #define _ASM_MACH_CAVIUM_OCTEON_TOPOLOGY_H
 
+struct pci_bus;
+int pcibus_to_node(struct pci_bus *bus);
+#define pcibus_to_node pcibus_to_node
+
 #ifdef CONFIG_NUMA
 
 static inline int cpu_to_node(int cpu)
@@ -23,13 +27,6 @@ static inline int parent_node(int node)
 }
 #define parent_node parent_node
 
-struct pci_bus;
-static inline int pcibus_to_node(struct pci_bus *bus)
-{
-	return 0;
-}
-#define pcibus_to_node pcibus_to_node
-
 static inline struct cpumask *cpumask_of_pcibus(struct pci_bus *bus)
 {
 	return cpumask_of_node(pcibus_to_node(bus));
diff --git a/arch/mips/pci/pcie-octeon.c b/arch/mips/pci/pcie-octeon.c
index be31236..fa214c0 100644
--- a/arch/mips/pci/pcie-octeon.c
+++ b/arch/mips/pci/pcie-octeon.c
@@ -53,6 +53,14 @@ struct pcie_17400_chip_data {
 	unsigned int intsn;
 };
 
+static struct octeon_pcie_interface *octeon_pcie_bus2interface(struct pci_bus *bus)
+{
+	struct octeon_pcie_interface *r;
+
+	r = container_of(bus->sysdata, struct octeon_pcie_interface, controller);
+	return r;
+}
+
 static void pcie_17400_enable(struct irq_data *data)
 {
 	struct pcie_17400_chip_data *cd = irq_data_get_irq_chip_data(data);
@@ -169,6 +177,26 @@ err:
 	return rv;
 }
 
+int pcibus_to_node(struct pci_bus *bus)
+{
+#ifdef CONFIG_NUMA
+	struct octeon_pcie_interface *pi;
+
+	/* Only chips with PCIE have a possibility of nodes other than 0. */
+	if (!octeon_has_feature(OCTEON_FEATURE_PCIE))
+		return 0;
+
+	while (bus->parent) {
+		struct pci_dev *dev = to_pci_dev(bus->bridge);
+		bus = dev->bus;
+	}
+	pi = octeon_pcie_bus2interface(bus);
+	return pi->node;
+#else
+	return 0;
+#endif
+}
+EXPORT_SYMBOL(pcibus_to_node);
 
 /**
  * Map a PCI device to the appropriate interrupt line
-- 
1.9.1

