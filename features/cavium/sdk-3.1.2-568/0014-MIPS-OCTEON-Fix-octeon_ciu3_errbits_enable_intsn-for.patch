From d961078ae9dc90c34fefdcb40822d6152e586e88 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Tue, 4 Nov 2014 14:25:18 -0800
Subject: [PATCH 014/184] MIPS: OCTEON: Fix octeon_ciu3_errbits_enable_intsn()
 for multi-node.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 2e0159320e2597701de0cf0be5c1ca81ba1d98b2
Description:

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/octeon-irq.c | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-irq.c b/arch/mips/cavium-octeon/octeon-irq.c
index f5c42fa..bf6bb89 100644
--- a/arch/mips/cavium-octeon/octeon-irq.c
+++ b/arch/mips/cavium-octeon/octeon-irq.c
@@ -2698,13 +2698,23 @@ int octeon_ciu3_errbits_enable_intsn(int node, int intsn)
 	if (!cfg->irq) {
 		int irq;
 		struct octeon_ciu_chip_data *cd;
-		int core = octeon_irq_get_local_core_num();
+		const struct cpumask *node_cpus;
+		int cpu_for_idt;
+		int core;
+#ifdef CONFIG_NUMA
+		node_cpus = cpu_online_mask;
+#else
+		node_cpus = cpumask_of_node(node);
+#endif
+		cpu_for_idt = cpumask_first(node_cpus);
+		WARN_ON(cpu_for_idt >= nr_cpu_ids);
+		core = octeon_coreid_for_cpu(cpu_for_idt) & 0x3f;
 
 		irq = irq_alloc_descs(-1, 1, 1, node);
 		if (irq < 0)
 			return irq;
 		cfg->irq = irq;
-		cfg->idt = core * 4 + 3; /* FIXME for Multi-node.*/
+		cfg->idt = core * 4 + 3;
 		cfg->node = node;
 		cfg->ciu3_addr = ciu3_addr;
 
-- 
1.9.1

