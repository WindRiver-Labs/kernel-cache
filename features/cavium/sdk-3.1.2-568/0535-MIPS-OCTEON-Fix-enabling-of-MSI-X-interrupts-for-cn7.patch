From bc3fd25ef33e4df445e567ab23d8734bd2fd9a31 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 12 Feb 2014 13:46:59 -0800
Subject: [PATCH 535/974] MIPS: OCTEON: Fix enabling of MSI-X interrupts for
 cn78XX.

Need to call unmask_msi_irq()/mask_msi_irq() as appropiate.

Also revert incorrect:

  commit 85bd44cd989c26bb172d5ef615fc8e7fec8024e2
  Author: Chandrakala Chavva <cchavva@caviumnetworks.com>
  Date:   Sun May 11 06:32:32 2014 -0700

    MIPS:OCTEON:MSI: Fix intsn for MSI interrupts

    Each SLI_MSI_RCVx are 64 bits apart.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/pci/msi-octeon.c | 20 ++++++++++++++++----
 1 file changed, 16 insertions(+), 4 deletions(-)

diff --git a/arch/mips/pci/msi-octeon.c b/arch/mips/pci/msi-octeon.c
index 06631e6..7249bb8 100644
--- a/arch/mips/pci/msi-octeon.c
+++ b/arch/mips/pci/msi-octeon.c
@@ -306,7 +306,7 @@ int arch_setup_msi_irq(struct pci_dev *dev, struct msi_desc *desc)
 		domain = octeon_irq_get_block_domain(node, MSI_BLOCK_NUMBER);
 
 		/* Get a irq for the msi intsn (hardware interrupt) */
-		hwirq = MSI_BLOCK_NUMBER << 12 | (msi * 64);
+		hwirq = MSI_BLOCK_NUMBER << 12 | msi;
 		irq = irq_create_mapping(domain, hwirq);
 		irqd_set_trigger_type(irq_get_irq_data(irq),
 				      IRQ_TYPE_EDGE_RISING);
@@ -448,10 +448,22 @@ static void octeon_irq_msi_ciu3_mask_ack(struct irq_data *data)
 	cvmx_write_csr(csr_addr, 1 << (msi & 0x3f));
 }
 
+static void octeon_irq_msi_ciu3_enable(struct irq_data *data)
+{
+	octeon_irq_ciu3_enable(data);
+	unmask_msi_irq(data);
+}
+
+static void octeon_irq_msi_ciu3_disable(struct irq_data *data)
+{
+	octeon_irq_ciu3_disable(data);
+	mask_msi_irq(data);
+}
+
 static struct irq_chip octeon_irq_msi_chip_ciu3 = {
-	.name = "CIU3",
-	.irq_enable = octeon_irq_ciu3_enable,
-	.irq_disable = octeon_irq_ciu3_disable,
+	.name = "MSI-X",
+	.irq_enable = octeon_irq_msi_ciu3_enable,
+	.irq_disable = octeon_irq_msi_ciu3_disable,
 	.irq_ack = octeon_irq_msi_ciu3_ack,
 	.irq_mask = octeon_irq_ciu3_mask,
 	.irq_mask_ack = octeon_irq_msi_ciu3_mask_ack,
-- 
2.6.2

