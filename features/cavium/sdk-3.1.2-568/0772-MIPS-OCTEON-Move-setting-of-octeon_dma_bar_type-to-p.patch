From 3c7bf34a446af2e29e8fedfb13db6718088ffa07 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Sat, 19 Jul 2014 18:05:50 -0700
Subject: [PATCH 772/974] MIPS: OCTEON: Move setting of octeon_dma_bar_type to
 prom_init().

Follow-on patches require octeon_dma_bar_type to be set much earlier,
so move it to prom_init().

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/setup.c | 16 ++++++++++++++++
 arch/mips/pci/pci-octeon.c      |  7 -------
 arch/mips/pci/pcie-octeon.c     |  3 ---
 3 files changed, 16 insertions(+), 10 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index 721786b..71384b6 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -835,6 +835,22 @@ append_arg:
 #ifdef CONFIG_CAVIUM_GDB
 	cvmx_debug_init();
 #endif
+
+#ifdef CONFIG_PCI
+	if (octeon_has_feature(OCTEON_FEATURE_PCIE)) {
+		if (octeon_has_feature(OCTEON_FEATURE_NPEI))
+			octeon_dma_bar_type = OCTEON_DMA_BAR_TYPE_PCIE;
+		else
+			octeon_dma_bar_type = OCTEON_DMA_BAR_TYPE_PCIE2;
+	} else {
+		if (OCTEON_IS_MODEL(OCTEON_CN31XX) ||
+		    OCTEON_IS_MODEL(OCTEON_CN38XX_PASS2))
+			octeon_dma_bar_type = OCTEON_DMA_BAR_TYPE_SMALL;
+		else
+			octeon_dma_bar_type = OCTEON_DMA_BAR_TYPE_BIG;
+	}
+#endif
+
 	pr_info("Cavium Inc. SDK-" SDK_VERSION "\n");
 }
 
diff --git a/arch/mips/pci/pci-octeon.c b/arch/mips/pci/pci-octeon.c
index 3f30fd8..abe3a1d 100644
--- a/arch/mips/pci/pci-octeon.c
+++ b/arch/mips/pci/pci-octeon.c
@@ -586,13 +586,6 @@ static int __init octeon_pci_setup(void)
 	/* Point pcibios_map_irq() to the PCI version of it */
 	octeon_pcibios_map_irq = octeon_pci_pcibios_map_irq;
 
-	/* Only use the big bars on chips that support it */
-	if (OCTEON_IS_MODEL(OCTEON_CN31XX) ||
-	    OCTEON_IS_MODEL(OCTEON_CN38XX_PASS2))
-		octeon_dma_bar_type = OCTEON_DMA_BAR_TYPE_SMALL;
-	else
-		octeon_dma_bar_type = OCTEON_DMA_BAR_TYPE_BIG;
-
 	/* PCI I/O and PCI MEM values */
 	set_io_port_base(OCTEON_PCI_IOSPACE_BASE);
 	ioport_resource.start = 0;
diff --git a/arch/mips/pci/pcie-octeon.c b/arch/mips/pci/pcie-octeon.c
index 8784a14..cf483c3 100644
--- a/arch/mips/pci/pcie-octeon.c
+++ b/arch/mips/pci/pcie-octeon.c
@@ -609,7 +609,6 @@ static int __init octeon_pcie_setup(void)
 				npei_ctl_status.u64 =
 					cvmx_read_csr(CVMX_PEXP_NPEI_CTL_STATUS);
 				host_mode = npei_ctl_status.s.host_mode;
-				octeon_dma_bar_type = OCTEON_DMA_BAR_TYPE_PCIE;
 			}
 		} else {
 			union cvmx_mio_rst_ctlx mio_rst_ctl;
@@ -618,8 +617,6 @@ static int __init octeon_pcie_setup(void)
 			else
 				mio_rst_ctl.u64 = cvmx_read_csr(CVMX_MIO_RST_CTLX(port));
 			host_mode = mio_rst_ctl.s.host_mode;
-			if (port == 0)
-				octeon_dma_bar_type = OCTEON_DMA_BAR_TYPE_PCIE2;
 		}
 
 		if (host_mode) {
-- 
2.6.2

