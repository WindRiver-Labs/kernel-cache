From 97982d33c2e30b441c80e6c4bddf7959388fcb0f Mon Sep 17 00:00:00 2001
From: Carlos Munoz <cmunoz@caviumnetworks.com>
Date: Sun, 27 Jul 2014 18:05:50 -0700
Subject: [PATCH 878/974] netdev: octeon-bgx-nexus: Unreset the mix interface
 in the bgx.

Signed-off-by: Carlos Munoz <cmunoz@caviumnetworks.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/octeon/octeon-bgx-nexus.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/drivers/net/ethernet/octeon/octeon-bgx-nexus.c b/drivers/net/ethernet/octeon/octeon-bgx-nexus.c
index dcedb61..f51015a 100644
--- a/drivers/net/ethernet/octeon/octeon-bgx-nexus.c
+++ b/drivers/net/ethernet/octeon/octeon-bgx-nexus.c
@@ -166,6 +166,7 @@ static int bgx_probe(struct platform_device *pdev)
 		bool is_mix = false;
 		bool is_pki = false;
 		union cvmx_bgxx_cmrx_config cmr_config;
+		cvmx_bgxx_cmr_global_config_t global_config;
 		struct pdev_list_item *pdev_item;
 
 		if (!of_device_is_compatible(child, "cavium,octeon-7890-bgx-port"))
@@ -186,6 +187,21 @@ static int bgx_probe(struct platform_device *pdev)
 		cmr_config.s.mix_en = is_mix ? 1 : 0;
 		cvmx_write_csr_node(numa_node, CVMX_BGXX_CMRX_CONFIG(port, interface), cmr_config.u64);
 
+		/* Unreset the mix bgx interface or it will interfare with the
+		 * other ports.
+		 */
+		if (is_mix) {
+			global_config.u64 = cvmx_read_csr_node(numa_node,
+					CVMX_BGXX_CMR_GLOBAL_CONFIG(interface));
+			if (!port)
+				global_config.s.cmr_mix0_reset = 0;
+			else if (port == 1)
+				global_config.s.cmr_mix1_reset = 0;
+			cvmx_write_csr_node(numa_node,
+				    CVMX_BGXX_CMR_GLOBAL_CONFIG(interface),
+					    global_config.u64);
+		}
+
 		snprintf(id, sizeof(id), "%llx.%u.ethernet-mac", (unsigned long long)addr, port);
 		new_dev = of_platform_device_create(child, id, &pdev->dev);
 		if (!new_dev) {
-- 
2.6.2

