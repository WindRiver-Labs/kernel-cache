From 4fbd0ece8e6316a75cc321a0dbe5b7684743222d Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 19 Nov 2014 09:18:48 -0800
Subject: [PATCH 024/184] MIPS: OCTEON: Initialize MSI as part of
 arch_init_irq().

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 78ce96ffd7b345d7a22f60ff9988f0c57aad5e29
Description:

MSI needs large ranges of contiguous irq values.  Move initialization
very early so that the irq space is not as fragmented.  The result is
a smaller overall range of active irq numbers.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/octeon-irq.c | 5 +++++
 arch/mips/pci/msi-octeon.c           | 2 --
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-irq.c b/arch/mips/cavium-octeon/octeon-irq.c
index bf6bb89..d94535b 100644
--- a/arch/mips/cavium-octeon/octeon-irq.c
+++ b/arch/mips/cavium-octeon/octeon-irq.c
@@ -3190,6 +3190,8 @@ static struct of_device_id __initdata ciu_types[] = {
 	{}
 };
 
+int octeon_msi_initialize(void);
+
 void __init arch_init_irq(void)
 {
 #ifdef CONFIG_SMP
@@ -3200,6 +3202,9 @@ void __init arch_init_irq(void)
 	}
 #endif
 	of_irq_init(ciu_types);
+#ifdef CONFIG_PCI_MSI
+	octeon_msi_initialize();
+#endif
 }
 
 asmlinkage void plat_irq_dispatch(void)
diff --git a/arch/mips/pci/msi-octeon.c b/arch/mips/pci/msi-octeon.c
index bb92ec2..b13d962 100644
--- a/arch/mips/pci/msi-octeon.c
+++ b/arch/mips/pci/msi-octeon.c
@@ -780,5 +780,3 @@ int __init octeon_msi_initialize(void)
 	}
 	return 0;
 }
-subsys_initcall(octeon_msi_initialize);
-
-- 
1.9.1

