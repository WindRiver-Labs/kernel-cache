From 9d10835ae2ddde795daaf13b8f3f0a7e9da8c448 Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Fri, 18 Mar 2016 17:01:09 +0800
Subject: [PATCH] MIPS: OCTEON: fix incorrect qlm value when CN63XX/CN66XX
 pcie initialization

When Octeon CPUs intialise the PCI controller, it will check if the
qlm port support PCI. CN63XX/CN66XX pass the incorrect qlm value (-1)
to the routine "cvmx_qlm_get_mode" and get wrong mode, this result
PCI initialization fails. So pass the correct qlm value according to
pcie_port number.

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/executive/cvmx-pcie.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/arch/mips/cavium-octeon/executive/cvmx-pcie.c b/arch/mips/cavium-octeon/executive/cvmx-pcie.c
index cc1b219..b5db04f 100644
--- a/arch/mips/cavium-octeon/executive/cvmx-pcie.c
+++ b/arch/mips/cavium-octeon/executive/cvmx-pcie.c
@@ -1434,6 +1434,10 @@ static int __cvmx_pcie_rc_initialize_gen2(int pcie_port)
 		 */
 		else if (OCTEON_IS_MODEL(OCTEON_CNF71XX))
 			qlm = 1;
+		else if (OCTEON_IS_MODEL(OCTEON_CN63XX))
+			qlm = pcie_port;
+		else if (OCTEON_IS_MODEL(OCTEON_CN66XX))
+			qlm = pcie_port;
 
 		if (OCTEON_IS_MODEL(OCTEON_CN78XX))
 			mode = cvmx_qlm_get_mode_cn78xx(node, qlm);
-- 
1.7.5.4

