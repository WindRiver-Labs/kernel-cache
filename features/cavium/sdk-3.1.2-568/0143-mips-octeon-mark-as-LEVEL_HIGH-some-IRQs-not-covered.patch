From 36038f3cd339fb83aed129e586a59cd5a41b3fcd Mon Sep 17 00:00:00 2001
From: Peter Swain <pswain@cavium.com>
Date: Sat, 29 Aug 2015 20:03:02 -0700
Subject: [PATCH 143/184] mips: octeon: mark as LEVEL_HIGH some IRQs not
 covered by devtree

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: acd5b752ffe67d1c79f5cea444ad1e25a21db5aa
Description:

Most Octeon IRQs are either specified in device tree,
or covered by the EDGE_RISING default.
Two genuine level-triggered signals need protection from the
upcoming clarification of edge/level handling in octeon-irq.c:
- internal rapidio signals for srio-ethernet
- early uart1 setup for gdb, which happens before device-tree parse

Signed-off-by: Peter Swain <pswain@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/octeon-rapidio.c | 1 +
 arch/mips/cavium-octeon/serial.c         | 2 ++
 2 files changed, 3 insertions(+)

diff --git a/arch/mips/cavium-octeon/octeon-rapidio.c b/arch/mips/cavium-octeon/octeon-rapidio.c
index 82ad2a6..f1b5785 100644
--- a/arch/mips/cavium-octeon/octeon-rapidio.c
+++ b/arch/mips/cavium-octeon/octeon-rapidio.c
@@ -1018,6 +1018,7 @@ static void octeon_srio_interrupt_75xx_cfg(int srio_port)
 		ints[i].mport_id = srio_port;
 		domain = octeon_irq_get_block_domain(0, SRIO_INTSN_E);
 		ints[i].irq = irq_create_mapping(domain, ints[i].intsn);
+		irq_set_irq_type(ints[i].irq, IRQ_TYPE_LEVEL_HIGH);
 	}
 }
 
diff --git a/arch/mips/cavium-octeon/serial.c b/arch/mips/cavium-octeon/serial.c
index f338c7d..a384361 100644
--- a/arch/mips/cavium-octeon/serial.c
+++ b/arch/mips/cavium-octeon/serial.c
@@ -58,10 +58,12 @@ static int octeon_setup_debug_uart(void)
 	else
 		hwirq = 34 + OCTEON_DEBUG_UART;
 
+	/* explicit irq, don't rely on device-tree */
 	irq = irq_create_mapping(NULL, hwirq);
 	if (!irq)
 		return -EINVAL;
 
+	irq_set_irq_type(irq, IRQ_TYPE_LEVEL_HIGH);
 
 	if (request_irq(irq, interrupt_debug_char,
 			0, "cvmx-debug", interrupt_debug_char)) {
-- 
1.9.1

