From 6b6dbfbf386739672dfc7f305de1b3275c4523ab Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 25 Feb 2015 16:47:46 -0800
Subject: [PATCH 081/184] gpio: gpio-octeon: Add gpio_to_irq() support.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 296ef799cc73fcd021c5e532a8c8b1b6c45dc7f5
Description:

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>

I had to update the irq_create_of_mapping() call due to change:
 of/irq: Create of_irq_parse_and_map_pci() to consolidate arch code.
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/gpio/gpio-octeon.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/drivers/gpio/gpio-octeon.c b/drivers/gpio/gpio-octeon.c
index c0239fe..10ddef8 100644
--- a/drivers/gpio/gpio-octeon.c
+++ b/drivers/gpio/gpio-octeon.c
@@ -9,6 +9,7 @@
 #include <linux/of_device.h>
 #include <linux/module.h>
 #include <linux/of_gpio.h>
+#include <linux/of_irq.h>
 #include <linux/io.h>
 
 #include <asm/octeon/octeon.h>
@@ -84,6 +85,20 @@ static int octeon_gpio_get(struct gpio_chip *chip, unsigned offset)
 	return ((1ull << offset) & read_bits) != 0;
 }
 
+static int octeon_gpio_to_irq(struct gpio_chip *chip, unsigned offset)
+{
+	struct of_phandle_args dev_irq;
+
+	if (offset >= 16)
+		return -ENXIO;
+
+	dev_irq.np = chip->of_node;
+	dev_irq.args[0] = offset;
+	dev_irq.args[1] = 8; /* level, active low */
+	dev_irq.args_count = 2;
+	return irq_create_of_mapping(&dev_irq);
+}
+
 static struct of_device_id octeon_gpio_match[] = {
 	{
 		.compatible = "cavium,octeon-3860-gpio",
@@ -149,6 +164,7 @@ static int octeon_gpio_probe(struct platform_device *pdev)
 	chip->set = octeon_gpio_set;
 	chip->of_gpio_n_cells = 2;
 	chip->of_xlate = of_gpio_simple_xlate;
+	chip->to_irq = octeon_gpio_to_irq;
 	err = gpiochip_add(chip);
 	if (err)
 		goto out;
-- 
1.9.1

