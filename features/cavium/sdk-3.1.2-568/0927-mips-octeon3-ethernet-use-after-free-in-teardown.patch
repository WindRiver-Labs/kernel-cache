From 3052e036f3470a5ab433be53b40daa4d9c4f6326 Mon Sep 17 00:00:00 2001
From: Peter Swain <pswain@cavium.com>
Date: Mon, 21 Jul 2014 18:05:50 -0700
Subject: [PATCH 927/974] mips: octeon3-ethernet: use-after-free in teardown

Delay free(netdev) until priv unused,
as priv is _part_ of netdev.

Don't teardown hardware until napi is stopped.

Signed-off-by: Peter Swain <pswain@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index c3eabe1..428bc04 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -2571,7 +2571,6 @@ static int octeon3_eth_remove(struct platform_device *pdev)
 	unregister_netdev(netdev);
 	bgx_port_set_netdev(pdev->dev.parent, NULL);
 	dev_set_drvdata(&pdev->dev, NULL);
-	free_netdev(netdev);
 
 	/* Free all resources when there are no more devices */
 	mutex_lock(&octeon3_eth_init_mutex);
@@ -2580,8 +2579,6 @@ static int octeon3_eth_remove(struct platform_device *pdev)
 	if (oen->init_done && list_empty(&oen->device_list)) {
 		int	i;
 
-		octeon3_eth_global_exit(node);
-
 		for (i = 0; i < MAX_NAPIS_PER_NODE; i++) {
 			napi_disable(&napi_wrapper[node][i].napi);
 			netif_napi_del(&napi_wrapper[node][i].napi);
@@ -2589,10 +2586,13 @@ static int octeon3_eth_remove(struct platform_device *pdev)
 
 		oen->init_done = false;
 		oen->napi_init_done = false;
+		octeon3_eth_global_exit(node);
+
 	}
 
 	mutex_unlock(&oen->device_list_lock);
 	mutex_unlock(&octeon3_eth_init_mutex);
+	free_netdev(netdev);
 
 	return 0;
 }
-- 
2.6.2

