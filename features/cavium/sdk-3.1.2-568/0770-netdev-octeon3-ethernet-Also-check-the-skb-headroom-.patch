From a8d70bff24dfe27179275b604755be1b92f6fc44 Mon Sep 17 00:00:00 2001
From: Carlos Munoz <cmunoz@caviumnetworks.com>
Date: Sat, 19 Jul 2014 18:05:50 -0700
Subject: [PATCH 770/974] netdev: octeon3-ethernet: Also check the skb headroom
 and skb size to determine if skb is recyclable.

Signed-off-by: Carlos Munoz <cmunoz@caviumnetworks.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 14 ++++++++------
 1 file changed, 8 insertions(+), 6 deletions(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index 532c2d3..d5d49ed 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -1688,12 +1688,14 @@ static int octeon3_eth_ndo_start_xmit(struct sk_buff *skb, struct net_device *ne
 			frag_count++;
 
 	/* Check if the skb can be recycled (freed back to the fpa) */
-	if (likely(recycle_skbs) &&
-	    likely(skb_shinfo(skb)->nr_frags == 0) &&
-	    likely(skb_shared(skb) == 0) &&
-	    likely(skb_cloned(skb) == 0) &&
-	    likely(frag_count == 0) &&
-	    likely(skb->fclone == SKB_FCLONE_UNAVAILABLE)) {
+	if (recycle_skbs &&
+	    skb_shinfo(skb)->nr_frags == 0 &&
+	    skb_shared(skb) == 0 &&
+	    skb_cloned(skb) == 0 &&
+	    frag_count == 0 &&
+	    skb_headroom(skb) >= 128 &&
+	    skb_end_offset(skb) >= packet_buffer_size &&
+	    skb->fclone == SKB_FCLONE_UNAVAILABLE) {
 		uint64_t	magic;
 
 		buf = (void **)PTR_ALIGN(skb->head, 128);
-- 
2.6.2

