From 760bb670b80d0f820968a608d1a859f4790188fe Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 9 Aug 2013 11:10:09 -0700
Subject: [PATCH 258/974] MIPS: OCTEON: Move L2 Cache probing code to setup.c

When we run as a virtualized guest kernel, the CPU is disassociated
from the OCTEON SoC's L2 cache, so we move the corresponding code to a
SoC specific place.  This allows us to share c-octeon.c between both
Normal and VM cases.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/setup.c       | 22 ++++++++++++++++++++++
 arch/mips/include/asm/octeon/octeon.h |  1 +
 arch/mips/mm/c-octeon.c               | 18 +++---------------
 3 files changed, 26 insertions(+), 15 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index 8e986ec..f9ae64b 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -544,6 +544,26 @@ void octeon_user_io_init(void)
 	write_c0_derraddr1(0);
 }
 
+static void octeon_soc_scache_init(void)
+{
+	struct cpuinfo_mips *c = &current_cpu_data;
+	unsigned long scache_size = cvmx_l2c_get_cache_size_bytes();
+
+	c->scache.sets = cvmx_l2c_get_num_sets();
+	c->scache.ways = cvmx_l2c_get_num_assoc();
+	c->scache.waybit = ffs(scache_size / c->scache.ways) - 1;
+	c->scache.waysize = scache_size / c->scache.ways;
+	c->scache.linesz = 128;
+	c->scache.flags |= MIPS_CPU_PREFETCH;
+
+	c->tcache.flags |= MIPS_CACHE_NOT_PRESENT;
+
+	if (smp_processor_id() == 0)
+		pr_notice("Secondary unified cache %ldkB, %d-way, %d sets, linesize %d bytes.\n",
+			  scache_size >> 10, c->scache.ways,
+			  c->scache.sets, c->scache.linesz);
+}
+
 /**
  * Early entry point for arch setup
  */
@@ -556,6 +576,8 @@ void __init prom_init(void)
 	int i;
 	u64 t;
 	int argc;
+
+	octeon_scache_init = octeon_soc_scache_init;
 	/*
 	 * The bootloader passes a pointer to the boot descriptor in
 	 * $a3, this is available as fw_arg3.
diff --git a/arch/mips/include/asm/octeon/octeon.h b/arch/mips/include/asm/octeon/octeon.h
index 5690b69..ab9cd40 100644
--- a/arch/mips/include/asm/octeon/octeon.h
+++ b/arch/mips/include/asm/octeon/octeon.h
@@ -420,6 +420,7 @@ int octeon_i2c_cvmx2i2c(unsigned int cvmx_twsi_bus_num);
 
 extern struct semaphore octeon_bootbus_sem;
 
+extern void (*octeon_scache_init)(void);
 int register_co_cache_error_notifier(struct notifier_block *nb);
 int unregister_co_cache_error_notifier(struct notifier_block *nb);
 #define CO_CACHE_ERROR_RECOVERABLE 0
diff --git a/arch/mips/mm/c-octeon.c b/arch/mips/mm/c-octeon.c
index a71b0bb..abad4da 100644
--- a/arch/mips/mm/c-octeon.c
+++ b/arch/mips/mm/c-octeon.c
@@ -312,6 +312,7 @@ static int octeon3_mcheck_handler(struct pt_regs *regs)
 	return MIPS_MC_NOT_HANDLED;
 }
 
+void (*octeon_scache_init)(void);
 /**
  * Probe Octeon's caches
  *
@@ -320,7 +321,6 @@ static void __cpuinit probe_octeon(void)
 {
 	unsigned long icache_size;
 	unsigned long dcache_size;
-	unsigned long scache_size;
 	unsigned int config1;
 	struct cpuinfo_mips *c = &current_cpu_data;
 
@@ -393,17 +393,6 @@ static void __cpuinit probe_octeon(void)
 	c->icache.sets = icache_size / (c->icache.linesz * c->icache.ways);
 	c->dcache.sets = dcache_size / (c->dcache.linesz * c->dcache.ways);
 
-	scache_size = cvmx_l2c_get_cache_size_bytes();
-
-	c->scache.sets = cvmx_l2c_get_num_sets();
-	c->scache.ways = cvmx_l2c_get_num_assoc();
-	c->scache.waybit = ffs(scache_size / c->scache.ways) - 1;
-	c->scache.waysize = scache_size / c->scache.ways;
-	c->scache.linesz = 128;
-	c->scache.flags |= MIPS_CPU_PREFETCH;
-
-	c->tcache.flags |= MIPS_CACHE_NOT_PRESENT;
-
 	if (smp_processor_id() == 0) {
 		pr_notice("Primary instruction cache %ldkB, %s, %d way, "
 			  "%d sets, linesize %d bytes.\n",
@@ -416,10 +405,9 @@ static void __cpuinit probe_octeon(void)
 			  "linesize %d bytes.\n",
 			  dcache_size >> 10, c->dcache.ways,
 			  c->dcache.sets, c->dcache.linesz);
-		pr_notice("Secondary unified cache %ldkB, %d-way, %d sets, linesize %d bytes.\n",
-			  scache_size >> 10, c->scache.ways,
-			  c->scache.sets, c->scache.linesz);
 	}
+	if (octeon_scache_init)
+		octeon_scache_init();
 }
 
 static void  __cpuinit octeon_cache_error_setup(void)
-- 
2.6.2

