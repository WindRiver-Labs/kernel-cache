From d8ac900725a1ae6fb90e710629774d1002c85116 Mon Sep 17 00:00:00 2001
From: Peter Swain <peter.swain@cavium.com>
Date: Wed, 4 Dec 2013 12:28:26 -0800
Subject: [PATCH 428/974] MIPS: octeon-power-throttle: keep maxthr at 0xff

Commit 8606f7 dropped maxthr when booting with low power,
but this causes problemx on cn71xx.
Revert that gratuitous change & explore further.

bug#8921
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/octeon-power-throttle.c | 11 +++++------
 1 file changed, 5 insertions(+), 6 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-power-throttle.c b/arch/mips/cavium-octeon/octeon-power-throttle.c
index d5764ec..6bd201c 100644
--- a/arch/mips/cavium-octeon/octeon-power-throttle.c
+++ b/arch/mips/cavium-octeon/octeon-power-throttle.c
@@ -114,16 +114,15 @@ static void octeon_power_throttle_init_cpu(int cpu)
 	if (throttle_op(cpu, &r, false))
 		return;
 
+	if (cpu == 0)
+		pr_debug("old power_throttle %llx\n",
+			r.raw);
+
 	r.s.ovrrd = 0;		/* MBZ */
 	r.s.distag = 0;		/* MBZ */
 	r.s.period = 2;		/* 256 cycles */
 	r.s.minthr = 0;
-
-	/*
-	 * allow instantaneous power to peak above HRM default
-	 * of (maxpow - adj), even if powlim holds average to that.
-	 */
-	r.s.maxthr = r.s.maxpow;
+	r.s.maxthr = 0xff;
 
 	/* limit average power to boot_powlim% of max power */
 	if (boot_powlim >= 0)
-- 
2.6.2

