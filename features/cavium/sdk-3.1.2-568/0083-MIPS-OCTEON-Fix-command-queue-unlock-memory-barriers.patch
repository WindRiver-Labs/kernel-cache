From 3480834d4601617e7b5d35ed684bec7126159b73 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 31 Oct 2012 16:19:50 -0700
Subject: [PATCH 083/974] MIPS: OCTEON: Fix command queue unlock memory
 barriers.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/include/asm/octeon/cvmx-cmd-queue.h | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/arch/mips/include/asm/octeon/cvmx-cmd-queue.h b/arch/mips/include/asm/octeon/cvmx-cmd-queue.h
index 024a71b..0fd844c 100644
--- a/arch/mips/include/asm/octeon/cvmx-cmd-queue.h
+++ b/arch/mips/include/asm/octeon/cvmx-cmd-queue.h
@@ -286,8 +286,12 @@ static inline void __cvmx_cmd_queue_lock(cvmx_cmd_queue_id_t queue_id,
  */
 static inline void __cvmx_cmd_queue_unlock(__cvmx_cmd_queue_state_t *qptr)
 {
-	qptr->now_serving++;
-	CVMX_SYNCWS;
+	uint8_t ns;
+
+	ns = qptr->now_serving + 1;
+	CVMX_SYNCWS;		/* Order queue manipulation with respect to the unlock.  */
+	qptr->now_serving = ns;
+	CVMX_SYNCWS;		/* nudge out the unlock. */
 }
 
 /**
-- 
2.6.2

