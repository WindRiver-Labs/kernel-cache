From 18ab05d086767476c076590278092afae0e69943 Mon Sep 17 00:00:00 2001
From: Peter Swain <pswain@cavium.com>
Date: Fri, 21 Aug 2015 14:38:45 -0700
Subject: [PATCH 139/184] mips: octeon3-ethernet: use-after-free in teardown

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 63f120e34f415ad90899331ab9d97d3f7b5c1e1e
Description:

Delay free(netdev) until priv unused,
as priv is _part_ of netdev.

Don't teardown hardware until napi is stopped.

Signed-off-by: Peter Swain <pswain@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index 3ac3701..a891392 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -2584,7 +2584,6 @@ static int octeon3_eth_remove(struct platform_device *pdev)
 	unregister_netdev(netdev);
 	bgx_port_set_netdev(pdev->dev.parent, NULL);
 	dev_set_drvdata(&pdev->dev, NULL);
-	free_netdev(netdev);
 
 	/* Free all resources when there are no more devices */
 	mutex_lock(&octeon3_eth_init_mutex);
@@ -2593,8 +2592,6 @@ static int octeon3_eth_remove(struct platform_device *pdev)
 	if (oen->init_done && list_empty(&oen->device_list)) {
 		int	i;
 
-		octeon3_eth_global_exit(node);
-
 		for (i = 0; i < MAX_NAPIS_PER_NODE; i++) {
 			napi_disable(&napi_wrapper[node][i].napi);
 			netif_napi_del(&napi_wrapper[node][i].napi);
@@ -2602,10 +2599,13 @@ static int octeon3_eth_remove(struct platform_device *pdev)
 
 		oen->init_done = false;
 		oen->napi_init_done = false;
+		octeon3_eth_global_exit(node);
+
 	}
 
 	mutex_unlock(&oen->device_list_lock);
 	mutex_unlock(&octeon3_eth_init_mutex);
+	free_netdev(netdev);
 
 	return 0;
 }
-- 
1.9.1

