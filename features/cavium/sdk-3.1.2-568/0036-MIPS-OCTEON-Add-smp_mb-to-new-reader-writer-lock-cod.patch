From a010e1a68ec12b7c98d70e16af7a034a9e8eb3ac Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 12 Dec 2014 10:55:57 -0800
Subject: [PATCH 036/184] MIPS: OCTEON: Add smp_mb() to new reader/writer lock
 code arch_read_unlock().

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 9e57755b08bcd6aaa19024a4f682692e91cb4a0a
Description:

Empirical evidence suggests that this is needed.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/spinlock.h | 1 +
 1 file changed, 1 insertion(+)

diff --git a/arch/mips/include/asm/spinlock.h b/arch/mips/include/asm/spinlock.h
index 415f7e5..d0f8fab 100644
--- a/arch/mips/include/asm/spinlock.h
+++ b/arch/mips/include/asm/spinlock.h
@@ -263,6 +263,7 @@ static inline void arch_read_unlock(arch_rwlock_t *rw)
 {
 	int dec = -1;
 
+	smp_mb();
 	__asm__ __volatile__(
 		"saa	%[dec], (%[rw])			\n"
 		"	pref	26, 0(%[rw]) #nudge	\n"
-- 
1.9.1

