From 3ccb9ff4e7d359ef84fe6f2a987ed0dce5768ab7 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 25 Jul 2014 18:05:50 -0700
Subject: [PATCH 850/974] MIPS: OCTEON: Add gpio_to_irq() test to
 octeon-error-injector.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/octeon-error-injector.c | 34 +++++++++++++++++++++++++
 1 file changed, 34 insertions(+)

diff --git a/arch/mips/cavium-octeon/octeon-error-injector.c b/arch/mips/cavium-octeon/octeon-error-injector.c
index 0ce0063..43f2791 100644
--- a/arch/mips/cavium-octeon/octeon-error-injector.c
+++ b/arch/mips/cavium-octeon/octeon-error-injector.c
@@ -11,6 +11,8 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/slab.h>
+#include <linux/gpio.h>
+#include <linux/interrupt.h>
 
 #include <asm/octeon/octeon.h>
 #include <asm/octeon/cvmx-fpa.h>
@@ -110,6 +112,32 @@ static void octeon_error_injector_fpa1(void)
 	cvmx_write_csr(CVMX_FPA_POOLX_THRESHOLD(7), old_threshold);
 }
 
+static irqreturn_t octeon_error_injector_gpio_handler(int irq, void *arg)
+{
+	disable_irq_nosync(irq);
+	return IRQ_HANDLED;
+}
+
+static int octeon_error_injector_irq;
+
+static void octeon_error_injector_gpio_irq(void)
+{
+	int rv;
+	int irq = gpio_to_irq(test_param);
+
+	pr_err("gpio_to_irq(%d) -> %d\n", test_param, irq);
+
+	if (irq) {
+		rv = request_irq(irq, octeon_error_injector_gpio_handler, 0,
+				 "octeon_error_injector",
+				 octeon_error_injector_gpio_handler);
+		if (rv)
+			pr_err("request_irq failed: %d\n", rv);
+		else
+			octeon_error_injector_irq = irq;
+	}
+}
+
 static int __init octeon_error_injector_init(void)
 {
 	/* We are injecting errors, so mark the kernel as tainted.*/
@@ -131,6 +159,9 @@ static int __init octeon_error_injector_init(void)
 	case 5:
 		octeon_error_injector_l1_icache_parity();
 		break;
+	case 6:
+		octeon_error_injector_gpio_irq();
+		break;
 	default:
 		pr_err("Error: Unrecognized test number: %d\n",  test_number);
 		break;
@@ -142,6 +173,9 @@ module_init(octeon_error_injector_init);
 
 static void __exit octeon_error_injector_exit(void)
 {
+	if (octeon_error_injector_irq)
+		free_irq(octeon_error_injector_irq,
+			 octeon_error_injector_gpio_handler);
 }
 module_exit(octeon_error_injector_exit);
 
-- 
2.6.2

