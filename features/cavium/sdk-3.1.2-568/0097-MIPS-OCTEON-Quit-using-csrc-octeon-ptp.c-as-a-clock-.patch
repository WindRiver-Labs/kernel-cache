From 12d513d94ed3c54a67ebc622780fc019e743d9c5 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Tue, 20 Nov 2012 13:52:56 -0800
Subject: [PATCH 097/974] MIPS: OCTEON: Quit using csrc-octeon-ptp.c as a clock
 source.

It is not always connected to a clock.  We need to keep the file to
initialize the PTP clock for any network driver users.  So we do the
initialization, but don't register the clocksource.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/csrc-octeon-ptp.c | 13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/csrc-octeon-ptp.c b/arch/mips/cavium-octeon/csrc-octeon-ptp.c
index 4af62fb..3c1534f 100644
--- a/arch/mips/cavium-octeon/csrc-octeon-ptp.c
+++ b/arch/mips/cavium-octeon/csrc-octeon-ptp.c
@@ -12,6 +12,13 @@
 #include <asm/octeon/octeon.h>
 #include <asm/octeon/cvmx-mio-defs.h>
 
+/*
+ * By default use only the cvmcount source and leave this one
+ * disabled/unregistered.
+ */
+#define REGISTER_OCTEON_PTP_CSRC 0
+
+#if REGISTER_OCTEON_PTP_CSRC
 static cycle_t octeon_ptp_clock_read(struct clocksource *cs)
 {
 	return octeon_read_ptp_csr(CVMX_MIO_PTP_CLOCK_HI);
@@ -19,10 +26,12 @@ static cycle_t octeon_ptp_clock_read(struct clocksource *cs)
 
 static struct clocksource clocksource_ptp_clock = {
 	.name		= "OCTEON_PTP_CLOCK",
+	.rating		= 400,
 	.read		= octeon_ptp_clock_read,
 	.mask		= CLOCKSOURCE_MASK(64),
 	.flags		= CLOCK_SOURCE_IS_CONTINUOUS,
 };
+#endif
 
 int __init ptp_clock_init(void)
 {
@@ -62,10 +71,10 @@ int __init ptp_clock_init(void)
 		ptp_clock_cfg.s.ptp_en = 1;
 		cvmx_write_csr(CVMX_MIO_PTP_CLOCK_CFG, ptp_clock_cfg.u64);
 	}
-
+#if REGISTER_OCTEON_PTP_CSRC
 	/* Add PTP as a high quality clocksource with nano second granularity */
-	clocksource_ptp_clock.rating = 400;
 	clocksource_register_hz(&clocksource_ptp_clock, NSEC_PER_SEC);
+#endif
 	return 0;
 }
 arch_initcall(ptp_clock_init);
-- 
2.6.2

