From 2e072249172a7d7ce09763c5241945b1eca95891 Mon Sep 17 00:00:00 2001
From: Vinita Gupta <vgupta@caviumnetworks.com>
Date: Mon, 2 Dec 2013 10:23:05 -0800
Subject: [PATCH 420/974] usb: octeon2-commom.c: Added host controller reset
 for kexec/kdump to work

Signed-off-by: Vinita Gupta <vgupta@caviumnetworks.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/usb/host/octeon2-common.c | 25 +++++++++++++++++++++++++
 1 file changed, 25 insertions(+)

diff --git a/drivers/usb/host/octeon2-common.c b/drivers/usb/host/octeon2-common.c
index 7b82919..25210e8 100644
--- a/drivers/usb/host/octeon2-common.c
+++ b/drivers/usb/host/octeon2-common.c
@@ -14,6 +14,7 @@
 
 #include <asm/octeon/octeon.h>
 #include <asm/octeon/cvmx-uctlx-defs.h>
+#include <asm/octeon/cvmx-uahcx-defs.h>
 
 static DEFINE_MUTEX(octeon2_usb_clocks_mutex);
 
@@ -253,3 +254,27 @@ void octeon2_usb_clocks_stop(void)
 	mutex_unlock(&octeon2_usb_clocks_mutex);
 }
 EXPORT_SYMBOL(octeon2_usb_clocks_stop);
+
+static int __init octeon2_usb_reset(void)
+{
+	union cvmx_uctlx_clk_rst_ctl clk_rst_ctl;
+	union cvmx_uahcx_ehci_usbcmd ehci_usbcmd;
+	union cvmx_uahcx_ohci0_hccommandstatus ohci_usbcmd;
+
+	clk_rst_ctl.u64 = cvmx_read_csr(CVMX_UCTLX_CLK_RST_CTL(0));
+	if (clk_rst_ctl.s.hrst) {
+		ehci_usbcmd.u32 = cvmx_read64_uint32(CVMX_UAHCX_EHCI_USBCMD(0));
+		ehci_usbcmd.s.rs = 0;
+		cvmx_write64_uint32(CVMX_UAHCX_EHCI_USBCMD(0), ehci_usbcmd.u32);
+		mdelay(2);
+		ehci_usbcmd.s.hcreset = 1;
+		cvmx_write64_uint32(CVMX_UAHCX_EHCI_USBCMD(0), ehci_usbcmd.u32);
+		ohci_usbcmd.u32 = cvmx_read64_uint32(CVMX_UAHCX_OHCI0_HCCOMMANDSTATUS(0));
+		ohci_usbcmd.s.hcr = 1;
+		cvmx_write64_uint32(CVMX_UAHCX_OHCI0_HCCOMMANDSTATUS(0), ohci_usbcmd.u32);
+
+	}
+	return 0;
+}
+
+arch_initcall(octeon2_usb_reset);
-- 
2.6.2

