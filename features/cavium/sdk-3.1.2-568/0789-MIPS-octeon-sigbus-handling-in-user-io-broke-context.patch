From 61ac70eba731a42e47270f5c62ffcb3184327c83 Mon Sep 17 00:00:00 2001
From: Peter Swain <pswain@cavium.com>
Date: Fri, 4 Jul 2014 18:05:50 -0700
Subject: [PATCH 789/974] MIPS: octeon: sigbus handling in user-io broke
 context tracking

I accidentally built with both CONFIG_CONTEXT_TRACKING=y and
CONFIG_CAVIUM_OCTEON_USER_IO_PER_PROCESS=y, and gcc pointed out a
use-before-set case.
This resolves that issue, but this code could do with a cleanup
looks like perf counters are not being inc'd in the USER_IO_PER_PROCESS
exception case

Signed-off-by: Peter Swain <pswain@caviumnetworks.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/kernel/unaligned.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/arch/mips/kernel/unaligned.c b/arch/mips/kernel/unaligned.c
index 5328dd3..bcb5eb6 100644
--- a/arch/mips/kernel/unaligned.c
+++ b/arch/mips/kernel/unaligned.c
@@ -1651,8 +1651,10 @@ asmlinkage void do_ade(struct pt_regs *regs)
 	    (regs->cp0_badvaddr >= CVMSEG_BASE && regs->cp0_badvaddr < CVMSEG_BASE + cvmseg_size)) {
 #if defined(CONFIG_CAVIUM_OCTEON_USER_IO_PER_PROCESS)
 		struct task_struct *group_leader = current->group_leader;
-		if (!test_tsk_thread_flag(group_leader, TIF_XKPHYS_IO_EN))
+		if (!test_tsk_thread_flag(group_leader, TIF_XKPHYS_IO_EN)) {
+			prev_state = exception_enter();
 			goto sigbus;
+		}
 #endif
 		preempt_disable();
 		cvmmemctl = __read_64bit_c0_register($11, 7);
-- 
2.6.2

