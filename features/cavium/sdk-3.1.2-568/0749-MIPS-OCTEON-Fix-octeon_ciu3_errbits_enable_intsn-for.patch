From 327365010da4de6a9d3fa15585e5b614f76a0b4c Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 4 Jul 2014 18:05:50 -0700
Subject: [PATCH 749/974] MIPS: OCTEON: Fix octeon_ciu3_errbits_enable_intsn()
 for multi-node.

Signed-off-by: David Daney <david.daney@cavium.com>
[Original patch taken from Cavium SDK 3.1.2-568]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 arch/mips/cavium-octeon/octeon-irq.c | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-irq.c b/arch/mips/cavium-octeon/octeon-irq.c
index e3a3d5d..6ccc00e 100644
--- a/arch/mips/cavium-octeon/octeon-irq.c
+++ b/arch/mips/cavium-octeon/octeon-irq.c
@@ -2649,13 +2649,23 @@ int octeon_ciu3_errbits_enable_intsn(int node, int intsn)
 	if (!cfg->irq) {
 		int irq;
 		struct octeon_ciu_chip_data *cd;
-		int core = octeon_irq_get_local_core_num();
+		const struct cpumask *node_cpus;
+		int cpu_for_idt;
+		int core;
+#ifdef CONFIG_NUMA
+		node_cpus = cpu_online_mask;
+#else
+		node_cpus = cpumask_of_node(node);
+#endif
+		cpu_for_idt = cpumask_first(node_cpus);
+		WARN_ON(cpu_for_idt >= nr_cpu_ids);
+		core = octeon_coreid_for_cpu(cpu_for_idt) & 0x3f;
 
 		irq = irq_alloc_descs(-1, 1, 1, node);
 		if (irq < 0)
 			return irq;
 		cfg->irq = irq;
-		cfg->idt = core * 4 + 3; /* FIXME for Multi-node.*/
+		cfg->idt = core * 4 + 3;
 		cfg->node = node;
 		cfg->ciu3_addr = ciu3_addr;
 
-- 
2.6.2

