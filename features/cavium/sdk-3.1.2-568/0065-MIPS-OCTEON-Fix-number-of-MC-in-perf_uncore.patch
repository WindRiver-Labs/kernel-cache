From 2e3978efeab0850ac49fc8861a2f4eaa3afc202a Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 6 Feb 2015 13:38:16 -0800
Subject: [PATCH 065/184] MIPS: OCTEON: Fix number of MC in perf_uncore.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: cbdcc631f3b9abb66171a50c0ec39d75c484e827
Description:

The number of memory controllers is not the same as the number of
TADs, set it based on chip model.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from octeon-linux-kernel-patches-SDK-3.1.2-release]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/perf_uncore.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/arch/mips/cavium-octeon/perf_uncore.c b/arch/mips/cavium-octeon/perf_uncore.c
index 80f4610..14a17aff 100644
--- a/arch/mips/cavium-octeon/perf_uncore.c
+++ b/arch/mips/cavium-octeon/perf_uncore.c
@@ -101,6 +101,7 @@ static int lim_cvmx_lmcx(void)
 {
 	int lim = 0;
 	int tad;
+	int possible;
 
 	/*
 	 * Prepare to walk over all _enabled_ LMC banks:
@@ -110,7 +111,12 @@ static int lim_cvmx_lmcx(void)
 	 */
 	if (OCTEON_IS_OCTEON1PLUS())
 		return 1;
-	for (tad = 0; tad < CVMX_L2C_TADS; tad++) {
+	possible = 1;
+	if (OCTEON_IS_MODEL(OCTEON_CN73XX) || OCTEON_IS_MODEL(OCTEON_CN75XX))
+		possible = 2;
+	else if (OCTEON_IS_MODEL(OCTEON_CN68XX) || OCTEON_IS_MODEL(OCTEON_CN78XX))
+		possible = 4;
+	for (tad = 0; tad < possible; tad++) {
 		union cvmx_lmcx_dll_ctl2 ctl2;
 		ctl2.u64 = cvmx_read_csr(CVMX_LMCX_DLL_CTL2(tad));
 		if (current_cpu_type() == CPU_CAVIUM_OCTEON3) {
-- 
1.9.1

