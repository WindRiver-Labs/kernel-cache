From eeb7ea68c2db59347da7babdfb565156d7f0143b Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Mon, 2 Jun 2014 14:39:09 -0700
Subject: [PATCH 507/518] netdev: octeon3-ethernet: Implement PKI-20775

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: e2c61dfd3af104c7fdd7281973de6f041dd74f83
Description:

Must reread statistics registers until not all ones.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 17 ++++++++++++++---
 1 file changed, 14 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index 6fc4f3c..5ec2797 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -979,6 +979,17 @@ skip_xmit:
 	return NETDEV_TX_OK;
 }
 
+static u64 read_pki_stat(int numa_node, u64 csr)
+{
+	u64 v;
+
+	/* PKI-20775, must read until not all ones. */
+	do {
+		v = cvmx_read_csr_node(numa_node, csr);
+	} while (v == 0xffffffffffffffffull);
+	return v;
+}
+
 static struct rtnl_link_stats64 *octeon3_eth_ndo_get_stats64(struct net_device *netdev,
 							     struct rtnl_link_stats64 *s)
 {
@@ -988,9 +999,9 @@ static struct rtnl_link_stats64 *octeon3_eth_ndo_get_stats64(struct net_device *
 
 	spin_lock(&priv->stat_lock);
 
-	packets = cvmx_read_csr_node(priv->numa_node, CVMX_PKI_STATX_STAT0(priv->pki_pkind));
-	octets = cvmx_read_csr_node(priv->numa_node, CVMX_PKI_STATX_STAT1(priv->pki_pkind));
-	dropped = cvmx_read_csr_node(priv->numa_node, CVMX_PKI_STATX_STAT3(priv->pki_pkind));
+	packets = read_pki_stat(priv->numa_node, CVMX_PKI_STATX_STAT0(priv->pki_pkind));
+	octets = read_pki_stat(priv->numa_node, CVMX_PKI_STATX_STAT1(priv->pki_pkind));
+	dropped = read_pki_stat(priv->numa_node, CVMX_PKI_STATX_STAT3(priv->pki_pkind));
 
 	delta_packets = (packets - priv->last_packets) & ((1ull << 48) - 1);
 	delta_octets = (octets - priv->last_octets) & ((1ull << 48) - 1);
-- 
1.9.1

