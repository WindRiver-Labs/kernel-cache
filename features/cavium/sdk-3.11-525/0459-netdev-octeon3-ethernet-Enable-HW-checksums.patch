From ea0ac2353d749ffd7323e8829bd3428f6b944169 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 7 May 2014 11:41:15 -0400
Subject: [PATCH 459/518] netdev: octeon3-ethernet: Enable HW checksums.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 23323af6d5cf1c706ff234f488b34235555f72ca
Description:

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/ethernet/octeon/octeon3-ethernet.c | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/octeon/octeon3-ethernet.c b/drivers/net/ethernet/octeon/octeon3-ethernet.c
index 4df455e..b423f1c 100644
--- a/drivers/net/ethernet/octeon/octeon3-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon3-ethernet.c
@@ -552,7 +552,7 @@ static int octeon3_eth_napi(struct napi_struct *napi, int budget)
 	return rx_count;
 }
 
-#define BROKEN_SIMULATOR_CSUM 1
+//#define BROKEN_SIMULATOR_CSUM 1
 
 static int octeon3_eth_ndo_init(struct net_device *netdev)
 {
@@ -755,6 +755,7 @@ static int octeon3_eth_ndo_start_xmit(struct sk_buff *skb, struct net_device *ne
 	union cvmx_pko_lmtdma_data lmtdma_data;
 	union cvmx_pko_query_rtn query_rtn;
 	u8 l4_hdr = 0;
+	unsigned int checksum_alg;
 	long backlog;
 	int frag_count;
 	int head_len, i;
@@ -823,14 +824,19 @@ static int octeon3_eth_ndo_start_xmit(struct sk_buff *skb, struct net_device *ne
 		break;
 	}
 #endif
+	checksum_alg = 1; /* UDP == 1 */
 	switch (l4_hdr) {
-	case IPPROTO_TCP:
 	case IPPROTO_SCTP:
+		checksum_alg++; /* SCTP == 3 */
+		/* Fall through */
+	case IPPROTO_TCP: /* TCP == 2 */
+		checksum_alg++;
+		/* Fall through */
 	case IPPROTO_UDP:
 		if (skb_transport_header_was_set(skb)) {
 			int l4ptr = skb_transport_header(skb) - skb->data;
 			send_hdr.s.l4ptr = l4ptr;
-			send_hdr.s.ckl4 = 1;
+			send_hdr.s.ckl4 = checksum_alg;
 		}
 		break;
 	default:
-- 
1.9.1

