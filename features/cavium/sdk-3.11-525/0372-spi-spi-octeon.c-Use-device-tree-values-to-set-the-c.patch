From f30ef32d6ed0ce6da1b3570d8b83b1e00a1a911e Mon Sep 17 00:00:00 2001
From: Carlos Munoz <carlos.munoz@caviumnetworks.com>
Date: Mon, 20 Jan 2014 14:11:26 -0800
Subject: [PATCH 372/518] spi: spi-octeon.c: Use device tree values to set the
 controller's maximum frequency.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: f2b40aa436ee28a1fd0037743251fee5150436b8
Description:

Signed-off-by: Carlos Munoz <carlos.munoz@caviumnetworks.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 Documentation/devicetree/bindings/spi/spi-octeon.txt | 2 ++
 drivers/spi/spi-octeon.c                             | 9 +++++----
 2 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/Documentation/devicetree/bindings/spi/spi-octeon.txt b/Documentation/devicetree/bindings/spi/spi-octeon.txt
index 431add1..58f7d01 100644
--- a/Documentation/devicetree/bindings/spi/spi-octeon.txt
+++ b/Documentation/devicetree/bindings/spi/spi-octeon.txt
@@ -6,6 +6,7 @@ Required properties:
 - interrupts : One interrupt, used by the controller.
 - #address-cells : <1>, as required by generic SPI binding.
 - #size-cells : <0>, also as required by generic SPI binding.
+- spi-max-frequency : Maximum frequency of the controller.
 
 Child nodes as per the generic SPI binding.
 
@@ -17,6 +18,7 @@ Example:
 		interrupts = <0 58>;
 		#address-cells = <1>;
 		#size-cells = <0>;
+		spi-max-frequency = <25000000>;
 
 		eeprom@0 {
 			compatible = "st,m95256", "atmel,at25";
diff --git a/drivers/spi/spi-octeon.c b/drivers/spi/spi-octeon.c
index b881dfb..99dbed2 100644
--- a/drivers/spi/spi-octeon.c
+++ b/drivers/spi/spi-octeon.c
@@ -26,7 +26,6 @@
 #define OCTEON_SPI_MAX_BYTES 9
 
 #define OCTEON_SPI_MAX_CLOCK_HZ		16000000
-#define OCTEON_SPI_MAX_CLOCK_HZ_7XXX	200000000	/** Max clock for O3 */
 
 struct octeon_spi {
 	struct spi_master *my_master;
@@ -70,6 +69,8 @@ static int octeon_spi_do_transfer(struct octeon_spi *p,
 	u8 *rx_buf;
 	int len;
 	int i;
+	u32 max_freq;
+	struct device_node *np = p->my_master->dev.of_node;
 
 	struct octeon_spi_setup *msg_setup = spi_get_ctldata(msg->spi);
 
@@ -84,9 +85,9 @@ static int octeon_spi_do_transfer(struct octeon_spi *p,
 	if (xfer->bits_per_word)
 		bits_per_word = xfer->bits_per_word;
 
-	if (OCTEON_IS_OCTEON3()) {
-		if (speed_hz > OCTEON_SPI_MAX_CLOCK_HZ_7XXX)
-			speed_hz = OCTEON_SPI_MAX_CLOCK_HZ_7XXX;
+	if (!of_property_read_u32(np, "spi-max-frequency", &max_freq)) {
+		if (speed_hz > max_freq)
+			speed_hz = max_freq;
 	}
 	else {
 		if (speed_hz > OCTEON_SPI_MAX_CLOCK_HZ)
-- 
1.9.1

