From 34fa72986b71cc01a1c32eef001c92680bd55295 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Tue, 25 Sep 2012 15:41:20 -0700
Subject: [PATCH 054/518] MIPS: OCTEON: Rearrange CVMSEG slots.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: abed31ea83a960d26102be4bc2b4b6a366b14a7b
Description:

By putting FAST_ACCESS_THREAD_OFFSET at the top, any TLB related use
can be contiguous.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/mipsregs.h | 6 +++---
 arch/mips/mm/tlbex.c             | 5 ++++-
 2 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/arch/mips/include/asm/mipsregs.h b/arch/mips/include/asm/mipsregs.h
index 569cbbd..e9337d6 100644
--- a/arch/mips/include/asm/mipsregs.h
+++ b/arch/mips/include/asm/mipsregs.h
@@ -627,12 +627,12 @@
  * thread pointer from userspace. Octeon uses a 64bit location in
  * CVMSEG to store the thread pointer for quick access.
  *
- * TLB refill uses location -8, fast access is -16 (both from the top
- * of the area.
+ * TLB refill uses location -16 (and below), fast access is -8 (both
+ * from the top of the area.
  */
 #ifdef CONFIG_FAST_ACCESS_TO_THREAD_POINTER
 #define FAST_ACCESS_THREAD_OFFSET			\
-	(CONFIG_CAVIUM_OCTEON_CVMSEG_SIZE*128-16-32768)
+	(CONFIG_CAVIUM_OCTEON_CVMSEG_SIZE * 128 - 8 - 32768)
 #define FAST_ACCESS_THREAD_REGISTER			\
 	(*(unsigned long *)(FAST_ACCESS_THREAD_OFFSET))
 #endif
diff --git a/arch/mips/mm/tlbex.c b/arch/mips/mm/tlbex.c
index 1c00c02..dc60b69 100644
--- a/arch/mips/mm/tlbex.c
+++ b/arch/mips/mm/tlbex.c
@@ -113,8 +113,11 @@ static int scratchpad_offset(int i)
 	/*
 	 * CVMSEG starts at address -32768 and extends for
 	 * CAVIUM_OCTEON_CVMSEG_SIZE 128 byte cache lines.
+	 *
+	 * FAST_ACCESS_THREAD_OFFSET is at the top.  TLB related work
+	 * down from there.
 	 */
-	i += 1; /* Kernel use starts at the top and works down. */
+	i += 2;
 	return CONFIG_CAVIUM_OCTEON_CVMSEG_SIZE * 128 - (8 * i) - 32768;
 }
 #else
-- 
1.9.1

