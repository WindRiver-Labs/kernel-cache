From 9455d12364e11ccb2552ae3911252d385329005a Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Tue, 13 May 2014 11:07:19 -0700
Subject: [PATCH 471/518] MIPS: OCTEON: Cleanup MSI handling code.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 46b74c1858591e447c40e504b1d773ce315ba3ad
Description:

No functional change.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/pci/msi-octeon.c | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/arch/mips/pci/msi-octeon.c b/arch/mips/pci/msi-octeon.c
index 7249bb8..fc9a71f 100644
--- a/arch/mips/pci/msi-octeon.c
+++ b/arch/mips/pci/msi-octeon.c
@@ -318,13 +318,13 @@ int arch_setup_msi_irq(struct pci_dev *dev, struct msi_desc *desc)
 		if (msi_to_irq[msi])
 			irq = msi_to_irq[msi];
 		else {
-			cd = kzalloc(sizeof(*cd), GFP_KERNEL);
+			cd = kzalloc_node(sizeof(*cd), GFP_KERNEL, node);
+			if (!cd)
+				return -ENOMEM;
 			cd->msi = msi;
 			cd->hwmsi = hwmsi;
-
-			if ((irq = irq_alloc_descs(-1, 1, 1, node)) < 0) {
-				WARN(1, "arch_setup_msi_irq: Unable to find a "
-				     "free irq\n");
+			irq = irq_alloc_descs(-1, 1, 1, node);
+			if (WARN(irq < 0, "arch_setup_msi_irq: Unable to find a free irq\n")) {
 				clear_bit(msi, msi_free_irq_bitmap[node]);
 				kfree(cd);
 				return -ENOSPC;
-- 
1.9.1

