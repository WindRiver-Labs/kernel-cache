From f48644167f541568facffdaf80da7c2ddeb7f9bf Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 16 Aug 2012 16:30:25 -0700
Subject: [PATCH 043/518] MIPS: If huge pages are enabled, align STACK_TOP to a
 huge page boundry.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: f92a0f257c3befc962a33d5dc7c521be348fecc1
Description:

This allows us to remap the stack onto huge pages without clobbering
either the VDSO nor memory past the TASK_SIZE limit.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/processor.h | 18 +++++++++++++++++-
 arch/mips/kernel/vdso.c           |  2 +-
 2 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/arch/mips/include/asm/processor.h b/arch/mips/include/asm/processor.h
index 7bd6af8..b63148e 100644
--- a/arch/mips/include/asm/processor.h
+++ b/arch/mips/include/asm/processor.h
@@ -78,9 +78,25 @@ extern unsigned int vced_count, vcei_count;
 
 #define TASK_IS_32BIT_ADDR test_thread_flag(TIF_32BIT_ADDR)
 
+# ifdef CONFIG_HUGETLB_PAGE
+/*
+ * Align the STACK_TOP on a HPAGE_SIZE boundry so the stack may be
+ * remapped to a huge page.
+ */
+# define SPECIAL_PAGES_BASE ((TASK_SIZE & PAGE_MASK) - SPECIAL_PAGES_SIZE)
+# define STACK_TOP (SPECIAL_PAGES_BASE & HPAGE_MASK)
+
+# endif /* CONFIG_HUGETLB_PAGE */
+#endif /* CONFIG_64BIT */
+
+#ifndef STACK_TOP
+# define STACK_TOP	((TASK_SIZE & PAGE_MASK) - SPECIAL_PAGES_SIZE)
+#endif
+
+#ifndef SPECIAL_PAGES_BASE
+# define SPECIAL_PAGES_BASE STACK_TOP
 #endif
 
-#define STACK_TOP	((TASK_SIZE & PAGE_MASK) - SPECIAL_PAGES_SIZE)
 
 /*
  * This decides where the kernel will search for a free chunk of vm
diff --git a/arch/mips/kernel/vdso.c b/arch/mips/kernel/vdso.c
index 0f1af58..088acee 100644
--- a/arch/mips/kernel/vdso.c
+++ b/arch/mips/kernel/vdso.c
@@ -67,7 +67,7 @@ subsys_initcall(init_vdso);
 
 static unsigned long vdso_addr(unsigned long start)
 {
-	return STACK_TOP;
+	return SPECIAL_PAGES_BASE;
 }
 
 int arch_setup_additional_pages(struct linux_binprm *bprm, int uses_interp)
-- 
1.9.1

