From 4a55edb935ba6e458cc5634ff54929daf944d216 Mon Sep 17 00:00:00 2001
From: Chandrakala Chavva <cchavva@caviumnetworks.com>
Date: Tue, 4 Feb 2014 19:13:05 -0800
Subject: [PATCH 378/518] alu change: MIPS: OCTEON: Improve PHY mode setting

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 085af604bb03a7b22f06fe357232c696b67fcce3
Description:

    The PY mode and 1000x base mode are read from device tree.
    Improved the code so that the fields are read from the port
    instead of the base.

Signed-off-by: Chandrakala Chavva <cchavva@caviumnetworks.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/ethernet/octeon/ethernet.c | 31 ++++++++++++++-----------------
 1 file changed, 14 insertions(+), 17 deletions(-)

diff --git a/drivers/net/ethernet/octeon/ethernet.c b/drivers/net/ethernet/octeon/ethernet.c
index d849420..45929d6 100644
--- a/drivers/net/ethernet/octeon/ethernet.c
+++ b/drivers/net/ethernet/octeon/ethernet.c
@@ -785,26 +785,23 @@ static int cvm_oct_get_port_status(struct device_node *pip)
 			case CVMX_HELPER_INTERFACE_MODE_SGMII:
 			case CVMX_HELPER_INTERFACE_MODE_QSGMII:
 			{
-				struct device_node *n;
-				if (cvm_oct_node_for_port(pip, i, j) != NULL)
+				struct device_node *port_node;
+				port_node = cvm_oct_node_for_port(pip, i, j);
+				if (port_node != NULL)
 					cvmx_helper_set_port_valid(i, j, true);
 				else
 					cvmx_helper_set_port_valid(i, j, false);
-
-				n = of_find_compatible_node(NULL, NULL,
-						"cavium,octeon-3860-pip-port");
-				if (n != NULL && of_get_property(n, 
-					"cavium,sgmii-mac-phy-mode", NULL) != NULL)
-					cvmx_helper_set_mac_phy_mode(i, j, true);
-				else
-					cvmx_helper_set_mac_phy_mode(i, j, false);
-	
-				if (n != NULL && of_get_property(n, 
-					"cavium,sgmii-mac-1000x-mode", NULL) 
-					!= NULL)
-					cvmx_helper_set_1000x_mode(i, j, true);
-				else
-					cvmx_helper_set_1000x_mode(i, j, false);
+				cvmx_helper_set_mac_phy_mode(i, j, false);
+				cvmx_helper_set_1000x_mode(i, j, false);
+				if (port_node) {
+					if (of_get_property(port_node, 
+					    "cavium,sgmii-mac-phy-mode", NULL) != NULL)
+						cvmx_helper_set_mac_phy_mode(i, j, true);
+					if (of_get_property(port_node, 
+					    "cavium,sgmii-mac-1000x-mode", NULL) 
+					    != NULL)
+						cvmx_helper_set_1000x_mode(i, j, true);
+				}
 				break;
 			}
 			default:
-- 
1.9.1

