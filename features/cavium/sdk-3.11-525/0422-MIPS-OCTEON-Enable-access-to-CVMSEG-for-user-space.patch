From be84954d42d3754df775572dae8f953bcca7daa3 Mon Sep 17 00:00:00 2001
From: Chandrakala Chavva <cchavva@caviumnetworks.com>
Date: Wed, 2 Apr 2014 15:08:11 -0700
Subject: [PATCH 422/518] MIPS:OCTEON: Enable access to CVMSEG for user space

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 7e1617a2589afe91087e19e6f20a206f04bc3b0c
Description:

Access to CVMSEG is required for LMTDMA operations.
Also enable CvmMemCtl(LMTLIME,LMTENA), required for LMTDMA opernations.

Signed-off-by: Chandrakala Chavva <cchavva@caviumnetworks.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/cavium-octeon/setup.c       |  6 ++++++
 arch/mips/include/asm/octeon/octeon.h | 11 +++++++++--
 arch/mips/kernel/octeon-cpu.c         |  1 +
 3 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index b3668fb..707a2bf 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -487,6 +487,12 @@ void octeon_user_io_init(void)
 	 * kernel/debug mode. */
 #if CONFIG_CAVIUM_OCTEON_CVMSEG_SIZE > 0
 	cvmmemctl.s.cvmsegenak = 1;
+	if (OCTEON_IS_MODEL(OCTEON_CN78XX)) {
+		/* Enable LMTDMA */
+		cvmmemctl.s.lmtena = 1;
+		/* Scratch line to use for LMT operation */
+		cvmmemctl.s.lmtline = 2;
+	}
 #else
 	cvmmemctl.s.cvmsegenak = 0;
 #endif
diff --git a/arch/mips/include/asm/octeon/octeon.h b/arch/mips/include/asm/octeon/octeon.h
index 4e3e07f..930634f17 100644
--- a/arch/mips/include/asm/octeon/octeon.h
+++ b/arch/mips/include/asm/octeon/octeon.h
@@ -181,7 +181,12 @@ union octeon_cvmemctl {
 		/* RO 1 = BIST fail, 0 = BIST pass */
 		uint64_t wbfbist:1;
 		/* Reserved */
-		uint64_t reserved:13;
+		uint64_t reserved:6;
+		/* When set, LMTDMA/LMTST operations are permitted */
+		uint64_t lmtena:1;
+		/* Selects the CVMSEG LM cacheline used by LMTDMA
+		   LMTST and wide atomic store operations */
+		uint64_t lmtline:6;
 		/* When set, TLB parity errors can occur. */
 		uint64_t tlbperrena:1;
 		/* OCTEON II - When set, CVMSET LM parity errors are enabled. */
@@ -319,7 +324,9 @@ union octeon_cvmemctl {
 		uint64_t disstpref:1;
 		uint64_t lmemperrena:1;
 		uint64_t tlbperrena:1;
-		uint64_t reserved:13;
+		uint64_t lmtline:6;
+		uint64_t lmtena:1;
+		uint64_t reserved:6;
 		uint64_t wbfbist:1;
 		uint64_t ptgbist:1;
 		uint64_t dcmbist:1;
diff --git a/arch/mips/kernel/octeon-cpu.c b/arch/mips/kernel/octeon-cpu.c
index 37bddd0..a08c4ad 100644
--- a/arch/mips/kernel/octeon-cpu.c
+++ b/arch/mips/kernel/octeon-cpu.c
@@ -48,6 +48,7 @@ void octeon_prepare_arch_switch(struct task_struct *next)
 
 #if defined(CONFIG_CAVIUM_OCTEON_USER_IO_PER_PROCESS)
 	cvmmemctl.s.xkioenau = test_tsk_thread_flag(group_leader, TIF_XKPHYS_IO_EN) ? 1 : 0;
+	cvmmemctl.s.cvmsegenau = test_tsk_thread_flag(group_leader, TIF_XKPHYS_IO_EN) ? 1 : 0;
 #endif
 	write_c0_cvmmemctl(cvmmemctl.u64);
 }
-- 
1.9.1

