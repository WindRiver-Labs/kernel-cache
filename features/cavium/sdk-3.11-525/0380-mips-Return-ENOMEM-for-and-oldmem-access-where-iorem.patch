From 20cec8035cef47794fd06871446da2d3f84a8239 Mon Sep 17 00:00:00 2001
From: Corey Minyard <cminyard@mvista.com>
Date: Mon, 3 Feb 2014 10:19:27 -0600
Subject: [PATCH 380/518] mips: Return ENOMEM for and oldmem access where
 ioremap fails

Source: Cavium Networks, Inc
MR: 5283
Type: Defect Fix
Disposition: Needs submitting to k.org
ChangeID: 6eecf1222d598a67f4cddf6bfc684d96dc2aab5d
Description:

If ioremap fails, you shouldn't really try to access the memory.  Return
ENOMEM like x86_64 does.

Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/kernel/crash_dump.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/arch/mips/kernel/crash_dump.c b/arch/mips/kernel/crash_dump.c
index f988643..148e9ae1 100644
--- a/arch/mips/kernel/crash_dump.c
+++ b/arch/mips/kernel/crash_dump.c
@@ -43,6 +43,8 @@ ssize_t copy_oldmem_page(unsigned long pfn, char *buf,
 		return 0;
 
 	vaddr = ioremap(pfn << PAGE_SHIFT, PAGE_SIZE);
+	if (!vaddr)
+		return -ENOMEM
 
 	if (!userbuf) {
 		memcpy(buf, (vaddr + offset), csize);
-- 
1.9.1

