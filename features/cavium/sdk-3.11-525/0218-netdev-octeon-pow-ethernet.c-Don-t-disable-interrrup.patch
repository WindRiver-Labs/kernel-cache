From 4e99ff0701891b0916bc160f21017ce0a9db660c Mon Sep 17 00:00:00 2001
From: Carlos Munoz <carlos.munoz@caviumnetworks.com>
Date: Wed, 21 Aug 2013 10:08:09 -0700
Subject: [PATCH 218/518] netdev: octeon-pow-ethernet.c: Don't disable
 interrrupt in interrupt handler.

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 4694a47490444f333d4711c08adc4023b4c365f2
Description:

Signed-off-by: Carlos Munoz <carlos.munoz@caviumnetworks.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/ethernet/octeon/octeon-pow-ethernet.c | 16 +++++++++-------
 1 file changed, 9 insertions(+), 7 deletions(-)

diff --git a/drivers/net/ethernet/octeon/octeon-pow-ethernet.c b/drivers/net/ethernet/octeon/octeon-pow-ethernet.c
index a80a7c9..4aec9d0 100644
--- a/drivers/net/ethernet/octeon/octeon-pow-ethernet.c
+++ b/drivers/net/ethernet/octeon/octeon-pow-ethernet.c
@@ -319,18 +319,13 @@ static irqreturn_t octeon_pow_interrupt(int cpl, void *dev_id)
 	asm volatile ("synciobdma" : : : "memory");
 
 	if (OCTEON_IS_MODEL(OCTEON_CN68XX)) {
-		cvmx_write_csr(CVMX_SSO_WQ_INT, 1ull << priv->rx_group);
-		cvmx_write_csr(CVMX_SSO_WQ_IQ_DIS, 1ull << priv->rx_group);
-
+		/* Only allow work for our group */
 		old_group_mask = cvmx_read_csr(CVMX_SSO_PPX_GRP_MSK(coreid));
 		cvmx_write_csr(CVMX_SSO_PPX_GRP_MSK(coreid),
 			       1ull << priv->rx_group);
 		/* Read it back so it takes effect before we request work */
 		cvmx_read_csr(CVMX_SSO_PPX_GRP_MSK(coreid));
 	} else {
-		/* Acknowledge the interrupt */
-		cvmx_write_csr(CVMX_POW_WQ_INT, 0x10001 << priv->rx_group);
-
 		/* Only allow work for our group */
 		old_group_mask = cvmx_read_csr(CVMX_POW_PP_GRP_MSKX(coreid));
 		cvmx_write_csr(CVMX_POW_PP_GRP_MSKX(coreid), 1 << priv->rx_group);
@@ -413,13 +408,20 @@ static irqreturn_t octeon_pow_interrupt(int cpl, void *dev_id)
 		netif_rx(skb);
 	}
 
-	/* Restore the original POW group mask */
 	if (OCTEON_IS_MODEL(OCTEON_CN68XX)) {
+		/* Restore the original POW group mask */
 		cvmx_write_csr(CVMX_SSO_PPX_GRP_MSK(coreid), old_group_mask);
 		/* Read it back so it takes effect before ?? */
 		cvmx_read_csr(CVMX_SSO_PPX_GRP_MSK(coreid));
+
+		/* Acknowledge the interrupt */
+		cvmx_write_csr(CVMX_SSO_WQ_INT, 1ull << priv->rx_group);
 	} else {
+		/* Restore the original POW group mask */
 		cvmx_write_csr(CVMX_POW_PP_GRP_MSKX(coreid), old_group_mask);
+
+		/* Acknowledge the interrupt */
+		cvmx_write_csr(CVMX_POW_WQ_INT, 1ull << priv->rx_group);
 	}
 	return IRQ_HANDLED;
 }
-- 
1.9.1

