From 9447a864ab65b98543ed4704bac52fcd2aaa6706 Mon Sep 17 00:00:00 2001
From: Chandrakala Chavva <cchavva@caviumnetworks.com>
Date: Tue, 24 Sep 2013 11:12:55 -0700
Subject: [PATCH 248/518] MIPS: OCTEON: Fix non-smp build issues

Source: Cavium Networks, Inc.
MR: 00000
Type: Integration
Disposition: Merged from Octeon Tree
ChangeID: 447f41fdd884576f95ff06e55ae0a1e0af8cabda
Description:

octeon_bootloader_entry_addr is defined only when kernel is configured
for CONFIG_SMP.

Signed-off-by: Chandrakala Chavva <cchavva@caviumnetworks.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
[Original patch taken from Cavium SDK 3.1.1 525]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/watchdog/octeon-wdt-main.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/drivers/watchdog/octeon-wdt-main.c b/drivers/watchdog/octeon-wdt-main.c
index 0d6f1d3..dd48772 100644
--- a/drivers/watchdog/octeon-wdt-main.c
+++ b/drivers/watchdog/octeon-wdt-main.c
@@ -135,9 +135,11 @@ static void __init octeon_wdt_build_stage1(void)
 	int i;
 	int len;
 	u32 *p = nmi_stage1_insns;
+#ifdef CONFIG_SMP
 	struct uasm_label *l = labels;
 	struct uasm_reloc *r = relocs;
 	bool is_ciu2 = OCTEON_IS_MODEL(OCTEON_CN68XX);
+#endif
 
 	/*
 	 * For the next few instructions running the debugger may
@@ -153,6 +155,7 @@ static void __init octeon_wdt_build_stage1(void)
 	uasm_i_ori(&p, K0, K0, ST0_UX | ST0_SX | ST0_KX);
 	uasm_i_mtc0(&p, K0, C0_STATUS);
 
+#ifdef CONFIG_SMP
 	/*
 	 * If octeon_bootloader_entry_addr is set, we can transfer
 	 * control to the bootloader if it is not a watchdog related
@@ -196,12 +199,14 @@ static void __init octeon_wdt_build_stage1(void)
 		uasm_il_bbit0(&p, &r, K0, 1, label_enter_bootloader);
 		uasm_i_nop(&p);
 	}
+#endif
 
 	/* Load the address of the second stage handler */
 	UASM_i_LA(&p, K0, (long)octeon_wdt_nmi_stage2);
 	uasm_i_jr(&p, K0);
 	uasm_i_dmfc0(&p, K0, C0_DESAVE);
 
+#ifdef CONFIG_SMP
 	if (octeon_bootloader_entry_addr) {
 		uasm_build_label(&l, p, label_enter_bootloader);
 		/* Jump to the bootloader and restore K0 */
@@ -209,6 +214,7 @@ static void __init octeon_wdt_build_stage1(void)
 		uasm_i_jr(&p, K0);
 		uasm_i_dmfc0(&p, K0, C0_DESAVE);
 	}
+#endif
 	uasm_resolve_relocs(relocs, labels);
 
 	len = (int)(p - nmi_stage1_insns);
-- 
1.9.1

