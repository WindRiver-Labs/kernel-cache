From 4325bd57732efb7f336bfe5b9eee24bef27ab9c2 Mon Sep 17 00:00:00 2001
From: Jiang Bin <bin.jiang@windriver.com>
Date: Tue, 26 Jun 2012 14:52:31 +0800
Subject: [PATCH 12/22] Cavium: kexec: fix crash kernel fails to start octeon
 ethernet.

crash kernel boots with "reset_devices" which requires to reset network
devices, otherwise octeon ethernet can't work.

Signed-off-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/net/ethernet/octeon/Makefile   |    1 +
 drivers/net/ethernet/octeon/ethernet.c |    4 ++--
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/octeon/Makefile b/drivers/net/ethernet/octeon/Makefile
index d5c3bae..4d7f73b 100644
--- a/drivers/net/ethernet/octeon/Makefile
+++ b/drivers/net/ethernet/octeon/Makefile
@@ -7,6 +7,7 @@ obj-$(CONFIG_OCTEON_POW_ONLY_ETHERNET)	+= octeon-pow-ethernet.o
 obj-${CONFIG_OCTEON_ETHERNET} +=  octeon-ethernet.o
 obj-${CONFIG_OCTEON_ETHERNET_MEM} += ethernet-mem.o
 obj-${CONFIG_KEXEC} +=  octeon-kexec-net.o
+obj-${CONFIG_CRASH_DUMP} +=  octeon-kexec-net.o
 
 octeon-ethernet-objs := ethernet.o
 octeon-ethernet-objs += ethernet-mdio.o
diff --git a/drivers/net/ethernet/octeon/ethernet.c b/drivers/net/ethernet/octeon/ethernet.c
index 7cede86..d540633 100644
--- a/drivers/net/ethernet/octeon/ethernet.c
+++ b/drivers/net/ethernet/octeon/ethernet.c
@@ -859,7 +859,7 @@ static struct device_node * __devinit cvm_oct_node_for_port(struct device_node *
 	return np;
 }
 
-#ifdef CONFIG_KEXEC
+#if defined(CONFIG_KEXEC) || defined(CONFIG_CRASH_DUMP)
 extern void octeon_shutdown_network_hw(void);
 #endif
 
@@ -871,7 +871,7 @@ static int __devinit cvm_oct_probe(struct platform_device *pdev)
 	int qos, r;
 	struct device_node *pip;
 
-#ifdef CONFIG_KEXEC
+#if defined(CONFIG_KEXEC) || defined(CONFIG_CRASH_DUMP)
 	if (reset_devices)
 		octeon_shutdown_network_hw();
 #endif
-- 
1.7.10.4

