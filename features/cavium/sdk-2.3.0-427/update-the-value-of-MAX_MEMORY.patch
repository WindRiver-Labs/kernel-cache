From 458e0c1f6d4a3e175115cc3bf062935447c3c6c9 Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Thu, 30 Aug 2012 17:44:50 +0800
Subject: [PATCH 26/27] update the value of MAX_MEMORY

get the correct value of MAX_MEMORY from bootinfo structure

add the support of size unit (M/K) in command line

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/cavium-octeon/setup.c |   14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index e3c30b6..3eddb27 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -435,6 +435,7 @@ void __init prom_init(void)
 	octeon_boot_desc_ptr = (struct octeon_boot_descriptor *)fw_arg3;
 	octeon_bootinfo =
 		cvmx_phys_to_ptr(octeon_boot_desc_ptr->cvmx_desc_vaddr);
+	MAX_MEMORY = (uint64_t)octeon_bootinfo->dram_size << 20;
 	cvmx_bootmem_init(cvmx_phys_to_ptr(octeon_bootinfo->phy_mem_desc_addr));
 
 	sysinfo = cvmx_sysinfo_get();
@@ -583,8 +584,17 @@ void __init prom_init(void)
 			cvmx_phys_to_ptr(octeon_boot_desc_ptr->argv[i]);
 		if ((strncmp(arg, "MEM=", 4) == 0) ||
 		    (strncmp(arg, "mem=", 4) == 0)) {
-			sscanf(arg + 4, "%llu", &MAX_MEMORY);
-			MAX_MEMORY <<= 20;
+			char mult = '?';
+			sscanf(arg + 4, "%llu%c", &MAX_MEMORY, &mult);
+			switch (mult) {
+				case 'M':
+				case '?':
+					MAX_MEMORY <<= 20;
+				case 'K':
+					MAX_MEMORY <<= 10;
+				default:
+					break;
+			}
 			if (MAX_MEMORY == 0)
 				MAX_MEMORY = 32ull << 30;
 		} else if (strcmp(arg, "ecc_verbose") == 0) {
-- 
1.7.9.7

