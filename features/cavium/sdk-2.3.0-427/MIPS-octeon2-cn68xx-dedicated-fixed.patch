From b8e4c1de49dad217c473ed5637a19912d29c099c Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Wed, 5 Sep 2012 16:24:57 +0800
Subject: [PATCH 20/27] MIPS: octeon2: cn68xx dedicated fixed

Based on SDK 2.3.0-427

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/cavium-octeon/smp.c |   12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/arch/mips/cavium-octeon/smp.c b/arch/mips/cavium-octeon/smp.c
index 97e7ce9..697a1be 100644
--- a/arch/mips/cavium-octeon/smp.c
+++ b/arch/mips/cavium-octeon/smp.c
@@ -39,6 +39,11 @@ static irqreturn_t mailbox_interrupt(int irq, void *dev_id)
 	/* Load the mailbox register to figure out what we're supposed to do */
 	action = cvmx_read_csr(CVMX_CIU_MBOX_CLRX(coreid)) & 0xffff;
 
+        if (OCTEON_IS_MODEL(OCTEON_CN68XX))
+                action &= 0xff;
+        else
+		action &= 0xffff;
+
 	/* Clear the mailbox to clear the interrupt */
 	cvmx_write_csr(CVMX_CIU_MBOX_CLRX(coreid), action);
 
@@ -194,6 +199,7 @@ static void __cpuinit octeon_init_secondary(void)
  */
 void octeon_prepare_cpus(unsigned int max_cpus)
 {
+	u64 mask;
 #ifdef CONFIG_HOTPLUG_CPU
 	struct linux_app_boot_info *labi;
 
@@ -206,7 +212,11 @@ void octeon_prepare_cpus(unsigned int max_cpus)
 	 * Only the low order mailbox bits are used for IPIs, leave
 	 * the other bits alone.
 	 */
-	cvmx_write_csr(CVMX_CIU_MBOX_CLRX(cvmx_get_core_num()), 0xffff);
+        if (OCTEON_IS_MODEL(OCTEON_CN68XX))
+                mask = 0xff;
+        else
+                mask = 0xffff;
+	cvmx_write_csr(CVMX_CIU_MBOX_CLRX(cvmx_get_core_num()), mask);
 	if (request_irq(OCTEON_IRQ_MBOX0, mailbox_interrupt,
 			IRQF_PERCPU | IRQF_NO_THREAD, "SMP-IPI",
 			mailbox_interrupt)) {
-- 
1.7.9.7

