From a02356ed2c94275d6504d4a50a3fff7213e364a9 Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Wed, 5 Sep 2012 16:23:03 +0800
Subject: [PATCH 19/27] MIPS: octeon2: add the octeon_read_ptp_csr function

Based on SDK 2.3.0-427

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/include/asm/octeon/octeon.h |   19 +++++++++++++++++++
 1 file changed, 19 insertions(+)

diff --git a/arch/mips/include/asm/octeon/octeon.h b/arch/mips/include/asm/octeon/octeon.h
index f72f768..4e4f6da 100644
--- a/arch/mips/include/asm/octeon/octeon.h
+++ b/arch/mips/include/asm/octeon/octeon.h
@@ -53,6 +53,9 @@ extern asmlinkage void octeon_cop2_restore(struct octeon_cop2_state *task);
 extern void octeon_init_cvmcount(void);
 extern void octeon_setup_delays(void);
 
+typedef void (*octeon_irq_ip4_handler_t)(void);
+void octeon_irq_set_ip4_handler(octeon_irq_ip4_handler_t h);
+
 #define OCTEON_ARGV_MAX_ARGS	64
 #define OCTOEN_SERIAL_LEN	20
 
@@ -259,4 +262,20 @@ extern uint64_t octeon_bootloader_entry_addr;
 
 extern void (*octeon_irq_setup_secondary)(void);
 
+static inline uint64_t octeon_read_ptp_csr(uint64_t csr)
+{
+        if (OCTEON_IS_MODEL(OCTEON_CN63XX_PASS1_X)) {
+                uint64_t result;
+                unsigned long flags;
+                /* CN63XX pass 1.x has an errata where you must read this
+                        register twice to get the correct result */
+                local_irq_save(flags);
+                cvmx_read_csr(csr);
+                result = cvmx_read_csr(csr);
+                local_irq_restore(flags);
+                return result;
+        } else
+                return cvmx_read_csr(csr);
+}
+
 #endif /* __ASM_OCTEON_OCTEON_H */
-- 
1.7.9.7

