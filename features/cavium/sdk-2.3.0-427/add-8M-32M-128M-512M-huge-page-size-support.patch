From 52070ed779be67571be256bc97c94917cbfc146b Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Wed, 26 Sep 2012 16:03:45 +0800
Subject: [PATCH 27/27] add 8M 32M 128M 512M huge page size support

We need the 8M, 32M, 128M, 512M huge page size support
when page size is 4KB

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/Kconfig                |   27 +++++++++++++++++++++++++++
 arch/mips/include/asm/mipsregs.h |   10 +++++-----
 arch/mips/include/asm/page.h     |   14 +++++++++++++-
 3 files changed, 45 insertions(+), 6 deletions(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index c5b396d..2d07a2e 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -1809,6 +1809,33 @@ config FORCE_MAX_ZONEORDER
 	  The page size is not necessarily 4KB.  Keep this in mind
 	  when choosing a value for this option.
 
+choice
+	prompt "Hugetlb Page Size (EXPERIMENTAL)"
+	depends on HUGETLB_PAGE
+	default HUGETLB_PAGE_SIZE_2MB
+
+config HUGETLB_PAGE_SIZE_2MB
+	bool "2MB"
+	depends on !PAGE_SIZE_16KB || !PAGE_SIZE_64KB
+
+config HUGETLB_PAGE_SIZE_8MB
+	bool "8MB"
+	depends on (!PAGE_SIZE_16KB || !PAGE_SIZE_64KB) && EXPERIMENTAL
+
+config HUGETLB_PAGE_SIZE_32MB
+	bool "32MB"
+	depends on !PAGE_SIZE_64KB && EXPERIMENTAL
+
+config HUGETLB_PAGE_SIZE_128MB
+	bool "128MB"
+	depends on !PAGE_SIZE_64KB && EXPERIMENTAL
+
+config HUGETLB_PAGE_SIZE_512MB
+	bool "512MB"
+	depends on EXPERIMENTAL
+
+endchoice
+
 config BOARD_SCACHE
 	bool
 
diff --git a/arch/mips/include/asm/mipsregs.h b/arch/mips/include/asm/mipsregs.h
index e64be7c6..e71d90e 100644
--- a/arch/mips/include/asm/mipsregs.h
+++ b/arch/mips/include/asm/mipsregs.h
@@ -230,15 +230,15 @@
 /*
  * Default huge tlb size for a given kernel configuration
  */
-#ifdef CONFIG_PAGE_SIZE_4KB
+#if defined(CONFIG_HUGETLB_PAGE_SIZE_2MB)
 #define PM_HUGE_MASK	PM_1M
-#elif defined(CONFIG_PAGE_SIZE_8KB)
+#elif defined(CONFIG_HUGETLB_PAGE_SIZE_8MB)
 #define PM_HUGE_MASK	PM_4M
-#elif defined(CONFIG_PAGE_SIZE_16KB)
+#elif defined(CONFIG_HUGETLB_PAGE_SIZE_32MB)
 #define PM_HUGE_MASK	PM_16M
-#elif defined(CONFIG_PAGE_SIZE_32KB)
+#elif defined(CONFIG_HUGETLB_PAGE_SIZE_128MB)
 #define PM_HUGE_MASK	PM_64M
-#elif defined(CONFIG_PAGE_SIZE_64KB)
+#elif defined(CONFIG_HUGETLB_PAGE_SIZE_512MB)
 #define PM_HUGE_MASK	PM_256M
 #elif defined(CONFIG_HUGETLB_PAGE)
 #error Bad page size configuration for hugetlbfs!
diff --git a/arch/mips/include/asm/page.h b/arch/mips/include/asm/page.h
index da9bd7d..a904406 100644
--- a/arch/mips/include/asm/page.h
+++ b/arch/mips/include/asm/page.h
@@ -34,7 +34,19 @@
 #define PAGE_MASK       (~((1 << PAGE_SHIFT) - 1))
 
 #ifdef CONFIG_HUGETLB_PAGE
-#define HPAGE_SHIFT	(PAGE_SHIFT + PAGE_SHIFT - 3)
+
+#if defined(CONFIG_HUGETLB_PAGE_SIZE_2MB)
+#define HPAGE_SHIFT     21
+#elif defined(CONFIG_HUGETLB_PAGE_SIZE_8MB)
+#define HPAGE_SHIFT     23
+#elif defined(CONFIG_HUGETLB_PAGE_SIZE_32MB)
+#define HPAGE_SHIFT     25
+#elif defined(CONFIG_HUGETLB_PAGE_SIZE_128MB)
+#define HPAGE_SHIFT     27
+#elif defined(CONFIG_HUGETLB_PAGE_SIZE_512MB)
+#define HPAGE_SHIFT     29
+#endif
+
 #define HPAGE_SIZE	(_AC(1,UL) << HPAGE_SHIFT)
 #define HPAGE_MASK	(~(HPAGE_SIZE - 1))
 #define HUGETLB_PAGE_ORDER	(HPAGE_SHIFT - PAGE_SHIFT)
-- 
1.7.9.7

