From 8eb6b7befafa32123a64841d1ffd47c7175dd07b Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Wed, 10 Apr 2013 16:21:03 +0800
Subject: [PATCH 01/22] MIPS: Octeon: update the value of MAX_MEMORY

get the correct value of MAX_MEMORY from bootinfo structure

add the support of size unit (M/K) in command line

Signed-off-by: Jack Tan <jack.tan@windriver.com>
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/cavium-octeon/setup.c |   14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index 15d7844..6fdd30a 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -678,6 +678,7 @@ void __init prom_init(void)
 	 */
 	octeon_boot_desc_ptr = (struct octeon_boot_descriptor *)fw_arg3;
 	octeon_bootinfo = phys_to_virt(octeon_boot_desc_ptr->cvmx_desc_vaddr);
+	MAX_MEMORY = (uint64_t)octeon_bootinfo->dram_size << 20;
 	cvmx_bootmem_init(octeon_bootinfo->phy_mem_desc_addr);
 
 	sysinfo = cvmx_sysinfo_get();
@@ -817,8 +818,17 @@ void __init prom_init(void)
 				pr_err("Named Block[%d] = \"%s\"\n", j, named_memory_blocks[j]);
 		} else if ((strncmp(arg, "MEM=", 4) == 0) ||
 			   (strncmp(arg, "mem=", 4) == 0)) {
-			sscanf(arg + 4, "%llu", &MAX_MEMORY);
-			MAX_MEMORY <<= 20;
+			char mult = '?';
+			sscanf(arg + 4, "%llu%c", &MAX_MEMORY, &mult);
+			switch (mult) {
+				case 'M':
+				case '?':
+					MAX_MEMORY <<= 20;
+				case 'K':
+					MAX_MEMORY <<= 10;
+				default:
+					break;
+			}
 			if (MAX_MEMORY == 0)
 				MAX_MEMORY = 32ull << 30;
 		} else if (strncmp(arg, "rd_name=", 8) == 0) {
-- 
1.7.10.4

