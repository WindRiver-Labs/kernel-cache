From 484dfaec457152b394904a23cf6a65023d4a8b76 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Tue, 11 Dec 2012 13:45:41 -0800
Subject: [PATCH 264/337] netdev/octeon-ethernet: Allocate enough PKO command
 buffers.

Based On SDK 3.0.0-482

With lockless access we need at least 4 per queue.

Also get rid of USE_PACKET_POOL_FOR_OUTPUT_BUFFERS.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 drivers/net/ethernet/octeon/ethernet.c |   21 +++++++--------------
 1 files changed, 7 insertions(+), 14 deletions(-)

diff --git a/drivers/net/ethernet/octeon/ethernet.c b/drivers/net/ethernet/octeon/ethernet.c
index 3027e35..ece8db1 100644
--- a/drivers/net/ethernet/octeon/ethernet.c
+++ b/drivers/net/ethernet/octeon/ethernet.c
@@ -288,16 +288,14 @@ static __devinit int cvm_oct_configure_common_hw(void)
 	cvmx_ipd_set_wqe_pool_config(wqe_pool, FPA_WQE_POOL_SIZE,
 				     num_packet_buffers);
 
-#ifdef USE_PACKET_POOL_FOR_OUTPUT_BUFFERS
-	output_pool = packet_pool;
+	if (cvm_oct_pko_lockless()) {
+		cvm_oct_set_pko_multiqueue();
+		cvm_oct_num_output_buffers = 4 * cvm_oct_get_total_pko_queues();
+	} else {
+		cvm_oct_num_output_buffers = 128;
+	}
 
-	/* communicate output pool no. to pko */
-	cvmx_pko_set_cmd_que_pool_config(output_pool,
-					 FPA_PACKET_POOL_SIZE,
-					 num_packet_buffers);
-#else
 	/* alloc fpa pool for output buffers */
-	cvm_oct_num_output_buffers = 128;
 	output_pool = cvm_oct_alloc_fpa_pool(-1, FPA_OUTPUT_BUFFER_POOL_SIZE);
 	if (output_pool < 0) {
 		pr_err("cvm_oct_alloc_fpa_pool(FPA_OUTPUT_BUFFER_POOL, FPA_OUTPUT_BUFFER_POOL_SIZE) failed.\n");
@@ -309,14 +307,10 @@ static __devinit int cvm_oct_configure_common_hw(void)
 	cvmx_pko_set_cmd_que_pool_config(output_pool,
 					 FPA_OUTPUT_BUFFER_POOL_SIZE,
 					 cvm_oct_num_output_buffers);
-#endif
 
 	/* more configuration needs to be done, so enable ipd seperately */
 	cvmx_ipd_cfg.ipd_enable = 0;
 
-	if (cvm_oct_pko_lockless())
-		cvm_oct_set_pko_multiqueue();
-
 	cvmx_helper_initialize_packet_io_global();
 
 #ifdef __LITTLE_ENDIAN
@@ -1106,11 +1100,10 @@ static int __devexit cvm_oct_remove(struct platform_device *pdev)
 			      num_packet_buffers + num_devices_extra_wqe * PER_DEVICE_EXTRA_WQE);
 	cvm_oct_release_fpa_pool(wqe_pool);
 
-#ifndef USE_PACKET_POOL_FOR_OUTPUT_BUFFERS
 	cvm_oct_mem_empty_fpa(output_pool,
 				cvm_oct_num_output_buffers);
 	cvm_oct_release_fpa_pool(output_pool);
-#endif
+
 	cvm_oct_mem_cleanup();
 
 	return 0;
-- 
1.7.5.4

