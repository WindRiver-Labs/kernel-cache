From c7e5ee224422fccf230d462b3c9e6929f82bffb3 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 16 Jan 2013 16:44:12 -0800
Subject: [PATCH 325/337] netdev/octeon-ethernet: Enable hardware error
 reporting on SGMII and XAUI ports

Based On SDK 3.0.0-482

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 drivers/net/ethernet/octeon/ethernet-mdio.c   |    3 +++
 drivers/net/ethernet/octeon/ethernet-sgmii.c  |   22 ++++++++++++++++++++++
 drivers/net/ethernet/octeon/ethernet.c        |    2 ++
 drivers/net/ethernet/octeon/octeon-ethernet.h |    2 ++
 4 files changed, 29 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/octeon/ethernet-mdio.c b/drivers/net/ethernet/octeon/ethernet-mdio.c
index 670ad26..c96fb18 100644
--- a/drivers/net/ethernet/octeon/ethernet-mdio.c
+++ b/drivers/net/ethernet/octeon/ethernet-mdio.c
@@ -350,6 +350,9 @@ void cvm_oct_adjust_link(struct net_device *dev)
 
 		cvmx_helper_link_set(priv->ipd_port, link_info);
 
+		if (priv->link_change)
+			priv->link_change(priv, link_info);
+
 		cvm_oct_note_carrier(priv, link_info);
 	}
 }
diff --git a/drivers/net/ethernet/octeon/ethernet-sgmii.c b/drivers/net/ethernet/octeon/ethernet-sgmii.c
index c6768af..7d25ad9 100644
--- a/drivers/net/ethernet/octeon/ethernet-sgmii.c
+++ b/drivers/net/ethernet/octeon/ethernet-sgmii.c
@@ -113,10 +113,32 @@ int cvm_oct_sgmii_stop(struct net_device *dev)
 	return 0;
 }
 
+static void cvm_oct_sgmii_link_change(struct octeon_ethernet *priv,
+				      cvmx_helper_link_info_t link_info)
+{
+	if (link_info.s.link_up)
+		octeon_error_tree_enable(CVMX_ERROR_GROUP_ETHERNET,
+					 priv->ipd_port);
+	else
+		octeon_error_tree_disable(CVMX_ERROR_GROUP_ETHERNET,
+					  priv->ipd_port);
+}
+
 int cvm_oct_sgmii_init(struct net_device *dev)
 {
+	struct octeon_ethernet *priv = netdev_priv(dev);
+
 	cvm_oct_common_init(dev);
 	dev->netdev_ops->ndo_stop(dev);
+	priv->link_change = cvm_oct_sgmii_link_change;
 
 	return 0;
 }
+
+void cvm_oct_sgmii_uninit(struct net_device *dev)
+{
+	struct octeon_ethernet *priv = netdev_priv(dev);
+
+	octeon_error_tree_disable(CVMX_ERROR_GROUP_ETHERNET,
+				  priv->ipd_port);
+}
diff --git a/drivers/net/ethernet/octeon/ethernet.c b/drivers/net/ethernet/octeon/ethernet.c
index e180458..c86b943 100644
--- a/drivers/net/ethernet/octeon/ethernet.c
+++ b/drivers/net/ethernet/octeon/ethernet.c
@@ -682,6 +682,7 @@ static const struct net_device_ops cvm_oct_npi_netdev_ops = {
 /* SGMII and XAUI handled the same so they both use this. */
 static const struct net_device_ops cvm_oct_sgmii_netdev_ops = {
 	.ndo_init		= cvm_oct_sgmii_init,
+	.ndo_uninit		= cvm_oct_sgmii_uninit,
 	.ndo_open		= cvm_oct_sgmii_open,
 	.ndo_stop		= cvm_oct_sgmii_stop,
 	.ndo_start_xmit		= cvm_oct_xmit,
@@ -696,6 +697,7 @@ static const struct net_device_ops cvm_oct_sgmii_netdev_ops = {
 };
 static const struct net_device_ops cvm_oct_sgmii_lockless_netdev_ops = {
 	.ndo_init		= cvm_oct_sgmii_init,
+	.ndo_uninit		= cvm_oct_sgmii_uninit,
 	.ndo_open		= cvm_oct_sgmii_open,
 	.ndo_stop		= cvm_oct_sgmii_stop,
 	.ndo_start_xmit		= cvm_oct_xmit_lockless,
diff --git a/drivers/net/ethernet/octeon/octeon-ethernet.h b/drivers/net/ethernet/octeon/octeon-ethernet.h
index 9398f0a..abc39b6 100644
--- a/drivers/net/ethernet/octeon/octeon-ethernet.h
+++ b/drivers/net/ethernet/octeon/octeon-ethernet.h
@@ -90,6 +90,7 @@ struct octeon_ethernet {
 	/* Called periodically to check link status */
 	spinlock_t poll_lock;
 	void (*poll) (struct net_device *dev);
+	void (*link_change) (struct octeon_ethernet *, cvmx_helper_link_info_t);
 	struct delayed_work	port_periodic_work;
 	struct work_struct	port_work;	/* may be unused. */
 	struct device_node	*of_node;
@@ -113,6 +114,7 @@ int cvm_oct_rgmii_open(struct net_device *dev);
 int cvm_oct_rgmii_stop(struct net_device *dev);
 
 int cvm_oct_sgmii_init(struct net_device *dev);
+void cvm_oct_sgmii_uninit(struct net_device *dev);
 int cvm_oct_sgmii_open(struct net_device *dev);
 int cvm_oct_sgmii_stop(struct net_device *dev);
 
-- 
1.7.5.4

