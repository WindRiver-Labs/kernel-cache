From 65df97f85dbd51a967b81f33cc43f248fcd9361a Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 10 Jan 2013 11:40:39 -0800
Subject: [PATCH 302/337] netdev/octeon-ethernet: Add rx_cpu_factor parameter
 to control RX CPU usage.

Based On SDK 3.0.0-482

Tuning the rx_cpu_factor can affect throughput, and allows (somewhat)
latency to be managed.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 drivers/net/ethernet/octeon/ethernet-napi.c   |    2 +-
 drivers/net/ethernet/octeon/ethernet.c        |    5 +++++
 drivers/net/ethernet/octeon/octeon-ethernet.h |    1 +
 3 files changed, 7 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/octeon/ethernet-napi.c b/drivers/net/ethernet/octeon/ethernet-napi.c
index a94a114..44693f5 100644
--- a/drivers/net/ethernet/octeon/ethernet-napi.c
+++ b/drivers/net/ethernet/octeon/ethernet-napi.c
@@ -143,7 +143,7 @@ static int CVM_OCT_NAPI_POLL(struct napi_struct *napi, int budget)
 				counts.u64 = cvmx_read_csr(CVMX_POW_WQ_INT_CNTX(pow_receive_group));
 				backlog = counts.s.iq_cnt + counts.s.ds_cnt;
 			}
-			if (backlog > 16 * cores_in_use &&
+			if (backlog > rx_cpu_factor * cores_in_use &&
 			    napi != NULL &&
 			    cores_in_use < core_state.baseline_cores)
 				cvm_oct_enable_one_cpu();
diff --git a/drivers/net/ethernet/octeon/ethernet.c b/drivers/net/ethernet/octeon/ethernet.c
index 060c4ed..0b3747f 100644
--- a/drivers/net/ethernet/octeon/ethernet.c
+++ b/drivers/net/ethernet/octeon/ethernet.c
@@ -54,6 +54,11 @@
 #include <asm/octeon/cvmx-gmxx-defs.h>
 #include <asm/octeon/cvmx-smix-defs.h>
 
+int rx_cpu_factor = 8;
+module_param(rx_cpu_factor, int, S_IRUGO | S_IWUSR | S_IWGRP);
+MODULE_PARM_DESC(rx_cpu_factor, "Control how many CPUs are used for packet reception.\n"
+		 "\tLarger numbers result in fewer CPUs used.");
+
 int num_packet_buffers = 1024;
 module_param(num_packet_buffers, int, 0444);
 MODULE_PARM_DESC(num_packet_buffers, "\n"
diff --git a/drivers/net/ethernet/octeon/octeon-ethernet.h b/drivers/net/ethernet/octeon/octeon-ethernet.h
index a1f0f97..9398f0a 100644
--- a/drivers/net/ethernet/octeon/octeon-ethernet.h
+++ b/drivers/net/ethernet/octeon/octeon-ethernet.h
@@ -155,6 +155,7 @@ void cvm_oct_mem_cleanup(void);
 
 extern const struct ethtool_ops cvm_oct_ethtool_ops;
 
+extern int rx_cpu_factor;
 extern int packet_pool;
 extern int wqe_pool;
 extern int output_pool;
-- 
1.7.5.4

