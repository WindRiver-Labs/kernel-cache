From 90db7b2e21ad7a45f60c4f1ffef6af80479a095b Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 29 Sep 2011 14:54:40 -0700
Subject: [PATCH 322/337] MIPS: Only generate the TLB refill handler once on
 SMP machines.

Based On SDK 3.0.0-482

... Well really once per ebase, but for most systems that is once.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/mm/tlbex.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/arch/mips/mm/tlbex.c b/arch/mips/mm/tlbex.c
index 2f47179..f06993d 100644
--- a/arch/mips/mm/tlbex.c
+++ b/arch/mips/mm/tlbex.c
@@ -2133,6 +2133,7 @@ void __cpuinit build_tlb_refill_handler(void)
 	 * needed once.
 	 */
 	static int run_once = 0;
+	static unsigned long last_ebase;
 
 #ifdef CONFIG_64BIT
 	check_for_high_segbits = current_cpu_data.vmbits > (PGDIR_SHIFT + PGD_ORDER + PAGE_SHIFT - 3);
@@ -2179,7 +2180,10 @@ void __cpuinit build_tlb_refill_handler(void)
 			build_r4000_tlb_modify_handler();
 			run_once++;
 		}
-		build_r4000_tlb_refill_handler();
+		if (last_ebase != ebase) {
+			build_r4000_tlb_refill_handler();
+			last_ebase = ebase;
+		}
 	}
 }
 
-- 
1.7.5.4

