From 053ed699c53248deedbd458e0fa03fd42b5d40ab Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 23 Jan 2013 11:11:17 -0800
Subject: [PATCH 336/337] MIPS: OCTEON: Fix OOPS in octeon-hw-status.

Based On SDK 3.0.0-482

If there is an interrupt in the middle of a
octeon_hw_status_remove_source() we were attempting to interpret the
hwint value as a register address and accessing the (false)register.
Don't try register accesses if is_hwint is set.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/cavium-octeon/octeon-hw-status.c      |   34 +++++++++++++---------
 arch/mips/include/asm/octeon/octeon-hw-status.h |    1 +
 2 files changed, 21 insertions(+), 14 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-hw-status.c b/arch/mips/cavium-octeon/octeon-hw-status.c
index 71b3b6b..706e503 100644
--- a/arch/mips/cavium-octeon/octeon-hw-status.c
+++ b/arch/mips/cavium-octeon/octeon-hw-status.c
@@ -146,23 +146,29 @@ static int irq_cb(struct octeon_hw_status_node *n, void *arg)
 	struct octeon_hw_status_data ohsd;
 	struct irq_cb_data *d = arg;
 
-	bit_mask = 1ull << n->bit;
-	csr = cvmx_read_csr(n->reg);
-	if (!(csr & bit_mask))
-		return 0;
-
-	if (n->mask_reg) {
-		en = cvmx_read_csr(n->mask_reg);
-		if (!(en & bit_mask))
+	memset(&ohsd, 0, sizeof(ohsd));
+
+	if (n->is_hwint) {
+		ohsd.reg = n->hwint;
+		ohsd.reg_is_hwint = 1;
+	} else {
+		bit_mask = 1ull << n->bit;
+		csr = cvmx_read_csr(n->reg);
+		if (!(csr & bit_mask))
 			return 0;
-	}
-	/* Found an enabled source. */
 
-	if (n->ack_w1c)
-		cvmx_write_csr(n->reg, bit_mask);
+		if (n->mask_reg) {
+			en = cvmx_read_csr(n->mask_reg);
+			if (!(en & bit_mask))
+				return 0;
+		}
+		/* Found an enabled source. */
+		if (n->ack_w1c)
+			cvmx_write_csr(n->reg, bit_mask);
 
-	ohsd.reg = n->reg;
-	ohsd.bit = n->bit;
+		ohsd.reg = n->reg;
+		ohsd.bit = n->bit;
+	}
 	raw_notifier_call_chain(&octeon_hw_status_notifiers,
 				OCTEON_HW_STATUS_SOURCE_ASSERTED, &ohsd);
 	d->handled_one = true;
diff --git a/arch/mips/include/asm/octeon/octeon-hw-status.h b/arch/mips/include/asm/octeon/octeon-hw-status.h
index 7626cea..6593319 100644
--- a/arch/mips/include/asm/octeon/octeon-hw-status.h
+++ b/arch/mips/include/asm/octeon/octeon-hw-status.h
@@ -24,6 +24,7 @@ struct octeon_hw_status_reg {
 struct octeon_hw_status_data {
 	u64 reg;
 	u32 bit;
+	u8 reg_is_hwint:1;
 };
 
 int octeon_hw_status_notifier_register(struct notifier_block *nb);
-- 
1.7.5.4

