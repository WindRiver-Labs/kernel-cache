From 022fdc68631e7a85b629e19c2d5b8ea13c69b3fc Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Mon, 14 Jan 2013 15:56:29 -0800
Subject: [PATCH 308/337] MIPS: OCTEON: Use IRQF_ONESHOT for the HW status irq
 handler.

Based On SDK 3.0.0-482

This thing is threaded.  So we cannot be unmasking until the handler
completes.

Release the write lock before enabling the interrupts.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/cavium-octeon/octeon-hw-status.c |   12 ++++++------
 1 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-hw-status.c b/arch/mips/cavium-octeon/octeon-hw-status.c
index 63224cb..d8a6253 100644
--- a/arch/mips/cavium-octeon/octeon-hw-status.c
+++ b/arch/mips/cavium-octeon/octeon-hw-status.c
@@ -237,19 +237,19 @@ int octeon_hw_status_add_source(struct octeon_hw_status_reg *chain)
 	w->users++;
 	WARN(w->users == 0, "Reference count overflowed!");
 
+	write_unlock(&octeon_hw_status_lock);
+
 	if (root_created) {
 		/* register an interrupt handler */
 		root->irq = irq_create_mapping(NULL, root->hwint);
-		if (!root->irq) {
-			rv = -ENXIO;
-			goto out;
-		}
+		if (!root->irq)
+			return -ENXIO;
+
 		rv = request_threaded_irq(root->irq, NULL, octeon_hw_status_irq,
-					  0, "octeon-hw-status", root);
+					  IRQF_ONESHOT, "octeon-hw-status", root);
 		WARN(rv, "request_threaded_irq failed: %d", rv);
 	}
 
-	write_unlock(&octeon_hw_status_lock);
 	ohsd.reg = w->reg;
 	ohsd.bit = w->bit;
 	raw_notifier_call_chain(&octeon_hw_status_notifiers,
-- 
1.7.5.4

