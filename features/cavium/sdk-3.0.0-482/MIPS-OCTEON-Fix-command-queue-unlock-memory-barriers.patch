From 96461540c1bb1c1821579c226646262fae247da3 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 31 Oct 2012 16:19:50 -0700
Subject: [PATCH 216/337] MIPS: OCTEON: Fix command queue unlock memory
 barriers.

Based On SDK 3.0.0-482

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: Corey Minyard <cminyard@mvista.com>
Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/include/asm/octeon/cvmx-cmd-queue.h |    8 ++++++--
 1 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/arch/mips/include/asm/octeon/cvmx-cmd-queue.h b/arch/mips/include/asm/octeon/cvmx-cmd-queue.h
index 614653b..8b89a71 100644
--- a/arch/mips/include/asm/octeon/cvmx-cmd-queue.h
+++ b/arch/mips/include/asm/octeon/cvmx-cmd-queue.h
@@ -286,8 +286,12 @@ static inline void __cvmx_cmd_queue_lock(cvmx_cmd_queue_id_t queue_id,
  */
 static inline void __cvmx_cmd_queue_unlock(__cvmx_cmd_queue_state_t *qptr)
 {
-	qptr->now_serving++;
-	CVMX_SYNCWS;
+	uint8_t ns;
+
+	ns = qptr->now_serving + 1;
+	CVMX_SYNCWS;		/* Order queue manipulation with respect to the unlock.  */
+	qptr->now_serving = ns;
+	CVMX_SYNCWS;		/* nudge out the unlock. */
 }
 
 /**
-- 
1.7.5.4

