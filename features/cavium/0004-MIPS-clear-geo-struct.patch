From ddf8e9a7c451256ecebffded7ca0bfe0844ce1dc Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Fri, 18 Oct 2013 11:06:01 +0800
Subject: [PATCH 4/7] MIPS: clear geo struct

If a driver doesn't define getgeo function, some user applications,
such as fdisk, assume all geo data copied from Kernel are zero.
So Kernel must be responsible for clearing geo struct before copying it to
user space, else sometimes it would contains the previous stack data and copy
the illegal data to user space, the application will have undefined results.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 block/compat_ioctl.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/block/compat_ioctl.c b/block/compat_ioctl.c
index 7c668c8..a881fde 100644
--- a/block/compat_ioctl.c
+++ b/block/compat_ioctl.c
@@ -54,6 +54,8 @@ static int compat_hdio_getgeo(struct gendisk *disk, struct block_device *bdev,
 	struct hd_geometry geo;
 	int ret;
 
+	memset(&geo, 0, sizeof(geo));
+
 	if (!ugeo)
 		return -EINVAL;
 	if (!disk->fops->getgeo)
-- 
1.7.0.4

