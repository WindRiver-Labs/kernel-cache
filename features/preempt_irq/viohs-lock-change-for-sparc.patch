From 054c316b4408e56b885fc60dcf1bca84a34c0f05 Mon Sep 17 00:00:00 2001
From: Hong H. Pham <hong.pham@windriver.com>
Date: Tue, 20 Jan 2009 10:17:12 -0500
Subject: [PATCH] preempt_irq: viohs lock change for sparc

Use raw spinlocks instead of regular spinlocks to avoid "scheduling while
atomic" warnings when the various SUN4V LDOM drivers initialize.

Signed-off-by: Hong H. Pham <hong.pham@windriver.com>
---
 arch/sparc64/kernel/viohs.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/arch/sparc64/kernel/viohs.c b/arch/sparc64/kernel/viohs.c
index 708fa17..7bfd818 100644
--- a/arch/sparc64/kernel/viohs.c
+++ b/arch/sparc64/kernel/viohs.c
@@ -738,7 +738,8 @@ void vio_port_up(struct vio_driver_state *vio)
 	unsigned long flags;
 	int err, state;
 
-	spin_lock_irqsave(&vio->lock, flags);
+	local_irq_save(flags);
+	_raw_spin_lock(&vio->lock);
 
 	state = ldc_state(vio->lp);
 
@@ -765,7 +766,8 @@ void vio_port_up(struct vio_driver_state *vio)
 		mod_timer(&vio->timer, expires);
 	}
 
-	spin_unlock_irqrestore(&vio->lock, flags);
+	_raw_spin_unlock(&vio->lock);
+	local_irq_restore(flags);
 }
 EXPORT_SYMBOL(vio_port_up);
 
-- 
1.6.0.3

