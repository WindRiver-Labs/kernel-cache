From 4c4856f5e4d583aa79ebc618c00c6677cd8b8bff Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Wed, 8 Oct 2008 14:54:12 -0400
Subject: [PATCH] [PATCH] This snippet is buried in the preempt-realtime-core.patch but clearly is

From 9579c9f7a0506b5692c75eb2434ec351bdb8a6e5 Mon Sep 17 00:00:00 2001
Subject: [PATCH] This snippet is buried in the preempt-realtime-core.patch but clearly is
 required for basic soft/hardirq threading.
---
 include/linux/hardirq.h |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/include/linux/hardirq.h b/include/linux/hardirq.h
index b39f49d..9928466 100644
--- a/include/linux/hardirq.h
+++ b/include/linux/hardirq.h
@@ -76,9 +76,9 @@
  * Are we doing bottom half or hardware interrupt processing?
  * Are we in a softirq context? Interrupt context?
  */
-#define in_irq()		(hardirq_count())
-#define in_softirq()		(softirq_count())
-#define in_interrupt()		(irq_count())
+#define in_irq()	(hardirq_count() || (current->flags & PF_HARDIRQ))
+#define in_softirq()	(softirq_count() || (current->flags & PF_SOFTIRQ))
+#define in_interrupt()	(irq_count())
 #define in_nmi()		(hardnmi_count())
 
 #if defined(CONFIG_PREEMPT)
-- 
1.5.5.1

