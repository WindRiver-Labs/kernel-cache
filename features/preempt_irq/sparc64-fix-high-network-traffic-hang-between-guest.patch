From 1a12442e8856fd26846bdb5d68d508819f0ebde8 Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Thu, 16 Apr 2009 16:38:59 +0800
Subject: [PATCH] sparc64: fix high-network-traffic hang between guest domains

Moderately high network traffic between two Linux guest domains
(on the same physical machine, under the Sun hypervisor) would
hang both domains.  To avoid this, we disable hard IRQ preemption
for the logical domain channel rx and tx interrupts.

Signed-off-by: Boban Petrovic <boban.petrovic@windriver.com>
Signed-off-by: Chris Torek <chris.torek@windriver.com>
---
 arch/sparc64/kernel/ldc.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/arch/sparc64/kernel/ldc.c b/arch/sparc64/kernel/ldc.c
index d689823..a6b75cd 100644
--- a/arch/sparc64/kernel/ldc.c
+++ b/arch/sparc64/kernel/ldc.c
@@ -1243,13 +1243,13 @@ int ldc_bind(struct ldc_channel *lp, const char *name)
 	snprintf(lp->tx_irq_name, LDC_IRQ_NAME_MAX, "%s TX", name);
 
 	err = request_irq(lp->cfg.rx_irq, ldc_rx,
-			  IRQF_SAMPLE_RANDOM | IRQF_SHARED,
+			  IRQF_SAMPLE_RANDOM | IRQF_SHARED | IRQF_NODELAY,
 			  lp->rx_irq_name, lp);
 	if (err)
 		return err;
 
 	err = request_irq(lp->cfg.tx_irq, ldc_tx,
-			  IRQF_SAMPLE_RANDOM | IRQF_SHARED,
+			  IRQF_SAMPLE_RANDOM | IRQF_SHARED | IRQF_NODELAY,
 			  lp->tx_irq_name, lp);
 	if (err) {
 		free_irq(lp->cfg.rx_irq, lp);
-- 
1.6.0.4

