From 167e453cd8b7bbf5272a0b9067d0ff27bbfea861 Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Wed, 8 Oct 2008 14:53:21 -0400
Subject: [PATCH] [PATCH] patch smp-processor-id-fixups.patch

From d6259fa05d6981328687288c1b3b502b62e466da Mon Sep 17 00:00:00 2001
Subject: [PATCH] patch smp-processor-id-fixups.patch
---
 include/linux/netpoll.h |    2 +-
 kernel/hrtimer.c        |    5 ++++-
 kernel/workqueue.c      |    2 +-
 3 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/include/linux/netpoll.h b/include/linux/netpoll.h
index 80e166a..5906882 100644
--- a/include/linux/netpoll.h
+++ b/include/linux/netpoll.h
@@ -77,7 +77,7 @@ static inline void *netpoll_poll_lock(struct napi_struct *napi)
 	rcu_read_lock(); /* deal with race on ->npinfo */
 	if (dev && dev->npinfo) {
 		spin_lock(&napi->poll_lock);
-		napi->poll_owner = smp_processor_id();
+		napi->poll_owner = raw_smp_processor_id();
 		return napi;
 	}
 	return NULL;
diff --git a/kernel/hrtimer.c b/kernel/hrtimer.c
index 6700d9a..54d0c3f 100644
--- a/kernel/hrtimer.c
+++ b/kernel/hrtimer.c
@@ -1380,7 +1380,10 @@ void hrtimer_interrupt(struct clock_event_device *dev)
 
 static void run_hrtimer_softirq(struct softirq_action *h)
 {
-	run_hrtimer_pending(&__get_cpu_var(hrtimer_bases));
+	struct hrtimer_cpu_base *cpu_base;
+
+	cpu_base = &per_cpu(hrtimer_bases, raw_smp_processor_id());
+	run_hrtimer_pending(cpu_base);
 }
 
 #endif	/* CONFIG_HIGH_RES_TIMERS */
diff --git a/kernel/workqueue.c b/kernel/workqueue.c
index 0a67192..3777efa 100644
--- a/kernel/workqueue.c
+++ b/kernel/workqueue.c
@@ -209,7 +209,7 @@ static void delayed_work_timer_fn(unsigned long __data)
 	struct cpu_workqueue_struct *cwq = get_wq_data(&dwork->work);
 	struct workqueue_struct *wq = cwq->wq;
 
-	__queue_work(wq_per_cpu(wq, smp_processor_id()), &dwork->work);
+	__queue_work(wq_per_cpu(wq, raw_smp_processor_id()), &dwork->work);
 }
 
 /**
-- 
1.5.5.1

