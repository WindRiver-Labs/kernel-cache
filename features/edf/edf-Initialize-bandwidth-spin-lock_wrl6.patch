From 46c90471079fec403c1d8ece8b01f69c2b01a38c Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Thu, 8 May 2014 11:57:20 +0800
Subject: [PATCH] edf: Initialize bandwidth spin lock

When enable SMP and DEBUG_SPINLOCK, spin lock has no initializing:
[ 0.000000] Call Trace:
[ 0.000000] [<c15835e9>] spin_dump+0x97/0x9f
[ 0.000000] [<c158360c>] spin_bug+0x1b/0x1f
[ 0.000000] [<c12d74f0>] do_raw_spin_lock+0xf0/0x120
[ 0.000000] [<c1589679>] _raw_spin_lock+0x49/0x50
[ 0.000000] [<c10770cc>] ? init_dl_bw+0x2c/0xa0
[ 0.000000] [<c10770cc>] init_dl_bw+0x2c/0xa0
[ 0.000000] [<c184d545>] ? sched_init+0x1d/0x4a6
[ 0.000000] [<c1062eff>] init_rootdomain+0x1f/0x50
[ 0.000000] [<c184d572>] sched_init+0x4a/0x4a6
[ 0.000000] [<c12d73d2>] ? __raw_spin_lock_init+0x32/0x60
[ 0.000000] [<c1853276>] ? vmalloc_init+0x45/0xbc
[ 0.000000] [<c18395be>] start_kernel+0x192/0x349
[ 0.000000] [<c1839269>] ? repair_env_string+0x51/0x51
[ 0.000000] [<c1839098>] i386_start_kernel+0x98/0x9f
[ 0.000000] Hierarchical RCU implementation.

Signed-off-by: Li Wang <li.wang@windriver.com>
---
 kernel/sched/core.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/kernel/sched/core.c b/kernel/sched/core.c
index f7a28a1..d364345 100644
--- a/kernel/sched/core.c
+++ b/kernel/sched/core.c
@@ -7383,13 +7383,13 @@ void __init sched_init(void)
 #endif /* CONFIG_CPUMASK_OFFSTACK */
 	}
 
+	init_dl_bandwidth(&def_dl_bandwidth, actual_dl_runtime());
 #ifdef CONFIG_SMP
 	init_defrootdomain();
 #endif
 
 	init_rt_bandwidth(&def_rt_bandwidth,
 			global_rt_period(), global_rt_runtime());
-	init_dl_bandwidth(&def_dl_bandwidth, actual_dl_runtime());
 
 #ifdef CONFIG_RT_GROUP_SCHED
 	init_rt_bandwidth(&root_task_group.rt_bandwidth,
-- 
1.7.9.5

