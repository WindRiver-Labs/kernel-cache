From 5d82ef470dec78ac1dce6223d4ec32d41eac0549 Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Fri, 21 Jan 2011 15:09:42 +0800
Subject: [PATCH 15/15] sched: compute ktime with negative number correctly

ktime_add_ns() uses u64 for its nsec parameter so calling it with a negative
nsec value will not give you the expected result. Instead we need to make use
of ktime_sub_ns().

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 kernel/sched_dl.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/kernel/sched_dl.c b/kernel/sched_dl.c
index 49a11d4..4dd3418 100644
--- a/kernel/sched_dl.c
+++ b/kernel/sched_dl.c
@@ -256,7 +256,10 @@ static int start_dl_timer(struct sched_dl_entity *dl_se, u64 wakeup)
 	act = ns_to_ktime(wakeup);
 	now = hrtimer_cb_get_time(&dl_se->dl_timer);
 	delta = ktime_to_ns(now) - rq->clock;
-	act = ktime_add_ns(act, delta);
+	if(delta < 0)
+		act = ktime_sub_ns(act, (-delta));
+	else
+		act = ktime_add_ns(act, delta);
 
 	/*
 	 * If the expiry time already passed, e.g., because the value
-- 
1.7.0.4

