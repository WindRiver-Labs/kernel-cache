From 024df92b337321d549fb75f3814f11052edf5510 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Tue, 25 Sep 2012 12:18:27 -0700
Subject: [PATCH 16/16] sched: compute ktime with negative number correctly

ktime_add_ns() uses u64 for its nsec parameter so calling it with a negative
nsec value will not give you the expected result. Instead we need to make use
of ktime_sub_ns().

Signed-off-by: Liming Wang <liming.wang@windriver.com>
Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 kernel/sched/dl.c |    5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/kernel/sched/dl.c b/kernel/sched/dl.c
index 3e28ed3..aa8b301 100644
--- a/kernel/sched/dl.c
+++ b/kernel/sched/dl.c
@@ -446,7 +446,10 @@ static int start_dl_timer(struct sched_dl_entity *dl_se, bool boosted)
 	act = ns_to_ktime(dl_se->deadline);
 	now = hrtimer_cb_get_time(&dl_se->dl_timer);
 	delta = ktime_to_ns(now) - rq->clock;
-	act = ktime_add_ns(act, delta);
+	if(delta < 0)
+		act = ktime_sub_ns(act, (-delta));
+	else
+		act = ktime_add_ns(act, delta);
 
 	/*
 	 * If the expiry time already passed, e.g., because the value
-- 
1.7.9.7

