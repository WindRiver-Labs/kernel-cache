From 605c0ca82a1fba4fd84c7832c2d2ea009ec3eb1d Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Sun, 1 Feb 2009 17:12:08 +0800
Subject: [PATCH] kmemtrace: Make kmemtrace work on PPC64(UP or SMP), PPC32 SMP and MIPS SMP

Although the issues was only reported to appear on
emer_atca6101(PPC64 SMP), based on lots of my
experiments on different type boards, I found
kmemtrace doesn't work on PPC32 SMP, PPC64 UP/SMP
and MIPS32/64 SMP boards, the root cause of which
is the initialization sequence among kmemtrace_init,
pgtable_cache_init() and smp_init() which are invoked
in the file: init/main.c.

1. The function pgtable_cache_init() is not empty
only in PPC64 arch, which is nontrivial to memory
management, if wants to make kmemtrace work on PPC64
boards, must invoke kmemtrace_init() after invoking
pgtable_cache_init() during system init series.

2. On PPC32/64 SMP and MIPS32/64 SMP board, the global
variable: cpu_online_mask is set in smp_init() to mark
how many cpus run in system.

kmemtrace bases on two lower level subsystems: relay
and marker, and it has two initialization function:
kmemtrace_init() and  kmemtrace_setup_late(), the former
is inovked firtsly and before smp_init() to allocate
required memory buffers for every CPU according to
cpu_online_mask, the latter is invoked after smp_init()
to use memory buffers allocated in kmemtrace_init() to do
further initialization for every CPU as per cpu_online_mask.

Because the number of CPU conveyed in cpu_online_mask
between before and after invoking smp_init() is different,
during running kmemtrace_setup_late(), will produce a kernel
panic for lacking CPU specific buffer except for CPU0.

Obviously, moving kmemtrace_init() to after smp_init() is
the very most simple solution to above stated two kernel
panic issues for all different CPU type platfroms.

Signed-off-by: Andrew Liu <shengping.liu@windriver.com>
---
 init/main.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/init/main.c b/init/main.c
index a3f508e..de0e452 100644
--- a/init/main.c
+++ b/init/main.c
@@ -669,8 +669,6 @@ asmlinkage void __init start_kernel(void)
 	init_early_trace();
 #endif
 
-	kmemtrace_init();
-
 	debug_objects_mem_init();
 	idr_init_cache();
 	setup_per_cpu_pageset();
@@ -964,6 +962,9 @@ static int __init kernel_init(void * unused)
 	do_pre_smp_initcalls();
 
 	smp_init();
+
+	kmemtrace_init();
+
 	sched_init_smp();
 
 	cpuset_init_smp();
-- 
1.6.0.3

