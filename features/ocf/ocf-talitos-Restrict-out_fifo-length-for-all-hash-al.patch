From 763e0db2a7de4e538b1ec60c498515a70f8f4136 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Thu, 10 Nov 2011 13:31:55 +0800
Subject: [PATCH 1/2] ocf/talitos: Restrict out_fifo length for all hash algorithm

commit "ocf/talitos: Workaround for SEC generate AE interrupt
when run md5/sha1 benchmark program" add workaround for doing
MD5/SHA1 hash algorithm, this workaround should be also applied
to MD5_HMAC/SHA1_HMAC algorithm, so restricting out_fifo length
for all hash algorithm to avoid MEDU generating error interrupt
although it may increase the chance of collisions.

Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 crypto/ocf/talitos/talitos.c |   27 +++++++++++----------------
 1 files changed, 11 insertions(+), 16 deletions(-)

diff --git a/crypto/ocf/talitos/talitos.c b/crypto/ocf/talitos/talitos.c
index 4bf5928..320ae5b 100644
--- a/crypto/ocf/talitos/talitos.c
+++ b/crypto/ocf/talitos/talitos.c
@@ -840,17 +840,20 @@ talitos_process(device_t dev, struct cryptop *crp, int hint)
 		td->hdr |= TALITOS_SEL0_MDEU
 				|  TALITOS_MODE0_MDEU_INIT
 				|  TALITOS_MODE0_MDEU_PAD;
+
+		/* 
+		 * MDEU is unhappy when the len of out_fifo is bigger
+		 * than 32 bytes, as the output of MD5 is 128 bits and 
+		 * the output of SHA1 is 160 bits, we restrict out_fifo 
+		 * len to 32 bytes so as to make MDEU don't generate 
+		 * error interrupt.
+		 */
+		if (td->ptr[out_fifo].len > MDEU_UPSET_THRESHOLD)
+			td->ptr[out_fifo].len = MDEU_UPSET_THRESHOLD;
+
 		switch (maccrd->crd_alg) {
 			case	CRYPTO_MD5:	
 				td->hdr |= TALITOS_MODE0_MDEU_MD5;
-				/* 
-				 * MDEU is unhappy when the len of out_fifo is bigger
-				 * than 32 bytes, as the output of MD5 is 128 bits, we
-				 * restrict out_fifo len to 32 bytes so as to make MDEU
-				 * don't generate error interrupt.
-				 */ 
-				if (td->ptr[out_fifo].len > MDEU_UPSET_THRESHOLD)
-					td->ptr[out_fifo].len = MDEU_UPSET_THRESHOLD;
 				DPRINTF("MD5  ses %d ch %d len %d\n",
 					(u32)TALITOS_SESSION(crp->crp_sid), 
 					chsel, td->ptr[in_fifo].len);
@@ -860,14 +863,6 @@ talitos_process(device_t dev, struct cryptop *crp, int hint)
 				break;
 			case	CRYPTO_SHA1:	
 				td->hdr |= TALITOS_MODE0_MDEU_SHA1;
-				/* 
-				 * MDEU is unhappy when the len of out_fifo is bigger
-				 * than 32 bytes, as the output of SHA1 is 160 bits, we
-				 * restrict out_fifo len to 32 bytes so as to make MDEU
-				 * don't generate error interrupt.
-				 */
-				if (td->ptr[out_fifo].len > MDEU_UPSET_THRESHOLD)
-					td->ptr[out_fifo].len = MDEU_UPSET_THRESHOLD;
 				DPRINTF("SHA1 ses %d ch %d len %d\n",
 					(u32)TALITOS_SESSION(crp->crp_sid), 
 					chsel, td->ptr[in_fifo].len);
-- 
1.7.0.4

