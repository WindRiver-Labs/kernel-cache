From 0e5095beb4ab6a911e6ec9a3947cc2ee04781efe Mon Sep 17 00:00:00 2001
From: Phil Staub <Phil.Staub@windriver.com>
Date: Fri, 12 Oct 2012 13:11:28 -0700
Subject: [PATCH 4/8] drivers: staging: cdv: Make the per-driver
 file_operations struct const

The DRM layer keeps a copy of struct file_operations inside its
big driver struct... which prevents it from being consistent and static.
For consistency (and the general security objective of having such things
static), it's desirable to get this fixed.

This patch splits out the file_operations field to its own struct,
which is then "static const", and just stick a pointer to this into
the driver struct, making it more consistent with how the rest of the
kernel does this.

Signed-off-by: Phil Staub <Phil.Staub@windriver.com>
Signed-off-by: Liang Li <liang.li@windriver.com>
---
 drivers/staging/cdv/drv/psb_drv.c |   23 +++++++++++++----------
 1 file changed, 13 insertions(+), 10 deletions(-)

diff --git a/drivers/staging/cdv/drv/psb_drv.c b/drivers/staging/cdv/drv/psb_drv.c
index 3159169..f00bf78 100644
--- a/drivers/staging/cdv/drv/psb_drv.c
+++ b/drivers/staging/cdv/drv/psb_drv.c
@@ -1809,6 +1809,18 @@ static const struct dev_pm_ops psb_pm_ops = {
         .runtime_idle = psb_runtime_idle,
 };
 
+static const struct file_operations psb_driver_fops = {
+	.owner = THIS_MODULE,
+	.open = psb_open,
+	.release = psb_release,
+	.unlocked_ioctl = drm_ioctl,
+	.mmap = psb_mmap,
+	.poll = psb_poll,
+	.fasync = drm_fasync,
+	.read = drm_read,
+	.llseek = noop_llseek,
+};
+
 static struct drm_driver driver = {
 	.driver_features = DRIVER_HAVE_IRQ | DRIVER_IRQ_SHARED | \
 			   DRIVER_IRQ_VBL | DRIVER_MODESET,
@@ -1832,16 +1844,7 @@ static struct drm_driver driver = {
 	.suspend = PVRSRVDriverSuspend,
 	.resume = PVRSRVDriverResume,
 	.preclose = psb_driver_preclose,
-	.fops = {
-		 .owner = THIS_MODULE,
-		 .open = psb_open,
-		 .release = psb_release,
-		 .unlocked_ioctl = drm_ioctl,
-		 .mmap = psb_mmap,
-		 .poll = psb_poll,
-		 .fasync = drm_fasync,
-		 .read = drm_read,
-		 },
+	.fops = &psb_driver_fops,
 	.name = DRIVER_NAME,
 	.desc = DRIVER_DESC,
 	.date = PSB_DRM_DRIVER_DATE,
-- 
1.7.9.7

