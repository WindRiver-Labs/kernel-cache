From fba151cb6b701fbce29e6fd0e72ffeff2b2535b9 Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Mon, 8 Jun 2009 14:06:12 +0800
Subject: [PATCH 08/21] Save rbp in interrupt stack when oprofile was configured

Common irq handler needn't rbp but oprofile needs it to backtrace
the user space stack. So just save the rbp when oprofile was configured.

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
Integrated-by: Liming Wang <liming.wang@windriver.com>
---
 arch/x86/kernel/entry_64.S |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/x86/kernel/entry_64.S b/arch/x86/kernel/entry_64.S
index 1f9fecc..88d0d8c 100644
--- a/arch/x86/kernel/entry_64.S
+++ b/arch/x86/kernel/entry_64.S
@@ -329,6 +329,12 @@ ENTRY(save_args)
 
 	leaq -ARGOFFSET+16(%rsp),%rdi	/* arg1 for handler */
 	movq_cfi rbp, 8		/* push %rbp */
+#if defined(CONFIG_OPROFILE) || defined(CONFIG_OPROFILE_MODULE)
+        /*
+         * Save the rbp to let oprofile backtrace the user stack
+        */
+        movq %rbp, -8(%rsp)
+#endif
 	leaq 8(%rsp), %rbp		/* mov %rsp, %ebp */
 	testl $3, CS(%rdi)
 	je 1f
-- 
1.6.5.2

