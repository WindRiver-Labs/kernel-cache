From 0cea68393f86230abe486eade5d86fddd6810167 Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Tue, 11 Sep 2012 20:59:35 -0400
Subject: [PATCH 01/11] kernel/sys.c: Introduce ALWAYS_RESTART config option

If enabled, Force the system to restart instead of halt or power
off.

Signed-off-by: Liming Wang <liming.wang@windriver.com>
Integrated-by: Yong Zhang <yong.zhang@windriver.com>
Signed-off-by: Joe MacDonald <joe.macdonald@windriver.com>
---
 init/Kconfig   |    9 +++++++++
 kernel/panic.c |    3 +++
 kernel/sys.c   |   12 ++++++++++++
 3 files changed, 24 insertions(+)

diff --git a/init/Kconfig b/init/Kconfig
index 96d9e6c..336a46c 100644
--- a/init/Kconfig
+++ b/init/Kconfig
@@ -1307,6 +1307,15 @@ config PCI_QUIRKS
           bugs/quirks. Disable this only if your target machine is
           unaffected by PCI quirks.
 
+config ALWAYS_RESTART
+	default n
+	bool "Force the system to restart instead of halt or power off"
+	help
+	  This effectively disables the ability for the system to halt.  Instead a
+	  restart will happen under any circumstances.  This is mostly of use to
+	  systems that need to come back up immediately regardless of the reason it
+	  went down (eg. unattended systems in remote locations).
+
 config SLUB_DEBUG
 	default y
 	bool "Enable SLUB debugging support" if EXPERT
diff --git a/kernel/panic.c b/kernel/panic.c
index 4e5dcbb..1c3dc59 100644
--- a/kernel/panic.c
+++ b/kernel/panic.c
@@ -171,6 +171,9 @@ void panic(const char *fmt, ...)
 		disabled_wait(caller);
 	}
 #endif
+#ifdef CONFIG_ALWAYS_RESTART
+	machine_restart(NULL);
+#endif
 	local_irq_enable();
 	for (i = 0; ; i += PANIC_TIMER_STEP) {
 		touch_softlockup_watchdog();
diff --git a/kernel/sys.c b/kernel/sys.c
index 2185992..7d4cd9e 100644
--- a/kernel/sys.c
+++ b/kernel/sys.c
@@ -397,9 +397,15 @@ void kernel_halt(void)
 {
 	kernel_shutdown_prepare(SYSTEM_HALT);
 	syscore_shutdown();
+#ifdef CONFIG_ALWAYS_RESTART
+	printk(KERN_EMERG "System restarting.\n");
+	kmsg_dump(KMSG_DUMP_RESTART);
+	machine_restart(NULL);
+#else
 	printk(KERN_EMERG "System halted.\n");
 	kmsg_dump(KMSG_DUMP_HALT);
 	machine_halt();
+#endif
 }
 
 EXPORT_SYMBOL_GPL(kernel_halt);
@@ -416,9 +422,15 @@ void kernel_power_off(void)
 		pm_power_off_prepare();
 	disable_nonboot_cpus();
 	syscore_shutdown();
+#ifdef CONFIG_ALWAYS_RESTART
+	printk(KERN_EMERG "System now powering down, restarting.\n");
+	kmsg_dump(KMSG_DUMP_RESTART);
+	machine_restart(NULL);
+#else
 	printk(KERN_EMERG "Power down.\n");
 	kmsg_dump(KMSG_DUMP_POWEROFF);
 	machine_power_off();
+#endif
 }
 EXPORT_SYMBOL_GPL(kernel_power_off);
 
-- 
1.7.9.7

