From 76dc96bacc73eeb0cb53cc1e2e133b9325dd92ff Mon Sep 17 00:00:00 2001
From: Han Chao <chan@windriver.com>
Date: Mon, 17 Mar 2014 16:21:04 +0800
Subject: [PATCH 04/16] grsec: allow write access to process vm.

Allow kgdb access to process memory, and use the normal GRSecurity
logging mechanism to report failed connect attempts.

Signed-off-by: Joe MacDonald <joe.macdonald@windriver.com>
Signed-off-by: Benjamin Walsh <benjamin.walsh@windriver.com>
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
Signed-off-by: Han Chao <chan@windriver.com>
---
 include/linux/grmsg.h |    1 +
 mm/memory.c           |   22 ++++++++++++++++++++++
 security/Kconfig      |    9 +++++++++
 3 files changed, 32 insertions(+)

diff --git a/include/linux/grmsg.h b/include/linux/grmsg.h
index a4396b5..3ef0ff1 100644
--- a/include/linux/grmsg.h
+++ b/include/linux/grmsg.h
@@ -109,5 +109,6 @@
 #define GR_INIT_TRANSFER_MSG "persistent special role transferred privilege to init by "
 #define GR_BADPROCPID_MSG "denied read of sensitive /proc/pid/%s entry via fd passed across exec by "
 #define GR_SYMLINKOWNER_MSG "denied following symlink %.950s since symlink owner %u does not match target owner %u, by "
+#define GR_ACCESS_PROC_VM_MSG "denied access to process memory "
 #define GR_BRUTE_DAEMON_MSG "bruteforce prevention initiated for the next 30 minutes or until service restarted, stalling each fork 30 seconds.  Please investigate the crash report for "
 #define GR_BRUTE_SUID_MSG "bruteforce prevention initiated due to crash of %.950s against uid %u, banning suid/sgid execs for %u minutes.  Please investigate the crash report for "
diff --git a/mm/memory.c b/mm/memory.c
index c661554..019da67 100644
--- a/mm/memory.c
+++ b/mm/memory.c
@@ -4369,6 +4369,28 @@ static ssize_t __access_remote_vm(struct task_struct *tsk, struct mm_struct *mm,
 
 		ret = get_user_pages(tsk, mm, addr, 1,
 				write, 1, &page, &vma);
+#if defined(CONFIG_PAX_MPROTECT) && \
+    defined(CONFIG_PAX_MPROTECT_ALLOW_PTRACE)
+		if (write && ret <= 0) {
+			struct vm_area_struct *tvma, *prev;
+			unsigned long vm_flags;
+			ret = get_user_pages(tsk, mm, addr, 1,
+					     0, 1, &page, &vma);
+			if (ret <= 0)
+				break;
+			tvma = find_vma_prev(mm, addr, &prev);
+			if (!(tvma->vm_flags & (VM_MAYWRITE | VM_WRITE))) {
+				vm_flags = tvma->vm_flags;
+				tvma->vm_flags |= VM_MAYWRITE;
+				if (mprotect_fixup(vma, &prev, addr,
+						   vma->vm_end,
+						   tvma->vm_flags))
+					ret = -EFAULT;
+			}
+			ret = get_user_pages(tsk, mm, addr, 1,
+					     write, 1, &page, &vma);
+		}
+#endif
 		if (ret <= 0) {
 			/*
 			 * Check if this is a VM_IO | VM_PFNMAP VMA, which
diff --git a/security/Kconfig b/security/Kconfig
index de9bffe..020d836 100644
--- a/security/Kconfig
+++ b/security/Kconfig
@@ -500,6 +500,15 @@ config PAX_MPROTECT
 	  NOTE: you can use the 'chpax' or 'paxctl' utilities to control
 	  this feature on a per file basis.
 
+config PAX_MPROTECT_ALLOW_PTRACE
+	bool "Always allow ptrace write with PAX_MPROTECT"
+	depends on PAX_MPROTECT
+	default y
+	help
+	  This option is intended to allow the ptrace to modify an
+	  executables non writable pages that are protected with the
+	  restricted mprotect() that is in enforced with PAX_MPROTECT.
+
 config PAX_MPROTECT_COMPAT
 	bool "Use legacy/compat protection demoting (read help)"
 	default y if (GRKERNSEC_CONFIG_AUTO && GRKERNSEC_CONFIG_DESKTOP)
-- 
1.7.9.5

