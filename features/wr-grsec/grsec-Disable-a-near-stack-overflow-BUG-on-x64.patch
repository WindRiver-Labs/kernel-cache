From b76219d463521387a35ed73b0f8fc51da8acaf93 Mon Sep 17 00:00:00 2001
From: Jianchuan Wang <jianchuan.wang@windriver.com>
Date: Wed, 11 Mar 2015 12:09:37 +0800
Subject: [PATCH] grsec: Disable a near-stack-overflow BUG() on x64

commit 9ee712882ff5635fe7a76115c45e8a2406c6b39a grsecurity
(No public grsecurity git repo, get the commit id from change log
https://grsecurity.net/changelog-stable2.txt)

Disable a near-stack-overflow BUG() on x64 where we have
GRKERNSEC_KSTACKOVERFLOW to use instead.  Works around a rarely reported issue
where it seems for some driver we're executing a copy_*_user on a debug
stack instead of on the process stack.

Signed-off-by: Brad Spengler <spender@grsecurity.net>
Signed-off-by: Jianchuan Wang <jianchuan.wang@windriver.com>
---
 fs/exec.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/fs/exec.c b/fs/exec.c
index cb8ebd8..e8d239e 100644
--- a/fs/exec.c
+++ b/fs/exec.c
@@ -2054,7 +2054,7 @@ void __check_object_size(const void *ptr, unsigned long n, bool to_user, bool co
 	const char *type;
 #endif
 
-#ifndef CONFIG_STACK_GROWSUP
+#if !defined(CONFIG_STACK_GROWSUP) && !defined(CONFIG_X86_64)
 	unsigned long stackstart = (unsigned long)task_stack_page(current);
 	unsigned long currentsp = (unsigned long)&stackstart;
 	if (unlikely((currentsp < stackstart + 512 ||
-- 
1.8.3.1

