From cde39001c00e79780a68075ca8d0b2ca94c3b595 Mon Sep 17 00:00:00 2001
From: Liang Li <liang.li@windriver.com>
Date: Wed, 14 Jan 2015 15:00:29 -0800
Subject: [PATCH] Define GRSEC_ALLOW_KCORE to force /proc/kcore support

Signed-off-by: Roy.Li <rongqing.li@windriver.com>
Signed-off-by: Liang Li <liang.li@windriver.com>
[Adjust context for 3.14 kernel]
Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 fs/proc/Kconfig | 10 +++++++++-
 fs/proc/kcore.c |  3 +++
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/fs/proc/Kconfig b/fs/proc/Kconfig
index c9ba48b..a6c9821 100644
--- a/fs/proc/Kconfig
+++ b/fs/proc/Kconfig
@@ -28,9 +28,17 @@ config PROC_FS
 	  This option will enlarge your kernel by about 67 KB. Several
 	  programs depend on this, so everyone should say Y here.
 
+config GRSEC_ALLOW_KCORE
+	bool "force /proc/kcore support when grsec is on"
+	depends on GRKERNSEC_PROC_ADD
+	default n
+	help
+	/proc/kcore is normally disabled by the GRSecurity kernel hardening
+	policy. Unless you know you need this feature, you should say N here.
+
 config PROC_KCORE
 	bool "/proc/kcore support" if !ARM
-	depends on PROC_FS && MMU && !GRKERNSEC_PROC_ADD
+	depends on PROC_FS && MMU && (!GRKERNSEC_PROC_ADD || GRSEC_ALLOW_KCORE)
 	help
 	  Provides a virtual ELF core file of the live kernel.  This can
 	  be read with gdb and other ELF tools.  No modifications can be
diff --git a/fs/proc/kcore.c b/fs/proc/kcore.c
index 2f9cb5e..ac4f840 100644
--- a/fs/proc/kcore.c
+++ b/fs/proc/kcore.c
@@ -551,9 +551,12 @@ read_kcore(struct file *file, char __user *buffer, size_t buflen, loff_t *fpos)
 
 static int open_kcore(struct inode *inode, struct file *filp)
 {
+
+#ifndef CONFIG_GRSEC_ALLOW_KCORE
 #if defined(CONFIG_GRKERNSEC_PROC_ADD) || defined(CONFIG_GRKERNSEC_HIDESYM)
 	return -EPERM;
 #endif
+#endif
 	if (!capable(CAP_SYS_RAWIO))
 		return -EPERM;
 	if (kcore_need_update)
-- 
2.0.2

