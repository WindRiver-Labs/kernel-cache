From 8108dac134a8fab197a65d9b093ae7a5c9537355 Mon Sep 17 00:00:00 2001
From: Han Chao <chan@windriver.com>
Date: Mon, 17 Mar 2014 16:09:20 +0800
Subject: [PATCH] grsec: Introduce config option for hardware NX

Due to potential performance impacts on P4-based systems, PAX rules out
the possibility of hardware-based paging on x86_32 systems entirely.  So
long as there is actual hardware-based paging, however, the impact is
negligible, therefore we will provide an option to get NX back on through
Kconfig.

Signed-off-by: Joe MacDonald <joe.macdonald@windriver.com>
Signed-off-by: Han Chao <chan@windriver.com>
---
 arch/x86/Kconfig | 13 +++++++++++++
 security/Kconfig |  2 +-
 2 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig
index b8a645c..81f984e 100644
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@ -304,6 +304,19 @@ config SMP
 
 	  If you don't know what to do here, say N.
 
+config ARCH_HAS_HW_NX
+	bool "Platform has hardware-based Execute-Disable (NX)"
+	default n if X86_32
+	default y if X86_64
+	help
+	  If your target platform has hardware-based Execute Disable, also called
+	  No-eXecute, NX, Enhanced Virus Protection (AMD), or eXecute-Never (XN)
+	  on ARM platforms, and you wish to make use of this feature, you should
+	  say 'y' here.
+
+	  If your platform does not have some sort of hardware-based write-or-
+	  exeucte support, you should say 'n' here.
+
 config X86_X2APIC
 	bool "Support x2apic"
 	depends on X86_LOCAL_APIC && X86_64 && IRQ_REMAP
diff --git a/security/Kconfig b/security/Kconfig
index 4c193cc..56b44b7 100644
--- a/security/Kconfig
+++ b/security/Kconfig
@@ -403,7 +403,7 @@ config PAX_NOEXEC
 config PAX_PAGEEXEC
 	bool "Paging based non-executable pages"
 	default y if GRKERNSEC_CONFIG_AUTO
-	depends on PAX_NOEXEC && (!X86_32 || M586 || M586TSC || M586MMX || M686 || MPENTIUMII || MPENTIUMIII || MPENTIUMM || MCORE2 || MATOM || MPENTIUM4 || MPSC || MK7 || MK8 || MWINCHIPC6 || MWINCHIP2 || MWINCHIP3D || MVIAC3_2 || MVIAC7)
+	depends on PAX_NOEXEC && (ARCH_HAS_HW_NX || (!X86_32 || M586 || M586TSC || M586MMX || M686 || MPENTIUMII || MPENTIUMIII || MPENTIUMM || MCORE2 || MATOM || MPENTIUM4 || MPSC || MK7 || MK8 || MWINCHIPC6 || MWINCHIP2 || MWINCHIP3D || MVIAC3_2 || MVIAC7))
 	select ARCH_TRACK_EXEC_LIMIT if X86_32
 	help
 	  This implementation is based on the paging feature of the CPU.
-- 
2.0.2

