From 25c4dc50584d3f6c0a39e8cbcfdc5c4d786f9632 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Mon, 10 Mar 2014 10:45:48 -0700
Subject: [PATCH] grsec/ppc: Add local unchecked type and APIs

Define local unchecked type and APIs for PPC32.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/powerpc/include/asm/local.h | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/arch/powerpc/include/asm/local.h b/arch/powerpc/include/asm/local.h
index b8da913..608d40a 100644
--- a/arch/powerpc/include/asm/local.h
+++ b/arch/powerpc/include/asm/local.h
@@ -9,6 +9,10 @@ typedef struct
 	atomic_long_t a;
 } local_t;
 
+typedef struct {
+	atomic_long_unchecked_t a;
+} local_unchecked_t;
+
 #define LOCAL_INIT(i)	{ ATOMIC_LONG_INIT(i) }
 
 #define local_read(l)	atomic_long_read(&(l)->a)
@@ -19,6 +23,13 @@ typedef struct
 #define local_inc(l)	atomic_long_inc(&(l)->a)
 #define local_dec(l)	atomic_long_dec(&(l)->a)
 
+#define local_read_unchecked(l)		atomic_long_read_unchecked(&(l)->a)
+#define local_set_unchecked(l, i)	atomic_long_set_unchecked(&(l)->a, (i))
+#define local_add_unchecked(i,l)	atomic_long_add_unchecked((i),(&(l)->a))
+#define local_sub_unchecked(i,l)	atomic_long_sub_unchecked((i),(&(l)->a))
+#define local_inc_unchecked(l)		atomic_long_inc_unchecked(&(l)->a)
+#define local_dec_unchecked(l)		atomic_long_dec_unchecked(&(l)->a)
+
 static __inline__ long local_add_return(long a, local_t *l)
 {
 	long t;
@@ -36,7 +47,8 @@ static __inline__ long local_add_return(long a, local_t *l)
 	return t;
 }
 
-#define local_add_negative(a, l)	(local_add_return((a), (l)) < 0)
+#define local_add_negative(a, l)		(local_add_return((a), (l)) < 0)
+#define local_add_return_unchecked(a, l)	local_add_return((a), (l))
 
 static __inline__ long local_sub_return(long a, local_t *l)
 {
@@ -102,6 +114,8 @@ static __inline__ long local_dec_return(local_t *l)
 #define local_cmpxchg(l, o, n) \
 	(cmpxchg_local(&((l)->a.counter), (o), (n)))
 #define local_xchg(l, n) (xchg_local(&((l)->a.counter), (n)))
+#define local_cmpxchg_unchecked(l, o, n) \
+	local_cmpxchg(l, o, n)
 
 /**
  * local_add_unless - add unless the number is a given value
-- 
1.8.5.2.233.g932f7e4

