From c26313d7dc88f68cb027179b463346893d305f5a Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Mon, 19 Jan 2015 13:35:25 -0800
Subject: [PATCH] grsec/uvesafb: Workaround for uvesafb init when GRKERNEC_IO
 is enabled

When GRKERNSEC_IO is enabled, uvesafb_exec call to run v86d should return
non-zero value in uvesafb_vbe_getinfo to indicate the failure of accessing I/O
in v86d. But, on QEMU 2.x it returns 0, so uvesafb driver traps into infinite
loop in uvesafb_vbe_getmodes.

The failure log looks like:

root@qemu0:~# insmod uvesafb.ko
grsec: denied use of ioperm() by /sbin/v86d[v86d:165] uid/euid:0/0 gid/egid:0/0, parent /lib/systemd/systemd[systemd:1] uid/euid:0/0 gid/egid:0/0
grsec: denied use of iopl() by /sbin/v86d[v86d:165] uid/euid:0/0 gid/egid:0/0, parent /lib/systemd/systemd[systemd:1] uid/euid:0/0 gid/egid:0/0
uvesafb: SeaBIOS Developers, SeaBIOS VBE Adapter, Rev. 1, OEM: SeaBIOS VBE(C) 2011, VBE v3.0
traps: v86d[165] general protection ip:400f44 sp:3f55c21e7c8 error:0 in v86d[400000+19000]
grsec: Segmentation fault occurred at            (nil) in /sbin/v86d[v86d:165] uid/euid:0/0 gid/egid:0/0, parent /lib/systemd/systemd[systemd:1] uid/euid:0/0 gid/egid:0/0
grsec: denied resource overstep by requesting 4096 for RLIMIT_CORE against limit 0 for /sbin/v86d[v86d:165] uid/euid:0/0 gid/egid:0/0, parent /lib/systemd/systemd[systemd:1] uid/euid:0/0 gid/egid:0/0
uvesafb: Getting mode info block for mode 0x100 failed (eax=0x4f01, err=1)
grsec: denied use of ioperm() by /sbin/v86d[v86d:168] uid/euid:0/0 gid/egid:0/0, parent /lib/systemd/systemd[systemd:1] uid/euid:0/0 gid/egid:0/0
grsec: denied use of iopl() by /sbin/v86d[v86d:168] uid/euid:0/0 gid/egid:0/0, parent /lib/systemd/systemd[systemd:1] uid/euid:0/0 gid/egid:0/0
traps: v86d[168] general protection ip:400f44 sp:399a56fdd88 error:0 in v86d[400000+19000]
grsec: Segmentation fault occurred at            (nil) in /sbin/v86d[v86d:168] uid/euid:0/0 gid/egid:0/0, parent /lib/systemd/systemd[systemd:1] uid/euid:0/0 gid/egid:0/0
grsec: more alerts, logging disabled for 10 seconds

But, the it behaves as expected on QEMU 1.5, the log on QEMU 1.5 is as follows:

root@qemu0:~# insmod uvesafb.ko
grsec: denied use of ioperm() by /sbin/v86d[v86d:168] uid/euid:0/0 gid/egid:0/0, parent /lib/systemd/systemd[systemd:1] uid/euid:0/0 gid/egid:0/0
grsec: denied use of iopl() by /sbin/v86d[v86d:168] uid/euid:0/0 gid/egid:0/0, parent /lib/systemd/systemd[systemd:1] uid/euid:0/0 gid/egid:0/0
traps: v86d[168] general protection ip:400f64 sp:3f48ea18008 error:0 in v86d[400000+19000]
grsec: Segmentation fault occurred at            (nil) in /sbin/v86d[v86d:168] uid/euid:0/0 gid/egid:0/0, parent /lib/systemd/systemd[systemd:1] uid/euid:0/0 gid/egid:0/0
grsec: denied resource overstep by requesting 4096 for RLIMIT_CORE against limit 0 for /sbin/v86d[v86d:168] uid/euid:0/0 gid/egid:0/0, parent /lib/systemd/systemd[systemd:1] uid/euid:0/0 gid/egid:0/0
uvesafb: Getting VBE info block failed (eax=0x4f00, err=1)
uvesafb: vbe_init() failed with -22
uvesafb: probe of uvesafb.0 failed with error -22

So, just return -EINVAL in uvesafb_vbe_getinfo to workaround this issue before
it get fixed in QEMU.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 drivers/video/uvesafb.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/drivers/video/uvesafb.c b/drivers/video/uvesafb.c
index 6e75516..5629d6c 100644
--- a/drivers/video/uvesafb.c
+++ b/drivers/video/uvesafb.c
@@ -420,6 +420,10 @@ static int uvesafb_vbe_getinfo(struct uvesafb_ktask *task,
 {
 	int err;
 
+#ifdef CONFIG_GRKERNSEC_IO
+	return -EINVAL;
+#endif
+
 	task->t.regs.eax = 0x4f00;
 	task->t.flags = TF_VBEIB;
 	task->t.buf_len = sizeof(struct vbe_ib);
-- 
2.0.2

