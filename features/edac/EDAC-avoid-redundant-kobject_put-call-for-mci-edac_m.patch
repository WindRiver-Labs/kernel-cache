From 949a271185fb532e53542b776eab8b146df423f4 Mon Sep 17 00:00:00 2001
From: Jason HU <yongqi.hu@windriver.com>
Date: Tue, 27 Apr 2010 23:05:36 -0700
Subject: [PATCH] EDAC: avoid redundant kobject_put call for mci->edac_mci_kobj

kobject_put for mci->edac_mci_kobj  was called more times than
kobject_get in the current edac code.

A typical sequence to add a mc device is:

1.  Call edac_mc_alloc
mci->edac_mci_kobj was initialized by calling
edac_mc_register_sysfs_main_kobj, which call kobject_get for
mci->edac_mci_kobj.

2. Steps such as setting up the mci fileds and initializing
   the device, omitted

3. Call edac_mc_add_mc:
mc was added to global list and sysfs by calling
edac_create_sysfs_mci_device,  but no reference count
operation, or kobject_get call, for  mci->edac_mci_kobj.

And to remove a mc device:

1. Call edac_mc_del_mc
edac_remove_sysfs_mci_device(mci) was called, and kobject_put for
mci->edac_mci_kobj was called there.
But in fact it should not be called there since its counterpart does
not do the contrary operation.

2. Call edac_mc_free:
edac_mc_unregister_sysfs_main_kobj(mci) was called, and  kobject_put
was called for mci->edac_mci_kobj.

Since mci has been freed after edac_remove_sysfs_mci_device was
called in edac_mc_del_mc, the reference to mci->edac_mci_kobject
later there will cause this defect. But this defect may not occur
for some reason since more call for kobject_put is harmless unless
the storage is referred after reused.

Signed-off-by: Jason HU <yongqi.hu@windriver.com>
---
 drivers/edac/edac_mc_sysfs.c |    8 +++-----
 1 files changed, 3 insertions(+), 5 deletions(-)

diff --git a/drivers/edac/edac_mc_sysfs.c b/drivers/edac/edac_mc_sysfs.c
index 418b65f..1d358ae 100644
--- a/drivers/edac/edac_mc_sysfs.c
+++ b/drivers/edac/edac_mc_sysfs.c
@@ -720,6 +720,9 @@ fail_out:
  */
 void edac_mc_unregister_sysfs_main_kobj(struct mem_ctl_info *mci)
 {
+
+	debugf0("%s()  unregister this mci kobj\n", __func__);
+
 	/* delete the kobj from the mc_kset */
 	kobject_put(&mci->edac_mci_kobj);
 }
@@ -876,11 +879,6 @@ void edac_remove_sysfs_mci_device(struct mem_ctl_info *mci)
 
 	/* remove this mci instance's attribtes */
 	edac_remove_mci_instance_attributes(mci);
-
-	debugf0("%s()  unregister this mci kobj\n", __func__);
-
-	/* unregister this instance's kobject */
-	kobject_put(&mci->edac_mci_kobj);
 }
 
 
-- 
1.6.5.2

