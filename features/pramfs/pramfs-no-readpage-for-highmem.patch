From 336721a4eb3822f31ed2eca78908fc9334ec0a3e Mon Sep 17 00:00:00 2001
From: Ivar Holmqvist <ivar.holmqvist@windriver.com>
Date: Wed, 17 Mar 2010 06:28:06 -0700
Subject: [PATCH 3/5] pramfs:no readpage for highmem

Don't do readahead (readpage) when there is a possibilty that
the pages are in highmem.

Signed-off-by: Ivar Holmqvist <ivar.holmqvist@windriver.com>
---
 fs/pramfs/inode.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/fs/pramfs/inode.c b/fs/pramfs/inode.c
index ce32871..5d70fe9 100644
--- a/fs/pramfs/inode.c
+++ b/fs/pramfs/inode.c
@@ -548,6 +548,8 @@ int pram_get_and_update_block(struct inode *inode, sector_t iblock,
 	u64 block;
 	void *bp;
 
+	BUG_ON(PageHighMem(bh->b_page));
+
 	mutex_lock(&pram_lock);
 
 	block = pram_find_data_block(inode, iblock);
@@ -590,7 +592,11 @@ int pram_get_and_update_block(struct inode *inode, sector_t iblock,
 }
 
 struct address_space_operations pram_aops = {
+#ifdef CONFIG_HIGHMEM
+	.readpage	= simple_readpage,
+#else
 	.readpage	= pram_readpage,
+#endif
 	.direct_IO	= pram_direct_IO,
 	.get_xip_mem	= pram_get_xip_mem,
 };
-- 
1.6.5.2

