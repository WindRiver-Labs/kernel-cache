From 77ef4ca8e6118fa5df2bc1130f3ad675eb554a7e Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Wed, 14 Sep 2011 11:03:56 +0800
Subject: [PATCH] fs: pramfs: fix wrong pram bitmap ops in big-endian core

On big-endian system, the macro of pram_set/clear_bitmap
uses the big-endian byte order to fill the bitmap, and it
shows the following wrong bitmap:

 0xfeff0001 0x1000000 0x0 0x0 0x0 0x0 0x0 0x0 0x0 0x0
       ^^^
So remove the two macros and directly use the proper to
fix this issue.

This fix has been validated in little-endian too.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 fs/pramfs/balloc.c |    4 ++--
 fs/pramfs/pram.h   |    3 ---
 2 files changed, 2 insertions(+), 5 deletions(-)

diff --git a/fs/pramfs/balloc.c b/fs/pramfs/balloc.c
index b8ca950..342874c 100644
--- a/fs/pramfs/balloc.c
+++ b/fs/pramfs/balloc.c
@@ -54,7 +54,7 @@ void pram_free_block(struct super_block *sb, unsigned long blocknr)
 	bp = pram_get_block(sb, bitmap_block);
 
 	pram_memunlock_block(sb, bp);
-	pram_clear_bit(blocknr, bitmap); /* mark the block free */
+	__test_and_clear_bit(blocknr, bitmap); /* mark the block free */
 	pram_memlock_block(sb, bp);
 	
 	ps = pram_get_super(sb);
@@ -122,7 +122,7 @@ int pram_new_block(struct super_block *sb, unsigned long *blocknr, int zero)
 	bp = pram_get_block(sb, bitmap_block);
 
 	pram_memunlock_block(sb, bp);
-	pram_set_bit(bnr, bitmap); /* mark the new block in use */
+	__test_and_set_bit(bnr,bitmap); /* mark the new block in use */
 	pram_memlock_block(sb, bp);
 
 	if (zero) {
diff --git a/fs/pramfs/pram.h b/fs/pramfs/pram.h
index 1ccf9ca..c26e054 100644
--- a/fs/pramfs/pram.h
+++ b/fs/pramfs/pram.h
@@ -51,9 +51,6 @@ extern ssize_t pram_direct_IO(int rw, struct kiocb *iocb,
 			  loff_t offset, unsigned long nr_segs);
 extern int pram_mmap(struct file *file, struct vm_area_struct *vma);
 
-#define pram_set_bit			ext2_set_bit
-#define pram_clear_bit			ext2_clear_bit
-
 #define clear_opt(o, opt)	(o &= ~PRAM_MOUNT_##opt)
 #define set_opt(o, opt)		(o |= PRAM_MOUNT_##opt)
 #define test_opt(sb, opt)	(((struct pram_sb_info *)sb->s_fs_info)->s_mount_opt & \
-- 
1.7.0.4

