From 939d764a5547c463668f68092ead955589d43481 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Wed, 18 May 2011 18:34:17 +0800
Subject: [PATCH 2/2] pramfs: fix compiling error for new version pramfs

Some compiling fixes in favour of backporting pramfs
from 2.6.36-1.2.4

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/x86/Kconfig     |    2 +-
 fs/inode.c           |   32 ++++++++++++++++++++++++++++++++
 fs/libfs.c           |    9 +++++++++
 fs/pramfs/Kconfig    |    2 +-
 fs/pramfs/inode.c    |    2 +-
 fs/pramfs/wprotect.h |    2 +-
 fs/pramfs/xattr.c    |   10 +++++++---
 include/linux/fs.h   |    6 ++++++
 8 files changed, 58 insertions(+), 7 deletions(-)

diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig
index 03b306d..15776f4 100644
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@ -27,7 +27,7 @@ config X86
 	select HAVE_OPROFILE
 	select HAVE_PERF_EVENTS if (!M386 && !M486)
 	select HAVE_IOREMAP_PROT
-	select HAVE_SET_MEMORY_RO
+	select HAVE_SET_MEMORY_RO if PRAMFS
 	select HAVE_KPROBES
 	select ARCH_WANT_OPTIONAL_GPIOLIB
 	select ARCH_WANT_FRAME_POINTERS
diff --git a/fs/inode.c b/fs/inode.c
index 407bf39..0a3568a 100644
--- a/fs/inode.c
+++ b/fs/inode.c
@@ -296,6 +296,18 @@ void __iget(struct inode *inode)
 	inodes_stat.nr_unused--;
 }
 
+void end_writeback(struct inode *inode)
+{
+	might_sleep();
+	BUG_ON(inode->i_data.nrpages);
+	BUG_ON(!list_empty(&inode->i_data.private_list));
+	BUG_ON(!(inode->i_state & I_FREEING));
+	BUG_ON(inode->i_state & I_CLEAR);
+	inode_sync_wait(inode);
+	inode->i_state = I_FREEING | I_CLEAR;
+}
+EXPORT_SYMBOL(end_writeback);
+
 /**
  * clear_inode - clear an inode
  * @inode: inode to clear
@@ -1610,3 +1622,23 @@ void init_special_inode(struct inode *inode, umode_t mode, dev_t rdev)
 				  inode->i_ino);
 }
 EXPORT_SYMBOL(init_special_inode);
+
+/**
+ * Init uid,gid,mode for new inode according to posix standards
+ * @inode: New inode
+ * @dir: Directory inode
+ * @mode: mode of the new inode
+ */
+void inode_init_owner(struct inode *inode, const struct inode *dir,
+			mode_t mode)
+{
+	inode->i_uid = current_fsuid();
+	if (dir && dir->i_mode & S_ISGID) {
+		inode->i_gid = dir->i_gid;
+		if (S_ISDIR(mode))
+			mode |= S_ISGID;
+	} else
+		inode->i_gid = current_fsgid();
+	inode->i_mode = mode;
+}
+EXPORT_SYMBOL(inode_init_owner);
diff --git a/fs/libfs.c b/fs/libfs.c
index b016af9..cce4d37 100644
--- a/fs/libfs.c
+++ b/fs/libfs.c
@@ -841,6 +841,15 @@ int simple_fsync(struct file *file, struct dentry *dentry, int datasync)
 }
 EXPORT_SYMBOL(simple_fsync);
 
+/*
+ * No-op implementation of ->fsync for in-memory filesystems.
+ */
+int noop_fsync(struct file *file, int datasync)
+{
+	return 0;
+}
+EXPORT_SYMBOL(noop_fsync);
+
 EXPORT_SYMBOL(dcache_dir_close);
 EXPORT_SYMBOL(dcache_dir_lseek);
 EXPORT_SYMBOL(dcache_dir_open);
diff --git a/fs/pramfs/Kconfig b/fs/pramfs/Kconfig
index 0a2c54a..c1c286b 100644
--- a/fs/pramfs/Kconfig
+++ b/fs/pramfs/Kconfig
@@ -1,5 +1,5 @@
 config PRAMFS
-	tristate "Persistent and Protected RAM file system support"
+	bool "Persistent and Protected RAM file system support"
 	depends on HAS_IOMEM && EXPERIMENTAL
 	select CRC16
 	help
diff --git a/fs/pramfs/inode.c b/fs/pramfs/inode.c
index 01cf81c..157fa42 100644
--- a/fs/pramfs/inode.c
+++ b/fs/pramfs/inode.c
@@ -711,7 +711,7 @@ int pram_notify_change(struct dentry *dentry, struct iattr *attr)
 		if (error)
 			return error;
 	}
-	setattr_copy(inode, attr);
+	inode_setattr(inode, attr);
 	if (attr->ia_valid & ATTR_MODE)
 		error = pram_acl_chmod(inode);
 	error = pram_update_inode(inode);
diff --git a/fs/pramfs/wprotect.h b/fs/pramfs/wprotect.h
index 4e35a0e..a30a7ae 100644
--- a/fs/pramfs/wprotect.h
+++ b/fs/pramfs/wprotect.h
@@ -133,7 +133,7 @@ static inline void pram_memlock_super(struct super_block *sb,
 {
 	pram_sync_super(ps);
 }
-static inline void pram_memunlock_inode(struct super_block *sb {}
+static inline void pram_memunlock_inode(struct super_block *sb,
 					struct pram_inode *pi) {}
 static inline void pram_memlock_inode(struct super_block *sb,
 					struct pram_inode *pi)
diff --git a/fs/pramfs/xattr.c b/fs/pramfs/xattr.c
index 3cdfb38..351f1b0 100644
--- a/fs/pramfs/xattr.c
+++ b/fs/pramfs/xattr.c
@@ -958,7 +958,7 @@ static struct pram_xblock_desc *pram_xattr_cache_find(struct inode *inode, struc
 		return NULL;  /* never share */
 	ea_idebug(inode, "looking for cached blocks [%x]", (int)hash);
 again:
-	ce = mb_cache_entry_find_first(pram_xattr_cache, (struct block_device *)sbi, hash);
+	ce = mb_cache_entry_find_first(pram_xattr_cache, 0, (struct block_device *)sbi, hash);
 	while (ce) {
 		char *bp;
 
@@ -991,7 +991,7 @@ again:
 			}
 			mutex_unlock(&desc->lock);
 		}
-		ce = mb_cache_entry_find_next(ce, (struct block_device *)sbi, hash);
+		ce = mb_cache_entry_find_next(ce, 0, (struct block_device *)sbi, hash);
 	}
 	return NULL;
 }
@@ -1074,7 +1074,11 @@ static void init_xblock_desc_once(void *foo)
 int __init init_pram_xattr(void)
 {
 	int ret = 0;
-	pram_xattr_cache = mb_cache_create("pram_xattr", 6);
+
+	pram_xattr_cache = mb_cache_create("pram_xattr", NULL,
+		sizeof(struct mb_cache_entry) +
+		sizeof(((struct mb_cache_entry *) 0)->e_indexes[0]), 1, 6);
+
 	if (!pram_xattr_cache) {
 		ret = -ENOMEM;
 		goto fail1;
diff --git a/include/linux/fs.h b/include/linux/fs.h
index 8d699a2..101dba2 100644
--- a/include/linux/fs.h
+++ b/include/linux/fs.h
@@ -1432,6 +1432,7 @@ extern void dentry_unhash(struct dentry *dentry);
  * VFS file helper functions.
  */
 extern int file_permission(struct file *, int);
+extern void inode_init_owner(struct inode *inode, const struct inode *dir, mode_t mode);
 
 /*
  * VFS FS_IOC_FIEMAP helper definitions.
@@ -1563,6 +1564,9 @@ struct super_operations {
    	void (*dirty_inode) (struct inode *);
 	int (*write_inode) (struct inode *, struct writeback_control *wbc);
 	void (*drop_inode) (struct inode *);
+#ifdef CONFIG_PRAMFS
+	void (*evict_inode) (struct inode *);
+#endif
 	void (*delete_inode) (struct inode *);
 	void (*put_super) (struct super_block *);
 	void (*write_super) (struct super_block *);
@@ -2183,6 +2187,7 @@ static inline void insert_inode_hash(struct inode *inode) {
 	__insert_inode_hash(inode, inode->i_ino);
 }
 
+extern void end_writeback(struct inode *);
 extern void file_move(struct file *f, struct list_head *list);
 extern void file_kill(struct file *f);
 #ifdef CONFIG_BLOCK
@@ -2353,6 +2358,7 @@ extern int simple_write_end(struct file *file, struct address_space *mapping,
 			struct page *page, void *fsdata);
 
 extern struct dentry *simple_lookup(struct inode *, struct dentry *, struct nameidata *);
+extern int noop_fsync(struct file *, int);
 extern ssize_t generic_read_dir(struct file *, char __user *, size_t, loff_t *);
 extern const struct file_operations simple_dir_operations;
 extern const struct inode_operations simple_dir_inode_operations;
-- 
1.7.0.4

