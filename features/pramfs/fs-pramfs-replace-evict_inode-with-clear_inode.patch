From f7d1ad7b970c092633669e9375d45d6e574c1125 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Thu, 22 Sep 2011 11:19:33 +0800
Subject: [PATCH] fs: pramfs: replace evict_inode with clear_inode

2.6.34 uses clear_inode versus evict_inode. Without setting
a clear_inode super_operation pointer inode cannot be freed
from a real pramfs.

And because pramfs does not implement delete_inode, so we
keep truncate_inode_pages and end_writeback as pramfs does.

The following is the commit ID in mainline kernel only as
reference:
Upstream: b57922d97fd6f79b6dbe6db0c4fd30d219fa08c1

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 fs/pramfs/inode.c  |    2 +-
 fs/pramfs/pram.h   |    2 +-
 fs/pramfs/super.c  |    2 +-
 include/linux/fs.h |    3 ---
 4 files changed, 3 insertions(+), 6 deletions(-)

diff --git a/fs/pramfs/inode.c b/fs/pramfs/inode.c
index 157fa42..5a16813 100644
--- a/fs/pramfs/inode.c
+++ b/fs/pramfs/inode.c
@@ -432,7 +432,7 @@ fail:
 	return ERR_PTR(err);
 }
 
-void pram_evict_inode(struct inode *inode)
+void pram_clear_inode(struct inode *inode)
 {
 	int want_delete = 0;
 
diff --git a/fs/pramfs/pram.h b/fs/pramfs/pram.h
index ad1d2c4..a7c8865 100644
--- a/fs/pramfs/pram.h
+++ b/fs/pramfs/pram.h
@@ -80,7 +80,7 @@ extern u64 pram_find_data_block(struct inode *inode,
 
 extern struct inode *pram_iget(struct super_block *sb, unsigned long ino);
 extern void pram_put_inode(struct inode *inode);
-extern void pram_evict_inode(struct inode *inode);
+extern void pram_clear_inode(struct inode *inode);
 extern struct inode *pram_new_inode(struct inode *dir, int mode);
 extern int pram_update_inode(struct inode *inode);
 extern int pram_write_inode(struct inode *inode, struct writeback_control *wbc);
diff --git a/fs/pramfs/super.c b/fs/pramfs/super.c
index 4b3bb80..9eaa8ba 100644
--- a/fs/pramfs/super.c
+++ b/fs/pramfs/super.c
@@ -821,7 +821,7 @@ static struct super_operations pram_sops = {
 	.destroy_inode	= pram_destroy_inode,
 	.write_inode	= pram_write_inode,
 	.dirty_inode	= pram_dirty_inode,
-	.evict_inode	= pram_evict_inode,
+	.clear_inode	= pram_clear_inode,
 	.put_super	= pram_put_super,
 	.statfs		= pram_statfs,
 	.remount_fs	= pram_remount,
diff --git a/include/linux/fs.h b/include/linux/fs.h
index 71ce896..e5cc0c0 100644
--- a/include/linux/fs.h
+++ b/include/linux/fs.h
@@ -1567,9 +1567,6 @@ struct super_operations {
    	void (*dirty_inode) (struct inode *);
 	int (*write_inode) (struct inode *, struct writeback_control *wbc);
 	void (*drop_inode) (struct inode *);
-#ifdef CONFIG_PRAMFS
-	void (*evict_inode) (struct inode *);
-#endif
 	void (*delete_inode) (struct inode *);
 	void (*put_super) (struct super_block *);
 	void (*write_super) (struct super_block *);
-- 
1.7.0.4

