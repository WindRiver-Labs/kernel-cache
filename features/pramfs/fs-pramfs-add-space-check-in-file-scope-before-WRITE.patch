From fd28c9b5f9f89ed8aa983d60282d84ec1926dcbc Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Wed, 16 Nov 2011 14:06:54 +0800
Subject: [PATCH 17/18] fs: pramfs: add space check in file scope before WRITE

If no enough space is available, we return -EFBIG.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 fs/pramfs/file.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/fs/pramfs/file.c b/fs/pramfs/file.c
index 05a4af4..36d76c1 100644
--- a/fs/pramfs/file.c
+++ b/fs/pramfs/file.c
@@ -160,6 +160,10 @@ ssize_t pram_direct_IO(int rw, struct kiocb *iocb,
 	struct iov_iter iter;
 	int num_blocks, blocksize_mask;
 	size_t length = iov_length(iov, nr_segs);
+	struct pram_super_block *ps = pram_get_super(sb);
+	unsigned int size = (length % be32_to_cpu(ps->s_blocksize)) ?\
+			(length/be32_to_cpu(ps->s_blocksize) + 1) :\
+			(length/be32_to_cpu(ps->s_blocksize));
 
 	if (length < 0)
 		return -EINVAL;
@@ -179,6 +183,10 @@ ssize_t pram_direct_IO(int rw, struct kiocb *iocb,
 	blocknr_start = blocknr;
 
 	if (rw == WRITE) {
+		/* check if there is enough space for writing*/
+		if (size > be32_to_cpu(ps->s_free_blocks_count))
+			return -EFBIG;
+
 		/* prepare a temporary buffer to hold a user data block
 		   for writing. */
 		tmp = kmalloc(sb->s_blocksize, GFP_KERNEL);
-- 
1.7.0.4

