From 12448504c29b041ffbdc0e56f8e4cd614700e5e0 Mon Sep 17 00:00:00 2001
From: Benjamin Walsh <benjamin.walsh@windriver.com>
Date: Thu, 27 May 2010 17:38:10 -0400
Subject: [PATCH 5/5] MIPS/kexec: Add machine-specific page validity check in vmcore

Some systems need to verify the validity of pages referenced by
vmcore when accessing them, some do not. By default, the check
returns all pages valid. Systems that need a different implementation
can install their own.

Signed-off-by: Benjamin Walsh <benjamin.walsh@windriver.com>
---
 arch/mips/kernel/crash_dump.c |   10 +++++++++-
 1 files changed, 9 insertions(+), 1 deletions(-)

diff --git a/arch/mips/kernel/crash_dump.c b/arch/mips/kernel/crash_dump.c
index 8e172a7..35c3a3d 100644
--- a/arch/mips/kernel/crash_dump.c
+++ b/arch/mips/kernel/crash_dump.c
@@ -35,6 +35,14 @@ __setup("savemaxmem=", parse_savemaxmem);
 
 static void *kdump_buf_page;
 
+static int default_machine_check_pfn_validity(unsigned long pfn)
+{
+	return 1;
+}
+/* Do NOT set this to NULL */
+int (*_machine_check_pfn_validity)(unsigned long pfn) =
+	default_machine_check_pfn_validity;
+
 /**
  * copy_oldmem_page - copy one page from "oldmem"
  * @pfn: page frame number to be copied
@@ -63,7 +71,7 @@ ssize_t copy_oldmem_page(unsigned long pfn, char *buf,
 		return 0;
 
 	/* see if the PFN is valid and present */
-	if (pfn_present(pfn) && pfn_valid(pfn)) {
+	if (_machine_check_pfn_validity(pfn)) {
 		vaddr = kmap_atomic_pfn(pfn, KM_PTE0);
 
 		if (!userbuf) {
-- 
1.6.5.2

