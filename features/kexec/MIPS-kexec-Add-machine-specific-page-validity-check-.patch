From 7b57e016f986008027a32e987ebdb79331c2e2b6 Mon Sep 17 00:00:00 2001
From: Benjamin Walsh <benjamin.walsh@windriver.com>
Date: Sat, 11 Jul 2009 17:01:09 -0400
Subject: [PATCH 6/6] MIPS/kexec: Add machine-specific page validity check in vmcore

Some systems need to verify the validity of pages referenced by
vmcore when accessing them, some do not. By default, the check
returns all pages valid. Systems that need a different implementation
can install their own.

Signed-off-by: Benjamin Walsh <benjamin.walsh@windriver.com>
---
 arch/mips/kernel/crash_dump.c |   10 +++++++++-
 1 files changed, 9 insertions(+), 1 deletions(-)

diff --git a/arch/mips/kernel/crash_dump.c b/arch/mips/kernel/crash_dump.c
index 4e63d7f..da04dce 100644
--- a/arch/mips/kernel/crash_dump.c
+++ b/arch/mips/kernel/crash_dump.c
@@ -34,6 +34,14 @@ __setup("savemaxmem=", parse_savemaxmem);
 
 static void *kdump_buf_page;
 
+static int default_machine_check_pfn_validity(unsigned long pfn)
+{
+	return 1;
+}
+/* Do NOT set this to NULL */
+int (*_machine_check_pfn_validity)(unsigned long pfn) =
+	default_machine_check_pfn_validity;
+
 /**
  * copy_oldmem_page - copy one page from "oldmem"
  * @pfn: page frame number to be copied
@@ -62,7 +70,7 @@ ssize_t copy_oldmem_page(unsigned long pfn, char *buf,
 		return 0;
 
 	/* see if the PFN is valid and present */
-	if (pfn_present(pfn) && pfn_valid(pfn)) {
+	if (_machine_check_pfn_validity(pfn)) {
 		vaddr = kmap_atomic_pfn(pfn, KM_PTE0);
 
 		if (!userbuf) {
-- 
1.6.3.1

