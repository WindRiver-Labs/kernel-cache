From 949e89ee03b7ea6c6b51ef93558b7af16f9fc15b Mon Sep 17 00:00:00 2001
From: Benjamin Walsh <benjamin.walsh@windriver.com>
Date: Fri, 22 May 2009 14:28:38 +0800
Subject: [PATCH 1/5] powerpc: fix kexec bug when enable high mem support in FSL_BOOKE

In FSL_BOOKE platform, relocate_new_kernel only map the 0~768M low
memory when starting new kernel. So we should limit both the kexec
source and destination page under 0x2fffffff.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
Integrated-by: Benjamin Walsh <benjamin.walsh@windriver.com>
---
 arch/powerpc/include/asm/kexec.h |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/kexec.h b/arch/powerpc/include/asm/kexec.h
index 7e06b43..ed00a49 100644
--- a/arch/powerpc/include/asm/kexec.h
+++ b/arch/powerpc/include/asm/kexec.h
@@ -6,13 +6,21 @@
  * Maximum page that is mapped directly into kernel memory.
  * XXX: Since we copy virt we can use any page we allocate
  */
+#ifdef CONFIG_FSL_BOOKE
+#define KEXEC_SOURCE_MEMORY_LIMIT 0x2fffffff
+#else
 #define KEXEC_SOURCE_MEMORY_LIMIT (-1UL)
+#endif
 
 /*
  * Maximum address we can reach in physical address mode.
  * XXX: I want to allow initrd in highmem. Otherwise set to rmo on LPAR.
  */
+#ifdef CONFIG_FSL_BOOKE
+#define KEXEC_DESTINATION_MEMORY_LIMIT 0x2fffffff
+#else
 #define KEXEC_DESTINATION_MEMORY_LIMIT (-1UL)
+#endif
 
 /* Maximum address we can use for the control code buffer */
 #ifdef __powerpc64__
-- 
1.6.5.2

