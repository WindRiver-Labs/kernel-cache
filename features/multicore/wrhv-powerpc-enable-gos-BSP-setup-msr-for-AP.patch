From 1367dcf15e964ee7e65e9f460e9ad9725cf4d14e Mon Sep 17 00:00:00 2001
From: Liang Li <liang.li@windriver.com>
Date: Tue, 27 Jul 2010 12:38:16 +0800
Subject: [PATCH] wrhv/powerpc: enable gos BSP setup msr for AP

Guest OS on e500mc and e500 need different MSR value when AP
start from '_start'. Here we just use a weak function as empty
stub then different powerpc GOS BSP could implement this
function to setup correct MSR value.

Signed-off-by: Liang Li <liang.li@windriver.com>
---
 arch/powerpc/include/asm/wrhv.h |    1 +
 arch/powerpc/kernel/vbi/wrhv.c  |    9 ++++++---
 2 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/include/asm/wrhv.h b/arch/powerpc/include/asm/wrhv.h
index 01ea5f7..aea8245 100644
--- a/arch/powerpc/include/asm/wrhv.h
+++ b/arch/powerpc/include/asm/wrhv.h
@@ -27,6 +27,7 @@ extern void wrhv_init_irq(void);
 extern void __init wrhv_calibrate_decr(void);
 extern void __init wrhv_time_init(void);
 extern int __init wrhv_earlycon_setup(void);
+extern void wrhv_setup_msr_for_ap(VBI_HREG_SET_CMPLX_QUALIFIED *);
 
 extern int __init smp_wrhv_probe(void);
 extern void smp_wrhv_message_pass(int target, int msg);
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index c2b26e9..1d2028b 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -1465,6 +1465,11 @@ VBI_HREG_SET_CMPLX_QUALIFIED bootREG;
 int irq_base = 0xFFFF; /*init as invalid IRQ number*/
 #define WRHV_IPI_NUM      4
 
+__weak void wrhv_setup_msr_for_ap(VBI_HREG_SET_CMPLX_QUALIFIED *regs)
+{
+	return;
+}
+
 DEFINE_PER_CPU(long long, tb_diff);
 
 long long wrhv_gettb_diff()
@@ -1622,9 +1627,7 @@ static void __devinit smp_wrhv_kick_cpu(int nr)
 
 	bootREG.vbiRegType = VBI_REG_SET_32BIT;
 	bootREG.vbiRegSet.hreg32.pc = 0xc0000000;
-#ifdef CONFIG_PPC85xx_VT_MODE
-	bootREG.vbiRegSet.hreg32.msr = 0x10000000;
-#endif
+	wrhv_setup_msr_for_ap(&bootREG);
 
 	ret = vbi_vb_write_reg(&bootREG, VBI_BOARD_ID_GET(), nr);
 	if (ret)
-- 
1.6.5.2

