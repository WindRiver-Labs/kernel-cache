From abc6054df2e216ecb1633115d0a9dfd59c708e68 Mon Sep 17 00:00:00 2001
From: Liang Li <liang.li@windriver.com>
Date: Wed, 26 Oct 2011 23:11:31 +0800
Subject: [PATCH] VBI syscall: enable VBI syscall for arm GOS

When wrload working in syscall mode, it will relay on VBI system calls
to write image to destination VB and activate. We need implementation
in the VBI system call to enable wrload working in syscall mode on ARM.

This can be folded into:
[
commit ea18907f831249f4fd0fa405f53f30131acab68c
Author: Liang Li <liang.li@windriver.com>
Date:   Tue Jul 19 09:24:46 2011 +0800

    wrhv: core: introduce the core WR hypervisor support

    These files represent the Linux specific additions that
    were not specifically a part of the reference VBI implementation.

    Also put in place the Kconfig and Makefile hooks for WR HV/guest
    content.

    Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
    Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
    Signed-off-by: Liang Li <liang.li@windriver.com>
]

Signed-off-by: Liang Li <liang.li@windriver.com>
---
 kernel/vbi/syscall_vbi.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/kernel/vbi/syscall_vbi.c b/kernel/vbi/syscall_vbi.c
index e9011e8..b65d305 100644
--- a/kernel/vbi/syscall_vbi.c
+++ b/kernel/vbi/syscall_vbi.c
@@ -91,6 +91,11 @@ asmlinkage long sys_vbi_activate_vb(uint32_t vb, uint32_t addr)
 	/* r3, 1st argument pointer to config page */
 	rctl.vbiRegSet.hreg32.gpr[3] = vb_cfg;
 #endif
+#ifdef CONFIG_ARM
+	rctl.vbiRegSet.hreg32.pc = (unsigned long *)addr;
+	rctl.vbiRegSet.hreg32.r[0] = (uint32_t)vb_cfg;
+	rctl.vbiRegSet.hreg32.cpsr = PSR_F_BIT | PSR_I_BIT | SVC_MODE;
+#endif
 
 	retval = vbi_vb_write_reg(&rctl, vb, 0);
 	if (retval) {
-- 
1.7.0.4

