From 46ad844a81aaa7d291aadfd6132a24308750841e Mon Sep 17 00:00:00 2001
From: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
Date: Mon, 3 May 2010 11:40:12 -0400
Subject: [PATCH 07/11] WRHV: Set proper permissions on kernel pages

The hypervisor needs the TLB pages to be marked as:
SX/SW/SR/UW/UR/UX

Since the guest OS is running in user mode it needs to
ensure that it sets the pages as (UW/UR/UX).  If this is
not done correctly the hypervisor will interpret these
pages wrong as instructions thus yielding exception 0x400.

Signed-off-by: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
---
 arch/powerpc/include/asm/pte-common.h |   15 ++++++++++++---
 arch/powerpc/platforms/85xx/Kconfig   |    2 +-
 2 files changed, 13 insertions(+), 4 deletions(-)

diff --git a/arch/powerpc/include/asm/pte-common.h b/arch/powerpc/include/asm/pte-common.h
index 51f5eb6..53c0a46 100644
--- a/arch/powerpc/include/asm/pte-common.h
+++ b/arch/powerpc/include/asm/pte-common.h
@@ -107,6 +107,8 @@ extern unsigned long bad_call_to_PMD_PAGE_SIZE(void);
 #define _PAGE_BASE_NC	(_PAGE_PRESENT | _PAGE_ACCESSED | _PAGE_PSIZE)
 #if defined(CONFIG_SMP) || defined(CONFIG_PPC_STD_MMU)
 #define _PAGE_BASE	(_PAGE_BASE_NC | _PAGE_COHERENT)
+#elif defined(CONFIG_WRHV_E500)
+#define _PAGE_BASE (_PAGE_PRESENT | _PAGE_ACCESSED | VMMU_PROT_USER_READ)
 #else
 #define _PAGE_BASE	(_PAGE_BASE_NC)
 #endif
@@ -148,14 +150,20 @@ extern unsigned long bad_call_to_PMD_PAGE_SIZE(void);
 #define __S111	PAGE_SHARED_X
 
 /* Permission masks used for kernel mappings */
+#ifdef CONFIG_WRHV_E500
+#define PAGE_KERNEL	__pgprot(_PAGE_BASE | _PAGE_KERNEL_RW | _PAGE_HWEXEC)
+#define PAGE_KERNEL_X	__pgprot(_PAGE_BASE | _PAGE_KERNEL_RWX | _PAGE_HWEXEC)
+#define PAGE_KERNEL_ROX	__pgprot(_PAGE_BASE | _PAGE_KERNEL_ROX | _PAGE_HWEXEC)
+#else
 #define PAGE_KERNEL	__pgprot(_PAGE_BASE | _PAGE_KERNEL_RW)
+#define PAGE_KERNEL_X	__pgprot(_PAGE_BASE | _PAGE_KERNEL_RWX)
+#define PAGE_KERNEL_ROX	__pgprot(_PAGE_BASE | _PAGE_KERNEL_ROX)
+#endif
 #define PAGE_KERNEL_NC	__pgprot(_PAGE_BASE_NC | _PAGE_KERNEL_RW | \
 				 _PAGE_NO_CACHE)
 #define PAGE_KERNEL_NCG	__pgprot(_PAGE_BASE_NC | _PAGE_KERNEL_RW | \
 				 _PAGE_NO_CACHE | _PAGE_GUARDED)
-#define PAGE_KERNEL_X	__pgprot(_PAGE_BASE | _PAGE_KERNEL_RWX)
 #define PAGE_KERNEL_RO	__pgprot(_PAGE_BASE | _PAGE_KERNEL_RO)
-#define PAGE_KERNEL_ROX	__pgprot(_PAGE_BASE | _PAGE_KERNEL_ROX)
 
 /* Protection used for kernel text. We want the debuggers to be able to
  * set breakpoints anywhere, so don't write protect the kernel text
@@ -175,6 +183,7 @@ extern unsigned long bad_call_to_PMD_PAGE_SIZE(void);
 #define PAGE_AGP		(PAGE_KERNEL_NC)
 #define HAVE_PAGE_AGP
 
+#ifndef CONFIG_WRHV_E500
 /* Advertise support for _PAGE_SPECIAL */
 #define __HAVE_ARCH_PTE_SPECIAL
-
+#endif
diff --git a/arch/powerpc/platforms/85xx/Kconfig b/arch/powerpc/platforms/85xx/Kconfig
index 3a2ade2..b86f143 100644
--- a/arch/powerpc/platforms/85xx/Kconfig
+++ b/arch/powerpc/platforms/85xx/Kconfig
@@ -156,7 +156,7 @@ config P4080_DS
 	select HAS_RAPIDIO
 	help
 	  This option enables support for the P4080 DS board
-
+ 
 endif # FSL_SOC_BOOKE
 
 config TQM85xx
-- 
1.6.5.2

