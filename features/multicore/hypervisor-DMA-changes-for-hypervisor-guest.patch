From 86b3a9e71476069fc98caab2e76c04d17206c780 Mon Sep 17 00:00:00 2001
From: WRS Support <support@windriver.com>
Date: Fri, 2 Oct 2009 16:12:13 -0400
Subject: [PATCH 07/18] hypervisor: DMA changes for hypervisor/guest

This represents changes to existing DMA files in
order to support linux as a guest OS on WR hypervisor.

Signed-off-by: Liang Li <liang.li@windriver.com>
---
 drivers/base/dma-coherent.c |   21 +++++++++++++++++++++
 1 files changed, 21 insertions(+), 0 deletions(-)

diff --git a/drivers/base/dma-coherent.c b/drivers/base/dma-coherent.c
index d4d8ce5..b292260 100644
--- a/drivers/base/dma-coherent.c
+++ b/drivers/base/dma-coherent.c
@@ -6,6 +6,10 @@
 #include <linux/kernel.h>
 #include <linux/dma-mapping.h>
 
+#ifdef CONFIG_WRHV
+#include <vbi/interface.h>
+#endif
+
 struct dma_coherent_mem {
 	void		*virt_base;
 	u32		device_base;
@@ -133,6 +137,23 @@ int dma_alloc_from_coherent(struct device *dev, ssize_t size,
 	 * Memory was found in the per-device area.
 	 */
 	*dma_handle = mem->device_base + (pageno << PAGE_SHIFT);
+#ifdef CONFIG_WRHV
+	{
+		u64 paddr;
+		dma_addr_t addr = mem->device_base
+			+ (page << PAGE_SHIFT);
+
+		if (vbi_get_guest_dma_addr((void *)addr,
+					&paddr) == 0)
+			*dma_handle = (dma_addr_t)paddr;
+		else {
+			bitmap_release_region(mem->bitmap,
+					mem->size, order);
+			return 0;
+		}
+	}
+#endif
+
 	*ret = mem->virt_base + (pageno << PAGE_SHIFT);
 	memset(*ret, 0, size);
 
-- 
1.6.5.2

