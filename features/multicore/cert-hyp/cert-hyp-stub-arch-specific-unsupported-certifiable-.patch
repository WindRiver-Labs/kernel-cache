From 262310a56082ae06638fbb07f3ec326c783ddff5 Mon Sep 17 00:00:00 2001
From: Thomas Tai <thomas.tai@windriver.com>
Date: Fri, 18 Feb 2011 15:41:45 -0500
Subject: [PATCH 7/7] cert-hyp: stub arch specific unsupported certifiable hypervisor VBI

For arch specific certifiable VBI is stub out via runtime variable,
for asmlinkage functions, a new name is created in the .S file, so
that the inline function can probably call the function in debug
version.

Signed-off-by: Thomas Tai <thomas.tai@windriver.com>
---
 arch/x86/kernel/vbi/syscalls.S |    5 +++--
 arch/x86/kernel/vbi/wrhv.c     |    7 +++++++
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/arch/x86/kernel/vbi/syscalls.S b/arch/x86/kernel/vbi/syscalls.S
index c108a92..f03a35b 100644
--- a/arch/x86/kernel/vbi/syscalls.S
+++ b/arch/x86/kernel/vbi/syscalls.S
@@ -121,7 +121,7 @@ vbi_hcall(vbi_reply, reply, 4)
  *
  */
 vbi_hcall(vbi_kputs, kputs, 1)
-
+vbi_hcall(cert_debug_vbi_kputs, kputs, 1)
 
 /*
  * vbi_kputc - print a character on the kernel console
@@ -132,6 +132,7 @@ vbi_hcall(vbi_kputs, kputs, 1)
  *
  */
 vbi_hcall(vbi_kputc, kputc, 1)
+vbi_hcall(cert_debug_vbi_kputc, kputc, 1)
 
 
 /*
@@ -515,7 +516,7 @@ vbi_hcall(vbi_vb_read_mem, memRead_op, 2)
  *
  */
 vbi_hcall(vbi_shell_start_debug, dbgShStart, 1)
-
+vbi_hcall(cert_debug_vbi_shell_start_debug, dbgShStart, 1)
 
 /*
  * vbi_vb_read_reg - Read a remote core's registers
diff --git a/arch/x86/kernel/vbi/wrhv.c b/arch/x86/kernel/vbi/wrhv.c
index 32c6061..a449006 100644
--- a/arch/x86/kernel/vbi/wrhv.c
+++ b/arch/x86/kernel/vbi/wrhv.c
@@ -20,6 +20,7 @@
 #include <linux/kernel_stat.h>
 #include <vbi/vbi.h>
 #include <vbi/compat.h>
+#include <vbi/stats.h>
 #include <asm/setup.h>
 #include <asm/paravirt.h>
 #include <asm/processor.h>
@@ -577,6 +578,12 @@ void __init wrhv_boot_config(void)
 		novtlbopt = 1;
 
 	reserve_top_address(WRHV_RESERVED_TOP);
+
+#ifdef CONFIG_WRHV_CERT
+	cert_hyp_version = CERT_HYP_VER_STD;
+	if (strstr(boot_command_line, "cert_debug"))
+		cert_hyp_version = CERT_HYP_VER_DEBUG;
+#endif
 }
 
 #ifdef CONFIG_SMP
-- 
1.6.5.2

