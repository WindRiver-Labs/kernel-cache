From ee585ad5019c30351b3857eaecf6a651c1905c28 Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Mon, 20 Dec 2010 10:05:34 +0800
Subject: [PATCH] wrhv/ppc: sync time base among SMP

In ppc guest os, no uboot helps us sync time base among SMP,
we need sync it at guest linux side. Here add time base sync part
to aviod some subtle problems.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/powerpc/include/asm/time.h  |   14 ++++++++++----
 arch/powerpc/kernel/smp-tbsync.c |    7 -------
 arch/powerpc/kernel/vbi/wrhv.c   |    2 ++
 3 files changed, 12 insertions(+), 11 deletions(-)

diff --git a/arch/powerpc/include/asm/time.h b/arch/powerpc/include/asm/time.h
index e16407c..2052e49 100644
--- a/arch/powerpc/include/asm/time.h
+++ b/arch/powerpc/include/asm/time.h
@@ -119,7 +119,7 @@ static inline u64 get_tb(void)
 	return mftb();
 }
 #else /* CONFIG_PPC64 */
-static inline u64 get_tb(void)
+static inline u64 get_hardware_tb(void)
 {
 	unsigned int tbhi, tblo, tbhi2;
 
@@ -129,12 +129,18 @@ static inline u64 get_tb(void)
 		tbhi2 = get_tbu();
 	} while (tbhi != tbhi2);
 
-#ifndef CONFIG_WRHV
 	return ((u64)tbhi << 32) | tblo;
+}
+
+static inline u64 get_tb(void)
+{
+#ifndef CONFIG_WRHV
+	return get_hardware_tb();
 #else
-	return (((u64)tbhi << 32) | tblo) + wrhv_gettb_diff();
+	return (u64)((long long)get_hardware_tb() + wrhv_gettb_diff());
 #endif
 }
+
 #endif /* !CONFIG_PPC64 */
 
 static inline u64 get_tb_or_rtc(void)
@@ -150,7 +156,7 @@ static inline void set_tb(unsigned int upper, unsigned int lower)
 	mtspr(SPRN_TBWL, lower);
 #else
 	unsigned long long tb = ((u64)upper<<32) | lower;
-	wrhv_settb_diff((long long)get_tb() - (long long)tb);
+	wrhv_settb_diff((long long)tb - (long long)get_hardware_tb());
 #endif
 }
 
diff --git a/arch/powerpc/kernel/smp-tbsync.c b/arch/powerpc/kernel/smp-tbsync.c
index d3f6425..03e45c4 100644
--- a/arch/powerpc/kernel/smp-tbsync.c
+++ b/arch/powerpc/kernel/smp-tbsync.c
@@ -126,10 +126,6 @@ void __devinit smp_generic_give_timebase(void)
 
 	pr_debug("Got ack\n");
 
-#ifdef CONFIG_WRHV
-	goto bypass;
-#endif
-
 	/* binary search */
 	for (old = -1; old != offset ; offset = (min+max) / 2) {
 		score = start_contest(kSetAndTest, offset, NUM_ITER);
@@ -162,9 +158,6 @@ void __devinit smp_generic_give_timebase(void)
 	}
 	pr_debug("Final offset: %d (%d/%d)\n", offset, score2, NUM_ITER );
 
-#ifdef CONFIG_WRHV
-bypass:
-#endif
 	/* exiting */
 	tbsync->cmd = kExit;
 	wmb();
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index a30d270..ba71064 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -2091,6 +2091,8 @@ struct smp_ops_t smp_wrhv_ops = {
 	.probe = smp_wrhv_probe,
 	.message_pass = smp_wrhv_message_pass,
 	.setup_cpu = smp_wrhv_setup_cpu,
+	.take_timebase = smp_generic_take_timebase,
+	.give_timebase = smp_generic_give_timebase,
 };
 
 void __init wrhv_smp_init(void)
-- 
1.7.0

