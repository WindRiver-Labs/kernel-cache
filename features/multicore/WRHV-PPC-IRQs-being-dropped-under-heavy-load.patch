From 423246459ff33782ed22535c03b63cbce7ee9052 Mon Sep 17 00:00:00 2001
From: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
Date: Mon, 14 Jun 2010 11:18:54 -0400
Subject: [PATCH 5/6] WRHV/PPC: IRQs being dropped under heavy load

Heavy serial console output over NFS root the target
(8572 and 8548) would constantly hang.  [Simics too!]

Simple test.  Using NFS root,

%> cd /
%> find .

Constantly locks up.

The root cause of this problem was that other interrupts (serial,
network, etc..) were being processed ahead of the VIOAPIC IRQ's
which lead to IRQ's being dropped in a seemingly random fashion.

Under a uP configuration the problem is a little bit harder to
reproduce given that there are not as many IRQs firing.  Where
as under SMP the IRQ load is significantly higher and the problem
is far more apparent.

Signed-off-by: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
---
 include/linux/interrupt.h |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/include/linux/interrupt.h b/include/linux/interrupt.h
index 75f3f00..f87f5c8 100644
--- a/include/linux/interrupt.h
+++ b/include/linux/interrupt.h
@@ -176,7 +176,7 @@ extern void devm_free_irq(struct device *dev, unsigned int irq, void *dev_id);
  * places left. So the only effect should be slightly increased
  * irqs-off latencies.
  */
-#ifdef CONFIG_LOCKDEP
+#if defined(CONFIG_LOCKDEP) || defined(CONFIG_PARAVIRT)
 # define local_irq_enable_in_hardirq()	do { } while (0)
 #else
 # define local_irq_enable_in_hardirq()	local_irq_enable()
-- 
1.6.5.2

