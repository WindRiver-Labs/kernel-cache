From 87e2251ff1d2c320a4461b360364f3a4ec3b8350 Mon Sep 17 00:00:00 2001
From: Jim Somerville <Jim.Somerville@windriver.com>
Date: Tue, 20 Sep 2011 19:23:37 -0400
Subject: [PATCH] wrhv: arm: Introduce sched clock

Originally the machine specific timer init routine was
simply overwritten by the WRHV one.  Now, we preserve the
machine specific routine for calling at the end of
WRHV timer init.

Signed-off-by: Jim Somerville <Jim.Somerville@windriver.com>
---
 arch/arm/include/asm/wrhv.h |    1 +
 arch/arm/kernel/setup.c     |    1 +
 arch/arm/kernel/vbi/wrhv.c  |    4 ++++
 3 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/arm/include/asm/wrhv.h b/arch/arm/include/asm/wrhv.h
index 9dff1dc..10500fb 100644
--- a/arch/arm/include/asm/wrhv.h
+++ b/arch/arm/include/asm/wrhv.h
@@ -28,6 +28,7 @@
 extern void wrhv_time_init(void);
 extern void wrhv_init_irq(void);
 extern void (*wrhv_machine_init_irq)(void);
+extern void (*wrhv_machine_init_timer)(void);
 extern spinlock_t vmmu_handle_lock;
 
 #endif /* __ASSEMBLY__ */
diff --git a/arch/arm/kernel/setup.c b/arch/arm/kernel/setup.c
index 65d2b2e..8e17d19 100644
--- a/arch/arm/kernel/setup.c
+++ b/arch/arm/kernel/setup.c
@@ -746,6 +746,7 @@ void __init setup_arch(char **cmdline_p)
 		parse_tags(tags);
 	}
 #else
+	wrhv_machine_init_timer = mdesc->timer->init;
 	mdesc->timer->init = wrhv_time_init;
 	mdesc->init_machine = NULL;
 	if (mdesc->fixup)
diff --git a/arch/arm/kernel/vbi/wrhv.c b/arch/arm/kernel/vbi/wrhv.c
index 4e28c5c..e07bc1b 100644
--- a/arch/arm/kernel/vbi/wrhv.c
+++ b/arch/arm/kernel/vbi/wrhv.c
@@ -373,6 +373,7 @@ static struct irqaction wrhv_timer_irq = {
 #endif
 
 void (*wrhv_machine_init_irq)(void) __initdata = NULL;
+void (*wrhv_machine_init_timer)(void) __initdata = NULL;
 
 void __init wrhv_init_irq(void)
 {
@@ -466,6 +467,9 @@ void __init wrhv_time_init(void)
 	clockevents_register_device(evt);
 	setup_irq(TIMERTICK_IRQ, &wrhv_timer_irq);
 	vbi_unmask_vioapic_irq(TIMERTICK_IRQ); /* Allow timer ints through */
+
+	if (wrhv_machine_init_timer)
+		wrhv_machine_init_timer();
 }
 
 void __devinit wrhv_setup_secondary_clock(void)
-- 
1.7.0.4

