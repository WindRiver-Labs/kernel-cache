From 922aa9e32758b2e3c75a3325441915b6cc86515b Mon Sep 17 00:00:00 2001
From: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
Date: Thu, 5 Aug 2010 21:44:54 -0400
Subject: [PATCH] WRHV: Set decrementer based on new HV mdio

Previously the decrementer was set incorrectly and boards
which relied on it for things like the sleep command were
not getting expected results.

The hypervisor was not providing the CPU freq. correctly to
the guest and /proc/cpu was not correct compared to that of
native.  What was being used for CPU freq. was actually the
board clock freq.

Double check that the XML settings for TimerTickFrequency is the
same as CONFIG_HZ by comparing it to VBI_TICK_TIMER_FREQ_GET, which
is the tick freq provide in the HV config structure.

Signed-off-by: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
---
 arch/powerpc/include/asm/arch_vbi.h |    1 +
 arch/powerpc/kernel/vbi/wrhv.c      |   11 ++++++++---
 2 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/include/asm/arch_vbi.h b/arch/powerpc/include/asm/arch_vbi.h
index cca00da..fd28ec6 100644
--- a/arch/powerpc/include/asm/arch_vbi.h
+++ b/arch/powerpc/include/asm/arch_vbi.h
@@ -150,6 +150,7 @@
 #define MDIO_INT_ENABLE		3
 #define MDIO_INT_DISABLE	4
 #define BSP_CLK_FREQ		5
+#define CPU_CLK_FREQ		6
 
 #ifndef _ASMLANGUAGE
 
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 28c3b24..1d3716d 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -234,7 +234,8 @@ uint32_t get_bsp_clock_freq(void)
 	VBI_BSP_MSG_REPLY clk_reply;
 	uint16_t rc = -1;
 
-	clk_msg.request = VBI_BSP_CLK_FREQ;
+	/* Hard code for now until we get proper VBI support */
+	clk_msg.request = CPU_CLK_FREQ; /* request CPU freq */
 
 	rc = bsp_service_handle(&clk_msg, &clk_reply);
 	if (rc)
@@ -360,12 +361,16 @@ void wrhv_restart(char *cmd)
 
 void __devinit wrhv_calibrate_decr(void)
 {
-	/* The timebase is updated every 8 bus clocks */
-	ppc_tb_freq = wrhv_cpu_freq / 8;
+	ppc_tb_freq = VBI_TIMESTAMP_FREQ_GET();
 	ppc_proc_freq = wrhv_cpu_freq;
 	printk(KERN_DEBUG "WRHV-TIME: wrhv_cpu_freq=%lu  ppc_tb_freq =%lu\n",
 			wrhv_cpu_freq, ppc_tb_freq);
 
+	if (VBI_TICK_TIMER_FREQ_GET() != CONFIG_HZ) {
+		printk(KERN_ERR "Mismatch between CONFIG_HZ and TickTimerFreq detected!");
+		printk(KERN_ERR "  Your decrementer has not been setup correctly\n");
+		BUG();
+	}
 }
 
 void __init wrhv_time_init(void)
-- 
1.6.5.2

