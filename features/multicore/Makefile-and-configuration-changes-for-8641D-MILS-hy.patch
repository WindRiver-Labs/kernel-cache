From 935ff638eae3d6693bad64a14c3dc60b99c7b993 Mon Sep 17 00:00:00 2001
From: Thomas Tai <thomas.tai@windriver.com>
Date: Thu, 8 Apr 2010 21:49:46 -0400
Subject: [PATCH 3/9] Makefile and configuration changes for 8641D MILS hypervisor

A new startup file and new platform option is needed for MILS
hypervisor, Makefile changed is required to select and build
the new platform. The new platform Kconfig file is based on
MPC8641_HPCN.

Also changed Makefile not to compile fpu.S and move fpu
related stub function to head_wrhv_stdmmu.S

Signed-off-by: Thomas Tai <thomas.tai@windriver.com>
---
 arch/powerpc/Makefile                |   12 ++++++++++--
 arch/powerpc/kernel/Makefile         |   14 +++++++++++---
 arch/powerpc/platforms/86xx/Kconfig  |    8 +++++++-
 arch/powerpc/platforms/86xx/Makefile |    1 +
 4 files changed, 29 insertions(+), 6 deletions(-)

diff --git a/arch/powerpc/Makefile b/arch/powerpc/Makefile
index ddf90d8..0117941 100644
--- a/arch/powerpc/Makefile
+++ b/arch/powerpc/Makefile
@@ -132,20 +132,28 @@ cpu-as-$(CONFIG_E200)		+= -Wa,-me200
 KBUILD_AFLAGS += $(cpu-as-y)
 KBUILD_CFLAGS += $(cpu-as-y)
 
-head-y				:= arch/powerpc/kernel/head_$(CONFIG_WORD_SIZE).o
 head-$(CONFIG_8xx)		:= arch/powerpc/kernel/head_8xx.o
 head-$(CONFIG_40x)		:= arch/powerpc/kernel/head_40x.o
 head-$(CONFIG_44x)		:= arch/powerpc/kernel/head_44x.o
 
+# Windriver hypervisor startup head file
 ifeq ($(CONFIG_WRHV),y)
+ifeq ($(CONFIG_FSL_BOOKE),y)
 head-$(CONFIG_FSL_BOOKE)	:= arch/powerpc/kernel/head_wrhv.o
+endif
+ifeq ($(CONFIG_6xx),y)
+head-y				:= arch/powerpc/kernel/head_wrhv_stdmmu.o
+endif
+# Native startup head file
 else
+head-y				:= arch/powerpc/kernel/head_$(CONFIG_WORD_SIZE).o
 head-$(CONFIG_FSL_BOOKE)	:= arch/powerpc/kernel/head_fsl_booke.o
 endif
 
 head-$(CONFIG_PPC64)		+= arch/powerpc/kernel/entry_64.o
+ifndef CONFIG_WRHV
 head-$(CONFIG_PPC_FPU)		+= arch/powerpc/kernel/fpu.o
-
+endif
 core-y				+= arch/powerpc/kernel/ \
 				   arch/powerpc/mm/ \
 				   arch/powerpc/lib/ \
diff --git a/arch/powerpc/kernel/Makefile b/arch/powerpc/kernel/Makefile
index ed81822..07f19d0 100644
--- a/arch/powerpc/kernel/Makefile
+++ b/arch/powerpc/kernel/Makefile
@@ -68,15 +68,22 @@ endif
 obj-$(CONFIG_44x)		+= cpu_setup_44x.o
 obj-$(USE_IMMEDIATE)		+= immediate.o
 
-extra-$(CONFIG_PPC_STD_MMU)	:= head_32.o
 extra-$(CONFIG_PPC64)		:= head_64.o
 extra-$(CONFIG_40x)		:= head_40x.o
 extra-$(CONFIG_44x)		:= head_44x.o
 
+# Windriver hypervisor startup head file
 ifeq ($(CONFIG_WRHV),y)
-extra-$(CONFIG_WRHV)	:= head_wrhv.o
+ifeq ($(CONFIG_FSL_BOOKE), y)
+extra-$(CONFIG_WRHV)		:= head_wrhv.o
+endif
+ifeq ($(CONFIG_6xx), y)
+extra-$(CONFIG_WRHV)		:= head_wrhv_stdmmu.o
+endif
 else
+# Native startup head file
 extra-$(CONFIG_FSL_BOOKE)	:= head_fsl_booke.o
+extra-$(CONFIG_PPC_STD_MMU)	:= head_32.o
 endif
 
 extra-$(CONFIG_8xx)		:= head_8xx.o
@@ -120,8 +127,9 @@ obj-y				+= iomap.o
 endif
 
 obj-$(CONFIG_PPC64)		+= $(obj64-y)
-
+ifndef CONFIG_WRHV
 extra-$(CONFIG_PPC_FPU)		+= fpu.o
+endif
 extra-$(CONFIG_PPC64)		+= entry_64.o
 
 extra-y				+= systbl_chk.i
diff --git a/arch/powerpc/platforms/86xx/Kconfig b/arch/powerpc/platforms/86xx/Kconfig
index 9355a52..0678194 100644
--- a/arch/powerpc/platforms/86xx/Kconfig
+++ b/arch/powerpc/platforms/86xx/Kconfig
@@ -31,6 +31,12 @@ config MPC8610_HPCD
 	help
 	  This option enables support for the MPC8610 HPCD board.
 
+config WRHV_8641D
+	bool "MPC8641D Guest for MILS HV"
+	depends on WRHV_MILS
+	select DEFAULT_UIMAGE
+	help
+	 This option enables support for the 8641d Hypervisor enabled board.
 endif
 
 config MPC8641
@@ -39,7 +45,7 @@ config MPC8641
 	select FSL_PCI if PCI
 	select PPC_UDBG_16550
 	select MPIC
-	default y if MPC8641_HPCN || SBC8641D
+	default y if MPC8641_HPCN || SBC8641D  || WRHV_8641D
 
 config MPC8610
 	bool
diff --git a/arch/powerpc/platforms/86xx/Makefile b/arch/powerpc/platforms/86xx/Makefile
index 8fee37d..45e3050 100644
--- a/arch/powerpc/platforms/86xx/Makefile
+++ b/arch/powerpc/platforms/86xx/Makefile
@@ -7,3 +7,4 @@ obj-$(CONFIG_SMP)		+= mpc86xx_smp.o
 obj-$(CONFIG_MPC8641_HPCN)	+= mpc86xx_hpcn.o
 obj-$(CONFIG_SBC8641D)		+= sbc8641d.o
 obj-$(CONFIG_MPC8610_HPCD)	+= mpc8610_hpcd.o
+obj-$(CONFIG_WRHV_8641D)	+= wrhv_mpc8641d.o
-- 
1.6.5.2

