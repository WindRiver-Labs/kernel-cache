From 706020b192ef3586eb567a09f8ca6e968fdbcf45 Mon Sep 17 00:00:00 2001
From: Thomas Tai <thomas.tai@windriver.com>
Date: Fri, 20 Aug 2010 10:55:09 -0700
Subject: [PATCH 2/3] Add macro to support setting hardware debug register

Signed-off-by: Thomas Tai <thomas.tai@windriver.com>
---
 arch/powerpc/include/asm/reg.h |    6 ++++++
 arch/powerpc/kernel/vbi/wrhv.c |   16 ++++++++++++++++
 2 files changed, 22 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/reg.h b/arch/powerpc/include/asm/reg.h
index 7022b5f..3ef54b0 100644
--- a/arch/powerpc/include/asm/reg.h
+++ b/arch/powerpc/include/asm/reg.h
@@ -893,8 +893,14 @@
 #define mfspr(rn)	({unsigned long rval; \
 			asm volatile("mfspr %0," __stringify(rn) \
 				: "=r" (rval)); rval;})
+
+#ifdef CONFIG_WRHV
+extern void wrhv_mtspr(unsigned int, unsigned int);
+#define mtspr(rn, v)	wrhv_mtspr(rn, v)
+#else
 #define mtspr(rn, v)	asm volatile("mtspr " __stringify(rn) ",%0" : : "r" (v)\
 				     : "memory")
+#endif
 
 #ifdef __powerpc64__
 #ifdef CONFIG_PPC_CELL
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 6854712..127dc28 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -1268,6 +1268,22 @@ static void wrhv_handle_debug(struct pt_regs *regs, unsigned long debug_status)
 		mtspr(SPRN_DBCR0, current->thread.dbcr0);
 }
 
+/* arch/powerpc/include/asm/reg.h */
+void wrhv_mtspr(unsigned int sprn, unsigned int value)
+{
+
+	switch(sprn){
+		case SPRN_DBCR0:
+			wr_control->vb_control_regs.dbcr0 = value;
+			break;
+
+		case SPRN_DBSR:
+			wr_control->vb_control_regs.dbsr = value;
+			break;
+	}
+}
+
+
 /* arch/powerpc/kernel/traps.c */
 void __kprobes wrhv_DebugException(struct pt_regs *regs, unsigned long debug_status)
 {
-- 
1.6.5.2

