From 03cdc623399677c1701b0ba7b12b9bd1d5354c8c Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Mon, 25 Apr 2011 17:19:27 +0800
Subject: [PATCH 2/2] wrhv/p4080: enable hard FPU on rev2 board

Due to the errata CPU12 the core may stall when executing a
floating-point instruction on rev1 board, but it has been fixed
in rev2 board. So add a dynamic check to use FPU on rev2 board,
and still do software emulation for floating-point instruction
on rev1 board.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/head_wrhv_p4080.S |   19 ++++++++++++++++++-
 1 files changed, 18 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/kernel/head_wrhv_p4080.S b/arch/powerpc/kernel/head_wrhv_p4080.S
index a2d11f2..e668fbb 100644
--- a/arch/powerpc/kernel/head_wrhv_p4080.S
+++ b/arch/powerpc/kernel/head_wrhv_p4080.S
@@ -169,7 +169,7 @@ _ENTRY(__early_start)
 	SET_IVOR(4,  ExternalInput);
 	SET_IVOR(5,  Alignment);
 	SET_IVOR(6,  Program);
-	SET_IVOR(7,  FloatingPointUnavailableErrata);
+	SET_IVOR(7,  FloatingPointUnavailable);
 	SET_IVOR(8,  SystemCall);
 	SET_IVOR(9,  AuxillaryProcessorUnavailable);
 	SET_IVOR(10, Decrementer);
@@ -295,6 +295,7 @@ interrupt_base:
 
 	/* Floating Point Unavailable Interrupt */
 #ifdef CONFIG_PPC_FPU
+	FP_UNAVAILABLE_EXCEPTION
 	EXCEPTION(0x0800, FloatingPointUnavailableErrata, program_check_exception, EXC_XFER_EE)
 #else
 	EXCEPTION(0x0800, FloatingPointUnavailable, unknown_exception, EXC_XFER_EE)
@@ -707,6 +708,22 @@ set_exec_table:
 	stwx	r4,r3,r5
 	blr
 
+/* Adjust or setup IVORs for e500mc */
+_GLOBAL(__setup_e500mc_ivors)
+#ifdef CONFIG_PPC_FPU
+	mfspr	r3,SPRN_PVR
+	xoris	r0,r3,0x8023
+	cmpwi	r0,0x0010
+	bne	1f		/* skip if !rev1.0 */
+	mflr	r6
+	mr	r7,r4		/* r4 is used by __setup_cpu_e500mc */
+	SET_IVOR(7, FloatingPointUnavailableErrata)
+	mr	r4,r7
+	mtlr	r6
+1:
+#endif
+	blr
+
 /*
  * Global functions
  */
-- 
1.7.0.2

