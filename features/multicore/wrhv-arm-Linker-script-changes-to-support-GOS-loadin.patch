From 3386d47a8f121d8d6df0361db8a3679e88dff447 Mon Sep 17 00:00:00 2001
From: Jim Somerville <Jim.Somerville@windriver.com>
Date: Wed, 3 Aug 2011 13:42:16 -0400
Subject: [PATCH 10/10] wrhv: arm:  Linker script changes to support GOS loading

The hypervisor's loader is very basic, requiring us
to link with the load offset.  In future, if the hv
improves its loading capability, we can drop this change
to the linker script.

Signed-off-by: Jim Somerville <Jim.Somerville@windriver.com>
---
 arch/arm/kernel/vmlinux.lds.S |   16 +++++++++++++---
 1 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/arch/arm/kernel/vmlinux.lds.S b/arch/arm/kernel/vmlinux.lds.S
index faa4c67..f1eb96a 100644
--- a/arch/arm/kernel/vmlinux.lds.S
+++ b/arch/arm/kernel/vmlinux.lds.S
@@ -8,6 +8,15 @@
 #include <asm/memory.h>
 #include <asm/page.h>
 	
+#ifdef CONFIG_WRHV
+/* Normally this is zero, but we have to override the load offset to
+ * compensate for quirks in the hypervisor loader.
+ */
+
+#undef LOAD_OFFSET
+#define LOAD_OFFSET PAGE_OFFSET
+#endif
+
 OUTPUT_ARCH(arm)
 ENTRY(stext)
 
@@ -29,7 +38,8 @@ SECTIONS
 	. = PAGE_OFFSET + TEXT_OFFSET;
 #endif
 
-	.init : {			/* Init code and data		*/
+	.init : AT(ADDR(.init) - LOAD_OFFSET)
+{			/* Init code and data		*/
 		_stext = .;
 		_sinittext = .;
 			HEAD_TEXT
@@ -86,7 +96,7 @@ SECTIONS
 #endif
 	}
 
-	.text : {			/* Real text segment		*/
+	.text : AT(ADDR(.text) - LOAD_OFFSET){	/* Real text segment	*/
 		_text = .;		/* Text and read-only data	*/
 			__exception_text_start = .;
 			*(.exception.text)
@@ -135,7 +145,7 @@ SECTIONS
 	__data_loc = .;
 #endif
 
-	.data : AT(__data_loc) {
+	.data : AT(ADDR(.data) - LOAD_OFFSET) {
 		_data = .;		/* address in memory */
 		_sdata = .;
 
-- 
1.7.0.4

