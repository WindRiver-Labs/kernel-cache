From d8c65bb743277b282649b3b9718aaa771ac032d2 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Wed, 27 Nov 2013 17:21:15 +0800
Subject: [PATCH 2/2] wrhv: pci: fixup irq number also on hotplug path

GuestOS uses PCI's final quirks(pci_fixup_final) which are currently
invoked by pci_apply_final_quirks() to get irq number from virtual
board xml configuration, however, currently this function is only
called on booting path, so if a PCI device is removed and rescanned,
it would not get a correct irq number.

To resolve this problem, we also need to do irq number fixup on hotplug
path, thus, adding pci_fixup_final quirks in pci_bus_add_devices().

Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/pci/bus.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/pci/bus.c b/drivers/pci/bus.c
index 17e5903..c8a1132 100644
--- a/drivers/pci/bus.c
+++ b/drivers/pci/bus.c
@@ -201,6 +201,9 @@ void pci_bus_add_devices(const struct pci_bus *bus)
 		/* Skip already-added devices */
 		if (dev->is_added)
 			continue;
+#ifdef CONFIG_WRHV
+		pci_fixup_device(pci_fixup_final, dev);
+#endif
 		retval = pci_bus_add_device(dev);
 		if (retval)
 			dev_err(&dev->dev, "Error adding device, continuing\n");
-- 
1.7.0

