From 0e87ebfc6e58c7116388c950173ba5b9a76d3f64 Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Fri, 12 Aug 2011 09:41:02 +0800
Subject: [PATCH 1/3] wrhv/x86: paravirt memory_setup in x86-32

Currently function memory_setup is only paravirted in x86-64, but not
x86-32. Here make x86-32 use paravirt function wrhv_memory_setup too.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/x86/kernel/vbi/wrhv.c |    9 ++-------
 1 files changed, 2 insertions(+), 7 deletions(-)

diff --git a/arch/x86/kernel/vbi/wrhv.c b/arch/x86/kernel/vbi/wrhv.c
index 76687d9..26dbcec 100644
--- a/arch/x86/kernel/vbi/wrhv.c
+++ b/arch/x86/kernel/vbi/wrhv.c
@@ -522,17 +522,15 @@ void wrhv_cpu_workarounds(struct cpuinfo_x86 *c)
 #endif
 }
 
-#ifdef CONFIG_X86_64
 char *__init wrhv_memory_setup(void)
 {
 	char *who = "WRHV-e820";
 	e820_add_region(0, wr_config->phys_mem_size, E820_RAM);
-	e820_add_region((u64)_wr_config, 0x10000, E820_RESERVED);
+	e820_add_region((phys_addr_t)_wr_config, 0x10000, E820_RESERVED);
 	update_e820();
 	return who;
 
 }
-#endif
 
 void __init wrhv_boot_config(void)
 {
@@ -549,9 +547,7 @@ void __init wrhv_boot_config(void)
 		(unsigned long)&__initrd_end - (unsigned long)&__initrd_start;
 	}
 
-#ifdef CONFIG_X86_64
 	x86_init.resources.memory_setup = wrhv_memory_setup;
-#endif
 	legacy_pic = &null_legacy_pic;
 
 #ifndef WRHV_USE_XMLCONFIG
@@ -565,8 +561,7 @@ void __init wrhv_boot_config(void)
 #ifdef CONFIG_X86_32
         snprintf(boot_command_line, COMMAND_LINE_SIZE,
 		"retain_initrd pci=wrhv idle=wrhv serialnumber nolapic nomce "
-		"noreplace-smp nosep memmap=exactmap memmap=%dK@0 %s",
-		wr_config->phys_mem_size / 1024,
+		"noreplace-smp nosep %s",
 		wr_config->bootLine);
 #else
 	snprintf(boot_command_line, COMMAND_LINE_SIZE,
-- 
1.7.0.2

