From 5cd32bbfbccf3743ced714be7c5f591675969c52 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 1 Jun 2010 00:31:33 -0700
Subject: [PATCH] wrhv/powerpc: add multi irq support for each device node

Currently the wrhv_irq_of_parse_and_map get the irq from the
xml file by matching the device node full name, and only support
one irq for each device. This patch fix this issue. We still
get the first irq by matching the device full name. And for the
other irq we find it by matching the device full name + "#<index>".

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/vbi/wrhv.c |   20 ++++++++++++++++++--
 1 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 3f29cc2..6686483 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -662,10 +662,26 @@ unsigned int wrhv_map_irq_of_desc(char *irq_name, int32_t irq_dir)
 
 unsigned int wrhv_irq_of_parse_and_map(struct device_node *dev, int index)
 {
-	if (index)
+	char *p, tmp[120];
+
+	/* Currently we only support 0 ~ 9 index */
+	if (index > 9 || index < 0)
 		return NO_IRQ;
 
-	return wrhv_map_irq_of_desc(dev->full_name, VB_INPUT_INT);
+	if (!index)
+		p = dev->full_name;
+	else {
+		int i;
+
+		p = tmp;
+		strncpy(p, dev->full_name, 120 - 2);
+		i = strlen(p);
+		p[i++] = '#';
+		p[i++] = index + '0';
+		p[i]   = '\0';
+	}
+
+	return wrhv_map_irq_of_desc(p, VB_INPUT_INT);
 }
 
 unsigned int wrhv_get_pvr(void)
-- 
1.6.5.2

