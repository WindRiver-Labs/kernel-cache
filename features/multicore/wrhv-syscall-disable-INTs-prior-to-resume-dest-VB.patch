From ce3d745d365e4e709cb24091856287a5d2b7a5c8 Mon Sep 17 00:00:00 2001
From: Liang Li <liang.li@windriver.com>
Date: Wed, 5 Jan 2011 16:50:30 +0800
Subject: [PATCH] wrhv/syscall: disable INTs prior to resume dest VB

Before actually resume the dest VB, we need to make sure
new loaded image will gain the control other than let old
image have chance to 'trigger exception by discover these
trash memory'. By disable interrupts for dest VB before
resume it, we can make sure interrupts won't be handled by
old image then newly loaded image won't be 'preempted'.

Signed-off-by: Liang Li <liang.li@windriver.com>
---
 kernel/vbi/syscall_vbi.c |   12 ++++++++++++
 1 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/kernel/vbi/syscall_vbi.c b/kernel/vbi/syscall_vbi.c
index d2132c0..d5a2c99 100644
--- a/kernel/vbi/syscall_vbi.c
+++ b/kernel/vbi/syscall_vbi.c
@@ -75,6 +75,13 @@ asmlinkage long sys_vbi_activate_vb(uint32_t vb, uint32_t addr)
 	}
 
 #ifdef CONFIG_X86
+	/*
+	 * Since the memory of the target vb has been changed(writen
+	 * alternative image). Disable interrupts could make sure
+	 * old image won't get chance to run before loaded image
+	 * gain control
+	 */
+	rctl.vbiRegSet.hreg32.eflags &= ~X86_EFLAGS_IF;
 	rctl.vbiRegSet.hreg32.eip = addr;
 	rctl.vbiRegSet.hreg32.eax = vb_cfg;
 #endif
@@ -83,6 +90,11 @@ asmlinkage long sys_vbi_activate_vb(uint32_t vb, uint32_t addr)
 	wrhv_setup_msr_for_ap(&rctl);
 	/* r3, 1st argument pointer to config page */
 	rctl.vbiRegSet.hreg32.gpr[3] = vb_cfg;
+	/*
+	 * Make sure *no* interrutions before the loaded image
+	 * actually gain the control
+	 */
+	rctl.vbiRegSet.hreg32.msr &= ~(MSR_CE | MSR_EE | MSR_ME | MSR_DE);
 #endif
 
 	retval = vbi_vb_write_reg(&rctl, vb, 0);
-- 
1.6.5.2

