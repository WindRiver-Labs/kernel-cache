From 9e562926b9b25bc522b2ca5bf8fa8a7de895516e Mon Sep 17 00:00:00 2001
From: Liang Li <liang.li@windriver.com>
Date: Wed, 29 Dec 2010 13:49:44 +0800
Subject: [PATCH] wrhv/x86: only issue vbi_vb_reset from boot core

wrhv has such kind of restriction that only allow boot core
of a VB issue vbi_vb_reset vbi call, otherwise hyp will return
error code.

Signed-off-by: Liang Li <liang.li@windriver.com>
---
 kernel/vbi/syscall_vbi.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/kernel/vbi/syscall_vbi.c b/kernel/vbi/syscall_vbi.c
index 71317c6..d2132c0 100644
--- a/kernel/vbi/syscall_vbi.c
+++ b/kernel/vbi/syscall_vbi.c
@@ -28,6 +28,7 @@
 #include <asm/unistd.h>
 
 #include <linux/capability.h>
+#include <linux/sched.h>
 
 #define OK              0
 #define ERROR           -1
@@ -192,6 +193,12 @@ asmlinkage long sys_vbi_control(uint32_t vb, uint32_t command, uint32_t flags)
 			printk(KERN_ERR "%s: vb_resume VB%d failed.\n", __func__, vb);
 		break;
 	case SYS_VBI_VB_RESTART:
+		/*
+		 * vbi_vb_reset won't success in case 'non-boot core'
+		 * issue the vbi call, so we have to make sure 'current'
+		 * is running on core0
+		 */
+		set_cpus_allowed_ptr(current, cpumask_of(0));
 		ret = vbi_vb_reset(vb, cores, reset_opts);
 		if (ret)
 			printk(KERN_ERR "%s: vb_reset VB%d failed.\n", __func__, vb);
-- 
1.7.3.3

