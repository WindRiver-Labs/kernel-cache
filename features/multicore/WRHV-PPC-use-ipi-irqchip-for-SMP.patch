From 637d3d504abec90b60542a6be23dad4f47d9a4b7 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Wed, 12 May 2010 16:39:50 +0800
Subject: [PATCH 14/14] WRHV/PPC: use ipi irqchip for SMP

Avoid ipi dropped by handle_fasteoi_irq without handling.
void
handle_fasteoi_irq(unsigned int irq, struct irq_desc *desc)
{
.....
if (unlikely(desc->status & IRQ_INPROGRESS))
                goto out;
......
ipi  has chance of not being handled but just out.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/vbi/wrhv.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 67f60ca..649873d 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -1354,6 +1354,9 @@ void wrhv_request_ipis(void)
 		panic("WRHV reslove irq for IPI failed.\n");
 
 	for (i = 0; i < 4; i++) {
+		set_irq_chip_and_handler_name(irq_base+i,
+			&wrhv_ipi_irq_chip, handle_percpu_irq, "per_cpu");
+
 		err = request_irq(irq_base+i, wrhv_ipi_action,
 				  IRQF_DISABLED|IRQF_PERCPU,
 				  ipi_names[i], (void *)i);
-- 
1.6.5.2

