From 17763cef9462747a9c663a2e7ab58991aeb3fd27 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Mon, 16 May 2011 15:11:59 +0800
Subject: [PATCH] fsl_p4080-mc: replace with TLB1 entry to map UART REG space

The hypervisor only saves the persistent TLB1 entries but NOT TLB0,
the TLB0 entries are by nature a cache meant to refreshed when needed
via an MMU TLB miss handling. For example we don't save TLB0 entries
when you switch between processes in Linux. For P4080 LPID tag separates
the TLB's between VBs in a similar way PID does for processes but
they use the same cache.

So a TLB0 entry may be replaced by a more recent access to a TLB
which has similar address attributes as same 'way'. This is done by
the hardware and we have no control over it.

We have to use TLB1 entry to replace the original TLB0 entry to map
UART REG space for early output. And the hypervisor always guarantee TLB1
to make sure that VB don't corrupt any valid TLB1 entry. And the hypervisor
can search the free TLB1 entry index to replace the index we set. So we can
set the TLB1 index with any value and here we use '0' by default. And while
bootstrap TLB1 entries are enough for VB so its also safe.

And use PPC_TLBILX_ALL to invalidate all unnecessary TLB entries in current
partititon.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/boot/wrhv_p4080_ns16550.c |    4 ++--
 arch/powerpc/kernel/head_wrhv_p4080.S  |    7 +------
 2 files changed, 3 insertions(+), 8 deletions(-)

diff --git a/arch/powerpc/boot/wrhv_p4080_ns16550.c b/arch/powerpc/boot/wrhv_p4080_ns16550.c
index dcb8e21..2a49a76 100644
--- a/arch/powerpc/boot/wrhv_p4080_ns16550.c
+++ b/arch/powerpc/boot/wrhv_p4080_ns16550.c
@@ -50,7 +50,7 @@ static u8 ns16550_tstc(void)
 }
 
 #define TLBWE_CODE		0x7C0007A4
-#define MAS0_TLBSEL0_ENTRY0	0x0
+#define MAS0_TLBSEL1_ENTRY	0x10000000
 #define MAS1_VALID_4K_TSIZE	(0x80000000|((1 << 8) & 0x00000F00))
 #define MAS2_IG			0x0000000a
 #define MAS2_SXWR		0x00000015
@@ -70,7 +70,7 @@ static void wrhv_uart_tlb0_create(void)
 		"ori    3,3,%4@l\n"
 		"tlbwe\n"
 	:
-	:"r" (MAS0_TLBSEL0_ENTRY0), "r" (MAS1_VALID_4K_TSIZE),
+	:"r" (MAS0_TLBSEL1_ENTRY), "r" (MAS1_VALID_4K_TSIZE),
 		"r" ((unsigned int)reg_base|MAS2_IG), 
 		"r" ((unsigned int)reg_base|MAS2_SXWR), 
 		"i" (TLBWE_CODE)
diff --git a/arch/powerpc/kernel/head_wrhv_p4080.S b/arch/powerpc/kernel/head_wrhv_p4080.S
index e668fbb..05afe3c 100644
--- a/arch/powerpc/kernel/head_wrhv_p4080.S
+++ b/arch/powerpc/kernel/head_wrhv_p4080.S
@@ -115,12 +115,7 @@ _ENTRY(__early_start)
 2:     
 	/* Invalid unnecessary TLB entries passed by the Hypervisor */
 	li      r0,0
-	li      r3,0
-	li      r4,0
-	ori     r4,r4,(MAS1_TSIZE(BOOK3E_PAGESZ_256M))@l
-	mtspr   SPRN_MAS1,r4
-	isync
-	PPC_TLBILX_PID(0,3)
+	PPC_TLBILX_ALL(0,0)
 	TLBSYNC
 
 	/* Establish the interrupt vector base */
-- 
1.7.0.4

