From d49980e0923e40edaf0ec22fe6ad51da2a06c66f Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 16 Jul 2010 21:54:31 -0700
Subject: [PATCH] ppc-mc: Fix incorrect CR0 setting

When running some test cases from LTP/posixtestsuite, kernel will hang or
panic. After enable some kernel hacking option, we can see some call traces:
-----
Call Trace:
[cf885ce0] [c0009284] show_stack+0x44/0x160 (unreliable)
[cf885d10] [c022a6cc] do_raw_spin_lock+0x16c/0x174
[cf885d40] [c042886c] _raw_spin_lock+0x4c/0x60
[cf885d60] [c00320b8] scheduler_tick+0x40/0x1c8
[cf885d80] [c00473bc] update_process_times+0x44/0x60
[cf885da0] [c00759c8] wrhv_timer_interrupt+0xa0/0x124
[cf885dc0] [c0017558] wrhv_hw_timer_interrupt+0x90/0x188
[cf885de0] [c00188b8] paravirt_timer_interrupt+0x1c/0x2c
[cf885df0] [c000ee80] timer_interrupt+0x10/0x20
[cf885e00] [c000e468] ret_from_except+0x0/0x10
[cf885ec0] [c001ae64] local_flush_tlb_mm+0x1c/0x60
[cf885ed0] [c001ab08] switch_mmu_context+0x100/0x3b0
[cf885f20] [c0425ba4] schedule+0x5e0/0x668
[cf885f90] [c000a564] wait_idle+0x38/0x44
[cf885fa0] [c000a59c] cpu_idle+0x2c/0xec
[cf885fc0] [c042b34c] wrhv_start_secondary+0x300/0x318
[cf885ff0] [c000328c] __secondary_start+0x18/0x5c

Looks interrupt is enabled when calling local_flush_tlb_mm(). And this is not allowed
under schedule context.

Track the following path:

local_flush_tlb_mm -> _tlbil_pid) -->

        mfmsr   r10
        wrteei  0
        ......
        wrtee   r10
        /* When enable EE we check if the pending interrupt
         * should be handled.
         */
        rlwinm  r10,r10,0,16,16;        /* test EE bit */
             ^
        Here we miss '.' to pass the result state to CR0 used by the following command,
'beq'. Then guest OS go HY improperly and sometimes interrupt may be enabled.

        beq     2f
        ......

Use 'rlwinm.' to replace 'rlwinm' to make sure guest OS can run well.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/mm/wrhv_tlb_nohash_low.S |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/mm/wrhv_tlb_nohash_low.S b/arch/powerpc/mm/wrhv_tlb_nohash_low.S
index 9f53b72..b4196ef 100644
--- a/arch/powerpc/mm/wrhv_tlb_nohash_low.S
+++ b/arch/powerpc/mm/wrhv_tlb_nohash_low.S
@@ -89,7 +89,7 @@ BEGIN_MMU_FTR_SECTION
 	/* When enable EE we check if the pending interrupt 
 	 * should be handled.
 	 */
-	rlwinm	r10,r10,0,16,16;	/* test EE bit */
+	rlwinm.	r10,r10,0,16,16;	/* test EE bit */
 	beq	2f
 	mr	r10,r0
 	lis	r0,VBI_SYS_int_enable@h;
@@ -181,7 +181,7 @@ ALT_MMU_FTR_SECTION_END_IFCLR(MMU_FTR_USE_TLBILX)
 	/* When enable EE we check if the pending interrupt 
 	 * should be handled. 
 	 */
-	rlwinm	r10,r10,0,16,16;	/* test EE bit */       
+	rlwinm.	r10,r10,0,16,16;	/* test EE bit */       
 	beq	2f
 	mr	r10,r0
 	lis	r0,VBI_SYS_int_enable@h;
-- 
1.6.5.2

