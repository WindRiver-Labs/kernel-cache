From 7c38d7ac10ab73199912cd11f9d428e78387c3e6 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Wed, 4 Aug 2010 09:22:46 +0800
Subject: [PATCH 1/2] ppc-mc/e500: paravit pvr/svr

The guest OS cannot acces directly pvr/svr register so we have to
paravirt them.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/include/asm/paravirt.h |    2 ++
 arch/powerpc/kernel/paravirt.c      |    6 ++++++
 arch/powerpc/kernel/setup-common.c  |   13 +++++++++++++
 arch/powerpc/kernel/vbi/wrhv.c      |    8 +++++++-
 4 files changed, 28 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/include/asm/paravirt.h b/arch/powerpc/include/asm/paravirt.h
index df1f14d..046db30 100644
--- a/arch/powerpc/include/asm/paravirt.h
+++ b/arch/powerpc/include/asm/paravirt.h
@@ -9,6 +9,7 @@ extern void native_do_IRQ(struct pt_regs *regs);
 extern unsigned int native_irq_of_parse_and_map(struct device_node *dev,
 						int index);
 extern unsigned int native_get_pvr(void);
+extern unsigned int native_get_svr(void);
 extern void native_timer_interrupt(struct pt_regs * regs);
 extern void __init native_time_init(void);
 extern void __init native_clocksource_init(void);
@@ -48,6 +49,7 @@ struct pv_time_ops {
 
 struct pv_cpu_ops {
 	unsigned int (*get_pvr)(void);
+	unsigned int (*get_svr)(void);
 	void (*DebugException)(struct pt_regs *regs, unsigned long debug_status);
 	int (*kgdb_arch_handle_exception)(int vector, int signo, int err_code,
                                char *remcom_in_buffer, char *remcom_out_buffer,
diff --git a/arch/powerpc/kernel/paravirt.c b/arch/powerpc/kernel/paravirt.c
index cdb2357..fbdadff 100644
--- a/arch/powerpc/kernel/paravirt.c
+++ b/arch/powerpc/kernel/paravirt.c
@@ -123,6 +123,7 @@ struct pv_irq_ops pv_irq_ops = {
 
 struct pv_cpu_ops pv_cpu_ops = {
 	.get_pvr = native_get_pvr,
+	.get_svr = native_get_svr,
 	.DebugException = native_DebugException,
 #ifdef CONFIG_KGDB
 	.kgdb_arch_handle_exception = native_kgdb_arch_handle_exception,
@@ -193,6 +194,11 @@ unsigned int paravirt_get_pvr(void)
 	return pv_cpu_ops.get_pvr();
 }
 
+unsigned int paravirt_get_svr(void)
+{
+	return pv_cpu_ops.get_svr();
+}
+
 int paravirt_fsl_pq_mdio_write(struct mii_bus *bus, int mii_id, int devad,
 				int regnum, u16 value)
 {
diff --git a/arch/powerpc/kernel/setup-common.c b/arch/powerpc/kernel/setup-common.c
index 98e3c66..5ec32cd 100644
--- a/arch/powerpc/kernel/setup-common.c
+++ b/arch/powerpc/kernel/setup-common.c
@@ -171,6 +171,19 @@ unsigned int get_pvr(void)
 {
 	return paravirt_get_pvr();
 }
+EXPORT_SYMBOL(get_pvr);
+
+unsigned paravirt_get_svr(void) __attribute__((weak, alias("native_get_svr")));
+unsigned int native_get_svr(void)
+{
+	return mfspr(SPRN_SVR);
+}
+
+unsigned int get_svr(void)
+{
+	return paravirt_get_svr();
+}
+EXPORT_SYMBOL(get_svr);
 
 static int show_cpuinfo(struct seq_file *m, void *v)
 {
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 1d2028b..28c3b24 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -701,7 +701,12 @@ unsigned int wrhv_irq_of_parse_and_map(struct device_node *dev, int index)
 
 unsigned int wrhv_get_pvr(void)
 {
-       return 0x80200000;
+	return wr_status->vb_status_regs.pvr;
+}
+
+unsigned int wrhv_get_svr(void)
+{
+	return wr_status->vb_status_regs.svr;
 }
 
 int native_fsl_pq_mdio_write(struct mii_bus *bus, int mii_id, int devad,
@@ -1436,6 +1441,7 @@ void wrhv_init(void)
 			wrhv_irq_of_parse_and_map;
 
 	pv_cpu_ops.get_pvr = wrhv_get_pvr;
+	pv_cpu_ops.get_svr = wrhv_get_svr;
 	pv_cpu_ops.DebugException = wrhv_DebugException;
 	pv_cpu_ops.kgdb_arch_handle_exception =
 		wrhv_kgdb_arch_handle_exception;
-- 
1.6.5.2

