From 74432f1bdacee503b6a696c6488da98770ca4e96 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Fri, 4 Mar 2011 10:12:00 +0800
Subject: [PATCH 2/2] wrhv/virtio: don't run input vq cb before we fill the read buffer

It makes no sense to run the input virtual queue callback before
we fill the read buffer. It is also possible that some members of
ports_device struct are still not initialized. So running the callback
will cause panic in this situation.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/wrhv/wrhv_devices.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/drivers/wrhv/wrhv_devices.c b/drivers/wrhv/wrhv_devices.c
index 1fefb4c..cf042c8 100644
--- a/drivers/wrhv/wrhv_devices.c
+++ b/drivers/wrhv/wrhv_devices.c
@@ -257,6 +257,14 @@ static irqreturn_t wrhv_interrupt(int irq, void *_vq)
 {
 	struct wrhv_virtqueue *vq = _vq;
 
+	/*
+	 * Don't run the input virtual queue callback function before we
+	 * fill the read buffer.
+	 */
+	if ((vq->mode & WRHV_DEVICE_VQ_IN) &&
+		(!vq->read_buf || !vq->len))
+		return IRQ_HANDLED;
+
 	if (vq->vq.callback)
 		vq->vq.callback(&vq->vq);
 
-- 
1.6.5.2

