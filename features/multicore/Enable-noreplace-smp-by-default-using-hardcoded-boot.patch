From 0070083f94004259412753401e6fa2b02a32a342 Mon Sep 17 00:00:00 2001
From: Thomas Tai <thomas.tai@windriver.com>
Date: Wed, 11 May 2011 13:43:26 -0400
Subject: [PATCH] Enable noreplace-smp by default using hardcoded bootline

Atomic operators, memory barriers etc get optimized by removing lock/sync
instructions at run-time even if the kernel is configured for SMP. This
happens if the kernel detects only one core. While this maybe okay in
a single OS situation, it is not okay when you are in a multi-os
situation (read MIPC).

Enable noreplace_smp by default using hardcoded bootline, so that
user do not have to put in bootline argument to enable it.

Also remove #ifndef CONFIG_WRHV in alternatives_smp_switch()
to make sure noreplace_smp is detected correctly.

Signed-off-by: Thomas Tai <thomas.tai@windriver.com>
---
 arch/x86/kernel/alternative.c |    2 --
 arch/x86/kernel/vbi/wrhv.c    |    7 +++++--
 2 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/arch/x86/kernel/alternative.c b/arch/x86/kernel/alternative.c
index b999bf2..bd1c4e7 100644
--- a/arch/x86/kernel/alternative.c
+++ b/arch/x86/kernel/alternative.c
@@ -356,10 +356,8 @@ void alternatives_smp_switch(int smp)
 	printk("lockdep: fixing up alternatives.\n");
 #endif
 
-#ifndef CONFIG_WRHV
 	if (noreplace_smp || smp_alt_once)
 		return;
-#endif
 
 	BUG_ON(!smp && (num_online_cpus() > 1));
 
diff --git a/arch/x86/kernel/vbi/wrhv.c b/arch/x86/kernel/vbi/wrhv.c
index a449006..e12c2f2 100644
--- a/arch/x86/kernel/vbi/wrhv.c
+++ b/arch/x86/kernel/vbi/wrhv.c
@@ -564,12 +564,15 @@ void __init wrhv_boot_config(void)
 	   actual hypervisor config/status/control space yet */
 #ifdef CONFIG_X86_32
         snprintf(boot_command_line, COMMAND_LINE_SIZE,
-		"retain_initrd pci=wrhv idle=wrhv serialnumber nolapic nomce nosep memmap=exactmap memmap=%dK@0 %s",
+		"retain_initrd pci=wrhv idle=wrhv serialnumber nolapic nomce "
+		"noreplace-smp nosep memmap=exactmap memmap=%dK@0 %s",
 		wr_config->phys_mem_size / 1024,
 		wr_config->bootLine);
 #else
 	snprintf(boot_command_line, COMMAND_LINE_SIZE,
-		"retain_initrd pci=wrhv idle=wrhv serialnumber nolapic noxsave nomce nosep nogbpages noexec=off novtlbopt %s",
+		"retain_initrd pci=wrhv idle=wrhv serialnumber nolapic "
+		"noxsave noreplace-smp nomce nosep nogbpages noexec=off "
+		"novtlbopt %s",
 		wr_config->bootLine);
 #endif
 
-- 
1.7.0.4

