From 4da2288c368a53a0d8b10c3c95e1352677dbe97e Mon Sep 17 00:00:00 2001
From: gcaron <Guillaume.Caron@windriver.com>
Date: Thu, 10 Oct 2013 10:06:14 -0400
Subject: [PATCH] WIND00431175: SMP Guest WRLinux 4.3 crashes when HV debug shell is exited.

In WRLinux 4.3 SMP guests, the BoardConfig area is remapped to the top of the
32-bit guest virtual address space and internal pointers in the BoardConfig area
are modified to account for this remap. Unfortunately, this pointer fixup is
applied every time the SMP WRLinux 4.3 guest is (re)started.
This patch resolves the issue.
---
 arch/x86/kernel/vbi/wrhv.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/arch/x86/kernel/vbi/wrhv.c b/arch/x86/kernel/vbi/wrhv.c
index 25a61c6..1341ef6 100644
--- a/arch/x86/kernel/vbi/wrhv.c
+++ b/arch/x86/kernel/vbi/wrhv.c
@@ -137,6 +137,13 @@ static inline void construct_fake_wr_config(void)
 	delta = (unsigned long)wr_config - (unsigned long)_wr_config;
 	fake_wr_config = (struct vb_config *)
 			 (delta + (unsigned long)wr_config->corePrivate);
+			 
+	/* do not add the delta if done already */		 
+	if (fake_wr_config->vb_control == 
+	    (delta + (unsigned long)wr_config->vb_control))
+	{
+	    return;
+	}
 
 	*fake_wr_config = *wr_config;
 	fake_wr_config->vb_control = (struct vb_control *)
-- 
1.7.0

