From e33ef0ad2b3fe43e8439eb802259f9e8962e8008 Mon Sep 17 00:00:00 2001
From: Thomas Tai <thomas.tai@windriver.com>
Date: Wed, 15 Jun 2011 15:12:07 -0400
Subject: [PATCH 2/3] update name changes for schedule transition and port VBI

Certified hypervisor schedule transition VBI function arguments
has changed, update VBI calls to match the latest version. Also
added port VBI system calls to support port function.

Signed-off-by: Thomas Tai <thomas.tai@windriver.com>
---
 arch/x86/kernel/vbi/syscalls.S |   25 +++++++++++++++++--------
 include/vbi/compat.h           |    4 ++--
 include/vbi/private.h          |    6 +++++-
 include/vbi/syscall.h          |   12 +++++++++++-
 include/vbi/syscalls.h         |    3 ++-
 5 files changed, 37 insertions(+), 13 deletions(-)

diff --git a/arch/x86/kernel/vbi/syscalls.S b/arch/x86/kernel/vbi/syscalls.S
index af390a9..53ff445 100644
--- a/arch/x86/kernel/vbi/syscalls.S
+++ b/arch/x86/kernel/vbi/syscalls.S
@@ -637,17 +637,26 @@ vbi_hcall(vbi_vb_move, vbMove, 3)
  */
 vbi_hcall(vbi_vb_set_priority, vbPrioSet, 3)
 
+
+#ifdef CONFIG_WRHV_CERT
 /*
- * vbiSchedTransitionOp - transition the  frame scheduler
+ * vbi_sched_control_op - do schedule control
  *
- * This system call executes a frame scheduler transition.   Possible scheduler
- * transitions are:
+ * This system call makes a syscall to do schedule manipulations in Hypervisor.
+ * The type of control is defined in the first parameter, after which there are
+ * 4 "void *" parameters that are interpreted and used differently in each
+ * case.
  *
- * SCHEDULER_TRANSITON_MAJOR
- * SCHEDULER_TRANSITION_MINOR
- * SCHEDULER_TRANSITION_TICK
+ * Returns: OK or ERROR if control operation is not successful
+ */
+vbi_hcall(vbi_sched_control_op, schedControl, 5)
+
+/*
+ * vbi_port_op - port operations
+ *
+ * This system call executes a port operation.
  *
+ * Returns: OK or ERROR if transition setup is not successful
  */
-#ifdef CONFIG_WRHV_CERT
-vbi_hcall(vbi_sched_transition_op, schedTransition, 1)
+vbi_hcall(vbi_port_op, port, 3)
 #endif
diff --git a/include/vbi/compat.h b/include/vbi/compat.h
index 2ef5fd6..b8cb320 100644
--- a/include/vbi/compat.h
+++ b/include/vbi/compat.h
@@ -142,8 +142,8 @@
 #define vbiVbRemote		vbi_vb_remote
 
 #ifdef CONFIG_WRHV_CERT
-#define vbiSchedTransition	vbi_sched_transition
-#define vbiSchedTransitionOp	vbi_sched_transition_op
+#define vbiSchedControlOp	vbi_sched_control_op
+#define vbiPortOp		vbi_port_op
 #endif
 
 #define vbiVbRegisterRead	vbi_vb_read_reg
diff --git a/include/vbi/private.h b/include/vbi/private.h
index 979fefb..f104d63 100644
--- a/include/vbi/private.h
+++ b/include/vbi/private.h
@@ -39,7 +39,11 @@ extern asmlinkage int32_t vbi_ns_op(uint32_t op, char* name, uint32_t rev,
 
 #ifdef CONFIG_WRHV_CERT
 /* Transition to a new schedule */
-extern asmlinkage int32_t vbi_sched_transition_op(uint32_t transition_type);
+extern asmlinkage int32_t vbi_sched_control_op(uint32_t transition,
+			char *sched_name, void *transition_type, void *core_id,
+			void *args);
+extern asmlinkage int32_t vbi_port_op(uint32_t operation_type,
+			uint32_t vb_port_id, uint32_t length);
 #endif
 
 /* Message receive private operator */
diff --git a/include/vbi/syscall.h b/include/vbi/syscall.h
index 2bbd84c..6b36100 100644
--- a/include/vbi/syscall.h
+++ b/include/vbi/syscall.h
@@ -185,7 +185,17 @@ extern asmlinkage int32_t cert_debug_vbi_kputc(int c);
 extern asmlinkage void cert_debug_vbi_shell_start_debug(uint32_t  flags);
 
 /* schedule transition api */
-extern int32_t vbi_sched_transition(char *name, uint32_t transition_type);
+extern int32_t vbi_sched_transition(char *name, uint32_t transition_type,
+				uint32_t core_id);
+
+/* port api */
+extern int32_t vbi_port_id_get(char *name,  uint32_t *vb_port_id);
+
+extern int32_t vbi_port_send(uint32_t vb_port_id, const char *message,
+				size_t length);
+
+extern int32_t vbi_port_receive(uint32_t vb_port_id, char *buffer,
+				size_t *length);
 
 /* system call prototypes for use within a context */
 static inline int vbi_ctx_ctl(unsigned operation, unsigned arg1,
diff --git a/include/vbi/syscalls.h b/include/vbi/syscalls.h
index 6aa1204..48f1444 100644
--- a/include/vbi/syscalls.h
+++ b/include/vbi/syscalls.h
@@ -112,7 +112,8 @@
 #define VBI_SYS_vbResume        HY_SYSCALL(25)	/* Resume vcores	*/
 #define VBI_SYS_vbRemote        HY_SYSCALL(26)	/* Get info of board	*/
 #ifdef CONFIG_WRHV_CERT
-#define VBI_SYS_schedTransition HY_SYSCALL(27)  /* transition frame scheduler */
+#define VBI_SYS_schedControl	HY_SYSCALL(27)  /* scheduler control    */
+#define VBI_SYS_port		HY_SYSCALL(28)  /* port send and receive */
 #endif
 
 /* Additional VMMU calls */
-- 
1.7.0.4

