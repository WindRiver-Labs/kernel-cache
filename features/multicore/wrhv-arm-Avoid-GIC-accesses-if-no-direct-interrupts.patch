From f71739218383adba99cca73a185c9ba7052364fe Mon Sep 17 00:00:00 2001
From: Jim Somerville <Jim.Somerville@windriver.com>
Date: Wed, 14 Sep 2011 12:04:20 -0400
Subject: [PATCH] wrhv: arm: Avoid GIC accesses if no direct interrupts

If the user does not specify direct_interrupts= on
the BootLine, then direct interrupts are not to be
used so the GIC should not be touched at all.

This change is to facilitate core sharing between
VBs.

Signed-off-by: Jim Somerville <Jim.Somerville@windriver.com>
---
 arch/arm/kernel/vbi/wrhv.c |    7 +++++--
 1 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/arch/arm/kernel/vbi/wrhv.c b/arch/arm/kernel/vbi/wrhv.c
index 2d5b4b1..4e28c5c 100644
--- a/arch/arm/kernel/vbi/wrhv.c
+++ b/arch/arm/kernel/vbi/wrhv.c
@@ -302,7 +302,8 @@ void __cpuinit wrhv_platform_secondary_init(unsigned int cpu)
 
 	vbi_set_exc_base((void *)CONFIG_VECTORS_BASE);
 
-	gic_cpu_init(0, gic_cpu_base_addr);
+	if (direct_interrupts_list)
+		gic_cpu_init(0, gic_cpu_base_addr);
 
 	wrhv_unmask_IPIs_for_vcore();
 
@@ -393,8 +394,10 @@ void __init wrhv_init_irq(void)
 	}
 
 	/* Do any hardware specific init to support direct irqs */
-	if (wrhv_machine_init_irq)
+	if (wrhv_machine_init_irq && direct_interrupts_list)
 		wrhv_machine_init_irq();
+	else
+		printk(KERN_INFO "WRHV: No direct irq support\n");
 }
 
 void wrhv_do_IRQ(struct pt_regs *regs)
-- 
1.7.0.4

