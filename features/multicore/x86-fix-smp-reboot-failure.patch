From eb0217264e4d84c52f234a09a49dee25bfc94ebe Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Tue, 20 Apr 2010 15:27:33 +0800
Subject: [PATCH] x86: fix smp reboot failure

The arg of function write_cr3 should be a physical address,
or guest os will drop into nested page fault and finally halt
by hypervisor. function stop_me has such illegal calling of
write_cr3, so fix it here to make reboot functional.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/x86/kernel/vbi/wrhv.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/arch/x86/kernel/vbi/wrhv.c b/arch/x86/kernel/vbi/wrhv.c
index a8be1fb..7494168 100644
--- a/arch/x86/kernel/vbi/wrhv.c
+++ b/arch/x86/kernel/vbi/wrhv.c
@@ -1233,7 +1233,7 @@ static void __init wrhv_smp_cpus_done(unsigned int max_cpus)
 
 static void stop_me(void * t)
 {
-	write_cr3((unsigned long)swapper_pg_dir);
+	write_cr3(__pa(swapper_pg_dir));
 
 	/* Enter into infinite loop to stop self*/
 	while(1);
-- 
1.6.0.4

