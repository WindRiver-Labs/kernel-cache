From a6c457bacb810b5f82952f38caf4048437cadde1 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Mon, 20 Sep 2010 23:20:49 -0700
Subject: [PATCH] wrhv: acquire xtime_lock before calling do_timer

The function do_timer will update jiffies_64 and xtime, and should
be invoked with xtime_lock acquired. Otherwise we will get inaccurate
time when the do_timer is running.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 kernel/vbi/wrhv.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/kernel/vbi/wrhv.c b/kernel/vbi/wrhv.c
index 75c7d15..95abed1 100644
--- a/kernel/vbi/wrhv.c
+++ b/kernel/vbi/wrhv.c
@@ -323,8 +323,11 @@ irqreturn_t __weak wrhv_timer_interrupt(int irq, void *dev_id)
 	per_cpu(mark_offset,cpu) = wr_vb_status->tick_count;
 
 	do {
-		if(!smp_processor_id())
+		if (!smp_processor_id()) {
+			write_seqlock(&xtime_lock);
 			do_timer(1);
+			write_sequnlock(&xtime_lock);
+		}
 		update_process_times(user_mode(regs));
 		profile_tick(CPU_PROFILING);
 		if (lost_jiffies > (2*HZ)) {
-- 
1.6.5.2

