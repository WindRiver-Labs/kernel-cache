From 46b2a5d2aac6216afca8443f8f1ef325922108a2 Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Sun, 26 Dec 2010 15:15:50 -0500
Subject: [PATCH] Fix fallout from p4080 vbi_di_eoi changes

The PPC changes that added the vbi_di_eoi() neglected to account for
the fact that arch!=PPC doesn't have this.  THere was also a compile
failure for the differing types (asmlinkage vs. none) of the two fcn
prototypes given for it.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
---
 include/vbi/private.h |    3 ---
 include/vbi/vbi.h     |    2 +-
 kernel/vbi/wrhv.c     |    7 +++++++
 3 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/include/vbi/private.h b/include/vbi/private.h
index bbfe159..f1206b7 100644
--- a/include/vbi/private.h
+++ b/include/vbi/private.h
@@ -42,9 +42,6 @@ extern asmlinkage int32_t vbi_rx_op(void *rmsg, uint32_t rlen,
 extern asmlinkage int32_t vbi_vb_remote(uint32_t op, uint32_t board_id,
 			int32_t core_id,  void *out);
 
-/* direct interrupt eoi */
-extern asmlinkage void vbi_di_eoi(void);
-
 #endif
 
 #endif  /* _VBI_PRIVATE_H */
diff --git a/include/vbi/vbi.h b/include/vbi/vbi.h
index 5784406..97f2a2a 100644
--- a/include/vbi/vbi.h
+++ b/include/vbi/vbi.h
@@ -530,7 +530,7 @@ extern int32_t vbi_get_vioapic_vec(uint32_t irq);
 extern int32_t vbi_unmask_vioapic_irq(uint32_t irq);
 extern int32_t vbi_mask_vioapic_irq(uint32_t irq);
 extern int32_t vbi_ack_vioapic_irq(uint32_t irq);
-extern void vbi_di_eoi(void);
+extern asmlinkage void vbi_di_eoi(void);
 extern int32_t vbi_send_vioapic_irq(uint32_t irq, uint32_t filter,
 				      uint32_t target);
 extern int32_t vbi_send_vioapic_irq(uint32_t irq, uint32_t filter,
diff --git a/kernel/vbi/wrhv.c b/kernel/vbi/wrhv.c
index 1c1c3b4..b288af5 100644
--- a/kernel/vbi/wrhv.c
+++ b/kernel/vbi/wrhv.c
@@ -74,6 +74,7 @@ static void wrhv_ack_irq(unsigned int irq)
 	vbi_ack_vioapic_irq(irq);
 }
 
+#ifdef CONFIG_PPC
 extern int wrhv_dir_irq;
 static void wrhv_eoi_irq(unsigned int irq)
 {
@@ -82,6 +83,12 @@ static void wrhv_eoi_irq(unsigned int irq)
 	else
 		vbi_ack_vioapic_irq(irq);
 }
+#else
+static void wrhv_eoi_irq(unsigned int irq)
+{
+	vbi_ack_vioapic_irq(irq);
+}
+#endif
 
 static void wrhv_maskack_irq(unsigned int irq)
 {
-- 
1.6.5.2

