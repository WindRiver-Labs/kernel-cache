From a603b0f928d518fe63b1fb04c2557a7bf4362435 Mon Sep 17 00:00:00 2001
From: Yue Tao <yue.tao@windriver.com>
Date: Thu, 18 Sep 2014 02:10:36 -0700
Subject: [PATCH] wrhv202 paravirt changes

Signed-off-by: Guillaume.Caron@windriver.com

---
 arch/x86/kernel/vbi/wrhv.c |   24 +++++++++++++++++++++---
 include/vbi/interface.h    |    8 +++++---
 2 files changed, 26 insertions(+), 6 deletions(-)

diff --git a/arch/x86/kernel/vbi/wrhv.c b/arch/x86/kernel/vbi/wrhv.c
index 17aacdd..360cc01 100644
--- a/arch/x86/kernel/vbi/wrhv.c
+++ b/arch/x86/kernel/vbi/wrhv.c
@@ -48,6 +48,16 @@
 
 #define WRHV_BOOTARG_BUF_SIZE   256
 
+#define GUEST_IO_APIC_START             0xFEC00000
+#define GUEST_IO_APIC_SIZE              0x00001000
+#define GUEST_LAPIC_START               0xFEE00000
+#define GUEST_LAPIC_SIZE                0x00001000
+
+#define ONE_PAGE			0x1000
+#define ONE_MEG 			( 1024ul * 1024ul )
+#define ONE_GIG 			( ONE_MEG * 1024ul )
+#define FOUR_GIG 			( 4ull * ONE_GIG )
+
 /* Copied over during early bootstrap */
 struct vb_config __wr_config = { .pid = -1 };
 /* Pointer passed from hypervisor */
@@ -167,7 +177,7 @@ static inline void construct_fake_wr_config(void)
 	if (wr_config->memoryRegionsConfigAddress != NULL) {
 		fake_wr_config->memoryRegionsConfigAddress =
 			(struct vb_mem_info *)(delta +
-		(unsigned long)wr_config->sharedMemoryRegionsConfigAddress);
+		(unsigned long)wr_config->memoryRegionsConfigAddress);
 	}
 
 	fake_wr_config->interruptConfiguration = (struct vb_int_info *)
@@ -631,6 +641,10 @@ void __init wrhv_post_memory_setup(void)
 	early_iounmap(dev_first, devs_size);
 	e820_add_region((u64)(unsigned long)_wr_config,
 			(u64)_wr_config_pages << PAGE_SHIFT, E820_RESERVED);
+	e820_add_region((u64)GUEST_IO_APIC_START,
+			(u64)GUEST_IO_APIC_SIZE, E820_RESERVED);
+	e820_add_region((u64)GUEST_LAPIC_START,
+			(u64)GUEST_LAPIC_SIZE, E820_RESERVED);
 	update_e820();
 }
 
@@ -735,6 +749,11 @@ void __init wrhv_boot_config(void)
 	if (strstr(boot_command_line, "novtlbopt"))
 		novtlbopt = 1;
 
+#ifdef CONFIG_X86_32
+	_wr_config_pages = wrhv_config_pages_count();
+	reserve_top_address((unsigned long)_wr_config_pages << PAGE_SHIFT);
+#endif
+	
 #ifdef CONFIG_WRHV_SAFETY_PROFILE
 	safety_hyp_version = SAFETY_HYP_VER_STD;
 	if (strstr(boot_command_line, "safety_debug"))
@@ -1815,9 +1834,8 @@ void __init wrhv_init(void)
 #ifdef CONFIG_SMP
 	wrhv_smp_init();
 #endif
+#ifdef CONFIG_X86_64
 	_wr_config_pages = wrhv_config_pages_count();
-#ifdef CONFIG_X86_32
-	reserve_top_address((unsigned long)_wr_config_pages << PAGE_SHIFT);
 #endif
 
 	wrhv_post_memory_setup();
diff --git a/include/vbi/interface.h b/include/vbi/interface.h
index 150cb78..302ab20 100644
--- a/include/vbi/interface.h
+++ b/include/vbi/interface.h
@@ -1,7 +1,7 @@
 /*
  * interface.h - virtual board interface header file
  *
- * Copyright (c) 2007-2010 Wind River Systems, Inc.
+ * Copyright (c) 2007-2014 Wind River Systems, Inc.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 as
@@ -714,11 +714,13 @@ struct vb_config
 
 	/* guest type */
 
-	uint32_t   guestOS;
+	uint32_t guestOS;
+	
+	uint32_t pad13;
 
 	/* main memory configuration settings 64 bit */
 
-	uint64_t  phys_mem_size_64; /* the vbPhysical size of RAM 64 bit */
+	uint64_t phys_mem_size_64; /* the vbPhysical size of RAM 64 bit */
 };
 
 #endif /*_ASMLANGUAGE */
-- 
1.7.0

