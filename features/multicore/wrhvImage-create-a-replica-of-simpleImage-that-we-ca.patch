From 207fbfe9cbae94a6ce248f41f65df72a1ee417db Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Thu, 1 Apr 2010 13:04:25 -0400
Subject: [PATCH] wrhvImage: create a replica of simpleImage that we can tweak

The default load address for a simpleImage is too low, and
it will fail to boot on the WR hypervisor with an error
message saying essentially just that.  Rather than change
the defaults for simpleImage, this creates a wrhvImage
which we are free to adjust in any way we want.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
---
 arch/powerpc/Makefile      |    3 ++-
 arch/powerpc/boot/Makefile |    9 ++++++++-
 arch/powerpc/boot/wrapper  |    5 +++++
 3 files changed, 15 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/Makefile b/arch/powerpc/Makefile
index 21699f7..ddf90d8 100644
--- a/arch/powerpc/Makefile
+++ b/arch/powerpc/Makefile
@@ -162,7 +162,7 @@ all: zImage
 
 CPPFLAGS_vmlinux.lds	:= -Upowerpc
 
-BOOT_TARGETS = zImage zImage.initrd uImage zImage% dtbImage% treeImage.% cuImage.% simpleImage.%
+BOOT_TARGETS = zImage zImage.initrd uImage zImage% dtbImage% treeImage.% cuImage.% simpleImage.% wrhvImage.%
 
 PHONY += $(BOOT_TARGETS)
 
@@ -185,6 +185,7 @@ define archhelp
   @echo '                    versions which do not support device trees'
   @echo '  dtbImage.<dt>   - zImage with an embedded device tree blob'
   @echo '  simpleImage.<dt> - Firmware independent image.'
+  @echo '  wrhvImage.<dt>  - Wind River Hypervisor image.'
   @echo '  treeImage.<dt>  - Support for older IBM 4xx firmware (not U-Boot)'
   @echo '  install         - Install kernel using'
   @echo '                    (your) ~/bin/installkernel or'
diff --git a/arch/powerpc/boot/Makefile b/arch/powerpc/boot/Makefile
index e930df5..ed37e72 100644
--- a/arch/powerpc/boot/Makefile
+++ b/arch/powerpc/boot/Makefile
@@ -287,7 +287,8 @@ initrd-  := $(patsubst zImage%, zImage.initrd%, $(image-n) $(image-))
 initrd-y := $(patsubst zImage%, zImage.initrd%, \
 		$(patsubst dtbImage%, dtbImage.initrd%, \
 		$(patsubst simpleImage%, simpleImage.initrd%, \
-		$(patsubst treeImage%, treeImage.initrd%, $(image-y)))))
+		$(patsubst wrhvImage%, wrhvImage.initrd%, \
+		$(patsubst treeImage%, treeImage.initrd%, $(image-y))))))
 initrd-y := $(filter-out $(image-y), $(initrd-y))
 targets	+= $(image-y) $(initrd-y)
 
@@ -329,6 +330,12 @@ $(obj)/simpleImage.initrd.%: vmlinux $(obj)/%.dtb $(wrapperbits)
 $(obj)/simpleImage.%: vmlinux $(obj)/%.dtb $(wrapperbits)
 	$(call if_changed,wrap,simpleboot-$*,,$(obj)/$*.dtb)
 
+$(obj)/wrhvImage.initrd.%: vmlinux $(obj)/%.dtb $(wrapperbits)
+	$(call if_changed,wrap,wrhvboot-$*,,$(obj)/$*.dtb,$(obj)/ramdisk.image.gz)
+
+$(obj)/wrhvImage.%: vmlinux $(obj)/%.dtb $(wrapperbits)
+	$(call if_changed,wrap,wrhvboot-$*,,$(obj)/$*.dtb)
+
 $(obj)/treeImage.initrd.%: vmlinux $(obj)/%.dtb $(wrapperbits)
 	$(call if_changed,wrap,treeboot-$*,,$(obj)/$*.dtb,$(obj)/ramdisk.image.gz)
 
diff --git a/arch/powerpc/boot/wrapper b/arch/powerpc/boot/wrapper
index 965c237..5adcefe 100755
--- a/arch/powerpc/boot/wrapper
+++ b/arch/powerpc/boot/wrapper
@@ -218,6 +218,11 @@ simpleboot-*)
     platformo="$object/simpleboot.o"
     binary=y
     ;;
+wrhvboot-*)
+    link_address='0x600000'
+    platformo="$object/simpleboot.o"
+    binary=y
+    ;;
 asp834x-redboot)
     platformo="$object/fixed-head.o $object/redboot-83xx.o"
     binary=y
-- 
1.6.5.2

