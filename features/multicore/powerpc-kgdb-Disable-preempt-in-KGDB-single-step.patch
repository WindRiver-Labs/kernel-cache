From 1ecc0458b4d18b75bd10c8704f9387a6e00fe42b Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Thu, 24 Dec 2009 01:13:40 -0800
Subject: [PATCH] powerpc/kgdb: Disable preempt in KGDB single step

KGDB single step can't return when many context switch occur, so
disable preempt in KGDB single step handler to reduce context
switch during single step, reenable preempt in Debug exception
handler since single step causes a debug exception.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/powerpc/kernel/vbi/wrhv.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 5b9ccc9..521c114 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -1007,6 +1007,8 @@ void __kprobes wrhv_DebugException(struct pt_regs *regs, unsigned long debug_sta
 
 	if (debug_status & DBSR_IC) {   /* instruction completion */
 		regs->msr &= ~MSR_DE;
+		if (!user_mode(regs))
+			preempt_enable_no_resched();
 		if (notify_die(DIE_SSTEP, "single_step", regs, 5,
 			       5, SIGTRAP) == NOTIFY_STOP) {
 			return;
@@ -1074,6 +1077,8 @@ int wrhv_kgdb_arch_handle_exception(int vector, int signo, int err_code,
 			 */
 			wr_control->vb_control_regs.emsr |= MSR_DE;
 			linux_regs->msr |= MSR_DE;
+			if (!user_mode(linux_regs))
+				preempt_disable();
 #else
 			linux_regs->msr |= MSR_SE;
 #endif
-- 
1.6.5.2

