From edd651d0baa17332935ffaf4c17e0620ae13b775 Mon Sep 17 00:00:00 2001
From: Thomas Tai <thomas.tai@windriver.com>
Date: Thu, 8 Apr 2010 21:49:45 -0400
Subject: [PATCH 2/9] Use CONFIG_6xx to seperate from E500 code path

MILS hypervisor support 8548 which is a E500 CPU and 8641 which
is a 6xx CPU. Use CONFIG_6xx to seperate between those 2 CPU.

Signed-off-by: Thomas Tai <thomas.tai@windriver.com>
---
 arch/powerpc/include/asm/ppc_asm.h |    2 +-
 arch/powerpc/kernel/setup_32.c     |    2 +-
 arch/powerpc/kernel/traps.c        |   19 +++++++++----------
 arch/powerpc/mm/mmu_decl.h         |    7 +++++++
 include/vbi/vdk_interface.h        |   10 ++++++++++
 5 files changed, 28 insertions(+), 12 deletions(-)

diff --git a/arch/powerpc/include/asm/ppc_asm.h b/arch/powerpc/include/asm/ppc_asm.h
index d0c7f33..844c322 100644
--- a/arch/powerpc/include/asm/ppc_asm.h
+++ b/arch/powerpc/include/asm/ppc_asm.h
@@ -389,7 +389,7 @@ END_FTR_SECTION_IFCLR(CPU_FTR_601)
 #endif
 
 
-#if defined(CONFIG_BOOKE)
+#if defined(CONFIG_BOOKE) || defined (CONFIG_WRHV)
 #define toreal(rd)
 #define fromreal(rd)
 
diff --git a/arch/powerpc/kernel/setup_32.c b/arch/powerpc/kernel/setup_32.c
index 660d9dd..47883cd 100644
--- a/arch/powerpc/kernel/setup_32.c
+++ b/arch/powerpc/kernel/setup_32.c
@@ -135,7 +135,7 @@ notrace void __init machine_init(unsigned long dt_ptr, unsigned long phys)
 
 	setup_kdump_trampoline();
 
-#ifdef CONFIG_6xx
+#if defined(CONFIG_6xx) && !defined(CONFIG_WRHV)
 	if (cpu_has_feature(CPU_FTR_CAN_DOZE) ||
 	    cpu_has_feature(CPU_FTR_CAN_NAP))
 		ppc_md.power_save = ppc6xx_idle;
diff --git a/arch/powerpc/kernel/traps.c b/arch/powerpc/kernel/traps.c
index b8250ab..15750bd 100644
--- a/arch/powerpc/kernel/traps.c
+++ b/arch/powerpc/kernel/traps.c
@@ -789,15 +789,7 @@ static int emulate_instruction(struct pt_regs *regs)
 	/* Emulate the mfspr rD, PVR. */
 	if ((instword & INST_MFSPR_PVR_MASK) == INST_MFSPR_PVR) {
 		rd = (instword >> 21) & 0x1f;
-#ifndef CONFIG_WRHV
-		regs->gpr[rd] = mfspr(SPRN_PVR);
-#else
-		/*
-		 * PVR for wrhv hypervisor should be 0x80200000,
-		 * why is it 0x80200010?
-		 */
-		regs->gpr[rd] = 0x80200010;
-#endif
+		regs->gpr[rd] = get_pvr();
 		return 0;
 	}
 
@@ -1115,7 +1107,14 @@ void __kprobes DebugException(struct pt_regs *regs, unsigned long debug_status)
 	paravirt_DebugException(regs, debug_status);
 }
 
-#endif /* CONFIG_4xx || CONFIG_BOOKE */
+#else /* CONFIG_4xx || CONFIG_BOOKE */
+/* other CPU family do not have native debug exception function */
+void __kprobes native_DebugException(struct pt_regs *regs,
+		unsigned long debug_status)
+{
+	return;
+}
+#endif
 
 #if !defined(CONFIG_TAU_INT)
 void TAUException(struct pt_regs *regs)
diff --git a/arch/powerpc/mm/mmu_decl.h b/arch/powerpc/mm/mmu_decl.h
index 2d1631a..5a77052 100644
--- a/arch/powerpc/mm/mmu_decl.h
+++ b/arch/powerpc/mm/mmu_decl.h
@@ -59,7 +59,14 @@ extern phys_addr_t lowmem_end_addr;
  */
 #if defined(CONFIG_PARAVIRT)
 
+#if defined(CONFIG_E500)
 #define flush_HPTE(pid, va, pg)	_tlbie(va, pid)
+#elif defined(CONFIG_6xx)
+#define flush_HPTE(pid, va, pg)	_tlbie(va)
+#else
+#error unsupported CPU family
+#endif
+
 extern void MMU_init_hw(void);
 extern unsigned long mmu_mapin_ram(void);
 extern void adjust_total_lowmem(void);
diff --git a/include/vbi/vdk_interface.h b/include/vbi/vdk_interface.h
index 9eef3b0..b9206da 100644
--- a/include/vbi/vdk_interface.h
+++ b/include/vbi/vdk_interface.h
@@ -127,8 +127,18 @@
 #define VB_STATUS_LR                    4*29
 #define VB_STATUS_R3                    4*30
 #define VB_STATUS_R4                    4*31
+
+#if defined(CONFIG_E500)
 #define VB_STATUS_ESR                   4*34
 #define VB_STATUS_DEAR                  4*37
+#elif defined(CONFIG_6xx)
+#define VB_STATUS_DAR                   4*32
+#define VB_STATUS_DSISR                 4*33
+#define VB_STATUS_ESR                   VB_STATUS_DSISR
+#else
+#error unsupported CPU family
+#endif
+
 #endif
 /* Assembler offsets for vb_config */
 #define VB_CONFIG_VBSTATUS		(((2+0) * 8) + 4)
-- 
1.6.5.2

