From 3a6feb31f5607ad31b7a6e9da65d366ea860490c Mon Sep 17 00:00:00 2001
From: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
Date: Mon, 24 May 2010 20:28:02 -0400
Subject: [PATCH 05/11] WRHV: Paravirtualize TLB cache flushing

TLB Cache flushing on the e500 version of the Hypervisor
is different then that of the P4080.

Signed-off-by: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
---
 arch/powerpc/include/asm/pv_pgtable-ppc32.h |    2 -
 arch/powerpc/mm/wrhv_tlb_nohash_low.S       |   74 ++-------------------------
 2 files changed, 5 insertions(+), 71 deletions(-)

diff --git a/arch/powerpc/include/asm/pv_pgtable-ppc32.h b/arch/powerpc/include/asm/pv_pgtable-ppc32.h
index 2d8175f..81c44a1 100644
--- a/arch/powerpc/include/asm/pv_pgtable-ppc32.h
+++ b/arch/powerpc/include/asm/pv_pgtable-ppc32.h
@@ -38,9 +38,7 @@
 #define _PMD_PRESENT_MASK	(_PMD_PRESENT)
 #define _PMD_BAD		(~PAGE_MASK & ~0x03)
 
-#ifndef CONFIG_PARAVIRT
 #define _PAGE_BASE		(_PAGE_PRESENT | _PAGE_ACCESSED | VMMU_PROT_USER_READ)
-#endif
 
 #define PFN_SIZE		(1UL << PFN_SHIFT_OFFSET)
 #define PFN_MASK		(~(PFN_SIZE-1))
diff --git a/arch/powerpc/mm/wrhv_tlb_nohash_low.S b/arch/powerpc/mm/wrhv_tlb_nohash_low.S
index 52a266a..5ecc370 100644
--- a/arch/powerpc/mm/wrhv_tlb_nohash_low.S
+++ b/arch/powerpc/mm/wrhv_tlb_nohash_low.S
@@ -32,79 +32,15 @@
 #include <asm/asm-offsets.h>
 #include <asm/processor.h>
 
-#if defined(CONFIG_FSL_BOOKE) && !defined(CONFIG_PPC85xx_VT_MODE)
-/*
- * FSL BookE implementations.
- *
- * Since feature sections are using _SECTION_ELSE we need
- * to have the larger code path before the _SECTION_ELSE
- */
-
-/*
- * Flush MMU TLB on the local processor
- */
+#if defined(CONFIG_WRHV_E500) && !defined(CONFIG_PPC85xx_VT_MODE)
 _GLOBAL(_tlbil_all)
-BEGIN_MMU_FTR_SECTION
-	li	r3,(MMUCSR0_TLBFI)@l
-	mtspr	SPRN_MMUCSR0, r3
-1:
-	mfspr	r3,SPRN_MMUCSR0
-	andi.	r3,r3,MMUCSR0_TLBFI@l
-	bne	1b
-MMU_FTR_SECTION_ELSE
-	PPC_TLBILX_ALL(0,0)
-ALT_MMU_FTR_SECTION_END_IFCLR(MMU_FTR_USE_TLBILX)
-	msync
-	isync
-	blr
-
 _GLOBAL(_tlbil_pid)
-BEGIN_MMU_FTR_SECTION
-	slwi	r3,r3,16
-	mfmsr	r10
-	wrteei	0
-	mfspr	r4,SPRN_MAS6	/* save MAS6 */
-	mtspr	SPRN_MAS6,r3
-	PPC_TLBILX_PID(0,0)
-	mtspr	SPRN_MAS6,r4	/* restore MAS6 */
-	wrtee	r10
-MMU_FTR_SECTION_ELSE
-	li	r3,(MMUCSR0_TLBFI)@l
-	mtspr	SPRN_MMUCSR0, r3
-1:
-	mfspr	r3,SPRN_MMUCSR0
-	andi.	r3,r3,MMUCSR0_TLBFI@l
-	bne	1b
-ALT_MMU_FTR_SECTION_END_IFSET(MMU_FTR_USE_TLBILX)
-	msync
-	isync
-	blr
-
-/*
- * Flush MMU TLB for a particular address, but only on the local processor
- * (no broadcast)
- */
 _GLOBAL(__tlbil_va)
-	mfmsr	r10
-	wrteei	0
-	slwi	r4,r4,16
-	ori	r4,r4,(MAS6_ISIZE(BOOK3E_PAGESZ_4K))@l
-	mtspr	SPRN_MAS6,r4		/* assume AS=0 for now */
-BEGIN_MMU_FTR_SECTION
-	tlbsx	0,r3
-	mfspr	r4,SPRN_MAS1		/* check valid */
-	andis.	r3,r4,MAS1_VALID@h
-	beq	1f
-	rlwinm	r4,r4,0,1,31
-	mtspr	SPRN_MAS1,r4
-	tlbwe
-MMU_FTR_SECTION_ELSE
-	PPC_TLBILX_VA(0,r3)
-ALT_MMU_FTR_SECTION_END_IFCLR(MMU_FTR_USE_TLBILX)
-	msync
-	isync
-1:	wrtee	r10
+	lis     r0, VBI_SYS_tlb_flush@h
+	ori     r0, r0, VBI_SYS_tlb_flush@l
+	sc
 	blr
+
 #elif defined(CONFIG_FSL_BOOKE) && defined(CONFIG_PPC85xx_VT_MODE)
 /*
  * FSL BookE implementations on Wind River HY.
-- 
1.6.5.2

