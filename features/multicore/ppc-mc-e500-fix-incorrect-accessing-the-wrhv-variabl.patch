From 537f2cb24b7bc12e96e96dea03974533a93175db Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Thu, 26 Aug 2010 04:54:58 -0700
Subject: [PATCH] ppc-mc/e500: fix incorrect accessing the wrhv variable

We should use lis & lwz to access the variable like the following:
        lis     r12,wr_control@h
        lwz     r12,wr_control@l(r12)

Otherwise it's possible to corrupt other memory space.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/head_wrhv.S     |    2 +-
 arch/powerpc/kernel/wrhv_entry_32.S |    6 +++---
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/arch/powerpc/kernel/head_wrhv.S b/arch/powerpc/kernel/head_wrhv.S
index 1233f2c..8ae74a0 100644
--- a/arch/powerpc/kernel/head_wrhv.S
+++ b/arch/powerpc/kernel/head_wrhv.S
@@ -728,7 +728,7 @@ _GLOBAL(giveup_spe)
 	evstddx	evr6, r4, r3		/* save off accumulator */
 
 	lis	r6,wr_status@ha
-	ori	r6,r6,wr_status@l
+	lwz     r6,wr_status@l(r6)
 	lwz	r6,VB_STATUS_SPEFSCR(r6)
 	stw	r6,THREAD_SPEFSCR(r3)	/* save spefscr register value */
 	beq	1f
diff --git a/arch/powerpc/kernel/wrhv_entry_32.S b/arch/powerpc/kernel/wrhv_entry_32.S
index 5ce9ec0..27d4d16 100644
--- a/arch/powerpc/kernel/wrhv_entry_32.S
+++ b/arch/powerpc/kernel/wrhv_entry_32.S
@@ -385,7 +385,7 @@ _GLOBAL(paravirt_switch)
 #ifdef CONFIG_SPE
 BEGIN_FTR_SECTION
 	lis	r12,wr_status@ha
-	ori	r12,r12,wr_status@l
+	lwz	r12,wr_status@l(r12)
 	lwz	r12,VB_STATUS_SPEFSCR(r12)  /* save spefscr register value */
 	stw	r12,THREAD+THREAD_SPEFSCR(r2)
 END_FTR_SECTION_IFSET(CPU_FTR_SPE)
@@ -415,8 +415,8 @@ END_FTR_SECTION_IFSET(CPU_FTR_SPE)
 #ifdef CONFIG_SPE
 BEGIN_FTR_SECTION
 	lwz	r0,THREAD+THREAD_SPEFSCR(r2)
-	lis	r12,wr_control@h
-	ori	r12,r12,wr_control@l
+	lis	r12,wr_control@ha
+	lwz	r12,wr_control@l(r12)
 	stw	r0,VB_CONTROL_SPEFSCR(r12)	/* restore SPEFSCR reg */
 END_FTR_SECTION_IFSET(CPU_FTR_SPE)
 #endif /* CONFIG_SPE */
-- 
1.6.5.2

