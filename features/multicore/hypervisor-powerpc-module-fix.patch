From 035bbbaa9e20c6cbd25bc4d8e808e6fe5bc3ca34 Mon Sep 17 00:00:00 2001
From: WRS Support <support@windriver.com>
Date: Fri, 2 Oct 2009 16:12:13 -0400
Subject: [PATCH 16/18] hypervisor: powerpc module fix

Replace vmalloc(...) with kmalloc(..., GFP_KERNEL) for PPC.
---
 kernel/module.c |   22 +++++++++++++++++++++-
 1 files changed, 21 insertions(+), 1 deletions(-)

diff --git a/kernel/module.c b/kernel/module.c
index 496d793..b11b898 100644
--- a/kernel/module.c
+++ b/kernel/module.c
@@ -2047,7 +2047,12 @@ static noinline struct module *load_module(void __user *umod,
 
 	/* Suck in entire file: we'll want most of it. */
 	/* vmalloc barfs on "unusual" numbers.  Check here */
+
+#if defined(CONFIG_WRHV) && defined(CONFIG_PPC)
+	if (len > 64 * 1024 * 1024 || (hdr = kmalloc(len, GFP_KERNEL)) == NULL)
+#else
 	if (len > 64 * 1024 * 1024 || (hdr = vmalloc(len)) == NULL)
+#endif
 		return ERR_PTR(-ENOMEM);
 
 	if (copy_from_user(hdr, umod, len) != 0) {
@@ -2425,12 +2430,19 @@ static noinline struct module *load_module(void __user *umod,
 	 * Do it before processing of module parameters, so the module
 	 * can provide parameter accessor functions of its own.
 	 */
-	if (mod->module_init)
+	if (mod->module_init) {
 		flush_icache_range((unsigned long)mod->module_init,
 				   (unsigned long)mod->module_init
 				   + mod->init_size);
+#if defined(CONFIG_WRHV) && defined(CONFIG_PPC)
+		flush_dcache_page(virt_to_page(mod->module_init));
+#endif
+	}
 	flush_icache_range((unsigned long)mod->module_core,
 			   (unsigned long)mod->module_core + mod->core_size);
+#if defined(CONFIG_WRHV) && defined(CONFIG_PPC)
+	flush_dcache_page(virt_to_page(mod->module_core));
+#endif
 
 	set_fs(old_fs);
 
@@ -2459,7 +2471,11 @@ static noinline struct module *load_module(void __user *umod,
 	add_notes_attrs(mod, hdr->e_shnum, secstrings, sechdrs);
 
 	/* Get rid of temporary copy */
+#if defined(CONFIG_WRHV) && defined(CONFIG_PPC)
+	kfree(hdr);
+#else
 	vfree(hdr);
+#endif
 
 	trace_module_load(mod);
 
@@ -2491,7 +2507,11 @@ static noinline struct module *load_module(void __user *umod,
 	kfree(args);
 	kfree(strmap);
  free_hdr:
+#if defined(CONFIG_WRHV) && defined(CONFIG_PPC)
+	kfree(hdr);
+#else
 	vfree(hdr);
+#endif
 	return ERR_PTR(err);
 
  truncated:
-- 
1.6.5.2

