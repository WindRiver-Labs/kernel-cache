From 6af115b22974356953e7eddadaa57ac50dabd39e Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Fri, 23 Apr 2010 15:28:58 +0800
Subject: [PATCH] x86 guest: fix build error when turn off CONFIG_SMP

Add CONFIG_SMP restriction at where wrhv_calibrate_smp_cpus
is called.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/x86/kernel/setup.c |    2 +-
 include/asm-x86/wrhv.h  |    2 ++
 2 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/arch/x86/kernel/setup.c b/arch/x86/kernel/setup.c
index e44fa64..a6dd993 100644
--- a/arch/x86/kernel/setup.c
+++ b/arch/x86/kernel/setup.c
@@ -911,7 +911,7 @@ void __init setup_arch(char **cmdline_p)
 
 	e820_setup_gap();
 
-#ifdef CONFIG_WRHV
+#if defined(CONFIG_WRHV) && defined(CONFIG_SMP)
 	wrhv_calibrate_smp_cpus();
 #endif
 
diff --git a/include/asm-x86/wrhv.h b/include/asm-x86/wrhv.h
index 4f29b66..503e799 100644
--- a/include/asm-x86/wrhv.h
+++ b/include/asm-x86/wrhv.h
@@ -29,7 +29,9 @@ extern void wrhv_vtlb_op(unsigned int, unsigned long,
 			 unsigned long, unsigned long);
 extern int wrhv_pci_bus_scan(void);
 extern int wrhv_pci_probeonly;
+#ifdef CONFIG_SMP
 extern void wrhv_calibrate_smp_cpus(void);
+#endif
 
 extern unsigned long __initrd_start, __initrd_end;
 
-- 
1.6.0.4

