From c3944354388d4f769b5830f973836b729b9c7fc1 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Wed, 28 Jul 2010 20:02:00 -0700
Subject: [PATCH] ppc-mc/fsl_mpc8572_ds: support PCIE

Add the law configuration function like fsl_p4080 since we should
configure law for PCIE space if necessary. And fix one small typo
while setting target_id to law attribute filed.

And define one function with DECLARE_PCI_FIXUP_EARLY to clean those
previous BASE setting from the bootloader. You know we should set
them as guest OS expect.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/vbi/wrhv.c            |   17 ++++++++++++++++-
 arch/powerpc/platforms/85xx/wrhv_8572ds.c |    2 ++
 2 files changed, 18 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 1d2028b..1214c2b 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -509,7 +509,7 @@ int ppc_setup_pci_law( struct device_node *dev)
 			printk(KERN_INFO "  Setup LAW for PCIE Space  0x%016llx..0x%016llx \n", 
 					cpu_addr, cpu_addr + size - 1);
 
-			attr = LAW_EN | (pcie_index < 20) | (__ilog2(size) - 1) ;
+			attr = LAW_EN | (pcie_index << 20) | (__ilog2(size) - 1) ;
 			ppc_setup_law(pcie_index, cpu_addr, attr);
 		}
 	}
@@ -1860,4 +1860,19 @@ void pci_msi_disable(struct pci_dev *dev)
 	}
 }
 DECLARE_PCI_FIXUP_FINAL(PCI_ANY_ID, PCI_ANY_ID, pci_msi_disable);
+/* Clean those previous BASE set since we'll re-configure these for guest OS. */
+void wrhv_pci_fixup_resource(struct pci_dev* dev)
+{
+	/* There are two BASE REGs regardless of head type. */
+	pci_write_config_dword(dev, PCI_BASE_ADDRESS_0, 0);
+	pci_write_config_dword(dev, PCI_BASE_ADDRESS_1, 0);
+
+	if (dev->hdr_type == PCI_HEADER_TYPE_NORMAL) {
+		pci_write_config_dword(dev, PCI_BASE_ADDRESS_2, 0);
+		pci_write_config_dword(dev, PCI_BASE_ADDRESS_3, 0);
+		pci_write_config_dword(dev, PCI_BASE_ADDRESS_4, 0);
+		pci_write_config_dword(dev, PCI_BASE_ADDRESS_5, 0);
+	}
+}
+DECLARE_PCI_FIXUP_EARLY(PCI_ANY_ID, PCI_ANY_ID, wrhv_pci_fixup_resource);
 #endif
diff --git a/arch/powerpc/platforms/85xx/wrhv_8572ds.c b/arch/powerpc/platforms/85xx/wrhv_8572ds.c
index eebf4b2..4c367b3 100644
--- a/arch/powerpc/platforms/85xx/wrhv_8572ds.c
+++ b/arch/powerpc/platforms/85xx/wrhv_8572ds.c
@@ -116,6 +116,8 @@ static void __init mpc85xx_ds_setup_arch(void)
 			hose = pci_find_hose_for_OF_device(np);
 			max = min(max, hose->dma_window_base_cur +
 					hose->dma_window_size);
+			
+			ppc_setup_pci_law(np);
 
 		}
 	}
-- 
1.6.5.2

