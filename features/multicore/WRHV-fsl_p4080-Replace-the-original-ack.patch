From 26e2c56b624af2b961f39a463c4f5e56e5ad243a Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Wed, 12 May 2010 16:39:52 +0800
Subject: [PATCH] WRHV/fsl_p4080: Replace the original ack

Implement a ack function to call the correct VBI to ack the vioapic interrupt
or direct interrupt.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/vbi/syscalls.S |   17 +++++++++++++++++
 include/vbi/vbi.h                  |    1 +
 kernel/vbi/wrhv.c                  |   18 +++++++++++++++++-
 3 files changed, 35 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/syscalls.S b/arch/powerpc/kernel/vbi/syscalls.S
index 4e06012..b114ff6 100644
--- a/arch/powerpc/kernel/vbi/syscalls.S
+++ b/arch/powerpc/kernel/vbi/syscalls.S
@@ -35,6 +35,7 @@ FUNC_EXPORT(vbi_vb_read_reg)
 FUNC_EXPORT(vbi_vb_write_reg)
 FUNC_EXPORT(vbi_io_apic_op)
 FUNC_EXPORT(vbi_io_apic_ioctl)
+FUNC_EXPORT(vbi_di_eoi)
 FUNC_EXPORT(vbi_hy_ioctl)
 FUNC_EXPORT(vbi_ctx_ctl)
 FUNC_EXPORT(vbi_send)
@@ -738,6 +739,22 @@ vbi_hcall(vbi_vb_write_reg, RegsWrite_op)
 vbi_hcall(vbi_vcore_irq_redirect, intRedirect)
 
 /*
+ * vbiDirectInterruptEOI - clear last interrupt
+ *
+ * This system call interfaces to the virtual board to clear the last PIC
+ * interrupt enabling another interrupt to be triggered in the hardware.
+ * Should be used only when Virtual board is using direct interrupts.
+ *
+ * C interface:
+ *
+ *   vbiDirectInterruptEOI ()
+ *
+ * Returns: NONE
+ *
+ */
+vbi_hcall(vbi_di_eoi, pic_EOI)
+
+/*
  * vbi_vb_remote - VB remote operations
  *
  * This system call interfaces to the virtual board and requests for
diff --git a/include/vbi/vbi.h b/include/vbi/vbi.h
index 7a539ca..97f2a2a 100644
--- a/include/vbi/vbi.h
+++ b/include/vbi/vbi.h
@@ -530,6 +530,7 @@ extern int32_t vbi_get_vioapic_vec(uint32_t irq);
 extern int32_t vbi_unmask_vioapic_irq(uint32_t irq);
 extern int32_t vbi_mask_vioapic_irq(uint32_t irq);
 extern int32_t vbi_ack_vioapic_irq(uint32_t irq);
+extern asmlinkage void vbi_di_eoi(void);
 extern int32_t vbi_send_vioapic_irq(uint32_t irq, uint32_t filter,
 				      uint32_t target);
 extern int32_t vbi_send_vioapic_irq(uint32_t irq, uint32_t filter,
diff --git a/kernel/vbi/wrhv.c b/kernel/vbi/wrhv.c
index bf02386..b288af5 100644
--- a/kernel/vbi/wrhv.c
+++ b/kernel/vbi/wrhv.c
@@ -74,6 +74,22 @@ static void wrhv_ack_irq(unsigned int irq)
 	vbi_ack_vioapic_irq(irq);
 }
 
+#ifdef CONFIG_PPC
+extern int wrhv_dir_irq;
+static void wrhv_eoi_irq(unsigned int irq)
+{
+	if (wrhv_dir_irq)
+		vbi_di_eoi();
+	else
+		vbi_ack_vioapic_irq(irq);
+}
+#else
+static void wrhv_eoi_irq(unsigned int irq)
+{
+	vbi_ack_vioapic_irq(irq);
+}
+#endif
+
 static void wrhv_maskack_irq(unsigned int irq)
 {
 	if (irq != 0)
@@ -326,7 +342,7 @@ struct irq_chip wrhv_irq_chip = {
 	.enable		= wrhv_enable_irq,
 	.unmask		= wrhv_unmask_irq,
 	.mask_ack	= wrhv_maskack_irq,
-	.eoi		= wrhv_ack_irq,
+	.eoi		= wrhv_eoi_irq,
 };
 
 #ifdef CONFIG_SMP
-- 
1.7.3.3

