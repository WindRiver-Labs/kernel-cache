From 18a4b9fdb92b2ecd130632a65822b12739e6f60e Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Sat, 16 Nov 2013 15:03:26 +0800
Subject: [PATCH 1/2] wrhv: pci: Assign correct memory space to BARs

Guestos mark the device memory space as E820_RESERVED so as to avoid
conflicts with normal physical memory, however, during PCI hotplug
operation, when PCI driver rescans for available memory resource for
the previously removed PCI device, it will skip the the E820 reserved
memory space and may fail to assign the memory space to BAR.

We should not skip the E820 reserved memory space during rescanning
since this is really the exact memory space which the PCI device
needed, furthermore, to avoid EPT violation exception, we should
also ensure that the memory space which is assigned to PCI BARs
must be the same with the XML configuration.

Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
Signed-off-by: wenlin.kang <wenlin.kang@windriver.com>
---
 arch/x86/kernel/resource.c |    2 ++
 drivers/pci/bus.c          |    4 ++++
 2 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/x86/kernel/resource.c b/arch/x86/kernel/resource.c
index 2a26819..14a2b0c 100644
--- a/arch/x86/kernel/resource.c
+++ b/arch/x86/kernel/resource.c
@@ -43,6 +43,8 @@ void arch_remove_reservations(struct resource *avail)
 			avail->start = BIOS_END;
 		resource_clip(avail, BIOS_ROM_BASE, BIOS_ROM_END);
 
+#ifndef CONFIG_WRHV
 		remove_e820_regions(avail);
+#endif
 	}
 }
diff --git a/drivers/pci/bus.c b/drivers/pci/bus.c
index 628ea20..17e5903 100644
--- a/drivers/pci/bus.c
+++ b/drivers/pci/bus.c
@@ -115,7 +115,11 @@ pci_bus_alloc_resource(struct pci_bus *bus, struct resource *res,
 
 		/* Ok, try it out.. */
 		ret = allocate_resource(r, res, size,
+#ifdef CONFIG_WRHV
+					res->start ? : min,
+#else
 					r->start ? : min,
+#endif
 					max, align,
 					alignf, alignf_data);
 		if (ret == 0)
-- 
1.7.0

