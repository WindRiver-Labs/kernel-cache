From 07d62cb0e1c3d934a717ec763be61900ca2abbd5 Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Mon, 1 Apr 2013 17:13:56 +0800
Subject: [PATCH] wrhv: vbi: add support for guest memory size bigger than 4GB

introduce a new vb_config entity for giving bigger than 4GB
memory to the guest.

Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 arch/arm/kernel/vbi/wrhv.c     |    3 ++-
 arch/powerpc/kernel/vbi/wrhv.c |    3 ++-
 arch/x86/kernel/vbi/wrhv.c     |    5 ++++-
 include/vbi/compat.h           |    1 +
 include/vbi/interface.h        |    4 ++++
 5 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/arch/arm/kernel/vbi/wrhv.c b/arch/arm/kernel/vbi/wrhv.c
index d300e62..2ea0f22 100644
--- a/arch/arm/kernel/vbi/wrhv.c
+++ b/arch/arm/kernel/vbi/wrhv.c
@@ -92,7 +92,8 @@ int wrhv_find_direct_interrupt(int intr_candidate)
 
 unsigned long __init wrhv_find_end_of_memory(void)
 {
-	return wr_config->phys_mem_size;
+	return wr_config->phys_mem_size ? wr_config->phys_mem_size :
+					  wr_config->phys_mem_size_64;
 }
 
 char wrhv_super_early_stack[WRHV_SUPER_EARLY_STACK_SIZE];
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index db09a93..956fdf3 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -385,7 +385,8 @@ void wrhv_mapping(void)
 
 unsigned long __init wrhv_find_end_of_memory(void)
 {
-	return wr_config->phys_mem_size;
+	return wr_config->phys_mem_size ? wr_config->phys_mem_size :
+					  wr_config->phys_mem_size_64;
 }
 
 int __init wrhv_early_init_dt_scan_memory_ppc(unsigned long node,
diff --git a/arch/x86/kernel/vbi/wrhv.c b/arch/x86/kernel/vbi/wrhv.c
index 328c44d..25a61c6 100644
--- a/arch/x86/kernel/vbi/wrhv.c
+++ b/arch/x86/kernel/vbi/wrhv.c
@@ -550,7 +550,10 @@ void wrhv_cpu_workarounds(struct cpuinfo_x86 *c)
 char *__init wrhv_memory_setup(void)
 {
 	char *who = "WRHV-e820";
-	e820_add_region(0, wr_config->phys_mem_size, E820_RAM);
+	if (wr_config->phys_mem_size)
+		e820_add_region(0, wr_config->phys_mem_size, E820_RAM);
+	else
+		e820_add_region(0, wr_config->phys_mem_size_64, E820_RAM);
 	return who;
 
 }
diff --git a/include/vbi/compat.h b/include/vbi/compat.h
index 960eff5..b61a395 100644
--- a/include/vbi/compat.h
+++ b/include/vbi/compat.h
@@ -102,6 +102,7 @@
 #define memoryAliasSize		mem_alias_size
 #define memoryAliasAddress	mem_alias_addr
 #define physicalMemorySize	phys_mem_size
+#define physicalMemorySize64	phys_mem_size_64
 
 #define numInt			num_int
 #define numSm			num_sm
diff --git a/include/vbi/interface.h b/include/vbi/interface.h
index 5ea17ef..150cb78 100644
--- a/include/vbi/interface.h
+++ b/include/vbi/interface.h
@@ -715,6 +715,10 @@ struct vb_config
 	/* guest type */
 
 	uint32_t   guestOS;
+
+	/* main memory configuration settings 64 bit */
+
+	uint64_t  phys_mem_size_64; /* the vbPhysical size of RAM 64 bit */
 };
 
 #endif /*_ASMLANGUAGE */
-- 
1.7.0

