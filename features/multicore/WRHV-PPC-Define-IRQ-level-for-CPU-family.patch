From ae13d981ab1b4f4de69eba9f4ab6dc14abbbccfe Mon Sep 17 00:00:00 2001
From: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
Date: Wed, 19 May 2010 14:19:14 -0400
Subject: [PATCH 10/11] WRHV/PPC: Define IRQ level for CPU family

The hypervisor's definition of interrupt enabling and/or disabling is
completely different based on the board / CPU family. (e500mc vs e500)

This solution takes the guess work out of what 0 and 1 means.
It is significantly more simple then changing all references
to intDisabled and intPending.

The definition of intPending and intDisabled are hard coded
though out the Linux kernel as well as the hypervisor.

During context switch and exception handling the hypervisor
is hard coded to look for -1 or 0 for the oldIntDisable
and newIntdisable etc.

Signed-off-by: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
---
 arch/powerpc/include/asm/pv_hw_irq.h |   22 +++++++++++++++++-----
 1 files changed, 17 insertions(+), 5 deletions(-)

diff --git a/arch/powerpc/include/asm/pv_hw_irq.h b/arch/powerpc/include/asm/pv_hw_irq.h
index 694459b..7552c67 100644
--- a/arch/powerpc/include/asm/pv_hw_irq.h
+++ b/arch/powerpc/include/asm/pv_hw_irq.h
@@ -19,6 +19,14 @@ extern void wrhv_int_lock(void);
 extern void wrhv_int_unlock(int lvl);
 extern int wrhv_int_lvl_get (void);
 
+#ifdef CONFIG_WRHV_E500
+#define IRQS_ENABLED 0
+#define IRQS_DISABLED -1
+#elif CONFIG_WRHV_P4080
+#define IRQS_ENABLED 1
+#define IRQS_DISABLED 0
+#endif
+
 /* undefine native implementation */
 #undef raw_local_irq_restore
 #undef raw_local_irq_disable
@@ -47,19 +55,23 @@ static inline void pv_local_irq_save_ptr(unsigned long *flags)
         wrhv_int_lock();
 }
 
-
-#define raw_local_irq_restore(flags)   (flags == 1 ? pv_local_irq_enable() : pv_local_irq_disable ())
 #define raw_local_irq_disable()        pv_local_irq_disable()
 #define raw_local_irq_enable()         pv_local_irq_enable()
 
 #define raw_local_save_flags(flags)    ((flags) = wrhv_int_lvl_get())
+#define raw_local_irq_restore(flags)   (flags == IRQS_ENABLED  \
+			 ? pv_local_irq_enable() : pv_local_irq_disable ())
+#define raw_irqs_disabled_flags(flags) (flags == IRQS_DISABLED)
+#define raw_irqs_disabled()		(wrhv_int_lvl_get() == IRQS_DISABLED)
+#ifdef CONFIG_WRHV_P4080DS
 #define raw_local_irq_save(flags)      do {    \
 		flags = wrhv_int_lvl_get();     \
 		pv_local_irq_disable();         \
-	} while (0)
+	} while (IRQS_DISABLED)
 
-#define raw_irqs_disabled()            (wrhv_int_lvl_get() == 0)
-#define raw_irqs_disabled_flags(flags) (flags == 0)
+#elif CONFIG_WRHV_E500
+#define raw_local_irq_save(flags)      pv_local_irq_save_ptr(&flags)
+#endif
 
 #define hard_irq_disable()             raw_local_irq_disable()
 
-- 
1.6.5.2

