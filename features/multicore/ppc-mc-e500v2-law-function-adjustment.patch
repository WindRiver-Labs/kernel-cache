From 8de429a6293fd1786c89f820f6837cd97f3df74a Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Tue, 26 Oct 2010 16:16:44 +0800
Subject: [PATCH] ppc-mc/e500v2: law function adjustment

split a new function ppc_prepare_law_setup from ppc_search_free_law
since such work only need to be done once.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/powerpc/kernel/vbi/wrhv.c |  104 +++++++++++++++++++++++-----------------
 1 files changed, 60 insertions(+), 44 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index a8ec9d6..2a30af2 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -377,65 +377,81 @@ unsigned int low_base = -1;
 unsigned int law_attrib = -1;
 unsigned int law_offset = 0x10;
 unsigned char *law_base;
-int ppc_search_free_law(int target_id, unsigned long long addr)
+int law_num;
+int law_prepare_done;
+int ppc_prepare_law_setup(void)
 {
 	struct device_node *dev;
-	int i, law_num = 0;
-	static int index = -1;
 	const int *prop;
 
-	dev = of_find_compatible_node(NULL, NULL, "fsl,corenet-law");
-	if (!dev) {
-		printk(KERN_ERR "%s: No corenet law device node.\n", __func__);
-		return -1;
-	}
+	if (law_prepare_done == 0) {
+		dev = of_find_compatible_node(NULL, NULL, "fsl,corenet-law");
+		if (!dev) {
+			printk(KERN_ERR
+				"%s: No corenet law device node.\n", __func__);
+			return -1;
+		}
 
-	law_base = of_iomap(dev, 0);
-	if (!law_base) {
-		printk(KERN_ERR "%s: Can't iomap corenet law.\n", __func__);
-		return -1;
-	}
+		law_base = of_iomap(dev, 0);
+		if (!law_base) {
+			printk(KERN_ERR
+				"%s: Can't iomap corenet law.\n", __func__);
+			return -1;
+		}
 
-	/* Get law numbers property */
-	prop = of_get_property(dev, "fsl,num-laws", NULL);
-	if (prop)
-		law_num = *prop;
-	else
-		return -1;
+		/* Get law numbers property */
+		prop = of_get_property(dev, "fsl,num-laws", NULL);
+		if (prop)
+			law_num = *prop;
+		else
+			return -1;
 
-	/* Get the high base offset for setting law address */
-	prop = of_get_property(dev, "high-base", NULL);
-	if (prop)
-		high_base = *prop;
-	else
-		return -1;
+		/* Get the high base offset for setting law address */
+		prop = of_get_property(dev, "high-base", NULL);
+		if (prop)
+			high_base = *prop;
+		else
+			return -1;
 
-	/* Get the low base offset for setting the law address 
-	no need to bail if this property is missing since the
-	8572 does not have this property */
-	prop = of_get_property(dev, "low-base", NULL);
-	if (prop)
-		low_base = *prop;
-
-	/* Get the law attribute used for setting law attributes */
-	prop = of_get_property(dev, "law-attrib", NULL);
-	if (prop)
-		law_attrib = *prop;
-	else
-		return -1;
+		/* Get the low base offset for setting the law address
+		no need to bail if this property is missing since the
+		8572 does not have this property */
+		prop = of_get_property(dev, "low-base", NULL);
+		if (prop)
+			low_base = *prop;
+
+		/* Get the law attribute used for setting law attributes */
+		prop = of_get_property(dev, "law-attrib", NULL);
+		if (prop)
+			law_attrib = *prop;
+		else
+			return -1;
+
+		/* Get the law register offset for setting law address */
+		prop = of_get_property(dev, "offset", NULL);
+		if (prop)
+			law_offset = *prop;
+
+		law_prepare_done = 1;
+	}
+
+	return 0;
+}
+
+int ppc_search_free_law(int target_id, unsigned long long addr)
+{
+	int i;
+	static int index = -1;
 
-	/* Get the law register offset for setting law address */
-	prop = of_get_property(dev, "offset", NULL);
-	if (prop)
-		law_offset = *prop;
+	ppc_prepare_law_setup();
 
 	if ((!ppc_md.set_law_attr) || (!ppc_md.set_law_base) || (!ppc_md.get_law_attr))
 		return -1;
 
 	for (i = index+1;i < law_num;i++) {
 		/* Firstly we should invalid those existed LAW we want configure. */
-		if (((ppc_md.get_law_attr(i) & LAW_TARGET_ID) == target_id) 
-			|| (ppc_md.get_law_base(i) == addr))
+		if (((ppc_md.get_law_attr(i) & LAW_TARGET_ID)
+		    == (target_id << 20)) || (ppc_md.get_law_base(i) == addr))
 			ppc_md.set_law_attr(i, 0);
 
 		/* Skip these used LAW item */
-- 
1.6.5.2

