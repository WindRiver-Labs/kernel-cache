From ba61f2c97c1d07c5db0f65bba4291106c0f890b9 Mon Sep 17 00:00:00 2001
From: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
Date: Tue, 15 Feb 2011 21:34:09 -0500
Subject: [PATCH 06/10] WRHV/ASID: Associate VMMU Handle and ASID to every MM

There needs to be a direct corelation between every
MM and VMMU Handle.  A VMMUHandle exists for the duration
of every allocated MM.  This association is used during
context creation and deletion.

Signed-off-by: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
---
 arch/powerpc/include/asm/mmu-book3e.h |    4 ++++
 arch/powerpc/kernel/vbi/wrhv.c        |    6 ++++++
 2 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/mmu-book3e.h b/arch/powerpc/include/asm/mmu-book3e.h
index 7469581..9e1119b 100644
--- a/arch/powerpc/include/asm/mmu-book3e.h
+++ b/arch/powerpc/include/asm/mmu-book3e.h
@@ -181,6 +181,10 @@ typedef struct {
 	unsigned int	id;
 	unsigned int	active;
 	unsigned long	vdso_base;
+#ifdef CONFIG_WRHV_ASID_OPTIMIZATION
+	unsigned int	asid;
+	unsigned long	vmmu_handle;
+#endif
 } mm_context_t;
 
 /* Page size definitions, common between 32 and 64-bit
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 9c1b3ca..9bb8bf4 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -1010,6 +1010,12 @@ void wrhv_vmmu_restore(void)
 	 */
 	wr_control->vmmu0 = wr_status->vmmu0;
 	wr_control->vmmu1 = wr_status->vmmu1;
+#ifdef CONFIG_WRHV_ASID_OPTIMIZATION
+	wr_control->vb_control_regs.vmmu_handle =
+		wr_status->vb_status_regs.vmmu_handle;
+	wr_control->vb_control_regs.asid =
+		wr_status->vb_status_regs.asid;
+#endif
 	return;
 }
 
-- 
1.6.5.2

