From b1a211e7a4b7dab108bc27f6f530923c8301c5de Mon Sep 17 00:00:00 2001
From: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
Date: Fri, 18 Feb 2011 14:59:36 -0500
Subject: [PATCH 08/10] WRHV/ASID: Update config and control struct in and out of exceptions

Linux needs to push the virtual ASID and VMMU Handle when
returning from and going to exceptions so that they are
in sync with the Hypervisor.

Signed-off-by: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
---
 arch/powerpc/kernel/head_wrhv.h     |   14 ++++++++++++++
 arch/powerpc/kernel/wrhv_entry_32.S |   12 ++++++++++++
 2 files changed, 26 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/head_wrhv.h b/arch/powerpc/kernel/head_wrhv.h
index 96b42e6..fb84304 100644
--- a/arch/powerpc/kernel/head_wrhv.h
+++ b/arch/powerpc/kernel/head_wrhv.h
@@ -38,6 +38,19 @@
 	 * registers contain their value before the system call was executed.
 	 */
 #ifndef	CONFIG_PPC85xx_VT_MODE
+#define ASID_OPT							\
+	lis     r9,wr_control@ha;					\
+	lwz     r9,wr_control@l(r9);					\
+	lwz     r12,VB_STATUS_VMMU0(r4);				\
+	stw     r12,VB_CONTROL_VMMU0(r9);				\
+	lwz     r12,VB_STATUS_VMMU_HANDLE(r4);				\
+	stw     r12,VB_CONTROL_VMMU_HANDLE(r9);				\
+	lwz     r12,VB_STATUS_ASID(r4);					\
+	stw     r12,VB_CONTROL_ASID(r9)
+#else
+#define ASID_OPT							\
+	nop
+#endif
 #undef NORMAL_EXCEPTION_PROLOG
 #define NORMAL_EXCEPTION_PROLOG						     \
         mr      r4,r1;                                                       \
@@ -65,6 +78,7 @@
         stw     r12,GPR4(r11);                                               \
         lwz     r12,VB_STATUS_CR(r4);                                        \
         stw     r12,_CCR(r11);                                               \
+        ASID_OPT;                                                            \
         lwz     r9,VB_STATUS_SRR1(r4);                                       \
 	rlwinm  r9,r9,0,18,15; /* Clear EE & PR bits */                      \
 	mr	r12, r4;                                                     \
diff --git a/arch/powerpc/kernel/wrhv_entry_32.S b/arch/powerpc/kernel/wrhv_entry_32.S
index 2d33f57..707e6cf 100644
--- a/arch/powerpc/kernel/wrhv_entry_32.S
+++ b/arch/powerpc/kernel/wrhv_entry_32.S
@@ -149,6 +149,18 @@ paravirt_transfer_to_handler_cont:
 	lwz	r11,VB_STATUS_OLD_INT_DISABLE(r12)
 	stw	r11,VB_CONTROL_NEW_INT_DISABLE(r9)
 
+#ifdef CONFIG_WRHV_ASID_OPTIMIZATION
+	/* Push the virtual ASID into the control struct */
+	lwz	r11,VB_STATUS_ASID(r12)
+	stw	r11,VB_CONTROL_ASID(r9)
+
+	/* Update the VMMU handle */
+	lwz	r11,VB_STATUS_VMMU_HANDLE(r12)
+	stw	r11,VB_CONTROL_VMMU_HANDLE(r9)
+
+	lwz	r11,VB_STATUS_VMMU0(r12)
+	stw	r11,VB_CONTROL_VMMU0(r9)
+#endif
 /*
 	lwz	r11,VB_STATUS_CR(r12)
 	stw	r11,VB_CONTROL_CR(r9)
-- 
1.6.5.2

