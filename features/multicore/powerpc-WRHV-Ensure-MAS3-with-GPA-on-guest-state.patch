From 599f7ba9a727f19cc433dc00ecf4af8392ff8de2 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Tue, 23 Mar 2010 20:10:52 -0700
Subject: [PATCH] powerpc: WRHV: Ensure MAS3 with GPA on guest state

The guest OS should pass GPA, guest physical address, to MAS3. Then hypervisor
will update MAS3 with RPA, real physical address, while executing those TLB
privileged instructions. So if guest OS execute continuously these instructions
twice or more, RPA will be kept on MAS3 to be passed incorrectly for the hypervisor
from the second.

The above is generated on some exceptions such as Data/Instruction TLB exception
on SMP. So here re-write GPA to MAS3 before next tlb instruction.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
Integrated-by: Mark Asselstine <mark.asselstine@windriver.com>
---
 arch/powerpc/kernel/head_wrhv.S |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/head_wrhv.S b/arch/powerpc/kernel/head_wrhv.S
index 64839c6..f76689f 100644
--- a/arch/powerpc/kernel/head_wrhv.S
+++ b/arch/powerpc/kernel/head_wrhv.S
@@ -360,6 +360,12 @@ interrupt_base:
 7:	mfspr	r13, SPRN_MAS1
 	rlwinm	r13, r13, 0, 1, 31	/* Clear Valid bit */
 	mtspr	SPRN_MAS1, r13
+
+	/* We have to restore GPA to MAS3 when execute continuously 
+	 * tlb instruction.
+	 */
+	mtspr   SPRN_MAS3,r10
+
 	tlbwe
 
 	b	5b		/* Try again */
-- 
1.6.0.4

