From 09f86163ed2fc1c31b6685406ed6ff5a9097ecb6 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Wed, 15 Dec 2010 14:55:28 +0800
Subject: [PATCH 28/38] WRHV: MIPS: Paravirtualize copy_thread function

In native Linux, kernel state is determined by ST0_CU0 bit, but on GOS
ST0_CU0 is always zero, so KSU_SUPERVISOR is used to determine if thread
is kernel thread or userspace thread.
And, get CP0 status value from VB_STATUS instead of physical register.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/kernel/process.c |   12 ++++++++++++
 1 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/arch/mips/kernel/process.c b/arch/mips/kernel/process.c
index bc660c0..041d5df 100644
--- a/arch/mips/kernel/process.c
+++ b/arch/mips/kernel/process.c
@@ -43,6 +43,10 @@
 #include <asm/inst.h>
 #include <asm/stacktrace.h>
 
+#ifdef CONFIG_WRHV
+#include <vbi/vbi.h>
+#endif
+
 DEFINE_TRACE(sched_kthread_create);
 
 /*
@@ -147,7 +151,11 @@ int copy_thread(unsigned long clone_flags, unsigned long usp,
 	childregs->regs[2] = 0;	/* Child gets zero as return value */
 	regs->regs[2] = p->pid;
 
+#ifdef CONFIG_WRHV
+	if (childregs->cp0_status & KSU_SUPERVISOR) {
+#else
 	if (childregs->cp0_status & ST0_CU0) {
+#endif
 		childregs->regs[28] = (unsigned long) ti;
 		childregs->regs[29] = childksp;
 		ti->addr_limit = KERNEL_DS;
@@ -162,7 +170,11 @@ int copy_thread(unsigned long clone_flags, unsigned long usp,
 	 * New tasks lose permission to use the fpu. This accelerates context
 	 * switching for most programs since they don't use the fpu.
 	 */
+#ifdef CONFIG_WRHV
+	p->thread.cp0_status = wr_vb_status->vb_status_regs.sr & ~(ST0_CU2|ST0_CU1);
+#else
 	p->thread.cp0_status = read_c0_status() & ~(ST0_CU2|ST0_CU1);
+#endif
 	childregs->cp0_status &= ~(ST0_CU2|ST0_CU1);
 
 #ifdef CONFIG_MIPS_MT_SMTC
-- 
1.6.5.2

