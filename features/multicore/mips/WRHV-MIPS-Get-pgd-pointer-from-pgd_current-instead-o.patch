From 985bf42e65d2ed8069dc408d9fa3d77b542ec75c Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Tue, 1 Mar 2011 09:37:37 +0800
Subject: [PATCH 11/38] WRHV: MIPS: Get pgd pointer from pgd_current instead of CP0 context

Since GOS can't access any CP0 register, so disable MIPS_PGD_C0_CONTEXT
on GOS. GOS get pdg pointer from pgd_current insteadof CP0 context.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/Kconfig                   |    2 +-
 arch/mips/include/asm/mmu_context.h |    6 ++++++
 arch/mips/mm/tlbex.c                |    7 +++++++
 3 files changed, 14 insertions(+), 1 deletions(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index 168b319..cf2a482 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -1479,7 +1479,7 @@ config CPU_SUPPORTS_UNCACHED_ACCELERATED
 	bool
 config MIPS_PGD_C0_CONTEXT
 	bool
-	default y if 64BIT && CPU_MIPSR2
+	default y if 64BIT && CPU_MIPSR2 && !WRHV
 
 #
 # Set to y for ptrace access to watch registers.
diff --git a/arch/mips/include/asm/mmu_context.h b/arch/mips/include/asm/mmu_context.h
index d959273..25e32d6 100644
--- a/arch/mips/include/asm/mmu_context.h
+++ b/arch/mips/include/asm/mmu_context.h
@@ -68,10 +68,16 @@ extern unsigned long pgd_current[];
 	TLBMISS_HANDLER_SETUP_PGD(swapper_pg_dir)
 #endif
 #ifdef CONFIG_64BIT
+#ifdef CONFIG_WRHV
+#define TLBMISS_HANDLER_SETUP()						\
+	back_to_back_c0_hazard();					\
+	TLBMISS_HANDLER_SETUP_PGD(swapper_pg_dir)
+#else
 #define TLBMISS_HANDLER_SETUP()						\
 	write_c0_context((unsigned long) smp_processor_id() << 26);	\
 	back_to_back_c0_hazard();					\
 	TLBMISS_HANDLER_SETUP_PGD(swapper_pg_dir)
+#endif /* CONFIG_WRHV */
 #endif
 #endif /* CONFIG_MIPS_PGD_C0_CONTEXT*/
 #if defined(CONFIG_CPU_R3000) || defined(CONFIG_CPU_TX39XX)
diff --git a/arch/mips/mm/tlbex.c b/arch/mips/mm/tlbex.c
index bdb39c3..9d83eff 100644
--- a/arch/mips/mm/tlbex.c
+++ b/arch/mips/mm/tlbex.c
@@ -30,6 +30,9 @@
 #include <asm/mmu_context.h>
 #include <asm/war.h>
 #include <asm/uasm.h>
+#ifdef CONFIG_WRHV
+#include <asm/mmu_context.h>
+#endif
 
 /*
  * TLB load/store/modify handlers.
@@ -179,6 +182,10 @@ static int check_for_high_segbits __cpuinitdata;
  * we cannot do r3000 under these circumstances.
  */
 
+#ifdef CONFIG_CPU_CAVIUM_OCTEON
+static int pgd_reg __cpuinitdata;
+#endif
+
 /*
  * The R3000 TLB handler is simple.
  */
-- 
1.6.5.2

