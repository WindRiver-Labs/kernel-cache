From d37c6450e33960d37b14550b9d6123aac1fa9590 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Tue, 21 Dec 2010 16:42:03 +0800
Subject: [PATCH 20/38] WRHV: MIPS: Paravirtualize exception rollback prologue

Native Linux need determine if exception occurs in wait function,
then need adjust EPC address to skip wait. On GOS, read current
EPC from VB_STATU, then write the updated EPC to VB_STATUS again.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/kernel/wrhv_genex.S |    7 +++++--
 1 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/arch/mips/kernel/wrhv_genex.S b/arch/mips/kernel/wrhv_genex.S
index 1e34f93..851017d 100644
--- a/arch/mips/kernel/wrhv_genex.S
+++ b/arch/mips/kernel/wrhv_genex.S
@@ -157,12 +157,15 @@ LEAF(r4k_wait)
 	FEXPORT(rollback_\handler)
 	.set	push
 	.set	noat
-	MFC0	k0, CP0_EPC
+	PTR_L	k0, wr_vb_status
+	LONG_L	k0, VB_STATUS_EPC(k0)
 	PTR_LA	k1, r4k_wait
 	ori	k0, 0x1f	/* 32 byte rollback region */
 	xori	k0, 0x1f
 	bne	k0, k1, 9f
-	MTC0	k0, CP0_EPC
+	nop
+	PTR_L	k1, wr_vb_status
+	LONG_S	k0, VB_STATUS_EPC(k1)
 9:
 	.set pop
 	.endm
-- 
1.6.5.2

