From a2bbd98c3f09b96f7e3e63227666996426f032ce Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Fri, 25 Feb 2011 11:19:42 +0800
Subject: [PATCH 33/38] WRHV: MIPS: Paravirtualize tlb init

In GOS side, TLB init is unnecessary since Hypervisor already
initialized TLB for VBs. To keep the consistency with native Linux,
tlb_init is still paravirtualized, but it does nothing.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/include/asm/paravirt.h |    6 ++++++
 arch/mips/kernel/paravirt.c      |   10 ++++++++++
 arch/mips/kernel/vbi/wrhv.c      |   17 +++++++++++++++++
 arch/mips/mm/tlb-r4k.c           |   10 +++++++++-
 4 files changed, 42 insertions(+), 1 deletions(-)

diff --git a/arch/mips/include/asm/paravirt.h b/arch/mips/include/asm/paravirt.h
index 5882571..9fcdaf8 100644
--- a/arch/mips/include/asm/paravirt.h
+++ b/arch/mips/include/asm/paravirt.h
@@ -12,6 +12,7 @@ struct pv_info {
  * native functions
  */
 extern void __init native_per_cpu_trap_init(void);
+extern void __init native_tlb_init(void);
 
 /*
  * paravirtual operations structure
@@ -20,7 +21,12 @@ struct pv_cpu_ops {
 	void (*per_cpu_trap_init)(void);
 };
 
+struct pv_mem_ops {
+	void (*tlb_init)(void);
+};
+
 extern struct pv_cpu_ops pv_cpu_ops;
+extern struct pv_mem_ops pv_mem_ops;
 
 #endif /* CONFIG_PARAVIRT */
 #endif	/* __ASM_PARAVIRT_H */
diff --git a/arch/mips/kernel/paravirt.c b/arch/mips/kernel/paravirt.c
index 63f272b..20cfbd8 100644
--- a/arch/mips/kernel/paravirt.c
+++ b/arch/mips/kernel/paravirt.c
@@ -43,9 +43,19 @@ struct pv_cpu_ops pv_cpu_ops = {
 	.per_cpu_trap_init = native_per_cpu_trap_init,
 };
 
+struct pv_mem_ops pv_mem_ops = {
+	.tlb_init = native_tlb_init,
+};
+
 void __init paravirt_per_cpu_trap_init(void)
 {
 	pv_cpu_ops.per_cpu_trap_init();
 }
 
+void __init paravirt_tlb_init(void)
+{
+	pv_mem_ops.tlb_init();
+}
+
 EXPORT_SYMBOL(pv_cpu_ops);
+EXPORT_SYMBOL(pv_mem_ops);
diff --git a/arch/mips/kernel/vbi/wrhv.c b/arch/mips/kernel/vbi/wrhv.c
index 5326deb..5ed9d10 100644
--- a/arch/mips/kernel/vbi/wrhv.c
+++ b/arch/mips/kernel/vbi/wrhv.c
@@ -91,6 +91,21 @@ void __cpuinit wrhv_per_cpu_trap_init(void)
 	TLBMISS_HANDLER_SETUP();
 }
 
+void __cpuinit wrhv_tlb_init(void)
+{
+	if (kernel_uses_smartmips_rixi) {
+		/*
+		 * Enable the no read, no exec bits, and enable large virtual
+		 * address.
+		 */
+		u32 pg = PG_RIE | PG_XIE;
+#ifdef CONFIG_64BIT
+		pg |= PG_ELPA;
+#endif
+		write_c0_pagegrain(pg);
+	}
+}
+
 void __init wrhv_init(void)
 {
 	/* initialize wr_config so that we can access
@@ -102,6 +117,8 @@ void __init wrhv_init(void)
 	vbi_init(wr_config);
 
 	pv_cpu_ops.per_cpu_trap_init = wrhv_per_cpu_trap_init;
+
+	pv_mem_ops.tlb_init = wrhv_tlb_init;
 }
 
 #ifdef CONFIG_PARAVIRT
diff --git a/arch/mips/mm/tlb-r4k.c b/arch/mips/mm/tlb-r4k.c
index 61ed787..78a76c1 100644
--- a/arch/mips/mm/tlb-r4k.c
+++ b/arch/mips/mm/tlb-r4k.c
@@ -439,7 +439,10 @@ static int __init set_ntlb(char *str)
 
 __setup("ntlb=", set_ntlb);
 
-void __cpuinit tlb_init(void)
+void paravirt_tlb_init(void)
+	__attribute__((weak, alias("native_tlb_init")));
+
+void __cpuinit native_tlb_init(void)
 {
 	/*
 	 * You should never change this register:
@@ -486,3 +489,8 @@ void __cpuinit tlb_init(void)
 
 	build_tlb_refill_handler();
 }
+
+void __cpuinit tlb_init(void)
+{
+	paravirt_tlb_init();
+}
-- 
1.6.5.2

