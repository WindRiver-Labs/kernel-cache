From a99036c7523845a1e8aae5dc80b8b8a7de27eeb6 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Tue, 1 Mar 2011 09:39:15 +0800
Subject: [PATCH 16/38] WRHV: MIPS: Replace vmap to kmap for mapping vdso

Since vmap maps vdso to xsseg, but Hyerpvisor can't support the TLB
mapping in this area now, so replace vmap to kmap to map vdso in
ksseg area.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/kernel/vdso.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/arch/mips/kernel/vdso.c b/arch/mips/kernel/vdso.c
index b773c11..308c98b 100644
--- a/arch/mips/kernel/vdso.c
+++ b/arch/mips/kernel/vdso.c
@@ -16,6 +16,7 @@
 #include <linux/elf.h>
 #include <linux/vmalloc.h>
 #include <linux/unistd.h>
+#include <linux/highmem.h>
 
 #include <asm/vdso.h>
 #include <asm/uasm.h>
@@ -43,7 +44,11 @@ static int __init init_vdso(void)
 	if (!vdso_page)
 		panic("Cannot allocate vdso");
 
+#ifdef CONFIG_WRHV
+	vdso = kmap_atomic(vdso_page, KM_USER0);
+#else
 	vdso = vmap(&vdso_page, 1, 0, PAGE_KERNEL);
+#endif
 	if (!vdso)
 		panic("Cannot map vdso");
 	clear_page(vdso);
@@ -59,7 +64,11 @@ static int __init init_vdso(void)
 			   __NR_O32_rt_sigreturn);
 #endif
 
+#ifdef CONFIG_WRHV
+	kunmap_atomic(vdso, KM_USER0);
+#else
 	vunmap(vdso);
+#endif
 
 	pr_notice("init_vdso successfull\n");
 
-- 
1.6.5.2

