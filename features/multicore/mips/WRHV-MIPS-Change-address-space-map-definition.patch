From c3ed17f1a76097641500ea54469869f464623389 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Thu, 25 Nov 2010 18:58:08 +0800
Subject: [PATCH 07/38] WRHV: MIPS: Change address space map definition

Since Linux GOS runs in supervisor mode, hence it just can access
XUSEG, XSSEG and KSSEG, but can access xkphys I/O. So, kernel image
is loaded to KSSEG, vmalloc area is at XSSEG.

Redefine MAP_BASE and CAC_BASE to reflect this. And, redefine
VMALLOC_START/END, move MODULE area to vmalloc area instead of CKSEG.
Redefined FIXADDR_START and FIXADDR_TOP to align the vmalloc area.
Update __pa/__va to translate virt/phys address to correct segment.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/include/asm/fixmap.h              |    8 ++++++++
 arch/mips/include/asm/mach-generic/spaces.h |    8 ++++++++
 arch/mips/include/asm/page.h                |    2 +-
 arch/mips/include/asm/pgtable-64.h          |    7 ++++++-
 4 files changed, 23 insertions(+), 2 deletions(-)

diff --git a/arch/mips/include/asm/fixmap.h b/arch/mips/include/asm/fixmap.h
index 0b89b83..6ec0880 100644
--- a/arch/mips/include/asm/fixmap.h
+++ b/arch/mips/include/asm/fixmap.h
@@ -73,11 +73,19 @@ enum fixed_addresses {
 #if defined(CONFIG_CPU_TX39XX) || defined(CONFIG_CPU_TX49XX)
 #define FIXADDR_TOP	((unsigned long)(long)(int)(0xff000000 - 0x20000))
 #else
+#if defined(CONFIG_WRHV)
+#define FIXADDR_TOP	(FIXADDR_START + FIXADDR_SIZE)	
+#else
 #define FIXADDR_TOP	((unsigned long)(long)(int)0xfffe0000)
 #endif
 #endif
+#endif
 #define FIXADDR_SIZE	(__end_of_fixed_addresses << PAGE_SHIFT)
+#ifdef CONFIG_WRHV
+#define FIXADDR_START	0x4000000020000000UL
+#else
 #define FIXADDR_START	(FIXADDR_TOP - FIXADDR_SIZE)
+#endif
 
 #define __fix_to_virt(x)	(FIXADDR_TOP - ((x) << PAGE_SHIFT))
 #define __virt_to_fix(x)	((FIXADDR_TOP - ((x)&PAGE_MASK)) >> PAGE_SHIFT)
diff --git a/arch/mips/include/asm/mach-generic/spaces.h b/arch/mips/include/asm/mach-generic/spaces.h
index c9fa4b1..45ef3c0 100644
--- a/arch/mips/include/asm/mach-generic/spaces.h
+++ b/arch/mips/include/asm/mach-generic/spaces.h
@@ -41,12 +41,16 @@
 #ifdef CONFIG_64BIT
 
 #ifndef CAC_BASE
+#ifdef CONFIG_WRHV
+#define CAC_BASE		_AC(0xffffffffc0000000, UL)
+#else
 #ifdef CONFIG_DMA_NONCOHERENT
 #define CAC_BASE		_AC(0x9800000000000000, UL)
 #else
 #define CAC_BASE		_AC(0xa800000000000000, UL)
 #endif
 #endif
+#endif
 
 #ifndef IO_BASE
 #define IO_BASE			_AC(0x9000000000000000, UL)
@@ -57,8 +61,12 @@
 #endif
 
 #ifndef MAP_BASE
+#ifdef CONFIG_WRHV
+#define MAP_BASE		_AC(0x4000000000000000, UL)
+#else
 #define MAP_BASE		_AC(0xc000000000000000, UL)
 #endif
+#endif
 
 /*
  * Memory above this physical address will be considered highmem.
diff --git a/arch/mips/include/asm/page.h b/arch/mips/include/asm/page.h
index a16beaf..300ea57 100644
--- a/arch/mips/include/asm/page.h
+++ b/arch/mips/include/asm/page.h
@@ -139,7 +139,7 @@ typedef struct { unsigned long pgprot; } pgprot_t;
 /*
  * __pa()/__va() should be used only during mem init.
  */
-#ifdef CONFIG_64BIT
+#if defined(CONFIG_64BIT) && !defined(CONFIG_WRHV)
 #define __pa(x)								\
 ({									\
     unsigned long __x = (unsigned long)(x);				\
diff --git a/arch/mips/include/asm/pgtable-64.h b/arch/mips/include/asm/pgtable-64.h
index 1be4b0f..ab9cdcb 100644
--- a/arch/mips/include/asm/pgtable-64.h
+++ b/arch/mips/include/asm/pgtable-64.h
@@ -125,14 +125,19 @@
  * the first couple of pages so NULL pointer dereferences will still
  * reliably trap.
  */
+#ifdef CONFIG_WRHV
+#define VMALLOC_START		(MAP_BASE + (2 * PAGE_SIZE) + 0x100000000UL)
+#define VMALLOC_END		0x400000001fffffff
+#else
 #define VMALLOC_START		(MAP_BASE + (2 * PAGE_SIZE))
 #define VMALLOC_END	\
 	(MAP_BASE + \
 	 min(PTRS_PER_PGD * PTRS_PER_PMD * PTRS_PER_PTE * PAGE_SIZE, \
 	     (1UL << cpu_vmbits)) - (1UL << 32))
+#endif /* CONFIG_WRHV */
 
 #if defined(CONFIG_MODULES) && defined(KBUILD_64BIT_SYM32) && \
-	VMALLOC_START != CKSSEG
+	VMALLOC_START != CKSSEG && !defined(CONFIG_WRHV)
 /* Load modules into 32bit-compatible segment. */
 #define MODULE_START	CKSSEG
 #define MODULE_END	(FIXADDR_START-2*PAGE_SIZE)
-- 
1.6.5.2

