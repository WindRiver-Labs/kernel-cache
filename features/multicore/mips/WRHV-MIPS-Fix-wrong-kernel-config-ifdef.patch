From 9c18d6ff2a952951aed7adf3fb7bc64a1f41af1c Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Wed, 30 Mar 2011 15:35:37 +0800
Subject: [PATCH] WRHV: MIPS: Fix wrong kernel config #ifdef

Change '#ifdef CONFIG_CAVIUM_OCTEON' to '#ifdef
CONFIG_CPU_CAVIUM_OCTEON' since CONFIG_CAVIUM_OCTEON is non-existed.
And, only register 2 IPIs for non Cavium Octeon platforms since they
doesn't support ICACHE_FLUSH IPI.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/kernel/vbi/wrhv.c |    8 ++++++--
 1 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/arch/mips/kernel/vbi/wrhv.c b/arch/mips/kernel/vbi/wrhv.c
index 766a98e..63323e4 100644
--- a/arch/mips/kernel/vbi/wrhv.c
+++ b/arch/mips/kernel/vbi/wrhv.c
@@ -352,7 +352,7 @@ static irqreturn_t wrhv_ipi_interrupt(int irq, void *dev_id)
  	if (action & SMP_CALL_FUNCTION)
  		smp_call_function_interrupt();
  
-#ifdef CONFIG_CAVIUM_OCTEON
+#ifdef CONFIG_CPU_CAVIUM_OCTEON
  	/* Check if we've been told to flush the icache */
  	if (action & SMP_ICACHE_FLUSH)
  		asm volatile ("synci 0($0)\n");
@@ -366,7 +366,7 @@ void wrhv_request_ipis(void)
  	static char *ipi_names[] = {
  		"IPI1 (reschedule)",
  		"IPI2 (call function)",
-#ifdef CONFIG_CAVIUM_OCTEON
+#ifdef CONFIG_CPU_CAVIUM_OCTEON
  		"IPI3 (icache flush)",
 #endif
  	};
@@ -378,7 +378,11 @@ void wrhv_request_ipis(void)
  	if (irq == VBI_INVALID_IRQ)
  		panic("WRHV resolve irq for IPI failed\n");
  
+#ifdef CONFIG_CPU_CAVIUM_OCTEON
  	for (i = 0; i < 3; i++) {
+#else
+ 	for (i = 0; i < 2; i++) {
+#endif
  		set_irq_chip_and_handler_name(irq + i, &wrhv_ipi_irq_chip,
  					      handle_percpu_irq, "per_cpu");
  		err = request_irq(irq + i, wrhv_ipi_interrupt,
-- 
1.6.5.2

