From 409ae2558b496dd5fe47e86cd82341a1ca3181d9 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Wed, 27 Apr 2011 15:39:49 +0800
Subject: [PATCH] WRHV: MIPS: Move restart/halt to MIPS common and make reboot SMP safe

Move restart/halt to MIPS common location. And, call smp_call_function
to send IPIs to other cores to call reboot function so that SMP can
warm reboot.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/kernel/vbi/wrhv.c |   43 +++++++++++++++++++++++++++++++++++++++++++
 1 files changed, 43 insertions(+), 0 deletions(-)

diff --git a/arch/mips/kernel/vbi/wrhv.c b/arch/mips/kernel/vbi/wrhv.c
index 21b1127..a9a77ec 100644
--- a/arch/mips/kernel/vbi/wrhv.c
+++ b/arch/mips/kernel/vbi/wrhv.c
@@ -52,6 +52,49 @@ void wrhv_unmask_IPIs_for_vcore(void);
 
 unsigned long max_asid;
 
+static void wrhv_do_restart(char *command)
+{
+	int ret = 0;
+	unsigned int cpu = smp_processor_id();
+
+	if (!cpu) {
+		printk(KERN_INFO "WRHV: rebooting \n");
+
+		ret = vbi_vb_reset(VBI_BOARD_ID_GET(), VBI_VB_CORES_ALL,
+				   VBI_VBMGMT_RESET_AND_START_CORE0 |
+				   VBI_VBMGMT_RESET_DOWNLOAD);
+
+		if (ret)
+			printk(KERN_ERR "WRHV: reboot failed. ret = %d\n", ret);
+	}
+}
+
+static void wrhv_halt(void)
+{
+	unsigned int cpu;
+	int ret = 0;
+
+	cpu = smp_processor_id();
+
+	if (!cpu)
+		ret = vbi_vb_suspend(VBI_BOARD_ID_GET(), cpu);
+
+	if (ret)
+		printk(KERN_ERR "%s: suspend result: %d\n", __func__, ret);
+}
+
+static void wrhv_restart(char *command)
+{
+	int cpu = smp_processor_id();
+
+	if (!cpu)
+		wrhv_do_restart(NULL);
+	else
+		smp_call_function(wrhv_do_restart, NULL, 1);
+
+	while (1);
+}
+
 static void get_max_asid(void)
 {
 	max_asid = vbi_get_max_asid_vmmu();
-- 
1.7.0.4

