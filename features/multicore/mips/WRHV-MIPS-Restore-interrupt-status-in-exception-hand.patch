From 7dcce3ae6c391b06670681398499a75782eab166 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Mon, 20 Dec 2010 11:08:13 +0800
Subject: [PATCH 17/38] WRHV: MIPS: Restore interrupt status in exception handler

Grab interrupt status from VB_STATUS, then restore to VB_CONTROL in
common exception handler and rdhwr fast exception handler.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/include/asm/wrhv_stackframe.h |    5 ++++-
 arch/mips/kernel/wrhv_genex.S           |    3 +++
 2 files changed, 7 insertions(+), 1 deletions(-)

diff --git a/arch/mips/include/asm/wrhv_stackframe.h b/arch/mips/include/asm/wrhv_stackframe.h
index 543cc19..3291ec3 100644
--- a/arch/mips/include/asm/wrhv_stackframe.h
+++ b/arch/mips/include/asm/wrhv_stackframe.h
@@ -436,7 +436,10 @@
 #endif /* CONFIG_MIPS_MT_SMTC */
 		PTR_L	k1, wr_vb_control
 		LONG_L	v1, PT_EPC(sp)
-		LONG_S	v1, VB_CONTROL_EPC(k1)	
+		LONG_S	v1, VB_CONTROL_EPC(k1)
+		PTR_L	k0, wr_vb_status
+		LONG_L	k0, VB_STATUS_OLD_INT_DISABLE(k0)
+		LONG_S	k0, VB_CONTROL_NEW_INT_DISABLE(k1) 
 		LONG_L	$31, PT_R31(sp)
 		LONG_L	$28, PT_R28(sp)
 		LONG_L	$25, PT_R25(sp)
diff --git a/arch/mips/kernel/wrhv_genex.S b/arch/mips/kernel/wrhv_genex.S
index b71e59a..1e34f93 100644
--- a/arch/mips/kernel/wrhv_genex.S
+++ b/arch/mips/kernel/wrhv_genex.S
@@ -539,6 +539,9 @@ NESTED(nmi_handler, PT_SIZE, sp)
 #endif
 	PTR_L	v1, wr_vb_control
 	LONG_S	k0, VB_CONTROL_EPC(v1)
+	PTR_L	k0, wr_vb_status
+	LONG_L	k0, VB_STATUS_OLD_INT_DISABLE(k0)
+	LONG_S	k0, VB_CONTROL_NEW_INT_DISABLE(v1) 
 	/* I hope three instructions between MTC0 and ERET are enough... */
 	ori	k1, _THREAD_MASK
 	xori	k1, _THREAD_MASK
-- 
1.6.5.2

