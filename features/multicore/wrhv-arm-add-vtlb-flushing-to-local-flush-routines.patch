From 97c786d37eb899c5e2024d6e431471d8f4533e8d Mon Sep 17 00:00:00 2001
From: Jim Somerville <Jim.Somerville@windriver.com>
Date: Thu, 29 Sep 2011 18:01:16 -0400
Subject: [PATCH 2/2] wrhv: arm: add vtlb flushing to local flush routines

When flushing tlb entries, also flush the vtlb.
Currently we flush everything.

Signed-off-by: Jim Somerville <Jim.Somerville@windriver.com>
---
 arch/arm/include/asm/tlbflush.h |   19 +++++++++++++++++++
 1 files changed, 19 insertions(+), 0 deletions(-)

diff --git a/arch/arm/include/asm/tlbflush.h b/arch/arm/include/asm/tlbflush.h
index 33b546a..3e6b2d9 100644
--- a/arch/arm/include/asm/tlbflush.h
+++ b/arch/arm/include/asm/tlbflush.h
@@ -10,6 +10,9 @@
 #ifndef _ASMARM_TLBFLUSH_H
 #define _ASMARM_TLBFLUSH_H
 
+#ifdef CONFIG_WRHV
+#include <vbi/syscall.h>
+#endif
 
 #ifndef CONFIG_MMU
 
@@ -322,6 +325,10 @@ static inline void local_flush_tlb_all(void)
 	const int zero = 0;
 	const unsigned int __tlb_flag = __cpu_tlb_flags;
 
+#ifdef CONFIG_WRHV
+	vbi_flush_tlb(0, 0, -1); /* Flush everything */
+#endif
+
 	if (tlb_flag(TLB_WB))
 		dsb();
 
@@ -356,6 +363,10 @@ static inline void local_flush_tlb_mm(struct mm_struct *mm)
 	const int asid = ASID(mm);
 	const unsigned int __tlb_flag = __cpu_tlb_flags;
 
+#ifdef CONFIG_WRHV
+	vbi_flush_tlb(0, 0, -1); /* Flush everything */
+#endif
+
 	if (tlb_flag(TLB_WB))
 		dsb();
 
@@ -403,6 +414,10 @@ local_flush_tlb_page(struct vm_area_struct *vma, unsigned long uaddr)
 	const int zero = 0;
 	const unsigned int __tlb_flag = __cpu_tlb_flags;
 
+#ifdef CONFIG_WRHV
+	vbi_flush_tlb(0, 0, -1); /* Flush everything */
+#endif
+
 	uaddr = (uaddr & PAGE_MASK) | ASID(vma->vm_mm);
 
 	if (tlb_flag(TLB_WB))
@@ -452,6 +467,10 @@ static inline void local_flush_tlb_kernel_page(unsigned long kaddr)
 	const int zero = 0;
 	const unsigned int __tlb_flag = __cpu_tlb_flags;
 
+#ifdef CONFIG_WRHV
+	vbi_flush_tlb(0, 0, -1); /* Flush everything */
+#endif
+
 	kaddr &= PAGE_MASK;
 
 	if (tlb_flag(TLB_WB))
-- 
1.7.0.4

