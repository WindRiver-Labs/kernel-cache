From 84b27aac1cf7708c6a744f3d6056ae769752c005 Mon Sep 17 00:00:00 2001
From: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
Date: Thu, 25 Nov 2010 13:38:09 -0500
Subject: [PATCH 1/2] WRHV/ppc: correct timebase reads for SMP

To avoid the following kernel panic

<text_console_cmp0.con>BUG: using smp_processor_id() in preemptible [00000000] code: rcS/54
<text_console_cmp0.con>caller is timebase_read+0x2c/0x90
<text_console_cmp0.con>Call Trace:
<text_console_cmp0.con>[cf8d5dc0] [c0009c4c] show_stack+0x64/0x1a4 (unreliable)
<text_console_cmp0.con>[cf8d5df0] [c026f154] debug_smp_processor_id+0x100/0x104
<text_console_cmp0.con>[cf8d5e10] [c00101f8] timebase_read+0x2c/0x90
<text_console_cmp0.con>[cf8d5e20] [c0080b18] ktime_get_ts+0xc0/0x198
<text_console_cmp0.con>[cf8d5e60] [c004fa08] copy_process+0x4fc/0xde0
<text_console_cmp0.con>[cf8d5ec0] [c0050384] do_fork+0x98/0x3cc
<text_console_cmp0.con>BUG: using smp_processor_id() in preemptible [00000000] code: tcf-agent/60
<text_console_cmp0.con>caller is timebase_read+0x2c/0x90

when reading the timebase register.  Simply
utilize the __raw variant to avoid disabling
preemption.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/include/asm/time.h |   12 ++----------
 arch/powerpc/kernel/vbi/wrhv.c  |    2 +-
 2 files changed, 3 insertions(+), 11 deletions(-)

diff --git a/arch/powerpc/include/asm/time.h b/arch/powerpc/include/asm/time.h
index 95eba1a..e16407c 100644
--- a/arch/powerpc/include/asm/time.h
+++ b/arch/powerpc/include/asm/time.h
@@ -132,13 +132,7 @@ static inline u64 get_tb(void)
 #ifndef CONFIG_WRHV
 	return ((u64)tbhi << 32) | tblo;
 #else
-	{
-	int cpuid = smp_processor_id();
-	if(cpuid)
-		return (((u64)tbhi << 32) | tblo) + wrhv_gettb_diff();
-	else
-		return ((u64)tbhi << 32) | tblo;
-	}
+	return (((u64)tbhi << 32) | tblo) + wrhv_gettb_diff();
 #endif
 }
 #endif /* !CONFIG_PPC64 */
@@ -156,9 +150,7 @@ static inline void set_tb(unsigned int upper, unsigned int lower)
 	mtspr(SPRN_TBWL, lower);
 #else
 	unsigned long long tb = ((u64)upper<<32) | lower;
-	int cpuid = smp_processor_id();
-	if(cpuid)
-		wrhv_settb_diff((long long)get_tb() - (long long)tb);
+	wrhv_settb_diff((long long)get_tb() - (long long)tb);
 #endif
 }
 
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index a8b47c5..15459af 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -1554,7 +1554,7 @@ DEFINE_PER_CPU(long long, tb_diff);
 
 long long wrhv_gettb_diff()
 {
-	return __get_cpu_var(tb_diff);
+	return __raw_get_cpu_var(tb_diff);
 }
 
 void wrhv_settb_diff(long long diff)
-- 
1.6.5.2

