From 3be5fe4dd64dc6a8a241d1717f6ed76d3c352828 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:25:34 -0400
Subject: [PATCH 046/391] lttng-core/lttng-filter

LTTng filter

Filter module providing the filter/ directory entry.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 include/linux/ltt-tracer.h |    2 +
 ltt/Kconfig                |    3 ++
 ltt/Makefile               |    1 +
 ltt/ltt-filter.c           |   54 ++++++++++++++++++++++++++++++++++++++++++++
 4 files changed, 60 insertions(+), 0 deletions(-)
 create mode 100644 ltt/ltt-filter.c

diff --git a/include/linux/ltt-tracer.h b/include/linux/ltt-tracer.h
index 006a2f5..ac053a3 100644
--- a/include/linux/ltt-tracer.h
+++ b/include/linux/ltt-tracer.h
@@ -658,6 +658,8 @@ enum ltt_filter_control_msg {
 extern int ltt_filter_control(enum ltt_filter_control_msg msg,
 		const char *trace_name);
 
+extern struct dentry *get_filter_root(void);
+
 void ltt_write_trace_header(struct ltt_trace_struct *trace,
 		struct ltt_subbuffer_header *header);
 extern void ltt_buffer_destroy(struct ltt_channel_struct *ltt_chan);
diff --git a/ltt/Kconfig b/ltt/Kconfig
index 9b9787e..8d53120 100644
--- a/ltt/Kconfig
+++ b/ltt/Kconfig
@@ -28,6 +28,9 @@ menuconfig LTT
 
 if LTT
 
+config LTT_FILTER
+	tristate
+
 config LTT_RELAY_ALLOC
 	def_bool n
 
diff --git a/ltt/Makefile b/ltt/Makefile
index 2dc242b..2461341 100644
--- a/ltt/Makefile
+++ b/ltt/Makefile
@@ -13,3 +13,4 @@ obj-$(CONFIG_LTT_STATEDUMP)		+= ltt-statedump.o
 obj-$(CONFIG_LTT_FAST_SERIALIZE)	+= ltt-type-serializer.o
 obj-$(CONFIG_LTT_TRACE_CONTROL)		+= ltt-trace-control.o
 obj-$(CONFIG_LTT_USERSPACE_EVENT)	+= ltt-userspace-event.o
+obj-$(CONFIG_LTT_FILTER)		+= ltt-filter.o
diff --git a/ltt/ltt-filter.c b/ltt/ltt-filter.c
new file mode 100644
index 0000000..95c43dd
--- /dev/null
+++ b/ltt/ltt-filter.c
@@ -0,0 +1,54 @@
+/*
+ * Copyright (C) 2008 Mathieu Desnoyers
+ *
+ * Dual LGPL v2.1/GPL v2 license.
+ */
+
+#include <linux/module.h>
+#include <linux/debugfs.h>
+#include <linux/fs.h>
+#include <linux/ltt-tracer.h>
+#include <linux/mutex.h>
+
+#define LTT_FILTER_DIR	"filter"
+
+/*
+ * Protects the ltt_filter_dir allocation.
+ */
+static DEFINE_MUTEX(ltt_filter_mutex);
+
+static struct dentry *ltt_filter_dir;
+
+struct dentry *get_filter_root(void)
+{
+	struct dentry *ltt_root_dentry;
+
+	mutex_lock(&ltt_filter_mutex);
+	if (!ltt_filter_dir) {
+		ltt_root_dentry = get_ltt_root();
+		if (!ltt_root_dentry)
+			goto err_no_root;
+
+		ltt_filter_dir = debugfs_create_dir(LTT_FILTER_DIR,
+						    ltt_root_dentry);
+		if (!ltt_filter_dir)
+			printk(KERN_ERR
+				"ltt_filter_init: failed to create dir %s\n",
+				LTT_FILTER_DIR);
+	}
+err_no_root:
+	mutex_unlock(&ltt_filter_mutex);
+	return ltt_filter_dir;
+}
+EXPORT_SYMBOL_GPL(get_filter_root);
+
+static void __exit ltt_filter_exit(void)
+{
+	debugfs_remove(ltt_filter_dir);
+}
+
+module_exit(ltt_filter_exit);
+
+MODULE_LICENSE("GPL and additional rights");
+MODULE_AUTHOR("Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>");
+MODULE_DESCRIPTION("Linux Trace Toolkit Filter");
-- 
1.6.5.2

