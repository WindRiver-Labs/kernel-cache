From 8413771d247866921f6adf55e7880ed63a92e56e Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Wed, 18 May 2011 18:41:25 -0400
Subject: [PATCH 022/248] trace-clock/trace-clock-use-access-once

Trace clock use ACCESS_ONCE

We need to tell the compiler to only read the index variable once to protect
against interrupts.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 kernel/trace/trace-clock-32-to-64.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/kernel/trace/trace-clock-32-to-64.c b/kernel/trace/trace-clock-32-to-64.c
index 905166e..4b9e2e7 100644
--- a/kernel/trace/trace-clock-32-to-64.c
+++ b/kernel/trace/trace-clock-32-to-64.c
@@ -112,7 +112,7 @@ u64 notrace trace_clock_read_synthetic_tsc(void)
 
 	preempt_disable_notrace();
 	cpu_synth = &per_cpu(synthetic_tsc, smp_processor_id());
-	index = cpu_synth->index;		/* atomic read */
+	index = ACCESS_ONCE(cpu_synth->index);	/* atomic read */
 	tsc = trace_clock_read32();		/* Hardware clocksource read */
 
 	/* Overflow detection */
-- 
1.7.0.4

