From 9e35b8cf2e25c32dcfec9b514f6e5a8b5ded7c21 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:27:19 -0400
Subject: [PATCH 229/390] lttng-transport-irqoff-detect-nmi

LTTng transport IRQoff detect NMI

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 ltt/ltt-relay-irqoff.h |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/ltt/ltt-relay-irqoff.h b/ltt/ltt-relay-irqoff.h
index a3b556b..3238dc2 100644
--- a/ltt/ltt-relay-irqoff.h
+++ b/ltt/ltt-relay-irqoff.h
@@ -57,6 +57,7 @@
 #include <linux/cpu.h>
 #include <linux/pipe_fs_i.h>
 #include <linux/splice.h>
+#include <linux/hardirq.h>
 #include <asm/atomic.h>
 #include <asm/local.h>
 
@@ -224,13 +225,15 @@ static __inline__ int ltt_reserve_slot(struct ltt_trace_struct *trace,
 	struct ltt_channel_buf_struct *ltt_buf = buf->chan_private;
 	long o_begin, o_end, o_old;
 	size_t before_hdr_pad;
+	unsigned int nest;
 
 	raw_local_irq_save(ltt_buf->irqflags);
 
 	/*
 	 * Perform retryable operations.
 	 */
-	if (unlikely(__get_cpu_var(ltt_nesting) > 4)) {
+	nest = __get_cpu_var(ltt_nesting);
+	if (unlikely(nest > 4 || (in_nmi() && nest > 1))) {
 		local_inc(&ltt_buf->events_lost);
 		raw_local_irq_restore(ltt_buf->irqflags);
 		return -EPERM;
-- 
1.6.5.2

