From c38bfe01c2b156eace3bef713b45e5018f45e700 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
Date: Thu, 30 Oct 2008 23:27:25 -0400
Subject: [PATCH] lttng-instrumentation-traps-tracepoints-probes

LTTng instrumentation trap tracepoints probes

Trap instrumentation tracepoints probes.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 ltt/probes/Makefile     |    3 ++-
 ltt/probes/trap-trace.c |   25 +++++++++++++++++++++++++
 2 files changed, 27 insertions(+), 1 deletions(-)
 create mode 100644 ltt/probes/trap-trace.c

diff --git a/ltt/probes/Makefile b/ltt/probes/Makefile
index f5f7241..83e3b58 100644
--- a/ltt/probes/Makefile
+++ b/ltt/probes/Makefile
@@ -8,11 +8,12 @@ CFLAGS_REMOVE_ipc-trace.o = -pg
 CFLAGS_REMOVE_lockdep-trace.o = -pg
 CFLAGS_REMOVE_rcu-trace.o = -pg
 CFLAGS_REMOVE_syscall-trace.o = -pg
+CFLAGS_REMOVE_trap-trace.o = -pg
 endif
 
 obj-$(CONFIG_LTT_TRACEPROBES)	+= kernel-trace.o mm-trace.o fs-trace.o \
 				ipc-trace.o lockdep-trace.o rcu-trace.o \
-				syscall-trace.o
+				syscall-trace.o trap-trace.o
 
 ifeq ($(CONFIG_NET),y)
 ifdef CONFIG_FTRACE
diff --git a/ltt/probes/trap-trace.c b/ltt/probes/trap-trace.c
new file mode 100644
index 0000000..8261607
--- /dev/null
+++ b/ltt/probes/trap-trace.c
@@ -0,0 +1,25 @@
+/*
+ * ltt/probes/trap-trace.c
+ *
+ * Trap tracepoint probes.
+ */
+
+#include <linux/module.h>
+#include <trace/trap.h>
+
+void probe_trap_entry(struct pt_regs *regs, long id)
+{
+	trace_mark_tp(kernel_trap_entry, trap_entry,
+		probe_trap_entry, "ip #p%ld trap_id %d",
+		instruction_pointer(regs), (int)id);
+}
+
+void probe_trap_exit(void)
+{
+	trace_mark_tp(kernel_trap_exit, trap_exit,
+		probe_trap_exit, MARK_NOARGS);
+}
+
+MODULE_LICENSE("GPL");
+MODULE_AUTHOR("Mathieu Desnoyers");
+MODULE_DESCRIPTION("Trap Tracepoint Probes");
-- 
1.5.5.1

