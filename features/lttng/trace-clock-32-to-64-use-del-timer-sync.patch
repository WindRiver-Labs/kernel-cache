From 2a66a90c831f488a16ae8c366c5efa0cdd9eb25a Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:28:28 -0400
Subject: [PATCH 359/391] trace-clock-32-to-64-use-del-timer-sync

trace clock 32 to 64 use del timer sync

Needed for RT kernel.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
---
 kernel/trace/trace-clock-32-to-64.c |   17 +++--------------
 1 files changed, 3 insertions(+), 14 deletions(-)

diff --git a/kernel/trace/trace-clock-32-to-64.c b/kernel/trace/trace-clock-32-to-64.c
index d80255e..bce7c8e 100644
--- a/kernel/trace/trace-clock-32-to-64.c
+++ b/kernel/trace/trace-clock-32-to-64.c
@@ -150,10 +150,8 @@ static void tsc_timer_fct(unsigned long data)
 {
 	update_synthetic_tsc();
 
-	per_cpu(tsc_timer, smp_processor_id()).expires =
-		jiffies + precalc_expire;
-	add_timer_on(&per_cpu(tsc_timer, smp_processor_id()),
-		     smp_processor_id());
+	mod_timer_pinned(&per_cpu(tsc_timer, smp_processor_id()),
+		  jiffies + precalc_expire);
 }
 
 /*
@@ -199,18 +197,9 @@ static void enable_synthetic_tsc(int cpu)
 	add_timer_on(&per_cpu(tsc_timer, cpu), cpu);
 }
 
-/*
- * Cannot use del_timer_sync with add_timer_on, so use an IPI to locally
- * delete the timer.
- */
-static void disable_synthetic_tsc_ipi(void *info)
-{
-	del_timer(&per_cpu(tsc_timer, smp_processor_id()));
-}
-
 static void disable_synthetic_tsc(int cpu)
 {
-	smp_call_function_single(cpu, disable_synthetic_tsc_ipi, NULL, 1);
+	del_timer_sync(&per_cpu(tsc_timer, smp_processor_id()));
 }
 
 /*
-- 
1.6.5.2

