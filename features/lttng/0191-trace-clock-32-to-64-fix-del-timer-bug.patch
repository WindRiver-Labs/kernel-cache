From ecca00ec2936d25c2eb5d4c9f3109d64c1593401 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Wed, 18 May 2011 18:42:42 -0400
Subject: [PATCH 191/248] trace-clock-32-to-64-fix-del-timer-bug

trace clock 32 to 64 fix del timer bug

{{{

BUG: using smp_processor_id() in preemptible [00000000] code: lttctl/748
caller is put_synthetic_tsc+0x7c/0xf8
Backtrace:
[<c002d46c>] (dump_backtrace+0x0/0x10c) from [<c03a83a8>] (dump_stack+0x18/0x1c)
 r7:c04c69d4 r6:c008e7a4 r5:00000000 r4:ce0c0000
[<c03a8390>] (dump_stack+0x0/0x1c) from [<c0242d74>]
(debug_smp_processor_id+0xc0/0xec)
[<c0242cb4>] (debug_smp_processor_id+0x0/0xec) from [<c008e7a4>]
(put_synthetic_tsc+0x7c/0xf8)
 r6:c04fa24c r5:c0023600 r4:00000000
[<c008e728>] (put_synthetic_tsc+0x0/0xf8) from [<c008eb68>]
(put_trace_clock+0x68/0x7c)
 r8:befa4edb r7:0000000b r6:ce0c1d2a r5:cdfbe200 r4:00000000
[<c008eb00>] (put_trace_clock+0x0/0x7c) from [<c022ae90>]
(ltt_trace_destroy+0x40/0x94)
[<c022ae50>] (ltt_trace_destroy+0x0/0x94) from [<c023392c>]
(destroy_trace_write+0xbc/0x140)
 r5:00000000 r4:0000000b
[<c0233870>] (destroy_trace_write+0x0/0x140) from [<c00be780>]
(vfs_write+0xb4/0x144)
 r7:0000000b r6:ce0c1f70 r5:befa4edb r4:cde545a0
[<c00be6cc>] (vfs_write+0x0/0x144) from [<c00be964>] (sys_write+0x48/0xf4)
 r7:0000000b r6:cde545a0 r5:00000000 r4:00000000
[<c00be91c>] (sys_write+0x0/0xf4) from [<c0028e5c>]
(__sys_trace_return+0x0/0x24)
BUG: using smp_processor_id() in preemptible [00000000] code: lttctl/748
caller is put_synthetic_tsc+0x7c/0xf8

}}}

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
---
 kernel/trace/trace-clock-32-to-64.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/kernel/trace/trace-clock-32-to-64.c b/kernel/trace/trace-clock-32-to-64.c
index bce7c8e..843749a 100644
--- a/kernel/trace/trace-clock-32-to-64.c
+++ b/kernel/trace/trace-clock-32-to-64.c
@@ -199,7 +199,7 @@ static void enable_synthetic_tsc(int cpu)
 
 static void disable_synthetic_tsc(int cpu)
 {
-	del_timer_sync(&per_cpu(tsc_timer, smp_processor_id()));
+	del_timer_sync(&per_cpu(tsc_timer, cpu));
 }
 
 /*
-- 
1.7.0.4

