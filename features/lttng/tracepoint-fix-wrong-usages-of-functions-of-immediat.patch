From 8c0ad226c31bfd7fc173c571b88a0d1714cf9d2f Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Thu, 10 Mar 2011 17:45:09 +0800
Subject: [PATCH] tracepoint: fix wrong usages of functions of immediate value

First remove previous "&" when using _imv_read, otherwise it will return
wrong value. And use "imv_set" to assign value of immediate value.

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 kernel/tracepoint.c |   10 +++++-----
 1 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/kernel/tracepoint.c b/kernel/tracepoint.c
index 384f4b0..1bfedb6 100644
--- a/kernel/tracepoint.c
+++ b/kernel/tracepoint.c
@@ -244,9 +244,9 @@ static void set_tracepoint(struct tracepoint_entry **entry,
 {
 	WARN_ON(strcmp((*entry)->name, elem->name) != 0);
 
-	if (elem->regfunc && !_imv_read(&elem->state) && active)
+	if (elem->regfunc && !_imv_read(elem->state) && active)
 		elem->regfunc();
-	else if (elem->unregfunc && _imv_read(&elem->state) && !active)
+	else if (elem->unregfunc && _imv_read(elem->state) && !active)
 		elem->unregfunc();
 
 	/*
@@ -257,7 +257,7 @@ static void set_tracepoint(struct tracepoint_entry **entry,
 	 * is used.
 	 */
 	rcu_assign_pointer(elem->funcs, (*entry)->funcs);
-	elem->state__imv = active;
+	imv_set(elem->state, active);
 }
 
 /*
@@ -268,10 +268,10 @@ static void set_tracepoint(struct tracepoint_entry **entry,
  */
 static void disable_tracepoint(struct tracepoint *elem)
 {
-	if (elem->unregfunc && _imv_read(&elem->state))
+	if (elem->unregfunc && _imv_read(elem->state))
 		elem->unregfunc();
 
-	elem->state__imv = 0;
+	imv_set(elem->state, 0);
 	rcu_assign_pointer(elem->funcs, NULL);
 }
 
-- 
1.6.5.2

