From b6e4bbd714765353989cbdef39b4b2bfb3b2fe3d Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:26:55 -0400
Subject: [PATCH 185/391] module-vmalloc_sync_all_on_module_load

module : vmalloc_sync_all() on module load

Call vmalloc_sync_all() after module vmalloc(), to make sure the module text or
data access does not generate any page fault.

This is useful for kernel tracing, when the trace code is within modules, and we
want to isntrument the page fault handler.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 kernel/module.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/kernel/module.c b/kernel/module.c
index ae8ae87..c08d701 100644
--- a/kernel/module.c
+++ b/kernel/module.c
@@ -2044,6 +2044,12 @@ static noinline struct module *load_module(void __user *umod,
 	if (len > 64 * 1024 * 1024 || (hdr = vmalloc(len)) == NULL)
 		return ERR_PTR(-ENOMEM);
 
+	/*
+	 * Make sure the module text or data access never generates any page
+	 * fault.
+	 */
+	vmalloc_sync_all();
+
 	if (copy_from_user(hdr, umod, len) != 0) {
 		err = -EFAULT;
 		goto free_hdr;
-- 
1.6.5.2

