From cf3043f2407bf659e7f8fa2542480144e543bc2a Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Wed, 18 May 2011 18:41:59 -0400
Subject: [PATCH 096/248] lttng-statedump/lttng-statedump-swap

LTTng statedump swap files dump

Dumps the kernel status at trace start. Iteration over kernel data structures
divided in chunks so no lock is held for too long. Tracing being active at that
time logs information about concurrent modification to data structures when lock
is released.

[Edit Mathieu Desnoyers]
License changed to Dual LGPL v2.1/GPL v2 license.

Swap file dump.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 include/linux/swap.h |    6 ++++++
 mm/swapfile.c        |   19 +++++++++++++++++++
 2 files changed, 25 insertions(+), 0 deletions(-)

diff --git a/include/linux/swap.h b/include/linux/swap.h
index 535e441..9b779e1 100644
--- a/include/linux/swap.h
+++ b/include/linux/swap.h
@@ -384,6 +384,8 @@ mem_cgroup_uncharge_swapcache(struct page *page, swp_entry_t ent, bool swapout)
 }
 #endif
 
+extern void ltt_dump_swap_files(void *call_data);
+
 #else /* CONFIG_SWAP */
 
 #define nr_swap_pages				0L
@@ -508,6 +510,10 @@ mem_cgroup_count_swap_user(swp_entry_t ent, struct page **pagep)
 }
 #endif
 
+static inline void ltt_dump_swap_files(void *call_data)
+{
+}
+
 #endif /* CONFIG_SWAP */
 #endif /* __KERNEL__*/
 #endif /* _LINUX_SWAP_H */
diff --git a/mm/swapfile.c b/mm/swapfile.c
index c0ad313..aaa657a 100644
--- a/mm/swapfile.c
+++ b/mm/swapfile.c
@@ -2520,3 +2520,22 @@ static void free_swap_count_continuations(struct swap_info_struct *si)
 		}
 	}
 }
+
+void ltt_dump_swap_files(void *call_data)
+{
+	int type;
+	struct swap_info_struct *p = NULL;
+
+	mutex_lock(&swapon_mutex);
+	for (type = swap_list.head; type >= 0; type = swap_info[type]->next) {
+		p = swap_info[type];
+		if (!(p->flags & SWP_WRITEOK))
+			continue;
+		__trace_mark(0, statedump_swap_files, call_data,
+			"filp %p vfsmount %p dname %s",
+			p->swap_file, p->swap_file->f_vfsmnt,
+			p->swap_file->f_dentry->d_name.name);
+	}
+	mutex_unlock(&swapon_mutex);
+}
+EXPORT_SYMBOL_GPL(ltt_dump_swap_files);
-- 
1.7.0.4

