From 01eacf04b19eecd834a39709ae02c4cf477bfae0 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Thu, 10 May 2012 13:05:15 -0700
Subject: [PATCH 114/248] module-vmalloc_sync_all_on_module_load

module : vmalloc_sync_all() on module load

Call vmalloc_sync_all() after module vmalloc(), to make sure the module text or
data access does not generate any page fault.

This is useful for kernel tracing, when the trace code is within modules, and we
want to isntrument the page fault handler.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 kernel/module.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/kernel/module.c b/kernel/module.c
index 35063c0..cc758c3 100644
--- a/kernel/module.c
+++ b/kernel/module.c
@@ -2421,6 +2421,12 @@ static int copy_and_check(struct load_info *info,
 	if ((hdr = vmalloc(len)) == NULL)
 		return -ENOMEM;
 
+	/*
+	 * Make sure the module text or data access never generates any page
+	 * fault.
+	 */
+	vmalloc_sync_all();
+
 	if (copy_from_user(hdr, umod, len) != 0) {
 		err = -EFAULT;
 		goto free_hdr;
-- 
1.7.0.4

