From 4cdca8612b654b549e4ff52e9cc2d55c08af43ab Mon Sep 17 00:00:00 2001
From: auto commit <unknown@unknown>
Date: Tue, 15 Jul 2008 14:56:26 -0400
Subject: [PATCH] call the module related functions if kernel is compiled with

module support. Will not compile otherwise.

Signed-off-by: Benjamin Poirier <benjamin.poirier@polymtl.ca>
---
 kernel/kernel-trace.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/kernel/kernel-trace.c b/kernel/kernel-trace.c
index 8a562c8..c4dd275 100644
--- a/kernel/kernel-trace.c
+++ b/kernel/kernel-trace.c
@@ -207,6 +207,7 @@ static void probe_kernel_vprintk(void *retaddr, char *buf, int len)
 	}
 }
 
+#ifdef CONFIG_MODULES
 static void probe_kernel_module_free(struct module *mod)
 {
 	trace_mark(kernel_module_free, "name %s", mod->name);
@@ -216,6 +217,7 @@ static void probe_kernel_module_load(struct module *mod)
 {
 	trace_mark(kernel_module_load, "name %s", mod->name);
 }
+#endif
 
 int __init kernel_trace_init(void)
 {
@@ -286,10 +288,12 @@ int __init kernel_trace_init(void)
 	WARN_ON(ret);
 	ret = register_trace_kernel_vprintk(probe_kernel_vprintk);
 	WARN_ON(ret);
+#ifdef CONFIG_MODULES
 	ret = register_trace_kernel_module_free(probe_kernel_module_free);
 	WARN_ON(ret);
 	ret = register_trace_kernel_module_load(probe_kernel_module_load);
 	WARN_ON(ret);
+#endif
 
 	return 0;
 }
@@ -298,8 +302,10 @@ module_init(kernel_trace_init);
 
 void __exit kernel_trace_exit(void)
 {
+#ifdef CONFIG_MODULES
 	unregister_trace_kernel_module_load(probe_kernel_module_load);
 	unregister_trace_kernel_module_free(probe_kernel_module_free);
+#endif
 	unregister_trace_kernel_vprintk(probe_kernel_vprintk);
 	unregister_trace_kernel_printk(probe_kernel_printk);
 
-- 
1.5.5.1

