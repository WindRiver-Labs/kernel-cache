From 062202d218e65a30886a7a87403b2bde3c2fbd42 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:27:38 -0400
Subject: [PATCH 265/390] lttng-relay-lockless-fix-splice-size

lttng relay lockless fix splice size

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 ltt/ltt-relay-lockless.c |    7 ++++---
 1 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/ltt/ltt-relay-lockless.c b/ltt/ltt-relay-lockless.c
index 0e77cff..fddbe02 100644
--- a/ltt/ltt-relay-lockless.c
+++ b/ltt/ltt-relay-lockless.c
@@ -662,10 +662,11 @@ static int subbuf_splice_actor(struct file *in,
 	consumed_idx = SUBBUF_INDEX(consumed_old, buf->chan);
 
 	/*
-	 * Adjust read len, if longer than what is available
+	 * Adjust read len, if longer than what is available.
+	 * Max read size is 1 subbuffer due to get_subbuf/put_subbuf for
+	 * protection.
 	 */
-	bytes_avail = SUBBUF_TRUNC(local_read(&ltt_buf->offset), buf->chan)
-		    - consumed_old;
+	bytes_avail = buf->chan->subbuf_size;
 	WARN_ON(bytes_avail > buf->chan->alloc_size);
 	len = min_t(size_t, len, bytes_avail);
 	subbuf_pages = bytes_avail >> PAGE_SHIFT;
-- 
1.6.5.2

