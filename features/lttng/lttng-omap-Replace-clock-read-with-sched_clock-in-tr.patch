From e95b8eb5d5fa14ebaefe7fdba9ddc1e129e51380 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Mon, 23 Jul 2012 16:14:33 -0700
Subject: [PATCH] lttng: omap: Replace clock->read with sched_clock in trace
 clock

Due to upstream commit 354a183f536a8edf6cb80ee3e3f393736e278810
[Convert OMAPs 32kHz clocksource implementation to use the generic MMIO
clocksource support.]
and upstream commit 2f0778afac79bd8d226225556858a636931eeabc
[ARM: 7205/2: sched_clock: allow sched_clock to be selected at runtime]

clocksource->read interface is obsolete, so it's null now.
Switch to the new sched_clock() interface to get clock value.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/arm/mach-omap2/trace-clock.c |    8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/arch/arm/mach-omap2/trace-clock.c b/arch/arm/mach-omap2/trace-clock.c
index e4e008d..8b5a5b0 100644
--- a/arch/arm/mach-omap2/trace-clock.c
+++ b/arch/arm/mach-omap2/trace-clock.c
@@ -162,7 +162,7 @@ void save_sync_trace_clock(void)
 	if (!pm_count->refcount)
 		goto end;
 
-	pm_count->ext_32k = clock->read(clock);
+	pm_count->ext_32k = sched_clock();
 	pm_count->int_fast_clock = trace_clock_read64();
 end:
 	raw_spin_unlock(&pm_count->lock);
@@ -203,7 +203,7 @@ u64 _trace_clock_read_slow(void)
 	 */
 	ref_time = pm_count->int_fast_clock;
 	if (!pm_count->init_clock)
-		count_32k = clock->read(clock);
+		count_32k = sched_clock();
 	else
 		count_32k = pm_count->init_clock;
 
@@ -415,7 +415,7 @@ void _start_trace_clock(void)
 	u64 old_fast_clock;
 	int cpu;
 
-	ext_32k = clock->read(clock);
+	ext_32k = sched_clock();
 	old_fast_clock = per_cpu(pm_save_count, 0).int_fast_clock;
 
 	for_each_online_cpu(cpu) {
@@ -498,7 +498,7 @@ static int __cpuinit hotcpu_callback(struct notifier_block *nb,
 		if (trace_clock_refcount) {
 			pm_count = &per_cpu(pm_save_count, hotcpu);
 			local_irq_save(flags);
-			pm_count->ext_32k = clock->read(clock);
+			pm_count->ext_32k = sched_clock();
 			pm_count->int_fast_clock = trace_clock_read64();
 			local_irq_restore(flags);
 			pm_count->refcount = 1;
-- 
1.7.9.7

