From 25234ce9cc64ebc616d92b49eb7ad49509deb323 Mon Sep 17 00:00:00 2001
From: "Roy.Li" <rongqing.li@windriver.com>
Date: Thu, 28 Feb 2013 11:19:24 +0800
Subject: [PATCH] strace-clock: move clock_trace from stack into .data section

clock_trace in stack will be broken when exit init_unsync_trace_clock,
then calling clock_trace.clock_get() by clock_gettime(CLOCK_TRACE) will
crash the system.

	EIP: 0060:[<00000000>] EFLAGS: 00010286 CPU: 1
	EIP is at 0x0
	EAX: 0000000f EBX: 0000000f ECX: f605fefc EDX: f44b5f98
	ESI: bfe11ce8 EDI: 00000000 EBP: f44b5fac ESP: f44b5f8c
	 DS: 007b ES: 007b FS: 00d8 GS: 0033 SS: 0068
	CR0: 8005003b CR2: 00000000 CR3: 35101000 CR4: 000007f0
	DR0: 00000000 DR1: 00000000 DR2: 00000000 DR3: 00000000
	DR6: ffff0ff0 DR7: 00000400
	Process usta.out (pid: 943, ti=f44950c8 task=f4494d40 task.ti=f44950c8)
	Stack:
	 c104b0a4 7ffbfeff fffffffe bfe11ce8 00000109 0000000f 4fd11ea4 00000000
	 f44950c8 c17478b9 0000000f bfe11ce8 4fcdf000 4fd11ea4 00000000 bfe11d18
	 ffffffda 0000007b 0000007b 00000000 00000000 00000109 4fcdaced 00000073
	Call Trace:
	 [<c104b0a4>] ? sys_clock_gettime+0x34/0xe0
	 [<c17478b9>] syscall_call+0x7/0xb
	Code:  Bad EIP value.
	EIP: [<00000000>] 0x0 SS:ESP 0068:f44b5f8c
	CR2: 0000000000000000

This bug is triggered by program which links the libust.so.0, and when
load libust.so.0, the __do_global_ctro_aux from libust.so.0 calls clock_gettime.

	Breakpoint 1, 0x99e61cd0 in clock_gettime () from /lib/librt.so.1
	(gdb) bt
	#0 0x99e61cd0 in clock_gettime () from /lib/librt.so.1
	#1 0x9a011012 in init () at tracectl.c:1311
	#2 0x9a02810d in __do_global_ctors_aux () from /usr/lib/libust.so.0
	#3 0x9a00e81d in _init () from /usr/lib/libust.so.0
	#4 0x99e8e506 in __GI___ctype_init () at ctype-info.c:31
	#5 0x9a04fd39 in call_init (env=0xb029f41c, argv=0xb029f414, argc=1,
		l=<optimized out>) at dl-init.c:70
	#6 call_init (l=<optimized out>, argc=1, argv=0xb029f414, env=
		0xb029f41c) at dl-init.c:35
	#7 0x9a04fe8f in _dl_init (main_map=<optimized out>, argc=1, argv=
		0xb029f414, env=0xb029f41c) at dl-init.c:134
	#8 0x9a0421ef in _dl_start_user () from /lib/ld-linux.so.2

Signed-off-by: Roy.Li <rongqing.li@windriver.com>
---
 arch/x86/kernel/trace-clock.c |    4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/arch/x86/kernel/trace-clock.c b/arch/x86/kernel/trace-clock.c
index 05412b2..d2bf732 100644
--- a/arch/x86/kernel/trace-clock.c
+++ b/arch/x86/kernel/trace-clock.c
@@ -284,11 +284,11 @@ static int posix_get_trace_res(const clockid_t which_clock, struct timespec *tp)
 
 static __init int init_unsync_trace_clock(void)
 {
-	struct k_clock clock_trace = {
+	static struct k_clock clock_trace = {
 		.clock_getres = posix_get_trace_res,
 		.clock_get = posix_get_trace,
 	};
-	struct k_clock clock_trace_freq = {
+	static struct k_clock clock_trace_freq = {
 		.clock_getres = posix_get_trace_res,
 		.clock_get = posix_get_trace_freq,
 	};
-- 
1.7.9.7

