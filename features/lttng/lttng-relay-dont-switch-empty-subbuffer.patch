From 5b84857e7f9bd58748419277c828e333c7194bc0 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:28:02 -0400
Subject: [PATCH 310/391] lttng-relay-dont-switch-empty-subbuffer

lttng relay dont switch empty subbuffer

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 ltt/ltt-relay-lockless.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/ltt/ltt-relay-lockless.c b/ltt/ltt-relay-lockless.c
index 6de815c..d05d9b4 100644
--- a/ltt/ltt-relay-lockless.c
+++ b/ltt/ltt-relay-lockless.c
@@ -990,6 +990,7 @@ int ltt_relay_try_switch_slow(enum force_switch_mode mode,
 {
 	long sb_index;
 	long reserve_commit_diff;
+	long off;
 
 	offsets->begin = local_read(&buf->offset);
 	offsets->old = offsets->begin;
@@ -998,7 +999,8 @@ int ltt_relay_try_switch_slow(enum force_switch_mode mode,
 
 	*tsc = trace_clock_read64();
 
-	if (SUBBUF_OFFSET(offsets->begin, chan) != 0) {
+	off = SUBBUF_OFFSET(offsets->begin, chan);
+	if ((mode != FORCE_ACTIVE && off > 0) || off > ltt_sb_header_size()) {
 		offsets->begin = SUBBUF_ALIGN(offsets->begin, chan);
 		offsets->end_switch_old = 1;
 	} else {
-- 
1.6.5.2

