From 6cdb21bfddc013f4c2c8a948bd6452e5a9d2297d Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Fri, 11 May 2012 15:48:00 -0700
Subject: [PATCH 200/248] lttng-instrumentation-xtime-deprecated

lttng instrumentation xtime deprecated

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
---
 include/linux/time.h      |    2 ++
 kernel/time/timekeeping.c |    6 ++++++
 kernel/timer.c            |    4 ++++
 3 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/include/linux/time.h b/include/linux/time.h
index 33a92ea..4c0dc28 100644
--- a/include/linux/time.h
+++ b/include/linux/time.h
@@ -170,6 +170,8 @@ extern u64 timekeeping_max_deferment(void);
 extern void timekeeping_leap_insert(int leapsecond);
 extern int timekeeping_inject_offset(struct timespec *ts);
 
+struct timespec __get_wall_to_monotonic(void); /* does not take xtime_lock */
+
 struct tms;
 extern void do_sys_times(struct tms *);
 
diff --git a/kernel/time/timekeeping.c b/kernel/time/timekeeping.c
index ac05643..b5f8402 100644
--- a/kernel/time/timekeeping.c
+++ b/kernel/time/timekeeping.c
@@ -82,6 +82,12 @@ struct timekeeper {
 
 static struct timekeeper timekeeper;
 
+struct timespec __get_wall_to_monotonic(void)
+{
+        return wall_to_monotonic;
+}
+
+
 /*
  * This read-write spinlock protects us from races in SMP while
  * playing with xtime.
diff --git a/kernel/timer.c b/kernel/timer.c
index 9dcf6c2..0f1e122 100644
--- a/kernel/timer.c
+++ b/kernel/timer.c
@@ -1375,7 +1375,11 @@ static void run_timer_softirq(struct softirq_action *h)
  */
 void run_local_timers(void)
 {
+	struct timespec curtime, wtom;
+
 	hrtimer_run_queues();
+	curtime = __current_kernel_time();
+	wtom = __get_wall_to_monotonic();
 	raise_softirq(TIMER_SOFTIRQ);
 }
 
-- 
1.7.0.4

