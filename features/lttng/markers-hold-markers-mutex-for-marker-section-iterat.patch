From 4f8eecc88245d915ff6c9e1c4602a82d0ddf3c34 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:27:21 -0400
Subject: [PATCH 232/391] markers-hold-markers-mutex-for-marker-section-iteration

Hold the markers_mutex during marker section iteration.

From: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
Signed-off-by: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 kernel/marker.c         |    2 ++
 ltt/ltt-trace-control.c |   12 ++++++++++++
 2 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/kernel/marker.c b/kernel/marker.c
index 7d11393..93ffa8e 100644
--- a/kernel/marker.c
+++ b/kernel/marker.c
@@ -44,11 +44,13 @@ void lock_markers(void)
 {
 	mutex_lock(&markers_mutex);
 }
+EXPORT_SYMBOL_GPL(lock_markers);
 
 void unlock_markers(void)
 {
 	mutex_unlock(&markers_mutex);
 }
+EXPORT_SYMBOL_GPL(unlock_markers);
 
 /*
  * Marker hash table, containing the active markers.
diff --git a/ltt/ltt-trace-control.c b/ltt/ltt-trace-control.c
index 00257fa..1d94179 100644
--- a/ltt/ltt-trace-control.c
+++ b/ltt/ltt-trace-control.c
@@ -848,6 +848,8 @@ static ssize_t marker_info_read(struct file *filp, char __user *ubuf,
 	len = 0;
 	buf = (char *)__get_free_page(GFP_KERNEL);
 
+	lock_markers();
+
 	marker_iter_reset(&iter);
 	marker_iter_start(&iter);
 	for (; iter.marker != NULL; marker_iter_next(&iter)) {
@@ -874,6 +876,8 @@ static ssize_t marker_info_read(struct file *filp, char __user *ubuf,
 	}
 	marker_iter_stop(&iter);
 
+	unlock_markers();
+
 	if (len >= PAGE_SIZE) {
 		len = PAGE_SIZE;
 		buf[PAGE_SIZE] = '\0';
@@ -960,6 +964,8 @@ static int build_marker_control_files(void)
 	if (!markers_control_dir)
 		return -EEXIST;
 
+	lock_markers();
+
 	marker_iter_reset(&iter);
 	marker_iter_start(&iter);
 	for (; iter.marker != NULL; marker_iter_next(&iter)) {
@@ -968,6 +974,9 @@ static int build_marker_control_files(void)
 			goto err_build_fail;
 	}
 	marker_iter_stop(&iter);
+
+	unlock_markers();
+
 	return 0;
 
 err_build_fail:
@@ -993,6 +1002,8 @@ static int remove_marker_control_dir(struct module *mod, struct marker *marker)
 		return -ENOENT;
 	name = marker_d->d_name.name;
 
+	lock_markers();
+
 	marker_iter_reset(&iter);
 	marker_iter_start(&iter);
 	for (; iter.marker != NULL; marker_iter_next(&iter)) {
@@ -1010,6 +1021,7 @@ static int remove_marker_control_dir(struct module *mod, struct marker *marker)
 
 end:
 	marker_iter_stop(&iter);
+	unlock_markers();
 	return 0;
 }
 
-- 
1.6.5.2

