From 05a443b5d8aa17358c9a40ecdcd0e7ee21f3acf1 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:27:39 -0400
Subject: [PATCH 266/391] lttng-relay-irqoff-fix-splice-size

lttng relay irqoff fix splice size

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 ltt/ltt-relay-irqoff.c |    7 ++++---
 1 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/ltt/ltt-relay-irqoff.c b/ltt/ltt-relay-irqoff.c
index 0a814fa..b7b751a 100644
--- a/ltt/ltt-relay-irqoff.c
+++ b/ltt/ltt-relay-irqoff.c
@@ -661,10 +661,11 @@ static int subbuf_splice_actor(struct file *in,
 	consumed_idx = SUBBUF_INDEX(consumed_old, buf->chan);
 
 	/*
-	 * Adjust read len, if longer than what is available
+	 * Adjust read len, if longer than what is available.
+	 * Max read size is 1 subbuffer due to get_subbuf/put_subbuf for
+	 * protection.
 	 */
-	bytes_avail = SUBBUF_TRUNC(local_read(&ltt_buf->offset), buf->chan)
-		    - consumed_old;
+	bytes_avail = buf->chan->subbuf_size;
 	WARN_ON(bytes_avail > buf->chan->alloc_size);
 	len = min_t(size_t, len, bytes_avail);
 	subbuf_pages = bytes_avail >> PAGE_SHIFT;
-- 
1.6.5.2

