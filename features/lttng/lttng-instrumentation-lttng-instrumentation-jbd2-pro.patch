From 9d0f5eb64ed148580dfcb778bc2563f37c11fc62 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:26:11 -0400
Subject: [PATCH 108/391] lttng-instrumentation/lttng-instrumentation-jbd2-probes

LTTng instrumentation JBD2 probes

Probes implementing markers which record the data collected from JBD2 into trace
buffers.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
CC: Theodore Ts'o <tytso@mit.edu>
CC: Stephen C. Tweedie <sct@redhat.com>
CC: Andrew Morton <akpm@linux-foundation.org>
CC: linux-ext4@vger.kernel.org
---
 ltt/probes/Makefile     |    8 ++++++++
 ltt/probes/jbd2-trace.c |   39 +++++++++++++++++++++++++++++++++++++++
 2 files changed, 47 insertions(+), 0 deletions(-)
 create mode 100644 ltt/probes/jbd2-trace.c

diff --git a/ltt/probes/Makefile b/ltt/probes/Makefile
index 157151b..6fe4761 100644
--- a/ltt/probes/Makefile
+++ b/ltt/probes/Makefile
@@ -18,3 +18,11 @@ CFLAGS_REMOVE_net-trace.o = -pg
 endif
 obj-$(CONFIG_LTT_TRACEPROBES)	+= net-trace.o
 endif
+
+ifdef CONFIG_JBD2
+ifdef CONFIG_FTRACE
+CFLAGS_REMOVE_jbd2-trace.o = -pg
+endif
+obj-$(CONFIG_LTT_TRACEPROBES)	+= jbd2-trace.o
+endif
+
diff --git a/ltt/probes/jbd2-trace.c b/ltt/probes/jbd2-trace.c
new file mode 100644
index 0000000..acaab30
--- /dev/null
+++ b/ltt/probes/jbd2-trace.c
@@ -0,0 +1,39 @@
+/*
+ * ltt/probes/jbd2-trace.c
+ *
+ * JBD2 tracepoint probes.
+ *
+ * (C) Copyright 2009 - Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
+ * Dual LGPL v2.1/GPL v2 license.
+ */
+
+#include <linux/module.h>
+#include <trace/jbd2.h>
+
+void probe_jbd2_checkpoint(journal_t *journal, int result)
+{
+	trace_mark_tp(jbd2, checkpoint, jbd2_checkpoint,
+		probe_jbd2_checkpoint, "dev %s need_checkpoint %d",
+		journal->j_devname, result);
+}
+
+void probe_jbd2_start_commit(journal_t *journal,
+			     transaction_t *commit_transaction)
+{
+	trace_mark_tp(jbd2, start_commit, jbd2_start_commit,
+		probe_jbd2_start_commit, "dev %s transaction %d",
+		journal->j_devname, commit_transaction->t_tid);
+}
+
+void probe_jbd2_end_commit(journal_t *journal,
+			   transaction_t *commit_transaction)
+{
+	trace_mark_tp(jbd2, end_commit, jbd2_end_commit,
+		probe_jbd2_end_commit, "dev %s transaction %d head %d",
+		journal->j_devname, commit_transaction->t_tid,
+		journal->j_tail_sequence);
+}
+
+MODULE_LICENSE("GPL and additional rights");
+MODULE_AUTHOR("Mathieu Desnoyers");
+MODULE_DESCRIPTION("JBD2 Tracepoint Probes");
-- 
1.6.5.2

