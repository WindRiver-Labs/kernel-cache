From aa6a178f9f0794cf988e1f88793276c207f7ada9 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Wed, 18 May 2011 18:42:46 -0400
Subject: [PATCH 201/248] trace-clock-get-may-fail

Trace clock get may fail

ARM pmu reservation may fail, so we have to change the trace clock get
prototype.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
---
 arch/arm/mach-omap2/trace-clock.c             |    3 ++-
 arch/arm/plat-omap/include/plat/trace-clock.h |    2 +-
 arch/mips/include/asm/octeon/trace-clock.h    |    4 ++--
 arch/mips/include/asm/trace-clock.h           |    3 ++-
 arch/powerpc/include/asm/trace-clock.h        |    3 ++-
 arch/sh/include/asm/trace-clock.h             |    3 ++-
 arch/sparc/include/asm/trace-clock.h          |    3 ++-
 arch/x86/include/asm/trace-clock.h            |    2 +-
 arch/x86/kernel/trace-clock.c                 |    3 ++-
 9 files changed, 16 insertions(+), 10 deletions(-)

diff --git a/arch/arm/mach-omap2/trace-clock.c b/arch/arm/mach-omap2/trace-clock.c
index 31e50b4..4261c95 100644
--- a/arch/arm/mach-omap2/trace-clock.c
+++ b/arch/arm/mach-omap2/trace-clock.c
@@ -534,7 +534,7 @@ static int __cpuinit hotcpu_callback(struct notifier_block *nb,
 	return NOTIFY_OK;
 }
 
-void get_trace_clock(void)
+int get_trace_clock(void)
 {
 	spin_lock(&trace_clock_lock);
 	if (trace_clock_refcount++)
@@ -542,6 +542,7 @@ void get_trace_clock(void)
 	_start_trace_clock();
 end:
 	spin_unlock(&trace_clock_lock);
+	return 0;
 }
 EXPORT_SYMBOL_GPL(get_trace_clock);
 
diff --git a/arch/arm/plat-omap/include/plat/trace-clock.h b/arch/arm/plat-omap/include/plat/trace-clock.h
index a3a9e4b..a960d71 100644
--- a/arch/arm/plat-omap/include/plat/trace-clock.h
+++ b/arch/arm/plat-omap/include/plat/trace-clock.h
@@ -155,7 +155,7 @@ static inline u32 trace_clock_freq_scale(void)
 	return 1;
 }
 
-extern void get_trace_clock(void);
+extern int get_trace_clock(void);
 extern void put_trace_clock(void);
 extern void get_synthetic_tsc(void);
 extern void put_synthetic_tsc(void);
diff --git a/arch/mips/include/asm/octeon/trace-clock.h b/arch/mips/include/asm/octeon/trace-clock.h
index e097c4c..062662b 100644
--- a/arch/mips/include/asm/octeon/trace-clock.h
+++ b/arch/mips/include/asm/octeon/trace-clock.h
@@ -31,9 +31,9 @@ static inline u32 trace_clock_freq_scale(void)
 	return 1;
 }
 
-static inline void get_trace_clock(void)
+static inline int get_trace_clock(void)
 {
-	return;
+	return 0;
 }
 
 static inline void put_trace_clock(void)
diff --git a/arch/mips/include/asm/trace-clock.h b/arch/mips/include/asm/trace-clock.h
index 94a7db3..9bbcf99 100644
--- a/arch/mips/include/asm/trace-clock.h
+++ b/arch/mips/include/asm/trace-clock.h
@@ -59,9 +59,10 @@ static inline u32 trace_clock_freq_scale(void)
 extern void get_synthetic_tsc(void);
 extern void put_synthetic_tsc(void);
 
-static inline void get_trace_clock(void)
+static inline int get_trace_clock(void)
 {
 	get_synthetic_tsc();
+	return 0;
 }
 
 static inline void put_trace_clock(void)
diff --git a/arch/powerpc/include/asm/trace-clock.h b/arch/powerpc/include/asm/trace-clock.h
index b0b4e21..05facc3 100644
--- a/arch/powerpc/include/asm/trace-clock.h
+++ b/arch/powerpc/include/asm/trace-clock.h
@@ -33,8 +33,9 @@ static inline u32 trace_clock_freq_scale(void)
 	return 1;
 }
 
-static inline void get_trace_clock(void)
+static inline int get_trace_clock(void)
 {
+	return 0;
 }
 
 static inline void put_trace_clock(void)
diff --git a/arch/sh/include/asm/trace-clock.h b/arch/sh/include/asm/trace-clock.h
index 2e90aba..152d54c 100644
--- a/arch/sh/include/asm/trace-clock.h
+++ b/arch/sh/include/asm/trace-clock.h
@@ -49,9 +49,10 @@ static inline u32 trace_clock_freq_scale(void)
 	return 1;
 }
 
-static inline void get_trace_clock(void)
+static inline int get_trace_clock(void)
 {
 	get_synthetic_tsc();
+	return 0;
 }
 
 static inline void put_trace_clock(void)
diff --git a/arch/sparc/include/asm/trace-clock.h b/arch/sparc/include/asm/trace-clock.h
index 75ac94e..306fdf7 100644
--- a/arch/sparc/include/asm/trace-clock.h
+++ b/arch/sparc/include/asm/trace-clock.h
@@ -29,8 +29,9 @@ static inline u32 trace_clock_freq_scale(void)
 	return 1;
 }
 
-static inline void get_trace_clock(void)
+static inline int get_trace_clock(void)
 {
+	return 0;
 }
 
 static inline void put_trace_clock(void)
diff --git a/arch/x86/include/asm/trace-clock.h b/arch/x86/include/asm/trace-clock.h
index ccdcb67..01bc2f5 100644
--- a/arch/x86/include/asm/trace-clock.h
+++ b/arch/x86/include/asm/trace-clock.h
@@ -62,7 +62,7 @@ static inline u32 trace_clock_freq_scale(void)
 	return 1;
 }
 
-extern void get_trace_clock(void);
+extern int get_trace_clock(void);
 extern void put_trace_clock(void);
 
 extern void set_trace_clock_is_sync(int state);
diff --git a/arch/x86/kernel/trace-clock.c b/arch/x86/kernel/trace-clock.c
index b6c9d1f..ec866aa 100644
--- a/arch/x86/kernel/trace-clock.c
+++ b/arch/x86/kernel/trace-clock.c
@@ -186,7 +186,7 @@ static int __cpuinit hotcpu_callback(struct notifier_block *nb,
 	return NOTIFY_OK;
 }
 
-void get_trace_clock(void)
+int get_trace_clock(void)
 {
 	int cpu;
 
@@ -212,6 +212,7 @@ void get_trace_clock(void)
 end:
 	spin_unlock(&async_tsc_lock);
 	put_online_cpus();
+	return 0;
 }
 EXPORT_SYMBOL_GPL(get_trace_clock);
 
-- 
1.7.0.4

