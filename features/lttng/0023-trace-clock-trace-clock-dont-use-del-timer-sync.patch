From 378f93e9674f1dfaab1d2736d1efddf13e1d4222 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Wed, 18 May 2011 18:41:25 -0400
Subject: [PATCH 023/248] trace-clock/trace-clock-dont-use-del-timer-sync

trace clock 32-to-64 : don't use del_timer_sync

cannot use del_timer_sync with add_timer_on. The proper way to do it is to send
an IPI which does a del_timer on the remote CPU.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 kernel/trace/trace-clock-32-to-64.c |   11 ++++++++++-
 1 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/kernel/trace/trace-clock-32-to-64.c b/kernel/trace/trace-clock-32-to-64.c
index 4b9e2e7..3134e47 100644
--- a/kernel/trace/trace-clock-32-to-64.c
+++ b/kernel/trace/trace-clock-32-to-64.c
@@ -188,9 +188,18 @@ static void enable_synthetic_tsc(int cpu)
 	add_timer_on(&per_cpu(tsc_timer, cpu), cpu);
 }
 
+/*
+ * Cannot use del_timer_sync with add_timer_on, so use an IPI to locally
+ * delete the timer.
+ */
+static void disable_synthetic_tsc_ipi(void *info)
+{
+	del_timer(&per_cpu(tsc_timer, smp_processor_id()));
+}
+
 static void disable_synthetic_tsc(int cpu)
 {
-	del_timer_sync(&per_cpu(tsc_timer, cpu));
+	smp_call_function_single(cpu, disable_synthetic_tsc_ipi, NULL, 1);
 }
 
 /*
-- 
1.7.0.4

