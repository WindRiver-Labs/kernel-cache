From 0ff00f87d4e0f6d63943f7fe953eee4e4e1ca95a Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:25:21 -0400
Subject: [PATCH 023/391] trace-clock/trace-clock-dont-use-del-timer-sync

trace clock 32-to-64 : don't use del_timer_sync

cannot use del_timer_sync with add_timer_on. The proper way to do it is to send
an IPI which does a del_timer on the remote CPU.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 kernel/trace/trace-clock-32-to-64.c |   11 ++++++++++-
 1 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/kernel/trace/trace-clock-32-to-64.c b/kernel/trace/trace-clock-32-to-64.c
index 4b9e2e7..3134e47 100644
--- a/kernel/trace/trace-clock-32-to-64.c
+++ b/kernel/trace/trace-clock-32-to-64.c
@@ -188,9 +188,18 @@ static void enable_synthetic_tsc(int cpu)
 	add_timer_on(&per_cpu(tsc_timer, cpu), cpu);
 }
 
+/*
+ * Cannot use del_timer_sync with add_timer_on, so use an IPI to locally
+ * delete the timer.
+ */
+static void disable_synthetic_tsc_ipi(void *info)
+{
+	del_timer(&per_cpu(tsc_timer, smp_processor_id()));
+}
+
 static void disable_synthetic_tsc(int cpu)
 {
-	del_timer_sync(&per_cpu(tsc_timer, cpu));
+	smp_call_function_single(cpu, disable_synthetic_tsc_ipi, NULL, 1);
 }
 
 /*
-- 
1.6.5.2

