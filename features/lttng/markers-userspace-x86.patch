From e6a79822300e9390402a2d16b9c5fd545ad35449 Mon Sep 17 00:00:00 2001
From: auto commit <unknown@unknown>
Date: Tue, 15 Jul 2008 15:19:32 -0400
Subject: [PATCH] Markers userspace x86

x86_32 userspace markers.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 arch/x86/Kconfig                   |    1 +
 arch/x86/kernel/signal_32.c        |   16 ++++++++++++++++
 arch/x86/kernel/syscall_table_32.S |    2 ++
 include/asm-x86/thread_info_32.h   |    2 ++
 include/asm-x86/unistd_32.h        |    4 +++-
 5 files changed, 24 insertions(+), 1 deletions(-)

diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig
index 6db7e3a..c9c1c3b 100644
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@ -11,6 +11,7 @@ config 64BIT
 
 config X86_32
 	def_bool !64BIT
+	select HAVE_MARKERS_ABI
 
 config X86_64
 	def_bool 64BIT
diff --git a/arch/x86/kernel/signal_32.c b/arch/x86/kernel/signal_32.c
index d923736..43b68b8 100644
--- a/arch/x86/kernel/signal_32.c
+++ b/arch/x86/kernel/signal_32.c
@@ -20,6 +20,7 @@
 #include <linux/elf.h>
 #include <linux/smp.h>
 #include <linux/mm.h>
+#include <linux/marker.h>
 
 #include <asm/processor.h>
 #include <asm/ucontext.h>
@@ -670,5 +671,20 @@ do_notify_resume(struct pt_regs *regs, void *unused, __u32 thread_info_flags)
 	if (thread_info_flags & _TIF_HRTICK_RESCHED)
 		hrtick_resched();
 
+#ifdef CONFIG_MARKERS_USERSPACE
+	/* Pending marker update ? */
+	if (thread_info_flags & _TIF_MARKER_PENDING) {
+		/*
+		 * marker_update_process can sleep because it writes to
+		 * userspace and because it takes a mutex. While locking could
+		 * be changed to a non-blocking scheme, it is good do do not
+		 * fail on userspace page faults.
+		 */
+		local_irq_enable();
+		marker_update_process();
+		local_irq_disable();
+	}
+#endif
+
 	clear_thread_flag(TIF_IRET);
 }
diff --git a/arch/x86/kernel/syscall_table_32.S b/arch/x86/kernel/syscall_table_32.S
index adff556..582e042 100644
--- a/arch/x86/kernel/syscall_table_32.S
+++ b/arch/x86/kernel/syscall_table_32.S
@@ -326,3 +326,5 @@ ENTRY(sys_call_table)
 	.long sys_fallocate
 	.long sys_timerfd_settime	/* 325 */
 	.long sys_timerfd_gettime
+	.long sys_marker
+	.long sys_trace
diff --git a/include/asm-x86/thread_info_32.h b/include/asm-x86/thread_info_32.h
index ef8db48..ad0b64d 100644
--- a/include/asm-x86/thread_info_32.h
+++ b/include/asm-x86/thread_info_32.h
@@ -133,6 +133,7 @@ static inline struct thread_info *current_thread_info(void)
 #define TIF_SECCOMP		7	/* secure computing */
 #define TIF_HRTICK_RESCHED	9	/* reprogram hrtick timer */
 #define TIF_KERNEL_TRACE	10	/* kernel trace active */
+#define TIF_MARKER_PENDING	11	/* marker update pending */
 #define TIF_MEMDIE		16
 #define TIF_DEBUG		17	/* uses debug registers */
 #define TIF_IO_BITMAP		18	/* uses I/O bitmap */
@@ -153,6 +154,7 @@ static inline struct thread_info *current_thread_info(void)
 #define _TIF_SECCOMP		(1 << TIF_SECCOMP)
 #define _TIF_HRTICK_RESCHED	(1 << TIF_HRTICK_RESCHED)
 #define _TIF_KERNEL_TRACE	(1 << TIF_KERNEL_TRACE)
+#define _TIF_MARKER_PENDING	(1 << TIF_MARKER_PENDING)
 #define _TIF_DEBUG		(1 << TIF_DEBUG)
 #define _TIF_IO_BITMAP		(1 << TIF_IO_BITMAP)
 #define _TIF_FREEZE		(1 << TIF_FREEZE)
diff --git a/include/asm-x86/unistd_32.h b/include/asm-x86/unistd_32.h
index 194211e..926c503 100644
--- a/include/asm-x86/unistd_32.h
+++ b/include/asm-x86/unistd_32.h
@@ -332,8 +332,10 @@
 #define __NR_fallocate		324
 #define __NR_timerfd_settime	325
 #define __NR_timerfd_gettime	326
+#define __NR_marker		327
+#define __NR_trace		328
 
-#define NR_syscalls		327
+#define NR_syscalls		329
 
 #ifdef __KERNEL__
 
-- 
1.5.5.1

