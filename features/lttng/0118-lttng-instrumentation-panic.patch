From 7588ac7117fad3080ca60e8995fae83c0bdec9cb Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Thu, 10 May 2012 13:06:43 -0700
Subject: [PATCH 118/248] lttng-instrumentation-panic

LTTng instrumentation panic

Instrumentation of following panic and kexec related events are added:
        panic
        kernel_kexec
        crash_kexec

It is useful for build flight-recorder program based on lttng infrastructure.

From: Zhao Lei <zhaolei@cn.fujitsu.com>
Signed-off-by: Zhao Lei <zhaolei@cn.fujitsu.com>
Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 include/trace/kernel.h |   12 ++++++++++++
 kernel/kexec.c         |    8 ++++++++
 kernel/panic.c         |    7 +++++++
 3 files changed, 27 insertions(+), 0 deletions(-)

diff --git a/include/trace/kernel.h b/include/trace/kernel.h
index 2b54cce..ca61c54 100644
--- a/include/trace/kernel.h
+++ b/include/trace/kernel.h
@@ -2,6 +2,9 @@
 #define _TRACE_KERNEL_H
 
 #include <linux/tracepoint.h>
+#include <linux/kexec.h>
+
+struct kimage;
 
 DECLARE_TRACE(kernel_printk,
 	TP_PROTO(unsigned long retaddr),
@@ -15,5 +18,14 @@ DECLARE_TRACE(kernel_module_free,
 DECLARE_TRACE(kernel_module_load,
 	TP_PROTO(struct module *mod),
 		TP_ARGS(mod));
+DECLARE_TRACE(kernel_panic,
+	TP_PROTO(const char *fmt, va_list args),
+		TP_ARGS(fmt, args));
+DECLARE_TRACE(kernel_kernel_kexec,
+	TP_PROTO(struct kimage *image),
+		TP_ARGS(image));
+DECLARE_TRACE(kernel_crash_kexec,
+	TP_PROTO(struct kimage *image, struct pt_regs *regs),
+		TP_ARGS(image, regs));
 
 #endif
diff --git a/kernel/kexec.c b/kernel/kexec.c
index 4e2e472..b2cbf46 100644
--- a/kernel/kexec.c
+++ b/kernel/kexec.c
@@ -33,12 +33,16 @@
 #include <linux/vmalloc.h>
 #include <linux/swap.h>
 #include <linux/syscore_ops.h>
+#include <trace/kernel.h>
 
 #include <asm/page.h>
 #include <asm/uaccess.h>
 #include <asm/io.h>
 #include <asm/sections.h>
 
+DEFINE_TRACE(kernel_kernel_kexec);
+DEFINE_TRACE(kernel_crash_kexec);
+
 /* Per cpu memory for storing cpu states in case of system crash. */
 note_buf_t __percpu *crash_notes;
 
@@ -1080,6 +1084,8 @@ asmlinkage long compat_sys_kexec_load(unsigned long entry,
 
 void crash_kexec(struct pt_regs *regs)
 {
+	trace_kernel_crash_kexec(kexec_crash_image, regs);
+
 	/* Take the kexec_mutex here to prevent sys_kexec_load
 	 * running on one cpu from replacing the crash kernel
 	 * we are using after a panic on a different cpu.
@@ -1530,6 +1536,8 @@ int kernel_kexec(void)
 {
 	int error = 0;
 
+	trace_kernel_kernel_kexec(kexec_image);
+
 	if (!mutex_trylock(&kexec_mutex))
 		return -EBUSY;
 	if (!kexec_image) {
diff --git a/kernel/panic.c b/kernel/panic.c
index 8ed89a1..2f92477 100644
--- a/kernel/panic.c
+++ b/kernel/panic.c
@@ -23,6 +23,9 @@
 #include <linux/init.h>
 #include <linux/nmi.h>
 #include <linux/dmi.h>
+#include <trace/kernel.h>
+
+DEFINE_TRACE(kernel_panic);
 
 #define PANIC_TIMER_STEP 100
 #define PANIC_BLINK_SPD 18
@@ -74,6 +77,10 @@ void panic(const char *fmt, ...)
 	long i, i_next = 0;
 	int state = 0;
 
+	va_start(args, fmt);
+	trace_kernel_panic(fmt, args);
+	va_end(args);
+
 	/*
 	 * It's possible to come here directly from a panic-assertion and
 	 * not have preempt disabled. Some functions called from here want
-- 
1.7.0.4

