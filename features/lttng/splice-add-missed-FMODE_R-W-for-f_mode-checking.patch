From ed506135f94b6e373da204b739480d7b585f1677 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Wed, 1 Sep 2010 03:17:38 -0700
Subject: [PATCH] splice: add missed FMODE_R/W for f_mode checking

User program will get "invalid argument" when file in/out with FMODE_R/W.
So add them for checking.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 fs/splice.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/fs/splice.c b/fs/splice.c
index f873c84..1a534d4 100644
--- a/fs/splice.c
+++ b/fs/splice.c
@@ -1325,7 +1325,7 @@ static long do_splice(struct file *in, loff_t __user *off_in,
 		if (off_in)
 			return -ESPIPE;
 		if (off_out) {
-			if (!(out->f_mode & FMODE_PWRITE))
+			if (!(out->f_mode & (FMODE_WRITE | FMODE_PWRITE)))
 				return -EINVAL;
 			if (copy_from_user(&offset, off_out, sizeof(loff_t)))
 				return -EFAULT;
@@ -1345,7 +1345,7 @@ static long do_splice(struct file *in, loff_t __user *off_in,
 		if (off_out)
 			return -ESPIPE;
 		if (off_in) {
-			if (!(in->f_mode & FMODE_PREAD))
+			if (!(in->f_mode & (FMODE_READ | FMODE_PREAD)))
 				return -EINVAL;
 			if (copy_from_user(&offset, off_in, sizeof(loff_t)))
 				return -EFAULT;
-- 
1.6.5.2

