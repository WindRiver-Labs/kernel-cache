From 83452f58d481f36790eb1a50326e9a90c67adf81 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:27:49 -0400
Subject: [PATCH 283/391] lttng-relay-lockless-fix-alloc

lttng relay lockless fix alloc

Bug exposed when using large number of subbuffers.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 ltt/ltt-relay-lockless.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/ltt/ltt-relay-lockless.c b/ltt/ltt-relay-lockless.c
index 9acaccd..3b1467e 100644
--- a/ltt/ltt-relay-lockless.c
+++ b/ltt/ltt-relay-lockless.c
@@ -863,7 +863,7 @@ static int ltt_relay_create_buffer(struct ltt_trace_struct *trace,
 		return -ENOMEM;
 
 	ltt_buf->commit_count =
-		kzalloc_node(ALIGN(sizeof(ltt_buf->commit_count) * n_subbufs,
+		kzalloc_node(ALIGN(sizeof(*ltt_buf->commit_count) * n_subbufs,
 				   1 << INTERNODE_CACHE_SHIFT),
 			GFP_KERNEL, cpu_to_node(cpu));
 	if (!ltt_buf->commit_count) {
@@ -873,7 +873,7 @@ static int ltt_relay_create_buffer(struct ltt_trace_struct *trace,
 
 #ifdef CONFIG_LTT_VMCORE
 	ltt_buf->commit_seq =
-		kzalloc_node(ALIGN(sizeof(ltt_buf->commit_seq) * n_subbufs,
+		kzalloc_node(ALIGN(sizeof(*ltt_buf->commit_seq) * n_subbufs,
 				   1 << INTERNODE_CACHE_SHIFT),
 			GFP_KERNEL, cpu_to_node(cpu));
 	if (!ltt_buf->commit_seq) {
-- 
1.6.5.2

