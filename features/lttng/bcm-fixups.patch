From d67af43a054d36df60b8b6d09d49c8810ea1c3f0 Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Tue, 9 Sep 2008 22:54:39 -0400
Subject: [PATCH] sb1250 mips_hpt_frequency init

This patch addes initialization of mips_hpt_frequency
into sb1250/time.c, the ltt_init_synthetic_tsc() work
properly.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/sibyte/bcm1480/time.c |    6 +++++-
 arch/mips/sibyte/sb1250/time.c  |   17 +++++++++++++++++
 2 files changed, 22 insertions(+), 1 deletions(-)

diff --git a/arch/mips/sibyte/bcm1480/time.c b/arch/mips/sibyte/bcm1480/time.c
index 5439018..c2d35d9 100644
--- a/arch/mips/sibyte/bcm1480/time.c
+++ b/arch/mips/sibyte/bcm1480/time.c
@@ -20,7 +20,11 @@
 #ifdef CONFIG_SIMULATION
 #define BCM1480_HPT_VALUE       50000
 #else
-#define BCM1480_HPT_VALUE       1000000
+/* zbbus_mhz is an exported symbol initialized in bcm1480_setup() to that it
+ * contains the zbbus frequency in MHz. The zbbus runs as 1/2 the clock
+ * frequency. */
+extern unsigned int zbbus_mhz;
+#define BCM1480_HPT_VALUE	(zbbus_mhz * 2 * 1000000)
 #endif
 
 extern unsigned int mips_hpt_frequency;
diff --git a/arch/mips/sibyte/sb1250/time.c b/arch/mips/sibyte/sb1250/time.c
index 68337bf..05b92ff 100644
--- a/arch/mips/sibyte/sb1250/time.c
+++ b/arch/mips/sibyte/sb1250/time.c
@@ -20,8 +20,25 @@
 extern void sb1250_clocksource_init(void);
 extern void sb1250_clockevent_init(void);
 
+#ifdef CONFIG_SIMULATION
+#define BCM1250_HPT_VALUE       50000
+#else
+/* zbbus_mhz is an exported symbol initialized in bcm1250_setup() to that it
+ * contains the zbbus frequency in MHz. The zbbus runs as 1/2 the clock
+ * frequency. */
+extern unsigned int zbbus_mhz;
+#define BCM1250_HPT_VALUE       (zbbus_mhz * 2 * 1000000)
+#endif
+
+extern unsigned int mips_hpt_frequency;
+ 
 void __init plat_time_init(void)
 {
 	sb1250_clocksource_init();
 	sb1250_clockevent_init();
+
+	/* To initialize mips_hpt_frequency used by ltt_frequency
+	 *  otherwise there is div/zero when boot. 
+	 */
+	mips_hpt_frequency = BCM1250_HPT_VALUE;
 }
-- 
1.6.0.3

