From 76e7617814db725bdb1fd8ccabfb31deaa2b9a71 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:26:52 -0400
Subject: [PATCH 180/391] omap-trace-clock-add-write-trace-clock

omap trace clock add write value

Allow update of trace clock after a long period of time.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 arch/arm/plat-omap/include/mach/trace-clock.h |    1 +
 kernel/trace/trace-clock-32-to-64.c           |   14 ++++++++++++++
 2 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-omap/include/mach/trace-clock.h b/arch/arm/plat-omap/include/mach/trace-clock.h
index 5b5d09e..a41d5ad 100644
--- a/arch/arm/plat-omap/include/mach/trace-clock.h
+++ b/arch/arm/plat-omap/include/mach/trace-clock.h
@@ -34,6 +34,7 @@
 #define TC_EXPECTED_INTERRUPT_LATENCY	30
 
 extern u64 trace_clock_read_synthetic_tsc(void);
+extern void _trace_clock_write_synthetic_tsc(u64 value);
 extern struct omap_dm_timer *trace_clock_timer;
 extern unsigned long long cpu_hz;
 
diff --git a/kernel/trace/trace-clock-32-to-64.c b/kernel/trace/trace-clock-32-to-64.c
index cac40e3..da38361 100644
--- a/kernel/trace/trace-clock-32-to-64.c
+++ b/kernel/trace/trace-clock-32-to-64.c
@@ -90,6 +90,20 @@ static void update_synthetic_tsc(void)
 	}
 }
 
+/*
+ * Should only be called when the synthetic clock is not used.
+ */
+void _trace_clock_write_synthetic_tsc(u64 value)
+{
+	struct synthetic_tsc_struct *cpu_synth;
+	int cpu;
+
+	for_each_online_cpu(cpu) {
+		cpu_synth = &per_cpu(synthetic_tsc, cpu);
+		cpu_synth->tsc[cpu_synth->index].val = value;
+	}
+}
+
 /* Called from buffer switch : in _any_ context (even NMI) */
 u64 notrace trace_clock_read_synthetic_tsc(void)
 {
-- 
1.6.5.2

