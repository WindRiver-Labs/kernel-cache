From 065acf9aa9f9cfeb11b3efdc6505cb1c76abf794 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:28:06 -0400
Subject: [PATCH 319/391] immediate-values-hotplug-race-fix

Immediate values fix hotplug race

on_each_cpu seems to have a problem when executing concurrently with cpu
hotpunplug. It waits endlessly for an IPI to execute.

Use get/put_online_cpus() to work around this problem at the immediate value
code level.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 kernel/immediate.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/kernel/immediate.c b/kernel/immediate.c
index 22c7083..ca8ae2c 100644
--- a/kernel/immediate.c
+++ b/kernel/immediate.c
@@ -7,6 +7,7 @@
 #include <linux/mutex.h>
 #include <linux/immediate.h>
 #include <linux/memory.h>
+#include <linux/cpu.h>
 
 #include <asm/sections.h>
 
@@ -41,9 +42,12 @@ void imv_update_range(const struct __imv *begin,
 	for (iter = begin; iter < end; iter++) {
 		if (!iter->imv) /* Skip removed __init immediate values */
 			continue;
+		/* workaround on_each_cpu cpu hotplug race */
+		get_online_cpus();
 		mutex_lock(&text_mutex);
 		ret = arch_imv_update(iter, !imv_early_boot_complete);
 		mutex_unlock(&text_mutex);
+		put_online_cpus();
 		if (imv_early_boot_complete && ret)
 			printk(KERN_WARNING
 				"Invalid immediate value. "
-- 
1.6.5.2

