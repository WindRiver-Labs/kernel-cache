From 8f4bee9c2dbd7ad3f5b0329d048de8b3af1b1e13 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:26:27 -0400
Subject: [PATCH 138/391] lttng-instrumentation/lttng-instrumentation-syscall-tracepoints-probes

LTTng instrumentation syscall tracepoints probes

Syscall instrumentation tracepoints probes.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 ltt/probes/Makefile        |    4 ++-
 ltt/probes/syscall-trace.c |   53 ++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 56 insertions(+), 1 deletions(-)
 create mode 100644 ltt/probes/syscall-trace.c

diff --git a/ltt/probes/Makefile b/ltt/probes/Makefile
index 85b063e..4de500d 100644
--- a/ltt/probes/Makefile
+++ b/ltt/probes/Makefile
@@ -7,10 +7,12 @@ CFLAGS_REMOVE_fs-trace.o = -pg
 CFLAGS_REMOVE_ipc-trace.o = -pg
 CFLAGS_REMOVE_lockdep-trace.o = -pg
 CFLAGS_REMOVE_rcu-trace.o = -pg
+CFLAGS_REMOVE_syscall-trace.o = -pg
 endif
 
 obj-$(CONFIG_LTT_TRACEPROBES)	+= kernel-trace.o mm-trace.o fs-trace.o \
-				ipc-trace.o lockdep-trace.o rcu-trace.o
+				ipc-trace.o lockdep-trace.o rcu-trace.o \
+				syscall-trace.o
 
 ifeq ($(CONFIG_NET),y)
 ifdef CONFIG_FTRACE
diff --git a/ltt/probes/syscall-trace.c b/ltt/probes/syscall-trace.c
new file mode 100644
index 0000000..18ce105
--- /dev/null
+++ b/ltt/probes/syscall-trace.c
@@ -0,0 +1,53 @@
+/*
+ * ltt/probes/syscall-trace.c
+ *
+ * System call tracepoint probes.
+ *
+ * (C) Copyright 2009 - Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
+ * Dual LGPL v2.1/GPL v2 license.
+ */
+
+#include <linux/module.h>
+#include <linux/ltt-type-serializer.h>
+#include <trace/syscall.h>
+
+
+/* kernel_syscall_entry specialized tracepoint probe */
+
+void probe_syscall_entry(struct pt_regs *regs, long id);
+
+DEFINE_MARKER_TP(kernel_syscall_entry, syscall_entry,
+	probe_syscall_entry, "ip #p%ld syscall_id #2u%u");
+
+notrace void probe_syscall_entry(struct pt_regs *regs, long id)
+{
+	struct marker *marker;
+	struct serialize_long_short data;
+
+	data.f1 = instruction_pointer(regs);
+	data.f2 = (unsigned short)id;
+
+	marker = &GET_MARKER(kernel_syscall_entry);
+	ltt_specialized_trace(marker->single.probe_private,
+		&data, serialize_sizeof(data), sizeof(long));
+}
+
+/* kernel_syscall_exit specialized tracepoint probe */
+
+void probe_syscall_exit(long ret);
+
+DEFINE_MARKER_TP(kernel_syscall_exit, syscall_exit,
+	probe_syscall_exit, "ret %ld");
+
+notrace void probe_syscall_exit(long ret)
+{
+	struct marker *marker;
+
+	marker = &GET_MARKER(kernel_syscall_exit);
+	ltt_specialized_trace(marker->single.probe_private,
+		&ret, sizeof(ret), sizeof(ret));
+}
+
+MODULE_LICENSE("GPL and additional rights");
+MODULE_AUTHOR("Mathieu Desnoyers");
+MODULE_DESCRIPTION("syscall Tracepoint Probes");
-- 
1.6.5.2

