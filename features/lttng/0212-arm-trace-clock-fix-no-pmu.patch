From 6005fff8813b1058b7a1521cdf4d058a8ee0d183 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Wed, 18 May 2011 18:42:53 -0400
Subject: [PATCH 212/248] arm-trace-clock-fix-no-pmu

ARM trace clock fix no PMU

Causes trace clock start failure when CONFIG_CPU_HAS_PMU=n.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
---
 arch/arm/mach-omap2/trace-clock.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-omap2/trace-clock.c b/arch/arm/mach-omap2/trace-clock.c
index 62d5970..3db1cdb 100644
--- a/arch/arm/mach-omap2/trace-clock.c
+++ b/arch/arm/mach-omap2/trace-clock.c
@@ -13,6 +13,7 @@
 #include <linux/init.h>
 #include <linux/cpu.h>
 #include <linux/cpufreq.h>
+#include <linux/err.h>
 
 #include <plat/clock.h>
 #include <asm/trace-clock.h>
@@ -545,7 +546,7 @@ int get_trace_clock(void)
 	if (trace_clock_refcount)
 		goto end;
 	reserved_pmu = reserve_pmu(ARM_PMU_DEVICE_CPU);
-	if (!reserved_pmu) {
+	if (IS_ERR_OR_NULL(reserved_pmu) && PTR_ERR(reserved_pmu) != -ENODEV) {
 		ret = -EBUSY;
 		goto end;
 	}
@@ -699,7 +700,7 @@ static __init int init_trace_clock(void)
 	u64 rem;
 
 	ret = init_pmu(ARM_PMU_DEVICE_CPU);
-	if (ret)
+	if (ret && ret != -ENODEV)
 		return ret;
 	clock = get_clocksource_32k();
 	/*
-- 
1.7.0.4

