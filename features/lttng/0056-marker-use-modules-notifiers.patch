From 13abe7bb0cbf2ce45e157d30848eddf7b9201ff7 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
Date: Thu, 30 Oct 2008 23:26:53 -0400
Subject: [PATCH] marker-use-modules-notifiers

Marker use module notifier

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 kernel/marker.c |   31 +++++++++++++++++++++++++++++++
 1 files changed, 31 insertions(+), 0 deletions(-)

diff --git a/kernel/marker.c b/kernel/marker.c
index c6d7f5a..6308557 100644
--- a/kernel/marker.c
+++ b/kernel/marker.c
@@ -25,6 +25,8 @@
 #include <linux/err.h>
 #include <linux/slab.h>
 
+#define MARKER_NOTIFY_PRIO 1
+
 extern struct marker __start___markers[];
 extern struct marker __stop___markers[];
 
@@ -847,3 +849,32 @@ void *marker_get_private_data(const char *name, marker_probe_func *probe,
 	return ERR_PTR(-ENOENT);
 }
 EXPORT_SYMBOL_GPL(marker_get_private_data);
+
+int marker_module_notify(struct notifier_block *self,
+			 unsigned long val, void *data)
+{
+	struct module *mod = data;
+
+	switch (val) {
+	case MODULE_STATE_COMING:
+		marker_update_probe_range(mod->markers,
+			mod->markers + mod->num_markers);
+		break;
+	case MODULE_STATE_GOING:
+		marker_update_probe_range(mod->markers,
+			mod->markers + mod->num_markers);
+		break;
+	}
+	return 0;
+}
+
+struct notifier_block marker_module_nb = {
+	.notifier_call = marker_module_notify,
+	.priority = MARKER_NOTIFY_PRIO,
+};
+
+static int init_markers(void)
+{
+	return register_module_notifier(&marker_module_nb);
+}
+__initcall(init_markers);
-- 
1.5.5.1

