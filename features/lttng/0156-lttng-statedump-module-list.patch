From a87a8a67ecfb3483244abb21fef8f4bdf8968caa Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
Date: Thu, 2 Oct 2008 14:36:38 -0400
Subject: [PATCH] lttng-statedump-module-list

LTTng instrumentation statedump module.c list

List modules for ltt-statedump

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 include/linux/module.h |    5 +++++
 kernel/module.c        |   21 +++++++++++++++++++++
 2 files changed, 26 insertions(+), 0 deletions(-)

diff --git a/include/linux/module.h b/include/linux/module.h
index 7604b4a..ef0291a 100644
--- a/include/linux/module.h
+++ b/include/linux/module.h
@@ -471,6 +471,7 @@ int register_module_notifier(struct notifier_block * nb);
 int unregister_module_notifier(struct notifier_block * nb);
 
 extern void print_modules(void);
+extern void list_modules(void *call_data);
 
 extern void module_update_markers(void);
 extern int module_get_iter_markers(struct marker_iter *iter);
@@ -578,6 +579,10 @@ static inline void print_modules(void)
 {
 }
 
+static inline void list_modules(void *call_data)
+{
+}
+
 static inline void module_update_markers(void)
 {
 }
diff --git a/kernel/module.c b/kernel/module.c
index 539a0e4..40bbb5f 100644
--- a/kernel/module.c
+++ b/kernel/module.c
@@ -2715,6 +2715,27 @@ const struct seq_operations modules_op = {
 	.show	= m_show
 };
 
+void list_modules(void *call_data)
+{
+	/* Enumerate loaded modules */
+	struct list_head	*i;
+	struct module		*mod;
+	unsigned long refcount = 0;
+
+	psread_lock(&module_psrwlock);
+	list_for_each(i, &modules) {
+		mod = list_entry(i, struct module, list);
+#ifdef CONFIG_MODULE_UNLOAD
+		refcount = local_read(&mod->ref[0].count);
+#endif
+		__trace_mark(0, list_module, call_data,
+				"name %s state %d refcount %lu",
+				mod->name, mod->state, refcount);
+	}
+	psread_unlock(&module_psrwlock);
+}
+EXPORT_SYMBOL_GPL(list_modules);
+
 /* Given an address, look for it in the module exception tables. */
 const struct exception_table_entry *search_module_extables(unsigned long addr)
 {
-- 
1.5.5.1

