From 2556bfc455a85324f807e4dc327fca930e8495d5 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:28:11 -0400
Subject: [PATCH 329/390] markers-fix-compaction

markers fix compaction

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 include/linux/ltt-channels.h |    1 +
 include/linux/marker.h       |    1 +
 kernel/marker.c              |   12 ++++++++++--
 ltt/ltt-channels.c           |   14 ++++++++++++++
 4 files changed, 26 insertions(+), 2 deletions(-)

diff --git a/include/linux/ltt-channels.h b/include/linux/ltt-channels.h
index 5cecd4f..f51ba4f 100644
--- a/include/linux/ltt-channels.h
+++ b/include/linux/ltt-channels.h
@@ -57,5 +57,6 @@ void ltt_channels_trace_set_timer(struct ltt_chan *chan,
 
 int _ltt_channels_get_event_id(const char *channel, const char *name);
 int ltt_channels_get_event_id(const char *channel, const char *name);
+void _ltt_channels_reset_event_ids(void);
 
 #endif /* _LTT_CHANNELS_H */
diff --git a/include/linux/marker.h b/include/linux/marker.h
index ef88004..ef2f15f 100644
--- a/include/linux/marker.h
+++ b/include/linux/marker.h
@@ -264,5 +264,6 @@ extern int _is_marker_enabled(const char *channel, const char *name);
 extern int is_marker_enabled(const char *channel, const char *name);
 extern int _is_marker_present(const char *channel, const char *name);
 extern int is_marker_present(const char *channel, const char *name);
+extern void marker_update_probes(void);
 
 #endif
diff --git a/kernel/marker.c b/kernel/marker.c
index 6046f9c..688058f 100644
--- a/kernel/marker.c
+++ b/kernel/marker.c
@@ -37,6 +37,8 @@ static const int marker_debug;
 /*
  * markers_mutex nests inside module_mutex. Markers mutex protects the builtin
  * and module markers and the hash table.
+ * markers_mutex nests inside the trace lock, to ensure event ID consistency
+ * between the hash table and the marker section.
  */
 static DEFINE_MUTEX(markers_mutex);
 
@@ -783,7 +785,7 @@ void marker_update_probe_range(struct marker *begin,
  * Site effect : marker_set_format may delete the marker entry (creating a
  * replacement).
  */
-static void marker_update_probes(void)
+void marker_update_probes(void)
 {
 	/* Core kernel markers */
 	marker_update_probe_range(__start___markers, __stop___markers);
@@ -879,6 +881,7 @@ error_remove_marker:
 	WARN_ON(ret_err);
 end:
 	mutex_unlock(&markers_mutex);
+	marker_update_probes();	/* for compaction on error path */
 	return ret;
 }
 EXPORT_SYMBOL_GPL(marker_probe_register);
@@ -1090,7 +1093,10 @@ EXPORT_SYMBOL_GPL(marker_get_fmt_from_id);
  * markers_compact_event_ids - Compact markers event IDs and reassign channels
  *
  * Called when no channel users are active by the channel infrastructure.
- * Called with lock_markers() and channel mutex held.
+ * Called with trace lock, lock_markers() and channel mutex held.
+ *
+ * marker_update_probes() must be executed after compaction before releasing the
+ * trace lock.
  */
 void markers_compact_event_ids(void)
 {
@@ -1100,6 +1106,8 @@ void markers_compact_event_ids(void)
 	struct hlist_node *node, *next;
 	int ret;
 
+	_ltt_channels_reset_event_ids();
+
 	for (i = 0; i < MARKER_TABLE_SIZE; i++) {
 		head = &marker_table[i];
 		hlist_for_each_entry_safe(entry, node, next, head, hlist) {
diff --git a/ltt/ltt-channels.c b/ltt/ltt-channels.c
index 94e5ec8..81be66a 100644
--- a/ltt/ltt-channels.c
+++ b/ltt/ltt-channels.c
@@ -299,6 +299,7 @@ void ltt_channels_trace_free(struct ltt_chan *channels,
 	kref_put(&index_kref, release_trace_channel);
 	mutex_unlock(&ltt_channel_mutex);
 	unlock_markers();
+	marker_update_probes();
 }
 EXPORT_SYMBOL_GPL(ltt_channels_trace_free);
 
@@ -368,6 +369,19 @@ int ltt_channels_get_event_id(const char *channel, const char *name)
 	return ret;
 }
 
+/**
+ * ltt_channels_reset_event_ids - reset event IDs at compaction
+ *
+ * Called with lock marker and channel mutex held.
+ */
+void _ltt_channels_reset_event_ids(void)
+{
+	struct ltt_channel_setting *iter;
+
+	list_for_each_entry(iter, &ltt_channels, list)
+		iter->free_event_id = 0;
+}
+
 MODULE_LICENSE("GPL and additional rights");
 MODULE_AUTHOR("Mathieu Desnoyers");
 MODULE_DESCRIPTION("Linux Trace Toolkit Next Generation Channel Management");
-- 
1.6.5.2

