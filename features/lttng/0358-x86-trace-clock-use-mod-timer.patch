From 499b128b2950ee9d15a62ce3d203d3ffa1a4cbb0 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:28:27 -0400
Subject: [PATCH 358/391] x86-trace-clock-use-mod-timer

x86 trace clock use del timer sync

It is incorrect to call add_timer_on from the timer handler. This fixes this
issue.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
---
 arch/x86/kernel/trace-clock.c |    6 ++----
 1 files changed, 2 insertions(+), 4 deletions(-)

diff --git a/arch/x86/kernel/trace-clock.c b/arch/x86/kernel/trace-clock.c
index b95e4ed..b6c9d1f 100644
--- a/arch/x86/kernel/trace-clock.c
+++ b/arch/x86/kernel/trace-clock.c
@@ -104,10 +104,8 @@ static void update_timer_ipi(void *info)
 static void update_timer_fct(unsigned long data)
 {
 	(void)trace_clock_async_tsc_read();
-
-	per_cpu(update_timer, smp_processor_id()).expires = jiffies + 1;
-	add_timer_on(&per_cpu(update_timer, smp_processor_id()),
-		     smp_processor_id());
+	mod_timer_pinned(&per_cpu(update_timer, smp_processor_id()),
+			 jiffies + 1);
 }
 
 static void enable_trace_clock(int cpu)
-- 
1.6.5.2

