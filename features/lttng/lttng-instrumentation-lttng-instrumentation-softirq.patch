From d6944c62163ba7cba7414c5ff792299a71fef613 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:26:00 -0400
Subject: [PATCH 086/391] lttng-instrumentation/lttng-instrumentation-softirq

LTTng instrumentation softirq

Compared to Jason's patch, this patch also instruments softirq raise event.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
CC: 'Ingo Molnar' <mingo@elte.hu>
CC: Frederic Weisbecker <fweisbec@gmail.com>
CC: Jason Baron <jbaron@redhat.com>
CC: 'Peter Zijlstra' <peterz@infradead.org>
CC: Thomas Gleixner <tglx@linutronix.de>
CC: Russell King <rmk+lkml@arm.linux.org.uk>
CC: Masami Hiramatsu <mhiramat@redhat.com>
CC: "Frank Ch. Eigler" <fche@redhat.com>
CC: 'Hideo AOKI' <haoki@redhat.com>
CC: Takashi Nishiie <t-nishiie@np.css.fujitsu.com>
CC: 'Steven Rostedt' <rostedt@goodmis.org>
CC: Eduard - Gabriel Munteanu <eduard.munteanu@linux360.ro>
---
 include/trace/irq.h |   12 ++++++++++++
 kernel/softirq.c    |    3 +++
 2 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/include/trace/irq.h b/include/trace/irq.h
index 21881c7..1d89916 100644
--- a/include/trace/irq.h
+++ b/include/trace/irq.h
@@ -27,4 +27,16 @@ DECLARE_TRACE(irq_tasklet_high_exit,
 	TP_PROTO(struct tasklet_struct *t),
 		TP_ARGS(t));
 
+#if 0
+DECLARE_TRACE(irq_softirq_entry,
+	TP_PROTO(struct softirq_action *h, struct softirq_action *softirq_vec),
+		TP_ARGS(h, softirq_vec));
+DECLARE_TRACE(irq_softirq_exit,
+	TP_PROTO(struct softirq_action *h, struct softirq_action *softirq_vec),
+		TP_ARGS(h, softirq_vec));
+#endif
+DECLARE_TRACE(irq_softirq_raise,
+	TP_PROTO(unsigned int nr),
+		TP_ARGS(nr));
+
 #endif
diff --git a/kernel/softirq.c b/kernel/softirq.c
index 0965b2f..1d17845 100644
--- a/kernel/softirq.c
+++ b/kernel/softirq.c
@@ -193,6 +193,8 @@ EXPORT_SYMBOL(local_bh_enable_ip);
  */
 #define MAX_SOFTIRQ_RESTART 10
 
+DEFINE_TRACE(irq_softirq_raise);
+
 asmlinkage void __do_softirq(void)
 {
 	struct softirq_action *h;
@@ -321,6 +323,7 @@ void irq_exit(void)
  */
 inline void raise_softirq_irqoff(unsigned int nr)
 {
+	trace_irq_softirq_raise(nr);
 	__raise_softirq_irqoff(nr);
 
 	/*
-- 
1.6.5.2

