From 1e971b454bc5cd1a7bd414d7b23da5ce08d7d366 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
Date: Thu, 30 Oct 2008 23:26:41 -0400
Subject: [PATCH] get-cycles-powerpc-have-get-cycles

get_cycles() : powerpc64 HAVE_GET_CYCLES

This patch selects HAVE_GET_CYCLES and makes sure get_cycles_barrier() and
get_cycles_rate() are implemented.

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
CC: benh@kernel.crashing.org
CC: paulus@samba.org
CC: David Miller <davem@davemloft.net>
CC: Linus Torvalds <torvalds@linux-foundation.org>
CC: Andrew Morton <akpm@linux-foundation.org>
CC: Ingo Molnar <mingo@redhat.com>
CC: Peter Zijlstra <a.p.zijlstra@chello.nl>
CC: Thomas Gleixner <tglx@linutronix.de>
CC: Steven Rostedt <rostedt@goodmis.org>
CC: linux-arch@vger.kernel.org
---
 arch/powerpc/Kconfig             |    1 +
 arch/powerpc/include/asm/timex.h |   16 ++++++++++++++--
 include/linux/timer.h            |    3 ++-
 3 files changed, 17 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/Kconfig b/arch/powerpc/Kconfig
index 5d1cfc1..124d0a2 100644
--- a/arch/powerpc/Kconfig
+++ b/arch/powerpc/Kconfig
@@ -122,6 +122,7 @@ config PPC
 	select HAVE_DMA_ATTRS if PPC64
 	select USE_GENERIC_SMP_HELPERS if SMP
 	select HAVE_OPROFILE
+	select HAVE_GET_CYCLES if PPC64
 
 config EARLY_PRINTK
 	bool
diff --git a/arch/powerpc/include/asm/timex.h b/arch/powerpc/include/asm/timex.h
index c55e14f..76895c2 100644
--- a/arch/powerpc/include/asm/timex.h
+++ b/arch/powerpc/include/asm/timex.h
@@ -7,11 +7,11 @@
  * PowerPC architecture timex specifications
  */
 
+#define CLOCK_TICK_RATE	1024000 /* Underlying HZ */
+
 #include <asm/cputable.h>
 #include <asm/reg.h>
 
-#define CLOCK_TICK_RATE	1024000 /* Underlying HZ */
-
 typedef unsigned long cycles_t;
 
 static inline cycles_t get_cycles(void)
@@ -46,5 +46,17 @@ static inline cycles_t get_cycles(void)
 #endif
 }
 
+extern unsigned long tb_ticks_per_sec;
+
+static inline cycles_t get_cycles_rate(void)
+{
+	return tb_ticks_per_sec;
+}
+
+static inline void get_cycles_barrier(void)
+{
+	isync();
+}
+
 #endif	/* __KERNEL__ */
 #endif	/* _ASM_POWERPC_TIMEX_H */
diff --git a/include/linux/timer.h b/include/linux/timer.h
index d4ba792..173968e 100644
--- a/include/linux/timer.h
+++ b/include/linux/timer.h
@@ -2,7 +2,6 @@
 #define _LINUX_TIMER_H
 
 #include <linux/list.h>
-#include <linux/ktime.h>
 #include <linux/stddef.h>
 #include <linux/debugobjects.h>
 
@@ -176,6 +175,8 @@ static inline void add_timer(struct timer_list *timer)
 
 #define del_singleshot_timer_sync(t) del_timer_sync(t)
 
+#include <linux/ktime.h>
+
 extern void init_timers(void);
 extern void run_local_timers(void);
 struct hrtimer;
-- 
1.5.5.1

