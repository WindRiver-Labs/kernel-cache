From 63a7eba6ae876d778ee7f28ef7399844dfe2ff21 Mon Sep 17 00:00:00 2001
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Date: Thu, 13 May 2010 19:27:12 -0400
Subject: [PATCH 215/391] ltt-relay-locked-commit-count-false-sharing-fix

ltt relay locked false sharing fix

Signed-off-by: Mathieu Desnoyers <mathieu.desnoyers@polymtl.ca>
---
 ltt/ltt-relay-locked.c |    3 ++-
 ltt/ltt-relay-locked.h |    2 +-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/ltt/ltt-relay-locked.c b/ltt/ltt-relay-locked.c
index 6c23e30..0f83c14 100644
--- a/ltt/ltt-relay-locked.c
+++ b/ltt/ltt-relay-locked.c
@@ -789,7 +789,8 @@ static int ltt_relay_create_buffer(struct ltt_trace_struct *trace,
 		return -ENOMEM;
 
 	ltt_buf->commit_count =
-		kzalloc_node(sizeof(ltt_buf->commit_count) * n_subbufs,
+		kzalloc_node(ALIGN(sizeof(ltt_buf->commit_count) * n_subbufs,
+				   1 << INTERNODE_CACHE_SHIFT),
 			GFP_KERNEL, cpu_to_node(cpu));
 	if (!ltt_buf->commit_count) {
 		kfree(ltt_buf);
diff --git a/ltt/ltt-relay-locked.h b/ltt/ltt-relay-locked.h
index 53c013c..bedfa31 100644
--- a/ltt/ltt-relay-locked.h
+++ b/ltt/ltt-relay-locked.h
@@ -89,7 +89,7 @@ struct ltt_channel_buf_struct {
 	struct timer_list switch_timer;	/* timer for periodical switch */
 	unsigned long switch_timer_interval;	/* in jiffies. 0 unset */
 	struct rchan_buf *rbuf;		/* Pointer to rchan_buf */
-} ____cacheline_aligned;
+} ____cacheline_internodealigned_in_smp;
 
 /*
  * A switch is done during tracing or as a final flush after tracing (so it
-- 
1.6.5.2

