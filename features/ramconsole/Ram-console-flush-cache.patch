From 09e76a8a59de0bbff49f1a83c46754f36752e1d1 Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Tue, 3 Aug 2010 20:21:08 +0800
Subject: [PATCH] Ram console: flush cache

Signed-off-by: Herve Patriarche <herve.patriarche@windriver.com>
Integrated-by: Andrew Liu <shengping.liu@windriver.com>
---
 drivers/misc/ram_console.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/drivers/misc/ram_console.c b/drivers/misc/ram_console.c
index 731339c..f8a3d9c 100644
--- a/drivers/misc/ram_console.c
+++ b/drivers/misc/ram_console.c
@@ -22,6 +22,7 @@
 #include <linux/uaccess.h>
 #include <linux/lmb.h>
 #include <asm/io.h>
+#include <asm/cacheflush.h>
 
 #ifdef CONFIG_RAM_CONSOLE_ERROR_CORRECTION
 #include <linux/rslib.h>
@@ -67,6 +68,7 @@ static void ram_console_encode_rs8(uint8_t *data, size_t len, uint8_t *ecc)
 	encode_rs8(ram_console_rs_decoder, data, len, par, 0);
 	for (i = 0; i < ECC_SIZE; i++)
 		ecc[i] = par[i];
+	flush_dcache_range((long)ecc, (long)ecc + ECC_SIZE);
 }
 
 static int ram_console_decode_rs8(void *data, size_t len, uint8_t *ecc)
@@ -90,6 +92,8 @@ static void ram_console_update(const char *s, unsigned int count)
 	int size = ECC_BLOCK_SIZE;
 #endif
 	memcpy(buffer->data + buffer->start, s, count);
+	flush_dcache_range(((long)buffer->data) + buffer->start,
+		((long)buffer->data) + buffer->start  + count);
 #ifdef CONFIG_RAM_CONSOLE_ERROR_CORRECTION
 	block = buffer->data + (buffer->start & ~(ECC_BLOCK_SIZE - 1));
 	par = ram_console_par_buffer +
@@ -106,13 +110,14 @@ static void ram_console_update(const char *s, unsigned int count)
 
 static void ram_console_update_header(void)
 {
-#ifdef CONFIG_RAM_CONSOLE_ERROR_CORRECTION
 	struct ram_console_buffer *buffer = ram_console_buffer;
+#ifdef CONFIG_RAM_CONSOLE_ERROR_CORRECTION
 	uint8_t *par;
 	par = ram_console_par_buffer +
 	      DIV_ROUND_UP(ram_console_buffer_size, ECC_BLOCK_SIZE) * ECC_SIZE;
 	ram_console_encode_rs8((uint8_t *)buffer, sizeof(*buffer), par);
 #endif
+	flush_dcache_range((long)buffer,  ((long)buffer) + sizeof(*buffer));
 }
 
 static void
-- 
1.6.5.2

