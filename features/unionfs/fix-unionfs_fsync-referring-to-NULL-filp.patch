From dc41c2a0ca5da6eff21483b9a2d7fb70c710e1fd Mon Sep 17 00:00:00 2001
From: Lans Zhang <jia.zhang@windriver.com>
Date: Wed, 9 Jun 2010 09:46:13 +0800
Subject: [PATCH] fix unionfs_fsync() referring to NULL filp

[fs/unionfs] fix unionfs_fsync() referring to NULL filp

unionfs_fsync() should handle NULL filp properly, thereby avoiding causing
kernel crash.

Signed-off-by: Li Wang <Li.Wang@windriver.com>
Signed-off-by: Jia Zhang <jia.zhang@windriver.com>
---
 fs/unionfs/file.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/fs/unionfs/file.c b/fs/unionfs/file.c
index 965d071..ac3d62b 100644
--- a/fs/unionfs/file.c
+++ b/fs/unionfs/file.c
@@ -173,6 +173,9 @@ int unionfs_fsync(struct file *file, struct dentry *dentry, int datasync)
 	struct inode *lower_inode, *inode;
 	int err = -EINVAL;
 
+	if (!file)
+		return 0;
+
 	unionfs_read_lock(dentry->d_sb, UNIONFS_SMUTEX_PARENT);
 	unionfs_lock_dentry(dentry, UNIONFS_DMUTEX_CHILD);
 	err = unionfs_file_revalidate(file, true);
-- 
1.6.0.4

