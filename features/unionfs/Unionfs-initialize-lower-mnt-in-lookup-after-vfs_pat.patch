From 689f8ca25f9b2b6e761e78ae603fdfd940939425 Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Fri, 17 Sep 2010 10:27:25 +0800
Subject: [PATCH] Unionfs: initialize lower mnt in lookup after vfs_path_lookup

[upstream: 12f71ac8e4ad0f9945ae3f2cd7f9d628a3b8e3e2]

Signed-off-by: Erez Zadok <ezk@cs.sunysb.edu>
Integrated-by: Li Wang <li.wang@windriver.com>
---
 fs/unionfs/lookup.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/fs/unionfs/lookup.c b/fs/unionfs/lookup.c
index 0a9602a..080d8fc 100644
--- a/fs/unionfs/lookup.c
+++ b/fs/unionfs/lookup.c
@@ -392,6 +392,9 @@ struct dentry *unionfs_lookup_full(struct dentry *dentry,
 			goto out_free;
 		}
 		unionfs_set_lower_dentry_idx(dentry, bindex, lower_dentry);
+		if (!lower_mnt)
+			lower_mnt = unionfs_mntget(dentry->d_sb->s_root,
+						   bindex);
 		BUG_ON(!lower_mnt);
 		unionfs_set_lower_mnt_idx(dentry, bindex, lower_mnt);
 
-- 
1.7.0.4

