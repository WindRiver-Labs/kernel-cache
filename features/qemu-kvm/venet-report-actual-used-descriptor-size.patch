From 424909234a54ee17fd66a6c664cbe6850755a679 Mon Sep 17 00:00:00 2001
From: Gregory Haskins <ghaskins@novell.com>
Date: Thu, 27 Aug 2009 13:15:50 -0400
Subject: [PATCH 035/119] venet: report actual used descriptor size

This should reduce wasted effort copying parts of the descriptor
which are not in use, since the descriptors are typically pre-allocated

Signed-off-by: Gregory Haskins <ghaskins@novell.com>
---
 drivers/net/vbus-enet.c         |    2 ++
 include/linux/venet.h           |    3 +++
 kernel/vbus/devices/venet-tap.c |    3 ---
 3 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/drivers/net/vbus-enet.c b/drivers/net/vbus-enet.c
index b3e9695..63237f3 100644
--- a/drivers/net/vbus-enet.c
+++ b/drivers/net/vbus-enet.c
@@ -582,6 +582,8 @@ vbus_enet_tx_start(struct sk_buff *skb, struct net_device *dev)
 			iov->ptr = (u64)sg_phys(sg);
 		}
 
+		iter.desc->len = (u64)VSG_DESC_SIZE(vsg->count);
+
 	} else {
 		/*
 		 * non scatter-gather mode: simply put the skb right onto the
diff --git a/include/linux/venet.h b/include/linux/venet.h
index 57aeddd..53b6958 100644
--- a/include/linux/venet.h
+++ b/include/linux/venet.h
@@ -76,6 +76,9 @@ struct venet_sg {
 	struct venet_iov iov[1];
 };
 
+#define VSG_DESC_SIZE(count) (sizeof(struct venet_sg) + \
+			      sizeof(struct venet_iov) * ((count) - 1))
+
 #define VENET_FUNC_LINKUP    0
 #define VENET_FUNC_LINKDOWN  1
 #define VENET_FUNC_MACQUERY  2
diff --git a/kernel/vbus/devices/venet-tap.c b/kernel/vbus/devices/venet-tap.c
index b1e90f6..f19ab40 100644
--- a/kernel/vbus/devices/venet-tap.c
+++ b/kernel/vbus/devices/venet-tap.c
@@ -84,9 +84,6 @@ enum {
 	TX_IOQ_CONGESTED,
 };
 
-#define VSG_DESC_SIZE(count) (sizeof(struct venet_sg) + \
-			      sizeof(struct venet_iov) * ((count) - 1))
-
 #define MAX_VSG_DESC_SIZE VSG_DESC_SIZE(MAX_SKB_FRAGS)
 
 struct venettap;
-- 
1.6.5.2

