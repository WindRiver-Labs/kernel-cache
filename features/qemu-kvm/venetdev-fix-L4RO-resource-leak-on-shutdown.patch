From bcc6b4aefaec563f81e4cc81bf804100a95f71cf Mon Sep 17 00:00:00 2001
From: Gregory Haskins <ghaskins@novell.com>
Date: Tue, 13 Oct 2009 19:34:00 -0400
Subject: [PATCH 067/119] venetdev: fix L4RO resource leak on shutdown

We currently fail to properly cleanup L4RO resources, which results
in -EEXIST errors on subsequent attempts to negotiate L4RO features.
Lets fix this.

Signed-off-by: Gregory Haskins <ghaskins@novell.com>
---
 kernel/vbus/devices/venet/device.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/kernel/vbus/devices/venet/device.c b/kernel/vbus/devices/venet/device.c
index 67cb06f..13c1611 100644
--- a/kernel/vbus/devices/venet/device.c
+++ b/kernel/vbus/devices/venet/device.c
@@ -2182,6 +2182,14 @@ venetdev_vlink_release(struct vbus_connection *conn)
 	priv->vbus.evq.enabled = false;
 	priv->vbus.evq.linkstate = false;
 	priv->vbus.evq.txc = false;
+
+	if (priv->vbus.l4ro.shm)
+		vbus_shm_put(priv->vbus.l4ro.shm);
+	if (priv->vbus.l4ro.pageq.queue)
+		venetdev_queue_release(&priv->vbus.l4ro.pageq);
+	priv->vbus.l4ro.shm = NULL;
+	priv->vbus.l4ro.available = false;
+	priv->vbus.l4ro.enabled = false;
 }
 
 /*
-- 
1.6.5.2

