From 1e596486b07a5f95a8a631810d879050ff130ef2 Mon Sep 17 00:00:00 2001
From: Gregory Haskins <ghaskins@novell.com>
Date: Fri, 2 Oct 2009 14:47:59 -0400
Subject: [PATCH 114/119] KVM: Remove memslot->refs feature

It turns out that we really do not need to track the slot references
because the guest is obviously using the memory if we are seeing
GPAs point to it.

Signed-off-by: Gregory Haskins <ghaskins@novell.com>
Integrated-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 virt/kvm/xinterface.c |   18 +-----------------
 1 files changed, 1 insertions(+), 17 deletions(-)

diff --git a/virt/kvm/xinterface.c b/virt/kvm/xinterface.c
index fa520ae..6312d01 100644
--- a/virt/kvm/xinterface.c
+++ b/virt/kvm/xinterface.c
@@ -79,16 +79,13 @@ gpa_to_hva(struct _xinterface *_intf, unsigned long gpa)
 	    || gfn < memslot->base_gfn
 	    || gfn >= memslot->base_gfn + memslot->npages) {
 
-		if (memslot) {
-			atomic_dec(&memslot->refs);
+		if (memslot)
 			_intf->slotcache[cpu] = NULL;
-		}
 
 		memslot = gfn_to_memslot(_intf->kvm, gfn);
 		if (!memslot)
 			goto out;
 
-		atomic_inc(&memslot->refs);
 		_intf->slotcache[cpu] = memslot;
 	}
 
@@ -157,7 +154,6 @@ xvmap_release(struct kvm_xvmap *vmap)
 	struct _xinterface *_intf = to_intf(_xvmap->vmap.intf);
 
 	_vunmap(_intf, _xvmap->vmap.addr, _xvmap->npages);
-	atomic_dec(&_xvmap->memslot->refs);
 	kfree(_xvmap);
 }
 
@@ -355,8 +351,6 @@ xinterface_vmap(struct kvm_xinterface *intf,
 		goto fail;
 	}
 
-	atomic_inc(&memslot->refs);
-
 	_xvmap->memslot = memslot;
 	_xvmap->npages  = npages;
 
@@ -547,16 +541,6 @@ static void
 xinterface_release(struct kvm_xinterface *intf)
 {
 	struct _xinterface *_intf = to_intf(intf);
-	int i;
-
-	for_each_possible_cpu(i) {
-		struct kvm_memory_slot *memslot = _intf->slotcache[i];
-
-		if (memslot) {
-			atomic_dec(&memslot->refs);
-			_intf->slotcache[i] = NULL;
-		}
-	}
 
 	mmput(_intf->mm);
 	put_task_struct(_intf->task);
-- 
1.6.5.2

