From 6b91d4e58e912f8c151bbe4109c535534d8c9ad7 Mon Sep 17 00:00:00 2001
From: Gregory Haskins <ghaskins@novell.com>
Date: Mon, 2 Nov 2009 16:31:18 -0500
Subject: [PATCH 077/119] vbus: properly deregister the bus on shutdown

We currently leave the bus in the system-wide map, which is broken.  Lets fix
this so we properly cleanup and avoid a crash on subsequent registration.

Signed-off-by: Gregory Haskins <ghaskins@novell.com>
---
 kernel/vbus/core.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/kernel/vbus/core.c b/kernel/vbus/core.c
index 606f179..4041669 100644
--- a/kernel/vbus/core.c
+++ b/kernel/vbus/core.c
@@ -495,6 +495,10 @@ static void _vbus_release(struct kref *kref)
 {
 	struct vbus *vbus = container_of(kref, struct vbus, kref);
 
+	mutex_lock(&vbus_root.lock);
+	map_del(&vbus_root.buses.map, &vbus->node);
+	mutex_unlock(&vbus_root.lock);
+
 	kobject_put(&vbus->devices.kobj);
 	kobject_put(&vbus->members.kobj);
 	kobject_put(&vbus->kobj);
-- 
1.6.5.2

