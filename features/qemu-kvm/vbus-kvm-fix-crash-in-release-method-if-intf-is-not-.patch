From 08a860859701523253d8a22a32e231c14804a0ef Mon Sep 17 00:00:00 2001
From: Gregory Haskins <ghaskins@novell.com>
Date: Thu, 7 Jan 2010 13:07:14 -0500
Subject: [PATCH 107/119] vbus-kvm: fix crash in release() method if intf is not fully initialized

A kernel oops is caused by opening /dev/vbus-kvm and closing it before
it has been fully initializated with additional ioctl() calls.  This
patch ensures we do not try to free resources that have never been
initialized to begin with.

Signed-off-by: Gregory Haskins <ghaskins@novell.com>
---
 kernel/vbus/connectors/kvm.c |   10 ++++++++--
 1 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/kernel/vbus/connectors/kvm.c b/kernel/vbus/connectors/kvm.c
index 02111e1..b3de3ef 100644
--- a/kernel/vbus/connectors/kvm.c
+++ b/kernel/vbus/connectors/kvm.c
@@ -1395,10 +1395,16 @@ vbus_kvm_chardev_release(struct inode *inode, struct file *filp)
 		kvm_xioevent_deassign(vkvm->fastcalls.ioevent);
 	if (vkvm->shmsignals)
 		kvm_xioevent_deassign(vkvm->shmsignals);
-	mmput(vkvm->mm);
+
+	if (vkvm->state == _state_ready)
+		vbus_notifier_unregister(vkvm->vbus, &vkvm->vbusnotify);
+
+	if (vkvm->mm)
+		mmput(vkvm->mm);
+
 	vbus_memctx_put(vkvm->ctx);
 	vbus_client_put(vkvm->client);
-	vbus_notifier_unregister(vkvm->vbus, &vkvm->vbusnotify);
+
 	vbus_put(vkvm->vbus);
 
 	vbus_kvm_put(vkvm);
-- 
1.6.5.2

