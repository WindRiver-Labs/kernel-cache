From d7fa08be2dab2b3ff0e54b92d8bb6dae0cdab224 Mon Sep 17 00:00:00 2001
From: Pengyu Ma <pengyu.ma@windriver.com>
Date: Wed, 8 Jan 2014 14:36:49 +0800
Subject: [PATCH 168/175] ehci-ci13612: ehci_init should init data structure first to avoid trace

ehci_init should be called first to do spin_lock_init, then ehci_halt can
call spin_lock_irq.
Or it will cause call-trace when CONFIG_DEBUG_SPINLOCK=y.

Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 drivers/usb/host/ehci-ci13612.c |    9 +++++----
 1 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/drivers/usb/host/ehci-ci13612.c b/drivers/usb/host/ehci-ci13612.c
index b39dc0e..fa5547d 100644
--- a/drivers/usb/host/ehci-ci13612.c
+++ b/drivers/usb/host/ehci-ci13612.c
@@ -101,16 +101,17 @@ static int ci13612_ehci_init(struct usb_hcd *hcd)
 
 	ehci->sbrn = 0x20;
 
+	/* data structure init */
+	retval = ehci_init(hcd);
+	if (retval)
+		return retval;
+
 	/* Reset is only allowed on a stopped controller */
 	ehci_halt(ehci);
 
 	/* reset controller */
 	ehci_reset(ehci);
 
-	/* data structure init */
-	retval = ehci_init(hcd);
-	if (retval)
-		return retval;
 	hcd->self.sg_tablesize = 0;
 
 	retval = ehci_ci13612_reinit(ehci);
-- 
1.7.1

