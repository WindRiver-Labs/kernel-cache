From ba5b30ef37cbb03ecc4153f8a3bf994d50085cd0 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Fri, 3 May 2013 10:33:55 +0800
Subject: [PATCH 48/82] ppc/47x: add cputable entries for ACP 34xx

commit ba5b30ef37cbb03ecc4153f8a3bf994d50085cd0 from
git://git.yoctoproject.org/linux-yocto-3.14

This is based on the cputable.c from LSI. Currently only ACP 3448 SoC
has been tested, but all the ACP 34xx SoC are using a 476 core
and just have minor differences. They also use the same reference
board. Adding these cpu entries in cputable should enable
booting on all these 34xx family of SoCs.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/include/asm/reg.h | 1 +
 arch/powerpc/kernel/head_44x.S | 3 +++
 2 files changed, 4 insertions(+)

diff --git a/arch/powerpc/include/asm/reg.h b/arch/powerpc/include/asm/reg.h
index ce17815..be804e9 100644
--- a/arch/powerpc/include/asm/reg.h
+++ b/arch/powerpc/include/asm/reg.h
@@ -1079,6 +1079,7 @@
 #define PVR_405GP	0x40110000
 #define PVR_476		0x11a52000
 #define PVR_476FPE	0x7ff50000
+#define PVR_476X2	0x11b22080
 #define PVR_STB03XXX	0x40310000
 #define PVR_NP405H	0x41410000
 #define PVR_NP405L	0x41610000
diff --git a/arch/powerpc/kernel/head_44x.S b/arch/powerpc/kernel/head_44x.S
index ad6e179..e2165cd 100644
--- a/arch/powerpc/kernel/head_44x.S
+++ b/arch/powerpc/kernel/head_44x.S
@@ -813,6 +813,9 @@ _GLOBAL(init_cpu_state)
 	/* We use the PVR to differenciate 44x cores from 476 */
 	mfspr	r3,SPRN_PVR
 	srwi	r3,r3,16
+	/* Some X2 chips had a PVR that doesn't conform to the standard */
+	cmplwi	cr0,r3,PVR_476X2@h
+	beq	head_start_47x
 	cmplwi	cr0,r3,PVR_476FPE@h
 	beq	head_start_47x
 	cmplwi	cr0,r3,PVR_476@h
-- 
1.9.1

