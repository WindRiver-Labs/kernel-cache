From f5435a2ff3503b03eb9ca4b6f8d6bd0b1a5eb551 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 8 May 2012 09:16:09 +0800
Subject: [PATCH 58/82] powerpc/acpx1: add early debug support for acpx1 board

commit f5435a2ff3503b03eb9ca4b6f8d6bd0b1a5eb551 from
git://git.yoctoproject.org/linux-yocto-3.14

This is based on the lsi.patch in lsi_acp_linux_3.8.1.28 tarball.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/udbg_16550.c | 52 ++++++++++++++++++++++++++++++++++++++++
 1 file changed, 52 insertions(+)

diff --git a/arch/powerpc/kernel/udbg_16550.c b/arch/powerpc/kernel/udbg_16550.c
index f7089fc..7552bb6 100644
--- a/arch/powerpc/kernel/udbg_16550.c
+++ b/arch/powerpc/kernel/udbg_16550.c
@@ -256,6 +256,57 @@ void __init udbg_init_pas_realmode(void)
 #endif /* CONFIG_PPC_PASEMI */
 
 #ifdef CONFIG_PPC_EARLY_DEBUG_44x
+#if defined(CONFIG_ACP)
+
+#include <asm/io.h>
+#include <asm/udbg.h>
+#include <linux/amba/serial.h>
+
+static void *uart_base;
+
+static void
+acp_putc(char c)
+{
+	while (0 != (in_le32(uart_base + UART01x_FR) & UART01x_FR_TXFF))
+		;
+
+	if ('\n' == c) {
+		out_le32(uart_base + UART01x_DR, '\r');
+		while (0 != (in_le32(uart_base + UART01x_FR) & UART01x_FR_TXFF))
+			;
+	}
+
+	out_le32(uart_base + UART01x_DR, c);
+
+	return;
+}
+
+static int
+acp_getc(void)
+{
+	while (0 != (in_le32(uart_base + UART01x_FR) & UART01x_FR_RXFE))
+		;
+	return in_le32(uart_base + UART01x_DR);
+}
+
+void __init
+udbg_init_44x_as1(void)
+{
+	uart_base = (void *)0xf0004000;	/* 34xx UART0 address... */
+
+	if (0x11 != in_le32(uart_base + 0xfe0) ||
+	    0x10 != in_le32(uart_base + 0xfe4) ||
+	    0x24 != in_le32(uart_base + 0xfe8) ||
+	    0x00 != in_le32(uart_base + 0xfec))
+		uart_base = (void *)0xf0024000;	/* 25xx UART0 address... */
+	udbg_putc = acp_putc;
+	udbg_getc = acp_getc;
+
+	return;
+}
+
+#else	/* CONFIG_ACP */
+
 
 #include <platforms/44x/44x.h>
 
@@ -276,6 +327,7 @@ void __init udbg_init_44x_as1(void)
 	udbg_use_uart();
 }
 
+#endif /* CONFIG_ACP */
 #endif /* CONFIG_PPC_EARLY_DEBUG_44x */
 
 #ifdef CONFIG_PPC_EARLY_DEBUG_40x
-- 
1.9.1

