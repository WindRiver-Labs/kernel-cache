From 840d237414604dc7d7590ed7ff0d1bc1fb217b4e Mon Sep 17 00:00:00 2001
From: yhe <yongli.he@windriver.com>
Date: Tue, 5 Mar 2013 14:53:44 +0800
Subject: [PATCH 57/82] kexec/44x: avoid cpu spin code flushed by new kernel

commit 840d237414604dc7d7590ed7ff0d1bc1fb217b4e from
git://git.yoctoproject.org/linux-yocto-3.14

kexec secondary kernel run at same address with old one.
let cpu spin in data segment to avoid it's flushed while
copy the new kernel.

Signed-off-by: Yongli He <yongli.he@windriver.com>
---
 arch/powerpc/kernel/head_44x.S | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/arch/powerpc/kernel/head_44x.S b/arch/powerpc/kernel/head_44x.S
index bc6a832..0dbec3c 100644
--- a/arch/powerpc/kernel/head_44x.S
+++ b/arch/powerpc/kernel/head_44x.S
@@ -1288,6 +1288,13 @@ swapper_pg_dir:
 	.space	PGD_TABLE_SIZE
 
 /*
+ * KEXEC secondary kernel will run at same address as old one
+ * spin in data segment avoid it's flushed by new kernel
+ */
+_GLOBAL(kexec_smp_wait)
+	b .
+
+/*
  * Room for two PTE pointers, usually the kernel and current user pointers
  * to their respective root page table.
  */
-- 
1.9.1

