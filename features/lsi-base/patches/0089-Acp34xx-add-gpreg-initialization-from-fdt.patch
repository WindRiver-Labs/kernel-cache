From 74930fc76f33b653f921310e7ca981618e09a3fe Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Tue, 4 Aug 2015 05:53:48 +0000
Subject: [PATCH] Acp34xx: add gpreg initialization from fdt

In acp34xx platform, the register gpreg address is picked from
"lsi,gpreg" field from dts file. Or the register gpreg address
will be set to zero and the system will corrupt.

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/dma/lsi-dma32.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/drivers/dma/lsi-dma32.c b/drivers/dma/lsi-dma32.c
index 924d3af..5d18632 100644
--- a/drivers/dma/lsi-dma32.c
+++ b/drivers/dma/lsi-dma32.c
@@ -811,6 +811,19 @@ static int gpdma_of_probe(struct platform_device *op)
 		}
 	}
 
+#ifdef CONFIG_ACP
+	if (!(engine->chip->flags & LSIDMA_SEG_REGS)) {
+		struct device_node *gp_node;
+		gp_node = of_find_compatible_node(NULL, NULL, "lsi,gpreg");
+		if (!gp_node) {
+			dev_err(engine->dev, "FDT is missing node 'gpreg'\n");
+			rc = -EINVAL;
+			return rc;
+		}
+		engine->gpreg = of_iomap(gp_node, 0);
+	}
+#endif
+
 	/* General registes at device specific offset */
 	engine->gbase = engine->iobase + engine->chip->genregs_offset;
 
-- 
1.9.1

