From 4247606b5baa7eb9b52d3d48f7d81da0f6e9e4f7 Mon Sep 17 00:00:00 2001
From: Charlie Paul <cpaul.windriver@gmail.com>
Date: Mon, 6 Jul 2015 09:54:28 -0700
Subject: [PATCH 75/82] drivers/mtd: added acp34xx support for mtd

commit 4247606b5baa7eb9b52d3d48f7d81da0f6e9e4f7 from
git://git.yoctoproject.org/linux-yocto-3.14

Signed-off-by: Charlie Paul <cpaul.windriver@gmail.com>
---
 drivers/mtd/nand/lsi_acp_nand.c | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

diff --git a/drivers/mtd/nand/lsi_acp_nand.c b/drivers/mtd/nand/lsi_acp_nand.c
index 4f67bcb..adce248 100644
--- a/drivers/mtd/nand/lsi_acp_nand.c
+++ b/drivers/mtd/nand/lsi_acp_nand.c
@@ -30,6 +30,7 @@
 #include <linux/mtd/nand.h>
 #include <linux/mtd/partitions.h>
 #include <linux/of.h>
+#include <linux/of_address.h>
 #include <linux/io.h>
 #include <linux/delay.h>
 #include <asm/cacheflush.h>
@@ -596,7 +597,6 @@ lsi_nand_command(struct mtd_info *mtd, unsigned int command,
 	register struct nand_chip *chip = mtd->priv;
 	unsigned int status = 0;
 	struct lsi_nand_private *priv = &lsi_nand_private;
-	struct device_node *np = NULL;
 
 	DEBUG_PRINT("command=0x%x\n", command);
 	command &= 0xff;
@@ -799,7 +799,6 @@ static int lsi_nand_wait(struct mtd_info *mtd, struct nand_chip *chip)
 {
 	unsigned long status = 0;
 	loff_t offset = 0;
-	struct device_node *np = NULL;
 
 	/*
 	  When reading or writing, wait for the
@@ -3376,9 +3375,15 @@ static int
 lsi_nand_init_size(struct mtd_info *mtd, struct nand_chip *chip, u8 *id_data)
 {
 	int busw, extid;
+	int bits;
+	u8 cellinfo;
 
 	/* The 3rd id byte holds MLC / multichip data */
-	chip->cellinfo = readb(chip->IO_ADDR_R + NAND_ID4_REG);
+	cellinfo = readb(chip->IO_ADDR_R + NAND_ID4_REG);
+	bits = cellinfo & NAND_CI_CELLTYPE_MSK;
+	bits >>= NAND_CI_CELLTYPE_SHIFT;
+	chip->bits_per_cell = bits + 1;
+
 	/* The 4th id byte is the important one */
 	extid = readb(chip->IO_ADDR_R + NAND_ID6_REG);
 
-- 
1.9.1

