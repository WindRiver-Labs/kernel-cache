From 93a1c16b1ab5c671e9aafc1026b2f9737051ac54 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Mon, 23 Jun 2014 18:59:50 +0800
Subject: [PATCH 3/3] kexec: Increase the delay to wait other cpu to shutdown

machine_crash_shutdown waits for all cpus to shutdown. This process
involves cache flushes, register save, cpu disable, etc. As the number
of cpus increase, so does the time to complete shutdown.

CPU 11 will stop doing anything useful since another CPU has crashed
CPU 10 will stop doing anything useful since another CPU has crashed
CPU 4 will stop doing anything useful since another CPU has crashed
CPU 6 will stop doing anything useful since another CPU has crashed
CPU 7 will stop doing anything useful since another CPU has crashed
CPU 13 will stop doing anything useful since another CPU has crashed
CPU 12 will stop doing anything useful since another CPU has crashed
CPU 14 will stop doing anything useful since another CPU has crashed
CPU 8 will stop doing anything useful since another CPU has crashed
CPU 5 will stop doing anything useful since another CPU has crashed
CPU 2 will stop doing anything useful since another CPU has crashed
CPU 9 will stop doing anything useful since another CPU has crashed
CPU 1 will stop doing anything useful since another CPU has crashed
CPU 15 will stop doing anything useful since another CPU has crashed
CPU 3 will stop doing anything useful since another CPU has crashed
Non-crashing CPUs did not react to IPI
Loading crashdump kernel...
kexec: error: multiple CPUs still online
---[ end trace 528526e8afd65c2c ]---
Kernel panic - not syncing: Fatal exception
Loading crashdump kernel...
Bye

Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 arch/arm/kernel/machine_kexec.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/arch/arm/kernel/machine_kexec.c b/arch/arm/kernel/machine_kexec.c
index 163b160..aa92943 100644
--- a/arch/arm/kernel/machine_kexec.c
+++ b/arch/arm/kernel/machine_kexec.c
@@ -27,6 +27,9 @@ extern unsigned long kexec_boot_atags;
 
 static atomic_t waiting_for_crash_ipi;
 
+/* Wait at most two second for the other cpus to stop */
+#define KDUMP_TIMEOUT_WAIT 2000;
+
 /*
  * Provide a dummy crash_notes definition while crash dump arrives to arm.
  * This prevents breakage of crash_notes attribute in kernel/ksysfs.c.
@@ -110,7 +113,7 @@ void machine_crash_shutdown(struct pt_regs *regs)
 
 	atomic_set(&waiting_for_crash_ipi, num_online_cpus() - 1);
 	smp_call_function(machine_crash_nonpanic_core, NULL, false);
-	msecs = 1000; /* Wait at most a second for the other cpus to stop */
+	msecs = KDUMP_TIMEOUT_WAIT;
 	while ((atomic_read(&waiting_for_crash_ipi) > 0) && msecs) {
 		mdelay(1);
 		msecs--;
-- 
1.7.5.4

