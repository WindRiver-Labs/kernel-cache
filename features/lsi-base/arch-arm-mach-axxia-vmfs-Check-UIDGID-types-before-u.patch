From 20350f49c3d07be6c89741556e0b3b7bdd2709fb Mon Sep 17 00:00:00 2001
From: John Jacques <john.jacques@lsi.com>
Date: Mon, 27 Jan 2014 18:05:03 -0600
Subject: [PATCH] arch/arm/mach-axxia: vmfs: Check UIDGID types before using

https://github.com/lsigithub/lsi_axxia_yocto_3.10.git
commit 6876e9e8946ee1c1f05cf65476f57d2a40c25d14 standard/lsi/base

Updated to work when CONFIG_UIDGID_STRICT_TYPE_CHECKS is
not defined.

Signed-off-by: John Jacques <john.jacques@lsi.com>
Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 fs/vmfs/inode.c   |    4 ++--
 fs/vmfs/ioctl.c   |    4 ++--
 fs/vmfs/vmfs_fs.h |   14 ++++++++++++++
 3 files changed, 18 insertions(+), 4 deletions(-)

diff --git a/fs/vmfs/inode.c b/fs/vmfs/inode.c
index 713da0d..c9f81a2 100644
--- a/fs/vmfs/inode.c
+++ b/fs/vmfs/inode.c
@@ -486,10 +486,10 @@ int vmfs_notify_change(struct dentry *dentry, struct iattr *attr)
 		goto out;
 
 	error = -EPERM;
-	if ((attr->ia_valid & ATTR_UID) && ((attr->ia_uid).val != (server->mnt->uid).val))
+	if ((attr->ia_valid & ATTR_UID) && (GET_IA_UID_VAL(attr) != GET_UID_VAL(server)))
 		goto out;
 
-	if ((attr->ia_valid & ATTR_GID) && ((attr->ia_gid).val != (server->mnt->gid).val))
+	if ((attr->ia_valid & ATTR_GID) && (GET_IA_GID_VAL(attr) != GET_GID_VAL(server)))
 		goto out;
 
 	if ((attr->ia_valid & ATTR_MODE) && (attr->ia_mode & ~mask))
diff --git a/fs/vmfs/ioctl.c b/fs/vmfs/ioctl.c
index 988e69c..903bc28 100644
--- a/fs/vmfs/ioctl.c
+++ b/fs/vmfs/ioctl.c
@@ -34,11 +34,11 @@ long vmfs_unlocked_ioctl(struct file *filp, unsigned int cmd,
 		uid16_t uid16;
 		uid_t uid32;
 	case VMFS_IOC_GETMOUNTUID:
-		SET_UID(uid16, (server->mnt->mounted_uid).val);
+		SET_UID(uid16, GET_MNT_UID_VAL(server));
 		result = put_user(uid16, (uid16_t __user *) arg);
 		break;
 	case VMFS_IOC_GETMOUNTUID32:
-		SET_UID(uid32, (server->mnt->mounted_uid).val);
+		SET_UID(uid32, GET_MNT_UID_VAL(server));
 		result = put_user(uid32, (uid_t __user *) arg);
 		break;
 	default:
diff --git a/fs/vmfs/vmfs_fs.h b/fs/vmfs/vmfs_fs.h
index 73c88aa..810f674 100644
--- a/fs/vmfs/vmfs_fs.h
+++ b/fs/vmfs/vmfs_fs.h
@@ -31,6 +31,20 @@
 #include <linux/jiffies.h>
 #include <asm/unaligned.h>
 
+#ifdef CONFIG_UIDGID_STRICT_TYPE_CHECKS
+#define GET_MNT_UID_VAL(server) (server->mnt->mounted_uid).val
+#define GET_UID_VAL(server) (server->mnt->uid).val
+#define GET_GID_VAL(server) (server->mnt->gid).val
+#define GET_IA_UID_VAL(attr) (attr->ia_uid).val
+#define GET_IA_GID_VAL(server) (attr->ia_gid).val
+#else
+#define GET_MNT_UID_VAL(server) server->mnt->mounted_uid
+#define GET_UID_VAL(server) server->mnt->uid
+#define GET_GID_VAL(server) server->mnt->gid
+#define GET_IA_UID_VAL(attr) attr->ia_uid
+#define GET_IA_GID_VAL(attr) attr->ia_gid
+#endif
+
 static inline struct vmfs_sb_info *VMFS_SB(struct super_block *sb)
 {
 	return sb->s_fs_info;
-- 
1.7.5.4

