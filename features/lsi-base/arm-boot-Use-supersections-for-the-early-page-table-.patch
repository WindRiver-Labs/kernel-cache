From 444896d68dea8a14ea6034dbb469cf46dbb26e01 Mon Sep 17 00:00:00 2001
From: John Jacques <john.jacques@lsi.com>
Date: Mon, 1 Apr 2013 17:38:56 -0500
Subject: [PATCH 017/159] arm/boot: Use supersections for the early page table
 in the armv7 case

git.yoctoproject.org/git/linux-yocto-3.10
commit 9aa67bd94c17c9de72467550ca76389e05cdb7e8 standard/axxia/base.

Signed-off-by: Paul Butler <paul.butler@windriver.com>
---
 arch/arm/boot/compressed/head.S |   53 +++++++++++++++++++++++++++++++++++++++
 1 files changed, 53 insertions(+), 0 deletions(-)

diff --git a/arch/arm/boot/compressed/head.S b/arch/arm/boot/compressed/head.S
index f4757ce..315bdfa 100644
--- a/arch/arm/boot/compressed/head.S
+++ b/arch/arm/boot/compressed/head.S
@@ -612,6 +612,58 @@ __armv3_mpu_cache_on:
 #define CB_BITS 0x0c
 #endif
 
+#if defined(CONFIG_ARCH_AXXIA)
+__setup_mmu:
+		sub	r3, r4, #16384		@ Page directory size
+		bic	r3, r3, #0xff		@ Align the pointer
+		bic	r3, r3, #0x3f00
+
+		/*
+		 * Clear the level 1 page table.
+		 */
+
+		mov	r0, #0
+		mov	r1, r3
+		add	r2, r3, #0x4000
+1:		str	r0, [r1], #4
+		cmp	r1, r2
+		blt	1b
+
+		/*
+		 * First 1G is RAM, cacheable and bufferable.
+	         */
+
+		ldr	r0, =0x40c1e
+		mov	r1, r3
+		add	r2, r3, #0x1000
+1:		mov	r9, #0
+2:		str	r0, [r1], #4		@ Each supersection is repeated
+		add	r9, r9, #1		@ 16 times.
+		cmp	r9, #16
+		blt	2b
+		add	r0, r0, #0x1000000	@ 16M
+		cmp	r1, r2
+		blt	1b
+
+		/*
+		 * Third 1G is IO, not cacheable or bufferable.
+		 */
+
+		ldr	r0,=0x10040c52		@ Start at 0x20_1000_0000
+		add	r1, r3, #0x2000
+		add	r2, r3, #0x3000
+1:		mov	r9, #0
+2:		str	r0, [r1], #4		@ Each supersection is repeated
+		add	r9, r9, #1		@ 16 times.
+		cmp	r9, #16
+		blt	2b
+		add	r0, r0, #0x1000000	@ 16M
+		cmp	r1, r2
+		blt	1b
+
+		mov	pc, lr
+ENDPROC(__setup_mmu)
+#else
 __setup_mmu:	sub	r3, r4, #16384		@ Page directory size
 		bic	r3, r3, #0xff		@ Align the pointer
 		bic	r3, r3, #0x3f00
@@ -652,6 +704,7 @@ __setup_mmu:	sub	r3, r4, #16384		@ Page directory size
 		str	r1, [r0]
 		mov	pc, lr
 ENDPROC(__setup_mmu)
+#endif
 
 @ Enable unaligned access on v6, to allow better code generation
 @ for the decompressor C code:
-- 
1.7.5.4

