From eb4c01dcd905636a0ac1f9e4e0242c4cd11bd42a Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Thu, 25 Apr 2013 18:39:58 +0800
Subject: [PATCH 040/175] LSI:NIC: Using default value when ubootenv driver not present

git.yoctoproject.org/git/linux-yocto-3.10
commit 3507cf8c4d3484e019ff8c8985723f7ffb20f816 standard/axxia/base.

Force LSI NIC driver using default value when ubootenv driver not present.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/net/ethernet/lsi/lsi_acp_net.c |   11 ++++++++---
 1 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/lsi/lsi_acp_net.c b/drivers/net/ethernet/lsi/lsi_acp_net.c
index c62db95..f8a5e66 100644
--- a/drivers/net/ethernet/lsi/lsi_acp_net.c
+++ b/drivers/net/ethernet/lsi/lsi_acp_net.c
@@ -2692,7 +2692,7 @@ device_tree_failed:
 		 * and use hard-coded values for device base addresses.
 		 */
 		unsigned char ethaddr_string[20];
-
+#ifdef CONFIG_MTD_NAND_EP501X_UBOOTENV
 		if (0 != ubootenv_get("ethaddr", ethaddr_string)) {
 			pr_err("acp-femac: Could not read ethernet address!\n");
 			return -EBUSY;
@@ -2731,10 +2731,15 @@ device_tree_failed:
 			 (unsigned long)ioremap(0x002000482000ULL, 0x1000);
 			appnic_device->interrupt = 33;
 		}
+#else
+		/* Neither dtb info nor ubootenv driver found. */
+		pr_err("Could not read ethernet address!\n");
+		return -EBUSY;
+#endif
 	}
 
 device_tree_succeeded:
-
+#ifdef CONFIG_MTD_NAND_EP501X_UBOOTENV
 	/* Override phy_address with u-boot environment variable if set. */
 	if (0 == ubootenv_get("phy_address", uboot_env_string)) {
 		/*
@@ -2765,7 +2770,7 @@ device_tree_succeeded:
 			return -EBUSY;
 		appnic_device->ad_value = res;
 	}
-
+#endif
 	/* ad_value should never be 0. Use default if so ... */
 	if (appnic_device->ad_value == 0) {
 		appnic_device->ad_value = (PHY_AUTONEG_ADVERTISE_100FULL |
-- 
1.7.1

