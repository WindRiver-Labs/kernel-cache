From a86dafaeaf6d399ad596c8ac387c950c17fdcf4a Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Wed, 26 Aug 2015 10:05:49 +0800
Subject: [PATCH 52/68] arch/arm/mach-axxia: Enable L3

the patch comes from:
git://git.yoctoproject.org/linux-yocto-3.10
commit 671a028c702dd1ee2a8d7310102f338b4d5536f6 upstream

In some cases, the boot loader will leave the L3 cache in
SFONLY mode.  This is required because the early fixup
code in arch/arm/boot/compressed does not flush L3 cache.
This commit causes Linux to enable the L3 cache in the
arch/arm/mach-axxia startup code.

Signed-off-by: John Jacques <john.jacques@lsi.com>
Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
Signed-off-by: Li Wang <li.wang@windriver.com>
---
 arch/arm/mach-axxia/axxia.c |   14 +++++---------
 1 files changed, 5 insertions(+), 9 deletions(-)

diff --git a/arch/arm/mach-axxia/axxia.c b/arch/arm/mach-axxia/axxia.c
index 08e071f..397d9f4 100644
--- a/arch/arm/mach-axxia/axxia.c
+++ b/arch/arm/mach-axxia/axxia.c
@@ -62,9 +62,6 @@ static const char *axxia_dt_match[] __initconst = {
 };
 
 static void __iomem *base;
-
-#ifdef CONFIG_KEXEC
-
 static void __iomem *dickens;
 
 static void set_l3_pstate(u32 newstate)
@@ -93,14 +90,12 @@ static void set_l3_pstate(u32 newstate)
 static void
 flush_l3(void)
 {
-	/* Shutdown to flush */
-	set_l3_pstate(0);
+	/* Switch to SFONLY to flush */
+	set_l3_pstate(1);
 	/* ...and then back up again */
 	set_l3_pstate(3);
 }
 
-#endif
-
 static struct map_desc axxia_static_mappings[] __initdata = {
 #ifdef CONFIG_DEBUG_LL
 	{
@@ -202,12 +197,13 @@ static struct notifier_block axxia_amba_nb = {
 void __init axxia_dt_init(void)
 {
 	base = ioremap(0x2010000000, 0x40000);
-#ifdef CONFIG_KEXEC
 	if (!of_find_compatible_node(NULL, NULL, "lsi,axm5516-sim")) {
 		dickens = ioremap(0x2000000000, SZ_4M);
+#ifdef CONFIG_KEXEC
 		kexec_reinit = flush_l3;
-	}
 #endif
+		flush_l3();
+	}
 
 	bus_register_notifier(&platform_bus_type, &axxia_platform_nb);
 	bus_register_notifier(&amba_bustype, &axxia_amba_nb);
-- 
1.7.5.4

