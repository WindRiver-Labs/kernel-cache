From 22d1d3bcdeba1c2fd646f26f9c2ccf42991bce03 Mon Sep 17 00:00:00 2001
From: John Jacques <john.jacques@intel.com>
Date: Tue, 1 Dec 2015 14:28:09 +0200
Subject: [PATCH 1/2] drivers/net: Update the LSI FEMAC Driver for Axxia

commit ed0946fdab84a9c59dd238cb684a914eff1c2824 from
http://git.yoctoproject.org/cgit/cgit.cgi/linux-yocto-4.1
branch: standard/axxia/base

The driver was calling free_irq() without first calling
disable_irq() to synchronize pending and active handlers.
This commit adds a call to disable_irq().

Signed-off-by: John Jacques <john.jacques@intel.com>
Signed-off-by: Zhixiong Chi <zhixiong.chi@windriver.com>
---
 drivers/net/ethernet/lsi/lsi_acp_net.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/lsi/lsi_acp_net.c b/drivers/net/ethernet/lsi/lsi_acp_net.c
index 4b7188c..67bd0cf 100644
--- a/drivers/net/ethernet/lsi/lsi_acp_net.c
+++ b/drivers/net/ethernet/lsi/lsi_acp_net.c
@@ -1058,8 +1058,12 @@ static int appnic_stop(struct net_device *dev)
 
 	pr_info("%s: Stopping the interface.\n", LSI_DRV_NAME);
 
-	/* Disable all device interrupts. */
+	/* Disable interrupts. Note that disable_irq() will wait for
+	 * any interrupt handlers that are currently executing to
+	 * complete.
+	 */
 	write_mac(0, APPNIC_DMA_INTERRUPT_ENABLE);
+	disable_irq(dev->irq);
 	free_irq(dev->irq, dev);
 
 	/* Indicate to the OS that no more packets should be sent.  */
-- 
1.7.5.4

