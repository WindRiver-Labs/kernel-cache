From 7001497c38c9a2a1ae45ae183213c9952a800263 Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Tue, 25 Aug 2015 13:57:00 +0800
Subject: [PATCH 07/68] gpio: pl061: specify gpio base via device tree

the patch comes from:
git://git.yoctoproject.org/linux-yocto-3.10
commit cbfbd507fa16b7733bfa32d53093b40b96e6bb32 upstream

Use DT alias to allow the gpio base to be selected. This solves compatibility
with user-space programs that expects a fixed numbering scheme from non-DT
system. If an alias for the device node is not defined in device tree, the
fallback is to use the dynamically allocated number.

Signed-off-by: Anders Berg <anders.berg@avagotech.com>
Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
Signed-off-by: Li Wang <li.wang@windriver.com>
---
 drivers/gpio/gpio-pl061.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/drivers/gpio/gpio-pl061.c b/drivers/gpio/gpio-pl061.c
index 63ff0d0..701a71e 100644
--- a/drivers/gpio/gpio-pl061.c
+++ b/drivers/gpio/gpio-pl061.c
@@ -287,7 +287,11 @@ static int pl061_probe(struct device *dev,
 		chip->gc.base = pdata->gpio_base;
 		irq_base = pdata->irq_base;
 	} else if (dev->of_node) {
-		chip->gc.base = -1;
+		int id = of_alias_get_id(dev->of_node, "gpio");
+		if (id < 0)
+			chip->gc.base = -1;
+		else
+			chip->gc.base = id * PL061_GPIO_NR;
 		irq_base = 0;
 	} else {
 		if (retchip)
-- 
1.7.5.4

