From 4b3269cdc9251476d97ebac8b807270792005a05 Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Tue, 25 Aug 2015 14:57:26 +0800
Subject: [PATCH 20/68] Updated USB driver to not apply USB SW workarounds for
 3500

the patch comes from:
git://git.yoctoproject.org/linux-yocto-3.10
commit e229b3a11e7d2520e64f62d11ebaf04d7dc89bca upstream

Signed-off-by: SangeethaRao <sangeetha.rao@lsi.com>
Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
Signed-off-by: Li Wang <li.wang@windriver.com>
---
 drivers/usb/host/ehci-ci13612.c |   23 +++++++++++++++++++++++
 1 files changed, 23 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/host/ehci-ci13612.c b/drivers/usb/host/ehci-ci13612.c
index 1b1a1ec..a5f48e8 100644
--- a/drivers/usb/host/ehci-ci13612.c
+++ b/drivers/usb/host/ehci-ci13612.c
@@ -42,6 +42,14 @@ static void ci13612_usb_setup(struct usb_hcd *hcd)
 	struct ehci_hcd *ehci = hcd_to_ehci(hcd);
 	u32 txfulltuning = 0;
 
+	if ((of_find_compatible_node(NULL, NULL, "lsi,acp3500")
+		!= NULL)
+		|| (of_find_compatible_node(NULL, NULL, "lsi,axxia35xx")
+		!= NULL)) {
+		writel(3, USB_SBUSCFG);
+		return;
+	}
+
 	/* Fix for HW errata 0002832: Settings of VUSB_HS_TX_BURST and
 	 * TXFILLTUNING.
 	 * TXFIFOTHRES should satisfy
@@ -135,6 +143,13 @@ static int
 ci13612_fixup_usbcmd_rs(struct ehci_hcd *ehci)
 {
 	u32 port_status;
+	/* This workaround is not applicable to 3500 */
+	if ((of_find_compatible_node(NULL, NULL, "lsi,acp3500")
+		!= NULL)
+		|| (of_find_compatible_node(NULL, NULL, "lsi,axxia35xx")
+		!= NULL)) {
+		return 0;
+	}
 
 	port_status = ehci_readl(ehci, &ehci->regs->port_status[0]);
 	pr_info("ehci-ci13612: port_status = 0x%x\n", port_status);
@@ -166,6 +181,14 @@ ci13612_fixup_txpburst(struct ehci_hcd *ehci)
 {
 	unsigned burst_size;
 
+	/* This workaround is not applicable to 3500 */
+	if ((of_find_compatible_node(NULL, NULL, "lsi,acp3500")
+		!= NULL)
+		|| (of_find_compatible_node(NULL, NULL, "lsi,axxia35xx")
+		!= NULL)) {
+		return;
+	}
+
 	burst_size = ehci_readl(ehci, &ehci->regs->reserved1[1]);
 	burst_size = (burst_size & 0xffff00ff) | 0x4000;	/* TXPBURST */
 	ehci_writel(ehci, burst_size, &ehci->regs->reserved1[1]);
-- 
1.7.5.4

