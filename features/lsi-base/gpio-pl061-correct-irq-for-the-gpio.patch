From 7a8e86494b4273f46b57f7838f7e3289831710ab Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Fri, 6 Jun 2014 09:33:45 +0800
Subject: [PATCH] gpio: pl061: correct irq for the gpio

Since the gpio interrupt cascading to the the IRQ core system.
The gpio driver should check the linux interrupt number, instead of
the controller-local interrupt numbers.

Besides, add a checking in pl061_to_irq() to prevent following calltrace:

irq: irq_create_mapping called for NULL domain, hwirq=0
------------[ cut here ]------------
WARNING: at kernel/irq/irqdomain.c:580 irq_create_mapping+0x4c/0x120()
Modules linked in:
CPU: 0 PID: 807 Comm: runtest.sh Not tainted 3.10.38-ltsi-WR6.0.0.0_standard #16
[<c0417360>] (unwind_backtrace+0x0/0xec) from [<c0412464>] (show_stack+0x20/0x24)
[<c0412464>] (show_stack+0x20/0x24) from [<c09ee214>] (dump_stack+0x20/0x28)
[<c09ee214>] (dump_stack+0x20/0x28) from [<c04266f8>] (warn_slowpath_common+0x5c/0x7c)
[<c04266f8>] (warn_slowpath_common+0x5c/0x7c) from [<c04267d4>] (warn_slowpath_null+0x2c/0x34)
[<c04267d4>] (warn_slowpath_null+0x2c/0x34) from [<c04a4480>] (irq_create_mapping+0x4c/0x120)
[<c04a4480>] (irq_create_mapping+0x4c/0x120) from [<c0724f34>] (pl061_to_irq+0x1c/0x20)
[<c0724f34>] (pl061_to_irq+0x1c/0x20) from [<c0721b64>] (gpiod_to_irq+0x3c/0x50)
[<c0721b64>] (gpiod_to_irq+0x3c/0x50) from [<c0722fec>] (gpiod_export+0x12c/0x1dc)
[<c0722fec>] (gpiod_export+0x12c/0x1dc) from [<c07244b8>] (export_store+0x88/0xd0)
[<c07244b8>] (export_store+0x88/0xd0) from [<c0767418>] (class_attr_store+0x28/0x34)
[<c0767418>] (class_attr_store+0x28/0x34) from [<c0582978>] (sysfs_write_file+0x118/0x15c)
[<c0582978>] (sysfs_write_file+0x118/0x15c) from [<c0527908>] (vfs_write+0xe4/0x194)
[<c0527908>] (vfs_write+0xe4/0x194) from [<c0527e1c>] (SyS_write+0x4c/0x7c)
[<c0527e1c>] (SyS_write+0x4c/0x7c) from [<c040df40>] (ret_fast_syscall+0x0/0x48)
---[ end trace 8cad8b37a5d13e8d ]---

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/gpio/gpio-pl061.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/drivers/gpio/gpio-pl061.c b/drivers/gpio/gpio-pl061.c
index 7283209..63ff0d0 100644
--- a/drivers/gpio/gpio-pl061.c
+++ b/drivers/gpio/gpio-pl061.c
@@ -154,6 +154,9 @@ static int pl061_to_irq(struct gpio_chip *gc, unsigned offset)
 {
 	struct pl061_gpio *chip = container_of(gc, struct pl061_gpio, gc);
 
+	if (chip->domain == NULL)
+		return -EINVAL;
+
 	return irq_create_mapping(chip->domain, offset);
 }
 
@@ -334,8 +337,9 @@ static int pl061_probe(struct device *dev,
 	/*
 	 * irq_chip support
 	 */
-	if (irq_base <= 0)
+	if (irq <= 0)
 		return 0;
+
 	writeb(0, chip->base + GPIOIE); /* disable irqs */
 	if (irq < 0) {
 		if (retchip)
-- 
1.7.5.4

