From b6d398341df2472d71940b1d9d55817952066ecc Mon Sep 17 00:00:00 2001
From: David Mercado <david.mercado@windriver.com>
Date: Wed, 20 Nov 2013 15:16:54 -0500
Subject: [PATCH 141/175] LSI ACP34XX: Use per aperture memory offset for PCI

git.yoctoproject.org/git/linux-yocto-3.10
commit b2791a026d851ded767eaa728ab18f4be522669d standard/axxia/base.

The PCI core has been changed to support a per aperture memory
offset in commit 3fd47f063b17692e843128e2abda3e697df42198.  The LSI
PCI initialization is modified to use the per aperture memory offset.

Signed-off-by: Hong H. Pham <hong.pham@windriver.com>
---
 arch/powerpc/sysdev/lsi_pci.c |   13 +++++++------
 1 files changed, 7 insertions(+), 6 deletions(-)

diff --git a/arch/powerpc/sysdev/lsi_pci.c b/arch/powerpc/sysdev/lsi_pci.c
index a25d396..ada78ad 100644
--- a/arch/powerpc/sysdev/lsi_pci.c
+++ b/arch/powerpc/sysdev/lsi_pci.c
@@ -665,6 +665,7 @@ static void __init acp_configure_pciex_POMs(struct pciex_port *port,
 	/* Setup outbound memory windows */
 	for (i = j = 0; i < 3; i++) {
 		struct resource *res = &hose->mem_resources[i];
+		resource_size_t offset = hose->mem_offset[i];
 
 		/* we only care about memory windows */
 		if (!(res->flags & IORESOURCE_MEM))
@@ -677,17 +678,17 @@ static void __init acp_configure_pciex_POMs(struct pciex_port *port,
 
 		/* Configure the resource */
 		if (acp_setup_one_pciex_POM(port, hose, mbase,
-					res->start,
-				       res->start - hose->pci_mem_offset,
-				       resource_size(res),
-				       res->flags,
-				       j) == 0) {
+					    res->start,
+					    res->start - offset,
+					    resource_size(res),
+					    res->flags,
+					    j) == 0) {
 			j++;
 
 			/* If the resource PCI address is 0 then we have our
 			 * ISA memory hole
 			 */
-			if (res->start == hose->pci_mem_offset)
+			if (res->start == offset)
 				found_isa_hole = 1;
 		}
 	}
-- 
1.7.1

