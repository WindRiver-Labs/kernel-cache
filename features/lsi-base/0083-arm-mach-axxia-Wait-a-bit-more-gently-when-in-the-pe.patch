From 0db4163469d025975a5b890f01296d369b5bbdee Mon Sep 17 00:00:00 2001
From: John Jacques <john.jacques@lsi.com>
Date: Wed, 4 Sep 2013 15:02:20 -0500
Subject: [PATCH 083/175] arm/mach-axxia: Wait a bit more gently when in the pen.

git.yoctoproject.org/git/linux-yocto-3.10
commit 6f990a1b1a1b09123337462549fb213debb06bed standard/axxia/base.

Signed-off-by: John Jacques <john.jacques@lsi.com>
---
 arch/arm/mach-axxia/headsmp.S |   30 +++++++++++++++++++++++++++++-
 1 files changed, 29 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-axxia/headsmp.S b/arch/arm/mach-axxia/headsmp.S
index 6a36f38..f467cc5 100644
--- a/arch/arm/mach-axxia/headsmp.S
+++ b/arch/arm/mach-axxia/headsmp.S
@@ -28,7 +28,35 @@ ENTRY(axxia_secondary_startup)
 	sub	r4, r4, r5
 	add	r6, r6, r4
 pen:	ldr	r7, [r6]
-	cmp	r7, r0
+	/*
+	 * It seems that just looping over read/compare kills starves
+	 * ethernet, this will happen if we start the kernel with
+	 * maxcpus=X where X < 16. Which we really want in order to
+	 * isolate cores.
+	 *
+	 * FIXME: We should really use wfi or wfe here
+	 */
+	mov	r4, #0x7000
+__delay:
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	subs	r4,r4,#1
+	bne	__delay
+ 	cmp	r7, r0
 	bne	pen
 
 	/*
-- 
1.7.1

