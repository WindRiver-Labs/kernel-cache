From fe7a40c83a2cdbdbe35844e8cd46fbb21bebddc5 Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Tue, 25 Aug 2015 13:51:31 +0800
Subject: [PATCH 05/68] arm/axxia: pci: Add missing calls to release_resource
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

the patch comes from:
git://git.yoctoproject.org/linux-yocto-3.10
commit a637bf8712a29a2660e2af9e2e9443c33c145e8d upstream

Release io-resource in a couple of failure cases, this used to cause oopses
when cat:nig /proc/ioports

Signed-off-by: Fredrik Markstr√∂m <fredrik.markstrom@gmail.com>
Signed-off-by: Anders Berg <anders.berg@avagotech.com>
Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
Signed-off-by: Li Wang <li.wang@windriver.com>
---
 arch/arm/mach-axxia/pci.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-axxia/pci.c b/arch/arm/mach-axxia/pci.c
index 6dd3fae..c33f1e5 100644
--- a/arch/arm/mach-axxia/pci.c
+++ b/arch/arm/mach-axxia/pci.c
@@ -614,6 +614,7 @@ static int axxia_pcie_setup(int portno, struct pci_sys_data *sys)
 	if (err) {
 		pr_err("PCIE%d: Failed to request IRQ#%d (%d)\n",
 		       sys->domain, port->irq[0], err);
+		release_resource(&sys->io_res);
 		goto fail;
 	}
 
@@ -654,6 +655,7 @@ static int axxia_pcie_setup(int portno, struct pci_sys_data *sys)
 		if (link_state != 0xb) {
 			pr_warn("PCIE%d: Link in bad state - giving up!\n",
 				port->index);
+			release_resource(&sys->io_res);
 			goto fail;
 		}
 	}
-- 
1.7.5.4

