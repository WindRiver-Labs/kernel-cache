From bb11da63252ff246b6bc4c7caf2f3221d34af000 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Tue, 17 Dec 2013 09:51:01 +0000
Subject: [PATCH 4/9] ACP34xx:Leave interrupt activate when INTx assertted

On acp34xx, PCIe interrupt is trigged by PCIe I/O event. The ISR of
Acp34xx's PCIe driver reads all message in PCIe FIFO and cleaned
interrupt status.

Since the PCIe interrupt is a level triggered interrupt. PCIe ISR
should not clean interrupt status when there is asserted INTx
line, or system may lost IRQ.

This patch keeps watch on state each INTx line in ISR, if any line
asserted, the ISR didn't clean external IRQ bit of status register.
It will assure system could trigger IRQ when INTx asserted.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/sysdev/lsi_pci.c |    8 ++++++--
 1 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/sysdev/lsi_pci.c b/arch/powerpc/sysdev/lsi_pci.c
index e4b4500..c450738 100644
--- a/arch/powerpc/sysdev/lsi_pci.c
+++ b/arch/powerpc/sysdev/lsi_pci.c
@@ -819,7 +819,7 @@ acp_pcie_isr(int irq, void *arg)
 	u32 msg_fifo_stat;
 	u32 msg_fifo_info;
 	u8  externalPciIntr = 0;
-
+	u8 pciIntrLevel = 0;
 
 	/* read the PEI interrupt status register */
 	intr_status = in_le32(mbase + 0x10c0);
@@ -850,11 +850,13 @@ acp_pcie_isr(int irq, void *arg)
 			case 0x21:  /*    assert_INTb */
 			case 0x22:  /*    assert_INTc */
 			case 0x23:  /*    assert_INTd */
+				pciIntrLevel |= (1 << (msg_type - 0x20));
+				break;
 			case 0x24:  /* de-assert_INTa */
 			case 0x25:  /* de-assert_INTb */
 			case 0x26:  /* de-assert_INTc */
 			case 0x27:  /* de-assert_INTd */
-				/* do nothing */
+				pciIntrLevel &= ~(1 << (msg_type - 0x24));
 				break;
 			default:
 				printk(KERN_INFO
@@ -866,6 +868,8 @@ acp_pcie_isr(int irq, void *arg)
 			/* re-read fifo status */
 			msg_fifo_stat = in_le32(mbase + 0x10b4);
 		}
+		if (pciIntrLevel)
+			intr_status &= ~0x00000010;
 	} else {
 		/*
 		 * Ignore the common interrupts, still need to figure out what
-- 
1.7.5.4

