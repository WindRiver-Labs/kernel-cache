From b1dcd5848feb51a544fe4f331d3645199a4efec4 Mon Sep 17 00:00:00 2001
From: John Jacques <john.jacques@lsi.com>
Date: Mon, 27 Jan 2014 18:05:03 -0600
Subject: [PATCH 24/71] arch/arm/mach-axxia: Updates to the VMFS File System

git://git.yoctoproject.org/linux-yocto-3.10 standard/axxia/base
commit 09842de32ccbf5455ca6571f6fe7f8e5a2b1b785

Updated to work when CONFIG_UIDGID_STRICT_TYPE_CHECKS is
not defined.

Signed-off-by: John Jacques <john.jacques@lsi.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 fs/vmfs/inode.c |   12 ++++++++++++
 fs/vmfs/ioctl.c |    8 ++++++++
 2 files changed, 20 insertions(+), 0 deletions(-)

diff --git a/fs/vmfs/inode.c b/fs/vmfs/inode.c
index c9f81a2..d0f333d 100644
--- a/fs/vmfs/inode.c
+++ b/fs/vmfs/inode.c
@@ -486,11 +486,23 @@ int vmfs_notify_change(struct dentry *dentry, struct iattr *attr)
 		goto out;
 
 	error = -EPERM;
+#ifdef CONFIG_UIDGID_STRICT_TYPE_CHECKS
 	if ((attr->ia_valid & ATTR_UID) && (GET_IA_UID_VAL(attr) != GET_UID_VAL(server)))
 		goto out;
+#else
+	if ((attr->ia_valid & ATTR_UID) &&
+	    (attr->ia_uid != server->mnt->uid))
+		goto out;
+#endif
 
+#ifdef CONFIG_UIDGID_STRICT_TYPE_CHECKS
 	if ((attr->ia_valid & ATTR_GID) && (GET_IA_GID_VAL(attr) != GET_GID_VAL(server)))
 		goto out;
+#else
+	if ((attr->ia_valid & ATTR_GID) &&
+	    (attr->ia_gid != server->mnt->gid))
+		goto out;
+#endif
 
 	if ((attr->ia_valid & ATTR_MODE) && (attr->ia_mode & ~mask))
 		goto out;
diff --git a/fs/vmfs/ioctl.c b/fs/vmfs/ioctl.c
index 903bc28..dd63a9a 100644
--- a/fs/vmfs/ioctl.c
+++ b/fs/vmfs/ioctl.c
@@ -34,11 +34,19 @@ long vmfs_unlocked_ioctl(struct file *filp, unsigned int cmd,
 		uid16_t uid16;
 		uid_t uid32;
 	case VMFS_IOC_GETMOUNTUID:
+#ifdef CONFIG_UIDGID_STRICT_TYPE_CHECKS
 		SET_UID(uid16, GET_MNT_UID_VAL(server));
+#else
+		SET_UID(uid16, server->mnt->mounted_uid);
+#endif
 		result = put_user(uid16, (uid16_t __user *) arg);
 		break;
 	case VMFS_IOC_GETMOUNTUID32:
+#ifdef CONFIG_UIDGID_STRICT_TYPE_CHECKS
 		SET_UID(uid32, GET_MNT_UID_VAL(server));
+#else
+		SET_UID(uid32, server->mnt->mounted_uid);
+#endif
 		result = put_user(uid32, (uid_t __user *) arg);
 		break;
 	default:
-- 
1.7.5.4

