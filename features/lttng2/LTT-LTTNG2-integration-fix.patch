From 485bf55b4e7c6497e0ae5637af3c1b0102bfd098 Mon Sep 17 00:00:00 2001
From: Paul Barrette <paul.barrette@windriver.com>
Date: Wed, 20 Jun 2012 15:12:39 -0400
Subject: [PATCH] LTT & LTTNG2: integration fix

There are 3 fixes for the integration of LTT and LTTNG2:
1. drivers/staging/lttng2/Kconfig fix:
Fix incorrect define for checking if LTT is defined.
(LTT not LTTNG)

2. Cleanup default selections in arch/[x86|powerpc]/Kconfig:
LTT selects by default some defines that are incompatible with LTTNG2:
	HAVE_LTT_DUMP_TABLES
	HAVE_TRACE_CLOCK

3. include/trace/events/timer.h
The top level include/trace/events/timer.h has the same event
definitions as those in lttng2's timer.h.  To complicate matters, the
top level is pulled in first.  Use the top level, comment out the duplcates
in lttng2.

Signed-off-by: Paul Barrette <paul.barrette@windriver.com>
---
 arch/powerpc/Kconfig                               |    2 +-
 arch/x86/Kconfig                                   |    4 ++--
 drivers/staging/lttng2/Kconfig                     |    2 +-
 .../instrumentation/events/lttng-module/timer.h    |    6 ++++++
 4 files changed, 10 insertions(+), 4 deletions(-)

diff --git a/arch/powerpc/Kconfig b/arch/powerpc/Kconfig
index 80c97be..f76b11b 100644
--- a/arch/powerpc/Kconfig
+++ b/arch/powerpc/Kconfig
@@ -117,7 +117,7 @@ config PPC
 	select HAVE_IOREMAP_PROT
 	select HAVE_EFFICIENT_UNALIGNED_ACCESS
 	select HAVE_KPROBES
-	select HAVE_TRACE_CLOCK
+	select HAVE_TRACE_CLOCK if LTT
 	select HAVE_ARCH_KGDB
 	select HAVE_KRETPROBES
 	select HAVE_ARCH_TRACEHOOK
diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig
index e10fa1d..47139df 100644
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@ -30,11 +30,11 @@ config X86
 	select HAVE_MEMBLOCK_NODE_MAP
 	select ARCH_DISCARD_MEMBLOCK
 	select ARCH_WANT_OPTIONAL_GPIOLIB
-	select HAVE_LTT_DUMP_TABLES
+	select HAVE_LTT_DUMP_TABLES  if LTT
 	select ARCH_WANT_FRAME_POINTERS
 	select HAVE_DMA_ATTRS
 	select HAVE_KRETPROBES
-	select HAVE_TRACE_CLOCK
+	select HAVE_TRACE_CLOCK if LTT
 	select HAVE_OPTPROBES
 	select HAVE_FTRACE_MCOUNT_RECORD
 	select HAVE_C_RECORDMCOUNT
diff --git a/drivers/staging/lttng2/Kconfig b/drivers/staging/lttng2/Kconfig
index 4bab8b9..df506fc 100644
--- a/drivers/staging/lttng2/Kconfig
+++ b/drivers/staging/lttng2/Kconfig
@@ -1,6 +1,6 @@
 config LTTNG2
 	tristate "LTTng kernel tracer"
-	depends on TRACEPOINTS && m && !LTTNG
+	depends on TRACEPOINTS && m && !LTT
 	help
 	  The LTTng 2.0 Tracer Toolchain allows integrated kernel and
 	  user-space tracing from a single user interface: the "lttng"
diff --git a/drivers/staging/lttng2/instrumentation/events/lttng-module/timer.h b/drivers/staging/lttng2/instrumentation/events/lttng-module/timer.h
index fa89f66..301c62a 100644
--- a/drivers/staging/lttng2/instrumentation/events/lttng-module/timer.h
+++ b/drivers/staging/lttng2/instrumentation/events/lttng-module/timer.h
@@ -12,6 +12,11 @@
 #include <linux/timer.h>
 #endif /* _TRACE_TIMER_DEF_ */
 
+/* Note: these defines will result in a redefinition error on
+ * compilation since they are the same as those in
+ * include/trace/events/timer.h. _TRACE_EVENTS_TIMER_H is defined
+ * therein.  Key off that.*/
+#ifndef _TRACE_EVENTS_TIMER_H
 DECLARE_EVENT_CLASS(timer_class,
 
 	TP_PROTO(struct timer_list *timer),
@@ -327,6 +332,7 @@ TRACE_EVENT(itimer_expire,
 		  (int) __entry->pid, (unsigned long long)__entry->now)
 )
 
+#endif /* if _TRACE_EVENTS_TIMER_H */
 #endif /*  _TRACE_TIMER_H */
 
 /* This part must be outside protection */
-- 
1.7.9.7

