From 4c9808b2e890699cc0902231100357830f1d4581 Mon Sep 17 00:00:00 2001
From: Jianchuan Wang <jianchuan.wang@windriver.com>
Date: Fri, 26 Sep 2014 14:40:27 +0800
Subject: [PATCH] LTTng2: Using task_lock to protect nsproxy

We merge upstream commit 728dba3a39c66b3d8ac889ddbe38b5b1c264aec3
("namespaces: Use task_lock and not rcu to protect nsproxy")

It removed the function task_nsproxy, and caused that task_nsproxy isn't worked
under the "LINUX_VERSION_CODE < KERNEL_VERSION(3,17,0)" condition.

Signed-off-by: Jianchuan Wang <jianchuan.wang@windriver.com>
---
 drivers/staging/lttng2/lttng-statedump-impl.c | 11 +++--------
 1 file changed, 3 insertions(+), 8 deletions(-)

diff --git a/drivers/staging/lttng2/lttng-statedump-impl.c b/drivers/staging/lttng2/lttng-statedump-impl.c
index e4caa48..6d841c36 100644
--- a/drivers/staging/lttng2/lttng-statedump-impl.c
+++ b/drivers/staging/lttng2/lttng-statedump-impl.c
@@ -398,12 +398,8 @@ void lttng_statedump_process_ns(struct lttng_session *session,
 	 * "namespaces: Use task_lock and not rcu to protect nsproxy"
 	 * for details.
 	 */
-#if (LINUX_VERSION_CODE < KERNEL_VERSION(3,17,0))
-	rcu_read_lock();
-	proxy = task_nsproxy(p);
-#else /* #if (LINUX_VERSION_CODE < KERNEL_VERSION(3,17,0)) */
+	task_lock(p);
 	proxy = p->nsproxy;
-#endif /* #else #if (LINUX_VERSION_CODE < KERNEL_VERSION(3,17,0)) */
 	if (proxy) {
 		pid_ns = lttng_get_proxy_pid_ns(proxy);
 		do {
@@ -415,9 +411,8 @@ void lttng_statedump_process_ns(struct lttng_session *session,
 		trace_lttng_statedump_process_state(session,
 			p, type, mode, submode, status, NULL);
 	}
-#if (LINUX_VERSION_CODE < KERNEL_VERSION(3,17,0))
-	rcu_read_unlock();
-#endif /* #if (LINUX_VERSION_CODE < KERNEL_VERSION(3,17,0)) */
+	task_unlock(p);
+
 }
 
 static
-- 
2.0.2

