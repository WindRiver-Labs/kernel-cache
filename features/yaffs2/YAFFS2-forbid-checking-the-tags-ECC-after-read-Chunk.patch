From 0d8d40784706765b61c98865a5324a131fb6276f Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Mon, 1 Feb 2010 00:21:12 -0800
Subject: [PATCH] YAFFS2: forbid checking the tags' ECC after read Chunks on OMAP L138.

YAFFS2 will write a tag into nand spare area. The tag structure is:

typedef struct {
	yaffs_PackedTags2TagsPart t;
	yaffs_ECCOther ecc;
} yaffs_PackedTags2;

The first member "t" is the actual tags part, it is 16 bytes; the second
member "ecc" is the ECC value for the tags "t", it is 12 bytes. So the
whole structure is 28 bytes.

In L138, the size of a NAND page is 2048 + 64 bytes. The ECC value takes up
40 bytes. and 2 bytes for badblock markers. So there are 64 - 40 - 2 = 22
bytes spare area left. There is not enough for YAFFS2 tag.

When YAFFS2 write the tag into NAND, the tag is stripped to 22 bytes, the
last 6 bytes is cut. When YAFFS2 read the 28 bytes tag from NAND, the last
6 bytes of ECC member  is wrong data. However, after checking if ECC is
wrong,  YAFFS2 has no ERRORs, no WARNINGs, it will mark the block to bad
quietly if it found the wrong ECC data enough times.

Define CONFIG_YAFFS_IGNORE_TAGS_ECC  can forbid YAFFS2 to check the ECC data
after read the tag from NAND. In this case, the YAFFS2 tag is not protected
from NAND flips.

Signed-off-by: Stanley.Miao <stanley.miao@windriver.com>
---
 fs/yaffs2/Kconfig             |    8 ++++++++
 fs/yaffs2/yaffs_packedtags2.c |    4 ++--
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/fs/yaffs2/Kconfig b/fs/yaffs2/Kconfig
index de15163..1d01438 100644
--- a/fs/yaffs2/Kconfig
+++ b/fs/yaffs2/Kconfig
@@ -110,6 +110,14 @@ config YAFFS_DISABLE_LAZY_LOAD
 
 	  If unsure, say N.
 
+config YAFFS_IGNORE_TAGS_ECC
+	bool "Ignore yaffs2 tags ECC"
+	depends on YAFFS_YAFFS2
+	default n
+	help
+	  Yaff2 tags is 28-byte long. If your NAND Flash OOB area can't hold
+	  the whole tag, you can ignore the ecc data to shorten the tag length.
+	  Note, it will make the yaffs2 tags not to be protected by NAND flips.
 
 config YAFFS_DISABLE_WIDE_TNODES
 	bool "Turn off wide tnodes"
diff --git a/fs/yaffs2/yaffs_packedtags2.c b/fs/yaffs2/yaffs_packedtags2.c
index 957ed8b..04a4a1f 100644
--- a/fs/yaffs2/yaffs_packedtags2.c
+++ b/fs/yaffs2/yaffs_packedtags2.c
@@ -102,7 +102,7 @@ void yaffs_PackTags2(yaffs_PackedTags2 * pt, const yaffs_ExtendedTags * t)
 {
 	yaffs_PackTags2TagsPart(&pt->t,t);
 
-#ifndef YAFFS_IGNORE_TAGS_ECC
+#ifndef CONFIG_YAFFS_IGNORE_TAGS_ECC
 	{
 		yaffs_ECCCalculateOther((unsigned char *)&pt->t,
 					sizeof(yaffs_PackedTags2TagsPart),
@@ -167,7 +167,7 @@ void yaffs_UnpackTags2(yaffs_ExtendedTags * t, yaffs_PackedTags2 * pt)
 
 	if (pt->t.sequenceNumber != 0xFFFFFFFF) {
 		/* Page is in use */
-#ifdef YAFFS_IGNORE_TAGS_ECC
+#ifdef CONFIG_YAFFS_IGNORE_TAGS_ECC
 		{
 			t->eccResult = YAFFS_ECC_RESULT_NO_ERROR;
 		}
-- 
1.6.5.2

