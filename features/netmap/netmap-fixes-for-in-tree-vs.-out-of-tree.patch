From c271500972c7226ed2e2453f30a0b60276e41a5c Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Mon, 19 Jan 2015 13:30:50 -0500
Subject: [PATCH] netmap: fixes for in-tree vs. out of tree

The default build is out of tree, and hence it does some run time
configuration, and passes what would normally be Kconfig variables
in at build time.

Import a default runtime configuration header, and capture the
build flags used by the out of tree instance in the Makefiles
that were created for in-tree use.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/drivers/staging/netmap/LINUX/Makefile b/drivers/staging/netmap/LINUX/Makefile
index a7db83c188fc..98d05447dc23 100644
--- a/drivers/staging/netmap/LINUX/Makefile
+++ b/drivers/staging/netmap/LINUX/Makefile
@@ -1,4 +1,4 @@
 NETMAP_PATH := $(srctree)/drivers/staging/netmap
-ccflags-y += -I$(NETMAP_PATH)/sys/ -I$(NETMAP_PATH)/LINUX
+ccflags-y += -I$(NETMAP_PATH)/sys/ -I$(NETMAP_PATH)/LINUX -DCONFIG_NETMAP -DCONFIG_NETMAP_GENERIC -DCONFIG_NETMAP_MONITOR -DCONFIG_NETMAP_PIPE -DCONFIG_NETMAP_VALE
 
 obj-$(CONFIG_NETMAP) += netmap_linux.o
diff --git a/drivers/staging/netmap/LINUX/netmap_linux_config.h b/drivers/staging/netmap/LINUX/netmap_linux_config.h
new file mode 100644
index 000000000000..7de9e40067eb
--- /dev/null
+++ b/drivers/staging/netmap/LINUX/netmap_linux_config.h
@@ -0,0 +1,64 @@
+#ifndef NETMAP_LINUX_CONFIG_H
+#define NETMAP_LINUX_CONFIG_H
+
+#define NETMAP_LINUX_IXGBE_PTR_ARRAY 
+
+#define NETMAP_LINUX_IXGBE_DESC 3
+
+#define NETMAP_LINUX_HAVE_E1000E_EXT_RXDESC 
+
+#define NETMAP_LINUX_HAVE_ADDR_RANDOM 
+
+#define NETMAP_LINUX_HAVE_TX_SKB_SHARING 
+
+#define NETMAP_LINUX_HAVE_GET_STATS64 
+
+#define NETMAP_LINUX_HAVE_LIVE_ADDR_CHANGE 
+
+#define NETMAP_LINUX_HAVE_HRTIMER_MODE_REL 
+
+#define NETMAP_LINUX_HAVE_USLEEP_RANGE 
+
+#define NETMAP_LINUX_HAVE_NETDEV_TX_T 
+
+#define NETMAP_LINUX_HAVE_NETDEV_OPS 
+
+#define NETMAP_LINUX_HAVE_PHYS_ADDR_T 
+
+#define NETMAP_LINUX_HAVE_HRTIMER_FORWARD_NOW 
+
+#define NETMAP_LINUX_HAVE_QUEUE_MAPPING 
+
+#define NETMAP_LINUX_HAVE_UINTPTR 
+
+#define NETMAP_LINUX_HAVE_ACCESS_ONCE 
+
+#define NETMAP_LINUX_HAVE_SKB_COPY_LINEAR 
+
+#define NETMAP_LINUX_HAVE_INIT_NET 
+
+#define NETMAP_LINUX_HAVE_UNLOCKED_IOCTL 
+
+#define NETMAP_LINUX_PWAIT_KEY _key
+
+#define NETMAP_LINUX_HAVE_NUM_QUEUES 
+
+#define NETMAP_LINUX_HAVE_PERNET_OPS_ID 
+
+#define NETMAP_LINUX_HAVE_SET_CHANNELS 
+
+#define NETMAP_LINUX_HAVE_GET_RINGPARAM 
+
+#define NETMAP_LINUX_SELECT_QUEUE 4
+
+#define NETMAP_LINUX_HAVE_RX_HANDLER_RESULT 
+
+#define NETMAP_LINUX_HAVE_RX_REGISTER 
+
+#define NETMAP_LINUX_TIMER_RTYPE enum hrtimer_restart
+
+#define NETMAP_LINUX_HAVE_IOMMU 
+
+#define NETMAP_LINUX_DRIVER_SUFFIX ""
+
+#endif
diff --git a/drivers/staging/netmap/sys/dev/netmap/Makefile b/drivers/staging/netmap/sys/dev/netmap/Makefile
index 05df2c2f91c9..48d19fb41a44 100644
--- a/drivers/staging/netmap/sys/dev/netmap/Makefile
+++ b/drivers/staging/netmap/sys/dev/netmap/Makefile
@@ -1,6 +1,6 @@
 NETMAP_PATH := $(srctree)/drivers/staging/netmap
-ccflags-y += -I$(NETMAP_PATH)/sys/ -I$(NETMAP_PATH)/LINUX
+ccflags-y += -I$(NETMAP_PATH)/sys/ -I$(NETMAP_PATH)/LINUX -DCONFIG_NETMAP -DCONFIG_NETMAP_GENERIC -DCONFIG_NETMAP_MONITOR -DCONFIG_NETMAP_PIPE -DCONFIG_NETMAP_VALE
 
 obj-$(CONFIG_NETMAP) += netmap.o netmap_mem2.o \
         netmap_generic.o netmap_mbq.o netmap_vale.o \
-        netmap_offloadings.o netmap_pipe.o
+        netmap_offloadings.o netmap_pipe.o netmap_monitor.o
-- 
2.1.2

