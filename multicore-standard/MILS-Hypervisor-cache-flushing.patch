From 3d66fae5c28e57992f876d0da1b092a934e3e889 Mon Sep 17 00:00:00 2001
From: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
Date: Fri, 19 Feb 2010 08:16:47 -0500
Subject: [PATCH] [MILS] Hypervisor cache flushing

Call the proper cache flush call for the given version of the
hypervisor.

The third parameter to the vbi_flush_(i/d)cache function call
is for the stride and is not implemented on the c-hv.  This
means that when the specified region is flushed it will flush
things on boundaries specified by the stride.

The stride side is the cache line size (the code is uses it as "address
+= line size").  The code loops from the starting to ending address,
incrementing by the "stride" (like striding down the street) size.

For example, the 604 has 64 byte lines, so the stride size is 64.

Signed-off-by: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
---
 arch/powerpc/kernel/vbi/util.c |   19 +++++++++++++++++++
 1 files changed, 19 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/util.c b/arch/powerpc/kernel/vbi/util.c
index 9c7ba61..c73e918 100644
--- a/arch/powerpc/kernel/vbi/util.c
+++ b/arch/powerpc/kernel/vbi/util.c
@@ -117,24 +117,43 @@ int vb_context_mmu_on(int pid,	/* context id */
 
 void vb__flush_dcache_icache(void *start)
 {
+#ifdef CONFIG_WRHV_MILS
+	vbi_flush_icache(start, (void *)(start + (PAGE_SIZE-1)), L1_CACHE_BYTES);
+	vbi_flush_dcache(start, (void *)(start + (PAGE_SIZE-1)), L1_CACHE_BYTES);
+#else
 	vbi_flush_icache(start, 4096);
 	vbi_flush_dcache(start, 4096);
+#endif
 }
 
 void vb_flush_dcache_range(unsigned long start, unsigned long stop)
 {
+#ifdef CONFIG_WRHV_MILS
+	vbi_flush_dcache((void *) start, (void *) stop, 8);
+#else
 	vbi_flush_dcache((void *) start, (stop - start + 1));
+#endif
 }
 
 void vb__flush_icache_range(unsigned long start, unsigned long stop)
 {
+#ifdef CONFIG_WRHV_MILS
+	vbi_flush_dcache((void *) start, (void *) stop, 8);
+	vbi_flush_icache((void *) start, (void *) stop, 8);
+#else
 	vbi_update_text_cache((void *) start, (stop - start + 1));
+#endif
 }
 
 void vb__flush_dcache_icache_phys(unsigned long physaddr)
 {
+#ifdef CONFIG_WRHV_MILS
+	vbi_flush_dcache((void *) physaddr, (void *) (physaddr + (PAGE_SIZE-1)), L1_CACHE_BYTES);
+	vbi_flush_icache((void *) physaddr, (void *) (physaddr + (PAGE_SIZE-1)), L1_CACHE_BYTES);
+#else
 	vbi_flush_icache((void *) physaddr, 4096);
 	vbi_flush_dcache((void *) physaddr, 4096);
+#endif
 }
 
 EXPORT_SYMBOL_GPL(wrhv_int_lock);
-- 
1.7.0

