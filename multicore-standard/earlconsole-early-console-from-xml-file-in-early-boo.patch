From a191543ad5b6be40bff795f41bef05adf4b48271 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Tue, 15 Dec 2009 18:04:14 -0800
Subject: [PATCH 2/4] earlconsole: early console from xml file in early boot

This patch intended to support early console definition
in cmdline from wrhv xml file, and avoid early uart msg
tangle in early boot process.

Signed-off-by: Zumeng.chen <zumeng.chen@windriver.com>
---
 arch/powerpc/boot/serial.c    |   57 +++++++++++++++++++++++++++++++++++++++++
 arch/powerpc/boot/wrhv_boot.h |   15 +++++++++++
 2 files changed, 72 insertions(+), 0 deletions(-)
 create mode 100644 arch/powerpc/boot/wrhv_boot.h

diff --git a/arch/powerpc/boot/serial.c b/arch/powerpc/boot/serial.c
index 6738cd8..b1c9357 100644
--- a/arch/powerpc/boot/serial.c
+++ b/arch/powerpc/boot/serial.c
@@ -18,6 +18,9 @@
 #include "stdio.h"
 #include "io.h"
 #include "ops.h"
+#ifdef CONFIG_WRHV
+#include "wrhv_boot.h"
+#endif
 
 static int serial_open(void)
 {
@@ -82,6 +85,56 @@ static void serial_close(void)
 		scdp->close();
 }
 
+#ifdef CONFIG_WRHV
+static inline const char * wrhv_serial(int port_index)
+{
+	switch(port_index) {
+		case  0:
+			return "serial0";
+		case  1:
+			return "serial1";
+		case  2:
+			return "serial2";
+		case  3:
+			return "serial3";
+		default:
+			return NULL;
+	}
+}
+
+static void * wrhv_serial_get_stdout_devp(void)
+{
+	void *devp;
+	char *cmdline_p = (char *)(WRHV_CMDLINE_ADDR);
+	char wrhv_path[256];
+	int i = 0, serial_index = -1;
+
+	do{
+		if(!strncmp(&cmdline_p[i],"wrhv_earlycon=",WRHV_EARLYCON_SIZE)){
+			serial_index = cmdline_p[i+WRHV_EARLYCON_SIZE];
+			break;
+		}
+		/* Try to find next space  */
+		while((i < 242) && (cmdline_p[i] != 0x20))
+			i++;
+		/*skip the space */
+		i++;
+	}while(i < WRHV_CMDLINE_SIZE);
+
+	devp = finddevice("/aliases");
+	if (devp == NULL)
+		goto null_out;
+
+	if (getprop(devp,wrhv_serial((serial_index - 0x30)),wrhv_path,256) > 0){
+		devp =  finddevice(wrhv_path);
+		return devp;
+	}
+
+null_out:
+	return NULL;
+}
+#endif
+
 static void *serial_get_stdout_devp(void)
 {
 	void *devp;
@@ -113,6 +166,10 @@ int serial_console_init(void)
 	void *devp;
 	int rc = -1;
 
+#ifdef CONFIG_WRHV
+	devp = wrhv_serial_get_stdout_devp();
+	if(devp == NULL)
+#endif
 	devp = serial_get_stdout_devp();
 	if (devp == NULL)
 		goto err_out;
diff --git a/arch/powerpc/boot/wrhv_boot.h b/arch/powerpc/boot/wrhv_boot.h
new file mode 100644
index 0000000..6dc2d94
--- /dev/null
+++ b/arch/powerpc/boot/wrhv_boot.h
@@ -0,0 +1,15 @@
+#ifndef _WRHV_BOOT_H
+#define _WRHV_BOOT_H
+
+/*
+ * In current situation, there is no parameters protocol negotiated
+ * between hypervisor and guest Linux, so we still define the hard
+ * address for command line buffer like ENT_OFFSET as follows. Just
+ * for notes to remove them in the future.
+ * WRHV_CMDLINE_ADDR=offsetof(struct vb_config,bootLine)+ENT_OFFSET
+ */
+#define WRHV_CMDLINE_ADDR 0xF00000DC
+#define WRHV_CMDLINE_SIZE 256
+#define WRHV_EARLYCON_SIZE  14  /* sizeof("wrhv_earlycon=") */
+
+#endif /* _WRHV_BOOT_H */
-- 
1.6.5.2

