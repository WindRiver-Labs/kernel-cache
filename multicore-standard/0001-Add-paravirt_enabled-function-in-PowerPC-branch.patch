From 5e2a800965ab84600759e126398e46d1026462ab Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Tue, 27 Oct 2009 17:26:37 +0800
Subject: [PATCH 1/3] Add paravirt_enabled function in PowerPC branch

paravirt_enabled is used to assert whether system
has implemented paravirtualization.

Signed-off-by: Andrew Liu <shengping.liu@windriver.com>
---
 arch/powerpc/include/asm/paravirt.h  |    7 +++++++
 arch/powerpc/include/asm/processor.h |    6 ++++++
 arch/powerpc/kernel/paravirt.c       |   11 +++++++++++
 arch/powerpc/kernel/vbi/wrhv.c       |    3 +++
 4 files changed, 27 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/paravirt.h b/arch/powerpc/include/asm/paravirt.h
index bdb7387..0af22f7 100644
--- a/arch/powerpc/include/asm/paravirt.h
+++ b/arch/powerpc/include/asm/paravirt.h
@@ -55,6 +55,12 @@ struct pv_cpu_ops {
                                struct pt_regs *linux_regs);
 };
 
+/* general info */
+struct pv_info {
+        const char *name;
+        int paravirt_enabled;
+};
+
 struct pv_irq_ops {
 	void (*do_IRQ)(struct pt_regs *regs);
 	unsigned int (*irq_of_parse_and_map)
@@ -86,6 +92,7 @@ struct pv_mmu_ops {
 
 };
 
+extern struct pv_info pv_info;
 extern struct pv_time_ops pv_time_ops;
 extern struct pv_cpu_ops pv_cpu_ops;
 extern struct pv_irq_ops pv_irq_ops;
diff --git a/arch/powerpc/include/asm/processor.h b/arch/powerpc/include/asm/processor.h
index ae1c5b5..89750f7 100644
--- a/arch/powerpc/include/asm/processor.h
+++ b/arch/powerpc/include/asm/processor.h
@@ -42,6 +42,12 @@
 
 #if defined(__KERNEL__) && defined(CONFIG_PPC32)
 
+#ifdef CONFIG_PARAVIRT
+extern int paravirt_enabled(void);
+#else
+#define paravirt_enabled()      0
+#endif
+
 extern int _chrp_type;
 
 #ifdef CONFIG_PPC_PREP
diff --git a/arch/powerpc/kernel/paravirt.c b/arch/powerpc/kernel/paravirt.c
index 2207368..eb01d5f 100644
--- a/arch/powerpc/kernel/paravirt.c
+++ b/arch/powerpc/kernel/paravirt.c
@@ -104,6 +104,11 @@ void paravirt_init(void)
 #endif
 }
 
+struct pv_info pv_info = {
+        .name = "bare hardware",
+        .paravirt_enabled = 0,
+};
+
 /* default native operations */
 struct pv_time_ops pv_time_ops = {
 #if 0
@@ -243,11 +248,17 @@ int paravirt_early_init_dt_scan_memory(unsigned long node,
 					uname, depth, data);
 }
 
+inline int paravirt_enabled(void)
+{
+        return pv_info.paravirt_enabled;
+}
+
 extern struct pv_time_ops pv_time_ops;
 extern struct pv_cpu_ops pv_cpu_ops;
 extern struct pv_irq_ops pv_irq_ops;
 extern struct pv_mmu_ops pv_mmu_ops; 
 
+EXPORT_SYMBOL_GPL(pv_info);
 EXPORT_SYMBOL_GPL(pv_time_ops);
 EXPORT_SYMBOL    (pv_cpu_ops);
 EXPORT_SYMBOL    (pv_mmu_ops);
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index dad4cec..17f61d8 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -967,6 +967,9 @@ void wrhv_init(void)
 	wrhvControl = wrhvConfig->vbControl;
 	wrhvStatus = wrhvConfig->vbStatus;
 
+	pv_info.name = "wrhv";
+	pv_info.paravirt_enabled = 1;
+
 	pv_time_ops.hw_time_init = wrhv_hw_time_init;
         pv_time_ops.hw_timer_interrupt = wrhv_hw_timer_interrupt;
         pv_time_ops.hw_clocksource_init = wrhv_hw_clocksource_init;
-- 
1.6.5.2

