From 20feb9b52846f3fe3682d0b97a59692cbdad9957 Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Mon, 29 Mar 2010 17:15:43 -0400
Subject: [PATCH] MILS: export ppc syscalls from VDK specific file

The out of tree MILS modular drivers will be looking for
these direct hypervisor calls, so export them from a
MILS specific, but architecture independent location.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
---
 arch/powerpc/kernel/vbi/vdk_syscalls.S |   13 +-------
 arch/powerpc/kernel/vbi/wrhv.c         |   16 ----------
 kernel/vbi/Makefile                    |    2 +-
 kernel/vbi/vdk_syscalls.c              |   51 ++++++++++++++++++++++++++++++++
 4 files changed, 54 insertions(+), 28 deletions(-)
 create mode 100644 kernel/vbi/vdk_syscalls.c

diff --git a/arch/powerpc/kernel/vbi/vdk_syscalls.S b/arch/powerpc/kernel/vbi/vdk_syscalls.S
index df4141a..3a4dba7 100644
--- a/arch/powerpc/kernel/vbi/vdk_syscalls.S
+++ b/arch/powerpc/kernel/vbi/vdk_syscalls.S
@@ -37,16 +37,6 @@
 #define HCALL sc
 #endif
 
-FUNC_EXPORT(vbi_virt_to_phys)
-FUNC_EXPORT(vbi_enable_vmmu)
-FUNC_EXPORT(vbi_config_vmmu)
-FUNC_EXPORT(vbi_flush_dcache)
-FUNC_EXPORT(vbi_flush_icache)
-FUNC_EXPORT(vbi_exec_vec_base_addr_set)
-FUNC_EXPORT(vbi_vcore_irq_lock)
-FUNC_EXPORT(vbi_vcore_irq_unlock)
-FUNC_EXPORT(vbi_int_controller_done)
-
 _WRS_TEXT_SEG_START
 
 #define vbi_hcall(name, call)		\
@@ -55,7 +45,8 @@ FUNC_LABEL(name)			\
 	ori r0, r0, LO(VBI_SYS_##call);	\
 	HCALL;				\
 	blr;				\
-FUNC_END(name)
+FUNC_END(name);				\
+FUNC_EXPORT(name)
 
 
 /*
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 487e484..ac1a001 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -1329,19 +1329,3 @@ int fsl8572_get_pci_intr_wrhv(struct pci_dev *dev)
 	return irq;
 }
 #endif /* CONFIG_WRHV_8572 & CONFIG_PCI*/
-
-#if 0 // def CONFIG_WRHV_MILS
-EXPORT_SYMBOL(vbi_vcore_irq_lock);
-EXPORT_SYMBOL(vbi_vcore_irq_unlock);
-EXPORT_SYMBOL(vbi_int_controller_done);
-
-EXPORT_SYMBOL(vdk_port_send);
-EXPORT_SYMBOL(vdk_port_get_recv_buf);
-EXPORT_SYMBOL(vdk_port_buf_release);
-EXPORT_SYMBOL(vdk_schedule_name_to_id);
-EXPORT_SYMBOL(vdk_schedule_set);
-EXPORT_SYMBOL(vdk_sec_audit_event_inject);
-EXPORT_SYMBOL(vdk_sec_audit_event_collect);
-EXPORT_SYMBOL(vdk_safe_crit_event_inject);
-EXPORT_SYMBOL(vdk_safe_crit_event_collect);
-#endif
diff --git a/kernel/vbi/Makefile b/kernel/vbi/Makefile
index 595044e..7900ca3 100644
--- a/kernel/vbi/Makefile
+++ b/kernel/vbi/Makefile
@@ -4,7 +4,7 @@
 
 obj-y := wrhv.o paddr.o lib.o shmem.o show.o version.o interrupt.o
 ifeq ($(CONFIG_WRHV_MILS),y)
-obj-y += vdk_interrupt.o
+obj-y += vdk_interrupt.o vdk_syscalls.o
 else
 obj-y += io_apic.o idle.o msg.o ns.o
 endif
diff --git a/kernel/vbi/vdk_syscalls.c b/kernel/vbi/vdk_syscalls.c
new file mode 100644
index 0000000..bdd64c0
--- /dev/null
+++ b/kernel/vbi/vdk_syscalls.c
@@ -0,0 +1,51 @@
+/*
+ * vdk_syscall.c - export VDK syscalls.
+ *
+ * Copyright (c) 2010 Wind River Systems, Inc.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
+ * See the GNU General Public License for more details.
+ *
+ */
+
+/*
+ * This file contains the syscall exports for access via
+ * drivers built as modules that are looking to get to hypercalls.
+ *
+ *
+ * This particular version is only used by MILS.
+ */
+
+#include <linux/module.h>
+#include <vbi/vdk_syscalls.h>
+
+EXPORT_SYMBOL(vbi_vcore_irq_lock);
+EXPORT_SYMBOL(vbi_vcore_irq_unlock);
+EXPORT_SYMBOL(vbi_int_controller_done);
+
+EXPORT_SYMBOL(vbi_flush_icache);
+EXPORT_SYMBOL(vbi_flush_dcache);
+EXPORT_SYMBOL(vbi_config_vmmu);
+EXPORT_SYMBOL(vbi_enable_vmmu);
+EXPORT_SYMBOL(vbi_virt_to_phys);
+
+/*
+ * These are specific to MILS and not a part of the normal VBI 2.0 spec.
+ */
+EXPORT_SYMBOL(vdk_sec_audit_event_inject);
+EXPORT_SYMBOL(vdk_sec_audit_event_collect);
+EXPORT_SYMBOL(vdk_safe_crit_event_inject);
+EXPORT_SYMBOL(vdk_safe_crit_event_collect);
+
+EXPORT_SYMBOL(vdk_schedule_name_to_id);
+EXPORT_SYMBOL(vdk_schedule_set);
+
+EXPORT_SYMBOL(vdk_port_send);
+EXPORT_SYMBOL(vdk_port_get_recv_buf);
+EXPORT_SYMBOL(vdk_port_buf_release);
-- 
1.6.5.2

