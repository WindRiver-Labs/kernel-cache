From 36c6732ddf773b2005204afe05922c0b55f55d06 Mon Sep 17 00:00:00 2001
From: Thomas Tai <thomas.tai@windriver.com>
Date: Fri, 6 Nov 2009 10:32:09 -0500
Subject: [PATCH] Enable kgdb single stepping

Enable hypervisor emulated MSR's debug enable bit for
supporting kgdb single stepping.

Signed-off-by: Thomas Tai <thomas.tai@windriver.com>
---
 arch/powerpc/kernel/vbi/wrhv.c |   11 ++++++++++-
 1 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 3abab97..5b1943d 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -932,8 +932,17 @@ int wrhv_kgdb_arch_handle_exception(int vector, int signo, int err_code,
                 /* set the trace bit if we're stepping */
                 if (remcom_in_buffer[0] == 's') {
 #if defined(CONFIG_40x) || defined(CONFIG_BOOKE)
+			/*
+			 * Set hypervisor DBCR0_IC single step and
+			 * DBCR0_IDM internal debug mode.
+			 */
                         wrhvControl->vbControlRegs.dbcr0 |= (DBCR0_IC | DBCR0_IDM);
-                        linux_regs->msr |= MSR_DE;
+
+			/*
+			 * Set Debug Enable bit in hypervisor's emulated MSR which
+			 * is restored on return from exception
+			 */
+			wrhvControl->vbControlRegs.emsr |= MSR_DE;
 #else
                         linux_regs->msr |= MSR_SE;
 #endif
-- 
1.6.5.2

