From a324d3c29c950cbb216c93da9a97a734904836bf Mon Sep 17 00:00:00 2001
From: Thomas Tai <thomas.tai@windriver.com>
Date: Fri, 6 Nov 2009 10:32:09 -0500
Subject: [PATCH 48/59] Enable kgdb single stepping

Enable hypervisor emulated MSR's debug enable bit for
supporting kgdb single stepping.

Signed-off-by: Thomas Tai <thomas.tai@windriver.com>
---
 arch/powerpc/kernel/vbi/wrhv.c |   17 ++++++++++-------
 1 files changed, 10 insertions(+), 7 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 97f2483..a27d6f2 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -932,8 +932,17 @@ int wrhv_kgdb_arch_handle_exception(int vector, int signo, int err_code,
 		/* set the trace bit if we're stepping */
 		if (remcom_in_buffer[0] == 's') {
 #if defined(CONFIG_40x) || defined(CONFIG_BOOKE)
+			/*
+			 * Set hypervisor DBCR0_IC single step and
+			 * DBCR0_IDM internal debug mode.
+			 */
 			wr_control->vb_control_regs.dbcr0 |= (DBCR0_IC | DBCR0_IDM);
-			linux_regs->msr |= MSR_DE;
+
+			/*
+			 * Set Debug Enable bit in hypervisor's emulated MSR
+			 * which is restored on return from exception
+			 */
+			wr_control->vb_control_regs.emsr |= MSR_DE;
 #else
 			linux_regs->msr |= MSR_SE;
 #endif
@@ -965,15 +974,9 @@ void wrhv_init(void)
 	pv_info.name = "wrhv";
 	pv_info.paravirt_enabled = 1;
 
-<<<<<<< HEAD
-	pv_time_ops.hw_time_init = wrhv_hw_time_init;
-	pv_time_ops.hw_timer_interrupt = wrhv_hw_timer_interrupt;
-	pv_time_ops.hw_clocksource_init = wrhv_hw_clocksource_init;
-=======
 	pv_time_ops.time_init_cont = wrhv_time_init_cont;
 	pv_time_ops.timer_interrupt = wrhv_hw_timer_interrupt;
 	pv_time_ops.clocksource_init = wrhv_clocksource_init;
->>>>>>> 86353db... paravirtualize time init and timer interrupt
 
 	pv_irq_ops.do_IRQ = wrhv_do_IRQ;
 	pv_irq_ops.irq_of_parse_and_map =
-- 
1.6.5.2

