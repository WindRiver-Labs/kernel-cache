From a31f87b13afe522967c9c8cf72f47a849864f88f Mon Sep 17 00:00:00 2001
From: WRS Support <support@windriver.com>
Date: Fri, 2 Oct 2009 16:23:11 -0400
Subject: [PATCH] drivers: changes to various drivers for hypervisor/guest

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 drivers/serial/8250.c         |    4 ++++
 drivers/serial/serial_core.c  |    9 +++++++++
 drivers/usb/host/pci-quirks.c |    3 +++
 3 files changed, 16 insertions(+), 0 deletions(-)

diff --git a/drivers/serial/8250.c b/drivers/serial/8250.c
index 537a245..1335654 100644
--- a/drivers/serial/8250.c
+++ b/drivers/serial/8250.c
@@ -2255,7 +2255,11 @@ serial8250_set_termios(struct uart_port *port, struct ktermios *termios,
 		/* Switch to bank 2 not bank 1, to avoid resetting EXCR2 */
 		serial_outp(up, UART_LCR, 0xe0);
 	} else {
+#if defined(CONFIG_WRHV) && defined(CONFIG_PPC)
+		/* skip DLAB on WRHV + PPC */
+#else
 		serial_outp(up, UART_LCR, cval | UART_LCR_DLAB);/* set DLAB */
+#endif
 	}
 
 	serial_dl_write(up, quot);
diff --git a/drivers/serial/serial_core.c b/drivers/serial/serial_core.c
index 7547e94..4784808 100644
--- a/drivers/serial/serial_core.c
+++ b/drivers/serial/serial_core.c
@@ -2492,6 +2492,15 @@ int uart_add_one_port(struct uart_driver *drv, struct uart_port *port)
 		lockdep_set_class(&port->lock, &port_lock_key);
 	}
 
+#ifdef CONFIG_WRHV
+#define __MIPC_MSD_MAJOR	236
+	if (!uart_console(port) && (drv->major != __MIPC_MSD_MAJOR)) {
+		ret = -EBUSY;
+		goto out;
+	}
+#undef __MIPC_MSD_MAJOR
+#endif
+
 	uart_configure_port(drv, state, port);
 
 	/*
diff --git a/drivers/usb/host/pci-quirks.c b/drivers/usb/host/pci-quirks.c
index 5ef25db..055a17e 100644
--- a/drivers/usb/host/pci-quirks.c
+++ b/drivers/usb/host/pci-quirks.c
@@ -354,6 +354,9 @@ static void __devinit quirk_usb_disable_ehci(struct pci_dev *pdev)
 
 static void __devinit quirk_usb_early_handoff(struct pci_dev *pdev)
 {
+	if (paravirt_enabled())
+		return;
+
 	if (pdev->class == PCI_CLASS_SERIAL_USB_UHCI)
 		quirk_usb_handoff_uhci(pdev);
 	else if (pdev->class == PCI_CLASS_SERIAL_USB_OHCI)
-- 
1.6.5.2

