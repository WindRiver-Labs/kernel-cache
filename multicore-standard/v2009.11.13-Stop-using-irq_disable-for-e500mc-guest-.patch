From 22692361570384e8e5c8abc31fd73ad46ec147d0 Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Thu, 26 Nov 2009 20:11:16 -0500
Subject: [PATCH 3/7] v2009.11.13: Stop using irq_disable for e500mc guest mode

Integrate Friday the 13th release

[cf: 02n,02nov09,dtr  Stop using intDisable is e500mc guest mode.]

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
---
 arch/powerpc/kernel/vbi/syscalls.S |   28 +++++++++++++++++++++-------
 1 files changed, 21 insertions(+), 7 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/syscalls.S b/arch/powerpc/kernel/vbi/syscalls.S
index e22d0b6..e43274d 100644
--- a/arch/powerpc/kernel/vbi/syscalls.S
+++ b/arch/powerpc/kernel/vbi/syscalls.S
@@ -409,14 +409,14 @@ FUNC_END(vbi_flush_tlb)
  *
  */
 FUNC_LABEL(vbi_vcore_irq_unlock)
+#ifdef CONFIG_PPC85xx_VT_MODE
+	wrteei	1
+#else
 	lis	p0, HIADJ(wrhvVbControl)
 	lwz	p0, LO(wrhvVbControl)(p0)
 	li	p1, 0
-#ifdef CONFIG_PPC85xx_VT_MODE
-	writeei	1
-#endif
 	stw	p1, VB_CONTROL_INT_DISABLE(p0)
-
+#endif
 tryAgain:
 	lis	p0, HIADJ(wrhvVbStatus)
 	lwz	p0, LO(wrhvVbStatus)(p0)
@@ -444,14 +444,15 @@ FUNC_END(vbi_vcore_irq_unlock)
  *
  */
 FUNC_LABEL(vbi_vcore_irq_lock)
-	li	p1, -1
 #ifdef CONFIG_PPC85xx_VT_MODE
-	writeei	0
-#endif
+	wrteei	0
+#else
+	li	p1, -1
 	lis	p2, HIADJ(wrhvVbControl)
 	lwz	p2, LO(wrhvVbControl)(p2)
 	lwz	p0, VB_CONTROL_INT_DISABLE(p2)
 	stw	p1, VB_CONTROL_INT_DISABLE(p2)
+#endif
 	blr
 FUNC_END(vbi_vcore_irq_lock)
 
@@ -465,10 +466,23 @@ FUNC_END(vbi_vcore_irq_lock)
  *
  */
 FUNC_LABEL(vbi_vcore_irq_state)
+#ifdef CONFIG_PPC85xx_VT_MODE
+#define _PPC_MSR_BIT_EE 16
+	mfmsr	r3
+	rlwinm.	r3, r3, 0, _PPC_MSR_BIT_EE, _PPC_MSR_BIT_EE
+	beq	return_disabled
+	li	r3, 0
+	blr
+return_disabled:
+	li	r3, -1
+	blr
+#else
 	lis	p2, HIADJ(wrhvVbControl)
 	lwz	p2, LO(wrhvVbControl)(p2)
 	lwz	p0, VB_CONTROL_INT_DISABLE(p2)
 	blr
+#endif
+
 FUNC_END(vbi_vcore_irq_state)
 
 /*
-- 
1.6.5.2

