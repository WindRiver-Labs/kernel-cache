From 7d5e164ba205d39c834d92d8b540258557715fe7 Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Tue, 15 Dec 2009 14:13:22 -0500
Subject: [PATCH 7/8] vpi: cleanup vioapic direction fields

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
---
 include/vbi/compat.h  |    5 +++++
 include/vbi/io_apic.h |   12 ++++++------
 kernel/vbi/io_apic.c  |   32 ++++++++++++++++----------------
 3 files changed, 27 insertions(+), 22 deletions(-)

diff --git a/include/vbi/compat.h b/include/vbi/compat.h
index 76a6399..c0b002d 100644
--- a/include/vbi/compat.h
+++ b/include/vbi/compat.h
@@ -55,6 +55,8 @@
 
 #define VIOAPIC_ID		union vioapic_id
 #define VIOAPIC_VERSION		union vioapic_version
+#define VIOAPIC_REDIR_LOW	union vioapic_redir_low
+#define VIOAPIC_REDIR_HIGH	union vioapic_redir_high
 
 #define VB_TIMESTAMP		uint64_t
 #define vbiStatus_t		int32_t
@@ -77,6 +79,9 @@
 #define vbStatus		vb_status
 #define vbControl		vb_control
 
+#define vioapicLow		vioapic_low
+#define vioapicHigh		vioapic_high
+
 #define wrhvControl		wr_control
 #define wrhvConfig		wr_config
 #define wrhvStatus		wr_status
diff --git a/include/vbi/io_apic.h b/include/vbi/io_apic.h
index 308b64a..f1bda0e 100644
--- a/include/vbi/io_apic.h
+++ b/include/vbi/io_apic.h
@@ -52,7 +52,7 @@ union vioapic_version
 
 /* Virtual IO APIC redirection table entry. Split into high/low 32 */
 
-typedef union
+union vioapic_redir_high
 {
 	struct
 	{
@@ -60,9 +60,9 @@ typedef union
 		uint32_t destination:8;	/* destination field */
 	} field;
 	uint32_t value;
-} VIOAPIC_REDIR_HIGH;
+};
 
-typedef union
+union vioapic_redir_low
 {
 	struct
 	{
@@ -80,12 +80,12 @@ typedef union
 		uint32_t reserved:15;	/* reserved bits */
 	} field;
 	uint32_t value;
-} VIOAPIC_REDIR_LOW;
+};
 
 typedef struct vioapicEntry
 {
-	VIOAPIC_REDIR_LOW	vioapicLow;
-	VIOAPIC_REDIR_HIGH	vioapicHigh;
+	union vioapic_redir_low vioapic_low;
+	union vioapic_redir_high vioapic_high;
 } VIOAPIC_ENTRY;
 
 typedef struct vioapic
diff --git a/kernel/vbi/io_apic.c b/kernel/vbi/io_apic.c
index 29ded32..0c4c4c0 100644
--- a/kernel/vbi/io_apic.c
+++ b/kernel/vbi/io_apic.c
@@ -95,7 +95,7 @@ int32_t vbi_set_vioapic_vec(uint32_t irq, int32_t vector)
 	VB_DEBUG_MSG("Set vector %d: @ 0x%x\n", vioapicBase,
 		 &(pVioapic->entry[irq].value));
 
-	pVioapic->entry[irq].vioapicLow.field.vector = vector;
+	pVioapic->entry[irq].vioapic_low.field.vector = vector;
 
 	return 0;
 }
@@ -124,7 +124,7 @@ int32_t vbi_get_vioapic_vec(uint32_t irq)
 
 	VB_DEBUG_MSG("vbi_get_vioapic_vec: base @ 0x%x\n", vioapicBase);
 
-	vector = pVioapic->entry[irq].vioapicLow.field.vector;
+	vector = pVioapic->entry[irq].vioapic_low.field.vector;
 
 	VB_DEBUG_MSG("vbi_get_vioapic_vec: vector %d: for irq 0x%x\n", vector, irq);
 
@@ -178,7 +178,7 @@ int32_t vbi_mask_vioapic_irq(uint32_t irq)
 	if (irq > VIOAPIC_MAX_REDTABLE_ENTRIES-1)
 		return -1;
 
-	pVioapic->entry[irq].vioapicLow.field.mask = 1;
+	pVioapic->entry[irq].vioapic_low.field.mask = 1;
 
 	return 0;
 }
@@ -288,8 +288,8 @@ int32_t vbi_redir_vioapic_irq(uint32_t irq, int32_t core)
  */
 void vbi_disp_vioapic(void)
 {
-	VIOAPIC_REDIR_LOW regIoApicRedirLow;
-	VIOAPIC_REDIR_HIGH regIoApicRedirHigh;
+	union vioapic_redir_low reg_redir_low;
+	union vioapic_redir_high reg_redir_high;
 	volatile VIOAPIC *pVioapic = (volatile VIOAPIC *)VBI_VIOAPIC_BASE_GET();
 	uint32_t i;
 
@@ -321,20 +321,20 @@ void vbi_disp_vioapic(void)
 
 	for (i=0; i < VIOAPIC_MAX_REDTABLE_ENTRIES; i++) {
 
-	regIoApicRedirLow  = pVioapic->entry[i].vioapicLow;
-	regIoApicRedirHigh = pVioapic->entry[i].vioapicHigh;
+	reg_redir_low  = pVioapic->entry[i].vioapic_low;
+	reg_redir_high = pVioapic->entry[i].vioapic_high;
 
 	printk(" %3.3d   %3.3d   %4s %6s %5s %3s  %1d     %6s   %6s %d\n",
 			i,
-			regIoApicRedirLow.field.vector,
-			regIoApicRedirLow.field.mask ? "MASK" : "none",
-			regIoApicRedirLow.field.delivStatus ? "PEND" : "idle",
-			regIoApicRedirLow.field.trigger ? "level" : "edge",
-			regIoApicRedirLow.field.polarity ? "lo" : "hi",
-			regIoApicRedirLow.field.irr,
-			deliveryModes[regIoApicRedirLow.field.deliveryMode],
-			regIoApicRedirLow.field.destMode ? "Set: " : "ID: ",
-			regIoApicRedirHigh.field.destination);
+			reg_redir_low.field.vector,
+			reg_redir_low.field.mask ? "MASK" : "none",
+			reg_redir_low.field.delivStatus ? "PEND" : "idle",
+			reg_redir_low.field.trigger ? "level" : "edge",
+			reg_redir_low.field.polarity ? "lo" : "hi",
+			reg_redir_low.field.irr,
+			deliveryModes[reg_redir_low.field.deliveryMode],
+			reg_redir_low.field.destMode ? "Set: " : "ID: ",
+			reg_redir_high.field.destination);
 	}
 	printk("\n");
 }
-- 
1.6.5.2

