From 894b3abbb34bf039d83e2710870a7e49f03a7180 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Fri, 23 Oct 2009 16:35:46 +0800
Subject: [PATCH 2/2] Replace some direct access to VB_CONFIG with VBI 2.0 calls

Use VBI 2.0 calls to access VB_CONFIG instead of direct access,
except the someone before calling vbiInit and which don't have
matched VBI.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/powerpc/kernel/vbi/util.c            |    5 +++--
 arch/powerpc/platforms/85xx/wrhv_8572ds.c |    2 +-
 2 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/util.c b/arch/powerpc/kernel/vbi/util.c
index 08db41d..5bccef5 100644
--- a/arch/powerpc/kernel/vbi/util.c
+++ b/arch/powerpc/kernel/vbi/util.c
@@ -25,6 +25,7 @@ para-virtualize linux, therefore, may need some tweaks to be generic.
 #include <vbi/interface.h>
 #include <vbi/vmmu.h>
 #include <vbi/syscall.h>
+#include <vbi/vbi.h>
 
 
 /* defines */
@@ -57,14 +58,14 @@ unsigned int vb_memsize_get(void)
 		return 0;
 	}
 
-	return (((VB_CONFIG *) wrhvConfig)->physicalMemorySize);
+	return VBI_MEM_SIZE_GET();
 }
 
 unsigned int vb_context_get(void)
 {
 	if ((VB_CONFIG *) - 1 == wrhvConfig)
 		return 0xdeadbee0;
-	return (((VB_CONFIG *) wrhvConfig)->pid);
+	return VBI_CONTEXT_ID_GET();
 }
 
 void vb_pte_set(void *pPte, unsigned long paddr, int protval)
diff --git a/arch/powerpc/platforms/85xx/wrhv_8572ds.c b/arch/powerpc/platforms/85xx/wrhv_8572ds.c
index dcd8e28..ba82143 100644
--- a/arch/powerpc/platforms/85xx/wrhv_8572ds.c
+++ b/arch/powerpc/platforms/85xx/wrhv_8572ds.c
@@ -155,7 +155,7 @@ static int __init wrhv_8572ds_probe(void)
 	wrhv_mapping(); /* Map VB_CONFIG structure */
 	vbiInit(wrhvConfig);
 
-	strncpy(cmd_line, wrhvConfig->bootLine, VB_MAX_BOOTLINE_LENGTH - 1);
+	strncpy(cmd_line, VBI_BOOTLINE_ADDR_GET(), VB_MAX_BOOTLINE_LENGTH - 1);
 	cmd_line[VB_MAX_BOOTLINE_LENGTH - 1] = 0;
 
 	/* Save command line for /proc/cmdline */
-- 
1.6.5.rc3

