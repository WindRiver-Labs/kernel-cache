From 2480ecf9e72c72053fb4582945f679d148fd9254 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Mon, 12 Oct 2009 10:14:35 +0800
Subject: [PATCH 2/3] Add CONFIG_WRHV macro to protect the code in boot dir

Set console_ops.edit_cmdline to NULL and add CONFIG_WRHV macro
in boot/Makefile to protect it and other fix in boot dir.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/powerpc/boot/Makefile |    4 ++++
 arch/powerpc/boot/main.c   |    2 --
 arch/powerpc/boot/serial.c |    4 ++++
 3 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/boot/Makefile b/arch/powerpc/boot/Makefile
index a467985..d25fc85 100644
--- a/arch/powerpc/boot/Makefile
+++ b/arch/powerpc/boot/Makefile
@@ -29,6 +29,10 @@ ifdef CONFIG_DEBUG_INFO
 BOOTCFLAGS	+= -g
 endif
 
+ifdef CONFIG_WRHV
+BOOTCFLAGS     += -DCONFIG_WRHV
+endif
+
 ifeq ($(call cc-option-yn, -fstack-protector),y)
 BOOTCFLAGS	+= -fno-stack-protector
 endif
diff --git a/arch/powerpc/boot/main.c b/arch/powerpc/boot/main.c
index 754b77e..1ad38e4 100644
--- a/arch/powerpc/boot/main.c
+++ b/arch/powerpc/boot/main.c
@@ -139,10 +139,8 @@ static void prep_cmdline(void *chosen)
 
 	printf("\n\rLinux/PowerPC load: %s", cmdline);
 	/* If possible, edit the command line */
-#ifndef CONFIG_WRHV
 	if (console_ops.edit_cmdline)
 		console_ops.edit_cmdline(cmdline, COMMAND_LINE_SIZE);
-#endif
 	printf("\n\r");
 
 	/* Put the command line back into the devtree for the kernel */
diff --git a/arch/powerpc/boot/serial.c b/arch/powerpc/boot/serial.c
index 8b3607c..6738cd8 100644
--- a/arch/powerpc/boot/serial.c
+++ b/arch/powerpc/boot/serial.c
@@ -141,7 +141,11 @@ int serial_console_init(void)
 		console_ops.data = &serial_cd;
 
 		if (serial_cd.getc)
+#ifdef CONFIG_WRHV
+			console_ops.edit_cmdline = NULL;
+#else	
 			console_ops.edit_cmdline = serial_edit_cmdline;
+#endif
 
 		return 0;
 	}
-- 
1.6.3.3

