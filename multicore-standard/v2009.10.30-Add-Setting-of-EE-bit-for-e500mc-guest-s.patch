From 0546bdf610c2089afb523fe6ac779b6c4a93e95e Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Thu, 5 Nov 2009 20:11:16 -0500
Subject: [PATCH 15/22] v2009.10.30: Add Setting of EE bit for e500mc guest state

Integrate Halloween update

[cf: 02m,26oct09,dtr  Add Setting of EE bit for VT_MODE]

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
---
 arch/powerpc/kernel/vbi/syscalls.S |    8 +++++++-
 1 files changed, 7 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/syscalls.S b/arch/powerpc/kernel/vbi/syscalls.S
index 2a998f9..80fcf8e 100644
--- a/arch/powerpc/kernel/vbi/syscalls.S
+++ b/arch/powerpc/kernel/vbi/syscalls.S
@@ -1,7 +1,7 @@
 /*
  * syscalls.s - hypervisor system calls
  *
- * Copyright (c) 2007-2008 Wind River Systems, Inc.
+ * Copyright (c) 2007-2009 Wind River Systems, Inc.
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 as
@@ -412,6 +412,9 @@ FUNC_LABEL(vbiIntVCoreUnlock)
 	lis	p0, HIADJ(wrhvVbControl)
 	lwz	p0, LO(wrhvVbControl)(p0)
 	li	p1, 0
+#ifdef CONFIG_PPC85xx_VT_MODE
+	writeei	1
+#endif
 	stw	p1, VB_CONTROL_INT_DISABLE(p0)
 
 tryAgain:
@@ -442,6 +445,9 @@ FUNC_END(vbiIntVCoreUnlock)
  */
 FUNC_LABEL(vbiIntVCoreLock)
 	li	p1, -1
+#ifdef CONFIG_PPC85xx_VT_MODE
+	writeei	0
+#endif
 	lis	p2, HIADJ(wrhvVbControl)
 	lwz	p2, LO(wrhvVbControl)(p2)
 	lwz	p0, VB_CONTROL_INT_DISABLE(p2)
-- 
1.6.5.2

