From 59ef4a4acd7b0c6872ac060d15eda2237a673437 Mon Sep 17 00:00:00 2001
From: Liang Li <liang.li@windriver.com>
Date: Tue, 10 Nov 2009 01:22:23 -0800
Subject: [PATCH 49/59] x86: Fix hardcoded offset for startup code

The hardcoded offsets for coreId and bootLine in vb_config are
fragile, it is better to calculate the offset at build time so
that possible further modification to wrhv_config will alert us
at compile time but not hurt us silently.

Signed-off-by: Liang Li <liang.li@windriver.com>
---
 arch/x86/kernel/asm-offsets_32.c |    3 +++
 arch/x86/kernel/head_32.S        |    7 +------
 2 files changed, 4 insertions(+), 6 deletions(-)

diff --git a/arch/x86/kernel/asm-offsets_32.c b/arch/x86/kernel/asm-offsets_32.c
index f630804..3ffc69b 100644
--- a/arch/x86/kernel/asm-offsets_32.c
+++ b/arch/x86/kernel/asm-offsets_32.c
@@ -123,6 +123,9 @@ void foo(void)
 #ifdef CONFIG_WRHV
 	BLANK();
 	DEFINE(WRHV_VB_CONFIG_SIZE, sizeof(struct vb_config));
+	DEFINE(VB_MAX_BOOTLINE_LENGTH, VB_MAX_BOOTLINE_LENGTH);
+	OFFSET(WRHV_COREID_OFFSET, vb_config, coreId);
+	OFFSET(WRHV_BOOTLINE_OFFSET, vb_config, bootLine);
 #endif
 
 #ifdef CONFIG_XEN
diff --git a/arch/x86/kernel/head_32.S b/arch/x86/kernel/head_32.S
index ef3cbed..5239ac8 100644
--- a/arch/x86/kernel/head_32.S
+++ b/arch/x86/kernel/head_32.S
@@ -19,11 +19,6 @@
 #include <asm/asm-offsets.h>
 #include <asm/setup.h>
 #include <asm/processor-flags.h>
-// #include <vbi/interface.h>
-
-#define WRHV_COREID_OFFSET	0x98
-#define VB_MAX_BOOTLINE_LENGTH   256
-#define VB_CONFIG_BOOTLINE_OFFSET       0xdc
 
 /* Physical address */
 #define pa(X) ((X) - __PAGE_OFFSET)
@@ -195,7 +190,7 @@ num_subarch_entries = (. - subarch_entries) / 4
 	movsl
 
 	/* Fill in the boot command line */
-	movl $pa(__wr_config + VB_CONFIG_BOOTLINE_OFFSET), %esi
+	movl $pa(__wr_config + WRHV_BOOTLINE_OFFSET), %esi
 	movl $pa(boot_command_line),%edi
 	movl $(VB_MAX_BOOTLINE_LENGTH/4),%ecx
 	rep
-- 
1.6.5.2

