From 1216879eaac158021fbbb2663f4b3223d99f2e92 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Tue, 15 Dec 2009 18:04:13 -0800
Subject: [PATCH 1/4] earlconsole: support earlyconsole in xml file

This patch intended to support early console definition
in cmdline from wrhv xml file, and avoid early uart msg
tangle in kernel boot process.

Signed-off-by: Zumeng.chen <zumeng.chen@windriver.com>
Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 arch/powerpc/include/asm/machdep.h        |    4 ++++
 arch/powerpc/include/asm/wrhv.h           |    1 +
 arch/powerpc/kernel/legacy_serial.c       |    7 +++++++
 arch/powerpc/kernel/setup_32.c            |    6 ++++++
 arch/powerpc/kernel/vbi/wrhv.c            |   19 +++++++++++++++++++
 arch/powerpc/platforms/85xx/wrhv_8572ds.c |    1 +
 6 files changed, 38 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/machdep.h b/arch/powerpc/include/asm/machdep.h
index 23c21d2..7fc9cdd 100644
--- a/arch/powerpc/include/asm/machdep.h
+++ b/arch/powerpc/include/asm/machdep.h
@@ -261,6 +261,10 @@ struct machdep_calls {
 	void (*suspend_disable_irqs)(void);
 	void (*suspend_enable_irqs)(void);
 #endif
+
+#ifdef CONFIG_VIRTUALIZATION
+	int (*earlycon_setup)(void);
+#endif
 };
 
 extern void e500_idle(void);
diff --git a/arch/powerpc/include/asm/wrhv.h b/arch/powerpc/include/asm/wrhv.h
index 48a8ab2..6495671 100644
--- a/arch/powerpc/include/asm/wrhv.h
+++ b/arch/powerpc/include/asm/wrhv.h
@@ -24,6 +24,7 @@ extern unsigned int wrhv_vioapic_get_irq(void);
 extern void wrhv_init_irq(void);
 extern void __init wrhv_calibrate_decr(void);
 extern void __init wrhv_time_init(void);
+extern int __init wrhv_earlycon_setup(void);
 #ifdef CONFIG_PCI
 extern int fsl8572_get_pci_intr_wrhv(struct pci_dev *dev);
 #endif
diff --git a/arch/powerpc/kernel/legacy_serial.c b/arch/powerpc/kernel/legacy_serial.c
index 9ddfaef..946a6e7 100644
--- a/arch/powerpc/kernel/legacy_serial.c
+++ b/arch/powerpc/kernel/legacy_serial.c
@@ -23,6 +23,9 @@
 
 #define MAX_LEGACY_SERIAL_PORTS	8
 
+#ifdef CONFIG_WRHV
+extern int wrhv_earlycon;
+#endif
 static struct plat_serial8250_port
 legacy_serial_ports[MAX_LEGACY_SERIAL_PORTS+1];
 static struct legacy_serial_info {
@@ -379,6 +382,10 @@ void __init find_legacy_serial_ports(void)
 	}
 #endif
 
+#ifdef CONFIG_WRHV
+	if(wrhv_earlycon != -1 && wrhv_earlycon < MAX_LEGACY_SERIAL_PORTS)
+		legacy_serial_console = wrhv_earlycon;
+#endif
 	DBG("legacy_serial_console = %d\n", legacy_serial_console);
 	if (legacy_serial_console >= 0)
 		setup_legacy_serial_console(legacy_serial_console);
diff --git a/arch/powerpc/kernel/setup_32.c b/arch/powerpc/kernel/setup_32.c
index 63926de..ff98b08 100644
--- a/arch/powerpc/kernel/setup_32.c
+++ b/arch/powerpc/kernel/setup_32.c
@@ -289,6 +289,7 @@ static void __init exc_lvl_early_init(void)
 #define exc_lvl_early_init()
 #endif
 
+
 /* Warning, IO base is not yet inited */
 void __init setup_arch(char **cmdline_p)
 {
@@ -303,6 +304,11 @@ void __init setup_arch(char **cmdline_p)
 	if (ppc_md.init_early)
 		ppc_md.init_early();
 
+	/* give an opporunity for special legacy serial or
+	   other setup to be run */
+	if (ppc_md.earlycon_setup)
+		ppc_md.earlycon_setup();
+
 	find_legacy_serial_ports();
 
 	smp_setup_cpu_maps();
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index f489f65..5b9ccc9 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -141,9 +141,28 @@ extern struct hwtimer powerpc_timer;
 
 unsigned long wrhv_cpu_freq = 0;
 
+int wrhv_earlycon = -1;
 int wrhv_pci_devfn = -1;
 char wrhv_macaddr[6];
 
+#define WRHV_EARLYCON_SIZE  14  /* sizeof("wrhv_earlycon=") */
+int __init wrhv_earlycon_setup(void)
+{
+	char *p = NULL;
+
+	if((p=strstr(cmd_line, "wrhv_earlycon=")) != NULL){
+	/* Since the maximal number supported of serial port is 8
+	 * in legacy serial, so here we just use this convention
+	 */
+		wrhv_earlycon =  p[WRHV_EARLYCON_SIZE] - 0x30;
+		printk(KERN_INFO "WRHV: early serial output port is at %d\n",
+			wrhv_earlycon);
+		return 1;
+	}
+
+	return 0;
+}
+
 static int __init wrhv_pci_devfn_setup(char *s)
 {
 	wrhv_pci_devfn = simple_strtoul(s, NULL, 0);
diff --git a/arch/powerpc/platforms/85xx/wrhv_8572ds.c b/arch/powerpc/platforms/85xx/wrhv_8572ds.c
index 01aeb1c..7e93a85 100644
--- a/arch/powerpc/platforms/85xx/wrhv_8572ds.c
+++ b/arch/powerpc/platforms/85xx/wrhv_8572ds.c
@@ -194,4 +194,5 @@ define_machine(wrhv_8572ds) {
 	.progress = udbg_progress,
 	.power_save = wrhv_power_save,
 	.restart = wrhv_restart,
+	.earlycon_setup = wrhv_earlycon_setup,
 };
-- 
1.6.5.2

