From 1ed4fb112c7ca27eac8f21274b8d6d7bd0599669 Mon Sep 17 00:00:00 2001
From: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
Date: Thu, 18 Mar 2010 18:35:21 -0400
Subject: [PATCH] MILS: remove hard coded cpuinfo values

Now that the SK has matured there is no longer a need to hard
code values that get passed via the wr_config entry.

Previously /proc/cpuinfo did not yield accurate values.

Updates:
  -removed hard coded CPU freq given that the C-HV does not display
   this value for the 8572
  -remove hard coded loops per jiffy and let the kernel calculate this
   directly.
  -wrhv cpu frequency is calculated based on section 9.1 & 9.3 of
   the e500v2 reference manual.

Signed-off-by: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
---
 arch/powerpc/platforms/85xx/wrhv_sbc8548.c |   13 +++++--------
 1 files changed, 5 insertions(+), 8 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/wrhv_sbc8548.c b/arch/powerpc/platforms/85xx/wrhv_sbc8548.c
index 250cab1..52d6c08 100644
--- a/arch/powerpc/platforms/85xx/wrhv_sbc8548.c
+++ b/arch/powerpc/platforms/85xx/wrhv_sbc8548.c
@@ -48,10 +48,7 @@
 
 #include <sysdev/fsl_soc.h>
 #include <sysdev/fsl_pci.h>
-#define CPU_FREQ 33333333 /* WRHV CPU frequency */
-#define PROC_FREQ 50000000 /* CPU Freq */
-#define PROC_DIV 16  /* Time base divisor */
-#define LOOP_PER_JIF 2662400 /* Loops per jiffy */
+#define STAMP_FACTOR 8 /* See e500 reference manual (E500CORERM) section 9.3 */
 
 extern struct vb_config *wr_config;
 extern struct vb_status *wr_status;
@@ -59,10 +56,10 @@ extern struct vb_control *wr_control;
 
 static void __init wrhv_sbc8548_setup_freq(void)
 {
-	wrhv_cpu_freq = CPU_FREQ;
-	ppc_proc_freq = PROC_FREQ;
-	ppc_tb_freq = ppc_proc_freq / PROC_DIV;
-	loops_per_jiffy = LOOP_PER_JIF;
+	/* The cpu updates the Time Base every 8 CCB (Core Complex Bus)
+	 cycles.  According to section 9.1 of the core e500 reference manual
+	 the maximum value cannot exceed that of 1/8 the core frequency */
+	wrhv_cpu_freq = wr_config->stamp_freq * STAMP_FACTOR;
 }
 
 static void __init wrhv_sbc8548_map_config(void)
-- 
1.6.5.2

