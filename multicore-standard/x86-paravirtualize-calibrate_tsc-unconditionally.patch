From 2268cdab0b71532f72d60135fac9cb44905fabff Mon Sep 17 00:00:00 2001
From: Liang Li <liang.li@windriver.com>
Date: Thu, 28 Jan 2010 00:57:24 -0800
Subject: [PATCH] x86: paravirtualize calibrate_tsc unconditionally

We should paravirtualize calibrate_tsc when running on wrhv, no
matter hrtimer or pit timer is enabled or not.

When running guest OS on atom z530, the cpu is not as fast as
cpus on supermicro/nehalem. The native_calibrate_tsc often
failed. After calibrate_tsc fails, tsc will not be available
time source then it will fail to switch to HRTIMER mode at
runtime.

Signed-off-by: Liang Li <liang.li@windriver.com>
---
 arch/x86/kernel/vbi/wrhv.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/arch/x86/kernel/vbi/wrhv.c b/arch/x86/kernel/vbi/wrhv.c
index 432df57..9c901ae 100644
--- a/arch/x86/kernel/vbi/wrhv.c
+++ b/arch/x86/kernel/vbi/wrhv.c
@@ -1223,7 +1223,6 @@ void __init wrhv_setup_timer_irq(void)
 	if (irq == VBI_INVALID_IRQ) {
 		enable_hrtimer = 0;
 		pv_time_ops.time_init = wrhv_time_init;
-		pv_time_ops.get_tsc_khz = wrhv_calculate_cpu_khz;
 		printk(KERN_INFO "WRHV: HRTIMER is NOT present.\n");
 	} else {
 		enable_hrtimer = 1;
@@ -1234,9 +1233,10 @@ void __init wrhv_setup_timer_irq(void)
 #else
 	enable_hrtimer = 0;
 	pv_time_ops.time_init = wrhv_time_init;
-	pv_time_ops.get_tsc_khz = wrhv_calculate_cpu_khz;
 #endif
 
+	pv_time_ops.get_tsc_khz = wrhv_calculate_cpu_khz;
+
 #ifdef CONFIG_X86_LOCAL_APIC
 	pv_apic_ops.setup_boot_clock = wrhv_setup_boot_clock;
 	pv_apic_ops.setup_secondary_clock = wrhv_setup_secondary_clock;
-- 
1.6.5.2

