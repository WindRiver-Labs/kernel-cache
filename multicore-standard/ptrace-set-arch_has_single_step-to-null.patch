From 2563dd1801e844d423f06025cfb1011d979c1620 Mon Sep 17 00:00:00 2001
From: Thomas Tai <thomas.tai@windriver.com>
Date: Thu, 29 Oct 2009 13:24:14 -0700
Subject: [PATCH] ptrace: set arch_has_single_step to null

When running usermode-agent -V, failed at PTRACE_SINGLESTEP.
Refer to wrlinux 2.0 hypervisor implementation and
found PTRACE_SINGLESTEP should be handled by default case
statement. Add CONFIG_PARAVIRT in arch/powerpc/include/asm/ptrace.h

revert changes from kernel/ptrace.c because it is common to all
arch.

Signed-off-by: Thomas Tai <thomas.tai@windriver.com>
---
 arch/powerpc/include/asm/ptrace.h |    5 +++++
 kernel/ptrace.c                   |    2 --
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/include/asm/ptrace.h b/arch/powerpc/include/asm/ptrace.h
index 734e075..172c5fb 100644
--- a/arch/powerpc/include/asm/ptrace.h
+++ b/arch/powerpc/include/asm/ptrace.h
@@ -136,7 +136,12 @@ do {									      \
 /*
  * These are defined as per linux/ptrace.h, which see.
  */
+#ifndef CONFIG_PARAVIRT
 #define arch_has_single_step()	(1)
+#else
+#define arch_has_single_step()	(0)
+#endif
+
 extern void user_enable_single_step(struct task_struct *);
 extern void user_disable_single_step(struct task_struct *);
 
diff --git a/kernel/ptrace.c b/kernel/ptrace.c
index af2c195..6df2df5 100644
--- a/kernel/ptrace.c
+++ b/kernel/ptrace.c
@@ -445,11 +445,9 @@ int ptrace_request(struct task_struct *child, long request,
 		ret = ptrace_detach(child, data);
 		break;
 
-#ifndef CONFIG_PARAVIRT
 #ifdef PTRACE_SINGLESTEP
 	case PTRACE_SINGLESTEP:
 #endif
-#endif
 
 #ifdef PTRACE_SINGLEBLOCK
 	case PTRACE_SINGLEBLOCK:
-- 
1.6.5.2

