From b917cac18076cb671421033c3cca66a6ce6d18cd Mon Sep 17 00:00:00 2001
From: Thomas Tai <thomas.tai@windriver.com>
Date: Tue, 27 Oct 2009 15:57:06 -0400
Subject: [PATCH] paravirtualize ppc_proc_freq function

instead of using CONFIG_WRHV in header file,
paravirtualize the inline function and add implementation
in wrhv.c

Signed-off-by: Thomas Tai <thomas.tai@windriver.com>
---
 arch/powerpc/include/asm/fs_pd.h    |   12 ++++++++++--
 arch/powerpc/include/asm/paravirt.h |    1 +
 arch/powerpc/kernel/paravirt.c      |    8 ++++++++
 arch/powerpc/kernel/vbi/wrhv.c      |    6 ++++++
 4 files changed, 25 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/include/asm/fs_pd.h b/arch/powerpc/include/asm/fs_pd.h
index 876d862..9df3b12 100644
--- a/arch/powerpc/include/asm/fs_pd.h
+++ b/arch/powerpc/include/asm/fs_pd.h
@@ -42,10 +42,18 @@ static inline int uart_baudrate(void)
         return get_baudrate();
 }
 
+#ifdef CONFIG_PARAVIRT
+extern int paravirt_ppc_proc_freq(void);
+static inline int native_ppc_proc_freq(void)
+{
+	return ppc_proc_freq;
+}
+#endif
+
 static inline int uart_clock(void)
 {
-#ifdef CONFIG_WRHV
-	return wrhv_cpu_freq;
+#ifdef CONFIG_PARAVIRT
+	return paravirt_ppc_proc_freq();
 #else
         return ppc_proc_freq;
 #endif
diff --git a/arch/powerpc/include/asm/paravirt.h b/arch/powerpc/include/asm/paravirt.h
index 826ce48..0934d05 100644
--- a/arch/powerpc/include/asm/paravirt.h
+++ b/arch/powerpc/include/asm/paravirt.h
@@ -53,6 +53,7 @@ struct pv_cpu_ops {
 	int (*kgdb_arch_handle_exception)(int vector, int signo, int err_code,
                                char *remcom_in_buffer, char *remcom_out_buffer,
                                struct pt_regs *linux_regs);
+	int (*ppc_proc_freq)(void);
 };
 
 #ifdef CONFIG_PCI
diff --git a/arch/powerpc/kernel/paravirt.c b/arch/powerpc/kernel/paravirt.c
index e8e57ba..2959a5e 100644
--- a/arch/powerpc/kernel/paravirt.c
+++ b/arch/powerpc/kernel/paravirt.c
@@ -35,6 +35,7 @@
 #include <asm/fixmap.h>
 #include <asm/tlbflush.h>
 #include <asm/machdep.h>
+#include <asm/fs_pd.h>
 
 #include <linux/kernel.h>
 #include <linux/string.h>
@@ -130,6 +131,7 @@ struct pv_cpu_ops pv_cpu_ops = {
 	.gfar_of_init = native_gfar_of_init,
 	.DebugException = native_DebugException,
 	.kgdb_arch_handle_exception = native_kgdb_arch_handle_exception,
+	.ppc_proc_freq = native_ppc_proc_freq,
 };
 
 struct pv_mmu_ops pv_mmu_ops = {
@@ -200,6 +202,12 @@ int paravirt_kgdb_arch_handle_exception(int vector, int signo, int err_code,
 			remcom_in_buffer, remcom_out_buffer, linux_regs);
 }
 
+
+int paravirt_ppc_proc_freq(void)
+{
+	return pv_cpu_ops.ppc_proc_freq();
+}
+
 /* pv_mmu_ops */
 void paravirt_vmmu_restore (void)
 {
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index c43fe3b..c7b9d93 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -898,6 +898,10 @@ int wrhv_kgdb_arch_handle_exception(int vector, int signo, int err_code,
         return -1;
 }
 
+int wrhv_ppc_cpu_freq(void)
+{
+	return wrhv_cpu_freq;
+}
 
 void wrhv_init(void)
 {
@@ -925,6 +929,8 @@ void wrhv_init(void)
         pv_cpu_ops.DebugException = wrhv_DebugException;
         pv_cpu_ops.kgdb_arch_handle_exception = 
                 wrhv_kgdb_arch_handle_exception;
+	pv_cpu_ops.ppc_proc_freq =
+		wrhv_ppc_cpu_freq;
 
 	pv_mmu_ops.vmmu_restore = wrhv_vmmu_restore;
         pv_mmu_ops.MMU_init_hw = wrhv_MMU_init_hw;
-- 
1.6.5.2

