From 8ede12f04be47b25b2d55f2b4099dc673fd1dcb8 Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Thu, 3 Dec 2009 22:19:45 -0800
Subject: [PATCH] kgdb/powerpc: fix bug when kgdb single stepping

Besides enable hypervisor emulated MSR's debug enable bit, we should
also enable the bit saved in linux_regs. Otherwise single stepping
doesn't work well.

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 arch/powerpc/kernel/vbi/wrhv.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index fbe5e44..2f8739b 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -941,6 +941,7 @@ int wrhv_kgdb_arch_handle_exception(int vector, int signo, int err_code,
 			 * is restored on return from exception
 			 */
 			wr_control->vb_control_regs.emsr |= MSR_DE;
+			linux_regs->msr |= MSR_DE;
 #else
 			linux_regs->msr |= MSR_SE;
 #endif
-- 
1.6.5.2

