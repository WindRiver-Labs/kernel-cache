From 177fee9bdd49562d40b9167953bca253b2324c96 Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Thu, 19 Nov 2009 20:08:44 -0800
Subject: [PATCH] x86: enable_hrtimer & CONFIG_WRHV_X86_HRTIMERS dependency fix

The setup of enable_hrtimer should not only depends on hypervisor
xml file, but also kernel option CONFIG_WRHV_X86_HRTIMERS. so add
CONFIG_WRHV_X86_HRTIMERS restriction.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/x86/kernel/vbi/wrhv.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/x86/kernel/vbi/wrhv.c b/arch/x86/kernel/vbi/wrhv.c
index 9c59bd6..3ad542f 100644
--- a/arch/x86/kernel/vbi/wrhv.c
+++ b/arch/x86/kernel/vbi/wrhv.c
@@ -1255,6 +1255,7 @@ void wrhv_restart(void)
 
 void __init wrhv_setup_timer_irq(void)
 {
+#ifdef CONFIG_WRHV_X86_HRTIMERS
 	int irq;
 	irq = vbiIntVecFind(HRTIMER_IRQ_NAME, 1);
 	if (irq == VBI_INVALID_IRQ) {
@@ -1266,6 +1267,11 @@ void __init wrhv_setup_timer_irq(void)
 		enable_hrtimer = 1;
 		printk(KERN_INFO "WRHV: HRTIMER is present.\n");
 	}
+#else
+	enable_hrtimer = 0;
+	pv_time_ops.time_init = wrhv_time_init;
+	pv_time_ops.get_tsc_khz = wrhv_calculate_cpu_khz;
+#endif
 
 #ifdef CONFIG_X86_LOCAL_APIC
 	pv_apic_ops.setup_boot_clock = wrhv_setup_boot_clock;
-- 
1.6.5.2

