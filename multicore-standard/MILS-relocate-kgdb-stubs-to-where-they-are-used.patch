From 56134d837c7c079cff2fc78aad54a9a53b953bfd Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Fri, 5 Mar 2010 16:58:16 -0500
Subject: [PATCH] MILS: relocate kgdb stubs to where they are used.

These are specific to one file only, so lets just
put them where they are used.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
---
 arch/powerpc/include/asm/arch_vbi.h |   30 ----------------
 arch/powerpc/kernel/vbi/wrhv.c      |   65 +++++++++++++++++++++++++++++++++-
 include/vbi/vdk_interface.h         |   29 ---------------
 3 files changed, 63 insertions(+), 61 deletions(-)

diff --git a/arch/powerpc/include/asm/arch_vbi.h b/arch/powerpc/include/asm/arch_vbi.h
index 9a86b88..df58d0a 100644
--- a/arch/powerpc/include/asm/arch_vbi.h
+++ b/arch/powerpc/include/asm/arch_vbi.h
@@ -661,35 +661,5 @@ endIntVcoreLock:
 
 #endif /*_ASMLANGUAGE */
 
-static inline uint32_t get_emsr(void)
-{
-	return VBI_CNTRL_ADDR_GET()->vb_control_regs.emsr;
-}
-
-static inline uint32_t get_dbsr(void)
-{
-	return VBI_CNTRL_ADDR_GET()->vb_control_regs.dbsr;
-}
-
-static inline uint32_t get_dbcr(void)
-{
-	return VBI_CNTRL_ADDR_GET()->vb_control_regs.dbcr0;
-}
-
-static inline void put_emsr(uint32_t reg)
-{
-	VBI_CNTRL_ADDR_GET()->vb_control_regs.emsr = reg;
-}
-
-static inline void put_dbsr(uint32_t reg)
-{
-	VBI_CNTRL_ADDR_GET()->vb_control_regs.dbsr = reg;
-}
-
-static inline void put_dbcr(uint32_t reg)
-{
-	VBI_CNTRL_ADDR_GET()->vb_control_regs.dbcr0 = reg;
-}
-
 #endif /* _ASM_ARCH_VBI_H */
 #endif /* WRHV_MILS */
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 9756749..3fab15c 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -109,8 +109,6 @@
 #include <asm/processor.h>
 
 #include <asm/paravirt.h>
-#include <asm/arch_vbi.h>
-
 
 /* powerpc clocksource/clockevent code */
 #define HWTIMER_USE_JIFFY 1
@@ -147,6 +145,69 @@ int wrhv_earlycon = -1;
 int wrhv_pci_devfn = -1;
 char wrhv_macaddr[6];
 
+#ifdef CONFIG_WRHV_MILS
+static inline uint32_t get_emsr(void)
+{
+	return 0;
+}
+
+static inline uint32_t get_dbsr(void)
+{
+	return 0;
+}
+
+static inline uint32_t get_dbcr(void)
+{
+	return 0;
+}
+
+static inline void put_emsr(uint32_t reg)
+{
+	return;
+}
+
+static inline void put_dbsr(uint32_t reg)
+{
+	return;
+}
+
+static inline void put_dbcr(uint32_t reg)
+{
+	return;
+}
+#else	/* !MILS */
+static inline uint32_t get_emsr(void)
+{
+	return VBI_CNTRL_ADDR_GET()->vb_control_regs.emsr;
+}
+
+static inline uint32_t get_dbsr(void)
+{
+	return VBI_CNTRL_ADDR_GET()->vb_control_regs.dbsr;
+}
+
+static inline uint32_t get_dbcr(void)
+{
+	return VBI_CNTRL_ADDR_GET()->vb_control_regs.dbcr0;
+}
+
+static inline void put_emsr(uint32_t reg)
+{
+	VBI_CNTRL_ADDR_GET()->vb_control_regs.emsr = reg;
+}
+
+static inline void put_dbsr(uint32_t reg)
+{
+	VBI_CNTRL_ADDR_GET()->vb_control_regs.dbsr = reg;
+}
+
+static inline void put_dbcr(uint32_t reg)
+{
+	VBI_CNTRL_ADDR_GET()->vb_control_regs.dbcr0 = reg;
+}
+#endif /* CONFIG_WRHV_MILS */
+
+
 #define WRHV_EARLYCON_SIZE  14  /* sizeof("wrhv_earlycon=") */
 int __init wrhv_earlycon_setup(void)
 {
diff --git a/include/vbi/vdk_interface.h b/include/vbi/vdk_interface.h
index 33cfcfd..82e9490 100644
--- a/include/vbi/vdk_interface.h
+++ b/include/vbi/vdk_interface.h
@@ -614,35 +614,6 @@ static inline int32_t vbi_vb_reset(uint32_t id, int32_t core, uint32_t options)
 	return -1;
 }
 
-static inline uint32_t get_emsr(void)
-{
-	return 0;
-}
-
-static inline uint32_t get_dbsr(void)
-{
-	return 0;
-}
-
-static inline uint32_t get_dbcr(void)
-{
-	return 0;
-}
-
-static inline void put_emsr(uint32_t reg)
-{
-	return;
-}
-
-static inline void put_dbsr(uint32_t reg)
-{
-	return;
-}
-
-static inline void put_dbcr(uint32_t reg)
-{
-	return;
-}
 #endif /*_ASMLANGUAGE */
 #endif  /* _VDK_INTERFACE_H */
 
-- 
1.7.0

