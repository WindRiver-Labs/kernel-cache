From e3d903f1b9be6a10322b754ee4921af39af04696 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Thu, 22 Jan 2009 14:42:19 +0800
Subject: [PATCH] arm: clear previous VFP condition flags before set new ones

Clear the previous VFP condition flags before we set the new ones
for the soft float emulation. Otherwise we may get a error condition
flags combination.

Previously there was a such operation at this place, but it was
removed by commit c98929c07a01c9ec2e1e5253456acc7168da8b66. Restoring
this operation elimiates the regression.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/arm/vfp/vfpmodule.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/arch/arm/vfp/vfpmodule.c b/arch/arm/vfp/vfpmodule.c
index fed7421..1c37e05 100644
--- a/arch/arm/vfp/vfpmodule.c
+++ b/arch/arm/vfp/vfpmodule.c
@@ -157,6 +157,9 @@ static void vfp_raise_exceptions(u32 exceptions, u32 inst, u32 fpscr, struct pt_
 	 * Comparison instructions always return at least one of
 	 * these flags set.
 	 */
+	if (exceptions & (FPSCR_N|FPSCR_Z|FPSCR_C|FPSCR_V))
+		fpscr &= ~(FPSCR_N|FPSCR_Z|FPSCR_C|FPSCR_V);
+
 	fpscr |= exceptions;
 
 	fmxr(FPSCR, fpscr);
-- 
1.6.0.3

