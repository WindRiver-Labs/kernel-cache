From 233aa2f04096f2cbcaa8a5f41a410034aecfafcb Mon Sep 17 00:00:00 2001
From: Tonyliu <Bo.Liu@windriver.com>
Date: Thu, 5 Nov 2009 17:53:29 +0800
Subject: [PATCH 7/9] PM: add suspend/resume for DaVinci i2c

I2C bus clock should be disable after on-bus chips disabled while suspending
and enabled before on-bus chips enabled while resuming.

Signed-off-by: Tonyliu <Bo.Liu@windriver.com>
---
 drivers/i2c/busses/i2c-davinci.c |   26 ++++++++++++++++++++++++++
 1 files changed, 26 insertions(+), 0 deletions(-)

diff --git a/drivers/i2c/busses/i2c-davinci.c b/drivers/i2c/busses/i2c-davinci.c
index 67d88cc..125d11b 100644
--- a/drivers/i2c/busses/i2c-davinci.c
+++ b/drivers/i2c/busses/i2c-davinci.c
@@ -626,12 +626,38 @@ static int davinci_i2c_remove(struct platform_device *pdev)
 	return 0;
 }
 
+#ifdef CONFIG_PM
+static int davinci_i2c_suspend_late(struct platform_device *pdev,
+		pm_message_t state)
+{
+	struct davinci_i2c_dev *dev = platform_get_drvdata(pdev);
+
+	clk_disable(dev->clk);
+
+	return 0;
+}
+
+static int davinci_i2c_resume_early(struct platform_device *pdev)
+{
+	struct davinci_i2c_dev *dev = platform_get_drvdata(pdev);
+
+	clk_enable(dev->clk);
+
+	return 0;
+}
+#else
+#define davinci_i2c_suspend_late    NULL
+#define davinci_i2c_resume_early    NULL
+#endif
+
 /* work with hotplug and coldplug */
 MODULE_ALIAS("platform:i2c_davinci");
 
 static struct platform_driver davinci_i2c_driver = {
 	.probe		= davinci_i2c_probe,
 	.remove		= davinci_i2c_remove,
+	.suspend_late = davinci_i2c_suspend_late,
+	.resume_early = davinci_i2c_resume_early,
 	.driver		= {
 		.name	= "i2c_davinci",
 		.owner	= THIS_MODULE,
-- 
1.6.5.2

