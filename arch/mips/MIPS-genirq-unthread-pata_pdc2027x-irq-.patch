From c5b8d0dcbb068405c207582841c7b4b7d628a8ea Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Tue, 22 Feb 2011 12:52:03 +0800
Subject: [PATCH 2/2] genirq: nlm_xlr_atx_64_be: unthread pata_pdc2027x irq handlers to avoid system hang

pata_pdc2027x irq handlers have been shown to not function correctly
when handled in threads. Add IRQF_NODELAY to prevent threading.

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 drivers/ata/pata_pdc2027x.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/drivers/ata/pata_pdc2027x.c b/drivers/ata/pata_pdc2027x.c
index ca5cad0..0116529 100644
--- a/drivers/ata/pata_pdc2027x.c
+++ b/drivers/ata/pata_pdc2027x.c
@@ -708,6 +708,7 @@ static int __devinit pdc2027x_init_one(struct pci_dev *pdev, const struct pci_de
 	struct ata_host *host;
 	void __iomem *mmio_base;
 	int i, rc;
+	unsigned long irq_flags = IRQF_SHARED;
 
 	if (!printed_version++)
 		dev_printk(KERN_DEBUG, &pdev->dev, "version " DRV_VERSION "\n");
@@ -754,8 +755,11 @@ static int __devinit pdc2027x_init_one(struct pci_dev *pdev, const struct pci_de
 		return -EIO;
 
 	pci_set_master(pdev);
+#if defined(CONFIG_PREEMPT_HARDIRQS) && defined(CONFIG_RMI_PHOENIX)
+	irq_flags |= IRQF_NODELAY;
+#endif
 	return ata_host_activate(host, pdev->irq, ata_sff_interrupt,
-				 IRQF_SHARED, &pdc2027x_sht);
+				 irq_flags, &pdc2027x_sht);
 }
 
 /**
-- 
1.7.0.4

