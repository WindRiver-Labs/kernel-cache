From fb660e377602a3ef48191c86d7e281f42ac14f26 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Tue, 10 May 2011 19:54:35 +0800
Subject: [PATCH 2/2] mips/malta: disable a break hardware trigger

Based on Malta hardware implementation the target would always reset once
receive a break signal. So we have to disable this to support SysRQ break
handler.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/mips/include/asm/mips-boards/generic.h |    6 ++++++
 arch/mips/mti-malta/malta-reset.c           |   14 ++++++++++++++
 2 files changed, 20 insertions(+), 0 deletions(-)

diff --git a/arch/mips/include/asm/mips-boards/generic.h b/arch/mips/include/asm/mips-boards/generic.h
index 46c0856..665acd4 100644
--- a/arch/mips/include/asm/mips-boards/generic.h
+++ b/arch/mips/include/asm/mips-boards/generic.h
@@ -44,6 +44,12 @@
 #define GORESET           0x42
 
 /*
+ * Break register.
+ */
+#define	BRKRES_REG	0x1f000508
+#define	STOP_BRK_SET	0x0
+
+/*
  * Revision register.
  */
 #define MIPS_REVISION_REG                  0x1fc00010
diff --git a/arch/mips/mti-malta/malta-reset.c b/arch/mips/mti-malta/malta-reset.c
index 3294205..95e87bb 100644
--- a/arch/mips/mti-malta/malta-reset.c
+++ b/arch/mips/mti-malta/malta-reset.c
@@ -56,3 +56,17 @@ static int __init mips_reboot_setup(void)
 }
 
 arch_initcall(mips_reboot_setup);
+
+#ifdef CONFIG_MAGIC_SYSRQ
+static int __init  mips_break_clear(void)
+{
+	unsigned int __iomem *softres_reg =
+		ioremap(BRKRES_REG, sizeof(unsigned int));
+	
+	__raw_writel(STOP_BRK_SET, softres_reg);
+	
+	return 0;
+}
+
+arch_initcall(mips_break_clear);
+#endif
-- 
1.7.0.4

