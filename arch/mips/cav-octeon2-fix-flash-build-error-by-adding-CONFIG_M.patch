From daa2d37eb9e9bab7c76fd001662b7e331d05f3a8 Mon Sep 17 00:00:00 2001
From: Zhang Ruibo <ruibo.zhang@windriver.com>
Date: Thu, 10 Jan 2013 14:01:05 +0800
Subject: [PATCH] cav-octeon2:fix flash build error by adding CONFIG_MTD flag

If CONFIG_MTD set to "m", the flash compile error will occur:

 arch/mips/built-in.o: In function `flash_init':
 linux/arch/mips/cavium-octeon/flash_setup.c:59:
 undefined reference to `do_map_probe'
 linux/arch/mips/cavium-octeon/flash_setup.c:62:
 undefined reference to `mtd_device_parse_register'
 make[2]: *** [.tmp_vmlinux1] Error 1

so modify flash build flag from "y" to "CONFIG_MTD".
all flash usage should depend on MTD subsystem.

Because symbol "mtd_device_parse_register" use EXPORT_SYMBOL_GPL
to export,so add MODULE_LICENSE("GPL") to flash_setup.c

Signed-off-by: Ruibo Zhang<ruibo.zhang@windriver.com>

diff --git a/arch/mips/cavium-octeon/Makefile b/arch/mips/cavium-octeon/Makefile
index 19eb043..4f69ff1 100644
--- a/arch/mips/cavium-octeon/Makefile
+++ b/arch/mips/cavium-octeon/Makefile
@@ -10,7 +10,8 @@
 #
 
 obj-y := cpu.o setup.o serial.o octeon-platform.o octeon-irq.o csrc-octeon.o
-obj-y += dma-octeon.o flash_setup.o
+obj-y += dma-octeon.o
+obj-$(CONFIG_MTD) += flash_setup.o
 obj-y += octeon-memcpy.o
 obj-y += executive/
 
diff --git a/arch/mips/cavium-octeon/flash_setup.c b/arch/mips/cavium-octeon/flash_setup.c
index e44a55b..2b747b6 100644
--- a/arch/mips/cavium-octeon/flash_setup.c
+++ b/arch/mips/cavium-octeon/flash_setup.c
@@ -7,6 +7,7 @@
  *
  * Copyright (C) 2007, 2008 Cavium Networks
  */
+#include <linux/module.h>
 #include <linux/kernel.h>
 #include <linux/export.h>
 #include <linux/mtd/mtd.h>
@@ -25,6 +26,8 @@ static const char *part_probe_types[] = {
 	NULL
 };
 
+MODULE_LICENSE("GPL");
+
 /**
  * Module/ driver initialization.
  *
-- 
1.8.3.1

