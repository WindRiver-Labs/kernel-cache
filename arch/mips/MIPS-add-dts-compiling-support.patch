From 1af84b2d4ed4a861fcb9b03d9c8ede536b5fc5e2 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Wed, 6 Apr 2011 15:49:56 +0800
Subject: [PATCH] MIPS: add dts compiling support

Allows to put the dts file to arch/mips/boot/dts/ and compile it with
the following command:

$ make <dts-file-name>.dtb

It is based on the powerpc implementation.

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/mips/Kconfig         |    3 +++
 arch/mips/Makefile        |    9 +++++++--
 arch/mips/boot/.gitignore |    1 +
 arch/mips/boot/Makefile   |   11 ++++++++++-
 4 files changed, 21 insertions(+), 3 deletions(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index 37af0df..8c7a5e1 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -2099,6 +2099,9 @@ config STACKTRACE_SUPPORT
 	bool
 	default y
 
+config DTC
+	def_bool y
+
 source "init/Kconfig"
 
 source "kernel/Kconfig.freezer"
diff --git a/arch/mips/Makefile b/arch/mips/Makefile
index 0b9c01a..72d7f07 100644
--- a/arch/mips/Makefile
+++ b/arch/mips/Makefile
@@ -733,8 +733,10 @@ vmlinux.32: vmlinux
 vmlinux.64: vmlinux
 	$(OBJCOPY) -O $(64bit-bfd) $(OBJCOPYFLAGS) $< $@
 
-makeboot =$(Q)$(MAKE) $(build)=arch/mips/boot VMLINUX=$(vmlinux-32) $(1)
-makezboot =$(Q)$(MAKE) $(build)=arch/mips/boot/compressed \
+boot := arch/$(ARCH)/boot
+
+makeboot =$(Q)$(MAKE) $(build)=$(boot) VMLINUX=$(vmlinux-32) $(1)
+makezboot =$(Q)$(MAKE) $(build)=$(boot)/compressed \
 	   VMLINUX_LOAD_ADDRESS=$(load-y) 32bit-bfd=$(32bit-bfd) $(1)
 
 all:	$(all-y)
@@ -760,6 +762,9 @@ vmlinux.ecoff: $(vmlinux-32)
 vmlinux.srec: $(vmlinux-32)
 	+@$(call makeboot,$@)
 
+%.dtb: vmlinux
+	$(Q)$(MAKE) ARCH=mips $(build)=$(boot) $(patsubst %,$(boot)/%,$@)
+
 CLEAN_FILES += vmlinux.ecoff \
 	       vmlinux.srec
 
diff --git a/arch/mips/boot/.gitignore b/arch/mips/boot/.gitignore
index 4667a5f..243b48c 100644
--- a/arch/mips/boot/.gitignore
+++ b/arch/mips/boot/.gitignore
@@ -3,3 +3,4 @@ elf2ecoff
 vmlinux.*
 zImage
 zImage.tmp
+*.dtb
diff --git a/arch/mips/boot/Makefile b/arch/mips/boot/Makefile
index e39a08e..9cfadad 100644
--- a/arch/mips/boot/Makefile
+++ b/arch/mips/boot/Makefile
@@ -39,7 +39,16 @@ vmlinux.bin: $(VMLINUX)
 vmlinux.srec: $(VMLINUX)
 	$(OBJCOPY) -S -O srec $(strip-flags) $(VMLINUX) $(obj)/vmlinux.srec
 
+# Rule to build device tree blobs
+DTS_FLAGS ?= -p 1024
+dtstree := $(srctree)/$(src)/dts
+DTC = $(objtree)/scripts/dtc/dtc
+
+$(obj)/%.dtb: $(dtstree)/%.dts
+	$(DTC) -O dtb -o $(obj)/$*.dtb -b 0 $(DTS_FLAGS) $(dtstree)/$*.dts
+
 clean-files += elf2ecoff \
 	       vmlinux.bin \
 	       vmlinux.ecoff \
-	       vmlinux.srec
+	       vmlinux.srec \
+	       *.dtb
-- 
1.7.0.2

