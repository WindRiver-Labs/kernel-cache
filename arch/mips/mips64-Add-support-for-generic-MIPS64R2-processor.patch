From 068f514aa3c21f10dbd101040f9afc3599991172 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Thu, 17 Oct 2013 12:44:45 +0800
Subject: [PATCH] mips64: Add support for generic MIPS64R2 processor

QEMU for 64-bit MIPS provides a single MIPS64R2 processor selection:
MIPS64R2-generic, reporting Processor ID 0x00010000. This encoding
corresponds to the MIPS Technologies (MTI) code in the company field
with the Processor ID and Revision subfields left blank.

When cpu_probe() is invoked, it dispatches to cpu_probe_mips(), which
in turn has no handler for the blank Processor ID/Revision fields, so
no valid cputype is written in the cpuinfo_mips structure, and the
boot process cannot continue.

Here we add some definitions and a switch case to enable sane handling
of this processor (pseudo)type.

Finally, adding MIPS64R2-generic support to the kernel deserves to be
recognized in the Kconfig.

Signed-off-by: Phil Staub <Phil.Staub@windriver.com>
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
Signed-off-by: He Zhe <zhe.he@windriver.com>
---
 arch/mips/include/asm/cpu.h  | 3 ++-
 arch/mips/kernel/cpu-probe.c | 4 ++++
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/arch/mips/include/asm/cpu.h b/arch/mips/include/asm/cpu.h
index 76411df..c54acf0 100644
--- a/arch/mips/include/asm/cpu.h
+++ b/arch/mips/include/asm/cpu.h
@@ -93,6 +93,7 @@
  * These are the PRID's for when 23:16 == PRID_COMP_MIPS
  */
 
+#define PRID_IMP_MIPS64R2_GENERIC      0x0000  /* QEMU */
 #define PRID_IMP_4KC		0x8000
 #define PRID_IMP_5KC		0x8100
 #define PRID_IMP_20KC		0x8200
@@ -303,7 +304,7 @@ enum cpu_type_enum {
 	 */
 	CPU_5KC, CPU_5KE, CPU_20KC, CPU_25KF, CPU_SB1, CPU_SB1A, CPU_LOONGSON2,
 	CPU_CAVIUM_OCTEON, CPU_CAVIUM_OCTEON_PLUS, CPU_CAVIUM_OCTEON2,
-	CPU_CAVIUM_OCTEON3, CPU_XLR, CPU_XLP,
+	CPU_CAVIUM_OCTEON3, CPU_XLR, CPU_XLP, CPU_MIPS64R2_GENERIC,
 
 	CPU_LAST
 };
diff --git a/arch/mips/kernel/cpu-probe.c b/arch/mips/kernel/cpu-probe.c
index 530f832..51ec411 100644
--- a/arch/mips/kernel/cpu-probe.c
+++ b/arch/mips/kernel/cpu-probe.c
@@ -747,6 +747,10 @@ static inline void cpu_probe_legacy(struct cpuinfo_mips *c, unsigned int cpu)
 static inline void cpu_probe_mips(struct cpuinfo_mips *c, unsigned int cpu)
 {
 	switch (c->processor_id & PRID_IMP_MASK) {
+	case PRID_IMP_MIPS64R2_GENERIC:
+		c->cputype = CPU_MIPS64R2_GENERIC;
+		__cpu_name[cpu] = "MIPS64R2-generic";
+		break;
 	case PRID_IMP_4KC:
 		c->cputype = CPU_4KC;
 		__cpu_name[cpu] = "MIPS 4Kc";
-- 
2.0.2

