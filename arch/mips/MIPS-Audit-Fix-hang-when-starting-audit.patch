From 0bffbc59049d54b444f9f5381b0bec30c62f5296 Mon Sep 17 00:00:00 2001
From: Ralf Baechle <ralf.baechle@windriver.com>
Date: Tue, 31 Aug 2010 08:47:40 -0700
Subject: [PATCH] MIPS: Audit: Fix hang when starting audit

_TIF_SYSCALL_AUDIT is not a work flag but was set in _TIF_WORK_MASK
anyway.  This if circumstances were just right would lead to an infinite
loop in entry.S on return from a syscall.  With the Wind River Linux
default configuration of auditd this would strike the first process to
be forked off after auditd's startup.  Then eventually other CPUs would
freeze as well when their smp_call_function() never complete.

Signed-off-by: Ralf Baechle <ralf.baechle@windriver.com>

 arch/mips/include/asm/thread_info.h |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)
---
 arch/mips/include/asm/thread_info.h |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/arch/mips/include/asm/thread_info.h b/arch/mips/include/asm/thread_info.h
index aac9833..9f09f0a 100644
--- a/arch/mips/include/asm/thread_info.h
+++ b/arch/mips/include/asm/thread_info.h
@@ -148,7 +148,8 @@ register struct thread_info *__current_thread_info __asm__("$28");
 #define _TIF_LOAD_WATCH		(1<<TIF_LOAD_WATCH)
 
 /* work to do on interrupt/exception return */
-#define _TIF_WORK_MASK		(0x0000ffef & ~_TIF_SECCOMP)
+#define _TIF_WORK_MASK		(0x0000ffef &				\
+					~(_TIF_SECCOMP | _TIF_SYSCALL_AUDIT))
 /* work to do on any return to u-space */
 #define _TIF_ALLWORK_MASK	(0xc000ffff & ~_TIF_SECCOMP)
 
-- 
1.6.5.2

