From f618749be528968bf31c77644fb12d78a59238e2 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Thu, 18 Nov 2010 16:23:55 +0800
Subject: [PATCH 1/3] powerpc: some update to freescale rapidio driver

Change doorbell send process to be consist with user manual.
Use windows address from device tree.

Signed-off-by: Li Yang <leoli@freescale.com>
[Aplply this from P2020DS_20091110_ltib.iso for fsl_p2020.]
Integrated-by: Tiejun Chen <tiejun.chen@windriver.
---
 arch/powerpc/sysdev/fsl_rio.c |   12 +++++++-----
 1 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/arch/powerpc/sysdev/fsl_rio.c b/arch/powerpc/sysdev/fsl_rio.c
index cdba8e4..ea05afe 100644
--- a/arch/powerpc/sysdev/fsl_rio.c
+++ b/arch/powerpc/sysdev/fsl_rio.c
@@ -220,13 +220,15 @@ static int fsl_rio_doorbell_send(struct rio_mport *mport,
 		out_be16(priv->dbell_win, data);
 		break;
 	case RIO_PHY_SERIAL:
-		/* In the serial version silicons, such as MPC8548, MPC8641,
-		 * below operations is must be.
-		 */
-		out_be32(&priv->msg_regs->odmr, 0x00000000);
+		/* busy wait, replace with spin_event_timeout() later */
+		while (in_be32(&priv->msg_regs->odsr) & 0x4) {
+			cpu_relax();
+		}
+		out_be32(&priv->msg_regs->odsr, 0x1602);
 		out_be32(&priv->msg_regs->odretcr, 0x00000004);
 		out_be32(&priv->msg_regs->oddpr, destid << 16);
-		out_be32(&priv->msg_regs->oddatr, data);
+		out_be32(&priv->msg_regs->oddatr, data | 0x20000000);
+		out_be32(&priv->msg_regs->odmr, 0x00000000);
 		out_be32(&priv->msg_regs->odmr, 0x00000001);
 		break;
 	}
-- 
1.6.5.2

