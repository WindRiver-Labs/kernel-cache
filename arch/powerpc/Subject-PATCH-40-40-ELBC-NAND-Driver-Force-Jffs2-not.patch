From 3edef91b5fa17f976b019923f5747cece3b7e788 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Tue, 1 Mar 2011 18:09:04 +0800
Subject: [PATCH] Subject: [PATCH 40/40] ELBC NAND Driver:Force Jffs2 not use OOB for MLC

During mount JFFS2 partition on NAND flash operation, there are warning
messages generated by JFFS2:

jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x007c0000:
0xc0ff instead
jffs2_scan_eraseblock(): Magic bitmask 0x1985 not found at 0x00800000:
0xc0ff instead

JFFS2 community add a fix with not use OOB at MLC NAND, which need NAND
driver indicated by cleaning MTD_OOB_WRITEABLE bit mtd->flags.(WRLinux
has applied this patch.)

Since P1022DS use MLC 1G Byte NAND flash, the driver need clean
MTD_OOB_WRITEABLE bit in mtd->flags field.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/mtd/nand/fsl_elbc_nand.c |   12 ++++++++++++
 1 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/drivers/mtd/nand/fsl_elbc_nand.c b/drivers/mtd/nand/fsl_elbc_nand.c
index b14356f..0704ee1 100644
--- a/drivers/mtd/nand/fsl_elbc_nand.c
+++ b/drivers/mtd/nand/fsl_elbc_nand.c
@@ -902,6 +902,9 @@ static int __devinit fsl_elbc_chip_probe(struct fsl_elbc_ctrl *ctrl,
 	if (ret)
 		goto err;
 
+	if (boardflash_is_mlc())
+		priv->mtd.flags &= ~MTD_OOB_WRITEABLE;
+
 #ifdef CONFIG_MTD_PARTITIONS
 	/* First look for RedBoot table or partitions on the command
 	 * line, these take precedence over device tree information */
@@ -1012,6 +1015,15 @@ static irqreturn_t fsl_elbc_ctrl_irq(int irqno, void *data)
  * in the chip probe function.
 */
 
+static int boardflash_is_mlc(void)
+{
+#ifdef CONFIG_P1022_DS
+	return 1;
+#else
+	return 0;
+#endif
+}
+
 static int __devinit fsl_elbc_ctrl_probe(struct of_device *ofdev,
                                          const struct of_device_id *match)
 {
-- 
1.6.0.3

