From 1357c605002170e6a44f1c0e672fa5b92d9929c2 Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Mon, 9 Aug 2010 19:05:38 +0800
Subject: [PATCH] powerpc: search for all global-utilities when getting the reset register

From FSL vendor SDK 2.x.

Signed-off-by: Fredrik Markstrom <fredrik.markstrom@gmail.com>
Integrated-by: Andrew Liu <shengping.liu@windriver.com>
---
 arch/powerpc/sysdev/fsl_soc.c |   21 +++++++++++++--------
 1 files changed, 13 insertions(+), 8 deletions(-)

diff --git a/arch/powerpc/sysdev/fsl_soc.c b/arch/powerpc/sysdev/fsl_soc.c
index b91f7ac..e68e03d 100644
--- a/arch/powerpc/sysdev/fsl_soc.c
+++ b/arch/powerpc/sysdev/fsl_soc.c
@@ -378,17 +378,22 @@ static __be32 __iomem *rstcr;
 static int __init setup_rstcr(void)
 {
 	struct device_node *np;
-	np = of_find_node_by_name(NULL, "global-utilities");
-	if ((np && of_get_property(np, "fsl,has-rstcr", NULL))) {
-		rstcr = of_iomap(np, 0) + 0xb0;
-		if (!rstcr)
-			printk (KERN_EMERG "Error: reset control register "
-					"not mapped!\n");
-	} else if (ppc_md.restart == fsl_rstcr_restart)
-		printk(KERN_ERR "No RSTCR register, warm reboot won't work\n");
 
+	for_each_node_by_name(np, "global-utilities") {
+		if ((np && of_get_property(np, "fsl,has-rstcr", NULL))) {
+			rstcr = of_iomap(np, 0) + 0xb0;
+			if (!rstcr)
+				printk(KERN_EMERG "Error: reset control "
+					"register not mapped!\n");
+			break;
+		}
+	}
 	if (np)
 		of_node_put(np);
+
+	else
+		printk(KERN_INFO "rstcr compatible register does not exist!\n");
+
 	return 0;
 }
 
-- 
1.6.5.2

