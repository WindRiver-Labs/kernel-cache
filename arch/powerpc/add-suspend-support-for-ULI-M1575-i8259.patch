From 2a1ddb5c8dbfff4e226ed6b6db8a7023a159c8df Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Thu, 11 Aug 2011 16:14:45 +0800
Subject: [PATCH 4/5] add suspend support for ULI M1575 i8259

ULI M1575 uses its built-in i8259 controller to route interrupt to CPU.

Some configuration registers of i8259 will be set during board
initialization. However during system resume, the common PCI code does
not correctly restore all of these configuration registers. It is
because the common PCI code can only save&restore 64 bytes of PCI
configuration space and it is read/write as double word.

This patch fix this problem special for ULI M1575 i8259.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-add-suspend-support-for-ULI-M1575-i8259.patch.

Signed-off-by: Jason Jin <Jason.jin@freescale.com>
Signed-off-by: Dave Liu <daveliu@freescale.com>
Signed-off-by: Li Yang <leoli@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 arch/powerpc/platforms/85xx/Makefile          |    1 +
 arch/powerpc/platforms/85xx/uli8259_suspend.c |  112 +++++++++++++++++++++++++
 2 files changed, 113 insertions(+), 0 deletions(-)
 create mode 100644 arch/powerpc/platforms/85xx/uli8259_suspend.c

diff --git a/arch/powerpc/platforms/85xx/Makefile b/arch/powerpc/platforms/85xx/Makefile
index 42d0e04..b261e5b 100644
--- a/arch/powerpc/platforms/85xx/Makefile
+++ b/arch/powerpc/platforms/85xx/Makefile
@@ -19,3 +19,4 @@ obj-$(CONFIG_SBC8548)     += sbc8548.o
 obj-$(CONFIG_SOCRATES)    += socrates.o socrates_fpga_pic.o
 obj-$(CONFIG_KSI8560)	  += ksi8560.o
 obj-$(CONFIG_XES_MPC85xx) += xes_mpc85xx.o
+obj-$(CONFIG_FSL_PMC)     += uli8259_suspend.o
diff --git a/arch/powerpc/platforms/85xx/uli8259_suspend.c b/arch/powerpc/platforms/85xx/uli8259_suspend.c
new file mode 100644
index 0000000..a8d87c9
--- /dev/null
+++ b/arch/powerpc/platforms/85xx/uli8259_suspend.c
@@ -0,0 +1,112 @@
+/*
+ * Copyright (C) 2008 Freescale Semiconductor, Inc. All rights reserved.
+ *
+ * Description: Suspend support for ULI M1575 i8259 on MPC8572DS
+ *
+ * Changelog:
+ * May 2008 Jason Jin <jason.jin@freescale.com >
+ * - Initialization
+ *
+ * This file is part of the Linux kernel
+ *
+ * This program is free software; you can redistribute it and/or modify it
+ * under the terms of the GNU General Public License version 2 as published
+ * by the Free Software Foundation.
+ */
+
+#include <linux/stddef.h>
+#include <linux/kernel.h>
+#include <linux/pci.h>
+
+#include <asm/system.h>
+#include <asm/pci-bridge.h>
+
+#ifdef CONFIG_PM
+static DEFINE_SPINLOCK(uli_pm_lock);
+
+struct saved_config
+{
+	u32 save_0x48;
+	u8  save_0x86_0x8f[10];
+	u8  save_0x74;
+	u8  save_0x44;
+	u8  save_0x75;
+};
+struct saved_config uli8259_saved_config;
+
+static int uli8259_suspend(struct pci_dev *pdev, pm_message_t state)
+{
+	int i;
+	unsigned long flags;
+	spin_lock_irqsave(&uli_pm_lock, flags);
+
+	pci_read_config_dword(pdev, 0x48, &uli8259_saved_config.save_0x48);
+
+	for (i = 0; i < 10; i++)
+		pci_read_config_byte(pdev, 0x86 + i,
+				&uli8259_saved_config.save_0x86_0x8f[i]);
+
+	pci_read_config_byte(pdev, 0x74, &uli8259_saved_config.save_0x74);
+	pci_read_config_byte(pdev, 0x75, &uli8259_saved_config.save_0x75);
+	pci_read_config_byte(pdev, 0x44, &uli8259_saved_config.save_0x44);
+
+	spin_unlock_irqrestore(&uli_pm_lock, flags);
+	return 0;
+}
+
+static int uli8259_resume(struct pci_dev *pdev)
+{
+	int i;
+
+	unsigned long flags;
+	spin_lock_irqsave(&uli_pm_lock, flags);
+
+	pci_write_config_dword(pdev, 0x48, uli8259_saved_config.save_0x48);
+
+	for (i = 0; i < 10; i++)
+		pci_write_config_byte(pdev, 0x86 + i,
+				uli8259_saved_config.save_0x86_0x8f[i]);
+
+	pci_write_config_byte(pdev, 0x74, uli8259_saved_config.save_0x74);
+	pci_write_config_byte(pdev, 0x75, uli8259_saved_config.save_0x75);
+	pci_write_config_byte(pdev, 0x44, uli8259_saved_config.save_0x44);
+
+	outb(0xfa, 0x4d0);
+	outb(0x1e, 0x4d1);
+
+	spin_unlock_irqrestore(&uli_pm_lock, flags);
+	return 0;
+}
+#endif
+static int __devinit uli8259_suspend_probe(struct pci_dev *pdev,
+		const struct pci_device_id *ent)
+{
+	return 0;
+}
+
+
+static struct pci_device_id uli8259_pci_tbl[] = {
+	{ PCI_VENDOR_ID_AL, 0x1575, PCI_ANY_ID, PCI_ANY_ID, 0, 0},
+	{ 0, }
+};
+
+static struct pci_driver uli8259_suspend_driver = {
+	.name     = "uli8259 suspend",
+	.id_table = uli8259_pci_tbl,
+	.probe    = uli8259_suspend_probe,
+#ifdef CONFIG_PM
+	.suspend  = uli8259_suspend,
+	.resume   = uli8259_resume,
+#endif
+};
+
+static int uli8259_suspend_init(void)
+{
+	int ret;
+
+	ret = pci_register_driver(&uli8259_suspend_driver);
+
+	return ret;
+}
+
+module_init(uli8259_suspend_init);
-- 
1.7.0.2

