From a50a152fa1f0555ecb4aaf398224eb3697b4f6a4 Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Thu, 9 Dec 2010 09:21:18 +0800
Subject: [PATCH] powerpc: initialize saved frame pointer with a valid value

When a kernel thread clones a child kernel thread, it doesn't initialize
saved frame pointer, which may have a invalid value for calling macro
CALLER_ADDR1. This invalid value may lead to oops.

Here we initialize the child's saved frame pointer with it's parent's
sp, which is a valid and sane value for CALLER_ADDR1.

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 arch/powerpc/kernel/process.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/process.c b/arch/powerpc/kernel/process.c
index 278f101..9d8a535 100644
--- a/arch/powerpc/kernel/process.c
+++ b/arch/powerpc/kernel/process.c
@@ -749,6 +749,13 @@ int copy_thread(unsigned long clone_flags, unsigned long usp,
 	}
 	childregs->gpr[3] = 0;  /* Result from fork() */
 	sp -= STACK_FRAME_OVERHEAD;
+	/*
+	 * for kernel thread, set saved frame pointer
+	 * with a valid value, so that CALLER_ADDR1 will be valid later.
+	 */
+	if ((childregs->msr & MSR_PR) == 0) {
+		*(unsigned long*)sp = regs->gpr[1];
+	}
 
 	/*
 	 * The way this works is that at some point in the future
-- 
1.6.5.2

