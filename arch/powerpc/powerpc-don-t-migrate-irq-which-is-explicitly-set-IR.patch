From 5a3103e0a4d5bd78e121274499d61cf5b0106b49 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Thu, 10 Jan 2013 14:25:39 +0800
Subject: [PATCH] powerpc: don't migrate irq which is explicitly set
 IRQF_NOBALANCING

Flag IRQF_NOBALANCING is used to exclude one irq from irq balancing.
But when we try to offline a cpu the migrate_irqs doesn't honour this
flag and still migrate these irqs to other cpu. This definitely violate
the primary intention of this flag. So replace irqd_is_per_cpu()
with !irqd_can_balance() in migrate_irqs since it will cover both
IRQF_PERCPU and IRQF_NOBALANCING.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/powerpc/kernel/irq.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/arch/powerpc/kernel/irq.c b/arch/powerpc/kernel/irq.c
index 1d0848b..9d7a201 100644
--- a/arch/powerpc/kernel/irq.c
+++ b/arch/powerpc/kernel/irq.c
@@ -423,7 +423,7 @@ void migrate_irqs(void)
 		struct irq_chip *chip;
 
 		data = irq_desc_get_irq_data(desc);
-		if (irqd_is_per_cpu(data))
+		if (!irqd_can_balance(data))
 			continue;
 
 		chip = irq_data_get_irq_chip(data);
-- 
2.0.2

