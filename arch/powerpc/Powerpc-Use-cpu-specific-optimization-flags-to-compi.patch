From 3a5c527aa041f38d66add3b4b4bc4dc1e4fb4c29 Mon Sep 17 00:00:00 2001
From: Lei Liu <lei.liu2@windriver.com>
Date: Tue, 2 Apr 2013 13:47:05 +0800
Subject: [PATCH] Powerpc: Use cpu specific optimization flags to compile

With -mcpu=8548/e500mc switch, gcc will generate better code for
the specific CPU type, including more accurate instruction scheduling
model and better instruction selection.  lmbench result shows average
~2% performance increment after adding this switch.

Signed-off-by: Lei Liu <lei.liu2@windriver.com>
---
 arch/powerpc/Makefile                  |   10 ++++++++++
 arch/powerpc/platforms/85xx/Kconfig    |    6 ++++++
 arch/powerpc/platforms/Kconfig.cputype |    3 +++
 3 files changed, 19 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/Makefile b/arch/powerpc/Makefile
index 1316ca7..b1e46a7 100644
--- a/arch/powerpc/Makefile
+++ b/arch/powerpc/Makefile
@@ -122,6 +122,16 @@ ifeq ($(CONFIG_6xx),y)
 KBUILD_CFLAGS		+= -mcpu=powerpc
 endif
 
+# Use CPU specific optimization flags for e500v2 and e500mc, 
+# which results in better code generation for the specific
+# CPU type.  Select 8548 as the CPU type for e500v2 cores,
+# as required by GCC.
+mcpu-$(CONFIG_PPC_E500V2) += $(call cc-option,-mcpu=8548)
+ifeq ($(CONFIG_PPC32),y)
+mcpu-$(CONFIG_PPC_E500MC) += $(call cc-option,-mcpu=e500mc)
+endif
+KBUILD_CFLAGS += $(mcpu-y)
+
 # Work around a gcc code-gen bug with -fno-omit-frame-pointer.
 ifeq ($(CONFIG_FUNCTION_TRACER),y)
 KBUILD_CFLAGS		+= -mno-sched-epilog
diff --git a/arch/powerpc/platforms/85xx/Kconfig b/arch/powerpc/platforms/85xx/Kconfig
index 1e40093..ad464fa 100644
--- a/arch/powerpc/platforms/85xx/Kconfig
+++ b/arch/powerpc/platforms/85xx/Kconfig
@@ -36,6 +36,7 @@ config FLEXCAN
 
 config MPC85xx_CDS
 	bool "Freescale MPC85xx CDS"
+	select PPC_E500V2
 	select DEFAULT_UIMAGE
 	select PPC_I8259
 	help
@@ -43,6 +44,7 @@ config MPC85xx_CDS
 
 config MPC85xx_MDS
 	bool "Freescale MPC85xx MDS"
+	select PPC_E500V2
 	select DEFAULT_UIMAGE
 	select PHYLIB
 	select HAS_RAPIDIO
@@ -52,6 +54,7 @@ config MPC85xx_MDS
 
 config MPC8536_DS
 	bool "Freescale MPC8536 DS"
+	select PPC_E500V2
 	select DEFAULT_UIMAGE
 	select SWIOTLB
 	help
@@ -59,6 +62,7 @@ config MPC8536_DS
 
 config MPC85xx_DS
 	bool "Freescale MPC85xx DS"
+	select PPC_E500V2
 	select PPC_I8259
 	select DEFAULT_UIMAGE
 	select FSL_ULI1575 if PCI
@@ -68,6 +72,7 @@ config MPC85xx_DS
 
 config MPC85xx_RDB
 	bool "Freescale MPC85xx RDB"
+	select PPC_E500V2
 	select PPC_I8259
 	select DEFAULT_UIMAGE
 	select FSL_ULI1575 if PCI
@@ -151,6 +156,7 @@ config TQM8560
 
 config SBC8548
 	bool "Wind River SBC8548"
+	select PPC_E500V2
 	select DEFAULT_UIMAGE
 	help
 	  This option enables support for the Wind River SBC8548 board
diff --git a/arch/powerpc/platforms/Kconfig.cputype b/arch/powerpc/platforms/Kconfig.cputype
index 5fe4a84..7612806 100644
--- a/arch/powerpc/platforms/Kconfig.cputype
+++ b/arch/powerpc/platforms/Kconfig.cputype
@@ -128,6 +128,9 @@ config E500
 	select PPC_FSL_BOOK3E
 	bool
 
+config PPC_E500V2
+	bool
+
 config PPC_E500MC
 	bool "e500mc Support"
 	select PPC_FPU
-- 
1.7.0

