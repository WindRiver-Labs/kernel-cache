From e1a3e4b338f1901afa546c4a6b742faf4a229dab Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 17 Dec 2010 10:38:11 +0800
Subject: [PATCH 3/3] fsl_p2020/mtd: fix an inappropriate write buffer timerout

When write buffer for flash 'uWriteTimeout' is checked if the write-buffer is completed.
But its only one experienced time slot. So its necessary to add the given chip buffer
write time to make sure the actual write timeout is enough.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/mtd/chips/cfi_cmdset_0002.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/drivers/mtd/chips/cfi_cmdset_0002.c b/drivers/mtd/chips/cfi_cmdset_0002.c
index f3600e8..9ee9b29 100644
--- a/drivers/mtd/chips/cfi_cmdset_0002.c
+++ b/drivers/mtd/chips/cfi_cmdset_0002.c
@@ -1359,6 +1359,12 @@ static int __xipram do_write_buffer(struct map_info *map, struct flchip *chip,
 				adr, map_bankwidth(map),
 				chip->word_write_time);
 
+	/* uWriteTimeout is only one experienced time slot. So its necessary
+	 * to add the given chip buffer write time to make sure the actual write
+	 * timeout is enough.
+	 */
+	if (uWriteTimeout < chip->buffer_write_time)
+		uWriteTimeout += chip->buffer_write_time;
 	timeo = jiffies + uWriteTimeout;
 
 	for (;;) {
-- 
1.6.5.2

