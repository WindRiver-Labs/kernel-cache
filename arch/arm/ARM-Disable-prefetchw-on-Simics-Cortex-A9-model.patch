From 656db91b20b4a54b0aef154a3234224a2b844993 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Thu, 4 Sep 2014 11:05:05 -0700
Subject: [PATCH] ARM: Disable prefetchw on Simics Cortex-A9 model

The below upstream commits added prefetchw (pldw) support for ARMv7.
d8f57aa4bc5860df68d4c332d2a89c131417ee7b
("prefetch: add support for prefetchw using pldw on SMP ARMv7+ CPUs")
9bb17be062de6f5a9c9643258951aa0935652ec3
("ARM: locks: prefetch the destination word for write prior to strex")
f38d999c4d16fc0fce4270374f15fbb2d8713c09
("ARM: atomics: prefetch the destination word for write prior to strex")
d779c07dd72098a7416d907494f958213b7726f3
("ARM: bitops: prefetch the destination word for write prior to strex")

But, Simics Cortex-A9 model has bug about emulating pldw instruction, which
causes prefetch abort exception once pldw is executed.

So, add SIMICS_A9 platfrom to workaround pldw bug.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/arm/include/asm/processor.h | 3 ++-
 arch/arm/lib/bitops.h            | 4 +++-
 arch/arm/mach-vexpress/Kconfig   | 6 ++++++
 3 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/arch/arm/include/asm/processor.h b/arch/arm/include/asm/processor.h
index c3d5fc1..c4aa2ec 100644
--- a/arch/arm/include/asm/processor.h
+++ b/arch/arm/include/asm/processor.h
@@ -112,7 +112,8 @@ static inline void prefetch(const void *ptr)
 		:: "p" (ptr));
 }
 
-#if __LINUX_ARM_ARCH__ >= 7 && defined(CONFIG_SMP)
+/* Workaround for Simics Cortex-A9 model pldw bug */
+#if __LINUX_ARM_ARCH__ >= 7 && defined(CONFIG_SMP) && !defined(CONFIG_SIMICS_A9)
 #define ARCH_HAS_PREFETCHW
 static inline void prefetchw(const void *ptr)
 {
diff --git a/arch/arm/lib/bitops.h b/arch/arm/lib/bitops.h
index 52886b8..c0a54fc 100644
--- a/arch/arm/lib/bitops.h
+++ b/arch/arm/lib/bitops.h
@@ -10,7 +10,9 @@ UNWIND(	.fnstart	)
 	and	r3, r0, #31		@ Get bit offset
 	mov	r0, r0, lsr #5
 	add	r1, r1, r0, lsl #2	@ Get word offset
-#if __LINUX_ARM_ARCH__ >= 7 && defined(CONFIG_SMP)
+
+/* Workaround for Simics Cortex-A9 model pldw bug */
+#if __LINUX_ARM_ARCH__ >= 7 && defined(CONFIG_SMP) && !defined(CONFIG_SIMICS_A9)
 	.arch_extension	mp
 	ALT_SMP(W(pldw)	[r1])
 	ALT_UP(W(nop))
diff --git a/arch/arm/mach-vexpress/Kconfig b/arch/arm/mach-vexpress/Kconfig
index 4a70be4..bd84e02 100644
--- a/arch/arm/mach-vexpress/Kconfig
+++ b/arch/arm/mach-vexpress/Kconfig
@@ -85,4 +85,10 @@ config ARCH_VEXPRESS_TC2_PM
 	  Support for CPU and cluster power management on Versatile Express
 	  with a TC2 (A15x2 A7x3) big.LITTLE core tile.
 
+config SIMICS_A9
+	bool "Simics Cortex-A9 model"
+	depends on ARCH_VEXPRESS_CA9X4
+	help
+	  Support for Simics Vexpress Cortex-A9 platform.
+
 endmenu
-- 
2.0.2

