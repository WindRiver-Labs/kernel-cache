From 60f32a64e59cf3e56dbb05acb531675ca0379bcb Mon Sep 17 00:00:00 2001
From: Balaji T K <balajitk@ti.com>
Date: Mon, 28 Oct 2013 14:41:30 +0530
Subject: [PATCH 1090/1115] mmc: omap_hsmmc: OMAP5/DRA7 enable autocmd23

enable autocmd23 for OMAP5 and DRA7 based on hsmmc revision

Signed-off-by: Balaji T K <balajitk@ti.com>
(cherry picked from commit 6478dfcb8487ac1ad610467a35aa26ec9b5f0ac5)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/mmc/host/omap_hsmmc.c |   13 +++++++++++++
 1 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/drivers/mmc/host/omap_hsmmc.c b/drivers/mmc/host/omap_hsmmc.c
index e7da908..011f2c5 100644
--- a/drivers/mmc/host/omap_hsmmc.c
+++ b/drivers/mmc/host/omap_hsmmc.c
@@ -61,6 +61,7 @@
 #define OMAP_HSMMC_ISE		0x0138
 #define OMAP_HSMMC_AC12		0x013C
 #define OMAP_HSMMC_CAPA		0x0140
+#define OMAP_HSMMC_REV		0x01FC
 
 #define VS18			(1 << 26)
 #define VS30			(1 << 25)
@@ -140,6 +141,11 @@
 
 #define AUTO_CMD12		(1 << 0)	/* Auto CMD12 support */
 #define AUTO_CMD23		(1 << 1)	/* Auto CMD23 support */
+
+#define OMAP_HSMMC_REV_SHIFT	24
+/* HSMMC controller revision on OMAP5, DRA7 */
+#define OMAP_HSMMC_REV_33	0x33
+
 /*
  * One controller can have multiple slots, like on some omap boards using
  * omap.c controller driver. Luckily this is not currently done on any known
@@ -1875,6 +1881,7 @@ static int omap_hsmmc_probe(struct platform_device *pdev)
 	dma_cap_mask_t mask;
 	unsigned tx_req, rx_req;
 	struct pinctrl *pinctrl;
+	u32 revision;
 
 	match = of_match_device(of_match_ptr(omap_mmc_of_match), &pdev->dev);
 	if (match) {
@@ -2073,6 +2080,12 @@ static int omap_hsmmc_probe(struct platform_device *pdev)
 		host->use_reg = 1;
 	}
 
+	revision = OMAP_HSMMC_READ(host->base, REV);
+	if ((revision >> OMAP_HSMMC_REV_SHIFT) >= OMAP_HSMMC_REV_33) {
+		mmc->caps |= MMC_CAP_CMD23;
+		host->flags |= AUTO_CMD23;
+	}
+
 	mmc->ocr_avail = mmc_slot(host).ocr_mask;
 
 	/* Request IRQ for card detect */
-- 
1.7.5.4

