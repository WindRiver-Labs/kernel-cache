From e8c65a73808b0b8a9109daa2aa0e427af799047a Mon Sep 17 00:00:00 2001
From: srinivas pulukuru <srinivas.pulukuru@ti.com>
Date: Mon, 10 Jun 2013 13:38:12 -0500
Subject: [PATCH 0767/1115] omapdss: dispc: Fix wrong DMA access of NV12
 format in 1D burst mode

When a video pipe is configure in YUV4:2:0 format and 1D burst mode, the DISPC
DMA skips lines when fetching the chroma plane, even if doublestride is set to
0.

The workaround is to not set doublestride like done now, and also set the
VIDp_ATTRIBUTES.ROTATION bit to 1 or 3(90 or 270 degrees).

Originally worked on by Srinivas Pulukuru <srinivas.pulukuru@ti.com>

Signed-off-by: Archit Taneja <archit@ti.com>
(cherry picked from commit 36d10c07dbff079ddea9c1748e72473a170b1569)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/video/omap2/dss/dispc.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/video/omap2/dss/dispc.c b/drivers/video/omap2/dss/dispc.c
index 3f56650..6578540 100644
--- a/drivers/video/omap2/dss/dispc.c
+++ b/drivers/video/omap2/dss/dispc.c
@@ -1641,7 +1641,6 @@ static void dispc_ovl_set_rotation_attrs(enum omap_plane plane, u8 rotation,
 			row_repeat = false;
 	}
 
-	REG_FLD_MOD(DISPC_OVL_ATTRIBUTES(plane), vidrot, 13, 12);
 	if (dss_has_feature(FEAT_ROWREPEATENABLE))
 		REG_FLD_MOD(DISPC_OVL_ATTRIBUTES(plane),
 			row_repeat ? 1 : 0, 18, 18);
@@ -1650,10 +1649,14 @@ static void dispc_ovl_set_rotation_attrs(enum omap_plane plane, u8 rotation,
 		bool doublestride = (rotation_type == OMAP_DSS_ROT_TILER) &&
 					(rotation == OMAP_DSS_ROT_0 ||
 					rotation == OMAP_DSS_ROT_180);
+
+		vidrot = rotation_type != OMAP_DSS_ROT_TILER ? 1 : vidrot;
+
 		/* DOUBLESTRIDE */
 		REG_FLD_MOD(DISPC_OVL_ATTRIBUTES(plane), doublestride, 22, 22);
 	}
 
+	REG_FLD_MOD(DISPC_OVL_ATTRIBUTES(plane), vidrot, 13, 12);
 }
 
 static int color_mode_to_bpp(enum omap_color_mode color_mode)
-- 
1.7.5.4

