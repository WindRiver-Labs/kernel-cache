From 1b66be2e577cc0f7e6cc0c4ca5b77e2762188b73 Mon Sep 17 00:00:00 2001
From: Archit Taneja <archit@ti.com>
Date: Fri, 25 Oct 2013 20:23:19 +0530
Subject: [PATCH 0748/1115] omapdss: dss_dpll: enable M6 hsdivider for LCD2
 and LCD3 overlay managers

On DRA7x, 2 hsdivider outputs of each VIDEO PLL is fed back to DISPC. The M4
and M6 hsdividers are now fed back to provide LCDx_CLKs, with muxing done by
the control module.

DPLL_VIDEO1's M6 divider can be used to generate LCD2_CLK and LCD3_CLK and
DISPC_FCLK. DPLL_VIDEO2's M6 divider can be used to generate LCD2_CLK and
DISPC_FCLK.

Enable the M6 hsdividers along with M4. Typically, we don't need to enable both
the hsdividers for a PLL as we would most likely be using only one of them. But
the code isn't smart enough right now to figure out which hsdivider to use.

Signed-off-by: Archit Taneja <archit@ti.com>
(cherry picked from commit 0f694bcc7a7dba064adffa5a1f8ba8815f6b1d9f)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/video/omap2/dss/dss_dpll.c |    9 ++++++++-
 1 files changed, 8 insertions(+), 1 deletions(-)

diff --git a/drivers/video/omap2/dss/dss_dpll.c b/drivers/video/omap2/dss/dss_dpll.c
index 81044e1..170c8fa 100644
--- a/drivers/video/omap2/dss/dss_dpll.c
+++ b/drivers/video/omap2/dss/dss_dpll.c
@@ -230,6 +230,12 @@ int dss_dpll_set_clock_div(enum dss_dpll dpll, struct dss_dpll_cinfo *cinfo)
 			regm_hsdiv_start, regm_hsdiv_end);
 	dpll_write_reg(dpll, PLL_CONFIGURATION1, l);
 
+	/* CONFIGURATION3 */
+	l = dpll_read_reg(dpll, PLL_CONFIGURATION3);
+	/* M6_CLOCK_DIV */
+	l = FLD_MOD(l, cinfo->regm_hsdiv > 0 ? cinfo->regm_hsdiv - 1 : 0, 4, 0);
+	dpll_write_reg(dpll, PLL_CONFIGURATION3, l);
+
 	/* CONFIGURATION2 */
 	l = dpll_read_reg(dpll, PLL_CONFIGURATION2);
 	l = FLD_MOD(l, 1, 13, 13);	/* PLL_REFEN */
@@ -262,11 +268,12 @@ int dss_dpll_set_clock_div(enum dss_dpll dpll, struct dss_dpll_cinfo *cinfo)
 	l = FLD_MOD(l, 1, 13, 13);	/* PLL_REFEN */
 	l = FLD_MOD(l, 1, 14, 14);	/* PHY_CLKINEN */
 	l = FLD_MOD(l, 0, 15, 15);	/* BYPASSEN */
-	l = FLD_MOD(l, 1, 16, 16);	/* CLOCK_EN */
+	l = FLD_MOD(l, 1, 16, 16);	/* M4_CLOCK_EN */
 	l = FLD_MOD(l, 0, 17, 17);	/* CLOCK_PWDN */
 	l = FLD_MOD(l, 1, 18, 18);	/* PROTO_CLOCK_EN */
 	l = FLD_MOD(l, 0, 19, 19);	/* PROTO_CLOCK_PWDN */
 	l = FLD_MOD(l, 0, 20, 20);	/* HSDIVBYPASS */
+	l = FLD_MOD(l, 1, 23, 23);	/* M6_CLOCK_EN */
 	dpll_write_reg(dpll, PLL_CONFIGURATION2, l);
 
 	DSSDBG("PLL config done\n");
-- 
1.7.5.4

