From 80d25a353df37557bb091a9ac4a5a2754c0d8dfd Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Wed, 11 Dec 2013 01:47:18 +0000
Subject: [PATCH 0715/1115] ARM: OMAP2+: Hookup AM437x PM

Required changes have been made to am33xx PM code so enable
use for am43xx.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
Acked-by: Russ Dill <russ.dill@ti.com>
(cherry picked from commit 328e3a11b980aac0f6d8727aa5398bc8240c0958)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-omap2/Makefile |    3 ++-
 arch/arm/mach-omap2/common.h |    1 +
 arch/arm/mach-omap2/io.c     |    4 ++++
 arch/arm/mach-omap2/sram.c   |   15 +++++++++++++++
 4 files changed, 22 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-omap2/Makefile b/arch/arm/mach-omap2/Makefile
index 343bc93..c08cf5c 100644
--- a/arch/arm/mach-omap2/Makefile
+++ b/arch/arm/mach-omap2/Makefile
@@ -94,7 +94,7 @@ obj-$(CONFIG_ARCH_OMAP4)		+= pm44xx.o omap-mpuss-lowpower.o
 obj-$(CONFIG_SOC_OMAP5)			+= omap-mpuss-lowpower.o
 obj-$(CONFIG_SOC_DRA7XX)		+= omap-mpuss-lowpower.o
 obj-$(CONFIG_SOC_AM33XX)		+= pm33xx.o sleep33xx.o wkup_m3.o
-obj-$(CONFIG_SOC_AM43XX)		+= wkup_m3.o
+obj-$(CONFIG_SOC_AM43XX)		+= pm33xx.o wkup_m3.o
 obj-$(CONFIG_PM_DEBUG)			+= pm-debug.o
 
 obj-$(CONFIG_POWER_AVS_OMAP)		+= sr_device.o
@@ -103,6 +103,7 @@ obj-$(CONFIG_POWER_AVS_OMAP_CLASS3)    += smartreflex-class3.o
 AFLAGS_sleep24xx.o			:=-Wa,-march=armv6
 AFLAGS_sleep34xx.o			:=-Wa,-march=armv7-a$(plus_sec)
 AFLAGS_sleep33xx.o			:=-Wa,-march=armv7-a$(plus_sec)
+AFLAGS_sleep43xx.o			:=-Wa,-march=armv7-a$(plus_sec)
 
 endif
 
diff --git a/arch/arm/mach-omap2/common.h b/arch/arm/mach-omap2/common.h
index 5bffb03..9724908 100644
--- a/arch/arm/mach-omap2/common.h
+++ b/arch/arm/mach-omap2/common.h
@@ -118,6 +118,7 @@ void omap3430_init_late(void);
 void omap35xx_init_late(void);
 void omap3630_init_late(void);
 void am33xx_init_late(void);
+void am43xx_init_late(void);
 void am35xx_init_late(void);
 void ti81xx_init_late(void);
 void am33xx_init_late(void);
diff --git a/arch/arm/mach-omap2/io.c b/arch/arm/mach-omap2/io.c
index a34d73e..295e3e6 100644
--- a/arch/arm/mach-omap2/io.c
+++ b/arch/arm/mach-omap2/io.c
@@ -629,7 +629,11 @@ void __init am43xx_init_early(void)
 
 void __init am43xx_init_late(void)
 {
+	omap_hwmod_force_mstandby_repeated();
 	omap2_common_pm_late_init();
+	am33xx_pm_init();
+	omap_soc_device_init();
+	omap2_clk_enable_autoidle_all();
 }
 #endif
 
diff --git a/arch/arm/mach-omap2/sram.c b/arch/arm/mach-omap2/sram.c
index 303c562..3bc1804 100644
--- a/arch/arm/mach-omap2/sram.c
+++ b/arch/arm/mach-omap2/sram.c
@@ -298,6 +298,19 @@ static inline int am33xx_sram_init(void)
 }
 #endif
 
+#ifdef CONFIG_SOC_AM43XX
+static inline int am43xx_sram_init(void)
+{
+	am43xx_push_sram_idle();
+	return 0;
+}
+#else
+static inline int am43xx_sram_init(void)
+{
+	return 0;
+}
+#endif
+
 int __init omap_sram_init(void)
 {
 	omap_detect_sram();
@@ -309,6 +322,8 @@ int __init omap_sram_init(void)
 		omap243x_sram_init();
 	else if (soc_is_am33xx())
 		am33xx_sram_init();
+	else if (soc_is_am43xx())
+		am43xx_sram_init();
 	else if (cpu_is_omap34xx())
 		omap34xx_sram_init();
 
-- 
1.7.5.4

