From 40857cd7a0659ed855e04c010603285744c797ee Mon Sep 17 00:00:00 2001
From: Suman Anna <s-anna@ti.com>
Date: Mon, 15 Jul 2013 20:18:45 -0500
Subject: [PATCH 0691/1115] ARM: OMAP2+: define a common reserve function for
 DRA7xx

A new common reserve function for DRA7xx, dra7_reserve has been
added to enable creating CMA pools specific to the remoteproc
devices on the DRA7xx SoC. This function passes the DRA7xx SoC
identifier to the remoteproc cma reservation function, and can
be used by all DRA7xx related derivative board files.

Signed-off-by: Suman Anna <s-anna@ti.com>
(cherry picked from commit a459b6ee65d765376993740c551aa6db01d41ede)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-omap2/board-generic.c           |    2 +-
 arch/arm/mach-omap2/common.c                  |    6 ++++++
 arch/arm/mach-omap2/common.h                  |    1 +
 include/linux/platform_data/remoteproc-omap.h |    1 +
 4 files changed, 9 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-omap2/board-generic.c b/arch/arm/mach-omap2/board-generic.c
index 2404e76..84926c0 100644
--- a/arch/arm/mach-omap2/board-generic.c
+++ b/arch/arm/mach-omap2/board-generic.c
@@ -244,7 +244,7 @@ static const char *dra7xx_boards_compat[] __initdata = {
 };
 
 DT_MACHINE_START(DRA7XX_DT, "Generic DRA7XX (Flattened Device Tree)")
-	.reserve	= omap_reserve,
+	.reserve	= dra7_reserve,
 	.smp		= smp_ops(omap4_smp_ops),
 	.map_io		= omap5_map_io,
 	.init_early	= dra7xx_init_early,
diff --git a/arch/arm/mach-omap2/common.c b/arch/arm/mach-omap2/common.c
index 16a2355..4d5bf03 100644
--- a/arch/arm/mach-omap2/common.c
+++ b/arch/arm/mach-omap2/common.c
@@ -45,6 +45,12 @@ void __init omap5_reserve(void)
 	omap_reserve();
 }
 
+void __init dra7_reserve(void)
+{
+	omap_rproc_reserve_cma(RPROC_CMA_DRA7);
+	omap_reserve();
+}
+
 void __init omap_reserve(void)
 {
 	omap_dsp_reserve_sdram_memblock();
diff --git a/arch/arm/mach-omap2/common.h b/arch/arm/mach-omap2/common.h
index d3705ad..5bffb03 100644
--- a/arch/arm/mach-omap2/common.h
+++ b/arch/arm/mach-omap2/common.h
@@ -335,6 +335,7 @@ extern int omap4_twl6030_hsmmc_init(struct omap2_hsmmc_info *controllers);
 
 extern void omap4_reserve(void);
 extern void omap5_reserve(void);
+extern void dra7_reserve(void);
 extern void omap_reserve(void);
 
 extern void am33xx_reserve(void);
diff --git a/include/linux/platform_data/remoteproc-omap.h b/include/linux/platform_data/remoteproc-omap.h
index 007b210..4e6e832 100644
--- a/include/linux/platform_data/remoteproc-omap.h
+++ b/include/linux/platform_data/remoteproc-omap.h
@@ -80,5 +80,6 @@ static inline void __init omap_rproc_reserve_cma(int platform_type)
  */
 #define RPROC_CMA_OMAP4		1
 #define RPROC_CMA_OMAP5		2
+#define RPROC_CMA_DRA7		3
 
 #endif /* _PLAT_REMOTEPROC_H */
-- 
1.7.5.4

