From 899ae59e127a056e0b13a1f44455478b24dbbb1d Mon Sep 17 00:00:00 2001
From: Rajendra Nayak <rnayak@ti.com>
Date: Mon, 27 May 2013 15:46:44 +0530
Subject: [PATCH 0366/1115] ARM: DRA7: Enable MPU RET on suspend

On DRA7 prevent a CPU OFF and MPU OSWR and instead attempt a
CPU RET and MPU RET in suspend.

Signed-off-by: Rajendra Nayak <rnayak@ti.com>
(cherry picked from commit 6231c85d899f2907144a1c28f502082a9d351f54)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-omap2/omap-mpuss-lowpower.c |    2 ++
 arch/arm/mach-omap2/omap-wakeupgen.c      |    4 +++-
 arch/arm/mach-omap2/pm44xx.c              |    8 +++++++-
 3 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-omap2/omap-mpuss-lowpower.c b/arch/arm/mach-omap2/omap-mpuss-lowpower.c
index 2ab2f25..6de8248 100644
--- a/arch/arm/mach-omap2/omap-mpuss-lowpower.c
+++ b/arch/arm/mach-omap2/omap-mpuss-lowpower.c
@@ -244,6 +244,8 @@ int omap4_enter_lowpower(unsigned int cpu, unsigned int power_state)
 		save_state = 1;
 		break;
 	case PWRDM_POWER_RET:
+		save_state = 0;
+		break;
 	default:
 		/*
 		 * CPUx CSWR is invalid hardware state. Also CPUx OSWR
diff --git a/arch/arm/mach-omap2/omap-wakeupgen.c b/arch/arm/mach-omap2/omap-wakeupgen.c
index d1c8a8a..86a0723 100644
--- a/arch/arm/mach-omap2/omap-wakeupgen.c
+++ b/arch/arm/mach-omap2/omap-wakeupgen.c
@@ -379,7 +379,9 @@ static struct notifier_block irq_notifier_block = {
 
 static void __init irq_pm_init(void)
 {
-	cpu_pm_register_notifier(&irq_notifier_block);
+	/* No OFF mode support on dra7xx */
+	if (!soc_is_dra7xx())
+		cpu_pm_register_notifier(&irq_notifier_block);
 }
 #else
 static void __init irq_pm_init(void)
diff --git a/arch/arm/mach-omap2/pm44xx.c b/arch/arm/mach-omap2/pm44xx.c
index 3dbfa77..4627875 100644
--- a/arch/arm/mach-omap2/pm44xx.c
+++ b/arch/arm/mach-omap2/pm44xx.c
@@ -35,6 +35,7 @@ struct power_state {
 };
 
 static LIST_HEAD(pwrst_list);
+u32 cpu_suspend_state;
 
 #ifdef CONFIG_SUSPEND
 static int omap4_pm_suspend(void)
@@ -67,7 +68,7 @@ static int omap4_pm_suspend(void)
 	 * domain CSWR is not supported by hardware.
 	 * More details can be found in OMAP4430 TRM section 4.3.4.2.
 	 */
-	omap4_enter_lowpower(cpu_id, PWRDM_POWER_OFF);
+	omap4_enter_lowpower(cpu_id, cpu_suspend_state);
 
 	/* Restore next powerdomain state */
 	list_for_each_entry(pwrst, &pwrst_list, node) {
@@ -279,6 +280,11 @@ int __init omap4_pm_init(void)
 	if (cpu_is_omap44xx())
 		omap4_idle_init();
 
+	if (soc_is_dra7xx())
+		cpu_suspend_state = PWRDM_POWER_RET;
+	else
+		cpu_suspend_state = PWRDM_POWER_OFF;
+
 err2:
 	return ret;
 }
-- 
1.7.5.4

