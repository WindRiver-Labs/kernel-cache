From 3d7d3ac1afa425efe93ce30aa014f9a285040025 Mon Sep 17 00:00:00 2001
From: Rajendra Nayak <rnayak@ti.com>
Date: Mon, 25 Nov 2013 18:51:15 +0530
Subject: [PATCH 0680/1115] ARM: OMAP2+: Export SoC data to userspace

For some SoCs like omap5/am33xx and am43xx, the SoC info like
family/machine/revision wasn't exported to userspace via
the /sys/devices/socX interface.

Add the missing omap_soc_device_init() calls for these devices.

Signed-off-by: Rajendra Nayak <rnayak@ti.com>
(cherry picked from commit eea497ee2895101f0eeac36168deaba1c1047ee9)

Conflicts:
	arch/arm/mach-omap2/io.c
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-omap2/board-generic.c |    1 +
 arch/arm/mach-omap2/common.h        |    1 +
 arch/arm/mach-omap2/id.c            |    4 ++++
 arch/arm/mach-omap2/io.c            |    2 ++
 4 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-omap2/board-generic.c b/arch/arm/mach-omap2/board-generic.c
index 519f635..110f127 100644
--- a/arch/arm/mach-omap2/board-generic.c
+++ b/arch/arm/mach-omap2/board-generic.c
@@ -230,6 +230,7 @@ DT_MACHINE_START(AM43_DT, "Generic AM43 (Flattened Device Tree)")
 	.init_late	= am43xx_init_late,
 	.init_irq	= omap_gic_of_init,
 	.init_machine	= omap_generic_init,
+	.init_late	= am33xx_init_late,
 	.init_time	= omap3_sync32k_timer_init,
 	.dt_compat	= am43_boards_compat,
 	.restart	= am43xx_restart,
diff --git a/arch/arm/mach-omap2/common.h b/arch/arm/mach-omap2/common.h
index 6ef1409..196aa21 100644
--- a/arch/arm/mach-omap2/common.h
+++ b/arch/arm/mach-omap2/common.h
@@ -110,6 +110,7 @@ void am43xx_init_late(void);
 void omap4430_init_early(void);
 void omap5_init_early(void);
 void omap3_init_late(void);	/* Do not use this one */
+void am33xx_init_late(void);
 void omap4430_init_late(void);
 void omap2420_init_late(void);
 void omap2430_init_late(void);
diff --git a/arch/arm/mach-omap2/id.c b/arch/arm/mach-omap2/id.c
index 0289adc..e89d22d 100644
--- a/arch/arm/mach-omap2/id.c
+++ b/arch/arm/mach-omap2/id.c
@@ -645,6 +645,10 @@ static const char * __init omap_get_family(void)
 		return kasprintf(GFP_KERNEL, "OMAP4");
 	else if (soc_is_omap54xx())
 		return kasprintf(GFP_KERNEL, "OMAP5");
+	else if (soc_is_am33xx())
+		return kasprintf(GFP_KERNEL, "AM33xx");
+	else if (soc_is_am43xx())
+		return kasprintf(GFP_KERNEL, "AM43xx");
 	else
 		return kasprintf(GFP_KERNEL, "Unknown");
 }
diff --git a/arch/arm/mach-omap2/io.c b/arch/arm/mach-omap2/io.c
index 1c37656..a34d73e 100644
--- a/arch/arm/mach-omap2/io.c
+++ b/arch/arm/mach-omap2/io.c
@@ -603,6 +603,7 @@ void __init am33xx_init_late(void)
 	omap_device_force_mstandby_repeated();
 	omap2_common_pm_late_init();
 	am33xx_pm_init();
+	omap_soc_device_init();
 }
 #endif
 
@@ -694,6 +695,7 @@ void __init omap5_init_late(void)
 	omap2_common_suspend_init();
 	omap4_pm_init();
 	omap2_clk_enable_autoidle_all();
+	omap_soc_device_init();
 }
 #endif
 
-- 
1.7.5.4

