From df0be58651399ae9831600369649eef1525c25cf Mon Sep 17 00:00:00 2001
From: Suman Anna <s-anna@ti.com>
Date: Wed, 4 Dec 2013 23:17:22 -0600
Subject: [PATCH 0720/1115] ARM: OMAP: remoteproc: adjust the CMA pools for
 DRA7

The CMA base addresses and sizes are adjusted to meet the current
usecase requirements for the various processors for DRA7XX. The
IPU2 size is decreased by 112MB to account for the removal of
the OMAP camera stack, and the sizes for DSP1 and IPU1 are increased
to meet the current image needs. The CMA base addresses are also
adjusted and calculated using 0x95800000 as the starting base for
IPU2 and using the higher addresses for subsequent processors based
on the changed CMA pool sizes. The current CMA pool would end at
0x9F800000.

NOTE:
1. This requires the BIOS-side images to use matching addresses
   in the resource table, so older images with different resource
   tables may not boot after this change.
2. This change also helps with the enablement of fdt_high relocation
   in ti-u-boot, which causes the DT blob to occupy memory in the last
   MB before 0xA0000000 (fdt_high value) and thereby resulting in the
   failure of one of the rproc CMA pools.

Signed-off-by: Suman Anna <s-anna@ti.com>
(cherry picked from commit 62c47af0d9600d1574e123b2b082dcbff9590cbb)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-omap2/remoteproc.c |   14 ++++++++------
 1 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/arch/arm/mach-omap2/remoteproc.c b/arch/arm/mach-omap2/remoteproc.c
index 9ab8ba6..52c9920 100644
--- a/arch/arm/mach-omap2/remoteproc.c
+++ b/arch/arm/mach-omap2/remoteproc.c
@@ -66,9 +66,9 @@ static void dra7_ctrl_write_dsp2_boot_addr(u32 bootaddr);
  * Placing these in Kconfig is not worth the complexity.
  */
 #define DRA7_RPROC_CMA_BASE_IPU2	(0x95800000)
-#define DRA7_RPROC_CMA_BASE_DSP1	(0x95000000)
-#define DRA7_RPROC_CMA_BASE_DSP2	(0x94800000)
-#define DRA7_RPROC_CMA_BASE_IPU1	(0x94000000)
+#define DRA7_RPROC_CMA_BASE_DSP1	(0x99000000)
+#define DRA7_RPROC_CMA_BASE_IPU1	(0x9D000000)
+#define DRA7_RPROC_CMA_BASE_DSP2	(0x9F000000)
 
 #define OMAP5_RPROC_CMA_BASE_IPU	(0x95800000)
 #define OMAP5_RPROC_CMA_BASE_DSP	(0x95000000)
@@ -77,10 +77,12 @@ static void dra7_ctrl_write_dsp2_boot_addr(u32 bootaddr);
 #define OMAP4_RPROC_CMA_BASE_DSP	(0x98800000)
 
 #define OMAP_RPROC_CMA_SIZE_DSP		(0x800000)
+#define DRA7_RPROC_CMA_SIZE_DSP1	(0x4000000)
 
 #define OMAP4_RPROC_CMA_SIZE_IPU	(0x7000000)
 #define OMAP5_RPROC_CMA_SIZE_IPU	(0xA400000)
-#define DRA7_RPROC_CMA_SIZE_IPU1	(0x800000)
+#define DRA7_RPROC_CMA_SIZE_IPU2	(0x3800000)
+#define DRA7_RPROC_CMA_SIZE_IPU1	(0x2000000)
 
 /*
  * These data structures define the desired timers that would
@@ -260,7 +262,7 @@ static struct omap_rproc_pdev_data dra7_rproc_pdev_data[] = {
 #endif
 		.pdev = &omap4_dsp,
 		.cma_addr = DRA7_RPROC_CMA_BASE_DSP1,
-		.cma_size = OMAP_RPROC_CMA_SIZE_DSP,
+		.cma_size = DRA7_RPROC_CMA_SIZE_DSP1,
 	},
 	{
 #ifdef CONFIG_OMAP_REMOTEPROC_IPU
@@ -268,7 +270,7 @@ static struct omap_rproc_pdev_data dra7_rproc_pdev_data[] = {
 #endif
 		.pdev = &omap4_ipu,
 		.cma_addr = DRA7_RPROC_CMA_BASE_IPU2,
-		.cma_size = OMAP5_RPROC_CMA_SIZE_IPU,
+		.cma_size = DRA7_RPROC_CMA_SIZE_IPU2,
 	},
 	{
 #ifdef CONFIG_OMAP_REMOTEPROC_DSP2
-- 
1.7.5.4

