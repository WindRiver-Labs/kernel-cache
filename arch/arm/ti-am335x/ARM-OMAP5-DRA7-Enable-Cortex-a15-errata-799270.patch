From 7d8c6b84bf75955391940ab742a68e6006c4a50d Mon Sep 17 00:00:00 2001
From: Sricharan R <r.sricharan@ti.com>
Date: Wed, 20 Nov 2013 16:56:25 +0530
Subject: [PATCH 0679/1115] ARM: OMAP5/DRA7: Enable Cortex-a15 errata 799270

Enabling the erratum for OMAP5/DRA7 platforms.

Signed-off-by: Sricharan R <r.sricharan@ti.com>
(cherry picked from commit e9f0f5a6229be46c5c0afdf49e49635e1456e7d9)

Conflicts:
	arch/arm/mach-omap2/Kconfig
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-omap2/Kconfig     |    2 ++
 arch/arm/mach-omap2/sleep44xx.S |   14 +++++++++++++-
 2 files changed, 15 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-omap2/Kconfig b/arch/arm/mach-omap2/Kconfig
index 1d119bd..99c17e2 100644
--- a/arch/arm/mach-omap2/Kconfig
+++ b/arch/arm/mach-omap2/Kconfig
@@ -62,6 +62,7 @@ config SOC_OMAP5
 	select COMMON_CLK
 	select HAVE_ARM_ARCH_TIMER
 	select ARM_ERRATA_798181 if SMP
+	select ARM_ERRATA_799270
 
 config SOC_AM33XX
 	bool "TI AM33XX"
@@ -130,6 +131,7 @@ config SOC_DRA7XX
 	select ARCH_HAS_RESET_CONTROLLER
 	select RESET_TI
 	select PCI
+	select ARM_ERRATA_799270
 
 comment "OMAP Core Type"
 	depends on ARCH_OMAP2
diff --git a/arch/arm/mach-omap2/sleep44xx.S b/arch/arm/mach-omap2/sleep44xx.S
index 90c1697..a8549dfb 100644
--- a/arch/arm/mach-omap2/sleep44xx.S
+++ b/arch/arm/mach-omap2/sleep44xx.S
@@ -19,7 +19,7 @@
 #include "common.h"
 #include "omap44xx.h"
 #include "omap4-sar-layout.h"
-
+#include <../arch/arm/mm/proc-macros.S>
 #if defined(CONFIG_SMP) && defined(CONFIG_PM)
 
 .macro	DO_SMC
@@ -135,11 +135,17 @@ scu_gp_set:
 skip_scu_gp_set:
 	mrc	p15, 0, r0, c1, c1, 2		@ Read NSACR data
 	tst	r0, #(1 << 18)
+#ifdef CONFIG_ARM_ERRATA_799270
+	beq	1f
+	clear_actlr_smp r0, r8
+#else
 	mrcne	p15, 0, r0, c1, c0, 1
 	bicne	r0, r0, #(1 << 6)		@ Disable SMP bit
 	mcrne	p15, 0, r0, c1, c0, 1
 	isb
 	dsb
+#endif
+1:
 #ifdef CONFIG_CACHE_L2X0
 	/*
 	 * Clean and invalidate the L2 cache.
@@ -210,9 +216,15 @@ do_WFI:
 	 */
 	mrc	p15, 0, r0, c1, c0, 1
 	tst	r0, #(1 << 6)			@ Check SMP bit enabled?
+#ifdef CONFIG_ARM_ERRATA_799270
+	bne	1f
+	write_actlr_smp	r0, r8
+#else
 	orreq	r0, r0, #(1 << 6)
 	mcreq	p15, 0, r0, c1, c0, 1
 	isb
+#endif
+1:
 	bl	omap4_get_sar_ram_base
 	mov	r8, r0
 	ldr	r9, [r8, #OMAP_TYPE_OFFSET]
-- 
1.7.5.4

