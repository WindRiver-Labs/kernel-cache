From 105e131446cb51da807bb42cb0568598868549b5 Mon Sep 17 00:00:00 2001
From: Tomi Valkeinen <tomi.valkeinen@ti.com>
Date: Mon, 28 Oct 2013 11:47:39 +0200
Subject: [PATCH 0747/1115] OMAPDSS: HDMI5: use no-idle when reading edid

The HDMI core uses DSS L3 ICLK as a functional clock (or that is what it
seems like). This means that if the ICLK may be gated automatically
resulting in very slow EDID reading.

Set the HDMI's IDLEMODE to no-idle for the duration of the EDID reading
so that the ICLK will not be gated.

Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ti.com>
Cc: Tero Kristo <t-kristo@ti.com>
Cc: Nishanth Menon <nm@ti.com>
(cherry picked from commit 501393f5682e3d9e2810cc9a10d04357a6fac8a1)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/video/omap2/dss/hdmi5.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/drivers/video/omap2/dss/hdmi5.c b/drivers/video/omap2/dss/hdmi5.c
index d32aae7..c71fedf 100644
--- a/drivers/video/omap2/dss/hdmi5.c
+++ b/drivers/video/omap2/dss/hdmi5.c
@@ -345,14 +345,21 @@ static void hdmi_dump_regs(struct seq_file *s)
 static int read_edid(u8 *buf, int len)
 {
 	int r;
+	int idlemode;
 
 	mutex_lock(&hdmi.lock);
 
 	r = hdmi_runtime_get();
 	BUG_ON(r);
 
+	idlemode = REG_GET(hdmi.wp.base, HDMI_WP_SYSCONFIG, 3, 2);
+	/* No-idle mode */
+	REG_FLD_MOD(hdmi.wp.base, HDMI_WP_SYSCONFIG, 1, 3, 2);
+
 	r = hdmi5_read_edid(&hdmi.core,  buf, len);
 
+	REG_FLD_MOD(hdmi.wp.base, HDMI_WP_SYSCONFIG, idlemode, 3, 2);
+
 	hdmi_runtime_put();
 	mutex_unlock(&hdmi.lock);
 
-- 
1.7.5.4

