From f7fec79f9ba918c64be5108cacbec0cdc38ae77f Mon Sep 17 00:00:00 2001
From: Ido Yariv <ido@wizery.com>
Date: Tue, 30 Apr 2013 11:06:06 +0300
Subject: [PATCH 1093/1115] mmc: omap_hsmmc: Power down capable mmc slots

Even with DT, some slots can (and should) be powered off, as not all
slots rely on pbias cell programming.

Use the POWER_OFF_CARD capability to signal that it's OK to power down
the card. Cards which rely on pbias should not have this capability set.

Signed-off-by: Ido Yariv <ido@wizery.com>
Signed-off-by: Eliad Peller <eliad@wizery.com>
(cherry picked from commit 31993a25ad862606591e78c8d31441cd9916fbb7)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/mmc/host/omap_hsmmc.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/mmc/host/omap_hsmmc.c b/drivers/mmc/host/omap_hsmmc.c
index d254b76..fd6cfb9 100644
--- a/drivers/mmc/host/omap_hsmmc.c
+++ b/drivers/mmc/host/omap_hsmmc.c
@@ -294,8 +294,11 @@ static int omap_hsmmc_set_power(struct device *dev, int slot, int power_on,
 	 * With DT, never turn OFF the regulator for MMC1. This is because
 	 * the pbias cell programming support is still missing when
 	 * booting with Device tree
+	 * To support slots which are not affected by the above missing
+	 * functionally, power down if MMC_CAP_POWER_OFF_CARD is set.
 	 */
-	if (host->pbias_disable && !vdd)
+	if (host->pbias_disable && !vdd &&
+	    !(host->mmc->caps & MMC_CAP_POWER_OFF_CARD))
 		return 0;
 
 	if (mmc_slot(host).before_set_reg)
-- 
1.7.5.4

