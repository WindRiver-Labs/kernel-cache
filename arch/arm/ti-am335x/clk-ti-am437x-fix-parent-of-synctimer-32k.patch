From b91ffae3fce2ab3929498a79b29226bda6f5adb5 Mon Sep 17 00:00:00 2001
From: Sekhar Nori <nsekhar@ti.com>
Date: Mon, 21 Oct 2013 14:55:25 +0530
Subject: [PATCH 0835/1115] clk: ti: am437x: fix parent of synctimer 32k

The external 32KHz RTC clock source may not always be available
on board like in the case of ePOS EVM. By default sync timer, which
is used as clock source, feeds of this clock. This is a problem.
Change the parent of sync timer to PER PLL 32KHz clock instead
which is always present. This has a side effect that in low power
modes, sync timer will stop.

Signed-off-by: Sekhar Nori <nsekhar@ti.com>
Acked-by: Tero Kristo <t-kristo@ti.com>
(cherry picked from commit 93776e1a9dc12afdd20c12cb78655315a7d1d9ad)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/clk/ti/clk-43xx.c |   14 ++++++++++++++
 1 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/drivers/clk/ti/clk-43xx.c b/drivers/clk/ti/clk-43xx.c
index 3067f0a..16e41b6 100644
--- a/drivers/clk/ti/clk-43xx.c
+++ b/drivers/clk/ti/clk-43xx.c
@@ -112,11 +112,25 @@ static struct omap_dt_clk am43xx_clks[] = {
 
 int __init am43xx_clk_init(void)
 {
+	struct clk *clk1, *clk2;
+
 	of_clk_init(NULL);
 
 	omap_dt_clocks_register(am43xx_clks);
 
 	omap2_clk_disable_autoidle_all();
 
+	/*
+	 * The external 32KHz RTC clock source may not always be available
+	 * on board like in the case of ePOS EVM. By default sync timer, which
+	 * is used as clock source, feeds of this clock. This is a problem.
+	 * Change the parent of sync timer to PER PLL 32KHz clock instead
+	 * which is always present. This has a side effect that in low power
+	 * modes, sync timer will stop.
+	 */
+	clk1 = clk_get_sys(NULL, "mux_synctimer32k_ck");
+	clk2 = clk_get_sys(NULL, "clkdiv32k_ick");
+	clk_set_parent(clk1, clk2);
+
 	return 0;
 }
-- 
1.7.5.4

