From 18757d8ceb03d452d7d8d7a33bc7cd34c1a107b2 Mon Sep 17 00:00:00 2001
From: Suman Anna <s-anna@ti.com>
Date: Wed, 20 Nov 2013 17:05:19 -0600
Subject: [PATCH 0838/1115] CLK: TI: OMAP5: initialize IVA DPLL and associated
 output clocks

The IVA DPLL may not be usually configured by bootloader (e.g. u-boot
configures it only if CONFIG_SYS_CLOCKS_ENABLE_ALL is enabled), and
this results in various issues when trying to use a DSP or IVAHD,
whose root clocks are sourced from this DPLL. Initialize the IVA DPLL
at boot time to avoid the functional issues caused when using either
of these devices if the DPLL is not-locked. The DPLL will automatically
transition into a low-power stop mode when the associated output clocks
are not utilized or gated automatically.

The reset values of the dividers H11 & H12 are identical to each other,
but are different at each OPP. The reset values also may not match a
specific OPP. So, the derived output clocks from the IVA DPLL have to
be initialized as well (OPP100 values chosen currently) to avoid
initializing these divider outputs to incorrect frequencies.

Signed-off-by: Suman Anna <s-anna@ti.com>
(cherry picked from commit b15d17244c7db3e737771d0c0daf50f2c2dd9666)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/clk/ti/clk-54xx.c |   47 ++++++++++++++++++++++++++++++++++----------
 1 files changed, 36 insertions(+), 11 deletions(-)

diff --git a/drivers/clk/ti/clk-54xx.c b/drivers/clk/ti/clk-54xx.c
index b1163b7..88efdc1 100644
--- a/drivers/clk/ti/clk-54xx.c
+++ b/drivers/clk/ti/clk-54xx.c
@@ -25,6 +25,18 @@
  */
 #define OMAP5_DPLL_USB_DEFFREQ				960000000
 
+/*
+ * OMAP5 IVA DPLL frequency settings. The recommended maximum DPLL locked
+ * frequency is 2330 MHz for OPP_LOW & OPP_NOM (value for DPLL_IVA_X2_CLK),
+ * so the DPLL_IVA_DEFFREQ is defined to be half of this value. Note that
+ * the value 1164.8 MHz is chosen so that the DPLL can be locked with proper
+ * M & N divider values. The output clock values are based on the OPP_NOM
+ * frequencies for DSP and IVAHD subsystems.
+ */
+#define OMAP5_DPLL_IVA_DEFFREQ				1164800000
+#define OMAP5_DSP_GCLK_NOMFREQ				466000000
+#define OMAP5_IVA_GCLK_NOMFREQ				388300000
+
 static struct omap_dt_clk omap54xx_clks[] = {
 	DT_CLK(NULL, "pad_clks_src_ck", "pad_clks_src_ck"),
 	DT_CLK(NULL, "pad_clks_ck", "pad_clks_ck"),
@@ -183,17 +195,6 @@ static struct omap_dt_clk omap54xx_clks[] = {
 	DT_CLK(NULL, "auxclk3_ck", "auxclk3_ck"),
 	DT_CLK(NULL, "auxclkreq3_ck", "auxclkreq3_ck"),
 	DT_CLK(NULL, "timer_32k_ck", "sys_32k_ck"),
-	DT_CLK("omap_timer.1", "sys_ck", "sys_clkin"),
-	DT_CLK("omap_timer.2", "sys_ck", "sys_clkin"),
-	DT_CLK("omap_timer.3", "sys_ck", "sys_clkin"),
-	DT_CLK("omap_timer.4", "sys_ck", "sys_clkin"),
-	DT_CLK("omap_timer.9", "sys_ck", "sys_clkin"),
-	DT_CLK("omap_timer.10", "sys_ck", "sys_clkin"),
-	DT_CLK("omap_timer.11", "sys_ck", "sys_clkin"),
-	DT_CLK("omap_timer.5", "sys_ck", "dss_syc_gfclk_div"),
-	DT_CLK("omap_timer.6", "sys_ck", "dss_syc_gfclk_div"),
-	DT_CLK("omap_timer.7", "sys_ck", "dss_syc_gfclk_div"),
-	DT_CLK("omap_timer.8", "sys_ck", "dss_syc_gfclk_div"),
 	{ .node_name = NULL },
 };
 
@@ -201,6 +202,7 @@ int __init omap5xxx_clk_init(void)
 {
 	int rc;
 	struct clk *abe_dpll_ref, *abe_dpll, *sys_32k_ck, *usb_dpll;
+	struct clk *iva_dpll, *iva_h11x2_dpll, *iva_h12x2_dpll;
 
 	of_clk_init(NULL);
 
@@ -227,5 +229,28 @@ int __init omap5xxx_clk_init(void)
 	if (rc)
 		pr_err("%s: failed to set USB_DPLL M2 OUT\n", __func__);
 
+	/*
+	 * Lock the IVA DPLL and its derivative clocks so that the DSP and
+	 * IVA processors are running at nominal operating points rather
+	 * than at a bypass clock rate or at a misconfigured output rate.
+	 */
+	iva_dpll = clk_get_sys(NULL, "dpll_iva_ck");
+	rc = clk_set_rate(iva_dpll, OMAP5_DPLL_IVA_DEFFREQ);
+	if (!rc) {
+		iva_h11x2_dpll = clk_get_sys(NULL, "dpll_iva_h11x2_ck");
+		rc = clk_set_rate(iva_h11x2_dpll, OMAP5_DSP_GCLK_NOMFREQ);
+		if (rc)
+			pr_err("%s: failed to configure IVA DPLL h11x2 divider!\n",
+			       __func__);
+
+		iva_h12x2_dpll = clk_get_sys(NULL, "dpll_iva_h12x2_ck");
+		rc = clk_set_rate(iva_h12x2_dpll, OMAP5_IVA_GCLK_NOMFREQ);
+		if (rc)
+			pr_err("%s: failed to configure IVA DPLL h12x2 divider!\n",
+			       __func__);
+	} else {
+		pr_err("%s: failed to configure IVA DPLL!\n", __func__);
+	}
+
 	return 0;
 }
-- 
1.7.5.4

