From 49fd24d292c29a3dba35abc7fd7ab9db0c45cdad Mon Sep 17 00:00:00 2001
From: Sekhar Nori <nsekhar@ti.com>
Date: Tue, 22 Oct 2013 14:03:44 +0530
Subject: [PATCH 0625/1115] ARM: OMAP2+: AM43xx: implement support for machine
 restart

Add restart hook so that AM4372 builds can restart the platform.

Signed-off-by: Sekhar Nori <nsekhar@ti.com>
(cherry picked from commit 07188aba309877c42fd137efd71b58c1caa7e161)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-omap2/Makefile         |    1 +
 arch/arm/mach-omap2/am33xx-restart.c |   23 +++++++++++++++++++++++
 arch/arm/mach-omap2/board-generic.c  |    1 +
 arch/arm/mach-omap2/common.h         |    8 ++++++++
 4 files changed, 33 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-omap2/Makefile b/arch/arm/mach-omap2/Makefile
index 28515a6..a1f72b2 100644
--- a/arch/arm/mach-omap2/Makefile
+++ b/arch/arm/mach-omap2/Makefile
@@ -60,6 +60,7 @@ AFLAGS_sram34xx.o			:=-Wa,-march=armv7-a
 obj-$(CONFIG_SOC_OMAP2420)		+= omap2-restart.o
 obj-$(CONFIG_SOC_OMAP2430)		+= omap2-restart.o
 obj-$(CONFIG_SOC_AM33XX)		+= am33xx-restart.o
+obj-$(CONFIG_SOC_AM43XX)		+= am33xx-restart.o
 obj-$(CONFIG_ARCH_OMAP3)		+= omap3-restart.o
 obj-$(CONFIG_ARCH_OMAP4)		+= omap4-restart.o
 obj-$(CONFIG_SOC_OMAP5)			+= omap4-restart.o
diff --git a/arch/arm/mach-omap2/am33xx-restart.c b/arch/arm/mach-omap2/am33xx-restart.c
index a52e3b5..3c230cd 100644
--- a/arch/arm/mach-omap2/am33xx-restart.c
+++ b/arch/arm/mach-omap2/am33xx-restart.c
@@ -8,6 +8,7 @@
 #include <linux/kernel.h>
 
 #include "common.h"
+#include "prcm43xx.h"
 #include "prm-regbits-33xx.h"
 #include "prm33xx.h"
 
@@ -32,3 +33,25 @@ void am33xx_restart(char mode, const char *cmd)
 	(void)am33xx_prm_read_reg(AM33XX_PRM_DEVICE_MOD,
 				  AM33XX_PRM_RSTCTRL_OFFSET);
 }
+
+/**
+ * am43xx_restart - trigger a software restart of the SoC
+ * @mode: the "reboot mode", see arch/arm/kernel/{setup,process}.c
+ * @cmd: passed fr-om the userspace program rebooting the system (if provided)
+ *
+ * Resets the SoC.  For @cmd, see the 'reboot' syscall in
+ * kernel/sys.c.  No return value.
+ */
+void am43xx_restart(enum reboot_mode mode, const char *cmd)
+{
+	/* TODO: Handle mode and cmd if necessary */
+
+	am33xx_prm_rmw_reg_bits(AM33XX_RST_GLOBAL_WARM_SW_MASK,
+				AM33XX_RST_GLOBAL_WARM_SW_MASK,
+				AM43XX_PRM_DEVICE_INST,
+				AM33XX_PRM_RSTCTRL_OFFSET);
+
+	/* OCP barrier */
+	(void)am33xx_prm_read_reg(AM43XX_PRM_DEVICE_INST,
+				  AM33XX_PRM_RSTCTRL_OFFSET);
+}
diff --git a/arch/arm/mach-omap2/board-generic.c b/arch/arm/mach-omap2/board-generic.c
index f13adc6..4e2a5be 100644
--- a/arch/arm/mach-omap2/board-generic.c
+++ b/arch/arm/mach-omap2/board-generic.c
@@ -230,6 +230,7 @@ DT_MACHINE_START(AM43_DT, "Generic AM43 (Flattened Device Tree)")
 	.init_machine	= omap_generic_init,
 	.init_time	= omap3_sync32k_timer_init,
 	.dt_compat	= am43_boards_compat,
+	.restart	= am43xx_restart,
 MACHINE_END
 #endif
 
diff --git a/arch/arm/mach-omap2/common.h b/arch/arm/mach-omap2/common.h
index af6a4f8..c94ea40 100644
--- a/arch/arm/mach-omap2/common.h
+++ b/arch/arm/mach-omap2/common.h
@@ -148,6 +148,14 @@ static inline void am33xx_restart(char mode, const char *cmd)
 }
 #endif
 
+#ifdef CONFIG_SOC_AM43XX
+void am43xx_restart(enum reboot_mode mode, const char *cmd);
+#else
+static inline void am43xx_restart(enum reboot_mode mode, const char *cmd)
+{
+}
+#endif
+
 #ifdef CONFIG_ARCH_OMAP3
 void omap3xxx_restart(char mode, const char *cmd);
 #else
-- 
1.7.5.4

