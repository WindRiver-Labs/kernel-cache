From 80a0c6464c8796bbde3c7c411b7a2832ef89deb8 Mon Sep 17 00:00:00 2001
From: Eliad Peller <eliad@wizery.com>
Date: Mon, 29 Apr 2013 01:00:18 +0300
Subject: [PATCH 0417/1115] arm: edma: fix dt array parsing

edma_of_read_u32_to_s16_array() parsed dt arrays wrong -
it used incorrect size (parsed the array as u16 instead
of u32) and always overrode the first elemts with
termination values, resulting in empty array.

Fix it by using an intermediate u32 array.

NOTE: the same should be done for edma_of_read_u32_to_s8_array.

Signed-off-by: Ido Yariv <ido@wizery.com>
Signed-off-by: Eliad Peller <eliad@wizery.com>
(cherry picked from commit d512949b4b85f7080f6891dc66ea8cae78ac71e3)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/common/edma.c |   21 ++++++++++++++++-----
 1 files changed, 16 insertions(+), 5 deletions(-)

diff --git a/arch/arm/common/edma.c b/arch/arm/common/edma.c
index 915f424..0d6d3dc 100644
--- a/arch/arm/common/edma.c
+++ b/arch/arm/common/edma.c
@@ -1417,16 +1417,27 @@ static int edma_of_read_u32_to_s16_array(const struct device_node *np,
 					 size_t sz)
 {
 	int ret;
+	int i;
+	u32 *arr;
+
+	arr = kcalloc(sz, sizeof(u32), GFP_KERNEL);
+	if (!arr)
+		return -ENOMEM;
 
-	ret = of_property_read_u16_array(np, propname, out_values, sz);
+	ret = of_property_read_u32_array(np, propname, arr, sz);
 	if (ret)
-		return ret;
+		goto out;
+
+	for (i = 0; i < sz; i++)
+		out_values[i] = (s16) arr[i];
 
 	/* Terminate it */
-	*out_values++ = -1;
-	*out_values++ = -1;
+	out_values[sz++] = -1;
+	out_values[sz++] = -1;
 
-	return 0;
+out:
+	kfree(arr);
+	return ret;
 }
 
 static int edma_xbar_event_map(struct device *dev,
-- 
1.7.5.4

