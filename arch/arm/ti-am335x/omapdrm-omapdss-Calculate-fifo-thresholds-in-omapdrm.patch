From 20075123ec9be8629757d7aeecfe7fde4e6a5d23 Mon Sep 17 00:00:00 2001
From: Archit Taneja <archit@ti.com>
Date: Fri, 25 Oct 2013 20:23:22 +0530
Subject: [PATCH 0751/1115] omapdrm/omapdss: Calculate fifo thresholds in
 omapdrm driver

omapdss in compat mode calculates fifo threhsolds in APPLY. However, when
not in compat mode, it expected the omapdss user(omapdrm) to configure the
thresholds.

This currently isn't being done by omapdrm. Call threshold calculation and
setup functions to make sure the thresholds are configured correctly by
omapdrm.

Signed-off-by: Archit Taneja <archit@ti.com>
(cherry picked from commit e3bd468eaac441feb886730525f76ac590c6ebb6)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpu/drm/omapdrm/omap_plane.c |    5 +++++
 drivers/video/omap2/dss/dss.h        |    6 ------
 include/video/omapdss.h              |    4 ++++
 3 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/drivers/gpu/drm/omapdrm/omap_plane.c b/drivers/gpu/drm/omapdrm/omap_plane.c
index 8d225d7..a9016ca 100644
--- a/drivers/gpu/drm/omapdrm/omap_plane.c
+++ b/drivers/gpu/drm/omapdrm/omap_plane.c
@@ -126,6 +126,7 @@ static void omap_plane_pre_apply(struct omap_drm_apply *apply)
 	enum omap_channel channel;
 	bool enabled = omap_plane->enabled && crtc;
 	bool ilace, replication;
+	u32 low, high;
 	int ret;
 
 	DBG("%s, enabled=%d", omap_plane->name, enabled);
@@ -153,6 +154,10 @@ static void omap_plane_pre_apply(struct omap_drm_apply *apply)
 	ilace = false;
 	replication = false;
 
+	dispc_ovl_compute_fifo_thresholds(omap_plane->id, &low, &high,
+		false, false);
+	dispc_ovl_set_fifo_threshold(omap_plane->id, low, high);
+
 	/* and finally, update omapdss: */
 	ret = dispc_ovl_setup(omap_plane->id, info,
 			replication, omap_crtc_timings(crtc), false);
diff --git a/drivers/video/omap2/dss/dss.h b/drivers/video/omap2/dss/dss.h
index 91946cf..64ae87e 100644
--- a/drivers/video/omap2/dss/dss.h
+++ b/drivers/video/omap2/dss/dss.h
@@ -416,12 +416,6 @@ unsigned long dispc_fclk_rate(void);
 int dispc_calc_clock_rates(unsigned long dispc_fclk_rate,
 		struct dispc_clock_info *cinfo);
 
-
-void dispc_ovl_set_fifo_threshold(enum omap_plane plane, u32 low, u32 high);
-void dispc_ovl_compute_fifo_thresholds(enum omap_plane plane,
-		u32 *fifo_low, u32 *fifo_high, bool use_fifomerge,
-		bool manual_update);
-
 unsigned long dispc_mgr_lclk_rate(enum omap_channel channel);
 unsigned long dispc_mgr_pclk_rate(enum omap_channel channel);
 unsigned long dispc_core_clk_rate(void);
diff --git a/include/video/omapdss.h b/include/video/omapdss.h
index e68da23..8d99e68 100644
--- a/include/video/omapdss.h
+++ b/include/video/omapdss.h
@@ -980,6 +980,10 @@ int dispc_ovl_enable(enum omap_plane plane, bool enable);
 bool dispc_ovl_enabled(enum omap_plane plane);
 void dispc_ovl_set_channel_out(enum omap_plane plane,
 		enum omap_channel channel);
+void dispc_ovl_compute_fifo_thresholds(enum omap_plane plane,
+		u32 *fifo_low, u32 *fifo_high, bool use_fifomerge,
+		bool manual_update);
+void dispc_ovl_set_fifo_threshold(enum omap_plane plane, u32 low, u32 high);
 int dispc_ovl_setup(enum omap_plane plane, const struct omap_overlay_info *oi,
 		bool replication, const struct omap_video_timings *mgr_timings,
 		bool mem_to_mem);
-- 
1.7.5.4

