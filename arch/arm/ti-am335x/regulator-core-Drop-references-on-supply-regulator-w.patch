From e07c33660517beeda2100d47e5528cf16947397f Mon Sep 17 00:00:00 2001
From: Mark Brown <broonie@linaro.org>
Date: Mon, 8 Jul 2013 09:14:45 +0100
Subject: [PATCH 0928/1115] regulator: core: Drop references on supply
 regulator when unregistering

Signed-off-by: Mark Brown <broonie@linaro.org>
(cherry picked from commit 891636ea27ef42d92a420185d2ccbe190ba00a23)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/regulator/core.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/regulator/core.c b/drivers/regulator/core.c
index 288c75a..1510333 100644
--- a/drivers/regulator/core.c
+++ b/drivers/regulator/core.c
@@ -3740,8 +3740,11 @@ void regulator_unregister(struct regulator_dev *rdev)
 	if (rdev == NULL)
 		return;
 
-	if (rdev->supply)
+	if (rdev->supply) {
+		while (rdev->use_count--)
+			regulator_disable(rdev->supply);
 		regulator_put(rdev->supply);
+	}
 	mutex_lock(&regulator_list_mutex);
 	debugfs_remove_recursive(rdev->debugfs);
 	flush_work(&rdev->disable_work.work);
-- 
1.7.5.4

