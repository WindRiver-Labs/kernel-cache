From 53568afd95c5fbb41e06151ac896e2bee015142b Mon Sep 17 00:00:00 2001
From: Archit Taneja <archit@ti.com>
Date: Tue, 10 Dec 2013 16:14:18 +0530
Subject: [PATCH 0768/1115] omapdss: dss dplls: Ignore PLL_PWR_STATUS on DRA7x

There is a bug in DRA7x hardware which prevents the correct update of
PLL_PWR_STATUS when the power state of DPLL_VIDEO1/2 is changed.

Currently, the driver reports the error but still proceeds ahead. Modify the
code such that we don't read the STATUS field at all and add a small delay
for the power state to change. The dss dpll driver is currently used only for
DRA7x, the fix can be added in a more cleaner manner once it is used for DSI
PLLs on previous OMAP revisions too.

Signed-off-by: Archit Taneja <archit@ti.com>
(cherry picked from commit 6fcc278af65423291e4aa59e0436bee7f95f9e9e)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/video/omap2/dss/dss_dpll.c |   13 +++++++++++--
 1 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/drivers/video/omap2/dss/dss_dpll.c b/drivers/video/omap2/dss/dss_dpll.c
index 71ed545..8c855b0 100644
--- a/drivers/video/omap2/dss/dss_dpll.c
+++ b/drivers/video/omap2/dss/dss_dpll.c
@@ -309,12 +309,21 @@ static int dpll_power(enum dss_dpll dpll, int state)
 	/* PLL_PWR_CMD = enable both hsdiv and clkout*/
 	REG_FLD_MOD(dpll, CLK_CTRL, state, 31, 30);
 
+	/*
+	 * PLL_PWR_STATUS doesn't correctly reflect the power state set on
+	 * DRA7xx. Ignore the reg field and add a small delay for the power
+	 * state to change.
+	 */
+	if (omapdss_get_version() == OMAPDSS_VER_DRA7xx) {
+		usleep_range(500, 1000);
+		return 0;
+	}
+
 	/* PLL_PWR_STATUS: (NOTE: apparently buggy) */
 	while (FLD_GET(dpll_read_reg(dpll, CLK_CTRL), 29, 28) != state) {
 		if (++t > 1000) {
 			DSSERR("Failed to set DPLL power mode to %d\n", state);
-			/* return -ENODEV; */
-			return 0;
+			return -ENODEV;
 		}
 		udelay(1);
 	}
-- 
1.7.5.4

