From 4637e0b504087df28ff7857805252fcc1e47eede Mon Sep 17 00:00:00 2001
From: Tomi Valkeinen <tomi.valkeinen@ti.com>
Date: Thu, 25 Apr 2013 14:53:18 +0300
Subject: [PATCH 0448/1115] OMAPDSS: output: increase refcount in find_output
 funcs

Now that omap_dss_output has been combined into omap_dss_device, we can
add ref counting for the relevant output functions also.

This patch adds omap_dss_get_device() calls to the various find_output()
style functions. This, of course, means that the users of those
find_output functions need to do a omap_dss_put_device() after use.

Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ti.com>
(cherry picked from commit 820caabf68e6ebddbb48cf1770338682cfa318c5)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpu/drm/omapdrm/omap_drv.c |    2 ++
 drivers/video/omap2/dss/output.c   |   13 +++++++++----
 2 files changed, 11 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/omapdrm/omap_drv.c b/drivers/gpu/drm/omapdrm/omap_drv.c
index 78a78c6..2c2316a 100644
--- a/drivers/gpu/drm/omapdrm/omap_drv.c
+++ b/drivers/gpu/drm/omapdrm/omap_drv.c
@@ -277,6 +277,8 @@ static int omap_modeset_init(struct drm_device *dev)
 			if (supported_outputs & output->id)
 				encoder->possible_crtcs |= (1 << id);
 		}
+
+		omap_dss_put_device(output);
 	}
 
 	DBG("registered %d planes, %d crtcs, %d encoders and %d connectors\n",
diff --git a/drivers/video/omap2/dss/output.c b/drivers/video/omap2/dss/output.c
index cc81fec..9ad7d21 100644
--- a/drivers/video/omap2/dss/output.c
+++ b/drivers/video/omap2/dss/output.c
@@ -121,7 +121,7 @@ struct omap_dss_device *omap_dss_find_output(const char *name)
 
 	list_for_each_entry(out, &output_list, list) {
 		if (strcmp(out->name, name) == 0)
-			return out;
+			return omap_dss_get_device(out);
 	}
 
 	return NULL;
@@ -134,7 +134,7 @@ struct omap_dss_device *omap_dss_find_output_by_node(struct device_node *node)
 
 	list_for_each_entry(out, &output_list, list) {
 		if (out->dev->of_node == node)
-			return out;
+			return omap_dss_get_device(out);
 	}
 
 	return NULL;
@@ -143,20 +143,25 @@ EXPORT_SYMBOL(omap_dss_find_output_by_node);
 
 struct omap_dss_device *omapdss_find_output_from_display(struct omap_dss_device *dssdev)
 {
-	return dssdev->output;
+	return omap_dss_get_device(dssdev->output);
 }
 EXPORT_SYMBOL(omapdss_find_output_from_display);
 
 struct omap_overlay_manager *omapdss_find_mgr_from_display(struct omap_dss_device *dssdev)
 {
 	struct omap_dss_device *out;
+	struct omap_overlay_manager *mgr;
 
 	out = omapdss_find_output_from_display(dssdev);
 
 	if (out == NULL)
 		return NULL;
 
-	return out->manager;
+	mgr = out->manager;
+
+	omap_dss_put_device(out);
+
+	return mgr;
 }
 EXPORT_SYMBOL(omapdss_find_mgr_from_display);
 
-- 
1.7.5.4

