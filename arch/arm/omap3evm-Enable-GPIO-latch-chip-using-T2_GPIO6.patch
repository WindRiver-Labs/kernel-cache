From 56e7f79c47c3fec21fbbaad6a1e75467fbb76f40 Mon Sep 17 00:00:00 2001
From: Ajay Kumar Gupta <ajay.gupta@ti.com>
Date: Mon, 4 Jan 2010 13:24:31 +0530
Subject: [PATCH 1/9] omap3evm: Enable GPIO latch chip using T2_GPIO6

This has to be done to enable U131 chip used to latch USB, Camera and
Audio lines.

Should be done in generic way at board files.

Revert once generic implementation completed.

[picked from http://arago-project.org/git/projects/linux-omap3.git]

Signed-off-by: Ajay Kumar Gupta <ajay.gupta@ti.com>
Integrated-by: Wang Hui <hui.wang@windriver.com>
---
 drivers/mfd/twl-core.c |   28 ++++++++++++++++++++++++++++
 1 files changed, 28 insertions(+), 0 deletions(-)

diff --git a/drivers/mfd/twl-core.c b/drivers/mfd/twl-core.c
index 562cd49..2f8cfd1 100644
--- a/drivers/mfd/twl-core.c
+++ b/drivers/mfd/twl-core.c
@@ -38,6 +38,7 @@
 
 #include <linux/i2c.h>
 #include <linux/i2c/twl.h>
+#include <plat/board.h>
 
 #if defined(CONFIG_ARCH_OMAP2) || defined(CONFIG_ARCH_OMAP3)
 #include <plat/cpu.h>
@@ -954,6 +955,31 @@ static int twl_remove(struct i2c_client *client)
 	return 0;
 }
 
+#define TWL4030_VAUX2_1P8V 0x5
+#define ENABLE_VAUX2_DEV_GRP 0x20
+
+/* Enable USB GPIOs on new OMAP3EVM */
+static void usb_gpio_settings(void)
+{
+	unsigned char val;
+
+	if (get_omap3_evm_rev() < OMAP3EVM_BOARD_GEN_2)
+		return;
+
+	/* Enable TWL GPIO Module */
+	twl_i2c_write_u8(TWL4030_MODULE_GPIO, 0x04, REG_GPIO_CTRL);
+
+	/* Configure GPIO-6 as output */
+	twl_i2c_read_u8(TWL4030_MODULE_GPIO, &val, REG_GPIODATADIR1);
+	val |= 0x4;
+	twl_i2c_write_u8(TWL4030_MODULE_GPIO, val, REG_GPIODATADIR1);
+
+	/* Set GPIO6 = 1 */
+	twl_i2c_read_u8(TWL4030_MODULE_GPIO, &val, REG_GPIODATAOUT1);
+	val |= 0x40;
+	twl_i2c_write_u8(TWL4030_MODULE_GPIO, val, REG_GPIODATAOUT1);
+}
+
 /* NOTE:  this driver only handles a single twl4030/tps659x0 chip */
 static int __init
 twl_probe(struct i2c_client *client, const struct i2c_device_id *id)
@@ -1042,6 +1068,8 @@ twl_probe(struct i2c_client *client, const struct i2c_device_id *id)
 	}
 
 	status = add_children(pdata, id->driver_data);
+
+	usb_gpio_settings();
 fail:
 	if (status < 0)
 		twl_remove(client);
-- 
1.6.5.2

