From b86ed8dc6858aa2026c8badd6bbf9efbd8916c92 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Tue, 16 Jul 2013 17:36:14 +0800
Subject: [PATCH 30/57] ARM: keystone: add smc based secondary startup

Commit 1382327a45b55a53d31bf492e37faa182c69474d from arago tree
git://arago-project.org/git/projects/linux-keystone.git releases/03.00.00.11/master

When boot kernel is used, the primary core uses smc call to
power on and start secondary cores. This patch adds this
functionality.

Signed-off-by: Andrianov Vitaly Karicheri <vitalya@ti.com>
Signed-off-by: Murali Karicheri <m-karicheri2@ti.com>
Signed-off-by: Cyril Chemparathy <cyril@ti.com>
Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 arch/arm/mach-keystone/keystone.c |  1 +
 arch/arm/mach-keystone/platsmp.c  | 25 ++++++++++++++++++++-----
 2 files changed, 21 insertions(+), 5 deletions(-)

diff --git a/arch/arm/mach-keystone/keystone.c b/arch/arm/mach-keystone/keystone.c
index b26373a..d064b54 100644
--- a/arch/arm/mach-keystone/keystone.c
+++ b/arch/arm/mach-keystone/keystone.c
@@ -22,6 +22,7 @@
 #include <linux/platform_data/davinci-clock.h>
 
 #include <asm/setup.h>
+#include <asm/smp_plat.h>
 #include <asm/mach/map.h>
 #include <asm/mach/arch.h>
 #include <asm/mach/time.h>
diff --git a/arch/arm/mach-keystone/platsmp.c b/arch/arm/mach-keystone/platsmp.c
index f745a36..5fd3373 100644
--- a/arch/arm/mach-keystone/platsmp.c
+++ b/arch/arm/mach-keystone/platsmp.c
@@ -71,11 +71,26 @@ static void __cpuinit keystone_smp_secondary_init(unsigned int cpu)
 static int __cpuinit
 keystone_smp_boot_secondary(unsigned int cpu, struct task_struct *idle)
 {
-	unsigned long *ptr = (unsigned long *)(PAGE_OFFSET + 0x1f0);
-	ptr[cpu] = virt_to_idmap(&secondary_startup);
-	__cpuc_flush_dcache_area(ptr, sizeof(ptr) * 4);
-
-	return 0;
+ 	unsigned long start = virt_to_idmap(&secondary_startup);
+ 	int error;
+ 
+ 	pr_debug("keystone-smp: booting cpu %d, vector %08lx\n",
+ 		 cpu, start);
+ 
+ 	asm volatile (
+ 		"mov	r0, #0\n"	/* power on cmd */
+ 		"mov	r1, %1\n"	/* cpu          */
+ 		"mov	r2, %2\n"	/* start        */
+ 		".inst  0xe1600070\n"	/* SMI          */
+ 		"mov	%0, r0\n"
+ 		: "=r" (error)
+ 		: "r"(cpu), "r"(start)
+ 		: "cc", "r0", "r1", "r2", "memory"
+ 	);
+ 
+ 	pr_debug("keystone-smp: monitor returned %d\n", error);
+ 
+ 	return error;
 }
 
 #ifdef CONFIG_HOTPLUG_CPU
-- 
1.8.4.93.g57e4c17

