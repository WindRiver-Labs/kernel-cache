From 7a3d3448dbca7fd2d0679536f5f013094db9bed1 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Mon, 22 Jul 2013 14:53:53 +0800
Subject: [PATCH 39/57] ARM: keystone: add support for coherent dma

Commit 908f5d126c3ebdba233bf15d4a3b742baf074b21 from arago tree
git://arago-project.org/git/projects/linux-keystone.git releases/03.00.00.11/master

This patch adds a bus notifier that walks up the device tree, looking for a
"dma-coherent" property in the device's node, and its ancestors.  If this
property is found, the notifier callback applies coherent dma ops for the
device.

Signed-off-by: Cyril Chemparathy <cyril@ti.com>
Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 arch/arm/mach-keystone/keystone.c | 30 ++++++++++++++++++++++++++++++
 1 file changed, 30 insertions(+)

diff --git a/arch/arm/mach-keystone/keystone.c b/arch/arm/mach-keystone/keystone.c
index 915f815..4ee44d1 100644
--- a/arch/arm/mach-keystone/keystone.c
+++ b/arch/arm/mach-keystone/keystone.c
@@ -14,6 +14,7 @@
  * this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 #include <linux/delay.h>
+#include <linux/dma-mapping.h>
 #include <linux/io.h>
 #include <linux/of.h>
 #include <linux/init.h>
@@ -271,6 +272,34 @@ static struct sys_timer keystone_timer = {
 	.init = keystone_timer_init,
 };
 
+static bool is_coherent(struct device *dev)
+{
+	struct device_node *node = of_node_get(dev->of_node);
+
+	while (node) {
+		if (of_property_read_bool(node, "dma-coherent")) {
+			of_node_put(node);
+			return true;
+		}
+		node = of_get_next_parent(node);
+	}
+	return false;
+}
+
+static int keystone_platform_notifier(struct notifier_block *nb,
+				      unsigned long event, void *dev)
+{
+	if (event != BUS_NOTIFY_ADD_DEVICE)
+		return NOTIFY_DONE;
+
+	is_coherent(dev);
+
+	return NOTIFY_OK;
+}
+
+static struct notifier_block keystone_platform_nb = {
+	.notifier_call = keystone_platform_notifier,
+};
 
 static void __init keystone_init(void)
 {
@@ -279,6 +308,7 @@ static void __init keystone_init(void)
 	void (*func)(struct device_node *);
 
 	keystone_pm_runtime_init();
+	bus_register_notifier(&platform_bus_type, &keystone_platform_nb);
 	of_platform_populate(NULL, keystone_dt_match_table, NULL, NULL);
 
 	/* Initialize PCIE serdes */
-- 
1.8.4.93.g57e4c17

