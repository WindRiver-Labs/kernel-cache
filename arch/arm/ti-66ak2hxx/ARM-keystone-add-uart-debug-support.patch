From 8be96e308cb366579e010dea0f7180e23613363e Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Wed, 17 Jul 2013 10:13:25 +0800
Subject: [PATCH 33/57] ARM: keystone: add uart debug support

Commit 6b65277e812dac1aba9af3d7a73cd28e32a2cb1e from arago tree
git://arago-project.org/git/projects/linux-keystone.git releases/03.00.00.11/master

This patch adds UART based early debug support.

Signed-off-by: Cyril Chemparathy <cyril@ti.com>
Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 arch/arm/Kconfig.debug                            | 28 +++++++++++++
 arch/arm/mach-keystone/include/mach/debug-macro.S | 10 ++---
 arch/arm/mach-keystone/include/mach/serial.h      | 48 +++++++++++++++++++++++
 arch/arm/mach-keystone/include/mach/uncompress.h  | 32 +++++++++++++--
 4 files changed, 109 insertions(+), 9 deletions(-)
 create mode 100644 arch/arm/mach-keystone/include/mach/serial.h

diff --git a/arch/arm/Kconfig.debug b/arch/arm/Kconfig.debug
index 1d41908..fc6582c 100644
--- a/arch/arm/Kconfig.debug
+++ b/arch/arm/Kconfig.debug
@@ -160,6 +160,34 @@ choice
 		  If you have a ZC702 board and want early boot messages to
 		  appear on the USB serial adaptor, select this option.
 
+	config DEBUG_DAVINCI_TCI6614_UART0
+		bool "Kernel low-level debugging on TCI6614 using UART0"
+		depends on ARCH_KEYSTONE
+		help
+		  Say Y here if you want the debug print routines to direct
+		  their output to UART0 serial port on TCI6614 devices.
+
+	config DEBUG_DAVINCI_TCI6614_UART1
+		bool "Kernel low-level debugging on TCI6614 using UART1"
+		depends on ARCH_KEYSTONE
+		help
+		  Say Y here if you want the debug print routines to direct
+		  their output to UART1 serial port on TCI6614 devices.
+
+	config DEBUG_DAVINCI_TCI6638_UART0
+		bool "Kernel low-level debugging on TCI6638 using UART0"
+		depends on ARCH_KEYSTONE
+		help
+		  Say Y here if you want the debug print routines to direct
+		  their output to UART0 serial port on TCI6638 devices.
+
+	config DEBUG_DAVINCI_TCI6638_UART1
+		bool "Kernel low-level debugging on TCI6638 using UART1"
+		depends on ARCH_KEYSTONE
+		help
+		  Say Y here if you want the debug print routines to direct
+		  their output to UART1 serial port on TCI6638 devices.
+
 	config DEBUG_DC21285_PORT
 		bool "Kernel low-level debugging messages via footbridge serial port"
 		depends on FOOTBRIDGE
diff --git a/arch/arm/mach-keystone/include/mach/debug-macro.S b/arch/arm/mach-keystone/include/mach/debug-macro.S
index d1197d8..b19189f 100644
--- a/arch/arm/mach-keystone/include/mach/debug-macro.S
+++ b/arch/arm/mach-keystone/include/mach/debug-macro.S
@@ -17,18 +17,18 @@
  * You should have received a copy of the GNU General Public License along with
  * this program.  If not, see <http://www.gnu.org/licenses/>.
  */
+
 #include <linux/serial_reg.h>
 
+#include <mach/serial.h>
+
 #define UART_SHIFT	2
 
 	.macro	addruart,rp,rv,tmp
-	mov	\rv, #0x0c00
-	mov	\rv, #0xfed3
-	mov	\rp, #0x0c00
-	mov	\rp, #0x0253
+	ldr	\rv, =UART_VIRT
+	ldr	\rp, =UART_PHYS
 	.endm
 
-
 	.macro	senduart,rd,rx
 	str	\rd, [\rx, #UART_TX << UART_SHIFT]
 	.endm
diff --git a/arch/arm/mach-keystone/include/mach/serial.h b/arch/arm/mach-keystone/include/mach/serial.h
new file mode 100644
index 0000000..4f8c596
--- /dev/null
+++ b/arch/arm/mach-keystone/include/mach/serial.h
@@ -0,0 +1,48 @@
+/*
+ * Serial port register definitions
+ *
+ * Copyright 2010-2012 Texas Instruments, Inc.
+ *
+ * This program is free software; you can redistribute it and/or modify it
+ * under the terms and conditions of the GNU General Public License,
+ * version 2, as published by the Free Software Foundation.
+ *
+ * This program is distributed in the hope it will be useful, but WITHOUT
+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
+ * more details.
+ *
+ * You should have received a copy of the GNU General Public License along with
+ * this program.  If not, see <http://www.gnu.org/licenses/>.
+ */
+
+#ifndef __MACH_KEYSTONE_SERIAL_H__
+#define __MACH_KEYSTONE_SERIAL_H__
+
+#if defined(CONFIG_DEBUG_DAVINCI_TCI6614_UART0)
+
+#define UART_PHYS	0x02540000
+#define UART_VIRT	0xfed40000
+
+#elif defined(CONFIG_DEBUG_DAVINCI_TCI6614_UART1)
+
+#define UART_PHYS	0x02541000
+#define UART_VIRT	0xfed41000
+
+#elif defined(CONFIG_DEBUG_DAVINCI_TCI6638_UART0)
+
+#define UART_PHYS	0x02530c00
+#define UART_VIRT	0xfed30c00
+
+#elif defined(CONFIG_DEBUG_DAVINCI_TCI6638_UART1)
+
+#define UART_PHYS	0x02531000
+#define UART_VIRT	0xfed31000
+
+#elif defined(CONFIG_DEBUG_EARLY_PRINTK)
+
+#warn unsupported early debug configuration
+
+#endif
+
+#endif
diff --git a/arch/arm/mach-keystone/include/mach/uncompress.h b/arch/arm/mach-keystone/include/mach/uncompress.h
index 1071761..866ea7b 100644
--- a/arch/arm/mach-keystone/include/mach/uncompress.h
+++ b/arch/arm/mach-keystone/include/mach/uncompress.h
@@ -13,11 +13,35 @@
  * You should have received a copy of the GNU General Public License along with
  * this program.  If not, see <http://www.gnu.org/licenses/>.
  */
-#ifndef __MACH_UNCOMPRESS_H
-#define __MACH_UNCOMPRESS_H
+#ifndef __MACH_KEYSTONE_UNCOMPRESS_H__
+#define __MACH_KEYSTONE_UNCOMPRESS_H__
+
+#include <linux/types.h>
+#include <linux/serial_reg.h>
+
+#include <mach/serial.h>
+
+static void putc(char c)
+{
+#ifdef UART_PHYS
+	u32 *uart = (u32 *)UART_PHYS;
+
+	while (!(uart[UART_LSR] & UART_LSR_THRE))
+		barrier();
+	uart[UART_TX] = c;
+#endif
+}
+
+static inline void flush(void)
+{
+#ifdef UART_PHYS
+	u32 *uart = (u32 *)UART_PHYS;
+
+	while (!(uart[UART_LSR] & UART_LSR_THRE))
+		barrier();
+#endif
+}
 
-#define putc(c)
-#define flush()
 #define arch_decomp_setup()
 #define arch_decomp_wdog()
 
-- 
1.8.4.93.g57e4c17

