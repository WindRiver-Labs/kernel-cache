From 20b3bf0b0782ab9c77041c635d93a7004d14a846 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Wed, 17 Jul 2013 16:19:33 +0800
Subject: [PATCH 27/57] ARM: keystone: updates for smp ops api changes

Commit 78e82203e9836296eab827677eb72d8053c6ca7d from arago tree
git://arago-project.org/git/projects/linux-keystone.git releases/03.00.00.11/master

Signed-off-by: Cyril Chemparathy <cyril@ti.com>
Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 arch/arm/mach-keystone/keystone.c |  2 +-
 arch/arm/mach-keystone/keystone.h |  2 +-
 arch/arm/mach-keystone/platsmp.c  | 39 +++++++++++++++++++++++++++++++--------
 3 files changed, 33 insertions(+), 10 deletions(-)

diff --git a/arch/arm/mach-keystone/keystone.c b/arch/arm/mach-keystone/keystone.c
index d4a7c36..cd04440 100644
--- a/arch/arm/mach-keystone/keystone.c
+++ b/arch/arm/mach-keystone/keystone.c
@@ -126,7 +126,7 @@ static void __init keystone_init_meminfo(void)
 }
 
 DT_MACHINE_START(KEYSTONE, "KeyStone")
-	smp_ops(keystone_smp_ops)
+	.smp		= smp_ops(keystone_smp_ops)
 	.map_io		= keystone_map_io,
 	.init_irq	= keystone_init_irq,
 	.timer		= &keystone_timer,
diff --git a/arch/arm/mach-keystone/keystone.h b/arch/arm/mach-keystone/keystone.h
index 71bd0f4..3ea32a5 100644
--- a/arch/arm/mach-keystone/keystone.h
+++ b/arch/arm/mach-keystone/keystone.h
@@ -17,7 +17,7 @@
 #ifndef __KEYSTONE_H__
 #define __KEYSTONE_H__
 
-extern struct smp_ops keystone_smp_ops;
+extern struct smp_operations keystone_smp_ops;
 extern void secondary_startup(void);
 
 #endif /* __KEYSTONE_H__ */
diff --git a/arch/arm/mach-keystone/platsmp.c b/arch/arm/mach-keystone/platsmp.c
index acab603..f745a36 100644
--- a/arch/arm/mach-keystone/platsmp.c
+++ b/arch/arm/mach-keystone/platsmp.c
@@ -20,8 +20,8 @@
 #include <linux/smp.h>
 #include <linux/io.h>
 
+#include <asm/smp.h>
 #include <asm/smp_plat.h>
-#include <asm/smp_ops.h>
 #include <asm/hardware/gic.h>
 #include <asm/cacheflush.h>
 #include <asm/tlbflush.h>
@@ -53,7 +53,7 @@ static void __init keystone_smp_prepare_cpus(unsigned int max_cpus)
 	/* nothing to do here */
 }
 
-static void __cpuinit keystone_secondary_initmem(void)
+static void __cpuinit keystone_smp_secondary_initmem(void)
 {
 #ifdef CONFIG_ARM_LPAE
 	pgd_t *pgd0 = pgd_offset_k(0);
@@ -62,14 +62,14 @@ static void __cpuinit keystone_secondary_initmem(void)
 #endif
 }
 
-static void __cpuinit keystone_secondary_init(unsigned int cpu)
+static void __cpuinit keystone_smp_secondary_init(unsigned int cpu)
 {
 	gic_secondary_init(0);
-	keystone_secondary_initmem();
+	keystone_smp_secondary_initmem();
 }
 
 static int __cpuinit
-keystone_boot_secondary(unsigned int cpu, struct task_struct *idle)
+keystone_smp_boot_secondary(unsigned int cpu, struct task_struct *idle)
 {
 	unsigned long *ptr = (unsigned long *)(PAGE_OFFSET + 0x1f0);
 	ptr[cpu] = virt_to_idmap(&secondary_startup);
@@ -78,7 +78,30 @@ keystone_boot_secondary(unsigned int cpu, struct task_struct *idle)
 	return 0;
 }
 
-struct smp_ops keystone_smp_ops __initdata = {
-	smp_init_ops(keystone)
-	smp_secondary_ops(keystone)
+#ifdef CONFIG_HOTPLUG_CPU
+static int keystone_cpu_kill(unsigned int cpu)
+{
+	BUG();
+}
+
+static int keystone_cpu_die(unsigned int cpu)
+{
+	BUG();
+}
+static int keystone_cpu_disable(unsigned int cpu)
+{
+	BUG();
+}
+#endif
+
+struct smp_operations keystone_smp_ops __initdata = {
+	.smp_init_cpus		= keystone_smp_init_cpus,
+	.smp_prepare_cpus	= keystone_smp_prepare_cpus,
+	.smp_secondary_init	= keystone_smp_secondary_init,
+	.smp_boot_secondary	= keystone_smp_boot_secondary,
+#ifdef CONFIG_HOTPLUG_CPU
+	.cpu_kill		= keystone_cpu_kill,
+	.cpu_die		= keystone_cpu_die,
+	.cpu_disable		= keystone_cpu_disable,
+#endif
 };
-- 
1.8.4.93.g57e4c17

