From a0c03237c87cbbb8b1121d9cb5e2563b61b33c46 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Wed, 17 Jul 2013 09:56:27 +0800
Subject: [PATCH 31/57] ARM: keystone: update arm_dma_limit on address space
 switch

Commit 0c77e663c6eaea5ea4a194754fdb17e5f8cf86ac from arago tree
git://arago-project.org/git/projects/linux-keystone.git releases/03.00.00.11/master

The setup_dma_zone sets the arm_dma_limit before switching to the
high address space. If LPAE is enabled and keystone switches
to the high address space we need to recalculate the arm_dma_limit value.

Signed-off-by: Vitaly Andrianov <vitalya@ti.com>
Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 arch/arm/mach-keystone/keystone.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/arch/arm/mach-keystone/keystone.c b/arch/arm/mach-keystone/keystone.c
index d064b54..01d065a 100644
--- a/arch/arm/mach-keystone/keystone.c
+++ b/arch/arm/mach-keystone/keystone.c
@@ -128,6 +128,11 @@ static const char *keystone_match[] __initconst = {
 
 unsigned long __arch_dma_pfn_offset;
 
+#ifdef CONFIG_ZONE_DMA
+extern phys_addr_t arm_dma_limit;
+extern unsigned long arm_dma_zone_size;
+#endif
+
 static void __init keystone_init_meminfo(void)
 {
 	bool lpae = IS_ENABLED(CONFIG_ARM_LPAE);
@@ -164,6 +169,10 @@ static void __init keystone_init_meminfo(void)
 
 	__arch_dma_pfn_offset = PFN_DOWN(KEYSTONE_HIGH_PHYS_START -
 					 KEYSTONE_LOW_PHYS_START);
+#ifdef CONFIG_ZONE_DMA
+	arm_dma_limit = __pv_phys_offset + arm_dma_zone_size - 1;
+#endif
+
 }
 
 void keystone_restart(char mode, const char *cmd)
-- 
1.8.4.93.g57e4c17

