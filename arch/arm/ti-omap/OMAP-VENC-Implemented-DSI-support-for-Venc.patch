From e01e1e2252d420c676d247a570a7cf96f2fa24bc Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Fri, 22 Apr 2011 10:19:55 +0800
Subject: [PATCH 103/108] OMAP:VENC: Implemented DSI support for Venc

commit d460f1fd7d58f858bf90edb433120d5a34badfef from
the branch origin/OMAPPSP_03.00.01.06 of
git://arago-project.org/git/projects/linux-omap3.git

OMAP:VENC: Implemented DSI support for Venc

Signed-off-by: Vaibhav Hiremath <hvaibhav@ti.com>
Integrated-by: Stanley.Miao <stanley.miao@windriver.com>
---
 drivers/video/omap2/dss/venc.c |   48 ++++++++++++++++++++++++++++++++++++---
 1 files changed, 44 insertions(+), 4 deletions(-)

diff --git a/drivers/video/omap2/dss/venc.c b/drivers/video/omap2/dss/venc.c
index a30117f..8599e18 100644
--- a/drivers/video/omap2/dss/venc.c
+++ b/drivers/video/omap2/dss/venc.c
@@ -400,10 +400,38 @@ static const struct venc_config *venc_timings_to_config(
 	BUG();
 }
 
+
+#ifdef CONFIG_OMAP2_DSS_USE_DSI_PLL
+static int venc_set_dsi_clk(bool is_tft, unsigned long pck_req)
+{
+	struct dsi_clock_info dsi_cinfo;
+	struct dispc_clock_info dispc_cinfo;
+	int r;
+
+	r = dsi_pll_calc_clock_div_pck(is_tft, pck_req, &dsi_cinfo,
+			&dispc_cinfo);
+	if (r)
+		return r;
+
+	r = dsi_pll_set_clock_div(&dsi_cinfo);
+	if (r)
+		return r;
+
+	dss_select_dispc_clk_source(DSS_SRC_DSS1_ALWON_FCLK);
+	r = dispc_set_clock_div(&dispc_cinfo);
+
+	return r;
+}
+#endif
+
 static int venc_power_on(struct omap_dss_device *dssdev)
 {
 	u32 l;
 	int r = 0;
+#ifdef CONFIG_OMAP2_DSS_USE_DSI_PLL
+	struct omap_video_timings *t = &dssdev->panel.timings;
+	bool is_tft;
+#endif
 
 	venc_enable_clocks(1);
 
@@ -414,6 +442,12 @@ static int venc_power_on(struct omap_dss_device *dssdev)
 		DSSERR("failed in dsi_pll_init\n");
 		goto err;
 	}
+	is_tft = (dssdev->panel.config & OMAP_DSS_LCD_TFT) != 0;
+	r = venc_set_dsi_clk(is_tft, t->pixel_clock * 1000);
+	if (r) {
+		DSSERR("failed in venc_set_dsi_clk\n");
+		goto err1;
+	}
 #endif
 	venc_reset();
 	venc_write_config(venc_timings_to_config(&dssdev->panel.timings));
@@ -442,6 +476,16 @@ static int venc_power_on(struct omap_dss_device *dssdev)
 		dssdev->platform_enable(dssdev);
 
 	dssdev->manager->enable(dssdev->manager);
+
+	return r;
+#ifdef CONFIG_OMAP2_DSS_USE_DSI_PLL
+err1:
+	dsi_pll_uninit();
+	dss_clk_disable(DSS_CLK_FCK2);
+err:
+	venc_enable_clocks(0);
+	return r;
+#endif
 }
 
 static void venc_power_off(struct omap_dss_device *dssdev)
@@ -463,10 +507,6 @@ static void venc_power_off(struct omap_dss_device *dssdev)
 	venc_enable_clocks(0);
 }
 
-
-
-
-
 /* driver */
 static int venc_panel_probe(struct omap_dss_device *dssdev)
 {
-- 
1.7.0.4

