From e6245a67fdcb691c5cb5bc3122fcf8e3dac49fca Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Wed, 20 Apr 2011 11:19:33 +0800
Subject: [PATCH 104/108] DM37x: DSS mux configuration work-around for >Rev-B processor cards

commit 46b72bba7f8656903babb079b5d95d91a608c2f3 from
the branch origin/OMAPPSP_03.00.01.06 of
git://arago-project.org/git/projects/linux-omap3.git

Configure the DSS mux for the DM37x processor cards which version is greater than Rev-B.

Signed-off-by: Vaibhav Hiremath <hvaibhav@ti.com>
Integrated-by: Stanley.Miao <stanley.miao@windriver.com>
---
 arch/arm/mach-omap2/board-omap3evm.c |   23 +++++++++++++++++++++++
 arch/arm/mach-omap2/mux34xx.c        |   18 ++++++++++++++++++
 2 files changed, 41 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-omap2/board-omap3evm.c b/arch/arm/mach-omap2/board-omap3evm.c
index 43cb9d0..341c198 100644
--- a/arch/arm/mach-omap2/board-omap3evm.c
+++ b/arch/arm/mach-omap2/board-omap3evm.c
@@ -395,6 +395,19 @@ static int omap3_evm_enable_lcd(struct omap_dss_device *dssdev)
 	}
 	gpio_set_value(OMAP3EVM_LCD_PANEL_ENVDD, 0);
 
+	/* AM/DM37x: To get DSS working with 75MHz, we must use sys_bootx
+	 * pins for DSS, but since thes GPIO pins are reuired for LCD
+	 * orientation we must change the mux configuration to GPIO[2-3] for
+	 * SYS_BOOT[0-1]
+	 */
+	if (cpu_is_omap3630()) {
+		omap_mux_set_gpio(OMAP_MUX_MODE4 | OMAP_PIN_OUTPUT, 2);
+		omap_mux_set_gpio(OMAP_MUX_MODE4 | OMAP_PIN_OUTPUT, 3);
+
+		gpio_direction_output(OMAP3EVM_LCD_PANEL_LR, 1);
+		gpio_direction_output(OMAP3EVM_LCD_PANEL_UD, 1);
+	}
+
 	if (get_omap3_evm_rev() >= OMAP3EVM_BOARD_GEN_2)
 		gpio_set_value(OMAP3EVM_LCD_PANEL_BKLIGHT_GPIO, 0);
 	else
@@ -456,6 +469,16 @@ static int omap3_evm_enable_dvi(struct omap_dss_device *dssdev)
 
 	gpio_set_value(OMAP3EVM_DVI_PANEL_EN_GPIO, 1);
 
+	/* AM/DM37x: To get DSS working with 75MHz, we must use sys_bootx
+	 * pins for DSS, but since thes GPIO pins are reuired for LCD
+	 * orientation we must change the mux configuration to GPIO[2-3] for
+	 * SYS_BOOT[0-1]
+	 */
+	if (cpu_is_omap3630()) {
+		omap_mux_set_gpio(OMAP_MUX_MODE3, 2);
+		omap_mux_set_gpio(OMAP_MUX_MODE3, 3);
+	}
+
 	dvi_enabled = 1;
 	return 0;
 }
diff --git a/arch/arm/mach-omap2/mux34xx.c b/arch/arm/mach-omap2/mux34xx.c
index 07aa7b3..5e7a8e8 100644
--- a/arch/arm/mach-omap2/mux34xx.c
+++ b/arch/arm/mach-omap2/mux34xx.c
@@ -1324,6 +1324,24 @@ struct omap_mux __initdata omap3_cbb_subset[] = {
 	_OMAP3_MUXENTRY(DSS_PCLK, 66,
 		"dss_pclk", NULL, NULL, NULL,
 		"gpio_66", NULL, NULL, "safe_mode"),
+	_OMAP3_MUXENTRY(SYS_BOOT0, 2,
+		"sys_boot0", NULL, NULL, "dss_data18",
+		"gpio_2", NULL, NULL, "safe_mode"),
+	_OMAP3_MUXENTRY(SYS_BOOT1, 3,
+		"sys_boot1", NULL, NULL, "dss_data19",
+		"gpio_3", NULL, NULL, "safe_mode"),
+	_OMAP3_MUXENTRY(SYS_BOOT3, 5,
+		"sys_boot3", NULL, NULL, "dss_data20",
+		"gpio_5", NULL, NULL, "safe_mode"),
+	_OMAP3_MUXENTRY(SYS_BOOT4, 6,
+		"sys_boot4", "sdmmc2_dir_dat2", NULL, "dss_data21",
+		"gpio_6", NULL, NULL, "safe_mode"),
+	_OMAP3_MUXENTRY(SYS_BOOT5, 7,
+		"sys_boot5", "sdmmc2_dir_dat3", NULL, "dss_data22",
+		"gpio_7", NULL, NULL, "safe_mode"),
+	_OMAP3_MUXENTRY(SYS_BOOT6, 8,
+		"sys_boot6", NULL, NULL, "dss_data23",
+		"gpio_8", NULL, NULL, "safe_mode"),
 	_OMAP3_MUXENTRY(ETK_CLK, 12,
 		"etk_clk", "mcbsp5_clkx", "sdmmc3_clk", "hsusb1_stp",
 		"gpio_12", "mm1_rxdp", "hsusb1_tll_stp", NULL),
-- 
1.7.0.4

