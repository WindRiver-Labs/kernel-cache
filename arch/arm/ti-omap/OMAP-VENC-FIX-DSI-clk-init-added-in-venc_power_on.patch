From af2575d967f362546407753bcb9a715e4ce7cd25 Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Wed, 20 Apr 2011 10:16:13 +0800
Subject: [PATCH 101/108] OMAP:VENC:FIX:DSI clk init added in venc_power_on

commit 2a86de92614dee2eac7f8aa85aa91026e371dd14 from
the branch origin/OMAPPSP_03.00.01.06 of
git://arago-project.org/git/projects/linux-omap3.git

If user uses DSI clock as a source clock and if dynamically user
switched to TV out from LCD/DVI, the TV gets initialized but nothing
comes up on TV, since DSI clock init is not happening in venc.c file.

Signed-off-by: Vaibhav Hiremath <hvaibhav@ti.com>
Integrated-by: Stanley.Miao <stanley.miao@windriver.com>
---
 drivers/video/omap2/dss/venc.c |   19 +++++++++++++++++--
 1 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/drivers/video/omap2/dss/venc.c b/drivers/video/omap2/dss/venc.c
index eff3505..a30117f 100644
--- a/drivers/video/omap2/dss/venc.c
+++ b/drivers/video/omap2/dss/venc.c
@@ -400,12 +400,21 @@ static const struct venc_config *venc_timings_to_config(
 	BUG();
 }
 
-static void venc_power_on(struct omap_dss_device *dssdev)
+static int venc_power_on(struct omap_dss_device *dssdev)
 {
 	u32 l;
+	int r = 0;
 
 	venc_enable_clocks(1);
 
+#ifdef CONFIG_OMAP2_DSS_USE_DSI_PLL
+        dss_clk_enable(DSS_CLK_FCK2);
+        r = dsi_pll_init(dssdev, 1, 1);
+	if (r) {
+		DSSERR("failed in dsi_pll_init\n");
+		goto err;
+	}
+#endif
 	venc_reset();
 	venc_write_config(venc_timings_to_config(&dssdev->panel.timings));
 
@@ -447,6 +456,10 @@ static void venc_power_off(struct omap_dss_device *dssdev)
 
 	regulator_disable(venc.vdda_dac_reg);
 
+#ifdef CONFIG_OMAP2_DSS_USE_DSI_PLL
+	dsi_pll_uninit();
+	dss_clk_disable(DSS_CLK_FCK2);
+#endif
 	venc_enable_clocks(0);
 }
 
@@ -479,7 +492,9 @@ static int venc_panel_enable(struct omap_dss_device *dssdev)
 		goto err1;
 	}
 
-	venc_power_on(dssdev);
+	r = venc_power_on(dssdev);
+	if (r)
+		goto err1;
 
 	venc.wss_data = 0;
 
-- 
1.7.0.4

