From fa2574914e240818e408a6af8b5cd8b1b2495c7b Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Tue, 3 Jul 2012 11:12:04 +0800
Subject: [PATCH 15/28] SPEAr: convert to twd_local_timer_register() interface

commit 81e46f7b ARM: smp_twd: add runtime registration support

Converts localtimer to common smp_twd runtime interface.

So convert to twd_local_timer_register() interface for the spear13xx
platforms and in the meantime remove the old compile-time support.

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 arch/arm/mach-spear13xx/Makefile     |    1 -
 arch/arm/mach-spear13xx/localtimer.c |   26 --------------------------
 arch/arm/mach-spear13xx/pm.c         |   10 ----------
 arch/arm/mach-spear13xx/spear13xx.c  |   11 ++++++++---
 4 files changed, 8 insertions(+), 40 deletions(-)
 delete mode 100644 arch/arm/mach-spear13xx/localtimer.c

diff --git a/arch/arm/mach-spear13xx/Makefile b/arch/arm/mach-spear13xx/Makefile
index 47f8918..e507a39 100644
--- a/arch/arm/mach-spear13xx/Makefile
+++ b/arch/arm/mach-spear13xx/Makefile
@@ -6,7 +6,6 @@
 obj-y					+= spear13xx.o fsmc-nor.o
 obj-$(CONFIG_SMP)			+= platsmp.o headsmp.o
 obj-$(CONFIG_HOTPLUG_CPU)		+= hotplug.o
-obj-$(CONFIG_LOCAL_TIMERS)		+= localtimer.o
 obj-$(CONFIG_DW_PCIE)			+= dw_pcie.o
 obj-$(CONFIG_SPEAR_PCIE_REV341)		+= spear_pcie_rev_341.o
 obj-$(CONFIG_SPEAR_PCIE_REV370)		+= spear_pcie_rev_370.o
diff --git a/arch/arm/mach-spear13xx/localtimer.c b/arch/arm/mach-spear13xx/localtimer.c
deleted file mode 100644
index 05793f2..0000000
--- a/arch/arm/mach-spear13xx/localtimer.c
+++ /dev/null
@@ -1,26 +0,0 @@
-/*
- * arch/arm/mach-spear13xx/localtimer.c
- * Directly picked from realview
- *
- * Copyright (C) 2010 ST Microelectronics Ltd.
- * Shiraz Hashim <shiraz.hashim@st.com>
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
- */
-
-#include <linux/init.h>
-#include <linux/smp.h>
-#include <linux/clockchips.h>
-#include <asm/irq.h>
-#include <asm/smp_twd.h>
-#include <asm/localtimer.h>
-
-/* Setup the local clock events for a CPU. */
-int __cpuinit local_timer_setup(struct clock_event_device *evt)
-{
-	evt->irq = IRQ_LOCALTIMER;
-	twd_timer_setup(evt);
-	return 0;
-}
diff --git a/arch/arm/mach-spear13xx/pm.c b/arch/arm/mach-spear13xx/pm.c
index 1c44ea5..d8d4a88 100644
--- a/arch/arm/mach-spear13xx/pm.c
+++ b/arch/arm/mach-spear13xx/pm.c
@@ -63,13 +63,6 @@ static int spear_pm_on(void)
 
 static int spear_pm_sleep(suspend_state_t state)
 {
-	u32 twd_ctrl, twd_load;
-
-	twd_ctrl = readl(twd_base + TWD_TIMER_CONTROL);
-	twd_load = readl(twd_base + TWD_TIMER_LOAD);
-	/* twd timer stop */
-	writel(0, twd_base + TWD_TIMER_CONTROL);
-
 	/* Do the GIC specific latch ups for suspend mode */
 	if (state == PM_SUSPEND_MEM) {
 #ifdef CPU_PWR_DOMAIN_OFF
@@ -90,9 +83,6 @@ static int spear_pm_sleep(suspend_state_t state)
 	spear13xx_l2x0_init();
 	/* Call the CPU PM notifiers to notify exit from sleep */
 	cpu_pm_exit();
-	/* twd timer restart */
-	writel(twd_ctrl, twd_base + TWD_TIMER_CONTROL);
-	writel(twd_load, twd_base + TWD_TIMER_LOAD);
 
 	/* Do the GIC restoration for suspend mode */
 	if (state == PM_SUSPEND_MEM) {
diff --git a/arch/arm/mach-spear13xx/spear13xx.c b/arch/arm/mach-spear13xx/spear13xx.c
index c2f6a5a..3966575 100644
--- a/arch/arm/mach-spear13xx/spear13xx.c
+++ b/arch/arm/mach-spear13xx/spear13xx.c
@@ -1578,14 +1578,19 @@ void __init spear13xx_map_io(void)
 		spear13xx_clk_init();
 }
 
+#ifdef CONFIG_HAVE_ARM_TWD
+static DEFINE_TWD_LOCAL_TIMER(twd_local_timer, SPEAR13XX_LOCAL_TMR_BASE, IRQ_LOCALTIMER);
+#endif
+
 static void __init spear13xx_timer_init(void)
 {
 	char pclk_name[] = "osc1_24m_clk";
 	struct clk *gpt_clk, *pclk;
 
-#ifdef CONFIG_LOCAL_TIMERS
-	/* Setup the local timer base */
-	twd_base = __io_address(SPEAR13XX_LOCAL_TMR_BASE);
+#ifdef CONFIG_HAVE_ARM_TWD
+	int err = twd_local_timer_register(&twd_local_timer);
+	if (err)
+		pr_err("twd_local_timer_register failed %d\n", err);
 #endif
 
 	/* get the system timer clock */
-- 
1.7.9.7

