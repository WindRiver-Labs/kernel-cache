From 88fbdbecb83ea9b705b5b4f4c3aa35eb1be446a2 Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Thu, 23 Aug 2012 17:20:22 +0800
Subject: [PATCH 09/28] SPEAr: modify mach files to make stmmac driver work
 fine

Modify spear13xx mach files based on st git tree:

git://git.stlinux.com/spear/linux-2.6.git tag lsp-3.2.5
commit 6dfa4a5b lsp-3.2.5: Marking release lsp-3.2.5

changes according to above git tree:

 - add plat_stmmacphy_data platform data.
 - replace value of plat_stmmacenet_data with the value in above git tree.
 - replace plat_stmmacenet_data with plat_stmmacphy_data

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 arch/arm/mach-spear13xx/spear1310_evb.c         |   46 +++--
 arch/arm/mach-spear13xx/spear1310_reva.c        |    2 +-
 arch/arm/mach-spear13xx/spear1310_reva_evb.c    |  242 ++++++++++++++---------
 arch/arm/mach-spear13xx/spear1340_evb.c         |   47 +++--
 arch/arm/mach-spear13xx/spear1340_plug_boards.c |    4 +-
 arch/arm/mach-spear13xx/spear13xx.c             |    2 +-
 6 files changed, 203 insertions(+), 140 deletions(-)

diff --git a/arch/arm/mach-spear13xx/spear1310_evb.c b/arch/arm/mach-spear13xx/spear1310_evb.c
index 6577b54..c712739 100644
--- a/arch/arm/mach-spear13xx/spear1310_evb.c
+++ b/arch/arm/mach-spear13xx/spear1310_evb.c
@@ -44,6 +44,30 @@ static struct mtd_partition partition_info[] = {
 	PARTITION("Root File System", 0x380000, 84 * 0x20000),
 };
 
+/* Ethernet phy-0 device registeration */
+static struct plat_stmmacphy_data phy0_private_data = {
+	.bus_id = 0,
+	.phy_addr = 5,
+	.phy_mask = 0,
+	.interface = PHY_INTERFACE_MODE_GMII,
+	.phy_clk_cfg = spear13xx_eth_phy_clk_cfg,
+};
+
+static struct resource phy0_resources = {
+	.name = "phyirq",
+	.start = -1,
+	.end = -1,
+	.flags = IORESOURCE_IRQ,
+};
+
+static struct platform_device spear1310_phy0_device = {
+	.name		= "stmmacphy",
+	.id		= 0,
+	.num_resources	= 1,
+	.resource	= &phy0_resources,
+	.dev.platform_data = &phy0_private_data,
+};
+
 /* padmux devices to enable */
 static struct pmx_dev *pmx_devs[] = {
 	/* spear13xx specific devices */
@@ -110,32 +134,16 @@ static struct platform_device *plat_devs[] __initdata = {
 };
 
 /* Ethernet PLatform data */
-/* MDIO Bus Data */
-static struct stmmac_mdio_bus_data mdio0_private_data = {
-	.bus_id = 0,
-	.phy_mask = 0,
-};
-
-static struct stmmac_dma_cfg dma0_private_data = {
-	.pbl = 8,
-	.fixed_burst = 1,
-	.burst_len = DMA_AXI_BLEN_ALL,
-};
-
 static struct plat_stmmacenet_data eth_data = {
 	.bus_id = 0,
-	.phy_addr = -1,
-	.interface = PHY_INTERFACE_MODE_GMII,
 	.has_gmac = 1,
 	.enh_desc = 1,
 	.tx_coe = 1,
-	.dma_cfg = &dma0_private_data,
-	.rx_coe = STMMAC_RX_COE_TYPE2,
+	.pbl = 8,
+	.csum_off_engine = STMAC_TYPE_2,
 	.bugged_jumbo = 1,
+	.features = NETIF_F_HW_CSUM,
 	.pmt = 1,
-	.mdio_bus_data = &mdio0_private_data,
-	.init = spear13xx_eth_phy_clk_cfg,
-	.clk_csr = STMMAC_CSR_150_250M,
 };
 
 static struct mtd_partition nand_partition_info[] __initdata = {
diff --git a/arch/arm/mach-spear13xx/spear1310_reva.c b/arch/arm/mach-spear13xx/spear1310_reva.c
index 167bdd1..42b4d60 100644
--- a/arch/arm/mach-spear13xx/spear1310_reva.c
+++ b/arch/arm/mach-spear13xx/spear1310_reva.c
@@ -857,7 +857,7 @@ free_vco_clk:
 
 int spear1310_reva_eth_phy_clk_cfg(struct platform_device *pdev)
 {
-	struct plat_stmmacenet_data *pdata = dev_get_platdata(&pdev->dev);
+	struct plat_stmmacphy_data *pdata = dev_get_platdata(&pdev->dev);
 	void __iomem *addr = IOMEM(IO_ADDRESS(SPEAR1310_REVA_RAS_CTRL_REG1));
 	struct clk *clk, *phy_clk = NULL;
 	u32 tmp;
diff --git a/arch/arm/mach-spear13xx/spear1310_reva_evb.c b/arch/arm/mach-spear13xx/spear1310_reva_evb.c
index d1c77ce..cc2b4dd 100644
--- a/arch/arm/mach-spear13xx/spear1310_reva_evb.c
+++ b/arch/arm/mach-spear13xx/spear1310_reva_evb.c
@@ -35,6 +35,126 @@
 #include <mach/hardware.h>
 #include <mach/spear_pcie.h>
 
+/* Ethernet phy-0 device registeration */
+static struct plat_stmmacphy_data phy0_private_data = {
+	.bus_id = 0,
+	.phy_addr = 5,
+	.phy_mask = 0,
+	.interface = PHY_INTERFACE_MODE_GMII,
+	.phy_clk_cfg = spear13xx_eth_phy_clk_cfg,
+};
+
+static struct resource phy0_resources = {
+	.name = "phyirq",
+	.start = -1,
+	.end = -1,
+	.flags = IORESOURCE_IRQ,
+};
+
+static struct platform_device spear1310_reva_phy0_device = {
+	.name		= "stmmacphy",
+	.id		= 0,
+	.num_resources	= 1,
+	.resource	= &phy0_resources,
+	.dev.platform_data = &phy0_private_data,
+};
+
+/* Ethernet phy-1 device registeration */
+static struct plat_stmmacphy_data phy1_private_data = {
+	.bus_id = 1,
+	.phy_addr = 1,
+	.phy_mask = 0,
+	.interface = PHY_INTERFACE_MODE_MII,
+	.phy_clk_cfg = spear1310_reva_eth_phy_clk_cfg,
+};
+
+static struct resource phy1_resources = {
+	.name = "phyirq",
+	.start = -1,
+	.end = -1,
+	.flags = IORESOURCE_IRQ,
+};
+
+static struct platform_device spear1310_reva_phy1_device = {
+	.name = "stmmacphy",
+	.id = 1,
+	.num_resources = 1,
+	.resource = &phy1_resources,
+	.dev.platform_data = &phy1_private_data,
+};
+
+/* Ethernet phy-2 device registeration */
+static struct plat_stmmacphy_data phy2_private_data = {
+	.bus_id = 2,
+	.phy_addr = 2,
+	.phy_mask = 0,
+	.interface = PHY_INTERFACE_MODE_MII,
+	.phy_clk_cfg = spear1310_reva_eth_phy_clk_cfg,
+};
+
+static struct resource phy2_resources = {
+	.name = "phyirq",
+	.start = -1,
+	.end = -1,
+	.flags = IORESOURCE_IRQ,
+};
+
+static struct platform_device spear1310_reva_phy2_device = {
+	.name = "stmmacphy",
+	.id = 2,
+	.num_resources = 1,
+	.resource = &phy2_resources,
+	.dev.platform_data = &phy2_private_data,
+};
+
+/* Ethernet phy-3 device registeration */
+static struct plat_stmmacphy_data phy3_private_data = {
+	.bus_id = 3,
+	.phy_addr = 3,
+	.phy_mask = 0,
+	.interface = PHY_INTERFACE_MODE_RMII,
+	.phy_clk_cfg = spear1310_reva_eth_phy_clk_cfg,
+};
+
+static struct resource phy3_resources = {
+	.name = "phyirq",
+	.start = -1,
+	.end = -1,
+	.flags = IORESOURCE_IRQ,
+};
+
+static struct platform_device spear1310_reva_phy3_device = {
+	.name = "stmmacphy",
+	.id = 3,
+	.num_resources = 1,
+	.resource = &phy3_resources,
+	.dev.platform_data = &phy3_private_data,
+};
+
+/* Ethernet phy-4 device registeration */
+static struct plat_stmmacphy_data phy4_private_data = {
+	.bus_id = 4,
+	.phy_addr = 4,
+	.phy_mask = 0,
+	.interface = PHY_INTERFACE_MODE_RGMII,
+	.phy_clk_cfg = spear1310_reva_eth_phy_clk_cfg,
+};
+
+static struct resource phy4_resources = {
+	.name = "phyirq",
+	.start = -1,
+	.end = -1,
+	.flags = IORESOURCE_IRQ,
+};
+
+static struct platform_device spear1310_reva_phy4_device = {
+	.name = "stmmacphy",
+	.id = 4,
+	.num_resources = 1,
+	.resource = &phy4_resources,
+	.dev.platform_data = &phy4_private_data,
+};
+
 /* padmux devices to enable */
 static struct pmx_dev *pmx_devs[] = {
 	/* spear13xx specific devices */
@@ -114,6 +234,11 @@ static struct platform_device *plat_devs[] __initdata = {
 	&spear1310_reva_eth4_device,
 	&spear1310_reva_i2c1_device,
 	&spear1310_reva_plgpio_device,
+	&spear1310_reva_phy0_device,
+	&spear1310_reva_phy1_device,
+	&spear1310_reva_phy2_device,
+	&spear1310_reva_phy3_device,
+	&spear1310_reva_phy4_device,
 	&spear1310_reva_ras_fsmc_nor_device,
 	&spear1310_reva_rs485_0_device,
 	&spear1310_reva_rs485_1_device,
@@ -123,143 +248,64 @@ static struct platform_device *plat_devs[] __initdata = {
 
 /* Ethernet Platform Data */
 /* Ethernet GETH-0 device configuration */
-static struct stmmac_mdio_bus_data mdio0_private_data = {
-	.bus_id = 0,
-	.phy_mask = 0,
-};
-
-static struct stmmac_dma_cfg dma0_private_data = {
-	.pbl = 8,
-	.fixed_burst = 1,
-	.burst_len = DMA_AXI_BLEN_ALL,
-};
-
 static struct plat_stmmacenet_data eth0_data = {
 	.bus_id = 0,
-	.phy_addr = 5,
-	.interface = PHY_INTERFACE_MODE_GMII,
 	.has_gmac = 1,
 	.enh_desc = 1,
 	.tx_coe = 1,
-	.dma_cfg = &dma0_private_data,
-	.rx_coe = STMMAC_RX_COE_TYPE2,
+	.pbl = 8,
+	.csum_off_engine = STMAC_TYPE_2,
 	.bugged_jumbo = 1,
+	.features = NETIF_F_HW_CSUM,
 	.pmt = 1,
-	.mdio_bus_data = &mdio0_private_data,
-	.init = spear13xx_eth_phy_clk_cfg,
-	.clk_csr = STMMAC_CSR_150_250M,
 };
 
 /* Ethernet GETH-1 device configuration */
-static struct stmmac_mdio_bus_data mdio1_private_data = {
-	.bus_id = 1,
-	.phy_mask = 0,
-};
-
-static struct stmmac_dma_cfg dma1_private_data = {
-	.pbl = 8,
-	.fixed_burst = 1,
-	.burst_len = DMA_AXI_BLEN_ALL,
-};
-
 static struct plat_stmmacenet_data eth1_data = {
 	.bus_id = 1,
-	.phy_addr = 1,
-	.interface = PHY_INTERFACE_MODE_MII,
 	.has_gmac = 1,
 	.enh_desc = 1,
 	.tx_coe = 0,
-	.dma_cfg = &dma1_private_data,
-	.rx_coe = STMMAC_RX_COE_NONE,
-	.bugged_jumbo = 1,
-	.pmt = 1,
-	.mdio_bus_data = &mdio1_private_data,
-	.init = spear1310_reva_eth_phy_clk_cfg,
-	.clk_csr = STMMAC_CSR_150_250M,
-};
-
-/* Ethernet GETH-2 device configuration */
-static struct stmmac_mdio_bus_data mdio2_private_data = {
-	.bus_id = 2,
-	.phy_mask = 0,
-};
-
-static struct stmmac_dma_cfg dma2_private_data = {
 	.pbl = 8,
-	.fixed_burst = 1,
-	.burst_len = DMA_AXI_BLEN_ALL,
+	.csum_off_engine = STMAC_TYPE_0,
+	.bugged_jumbo = 0,
+	.features = NETIF_F_HW_CSUM,
 };
 
+/* Ethernet GETH-2 device configuration */
 static struct plat_stmmacenet_data eth2_data = {
 	.bus_id = 2,
-	.phy_addr = 2,
-	.interface = PHY_INTERFACE_MODE_MII,
 	.has_gmac = 1,
 	.enh_desc = 1,
 	.tx_coe = 0,
-	.dma_cfg = &dma2_private_data,
-	.rx_coe = STMMAC_RX_COE_NONE,
-	.bugged_jumbo = 1,
-	.pmt = 1,
-	.mdio_bus_data = &mdio2_private_data,
-	.init = spear1310_reva_eth_phy_clk_cfg,
-	.clk_csr = STMMAC_CSR_150_250M,
-};
-
-/* Ethernet GETH-3 device configuration */
-static struct stmmac_mdio_bus_data mdio3_private_data = {
-	.bus_id = 3,
-	.phy_mask = 0,
-};
-
-static struct stmmac_dma_cfg dma3_private_data = {
 	.pbl = 8,
-	.fixed_burst = 1,
-	.burst_len = DMA_AXI_BLEN_ALL,
+	.csum_off_engine = STMAC_TYPE_0,
+	.bugged_jumbo = 0,
+	.features = NETIF_F_HW_CSUM,
 };
 
+/* Ethernet GETH-3 device configuration */
 static struct plat_stmmacenet_data eth3_data = {
 	.bus_id = 3,
-	.phy_addr = 3,
-	.interface = PHY_INTERFACE_MODE_RMII,
 	.has_gmac = 1,
 	.enh_desc = 1,
 	.tx_coe = 0,
-	.dma_cfg = &dma3_private_data,
-	.rx_coe = STMMAC_RX_COE_NONE,
-	.bugged_jumbo = 1,
-	.pmt = 1,
-	.mdio_bus_data = &mdio3_private_data,
-	.init = spear1310_reva_eth_phy_clk_cfg,
-	.clk_csr = STMMAC_CSR_150_250M,
-};
-
-/* Ethernet GETH-4 device configuration */
-static struct stmmac_mdio_bus_data mdio4_private_data = {
-	.bus_id = 4,
-	.phy_mask = 0,
-};
-
-static struct stmmac_dma_cfg dma4_private_data = {
 	.pbl = 8,
-	.fixed_burst = 1,
-	.burst_len = DMA_AXI_BLEN_ALL,
+	.csum_off_engine = STMAC_TYPE_0,
+	.bugged_jumbo = 0,
+	.features = NETIF_F_HW_CSUM,
 };
 
+/* Ethernet GETH-4 device configuration */
 static struct plat_stmmacenet_data eth4_data = {
 	.bus_id = 4,
-	.phy_addr = 4,
-	.interface = PHY_INTERFACE_MODE_RGMII,
 	.has_gmac = 1,
 	.enh_desc = 1,
 	.tx_coe = 0,
-	.dma_cfg = &dma4_private_data,
-	.rx_coe = STMMAC_RX_COE_NONE,
-	.bugged_jumbo = 1,
-	.pmt = 1,
-	.mdio_bus_data = &mdio4_private_data,
-	.init = spear1310_reva_eth_phy_clk_cfg,
-	.clk_csr = STMMAC_CSR_150_250M,
+	.pbl = 8,
+	.csum_off_engine = STMAC_TYPE_0,
+	.bugged_jumbo = 0,
+	.features = NETIF_F_HW_CSUM,
 };
 
 static struct mtd_partition nand_partition_info[] __initdata = {
diff --git a/arch/arm/mach-spear13xx/spear1340_evb.c b/arch/arm/mach-spear13xx/spear1340_evb.c
index c95aff0..b4f254a 100644
--- a/arch/arm/mach-spear13xx/spear1340_evb.c
+++ b/arch/arm/mach-spear13xx/spear1340_evb.c
@@ -96,6 +96,30 @@ static struct platform_device spear1340_cam3_sensor_device = {
 	},
 };
 
+/* Ethernet phy-0 device registeration */
+static struct plat_stmmacphy_data phy0_private_data = {
+	.bus_id = 0,
+	.phy_addr = -1,
+	.phy_mask = 0,
+	.interface = PHY_INTERFACE_MODE_RGMII,
+	.phy_clk_cfg = spear13xx_eth_phy_clk_cfg,
+};
+
+static struct resource phy0_resources = {
+	.name = "phyirq",
+	.start = -1,
+	.end = -1,
+	.flags = IORESOURCE_IRQ,
+};
+
+struct platform_device spear1340_phy0_device = {
+	.name		= "stmmacphy",
+	.id		= 0,
+	.num_resources	= 1,
+	.resource	= &phy0_resources,
+	.dev.platform_data = &phy0_private_data,
+};
+
 /*
  * Pad multiplexing for making few pads as plgpio's.
  * Please retain original values and addresses, and update only mask as
@@ -272,6 +296,7 @@ static struct platform_device *plat_devs[] __initdata = {
 	&spear1340_i2s_record_device,
 	&spear1340_nand_device,
 	&spear1340_otg_device,
+	&spear1340_phy0_device,
 	&spear1340_plgpio_device,
 	&spear1340_pwm_device,
 	&spear1340_sata0_device,
@@ -348,32 +373,16 @@ static const struct kbd_platform_data kbd_data __initconst = {
 };
 
 /* Ethernet specific plat data */
-/* MDIO Bus Data */
-static struct stmmac_mdio_bus_data mdio0_private_data = {
-	.bus_id = 0,
-	.phy_mask = 0,
-};
-
-static struct stmmac_dma_cfg dma0_private_data = {
-	.pbl = 16,
-	.fixed_burst = 1,
-	.burst_len = DMA_AXI_BLEN_ALL,
-};
-
 static struct plat_stmmacenet_data eth_data = {
 	.bus_id = 0,
-	.phy_addr = -1,
-	.interface = PHY_INTERFACE_MODE_RGMII,
 	.has_gmac = 1,
 	.enh_desc = 1,
 	.tx_coe = 1,
-	.dma_cfg = &dma0_private_data,
-	.rx_coe = STMMAC_RX_COE_TYPE2,
+	.pbl = 16,
+	.csum_off_engine = STMAC_TYPE_2,
 	.bugged_jumbo = 1,
+	.features = NETIF_F_HW_CSUM,
 	.pmt = 1,
-	.mdio_bus_data = &mdio0_private_data,
-	.init = spear13xx_eth_phy_clk_cfg,
-	.clk_csr = STMMAC_CSR_150_250M,
 };
 
 /* Initializing platform data for spear1340 evb specific I2C devices */
diff --git a/arch/arm/mach-spear13xx/spear1340_plug_boards.c b/arch/arm/mach-spear13xx/spear1340_plug_boards.c
index f65c575..204bcdb 100644
--- a/arch/arm/mach-spear13xx/spear1340_plug_boards.c
+++ b/arch/arm/mach-spear13xx/spear1340_plug_boards.c
@@ -95,7 +95,7 @@ static struct pmx_dev *gmii_pb_pmx_devs[] = {
 
 static void __init gmii_pb_init(void)
 {
-	struct plat_stmmacenet_data *phy_data =
+	struct plat_stmmacphy_data *phy_data =
 		dev_get_platdata(&spear13xx_eth_device.dev);
 
 	phy_data->interface = PHY_INTERFACE_MODE_GMII;
@@ -119,7 +119,7 @@ static struct pmx_dev *rgmii_pb_pmx_devs[] = {
 
 static void __init rgmii_pb_init(void)
 {
-	struct plat_stmmacenet_data *phy_data =
+	struct plat_stmmacphy_data *phy_data =
 		dev_get_platdata(&spear13xx_eth_device.dev);
 
 	phy_data->interface = PHY_INTERFACE_MODE_RGMII;
diff --git a/arch/arm/mach-spear13xx/spear13xx.c b/arch/arm/mach-spear13xx/spear13xx.c
index 8df778c..75648c7 100644
--- a/arch/arm/mach-spear13xx/spear13xx.c
+++ b/arch/arm/mach-spear13xx/spear13xx.c
@@ -1257,7 +1257,7 @@ int spear13xx_eth_phy_clk_cfg(struct platform_device *pdev)
 {
 	int ret;
 	struct clk *input_clk, *input_pclk, *phy_pclk, *phy_clk;
-	struct plat_stmmacenet_data *pdata = dev_get_platdata(&pdev->dev);
+	struct plat_stmmacphy_data *pdata = dev_get_platdata(&pdev->dev);
 	const char *phy_clk_src_name[] = {
 		"gmac_phy_input_clk",
 		"gmac_phy_synth_clk",
-- 
1.7.9.7

