From d344bff58f8ff79c9f855764a9397425fbce1fed Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Thu, 5 Jul 2012 17:53:04 +0800
Subject: [PATCH 26/28] SPEAr: add one memory bank to meminfo in machines'
 fixup

DB9000 needs to reserve memory for framebuffer, but in fixup, meminfo has
no memory bank info yet. So add memory bank info before reserving the memory.

With this patch, we can't pass more than 1008M number to mem argument in the
bootargs.

In st git tree, there is one commit to work around this issue:
commit 0d083ab7 ARM init workaround: move fixup call after parse_cmdline

This commit modifies common code arch/arm/kernel/setup.c to postpone
calling fixup, but this is not compatible with multi board support, so
following the approach of other boards that use explicit memory bank
info in the fixup is used here.

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 arch/arm/mach-spear13xx/spear1310_evb.c      |    4 ++++
 arch/arm/mach-spear13xx/spear1310_reva_evb.c |    4 ++++
 arch/arm/mach-spear13xx/spear1340_evb.c      |    4 ++++
 3 files changed, 12 insertions(+)

diff --git a/arch/arm/mach-spear13xx/spear1310_evb.c b/arch/arm/mach-spear13xx/spear1310_evb.c
index c712739..5bbe500 100644
--- a/arch/arm/mach-spear13xx/spear1310_evb.c
+++ b/arch/arm/mach-spear13xx/spear1310_evb.c
@@ -301,6 +301,10 @@ static void __init spear1310_pcie_board_init(void)
 static void
 spear1310_evb_fixup(struct tag *tags, char **cmdline, struct meminfo *mi)
 {
+	mi->nr_banks = 1;
+	mi->bank[0].start = PHYS_OFFSET;
+	mi->bank[0].size = 0x40000000;
+
 #if defined(CONFIG_FB_DB9000) || defined(CONFIG_FB_DB9000_MODULE)
 	spear13xx_panel_fixup(mi);
 #endif
diff --git a/arch/arm/mach-spear13xx/spear1310_reva_evb.c b/arch/arm/mach-spear13xx/spear1310_reva_evb.c
index cc2b4dd..dbabc14 100644
--- a/arch/arm/mach-spear13xx/spear1310_reva_evb.c
+++ b/arch/arm/mach-spear13xx/spear1310_reva_evb.c
@@ -521,6 +521,10 @@ static void __init select_e1_interface(struct platform_device *pdev)
 static void
 spear1310_reva_evb_fixup(struct tag *tags, char **cmdline, struct meminfo *mi)
 {
+	mi->nr_banks = 1;
+	mi->bank[0].start = PHYS_OFFSET;
+	mi->bank[0].size = 0x10000000;
+
 #if defined(CONFIG_FB_DB9000) || defined(CONFIG_FB_DB9000_MODULE)
 	spear13xx_panel_fixup(mi);
 #endif
diff --git a/arch/arm/mach-spear13xx/spear1340_evb.c b/arch/arm/mach-spear13xx/spear1340_evb.c
index b4f254a..d6dd786 100644
--- a/arch/arm/mach-spear13xx/spear1340_evb.c
+++ b/arch/arm/mach-spear13xx/spear1340_evb.c
@@ -615,6 +615,10 @@ static struct spi_board_info *spi_board[] __initdata = {
 static void
 spear1340_evb_fixup(struct tag *tags, char **cmdline, struct meminfo *mi)
 {
+	mi->nr_banks = 1;
+	mi->bank[0].start = PHYS_OFFSET;
+	mi->bank[0].size = 0x40000000;
+
 #if defined(CONFIG_FB_DB9000) || defined(CONFIG_FB_DB9000_MODULE)
 	spear13xx_panel_fixup(mi);
 #endif
-- 
1.7.9.7

