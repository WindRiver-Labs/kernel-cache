From 6c473a27823277d017b8f40145b6e4b15df08622 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Wed, 14 Nov 2012 15:28:04 +0800
Subject: [PATCH] ARM: kernel: add cpu logical map DT init in setup_arch

Commit bc3c020ea0f2f5355b4a054d8a74564c2953e39f from
git://git.linaro.org/kernel/linux-linaro-tracking.git

As soon as the device tree is unflattened the cpu logical to physical
mapping is carried out in setup_arch to build a proper array of MPIDR and
corresponding logical indexes.

The mapping could have been carried out using the flattened DT blob and
related primitives, but since the mapping is not needed by early boot
code it can safely be executed when the device tree has been uncompressed to
its tree data structure.

This patch adds the arm_dt_init_cpu maps() function call in setup_arch().

If the kernel is not compiled with DT support the function is empty and
no logical mapping takes place through it; the mapping carried out in
smp_setup_processor_id() is left unchanged.
If DT is supported the mapping created in smp_setup_processor_id() is overriden.
The DT mapping also sets the possible cpus mask, hence platform
code need not set it again in the respective smp_init_cpus() functions.

Signed-off-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
[Add ifdef to make it safe for other platform]
Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>

diff --git a/arch/arm/kernel/setup.c b/arch/arm/kernel/setup.c
index 72c6106..c6fc3e9 100644
--- a/arch/arm/kernel/setup.c
+++ b/arch/arm/kernel/setup.c
@@ -976,6 +976,9 @@ void __init setup_arch(char **cmdline_p)
 
 	unflatten_device_tree();
 
+#ifdef CONFIG_ARCH_VEXPRESS_DT
+	arm_dt_init_cpu_maps();
+#endif
 #ifdef CONFIG_SMP
 	if (is_smp()) {
 		smp_set_ops(mdesc->smp);
-- 
1.8.3.1

