From 35409dac61b45f874c520fb1adb58593b839d952 Mon Sep 17 00:00:00 2001
From: Jon Medhurst <tixy@linaro.org>
Date: Wed, 25 Jul 2012 15:08:04 +0100
Subject: [PATCH 18/28] cpufreq: vexpress: Check for presence of SPC driver

Commit 0525e517dff7203dd1f68dd6d5d0c508c0d0fe88 from
git://git.linaro.org/kernel/linux-linaro-tracking.git

The cpufreq driver requires SPC hardware, so check for its presence
before initialising the driver. This enables the cpufreq driver to
safely exist in kernels run on hardware without SPC support.

Signed-off-by: Jon Medhurst <tixy@linaro.org>
Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 drivers/cpufreq/vexpress_bL_cpufreq.c |    5 +++++
 1 file changed, 5 insertions(+)

diff --git a/drivers/cpufreq/vexpress_bL_cpufreq.c b/drivers/cpufreq/vexpress_bL_cpufreq.c
index 1fffaef..2c71b24 100644
--- a/drivers/cpufreq/vexpress_bL_cpufreq.c
+++ b/drivers/cpufreq/vexpress_bL_cpufreq.c
@@ -264,6 +264,11 @@ static struct cpufreq_driver vexpress_cpufreq_driver = {
 
 static int __init vexpress_cpufreq_modinit(void)
 {
+	if (!vexpress_spc_check_loaded()) {
+		pr_info("vexpress cpufreq not initialised because no SPC found\n");
+		return -ENODEV;
+	}
+
 	return cpufreq_register_driver(&vexpress_cpufreq_driver);
 }
 
-- 
1.7.9.7

