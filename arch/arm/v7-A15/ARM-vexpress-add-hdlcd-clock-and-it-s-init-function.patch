From e37c0b0fffe232dd91a519c14086de84b578b74f Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Wed, 14 Nov 2012 15:40:58 +0800
Subject: [PATCH 10/28] ARM: vexpress: add hdlcd clock and it's init function

Introduce a new clk for hdlcd, and add hdlcd's early init func.

Refer to commit e137496cb07ec41cd02f819066bc7754ed2bfa94 from
git://linux-arm.org/arm-bls.git, and modified it's clock based
on old clock implementation other than new common clock.

Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 arch/arm/mach-vexpress/v2m.c |   53 ++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 53 insertions(+)

diff --git a/arch/arm/mach-vexpress/v2m.c b/arch/arm/mach-vexpress/v2m.c
index 7d8b883..a76645f 100644
--- a/arch/arm/mach-vexpress/v2m.c
+++ b/arch/arm/mach-vexpress/v2m.c
@@ -13,6 +13,7 @@
 #include <linux/platform_device.h>
 #include <linux/ata_platform.h>
 #include <linux/smsc911x.h>
+#include <linux/memblock.h>
 #include <linux/spinlock.h>
 #include <linux/device.h>
 #include <linux/usb/isp1760.h>
@@ -546,6 +547,30 @@ void __init v2m_dt_map_io(void)
 #endif
 }
 
+static u32 osc;
+
+static long hdlcd_round(struct clk *clk, unsigned long rate)
+{
+	return rate;
+}
+
+static int hdlcd_set(struct clk *clk, unsigned long rate)
+{
+	u32 site = v2m_get_master_site();
+
+	return v2m_cfg_write(SYS_CFG_OSC | SYS_CFG_SITE(site) | osc, rate);
+}
+
+static const struct clk_ops hdlcd_clk_ops = {
+	.round	= hdlcd_round,
+	.set	= hdlcd_set,
+};
+
+static struct clk hdlcd_clk = {
+	.ops	= &hdlcd_clk_ops,
+	.rate	= 24000000,
+};
+
 static struct clk_lookup v2m_dt_lookups[] = {
 	{	/* AMBA bus clock */
 		.con_id		= "apb_pclk",
@@ -585,6 +610,9 @@ static struct clk_lookup v2m_dt_lookups[] = {
 	}, {	/* PL111 CLCD */
 		.dev_id		= "1001f000.clcd",
 		.clk		= &osc1_clk,
+	}, {	/* HDLCD */
+		.con_id		= "2b000000.hdlcd",
+		.clk		= &hdlcd_clk,
 	},
 	/* RS1 memory map */
 	{	/* PL180 MMCI */
@@ -617,6 +645,29 @@ static struct clk_lookup v2m_dt_lookups[] = {
 	},
 };
 
+static void __init v2m_dt_hdlcd_init(void)
+{
+	struct device_node *node;
+	u32 framebuffer[2];
+
+	node = of_find_compatible_node(NULL, NULL, "arm,hdlcd");
+	if (!node)
+		return;
+
+	if (WARN_ON(of_property_read_u32_array(node, "framebuffer",
+			framebuffer, ARRAY_SIZE(framebuffer))))
+		return;
+
+	if (WARN_ON(memblock_remove(framebuffer[0], framebuffer[1])))
+		return;
+
+	if (WARN_ON(of_property_read_u32(node, "arm,vexpress-osc", &osc)))
+		return;
+
+	v2m_cfg_write(SYS_CFG_MUXFPGA | SYS_CFG_SITE(SYS_CFG_SITE_MB),
+			v2m_get_master_site());
+}
+
 void __init v2m_dt_init_early(void)
 {
 	struct device_node *node;
@@ -639,6 +690,8 @@ void __init v2m_dt_init_early(void)
 					"hardware (%x)!\n", dt_hbi, hbi);
 	}
 
+	v2m_dt_hdlcd_init();
+
 	clkdev_add_table(v2m_dt_lookups, ARRAY_SIZE(v2m_dt_lookups));
 }
 
-- 
1.7.9.7

