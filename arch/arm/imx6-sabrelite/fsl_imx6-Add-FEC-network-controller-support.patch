From e7bd67bfb8a73558f187aded3ebf3afeac3d07ba Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Tue, 11 Sep 2012 16:43:34 +0800
Subject: [PATCH 07/62] fsl_imx6: Add FEC network controller support

Source: Extract from vendor-drop package, L3.0.15_12.04.01_ER_source.tar.gz
(May,2012).

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-mx6/devices-imx6q.h        |    4 ++++
 arch/arm/mach-mx6/mach-mx6q_sabrelite.c  |   30 ++++++++++++++++++++++++++++++
 arch/arm/plat-mxc/devices/Kconfig        |    2 +-
 arch/arm/plat-mxc/devices/platform-fec.c |    5 +++++
 4 files changed, 40 insertions(+), 1 deletion(-)

diff --git a/arch/arm/mach-mx6/devices-imx6q.h b/arch/arm/mach-mx6/devices-imx6q.h
index 0ca6158..d35d44d 100644
--- a/arch/arm/mach-mx6/devices-imx6q.h
+++ b/arch/arm/mach-mx6/devices-imx6q.h
@@ -30,4 +30,8 @@ extern const struct imx_imx_uart_1irq_data imx6q_imx_uart_data[] __initconst;
 #define imx6q_add_imx_uart3(pdata)	imx6q_add_imx_uart(3, pdata)
 #define imx6q_add_imx_uart4(pdata)	imx6q_add_imx_uart(4, pdata)
 
+extern const struct imx_fec_data imx6q_fec_data;
+#define imx6q_add_fec(pdata)	\
+	imx_add_fec(&imx6q_fec_data, pdata)
+
 #endif
diff --git a/arch/arm/mach-mx6/mach-mx6q_sabrelite.c b/arch/arm/mach-mx6/mach-mx6q_sabrelite.c
index 293af74..2817d2c 100644
--- a/arch/arm/mach-mx6/mach-mx6q_sabrelite.c
+++ b/arch/arm/mach-mx6/mach-mx6q_sabrelite.c
@@ -31,6 +31,8 @@
 #include <linux/regulator/consumer.h>
 #include <linux/pwm_backlight.h>
 #include <linux/fec.h>
+#include <linux/phy.h>
+#include <linux/micrel_phy.h>
 #include <linux/memblock.h>
 #include <asm/hardware/gic.h>
 #include <asm/irq.h>
@@ -260,6 +262,28 @@ static inline void mx6q_sabrelite_init_uart(void)
 	imx6q_add_imx_uart1(&uart_pdata);
 }
 
+/* For imx6q sabrelite board: set KSZ9021RN RGMII pad skew */
+static int ksz9021rn_phy_fixup(struct phy_device *phydev)
+{
+	/* prefer master mode, disable 1000 Base-T capable */
+	phy_write(phydev, 0x9, 0x1c00);
+
+	/* min rx data delay */
+	phy_write(phydev, 0x0b, 0x8105);
+	phy_write(phydev, 0x0c, 0x0000);
+
+	/* max rx/tx clock delay, min rx/tx control delay */
+	phy_write(phydev, 0x0b, 0x8104);
+	phy_write(phydev, 0x0c, 0xf0f0);
+	phy_write(phydev, 0x0b, 0x104);
+
+	return 0;
+}
+
+static const struct fec_platform_data fec_data __initconst = {
+	.phy	= PHY_INTERFACE_MODE_RGMII,
+};
+
 static void __init fixup_mxc_board(struct tag *tags, char **cmdline,
 				   struct meminfo *mi)
 {
@@ -272,7 +296,13 @@ static void __init mx6_sabrelite_board_init(void)
 {
 	mxc_iomux_v3_setup_multiple_pads(mx6q_sabrelite_pads,
 					ARRAY_SIZE(mx6q_sabrelite_pads));
+
+	phy_register_fixup_for_uid(PHY_ID_KSZ9021, MICREL_PHY_ID_MASK,
+					   ksz9021rn_phy_fixup);
+
 	mx6q_sabrelite_init_uart();
+	imx6q_add_fec(&fec_data);
+
 }
 
 static void __init mx6_sabrelite_timer_init(void)
diff --git a/arch/arm/plat-mxc/devices/Kconfig b/arch/arm/plat-mxc/devices/Kconfig
index cb3e3ee..9dc3dfe 100644
--- a/arch/arm/plat-mxc/devices/Kconfig
+++ b/arch/arm/plat-mxc/devices/Kconfig
@@ -1,6 +1,6 @@
 config IMX_HAVE_PLATFORM_FEC
 	bool
-	default y if ARCH_MX25 || SOC_IMX27 || SOC_IMX35 || SOC_IMX50 || SOC_IMX51 || SOC_IMX53
+	default y if ARCH_MX25 || SOC_IMX27 || SOC_IMX35 || SOC_IMX50 || SOC_IMX51 || SOC_IMX53 || SOC_IMX6Q
 
 config IMX_HAVE_PLATFORM_FLEXCAN
 	select HAVE_CAN_FLEXCAN if CAN
diff --git a/arch/arm/plat-mxc/devices/platform-fec.c b/arch/arm/plat-mxc/devices/platform-fec.c
index 0bae44e..86a4d24 100644
--- a/arch/arm/plat-mxc/devices/platform-fec.c
+++ b/arch/arm/plat-mxc/devices/platform-fec.c
@@ -52,6 +52,11 @@ const struct imx_fec_data imx53_fec_data __initconst =
 	imx_fec_data_entry_single(MX53, "imx25-fec");
 #endif
 
+#ifdef CONFIG_SOC_IMX6Q
+const struct imx_fec_data imx6q_fec_data __initconst =
+	imx_fec_data_entry_single(MX6Q, "imx6q-fec");
+#endif
+
 struct platform_device *__init imx_add_fec(
 		const struct imx_fec_data *data,
 		const struct fec_platform_data *pdata)
-- 
1.7.9.7

