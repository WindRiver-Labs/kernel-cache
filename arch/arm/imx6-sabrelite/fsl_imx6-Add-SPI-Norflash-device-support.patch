From a186d5a440a432f83db78321392a7cbff944780f Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Tue, 25 Sep 2012 11:37:33 +0800
Subject: [PATCH 34/62] fsl_imx6: Add SPI Norflash device support

Source: Extract from vendor-drop package, L3.0.15_12.04.01_ER_source.tar.gz
(May,2012).

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-mx6/mach-mx6q_sabrelite.c |   38 +++++++++++++++++++++++++++++++
 1 file changed, 38 insertions(+)

diff --git a/arch/arm/mach-mx6/mach-mx6q_sabrelite.c b/arch/arm/mach-mx6/mach-mx6q_sabrelite.c
index e5156b9..eb68bd7 100644
--- a/arch/arm/mach-mx6/mach-mx6q_sabrelite.c
+++ b/arch/arm/mach-mx6/mach-mx6q_sabrelite.c
@@ -39,6 +39,8 @@
 #include <linux/phy.h>
 #include <linux/micrel_phy.h>
 #include <linux/memblock.h>
+#include <linux/spi/spi.h>
+#include <linux/spi/flash.h>
 
 #include <asm/system_misc.h>
 #include <asm/hardware/gic.h>
@@ -548,6 +550,40 @@ static const struct spi_imx_master mx6q_sabrelite_spi_data __initconst = {
 	.num_chipselect = ARRAY_SIZE(mx6q_sabrelite_spi_cs),
 };
 
+#if defined(CONFIG_MTD_M25P80) || defined(CONFIG_MTD_M25P80_MODULE)
+static struct mtd_partition imx6_sabrelite_spi_nor_partitions[] = {
+	{
+	 .name = "bootloader",
+	 .offset = 0,
+	 .size = 0x00040000,
+	},
+	{
+	 .name = "kernel",
+	 .offset = MTDPART_OFS_APPEND,
+	 .size = MTDPART_SIZ_FULL,
+	},
+};
+
+static struct flash_platform_data imx6_sabrelite__spi_flash_data = {
+	.name = "m25p80",
+	.parts = imx6_sabrelite_spi_nor_partitions,
+	.nr_parts = ARRAY_SIZE(imx6_sabrelite_spi_nor_partitions),
+	.type = "sst25vf016b",
+};
+#endif
+
+static struct spi_board_info imx6_sabrelite_spi_nor_device[] __initdata = {
+#if defined(CONFIG_MTD_M25P80)
+	{
+		.modalias = "m25p80",
+		.max_speed_hz = 20000000, /* max spi clock (SCK) speed in HZ */
+		.bus_num = 0,
+		.chip_select = 0,
+		.platform_data = &imx6_sabrelite__spi_flash_data,
+	},
+#endif
+};
+
 static void __init fixup_mxc_board(struct tag *tags, char **cmdline,
 				   struct meminfo *mi)
 {
@@ -638,6 +674,8 @@ static void __init mx6_sabrelite_board_init(void)
 
 	/* SPI */
 	imx6q_add_ecspi(0, &mx6q_sabrelite_spi_data);
+	spi_register_board_info(imx6_sabrelite_spi_nor_device,
+				ARRAY_SIZE(imx6_sabrelite_spi_nor_device));
 
 	imx6q_add_mxc_hdmi_core(&hdmi_core_data);
 	imx6q_add_mxc_hdmi(&hdmi_data);
-- 
1.7.9.7

