From b35e595c88eb0e2eaf6d05da5b4a383fa4c0dfd5 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Wed, 5 Dec 2012 10:59:29 +0800
Subject: [PATCH 61/62] fsl_imx6: Enable ARM Perfromance Monitor

Register PMU resources during system bootup, so that "Perf" Command can
be used to get misc performance data of a running program

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-mx6/devices-imx6q.h               |    2 ++
 arch/arm/mach-mx6/mach-mx6q_sabrelite.c         |    1 +
 arch/arm/plat-mxc/devices/Makefile              |    1 +
 arch/arm/plat-mxc/devices/platform-imx-pmu.c    |   44 +++++++++++++++++++++++
 arch/arm/plat-mxc/include/mach/devices-common.h |    2 ++
 5 files changed, 50 insertions(+)
 create mode 100644 arch/arm/plat-mxc/devices/platform-imx-pmu.c

diff --git a/arch/arm/mach-mx6/devices-imx6q.h b/arch/arm/mach-mx6/devices-imx6q.h
index 59d6521..7b1c207 100644
--- a/arch/arm/mach-mx6/devices-imx6q.h
+++ b/arch/arm/mach-mx6/devices-imx6q.h
@@ -158,4 +158,6 @@ extern const struct imx_flexcan_data imx6q_flexcan_data[] __initconst;
 extern const struct imx_imx_ssi_data imx6_imx_ssi_data[];
 #define imx6q_add_imx_ssi(id, pdata)	\
 	imx_add_imx_ssi(&imx6_imx_ssi_data[id], pdata)
+
+#define imx6_add_armpmu() imx_add_imx_armpmu()
 #endif
diff --git a/arch/arm/mach-mx6/mach-mx6q_sabrelite.c b/arch/arm/mach-mx6/mach-mx6q_sabrelite.c
index 3e9d865..192e638 100644
--- a/arch/arm/mach-mx6/mach-mx6q_sabrelite.c
+++ b/arch/arm/mach-mx6/mach-mx6q_sabrelite.c
@@ -1071,6 +1071,7 @@ static void __init mx6_sabrelite_board_init(void)
 	imx6q_add_mxc_pwm_backlight(3, &mx6_sabrelite_pwm_backlight_data);
 
 	imx6q_add_pm_imx(0, &mx6q_sabrelite_pm_data);
+	imx6_add_armpmu();
 
 	ret = gpio_request_array(mx6q_sabrelite_flexcan_gpios,
 			ARRAY_SIZE(mx6q_sabrelite_flexcan_gpios));
diff --git a/arch/arm/plat-mxc/devices/Makefile b/arch/arm/plat-mxc/devices/Makefile
index 552f9b4..978b256 100644
--- a/arch/arm/plat-mxc/devices/Makefile
+++ b/arch/arm/plat-mxc/devices/Makefile
@@ -43,3 +43,4 @@ obj-$(CONFIG_IMX_HAVE_PLATFORM_IMX_VPU) +=  platform-imx_vpu.o
 obj-$(CONFIG_IMX_HAVE_PLATFORM_IMX_MIPI_CSI2) += platform-imx-mipi_csi2.o
 obj-$(CONFIG_IMX_HAVE_PLATFORM_IMX_DVFS) +=  platform-imx_dvfs.o
 obj-$(CONFIG_IMX_HAVE_PLATFORM_IMX_PM) += platform-imx-pm.o
+obj-y += platform-imx-pmu.o
diff --git a/arch/arm/plat-mxc/devices/platform-imx-pmu.c b/arch/arm/plat-mxc/devices/platform-imx-pmu.c
new file mode 100644
index 0000000..cf29415
--- /dev/null
+++ b/arch/arm/plat-mxc/devices/platform-imx-pmu.c
@@ -0,0 +1,44 @@
+/*
+ * Copyright (C) 2012 Freescale Semiconductor, Inc. All Rights Reserved.
+ */
+
+/*
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+
+ * You should have received a copy of the GNU General Public License along
+ * with this program; if not, write to the Free Software Foundation, Inc.,
+ * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+ */
+
+#include <asm/sizes.h>
+#include <mach/hardware.h>
+#include <mach/devices-common.h>
+#include <asm/pmu.h>
+
+static struct resource mx6_pmu_resources[] = {
+	[0] = {
+		.start	= MXC_INT_CHEETAH_PERFORM,
+		.end	= MXC_INT_CHEETAH_PERFORM,
+		.flags	= IORESOURCE_IRQ,
+	},
+};
+
+struct platform_device mx6_pmu_device = {
+	.name		= "arm-pmu",
+	.id		= ARM_PMU_DEVICE_CPU,
+	.num_resources	= ARRAY_SIZE(mx6_pmu_resources),
+	.resource	= mx6_pmu_resources,
+};
+
+void __init imx_add_imx_armpmu()
+{
+	platform_device_register(&mx6_pmu_device);
+}
diff --git a/arch/arm/plat-mxc/include/mach/devices-common.h b/arch/arm/plat-mxc/include/mach/devices-common.h
index 42b26b1..5b090b5 100644
--- a/arch/arm/plat-mxc/include/mach/devices-common.h
+++ b/arch/arm/plat-mxc/include/mach/devices-common.h
@@ -496,3 +496,5 @@ struct imx_pm_imx_data {
 struct platform_device *__init imx_add_pm_imx(
 		const struct imx_pm_imx_data *data,
 		const struct pm_platform_data *pdata);
+
+void __init imx_add_imx_armpmu(void);
-- 
1.7.9.7

