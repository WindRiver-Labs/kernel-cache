From e55a011f30109f4c8c4e8274bbc908f01a164f7f Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Thu, 9 Aug 2012 15:47:24 +0800
Subject: [PATCH 04/62] fsl_imx6: add support for local timers on imx6
 platform

This patch adds support for the Cortex-A9 local timers available when
using the imx6 platform.

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-mx6/irq.c |   18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/arch/arm/mach-mx6/irq.c b/arch/arm/mach-mx6/irq.c
index 18222a64..7d0674d 100644
--- a/arch/arm/mach-mx6/irq.c
+++ b/arch/arm/mach-mx6/irq.c
@@ -21,6 +21,7 @@
 #include <linux/io.h>
 #include <linux/platform_device.h>
 #include <linux/irq.h>
+#include <asm/smp_twd.h>
 #include <asm/hardware/gic.h>
 #include <mach/hardware.h>
 #ifdef CONFIG_CPU_FREQ_GOV_INTERACTIVE
@@ -34,6 +35,21 @@ extern bool enable_wait_mode;
 extern int cpufreq_gov_irq_tuner_register(struct irq_tuner dbs_irq_tuner);
 #endif
 
+#ifdef CONFIG_HAVE_ARM_TWD
+static DEFINE_TWD_LOCAL_TIMER(twd_local_timer,
+			      LOCAL_TWD_ADDR,
+			      IRQ_LOCALTIMER);
+
+static void __init mx6_twd_init(void)
+{
+	int err = twd_local_timer_register(&twd_local_timer);
+	if (err)
+		pr_err("twd_local_timer_register failed %d\n", err);
+}
+#else
+#define mx6_twd_init()	do {} while (0)
+#endif
+
 static int mx6_gic_irq_set_wake(struct irq_data *d, unsigned int enable)
 {
 	if ((d->irq < MXC_INT_START) || (d->irq > MXC_INT_END)) {
@@ -104,6 +120,8 @@ void mx6_init_irq(void)
 	gic_init(0, 29, IO_ADDRESS(IC_DISTRIBUTOR_BASE_ADDR),
 		IO_ADDRESS(IC_INTERFACES_BASE_ADDR));
 
+	mx6_twd_init();
+
 	if (enable_wait_mode) {
 		/* Mask the always pending interrupts - HW bug. */
 		__raw_writel(0x00400000, gpc_base + 0x0c);
-- 
1.7.9.7

