From 6c9df06b3edd463be397cb11d3465365b6a13f51 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Thu, 15 Nov 2012 11:30:05 +0800
Subject: [PATCH 17/62] fsl_imx6: add platform device register for i2c driver

Source: Extract from vendor-drop package, L3.0.15_12.04.01_ER_source.tar.gz
(May,2012).

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-mx6/Kconfig                    |    1 +
 arch/arm/mach-mx6/clock.c                    |    2 +-
 arch/arm/mach-mx6/devices-imx6q.h            |    3 +++
 arch/arm/mach-mx6/mach-mx6q_sabrelite.c      |    7 +++++++
 arch/arm/plat-mxc/devices/platform-imx-i2c.c |   10 ++++++++++
 5 files changed, 22 insertions(+), 1 deletion(-)

diff --git a/arch/arm/mach-mx6/Kconfig b/arch/arm/mach-mx6/Kconfig
index ef99cfb..91fe424 100644
--- a/arch/arm/mach-mx6/Kconfig
+++ b/arch/arm/mach-mx6/Kconfig
@@ -19,6 +19,7 @@ config MACH_MX6Q_SABRELITE
 	select ARCH_MX6Q
 	select SOC_IMX6Q
 	select IMX_HAVE_PLATFORM_IMX_UART
+	select IMX_HAVE_PLATFORM_IMX_I2C
 	help
 	  Include support for i.MX 6Quad SABRE Lite platform. This includes specific
 	  configurations for the board and its peripherals.
diff --git a/arch/arm/mach-mx6/clock.c b/arch/arm/mach-mx6/clock.c
index 81ed1d3..03751b9 100644
--- a/arch/arm/mach-mx6/clock.c
+++ b/arch/arm/mach-mx6/clock.c
@@ -5038,7 +5038,7 @@ static struct clk_lookup lookups[] = {
 	_REGISTER_CLOCK(NULL, "pcie_axi_clk", pcie_axi_clk),
 	_REGISTER_CLOCK(NULL, "vdo_axi_clk", vdo_axi_clk),
 	_REGISTER_CLOCK(NULL, "iim_clk", iim_clk),
-	_REGISTER_CLOCK(NULL, "i2c_clk", i2c_clk[0]),
+	_REGISTER_CLOCK("imx-i2c.0", NULL, i2c_clk[0]),
 	_REGISTER_CLOCK("imx-i2c.1", NULL, i2c_clk[1]),
 	_REGISTER_CLOCK("imx-i2c.2", NULL, i2c_clk[2]),
 	_REGISTER_CLOCK(NULL, "vpu_clk", vpu_clk[0]),
diff --git a/arch/arm/mach-mx6/devices-imx6q.h b/arch/arm/mach-mx6/devices-imx6q.h
index d35d44d..028185c 100644
--- a/arch/arm/mach-mx6/devices-imx6q.h
+++ b/arch/arm/mach-mx6/devices-imx6q.h
@@ -34,4 +34,7 @@ extern const struct imx_fec_data imx6q_fec_data;
 #define imx6q_add_fec(pdata)	\
 	imx_add_fec(&imx6q_fec_data, pdata)
 
+extern const struct imx_imx_i2c_data imx6q_imx_i2c_data[] __initconst;
+#define imx6q_add_imx_i2c(id, pdata)	\
+	imx_add_imx_i2c(&imx6q_imx_i2c_data[id], pdata)
 #endif
diff --git a/arch/arm/mach-mx6/mach-mx6q_sabrelite.c b/arch/arm/mach-mx6/mach-mx6q_sabrelite.c
index 5b716b7..3cd52af 100644
--- a/arch/arm/mach-mx6/mach-mx6q_sabrelite.c
+++ b/arch/arm/mach-mx6/mach-mx6q_sabrelite.c
@@ -312,6 +312,10 @@ static struct sdma_platform_data imx6q_sdma_pdata __initdata = {
 	.script_addrs = &imx6q_sdma_script,
 };
 
+static struct imxi2c_platform_data mx6q_sabrelite_i2c_data = {
+	.bitrate = 100000,
+};
+
 static void __init fixup_mxc_board(struct tag *tags, char **cmdline,
 				   struct meminfo *mi)
 {
@@ -347,6 +351,9 @@ static void __init mx6_sabrelite_board_init(void)
 	imx6q_add_fec(&fec_data);
 	mx6_cpu_regulator_init();
 
+	imx6q_add_imx_i2c(0, &mx6q_sabrelite_i2c_data);
+	imx6q_add_imx_i2c(1, &mx6q_sabrelite_i2c_data);
+	imx6q_add_imx_i2c(2, &mx6q_sabrelite_i2c_data);
 }
 
 static void __init mx6_sabrelite_timer_init(void)
diff --git a/arch/arm/plat-mxc/devices/platform-imx-i2c.c b/arch/arm/plat-mxc/devices/platform-imx-i2c.c
index 19ad580..3244d48 100644
--- a/arch/arm/plat-mxc/devices/platform-imx-i2c.c
+++ b/arch/arm/plat-mxc/devices/platform-imx-i2c.c
@@ -104,6 +104,16 @@ const struct imx_imx_i2c_data imx53_imx_i2c_data[] __initconst = {
 };
 #endif /* ifdef CONFIG_SOC_IMX53 */
 
+#ifdef CONFIG_SOC_IMX6Q
+const struct imx_imx_i2c_data imx6q_imx_i2c_data[] __initconst = {
+#define imx6q_imx_i2c_data_entry(_id, _hwid)				\
+	imx_imx_i2c_data_entry(MX6Q, _id, _hwid, SZ_4K)
+	imx6q_imx_i2c_data_entry(0, 1),
+	imx6q_imx_i2c_data_entry(1, 2),
+	imx6q_imx_i2c_data_entry(2, 3),
+};
+#endif /* ifdef CONFIG_SOC_IMX6Q */
+
 struct platform_device *__init imx_add_imx_i2c(
 		const struct imx_imx_i2c_data *data,
 		const struct imxi2c_platform_data *pdata)
-- 
1.7.9.7

