From b61928a2f734f8f5118eea898b50d2e13e11be97 Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Thu, 18 Mar 2010 15:19:52 +0800
Subject: [PATCH 2/3] omapfb: Fix omapfb_get_recommended_bpp

When the mode is "pal" or "ntsc", bpp_overrides[i].bpp is zero. We can't
return 0, because it is a illegal bpp, fb_init() will fail. So, if
bpp_overrides[i].bpp is zero, we got the bpp value from
get_recommended_bpp().

Signed-off-by: Stanley.Miao <stanley.miao@windriver.com>
---
 drivers/video/omap2/omapfb/omapfb-main.c |    9 ++++++---
 1 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/drivers/video/omap2/omapfb/omapfb-main.c b/drivers/video/omap2/omapfb/omapfb-main.c
index 4a76917..dc2030b 100644
--- a/drivers/video/omap2/omapfb/omapfb-main.c
+++ b/drivers/video/omap2/omapfb/omapfb-main.c
@@ -2045,15 +2045,18 @@ static int omapfb_get_recommended_bpp(struct omapfb2_device *fbdev,
 		struct omap_dss_device *dssdev)
 {
 	int i;
+	int bpp = 0;
 
 	BUG_ON(dssdev->driver->get_recommended_bpp == NULL);
 
 	for (i = 0; i < fbdev->num_bpp_overrides; ++i) {
-		if (dssdev == fbdev->bpp_overrides[i].dssdev)
-			return fbdev->bpp_overrides[i].bpp;
+		if (dssdev == fbdev->bpp_overrides[i].dssdev) {
+			bpp = fbdev->bpp_overrides[i].bpp;
+			break;
+		}
 	}
 
-	return dssdev->driver->get_recommended_bpp(dssdev);
+	return bpp ? bpp : dssdev->driver->get_recommended_bpp(dssdev);
 }
 
 static int omapfb_parse_def_modes(struct omapfb2_device *fbdev)
-- 
1.6.5.2

