From 87770929eb8f747d0e5ef18ca471722e2eaa5471 Mon Sep 17 00:00:00 2001
From: Jason Wessel <jason.wessel@windriver.com>
Date: Fri, 22 Jul 2011 09:07:01 -0500
Subject: [PATCH 1/2] omap3,iommu: boot time disable iommu and camera

Up until the qemu OMAP simulator implements the iommu and a camera
device, add a bit of code to allow these features to be disabled at
boot time to avoid kernel warning/oops messages.

Signed-off-by: Jason Wessel <jason.wessel@windriver.com>
---
 arch/arm/plat-omap/iommu.c    |   13 +++++++++++++
 drivers/media/video/isp/isp.c |    9 +++++++++
 2 files changed, 22 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-omap/iommu.c b/arch/arm/plat-omap/iommu.c
index 0e13766..625140b 100644
--- a/arch/arm/plat-omap/iommu.c
+++ b/arch/arm/plat-omap/iommu.c
@@ -31,6 +31,11 @@ static const struct iommu_functions *arch_iommu;
 static struct platform_driver omap_iommu_driver;
 static struct kmem_cache *iopte_cachep;
 
+/* Allow iommu to be turned off via kernel boot param */
+static int off;
+module_param(off, int, 0444);
+MODULE_PARM_DESC(off, "off=1");
+
 /**
  * install_iommu_arch - Install archtecure specific iommu functions
  * @ops:	a pointer to architecture specific iommu functions
@@ -788,6 +793,9 @@ struct iommu *iommu_get(const char *name)
 	struct device *dev;
 	struct iommu *obj;
 
+	if (off)
+		return ERR_PTR(err);
+
 	dev = driver_find_device(&omap_iommu_driver.driver, NULL, (void *)name,
 				 device_match_by_alias);
 	if (!dev)
@@ -974,6 +982,9 @@ static int __init omap_iommu_init(void)
 	const unsigned long flags = SLAB_HWCACHE_ALIGN;
 	size_t align = 1 << 10; /* L2 pagetable alignement */
 
+	if (off)
+		return 0;
+
 	p = kmem_cache_create("iopte_cache", IOPTE_TABLE_SIZE, align, flags,
 			      iopte_cachep_ctor);
 	if (!p)
@@ -986,6 +997,8 @@ module_init(omap_iommu_init);
 
 static void __exit omap_iommu_exit(void)
 {
+	if (off)
+		return;
 	kmem_cache_destroy(iopte_cachep);
 
 	platform_driver_unregister(&omap_iommu_driver);
diff --git a/drivers/media/video/isp/isp.c b/drivers/media/video/isp/isp.c
index bedcfc7..7965c8f 100644
--- a/drivers/media/video/isp/isp.c
+++ b/drivers/media/video/isp/isp.c
@@ -53,6 +53,11 @@ static void isp_restore_ctx(struct device *dev);
 
 static void isp_buf_init(struct device *dev);
 
+/* Allow iommu to be turned off via kernel boot param */
+static int off;
+module_param(off, int, 0444);
+MODULE_PARM_DESC(off, "off=1");
+
 #define omap_rev_is_1_0() (GET_OMAP_REVISION() == 0x00)
 
 /* List of image formats supported via OMAP ISP */
@@ -2777,6 +2782,8 @@ static struct platform_driver omap3isp_driver = {
  **/
 static int __init isp_init(void)
 {
+	if (off)
+		return 0;
 	return platform_driver_register(&omap3isp_driver);
 }
 
@@ -2785,6 +2792,8 @@ static int __init isp_init(void)
  **/
 static void __exit isp_cleanup(void)
 {
+	if (off)
+		return;
 	platform_driver_unregister(&omap3isp_driver);
 }
 
-- 
1.7.0.4

