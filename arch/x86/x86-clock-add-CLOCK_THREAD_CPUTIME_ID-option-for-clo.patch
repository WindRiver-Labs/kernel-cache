From 45fdb498b4d569c55060dca124d7bd7c9e06a31f Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Sun, 9 Oct 2011 14:08:37 +0800
Subject: [PATCH] x86/clock: add CLOCK_THREAD_CPUTIME_ID option for clock_gettime

Commit "trace-clock-userspace" did below modifications to __vdso_clock_gettime,
which causes case04 of clock_nanosleep01(ltp testcase) failed.

notrace int __vdso_clock_gettime(clockid_t clock, struct timespec *ts)
	return do_realtime_coarse(ts);
		case CLOCK_MONOTONIC_COARSE:
			return do_monotonic_coarse(ts);
+               case CLOCK_TRACE:
+                       return do_trace_clock(ts);
+               case CLOCK_TRACE_FREQ:
+                       return do_trace_clock_freq(ts);
+               default:
+                       return -EINVAL;
		}
	return vdso_fallback_gettime(clock, ts);
}

Since clk_id of case04 is CLOCK_THREAD_CPUTIME_ID, so we need to
handle CLOCK_THREAD_CPUTIME_ID case in __vdso_clock_gettime func
other than return -EINVAL.

Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 arch/x86/vdso/vclock_gettime.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/arch/x86/vdso/vclock_gettime.c b/arch/x86/vdso/vclock_gettime.c
index 7bc4815..57ddff4 100644
--- a/arch/x86/vdso/vclock_gettime.c
+++ b/arch/x86/vdso/vclock_gettime.c
@@ -165,6 +165,8 @@ notrace int __vdso_clock_gettime(clockid_t clock, struct timespec *ts)
 			if (likely(gtod->clock.vread))
 				return do_monotonic(ts);
 			break;
+		case CLOCK_THREAD_CPUTIME_ID:
+			return vdso_fallback_gettime(clock, ts);
 		case CLOCK_REALTIME_COARSE:
 			return do_realtime_coarse(ts);
 		case CLOCK_MONOTONIC_COARSE:
-- 
1.7.0.4

