From c0a3e95f87d4d2aa40b75e02f5a5d616af51979d Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Tue, 25 Jan 2011 22:44:51 +0800
Subject: [PATCH] ppc-mc/e500mc: avoid destroying r10

The following native commit would use r10:

    powerpc/booke: Add Stack Marking support to Booke Exception Prolog

So r10 would be corrupted when used by the guest OS again so here push up
these lines simply to avoid destroying r10 at last.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/head_booke.h |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/kernel/head_booke.h b/arch/powerpc/kernel/head_booke.h
index 6c94650..1d78323 100644
--- a/arch/powerpc/kernel/head_booke.h
+++ b/arch/powerpc/kernel/head_booke.h
@@ -43,6 +43,9 @@
 	stw	r12,GPR11(r11);						     \
 	mflr	r10;							     \
 	stw	r10,_LINK(r11);						     \
+	lis     r10, STACK_FRAME_REGS_MARKER@ha;/* exception frame marker */ \
+	addi    r10, r10, STACK_FRAME_REGS_MARKER@l;                         \
+	stw     r10, 8(r11);                                                 \
 	mfspr	r10,SPRN_SPRG_RSCRATCH2;				     \
 	mfspr	r12,SPRN_SRR0;						     \
 	stw	r10,GPR1(r11);						     \
@@ -50,9 +53,6 @@
 	stw	r10,0(r11);						     \
 	rlwinm	r9,r9,0,14,12;		/* clear MSR_WE (necessary?)	   */\
 	stw	r0,GPR0(r11);						     \
-	lis     r10, STACK_FRAME_REGS_MARKER@ha;/* exception frame marker */ \
-	addi    r10, r10, STACK_FRAME_REGS_MARKER@l;                         \
-	stw     r10, 8(r11);                                                 \
 	SAVE_4GPRS(3, r11);						     \
 	SAVE_2GPRS(7, r11)
 
-- 
1.6.5.2

