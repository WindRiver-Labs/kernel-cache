From 101f6c08f285404bcc333000bcdb56338a5fbd1b Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Thu, 30 Jun 2011 12:55:23 +0800
Subject: [PATCH 222/233] net/dpa: only use one buffer pool even when static buffer pools are used

Currently the DPA driver only supports one buffer pool, and all the
ethernet will use it. This works fine when no static buffer pool is
used. But when we assign different static buffer pool to each ethernet,
the dpa driver will allocate a buffer pool for each ethernet, and use
the static bpid to initialize the port register. But it doesn't really
allocate the buffers for these pools except the first one. This will
definitely cause the others ethernet malfunction. So we should not
allocate new buffer pools after one has already been created even when
we use static buffer pool for this ethernet.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
[rebase it onto QorIQ-DPAA-SDK-V1-20110609-systembuilder.iso]
Integrated-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 drivers/net/dpa/dpaa_eth.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/net/dpa/dpaa_eth.c b/drivers/net/dpa/dpaa_eth.c
index e44ab1e..73bee6d 100644
--- a/drivers/net/dpa/dpaa_eth.c
+++ b/drivers/net/dpa/dpaa_eth.c
@@ -1740,7 +1740,7 @@ dpa_bp_probe(struct of_device *_of_dev, size_t *count)
 	phandle_prop = of_get_property(_of_dev->node,
 					"fsl,bman-buffer-pools", &lenp);
 
-	if (phandle_prop)
+	if (phandle_prop && !default_pool)
 		*count = lenp / sizeof(phandle);
 	else {
 		if (default_pool)
-- 
1.7.0.4

