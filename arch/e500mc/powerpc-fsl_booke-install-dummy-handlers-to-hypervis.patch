From 13a57b39bd4aedd8d09b8ebbb3469ab76035ec87 Mon Sep 17 00:00:00 2001
From: Shan Hai <shan.hai@windriver.com>
Date: Thu, 18 Jul 2013 05:30:12 -0400
Subject: [PATCH] powerpc/fsl_booke: install dummy handlers to hypervisor exceptions

Catching those exceptions without handling them is better than leave
them in the wild. The cpu would hang if the uninitialized exceptions
are triggered, the crash01 from LTP test suite can trigger those
exceptions by running random data in memory as instructions.

Signed-off-by: Shan Hai <shan.hai@windriver.com>
---
 arch/powerpc/kernel/head_fsl_booke.S |   24 ++++++++++++++++++++++++
 1 files changed, 24 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/head_fsl_booke.S b/arch/powerpc/kernel/head_fsl_booke.S
index 95b54dc..3817e93 100644
--- a/arch/powerpc/kernel/head_fsl_booke.S
+++ b/arch/powerpc/kernel/head_fsl_booke.S
@@ -775,6 +775,18 @@ cont:
 	/* Debug Interrupt */
 	DEBUG_DEBUG_EXCEPTION
 	DEBUG_CRIT_EXCEPTION
+	
+	/* Guest DoorBell */
+	EXCEPTION(0x4000, GuestDoorBell, unknown_exception, EXC_XFER_EE)
+
+	/* Guest DoorBell Critical */
+	CRITICAL_EXCEPTION(0x4010, CriticalGuestDoorBell, unknown_exception)
+
+	/* Hypercall */
+	EXCEPTION(0x4020, HyperCall, unknown_exception, EXC_XFER_EE)
+
+	/* Embedded Hypervisor Privilege */
+	EXCEPTION(0x4030, Ehvpriv, unknown_exception, EXC_XFER_EE)
 
 /*
  * Local functions
@@ -1088,6 +1100,18 @@ _GLOBAL(__setup_e500mc_ivors)
 	mtspr	SPRN_IVOR36,r3
 	li	r3,CriticalDoorbell@l
 	mtspr	SPRN_IVOR37,r3
+	mfspr   r3, SPRN_MMUCFG
+	andis.  r3, r3, MMUCFG_LPIDSIZE@h
+	beq     skip_hv_ivors
+	li      r3,GuestDoorBell@l
+	mtspr   SPRN_IVOR38,r3
+	li      r3,CriticalGuestDoorBell@l
+	mtspr   SPRN_IVOR39,r3
+	li      r3,HyperCall@l
+	mtspr   SPRN_IVOR40,r3
+	li      r3,Ehvpriv@l
+	mtspr   SPRN_IVOR41,r3
+skip_hv_ivors:
 	sync
 	blr
 
-- 
1.7.0

