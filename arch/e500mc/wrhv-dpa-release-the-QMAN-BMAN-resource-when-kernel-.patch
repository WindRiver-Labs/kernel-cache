From 9bca1a4ef74557bdbc1f22b2871b3af09c9026e4 Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Wed, 29 Jun 2011 15:26:05 +0800
Subject: [PATCH 207/233] wrhv/dpa: release the QMAN/BMAN resource when kernel restart

In guest OS, the QMAN/BMAN doesn't really be reset when the
kernel restart. So we should release the buffers in BMAN which are
created by dpa driver, and also destroy the FQs in QMAN which are
used for tx/rx queue. Otherwise after reboot the BMAN will include
stale buffers, and the FQ which is still in running state will be
initialized again.  This will make these FQs nonoperative.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
[rebase it onto QorIQ-DPAA-SDK-V1-20110609-systembuilder.iso]
Integrated-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 drivers/net/dpa/dpaa_eth.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/net/dpa/dpaa_eth.c b/drivers/net/dpa/dpaa_eth.c
index 03ff091..1351848 100644
--- a/drivers/net/dpa/dpaa_eth.c
+++ b/drivers/net/dpa/dpaa_eth.c
@@ -2758,6 +2758,9 @@ static struct of_platform_driver dpa_driver = {
 	.match_table	= dpa_match,
 	.owner		= THIS_MODULE,
 	.probe		= dpaa_eth_probe,
+#ifdef CONFIG_PPC85xx_VT_MODE
+	.shutdown	= dpa_remove,
+#endif
 	.remove		= __devexit_p(dpa_remove)
 };
 
-- 
1.7.0.4

