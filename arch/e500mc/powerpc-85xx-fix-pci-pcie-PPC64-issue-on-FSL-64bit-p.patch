From f2acf98920ca426c1f1264e8000a98d44d11b959 Mon Sep 17 00:00:00 2001
From: Lei Xu <B33228@freescale.com>
Date: Fri, 15 Apr 2011 18:33:59 +0800
Subject: [PATCH 058/233] powerpc/85xx: fix pci/pcie PPC64 issue on FSL 64bit processor

Extracted from vendor drop QorIQ-DPAA-SDK-V1-20110609-systembuilder.iso
0087-powerpc-85xx-fix-pci-pcie-PPC64-issue-on-FSL-64bit-p.patch

There are different data structures for pci/pcie in linux kernel
on PPC64 and PPC32, so this patch will handle the difference
as what they are defined.

Signed-off-by: Lei Xu <B33228@freescale.com>
Signed-off-by: Roy Zang <tie-fei.zang@freescale.com>
---
 arch/powerpc/kernel/pci-common.c |    4 ++++
 arch/powerpc/sysdev/fsl_pci.c    |    4 ++++
 arch/powerpc/sysdev/fsl_pci.h    |    1 +
 3 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/pci-common.c b/arch/powerpc/kernel/pci-common.c
index d4b8d86..74ec5bb 100644
--- a/arch/powerpc/kernel/pci-common.c
+++ b/arch/powerpc/kernel/pci-common.c
@@ -1664,7 +1664,11 @@ fake_pci_bus(struct pci_controller *hose, int busnr)
 		printk(KERN_ERR "Can't find hose for PCI bus %d!\n", busnr);
 	}
 	bus.number = busnr;
+#ifdef CONFIG_PPC64
+	bus.sysdata = hose->dn;
+#else
 	bus.sysdata = hose;
+#endif
 	bus.ops = hose? hose->ops: &null_pci_ops;
 	return &bus;
 }
diff --git a/arch/powerpc/sysdev/fsl_pci.c b/arch/powerpc/sysdev/fsl_pci.c
index 790984e..d55a946 100644
--- a/arch/powerpc/sysdev/fsl_pci.c
+++ b/arch/powerpc/sysdev/fsl_pci.c
@@ -369,6 +369,10 @@ int __init fsl_add_bridge(struct device_node *dev, int is_primary)
 	hose->first_busno = bus_range ? bus_range[0] : 0x0;
 	hose->last_busno = bus_range ? bus_range[1] : 0xff;
 
+#ifdef CONFIG_PPC64
+	pci_devs_phb_init_dynamic(hose);
+#endif
+
 	setup_indirect_pci(hose, rsrc.start, rsrc.start + 0x4,
 		PPC_INDIRECT_TYPE_BIG_ENDIAN);
 	setup_pci_cmd(hose);
diff --git a/arch/powerpc/sysdev/fsl_pci.h b/arch/powerpc/sysdev/fsl_pci.h
index 96af1b4..4f76cde 100644
--- a/arch/powerpc/sysdev/fsl_pci.h
+++ b/arch/powerpc/sysdev/fsl_pci.h
@@ -91,6 +91,7 @@ struct ccsr_pci {
 extern int fsl_add_bridge(struct device_node *dev, int is_primary);
 extern void fsl_pcibios_fixup_bus(struct pci_bus *bus);
 extern int mpc83xx_add_bridge(struct device_node *dev);
+extern void __devinit pci_devs_phb_init_dynamic(struct pci_controller *phb);
 
 #endif /* __POWERPC_FSL_PCI_H */
 #endif /* __KERNEL__ */
-- 
1.7.0.4

