From 03419e86b96929c632c454e89b24650fb342cb00 Mon Sep 17 00:00:00 2001
From: Xulei <B33228@freescale.com>
Date: Wed, 29 Dec 2010 09:32:48 +0000
Subject: [PATCH 147/233] eSDHC: Access Freescale eSDHC registers by 32-bit

Extracted from QorIQ-DPAA-SDK-V1-20110609-systembuilder.iso
0118-eSDHC-Access-Freescale-eSDHC-registers-by-32-bit.patch

For Freescale eSDHC registers only support 32-bit accesses,
this patch ensure that all Freescale eSDHC register accesses
are 32-bit.

Signed-off-by: Xulei <B33228@freescale.com>
---
 drivers/mmc/host/sdhci-of-esdhc.c |   18 ++++++++++++++----
 1 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/drivers/mmc/host/sdhci-of-esdhc.c b/drivers/mmc/host/sdhci-of-esdhc.c
index d5b11a1..9d4ec86 100644
--- a/drivers/mmc/host/sdhci-of-esdhc.c
+++ b/drivers/mmc/host/sdhci-of-esdhc.c
@@ -1,7 +1,7 @@
 /*
  * Freescale eSDHC controller driver.
  *
- * Copyright (c) 2007 Freescale Semiconductor, Inc.
+ * Copyright (c) 2007, 2010 Freescale Semiconductor, Inc.
  * Copyright (c) 2009 MontaVista Software, Inc.
  *
  * Authors: Xiaobo Xie <X.Xie@freescale.com>
@@ -39,11 +39,21 @@
 static u16 esdhc_readw(struct sdhci_host *host, int reg)
 {
 	u16 ret;
+	int base = reg & ~0x3;
+	int shift = (reg & 0x2) * 8;
 
 	if (unlikely(reg == SDHCI_HOST_VERSION))
-		ret = in_be16(host->ioaddr + reg);
+		ret = in_be32(host->ioaddr + base) & 0xffff;
 	else
-		ret = sdhci_be32bs_readw(host, reg);
+		ret = (in_be32(host->ioaddr + base) >> shift) & 0xffff;
+	return ret;
+}
+
+static u8 esdhc_readb(struct sdhci_host *host, int reg)
+{
+	int base = reg & ~0x3;
+	int shift = (reg & 0x3) * 8;
+	u8 ret = (in_be32(host->ioaddr + base) >> shift) & 0xff;
 	return ret;
 }
 
@@ -131,7 +141,7 @@ struct sdhci_of_data sdhci_esdhc = {
 	.ops = {
 		.readl = sdhci_be32bs_readl,
 		.readw = esdhc_readw,
-		.readb = sdhci_be32bs_readb,
+		.readb = esdhc_readb,
 		.writel = sdhci_be32bs_writel,
 		.writew = esdhc_writew,
 		.writeb = esdhc_writeb,
-- 
1.7.0.4

