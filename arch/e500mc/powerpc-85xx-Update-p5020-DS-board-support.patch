From c14b52d5179d558ce56a2704943fdeccef221ad8 Mon Sep 17 00:00:00 2001
From: Kumar Gala <kumar.gala@freescale.com>
Date: Thu, 14 Oct 2010 02:13:49 -0500
Subject: [PATCH 078/233] powerpc/85xx: Update p5020 DS board support

Extracted from vendor drop QorIQ-DPAA-SDK-V1-20110609-systembuilder.iso
0176-powerpc-85xx-Update-p5020-DS-board-support.patch

Update P5020DS code to deal with network and other refactoring.

Signed-off-by: Kumar Gala <galak@kernel.crashing.org>
[context adjustment]
Integrated-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/powerpc/platforms/85xx/Kconfig    |    1 +
 arch/powerpc/platforms/85xx/p5020_ds.c |   17 ++++++++++++++++-
 2 files changed, 17 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/Kconfig b/arch/powerpc/platforms/85xx/Kconfig
index 893ad4a..317926a 100644
--- a/arch/powerpc/platforms/85xx/Kconfig
+++ b/arch/powerpc/platforms/85xx/Kconfig
@@ -208,6 +208,7 @@ config P5020_DS
 	select SWIOTLB
 	select MPC8xxx_GPIO
 	select HAS_RAPIDIO
+	select HAS_FSL_PAMU
 	select FSL_HYDRA_DS_MDIO if PHYLIB
 	help
 	  This option enables support for the P5020 DS board
diff --git a/arch/powerpc/platforms/85xx/p5020_ds.c b/arch/powerpc/platforms/85xx/p5020_ds.c
index 7467b71..912fdfb 100644
--- a/arch/powerpc/platforms/85xx/p5020_ds.c
+++ b/arch/powerpc/platforms/85xx/p5020_ds.c
@@ -43,6 +43,18 @@ static int __init p5020_ds_probe(void)
 	return of_flat_dt_is_compatible(root, "fsl,P5020DS");
 }
 
+#if defined(CONFIG_PHYLIB) && defined(CONFIG_VITESSE_PHY)
+int vsc824x_add_skew(struct phy_device *phydev);
+#define PHY_ID_VSC8244                  0x000fc6c0
+static int __init board_fixups(void)
+{
+	phy_register_fixup_for_uid(PHY_ID_VSC8244, 0xfffff, vsc824x_add_skew);
+
+	return 0;
+}
+machine_device_initcall(p5020_ds, board_fixups);
+#endif
+
 define_machine(p5020_ds) {
 	.name			= "P5020 DS",
 	.probe			= p5020_ds_probe,
@@ -60,9 +72,12 @@ define_machine(p5020_ds) {
 	.restart		= fsl_rstcr_restart,
 	.calibrate_decr		= generic_calibrate_decr,
 	.progress		= udbg_progress,
+	.idle_loop		= cpu_idle_simple,
+	.power_save		= ppc_wait,
+	.init_early		= corenet_ds_init_early,
 };
 
-machine_device_initcall(p5020_ds, corenet_ds_publish_devices);
+machine_device_initcall(p5020_ds, declare_of_platform_devices);
 
 #ifdef CONFIG_SWIOTLB
 machine_arch_initcall(p5020_ds, swiotlb_setup_bus_notifier);
-- 
1.7.0.4

