From 5925c474dee267327e44f5800ed42510cb788c5a Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Tue, 29 Mar 2011 11:47:40 +0800
Subject: [PATCH 1/4] wrs_sbcp4080: add Wind River SBC P4080 board support

Introduce new platform support for Wind River SBC P4080

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/powerpc/platforms/85xx/Kconfig    |   12 +++++
 arch/powerpc/platforms/85xx/Makefile   |    1 +
 arch/powerpc/platforms/85xx/sbcp4080.c |   70 ++++++++++++++++++++++++++++++++
 3 files changed, 83 insertions(+), 0 deletions(-)
 create mode 100644 arch/powerpc/platforms/85xx/sbcp4080.c

diff --git a/arch/powerpc/platforms/85xx/Kconfig b/arch/powerpc/platforms/85xx/Kconfig
index e55c4f7..5c7f86d 100644
--- a/arch/powerpc/platforms/85xx/Kconfig
+++ b/arch/powerpc/platforms/85xx/Kconfig
@@ -195,6 +195,18 @@ config P4080_DS
 	help
 	  This option enables support for the P4080 DS board
 
+config SBCP4080
+	bool "Wind River SBC P4080"
+	select DEFAULT_UIMAGE
+	select PPC_E500MC
+	select SWIOTLB
+	select MPC8xxx_GPIO
+	select HAS_FSL_PAMU
+	select HAS_FSL_QBMAN
+	select HAS_FSL_PME
+	help
+	  This option enables support for the Wind River SBC P4080 board
+
 config WRHV_E500
 	bool
 
diff --git a/arch/powerpc/platforms/85xx/Makefile b/arch/powerpc/platforms/85xx/Makefile
index 17dc815..f997dd0 100644
--- a/arch/powerpc/platforms/85xx/Makefile
+++ b/arch/powerpc/platforms/85xx/Makefile
@@ -26,4 +26,5 @@ obj-$(CONFIG_SOCRATES)    += socrates.o socrates_fpga_pic.o
 obj-$(CONFIG_KSI8560)	  += ksi8560.o
 obj-$(CONFIG_XES_MPC85xx) += xes_mpc85xx.o
 obj-$(CONFIG_WRHV_P4080DS)    += wrhv_p4080_ds.o corenet_ds_mdio.o
+obj-$(CONFIG_SBCP4080)    += sbcp4080.o corenet_ds.o
 obj-$(CONFIG_FSL_PMC)     += uli8259_suspend.o
diff --git a/arch/powerpc/platforms/85xx/sbcp4080.c b/arch/powerpc/platforms/85xx/sbcp4080.c
new file mode 100644
index 0000000..0bf1967
--- /dev/null
+++ b/arch/powerpc/platforms/85xx/sbcp4080.c
@@ -0,0 +1,70 @@
+/*
+ * Wind River SBCP4080 setup and early boot code.
+ *
+ * Copyright 2011 Wind River Systems Inc.
+ *
+ * By Weiwei Wang <weiwei.wang@windriver.com>
+ *
+ * Based largely on the P4080 DS support - Copyright 2009-2010 Freescale Inc.
+ *
+ *
+ * This program is free software; you can redistribute  it and/or modify it
+ * under  the terms of  the GNU General  Public License as published by the
+ * Free Software Foundation;  either version 2 of the  License, or (at your
+ * option) any later version.
+ */
+
+#include <linux/kernel.h>
+#include <linux/pci.h>
+#include <linux/kdev_t.h>
+#include <linux/delay.h>
+#include <linux/interrupt.h>
+#include <linux/phy.h>
+
+#include <asm/system.h>
+#include <asm/time.h>
+#include <asm/machdep.h>
+#include <asm/pci-bridge.h>
+#include <mm/mmu_decl.h>
+#include <asm/prom.h>
+#include <asm/udbg.h>
+#include <asm/mpic.h>
+
+#include <linux/of_platform.h>
+#include <sysdev/fsl_soc.h>
+#include <sysdev/fsl_pci.h>
+
+#include "corenet_ds.h"
+
+/*
+ * Called very early, device-tree isn't unflattened
+ */
+static int __init sbcp4080_probe(void)
+{
+	unsigned long root = of_get_flat_dt_root();
+
+	return of_flat_dt_is_compatible(root, "SBCP4080");
+}
+
+define_machine(sbcp4080) {
+	.name			= "SBCP4080",
+	.probe			= sbcp4080_probe,
+	.setup_arch		= corenet_ds_setup_arch,
+	.init_IRQ		= corenet_ds_pic_init,
+#ifdef CONFIG_PCI
+	.pcibios_fixup_bus	= fsl_pcibios_fixup_bus,
+#endif
+	.get_irq		= mpic_get_coreint_irq,
+	.restart		= fsl_rstcr_restart,
+	.calibrate_decr		= generic_calibrate_decr,
+	.progress		= udbg_progress,
+	.idle_loop		= cpu_idle_simple,
+	.power_save		= ppc_wait,
+	.init_early		= corenet_ds_init_early,
+};
+
+machine_device_initcall(sbcp4080, declare_of_platform_devices);
+
+#ifdef CONFIG_SWIOTLB
+machine_arch_initcall(sbcp4080, swiotlb_setup_bus_notifier);
+#endif
-- 
1.7.0.4

