From 340724ba26c033289323227d5955d9c04c3a7081 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Thu, 8 Sep 2011 11:02:20 +0800
Subject: [PATCH 3/3] PPC_BOOK3E/kexec: convert appropriate address when kexec boot

When the kernel kexec loaded boot we already run at PAGE_OFFSET. So
convert some addresses rerfer to PAGE_OFFSET. And we should use
KEXEC_POWERPC_SMP_BOOTABLE to guarantee this.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/Kconfig              |    2 +-
 arch/powerpc/kernel/head_64.S     |    8 +++++++-
 arch/powerpc/platforms/85xx/smp.c |    2 +-
 3 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/Kconfig b/arch/powerpc/Kconfig
index 07885ef..7668378 100644
--- a/arch/powerpc/Kconfig
+++ b/arch/powerpc/Kconfig
@@ -374,7 +374,7 @@ config KEXEC
 
 config KEXEC_POWERPC_SMP_BOOTABLE
 	bool "Kernel bootable by kexec"
-	depends on SMP && (PPC_MULTIPLATFORM || PPC_85xx) && EXPERIMENTAL
+	depends on ((PPC_BOOK3E) || SMP && (PPC_MULTIPLATFORM || PPC_85xx)) && EXPERIMENTAL
 	help
 	  Some PowerPC kernels need a special treatment to be able to shut
 	  down CPUs and bring them safely to the kernel being kexec'ed into.
diff --git a/arch/powerpc/kernel/head_64.S b/arch/powerpc/kernel/head_64.S
index ad90636..b5b9e9e 100644
--- a/arch/powerpc/kernel/head_64.S
+++ b/arch/powerpc/kernel/head_64.S
@@ -413,9 +413,12 @@ _STATIC(__after_prom_start)
 #endif
 	mr.	r4,r26			/* In some cases the loader may  */
 	beq	9f			/* have already put us at zero */
+#if defined(CONFIG_PPC_BOOK3E) && defined(CONFIG_KEXEC_POWERPC_SMP_BOOTABLE)
+	tovirt(r4,r4)			/* on booke, we already run at PAGE_OFFSET */
+#endif
 	li	r6,0x100		/* Start offset, the first 0x100 */
 					/* bytes were copied earlier.	 */
-#ifdef CONFIG_PPC_BOOK3E
+#if defined(CONFIG_PPC_BOOK3E) && !defined(CONFIG_KEXEC_POWERPC_SMP_BOOTABLE)
 	tovirt(r6,r6)			/* on booke, we already run at PAGE_OFFSET */
 #endif
 
@@ -448,6 +451,9 @@ p_end:	.llong	_end - _stext
 
 4:	/* Now copy the rest of the kernel up to _end */
 	addis	r5,r26,(p_end - _stext)@ha
+#if defined(CONFIG_PPC_BOOK3E) && defined(CONFIG_KEXEC_POWERPC_SMP_BOOTABLE)
+	tovirt(r5,r5)			/* on booke, we already run at PAGE_OFFSET */
+#endif
 	ld	r5,(p_end - _stext)@l(r5)	/* get _end */
 5:	bl	.copy_and_flush		/* copy the rest */
 
diff --git a/arch/powerpc/platforms/85xx/smp.c b/arch/powerpc/platforms/85xx/smp.c
index 32dfb6a..a38a433 100644
--- a/arch/powerpc/platforms/85xx/smp.c
+++ b/arch/powerpc/platforms/85xx/smp.c
@@ -150,7 +150,7 @@ smp_85xx_unmap_bootpg(void)
 }
 #endif	/* #if !defined CONFIG_E500 || !defined CONFIG_SUSPEND */
 
-#ifndef CONFIG_KEXEC_POWERPC_SMP_BOOTABLE
+#if !defined(CONFIG_KEXEC_POWERPC_SMP_BOOTABLE) || defined(CONFIG_PPC_BOOK3E)
 static void __cpuinit
 smp_85xx_kick_cpu(int nr)
 {
-- 
1.7.0.2

