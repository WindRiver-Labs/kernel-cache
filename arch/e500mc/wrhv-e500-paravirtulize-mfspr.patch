From bf32c26d1490c324663a3eea376c82eafe306972 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Fri, 29 Jul 2011 13:21:37 +0800
Subject: [PATCH 2/2] wrhv/e500: paravirtulize mfspr

The mfspr is used by some drivers. So paravirtulize it by using
wrhv_mfspr on E500 GOS.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/include/asm/reg.h      |    2 ++
 arch/powerpc/include/asm/reg_wrhv.h |    5 +++++
 arch/powerpc/kernel/vbi/wrhv.c      |    1 +
 3 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/reg.h b/arch/powerpc/include/asm/reg.h
index f9b4ff2..a2bd01e 100644
--- a/arch/powerpc/include/asm/reg.h
+++ b/arch/powerpc/include/asm/reg.h
@@ -925,9 +925,11 @@
 #define mtmsr(v)	asm volatile("mtmsr %0" : : "r" (v) : "memory")
 #endif
 
+#ifndef mfspr
 #define mfspr(rn)	({unsigned long rval; \
 			asm volatile("mfspr %0," __stringify(rn) \
 				: "=r" (rval)); rval;})
+#endif
 
 #define mtspr(rn, v)	asm volatile("mtspr " __stringify(rn) ",%0" : : "r" (v)\
 				     : "memory")
diff --git a/arch/powerpc/include/asm/reg_wrhv.h b/arch/powerpc/include/asm/reg_wrhv.h
index 33ba1e3..1c1f6d2 100644
--- a/arch/powerpc/include/asm/reg_wrhv.h
+++ b/arch/powerpc/include/asm/reg_wrhv.h
@@ -201,6 +201,11 @@
 	lis	rd,wrhv_supervisor@ha;                          \
 	lwz	rd,wrhv_supervisor@l(rd)
 #endif
+#else	/* __ASSEMBLY__ */
+#ifndef CONFIG_PPC85xx_VT_MODE
+extern unsigned int wrhv_mfspr(unsigned int sprn);
+#define mfspr(rn)	wrhv_mfspr(rn)
+#endif
 #endif /* __ASSEMBLY__ */
 
 #endif /* __KERNEL__ */
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 8538758..e655c7c 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -1763,6 +1763,7 @@ unsigned int wrhv_mfspr(unsigned int sprn)
 	return value;
 }
 #endif
+EXPORT_SYMBOL(wrhv_mfspr);
 
 /* arch/powerpc/kernel/traps.c */
 void __kprobes wrhv_DebugException(struct pt_regs *regs, unsigned long debug_status)
-- 
1.7.0.4

