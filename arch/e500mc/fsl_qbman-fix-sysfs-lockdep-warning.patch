From 423fcbd4d2324dc8b200aea1ad170c3f35f30ddf Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Fri, 1 Jul 2011 11:00:22 +0800
Subject: [PATCH 194/233] fsl_qbman: fix sysfs lockdep warning

sysfs lockdep warning is reported:
BUG: key deadbeef not in .data!
------------[ cut here ]------------
Badness at kernel/lockdep.c:2713
NIP: c007e9ac LR: c007e994 CTR: c049f6b4
REGS: ebca9c70 TRAP: 0700   Not tainted  (2.6.34.9-WR4.2.0.0_standard)
MSR: 00029002 <EE,ME,CE>  CR: 24042042  XER: 00000000
TASK = ebca0000[1] 'swapper' THREAD: ebca8000 CPU: 0
GPR00: 00000000 ebca9d20 ebca0000 00000001 00000001 c0048a50 00000000 00000002
GPR08: 00000000 c0860000 00000001 c0860000 24042044 34cb9444 00000000 ebca8040
GPR16: c08540b0 c0636028 ebca8000 ebeebc00 ebeebc18 00000020 c085fe80 c0e48b50
GPR24: c053ca3c c08634ca 00000000 ebeebc18 fffffff4 ebd3e2a0 c0860000 ebd3e2e0
NIP [c007e9ac] lockdep_init_map+0x334/0x514
LR [c007e994] lockdep_init_map+0x31c/0x514
Call Trace:
[ebca9d20] [c007e984] lockdep_init_map+0x30c/0x514 (unreliable)
[ebca9d80] [c017ba40] sysfs_add_file_mode+0x5c/0xe8
[ebca9db0] [c017e7d8] internal_create_group+0xf8/0x204
[ebca9df0] [c06361dc] of_fsl_bman_probe+0x2c4/0x38c
[ebca9e40] [c053ba74] of_platform_device_probe+0x58/0x98
[ebca9e60] [c03d4758] driver_probe_device+0xa0/0x188
[ebca9e80] [c03d48fc] __driver_attach+0xbc/0xc0
[ebca9ea0] [c03d3d8c] bus_for_each_dev+0x70/0xac
[ebca9ed0] [c03d4584] driver_attach+0x24/0x34
[ebca9ee0] [c03d34f8] bus_add_driver+0xdc/0x304
[ebca9f10] [c03d4c6c] driver_register+0x94/0x164
[ebca9f30] [c053b950] of_register_driver+0x54/0x70
[ebca9f40] [c053cae4] bman_ctrl_init+0x24/0x34
[ebca9f50] [c0001d48] do_one_initcall+0x3c/0x1e4
[ebca9f80] [c07d9394] kernel_init+0x1a0/0x278
[ebca9ff0] [c001124c] original_kernel_thread+0x4c/0x68
Instruction dump:
7ca42b78 485a40c5 801e3168 2f800000 409eff84 482f39d5 2f830000 41beff78
3d20c086 80093408 2f800000 40beff68 <0fe00000> 4bffff60 7ee00106 4bffff58

call sysfs_attr_init to fix it.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 drivers/staging/fsl_qbman/bman_config.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_qbman/bman_config.c b/drivers/staging/fsl_qbman/bman_config.c
index 8b18680..6808236 100644
--- a/drivers/staging/fsl_qbman/bman_config.c
+++ b/drivers/staging/fsl_qbman/bman_config.c
@@ -623,6 +623,7 @@ static int __devinit of_fsl_bman_probe(struct of_device *ofdev,
 			(name_attrs_pool_count + i * 3);
 		dev_attr_buffer_pool_count[i].attr.mode = S_IRUSR;
 		dev_attr_buffer_pool_count[i].show = show_pool_count;
+		sysfs_attr_init(&dev_attr_buffer_pool_count[i].attr);
 		bman_dev_pool_count_attributes[i] =
 			&dev_attr_buffer_pool_count[i].attr;
 	}
-- 
1.7.0.4

