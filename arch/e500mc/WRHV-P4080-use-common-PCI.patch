From 320a11065ff5c06317db59c742f7c852e06b1766 Mon Sep 17 00:00:00 2001
From: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
Date: Mon, 24 May 2010 16:55:28 -0400
Subject: [PATCH 229/252] WRHV/P4080 use common PCI

Instead of having each board with its own specific
implementation of PCI, keep the duplication in a
common place.

Remove the P4080 PCI enabling components now that its
in a common shared location.  The DTS file is now responsible
to specifying the offset needed to setup the PCI LAW.

Signed-off-by: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
---
 arch/powerpc/boot/dts/wrhv_p4080ds.dts      |    3 ++
 arch/powerpc/platforms/85xx/wrhv_p4080_ds.c |   35 ++++----------------------
 2 files changed, 9 insertions(+), 29 deletions(-)

diff --git a/arch/powerpc/boot/dts/wrhv_p4080ds.dts b/arch/powerpc/boot/dts/wrhv_p4080ds.dts
index 2c6950e..c191982 100644
--- a/arch/powerpc/boot/dts/wrhv_p4080ds.dts
+++ b/arch/powerpc/boot/dts/wrhv_p4080ds.dts
@@ -641,6 +641,9 @@
 			compatible = "fsl,corenet-law";
 			reg = <0x0 0x1000>;
 			fsl,num-laws = <32>;
+			high-base = <0xc00>;
+			low-base = <0xc04>;
+			law-attrib = <0xc08>;
 		};
 
 		corenet-cf {
diff --git a/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c b/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
index 800259a..44e3596 100644
--- a/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
+++ b/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
@@ -36,6 +36,9 @@
 extern struct vb_config *wr_config;
 extern struct vb_status *wr_status;
 extern struct vb_control *wr_control;
+extern int wrhv_set_law_base(int index, unsigned long long addr);
+extern int wrhv_set_law_attr(int index, unsigned int attr);
+extern int wrhv_get_law_attr(int index);
 
 static void __init wrhv_mpc85xx_pic_init(void)
 {
@@ -53,32 +56,6 @@ static int primary_phb_addr;
 extern void __init wrhv_smp_init(void);
 #endif
 
-int wrhv_p4080_set_law_base(int index, unsigned long long addr)
-{
-	/* Set High base address */
-	out_be32((unsigned int *)(law_base + 0xc00 + index * 0x10), (addr >> 32) & 0xf);
-	/* Set Low base address */
-	out_be32((unsigned int *)(law_base + 0xc04 + index * 0x10), (unsigned int)addr);
-	return 0;
-} 
-
-int wrhv_p4080_set_law_attr(int index, unsigned int attr)
-{
-	/* Set Attributes */
-	out_be32((unsigned int *)(law_base + 0xc08 + index * 0x10), attr);
-
-	return 0;
-} 
-
-int wrhv_p4080_get_law_attr(int index)
-{
-	unsigned int attr = -1;
-
-	/* Get Attributes */
-	attr = in_be32((unsigned int *)(law_base + 0xc08 + index * 0x10));
-	return attr;
-}
-
 static void __init mpc85xx_ds_setup_arch(void)
 {
 #ifdef CONFIG_PCI
@@ -250,7 +227,7 @@ define_machine(p4080_ds) {
 	.progress		= udbg_progress,
 	.init_early		= p4080_init_early,
 	.idle_loop		= wait_idle,
-	.set_law_base		= wrhv_p4080_set_law_base,	
-	.set_law_attr		= wrhv_p4080_set_law_attr,
-	.get_law_attr		= wrhv_p4080_get_law_attr,
+	.set_law_base		= wrhv_set_law_base,
+	.set_law_attr		= wrhv_set_law_attr,
+	.get_law_attr		= wrhv_get_law_attr,
 };
-- 
1.6.5.2

