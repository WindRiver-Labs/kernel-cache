From 5ecb263479cefdd530a8cbc7a7ea772c91342f44 Mon Sep 17 00:00:00 2001
From: Benjamin Walsh <benjamin.walsh@windriver.com>
Date: Fri, 17 Sep 2010 13:11:36 -0700
Subject: [PATCH 148/252] kexec/p4080: Drain BMan on the way up in new kernel

Find the pools and drain all buffers from previous kernel.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
Integrated-by: Benjamin Walsh <benjamin.walsh@windriver.com>
---
 drivers/hwalloc/bman_driver.c |   35 +++++++++++++++++++++++++++++++++++
 1 files changed, 35 insertions(+), 0 deletions(-)

diff --git a/drivers/hwalloc/bman_driver.c b/drivers/hwalloc/bman_driver.c
index a592f1b..fe37813 100644
--- a/drivers/hwalloc/bman_driver.c
+++ b/drivers/hwalloc/bman_driver.c
@@ -275,6 +275,36 @@ bad_cpu_ph:
 	return 0;
 }
 
+#ifdef CONFIG_KEXEC_POWERPC_SMP_BOOTABLE
+static void bman_drain_bpool(void)
+{
+	struct device_node *dn;
+
+	for_each_compatible_node(dn, NULL, "fsl,bpool") {
+		u32 *bpid;
+		int ret;
+		struct bman_pool *p;
+		struct bman_pool_params tmp;
+		struct bm_buffer buf;
+
+		bpid = (u32 *)of_get_property(dn, "fsl,bpid", &ret);
+		if (!bpid || (ret != 4))
+			continue;
+
+		memset(&tmp, 0, sizeof(tmp));
+		tmp.bpid = *bpid;
+
+		p = bman_new_pool(&tmp);
+
+		do {
+			ret = bman_acquire(p, &buf, 1, 0);
+		} while (ret > 0);
+
+		bman_free_pool(p);
+	}
+}
+#endif
+
 static int __init fsl_bpool_init(struct device_node *node)
 {
 	int ret;
@@ -302,6 +332,11 @@ static int __init fsl_bpool_init(struct device_node *node)
 			"fsl,bpool-cfg");
 		return -ENODEV;
 	}
+
+#ifdef CONFIG_KEXEC_POWERPC_SMP_BOOTABLE
+	bman_drain_bpool();
+#endif
+
 #ifdef CONFIG_FSL_BMAN_CONFIG
 	if (cfg)
 		ret = __bm_pool_add(*bpid, cfg, ret / 24);
-- 
1.6.5.2

