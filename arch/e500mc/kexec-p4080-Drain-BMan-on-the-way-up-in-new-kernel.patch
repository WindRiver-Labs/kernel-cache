From 29ffe922c7898e5dd94fdb9116a71c24edb990dc Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Thu, 30 Jun 2011 09:31:10 +0800
Subject: [PATCH 211/233] kexec/p4080: Drain BMan on the way up in new kernel

Find the pools and drain all buffers from previous kernel.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
[rebase it onto QorIQ-DPAA-SDK-V1-20110609-systembuilder.iso]
Integrated-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 drivers/staging/fsl_qbman/bman_driver.c |   35 +++++++++++++++++++++++++++++++
 1 files changed, 35 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_qbman/bman_driver.c b/drivers/staging/fsl_qbman/bman_driver.c
index 75e4a12..b382a2a 100644
--- a/drivers/staging/fsl_qbman/bman_driver.c
+++ b/drivers/staging/fsl_qbman/bman_driver.c
@@ -310,6 +310,36 @@ static void __init fsl_bman_portal_destroy(struct bm_portal_config *pcfg)
 	kfree(pcfg);
 }
 
+#ifdef CONFIG_KEXEC_POWERPC_SMP_BOOTABLE
+static void bman_drain_bpool(void)
+{
+	struct device_node *dn;
+
+	for_each_compatible_node(dn, NULL, "fsl,bpool") {
+		u32 *bpid;
+		int ret;
+		struct bman_pool *p;
+		struct bman_pool_params tmp;
+		struct bm_buffer buf;
+
+		bpid = (u32 *)of_get_property(dn, "fsl,bpid", &ret);
+		if (!bpid || (ret != 4))
+			continue;
+
+		memset(&tmp, 0, sizeof(tmp));
+		tmp.bpid = *bpid;
+
+		p = bman_new_pool(&tmp);
+
+		do {
+			ret = bman_acquire(p, &buf, 1, 0);
+		} while (ret > 0);
+
+		bman_free_pool(p);
+	}
+}
+#endif
+
 static int __init fsl_bpool_init(struct device_node *node)
 {
 	int ret;
@@ -344,6 +374,11 @@ static int __init fsl_bpool_init(struct device_node *node)
 			"fsl,bpool-cfg");
 		return -ENODEV;
 	}
+
+#ifdef CONFIG_KEXEC_POWERPC_SMP_BOOTABLE
+	bman_drain_bpool();
+#endif
+
 	if (cfg)
 		ret = __bm_pool_add(*bpid, cfg, ret / 24);
 	else
-- 
1.7.0.4

