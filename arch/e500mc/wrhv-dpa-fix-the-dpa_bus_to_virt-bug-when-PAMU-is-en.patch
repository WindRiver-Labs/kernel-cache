From 8255f934b26e4e19d8e0b4b16e5dd3bb09aea2b8 Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Wed, 29 Jun 2011 17:37:07 +0800
Subject: [PATCH 208/233] wrhv/dpa: fix the dpa_bus_to_virt bug when PAMU is enabled

When PAMU is disabled, the physical address is equal to dma
address in guest OS. But when PAMU is enabled, maybe the
physical address and dma address are different. And we have
to use the dma address of PAGE_OFFSET to get the correct
to use the dma address of PAGE_OFFSET to get the correct
virtual address.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
[context adjustment]
Integrated-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 drivers/net/dpa/dpaa_eth.c |    7 ++++---
 1 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/drivers/net/dpa/dpaa_eth.c b/drivers/net/dpa/dpaa_eth.c
index 1351848..1eeca7a 100644
--- a/drivers/net/dpa/dpaa_eth.c
+++ b/drivers/net/dpa/dpaa_eth.c
@@ -172,10 +172,10 @@ struct dpa_fq {
 	 FM_PORT_FRM_ERR_PRS_ILL_INSTRUCT | FM_PORT_FRM_ERR_PRS_HDR_ERR)
 
 #ifdef	CONFIG_PPC85xx_VT_MODE
-static u64 guest_phy_offset;
+static u64 guest_dma_offset;
 
 #define dpa_phys_to_virt(addr) 	\
-	__va(addr - guest_phy_offset)
+	__va(addr - guest_dma_offset)
 #else
 #define	dpa_phys_to_virt(addr)	\
 	phys_to_virt(addr)
@@ -2784,7 +2784,8 @@ static int __init __cold dpa_load(void)
 #endif
 
 #ifdef	CONFIG_PPC85xx_VT_MODE
-	vbi_guest_phys_to_phys((void *)virt_to_phys((void *)PAGE_OFFSET), &guest_phy_offset);
+	vbi_get_guest_dma_addr((void *)virt_to_phys((void *)PAGE_OFFSET),
+				&guest_dma_offset);
 #endif
 	_errno = of_register_platform_driver(&dpa_driver);
 	if (unlikely(_errno < 0)) {
-- 
1.7.0.4

