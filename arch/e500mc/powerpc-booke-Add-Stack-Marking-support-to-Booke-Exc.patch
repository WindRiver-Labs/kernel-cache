From fa2f85d88247b9dc12117c9a43b459b54f9c97ac Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Wed, 4 Aug 2010 14:40:58 +0800
Subject: [PATCH 241/252] powerpc/booke: Add Stack Marking support to Booke Exception Prolog

It is from FSL vendor SDK 2.x.

This patch adds a marker to the exception stack frame to aid in debugging.
it's already inserted on other platforms and xmon recognizes it and
identifies exception frames when showing stack traces.

Signed-off-by: Torez Smith  <lnxtorez@linux.vnet.ibm.com>
Signed-off-by: Dave Kleikamp <shaggy@linux.vnet.ibm.com>
Integrated-by: Andrew Liu <shengping.liu@windriver.com>
---
 arch/powerpc/kernel/head_booke.h |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/head_booke.h b/arch/powerpc/kernel/head_booke.h
index 13603d6..6c94650 100644
--- a/arch/powerpc/kernel/head_booke.h
+++ b/arch/powerpc/kernel/head_booke.h
@@ -1,6 +1,8 @@
 #ifndef __HEAD_BOOKE_H__
 #define __HEAD_BOOKE_H__
 
+#include <asm/ptrace.h>        /* for STACK_FRAME_REGS_MARKER */
+
 /*
  * Macros used for common Book-e exception handling
  */
@@ -48,6 +50,9 @@
 	stw	r10,0(r11);						     \
 	rlwinm	r9,r9,0,14,12;		/* clear MSR_WE (necessary?)	   */\
 	stw	r0,GPR0(r11);						     \
+	lis     r10, STACK_FRAME_REGS_MARKER@ha;/* exception frame marker */ \
+	addi    r10, r10, STACK_FRAME_REGS_MARKER@l;                         \
+	stw     r10, 8(r11);                                                 \
 	SAVE_4GPRS(3, r11);						     \
 	SAVE_2GPRS(7, r11)
 
-- 
1.6.5.2

