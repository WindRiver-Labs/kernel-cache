From 744d8923ac77b2f363d1a8b9c58ad71f4ef798b0 Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Tue, 14 Dec 2010 15:50:48 +0800
Subject: [PATCH 03/28] FPU: Enable hard float point support on p4080 Rev2 board

Patch taken from FSL vendor SDK 2.2.

Remove hard coded changes to avoid the broken FPU in Rev1
p4080 silicon and instead opt for a dynamic check to allow
Rev2 p4080 silicon to properly use the FPU.

Integrated-by: Andrew Liu <shengping.liu@windriver.com>
---
 arch/powerpc/kernel/head_fsl_booke.S |   14 ++++++++++----
 1 files changed, 10 insertions(+), 4 deletions(-)

diff --git a/arch/powerpc/kernel/head_fsl_booke.S b/arch/powerpc/kernel/head_fsl_booke.S
index dc14a2f..6b2f683 100644
--- a/arch/powerpc/kernel/head_fsl_booke.S
+++ b/arch/powerpc/kernel/head_fsl_booke.S
@@ -321,11 +321,7 @@ skpinv:	addi	r6,r6,1				/* Increment */
 	SET_IVOR(4,  ExternalInput);
 	SET_IVOR(5,  Alignment);
 	SET_IVOR(6,  Program);
-#ifdef CONFIG_PPC_FPU
-	SET_IVOR(7,  FloatingPointUnavailableErrata);
-#else
 	SET_IVOR(7,  FloatingPointUnavailable);
-#endif
 	SET_IVOR(8,  SystemCall);
 	SET_IVOR(9,  AuxillaryProcessorUnavailable);
 	SET_IVOR(10, Decrementer);
@@ -529,6 +525,7 @@ interrupt_base:
 
 	/* Floating Point Unavailable Interrupt */
 #ifdef CONFIG_PPC_FPU
+	FP_UNAVAILABLE_EXCEPTION
 	EXCEPTION(0x0800, FloatingPointUnavailableErrata, program_check_exception, EXC_XFER_EE)
 #else
 #ifdef CONFIG_E200
@@ -971,6 +968,15 @@ _GLOBAL(__setup_e500_ivors)
 
 /* Adjust or setup IVORs for e500mc */
 _GLOBAL(__setup_e500mc_ivors)
+#ifdef CONFIG_PPC_FPU
+	mfspr	r3,SPRN_PVR
+	xoris	r0,r3,0x8023
+	cmpwi	r0,0x0010
+	bne	1f		/* skip if !rev1.0 */
+	li	r3,FloatingPointUnavailableErrata@l
+	mtspr	SPRN_IVOR7,r3
+1:
+#endif
 	li	r3,DebugDebug@l
 	mtspr	SPRN_IVOR15,r3
 	li	r3,PerformanceMonitor@l
-- 
1.6.5.2

