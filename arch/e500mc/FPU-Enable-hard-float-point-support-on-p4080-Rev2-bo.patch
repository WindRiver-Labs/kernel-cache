From 04282a05a3a5d4d5b3715f4eab2a657051b8c8b0 Mon Sep 17 00:00:00 2001
From: Timur Tabi <timur@freescale.com>
Date: Mon, 2 Nov 2009 16:26:30 -0600
Subject: [PATCH 158/233] FPU: Enable hard float point support on p4080 Rev2 board

Patch taken from FSL vendor SDK 2.2.

dynamic check silicon version to allow Rev2 p4080 silicon to
use the FPU properly.

Integrated-by: Andrew Liu <shengping.liu@windriver.com>
---
 arch/powerpc/kernel/head_fsl_booke.S |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/head_fsl_booke.S b/arch/powerpc/kernel/head_fsl_booke.S
index 1961190..16536c9 100644
--- a/arch/powerpc/kernel/head_fsl_booke.S
+++ b/arch/powerpc/kernel/head_fsl_booke.S
@@ -536,6 +536,7 @@ interrupt_base:
 	/* Floating Point Unavailable Interrupt */
 #ifdef CONFIG_PPC_FPU
 	FP_UNAVAILABLE_EXCEPTION
+	EXCEPTION(0x0800, FloatingPointUnavailableErrata, program_check_exception, EXC_XFER_EE)
 #else
 #ifdef CONFIG_E200
 	/* E200 treats 'normal' floating point instructions as FP Unavail exception */
@@ -1061,6 +1062,15 @@ _GLOBAL(__setup_e500_ivors)
 
 /* Adjust or setup IVORs for e500mc */
 _GLOBAL(__setup_e500mc_ivors)
+#ifdef CONFIG_PPC_FPU
+	mfspr	r3,SPRN_PVR
+	xoris	r0,r3,0x8023
+	cmpwi	r0,0x0010
+	bne	1f		/* skip if !rev1.0 */
+	li	r3,FloatingPointUnavailableErrata@l
+	mtspr	SPRN_IVOR7,r3
+1:
+#endif
 	li	r3,DebugDebug@l
 	mtspr	SPRN_IVOR15,r3
 	li	r3,PerformanceMonitor@l
-- 
1.7.0.4

