From a1c1ed5a1274ef20b552d011dd1cdf45ef0ac06e Mon Sep 17 00:00:00 2001
From: Emil Medve <Emilian.Medve@freescale.com>
Date: Thu, 22 Oct 2009 16:26:18 -0500
Subject: [PATCH 057/252] P4080/DPA: phylib returns (sometimes) pointer-encoded-error-codes

This fixes a crash when phy_{connect,attach}() fails

Signed-off-by: Emil Medve <Emilian.Medve@Freescale.com>
[Applied FSL SDK 2.0.3 patch
"kernel-2.6.30-P4080-DPA-phylib-returns-sometimes-pointer-e.patch"]
Integrated-by: Yuri Nedel <Yuri.Nedel@windriver.com>
---
 drivers/net/dpa/mac-api.c |   10 +++++-----
 1 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/drivers/net/dpa/mac-api.c b/drivers/net/dpa/mac-api.c
index cd96378..9b77bb6 100644
--- a/drivers/net/dpa/mac-api.c
+++ b/drivers/net/dpa/mac-api.c
@@ -299,14 +299,14 @@ static int dtsec_init_phy(struct net_device *net_dev)
 	else
 		phy_dev = of_phy_connect(net_dev, mac_dev->phy_node,
 				&adjust_link, 0, mac_dev->phy_if);
-	if (!phy_dev) {
+	if (unlikely(phy_dev == NULL) || IS_ERR(phy_dev)) {
 		cpu_netdev_err(net_dev,
-				"%s:%hu:%s(): Could not attach to PHY %s\n",
+				"%s:%hu:%s(): Could not connect to PHY %s\n",
 				__file__, __LINE__, __func__,
 				mac_dev->phy_node ?
 					mac_dev->phy_node->full_name :
 					mac_dev->fixed_bus_id);
-		return -ENODEV;
+		return phy_dev == NULL ? -ENODEV : PTR_ERR(phy_dev);
 	}
 
 	/* Remove any features not supported by the controller */
@@ -330,14 +330,14 @@ static int xgmac_init_phy(struct net_device *net_dev)
 	else
 		phy_dev = of_phy_attach(net_dev, mac_dev->phy_node, 0,
 				mac_dev->phy_if);
-	if (!phy_dev) {
+	if (unlikely(phy_dev == NULL) || IS_ERR(phy_dev)) {
 		cpu_netdev_err(net_dev,
 				"%s:%hu:%s(): Could not attach to PHY %s\n",
 				__file__, __LINE__, __func__,
 				mac_dev->phy_node ?
 					mac_dev->phy_node->full_name :
 					mac_dev->fixed_bus_id);
-		return -ENODEV;
+		return phy_dev == NULL ? -ENODEV : PTR_ERR(phy_dev);
 	}
 
 	phy_dev->supported &= priv->mac_dev->if_support;
-- 
1.6.5.2

