From 64275f0a466301c53178e6de8e758bff12deccd8 Mon Sep 17 00:00:00 2001
From: Andy Fleming <afleming@freescale.com>
Date: Mon, 16 May 2011 18:56:54 -0500
Subject: [PATCH 127/233] dpaa_eth: Handle 10G MDIO read errors

Extracted from vendor drop QorIQ-DPAA-SDK-V1-20110609-systembuilder.iso
0157-dpaa_eth-Handle-10G-MDIO-read-errors.patch

When the 10G MDIO bus encounters an unresponsive PHY or device, it
sets a flag indicating a read error, and it leaves the data field
as it was. This means that reads of non-existent PHYs/devices returns
the previously read value from the last read device. Also, if we are
asked to read in a Clause-22 fashion, we were attempting to read from
device -1, which might be interpretted as device 31.  For both cases,
we now return 0xffff, which is often interpretted by upper layers of
code as a failed read.

Signed-off-by: Andy Fleming <afleming@freescale.com>
---
 drivers/net/dpa/xgmac_mdio.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/drivers/net/dpa/xgmac_mdio.c b/drivers/net/dpa/xgmac_mdio.c
index b35f2f4..947e523 100644
--- a/drivers/net/dpa/xgmac_mdio.c
+++ b/drivers/net/dpa/xgmac_mdio.c
@@ -53,6 +53,7 @@
 #include <linux/crc32.h>
 #include <linux/mii.h>
 #include <linux/phy.h>
+#include <linux/mdio.h>
 #include <linux/of.h>
 #include <linux/of_platform.h>
 #include <linux/of_mdio.h>
@@ -72,6 +73,9 @@ int xgmac_mdio_write(struct mii_bus *bus, int port_addr,
 	struct tgec_mdio_controller __iomem *regs = bus->priv;
 	u32 mdio_ctl, mdio_stat;
 
+	if (dev_addr == MDIO_DEVAD_NONE)
+		return 0xffff;
+
 	/* Setup the MII Mgmt clock speed */
 	mdio_stat = MDIO_STAT_CLKDIV(100);
 	/* workaround for erratum XAUI3, only needs for Rev1 silicon */
@@ -144,6 +148,10 @@ int xgmac_mdio_read(struct mii_bus *bus, int port_addr, int dev_addr,
 	while ((in_be32(&regs->mdio_data)) & MDIO_DATA_BSY)
 		cpu_relax();
 
+	/* Return all Fs if nothing was there */
+	if (in_be32(&regs->mdio_stat) & MDIO_STAT_RD_ER)
+		return 0xffff;
+
 	return in_be32(&regs->mdio_data) & 0xffff;
 }
 
-- 
1.7.0.4

