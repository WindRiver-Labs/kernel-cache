From 2b816d390e834d74f6ebbf12c4d308a89a646019 Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Fri, 29 Apr 2011 15:28:05 +0800
Subject: [PATCH] ftrace: turn off preemptoff measurements while idle.

This fixes the bug where some measurements are off the charts,
since the time in idle is measured as a region with preemption
disabled which it obviously isn't.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/powerpc/kernel/idle.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/idle.c b/arch/powerpc/kernel/idle.c
index b970bb1..8f269b6 100644
--- a/arch/powerpc/kernel/idle.c
+++ b/arch/powerpc/kernel/idle.c
@@ -113,9 +113,13 @@ void cpu_idle_simple(void)
 	while (1) {
 		tick_nohz_stop_sched_tick(1);
 
+		stop_critical_timings();
+
 		while (!need_resched() && !cpu_should_die())
 			ppc_md.power_save();
 
+		start_critical_timings();
+
 		tick_nohz_restart_sched_tick();
 
 		if (cpu_should_die())
-- 
1.7.0.4

