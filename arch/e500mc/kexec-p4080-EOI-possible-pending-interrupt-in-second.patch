From e3ae335aa584b9e140864b994ac8f8a4421a7a44 Mon Sep 17 00:00:00 2001
From: Benjamin Walsh <benjamin.walsh@windriver.com>
Date: Thu, 16 Sep 2010 13:24:19 -0700
Subject: [PATCH 179/233] kexec/p4080: EOI possible pending interrupt in second kernel

An interrupt can be left pending from the first kernel, EOI it
to unblock interrupt processing.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
Integrated-by: Benjamin Walsh <benjamin.walsh@windriver.com>
---
 arch/powerpc/sysdev/mpic.c |   10 ++++++++--
 1 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/sysdev/mpic.c b/arch/powerpc/sysdev/mpic.c
index 49d324c..33fb3f0 100644
--- a/arch/powerpc/sysdev/mpic.c
+++ b/arch/powerpc/sysdev/mpic.c
@@ -1604,7 +1604,7 @@ unsigned int mpic_get_coreint_irq(void)
 {
 #ifdef CONFIG_BOOKE
 	struct mpic *mpic = mpic_primary;
-	u32 src;
+	u32 src, ret;
 
 	BUG_ON(mpic == NULL);
 
@@ -1622,7 +1622,13 @@ unsigned int mpic_get_coreint_irq(void)
 		return NO_IRQ;
 	}
 
-	return irq_linear_revmap(mpic->irqhost, src);
+	ret = irq_linear_revmap(mpic->irqhost, src);
+#ifdef CONFIG_KEXEC_POWERPC_SMP_BOOTABLE
+	if (ret == NO_IRQ)
+		mpic_eoi(mpic);
+#endif
+
+	return ret;
 #else
 	return NO_IRQ;
 #endif
-- 
1.7.0.4

