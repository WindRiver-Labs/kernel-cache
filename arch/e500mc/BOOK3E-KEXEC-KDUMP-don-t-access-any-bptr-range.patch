From 1540ec14ab0eff0caba1339cc65d0876ac44f406 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Mon, 17 Oct 2011 13:05:57 +0800
Subject: [PATCH 1/6] BOOK3E/KEXEC KDUMP: don't access any bptr range

Since BOOK3E KEXEC/KDUMP will always go the original smp_85xx_kick_cpu()
path, we shouldn't touch the original address used to invoke AP via the
firmware. Otherwise it corrupts normal memory usage.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/platforms/85xx/smp.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/smp.c b/arch/powerpc/platforms/85xx/smp.c
index a38a433..1239295 100644
--- a/arch/powerpc/platforms/85xx/smp.c
+++ b/arch/powerpc/platforms/85xx/smp.c
@@ -227,7 +227,9 @@ smp_85xx_kick_cpu(int nr)
 
 	local_irq_save(flags);
 
+#ifndef CONFIG_CRASH_DUMP
 	out_be32(bptr_vaddr + BOOT_ENTRY_PIR, nr);
+#endif
 #ifdef CONFIG_PPC32
 	out_be32(bptr_vaddr + BOOT_ENTRY_ADDR_LOWER, __pa(__early_start));
 
@@ -241,6 +243,7 @@ smp_85xx_kick_cpu(int nr)
 #else
 	smp_generic_kick_cpu(nr);
 
+#ifndef CONFIG_CRASH_DUMP
 	out_be64((u64 *)(bptr_vaddr + BOOT_ENTRY_ADDR_UPPER),
 		__pa((u64)*((unsigned long long *) generic_secondary_smp_init)));
 
@@ -248,6 +251,7 @@ smp_85xx_kick_cpu(int nr)
 		flush_dcache_range((ulong)bptr_vaddr,
 				(ulong)(bptr_vaddr + SIZE_BOOT_ENTRY));
 #endif
+#endif
 #endif /*#if defined CONFIG_E500 && defined CONFIG_SUSPEND */
 
 	local_irq_restore(flags);
-- 
1.7.0.4

