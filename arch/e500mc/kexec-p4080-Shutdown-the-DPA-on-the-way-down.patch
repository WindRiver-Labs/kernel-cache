From 2b2afb295863307e88800fe2b4b3d3427e07bd97 Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Thu, 30 Jun 2011 09:16:39 +0800
Subject: [PATCH 209/233] kexec/p4080: Shutdown the DPA on the way down.

Since we don't go through a HW reset in the kexec case,
shut down the DPA to get it back in a known state.

Signed-off-by: Benjamin Walsh <benjamin.walsh@windriver.com>
[context adjustment]
Integrated-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 .../src/wrappers/Peripherals/FM/lnxwrp_fm.c        |    6 +++---
 drivers/net/dpa/dpaa_eth.c                         |    2 +-
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/net/dpa/NetCommSw/src/wrappers/Peripherals/FM/lnxwrp_fm.c b/drivers/net/dpa/NetCommSw/src/wrappers/Peripherals/FM/lnxwrp_fm.c
index 3b8ffd1..dc9f6fc 100644
--- a/drivers/net/dpa/NetCommSw/src/wrappers/Peripherals/FM/lnxwrp_fm.c
+++ b/drivers/net/dpa/NetCommSw/src/wrappers/Peripherals/FM/lnxwrp_fm.c
@@ -983,7 +983,7 @@ static void qm_err_cb(struct qman_portal       *portal,
                        const struct qm_mr_entry *msg)
 {
     /* In guest OS, we maybe get a ISR when retiring a FQ */
-#ifndef CONFIG_PPC85xx_VT_MODE
+#if !defined(CONFIG_PPC85xx_VT_MODE) && !defined(CONFIG_KEXEC)
     BUG();
 #endif
 }
@@ -2673,7 +2673,7 @@ static int __devexit fm_remove(struct of_device *of_dev)
     return 0;
 }
 
-#ifdef CONFIG_PPC85xx_VT_MODE
+#if defined(CONFIG_PPC85xx_VT_MODE) || defined(CONFIG_KEXEC)
 static int fm_shutdown(struct of_device *of_dev)
 {
     t_LnxWrpFmDev   *p_LnxWrpFmDev;
@@ -2809,7 +2809,7 @@ static int __devexit fm_port_remove(struct of_device *of_dev)
     return 0;
 }
 
-#ifdef CONFIG_PPC85xx_VT_MODE
+#if defined(CONFIG_PPC85xx_VT_MODE) || defined(CONFIG_KEXEC)
 static int DestroyFmFQ(struct qman_fq *fq)
 {
 	int r = 0;
diff --git a/drivers/net/dpa/dpaa_eth.c b/drivers/net/dpa/dpaa_eth.c
index 1eeca7a..e44ab1e 100644
--- a/drivers/net/dpa/dpaa_eth.c
+++ b/drivers/net/dpa/dpaa_eth.c
@@ -2758,7 +2758,7 @@ static struct of_platform_driver dpa_driver = {
 	.match_table	= dpa_match,
 	.owner		= THIS_MODULE,
 	.probe		= dpaa_eth_probe,
-#ifdef CONFIG_PPC85xx_VT_MODE
+#if defined(CONFIG_PPC85xx_VT_MODE) || defined(CONFIG_KEXEC)
 	.shutdown	= dpa_remove,
 #endif
 	.remove		= __devexit_p(dpa_remove)
-- 
1.7.0.4

