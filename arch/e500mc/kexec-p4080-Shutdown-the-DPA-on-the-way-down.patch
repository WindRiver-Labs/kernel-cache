From d99216e2040dfc85c41b718b87a12bfccffbb05f Mon Sep 17 00:00:00 2001
From: Benjamin Walsh <benjamin.walsh@windriver.com>
Date: Thu, 16 Sep 2010 13:24:10 -0700
Subject: [PATCH 146/252] kexec/p4080: Shutdown the DPA on the way down.

Since we don't go through a HW reset in the kexec case,
shut down the DPA to get it back in a known state.

Signed-off-by: Benjamin Walsh <benjamin.walsh@windriver.com>
---
 .../kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c |    6 +++---
 drivers/net/dpa/dpa.c                              |    2 +-
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c b/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c
index ecac626..d4e0a56 100644
--- a/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c
+++ b/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c
@@ -488,7 +488,7 @@ static void qm_err_cb(struct qman_portal       *portal,
                        const struct qm_mr_entry *msg)
 {
     /* In guest OS, we maybe get a ISR when retiring a FQ */
-#ifndef CONFIG_PPC85xx_VT_MODE
+#if !defined(CONFIG_PPC85xx_VT_MODE) && !defined(CONFIG_KEXEC)
     BUG();
 #endif
 }
@@ -1841,7 +1841,7 @@ static int __devexit fm_remove(struct of_device *of_dev)
     return 0;
 }
 
-#ifdef CONFIG_PPC85xx_VT_MODE
+#if defined(CONFIG_PPC85xx_VT_MODE) || defined(CONFIG_KEXEC)
 static int fm_shutdown(struct of_device *of_dev)
 {
     t_LnxWrpFmDev   *p_LnxWrpFmDev;
@@ -1978,7 +1978,7 @@ static int __devexit fm_port_remove(struct of_device *of_dev)
     return 0;
 }
 
-#ifdef CONFIG_PPC85xx_VT_MODE
+#if defined(CONFIG_PPC85xx_VT_MODE) || defined(CONFIG_KEXEC)
 static int DestroyFmFQ(struct qman_fq *fq)
 {
 	int r = 0;
diff --git a/drivers/net/dpa/dpa.c b/drivers/net/dpa/dpa.c
index 23d0c00..77909e3 100644
--- a/drivers/net/dpa/dpa.c
+++ b/drivers/net/dpa/dpa.c
@@ -2400,7 +2400,7 @@ static struct of_platform_driver dpa_driver = {
 	.match_table	= dpa_match,
 	.owner		= THIS_MODULE,
 	.probe		= _dpa_probe,
-#ifdef CONFIG_PPC85xx_VT_MODE
+#if defined(CONFIG_PPC85xx_VT_MODE) || defined(CONFIG_KEXEC)
 	.shutdown	= dpa_remove,
 #endif
 	.remove		= __devexit_p(dpa_remove)
-- 
1.6.5.2

