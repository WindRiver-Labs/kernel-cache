From 3f6be568303e8da3d59b7bacf13c1ea03c67c1ee Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Wed, 29 Jan 2014 13:19:34 +0800
Subject: [PATCH] dpa: make dpa_get_stats() concurrent access safe

Introduce a spinlock to serialize the update of
net_dev->stats. And don't reset net_dev->stats
every time, instead calculate the stats locally
and assign it to net_dev->stats when the data is
done. Thus the update of net_dev->stats will be
monotinic and the user will be less confused about
the data.

Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 drivers/net/dpa/dpaa_eth.c |   17 +++++++++++------
 drivers/net/dpa/dpaa_eth.h |    3 +++
 2 files changed, 14 insertions(+), 6 deletions(-)

diff --git a/drivers/net/dpa/dpaa_eth.c b/drivers/net/dpa/dpaa_eth.c
index bd8e2b3..befce89 100644
--- a/drivers/net/dpa/dpaa_eth.c
+++ b/drivers/net/dpa/dpaa_eth.c
@@ -653,16 +653,20 @@ dpa_get_stats(struct net_device *net_dev)
 
 	netstats = (unsigned long *)&net_dev->stats;
 
-	memset(netstats, 0, sizeof(net_dev->stats));
+	spin_lock(&priv->lock);
+	for (i = 0; i < numstats; i++) {
+		unsigned long num = 0;
+		for_each_online_cpu(j) {
+			percpu_priv = per_cpu_ptr(priv->percpu_priv, j);
 
-	for_each_online_cpu(i) {
-		percpu_priv = per_cpu_ptr(priv->percpu_priv, i);
+			cpustats = (unsigned long *)&percpu_priv->stats;
 
-		cpustats = (unsigned long *)&percpu_priv->stats;
+			num += cpustats[i];
+		}
 
-		for (j = 0; j < numstats; j++)
-			netstats[j] += cpustats[j];
+		netstats[i] = num;
 	}
+	spin_unlock(&priv->lock);
 
 	return &net_dev->stats;
 }
@@ -2685,6 +2689,7 @@ dpaa_eth_probe(struct of_device *_of_dev, const struct of_device_id *match)
 		err = -ENOMEM;
 		goto alloc_percpu_failed;
 	}
+	spin_lock_init(&priv->lock);
 
 	if (priv->shared)
 		err = dpa_shared_netdev_init(dpa_node, net_dev);
diff --git a/drivers/net/dpa/dpaa_eth.h b/drivers/net/dpa/dpaa_eth.h
index bc8fc89..710ad68 100644
--- a/drivers/net/dpa/dpaa_eth.h
+++ b/drivers/net/dpa/dpaa_eth.h
@@ -105,6 +105,9 @@ struct dpa_priv_s {
 
 	uint32_t		 msg_enable;	/* net_device message level */
 	struct ptp_tsu		 *tsu;
+
+	struct spinlock		lock;
+
 };
 
 extern const struct ethtool_ops dpa_ethtool_ops;
-- 
1.7.0

