From 8c8e00bb1000682dbdd9915ad322c94ffa35d1a6 Mon Sep 17 00:00:00 2001
From: Kumar Gala <galak@kernel.crashing.org>
Date: Fri, 5 Mar 2010 15:20:15 -0600
Subject: [PATCH 114/233] phy: Update mdio code to support fman & vitesse phy

Extracted from vendor drop QorIQ-DPAA-SDK-V1-20110609-systembuilder.iso
0144-phy-Update-mdio-code-to-support-fman-vitesse-phy.patch

Signed-off-by: Kumar Gala <kumar.gala@freescale.com>
---
 drivers/net/fsl_pq_mdio.c |   14 ++++++++++++++
 drivers/net/phy/vitesse.c |   25 ++++++++++++++++++++++++-
 2 files changed, 38 insertions(+), 1 deletions(-)

diff --git a/drivers/net/fsl_pq_mdio.c b/drivers/net/fsl_pq_mdio.c
index e3f1782..50c5f00 100644
--- a/drivers/net/fsl_pq_mdio.c
+++ b/drivers/net/fsl_pq_mdio.c
@@ -374,6 +374,13 @@ static int fsl_pq_mdio_probe(struct of_device *ofdev,
 		err = -ENODEV;
 		goto err_free_irqs;
 #endif
+	} else if (of_device_is_compatible(np, "fsl,fman-mdio")) {
+#ifdef CONFIG_FSL_FMAN
+		tbiaddr = 5;
+#else
+		err = -ENODEV;
+		goto err_free_irqs;
+#endif
 	} else {
 		err = -ENODEV;
 		goto err_free_irqs;
@@ -392,7 +399,9 @@ static int fsl_pq_mdio_probe(struct of_device *ofdev,
 	}
 
 	if (tbiaddr == -1) {
+#ifndef CONFIG_FSL_FMAN
 		out_be32(tbipa, 0);
+#endif
 
 		tbiaddr = fsl_pq_mdio_find_free(new_bus);
 	}
@@ -407,7 +416,9 @@ static int fsl_pq_mdio_probe(struct of_device *ofdev,
 		goto err_free_irqs;
 	}
 
+#ifndef CONFIG_FSL_FMAN
 	out_be32(tbipa, tbiaddr);
+#endif
 
 	err = of_mdiobus_register(new_bus, np);
 	if (err) {
@@ -472,6 +483,9 @@ static struct of_device_id fsl_pq_mdio_match[] = {
 	{
 		.compatible = "fsl,etsec2-mdio",
 	},
+	{
+		.compatible = "fsl,fman-mdio",
+	},
 	{},
 };
 MODULE_DEVICE_TABLE(of, fsl_pq_mdio_match);
diff --git a/drivers/net/phy/vitesse.c b/drivers/net/phy/vitesse.c
index 2d3bcfd..25d2d47 100644
--- a/drivers/net/phy/vitesse.c
+++ b/drivers/net/phy/vitesse.c
@@ -54,6 +54,7 @@
 #define MII_VSC8221_AUXCONSTAT_INIT	0x0004 /* need to set this bit? */
 #define MII_VSC8221_AUXCONSTAT_RESERVED	0x0004
 
+#define PHY_ID_VSC8234			0x000fc620
 #define PHY_ID_VSC8244			0x000fc6c0
 #define PHY_ID_VSC8221			0x000fc550
 
@@ -119,7 +120,8 @@ static int vsc82xx_config_intr(struct phy_device *phydev)
 
 	if (phydev->interrupts == PHY_INTERRUPT_ENABLED)
 		err = phy_write(phydev, MII_VSC8244_IMASK,
-			phydev->drv->phy_id == PHY_ID_VSC8244 ?
+			((phydev->drv->phy_id == PHY_ID_VSC8234) ||
+			 (phydev->drv->phy_id == PHY_ID_VSC8244)) ?
 				MII_VSC8244_IMASK_MASK :
 				MII_VSC8221_IMASK_MASK);
 	else {
@@ -153,6 +155,21 @@ static struct phy_driver vsc8244_driver = {
 	.driver 	= { .owner = THIS_MODULE,},
 };
 
+/* Vitesse 823x */
+static struct phy_driver vsc8234_driver = {
+	.phy_id		= PHY_ID_VSC8234,
+	.name		= "Vitesse VSC8234",
+	.phy_id_mask	= 0x000ffff0,
+	.features	= PHY_GBIT_FEATURES,
+	.flags		= PHY_HAS_INTERRUPT,
+	.config_init	= &vsc824x_config_init,
+	.config_aneg	= &genphy_config_aneg,
+	.read_status	= &genphy_read_status,
+	.ack_interrupt	= &vsc824x_ack_interrupt,
+	.config_intr	= &vsc82xx_config_intr,
+	.driver 	= { .owner = THIS_MODULE,},
+};
+
 static int vsc8221_config_init(struct phy_device *phydev)
 {
 	int err;
@@ -190,6 +207,12 @@ static int __init vsc82xx_init(void)
 	err = phy_driver_register(&vsc8221_driver);
 	if (err < 0)
 		phy_driver_unregister(&vsc8244_driver);
+	err = phy_driver_register(&vsc8234_driver);
+	if (err < 0) {
+	 	phy_driver_unregister(&vsc8244_driver);
+	 	phy_driver_unregister(&vsc8221_driver);
+	}
+
 	return err;
 }
 
-- 
1.7.0.4

