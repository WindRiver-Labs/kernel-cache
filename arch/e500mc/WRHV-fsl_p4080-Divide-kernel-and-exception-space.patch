From 00e1afc7980ef4e9c7aec69fe31404825d19f50f Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Wed, 12 May 2010 16:39:48 +0800
Subject: [PATCH 186/233] WRHV/fsl_p4080: Divide kernel and exception space

For the hypervisor implementation the Linux kernel should run the space with
AS=1, exception handler should be as AS=0. So re-define MSR_KERNEL macro, and
make sure it's correct while enter/exit the exception handler.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
[context adjustment]
Integrated-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/powerpc/include/asm/reg_booke.h |    8 ++++++++
 arch/powerpc/kernel/entry_32.S       |   12 ++++++++++++
 2 files changed, 20 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/reg_booke.h b/arch/powerpc/include/asm/reg_booke.h
index a37254f..8decf9c 100644
--- a/arch/powerpc/include/asm/reg_booke.h
+++ b/arch/powerpc/include/asm/reg_booke.h
@@ -35,7 +35,15 @@
 #define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_IR|MSR_DR|MSR_CE)
 #define MSR_USER	(MSR_KERNEL|MSR_PR|MSR_EE)
 #else
+#if defined(CONFIG_PPC85xx_VT_MODE)
+#if defined(CONFIG_WR_OCD_DEBUG)
+#define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_CE|MSR_DE|MSR_IR|MSR_DR)
+#else
+#define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_CE|MSR_IR|MSR_DR)
+#endif
+#else
 #define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_CE)
+#endif
 #define MSR_USER	(MSR_KERNEL|MSR_PR|MSR_EE)
 #endif
 
diff --git a/arch/powerpc/kernel/entry_32.S b/arch/powerpc/kernel/entry_32.S
index 62274e8..14cc6a1 100644
--- a/arch/powerpc/kernel/entry_32.S
+++ b/arch/powerpc/kernel/entry_32.S
@@ -272,6 +272,10 @@ reenable_mmu:				/* re-enable mmu so we can */
 	bctr				/* jump to handler */
 #else /* CONFIG_TRACE_IRQFLAGS */
 	mtspr	SPRN_SRR0,r11
+#ifdef CONFIG_PPC85xx_VT_MODE
+	/* Guest Exception should be AS = 0 */
+	rlwinm	r10,r10,0,~(MSR_IR|MSR_DR)
+#endif
 	mtspr	SPRN_SRR1,r10
 	mtlr	r9
 	SYNC
@@ -995,7 +999,15 @@ exc_exit_restart:
 	lwz	r12,_NIP(r1)
 	FIX_SRR1(r9,r10)
 	mtspr	SPRN_SRR0,r12
+#ifdef	CONFIG_PPC85xx_VT_MODE
+	mr	r12,r9
+	ori	r9,r9,(MSR_IR|MSR_DR)
+#endif
 	mtspr	SPRN_SRR1,r9
+#ifdef	CONFIG_PPC85xx_VT_MODE
+	mr	r9,r12
+	lwz	r12,_NIP(r1)
+#endif
 	REST_4GPRS(9, r1)
 	lwz	r1,GPR1(r1)
 	.globl exc_exit_restart_end
-- 
1.7.4.1

