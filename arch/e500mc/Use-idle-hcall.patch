From c3e7a46d9fae8e9f160ae0cb27355130e410095a Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Wed, 4 Aug 2010 15:02:22 +0800
Subject: [PATCH 242/252] Use idle hcall.

It is from FSL vendor SDK 2.x.

The previous wait idle loop is generalized into a "simple" loop
for power_save callbacks that don't poll and are entered with
interrupts enabled.

This patch is a subset of the kernel-2.6.30-Use-idle-hcall.patch
from FSL's SDK 2.1.

Signed-off-by: Scott Wood <scottwood@freescale.com>
Integrated-by: Andrew Liu <shengping.liu@windriver.com>
---
 arch/powerpc/include/asm/machdep.h |    3 ++-
 arch/powerpc/kernel/idle.c         |   11 ++++++++---
 2 files changed, 10 insertions(+), 4 deletions(-)

diff --git a/arch/powerpc/include/asm/machdep.h b/arch/powerpc/include/asm/machdep.h
index 0206347..c2d285a 100644
--- a/arch/powerpc/include/asm/machdep.h
+++ b/arch/powerpc/include/asm/machdep.h
@@ -293,7 +293,8 @@ extern void e500_idle(void);
 extern void power4_idle(void);
 extern void power4_cpu_offline_powersave(void);
 extern void ppc6xx_idle(void);
-extern void wait_idle(void);
+extern void cpu_idle_simple(void);
+extern void ppc_wait(void);
 
 /*
  * ppc_md contains a copy of the machine description structure for the
diff --git a/arch/powerpc/kernel/idle.c b/arch/powerpc/kernel/idle.c
index 2ef29f6..b970bb1 100644
--- a/arch/powerpc/kernel/idle.c
+++ b/arch/powerpc/kernel/idle.c
@@ -13,7 +13,7 @@
  *
  * 32-bit and 64-bit versions merged by Paul Mackerras <paulus@samba.org>
  *
- * Portions Copyright 2009 Freescale Semiconductor, Inc.
+ * Portions Copyright 2009-2010 Freescale Semiconductor, Inc.
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
@@ -108,13 +108,13 @@ void cpu_idle(void)
 	}
 }
 
-void wait_idle(void)
+void cpu_idle_simple(void)
 {
 	while (1) {
 		tick_nohz_stop_sched_tick(1);
 
 		while (!need_resched() && !cpu_should_die())
-			asm volatile(PPC_WAIT(0));
+			ppc_md.power_save();
 
 		tick_nohz_restart_sched_tick();
 
@@ -127,6 +127,11 @@ void wait_idle(void)
 	}
 }
 
+void ppc_wait(void)
+{
+	asm volatile(PPC_WAIT(0));
+}
+
 int powersave_nap;
 
 #ifdef CONFIG_SYSCTL
-- 
1.6.5.2

