From e769f9a04efc4875ccfc276483d0a302c6ea4ed4 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Fri, 1 Apr 2011 17:07:32 +0800
Subject: [PATCH] PowerPC:fsl_elbc_nand:Fix memory corruption in Chip remove routine

The elbc_fcm_ctrl structure introduced in "P4080/eLBC: Make Freescale
elbc interrupt common to elbc devices" is shared by multi nand chip
instances. If the chip remove routine fsl_elbc_chip_remove() free this
structure without check, it would lead memory corruption.

Since the variable belong to NAND flash controller, the structure should
be deleted in driver's remove routine only. There is no need to delete the
variable in chip's remove routine.

Besides when reference the variable in driver's remove routine, driver should
check the pointer first, in case of NULL pointer.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/mtd/nand/fsl_elbc_nand.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/mtd/nand/fsl_elbc_nand.c b/drivers/mtd/nand/fsl_elbc_nand.c
index e31455c..5db558f 100644
--- a/drivers/mtd/nand/fsl_elbc_nand.c
+++ b/drivers/mtd/nand/fsl_elbc_nand.c
@@ -826,7 +826,6 @@ static int fsl_elbc_chip_remove(struct fsl_elbc_mtd *priv)
 
 	elbc_fcm_ctrl->chips[priv->bank] = NULL;
 	kfree(priv);
-	kfree(elbc_fcm_ctrl);
 	return 0;
 }
 
@@ -979,6 +978,10 @@ static int fsl_elbc_nand_remove(struct of_device *ofdev)
 {
 	int i;
 	struct fsl_elbc_fcm_ctrl *elbc_fcm_ctrl = fsl_lbc_ctrl_dev->nand;
+	
+	if (!elbc_fcm_ctrl)
+		return 0;
+	
 	for (i = 0; i < MAX_BANKS; i++)
 		if (elbc_fcm_ctrl->chips[i])
 			fsl_elbc_chip_remove(elbc_fcm_ctrl->chips[i]);
-- 
1.6.5.2

