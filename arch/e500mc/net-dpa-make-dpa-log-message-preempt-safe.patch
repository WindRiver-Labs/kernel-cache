From 8b0838629bed8885a52a8c4d56c26d5d03d4cb48 Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Wed, 29 Jun 2011 12:25:57 +0800
Subject: [PATCH 196/233] net/dpa: make dpa log message preempt safe

In dpa driver smp_processor_id/hard_smp_processor_id are
invoked with preempt enabled when printing log message.
So we will get a call trace as below. Replacing
smp_processor_id/hard_smp_processor_id with
raw_smp_processor_id/get_hard_smp_processor_id will fix
this issue.

BUG: using smp_processor_id() in preemptible [00000000] code: snmpd/1494
caller is dpa_get_settings+0xac/0x194
Call Trace:
[d57a7cf0] [c0007244] show_stack+0x44/0x160 (unreliable)
[d57a7d20] [c029b060] debug_smp_processor_id+0xe0/0xf0
[d57a7d40] [c0504260] dpa_get_settings+0xac/0x194
[d57a7d60] [c04555ec] dev_ethtool+0x1e4/0x146c
[d57a7dc0] [c0452208] dev_ioctl+0x50c/0x770
[d57a7e50] [c0438458] sock_ioctl+0x94/0x3b8
[d57a7e80] [c0103174] vfs_ioctl+0x3c/0xec
[d57a7ea0] [c0103408] do_vfs_ioctl+0x80/0x76c
[d57a7f10] [c0103b88] sys_ioctl+0x94/0x108
[d57a7f40] [c001072c] ret_from_syscall+0x0/0x4
cpu7/7: fsl_dpa: ethernet.26: eth4: dpa_ethtool.c:54:dpa_get_settings(): phy device not initialized

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
[rebase it onto QorIQ-DPAA-SDK-V1-20110609-systembuilder.iso]
Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 drivers/net/dpa/dpaa_eth-common.h |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/net/dpa/dpaa_eth-common.h b/drivers/net/dpa/dpaa_eth-common.h
index 49ea0d6..5e617b9 100644
--- a/drivers/net/dpa/dpaa_eth-common.h
+++ b/drivers/net/dpa/dpaa_eth-common.h
@@ -43,7 +43,7 @@
 #define __hot
 
 #define cpu_printk(level, format, arg...) \
-	pr_##level("cpu%d: " format, smp_processor_id(), ##arg)
+	pr_##level("cpu%d: " format, raw_smp_processor_id(), ##arg)
 
 #define cpu_pr_emerg(format, arg...)	\
 	cpu_printk(emerg, format, ##arg)
-- 
1.7.0.4

