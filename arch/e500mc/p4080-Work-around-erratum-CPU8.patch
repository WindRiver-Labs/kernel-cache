From 422f55971fe842d5b960e7c12e6589e1c3aa8254 Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Tue, 10 Nov 2009 23:52:04 +0000
Subject: [PATCH 208/252] p4080: Work around erratum CPU8.

Writing to PID requires either two isyncs, or one non-isync context
synchronizing instruction.

Signed-off-by: Scott Wood <scottwood@freescale.com>
[Applied FSL SDK 2.0.3 patch
"kernel-2.6.30-p4080-Work-around-erratum-CPU8.patch"]
Integrated-by: Yuri Nedel <Yuri.Nedel@windriver.com>
---
 arch/powerpc/kernel/head_fsl_booke.S |    3 +++
 arch/powerpc/platforms/85xx/Kconfig  |    4 ++++
 2 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/head_fsl_booke.S b/arch/powerpc/kernel/head_fsl_booke.S
index d15cdce..3342d53 100644
--- a/arch/powerpc/kernel/head_fsl_booke.S
+++ b/arch/powerpc/kernel/head_fsl_booke.S
@@ -1062,6 +1062,9 @@ _GLOBAL(set_context)
 #endif
 	mtspr	SPRN_PID,r3
 	isync			/* Force context change */
+#ifdef CONFIG_P4080_ERRATUM_CPU8
+	isync
+#endif
 	blr
 
 _GLOBAL(flush_dcache_L1)
diff --git a/arch/powerpc/platforms/85xx/Kconfig b/arch/powerpc/platforms/85xx/Kconfig
index ec50fd6..29735ea 100644
--- a/arch/powerpc/platforms/85xx/Kconfig
+++ b/arch/powerpc/platforms/85xx/Kconfig
@@ -87,6 +87,10 @@ config P4080_HV
 	help
 	  This option enables support for the P4080 Hypervisor Platform
 
+config P4080_ERRATUM_CPU8
+	bool "Work around P4080 rev 1 erratum CPU8"
+	default y if P4080_DS || P4080_HV
+
 config FSL_HYPERVISOR
 	bool
 	help
-- 
1.6.5.2

