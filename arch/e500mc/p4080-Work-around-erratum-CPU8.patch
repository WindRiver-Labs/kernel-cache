From af4c6b967d60008642ad9aca28ff65ea7c256ad0 Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Tue, 10 Nov 2009 23:52:04 +0000
Subject: [PATCH 159/233] p4080: Work around erratum CPU8.

Writing to PID requires either two isyncs, or one non-isync context
synchronizing instruction.

Signed-off-by: Scott Wood <scottwood@freescale.com>
[Applied FSL SDK 2.0.3 patch
"kernel-2.6.30-p4080-Work-around-erratum-CPU8.patch"]
Integrated-by: Yuri Nedel <Yuri.Nedel@windriver.com>
[rebase it onto QorIQ-DPAA-SDK-V1-20110609-systembuilder.iso]
Integrated-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/powerpc/kernel/head_fsl_booke.S |    3 +++
 arch/powerpc/platforms/85xx/Kconfig  |    4 ++++
 2 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/head_fsl_booke.S b/arch/powerpc/kernel/head_fsl_booke.S
index 16536c9..a144369 100644
--- a/arch/powerpc/kernel/head_fsl_booke.S
+++ b/arch/powerpc/kernel/head_fsl_booke.S
@@ -1166,6 +1166,9 @@ _GLOBAL(set_context)
 #endif
 	mtspr	SPRN_PID,r3
 	isync			/* Force context change */
+#ifdef CONFIG_P4080_ERRATUM_CPU8
+	isync
+#endif
 	blr
 
 _GLOBAL(flush_dcache_L1)
diff --git a/arch/powerpc/platforms/85xx/Kconfig b/arch/powerpc/platforms/85xx/Kconfig
index c8b8119..28ed4a3 100644
--- a/arch/powerpc/platforms/85xx/Kconfig
+++ b/arch/powerpc/platforms/85xx/Kconfig
@@ -153,6 +153,10 @@ config SBC8560
 	help
 	  This option enables support for the Wind River SBC8560 board
 
+config P4080_ERRATUM_CPU8
+	bool "Work around P4080 rev 1 erratum CPU8"
+	default y if P4080_DS || P4080_HV
+
 config P3041_DS
 	bool "Freescale P3041 DS"
 	select DEFAULT_UIMAGE
-- 
1.7.0.4

