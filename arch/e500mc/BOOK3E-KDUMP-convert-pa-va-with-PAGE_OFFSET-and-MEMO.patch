From 9a63d020112e91bc340579c425c2c7556cb4e791 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Tue, 18 Oct 2011 09:53:28 +0800
Subject: [PATCH 2/6] BOOK3E/KDUMP: convert pa/va with PAGE_OFFSET and MEMORY_START

On BOOK3E we should use PAGE_OFFSET and MEMORY_START to guarantee
the relocation offsets are properly computed for RELOCATABLE kernel.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/include/asm/page.h |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/page.h b/arch/powerpc/include/asm/page.h
index 7bcbdf8..67680d3 100644
--- a/arch/powerpc/include/asm/page.h
+++ b/arch/powerpc/include/asm/page.h
@@ -130,8 +130,16 @@ extern phys_addr_t kernstart_addr;
  * the other definitions for __va & __pa.
  */
 #ifdef CONFIG_BOOKE
+#if defined(CONFIG_CRASH_DUMP) && defined(CONFIG_PPC_BOOK3E)
+/* On BOOK3E we should use PAGE_OFFSET and MEMORY_START to guarantee
+ * the relocation offsets are properly computed for RELOCATABLE kernel.
+ */
+#define __va(x) ((void *)(unsigned long)((phys_addr_t)(x) + PAGE_OFFSET - MEMORY_START))
+#define __pa(x) ((unsigned long)(x) - PAGE_OFFSET + MEMORY_START)
+#else
 #define __va(x) ((void *)(unsigned long)((phys_addr_t)(x) - PHYSICAL_START + KERNELBASE))
 #define __pa(x) ((unsigned long)(x) + PHYSICAL_START - KERNELBASE)
+#endif
 #else
 #define __va(x) ((void *)(unsigned long)((phys_addr_t)(x) + PAGE_OFFSET - MEMORY_START))
 #define __pa(x) ((unsigned long)(x) - PAGE_OFFSET + MEMORY_START)
-- 
1.7.0.4

