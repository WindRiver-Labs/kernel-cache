From 6a17c0ea512c20d28fb6e4c0ecf7f6aa314dd351 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Wed, 20 Oct 2010 10:24:08 +0800
Subject: [PATCH 194/252] fman: introduce fman_init_early function

We can't reset B/QMAN in dump kernel. So we just free all
the B/Qman resources before booting the dump kernel. Since we
also need to shutdown FMAN before we free these resources,
introduce fman_init_early function for kexec to register
a crash shutdown hooks to do this.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 .../kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c |   36 ++++++++++++++++++++
 1 files changed, 36 insertions(+), 0 deletions(-)

diff --git a/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c b/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c
index 7020e00..3cca961 100644
--- a/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c
+++ b/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c
@@ -62,6 +62,7 @@
 #include <asm/errno.h>
 #include <asm/qe.h>        /* For struct qe_firmware */
 #include <sysdev/fsl_soc.h>
+#include <asm/kexec.h>
 
 /* NetCommSw Headers --------------- */
 #include "std_ext.h"
@@ -2371,3 +2372,38 @@ void fm_port_disable(struct fm_port *port)
     FM_PORT_Disable(p_LnxWrpFmPortDev->h_Dev);
 }
 EXPORT_SYMBOL(fm_port_disable);
+
+#ifdef CONFIG_KEXEC
+static int fm_crash_shutdown(struct device *dev, void *data)
+{
+	struct of_platform_driver *drv = data;
+	struct of_device *of_dev = to_of_device(dev);
+	t_LnxWrpFmDev   *p;
+
+	if (dev->driver != &drv->driver)
+		return 0;
+
+	p = dev_get_drvdata(&of_dev->dev);
+
+	if (!p->active)
+		return 0;
+
+	if (p->h_Dev)
+		FM_Free(p->h_Dev);
+
+	return 0;
+}
+
+static void fm_crash_shutdown_all(void)
+{
+	bus_for_each_dev(&of_platform_bus_type, NULL,
+			&fm_driver, fm_crash_shutdown);
+}
+
+void __init fman_init_early(void)
+{
+	crash_shutdown_register(&fm_crash_shutdown_all);
+}
+#else
+void __init fman_init_early(void) {}
+#endif
-- 
1.6.5.2

