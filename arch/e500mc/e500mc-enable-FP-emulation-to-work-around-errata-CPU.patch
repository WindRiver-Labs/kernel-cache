From c82f79b8ad19edc554e93dec89e81f5cf9c2c6b9 Mon Sep 17 00:00:00 2001
From: Timur Tabi <timur@freescale.com>
Date: Mon, 2 Nov 2009 16:26:30 -0600
Subject: [PATCH 206/252] e500mc: enable FP emulation to work around errata CPU12 and CPU13

Errata CPU12 and CPU13 mean that floating-point operations are broken, so we
need to enable FP emulation in the kernel.  However, e500mc has normal FP
support, so we need to modify the kernel to call the software FP emulation
handler instead of the normal FP handler.  To do this, we define a new
exception entry point called FloatingPointUnavailableErrata and set IVOR7 to
it.

This hack is not compatible with rev2 silicon.

Signed-off-by: Timur Tabi <timur@freescale.com>
[Applied FSL SDK 2.0.3 patch
"kernel-2.6.30-e500mc-enable-FP-emulation-to-work-around-er.patch".
Dropped the defconfig changes.]
Integrated-by: Yuri Nedel <Yuri.Nedel@windriver.com>
---
 arch/powerpc/kernel/head_fsl_booke.S |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/kernel/head_fsl_booke.S b/arch/powerpc/kernel/head_fsl_booke.S
index 7b8f6bc..d15cdce 100644
--- a/arch/powerpc/kernel/head_fsl_booke.S
+++ b/arch/powerpc/kernel/head_fsl_booke.S
@@ -321,7 +321,7 @@ skpinv:	addi	r6,r6,1				/* Increment */
 	SET_IVOR(4,  ExternalInput);
 	SET_IVOR(5,  Alignment);
 	SET_IVOR(6,  Program);
-	SET_IVOR(7,  FloatingPointUnavailable);
+	SET_IVOR(7,  FloatingPointUnavailableErrata);
 	SET_IVOR(8,  SystemCall);
 	SET_IVOR(9,  AuxillaryProcessorUnavailable);
 	SET_IVOR(10, Decrementer);
@@ -525,7 +525,7 @@ interrupt_base:
 
 	/* Floating Point Unavailable Interrupt */
 #ifdef CONFIG_PPC_FPU
-	FP_UNAVAILABLE_EXCEPTION
+	EXCEPTION(0x0800, FloatingPointUnavailableErrata, program_check_exception, EXC_XFER_EE)
 #else
 #ifdef CONFIG_E200
 	/* E200 treats 'normal' floating point instructions as FP Unavail exception */
-- 
1.6.5.2

