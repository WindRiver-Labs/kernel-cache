From c803c2db16e5c62778df74fc8879821d52b95578 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Wed, 19 Jun 2013 13:14:51 +0800
Subject: [PATCH 1/2] Revert "powerpc: don't enable irq in program exception"

This reverts commit 6e44ba897("powerpc: don't enable irq in
program exception").

Since commit 1771f7983("booke/kprobe: make program exception to
use one dedicated exception stack") has been dropped, kprobe is
not using a dedicated exception stack any more, so remove this
useless commit.

Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 arch/powerpc/kernel/traps.c  |    6 +++---
 arch/powerpc/math-emu/math.c |    2 +-
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/arch/powerpc/kernel/traps.c b/arch/powerpc/kernel/traps.c
index 5df42c2..d3ed2b2 100644
--- a/arch/powerpc/kernel/traps.c
+++ b/arch/powerpc/kernel/traps.c
@@ -37,7 +37,6 @@
 #include <linux/ltt-core.h>
 #include <trace/trap.h>
 #include <linux/kallsyms.h>
-#include <linux/uaccess.h>
 
 #include <asm/emulated_ops.h>
 #include <asm/pgtable.h>
@@ -864,8 +863,7 @@ static int emulate_instruction(struct pt_regs *regs)
 		return -EINVAL;
 	CHECK_FULL_REGS(regs);
 
-	if (probe_kernel_read((void *)&instword, (void *)(regs->nip),
-				sizeof(u32)))
+	if (get_user(instword, (u32 __user *)(regs->nip)))
 		return -EFAULT;
 
 	/* Emulate the mfspr rD, PVR. */
@@ -960,6 +958,8 @@ void __kprobes program_check_exception(struct pt_regs *regs)
 		return;
 	}
 
+	local_irq_enable();
+
 #ifdef CONFIG_MATH_EMULATION
 	/* (reason & REASON_ILLEGAL) would be the obvious thing here,
 	 * but there seems to be a hardware bug on the 405GP (RevD)
diff --git a/arch/powerpc/math-emu/math.c b/arch/powerpc/math-emu/math.c
index 9c3e0b5..164d559 100644
--- a/arch/powerpc/math-emu/math.c
+++ b/arch/powerpc/math-emu/math.c
@@ -224,7 +224,7 @@ do_mathemu(struct pt_regs *regs)
 	int eflag, trap;
 #endif
 
-	if (probe_kernel_read((void *)&insn, (void *)pc, sizeof(u32)))
+	if (get_user(insn, (u32 *)pc))
 		return -EFAULT;
 
 #ifndef CONFIG_MATH_EMULATION
-- 
1.7.0

