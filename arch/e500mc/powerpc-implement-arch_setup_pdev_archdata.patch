From 3a1183da075486112f39e10bfebe0f872f1f318b Mon Sep 17 00:00:00 2001
From: Kumar Gala <galak@kernel.crashing.org>
Date: Thu, 5 Aug 2010 10:05:31 -0500
Subject: [PATCH 025/233] powerpc: implement arch_setup_pdev_archdata

Extracted from vendor drop QorIQ-DPAA-SDK-V1-20110609-systembuilder.iso
0123-powerpc-implement-arch_setup_pdev_archdata.patch

We have a long standing issues with platform devices not have a valid
dma_mask pointer.  This hasn't been an issue to date as no platform
device has tried to set its dma_mask value to a non-default value.

Signed-off-by: Kumar Gala <galak@kernel.crashing.org>
---
 arch/powerpc/include/asm/device.h          |    1 +
 arch/powerpc/include/asm/platform_device.h |   18 +++++++++++++++++-
 arch/powerpc/kernel/setup-common.c         |    6 ------
 3 files changed, 18 insertions(+), 7 deletions(-)

diff --git a/arch/powerpc/include/asm/device.h b/arch/powerpc/include/asm/device.h
index 6d94d27..1277c11 100644
--- a/arch/powerpc/include/asm/device.h
+++ b/arch/powerpc/include/asm/device.h
@@ -43,6 +43,7 @@ dev_archdata_get_node(const struct dev_archdata *ad)
 }
 
 struct pdev_archdata {
+	u64 dma_mask;
 };
 
 #endif /* _ASM_POWERPC_DEVICE_H */
diff --git a/arch/powerpc/include/asm/platform_device.h b/arch/powerpc/include/asm/platform_device.h
index 01452c3..dd3a7c3 100644
--- a/arch/powerpc/include/asm/platform_device.h
+++ b/arch/powerpc/include/asm/platform_device.h
@@ -1 +1,17 @@
-#include <asm-generic/platform_device.h>
+#ifndef __ASM_PLATFORM_DEVICE_H_
+#define __ASM_PLATFORM_DEVICE_H_
+
+#include <linux/platform_device.h>
+#include <asm/dma-mapping.h>
+
+#define ARCH_HAS_PDEV_ARCHDATA_SETUP
+
+static inline void arch_setup_pdev_archdata(struct platform_device *pdev)
+{
+	pdev->dev.dma_mask = &pdev->archdata.dma_mask;
+	set_dma_ops(&pdev->dev, &dma_direct_ops);
+
+	return;
+}
+
+#endif /* __ASM_GENERIC_PLATFORM_DEVICE_H_ */
diff --git a/arch/powerpc/kernel/setup-common.c b/arch/powerpc/kernel/setup-common.c
index 9a933bb..d426b1d 100644
--- a/arch/powerpc/kernel/setup-common.c
+++ b/arch/powerpc/kernel/setup-common.c
@@ -723,11 +723,6 @@ static int ppc_dflt_bus_notify(struct notifier_block *nb,
 	return NOTIFY_DONE;
 }
 
-static struct notifier_block ppc_dflt_plat_bus_notifier = {
-	.notifier_call = ppc_dflt_bus_notify,
-	.priority = INT_MAX,
-};
-
 static struct notifier_block ppc_dflt_of_bus_notifier = {
 	.notifier_call = ppc_dflt_bus_notify,
 	.priority = INT_MAX,
@@ -735,7 +730,6 @@ static struct notifier_block ppc_dflt_of_bus_notifier = {
 
 static int __init setup_bus_notifier(void)
 {
-	bus_register_notifier(&platform_bus_type, &ppc_dflt_plat_bus_notifier);
 	bus_register_notifier(&of_platform_bus_type, &ppc_dflt_of_bus_notifier);
 
 	return 0;
-- 
1.7.0.4

