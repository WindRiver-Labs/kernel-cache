From 052b2aa81b9bb19bfce759c60630a3d44d72266d Mon Sep 17 00:00:00 2001
From: Emil Medve <Emilian.Medve@Freescale.com>
Date: Thu, 24 Sep 2009 22:47:03 -0500
Subject: [PATCH 038/252] P4080/DPA: MAC-less interfaces don't have a PHY

This fixes a kernel panic for Ethernet interfaces without a MAC.

Signed-off-by: Emil Medve <Emilian.Medve@Freescale.com>
[Cleanly applied the FSL SDK 2.0.3 patch:
"kernel-2.6.30-P4080-DPA-MAC-less-interfaces-don-t-have-a-P.patch"]
Integrated-by: Yuri Nedel <Yuri.Nedel@windriver.com>
---
 drivers/net/dpa/dpa-ethtool.c |   30 ++++++++++++++++++++++++++++++
 1 files changed, 30 insertions(+), 0 deletions(-)

diff --git a/drivers/net/dpa/dpa-ethtool.c b/drivers/net/dpa/dpa-ethtool.c
index b8a2ac5..295e5cf 100644
--- a/drivers/net/dpa/dpa-ethtool.c
+++ b/drivers/net/dpa/dpa-ethtool.c
@@ -43,6 +43,12 @@ static int __cold dpa_get_settings(struct net_device *net_dev, struct ethtool_cm
 
 	priv = (typeof(priv))netdev_priv(net_dev);
 
+	if (priv->mac_dev == NULL) {
+		cpu_netdev_info(net_dev,
+				"%s:%hu:%s(): This is a MAC-less interface\n",
+				__file__, __LINE__, __func__);
+		return -ENODEV;
+	}
 	if (unlikely(priv->mac_dev->phy_dev == NULL)) {
 		cpu_netdev_err(net_dev, "%s:%hu:%s(): phy device not initialized\n",
 			       __file__, __LINE__, __func__);
@@ -68,6 +74,12 @@ static int __cold dpa_set_settings(struct net_device *net_dev, struct ethtool_cm
 
 	priv = (typeof(priv))netdev_priv(net_dev);
 
+	if (priv->mac_dev == NULL) {
+		cpu_netdev_info(net_dev,
+				"%s:%hu:%s(): This is a MAC-less interface\n",
+				__file__, __LINE__, __func__);
+		return -ENODEV;
+	}
 	if (unlikely(priv->mac_dev->phy_dev == NULL)) {
 		cpu_netdev_err(net_dev, "%s:%hu:%s(): phy device not initialized\n",
 			       __file__, __LINE__, __func__);
@@ -141,6 +153,12 @@ int __cold dpa_nway_reset(struct net_device *net_dev)
 
 	priv = (typeof(priv))netdev_priv(net_dev);
 
+	if (priv->mac_dev == NULL) {
+		cpu_netdev_info(net_dev,
+				"%s:%hu:%s(): This is a MAC-less interface\n",
+				__file__, __LINE__, __func__);
+		return -ENODEV;
+	}
 	if (unlikely(priv->mac_dev->phy_dev == NULL)) {
 		cpu_netdev_err(net_dev, "%s:%hu:%s(): phy device not initialized\n",
 			       __file__, __LINE__, __func__);
@@ -185,6 +203,12 @@ void __cold dpa_get_pauseparam(struct net_device *net_dev, struct ethtool_pausep
 
 	priv = (typeof(priv))netdev_priv(net_dev);
 
+	if (priv->mac_dev == NULL) {
+		cpu_netdev_info(net_dev,
+				"%s:%hu:%s(): This is a MAC-less interface\n",
+				__file__, __LINE__, __func__);
+		return -ENODEV;
+	}
 	if (unlikely(priv->mac_dev->phy_dev == NULL)) {
 		cpu_netdev_err(net_dev, "%s:%hu:%s(): phy device not initialized\n",
 			       __file__, __LINE__, __func__);
@@ -204,6 +228,12 @@ int __cold dpa_set_pauseparam(struct net_device *net_dev, struct ethtool_pausepa
 
 	priv = (typeof(priv))netdev_priv(net_dev);
 
+	if (priv->mac_dev == NULL) {
+		cpu_netdev_info(net_dev,
+				"%s:%hu:%s(): This is a MAC-less interface\n",
+				__file__, __LINE__, __func__);
+		return -ENODEV;
+	}
 	if (unlikely(priv->mac_dev->phy_dev == NULL)) {
 		cpu_netdev_err(net_dev, "%s:%hu:%s(): phy device not initialized\n",
 			       __file__, __LINE__, __func__);
-- 
1.6.5.2

