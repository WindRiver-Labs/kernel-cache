From c894343789b8c72917c14281b3ef8699dea91771 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 19 Oct 2010 13:05:05 +0800
Subject: [PATCH 172/233] powerpc/kdump: run the crash down hooks after stopping all the other cores

We use the setjmp/longjmp code around the call out to the crash
down hooks. But if other cores get a exception at this time,
it will use the context saved by setjmp. This will definitely
cause a oops. So running these crash down hooks only after
stopping all the other cores.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/crash.c |   30 +++++++++++++++---------------
 1 files changed, 15 insertions(+), 15 deletions(-)

diff --git a/arch/powerpc/kernel/crash.c b/arch/powerpc/kernel/crash.c
index cfd2650..e201db5 100644
--- a/arch/powerpc/kernel/crash.c
+++ b/arch/powerpc/kernel/crash.c
@@ -415,6 +415,21 @@ void default_machine_crash_shutdown(struct pt_regs *regs)
 	}
 
 	/*
+	 * Make a note of crashing cpu. Will be used in machine_kexec
+	 * such that another IPI will not be sent.
+	 */
+	crashing_cpu = smp_processor_id();
+	crash_save_cpu(regs, crashing_cpu);
+	crash_kexec_prepare_cpus(crashing_cpu);
+	cpu_set(crashing_cpu, cpus_in_crash);
+	crash_kexec_stop_spus();
+#if defined(CONFIG_PPC_STD_MMU_64) && defined(CONFIG_SMP)
+	crash_kexec_wait_realmode(crashing_cpu);
+#endif
+	if (ppc_md.kexec_cpu_down)
+		ppc_md.kexec_cpu_down(1, 0);
+
+	/*
 	 * Call registered shutdown routines savely.  Swap out
 	 * __debugger_fault_handler, and replace on exit.
 	 */
@@ -436,21 +451,6 @@ void default_machine_crash_shutdown(struct pt_regs *regs)
 	}
 	crash_shutdown_cpu = -1;
 	__debugger_fault_handler = old_handler;
-
-	/*
-	 * Make a note of crashing cpu. Will be used in machine_kexec
-	 * such that another IPI will not be sent.
-	 */
-	crashing_cpu = smp_processor_id();
-	crash_save_cpu(regs, crashing_cpu);
-	crash_kexec_prepare_cpus(crashing_cpu);
-	cpu_set(crashing_cpu, cpus_in_crash);
-	crash_kexec_stop_spus();
-#if defined(CONFIG_PPC_STD_MMU_64) && defined(CONFIG_SMP)
-	crash_kexec_wait_realmode(crashing_cpu);
-#endif
-	if (ppc_md.kexec_cpu_down)
-		ppc_md.kexec_cpu_down(1, 0);
 }
 
 #ifdef CONFIG_PPC32
-- 
1.7.0.4

