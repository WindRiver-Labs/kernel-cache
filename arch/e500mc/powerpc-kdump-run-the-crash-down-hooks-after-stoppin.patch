From 0b0a724b7e5a7b289d805c8865f2f6d49251d350 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 19 Oct 2010 13:05:05 +0800
Subject: [PATCH] powerpc/kdump: run the crash down hooks after stopping all the other cores

We use the setjmp/longjmp code around the call out to the crash
down hooks. But if other cores get a exception at this time,
it will use the context saved by setjmp. This will definitely
cause a oops. So running these crash down hooks only after
stopping all the other cores.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>

diff --git a/arch/powerpc/kernel/crash.c b/arch/powerpc/kernel/crash.c
index 6e2a50b..e2e86c2 100644
--- a/arch/powerpc/kernel/crash.c
+++ b/arch/powerpc/kernel/crash.c
@@ -413,6 +413,19 @@ void default_machine_crash_shutdown(struct pt_regs *regs)
 	}
 
 	/*
+	 * Make a note of crashing cpu. Will be used in machine_kexec
+	 * such that another IPI will not be sent.
+	 */
+	crashing_cpu = smp_processor_id();
+	crash_save_cpu(regs, crashing_cpu);
+	crash_kexec_prepare_cpus(crashing_cpu);
+	cpu_set(crashing_cpu, cpus_in_crash);
+	crash_kexec_stop_spus();
+	crash_kexec_wait_realmode(crashing_cpu);
+	if (ppc_md.kexec_cpu_down)
+		ppc_md.kexec_cpu_down(1, 0);
+
+	/*
 	 * Call registered shutdown routines savely.  Swap out
 	 * __debugger_fault_handler, and replace on exit.
 	 */
@@ -434,19 +447,6 @@ void default_machine_crash_shutdown(struct pt_regs *regs)
 	}
 	crash_shutdown_cpu = -1;
 	__debugger_fault_handler = old_handler;
-
-	/*
-	 * Make a note of crashing cpu. Will be used in machine_kexec
-	 * such that another IPI will not be sent.
-	 */
-	crashing_cpu = smp_processor_id();
-	crash_save_cpu(regs, crashing_cpu);
-	crash_kexec_prepare_cpus(crashing_cpu);
-	cpu_set(crashing_cpu, cpus_in_crash);
-	crash_kexec_stop_spus();
-	crash_kexec_wait_realmode(crashing_cpu);
-	if (ppc_md.kexec_cpu_down)
-		ppc_md.kexec_cpu_down(1, 0);
 }
 
 #ifdef CONFIG_PPC32
-- 
1.7.0

