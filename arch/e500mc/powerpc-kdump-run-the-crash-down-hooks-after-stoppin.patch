From c2e36e6ef4dbb4ef92f1c3bfed6406a812e1a8bc Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 19 Oct 2010 13:05:05 +0800
Subject: [PATCH 251/252] powerpc/kdump: run the crash down hooks after stopping all the other cores

We use the setjmp/longjmp code around the call out to the crash
down hooks. But if other cores get a exception at this time,
it will use the context saved by setjmp. This will definitely
cause a oops. So running these crash down hooks only after
stopping all the other cores.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/crash.c |   24 ++++++++++++------------
 1 files changed, 12 insertions(+), 12 deletions(-)

diff --git a/arch/powerpc/kernel/crash.c b/arch/powerpc/kernel/crash.c
index 3a846ab..38f4dac 100644
--- a/arch/powerpc/kernel/crash.c
+++ b/arch/powerpc/kernel/crash.c
@@ -382,6 +382,18 @@ void default_machine_crash_shutdown(struct pt_regs *regs)
 	}
 
 	/*
+	 * Make a note of crashing cpu. Will be used in machine_kexec
+	 * such that another IPI will not be sent.
+	 */
+	crashing_cpu = smp_processor_id();
+	crash_save_cpu(regs, crashing_cpu);
+	crash_kexec_prepare_cpus(crashing_cpu);
+	cpu_set(crashing_cpu, cpus_in_crash);
+	crash_kexec_stop_spus();
+	if (ppc_md.kexec_cpu_down)
+		ppc_md.kexec_cpu_down(1, 0);
+
+	/*
 	 * Call registered shutdown routines savely.  Swap out
 	 * __debugger_fault_handler, and replace on exit.
 	 */
@@ -401,18 +413,6 @@ void default_machine_crash_shutdown(struct pt_regs *regs)
 		}
 	}
 	__debugger_fault_handler = old_handler;
-
-	/*
-	 * Make a note of crashing cpu. Will be used in machine_kexec
-	 * such that another IPI will not be sent.
-	 */
-	crashing_cpu = smp_processor_id();
-	crash_save_cpu(regs, crashing_cpu);
-	crash_kexec_prepare_cpus(crashing_cpu);
-	cpu_set(crashing_cpu, cpus_in_crash);
-	crash_kexec_stop_spus();
-	if (ppc_md.kexec_cpu_down)
-		ppc_md.kexec_cpu_down(1, 0);
 }
 
 #ifdef CONFIG_PPC32
-- 
1.6.5.2

