From b90063eda2cd41cfe177832147b55e09ab735038 Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Tue, 14 Dec 2010 15:55:37 +0800
Subject: [PATCH 09/28] skb_buff: Add skb_recycle and skb_is_recycleable helper functions

Patch taken from FSL vendor SDK 2.2.

Implment two helper functions:  skb_recycle and skb_is_recycleable
which are invoked directly in DPAA network driver.

Rearrange skb_recycle_check with skb_recycle and skb_is_recycleable, and
the function of skb_recycle_check doesn't change.

Its purpose is to get a bit potential performance improvements.
Under certain condition that a skb can surely be recycled, invoke skb_recycle
directly instead of skb_recycle_check to avoid unnecessary recyclable check.

Integrated-by: Andrew Liu <shengping.liu@windriver.com>
---
 include/linux/skbuff.h |   16 ++++++++++++++++
 net/core/skbuff.c      |   48 ++++++++++++++++++++++--------------------------
 2 files changed, 38 insertions(+), 26 deletions(-)

diff --git a/include/linux/skbuff.h b/include/linux/skbuff.h
index 9fa2ade..6e5bf5a 100644
--- a/include/linux/skbuff.h
+++ b/include/linux/skbuff.h
@@ -457,6 +457,7 @@ static inline struct sk_buff *alloc_skb_header(unsigned int size,
 #endif
 
 extern int skb_recycle_check(struct sk_buff *skb, int skb_size);
+extern void skb_recycle(struct sk_buff *skb);
 
 extern struct sk_buff *skb_morph(struct sk_buff *dst, struct sk_buff *src);
 extern struct sk_buff *skb_clone(struct sk_buff *skb,
@@ -2096,5 +2097,20 @@ static inline void skb_forward_csum(struct sk_buff *skb)
 }
 
 bool skb_partial_csum_set(struct sk_buff *skb, u16 start, u16 off);
+static inline int skb_is_recycleable(struct sk_buff *skb, int skb_size)
+{
+	if (skb_is_nonlinear(skb) || skb->fclone != SKB_FCLONE_UNAVAILABLE)
+		return 0;
+
+	skb_size = SKB_DATA_ALIGN(skb_size + NET_SKB_PAD);
+	if (skb_end_pointer(skb) - skb->head < skb_size)
+		return 0;
+
+	if (skb_shared(skb) || skb_cloned(skb))
+		return 0;
+
+	return 1;
+}
+
 #endif	/* __KERNEL__ */
 #endif	/* _LINUX_SKBUFF_H */
diff --git a/net/core/skbuff.c b/net/core/skbuff.c
index 1a1b207..3666cf5 100644
--- a/net/core/skbuff.c
+++ b/net/core/skbuff.c
@@ -554,35 +554,10 @@ void consume_skb(struct sk_buff *skb)
 }
 EXPORT_SYMBOL(consume_skb);
 
-/**
- *	skb_recycle_check - check if skb can be reused for receive
- *	@skb: buffer
- *	@skb_size: minimum receive buffer size
- *
- *	Checks that the skb passed in is not shared or cloned, and
- *	that it is linear and its head portion at least as large as
- *	skb_size so that it can be recycled as a receive buffer.
- *	If these conditions are met, this function does any necessary
- *	reference count dropping and cleans up the skbuff as if it
- *	just came from __alloc_skb().
- */
-int skb_recycle_check(struct sk_buff *skb, int skb_size)
+void skb_recycle(struct sk_buff *skb)
 {
 	struct skb_shared_info *shinfo;
 
-	if (irqs_disabled())
-		return 0;
-
-	if (skb_is_nonlinear(skb) || skb->fclone != SKB_FCLONE_UNAVAILABLE)
-		return 0;
-
-	skb_size = SKB_DATA_ALIGN(skb_size + NET_SKB_PAD);
-	if (skb_end_pointer(skb) - skb->head < skb_size)
-		return 0;
-
-	if (skb_shared(skb) || skb_cloned(skb))
-		return 0;
-
 	skb_release_head_state(skb);
 	shinfo = skb_shinfo(skb);
 	atomic_set(&shinfo->dataref, 1);
@@ -599,6 +574,27 @@ int skb_recycle_check(struct sk_buff *skb, int skb_size)
 	skb->data = skb->head + NET_SKB_PAD;
 	skb_reset_tail_pointer(skb);
 
+}
+
+/**
+ *	skb_recycle_check - check if skb can be reused for receive
+ *	@skb: buffer
+ *	@skb_size: minimum receive buffer size
+ *
+ *	Checks that the skb passed in is not shared or cloned, and
+ *	that it is linear and its head portion at least as large as
+ *	skb_size so that it can be recycled as a receive buffer.
+ *	If these conditions are met, this function does any necessary
+ *	reference count dropping and cleans up the skbuff as if it
+ *	just came from __alloc_skb().
+ */
+int skb_recycle_check(struct sk_buff *skb, int skb_size)
+{
+	if (!skb_is_recycleable(skb, skb_size))
+		return 0;
+
+	skb_recycle(skb);
+
 	return 1;
 }
 EXPORT_SYMBOL(skb_recycle_check);
-- 
1.7.0.4

