From 4e31968b649f388f32a5e1dc009c8379da947fe6 Mon Sep 17 00:00:00 2001
From: Andy Fleming <afleming@freescale.com>
Date: Thu, 2 Jun 2011 21:31:46 -0500
Subject: [PATCH 133/233] dpaa_eth: Release rejected tx buffers to pool

Extracted from vendor drop QorIQ-DPAA-SDK-V1-20110609-systembuilder.iso
0163-dpaa_eth-Release-rejected-tx-buffers-to-pool.patch

Some frames are configured so that the FM will return their buffers
to the buffer pool when completed. The egress_ern handler doesn't pay
attention to this fact when such frames are rejected by the frame queue,
and so the counter which tracks the number of buffers in the pool
becomes inaccurate, and over time, the driver will believe that there
are buffers in the pool, even when it is empty.

To fix this, we check the "FCO" bit in the rejected frame descriptor,
and release the buffer to the buffer pool. If this fails, too, we
decrement the buffer counter on this core.

Signed-off-by: Andy Fleming <afleming@freescale.com>
---
 drivers/net/dpa/dpaa_eth.c |   24 +++++++++++++++++++++---
 1 files changed, 21 insertions(+), 3 deletions(-)

diff --git a/drivers/net/dpa/dpaa_eth.c b/drivers/net/dpa/dpaa_eth.c
index 5013332..006b65d 100644
--- a/drivers/net/dpa/dpaa_eth.c
+++ b/drivers/net/dpa/dpaa_eth.c
@@ -1517,15 +1517,33 @@ static void egress_ern(struct qman_portal	*portal,
 	bp = priv->dpa_bp;
 	percpu_priv = per_cpu_ptr(priv->percpu_priv, smp_processor_id());
 
+	percpu_priv->stats.tx_dropped++;
+	percpu_priv->stats.tx_fifo_errors++;
+
+	/*
+	 * If we intended this buffer to go into the pool
+	 * when the FM was done, we need to try to put it in
+	 * manually. If that fails, increment the percpu counter
+	 */
+	if (msg->ern.fd.cmd & FM_FD_CMD_FCO) {
+		struct bm_buffer bmb;
+		int err;
+
+		bm_buffer_set64(&bmb, addr);
+		err = bman_release(bp->pool, &bmb, 1, 0);
+
+		if (!err)
+			return;
+
+		(*percpu_priv->dpa_bp_count)--;
+	}
+
 	skbh = (struct sk_buff **)phys_to_virt(addr);
 	skb = *skbh;
 
 	dma_unmap_single(bp->dev, addr, bp->size, DMA_TO_DEVICE);
 
 	dev_kfree_skb_any(skb);
-
-	percpu_priv->stats.tx_dropped++;
-	percpu_priv->stats.tx_fifo_errors++;
 }
 
 static const struct qman_fq rx_shared_fq __devinitconst = {
-- 
1.7.0.4

