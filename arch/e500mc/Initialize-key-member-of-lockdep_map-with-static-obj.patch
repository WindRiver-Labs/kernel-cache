From bdfff2b43fd327abbba1d890fd7d2b76d919c539 Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Fri, 17 Dec 2010 15:29:22 +0800
Subject: [PATCH 14/28] Initialize key member of lockdep_map with static object.

When turns on kernel option: CONFIG_PROVE_LOCKING, to every lock,
must initialize the key member of lockdep_map to identify it.

COMPLETION_INITIALIZER doesn't do it, can invoke init_waitqueue_head to do it.

Can remove the following call trace:
"
the code is fine but needs lockdep annotation.
turning off the locking correctness validator

[ebca9c90] [c0007394] show_stack+0x44/0x160 (unreliable)
[ebca9cc0] [c007cb8c] __lock_acquire+0x11dc/0x17cc
[ebca9d70] [c007d204] lock_acquire+0x88/0x124
[ebca9db0] [c05310f0] _raw_spin_lock_irq+0x4c/0x68
[ebca9dd0] [c052dce8] wait_for_common+0x30/0x1b0
[ebca9e10] [c0452670] init_affine_portal+0xa0/0x10c
[ebca9e60] [c06ea8ec] fsl_qman_portal_init+0x554/0x56c
[ebca9ef0] [c06eabb8] qman_init+0x2b4/0x394
[ebca9f50] [c0001cc4] do_one_initcall+0x3c/0x1e4
[ebca9f80] [c06c6394] kernel_init+0x1a0/0x278
[ebca9ff0] [c00106ac] original_kernel_thread+0x4c/0x68
"

Signed-off-by: Andrew Liu <shengping.liu@windriver.com>
---
 drivers/hwalloc/bman_driver.c |    1 +
 drivers/hwqueue/qman_driver.c |    1 +
 2 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/hwalloc/bman_driver.c b/drivers/hwalloc/bman_driver.c
index f09267b..4071983 100644
--- a/drivers/hwalloc/bman_driver.c
+++ b/drivers/hwalloc/bman_driver.c
@@ -179,6 +179,7 @@ static void init_affine_portal(const struct bm_portal_config *pconfig)
 		.done = COMPLETION_INITIALIZER(data.done),
 		.pconfig = pconfig
 	};
+	init_waitqueue_head(&data.done.wait);
 	struct task_struct *k = kthread_create(__init_affine_portal, &data,
 		"bman_affine%d", pconfig->cpu);
 	int ret;
diff --git a/drivers/hwqueue/qman_driver.c b/drivers/hwqueue/qman_driver.c
index a6556b3..f438ee0 100644
--- a/drivers/hwqueue/qman_driver.c
+++ b/drivers/hwqueue/qman_driver.c
@@ -227,6 +227,7 @@ static void init_affine_portal(const struct qm_portal_config *pconfig)
 		.done = COMPLETION_INITIALIZER(data.done),
 		.pconfig = pconfig
 	};
+	init_waitqueue_head(&data.done.wait);
 	struct task_struct *k = kthread_create(__init_affine_portal, &data,
 		"qman_affine%d", pconfig->cpu);
 	int ret;
-- 
1.6.5.2

