From 9051036883c45e3ecd7bca529a3639934f872855 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Wed, 13 Oct 2010 15:36:51 +0800
Subject: [PATCH 250/252] powerpc/kdump: flush cache after loading dump kernel

These operations are required because the data cache on ppc is
a write-back cache, and the instruction fetch bypasses the
date cache. So we should make sure that the changes are reflected
in memory.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/include/asm/kexec.h |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/kexec.h b/arch/powerpc/include/asm/kexec.h
index 5e6253d..8c7a57c 100644
--- a/arch/powerpc/include/asm/kexec.h
+++ b/arch/powerpc/include/asm/kexec.h
@@ -42,11 +42,17 @@
 #ifndef __ASSEMBLY__
 #include <linux/cpumask.h>
 #include <asm/reg.h>
+#include <asm/cacheflush.h>
 
 typedef void (*crash_shutdown_t)(void);
 
 #ifdef CONFIG_KEXEC
 
+#define kexec_flush_icache_page(page) {				\
+	unsigned long addr = (unsigned long)page_address(page);	\
+	flush_icache_range(addr, addr + PAGE_SIZE);		\
+}
+
 /*
  * This function is responsible for capturing register states if coming
  * via panic or invoking dump using sysrq-trigger.
-- 
1.6.5.2

