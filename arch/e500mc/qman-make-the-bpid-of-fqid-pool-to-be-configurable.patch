From 2416cdce3ee8004242a371a40e2e743407538734 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Mon, 26 Jul 2010 01:54:53 -0700
Subject: [PATCH 2/3] qman: make the bpid of fqid pool to be configurable

By default we use bpid 0 as the bman pool for fqid alloc.
But in sAMP when two linux are running at the same time,
there will be a conflict. So we add a new property
"qman-fqalloc-bpid" for qman device node in order to
configure the bpid of fqid pool.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/hwqueue/qman_driver.c  |   13 +++++++++++--
 drivers/hwqueue/qman_fqalloc.c |    5 +++--
 drivers/hwqueue/qman_private.h |    2 +-
 3 files changed, 15 insertions(+), 5 deletions(-)

diff --git a/drivers/hwqueue/qman_driver.c b/drivers/hwqueue/qman_driver.c
index f438ee0..bc3f13a 100644
--- a/drivers/hwqueue/qman_driver.c
+++ b/drivers/hwqueue/qman_driver.c
@@ -392,7 +392,7 @@ bad_cpu_ph:
 static __init int qman_init(void)
 {
 	struct device_node *dn;
-	int ret;
+	int ret, bpid = 0;
 
 	for_each_compatible_node(dn, NULL, "fsl,qman") {
 		if (!qman_init_error_int(dn))
@@ -422,7 +422,16 @@ static __init int qman_init(void)
 		pr_err("Expect Qman-dependent drivers to crash!\n");
 	}
 #ifdef CONFIG_FSL_QMAN_FQALLOCATOR
-	ret = __fqalloc_init();
+	dn = of_find_compatible_node(NULL, NULL, "fsl,qman");
+	if (dn) {
+		const uint32_t *prop;
+		int len;
+
+		prop = of_get_property(dn, "fsl,qman-fqalloc-bpid", &len);
+		if (prop)
+			bpid = *prop;
+	}
+	ret = __fqalloc_init(bpid);
 	if (ret)
 		return ret;
 #endif
diff --git a/drivers/hwqueue/qman_fqalloc.c b/drivers/hwqueue/qman_fqalloc.c
index 8fb0ba6..60ce115 100644
--- a/drivers/hwqueue/qman_fqalloc.c
+++ b/drivers/hwqueue/qman_fqalloc.c
@@ -41,10 +41,11 @@
 /****************/
 
 static struct bman_pool *fq_pool;
-static const struct bman_pool_params fq_pool_params;
+static struct bman_pool_params fq_pool_params;
 
-__init int __fqalloc_init(void)
+__init int __fqalloc_init(u32 bpid)
 {
+	fq_pool_params.bpid = bpid;
 	fq_pool = bman_new_pool(&fq_pool_params);
 	if (!fq_pool)
 		return -ENOMEM;
diff --git a/drivers/hwqueue/qman_private.h b/drivers/hwqueue/qman_private.h
index d158889..6240401 100644
--- a/drivers/hwqueue/qman_private.h
+++ b/drivers/hwqueue/qman_private.h
@@ -80,7 +80,7 @@ struct qm_portal_config {
 
 /* Hooks for driver initialisation */
 #ifdef CONFIG_FSL_QMAN_FQALLOCATOR
-__init int __fqalloc_init(void);
+__init int __fqalloc_init(u32 bpid);
 #endif
 
 /* Revision info (for errata and feature handling) */
-- 
1.7.0.4

