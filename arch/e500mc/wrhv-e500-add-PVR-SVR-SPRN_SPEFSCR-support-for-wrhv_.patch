From d5fb1083058b54ba22447100fc0ae178c294e5c4 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Fri, 29 Jul 2011 13:01:28 +0800
Subject: [PATCH 1/2] wrhv/e500: add PVR/SVR/SPRN_SPEFSCR support for wrhv_mfspr

In some cases we need to read these registers on E500 GOS.
So add the support for them in wrhv_mfspr.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/vbi/wrhv.c |   28 ++++++++++++++++++++++++++++
 1 files changed, 28 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 884fe20..8538758 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -1719,6 +1719,14 @@ unsigned int wrhv_mfspr(unsigned int sprn)
 	return value;
 }
 #else
+#define WRHV_READ_SPRN(sprn, value)		\
+do {						\
+	__asm__ __volatile__(			\
+	"mfspr	%0," __stringify(sprn)		\
+	: "=r" (value)				\
+	);					\
+} while (0)
+
 unsigned int wrhv_mfspr(unsigned int sprn)
 {
 	unsigned int value = 0;
@@ -1730,6 +1738,26 @@ unsigned int wrhv_mfspr(unsigned int sprn)
 		case SPRN_DBSR:
 			value = wr_control->vb_control_regs.dbsr;
 			break;
+
+		case SPRN_PVR:
+			value = VB_STATUS_REGS_ACCESS(wr_status, pvr);
+			break;
+
+		case SPRN_SVR:
+			value = VB_STATUS_REGS_ACCESS(wr_status, svr);
+			break;
+
+		/*
+		 * We have the read/write permission to SPEFSCR in GOS,
+		 * so we should get its value directly.
+		 */
+		case SPRN_SPEFSCR:
+			WRHV_READ_SPRN(SPRN_SPEFSCR, value);
+			break;
+
+		default:
+			panic("Unsupported read for spr 0x%x in %pF\n",
+				sprn, __builtin_return_address(0));
 	}
 
 	return value;
-- 
1.7.0.4

