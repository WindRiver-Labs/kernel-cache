From 6152075a6a34b5b7405f71a1af658cf7ea8d87c8 Mon Sep 17 00:00:00 2001
From: Jiang, Bin <bin.jiang@windriver.com>
Date: Sun, 30 Jan 2011 10:53:35 +0800
Subject: [PATCH 1/4] powerpc/fsl: Support unique MSI addresses per PCIe Root Complex

commit 3da34aae03d498ee62f75aa7467de93cce3030fd upstream

Its feasible based on how the PCI address map is setup that the region
of PCI address space used for MSIs differs for each PHB on the same SoC.

Instead of assuming that the address mappes to CCSRBAR 1:1 we read
PEXCSRBAR (BAR0) for the PHB that the given pci_dev is on.

Signed-off-by: Kumar Gala <galak@kernel.crashing.org>

[Commit 3da34aae is modified by commit bea6ccaf badly. Recover commit
3da34aae here.]

Integrated-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/powerpc/sysdev/fsl_msi.c |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/sysdev/fsl_msi.c b/arch/powerpc/sysdev/fsl_msi.c
index 9ca091f..f9bbcbc 100644
--- a/arch/powerpc/sysdev/fsl_msi.c
+++ b/arch/powerpc/sysdev/fsl_msi.c
@@ -131,10 +131,10 @@ static int fsl_compose_msi_msg(struct pci_dev *pdev, int hwirq,
  					hose->dn->full_name);
  			return -1;
  		}
- 		msg->address_lo = *((u64 *)reg);
+		msg->address_lo = *((u64 *)reg) + base;
  	}
  	else {
- 		msg->address_lo = msi_data->msi_addr_lo;
+		msg->address_lo = msi_data->msi_addr_lo + base;
  	}
  
 	msg->address_hi = msi_data->msi_addr_hi;
@@ -296,7 +296,7 @@ static int __devinit fsl_of_msi_probe(struct of_device *dev,
 			dev_err(&dev->dev, "ioremap problem failed\n");
 			goto error_out;
 		}
-		msi->msi_addr_lo = res.start + features->msiir_offset;
+		msi->msi_addr_lo = features->msiir_offset + (res.start & 0xfffff);
 	}
 
 	msi->feature = features->fsl_pic_ip;
-- 
1.6.5.2

