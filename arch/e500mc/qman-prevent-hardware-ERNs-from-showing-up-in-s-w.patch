From d161a8c93df7d8f6234454990c7e57cc38156846 Mon Sep 17 00:00:00 2001
From: Geoff Thorpe <Geoff.Thorpe@freescale.com>
Date: Fri, 7 May 2010 15:54:09 +0800
Subject: [PATCH 126/252] qman: prevent hardware ERNs from showing up in s/w.

Signed-off-by: Geoff Thorpe <Geoff.Thorpe@freescale.com>
Acked-by: K Agarwal Vineet-B22283 <vineet.agarwal@freescale.com>
[Kevin: Original patch taken from Freescale p4080 SDK 2.1 ISO image.
Apply cleanly to kernel 2.6.27]
Integrated-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/hwqueue/qman_config.c |   18 +++++++++++-------
 1 files changed, 11 insertions(+), 7 deletions(-)

diff --git a/drivers/hwqueue/qman_config.c b/drivers/hwqueue/qman_config.c
index ba2876a..61c4580 100644
--- a/drivers/hwqueue/qman_config.c
+++ b/drivers/hwqueue/qman_config.c
@@ -190,13 +190,6 @@ static void qm_set_ddebug(struct qman *qm, u8 mdd, u8 m_cfg)
 	qm_out(DD_CFG, ((mdd & 0x3) << 4) | (m_cfg & 0xf));
 }
 
-static void qm_set_dc(struct qman *qm, enum qm_dc_portal portal, int ed, u8 sernd)
-{
-	QM_ASSERT(!ed || (portal == qm_dc_portal_fman0) ||
-			(portal == qm_dc_portal_fman1));
-	qm_out(DCP_CFG(portal), (ed ? 0x100 : 0) | (sernd & 0x1f));
-}
-
 static void qm_set_dc_ddebug(struct qman *qm, enum qm_dc_portal portal, u16 ecd_tp_cfg)
 {
 	qm_out(DCP_DD_CFG(portal), ecd_tp_cfg & 0x1ff);
@@ -290,6 +283,14 @@ static void qm_set_congestion_config(struct qman *qm, u16 pres)
 
 #endif
 
+static void qm_set_dc(struct qman *qm, enum qm_dc_portal portal,
+			int ed, u8 sernd)
+{
+	QM_ASSERT(!ed || (portal == qm_dc_portal_fman0) ||
+			(portal == qm_dc_portal_fman1));
+	qm_out(DCP_CFG(portal), (ed ? 0x100 : 0) | (sernd & 0x1f));
+}
+
 static void qm_set_wq_scheduling(struct qman *qm, enum qm_wq_class wq_class,
 			u8 cs_elev, u8 csw2, u8 csw3, u8 csw4, u8 csw5,
 			u8 csw6, u8 csw7)
@@ -513,6 +514,9 @@ static int __init fsl_qman_init(struct device_node *node)
 	/* Set scheduling weights to defaults */
 	for (ret = qm_wq_first; ret <= qm_wq_last; ret++)
 		qm_set_wq_scheduling(qm, ret, 0, 0, 0, 0, 0, 0, 0);
+	/* We are not prepared to accept ERNs for hardware enqueues */
+	qm_set_dc(qm, qm_dc_portal_fman0, 1, 0);
+	qm_set_dc(qm, qm_dc_portal_fman1, 1, 0);
 	/* Workaround for bug 3594: "PAMU Address translation exception during
 	 * qman dqrr stashing". */
 	if (sizeof(dma_addr_t) <= sizeof(u32))
-- 
1.6.5.2

