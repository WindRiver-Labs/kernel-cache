From f43b87c98f9f013661be099deded3619f1c1a159 Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Fri, 10 Sep 2010 10:57:24 +0800
Subject: [PATCH 186/252] crypto: caam - make error reporting atomic

Patch taken from FSL vendor SDK 2.1.

i.e., avoid this kernel BUG stack dump when reporting an error in a context
that's not allowed to sleep:

BUG: sleeping function called from invalid context at mm/slab.c:3055
in_atomic(): 1, irqs_disabled(): 0, pid: 0, name: swapper
Call Trace:
[ebc91bc0] [c0007278] show_stack+0x40/0x15c (unreliable)
[ebc91bf0] [c002e2d4] __might_sleep+0x110/0x114
[ebc91c00] [c00a7580] kmem_cache_alloc+0xcc/0xd0
[ebc91c20] [c035ffec] report_jump_idx+0x74/0xe0
[ebc91c40] [c03600dc] report_deco_status+0x1c/0x100
[ebc91c60] [c035fe90] caam_jq_strstatus+0x68/0x80
[ebc91cc0] [c03674e0] split_key_done+0x58/0x74
[ebc91de0] [c035fc34] caam_jq_dequeue+0x168/0x260
[ebc91e20] [c0041564] tasklet_action+0xb8/0x190
[ebc91e50] [c00421cc] __do_softirq+0x9c/0x110
[ebc91e90] [c0004abc] do_softirq+0x60/0x64
[ebc91ea0] [c0042088] irq_exit+0x98/0xc4
[ebc91eb0] [c0004c58] do_IRQ+0xd0/0x104
[ebc91ed0] [c00103ec] ret_from_except+0x0/0x18
[ebc91f90] [c0008388] wait_idle+0x20/0x60
[ebc91fa0] [c00083f4] cpu_idle+0x2c/0xf8
[ebc91fc0] [c0477824] start_secondary+0x2e8/0x300
[ebc91ff0] [c0001988] __secondary_start+0x30/0x84
of_platform jq.37: DECO: desc idx 6: Invalid FIFO STORE Command. The FIFO store command is invalid.
RTNETLINK answers: Invalid argument

Signed-off-by: Kim Phillips <kim.phillips@freescale.com>
Integrated-by: Andrew Liu <shengping.liu@windriver.com>
---
 drivers/crypto/caam/error.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/crypto/caam/error.c b/drivers/crypto/caam/error.c
index 0750184..0993ea5 100644
--- a/drivers/crypto/caam/error.c
+++ b/drivers/crypto/caam/error.c
@@ -42,7 +42,7 @@
 {								\
 	char *tmp;						\
 								\
-	tmp = kmalloc(sizeof(format) + max_alloc, GFP_KERNEL);	\
+	tmp = kmalloc(sizeof(format) + max_alloc, GFP_ATOMIC);  \
 	sprintf(tmp, format, param);				\
 	strcat(str, tmp);					\
 	kfree(tmp);						\
-- 
1.6.5.2

