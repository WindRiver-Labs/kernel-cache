From b7675e4aaa1c62f1ac4138cb6918674303e6e052 Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Tue, 12 Jul 2011 16:53:43 +0800
Subject: [PATCH 227/233] net/dpa: fix dpa_bp free warning

When p4080ds-usdpaa.dtb is used, call trace is reported:
------------[ cut here ]------------
Badness at drivers/base/devres.c:648
NIP: c03bb958 LR: c03bb950 CTR: c03bafc0
REGS: ebcb5c70 TRAP: 0700   Not tainted  (2.6.34.10-rt-WR4.2.0.0_preempt_rt)
MSR: 00029002 <EE,ME,CE>  CR: 24042022  XER: 20000000
TASK = ebcb3830[1] 'swapper' THREAD: ebcb4000 CPU: 0
GPR00: 00000001 ebcb5d20 ebcb3830 fffffffe eb32eaa4 eb477750 eb477750 c07f696c
GPR08: c30269a4 fffffffd ebcb3830 00000000 24042022 14c38444 00000000 00000000
GPR16: 00000000 c0feeaa4 00000000 ebcb5d6c 00000000 00000010 eb786c00 effff78c
GPR24: eb787320 00000001 eb2b0390 eb477750 eb32e9c0 00000000 eb32e9d0 00000000
NIP [c03bb958] devm_kfree+0x2c/0x40
LR [c03bb950] devm_kfree+0x24/0x40
Call Trace:
[ebcb5d20] [c03bb950] devm_kfree+0x24/0x40 (unreliable)
[ebcb5d30] [c0611530] dpaa_eth_probe+0x1220/0x14c8
[ebcb5e30] [c051e68c] of_platform_device_probe+0x58/0x98
[ebcb5e50] [c03b8514] driver_probe_device+0xa0/0x188
[ebcb5e70] [c03b86b8] __driver_attach+0xbc/0xc0
[ebcb5e90] [c03b7b3c] bus_for_each_dev+0x70/0xac
[ebcb5ec0] [c03b8340] driver_attach+0x24/0x34
[ebcb5ed0] [c03b72a0] bus_add_driver+0xe4/0x310
[ebcb5f00] [c03b8a28] driver_register+0x94/0x164
[ebcb5f20] [c051e568] of_register_driver+0x54/0x70
[ebcb5f30] [c077afb4] dpa_load+0xa0/0xf4
[ebcb5f50] [c0001dfc] do_one_initcall+0x3c/0x1e0
[ebcb5f80] [c075a398] kernel_init+0x1a4/0x28c
[ebcb5ff0] [c001127c] original_kernel_thread+0x4c/0x68
Instruction dump:
4e800020 7c0802a6 9421fff0 7c862378 3ca0c03c 90010014 3c80c03c 3884afbc
38a5afc0 4bffffa9 3123ffff 7c091910 <0f000000> 80010014 38210010 7c0803a6

When default_pool is not NULL, dpa_bp is not malloc'ed, but a free
operation is still called, which finally cause the call trace. To
fix it, add if condition to control free operation.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 drivers/net/dpa/dpaa_eth.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/net/dpa/dpaa_eth.c b/drivers/net/dpa/dpaa_eth.c
index 7cd11c8..a2aab2a 100644
--- a/drivers/net/dpa/dpaa_eth.c
+++ b/drivers/net/dpa/dpaa_eth.c
@@ -2655,7 +2655,8 @@ dpaa_eth_probe(struct of_device *_of_dev, const struct of_device_id *match)
 	 * memory freed
 	 */
 	if (!net_dev) {
-		devm_kfree(&_of_dev->dev, dpa_bp);
+		if (!default_pool)
+			devm_kfree(&_of_dev->dev, dpa_bp);
 		devm_kfree(&_of_dev->dev, rxdefault);
 		devm_kfree(&_of_dev->dev, rxerror);
 		devm_kfree(&_of_dev->dev, txdefault);
-- 
1.7.0.4

