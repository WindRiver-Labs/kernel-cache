From 20f4347be4c1021b28b54fe5c153114e694df8c5 Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Fri, 10 Sep 2010 10:39:10 +0800
Subject: [PATCH 183/252] crypto: caam/algapi: rev.2 h/w: add ECN field in DPOVRD register

Patch taken from FSL vendor SDK 2.1.

reduce ip_hdr_len type to a byte to allow the new ECN
field specification.

The OVRD bit (a.k.a USE bit) consequently belongs in
the new ECN byte's space.

Signed-off-by: Kim Phillips <kim.phillips@freescale.com>
Integrated-by: Andrew Liu <shengping.liu@windriver.com>
---
 drivers/crypto/caam/algapi.c |   12 +++++++-----
 1 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/drivers/crypto/caam/algapi.c b/drivers/crypto/caam/algapi.c
index 9abbbb0..99f6e53 100644
--- a/drivers/crypto/caam/algapi.c
+++ b/drivers/crypto/caam/algapi.c
@@ -111,8 +111,9 @@ struct caam_ctx {
  * IPSec ESP Datapath Protocol Override Register (DPOVRD)
  */
 struct ipsec_deco_dpovrd {
-#define IPSEC_ENCAP_DECO_DPOVRD_USE cpu_to_be16(0x8000)
-	__be16 ip_hdr_len;
+#define IPSEC_ENCAP_DECO_DPOVRD_USE 0x80
+	u8 ovrd_ecn;
+	u8 ip_hdr_len;
 	u8 nh_offset;
 	u8 next_header;	/* reserved if decap */
 } __packed;
@@ -164,7 +165,7 @@ static int build_protocol_desc_ipsec_decap(struct caam_ctx *ctx,
 	}
 
 	/* ip hdr len currently fixed */
-	sh_desc->ip_hdr_len = cpu_to_be16(sizeof(struct iphdr));
+	sh_desc->ip_hdr_len = sizeof(struct iphdr);
 
 	/* we don't have a next hdr offset */
 	sh_desc->ip_nh_offset = 0;
@@ -296,7 +297,8 @@ static int build_protocol_desc_ipsec_encap(struct caam_ctx *ctx,
 	memcpy(&sh_desc->cbc.iv, "myivmyivmyivmyiv", sizeof(sh_desc->cbc.iv));
 #endif
 
-	/* indicate no IP header,
+	/*
+	 * indicate no IP header,
 	 * rather a jump instruction and key specification follow
 	 */
 	sh_desc->ip_hdr_len = 0;
@@ -954,7 +956,7 @@ static int ipsec_esp(struct ipsec_esp_edesc *edesc, struct aead_request *areq,
 	if ((direction == DIR_ENCAP) &&
 	    (!(ctx->shared_desc[1] & PDBOPTS_ESPCBC_TUNNEL))) {
 		/* insert the LOAD command */
-		dpovrd.ip_hdr_len |= IPSEC_ENCAP_DECO_DPOVRD_USE;
+		dpovrd.ovrd_ecn = IPSEC_ENCAP_DECO_DPOVRD_USE;
 		/* DECO class, no s-g, 7 == DPROVRD, 0 offset */
 		descptr = cmd_insert_load(descptr, &dpovrd, LDST_CLASS_DECO,
 					  0, 0x07 << 16, 0, sizeof(dpovrd),
-- 
1.6.5.2

