From e5ae51c2cbea13d61fa8499babedae4609563ae0 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 19 Oct 2010 13:19:35 +0800
Subject: [PATCH 195/252] bman: drain all the buffer pools before booting the dump kernel

In kdump we can't invoke the device_shutdown function as we do
in kexec. So we just forcibly drain all the buffer pools before
booting the dump kernel.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/hwalloc/bman_config.c |   28 ++++++++++++++++++++++++++++
 drivers/hwalloc/bman_sys.h    |    1 +
 2 files changed, 29 insertions(+), 0 deletions(-)

diff --git a/drivers/hwalloc/bman_config.c b/drivers/hwalloc/bman_config.c
index 12236dd..5ad4ecc 100644
--- a/drivers/hwalloc/bman_config.c
+++ b/drivers/hwalloc/bman_config.c
@@ -304,6 +304,30 @@ int bm_pool_set(u32 bpid, const u32 *thresholds)
 }
 EXPORT_SYMBOL(bm_pool_set);
 
+#ifdef CONFIG_KEXEC
+static void bman_drain_all_pool(void)
+{
+	int i;
+
+	for (i = 0; i < 64; i++) {
+		int ret;
+		struct bman_pool *p;
+		struct bman_pool_params tmp;
+		struct bm_buffer buf;
+
+		memset(&tmp, 0, sizeof(tmp));
+		tmp.bpid = i;
+		p = bman_new_pool(&tmp);
+
+		do {
+			ret = bman_acquire(p, &buf, 1, 0);
+		} while (ret > 0);
+
+		bman_free_pool(p);
+	}
+}
+#endif
+
 __init void bman_init_early(void)
 {
 	struct device_node *dn;
@@ -316,5 +340,9 @@ __init void bman_init_early(void)
 			BUG_ON(ret);
 		}
 	}
+
+#ifdef CONFIG_KEXEC
+	crash_shutdown_register(&bman_drain_all_pool);
+#endif
 }
 
diff --git a/drivers/hwalloc/bman_sys.h b/drivers/hwalloc/bman_sys.h
index 8ec71d1..d81d703 100644
--- a/drivers/hwalloc/bman_sys.h
+++ b/drivers/hwalloc/bman_sys.h
@@ -49,6 +49,7 @@
 #include <linux/ioctl.h>
 #include <linux/miscdevice.h>
 #include <linux/uaccess.h>
+#include <asm/kexec.h>
 
 /* CONFIG_FSL_BMAN_HAVE_POLL is defined via Kconfig, because the API header is
  * conditional upon it. CONFIG_FSL_BMAN_CHECKING is also defined via Kconfig,
-- 
1.6.5.2

