From 928ae84d1ec83bfb18ded414d54c020cad99a3bd Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Wed, 29 Jun 2011 13:49:34 +0800
Subject: [PATCH 200/233] bman: drain all the buffer pools before booting the dump kernel

In kdump we can't invoke the device_shutdown function as we do
in kexec. So we just forcibly drain all the buffer pools before
booting the dump kernel.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
[rebase it onto QorIQ-DPAA-SDK-V1-20110609-systembuilder.iso]
Integrated-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 drivers/staging/fsl_qbman/bman_config.c |   28 ++++++++++++++++++++++++++++
 drivers/staging/fsl_qbman/dpa_sys.h     |    1 +
 2 files changed, 29 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_qbman/bman_config.c b/drivers/staging/fsl_qbman/bman_config.c
index 6808236..c4e0f81 100644
--- a/drivers/staging/fsl_qbman/bman_config.c
+++ b/drivers/staging/fsl_qbman/bman_config.c
@@ -368,6 +368,30 @@ int bm_pool_set(u32 bpid, const u32 *thresholds)
 }
 EXPORT_SYMBOL(bm_pool_set);
 
+#ifdef CONFIG_KEXEC
+static void bman_drain_all_pool(void)
+{
+	int i;
+
+	for (i = 0; i < 64; i++) {
+		int ret;
+		struct bman_pool *p;
+		struct bman_pool_params tmp;
+		struct bm_buffer buf;
+
+		memset(&tmp, 0, sizeof(tmp));
+		tmp.bpid = i;
+		p = bman_new_pool(&tmp);
+
+		do {
+			ret = bman_acquire(p, &buf, 1, 0);
+		} while (ret > 0);
+
+		bman_free_pool(p);
+	}
+}
+#endif
+
 __init void bman_init_early(void)
 {
 	struct device_node *dn;
@@ -380,6 +404,10 @@ __init void bman_init_early(void)
 			BUG_ON(ret);
 		}
 	}
+
+#ifdef CONFIG_KEXEC
+	crash_shutdown_register(&bman_drain_all_pool);
+#endif
 }
 
 static void log_edata_bits(u32 bit_count)
diff --git a/drivers/staging/fsl_qbman/dpa_sys.h b/drivers/staging/fsl_qbman/dpa_sys.h
index 21dd2be..97f053a 100644
--- a/drivers/staging/fsl_qbman/dpa_sys.h
+++ b/drivers/staging/fsl_qbman/dpa_sys.h
@@ -55,6 +55,7 @@
 #include <asm/smp.h>
 #include <sysdev/fsl_soc.h>
 #include <linux/vmalloc.h>
+#include <asm/kexec.h>
 #ifdef CONFIG_WRHV
 #include <vbi/vbi.h>
 #endif
-- 
1.7.0.4

