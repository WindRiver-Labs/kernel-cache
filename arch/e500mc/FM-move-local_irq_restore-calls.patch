From ec490c4d7e6b0a8bf2aa05344e535cacef1bf793 Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Wed, 11 Aug 2010 16:56:26 +0800
Subject: [PATCH 175/252] FM: move local_irq_restore() calls

Move local_irq_restore() calls to avoid doing kfree()
with irq disabled.

Signed-off-by: Daniel Stenberg <daniel.stenberg@windriver.com>
Integrated-by: Andrew Liu <shengping.liu@windriver.com>
---
 .../kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c |   10 +++++-----
 1 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c b/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c
index 7f31cd7..7020e00 100644
--- a/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c
+++ b/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c
@@ -157,8 +157,8 @@ static int fm_proc_dump_stats(char *buffer, char **start, off_t offset,
                     );
 
     numOfWrittenChars = ProcBuff_GetNumOfWrittenChars(h_ProcBuff);
-    ProcBuff_Free(h_ProcBuff);
     local_irq_restore(flags);
+    ProcBuff_Free(h_ProcBuff);
 
     return numOfWrittenChars;
 }
@@ -233,8 +233,8 @@ static int fm_pcd_proc_dump_stats(char *buffer, char **start, off_t offset,
                     );
 
     numOfWrittenChars = ProcBuff_GetNumOfWrittenChars(h_ProcBuff);
-    ProcBuff_Free(h_ProcBuff);
     local_irq_restore(flags);
+    ProcBuff_Free(h_ProcBuff);
 
     return numOfWrittenChars;
 }
@@ -407,8 +407,8 @@ static int fm_proc_dump_regs(char *buffer, char **start, off_t offset,
     local_irq_save(flags);
     ProcBuff_Write (h_ProcBuff, "Debug level is too low to dump registers!!!\n");
     numOfWrittenChars = ProcBuff_GetNumOfWrittenChars(h_ProcBuff);
-    ProcBuff_Free(h_ProcBuff);
     local_irq_restore(flags);
+    ProcBuff_Free(h_ProcBuff);
 
     return numOfWrittenChars;
 #endif /* (defined(DEBUG_ERRORS) && ... */
@@ -447,8 +447,8 @@ static int fm_pcd_proc_dump_regs(char *buffer, char **start, off_t offset,
     local_irq_save(flags);
     ProcBuff_Write (h_ProcBuff, "Debug level is too low to dump registers!!!\n");
     numOfWrittenChars = ProcBuff_GetNumOfWrittenChars(h_ProcBuff);
-    ProcBuff_Free(h_ProcBuff);
     local_irq_restore(flags);
+    ProcBuff_Free(h_ProcBuff);
 
     return numOfWrittenChars;
 #endif /* (defined(DEBUG_ERRORS) && ... */
@@ -487,8 +487,8 @@ static int fm_port_proc_dump_regs(char *buffer, char **start, off_t offset,
     local_irq_save(flags);
     ProcBuff_Write (h_ProcBuff, "Debug level is too low to dump registers!!!\n");
     numOfWrittenChars = ProcBuff_GetNumOfWrittenChars(h_ProcBuff);
-    ProcBuff_Free(h_ProcBuff);
     local_irq_restore(flags);
+    ProcBuff_Free(h_ProcBuff);
 
     return numOfWrittenChars;
 #endif /* (defined(DEBUG_ERRORS) && ... */
-- 
1.6.5.2

