From 2111a165c0c8d5e13a33851436c3edcf33071a27 Mon Sep 17 00:00:00 2001
From: Varun Sethi <Varun.Sethi@freescale.com>
Date: Wed, 8 Apr 2015 22:59:03 +0530
Subject: [PATCH 106/132] Add support for IOMMU_MMIO flag.

This flag should be used for setting up access to device memory.

Signed-off-by: Varun Sethi <Varun.Sethi@freescale.com>
Change-Id: Ifc8947c274a260c101a37a29a1795231e9a578ab
Reviewed-on: http://git.am.freescale.net:8181/34634
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Stuart Yoder <stuart.yoder@freescale.com>
[Original patch from FSL LS2085 SDK EAR4.0]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/iommu/io-pgtable-arm.c |    5 +++++
 include/linux/iommu.h          |    1 +
 2 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/drivers/iommu/io-pgtable-arm.c b/drivers/iommu/io-pgtable-arm.c
index 5a500ed..6f987fd 100644
--- a/drivers/iommu/io-pgtable-arm.c
+++ b/drivers/iommu/io-pgtable-arm.c
@@ -283,6 +283,9 @@ static arm_lpae_iopte arm_lpae_prot_to_pte(struct arm_lpae_io_pgtable *data,
 		if (prot & IOMMU_CACHE)
 			pte |= (ARM_LPAE_MAIR_ATTR_IDX_CACHE
 				<< ARM_LPAE_PTE_ATTRINDX_SHIFT);
+		else if (prot & IOMMU_MMIO)
+			pte |= (ARM_LPAE_MAIR_ATTR_IDX_DEV
+				<< ARM_LPAE_PTE_ATTRINDX_SHIFT);
 	} else {
 		pte = ARM_LPAE_PTE_HAP_FAULT;
 		if (prot & IOMMU_READ)
@@ -291,6 +294,8 @@ static arm_lpae_iopte arm_lpae_prot_to_pte(struct arm_lpae_io_pgtable *data,
 			pte |= ARM_LPAE_PTE_HAP_WRITE;
 		if (prot & IOMMU_CACHE)
 			pte |= ARM_LPAE_PTE_MEMATTR_OIWB;
+		else if (prot & IOMMU_MMIO)
+			pte |= ARM_LPAE_PTE_MEMATTR_DEV;
 		else
 			pte |= ARM_LPAE_PTE_MEMATTR_NC;
 	}
diff --git a/include/linux/iommu.h b/include/linux/iommu.h
index 20f9a52..f5261fe 100644
--- a/include/linux/iommu.h
+++ b/include/linux/iommu.h
@@ -28,6 +28,7 @@
 #define IOMMU_WRITE	(1 << 1)
 #define IOMMU_CACHE	(1 << 2) /* DMA cache coherency */
 #define IOMMU_EXEC	(1 << 3)
+#define IOMMU_MMIO	(1 << 4) /* Device memory access */
 
 struct iommu_ops;
 struct iommu_group;
-- 
1.7.5.4

