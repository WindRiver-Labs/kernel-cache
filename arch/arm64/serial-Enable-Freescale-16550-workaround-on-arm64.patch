From 1eb229da643cf0495d378c68964ffb805301337f Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Wed, 4 Feb 2015 13:57:32 -0600
Subject: [PATCH 029/132] serial: Enable Freescale 16550 workaround on arm64

The same serial hardware is present on LS2085A which is arm64, so don't
limit the workaround to PPC.

Signed-off-by: Scott Wood <scottwood@freescale.com>
Signed-off-by: Bhupesh Sharma <bhupesh.sharma@freescale.com>
Change-Id: Ib715bf98342b7565e77872560fda9f916ed368e6
Reviewed-on: http://git.am.freescale.net:8181/30155
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
(cherry picked from commit 9ae66af1dad493f3da4619959b7f54634a8458da)
[Original patch from FSL LS2085 SDK EAR4.0]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/tty/serial/8250/Kconfig |    4 ++--
 drivers/tty/serial/of_serial.c  |    5 +++++
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/drivers/tty/serial/8250/Kconfig b/drivers/tty/serial/8250/Kconfig
index 7f96b50..a1c10b3 100644
--- a/drivers/tty/serial/8250/Kconfig
+++ b/drivers/tty/serial/8250/Kconfig
@@ -278,8 +278,8 @@ config SERIAL_8250_ACORN
 
 config SERIAL_8250_FSL
 	bool
-	depends on SERIAL_8250_CONSOLE && PPC_UDBG_16550
-	default PPC
+	depends on SERIAL_8250_CONSOLE
+	default PPC || ARM64
 
 config SERIAL_8250_DW
 	tristate "Support for Synopsys DesignWare 8250 quirks"
diff --git a/drivers/tty/serial/of_serial.c b/drivers/tty/serial/of_serial.c
index 9924660..4c25ba2 100644
--- a/drivers/tty/serial/of_serial.c
+++ b/drivers/tty/serial/of_serial.c
@@ -132,6 +132,11 @@ static int of_platform_serial_setup(struct platform_device *ofdev,
 	if (type == PORT_TEGRA)
 		port->handle_break = tegra_serial_handle_break;
 
+#ifdef CONFIG_SERIAL_8250_FSL
+	if (of_device_is_compatible(np, "fsl,ns16550"))
+		port->handle_irq = fsl8250_handle_irq;
+#endif
+
 	return 0;
 out:
 	if (info->clk)
-- 
1.7.5.4

