From d9e7a3f6b84c6ce5a7535ae8d3d2da3f4bb89594 Mon Sep 17 00:00:00 2001
From: Yijing Wang <wangyijing@huawei.com>
Date: Tue, 8 Jul 2014 10:08:55 +0800
Subject: [PATCH 069/132] PCI/MSI: Retrieve first MSI IRQ from msi_desc rather
 than pci_dev

commit a281b788d6070526c63b7bbc43dcbe5906d3f487 upstream

Retrieve the first MSI IRQ to compute the MSI index from struct msi_desc
rather than the struct pci_dev to avoid an additional memory access.

Signed-off-by: Yijing Wang <wangyijing@huawei.com>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
[WRL already has a different base, so this patch
 is not same as upstream.]
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/pci/msi.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/pci/msi.c b/drivers/pci/msi.c
index bb4afb8..d22bf45 100644
--- a/drivers/pci/msi.c
+++ b/drivers/pci/msi.c
@@ -289,7 +289,7 @@ static void msi_set_mask_bit(struct irq_data *data, u32 flag)
 		msix_mask_irq(desc, flag);
 		readl(desc->mask_base);		/* Flush write to device */
 	} else {
-		unsigned offset = data->irq - desc->dev->irq;
+		unsigned offset = data->irq - desc->irq;
 		msi_mask_irq(desc, 1 << offset, flag << offset);
 	}
 }
-- 
1.7.5.4

