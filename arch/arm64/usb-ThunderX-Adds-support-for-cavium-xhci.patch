From d4cf3a7b84b51b093dc7a74842e166bd236ad683 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Thu, 2 Jul 2015 07:10:00 +0000
Subject: [PATCH 20/23] usb:ThunderX:Adds support for cavium xhci

Register PCI device ID for Cavium ThunderX xhci controller.
Extracted from ThunderX-SDK pre-release 0.4.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/usb/host/xhci-pci.c |    1 +
 drivers/usb/host/xhci.c     |    4 ++++
 2 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/host/xhci-pci.c b/drivers/usb/host/xhci-pci.c
index 73c43e5..a7c4276 100644
--- a/drivers/usb/host/xhci-pci.c
+++ b/drivers/usb/host/xhci-pci.c
@@ -384,6 +384,7 @@ static const struct hc_driver xhci_pci_hc_driver = {
 static const struct pci_device_id pci_ids[] = { {
 	/* handle any USB 3.0 xHCI controller */
 	PCI_DEVICE_CLASS(PCI_CLASS_SERIAL_USB_XHCI, ~0),
+	PCI_DEVICE(PCI_VENDOR_ID_CAVIUM, 0xa01b),
 	.driver_data =	(unsigned long) &xhci_pci_hc_driver,
 	},
 	{ /* end: all zeroes */ }
diff --git a/drivers/usb/host/xhci.c b/drivers/usb/host/xhci.c
index ec2f700..64c9d67 100644
--- a/drivers/usb/host/xhci.c
+++ b/drivers/usb/host/xhci.c
@@ -280,6 +280,10 @@ static int xhci_setup_msix(struct xhci_hcd *xhci)
 	xhci->msix_count = min(num_online_cpus() + 1,
 				HCS_MAX_INTRS(xhci->hcs_params1));
 
+	/* Errata 23238 */
+	if(pdev->vendor == PCI_VENDOR_ID_CAVIUM)
+		xhci->msix_count = pci_msix_vec_count(pdev);
+
 	xhci->msix_entries =
 		kmalloc((sizeof(struct msix_entry))*xhci->msix_count,
 				GFP_KERNEL);
-- 
1.7.5.4

