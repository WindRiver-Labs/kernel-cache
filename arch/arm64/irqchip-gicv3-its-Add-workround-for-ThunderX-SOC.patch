From 63f7ef8c5ba981dc3d28576f97f8b01431cc2daf Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Wed, 15 Jul 2015 08:27:13 +0000
Subject: [PATCH 18/23] irqchip/gicv3-its:Add workround for ThunderX SOC.

Add workround for ThunderX SOC.
Extracted from ThunderX-SDK pre-release 0.4.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/irqchip/irq-gic-v3-its.c |   13 +++++++++++++
 1 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/drivers/irqchip/irq-gic-v3-its.c b/drivers/irqchip/irq-gic-v3-its.c
index 39b7676..edc78e2 100644
--- a/drivers/irqchip/irq-gic-v3-its.c
+++ b/drivers/irqchip/irq-gic-v3-its.c
@@ -944,8 +944,13 @@ static int its_alloc_tables(struct its_node *its)
 		if (type == GITS_BASER_TYPE_DEVICE) {
 			u64 typer = readq_relaxed(its->base + GITS_TYPER);
 			u32 ids = GITS_TYPER_DEVBITS(typer);
+#ifdef CONFIG_ARCH_THUNDER
+			u32 ittsize = ((typer >> 4) & 0xf) + 1;
 
+			order = get_order((1UL << ids) * ittsize);
+#else
 			order = get_order((1UL << ids) * entry_size);
+#endif
 		}
 
 		alloc_size = (1 << order) * PAGE_SIZE;
@@ -1009,6 +1014,14 @@ retry_baser:
 			}
 		}
 
+#ifdef CONFIG_ARCH_THUNDER
+        /* skip comparing cacheability feilds as they are implemenations
+         * defined.
+         */
+		val = val << 5;
+		tmp = tmp << 5;
+#endif
+
 		if (val != tmp) {
 			pr_err("ITS: %s: GITS_BASER%d doesn't stick: %lx %lx\n",
 			       its->msi_chip.of_node->full_name, i,
-- 
1.7.5.4

