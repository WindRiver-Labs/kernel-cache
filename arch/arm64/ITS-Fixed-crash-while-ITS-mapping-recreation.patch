From 316553c93bf526a9669bd0bd714fb11d91bf893a Mon Sep 17 00:00:00 2001
From: Sunil Goutham <sgoutham@cavium.com>
Date: Wed, 4 Jun 2014 12:52:18 +0530
Subject: [PATCH 172/430] ITS: Fixed crash while ITS mapping recreation

The commit comes from
  git://git.kernel.org/pub/scm/linux/kernel/git/rric/linux.git

Issue: When MSI-X interrupts are teared down ITS device is freed, but not removed
from the list. Due to this when ITS is asked to recreate the MSI-X irq mapping
ITS device is not created again and uses the freed one itself. This is resulting
in crash.

Signed-off-by: Sunil Goutham <sgoutham@cavium.com>
Signed-off-by: Robert Richter <rrichter@cavium.com>
(cherry picked from commit e106c89e86f5decc6655f6f3a2e8d8682b1e4be0)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/irqchip/irq-gic-v3-its.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/irqchip/irq-gic-v3-its.c b/drivers/irqchip/irq-gic-v3-its.c
index aa3144f..aba080f 100644
--- a/drivers/irqchip/irq-gic-v3-its.c
+++ b/drivers/irqchip/irq-gic-v3-its.c
@@ -1162,6 +1162,7 @@ static void its_msi_teardown_irq(struct msi_chip *chip, unsigned int irq)
 	if (list_empty(&its_dev->hwirq_list)) {
 		/* Unmap device/itt */
 		its_send_mapd(its_dev, 0);
+		list_del(&its_dev->entry);
 		its_free_device(its_dev);
 	}
 }
-- 
1.7.5.4

