From 100c5164490e48a6ab3ecc6dc84a9c4cfecdf8d0 Mon Sep 17 00:00:00 2001
From: Bruce Ashfield <bruce.ashfield@windriver.com>
Date: Fri, 28 May 2010 15:55:06 -0400
Subject: [PATCH 05/15] ck: make swap token active only when swap is more than half full

The swap token is only useful in conditions of swap thrash, and actually
worsens the common case by causing more swapping. Make it only have an effect
when swap is more than half full.

-ck

Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 include/linux/swap.h |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/include/linux/swap.h b/include/linux/swap.h
index 0eb9dfc..c58a460 100644
--- a/include/linux/swap.h
+++ b/include/linux/swap.h
@@ -337,9 +337,10 @@ extern struct mm_struct *swap_token_mm;
 extern void grab_swap_token(struct mm_struct *);
 extern void __put_swap_token(struct mm_struct *);
 
+/* Only allow swap token to have effect if swap is full */
 static inline int has_swap_token(struct mm_struct *mm)
 {
-	return (mm == swap_token_mm);
+	return (mm == swap_token_mm && vm_swap_full());
 }
 
 static inline void put_swap_token(struct mm_struct *mm)
-- 
1.6.5.2

