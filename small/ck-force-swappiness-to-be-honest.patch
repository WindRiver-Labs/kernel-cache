From 7950d8a9f8d4f847d83066243882e23994742274 Mon Sep 17 00:00:00 2001
From: Bruce Ashfield <bruce.ashfield@windriver.com>
Date: Fri, 28 May 2010 15:52:22 -0400
Subject: [PATCH 03/15] ck: force swappiness to be honest

Swappiness the tunable lies. It doesn't respect swappiness because it alters
the value when we're more than lightly loaded in the vm. Change it to -really-
mean swappiness unless we're about to go out of memory.

-ck

Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 mm/vmscan.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/mm/vmscan.c b/mm/vmscan.c
index 3ff3311..913516c 100644
--- a/mm/vmscan.c
+++ b/mm/vmscan.c
@@ -1633,6 +1633,7 @@ static void shrink_zone(int priority, struct zone *zone,
 	unsigned long nr_to_reclaim = sc->nr_to_reclaim;
 	struct zone_reclaim_stat *reclaim_stat = get_reclaim_stat(zone, sc);
 	int noswap = 0;
+	int tmp_priority;
 
 	/* If we have no swap space, do not bother scanning anon pages. */
 	if (!sc->may_swap || (nr_swap_pages <= 0)) {
@@ -1648,7 +1649,11 @@ static void shrink_zone(int priority, struct zone *zone,
 
 		scan = zone_nr_lru_pages(zone, sc, l);
 		if (priority || noswap) {
-			scan >>= priority;
+			tmp_priority = priority;
+
+			if (file && priority > 0)
+				tmp_priority = DEF_PRIORITY;
+			scan >>= tmp_priority;
 			scan = (scan * percent[file]) / 100;
 		}
 		nr[l] = nr_scan_try_batch(scan,
-- 
1.6.5.2

