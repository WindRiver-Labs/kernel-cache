From 1d469561ade27aa1a8ab9ca794b28ebc88241ed3 Mon Sep 17 00:00:00 2001
From: Hong H. Pham <hong.pham@windriver.com>
Date: Wed, 5 Nov 2008 11:41:38 -0500
Subject: [PATCH] SPARC64 save FPU state for VIS emulation

Copy the FPU state to the task's thread_info->fpregs for the VIS emulation
functions to access.

Signed-off-by: Hong H. Pham <hong.pham@windriver.com>
---
 arch/sparc64/kernel/visemul.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/arch/sparc64/kernel/visemul.c b/arch/sparc64/kernel/visemul.c
index 4e285f9..a4428fd 100644
--- a/arch/sparc64/kernel/visemul.c
+++ b/arch/sparc64/kernel/visemul.c
@@ -802,16 +802,18 @@ int vis_emul(struct pt_regs *regs, unsigned int insn)
 	BUG_ON(regs->tstate & TSTATE_PRIV);
 
 	if (test_thread_flag(TIF_32BIT))
 		pc = (u32)pc;
 
 	if (get_user(insn, (u32 __user *) pc))
 		return -EFAULT;
 
+	save_and_clear_fpu();
+
 	opf = (insn & VIS_OPF_MASK) >> VIS_OPF_SHIFT;
 	switch (opf) {
 	default:
 		return -EINVAL;
 
 	/* Pixel Formatting Instructions.  */
 	case FPACK16_OPF:
 	case FPACK32_OPF:
-- 
1.5.5.1

