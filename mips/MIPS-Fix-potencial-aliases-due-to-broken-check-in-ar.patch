From ad6df971488ff73d147dd50df724304cb0efe7d5 Mon Sep 17 00:00:00 2001
From: Ralf Baechle <ralf@linux-mips.org>
Date: Sat, 5 Dec 2009 20:19:59 +0000
Subject: [PATCH 113/117] MIPS: Fix potencial aliases due to broken check in arch_get_unmapped_area

commit ad6df971488ff73d147dd50df724304cb0efe7d5 from linux-mips

Noticed by Al Viro <viro@ftp.linux.org.uk>.

Signed-off-by: Ralf Baechle <ralf@linux-mips.org>
(cherry picked from commit 1d8a38bc5ec86a44d1eae863099f51766735d716)
---
 arch/mips/kernel/syscall.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/arch/mips/kernel/syscall.c b/arch/mips/kernel/syscall.c
index e43e843..596f120 100644
--- a/arch/mips/kernel/syscall.c
+++ b/arch/mips/kernel/syscall.c
@@ -92,7 +92,8 @@ unsigned long arch_get_unmapped_area(struct file *filp, unsigned long addr,
 		 * We do not accept a shared mapping if it would violate
 		 * cache aliasing constraints.
 		 */
-		if ((flags & MAP_SHARED) && (addr & shm_align_mask))
+		if ((flags & MAP_SHARED) &&
+		    ((addr - (pgoff << PAGE_SHIFT)) & shm_align_mask))
 			return -EINVAL;
 		return addr;
 	}
-- 
1.7.0

