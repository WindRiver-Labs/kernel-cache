From 161a224876767b538daa6df3121ad06fa8aea403 Mon Sep 17 00:00:00 2001
From: Ralf Baechle <ralf@linux-mips.org>
Date: Sat, 18 Oct 2008 13:23:10 +0100
Subject: [PATCH 005/117] MIPS: SMP: Don't reenable interrupts in stop_this_cpu; use WAIT instruction.

commit 161a224876767b538daa6df3121ad06fa8aea403 from linux-mips

Noticed by Anirban Sinha <ASinha@zeugmasystems.com>; patch by me.

Signed-off-by: Ralf Baechle <ralf@linux-mips.org>
(cherry picked from commit 563392b2a049023639dfb988dfcb228e3f0ed178)
---
 arch/mips/kernel/smp.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/arch/mips/kernel/smp.c b/arch/mips/kernel/smp.c
index 4410f17..6d3d197 100644
--- a/arch/mips/kernel/smp.c
+++ b/arch/mips/kernel/smp.c
@@ -161,8 +161,10 @@ static void stop_this_cpu(void *dummy)
 	 * Remove this CPU:
 	 */
 	cpu_clear(smp_processor_id(), cpu_online_map);
-	local_irq_enable();	/* May need to service _machine_restart IPI */
-	for (;;);		/* Wait if available. */
+	for (;;) {
+		if (cpu_wait)
+			(*cpu_wait)();		/* Wait if available. */
+	}
 }
 
 void smp_send_stop(void)
-- 
1.7.0

