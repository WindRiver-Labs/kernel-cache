From 0d17ba4d9eb4cc3866d325328233261c080f6409 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Tue, 18 May 2010 19:17:56 +0800
Subject: [PATCH] MIPS: Sibyte: Undefine CONFIG_CPU_HAS_PREFETCH to disable prefetch

commit 634286f127bef8799cd04799d3e1d5471e8fd91c changed the condition
of '#undef CONFIG_CPU_HAS_PREFETCH' from !defined(CONFIG_DMA_COHERENT)
|| !defined(CONFIG_DMA_IP27) to CONFIG_DMA_NONCOHERENT. So, actually,
CONFIG_CPU_HAS_PREFETCH is undefined for the most boards except IP27
always before the commit. This commit causes CONFIG_CPU_HAS_PREFETCH
is enabled on Sibyte. But prefetch causes bus error during module
loading, so undefine CONFIG_CPU_HAS_PREFETCH to disable prefetch for
Sibyte.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/lib/memcpy-inatomic.S |    3 +++
 arch/mips/lib/memcpy.S          |    3 +++
 2 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/mips/lib/memcpy-inatomic.S b/arch/mips/lib/memcpy-inatomic.S
index 68853a0..bd75c42 100644
--- a/arch/mips/lib/memcpy-inatomic.S
+++ b/arch/mips/lib/memcpy-inatomic.S
@@ -27,6 +27,9 @@
 #ifdef CONFIG_MIPS_MALTA
 #undef CONFIG_CPU_HAS_PREFETCH
 #endif
+#ifdef CONFIG_SIBYTE_SB1250
+#undef CONFIG_CPU_HAS_PREFETCH
+#endif
 
 #include <asm/asm.h>
 #include <asm/asm-offsets.h>
diff --git a/arch/mips/lib/memcpy.S b/arch/mips/lib/memcpy.S
index 56a1f85..be791ab 100644
--- a/arch/mips/lib/memcpy.S
+++ b/arch/mips/lib/memcpy.S
@@ -27,6 +27,9 @@
 #ifdef CONFIG_MIPS_MALTA
 #undef CONFIG_CPU_HAS_PREFETCH
 #endif
+#ifdef CONFIG_SIBYTE_SB1250
+#undef CONFIG_CPU_HAS_PREFETCH
+#endif
 
 #include <asm/asm.h>
 #include <asm/asm-offsets.h>
-- 
1.6.0.4

