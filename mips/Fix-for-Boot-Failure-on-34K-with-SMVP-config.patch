From 19e3b0258f5e377492ac69e6e01bb8cafac90819 Mon Sep 17 00:00:00 2001
From: Bi Junxiao <Junxiao.Bi@windriver.com>
Date: Thu, 15 Apr 2010 11:32:08 +0800
Subject: [PATCH] Fix for Boot Failure on 34K with SMVP config

commit 5460815027d802697b879644c74f0e8365254020 from
git://www.linux-mips.org/linux-mti.git

Signed-off-by: Raghu Gandham <raghu@mips.com>
[jbi: minor context mods in order to backport to 2.6.27]
Integrated-by: Bi Junxiao <junxiao.bi@windriver.com>
---
 arch/mips/kernel/smp-mt.c  |    7 +++++--
 include/asm-mips/mips_mt.h |    1 +
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/arch/mips/kernel/smp-mt.c b/arch/mips/kernel/smp-mt.c
index 87a1816..97c4509 100644
--- a/arch/mips/kernel/smp-mt.c
+++ b/arch/mips/kernel/smp-mt.c
@@ -36,6 +36,7 @@
 #include <asm/mipsmtregs.h>
 #include <asm/mips_mt.h>
 
+extern int gic_present;
 static void __init smvp_copy_vpe_config(void)
 {
 	write_vpe_c0_status(
@@ -118,6 +119,10 @@ static void vsmp_send_ipi_single(int cpu, unsigned int action)
 	unsigned long flags;
 	int vpflags;
 
+	if (gic_present) {
+		cmp_send_ipi_single(cpu, action);
+		return;
+	}
 	local_irq_save(flags);
 
 	vpflags = dvpe();	/* cant access the other CPU's registers whilst MVPE enabled */
@@ -151,8 +156,6 @@ static void vsmp_send_ipi_mask(cpumask_t mask, unsigned int action)
 
 static void __cpuinit vsmp_init_secondary(void)
 {
-	extern int gic_present;
-
 	/* This is Malta specific: IPI,performance and timer inetrrupts */
 	if (gic_present)
 		change_c0_status(ST0_IM, STATUSF_IP3 | STATUSF_IP4 |
diff --git a/include/asm-mips/mips_mt.h b/include/asm-mips/mips_mt.h
index ac79352..3177c83 100644
--- a/include/asm-mips/mips_mt.h
+++ b/include/asm-mips/mips_mt.h
@@ -19,6 +19,7 @@ extern unsigned long mt_fpemul_threshold;
 
 extern void mips_mt_regdump(unsigned long previous_mvpcontrol_value);
 extern void mips_mt_set_cpuoptions(void);
+extern void cmp_send_ipi_single(int cpu, unsigned int action);
 
 struct class;
 extern struct class *mt_class;
-- 
1.6.0.4

