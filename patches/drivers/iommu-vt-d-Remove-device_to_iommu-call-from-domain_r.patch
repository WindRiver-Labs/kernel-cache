From 7d540f4ac7646f30cf836674e8952a00903d5602 Mon Sep 17 00:00:00 2001
From: David Woodhouse <David.Woodhouse@intel.com>
Date: Sun, 9 Mar 2014 13:33:06 -0700
Subject: [PATCH 035/108] iommu/vt-d: Remove device_to_iommu() call from
 domain_remove_dev_info()

commit 7c7faa11ecf3eec17699ae73fc6e336cbf993081 upstream.

This was problematic because it works by domain/bus/devfn and we want
to make device_to_iommu() use only a struct device * (for handling non-PCI
devices). Now that the iommu pointer is reliably stored in the
device_domain_info, we don't need to look it up.

Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>
Signed-off-by: Liwei Song <liwei.song@windriver.com>
---
 drivers/iommu/intel-iommu.c |    8 +++-----
 1 files changed, 3 insertions(+), 5 deletions(-)

diff --git a/drivers/iommu/intel-iommu.c b/drivers/iommu/intel-iommu.c
index 20d0943..6c11f18 100644
--- a/drivers/iommu/intel-iommu.c
+++ b/drivers/iommu/intel-iommu.c
@@ -2082,7 +2082,6 @@ static void domain_remove_dev_info(struct dmar_domain *domain)
 {
 	struct device_domain_info *info;
 	unsigned long flags, flags2;
-	struct intel_iommu *iommu;
 
 	spin_lock_irqsave(&device_domain_lock, flags);
 	while (!list_empty(&domain->devices)) {
@@ -2092,16 +2091,15 @@ static void domain_remove_dev_info(struct dmar_domain *domain)
 		spin_unlock_irqrestore(&device_domain_lock, flags);
 
 		iommu_disable_dev_iotlb(info);
-		iommu = device_to_iommu(info->segment, info->bus, info->devfn);
-		iommu_detach_dev(iommu, info->bus, info->devfn);
+		iommu_detach_dev(info->iommu, info->bus, info->devfn);
 
 		if (domain->flags & DOMAIN_FLAG_VIRTUAL_MACHINE) {
-			iommu_detach_dependent_devices(iommu, info->dev);
+			iommu_detach_dependent_devices(info->iommu, info->dev);
 			/* clear this iommu in iommu_bmp, update iommu count
 			 * and capabilities
 			 */
 			spin_lock_irqsave(&domain->iommu_lock, flags2);
-			if (test_and_clear_bit(iommu->seq_id,
+			if (test_and_clear_bit(info->iommu->seq_id,
 					       domain->iommu_bmp)) {
 				domain->iommu_count--;
 				domain_update_iommu_cap(domain);
-- 
1.7.5.4

