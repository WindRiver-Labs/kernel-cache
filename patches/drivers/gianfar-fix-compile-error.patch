From 220dcb11a5868f79a21810005cd3b1e0988b87bb Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Tue, 9 Aug 2011 19:23:28 +0800
Subject: [PATCH 46/47] gianfar: fix compile error

Below compile error happens when building gianfar:
linux/drivers/net/gianfar.c: In function 'get_cpu_number':
linux/drivers/net/gianfar.c:1159: warning: assignment from incompatible pointer type
linux/drivers/net/gianfar.c:1178: error: dereferencing pointer to incomplete type
linux/drivers/net/gianfar.c:1182: error: dereferencing pointer to incomplete type
linux/drivers/net/gianfar.c: In function 'gfar_probe':
drivers/net/gianfar.c:1230: warning: unused variable 'j'
drivers/net/gianfar.c: In function 'gfar_tx_checksum':
drivers/net/gianfar.c:2687: error: 'IP_MF' undeclared (first use in this function)
drivers/net/gianfar.c:2687: error: (Each undeclared identifier is reported only once
drivers/net/gianfar.c:2687: error: for each function it appears in.)
drivers/net/gianfar.c:2687: error: 'IP_OFFSET' undeclared (first use in this function)
drivers/net/gianfar.c: In function 'gfar_clean_tx_ring':
drivers/net/gianfar.c:3462: error: 'nr_txbds' undeclared (first use in this function)

Fix this problem by:
1. add header file net/ip.h.
2. remove useless variable 'j'.
3. add the missed chang by replace nr_txbds with frags.

Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/net/gianfar.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 32b445e..cde45c0 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -82,6 +82,7 @@
 #include <linux/tcp.h>
 #include <linux/udp.h>
 #include <linux/in.h>
+#include <net/ip.h>
 #include <linux/inetdevice.h>
 #include <sysdev/fsl_soc.h>
 
@@ -3404,7 +3405,7 @@ static int gfar_clean_tx_ring(struct gfar_priv_tx_q *tx_queue)
 		tx_queue->num_txbdfree += frags + 1;
 		spin_unlock_irqrestore(&tx_queue->txlock, flags);
 #else
-		tx_queue->num_txbdfree += nr_txbds;
+		tx_queue->num_txbdfree += frags + 1;
 #endif
 	}
 
-- 
1.7.0.2

