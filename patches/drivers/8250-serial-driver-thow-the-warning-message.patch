From 03ab1b3458dbbf81f332c742233d7d95d1a24209 Mon Sep 17 00:00:00 2001
From: Yongli He <yongli.he@windriver.com>
Date: Thu, 22 Jul 2010 22:28:08 +0800
Subject: [PATCH] 8250 serial driver thow the warning message

enagle_irq should and could put out of the spin_lock_irqsave/restore.
then if CONFIG_HARDIRQS_SW_RESEND been set, no warning  complain
about eanble bh when irq disabled.

Signed-off-by: Yongli He <yongli.he@windriver.com>
---
 drivers/serial/8250.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/drivers/serial/8250.c b/drivers/serial/8250.c
index bc95256..2372db1 100644
--- a/drivers/serial/8250.c
+++ b/drivers/serial/8250.c
@@ -1917,11 +1917,16 @@ static int serial8250_startup(struct uart_port *port)
 		udelay(1); /* allow a working UART time to re-assert THRE */
 		iir = serial_in(up, UART_IIR);
 		serial_out(up, UART_IER, 0);
-
+#ifndef CONFIG_HARDIRQS_SW_RESEND		
 		if (up->port.flags & UPF_SHARE_IRQ)
 			enable_irq(up->port.irq);
+#endif 		
 		spin_unlock_irqrestore(&up->port.lock, flags);
 
+#ifdef CONFIG_HARDIRQS_SW_RESEND		
+		if (up->port.flags & UPF_SHARE_IRQ)
+			enable_irq(up->port.irq);
+#endif 		
 		/*
 		 * If the interrupt is not reasserted, setup a timer to
 		 * kick the UART on a regular basis.
-- 
1.7.0.4

