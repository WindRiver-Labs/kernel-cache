From 812760e978ff9edb6abe67434ab4b5c90aae372b Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Wed, 28 Jan 2015 13:12:34 -0500
Subject: [PATCH 1/2] intel-iommu: rewrite RMRR detection to be readable

The original code was confusing because it triggered on a
non match, and it wasn't easily extensible to add in more
devices with RMRR issues.

Rewrite it in a way that is equivalent, but allows more
devices to be listed and instrumentation to be added.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
Signed-off-by: Yunguo Wei <yunguo.wei@windriver.com>
---
 drivers/iommu/intel-iommu.c |   12 +++++++++---
 1 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/drivers/iommu/intel-iommu.c b/drivers/iommu/intel-iommu.c
index 6ca5845..8fb2ab0 100644
--- a/drivers/iommu/intel-iommu.c
+++ b/drivers/iommu/intel-iommu.c
@@ -2362,9 +2362,15 @@ static int iommu_should_identity_map(struct pci_dev *pdev, int startup)
 	 * from this process due to their usage of RMRRs that are known
 	 * to not be needed after BIOS hand-off to OS.
 	 */
-	if (device_has_rmrr(pdev) &&
-	    (pdev->class >> 8) != PCI_CLASS_SERIAL_USB)
-		return 0;
+	if (device_has_rmrr(pdev)) {
+		int match = 0;
+
+		if ((pdev->class >> 8) == PCI_CLASS_SERIAL_USB)
+			match = 1;
+
+		if (!match)
+			return 0;
+	}
 
 	if ((iommu_identity_mapping & IDENTMAP_AZALIA) && IS_AZALIA(pdev))
 		return 1;
-- 
1.7.5.4

