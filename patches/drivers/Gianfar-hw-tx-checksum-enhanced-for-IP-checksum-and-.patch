From 6c5141f0addda864103813a11bb3eda5fb985c26 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Tue, 9 Aug 2011 19:23:18 +0800
Subject: [PATCH 36/47] Gianfar: hw tx checksum enhanced for IP checksum and non psudo TCP/UDP checksum

tx_gfar_checksum does not configure h/w to calculate the IP checksum and
TCP/UDP checksum for packets without psudo checksum done in s/w.
This function is enhanced to
1). Configure h/w for IP checksum for fragmented packets and
    non-TCP/UDP packets.
2). Perform the L4 TCP/UDP checksum for cases where s/w does not
    provide the psudo header checksum.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
0032-Gianfar-hw-tx-checksum-enhanced-for-IP-checksum-and-.patch.

Signed-off-by: Rajan Gupta <rajan.gupta@freescale.com>
Signed-off-by: K Muralidhar <murali.k@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/net/gianfar.c |   21 ++++++++++++++++-----
 drivers/net/gianfar.h |    2 +-
 2 files changed, 17 insertions(+), 6 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 4e1986c..14387cb 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -2608,11 +2608,22 @@ static inline void gfar_tx_checksum(struct sk_buff *skb, struct txfcb *fcb)
 
 	/* Tell the controller what the protocol is */
 	/* And provide the already calculated phcs */
-	if (ip_hdr(skb)->protocol == IPPROTO_UDP) {
-		flags |= TXFCB_UDP;
-		fcb->phcs = udp_hdr(skb)->check;
-	} else
-		fcb->phcs = tcp_hdr(skb)->check;
+	if (!((ip_hdr(skb)->frag_off) & htons(IP_MF|IP_OFFSET))) {
+		/* If not fragmented packet */
+		if (ip_hdr(skb)->protocol == IPPROTO_UDP) {
+			if (udp_hdr(skb)->check) {
+				fcb->phcs = udp_hdr(skb)->check;
+				flags |= TXFCB_NPH;
+			}
+			flags |= TXFCB_UDP | TXFCB_TUP | TXFCB_CTU;
+		} else if (ip_hdr(skb)->protocol == IPPROTO_TCP) {
+			if (tcp_hdr(skb)->check) {
+				flags |= TXFCB_NPH;
+				fcb->phcs = tcp_hdr(skb)->check;
+			}
+			flags |= TXFCB_TUP | TXFCB_CTU;
+		}
+	}
 
 	/* l3os is the distance between the start of the
 	 * frame (skb->data) and the start of the IP hdr.
diff --git a/drivers/net/gianfar.h b/drivers/net/gianfar.h
index bf51f21..c98e804 100644
--- a/drivers/net/gianfar.h
+++ b/drivers/net/gianfar.h
@@ -595,7 +595,7 @@ static inline int devfp_register_tx_hook(devfp_hook_t hook)
 #define TXFCB_CIP		0x04
 #define TXFCB_CTU		0x02
 #define TXFCB_NPH		0x01
-#define TXFCB_DEFAULT 		(TXFCB_IP|TXFCB_TUP|TXFCB_CTU|TXFCB_NPH)
+#define TXFCB_DEFAULT		(TXFCB_IP|TXFCB_CIP)
 
 /* RxBD status field bits */
 #define RXBD_EMPTY		0x8000
-- 
1.7.0.2

