From 38a3012eedfc051e0190ef544995b44d3dcaa27b Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Tue, 9 Aug 2011 19:22:48 +0800
Subject: [PATCH 06/47] gianfar: Some minor bug fixes with filer programming

1. Filer should be enabled when num_rx_queues > 1 or when
ptimer (PTPD) is enabled.

2. Program the RIR0 register with NON ZERO value which is used
for packet distribution to multiple RX queues.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-gianfar-Some-minor-bug-fixes-with-filer.patch.

Signed-off-by: Sandeep Gopalpet <sandeep.kumar@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/net/gianfar.c |    4 ++++
 drivers/net/gianfar.h |    3 +++
 2 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 3def778..1f70c7d 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -1012,6 +1012,9 @@ static void gfar_init_filer_table(struct gfar_private *priv)
 		ftp_rqfpr[i] = rqfpr;
 		gfar_write_filer(priv, i, rqfcr, rqfpr);
 	}
+
+	/* Program the RIR0 reg with the required distribution */
+	priv->gfargrp[0].regs->rir0 = DEFAULT_RIR0;
 }
 
 static void gfar_detect_errata(struct gfar_private *priv)
@@ -1074,6 +1077,7 @@ static int gfar_probe(struct of_device *ofdev,
 			priv->ptimer_present = 0;
 			printk(KERN_ERR "IEEE1588: ptp-timer init failed\n");
 		}
+		priv->rx_filer_enable = 1;
 		pmuxcr_guts_write();
 		printk(KERN_INFO "IEEE1588: ptp-timer initialized\n");
 	}
diff --git a/drivers/net/gianfar.h b/drivers/net/gianfar.h
index 16fc35f..09ce69e 100644
--- a/drivers/net/gianfar.h
+++ b/drivers/net/gianfar.h
@@ -464,6 +464,9 @@ extern const char gfar_driver_version[];
 
 #define FPR_FILER_MASK	0xFFFFFFFF
 #define MAX_FILER_IDX	0xFF
+/* This default RIR value directly corresponds
+ * to the 3-bit hash value generated */
+#define DEFAULT_RIR0	0x05397700
 
 /* This default RIR value directly corresponds
  * to the 3-bit hash value generated */
-- 
1.7.0.2

