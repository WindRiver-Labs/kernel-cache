From 4599585f9718129c998cf78ff53b34a917bd633f Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Wed, 29 Jun 2011 18:03:28 +0800
Subject: [PATCH 26/47] 85xx: watchdog add release callback function

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-85xx-watchdog-add-release-callback-func.patch.

Signed-off-by: Jiang Yutang <b14898@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/watchdog/booke_wdt.c |   23 ++++++++++++++++++++++-
 1 files changed, 22 insertions(+), 1 deletions(-)

diff --git a/drivers/watchdog/booke_wdt.c b/drivers/watchdog/booke_wdt.c
index 801ead1..585e321 100644
--- a/drivers/watchdog/booke_wdt.c
+++ b/drivers/watchdog/booke_wdt.c
@@ -4,7 +4,7 @@
  * Author: Matthew McClintock
  * Maintainer: Kumar Gala <galak@kernel.crashing.org>
  *
- * Copyright 2005, 2008 Freescale Semiconductor Inc.
+ * Copyright 2005, 2008, 2010 Freescale Semiconductor Inc.
  *
  * This program is free software; you can redistribute  it and/or modify it
  * under  the terms of  the GNU General  Public License as published by the
@@ -114,6 +114,26 @@ static void __booke_wdt_enable(void *data)
 	mtspr(SPRN_TCR, val);
 }
 
+static void __booke_wdt_disable(void *data)
+{
+	u32 val;
+
+	val = mfspr(SPRN_TCR);
+	val &= ~(TCR_WIE | TCR_WRC_MASK | WDTP_MASK);
+	mtspr(SPRN_TCR, val);
+}
+
+static int booke_wdt_release(struct inode *inode, struct file *file)
+{
+	spin_lock(&booke_wdt_lock);
+	if (booke_wdt_enabled == 1) {
+		booke_wdt_enabled = 0;
+		on_each_cpu(__booke_wdt_disable, NULL, 0);
+		printk(KERN_INFO "PowerPC Book-E Watchdog Timer Disabled\n");
+	}
+	spin_unlock(&booke_wdt_lock);
+}
+
 static ssize_t booke_wdt_write(struct file *file, const char __user *buf,
 				size_t count, loff_t *ppos)
 {
@@ -199,6 +219,7 @@ static const struct file_operations booke_wdt_fops = {
 	.write = booke_wdt_write,
 	.unlocked_ioctl = booke_wdt_ioctl,
 	.open = booke_wdt_open,
+	.release = booke_wdt_release,
 };
 
 static struct miscdevice booke_wdt_miscdev = {
-- 
1.7.0.4

