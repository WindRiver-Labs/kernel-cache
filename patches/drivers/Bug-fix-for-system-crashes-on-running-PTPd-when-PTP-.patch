From 21f0390a76ed3ed9c6aead7fa21c156cd06ad25f Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Tue, 9 Aug 2011 19:23:06 +0800
Subject: [PATCH 24/47] Bug fix for system crashes on running PTPd when PTP timer node is not defined

When the IEEE1588 node is not defined in the DTS file, and PTPD application
calls 1588_ioctl the system crashes due to null pointer access. The patch adds
a check if ptptimer device is present in the system before calling 1588_ioctl.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-Bug-fix-for-System-crashes-on-running-P.patch.

Signed-off-by: P.V.Suresh <pala@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/net/gianfar.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 6ad91d3..ede1a9f 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -938,7 +938,10 @@ static int gfar_ioctl(struct net_device *dev, struct ifreq *rq, int cmd)
 
 	if ((cmd >= PTP_GET_RX_TIMESTAMP_SYNC) &&
 			(cmd <= PTP_CLEANUP_TIMESTAMP_BUFFERS))
-		retVal = gfar_ioctl_1588(dev, rq, cmd);
+		if (priv->ptimer_present)
+			retVal = gfar_ioctl_1588(dev, rq, cmd);
+		else
+			retVal = -ENODEV;
 	else
 		retVal = phy_mii_ioctl(priv->phydev, if_mii(rq), cmd);
 
-- 
1.7.0.2

