From 5f946f04842d2c64edf2e764f63690a39e003e53 Mon Sep 17 00:00:00 2001
From: Yongli He <yongli.he@windriver.com>
Date: Wed, 11 Feb 2009 15:31:55 +0800
Subject: [PATCH] amd8111e: Fix rx return code

after mem run out, amd8111e will failed to feed rx buffer, jump out
loop,if it use up it's budget at this time, the napi->poll_list will
be delete twice, and lead to crash.

Signed-off-by: Yongli He <yongli.he@windriver.com>
---
 drivers/net/amd8111e.c |   13 ++++++++-----
 1 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/drivers/net/amd8111e.c b/drivers/net/amd8111e.c
index 6dd35e3..7780f2f 100644
--- a/drivers/net/amd8111e.c
+++ b/drivers/net/amd8111e.c
@@ -830,11 +830,14 @@ static int amd8111e_rx_poll(struct napi_struct *napi, int budget)
 	} while(intr0 & RINT0);
 
 	/* Receive descriptor is empty now */
-	spin_lock_irqsave(&lp->lock, flags);
-	__netif_rx_complete(dev, napi);
-	writel(VAL0|RINTEN0, mmio + INTEN0);
-	writel(VAL2 | RDMD0, mmio + CMD0);
-	spin_unlock_irqrestore(&lp->lock, flags);
+	if (rx_pkt_limit >0)	
+	{
+		spin_lock_irqsave(&lp->lock, flags);
+		__netif_rx_complete(dev, napi);
+		writel(VAL0|RINTEN0, mmio + INTEN0);
+		writel(VAL2 | RDMD0, mmio + CMD0);
+		spin_unlock_irqrestore(&lp->lock, flags);
+	}
 
 rx_not_empty:
 	return num_rx_pkt;
-- 
1.6.0.3

