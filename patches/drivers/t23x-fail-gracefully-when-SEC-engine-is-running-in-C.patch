From 7493297390849ee153038017c8a97c6ec41fb5ce Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Tue, 28 Jun 2011 16:56:31 +0800
Subject: [PATCH 13/47] t23x: fail gracefully when SEC engine is running in CAMP secondary mode

Talitos 2.x/3.x does not support channel remapping, so add sanity check
to avoid mis-action.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-t23x-fail-gracefully-when-SEC-engine-is.patch.

Signed-off-by: Li Yang <leoli@freescale.com>

[Replace -1 by -EINVAL for return value.]

Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/crypto/t23x/t23xrm/t23xrmModule.c |    9 ++++++++-
 1 files changed, 8 insertions(+), 1 deletions(-)

diff --git a/drivers/crypto/t23x/t23xrm/t23xrmModule.c b/drivers/crypto/t23x/t23xrm/t23xrmModule.c
index ed31609..c8caefd 100644
--- a/drivers/crypto/t23x/t23xrm/t23xrmModule.c
+++ b/drivers/crypto/t23x/t23xrm/t23xrmModule.c
@@ -8,7 +8,7 @@
  * tree entry for each core, it does not auto-detect
  * hardware capability
  *
- * Copyright (c) 2007-2009 Freescale Semiconductor, Inc.
+ * Copyright (c) 2007-2010 Freescale Semiconductor, Inc.
  * All Rights Reserved
  *
  *
@@ -95,6 +95,7 @@ static int t23x_probe(struct of_device *ofdev,
     uint32_t   *fifod    = NULL;
     uint32_t   *eu_mask  = NULL;
     uint32_t   *typ_mask = NULL;
+    const char* mode = NULL;
     T2CoreInstance *devinst;
     struct device_node *dn;
     struct device *dev;
@@ -114,6 +115,12 @@ static int t23x_probe(struct of_device *ofdev,
 	return -ENOMEM;
     }
 
+    mode = of_get_property(dn, "fsl,multi-host-mode", NULL);
+    if (mode && !strcmp(mode, "secondary")) {
+	printk("t23x: can't work on CAMP secondary mode\n");
+	return -EINVAL;
+    }
+
     devinst->doneIRQid = of_irq_to_resource(dn, 0, NULL);
 
     /* Need to fetch capability bits from the dev node here */
-- 
1.7.0.4

