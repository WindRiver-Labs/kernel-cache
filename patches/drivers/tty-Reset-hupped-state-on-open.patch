From 57b883f66ed34133c403f158f34f9acf6f99f79d Mon Sep 17 00:00:00 2001
From: yzhu1 <yanjun.zhu@windriver.com>
Date: Fri, 25 Apr 2014 03:22:09 -0700
Subject: [PATCH] tty: Reset hupped state on open

commit d4855e1fc03c2bb32dd64badf51cec5a2a26ab2a upstream

A common security idiom is to hangup the current tty (via vhangup())
after forking but before execing a root shell. This hangs up any
existing opens which other processes may have and ensures subsequent
opens have the necessary permissions to open the root shell tty/pty.

Reset the TTY_HUPPED state after the driver has successfully
returned the opened tty (perform the reset while the tty is locked
to avoid racing with concurrent hangups).

Reported-by: Heorhi Valakhanovich <valahanovich@tut.by>
Signed-off-by: Peter Hurley <peter@hurleysoftware.com>
Cc: stable <stable@vger.kernel.org> # 3.12
Tested-by: Heorhi Valakhanovich <valahanovich@tut.by>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: yzhu1 <yanjun.zhu@windriver.com>
---
 drivers/tty/tty_io.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/tty/tty_io.c b/drivers/tty/tty_io.c
index afbb1e7..7c5d06f 100644
--- a/drivers/tty/tty_io.c
+++ b/drivers/tty/tty_io.c
@@ -2119,6 +2119,7 @@ retry_open:
 		tty_unlock();
 		goto retry_open;
 	}
+	clear_bit(TTY_HUPPED, &tty->flags); 
 	tty_unlock();
 
 
-- 
1.7.5.4

