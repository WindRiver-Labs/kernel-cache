From 45cb434df2ce4a343ee54eab9f52f3c1d2628478 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Wed, 13 Jul 2011 16:56:46 +0800
Subject: [PATCH 40/47] MMC/SD: power on before detecting card

The driver will not get the right status when using the callback
function 'get_cd' to check if the card is present because the
power is not on. Therefore, the controller must be power on
before detecting the card status.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-MMC-SD-power-on-before-detecting-card.patch.

Signed-off-by: Jerry Huang <Chang-Ming.Huang@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/mmc/core/core.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/mmc/core/core.c b/drivers/mmc/core/core.c
index 3168ebd..634dffc 100644
--- a/drivers/mmc/core/core.c
+++ b/drivers/mmc/core/core.c
@@ -1083,12 +1083,13 @@ void mmc_rescan(struct work_struct *work)
 	 */
 	mmc_bus_put(host);
 
+	mmc_power_up(host);
+
 	if (host->ops->get_cd && host->ops->get_cd(host) == 0)
 		goto out;
 
 	mmc_claim_host(host);
 
-	mmc_power_up(host);
 	sdio_reset(host);
 	mmc_go_idle(host);
 
-- 
1.7.0.4

