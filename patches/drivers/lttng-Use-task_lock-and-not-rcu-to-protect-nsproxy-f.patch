From cd9393c4524f24c555457f34f9490df04c5edc87 Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Mon, 15 Sep 2014 15:25:48 +0800
Subject: [PATCH] lttng: Use task_lock and not rcu to protect nsproxy for
 lttng

commit 5c2116b2 [namespaces: Use task_lock and not rcu to protect nsproxy]
removes the rcu lock from nsproxy.

This causes the following lttng build failure:

linux/drivers/staging/lttng2/lttng-statedump-impl.c:
In function 'lttng_statedump_process_ns':
linux/drivers/staging/lttng2/lttng-statedump-impl.c:288:2:
error: implicit declaration of function 'task_nsproxy' [-Werror=implicit-function-declaration]

So we convert lttng2 to the new locking scheme to fix the error.

Signed-off-by: Li Wang <li.wang@windriver.com>
---

diff --git a/drivers/staging/lttng2/lttng-statedump-impl.c b/drivers/staging/lttng2/lttng-statedump-impl.c
index aecf521..25d42c8 100644
--- a/drivers/staging/lttng2/lttng-statedump-impl.c
+++ b/drivers/staging/lttng2/lttng-statedump-impl.c
@@ -293,8 +293,8 @@ void lttng_statedump_process_ns(struct lttng_session *session,
 	struct nsproxy *proxy;
 	struct pid_namespace *pid_ns;
 
-	rcu_read_lock();
-	proxy = task_nsproxy(p);
+	task_lock(p);
+	proxy = p->nsproxy;
 	if (proxy) {
 		pid_ns = lttng_get_proxy_pid_ns(proxy);
 		do {
@@ -306,7 +306,7 @@ void lttng_statedump_process_ns(struct lttng_session *session,
 		trace_lttng_statedump_process_state(session,
 			p, type, mode, submode, status, NULL);
 	}
-	rcu_read_unlock();
+	task_unlock(p);
 }
 
 static
-- 
1.7.5.4

