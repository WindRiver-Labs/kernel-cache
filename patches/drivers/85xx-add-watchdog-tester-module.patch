From 7764f7965787719d8f50212a63deb39d831eeff8 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Wed, 29 Jun 2011 17:57:32 +0800
Subject: [PATCH 25/47] 85xx: add watchdog tester module

While Watchdog is working, insmod this module, cpus will be occupied by
a loop procedure. And system will reboot after watchdog time limit.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-85xx-add-watchdog-tester-module.patch.

Signed-off-by: Jiang Yutang <b14898@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/watchdog/Kconfig            |    8 ++++++++
 drivers/watchdog/Makefile           |    1 +
 drivers/watchdog/booke_wdt_tester.c |   31 +++++++++++++++++++++++++++++++
 3 files changed, 40 insertions(+), 0 deletions(-)
 create mode 100644 drivers/watchdog/booke_wdt_tester.c

diff --git a/drivers/watchdog/Kconfig b/drivers/watchdog/Kconfig
index e37015a..c261ca7 100644
--- a/drivers/watchdog/Kconfig
+++ b/drivers/watchdog/Kconfig
@@ -918,6 +918,14 @@ config BOOKE_WDT
 	  Please see Documentation/watchdog/watchdog-api.txt for
 	  more information.
 
+config BOOKE_WDT_TESTER
+	tristate "PowerPC Book-E Watchdog Timer Tester(only used as moduler)"
+	depends on BOOKE_WDT
+	default m
+	---help---
+	  This moduler will block kernel by loop occupy cpu resource, and
+	  then watchdog will timeout and reset system. Only used as moduler.
+
 # PPC64 Architecture
 
 config WATCHDOG_RTAS
diff --git a/drivers/watchdog/Makefile b/drivers/watchdog/Makefile
index e3d1cc8..f7c693d 100644
--- a/drivers/watchdog/Makefile
+++ b/drivers/watchdog/Makefile
@@ -124,6 +124,7 @@ obj-$(CONFIG_8xxx_WDT) += mpc8xxx_wdt.o
 obj-$(CONFIG_MV64X60_WDT) += mv64x60_wdt.o
 obj-$(CONFIG_PIKA_WDT) += pika_wdt.o
 obj-$(CONFIG_BOOKE_WDT) += booke_wdt.o
+obj-$(CONFIG_BOOKE_WDT_TESTER) += booke_wdt_tester.o
 
 # PPC64 Architecture
 obj-$(CONFIG_WATCHDOG_RTAS) += wdrtas.o
diff --git a/drivers/watchdog/booke_wdt_tester.c b/drivers/watchdog/booke_wdt_tester.c
new file mode 100644
index 0000000..1999706
--- /dev/null
+++ b/drivers/watchdog/booke_wdt_tester.c
@@ -0,0 +1,31 @@
+/*
+ * Watchdog timer tester for PowerPC Book-E systems
+ *
+ * Copyright 2010 Freescale Semiconductor Inc.
+ *
+ * Author: Jiang Yutang <b14898@freescale.com>
+ *
+ * This program is free software; you can redistribute  it and/or modify it
+ * under  the terms of  the GNU General  Public License as published by the
+ * Free Software Foundation;  either version 2 of the  License, or (at your
+ * option) any later version.
+ */
+
+#include <linux/module.h>
+
+static void __loop_occupy_cpu(void *data)
+{
+	printk(KERN_INFO "__loop_occupy_cpu id=%08x\n", smp_processor_id());
+	while (1);
+}
+
+static int __init wdt_tester_init(void)
+{
+	on_each_cpu(__loop_occupy_cpu, NULL, 0);
+	return 0;
+}
+
+module_init(wdt_tester_init);
+
+MODULE_AUTHOR("Jiang Yutang");
+MODULE_LICENSE("GPL");
-- 
1.7.0.4

