From 66605aae378a2d11db53912137575989067e33c1 Mon Sep 17 00:00:00 2001
From: Wang Hui <Hui.Wang@windriver.com>
Date: Fri, 18 Dec 2009 14:06:41 +0800
Subject: [PATCH] musb/core: Fix hot plug voltage drop issue

During connection as an A-Device, we may see a short current spikes
causing voltage drop. The software has already got a workaround for
this issue by skipping non-repeat vbuserror, but there are 2 potential
problems, one is that musb may wait for hot plug in A_IDLE or B_IDLE
state, while another is that current solution doesn't support repeatly
hot plug and unplug.

Signed-off-by: Wang Hui <Hui.Wang@windriver.com>
---
 drivers/usb/musb/musb_core.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/musb/musb_core.c b/drivers/usb/musb/musb_core.c
index 5c5bc1a..ce80206 100644
--- a/drivers/usb/musb/musb_core.c
+++ b/drivers/usb/musb/musb_core.c
@@ -517,6 +517,8 @@ static irqreturn_t musb_stage0_irq(struct musb *musb, u8 int_usb,
 		 */
 		switch (musb->xceiv.state) {
 		case OTG_STATE_A_HOST:
+		case OTG_STATE_A_IDLE:
+		case OTG_STATE_B_IDLE:
 			/* recovery is dicey once we've gotten past the
 			 * initial stages of enumeration, but if VBUS
 			 * stayed ok at the other end of the link, and
@@ -761,6 +763,7 @@ static irqreturn_t musb_stage2_irq(struct musb *musb, u8 int_usb,
 				otg_state_string(musb),
 				MUSB_MODE(musb), devctl);
 		handled = IRQ_HANDLED;
+		musb->vbuserr_retry = VBUSERR_RETRY_COUNT;
 
 		switch (musb->xceiv.state) {
 #ifdef CONFIG_USB_MUSB_HDRC_HCD
-- 
1.6.5.2

