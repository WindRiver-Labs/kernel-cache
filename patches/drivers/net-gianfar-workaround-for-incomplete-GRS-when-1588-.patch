From f0b9963a929e93d7dea25bae25fd18d10e3c3b6f Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 11 Oct 2011 13:14:58 +0800
Subject: [PATCH] net/gianfar: workaround for incomplete GRS when 1588 is enabled

On p2020 when 1588 timer is enabled, the GRS can't complete.
This scenario is very similar to errata eTSEC-A002. The workaround
for eTSEC-A002 has used another method to check whether the Rx is
idle. Also use this method to resolve this issue.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/gianfar.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 753cb74..7b57064 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -1132,6 +1132,10 @@ static void gfar_detect_errata(struct gfar_private *priv)
 			(pvr == 0x80861010 && (mod & 0xfff9) == 0x80c0))
 		priv->errata |= GFAR_ERRATA_A002;
 
+	/* P2020 Rev 2.0 */
+	if (priv->ptimer_present && pvr == 0x80211050)
+		priv->errata |= GFAR_ERRATA_A002;
+
 	if (priv->errata)
 		dev_info(dev, "enabled errata workarounds, flags: 0x%x\n",
 			 priv->errata);
-- 
1.7.0.4

