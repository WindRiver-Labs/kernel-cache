From df206ffc73063317bf8993c654cbbff25bb23914 Mon Sep 17 00:00:00 2001
From: yanjun.zhu <yanjun.zhu@windriver.com>
Date: Thu, 3 Apr 2014 17:26:16 +0800
Subject: [PATCH] gianfar: disable TX vlan

2.6.x kernels require a similar logic change as commit e1653c3e
[gianfar: do vlan cleanup] and commit 51b8cbfc
[gianfar: fix bug caused by e1653c3e] introduces for newer kernels.

Since tx vlan insertion of gianfar nic driver inserts vlan tag
to non-vlan packets, this will make non-vlan packets discarded by
mistake in kernel 2.6.x. In kernel(3.1+), tx vlan is disabled.
But in kernel 2.6.x, tx vlan is still enabled. Thus, gianfar
nic driver can not support vlan packets and non-vlan packets
at the same time.

Signed-off-by: yanjun.zhu <yanjun.zhu@windriver.com>
---
 drivers/net/gianfar.c |    8 +-------
 1 files changed, 1 insertions(+), 7 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 10a28bd..aaeaee8 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -1247,7 +1247,7 @@ static int gfar_probe(struct of_device *ofdev,
 	priv->vlgrp = NULL;
 
 	if (priv->device_flags & FSL_GIANFAR_DEV_HAS_VLAN)
-		dev->features |= NETIF_F_HW_VLAN_TX | NETIF_F_HW_VLAN_RX;
+		dev->features |= NETIF_F_HW_VLAN_RX;
 
 	if (priv->device_flags & FSL_GIANFAR_DEV_HAS_EXTENDED_HASH) {
 		priv->extended_hash = 1;
@@ -3210,12 +3210,6 @@ static void gfar_vlan_rx_register(struct net_device *dev,
 	priv->vlgrp = grp;
 
 	if (grp) {
-		/* Enable VLAN tag insertion */
-		tempval = gfar_read(&regs->tctrl);
-		tempval |= TCTRL_VLINS;
-
-		gfar_write(&regs->tctrl, tempval);
-
 		/* Enable VLAN tag extraction */
 		tempval = gfar_read(&regs->rctrl);
 		tempval |= (RCTRL_VLEX | RCTRL_PRSDEP_INIT);
-- 
1.7.0

