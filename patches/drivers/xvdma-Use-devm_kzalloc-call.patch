From bebfa651ad8f3119fe233e0310fa911b9e17e1c8 Mon Sep 17 00:00:00 2001
From: Radhey Shyam Pandey <radhey.shyam.pandey@xilinx.com>
Date: Tue, 24 Sep 2013 17:43:09 +0530
Subject: [PATCH 06/30] xvdma: Use devm_kzalloc call

git://github.com/Xilinx/linux-xlnx.git xilinx-v2013.4-trd
commit 600cf32f2fa2158ea2f8e97c1b3f32ba0b7575f3

Updated axivdma client driver to use
devm_kzalloc routine.

Signed-off-by: Radhey Shyam Pandey <radheys@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/staging/video/axivdma/xvdma.c |   19 +++++--------------
 1 files changed, 5 insertions(+), 14 deletions(-)

diff --git a/drivers/staging/video/axivdma/xvdma.c b/drivers/staging/video/axivdma/xvdma.c
index e37a4ee..eab72a3 100644
--- a/drivers/staging/video/axivdma/xvdma.c
+++ b/drivers/staging/video/axivdma/xvdma.c
@@ -356,12 +356,10 @@ static int xvdma_probe(struct platform_device *pdev)
 
 	devt = MKDEV(XVDMA_MAJOR, XVDMA_MINOR);
 
-	drvdata = kzalloc(sizeof(struct xvdma_drvdata), GFP_KERNEL);
-	if (!drvdata) {
-		dev_err(dev, "Couldn't allocate device private record\n");
-		retval = -ENOMEM;
-		goto failed0;
-	}
+	drvdata = devm_kzalloc(&pdev->dev, sizeof(struct xvdma_drvdata),
+				GFP_KERNEL);
+	if (!drvdata)
+		return -ENOMEM;
 	dev_set_drvdata(dev, (void *)drvdata);
 
 	drvdata->dev = dev;
@@ -372,18 +370,13 @@ static int xvdma_probe(struct platform_device *pdev)
 	retval = cdev_add(&drvdata->cdev, devt, 1);
 	if (retval) {
 		dev_err(dev, "cdev_add() failed\n");
-		goto failed1;
+		return retval;
 	}
 
 	xvdma_scan_channels();
 	dev_info(dev, "Xilinx VDMA probe successful\n");
 	dev_info(dev, "Devices Scanned %d\n", num_devices);
 	return 0;
-
-failed1:
-	kfree(drvdata);
-failed0:
-	return retval;
 }
 
 static int xvdma_remove(struct platform_device *op)
@@ -397,8 +390,6 @@ static int xvdma_remove(struct platform_device *op)
 
 	xvdma_release_channels();
 	cdev_del(&drvdata->cdev);
-	kfree(drvdata);
-	dev_set_drvdata(dev, NULL);
 	return 0;
 }
 
-- 
1.7.5.4

