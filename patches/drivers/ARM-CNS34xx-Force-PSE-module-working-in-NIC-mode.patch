From d9b5aa2a85a2f97c4ae51e1b24543455cafa4726 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Tue, 6 Sep 2011 14:22:43 +0800
Subject: [PATCH 2/4] ARM:CNS34xx:Force PSE module working in NIC mode

The PSE module on CNS34xx will normally strip off VLAN tag of each
received packet except in NIC mode. When PSE module working in NIC
mode( setting bit 15 in VLAN_CFG).The three MAC ports behave like
three NICs and no received packets are modified.

On Linux, network stack will handle VLAN tag by software. Therefore,
the PSE module must work in NIC mode. The patch forces PSE module
working in NIC mode.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/net/cns3xxx/cns3xxx_main.c |    5 +++++
 drivers/net/cns3xxx/cns3xxx_tool.h |    8 ++++++++
 drivers/net/cns3xxx/vb.h           |    1 +
 3 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/drivers/net/cns3xxx/cns3xxx_main.c b/drivers/net/cns3xxx/cns3xxx_main.c
index ce01a6c..2799d3a 100644
--- a/drivers/net/cns3xxx/cns3xxx_main.c
+++ b/drivers/net/cns3xxx/cns3xxx_main.c
@@ -3299,6 +3299,11 @@ static int __init cns3xxx_init_module(void)
 	cns3xxx_probe(ring_info);
 	cns3xxx_config_intr();
 
+#ifdef CNS3XXX_VLAN_8021Q
+	if (is_cns3xxx_nic_mode_8021q())
+		cns3xxx_nic_mode(1);
+#endif
+
 	spin_lock_init(&tx_lock);
 	spin_lock_init(&rx_lock);
 
diff --git a/drivers/net/cns3xxx/cns3xxx_tool.h b/drivers/net/cns3xxx/cns3xxx_tool.h
index 4ccd688..93209ca 100644
--- a/drivers/net/cns3xxx/cns3xxx_tool.h
+++ b/drivers/net/cns3xxx/cns3xxx_tool.h
@@ -535,6 +535,14 @@ static inline void cns3xxx_ivl(u8 enable)
 		MAC_GLOB_CFG_REG |= (0x1 << 7);
 }
 
+static inline void cns3xxx_nic_mode(u8 enable)
+{
+	VLAN_CFG &= (~(1<<15));
+	if (enable == 1)
+		VLAN_CFG |= (1<<15);
+}
+
+
 static inline void cns3xxx_disable_irq(u32 irq)
 {
 	disable_irq_nosync(irq);
diff --git a/drivers/net/cns3xxx/vb.h b/drivers/net/cns3xxx/vb.h
index 2b5150f..7cbe777 100644
--- a/drivers/net/cns3xxx/vb.h
+++ b/drivers/net/cns3xxx/vb.h
@@ -111,6 +111,7 @@ static inline void close_port2(void)
 #define my_vlan2_mac {0x00, 0x11, 0xbb, 0xcc, 0xdd, 0x70}
 #define my_vlan3_mac {0x00, 0x11, 0xbb, 0xcc, 0xdd, 0x80}
 
+#define CNS3XXX_NIC_MODE_8021Q
 
 #if defined(CONFIG_VLAN_8021Q) || defined(CONFIG_VLAN_8021Q_MODULE)
 	#ifndef CNS3XXX_NIC_MODE_8021Q
-- 
1.7.0.4

