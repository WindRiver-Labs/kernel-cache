From 3b977cf9c279ec228bb601dff8bba28a3a73e466 Mon Sep 17 00:00:00 2001
From: "H. Peter Anvin" <hpa@linux.intel.com>
Date: Mon, 17 Mar 2014 16:36:30 -0700
Subject: [PATCH 92/97] random: Add arch_has_random[_seed]()

commit 7b878d4b48c4e04b936918bb83836a107ba453b3 upstream.

Add predicate functions for having arch_get_random[_seed]*().  The
only current use is to avoid the loop in arch_random_refill() when
arch_get_random_seed_long() is unavailable.

Signed-off-by: H. Peter Anvin <hpa@linux.intel.com>
Cc: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Cc: Paul Mackerras <paulus@samba.org>
Cc: Michael Ellerman <michael@ellerman.id.au>
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
[adjusted patch for missing file arch/powerpc/include/asm/archrandom.h]
Signed-off-by: Liwei Song <liwei.song@windriver.com>
---
 arch/x86/include/asm/archrandom.h |    3 +++
 drivers/char/random.c             |    3 +++
 include/linux/random.h            |    8 ++++++++
 3 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/arch/x86/include/asm/archrandom.h b/arch/x86/include/asm/archrandom.h
index a5339c9..d85ce28 100644
--- a/arch/x86/include/asm/archrandom.h
+++ b/arch/x86/include/asm/archrandom.h
@@ -100,6 +100,9 @@ GET_SEED(arch_get_random_seed_int, unsigned int, RDSEED_INT, ASM_NOP4);
 
 #endif /* CONFIG_X86_64 */
 
+#define arch_has_random()	static_cpu_has(X86_FEATURE_RDRAND)
+#define arch_has_random_seed()	static_cpu_has(X86_FEATURE_RDSEED)
+
 static inline bool rdseed_long(unsigned long *v)
 {
 	return 0;
diff --git a/drivers/char/random.c b/drivers/char/random.c
index d78b90d..24376bf 100644
--- a/drivers/char/random.c
+++ b/drivers/char/random.c
@@ -1238,6 +1238,9 @@ static int arch_random_refill(void)
 	unsigned int i;
 	unsigned long buf[nlongs];
 
+	if (!arch_has_random_seed())
+		return 0;
+
 	for (i = 0; i < nlongs; i++) {
 		if (arch_get_random_seed_long(&buf[n]))
 			n++;
diff --git a/include/linux/random.h b/include/linux/random.h
index 6a11eb3..1ef261c 100644
--- a/include/linux/random.h
+++ b/include/linux/random.h
@@ -66,6 +66,10 @@ static inline int arch_get_random_int(unsigned int *v)
 {
 	return 0;
 }
+static inline int arch_has_random(void)
+{
+	return 0;
+}
 static inline int arch_get_random_seed_long(unsigned long *v)
 {
 	return 0;
@@ -74,6 +78,10 @@ static inline int arch_get_random_seed_int(unsigned int *v)
 {
 	return 0;
 }
+static inline int arch_has_random_seed(void)
+{
+	return 0;
+}
 #endif
 
 /* Pseudo random number generator from numerical recipes. */
-- 
1.7.5.4

