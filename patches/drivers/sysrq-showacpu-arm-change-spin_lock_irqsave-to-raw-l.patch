From 807dc551fd8204702dc50baa3330d5e369e8fc0e Mon Sep 17 00:00:00 2001
From: Haiqing Bai <Haiqing.Bai@windriver.com>
Date: Mon, 5 Jun 2017 13:32:11 +0800
Subject: [PATCH] sysrq showacpu: arm: change spin_lock_irqsave to raw lock

On target run:
$ while true; do echo l > /proc/sysrq-trigger; done
will trigger the below calltrace and causes lockup:

 BUG: sleeping function called from invalid context at kernel/locking/rtmutex.c:1165
 in_atomic(): 1, irqs_disabled(): 128, pid: 85, name: kworker/0:1
 CPU2:
 Preemption disabled at:[<  (null)>]   (null)
 [<800180f4>] (unwind_backtrace) from [<80012840>] (show_stack+0x20/0x24)
 [<80012840>] (show_stack) from [<803fcb20>] (showacpu+0x4c/0x64)
 CPU: 0 PID: 85 Comm: kworker/0:1 Tainted: G        W    3.14.39ltsi-rt37-WR7.0.0.25_preempt-rt #2
 [<803fcb20>] (showacpu) from [<80099fb8>] (generic_smp_call_function_single_interrupt+0xb8/0x104)
 Workqueue: events_power_efficient fb_flashcursor
 [<80099fb8>] (generic_smp_call_function_single_interrupt) from [<800155bc>] (handle_IPI+0xa0/0x15c)

 [<800155bc>] (handle_IPI) from [<80008578>] (gic_handle_irq+0x68/0x70)
 [<800180f4>] (unwind_backtrace) from [<80012840>] (show_stack+0x20/0x24)
 [<80008578>] (gic_handle_irq) from [<80013560>] (__irq_usr+0x40/0x60)
 [<80012840>] (show_stack) from [<80814298>] (dump_stack+0x74/0xcc)
 Exception stack(0xa8b41fb0 to 0xa8b41ff8)
 [<80814298>] (dump_stack) from [<8005fa8c>] (__might_sleep+0x134/0x160)
 1fa0:                                     00000006 00000002 000eda42 75f1a434
 [<8005fa8c>] (__might_sleep) from [<80819290>] (rt_spin_lock+0x28/0x38)
 1fc0: 74e00500 75f1a478 91a2b3c5 74e00500 75f1ad2f 00001fa0 76f6ce40 75f1ad58

 [<80819290>] (rt_spin_lock) from [<803fcb04>] (showacpu+0x30/0x64)
 1fe0: 000001ec 75f1a430 00000088 0005df40 600b0010 ffffffff
 SysRq :
 [<803fcb04>] (showacpu) from [<80099fb8>] (generic_smp_call_function_single_interrupt+0xb8/0x104)
 Show backtrace of all active CPUs
 [<80099fb8>] (generic_smp_call_function_single_interrupt) from [<800155bc>] (handle_IPI+0xa0/0x15c)
 [<800155bc>] (handle_IPI) from [<80008578>] (gic_handle_irq+0x68/0x70)
 [<80008578>] (gic_handle_irq) from [<80013380>] (__irq_svc+0x40/0x84)
 Exception stack(0xa8407d60 to 0xa8407da8)
 7d60: a86e5010 00000074 00000020 c09d80b4 a86e5010 00000074 8040e874 80c94df6
 7d80: 00000022 80c94dd4 80c11740 a8407dbc a8407dc0 a8407da8 8040ab38 8040e8a8
 7da0: 200f0013 ffffffff
 [<80013380>] (__irq_svc) from [<8040e8a8>] (imx_console_putchar+0x34/0x68)
 [<8040e8a8>] (imx_console_putchar) from [<8040ab38>] (uart_console_write+0x50/0x58)
 [<8040ab38>] (uart_console_write) from [<804105b8>] (imx_console_write+0x124/0x180)
 [<804105b8>] (imx_console_write) from [<8007b634>] (call_console_drivers.constprop.20+0x144/0x18c)
 [<8007b634>] (call_console_drivers.constprop.20) from [<8007c120>] (console_unlock+0x144/0x344)

 Change spin_lock_irqsave to raw_spin_lock_irqsave, spin_unlock_irqrestore to raw_spin_unlock_irqrestore
 prevents this os hang.

Signed-off-by: Haiqing Bai <Haiqing.Bai@windriver.com>
---
 drivers/tty/sysrq.c |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/drivers/tty/sysrq.c b/drivers/tty/sysrq.c
index 0ba1c59..4aeeddf 100644
--- a/drivers/tty/sysrq.c
+++ b/drivers/tty/sysrq.c
@@ -206,7 +206,7 @@ static struct sysrq_key_op sysrq_showlocks_op = {
 #endif
 
 #ifdef CONFIG_SMP
-static DEFINE_SPINLOCK(show_lock);
+static DEFINE_RAW_SPINLOCK(show_lock);
 
 static void showacpu(void *dummy)
 {
@@ -216,10 +216,10 @@ static void showacpu(void *dummy)
 	if (idle_cpu(smp_processor_id()))
 		return;
 
-	spin_lock_irqsave(&show_lock, flags);
+	raw_spin_lock_irqsave(&show_lock, flags);
 	pr_info("CPU%d:\n", smp_processor_id());
 	show_stack(NULL, NULL);
-	spin_unlock_irqrestore(&show_lock, flags);
+	raw_spin_unlock_irqrestore(&show_lock, flags);
 }
 
 static void sysrq_showregs_othercpus(struct work_struct *dummy)
-- 
1.7.5.4

