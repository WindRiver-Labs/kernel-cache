From 5072b668107a72a1c03adfa4435eb60c49ece253 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Mon, 11 Jul 2011 09:39:54 +0800
Subject: [PATCH 3/4] DMA: fsldma: Disable DMA_INTERRUPT when Async_tx enabled

Disable the use of DMA_INTERRUPT capability with Async_tx enabled.

The fsldma produces a null transfer with DMA_INTERRUPT
capability when used with Async_tx. When RAID devices
queue a transaction via Async_tx, this results in a hang.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-DMA-fsldma-Disable-DMA_INTERRUPT-when-A.patch.

Signed-off-by: Vishnu Suresh <Vishnu@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/dma/fsldma.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/drivers/dma/fsldma.c b/drivers/dma/fsldma.c
index 779d095..67dd442 100644
--- a/drivers/dma/fsldma.c
+++ b/drivers/dma/fsldma.c
@@ -1320,7 +1320,13 @@ static int __devinit fsldma_of_probe(struct of_device *op,
 	fdev->irq = irq_of_parse_and_map(op->node, 0);
 
 	dma_cap_set(DMA_MEMCPY, fdev->common.cap_mask);
+#ifndef CONFIG_ASYNC_CORE
+	/*
+	 * The DMA_INTERRUPT async_tx is a NULL transfer, which will
+	 * triger a PE interrupt.
+	 */
 	dma_cap_set(DMA_INTERRUPT, fdev->common.cap_mask);
+#endif
 	dma_cap_set(DMA_SLAVE, fdev->common.cap_mask);
 	fdev->common.device_alloc_chan_resources = fsl_dma_alloc_chan_resources;
 	fdev->common.device_free_chan_resources = fsl_dma_free_chan_resources;
-- 
1.7.0.2

