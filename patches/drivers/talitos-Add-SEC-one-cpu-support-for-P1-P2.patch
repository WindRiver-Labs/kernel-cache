From 1c5208606ea97d46e8c7cf9bec4776bb0250e7b5 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Tue, 28 Jun 2011 14:24:31 +0800
Subject: [PATCH 04/47] talitos: Add SEC one cpu support for P1/P2

Add SEC one cpu support, use primary mode by default.
It is valid in both SMP and Non-SMP mode.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-talitos-Add-SEC-one-cpu-support-for-P1-.patch.

signed-off-by: Jianhua Xie <b29408@freescale.com>
Signed-off-by: Li Yang <leoli@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/crypto/talitos.c |   14 ++++++++++----
 1 files changed, 10 insertions(+), 4 deletions(-)

diff --git a/drivers/crypto/talitos.c b/drivers/crypto/talitos.c
index d7da3b4..eeb6f5e 100644
--- a/drivers/crypto/talitos.c
+++ b/drivers/crypto/talitos.c
@@ -1974,14 +1974,20 @@ static int talitos_probe(struct of_device *ofdev,
 		priv->dual = 0;
 		priv->secondary = 1;
 	} else if (!strcmp(name, "dual")) {
-		if (nr_cpu_ids != 2) {
+		if (nr_cpu_ids < 2) {
+			/* add one cpu support to P1/P2 for both SMP and Non-SMP,
+			 * use primary as the default mode. */
+			priv->dual = 0;
+			priv->secondary = 0;
+		} else if (nr_cpu_ids == 2) {
+			priv->dual = 1;
+			priv->secondary = 0;
+		} else {
 			dev_err(dev, "can't work in dual host mode with CPU "
-					"number not equal to 2\n");
+					"number not equal to 2 or 1\n");
 			err = -EINVAL;
 			goto err_out;
 		}
-		priv->dual = 1;
-		priv->secondary = 0;
 	} else {
 		dev_err(dev, "invalid multi-host-mode in device tree node\n");
 		err = -EINVAL;
-- 
1.7.0.4

