From f189d84266312faab4481e52432dd9b3968deacf Mon Sep 17 00:00:00 2001
From: Guojian Zhou <guojian.zhou@windriver.com>
Date: Thu, 12 Feb 2015 17:30:16 +0800
Subject: [PATCH] ixgbe: The ixgbe could not double reset NIC hardware

This defect could be reproduced on the kernel kdump feature test.

The dump-capture kernel would hung on the ixgbe 10G NIC port intialization.
This NIC device could not shutdown when the kernel crash.
The ixgbe "double resets" are required for recovery from such error condition.
The second reset could clears out any effects on the pending NIC hardware.

The stop_adapter() would get the "IXGBE_ERR_MASTER_REQUESTS_PENDING" error
because it could not disable the PCI-express master access. This error would
cause the following reset operations were skipped. In fact, when this error
reproduced, the NIC MAC software reset operation should be requried to recovery
this issue. After the NIC MAC software reset operation, the stop_adapter()
could disable the PCI-express master access as expected.

Use the "reset_devices" flag to force the driver to execute software reset
operation on the 10G NIC MAC hardware.

The capture-dump kernel initialize the 10G NIC failure information:
ixgbe: Intel(R) 10 Gigabit PCI Express Network Driver - version 3.19.1-k
ixgbe: Copyright (c) 1999-2013 Intel Corporation.
ixgbe 0000:03:00.0: HW Init failed: -12
ixgbe: probe of 0000:03:00.0 failed with error -12

Signed-off-by: Guojian Zhou <guojian.zhou@windriver.com>
---
 drivers/net/ethernet/intel/ixgbe/ixgbe_x540.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/intel/ixgbe/ixgbe_x540.c b/drivers/net/ethernet/intel/ixgbe/ixgbe_x540.c
index 24b80a6..0b623d3 100644
--- a/drivers/net/ethernet/intel/ixgbe/ixgbe_x540.c
+++ b/drivers/net/ethernet/intel/ixgbe/ixgbe_x540.c
@@ -97,9 +97,11 @@ static s32 ixgbe_reset_hw_X540(struct ixgbe_hw *hw)
 
 	/* Call adapter stop to disable tx/rx and clear interrupts */
 	status = hw->mac.ops.stop_adapter(hw);
-	if (status != 0)
+	/* Use the "reset_devices" flag to force MAC software reset
+	   during the capture-dump kernel boot */
+	if (status != 0 && !reset_devices)
 		goto reset_hw_out;
-
+	status = 0;
 	/* flush pending Tx transactions */
 	ixgbe_clear_tx_pending(hw);
 
-- 
1.7.5.4

