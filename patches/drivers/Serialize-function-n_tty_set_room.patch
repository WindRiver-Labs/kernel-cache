From 0f768954473ea7a8443855761c9aef883ac51aa7 Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Wed, 30 Jan 2013 13:36:17 +0800
Subject: [PATCH] Serialize function n_tty_set_room

Without serialization, preemption on this function may
cause the read_cnt and receive_room are both set to
zero. This will block both producer and consumer of the
read_buf. Serialize it with a new created spinlock.

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 drivers/char/n_tty.c  |   12 ++++++++----
 drivers/char/tty_io.c |    1 +
 include/linux/tty.h   |    1 +
 3 files changed, 10 insertions(+), 4 deletions(-)

diff --git a/drivers/char/n_tty.c b/drivers/char/n_tty.c
index 72c03aa..d67c39d 100644
--- a/drivers/char/n_tty.c
+++ b/drivers/char/n_tty.c
@@ -87,14 +87,17 @@ static inline int tty_put_user(struct tty_struct *tty, unsigned char x,
  *
  *	Called by the driver to find out how much data it is
  *	permitted to feed to the line discipline without any being lost
- *	and thus to manage flow control. Not serialized. Answers for the
- *	"instant".
+ *	and thus to manage flow control.
  */
 
 static void n_tty_set_room(struct tty_struct *tty)
 {
-	/* tty->read_cnt is not read locked ? */
-	int	left = N_TTY_BUF_SIZE - tty->read_cnt - 1;
+	unsigned long flags;
+	int     left;
+
+	spin_lock_irqsave(&tty->receive_room_lock, flags);
+
+	left = N_TTY_BUF_SIZE - tty->read_cnt - 1;
 
 	/*
 	 * If we are doing input canonicalization, and there are no
@@ -105,6 +108,7 @@ static void n_tty_set_room(struct tty_struct *tty)
 	if (left <= 0)
 		left = tty->icanon && !tty->canon_data;
 	tty->receive_room = left;
+	spin_unlock_irqrestore(&tty->receive_room_lock, flags);
 }
 
 static void put_tty_queue_nolock(unsigned char c, struct tty_struct *tty)
diff --git a/drivers/char/tty_io.c b/drivers/char/tty_io.c
index a5919be..d5840be 100644
--- a/drivers/char/tty_io.c
+++ b/drivers/char/tty_io.c
@@ -2874,6 +2874,7 @@ void initialize_tty_struct(struct tty_struct *tty,
 	mutex_init(&tty->echo_lock);
 	spin_lock_init(&tty->read_lock);
 	spin_lock_init(&tty->ctrl_lock);
+	spin_lock_init(&tty->receive_room_lock);
 	INIT_LIST_HEAD(&tty->tty_files);
 	INIT_WORK(&tty->SAK_work, do_SAK_work);
 
diff --git a/include/linux/tty.h b/include/linux/tty.h
index 4409967..dce6f34 100644
--- a/include/linux/tty.h
+++ b/include/linux/tty.h
@@ -324,6 +324,7 @@ struct tty_struct {
 	/* If the tty has a pending do_SAK, queue it here - akpm */
 	struct work_struct SAK_work;
 	struct tty_port *port;
+	spinlock_t receive_room_lock;
 };
 
 /* tty magic number */
-- 
1.7.0

