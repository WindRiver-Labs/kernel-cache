From b0a814bb606be331ca7f7a0644458df84e385744 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Fri, 24 Jun 2011 14:27:18 +0800
Subject: [PATCH 18/20] TI816x audio: change FIFO addresses for ti816x platform

This patch is based on below commit from arago git tree.
git://arago-project.org/git/projects/linux-omap3.git
8fb9d7 ti816x:McASP changes wrt other Davinci platforms

Signed-off-by: Vaibhav Bedia <vaibhav.bedia@ti.com>
[This one is picked from the original commit to compatible
with wrlinux tree]
Integrated-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 sound/soc/davinci/davinci-mcasp.c |   19 +++++++++++++++++++
 sound/soc/davinci/davinci-mcasp.h |    4 ++++
 2 files changed, 23 insertions(+), 0 deletions(-)

diff --git a/sound/soc/davinci/davinci-mcasp.c b/sound/soc/davinci/davinci-mcasp.c
index 79f0f4a..b002240 100644
--- a/sound/soc/davinci/davinci-mcasp.c
+++ b/sound/soc/davinci/davinci-mcasp.c
@@ -104,10 +104,17 @@
 #define DAVINCI_MCASP_RXBUF_REG		0x280
 
 /* McASP FIFO Registers */
+#ifndef CONFIG_ARCH_TI816X
 #define DAVINCI_MCASP_WFIFOCTL		(0x1010)
 #define DAVINCI_MCASP_WFIFOSTS		(0x1014)
 #define DAVINCI_MCASP_RFIFOCTL		(0x1018)
 #define DAVINCI_MCASP_RFIFOSTS		(0x101C)
+#else
+#define DAVINCI_MCASP_WFIFOCTL		(0x1000)
+#define DAVINCI_MCASP_WFIFOSTS		(0x1004)
+#define DAVINCI_MCASP_RFIFOCTL		(0x1008)
+#define DAVINCI_MCASP_RFIFOSTS		(0x100C)
+#endif
 
 /*
  * DAVINCI_MCASP_PWREMUMGT_REG - Power Down and Emulation Management
@@ -881,7 +888,11 @@ static int davinci_mcasp_probe(struct platform_device *pdev)
 	clk_enable(dev->clk);
 	dev->clk_active = 1;
 
+#ifdef CONFIG_MACH_TI8168EVM
+	dev->base = ioremap(mem->start, (mem->end - mem->start) + 1);
+#else
 	dev->base = (void __iomem *)IO_ADDRESS(mem->start);
+#endif
 	dev->op_mode = pdata->op_mode;
 	dev->tdm_slots = pdata->tdm_slots;
 	dev->num_serializer = pdata->num_serializer;
@@ -893,8 +904,12 @@ static int davinci_mcasp_probe(struct platform_device *pdev)
 
 	dma_data = &dev->dma_params[SNDRV_PCM_STREAM_PLAYBACK];
 	dma_data->eventq_no = pdata->eventq_no;
+#ifdef CONFIG_MACH_TI8168EVM
+	dma_data->dma_addr = (dma_addr_t) (pdata->tx_dma_offset);
+#else
 	dma_data->dma_addr = (dma_addr_t) (pdata->tx_dma_offset +
 							io_v2p(dev->base));
+#endif
 
 	/* first TX, then RX */
 	res = platform_get_resource(pdev, IORESOURCE_DMA, 0);
@@ -907,8 +922,12 @@ static int davinci_mcasp_probe(struct platform_device *pdev)
 
 	dma_data = &dev->dma_params[SNDRV_PCM_STREAM_CAPTURE];
 	dma_data->eventq_no = pdata->eventq_no;
+#ifdef CONFIG_MACH_TI8168EVM
+	dma_data->dma_addr = (dma_addr_t) (pdata->rx_dma_offset);
+#else
 	dma_data->dma_addr = (dma_addr_t)(pdata->rx_dma_offset +
 							io_v2p(dev->base));
+#endif
 
 	res = platform_get_resource(pdev, IORESOURCE_DMA, 1);
 	if (!res) {
diff --git a/sound/soc/davinci/davinci-mcasp.h b/sound/soc/davinci/davinci-mcasp.h
index e755b51..0ce5953 100644
--- a/sound/soc/davinci/davinci-mcasp.h
+++ b/sound/soc/davinci/davinci-mcasp.h
@@ -19,7 +19,11 @@
 #define DAVINCI_MCASP_H
 
 #include <linux/io.h>
+#ifndef CONFIG_ARCH_TI816X
 #include <mach/asp.h>
+#else
+#include <plat/asp.h>
+#endif
 #include "davinci-pcm.h"
 
 extern struct snd_soc_dai davinci_mcasp_dai[];
-- 
1.7.0.2

