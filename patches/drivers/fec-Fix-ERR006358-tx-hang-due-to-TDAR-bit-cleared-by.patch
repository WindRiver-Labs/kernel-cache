From 2dda825f74b2a14998d2a51932fb408fb5f881ac Mon Sep 17 00:00:00 2001
From: "yadi.hu@windriver.com" <yadi.hu@windriver.com>
Date: Tue, 1 Aug 2017 17:02:39 +0800
Subject: [PATCH] fec: Fix ERR006358 tx hang due to TDAR bit cleared by uDMA

MTIP enet IP have one IC issue recorded at PDM ticket:TKT168103

The issue description: The TDAR bit after being set by software is not
acted upon by the ENET module due to the timing of when the ENET state
machine clearing the TDAR bit occurring coincident or momentarily after
the software sets the bit.

this patch is based on upstream
ccea2968398c ("net: fec: better implementation of iMX6 ERR006358 quirk")

Signed-off-by: Hu <yadi.hu@windriver.com>
---
 drivers/net/ethernet/freescale/fec_main.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fec_main.c b/drivers/net/ethernet/freescale/fec_main.c
index 03a3513..1d1e70d 100644
--- a/drivers/net/ethernet/freescale/fec_main.c
+++ b/drivers/net/ethernet/freescale/fec_main.c
@@ -838,6 +838,8 @@ fec_enet_tx(struct net_device *ndev)
 			if (netif_queue_stopped(ndev))
 				netif_wake_queue(ndev);
 		}
+		if (bdp != fep->cur_tx && readl(fep->hwp + FEC_X_DES_ACTIVE) == 0)
+			writel(0, fep->hwp + FEC_X_DES_ACTIVE);
 	}
 	return;
 }
-- 
1.7.5.4

