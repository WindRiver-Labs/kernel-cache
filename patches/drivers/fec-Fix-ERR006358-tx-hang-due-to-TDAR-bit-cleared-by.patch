From 4b031c817ea28a37b90c45a9e935200846bc07ba Mon Sep 17 00:00:00 2001
From: "yadi.hu@windriver.com" <yadi.hu@windriver.com>
Date: Thu, 19 Nov 2015 10:06:22 +0800
Subject: [PATCH] fec: Fix ERR006358 tx hang due to TDAR bit cleared by uDMA

MTIP enet IP have one IC issue recorded at PDM ticket:TKT168103

The issue description: The TDAR bit after being set by software is not
acted upon by the ENET module due to the timing of when the ENET state
machine clearing the TDAR bit occurring coincident or momentarily after
the software sets the bit.

this patch is based on upstream
ccea2968398c ("net: fec: better implementation of iMX6 ERR006358 quirk")

Signed-off-by: Hu <yadi.hu@windriver.com>
---
 drivers/net/ethernet/freescale/fec.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fec.c b/drivers/net/ethernet/freescale/fec.c
index bcb3f7b..8661d29 100644
--- a/drivers/net/ethernet/freescale/fec.c
+++ b/drivers/net/ethernet/freescale/fec.c
@@ -656,6 +656,8 @@ fec_enet_tx(struct net_device *ndev)
 				netif_wake_queue(ndev);
 		}
 	}
+	if (bdp != fep->cur_tx && readl(fep->hwp + FEC_X_DES_ACTIVE) == 0)
+		writel(0, fep->hwp + FEC_X_DES_ACTIVE);
 	fep->dirty_tx = bdp;
 	spin_unlock(&fep->hw_lock);
 }
-- 
1.7.5.4

