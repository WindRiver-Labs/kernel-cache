From 6dfcb0e2703b109bd5a9aee23a4c7eaae08aeeda Mon Sep 17 00:00:00 2001
From: Fei Wu <fei.wu@windriver.com>
Date: Tue, 28 Jul 2009 04:52:35 +0800
Subject: [PATCH] bnx2: Fix problem of using wrong IRQ handler.

commit 690103137267e9ed893febf7ff061af63e8235a9 upstream

The MSI-X handler was chosen before the call to pci_enable_msix().
If MSI-X was not available, the wrong MSI-X handler would be used in
INTA mode.  This would cause a screaming interrupt problem because
INTA would not be cleared by the MSI-X handler.

Fixed by assigning MSI-X handler after pci_enable_msix() returns
successfully.

Signed-off-by: Michael Chan <mchan@broadcom.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[wufei: remove the driver version update because of only picking up
one of the patches]
Integrated-off-by: Fei Wu <fei.wu@windriver.com>
---
 drivers/net/bnx2.c |    8 ++++----
 1 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/net/bnx2.c b/drivers/net/bnx2.c
index ba91aee..d95b3f8 100644
--- a/drivers/net/bnx2.c
+++ b/drivers/net/bnx2.c
@@ -5774,9 +5774,6 @@ bnx2_enable_msix(struct bnx2 *bp, int msix_vecs)
 	for (i = 0; i < BNX2_MAX_MSIX_VEC; i++) {
 		msix_ent[i].entry = i;
 		msix_ent[i].vector = 0;
-
-		strcpy(bp->irq_tbl[i].name, bp->dev->name);
-		bp->irq_tbl[i].handler = bnx2_msi_1shot;
 	}
 
 	rc = pci_enable_msix(bp->pdev, msix_ent, BNX2_MAX_MSIX_VEC);
@@ -5785,8 +5782,11 @@ bnx2_enable_msix(struct bnx2 *bp, int msix_vecs)
 
 	bp->irq_nvecs = msix_vecs;
 	bp->flags |= BNX2_FLAG_USING_MSIX | BNX2_FLAG_ONE_SHOT_MSI;
-	for (i = 0; i < BNX2_MAX_MSIX_VEC; i++)
+	for (i = 0; i < BNX2_MAX_MSIX_VEC; i++) {
 		bp->irq_tbl[i].vector = msix_ent[i].vector;
+		strcpy(bp->irq_tbl[i].name, bp->dev->name);
+		bp->irq_tbl[i].handler = bnx2_msi_1shot;
+	}
 }
 
 static void
-- 
1.6.3.3

