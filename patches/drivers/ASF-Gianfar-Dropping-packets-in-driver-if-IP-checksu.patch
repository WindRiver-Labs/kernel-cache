From 5f301948adc470d3155a80a8ef796f3590c62a95 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Tue, 9 Aug 2011 19:23:17 +0800
Subject: [PATCH 35/47] ASF Gianfar: Dropping packets in driver if IP checksum is incorrect

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
0031-ASF-Gianfar-Dropping-packets-in-driver-if-IP-checksu.patch.

Signed-off-by: Sachin Saxena <sachin.saxena@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/net/gianfar.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 10d3de6..4e1986c 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -3731,6 +3731,12 @@ static int gfar_process_frame(struct net_device *dev, struct sk_buff *skb,
 	if (devfp_rx_hook) {
 		int drop = 0;
 
+		/* Drop the packet silently if IP Checksum is not correct */
+		if ((fcb->flags & RXFCB_CIP) && (fcb->flags & RXFCB_EIP)) {
+			drop = 1;
+			goto drop_pkt;
+		}
+
 		if (priv->vlgrp && (fcb->flags & RXFCB_VLN)) {
 			struct net_device *vlan_dev = NULL;
 
@@ -3747,6 +3753,7 @@ static int gfar_process_frame(struct net_device *dev, struct sk_buff *skb,
 			skb->dev = dev;
 		}
 
+drop_pkt:
 		if (drop) {
 			dev_kfree_skb_any(skb);
 			return 0;
-- 
1.7.0.2

