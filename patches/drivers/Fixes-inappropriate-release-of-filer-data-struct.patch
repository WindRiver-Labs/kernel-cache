From d94fdfb4f20c722f6d8ff7f2b406f30ddc214982 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Tue, 9 Aug 2011 19:23:23 +0800
Subject: [PATCH 41/47] Fixes inappropriate release of filer data struct

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-Fixes-inappropriate-release-of-filer-da.patch.

Signed-off-by: Rajan Srivastava, B34330 <rajan.srivastava@freescale.com>
Signed-off-by: Akhil Goyal <akhil.goyal@freescale.com>
Signed-off-by: Li Yang <leoli@freescale.com>

[Move "Program the RIR0 reg with the required distribution" to proper position,
 this change contains in patch "gianfar:hardware TCP receive offload" which is
 not ported.
]

Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/net/gianfar.c |    9 +++++----
 1 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index d9a44ef..46b1566 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -1078,6 +1078,9 @@ static void gfar_init_filer_table(struct gfar_private *priv)
 	/* cur_filer_idx indicated the fisrt non-masked rule */
 	priv->cur_filer_idx = rqfar;
 
+	/* Program the RIR0 reg with the required distribution */
+	priv->gfargrp[0].regs->rir0 = DEFAULT_RIR0;
+
 	/* Rest are masked rules */
 	rqfcr = RQFCR_CMP_NOMATCH;
 	for (i = 0; i < rqfar; i++) {
@@ -1085,13 +1088,11 @@ static void gfar_init_filer_table(struct gfar_private *priv)
 		priv->ftp_rqfpr[i] = rqfpr;
 		gfar_write_filer(priv, i, rqfcr, rqfpr);
 	}
-
-	/* Program the RIR0 reg with the required distribution */
-	priv->gfargrp[0].regs->rir0 = DEFAULT_RIR0;
-
+	return;
 out:
 	kfree(priv->ftp_rqfcr);
 	kfree(priv->ftp_rqfpr);
+	priv->ftp_rqfpr = priv->ftp_rqfcr = NULL;
 }
 
 static void gfar_detect_errata(struct gfar_private *priv)
-- 
1.7.0.2

