From 8cabfda30344b208cfdf014337eba3b5615ecf88 Mon Sep 17 00:00:00 2001
From: Jiri Kosina <jkosina@suse.cz>
Date: Mon, 29 Dec 2014 16:44:29 +0800
Subject: [PATCH] HID: magicmouse: sanity check report size in raw_event() callback

commit c54def7bd64d7c0b6993336abcffb8444795bf38 upstream

The report passed to us from transport driver could potentially be
arbitrarily large, therefore we better sanity-check it so that
magicmouse_emit_touch() gets only valid values of raw_id.

Cc: stable@vger.kernel.org
Reported-by: Steven Vittitoe <scvitti@google.com>
Signed-off-by: Jiri Kosina <jkosina@suse.cz>
[Drop some codes which isn't applicable for this version, and also modify
some codes to apply them to this version]
Signed-off-by: Wenlin Kang <wenlin.kang@windriver.com>
---
 drivers/hid/hid-magicmouse.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/hid/hid-magicmouse.c b/drivers/hid/hid-magicmouse.c
index 0d471fc..1f89f1d 100644
--- a/drivers/hid/hid-magicmouse.c
+++ b/drivers/hid/hid-magicmouse.c
@@ -233,6 +233,11 @@ static int magicmouse_raw_event(struct hid_device *hdev,
 		msc->delta_time = (ts - msc->last_timestamp) & 0x3ffff;
 		msc->last_timestamp = ts;
 		msc->ntouches = (size - 6) / 8;
+		if (msc->ntouches > 15) {
+			dev_warn(&hdev->dev, "invalid size value (%d) for TOUCH_REPORT_ID\n",
+					size);
+			return 0;
+		}
 		for (ii = 0; ii < msc->ntouches; ii++)
 			magicmouse_emit_touch(msc, ii, data + ii * 8 + 6);
 		/* When emulating three-button mode, it is important
-- 
1.7.0

