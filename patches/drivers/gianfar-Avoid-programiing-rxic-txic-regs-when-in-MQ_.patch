From 966c4dd76a458d52b7a0b9e7b0d74189792f1a6f Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Tue, 9 Aug 2011 19:22:57 +0800
Subject: [PATCH 15/47] gianfar: Avoid programiing rxic/txic regs when in MQ_MG_MODE

Programming rxic/txic regs is not required when in MQ_MG_MODE
as we are already programming rxic0/txic0 regs.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-gianfar-Avoid-programiing-rxic-txic-reg.patch.

Signed-off-by: Sandeep Gopalpet <sandeep.kumar@freescale.com>
Signed-off-by: Jiajun Wu <b06378@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/net/gianfar.c |   17 ++++++++++-------
 1 files changed, 10 insertions(+), 7 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 7aeb505..9df9afc 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -2333,9 +2333,11 @@ void gfar_configure_tx_coalescing(struct gfar_private *priv,
 	/* Backward compatible case ---- even if we enable
 	 * multiple queues, there's only single reg to program
 	 */
-	gfar_write(&regs->txic, 0);
-	if(likely(priv->tx_queue[0]->txcoalescing))
-		gfar_write(&regs->txic, priv->tx_queue[0]->txic);
+	if (priv->mode == SQ_SG_MODE) {
+		gfar_write(&regs->txic, 0);
+		if (likely(priv->tx_queue[0]->txcoalescing))
+			gfar_write(&regs->txic, priv->tx_queue[0]->txic);
+	}
 
 	if (priv->mode == MQ_MG_MODE) {
 		baddr = &regs->txic0;
@@ -2349,7 +2351,6 @@ void gfar_configure_tx_coalescing(struct gfar_private *priv,
 			}
 			mask = mask << 0x1;
 		}
-
 	}
 }
 
@@ -2363,9 +2364,11 @@ void gfar_configure_rx_coalescing(struct gfar_private *priv,
 	/* Backward compatible case ---- even if we enable
 	 * multiple queues, there's only single reg to program
 	 */
-	gfar_write(&regs->rxic, 0);
-	if (unlikely(priv->rx_queue[0]->rxcoalescing))
-		gfar_write(&regs->rxic, priv->rx_queue[0]->rxic);
+	if (priv->mode == SQ_SG_MODE) {
+		gfar_write(&regs->rxic, 0);
+		if (unlikely(priv->rx_queue[0]->rxcoalescing))
+			gfar_write(&regs->rxic, priv->rx_queue[0]->rxic);
+	}
 
 	if (priv->mode == MQ_MG_MODE) {
 		baddr = &regs->rxic0;
-- 
1.7.0.2

