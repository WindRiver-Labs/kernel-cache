From 8504e6283d8d4cb215208459268aef0cc5c9c481 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Tue, 9 Aug 2011 19:23:12 +0800
Subject: [PATCH 30/47] Gianfar: Update control register for enable/disable PTP at runtime

Update RCTRL_TS_ENABLE bit in rctrl and TMR_CTRL_ENABLE bit in
tmr_ctrl register for enabling/disabling PTP at runtime.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-Gianfar-Update-control-register-for-ena.patch.

Signed-off-by: Akhil Goyal <akhil.goyal@freescale.com>
Signed-off-by: Li Yang <leoli@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/net/gianfar_1588.c |   14 ++++++++++++++
 1 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/drivers/net/gianfar_1588.c b/drivers/net/gianfar_1588.c
index a9c15d1..bc2eccb 100644
--- a/drivers/net/gianfar_1588.c
+++ b/drivers/net/gianfar_1588.c
@@ -727,6 +727,7 @@ static int gfar_1588_proc_write(struct file *file, const char *buffer,
 	struct of_device *ofdev;
 	struct gfar_1588_data_t *gfar_1588_info = \
 				(struct gfar_1588_data_t *)data;
+	struct gfar __iomem *regs;
 
 	if (count > GFAR_1588_PROCFS_MAX_SIZE)
 		count = GFAR_1588_PROCFS_MAX_SIZE;
@@ -765,12 +766,25 @@ static int gfar_1588_proc_write(struct file *file, const char *buffer,
 		} else {
 			ofdev = of_find_device_by_node(np);
 			priv = dev_get_drvdata(&ofdev->dev);
+			regs = priv->gfargrp[0].regs;
 			if (!strcmp(gfar_1588_info->value, "0")) {
 				printk(KERN_DEBUG "\r\n PTPD OFF \r\n");
 				priv->ptimer_present = 0;
+				gfar_write(&priv->ptimer->tmr_ctrl,
+					gfar_read(&priv->ptimer->tmr_ctrl)
+							& ~TMR_CTRL_ENABLE);
+				gfar_write(&regs->rctrl,
+					gfar_read(&regs->rctrl)
+							& ~RCTRL_TS_ENABLE);
 			} else if (!strcmp(gfar_1588_info->value, "1")) {
 				printk(KERN_DEBUG "\r\n PTPD ON \r\n");
 				priv->ptimer_present = 1;
+				gfar_write(&priv->ptimer->tmr_ctrl,
+					gfar_read(&priv->ptimer->tmr_ctrl)
+							| TMR_CTRL_ENABLE);
+				gfar_write(&regs->rctrl,
+					gfar_read(&regs->rctrl)
+							| RCTRL_TS_ENABLE);
 			}
 		}
 	}
-- 
1.7.0.2

