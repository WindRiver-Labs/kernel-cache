From e819a63b8bef102548f179af4fb7c7e798a76369 Mon Sep 17 00:00:00 2001
From: David Woodhouse <David.Woodhouse@intel.com>
Date: Sun, 9 Mar 2014 13:25:07 -0700
Subject: [PATCH 62/97] iommu/vt-d: Use domain_remove_one_dev_info() in
 domain_add_dev_info() error path

commit e2f8c5f6d45b092b52adea9d71018ef11250b924 upstream.

Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>
Signed-off-by: Liwei Song <liwei.song@windriver.com>
---
 drivers/iommu/intel-iommu.c |    8 +-------
 1 files changed, 1 insertions(+), 7 deletions(-)

diff --git a/drivers/iommu/intel-iommu.c b/drivers/iommu/intel-iommu.c
index 7eb9205..0b23f01 100644
--- a/drivers/iommu/intel-iommu.c
+++ b/drivers/iommu/intel-iommu.c
@@ -2465,8 +2465,6 @@ static int domain_add_dev_info(struct dmar_domain *domain,
 			       int translation)
 {
 	struct dmar_domain *ndomain;
-	struct device_domain_info *info;
-	unsigned long flags;
 	int ret;
 
 	ndomain = dmar_insert_dev_info(pci_domain_nr(pdev->bus),
@@ -2477,11 +2475,7 @@ static int domain_add_dev_info(struct dmar_domain *domain,
 
 	ret = domain_context_mapping(domain, pdev, translation);
 	if (ret) {
-		spin_lock_irqsave(&device_domain_lock, flags);
-		info = pdev->dev.archdata.iommu;
-		unlink_domain_info(info);
-		spin_unlock_irqrestore(&device_domain_lock, flags);
-		free_devinfo_mem(info);
+		domain_remove_one_dev_info(domain, pdev);
 		return ret;
 	}
 
-- 
1.7.5.4

