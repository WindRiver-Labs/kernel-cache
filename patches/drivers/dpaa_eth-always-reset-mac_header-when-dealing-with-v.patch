From 1f00b62aaa0ceb23d238c95defd9be742733c276 Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Tue, 8 Jan 2013 16:17:00 +0800
Subject: [PATCH] dpaa_eth: always reset mac_header when dealing with vlan

Extracted from QorIQ-DPAA-SDK-v1.1-20111026-systembuilder.iso:
"dpaa_eth: Ethernet driver for Freescale QorIQ DPA Architecture"

Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 drivers/net/dpa/dpaa_eth.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/drivers/net/dpa/dpaa_eth.c b/drivers/net/dpa/dpaa_eth.c
index a3da10c..f55aa3b 100644
--- a/drivers/net/dpa/dpaa_eth.c
+++ b/drivers/net/dpa/dpaa_eth.c
@@ -1056,8 +1056,12 @@ static inline int dpa_enable_tx_csum(struct dpa_priv_s *priv,
 	parse_result = (t_FmPrsResult *)parse_results;
 
 	/* If we're dealing with VLAN, get the real Ethernet type */
-	if (ethertype == ETH_P_8021Q)
+	if (ethertype == ETH_P_8021Q) {
+		/* We can't always assume the MAC header is set correctly
+		   * by the stack, so reset to beginning of skb->data */
+		skb_reset_mac_header(skb);
 		ethertype = ntohs(vlan_eth_hdr(skb)->h_vlan_encapsulated_proto);
+	}
 
 	/* Fill in the relevant L3 parse result fields
 	 * and read the L4 protocol type */
-- 
1.7.0

