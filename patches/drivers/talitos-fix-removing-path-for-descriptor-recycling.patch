From d371f13a71c04f4205a8d362afe6ed62056929f2 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Tue, 28 Jun 2011 16:34:59 +0800
Subject: [PATCH 09/47] talitos: fix removing path for descriptor recycling

If 'fsl,multi-host-mode' is not set correctly, talitos_probe will not create
netcrypto_cache block and goto err_out, and priv->netcrypto_cache will try
to be freed in talitos_remove, so if it's NULL, then kernel will panic.

Fix this problem by adding sanity test.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-talitos-fix-removing-path-for-descripto.patch.

Signed-off-by: Li Yang <leoli@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/crypto/talitos.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/crypto/talitos.c b/drivers/crypto/talitos.c
index 7695689..20ebefd 100644
--- a/drivers/crypto/talitos.c
+++ b/drivers/crypto/talitos.c
@@ -2331,7 +2331,8 @@ static int talitos_remove(struct of_device *ofdev)
 
 	dev_set_drvdata(dev, NULL);
 
-	kmem_cache_destroy(priv->netcrypto_cache);
+	if (priv->netcrypto_cache != NULL)
+		kmem_cache_destroy(priv->netcrypto_cache);
 	kfree(priv);
 
 	return 0;
-- 
1.7.0.4

