From 4bf2a84cece8066c56a3fe7b17a8cd54b190025a Mon Sep 17 00:00:00 2001
From: Wang Hui <Hui.Wang@windriver.com>
Date: Fri, 18 Dec 2009 14:06:46 +0800
Subject: [PATCH 08/11] netdriver/smc911x: replace reset to save original reg state on resume

The resume function will call smc911x_reset, in smc911x_reset function
, it will reset all smc911x registers. But some registers will be
changed on the fly by users and should not be reset, e.g. those
registers related to multicast.

Signed-off-by: Wang Hui <Hui.Wang@windriver.com>
---
 drivers/net/smc911x.c |   11 ++++++++++-
 1 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/drivers/net/smc911x.c b/drivers/net/smc911x.c
index 1b9dae6..7471ee3 100644
--- a/drivers/net/smc911x.c
+++ b/drivers/net/smc911x.c
@@ -2181,9 +2181,18 @@ static int smc911x_drv_resume(struct platform_device *dev)
 	DBG(SMC_DEBUG_FUNC, "--> %s\n", __func__);
 	if (ndev) {
 		struct smc911x_local *lp = netdev_priv(ndev);
+		unsigned int reg, timeout = 0;
 
 		if (netif_running(ndev)) {
-			smc911x_reset(ndev);
+			SMC_SET_BYTE_TEST(lp, 0);
+			timeout = 10000;
+			do {
+				udelay(10);
+				reg = SMC_GET_PMT_CTRL(lp) & PMT_CTRL_READY_;
+			} while (--timeout && !reg);
+			if (timeout == 0)
+				PRINTK("%s: smc911x_reset timeout waiting for"
+					"PM restore\n", dev->name);
 			if (lp->phy_type != 0)
 				smc911x_phy_configure(&lp->phy_configure);
 			smc911x_enable(ndev);
-- 
1.6.5.2

