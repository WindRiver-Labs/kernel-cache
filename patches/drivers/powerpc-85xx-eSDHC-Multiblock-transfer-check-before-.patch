From fff1b0e21cc64bd30cc8f63c0e5b8ffb20340d9a Mon Sep 17 00:00:00 2001
From: Dipen Dudhat <dipen.dudhat@freescale.com>
Date: Tue, 12 Jan 2010 19:39:18 +0800
Subject: [PATCH] powerpc/85xx: eSDHC: Multiblock transfer check before sending the command

Extracted from the P1020RDB_20100507-ltib.iso vendor drop

Without this patch, there will be following errors:

mmc0: Timeout waiting for hardware interrupt.
mmcblk0: retrying using single block read
mmcblk0: error -84 transferring data, sector 135, nr 32, card status 0x900
end_request: I/O error, dev mmcblk0, sector 135
Buffer I/O error on device mmcblk0p1, logical block 0
mmcblk0: error -84 transferring data, sector 136, nr 31, card status 0x900
end_request: I/O error, dev mmcblk0, sector 136
Buffer I/O error on device mmcblk0p1, logical block 1
mmcblk0: error -84 transferring data, sector 137, nr 30, card status 0x900
end_request: I/O error, dev mmcblk0, sector 137
Buffer I/O error on device mmcblk0p1, logical block 2
mmcblk0: error -84 transferring data, sector 138, nr 29, card status 0x900
end_request: I/O error, dev mmcblk0, sector 138
...

Signed-off-by: Dipen Dudhat <dipen.dudhat@freescale.com>
[Added the error log]
Integrated-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 drivers/mmc/host/sdhci.c |    3 +++
 drivers/mmc/host/sdhci.h |    1 +
 2 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.c
index f3a3980..79a21ba 100644
--- a/drivers/mmc/host/sdhci.c
+++ b/drivers/mmc/host/sdhci.c
@@ -934,6 +934,9 @@ static void sdhci_send_command(struct sdhci_host *host, struct mmc_command *cmd)
 	if (cmd->data)
 		flags |= SDHCI_CMD_DATA;
 
+	if (host->mrq->data && (cmd == host->mrq->data->stop))
+		flags = flags | SDHCI_CMD_ABORT;
+
 	sdhci_writew(host, SDHCI_MAKE_CMD(cmd->opcode, flags), SDHCI_COMMAND);
 }
 
diff --git a/drivers/mmc/host/sdhci.h b/drivers/mmc/host/sdhci.h
index face3c4..21526f5 100644
--- a/drivers/mmc/host/sdhci.h
+++ b/drivers/mmc/host/sdhci.h
@@ -49,6 +49,7 @@
 #define  SDHCI_CMD_CRC		0x08
 #define  SDHCI_CMD_INDEX	0x10
 #define  SDHCI_CMD_DATA		0x20
+#define  SDHCI_CMD_ABORT	0xC0
 
 #define  SDHCI_CMD_RESP_NONE	0x00
 #define  SDHCI_CMD_RESP_LONG	0x01
-- 
1.6.5.2

