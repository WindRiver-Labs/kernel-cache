From 4133655f96ebd1e3e9f4201d5d5df6aefb278eb6 Mon Sep 17 00:00:00 2001
From: Poonam Aggrwal <poonam.aggrwal@freescale.com>
Date: Thu, 30 Sep 2010 11:27:27 +0530
Subject: [PATCH 5/5] TDM:TDM and Legerity driver modified according to latest "of Platform" changes.

Fixing the build break of TDM and SLIC driver on 2.6.34.

Signed-off-by: Poonam Aggrwal <poonam.aggrwal@freescale.com>

[Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso.]

Integrated-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/tdm/device/tdm_fsl_starlite.c |   16 ++++++++--------
 drivers/tdm/line_ctrl/slic_zarlink.c  |    4 ++--
 drivers/tdm/test/tdm_test.c           |    2 +-
 3 files changed, 11 insertions(+), 11 deletions(-)

diff --git a/drivers/tdm/device/tdm_fsl_starlite.c b/drivers/tdm/device/tdm_fsl_starlite.c
index 3dd78d0..2bfab79 100644
--- a/drivers/tdm/device/tdm_fsl_starlite.c
+++ b/drivers/tdm/device/tdm_fsl_starlite.c
@@ -604,20 +604,20 @@ static int __devinit tdm_fsl_starlite_probe(struct of_device *ofdev,
 	dev_set_drvdata(&ofdev->dev, priv);
 	priv->device = &ofdev->dev;
 
-	ret = of_address_to_resource(ofdev->node, 0, &res);
+	ret = of_address_to_resource(ofdev->dev.of_node, 0, &res);
 	if (ret) {
 		ret = -EINVAL;
 		goto err_resource;
 	}
 	priv->ptdm_base = res.start;
 
-	priv->tdm_regs = of_iomap(ofdev->node, 0);
+	priv->tdm_regs = of_iomap(ofdev->dev.of_node, 0);
 	if (!priv->tdm_regs) {
 		ret = -ENOMEM;
 		goto err_tdmregs;
 	}
 
-	priv->dmac_regs = of_iomap(ofdev->node, 1);
+	priv->dmac_regs = of_iomap(ofdev->dev.of_node, 1);
 	if (!priv->dmac_regs) {
 		ret = -ENOMEM;
 		goto err_dmacreg;
@@ -631,13 +631,13 @@ static int __devinit tdm_fsl_starlite_probe(struct of_device *ofdev,
 	    (struct tdm_clock *)(TDM_CLKREG_OFFSET + (u8 *)priv->tdm_regs);
 
 	/* irqs mapping for tdm err/dmac err, dmac done */
-	priv->tdm_err_intr = irq_of_parse_and_map(ofdev->node, 0);
+	priv->tdm_err_intr = irq_of_parse_and_map(ofdev->dev.of_node, 0);
 	if (priv->tdm_err_intr == NO_IRQ) {
 		ret = -EINVAL;
 		goto err_tdmerr_irqmap;
 	}
 
-	priv->dmac_done_intr = irq_of_parse_and_map(ofdev->node, 1);
+	priv->dmac_done_intr = irq_of_parse_and_map(ofdev->dev.of_node, 1);
 	if (priv->dmac_done_intr == NO_IRQ) {
 		ret = -EINVAL;
 		goto err_dmacdone_irqmap;
@@ -771,13 +771,13 @@ static const struct of_device_id fsl_tdm_of_match[] = {
 MODULE_DEVICE_TABLE(of, fsl_tdm_of_match);
 
 static struct of_platform_driver tdm_fsl_starlite_driver = {
-	.match_table	= fsl_tdm_of_match,
-	.probe		= tdm_fsl_starlite_probe,
-	.remove		= __devexit_p(tdm_fsl_starlite_remove),
 	.driver		= {
 		.owner	= THIS_MODULE,
 		.name	= DRV_NAME,
+		.of_match_table	= fsl_tdm_of_match,
 	},
+	.probe		= tdm_fsl_starlite_probe,
+	.remove		= __devexit_p(tdm_fsl_starlite_remove),
 };
 
 static int __init tdm_fsl_starlite_init(void)
diff --git a/drivers/tdm/line_ctrl/slic_zarlink.c b/drivers/tdm/line_ctrl/slic_zarlink.c
index 23b8bc5..46a4af3 100644
--- a/drivers/tdm/line_ctrl/slic_zarlink.c
+++ b/drivers/tdm/line_ctrl/slic_zarlink.c
@@ -33,7 +33,7 @@
     But we have used so much of her original code and ideas that it seems
     only fair to recognize her as co-author -- Rajesh & Hemant */
 
-#include <linux/autoconf.h>
+
 #include <linux/module.h>
 #include <linux/device.h>
 #include <linux/kernel.h>
@@ -599,7 +599,7 @@ void configure_spi_pdata(struct spi_device *spi)
 {
 	struct slic_platform_data *spi_slic_pdata;
 	const u32 *iprop;
-	struct device_node *np = spi->dev.archdata.of_node;
+	struct device_node *np = spi->dev.of_node;
 
 	spi_slic_pdata = kzalloc(sizeof(*spi_slic_pdata), GFP_KERNEL);
 	if (spi_slic_pdata == NULL)
diff --git a/drivers/tdm/test/tdm_test.c b/drivers/tdm/test/tdm_test.c
index f542eab..f0f8e84 100644
--- a/drivers/tdm/test/tdm_test.c
+++ b/drivers/tdm/test/tdm_test.c
@@ -25,7 +25,7 @@
  * with this program; if not, write  to the Free Software Foundation, Inc.,
  * 675 Mass Ave, Cambridge, MA 02139, USA.
  */
-#include <linux/autoconf.h>
+
 #include <linux/module.h>
 #include <linux/device.h>
 #include <linux/kernel.h>
-- 
1.7.0.4

