From 4dd9cfbc383f16efd784ab8135297daaed15f662 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Tue, 9 Aug 2011 19:23:09 +0800
Subject: [PATCH 27/47] Gianfar: Fix Mapping of FCB QT value to gianfar existing virtual queues

        - Somtimes eTSEC filer misbehave and put garbage value in FCB.QT field.
        - If FCB->QT field contains a value > num_rx_queues then a direct
          mapping to virtual queues using QT as index will result in a CRASH,
          when we are going to free the SKB.
          Thus, need to map the QT value to existing virtual queues only,
          using modulo by num_rx_queues.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
0009-Gianfar-Fixing-Mapping-of-FCB-QT-value-to-gianfar-ex.patch.

Signed-off-by: Sachin Saxena <sachin.saxena@freescale.com>
Signed-off-by: Li Yang <leoli@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/net/gianfar.c |   12 +++++++++++-
 1 files changed, 11 insertions(+), 1 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 73a01d0..4d6d64c 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -3648,7 +3648,17 @@ static int gfar_process_frame(struct net_device *dev, struct sk_buff *skb,
 	/* Remove the FCB from the skb */
 	/* Remove the padded bytes, if there are any */
 	if (amount_pull) {
-		skb_record_rx_queue(skb, fcb->rq);
+		int queue_map;
+
+		/* If FCB->QT field contains a value > num_rx_queues then
+		   a direct mapping to virtual queues using QT as index will
+		   result in a CRASH, when we are going to free the SKB.
+		   So, need to map the QT value to existing virtual queues only.
+		   using modulo by num_rx_queues.
+		 */
+		queue_map = fcb->rq - (priv->num_rx_queues *
+				(fcb->rq/priv->num_rx_queues));
+		skb_record_rx_queue(skb, queue_map);
 		skb_pull(skb, amount_pull);
 	}
 
-- 
1.7.0.2

