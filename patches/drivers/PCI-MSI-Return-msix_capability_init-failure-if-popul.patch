From 34bedf32cbfe76859f5b8077ec782c3116a6b121 Mon Sep 17 00:00:00 2001
From: Alexander Gordeev <agordeev@redhat.com>
Date: Mon, 16 Dec 2013 09:34:56 +0100
Subject: [PATCH] PCI/MSI: Return msix_capability_init() failure if
 populate_msi_sysfs() fails

commit 2adc7907bac2c72535894732c4b41f9210f9e577 upstream

If populate_msi_sysfs() function failed msix_capability_init() must return
the error code, but it returns the success instead.  This update fixes the
described misbehaviour.

Signed-off-by: Alexander Gordeev <agordeev@redhat.com>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Reviewed-by: Tejun Heo <tj@kernel.org>
Signed-off-by: fupan li <fupan.li@windriver.com>
[PG: fixup additional goto that was imported via 3.10.62's cherry
 pick of commit f144d1496b47e7450f41b767d0d91c724c2198bc upstream.
 "PCI/MSI: Add device flag indicating that 64-bit MSIs don't work"]
Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/drivers/pci/msi.c b/drivers/pci/msi.c
index 8774fb8ab373..bf54371376e2 100644
--- a/drivers/pci/msi.c
+++ b/drivers/pci/msi.c
@@ -792,12 +792,12 @@ static int msix_capability_init(struct pci_dev *dev,
 
 	ret = arch_setup_msi_irqs(dev, nvec, PCI_CAP_ID_MSIX);
 	if (ret)
-		goto error;
+		goto out_avail;
 
 	/* Check if all MSI entries honor device restrictions */
 	ret = msi_verify_entries(dev);
 	if (ret)
-		goto error;
+		goto out_avail;
 
 	/*
 	 * Some devices require MSI-X to be enabled before we can touch the
@@ -810,10 +810,8 @@ static int msix_capability_init(struct pci_dev *dev,
 	msix_program_entries(dev, entries);
 
 	ret = populate_msi_sysfs(dev);
-	if (ret) {
-		ret = 0;
-		goto error;
-	}
+	if (ret)
+		goto out_free;
 
 	/* Set MSI-X enabled bits and unmask the function */
 	pci_intx_for_msi(dev, 0);
@@ -824,7 +822,7 @@ static int msix_capability_init(struct pci_dev *dev,
 
 	return 0;
 
-error:
+out_avail:
 	if (ret < 0) {
 		/*
 		 * If we had some success, report the number of irqs
@@ -841,6 +839,7 @@ error:
 			ret = avail;
 	}
 
+out_free:
 	free_msi_irqs(dev);
 
 	return ret;
-- 
2.1.0

