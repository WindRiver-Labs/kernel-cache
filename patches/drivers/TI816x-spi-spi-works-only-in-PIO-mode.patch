From fa946e5be5713887e648ca1b0af76d4b304a98cd Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Thu, 23 Jun 2011 17:41:55 +0800
Subject: [PATCH 14/20] TI816x spi: spi works only in PIO mode

This patch is based on below commit from arago git tree.
git://arago-project.org/git/projects/linux-omap3.git
ff2ce5 ti816x: mcspi PIO mode support validated on ti8168 evm

Signed-off-by: Mansoor Ahamed <mansoor.ahamed@ti.com>
[This one is picked from the original commit to compatible
with wrlinux tree]
Integrated-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 drivers/spi/omap2_mcspi.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/drivers/spi/omap2_mcspi.c b/drivers/spi/omap2_mcspi.c
index eae914f..3d3dab9 100644
--- a/drivers/spi/omap2_mcspi.c
+++ b/drivers/spi/omap2_mcspi.c
@@ -113,8 +113,11 @@ struct omap2_mcspi_dma {
 /* use PIO for small transfers, avoiding DMA setup/teardown overhead and
  * cache operations; better heuristics consider wordsize and bitrate.
  */
+#if defined(CONFIG_ARCH_TI816X) /* TI816x works only in PIO */
+#define DMA_MIN_BYTES			(4 * 1024 * 1024)
+#else
 #define DMA_MIN_BYTES			8
-
+#endif
 
 struct omap2_mcspi {
 	struct work_struct	work;
@@ -571,8 +574,10 @@ omap2_mcspi_txrx_pio(struct spi_device *spi, struct spi_transfer *xfer)
 		 * otherwise these rx datas will affect the direct following
 		 * RX_ONLY transfer.
 		 */
+#ifndef CONFIG_ARCH_TI816X
 		omap2_mcspi_set_enable(spi, 0);
 		omap2_mcspi_set_enable(spi, 1);
+#endif
 	}
 out:
 	return count - c;
-- 
1.7.0.2

