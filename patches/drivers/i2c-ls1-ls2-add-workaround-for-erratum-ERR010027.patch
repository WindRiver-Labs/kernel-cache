From 87be8c55ccb99fc324dacd6e504a779d3fc95783 Mon Sep 17 00:00:00 2001
From: Ying Zhang <b40530@freescale.com>
Date: Wed, 30 Mar 2016 13:52:23 +0800
Subject: [PATCH] i2c: ls1/ls2: add workaround for erratum ERR010027

Patch from https://patchwork.ozlabs.org/patch/573886/

ERR010027/ERR008951: Attempting a start cycle while the
bus is busy may generate a short clock pulse.

Software must ensure that the I2C BUS is idle by checking the
bus busy before switching to master mode and attempting a Start
cycle.

Signed-off-by: Ying Zhang <b40530@freescale.com>
Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 drivers/i2c/busses/i2c-imx.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/drivers/i2c/busses/i2c-imx.c b/drivers/i2c/busses/i2c-imx.c
index 584e002..44e4cf8 100644
--- a/drivers/i2c/busses/i2c-imx.c
+++ b/drivers/i2c/busses/i2c-imx.c
@@ -527,6 +527,13 @@ static int i2c_imx_xfer(struct i2c_adapter *adapter,
 
 	dev_dbg(&i2c_imx->adapter.dev, "<%s>\n", __func__);
 
+	/* workround for ERR010027: ensure that the I2C BUS is idle
+	 * before switching to master mode and attempting a Start cycle
+	 */
+	result = i2c_imx_bus_busy(i2c_imx, 0);
+	if (result)
+		goto fail0;
+
 	/* Start I2C transfer */
 	result = i2c_imx_start(i2c_imx);
 	if (result)
-- 
1.7.5.4

