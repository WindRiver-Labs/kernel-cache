From 148ad1e5a32e7e0d0bcfc1ff1a99410c138b0559 Mon Sep 17 00:00:00 2001
From: Liwei Song <liwei.song@windriver.com>
Date: Thu, 16 Apr 2015 13:53:55 +0800
Subject: [PATCH 108/108] usb: hcd: do not use usb_poll_irq() function in rt
 kernel

Since "commit ca3f855420f412b5e6b0e958faab7698621801a1
usb-serial-console: try to poll the hcd vs dropping data"
when use usb_poll_irq(), the function must be called with the interrupts
off as it forcibly polling the hcd device to drain the urb queue in
order to initiate the bulk write call backs, But here the function was
called
without interrupt disabled, then the check function
WARN_ON_ONCE(!irqs_disabled()) will give a calltrace warnning.
In the function the usb_poll_irq() is  called, make it depend on
!RT_FULL

This commit will fix the following calltrace:

[ 14.437391] CPU: 3 PID: 118 Comm: khubd Not tainted
3.14.29ltsi-rt22-WR7.0.0.4_preempt-rt #1
[ 14.437393] Hardware name: Intel Corp. GRANGEVILLE/GRANTLEY, BIOS
GNVDCRB1.86B.0030.V02.1411131050 11/13/2014
[ 14.437397] 0000000000000009 ffff880feb4376a8 ffffffff81a858c7
0000000000000000
[ 14.437400] ffff880feb4376e0 ffffffff8104e6cd ffff880fe8391800
ffffffff8257d098
[ 14.437402] 0000000000002710 ffff880fe6e5d208 ffff880fe6e5d200
ffff880feb4376f0
[ 14.437403] Call Trace:
[ 14.437410] [<ffffffff81a858c7>] dump_stack+0x4e/0x7a
[ 14.437416] [<ffffffff8104e6cd>] warn_slowpath_common+0x7d/0xc0
[ 14.437420] [<ffffffff8104e7ca>] warn_slowpath_null+0x1a/0x20
[ 14.437423] [<ffffffff816f3c8a>] usb_poll_irq+0x6a/0x80
[ 14.437428] [<ffffffff81730ad9>] usb_do_console_write.isra.0+0x59/0xa0
[ 14.437432] [<ffffffff81730bff>] usb_console_write+0xdf/0x110
[ 14.437437] [<ffffffff810a6e6b>]
call_console_drivers.constprop.18+0xbb/0x120
[ 14.437440] [<ffffffff810a74aa>] console_unlock+0x2ba/0x3f0
[ 14.437444] [<ffffffff810a88e9>] register_console+0x189/0x370
[ 14.437448] [<ffffffff81730c50>] usb_serial_console_init+0x20/0x30
<<end Check call trace in the boot>>

Signed-off-by: Liwei Song <liwei.song@windriver.com>
---
 drivers/usb/serial/console.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/serial/console.c b/drivers/usb/serial/console.c
index aa59dc1..3a17039 100644
--- a/drivers/usb/serial/console.c
+++ b/drivers/usb/serial/console.c
@@ -206,8 +206,10 @@ try_again:
 		count -= retval;
 		buf += retval;
 		udelay(1);
+#ifndef CONFIG_PREEMPT_RT_FULL
 		usb_poll_irq(serial->dev);
 		usb_poll_irq_schedule_flush();
+#endif
 		goto try_again;
 	}
 	pr_debug("%s - return value : %d\n", __func__, retval);
-- 
1.7.5.4

