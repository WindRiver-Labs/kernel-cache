From 81f6f34a7d760c4a914af9d6a7799afbe0261f74 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Tue, 9 Aug 2011 19:23:21 +0800
Subject: [PATCH 39/47] Add compile time flag in GIANFAR to control VLAN support in HW

By default, VLAN support will be in HW. Need to select this flag to enable
VLAN support in SW.
If this flag is selected, the GIANFAR will not export its VLAN HW
feature to Linux.
Linux network will start handling the VLAN header insertion/deletion work.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
0090-Added-compile-time-flag-in-GIANFAR-to-control-VLAN-s.patch.

Signed-off-by: Arun Pathak <arun.pathak@freescale.com>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/net/Kconfig   |    8 ++++++++
 drivers/net/gianfar.c |    8 ++++++--
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/drivers/net/Kconfig b/drivers/net/Kconfig
index 276ecf2..155cc0f 100644
--- a/drivers/net/Kconfig
+++ b/drivers/net/Kconfig
@@ -2428,6 +2428,14 @@ config GIANFAR_L2SRAM
 	help
 	  This option supports BD alloc in L2SRAM.
 
+config GFAR_SW_VLAN
+	bool "Selecting VLAN in SW"
+	depends on GIANFAR
+	help
+	  This option supports VLAN in SW.
+	  If selected, the GIANFAR will not export its VLAN HW feature to Linux.
+	  Linux will start handling the VLAN header insertion/deletion work..
+
 config 1588_MUX_eTSEC1
 	bool "Selecting 1588 signals over eTSEC1 signals"
 	depends on GIANFAR
diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index b34d56e..86d99ad 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -922,7 +922,7 @@ static int gfar_of_init(struct of_device *ofdev, struct net_device **pdev)
 			FSL_GIANFAR_DEV_HAS_COALESCE |
 			FSL_GIANFAR_DEV_HAS_RMON |
 			FSL_GIANFAR_DEV_HAS_MULTI_INTR;
-	if (model && !strcasecmp(model, "eTSEC"))
+	if (model && !strcasecmp(model, "eTSEC")) {
 		priv->device_flags =
 			FSL_GIANFAR_DEV_HAS_GIGABIT |
 			FSL_GIANFAR_DEV_HAS_COALESCE |
@@ -930,8 +930,12 @@ static int gfar_of_init(struct of_device *ofdev, struct net_device **pdev)
 			FSL_GIANFAR_DEV_HAS_MULTI_INTR |
 			FSL_GIANFAR_DEV_HAS_PADDING |
 			FSL_GIANFAR_DEV_HAS_CSUM |
-			FSL_GIANFAR_DEV_HAS_VLAN |
 			FSL_GIANFAR_DEV_HAS_EXTENDED_HASH;
+#ifndef CONFIG_GFAR_SW_VLAN
+		priv->device_flags |=
+			FSL_GIANFAR_DEV_HAS_VLAN;
+#endif
+	}
 
 	ctype = of_get_property(np, "phy-connection-type", NULL);
 
-- 
1.7.0.2

