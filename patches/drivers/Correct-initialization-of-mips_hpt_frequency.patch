From 19fd913965a0e0adb7a4ace1ddc0a953b6401fa3 Mon Sep 17 00:00:00 2001
From: Phil Staub <Phil.Staub@windriver.com>
Date: Wed, 4 Feb 2009 14:41:06 -0800
Subject: [PATCH] Correct initialization of mips_hpt_frequency

For non-simulated environments, set the mips_hpt_frequency to the
actual frequency by referencing the value of zbbus_mhz, which
runs at 1/2 the clock frequency.

Signed-off-by: Phil Staub <Phil.Staub@windriver.com>
---
 arch/mips/sibyte/bcm1480/time.c |    6 +++++-
 arch/mips/sibyte/sb1250/time.c  |    6 +++++-
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/arch/mips/sibyte/bcm1480/time.c b/arch/mips/sibyte/bcm1480/time.c
index 5439018..c2d35d9 100644
--- a/arch/mips/sibyte/bcm1480/time.c
+++ b/arch/mips/sibyte/bcm1480/time.c
@@ -20,7 +20,11 @@
 #ifdef CONFIG_SIMULATION
 #define BCM1480_HPT_VALUE       50000
 #else
-#define BCM1480_HPT_VALUE       1000000
+/* zbbus_mhz is an exported symbol initialized in bcm1480_setup() to that it
+ * contains the zbbus frequency in MHz. The zbbus runs as 1/2 the clock
+ * frequency. */
+extern unsigned int zbbus_mhz;
+#define BCM1480_HPT_VALUE	(zbbus_mhz * 2 * 1000000)
 #endif
 
 extern unsigned int mips_hpt_frequency;
diff --git a/arch/mips/sibyte/sb1250/time.c b/arch/mips/sibyte/sb1250/time.c
index 1212cd8..05b92ff 100644
--- a/arch/mips/sibyte/sb1250/time.c
+++ b/arch/mips/sibyte/sb1250/time.c
@@ -23,7 +23,11 @@ extern void sb1250_clockevent_init(void);
 #ifdef CONFIG_SIMULATION
 #define BCM1250_HPT_VALUE       50000
 #else
-#define BCM1250_HPT_VALUE       1000000
+/* zbbus_mhz is an exported symbol initialized in bcm1250_setup() to that it
+ * contains the zbbus frequency in MHz. The zbbus runs as 1/2 the clock
+ * frequency. */
+extern unsigned int zbbus_mhz;
+#define BCM1250_HPT_VALUE       (zbbus_mhz * 2 * 1000000)
 #endif
 
 extern unsigned int mips_hpt_frequency;
-- 
1.6.0.3

