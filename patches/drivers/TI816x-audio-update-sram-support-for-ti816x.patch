From 17821eeea89a1e7081b425238af8cac08bb31eca Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Fri, 24 Jun 2011 14:21:01 +0800
Subject: [PATCH 16/20] TI816x audio: update sram support for ti816x

For ti816x, there is no sram support for audio,
asp.h and sram.h is located in plat folder.

This patch is based on below commit from arago git tree.
git://arago-project.org/git/projects/linux-omap3.git
6acfc3 TI816X:Revert "ASoC: DaVinci: pcm, fix underrun by using sram"

Signed-off-by: Vaibhav Bedia <vaibhav.bedia@ti.com>
[This one is picked from the original commit to compatible
with wrlinux tree]
Integrated-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 sound/soc/davinci/davinci-pcm.c |   12 ++++++++++++
 sound/soc/davinci/davinci-pcm.h |    4 ++++
 2 files changed, 16 insertions(+), 0 deletions(-)

diff --git a/sound/soc/davinci/davinci-pcm.c b/sound/soc/davinci/davinci-pcm.c
index 2dc406f..35b4045 100644
--- a/sound/soc/davinci/davinci-pcm.c
+++ b/sound/soc/davinci/davinci-pcm.c
@@ -24,7 +24,11 @@
 
 #include <asm/dma.h>
 #include <mach/edma.h>
+#ifdef CONFIG_ARCH_TI816X
+#include <plat/sram.h>
+#else
 #include <mach/sram.h>
+#endif
 
 #include "davinci-pcm.h"
 
@@ -227,6 +231,7 @@ static void davinci_pcm_dma_irq(unsigned link, u16 ch_status, void *data)
 	}
 }
 
+#ifndef CONFIG_ARCH_TI816X
 static int allocate_sram(struct snd_pcm_substream *substream, unsigned size,
 		struct snd_pcm_hardware *ppcm)
 {
@@ -257,6 +262,7 @@ exit2:
 exit1:
 	return -ENOMEM;
 }
+#endif
 
 /*
  * Only used with ping/pong.
@@ -659,7 +665,9 @@ static int davinci_pcm_open(struct snd_pcm_substream *substream)
 
 	ppcm = (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) ?
 			&pcm_hardware_playback : &pcm_hardware_capture;
+#ifndef CONFIG_ARCH_TI816X
 	allocate_sram(substream, params->sram_size, ppcm);
+#endif
 	snd_soc_set_runtime_hwparams(substream, ppcm);
 	/* ensure that buffer size is a multiple of period size */
 	ret = snd_pcm_hw_constraint_integer(runtime,
@@ -788,7 +796,9 @@ static void davinci_pcm_free(struct snd_pcm *pcm)
 	int stream;
 
 	for (stream = 0; stream < 2; stream++) {
+#ifndef CONFIG_ARCH_TI816X
 		struct snd_dma_buffer *iram_dma;
+#endif
 		substream = pcm->streams[stream].substream;
 		if (!substream)
 			continue;
@@ -800,11 +810,13 @@ static void davinci_pcm_free(struct snd_pcm *pcm)
 		dma_free_writecombine(pcm->card->dev, buf->bytes,
 				      buf->area, buf->addr);
 		buf->area = NULL;
+#ifndef CONFIG_ARCH_TI816X
 		iram_dma = (struct snd_dma_buffer *)buf->private_data;
 		if (iram_dma) {
 			sram_free(iram_dma->area, iram_dma->bytes);
 			kfree(iram_dma);
 		}
+#endif
 	}
 }
 
diff --git a/sound/soc/davinci/davinci-pcm.h b/sound/soc/davinci/davinci-pcm.h
index 0764944..83d3282 100644
--- a/sound/soc/davinci/davinci-pcm.h
+++ b/sound/soc/davinci/davinci-pcm.h
@@ -13,7 +13,11 @@
 #define _DAVINCI_PCM_H
 
 #include <mach/edma.h>
+#ifndef CONFIG_ARCH_TI816X
 #include <mach/asp.h>
+#else
+#include <plat/asp.h>
+#endif
 
 
 struct davinci_pcm_dma_params {
-- 
1.7.0.2

