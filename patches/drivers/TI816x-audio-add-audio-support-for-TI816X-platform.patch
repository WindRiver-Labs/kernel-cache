From eac32897cbe9ad1232c20d38821dc595d57cbe4b Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Fri, 24 Jun 2011 14:23:06 +0800
Subject: [PATCH 17/20] TI816x audio: add audio support for TI816X platform

Add kernel config, compile support and some structs for
TI816x evm board.

This patch is based on below commit from arago git tree.
git://arago-project.org/git/projects/linux-omap3.git
69be15 TI816X: Audio support

Signed-off-by: Vaibhav Bedia <vaibhav.bedia@ti.com>
[This one is picked from the original commit to compatible
with wrlinux tree]
Integrated-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 sound/soc/davinci/Kconfig       |   16 ++++++++++++++++
 sound/soc/davinci/Makefile      |    5 +++++
 sound/soc/davinci/davinci-evm.c |   36 +++++++++++++++++++++++++++++++++++-
 3 files changed, 56 insertions(+), 1 deletions(-)

diff --git a/sound/soc/davinci/Kconfig b/sound/soc/davinci/Kconfig
index 047ee39..293d558 100644
--- a/sound/soc/davinci/Kconfig
+++ b/sound/soc/davinci/Kconfig
@@ -6,6 +6,14 @@ config SND_DAVINCI_SOC
 	  the DAVINCI AC97 or I2S interface. You will also need
 	  to select the audio interfaces to support below.
 
+config SND_TI816X_SOC
+	tristate "SoC Audio for the TI816X chip"
+	depends on ARCH_TI816X
+	help
+	  Say Y or M if you want to add support for codecs attached to
+	  the DAVINCI AC97 or I2S interface. You will also need
+	  to select the audio interfaces to support below.
+
 config SND_DAVINCI_SOC_I2S
 	tristate
 
@@ -61,3 +69,11 @@ config  SND_DA850_SOC_EVM
 	  Say Y if you want to add support for SoC audio on TI
 	  DA850/OMAP-L138 EVM
 
+config  SND_TI816X_SOC_EVM
+	tristate "SoC Audio support for TI816X EVM"
+	depends on SND_TI816X_SOC
+	select SND_DAVINCI_SOC_MCASP
+	select SND_SOC_TLV320AIC3X
+	help
+	  Say Y if you want to add support for SoC audio on TI
+	  816X EVM
diff --git a/sound/soc/davinci/Makefile b/sound/soc/davinci/Makefile
index a6939d7..d00c065 100644
--- a/sound/soc/davinci/Makefile
+++ b/sound/soc/davinci/Makefile
@@ -16,3 +16,8 @@ obj-$(CONFIG_SND_DM6467_SOC_EVM) += snd-soc-evm.o
 obj-$(CONFIG_SND_DA830_SOC_EVM) += snd-soc-evm.o
 obj-$(CONFIG_SND_DA850_SOC_EVM) += snd-soc-evm.o
 obj-$(CONFIG_SND_DAVINCI_SOC_SFFSDR) += snd-soc-sffsdr.o
+
+obj-$(CONFIG_SND_TI816X_SOC_EVM) += snd-soc-evm.o
+obj-$(CONFIG_SND_TI816X_SOC) += snd-soc-davinci.o
+obj-$(CONFIG_SND_TI816X_SOC_I2S) += snd-soc-davinci-i2s.o
+obj-$(CONFIG_SND_TI816X_SOC_MCASP) += snd-soc-davinci-mcasp.o
diff --git a/sound/soc/davinci/davinci-evm.c b/sound/soc/davinci/davinci-evm.c
index 7ccbe66..0ae37f3 100644
--- a/sound/soc/davinci/davinci-evm.c
+++ b/sound/soc/davinci/davinci-evm.c
@@ -23,9 +23,14 @@
 #include <asm/dma.h>
 #include <asm/mach-types.h>
 
-#include <mach/asp.h>
 #include <mach/edma.h>
+#ifdef CONFIG_ARCH_TI816X
+#include <plat/asp.h>
+#include <plat/mux.h>
+#else
+#include <mach/asp.h>
 #include <mach/mux.h>
+#endif
 
 #include "../codecs/tlv320aic3x.h"
 #include "../codecs/spdif_transciever.h"
@@ -60,6 +65,10 @@ static int evm_hw_params(struct snd_pcm_substream *substream,
 				machine_is_davinci_da850_evm())
 		sysclk = 24576000;
 
+	/* TODO: VB__Put the correct value of codec clk here */
+	else if (cpu_is_ti816x())
+		sysclk = 12288000;
+
 	else
 		return -EINVAL;
 
@@ -177,6 +186,15 @@ static struct snd_soc_dai_link da8xx_evm_dai = {
 	.ops = &evm_ops,
 };
 
+static struct snd_soc_dai_link ti816x_evm_dai = {
+	.name = "TLV320AIC3X",
+	.stream_name = "AIC3X",
+	.cpu_dai = &davinci_mcasp_dai[DAVINCI_MCASP_I2S_DAI],
+	.codec_dai = &aic3x_dai,
+	.init = evm_aic3x_init,
+	.ops = &evm_ops,
+};
+
 /* davinci dm6446, dm355 or dm365 evm audio machine driver */
 static struct snd_soc_card snd_soc_card_evm = {
 	.name = "DaVinci EVM",
@@ -207,6 +225,13 @@ static struct snd_soc_card da850_snd_soc_card = {
 	.num_links = 1,
 };
 
+static struct snd_soc_card ti816x_snd_soc_card = {
+	.name = "TI816x EVM",
+	.dai_link = &ti816x_evm_dai,
+	.platform = &davinci_soc_platform,
+	.num_links = 1,
+};
+
 static struct aic3x_setup_data aic3x_setup;
 
 /* evm audio subsystem */
@@ -236,6 +261,12 @@ static struct snd_soc_device da850_evm_snd_devdata = {
 	.codec_data	= &aic3x_setup,
 };
 
+static struct snd_soc_device ti816x_evm_snd_devdata = {
+	.card           = &ti816x_snd_soc_card,
+	.codec_dev      = &soc_codec_dev_aic3x,
+	.codec_data     = &aic3x_setup,
+};
+
 static struct platform_device *evm_snd_device;
 
 static int __init evm_init(void)
@@ -259,6 +290,9 @@ static int __init evm_init(void)
 	} else if (machine_is_davinci_da850_evm()) {
 		evm_snd_dev_data = &da850_evm_snd_devdata;
 		index = 0;
+	} else if (cpu_is_ti816x()) {
+		evm_snd_dev_data = &ti816x_evm_snd_devdata;
+		index = 0;
 	} else
 		return -EINVAL;
 
-- 
1.7.0.2

