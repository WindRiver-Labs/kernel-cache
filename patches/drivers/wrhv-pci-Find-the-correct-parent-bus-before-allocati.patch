From 95037326f3acde26441076b002b9175e63597d4c Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Mon, 23 Jun 2014 10:56:05 +0800
Subject: [PATCH] wrhv: pci: Find the correct parent bus before allocating resource

There is case that the root resource descriptor passed to allocate_resource()
is the desired resource's grandparent, when this happens, the allocating request
always failed because of two reasons:
1). We may failed to find a valid memory space(consistent with XML
configuration) in find_resource().
2). The conflict entry would be found in __request_resource().

So before we call allocate_resource(), we should guarantee that we are
on the correct resource tree(parent's tree).

Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/pci/bus.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/drivers/pci/bus.c b/drivers/pci/bus.c
index c8a1132..ce6b453 100644
--- a/drivers/pci/bus.c
+++ b/drivers/pci/bus.c
@@ -91,6 +91,9 @@ pci_bus_alloc_resource(struct pci_bus *bus, struct resource *res,
 {
 	int i, ret = -ENOMEM;
 	struct resource *r;
+#ifdef CONFIG_WRHV
+	struct resource *r_tmp;
+#endif
 	resource_size_t max = -1;
 
 	type_mask |= IORESOURCE_IO | IORESOURCE_MEM;
@@ -113,6 +116,12 @@ pci_bus_alloc_resource(struct pci_bus *bus, struct resource *res,
 		    !(res->flags & IORESOURCE_PREFETCH))
 			continue;
 
+#ifdef CONFIG_WRHV
+	r_tmp = request_resource_conflict(r, res); 
+	if (r_tmp)
+		r = r_tmp;
+#endif
+
 		/* Ok, try it out.. */
 		ret = allocate_resource(r, res, size,
 #ifdef CONFIG_WRHV
-- 
1.7.0

