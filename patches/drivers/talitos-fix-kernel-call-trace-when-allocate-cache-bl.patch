From 27068eeae95dde47f179604444bc79dd19c554bd Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Mon, 1 Aug 2011 15:07:12 +0800
Subject: [PATCH 23/47] talitos: fix kernel call trace when allocate cache block

The below kernel call trace happens on preempt_rt kernel when
using talitos:
kernel BUG at /build/linux/mm/slab.c:2904!
Oops: Exception in kernel mode, sig: 5 [#1]
PREEMPT SMP NR_CPUS=2 LTT NESTING LEVEL : 0
P1022 DS
last sysfs file: /sys/devices/virtual/block/md0/dev
NIP: c0110bb8 LR: c0110b68 CTR: 00000001
REGS: ee1e9960 TRAP: 0700   Not tainted  (2.6.34.10-rt-WR4.2.0.0_preempt_rt)
MSR: 00029000 <EE,ME,CE>  CR: 44002f42  XER: 20000000
TASK = efbf4810[1151] 'ping' THREAD: ee1e8000 CPU: 0
GPR00: 00000001 ee1e9a10 efbf4810 00000000 000002c3 000002c3 00008000 00000000
GPR08: efbf4810 ee1e9a00 efbf4810 ee1e9a18 24002f42 100216d8 ee1e9a18 00000020
GPR16: 00000000 c07aa2f4 000000f0 00000000 c07a729c c0784980 c0783c80 000000f0
GPR24: c074f96c ef36b2e4 c074f98c ee1e9a88 00100100 00200200 ef36b2c0 ef39e0c0
NIP [c0110bb8] cache_alloc_refill+0x3d8/0x650
LR [c0110b68] cache_alloc_refill+0x388/0x650
Call Trace:
[ee1e9a10] [c0110aec] cache_alloc_refill+0x30c/0x650 (unreliable)
[ee1e9a80] [c01121a0] kmem_cache_alloc+0x218/0x220
[ee1e9ac0] [c04c9fc4] crypto_edesc_alloc+0x6c/0x70
[ee1e9ad0] [c04ca130] talitos_edesc_alloc+0x168/0x278
[ee1e9b00] [c04caf48] aead_givencrypt+0x3c/0xd0
[ee1e9b20] [f941a390] esp_output+0x294/0x308 [esp4]
[ee1e9b80] [c05977c8] xfrm_output_resume+0x200/0x39c
[ee1e9bc0] [c058b9d0] xfrm4_output_finish+0x38/0x78
[ee1e9bd0] [c05499e0] ip_local_out+0x34/0x48
[ee1e9be0] [c0549c74] ip_push_pending_frames+0x280/0x3b0
[ee1e9c10] [c056a074] raw_sendmsg+0x4a0/0x7e4
[ee1e9cb0] [c0575028] inet_sendmsg+0x38/0x7c
[ee1e9cd0] [c05036c0] sock_sendmsg+0xc0/0x160
[ee1e9db0] [c0503a2c] sys_sendmsg+0x1e4/0x2a0
[ee1e9f00] [c05066f8] sys_socketcall+0x1a0/0x320
[ee1e9f40] [c00123b4] ret_from_syscall+0x0/0x4

Fix this problem by adding SLAB_CACHE_DMA flag when create cache block.

Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/crypto/talitos.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/crypto/talitos.c b/drivers/crypto/talitos.c
index 2bd9b6e..4d3a406 100644
--- a/drivers/crypto/talitos.c
+++ b/drivers/crypto/talitos.c
@@ -2699,7 +2699,7 @@ static int talitos_probe(struct of_device *ofdev,
 
 	priv->netcrypto_cache = kmem_cache_create("netcrypto_cache",
 						MAX_DESC_LEN, 0,
-					SLAB_HWCACHE_ALIGN, NULL);
+					SLAB_HWCACHE_ALIGN | SLAB_CACHE_DMA, NULL);
 	if (!priv->netcrypto_cache) {
 		printk(KERN_ERR "%s: failed to create block cache\n",
 				__func__);
-- 
1.7.0.4

