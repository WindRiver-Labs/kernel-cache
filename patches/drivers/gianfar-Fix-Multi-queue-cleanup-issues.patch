From e8c975d87a8aac8c1d189e36e890c72c5380a154 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Tue, 9 Aug 2011 19:22:59 +0800
Subject: [PATCH 17/47] gianfar: Fix Multi queue cleanup issues

Fix updating mask value and checking for  multiple queues in
gfar_poll_tx under normal cleanup process.

Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-gianfar-Fix-Fast-route-and-Multi-queue-.patch.

Signed-off-by: Sandeep Gopalpet <sandeep.kumar@freescale.com>
Signed-off-by: Jiajun Wu <b06378@freescale.com>

[Remove Fast route part because we didn't porting such codes.]

Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 drivers/net/gianfar.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 52cb1f6..f2b1759 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -3506,7 +3506,9 @@ static int gfar_poll_tx(struct napi_struct *napi, int budget)
 							flags);
 			}
 			tx_cleaned += tx_cleaned_per_queue;
+			tx_cleaned_per_queue = 0;
 		}
+		mask = mask >> 0x1;
 	}
 
 	budget = (num_act_qs * DEFAULT_TX_RING_SIZE) + 1;
-- 
1.7.0.2

