From d99d204bf68da62b0c9a46e4ab073a407cbc71a7 Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Fri, 25 Jun 2010 09:24:50 +0800
Subject: [PATCH 3/3] gianfar: only check headroom when FCB is needed

This patch was backported from mainline.
commit upstream: commit 5b28beaf88436fa44fc25ee27a2fadffb75f222e

Signed-off-by: Li Yang <leoli@freescale.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Integrated-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 drivers/net/gianfar.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 111bcbe..657afc0 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -1156,8 +1156,10 @@ static int gfar_start_xmit(struct sk_buff *skb, struct net_device *dev)
 	u16 status;
 	unsigned long flags;
 
-	/* make space for additional header */
-	if (skb_headroom(skb) < GMAC_FCB_LEN) {
+        /* make space for additional header when fcb is needed */
+	if (((skb->ip_summed == CHECKSUM_PARTIAL) ||
+                        (priv->vlgrp && vlan_tx_tag_present(skb))) &&
+                        (skb_headroom(skb) < GMAC_FCB_LEN)) {
 		struct sk_buff *skb_new;
 
 		skb_new = skb_realloc_headroom(skb, GMAC_FCB_LEN);
-- 
1.7.0.4

