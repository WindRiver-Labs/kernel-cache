From e180c50f3b9e70876e3f8dff121a9248b1625d0f Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Thu, 9 Jul 2009 13:58:50 +0800
Subject: [PATCH] gfar keep vlan_stat when resume

when ifdown then ifup NIC. The gfar driver will discard
the previous state which is related with VLAN hw support.
So if we have enabled VLAN hw support, we keep the related
register bits unchanged.

Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 drivers/net/gianfar.c |   11 ++++++++---
 1 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 4320a98..c9e6a5d 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -800,6 +800,7 @@ int startup_gfar(struct net_device *dev)
 	struct gfar __iomem *regs = priv->regs;
 	int err = 0;
 	u32 rctrl = 0;
+	u32 tctrl = 0;
 	u32 attrs = 0;
 
 	gfar_write(&regs->imask, IMASK_INIT_CLEAR);
@@ -974,8 +975,10 @@ int startup_gfar(struct net_device *dev)
 		rctrl |= RCTRL_EMEN;
 	}
 
-	if (priv->vlan_enable)
-		rctrl |= RCTRL_VLAN;
+	if (priv->vlgrp) {
+		rctrl |= RCTRL_VLAN | RCTRL_VLEX;
+		tctrl |= TCTRL_VLINS;
+	}
 
 	if (priv->padding) {
 		rctrl &= ~RCTRL_PAL_MASK;
@@ -986,7 +989,9 @@ int startup_gfar(struct net_device *dev)
 	gfar_write(&priv->regs->rctrl, rctrl);
 
 	if (dev->features & NETIF_F_IP_CSUM)
-		gfar_write(&priv->regs->tctrl, TCTRL_INIT_CSUM);
+		tctrl |= TCTRL_INIT_CSUM;
+
+	gfar_write(&priv->regs->tctrl, tctrl);
 
 	/* Set the extraction length and index */
 	attrs = ATTRELI_EL(priv->rx_stash_size) |
-- 
1.6.3.3

