From c6b546bdeee7eb48ddd20816a99518ad82301809 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Sat, 18 Jun 2011 20:26:19 +0800
Subject: [PATCH 05/27] ARM:CNS34xx:Add KGDBoe Support

KGDBoE fails to connect to the CNS3420 due to netpoll
issues. Fixing netpoll, fixes KDBDoE connects.

In addtion to correct the netpoll related code, it needs
check irq's depth when enable NIC's irq, or the netpoll
routine will trigger warning with "Unbalanced enable for
IRQ".

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/net/cns3xxx/cns3xxx_main.c |   19 +++----------------
 drivers/net/cns3xxx/cns3xxx_tool.h |    5 +++++
 2 files changed, 8 insertions(+), 16 deletions(-)

diff --git a/drivers/net/cns3xxx/cns3xxx_main.c b/drivers/net/cns3xxx/cns3xxx_main.c
index 05be4b3..892149c 100644
--- a/drivers/net/cns3xxx/cns3xxx_main.c
+++ b/drivers/net/cns3xxx/cns3xxx_main.c
@@ -3125,23 +3125,10 @@ static int cns3xxx_notify_reboot(
 }
 
 #ifdef CONFIG_CNS3XXX_NAPI
-static struct net_device *init_napi_dev(
-	struct net_device *ndev, const struct RingInfo *ring_info)
+static struct net_device *init_napi_dev(struct net_device *ndev)
 {
 	struct CNS3XXXPrivate *priv;
-
-	ndev = alloc_etherdev(sizeof(struct CNS3XXXPrivate));
-	if (!ndev) {
-		printk(KERN_ERR "Cannot allocate NAPI virtual device\n");
-		BUG();
-	}
 	priv = netdev_priv(ndev);
-	memset(priv, 0, sizeof(struct CNS3XXXPrivate));
-
-	priv->num_rx_queues = ring_info->num_rx_queues;
-	priv->num_tx_queues = ring_info->num_tx_queues;
-	priv->rx_ring = ring_info->rx_ring;
-	priv->tx_ring = ring_info->tx_ring;
 
 	netif_napi_add(ndev, &priv->napi , cns3xxx_poll, CNS3XXX_NAPI_WEIGHT);
 	dev_hold(ndev);
@@ -3286,9 +3273,9 @@ static int __init cns3xxx_init_module(void)
 	spin_lock_init(&rx_lock);
 
 #ifdef CONFIG_CNS3XXX_NAPI
-	napi_dev = init_napi_dev(napi_dev, &ring_info);
+	napi_dev = init_napi_dev(intr_netdev);
 #ifdef CNS3XXX_DOUBLE_RX_RING
-	r1_napi_dev = init_napi_dev(r1_napi_dev, &ring_info);
+	r1_napi_dev = init_napi_dev(intr_netdev);
 #endif
 #endif
 	register_reboot_notifier(&cns3xxx_notifier_reboot);
diff --git a/drivers/net/cns3xxx/cns3xxx_tool.h b/drivers/net/cns3xxx/cns3xxx_tool.h
index f1aad18..5fa131a 100644
--- a/drivers/net/cns3xxx/cns3xxx_tool.h
+++ b/drivers/net/cns3xxx/cns3xxx_tool.h
@@ -29,6 +29,7 @@
 
 #include "cns3xxx.h"
 #include <linux/kernel.h>
+#include <linux/irq.h>
 
 #define SHOW_DEBUG_MESSAGE
 #ifdef SHOW_DEBUG_MESSAGE
@@ -537,6 +538,10 @@ static inline void cns3xxx_disable_irq(u32 irq)
 
 static inline void cns3xxx_enable_irq(u32 irq)
 {
+	struct irq_desc *desc = irq_to_desc(irq);
+	if (desc->depth == 0)
+		return ;
+
 	enable_irq(irq);
 }
 
-- 
1.7.0.4

