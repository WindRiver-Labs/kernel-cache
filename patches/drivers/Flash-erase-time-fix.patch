From e93118d4137c2dd7aff03b60ffce87365ec55429 Mon Sep 17 00:00:00 2001
From: Benjamin Walsh <benjamin.walsh@windriver.com>
Date: Wed, 3 Dec 2008 10:20:25 -0500
Subject: [PATCH 05/11] Flash erase time fix

Added an erase time multiplier base on whether a flash chip gives
its erase time in seconds or milli-seconds.

Signed-off-by: Benjamin Walsh <benjamin.walsh@windriver.com>
---
 drivers/mtd/chips/Kconfig           |    8 ++++++++
 drivers/mtd/chips/cfi_cmdset_0001.c |    3 ++-
 2 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/drivers/mtd/chips/Kconfig b/drivers/mtd/chips/Kconfig
index 35c6a23..4142733 100644
--- a/drivers/mtd/chips/Kconfig
+++ b/drivers/mtd/chips/Kconfig
@@ -186,6 +186,14 @@ config MTD_CFI_INTELEXT
 	  provides support for one of those command sets, used on Intel
 	  StrataFlash and other parts.
 
+config MTD_CFI_INTELEXT_ERASE_MULTIPLIER
+       int "Erase duration multiplier"
+       depends on MTD_CFI_INTELEXT
+       default 1000
+       ---help---
+         Default erase times are in milliseconds. If they are in seconds,
+         use 1000000 instead (e.g. ATMEL AT49LW080 chip on ATCA717).
+
 config MTD_CFI_AMDSTD
 	tristate "Support for AMD/Fujitsu/Spansion flash chips"
 	depends on MTD_GEN_PROBE
diff --git a/drivers/mtd/chips/cfi_cmdset_0001.c b/drivers/mtd/chips/cfi_cmdset_0001.c
index 5fbf29e..aae0494 100644
--- a/drivers/mtd/chips/cfi_cmdset_0001.c
+++ b/drivers/mtd/chips/cfi_cmdset_0001.c
@@ -506,7 +506,8 @@ struct mtd_info *cfi_cmdset_0001(struct map_info *map, int primary)
 
 		if (cfi->cfiq->BlockEraseTimeoutTyp)
 			cfi->chips[i].erase_time =
-				1000<<cfi->cfiq->BlockEraseTimeoutTyp;
+				CONFIG_MTD_CFI_INTELEXT_ERASE_MULTIPLIER
+                                       <<cfi->cfiq->BlockEraseTimeoutTyp;
 		else
 			cfi->chips[i].erase_time = 2000000;
 
-- 
1.6.5.2

