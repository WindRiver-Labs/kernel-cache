From 5095b6bd0a0967d33d20d85dfb6afafad23a21f9 Mon Sep 17 00:00:00 2001
From: Liang Li <liang.li@windriver.com>
Date: Tue, 15 Jan 2013 14:52:30 +0800
Subject: [PATCH] wireless/cfg80211: do err handling kfree without holding
 spin-lock

The error handling code in cfg80211_mlme_register_mgmt calling kfree
while holding spin lock wdev->mgmt_registration_lock, then release the
lock right after the kfree.

There is no restriction to the sequence that do kfree before release
spin lock .. and do kfree after release spin lock should be better way
to do error clean up work.

So just minor change to move the kfree after lock release.

Signed-off-by: Lans Zhang <jia.zhang@windriver.com>
Signed-off-by: Liang Li <liang.li@windriver.com>
---
 net/wireless/mlme.c |    7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/net/wireless/mlme.c b/net/wireless/mlme.c
index f5a7ac3..1c76771 100644
--- a/net/wireless/mlme.c
+++ b/net/wireless/mlme.c
@@ -649,10 +649,8 @@ int cfg80211_mlme_register_mgmt(struct wireless_dev *wdev, u32 snd_pid,
 		}
 	}
 
-	if (err) {
-		kfree(nreg);
+	if (err)
 		goto out;
-	}
 
 	memcpy(nreg->match, match_data, match_len);
 	nreg->match_len = match_len;
@@ -667,6 +665,9 @@ int cfg80211_mlme_register_mgmt(struct wireless_dev *wdev, u32 snd_pid,
  out:
 	spin_unlock_bh(&wdev->mgmt_registrations_lock);
 
+	if (err)
+		kfree(nreg);
+
 	return err;
 }
 
-- 
1.7.9.7

