From 376894d03445b2efbf3e67c1fe214d5bf30dbc26 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Thu, 17 Oct 2013 15:44:18 +0800
Subject: [PATCH 4/4] sctp: Don't do checksum offload if IPsec is enabled

If a networking device support SCTP checksum offload feature,
sctp will pass the checksum calculation to hardware device.
However, when IPsec is enabled, xfrm_output() will invalidate
the hardware checksum and recalculate the checksum manually on
outgoing path, now the problem arises, the calculated checksum
in skb_checksum_help() is not compatible with CRC32, so at the
receiver side, these packets are dropped because of failing to
pass the checksum verification.

To fix this problem, we should not do sctp checksum offload
if IPsec is enabled.

Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 net/sctp/output.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/net/sctp/output.c b/net/sctp/output.c
index 9056388..d9df968 100644
--- a/net/sctp/output.c
+++ b/net/sctp/output.c
@@ -531,7 +531,13 @@ int sctp_packet_transmit(struct sctp_packet *packet)
 	 * by CRC32-C as described in <draft-ietf-tsvwg-sctpcsum-02.txt>.
 	 */
 	if (!sctp_checksum_disable) {
+#ifdef CONFIG_XFRM
+		/* dst which tagged with xfrm SA is pushed to IPsec */
+		if (!(dst->dev->features & NETIF_F_SCTP_CSUM) ||
+		      dst->xfrm) {
+#else
 		if (!(dst->dev->features & NETIF_F_SCTP_CSUM)) {
+#endif
 			__u32 crc32 = sctp_start_cksum((__u8 *)sh,
 							cksum_buf_len);
 
-- 
1.7.0

