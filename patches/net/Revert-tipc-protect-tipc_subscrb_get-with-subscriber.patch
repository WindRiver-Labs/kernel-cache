From 902fd852186a2f596ba770b3c6d6ab9c8188a3f3 Mon Sep 17 00:00:00 2001
From: Zhenbo Gao <zhenbo.gao@windriver.com>
Date: Wed, 28 Mar 2018 16:38:20 +0800
Subject: [PATCH 005/376] Revert "tipc: protect tipc_subscrb_get() with
 subscriber spin lock"

This reverts commit f610fa3b91017dd5666632b01c05fb9925c4dc6c.

A big patch set for upgrading TIPC(to v4.16-rc6) will come soon

Signed-off-by: Zhenbo Gao <zhenbo.gao@windriver.com>
---
 net/tipc/subscr.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/net/tipc/subscr.c b/net/tipc/subscr.c
index 0ddba85..d6e6af2 100644
--- a/net/tipc/subscr.c
+++ b/net/tipc/subscr.c
@@ -296,14 +296,14 @@ static void tipc_subscrp_subscribe(struct net *net, struct tipc_subscr *s,
 
 	spin_lock_bh(&subscriber->lock);
 	list_add(&sub->subscrp_list, &subscriber->subscrp_list);
-	tipc_subscrb_get(subscriber);
 	sub->subscriber = subscriber;
 	tipc_nametbl_subscribe(sub);
 	spin_unlock_bh(&subscriber->lock);
 
 	timeout = htohl(sub->evt.s.timeout, sub->swap);
 
-	mod_timer(&sub->timer, jiffies + msecs_to_jiffies(timeout));
+	if (!mod_timer(&sub->timer, jiffies + msecs_to_jiffies(timeout)))
+		tipc_subscrb_get(subscriber);
 }
 
 /* Handle one termination request for the subscriber */
-- 
1.7.5.4

