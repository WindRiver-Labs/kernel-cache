From 62d82763b0859c7c4dc020131fb111a9139bb208 Mon Sep 17 00:00:00 2001
From: Zhenbo Gao <zhenbo.gao@windriver.com>
Date: Wed, 28 Mar 2018 16:37:44 +0800
Subject: [PATCH 004/376] Revert "tipc: move linearization of buffers to
 generic code"

This reverts commit fe10ac3bc4a045910e590af53ca68c6f4f334958.

A big patch set for upgrading TIPC(to v4.16-rc6) will come soon

Signed-off-by: Zhenbo Gao <zhenbo.gao@windriver.com>
---
 net/tipc/link.c       |    3 ---
 net/tipc/name_distr.c |    1 -
 net/tipc/udp_media.c  |    5 +++++
 3 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/net/tipc/link.c b/net/tipc/link.c
index 420fb2c..43a515d 100644
--- a/net/tipc/link.c
+++ b/net/tipc/link.c
@@ -1452,9 +1452,6 @@ static void tipc_link_proto_rcv(struct tipc_link *l_ptr,
 
 		/* fall thru' */
 	case ACTIVATE_MSG:
-		skb_linearize(buf);
-		msg = buf_msg(buf);
-
 		/* Update link settings according other endpoint's values */
 		strcpy((strrchr(l_ptr->name, ':') + 1), (char *)msg_data(msg));
 
diff --git a/net/tipc/name_distr.c b/net/tipc/name_distr.c
index 113fb0f..41e7b7e 100644
--- a/net/tipc/name_distr.c
+++ b/net/tipc/name_distr.c
@@ -397,7 +397,6 @@ void tipc_named_rcv(struct net *net, struct sk_buff_head *inputq)
 
 	spin_lock_bh(&tn->nametbl_lock);
 	for (skb = skb_dequeue(inputq); skb; skb = skb_dequeue(inputq)) {
-		skb_linearize(skb);
 		msg = buf_msg(skb);
 		mtype = msg_type(msg);
 		item = (struct distr_item *)msg_data(msg);
diff --git a/net/tipc/udp_media.c b/net/tipc/udp_media.c
index aecbd06..e14f235 100644
--- a/net/tipc/udp_media.c
+++ b/net/tipc/udp_media.c
@@ -48,6 +48,7 @@
 #include <linux/tipc_netlink.h>
 #include "core.h"
 #include "bearer.h"
+#include "msg.h"
 
 /* IANA assigned UDP port */
 #define UDP_PORT_DEFAULT	6118
@@ -216,6 +217,10 @@ static int tipc_udp_recv(struct sock *sk, struct sk_buff *skb)
 {
 	struct udp_bearer *ub;
 	struct tipc_bearer *b;
+	int usr = msg_user(buf_msg(skb));
+
+	if ((usr == LINK_PROTOCOL) || (usr == NAME_DISTRIBUTOR))
+		skb_linearize(skb);
 
 	ub = rcu_dereference_sk_user_data(sk);
 	if (!ub) {
-- 
1.7.5.4

