From 00015582def2a2786de7175f070e5c2fb0b21299 Mon Sep 17 00:00:00 2001
From: Johannes Berg <johannes.berg@intel.com>
Date: Thu, 9 Jan 2014 16:59:55 +0800
Subject: [PATCH] wireless: radiotap: fix parsing buffer overrun

commit f5563318ff1bde15b10e736e97ffce13be08bc1a upstream

When parsing an invalid radiotap header, the parser can overrun
the buffer that is passed in because it doesn't correctly check
 1) the minimum radiotap header size
 2) the space for extended bitmaps

The first issue doesn't affect any in-kernel user as they all
check the minimum size before calling the radiotap function.
The second issue could potentially affect the kernel if an skb
is passed in that consists only of the radiotap header with a
lot of extended bitmaps that extend past the SKB. In that case
a read-only buffer overrun by at most 4 bytes is possible.

Fix this by adding the appropriate checks to the parser.

Cc: stable@vger.kernel.org
Reported-by: Evan Huus <eapache@gmail.com>
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
[Adjust symbol names due to different definition.]
Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 net/wireless/radiotap.c |    8 +++++++-
 1 files changed, 7 insertions(+), 1 deletions(-)

diff --git a/net/wireless/radiotap.c b/net/wireless/radiotap.c
index f591871..6fd7258 100644
--- a/net/wireless/radiotap.c
+++ b/net/wireless/radiotap.c
@@ -54,6 +54,10 @@ int ieee80211_radiotap_iterator_init(
     struct ieee80211_radiotap_header *radiotap_header,
     int max_length)
 {
+	/* check the radiotap header can actually be present */
+	if (max_length < sizeof(struct ieee80211_radiotap_header))
+		return -EINVAL;
+
 	/* Linux only supports version 0 radiotap format */
 	if (radiotap_header->it_version)
 		return -EINVAL;
@@ -83,7 +87,9 @@ int ieee80211_radiotap_iterator_init(
 			 */
 
 			if (((ulong)iterator->arg -
-			     (ulong)iterator->rtheader) > iterator->max_length)
+			     (ulong)iterator->rtheader +
+			     sizeof(uint32_t)) >
+			     (ulong)iterator->max_length)
 				return -EINVAL;
 		}
 
-- 
1.7.0

