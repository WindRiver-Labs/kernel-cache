From ddfc82611ac5c962bd4063555d9ee39089336eb7 Mon Sep 17 00:00:00 2001
From: Ovidiu Panait <ovidiu.panait@windriver.com>
Date: Sat, 9 Sep 2017 16:41:35 +0000
Subject: [PATCH] flow_dissector: Jump to exit code in __skb_flow_dissect

commit a6e544b0a88b53114bfa5a57e21b7be7a8dfc9d0 upstream

Instead of returning immediately (on a parsing failure for instance) we
jump to cleanup code. This always sets protocol values in key_control
(even on a failure there is still valid information in the key_tags that
was set before the problem was hit).

Signed-off-by: Tom Herbert <tom@herbertland.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Ovidiu Panait <ovidiu.panait@windriver.com>
---
 net/core/flow_dissector.c |   25 +++++++++++++++----------
 1 files changed, 15 insertions(+), 10 deletions(-)

diff --git a/net/core/flow_dissector.c b/net/core/flow_dissector.c
index f97101b..dda1f11 100644
--- a/net/core/flow_dissector.c
+++ b/net/core/flow_dissector.c
@@ -29,6 +29,7 @@ bool skb_flow_dissect(const struct sk_buff *skb, struct flow_keys *flow)
 {
 	int poff, nhoff = skb_network_offset(skb);
 	u8 ip_proto;
+	bool ret = false;
 	__be16 proto = skb->protocol;
 
 	memset(flow, 0, sizeof(*flow));
@@ -41,7 +42,7 @@ again:
 ip:
 		iph = skb_header_pointer(skb, nhoff, sizeof(_iph), &_iph);
 		if (!iph || iph->ihl < 5)
-			return false;
+			goto out_bad;
 
 		if (ip_is_fragment(iph))
 			ip_proto = 0;
@@ -57,7 +58,7 @@ ip:
 ipv6:
 		iph = skb_header_pointer(skb, nhoff, sizeof(_iph), &_iph);
 		if (!iph)
-			return false;
+			goto out_bad;
 
 		ip_proto = iph->nexthdr;
 		flow->src = (__force __be32)ipv6_addr_hash(&iph->saddr);
@@ -71,7 +72,7 @@ ipv6:
 
 		vlan = skb_header_pointer(skb, nhoff, sizeof(_vlan), &_vlan);
 		if (!vlan)
-			return false;
+			goto out_bad;
 
 		proto = vlan->h_vlan_encapsulated_proto;
 		nhoff += sizeof(*vlan);
@@ -84,7 +85,7 @@ ipv6:
 		} *hdr, _hdr;
 		hdr = skb_header_pointer(skb, nhoff, sizeof(_hdr), &_hdr);
 		if (!hdr)
-			return false;
+			goto out_bad;
 		proto = hdr->proto;
 		nhoff += PPPOE_SES_HLEN;
 		switch (proto) {
@@ -93,11 +94,11 @@ ipv6:
 		case __constant_htons(PPP_IPV6):
 			goto ipv6;
 		default:
-			return false;
+			goto out_bad;
 		}
 	}
 	default:
-		return false;
+		goto out_bad;
 	}
 
 	switch (ip_proto) {
@@ -109,7 +110,7 @@ ipv6:
 
 		hdr = skb_header_pointer(skb, nhoff, sizeof(_hdr), &_hdr);
 		if (!hdr)
-			return false;
+			goto out_bad;
 		/*
 		 * Only look inside GRE if version zero and no
 		 * routing
@@ -130,7 +131,7 @@ ipv6:
 				eth = skb_header_pointer(skb, nhoff,
 							 sizeof(_eth), &_eth);
 				if (!eth)
-					return false;
+					goto out_bad;
 				proto = eth->h_proto;
 				nhoff += sizeof(*eth);
 			}
@@ -144,7 +145,6 @@ ipv6:
 		break;
 	}
 
-	flow->ip_proto = ip_proto;
 	poff = proto_ports_offset(ip_proto);
 	if (poff >= 0) {
 		__be32 *ports, _ports;
@@ -155,9 +155,14 @@ ipv6:
 			flow->ports = *ports;
 	}
 
+out_good:
+	ret = true;
+
+out_bad:
+	flow->ip_proto = ip_proto;
 	flow->thoff = (u16) nhoff;
 
-	return true;
+	return ret;
 }
 EXPORT_SYMBOL(skb_flow_dissect);
 
-- 
1.7.5.4

