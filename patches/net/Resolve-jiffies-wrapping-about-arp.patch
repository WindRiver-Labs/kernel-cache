From 848fdbe97c73736ca2ee207e3141be7731fb6e68 Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Tue, 15 Dec 2009 11:03:47 +0800
Subject: [PATCH] Resolve jiffies wrapping about arp

When jiffies wraps, it must be larger than the value of "updated".
The solution will enhance the condition of "time_after".

Signed-off-by: Li Wang <li.wang@windriver.com>
---
 net/ipv4/arp.c |    9 ++++++++-
 1 files changed, 8 insertions(+), 1 deletions(-)

diff --git a/net/ipv4/arp.c b/net/ipv4/arp.c
index b043eda..87bb91c 100644
--- a/net/ipv4/arp.c
+++ b/net/ipv4/arp.c
@@ -877,7 +877,14 @@ static int arp_process(struct sk_buff *skb)
 		   agents are active. Taking the first reply prevents
 		   arp trashing and chooses the fastest router.
 		 */
-		override = time_after(jiffies, n->updated + n->parms->locktime);
+		/*
+		 * If n->updated is after jiffes, then the clock has wrapped and
+		 * we are *well* past the locktime, so set the override flag
+		 */
+		if (time_after(n->updated, jiffies))
+			override = 1;
+		else
+			override = time_after(jiffies, n->updated + n->parms->locktime);
 
 		/* Broadcast replies and request packets
 		   do not assert neighbour reachability.
-- 
1.6.5.2

