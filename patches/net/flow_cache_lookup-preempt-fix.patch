From dc7b1442ecfc72c51e556d18dce42c559db888e8 Mon Sep 17 00:00:00 2001
From: Hong H. Pham <hong.pham@windriver.com>
Date: Tue, 27 Jan 2009 15:14:45 -0500
Subject: [PATCH] flow_cache_lookup preempt fix

Using smp_processor_id() in preemptible code will cause a kernel BUG().
Use get_cpu() and put_cpu() instead.

Signed-off-by: Hong H. Pham <hong.pham@windriver.com>
---
 net/core/flow.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/net/core/flow.c b/net/core/flow.c
index 5cf8105..a8c428c 100644
--- a/net/core/flow.c
+++ b/net/core/flow.c
@@ -173,7 +173,7 @@ void *flow_cache_lookup(struct flowi *key, u16 family, u8 dir,
 	int cpu;
 
 	local_bh_disable();
-	cpu = smp_processor_id();
+	cpu = get_cpu();
 
 	fle = NULL;
 	/* Packet really early in init?  Making flow_cache_init a
@@ -195,6 +195,7 @@ void *flow_cache_lookup(struct flowi *key, u16 family, u8 dir,
 
 				if (ret)
 					atomic_inc(fle->object_ref);
+				put_cpu();
 				local_bh_enable();
 
 				return ret;
@@ -238,6 +239,7 @@ nocache:
 			if (obj)
 				atomic_inc(fle->object_ref);
 		}
+		put_cpu();
 		local_bh_enable();
 
 		if (err)
-- 
1.6.0.3

