From 59de4f3ad4bd43a58159a5505d7087ca3a4feaf0 Mon Sep 17 00:00:00 2001
From: Lans Zhang <jia.zhang@windriver.com>
Date: Mon, 1 Mar 2010 11:24:50 +0800
Subject: [PATCH] gianfar: Fix packet drop when out of memory

author	Andy Fleming <afleming@freescale.com>
committer	David S. Miller <davem@davemloft.net>

gianfar: Fix packet drop when out of memory

commit	8882d9a60028a9937e9c5652cfb80d4399ce5242	upstream

The patch which fixed gianfar so it drops packets when it runs out
of memory left in the code which frees the skb when it drops packets.
Change the code so that we only free the skb if the new skb was successfully
created.

Signed-off-by: Andy Fleming <afleming@freescale.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Integrated-by: Lans Zhang <jia.zhang@windriver.com>
---
 drivers/net/gianfar.c |    3 +--
 1 files changed, 1 insertions(+), 2 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 8ce5a9c..8e98e8b 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -1656,8 +1656,7 @@ int gfar_clean_rx_ring(struct net_device *dev, int rx_work_limit)
 
 			if (unlikely(!newskb))
 				newskb = skb;
-
-			if (skb)
+			else if (skb)
 				dev_kfree_skb_any(skb);
 		} else {
 			/* Increment the number of packets */
-- 
1.6.0.3

