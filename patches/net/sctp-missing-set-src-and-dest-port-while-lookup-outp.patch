From 52de74c75310a55c2a3dc8e487f371f8f62d0c96 Mon Sep 17 00:00:00 2001
From: Wei Yongjun <yjwei@cn.fujitsu.com>
Date: Sun, 29 Sep 2013 13:52:03 +0800
Subject: [PATCH 1/4] sctp: missing set src and dest port while lookup output route

commit 6429d3dc4bd6251b01c11b851e23a4d60f079e06 upstream

While lookup the output route, we do not set the src and dest
port. This will cause we got a wrong route if we had set the
outbund transport to IPsec with src or dst port.

Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 net/sctp/protocol.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/net/sctp/protocol.c b/net/sctp/protocol.c
index 5a5a312..170df9b 100644
--- a/net/sctp/protocol.c
+++ b/net/sctp/protocol.c
@@ -475,13 +475,17 @@ static struct dst_entry *sctp_v4_get_dst(struct sctp_association *asoc,
 
 	memset(fl, 0x0, sizeof(struct flowi));
 	fl->fl4_dst  = daddr->v4.sin_addr.s_addr;
+	fl->fl_ip_dport = daddr->v4.sin_port;
 	fl->proto = IPPROTO_SCTP;
 	if (asoc) {
 		fl->fl4_tos = RT_CONN_FLAGS(asoc->base.sk);
 		fl->oif = asoc->base.sk->sk_bound_dev_if;
+		fl->fl_ip_sport = htons(asoc->base.bind_addr.port);
 	}
-	if (saddr)
+	if (saddr) {
 		fl->fl4_src = saddr->v4.sin_addr.s_addr;
+		fl->fl_ip_sport = saddr->v4.sin_port;
+	}
 
 	SCTP_DEBUG_PRINTK("%s: DST:%pI4, SRC:%pI4 - ",
 			  __func__, &fl->fl4_dst, &fl->fl4_src);
@@ -529,6 +533,7 @@ static struct dst_entry *sctp_v4_get_dst(struct sctp_association *asoc,
 		if ((laddr->state == SCTP_ADDR_SRC) &&
 		    (AF_INET == laddr->a.sa.sa_family)) {
 			fl->fl4_src = laddr->a.v4.sin_addr.s_addr;
+			fl->fl_ip_sport = laddr->a.v4.sin_port;
 			if (!ip_route_output_key(&init_net, &rt, fl)) {
 				dst = &rt->u.dst;
 				goto out_unlock;
-- 
1.7.0

