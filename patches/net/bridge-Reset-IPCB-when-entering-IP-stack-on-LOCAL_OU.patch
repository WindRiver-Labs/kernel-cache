From a475e1d8bd3df9efe72a7e51753a5d00d0dc08c9 Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Wed, 7 Aug 2013 12:24:14 +0800
Subject: [PATCH 5/5] bridge: Reset IPCB when entering IP stack on LOCAL_OUT

Whenever we enter the IP stack proper from bridge netfilter we
need to ensure that the skb is in a form the IP stack expects
it to be in.

The entry point on NF_LOCAL_OUT did not meet the requirements of
the IP stack, therefore leading to potential crashes/panics.

Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 net/bridge/br_netfilter.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/net/bridge/br_netfilter.c b/net/bridge/br_netfilter.c
index c0d5170..9d2f595 100644
--- a/net/bridge/br_netfilter.c
+++ b/net/bridge/br_netfilter.c
@@ -829,6 +829,9 @@ static unsigned int br_nf_local_out(unsigned int hook, struct sk_buff *skb,
 	nf_bridge->physoutdev = skb->dev;
 	realindev = nf_bridge->physindev;
 
+	if (br_parse_ip_options(skb))
+		return NF_DROP;
+
 	if (nf_bridge->mask & BRNF_PKT_TYPE) {
 		skb->pkt_type = PACKET_OTHERHOST;
 		nf_bridge->mask ^= BRNF_PKT_TYPE;
-- 
1.7.0

