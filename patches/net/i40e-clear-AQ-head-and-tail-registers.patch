From 34889576b1805efe446f5bd5b9cc7bf8d1add0b6 Mon Sep 17 00:00:00 2001
From: Shannon Nelson <shannon.nelson@intel.com>
Date: Sat, 16 Nov 2013 10:00:35 +0000
Subject: [PATCH 045/232] i40e: clear AQ head and tail registers

commit 26d7178f5ba164e329f137b00a542fd67b850051 upstream

During admin queue shutdown clear some more registers
explicitly.

Change-Id: Ifb235c691e1c55e76bf66e0642207f464153d05a
Signed-off-by: Shannon Nelson <shannon.nelson@intel.com>
Signed-off-by: Jesse Brandeburg <jesse.brandeburg@intel.com>
Tested-by: Kavindya Deegala <kavindya.s.deegala@intel.com>
Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
Signed-off-by: fupan li <fupan.li@windriver.com>
---
 drivers/net/ethernet/intel/i40e/i40e_adminq.c |   18 ++++++++++++++----
 1 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/drivers/net/ethernet/intel/i40e/i40e_adminq.c b/drivers/net/ethernet/intel/i40e/i40e_adminq.c
index cfef7fc..2bf73dd 100644
--- a/drivers/net/ethernet/intel/i40e/i40e_adminq.c
+++ b/drivers/net/ethernet/intel/i40e/i40e_adminq.c
@@ -466,10 +466,15 @@ static i40e_status i40e_shutdown_asq(struct i40e_hw *hw)
 		return I40E_ERR_NOT_READY;
 
 	/* Stop firmware AdminQ processing */
-	if (hw->mac.type == I40E_MAC_VF)
+	if (hw->mac.type == I40E_MAC_VF) {
 		wr32(hw, I40E_VF_ATQLEN1, 0);
-	else
+		wr32(hw, I40E_VF_ATQH1, 0);
+		wr32(hw, I40E_VF_ATQT1, 0);
+	} else {
 		wr32(hw, I40E_PF_ATQLEN, 0);
+		wr32(hw, I40E_PF_ATQH, 0);
+		wr32(hw, I40E_PF_ATQT, 0);
+	}
 
 	/* make sure lock is available */
 	mutex_lock(&hw->aq.asq_mutex);
@@ -500,10 +505,15 @@ static i40e_status i40e_shutdown_arq(struct i40e_hw *hw)
 		return I40E_ERR_NOT_READY;
 
 	/* Stop firmware AdminQ processing */
-	if (hw->mac.type == I40E_MAC_VF)
+	if (hw->mac.type == I40E_MAC_VF) {
 		wr32(hw, I40E_VF_ARQLEN1, 0);
-	else
+		wr32(hw, I40E_VF_ARQH1, 0);
+		wr32(hw, I40E_VF_ARQT1, 0);
+	} else {
 		wr32(hw, I40E_PF_ARQLEN, 0);
+		wr32(hw, I40E_PF_ARQH, 0);
+		wr32(hw, I40E_PF_ARQT, 0);
+	}
 
 	/* make sure lock is available */
 	mutex_lock(&hw->aq.arq_mutex);
-- 
1.7.5.4

