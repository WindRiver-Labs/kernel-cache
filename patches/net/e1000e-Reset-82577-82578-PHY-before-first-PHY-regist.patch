From 5ce57490de470073f608fea6c3be42192c7bd80f Mon Sep 17 00:00:00 2001
From: hongbo zhong <hongbo.zhong@windriver.com>
Date: Thu, 11 Nov 2010 14:28:30 +0800
Subject: [PATCH] e1000e: Reset 82577/82578 PHY before first PHY register read

commit 627c8a041f7aaaea93c766f69bd61d952a277586 from upstream.

Reset the PHY before first accessing it.  Doing so, ensure
that the PHY is in a known good state before we read/write
PHY registers. This fixes a driver probe failure.

Signed-off-by: Bruce Allan <bruce.w.allan@intel.com>
Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Integrated-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/net/e1000e/ich8lan.c |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/drivers/net/e1000e/ich8lan.c b/drivers/net/e1000e/ich8lan.c
index e200d9c..b923568 100644
--- a/drivers/net/e1000e/ich8lan.c
+++ b/drivers/net/e1000e/ich8lan.c
@@ -280,6 +280,16 @@ static s32 e1000_init_phy_params_pchlan(struct e1000_hw *hw)
 	phy->ops.power_down           = e1000_power_down_phy_copper_ich8lan;
 	phy->autoneg_mask             = AUTONEG_ADVERTISE_SPEED_DEFAULT;
 
+	/*
+	 * Reset the PHY before any acccess to it.  Doing so, ensures that
+	 * the PHY is in a known good state before we read/write PHY registers.
+	 * The generic reset is sufficient here, because we haven't determined
+	 * the PHY type yet.
+	 */
+	ret_val = e1000e_phy_hw_reset_generic(hw);
+	if (ret_val)
+		goto out;
+
 	phy->id = e1000_phy_unknown;
 	ret_val = e1000e_get_phy_id(hw);
 	if (ret_val) {
-- 
1.6.5.2

