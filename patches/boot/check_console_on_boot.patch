From 5c2b8744d69f321ac0ede1fa742b2ff459f23d7b Mon Sep 17 00:00:00 2001
From: auto commit <unknown@unknown>
Date: Wed, 1 Oct 2008 21:40:40 -0400
Subject: [PATCH] check console device file on fs when booting

If a root filesystem is generated as non-root, one of
the tell tale signs is /dev/console not being a character
file. To save a whole class of questions, let's just test
for the condition and let the user know.

Signed-off-by: Richard Laroque <rlarocqu@windriver.com>
Signed-off-bu: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 init/main.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/init/main.c b/init/main.c
index f6f7042..21d2d7c 100644
--- a/init/main.c
+++ b/init/main.c
@@ -795,12 +795,20 @@ static void run_init_process(char *init_filename)
  */
 static int noinline init_post(void)
 {
+	struct stat console_stat;
+
 	free_initmem();
 	unlock_kernel();
 	mark_rodata_ro();
 	system_state = SYSTEM_RUNNING;
 	numa_default_policy();
 
+	/* Use /dev/console to infer if the rootfs is setup properly */
+	if (sys_newlstat((char __user *) "/dev/console", (struct stat __user *) &console_stat)
+			|| !S_ISCHR(console_stat.st_mode)) {
+		panic("/dev/console is missing or not a character device!\nPlease ensure your rootfs is properly configured\n");
+	}
+
 	if (sys_open((const char __user *) "/dev/console", O_RDWR, 0) < 0)
 		printk(KERN_WARNING "Warning: unable to open an initial console.\n");
 
-- 
1.5.5.1

