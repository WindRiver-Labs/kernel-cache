From 18b667db000e02d71858e8b7fe56cc576b246a63 Mon Sep 17 00:00:00 2001
From: Jason Wessel <jason.wessel@windriver.com>
Date: Mon, 3 Oct 2011 14:57:14 -0500
Subject: [PATCH] nfsroot: Add mport to allow specification of the mnt_port on an NFS root mount

It is possible to entirely avoid contacting rpcbind/portmap
services if assigned ports are in use for the NFS root mount.

The main user of this functionality is booting up a kernel
and connecting it to a user mode NFS server on a host
where rpcbind/portmap services are not running.

Signed-off-by: Jason Wessel <jason.wessel@windriver.com>
---
 fs/nfs/nfsroot.c |    9 ++++++++-
 1 files changed, 8 insertions(+), 1 deletions(-)

diff --git a/fs/nfs/nfsroot.c b/fs/nfs/nfsroot.c
index 6cfcacd..a15f70a 100644
--- a/fs/nfs/nfsroot.c
+++ b/fs/nfs/nfsroot.c
@@ -123,7 +123,7 @@ enum {
 	/* Options that take integer arguments */
 	Opt_port, Opt_rsize, Opt_wsize, Opt_timeo, Opt_retrans, Opt_acregmin,
 	Opt_acregmax, Opt_acdirmin, Opt_acdirmax, Opt_mountprog,
-	Opt_nfsprog,
+	Opt_nfsprog, Opt_mport,
 	/* Options that take no arguments */
 	Opt_soft, Opt_hard, Opt_intr,
 	Opt_nointr, Opt_posix, Opt_noposix, Opt_cto, Opt_nocto, Opt_ac, 
@@ -145,6 +145,7 @@ static const match_table_t tokens __initconst = {
 	{Opt_acdirmax, "acdirmax=%u"},
 	{Opt_mountprog, "mountprog=%u"},
 	{Opt_nfsprog, "nfsprog=%u"},
+	{Opt_mport, "mport=%u"},
 	{Opt_soft, "soft"},
 	{Opt_hard, "hard"},
 	{Opt_intr, "intr"},
@@ -203,6 +204,9 @@ static int __init root_nfs_parse(char *name, char *buf)
 			case Opt_port:
 				nfs_port = option;
 				break;
+			case Opt_mport:
+				mount_port = option;
+				break;
 			case Opt_rsize:
 				nfs_data.rsize = option;
 				break;
@@ -481,12 +485,15 @@ static int __init root_nfs_ports(void)
 			"as nfsd port\n", port);
 	}
 
+	if (mount_port)
+		goto got_mount_port;
 	if ((port = root_nfs_getport(nfs_data.mount_prog, mountd_ver, proto)) < 0) {
 		printk(KERN_ERR "Root-NFS: Unable to get mountd port "
 				"number from server, using default\n");
 		port = mountd_port;
 	}
 	mount_port = port;
+got_mount_port:
 	dprintk("Root-NFS: mountd port is %d\n", port);
 
 	return 0;
-- 
1.7.0.4

