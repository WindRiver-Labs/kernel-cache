From ad90b77a9bf9f15afa04174b672993a060440cf5 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Mon, 16 Sep 2013 15:54:05 -0700
Subject: [PATCH 3/6] trace: Increase process name size for late boottime
 analysis

Add CONFIG_WR_BOOT kernel config to increase the buffer for the
process name so that analyse-boottime can display the process
name correctly.

Signed-off-by: Pradeep Tumati <pradeep.tumati@windriver.com>
[yshi: Add text for the config so that it can be showed in menuconfig]
Signed-off-by: Yang Shi <yang.shi@windriver.com>
Signed-off-by: Han Chao <chan@windriver.com>
---
 include/linux/threads.h | 6 +++++-
 kernel/trace/Kconfig    | 3 +++
 kernel/trace/trace.c    | 6 +++++-
 3 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/include/linux/threads.h b/include/linux/threads.h
index 383ab95..9e49628 100644
--- a/include/linux/threads.h
+++ b/include/linux/threads.h
@@ -24,7 +24,11 @@
 /*
  * This controls the default maximum pid allocated to a process
  */
-#define PID_MAX_DEFAULT (CONFIG_BASE_SMALL ? 0x1000 : 0x8000)
+#define MAX_PID_NUM 0x8000
+#ifdef CONFIG_WR_BOOT
+#define MAX_PID_NUM 0x16000
+#endif
+#define PID_MAX_DEFAULT (CONFIG_BASE_SMALL ? 0x1000 : MAX_PID_NUM)
 
 /*
  * A maximum of 4 million PIDs should be enough for a while.
diff --git a/kernel/trace/Kconfig b/kernel/trace/Kconfig
index 015f85a..511ce32 100644
--- a/kernel/trace/Kconfig
+++ b/kernel/trace/Kconfig
@@ -226,6 +226,9 @@ config SCHED_TRACER
 	  This tracer tracks the latency of the highest priority task
 	  to be scheduled in, starting from the point it has woken up.
 
+config WR_BOOT
+	bool "Wind River boottime analysis"
+
 config ENABLE_DEFAULT_TRACERS
 	bool "Trace process context switches and events"
 	depends on !GENERIC_TRACER
diff --git a/kernel/trace/trace.c b/kernel/trace/trace.c
index 0582a01..08919ff 100644
--- a/kernel/trace/trace.c
+++ b/kernel/trace/trace.c
@@ -1220,7 +1220,11 @@ void tracing_reset_all_online_cpus(void)
 	}
 }
 
-#define SAVED_CMDLINES 128
+#define TOTAL_CMDLINE 128
+#ifdef CONFIG_WR_BOOT
+#define TOTAL_CMDLINE 256
+#endif
+#define SAVED_CMDLINES TOTAL_CMDLINE
 #define NO_CMDLINE_MAP UINT_MAX
 static unsigned map_pid_to_cmdline[PID_MAX_DEFAULT+1];
 static unsigned map_cmdline_to_pid[SAVED_CMDLINES];
-- 
1.8.4.93.g57e4c17

