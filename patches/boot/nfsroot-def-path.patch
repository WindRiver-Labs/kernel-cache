From: Bruce Ashfield <bruce.ashfield@windriver.com>
Subject: allow nfs root to be a compile time option

make NFS_ROOT compile time configurable with a sane 
default so as to not surprise anyone.

Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>

--- a/fs/Kconfig
+++ b/fs/Kconfig
@@ -1751,10 +1751,30 @@ config ROOT_NFS
 	  autoconfiguration" so that your box can discover its network address
 	  at boot time.
 
 	  Most people say N here.
 
+config ROOT_NFS_PATH
+	string "Default NFS Root file system path"
+	depends on ROOT_NFS
+	default "/tftpboot/%s"
+	help
+	  If you intend to boot your box with an NFS-mounted root filesystem,
+	  you will need to specify a path on your boot server where the
+	  filesytems is located.  If you don't specify one in your kernel boot
+	  arguments, or if you specify the 'ip=on' option, this is the path
+	  which will actually be used.  Only one format option is respected
+	  here, '%s' is translated into the ip address of your box, and it is
+	  only interpreted the first time it is found in the string.  Strings
+	  are silently truncated to 255 bytes total, including the string
+	  representation of the local IP address.
+
+	  This has no effect if you specify a path in your kernel boot
+	  arguments.
+
+	  Choose the default unless you know why you want something different.
+
 config LOCKD
 	tristate
 
 config LOCKD_V4
 	bool
Index: linux-2.6.21-standard/fs/nfs/nfsroot.c
===================================================================
--- linux-2.6.21-standard.orig/fs/nfs/nfsroot.c
+++ linux-2.6.21-standard/fs/nfs/nfsroot.c
@@ -90,11 +90,11 @@
 /* Define this to allow debugging output */
 #undef NFSROOT_DEBUG
 #define NFSDBG_FACILITY NFSDBG_ROOT
 
 /* Default path we try to mount. "%s" gets replaced by our IP address */
-#define NFS_ROOT		"/tftpboot/%s"
+#define NFS_ROOT		CONFIG_ROOT_NFS_PATH
 
 /* Parameters passed from the kernel command line */
 static char nfs_root_name[256] __initdata = "";
 
 /* Address of NFS server */
@@ -402,11 +402,14 @@ static int __init nfs_root_setup(char *l
 		strlcpy(nfs_root_name, line, sizeof(nfs_root_name));
 	} else {
 		int n = strlen(line) + sizeof(NFS_ROOT) - 1;
 		if (n >= sizeof(nfs_root_name))
 			line[sizeof(nfs_root_name) - sizeof(NFS_ROOT) - 2] = '\0';
-		sprintf(nfs_root_name, NFS_ROOT, line);
+		if (strstr(NFS_ROOT, "%s"))
+			sprintf(nfs_root_name, NFS_ROOT, line);
+		else
+			strlcpy(nfs_root_name, NFS_ROOT, sizeof(nfs_root_name));
 	}
 	root_server_addr = root_nfs_parse_addr(nfs_root_name);
 	return 1;
 }
 
