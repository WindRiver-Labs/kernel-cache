From 8166ddba0cc4f6089c5aeeb67d8712e0d7bebd06 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Thu, 2 Dec 2010 21:52:47 -0500
Subject: [PATCH] perf: Fix perf build and dependencies for perl and python

 1) when build perl for perf, there is a bool redefinition,
    so remove -Werror when building perl.

 2) Introduced a varible LIBPERL_DIR to judge if perl is
    involved, which comes from dist/perf/Makefile.

 3) Introduced a varible PYTHON_MAJOR to judge if python
    is included, which comes from dist/perf/Makefile.

 4) If python or perl is not installed, we also remove
    their scripts to avoid rpm-installing other packages
    in small.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 tools/perf/Makefile |   30 ++++++++++++++++++++++++++----
 1 files changed, 26 insertions(+), 4 deletions(-)

diff --git a/tools/perf/Makefile b/tools/perf/Makefile
index 3fe5e27..a0665a1 100644
--- a/tools/perf/Makefile
+++ b/tools/perf/Makefile
@@ -198,7 +198,11 @@ ifndef PERF_DEBUG
   CFLAGS_OPTIMIZE = -O6
 endif
 
+ifneq ($(LIBPERL_DIR),)
+CFLAGS = -ggdb3 -Wall -Wextra -std=gnu99 $(CFLAGS_OPTIMIZE) -D_FORTIFY_SOURCE=2 $(EXTRA_WARNINGS) $(EXTRA_CFLAGS)
+else
 CFLAGS = -ggdb3 -Wall -Wextra -std=gnu99 -Werror $(CFLAGS_OPTIMIZE) -D_FORTIFY_SOURCE=2 $(EXTRA_WARNINGS) $(EXTRA_CFLAGS)
+endif
 EXTLIBS = -lpthread -lrt -lelf -lm
 ALL_CFLAGS = $(CFLAGS) -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64
 ALL_LDFLAGS = $(LDFLAGS)
@@ -513,9 +517,10 @@ else
 	LIB_OBJS += util/probe-finder.o
 endif
 
+ifeq ($(LIBPERL_DIR),)
 ifndef NO_LIBPERL
-PERL_EMBED_LDOPTS = `$(HOST_BUILD_BIN_DIR)perl -MExtUtils::Embed -e ldopts 2>/dev/null`
-PERL_EMBED_CCOPTS = `$(HOST_BUILD_BIN_DIR)perl -MExtUtils::Embed -e ccopts 2>/dev/null`
+PERL_EMBED_LDOPTS = `$(HOST_BUILD_BIN_DIR)\perl -MExtUtils::Embed -e ldopts 2>/dev/null`
+PERL_EMBED_CCOPTS = `$(HOST_BUILD_BIN_DIR)\perl -MExtUtils::Embed -e ccopts 2>/dev/null`
 endif
 
 ifneq ($(shell sh -c "(echo '\#include <EXTERN.h>'; echo '\#include <perl.h>'; echo 'int main(void) { perl_alloc(); return 0; }') | $(CC) -x c - $(PERL_EMBED_CCOPTS) -o $(BITBUCKET) $(PERL_EMBED_LDOPTS) > /dev/null 2>&1 && echo y"), y)
@@ -525,10 +530,17 @@ else
 	LIB_OBJS += util/scripting-engines/trace-event-perl.o
 	LIB_OBJS += scripts/perl/Perf-Trace-Util/Context.o
 endif
+else
+	BASIC_CFLAGS += -I$(HOST_CROSS_SYSROOT_DIR)/$(LIBPERL_DIR)/CORE
+	ALL_LDFLAGS += -L$(HOST_CROSS_SYSROOT_DIR)/$(LIBPERL_DIR)/CORE -lperl
+	LIB_OBJS += util/scripting-engines/trace-event-perl.o
+	LIB_OBJS += scripts/perl/Perf-Trace-Util/Context.o
+endif
 
+ifeq ($(PYTHON_MAJOR),)
 ifndef NO_LIBPYTHON
-PYTHON_EMBED_LDOPTS = `$(HOST_BUILD_BIN_DIR)python-config --ldflags 2>/dev/null`
-PYTHON_EMBED_CCOPTS = `$(HOST_BUILD_BIN_DIR)python-config --cflags 2>/dev/null`
+PYTHON_EMBED_LDOPTS = `$(HOST_BUILD_BIN_DIR)\python-config --ldflags 2>/dev/null`
+PYTHON_EMBED_CCOPTS = `$(HOST_BUILD_BIN_DIR)\python-config --cflags 2>/dev/null`
 endif
 
 ifneq ($(shell sh -c "(echo '\#include <Python.h>'; echo 'int main(void) { Py_Initialize(); return 0; }') | $(CC) -x c - $(PYTHON_EMBED_CCOPTS) -o /dev/null $(PYTHON_EMBED_LDOPTS) > /dev/null 2>&1 && echo y"), y)
@@ -538,6 +550,12 @@ else
 	LIB_OBJS += util/scripting-engines/trace-event-python.o
 	LIB_OBJS += scripts/python/Perf-Trace-Util/Context.o
 endif
+else
+	BASIC_CFLAGS += -I$(HOST_CROSS_SYSROOT_DIR)/usr/include/python$(PYTHON_MAJOR)
+	ALL_LDFLAGS += -L$(HOST_CROSS_SYSROOT_DIR)/usr/lib/python$(PYTHON_MAJOR)/config  -lpython2.6
+	LIB_OBJS += util/scripting-engines/trace-event-python.o
+	LIB_OBJS += scripts/python/Perf-Trace-Util/Context.o
+endif
 
 ifdef NO_DEMANGLE
 	BASIC_CFLAGS += -DNO_DEMANGLE
@@ -1029,17 +1047,21 @@ export perfexec_instdir
 install: all
 	$(INSTALL) -d -m 755 '$(DESTDIR_SQ)$(bindir_SQ)'
 	$(INSTALL) perf$X '$(DESTDIR_SQ)$(bindir_SQ)'
+ifneq ($(LIBPERL_DIR),)
 	$(INSTALL) -d -m 755 '$(DESTDIR_SQ)$(perfexec_instdir_SQ)/scripts/perl/Perf-Trace-Util/lib/Perf/Trace'
 	$(INSTALL) -d -m 755 '$(DESTDIR_SQ)$(perfexec_instdir_SQ)/scripts/perl/bin'
 	$(INSTALL) perf-archive -t '$(DESTDIR_SQ)$(perfexec_instdir_SQ)'
 	$(INSTALL) scripts/perl/Perf-Trace-Util/lib/Perf/Trace/* -t '$(DESTDIR_SQ)$(perfexec_instdir_SQ)/scripts/perl/Perf-Trace-Util/lib/Perf/Trace'
 	$(INSTALL) scripts/perl/*.pl -t '$(DESTDIR_SQ)$(perfexec_instdir_SQ)/scripts/perl'
 	$(INSTALL) scripts/perl/bin/* -t '$(DESTDIR_SQ)$(perfexec_instdir_SQ)/scripts/perl/bin'
+endif
+ifneq ($(PYTHON_MAJOR),)
 	$(INSTALL) -d -m 755 '$(DESTDIR_SQ)$(perfexec_instdir_SQ)/scripts/python/Perf-Trace-Util/lib/Perf/Trace'
 	$(INSTALL) -d -m 755 '$(DESTDIR_SQ)$(perfexec_instdir_SQ)/scripts/python/bin'
 	$(INSTALL) scripts/python/Perf-Trace-Util/lib/Perf/Trace/* -t '$(DESTDIR_SQ)$(perfexec_instdir_SQ)/scripts/python/Perf-Trace-Util/lib/Perf/Trace'
 	$(INSTALL) scripts/python/*.py -t '$(DESTDIR_SQ)$(perfexec_instdir_SQ)/scripts/python'
 	$(INSTALL) scripts/python/bin/* -t '$(DESTDIR_SQ)$(perfexec_instdir_SQ)/scripts/python/bin'
+endif
 
 ifdef BUILT_INS
 	$(INSTALL) -d -m 755 '$(DESTDIR_SQ)$(perfexec_instdir_SQ)'
-- 
1.6.5.2

