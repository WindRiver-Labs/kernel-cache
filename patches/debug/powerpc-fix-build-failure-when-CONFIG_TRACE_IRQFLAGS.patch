From a2ac307274ee858ec2b6dc8b81680b41b537bba7 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Fri, 17 Dec 2010 11:18:04 +0800
Subject: [PATCH] powerpc: fix build failure when CONFIG_TRACE_IRQFLAGS

When CONFIG_TRACE_IRQFLAGS is enabled, we should use mtspr SPRN_SPRG0
instead of mtsprg <#> to avoid register spill issues.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/powerpc/kernel/entry_32.S |   28 ++++++++++++++--------------
 1 files changed, 14 insertions(+), 14 deletions(-)

diff --git a/arch/powerpc/kernel/entry_32.S b/arch/powerpc/kernel/entry_32.S
index 3635916..14cc6a1 100644
--- a/arch/powerpc/kernel/entry_32.S
+++ b/arch/powerpc/kernel/entry_32.S
@@ -250,23 +250,23 @@ reenable_mmu:				/* re-enable mmu so we can */
 	 */
 	stw	r9,8(r1)
 	stw	r11,12(r1)
-	mtsprg	0,r0
-	mtsprg	4,r4
-	mtsprg	5,r5
-	mtsprg	6,r6
-	mtsprg	7,r7
-	mtsprg	1,r8
-	mtsprg	2,r3
+	mtspr	SPRN_SPRG0,r0
+	mtspr	SPRN_SPRG4,r4
+	mtspr	SPRN_SPRG5,r5
+	mtspr	SPRN_SPRG6,r6
+	mtspr	SPRN_SPRG7,r7
+	mtspr	SPRN_SPRG1,r8
+	mtspr	SPRN_SPRG2,r3
 	bl	trace_hardirqs_off
 	lwz	r11,12(r1)
 	lwz	r9,8(r1)
-	mfsprg	r3,2
-	mfsprg	r8,1
-	mfsprg	r7,7
-	mfsprg	r6,6
-	mfsprg	r5,5
-	mfsprg	r4,4
-	mfsprg	r0,0
+	mfspr	r3,SPRN_SPRG2
+	mfspr	r8,SPRN_SPRG1
+	mfspr	r7,SPRN_SPRG7
+	mfspr	r6,SPRN_SPRG6
+	mfspr	r5,SPRN_SPRG5
+	mfspr	r4,SPRN_SPRG4
+	mfspr	r0,SPRN_SPRG0
 1:	mtctr	r11
 	mtlr	r9
 	bctr				/* jump to handler */
-- 
1.7.0

