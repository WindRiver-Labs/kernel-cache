From cad570db3b9693016a9c5b1537ed8352fc238ba0 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 30 Nov 2010 18:40:44 -0800
Subject: [PATCH] powerpc/lockdep: ignore MSR_PR check when CONFIG_PROVE_LOCKING is enabled

In order to fix a oops when CONFIG_IRQSOFF_TRACER is enabled,
the commit(tracing: fix oops for powerpc in irqsoff_tracer)
avoid to invoke trace_hardirqs_on before returning to user space.
But when CONFIG_PROVE_LOCKING is enabled, the trace_hardirqs_on will
use a different implementation. And the lockdep also require to
invoke it before returning to both user space or kernel context
with irq enabled. So ignore the MS_PR check when CONFIG_PROVE_LOCKING
is enabled.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/entry_32.S |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/entry_32.S b/arch/powerpc/kernel/entry_32.S
index 863d72c..59d75b3 100644
--- a/arch/powerpc/kernel/entry_32.S
+++ b/arch/powerpc/kernel/entry_32.S
@@ -934,8 +934,10 @@ native_restore:
 	 * we could encode what the exception did somewhere or test the exception
 	 * type in the pt_regs but that sounds overkill
 	 */
+#ifndef CONFIG_PROVE_LOCKING
 	andi.	r10,r9,MSR_PR
 	bne	1f /* Do nothing if restore to user-mode */
+#endif
 	andi.	r10,r9,MSR_EE
 	beq	1f
 	bl	trace_hardirqs_on
-- 
1.6.5.2

