From efc2a0cf50b01608c3e7ac84c94785081519fd8b Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Fri, 24 Feb 2012 17:22:31 +0800
Subject: [PATCH 6/9] fix pgoff in "have to relocate" case of mremap()

commit 935874141df839c706cd6cdc438e85eb69d1525e upstream

Acked-by: Hugh Dickins <hugh.dickins@tiscali.co.uk>
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 mm/mremap.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/mm/mremap.c b/mm/mremap.c
index a80e0e5..1030952 100644
--- a/mm/mremap.c
+++ b/mm/mremap.c
@@ -479,7 +479,9 @@ unsigned long do_mremap(unsigned long addr,
 			map_flags |= MAP_SHARED;
 
 		new_addr = get_unmapped_area(vma->vm_file, 0, new_len,
-					vma->vm_pgoff, map_flags);
+					vma->vm_pgoff +
+					((addr - vma->vm_start) >> PAGE_SHIFT),
+					map_flags);
 		if (new_addr & ~PAGE_MASK) {
 			ret = new_addr;
 			goto out;
-- 
1.7.0.4

