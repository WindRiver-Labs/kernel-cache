From 0e5936c118b68086fddbc7345be6c152bb6b195a Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Fri, 24 Feb 2012 18:12:36 +0800
Subject: [PATCH 9/9] switch do_brk() to get_unmapped_area()

commit 2c6a10161d0b5fc047b5bd81b03693b9af99fab5 upstream

Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Integrated-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 mm/mmap.c |   10 ++--------
 1 files changed, 2 insertions(+), 8 deletions(-)

diff --git a/mm/mmap.c b/mm/mmap.c
index c809d42..5a9c5cf 100644
--- a/mm/mmap.c
+++ b/mm/mmap.c
@@ -1970,20 +1970,14 @@ unsigned long do_brk(unsigned long addr, unsigned long len)
 	if (!len)
 		return addr;
 
-	if ((addr + len) > TASK_SIZE || (addr + len) < addr)
-		return -EINVAL;
-
-	if (is_hugepage_only_range(mm, addr, len))
-		return -EINVAL;
-
 	error = security_file_mmap(NULL, 0, 0, 0, addr, 1);
 	if (error)
 		return error;
 
 	flags = VM_DATA_DEFAULT_FLAGS | VM_ACCOUNT | mm->def_flags;
 
-	error = arch_mmap_check(addr, len, flags);
-	if (error)
+	error = get_unmapped_area(NULL, addr, len, 0, MAP_FIXED);
+	if (error & ~PAGE_MASK)
 		return error;
 
 	/*
-- 
1.7.0.4

