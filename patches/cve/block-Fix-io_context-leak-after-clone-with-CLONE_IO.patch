From 5095f41efcecad2c25a9e60a1371b3daa893fc72 Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Tue, 19 Jun 2012 15:34:53 +0800
Subject: [PATCH 2/2] block: Fix io_context leak after clone with CLONE_IO

upstream commit: 61cc74fbb87af6aa551a06a370590c9bc07e29d9

With CLONE_IO, copy_io() increments both ioc->refcount and ioc->nr_tasks.
However exit_io_context() only decrements ioc->refcount if ioc->nr_tasks
reaches 0.

Always call put_io_context() in exit_io_context().

Signed-off-by: Louis Rilling <louis.rilling@kerlabs.com>
Signed-off-by: Jens Axboe <jens.axboe@oracle.com>
Integrated-by: Li Wang <li.wang@windriver.com>
---
 block/blk-ioc.c |    3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/block/blk-ioc.c b/block/blk-ioc.c
index e3a4765..7999225 100644
--- a/block/blk-ioc.c
+++ b/block/blk-ioc.c
@@ -79,9 +79,8 @@ void exit_io_context(struct task_struct *task)
 		if (ioc->aic && ioc->aic->exit)
 			ioc->aic->exit(ioc->aic);
 		cfq_exit(ioc);
-
-		put_io_context(ioc);
 	}
+	put_io_context(ioc);
 }
 
 struct io_context *alloc_io_context(gfp_t gfp_flags, int node)
-- 
1.7.9.7

