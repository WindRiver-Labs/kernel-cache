From db0a0993a9a3856f1311e48c0e54928640399f81 Mon Sep 17 00:00:00 2001
From: "yanjun.zhu" <yanjun.zhu@windriver.com>
Date: Mon, 21 Oct 2013 16:49:05 +0800
Subject: [PATCH] ansi_cprng: Fix off by one error in non-block size request

commit 4d7ada78a64c86789836f5153962a45693b4d9a6 upstream

If several small requests are made that are less than the instances block
size, the remainder for loop code doesn't increment rand_data_valid in
the last iteration, meaning that the last bytes in the rand_data buffer
gets reused on the subsequent smaller-than-a-block request for random
data. Re-code the for loop to make sure that rand_data_valid gets
incremented appropriately

CVE-2013-4345

Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
Reported-by: Stephan Mueller <stephan.mueller@atsec.com>
CC: Stephan Mueller <stephan.mueller@atsec.com>
CC: Petr Matousek <pmatouse@redhat.com>
CC: Herbert Xu <herbert@gondor.apana.org.au>
CC: "David S. Miller" <davem@davemloft.net>
Signed-off-by: yanjun.zhu <yanjun.zhu@windriver.com>
---
 crypto/ansi_cprng.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/crypto/ansi_cprng.c b/crypto/ansi_cprng.c
index c0bb377..666f196 100644
--- a/crypto/ansi_cprng.c
+++ b/crypto/ansi_cprng.c
@@ -230,11 +230,11 @@ remainder:
 	 */
 	if (byte_count < DEFAULT_BLK_SZ) {
 empty_rbuf:
-		for (; ctx->rand_data_valid < DEFAULT_BLK_SZ;
-			ctx->rand_data_valid++) {
+		while (ctx->rand_data_valid < DEFAULT_BLK_SZ) {
 			*ptr = ctx->rand_data[ctx->rand_data_valid];
 			ptr++;
 			byte_count--;
+			ctx->rand_data_valid++;
 			if (byte_count == 0)
 				goto done;
 		}
-- 
1.7.5.4

