From 266449f4d447b5db0e4a978a64bd2c33d6351049 Mon Sep 17 00:00:00 2001
From: Qi Hou <qi.hou@windriver.com>
Date: Mon, 10 Apr 2017 11:31:29 +0800
Subject: [PATCH] keyring: fix null-ptr deref in keyring_search_aux

The "match" func pointer field in key_type_dead is not set and it is NULL.
If a key type request of "dead" is provoked via request_key system call, the
"match" func pointer will be dereferenced. But it is NULL, a kernel oops will
will happen.

Even though Davin declared "You shouldn't be able to deal with dead
keys at all", it should be fixed by checking the validation of the "match"
field before dereferencing in case of intentionally or unintentionally
attacking.

Signed-off-by: idl3r <idler1984@xxxxxxxxx>
Signed-off-by: David Howells <dhowells@xxxxxxxxxx>
Signed-off-by: Willy Tarreau <w@xxxxxx>
Link: https://nvd.nist.gov/vuln/detail/CVE-2017-6951
Signed-off-by: Qi Hou <qi.hou@windriver.com>
---
 security/keys/keyring.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/security/keys/keyring.c b/security/keys/keyring.c
index 6ece7f2..a018abb 100644
--- a/security/keys/keyring.c
+++ b/security/keys/keyring.c
@@ -335,6 +335,11 @@ key_ref_t keyring_search_aux(key_ref_t keyring_ref,
 	long err;
 	int sp, nkeys, kix;
 
+	if (!match) {
+		key_ref = ERR_PTR(-EINVAL);
+		goto error;
+	}
+
 	keyring = key_ref_to_ptr(keyring_ref);
 	possessed = is_key_possessed(keyring_ref);
 	key_check(keyring);
-- 
1.7.5.4

