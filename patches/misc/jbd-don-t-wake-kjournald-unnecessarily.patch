From e60bfa7c158bf69227b31716442285c36ca92a97 Mon Sep 17 00:00:00 2001
From: Eric Sandeen <sandeen@redhat.com>
Date: Tue, 11 Aug 2015 17:38:36 +0800
Subject: [PATCH 1/2] jbd: don't wake kjournald unnecessarily

commit 7e2fb2d7e6a3094473f101ae33dd6431ae6d2ed1 upstream

Don't send an extra wakeup to kjournald in the case where we
already have the proper target in j_commit_request, i.e. that
commit has already been requested for commit.

commit d9b0193 "jbd: fix fsync() tid wraparound bug" changed
the logic leading to a wakeup, but it caused some extra wakeups
which were found to lead to a measurable performance regression.

Signed-off-by: Eric Sandeen <sandeen@redhat.com>
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: yanjun.zhu <yanjun.zhu@windriver.com>
---
 fs/jbd/journal.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/fs/jbd/journal.c b/fs/jbd/journal.c
index 61de29b..d5c5ccf 100644
--- a/fs/jbd/journal.c
+++ b/fs/jbd/journal.c
@@ -439,7 +439,8 @@ int __log_start_commit(journal_t *journal, tid_t target)
 	 * currently running transaction (if it exists).  Otherwise,
 	 * the target tid must be an old one.
 	 */
-	if (journal->j_running_transaction &&
+	if (journal->j_commit_request != target &&
+	    journal->j_running_transaction &&
 	    journal->j_running_transaction->t_tid == target) {
 		/*
 		 * We want a new commit: OK, mark the request and wakup the
-- 
1.7.0

