From 78c940507e9e98f748629bcc327bc5c32ab36043 Mon Sep 17 00:00:00 2001
From: Zhenbo Gao <zhenbo.gao@windriver.com>
Date: Thu, 14 Jan 2016 08:13:13 +0000
Subject: [PATCH] module: fix compile err when KALLSYMS is not set

compile kernel will fail if KALLSYMS is not set, the output looks like:
...
  CC kernel/module.o
  ../bitbake_build/tmp/work/qemux86-wrs-linux/linux-windriver/3.10-r0/linux/kernel/module.c:1681:2:
  error: implicit declaration of function 'add_notes_attrs'
  [-Werror=implicit-function-declaration]
    add_notes_attrs(mod, info);
      ^

Signed-off-by: Zhenbo Gao <zhenbo.gao@windriver.com>
---
 kernel/module.c |   19 ++++++++++++-------
 1 files changed, 12 insertions(+), 7 deletions(-)

diff --git a/kernel/module.c b/kernel/module.c
index 9dccb57..b793ada 100644
--- a/kernel/module.c
+++ b/kernel/module.c
@@ -1319,7 +1319,6 @@ resolve_symbol_wait(struct module *mod,
 #ifdef CONFIG_SYSFS
 
 #if (defined(CONFIG_KALLSYMS) || defined (CONFIG_WR_OCD_DEBUG))
-#ifdef CONFIG_KALLSYMS
 static inline bool sect_empty(const Elf_Shdr *sect)
 {
 	return !(sect->sh_flags & SHF_ALLOC) || sect->sh_size == 0;
@@ -1346,7 +1345,6 @@ static ssize_t module_sect_show(struct module_attribute *mattr,
 		container_of(mattr, struct module_sect_attr, mattr);
 	return sprintf(buf, "0x%pK\n", (void *)sattr->address);
 }
-#endif /* CONFIG_KALLSYMS */
 
 static void free_sect_attrs(struct module_sect_attrs *sect_attrs)
 {
@@ -1394,9 +1392,7 @@ static void add_sect_attrs(struct module *mod, const struct load_info *info)
 			goto out;
 		sect_attrs->nsections++;
 		sysfs_attr_init(&sattr->mattr.attr);
-#ifdef CONFIG_KALLSYMS
 		sattr->mattr.show = module_sect_show;
-#endif
 		sattr->mattr.store = NULL;
 		sattr->mattr.attr.name = sattr->name;
 		sattr->mattr.attr.mode = S_IRUGO;
@@ -1425,11 +1421,11 @@ static void remove_sect_attrs(struct module *mod)
 	}
 }
 
-#ifdef CONFIG_KALLSYMS
 /*
  * /sys/module/foo/notes/.section.name gives contents of SHT_NOTE sections.
  */
 
+#ifdef CONFIG_KALLSYMS
 struct module_notes_attrs {
 	struct kobject *dir;
 	unsigned int notes;
@@ -1523,6 +1519,17 @@ static void remove_notes_attrs(struct module *mod)
 	if (mod->notes_attrs)
 		free_notes_attrs(mod->notes_attrs, mod->notes_attrs->notes);
 }
+
+#else /* !CONFIG_KALLSYMS && CONFIG_WR_OCD_DEBUG */
+static inline void add_notes_attrs(struct module *mod,
+				   const struct load_info *info)
+{
+}
+
+static inline void remove_notes_attrs(struct module *mod)
+{
+}
+
 #endif /* CONFIG_KALLSYMS */
 
 #else /* ! (CONFIG_KALLSYMS || CONFIG_WR_OCD_DEBUG) */
@@ -1536,7 +1543,6 @@ static inline void remove_sect_attrs(struct module *mod)
 {
 }
 
-#ifdef CONFIG_KALLSYMS
 static inline void add_notes_attrs(struct module *mod,
 				   const struct load_info *info)
 {
@@ -1545,7 +1551,6 @@ static inline void add_notes_attrs(struct module *mod,
 static inline void remove_notes_attrs(struct module *mod)
 {
 }
-#endif /* CONFIG_KALLSYMS */
 #endif /* CONFIG_KALLSYMS || CONFIG_WR_OCD_DEBUG */
 
 static void add_usage_links(struct module *mod)
-- 
1.7.5.4

