From 26cbb589f03bc5882ace781badacc4d9e79950a0 Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Wed, 5 Jul 2017 09:02:41 +0000
Subject: [PATCH] security/keys: Check function "match" before calling it

In function keyring_search_iterator, "match" maybe called as a NULL
pointer. Fix it.

This issue is introduce by b2a4df200d and disappeared after commit
c06cfb08b8
KEYS: Remove key_type::match in favour of overriding default by
match_preparse

Commit c06cfb08b8 doesn't focus on this very bug but changed related
mechanism that make this issue disappeared. It is not fit for current
kernel. So we just fix bug here.

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 security/keys/keyring.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/security/keys/keyring.c b/security/keys/keyring.c
index 79fb9f4..0268bc6 100644
--- a/security/keys/keyring.c
+++ b/security/keys/keyring.c
@@ -533,7 +533,8 @@ static int keyring_search_iterator(const void *object, void *iterator_data)
 	}
 
 	/* keys that don't match */
-	if (!ctx->match(key, ctx->match_data)) {
+	if ((!ctx->match) ||
+	    !ctx->match(key, ctx->match_data)) {
 		kleave(" = 0 [!match]");
 		return 0;
 	}
-- 
1.7.5.4

