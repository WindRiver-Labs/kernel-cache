From 6b0d30428dcfc1fb8b4880e1fd530bbf4fcd4642 Mon Sep 17 00:00:00 2001
From: Li Zhou <li.zhou@windriver.com>
Date: Fri, 26 Jun 2015 14:54:11 +0800
Subject: [PATCH] fs: nfsd: add missing fh_drop_write for fucntion
 nfsd_setattr

There is only fh_want_write in the beginning of fucntion nfsd_setattr,
and no fh_drop_write at the end of it. So when umount after nfs client
is writing (in which case nfsd_setattr is called), kernel will print
WARNING because of messed up want_write/drop_write() pair.

The WARNING message is as below:
------------[ cut here ]------------
WARNING: at ....../linux/fs/namespace.c:796 mntput_no_expire+0xfb/0x130()
Hardware name: Bochs
Modules linked in: cfbfillrect exportfs cfbimgblt cfbcopyarea uvesafb parport floppy parport_pc minix nfsd
Pid: 2033, comm: umount Not tainted 3.4.91-WR5.0.1.26_standard #2
Call Trace:
 [<ffffffff8103562f>] warn_slowpath_common+0x7f/0xc0
 [<ffffffff8103568a>] warn_slowpath_null+0x1a/0x20
 [<ffffffff8114c7bb>] mntput_no_expire+0xfb/0x130
 [<ffffffff8114d53d>] sys_umount+0x6d/0x3a0
 [<ffffffff81666052>] system_call_fastpath+0x16/0x1b
---[ end trace 5886946490775e2c ]---

This solution is specific for wrlinux5 kernel, and this issue is fixed
by different semantics in the newer kernel version by
<commit 4a55c1017b8dcfd0554734ce3f19374d5b522d59
nfsd: Push mnt_want_write() outside of i_mutex>, which isn't proper for
this kernel version yet.

Signed-off-by: Li Zhou <li.zhou@windriver.com>
---
 fs/nfsd/vfs.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/fs/nfsd/vfs.c b/fs/nfsd/vfs.c
index 6383062..ad0c754 100644
--- a/fs/nfsd/vfs.c
+++ b/fs/nfsd/vfs.c
@@ -420,7 +420,7 @@ nfsd_setattr(struct svc_rqst *rqstp, struct svc_fh *fhp, struct iattr *iap,
 	/* Get inode */
 	err = fh_verify(rqstp, fhp, ftype, accmode);
 	if (err)
-		goto out;
+		goto out_no_drop_write;
 	if (get_write_count) {
 		host_err = fh_want_write(fhp);
 		if (host_err)
@@ -473,6 +473,9 @@ out_put_write_access:
 	if (!err)
 		commit_metadata(fhp);
 out:
+	if (get_write_count)
+		fh_drop_write(fhp);
+out_no_drop_write:
 	return err;
 }
 
-- 
1.7.5.4

