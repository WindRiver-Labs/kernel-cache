From 592655375b13314b208d51eae3068b2e5a86175d Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Tue, 24 May 2016 10:45:50 +0800
Subject: [PATCH] workqueue: bug fix on call trace

Upstream commit 5b95e1af8d17d85a is not integrated correctly
thus caused the call trace below, fix it.

WARNING: CPU: 0 PID: 1 at kernel/workqueue.c:3504 numa_pwq_tbl_install+0x87/0x90()
Modules linked in:
CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.1.21-WR8.0.0.0_standard #11
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.8.2-0-g33fbe13 by qemu-project.org 04/01/2014
 00000286 00000286 c78a5dbc c19a8673 00000000 c1bca78a c78a5dec c1055437
 c1bbd92c 00000000 00000001 c1bca78a 00000db0 c106c8f7 c106c8f7 c781df00
 c7831c00 00000000 c78a5dfc c1055512 00000009 00000000 c78a5e10 c106c8f7
Call Trace:
 [<c19a8673>] dump_stack+0x5f/0x86
 [<c1055437>] warn_slowpath_common+0x87/0xc0
 [<c106c8f7>] ? numa_pwq_tbl_install+0x87/0x90
 [<c106c8f7>] ? numa_pwq_tbl_install+0x87/0x90
 [<c1055512>] warn_slowpath_null+0x22/0x30
 [<c106c8f7>] numa_pwq_tbl_install+0x87/0x90
 [<c106d7bf>] apply_wqattrs_commit+0x7f/0xd0
 [<c1072357>] apply_workqueue_attrs+0x57/0xb0
 [<c1073aa8>] __alloc_workqueue_key+0x148/0x4a0
 [<c19aee7d>] ? mutex_unlock+0xd/0x10
 [<c1073cbc>] ? __alloc_workqueue_key+0x35c/0x4a0
 [<c1d919a2>] init_workqueues+0x3ac/0x46b
 [<c1d915f6>] ? wq_sysfs_init+0x24/0x24
 [<c100042e>] do_one_initcall+0x7e/0x1b0
 [<c1d915f6>] ? wq_sysfs_init+0x24/0x24
 [<c10bf2f1>] ? vprintk_default+0x41/0x60
 [<c19a69a4>] ? printk+0x17/0x19
 [<c1013e19>] ? print_cpu_info+0x89/0x100
 [<c1d88830>] ? native_smp_prepare_cpus+0x28d/0x297
 [<c1d7ac00>] kernel_init_freeable+0xe3/0x220
 [<c10a8c9b>] ? trace_hardirqs_on+0xb/0x10
 [<c19b0d82>] ? _raw_spin_unlock_irq+0x32/0x50
 [<c107da7c>] ? finish_task_switch+0x8c/0x100
 [<c107da3a>] ? finish_task_switch+0x4a/0x100
 [<c19a3970>] kernel_init+0x10/0xe0
 [<c19b1701>] ret_from_kernel_thread+0x21/0x30
 [<c19a3960>] ? rest_init+0x120/0x120

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 kernel/workqueue.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/kernel/workqueue.c b/kernel/workqueue.c
index 590cdae..3e9c16c 100644
--- a/kernel/workqueue.c
+++ b/kernel/workqueue.c
@@ -3670,7 +3670,6 @@ int apply_workqueue_attrs(struct workqueue_struct *wq,
 
 	mutex_lock(&wq_pool_mutex);
 	ctx = apply_wqattrs_prepare(wq, attrs);
-	mutex_unlock(&wq_pool_mutex);
 
 	/* the ctx has been prepared successfully, let's commit it */
 	if (ctx) {
@@ -3678,6 +3677,7 @@ int apply_workqueue_attrs(struct workqueue_struct *wq,
 		ret = 0;
 	}
 
+	mutex_unlock(&wq_pool_mutex);
 	put_online_cpus();
 
 	apply_wqattrs_cleanup(ctx);
-- 
1.7.5.4

