From 9640d59bb93d8b06a7cd335d8a8a8a7105b4bb6f Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Thu, 5 Jan 2017 09:37:44 +0800
Subject: [PATCH] make kthread_cpus affected by isolcpus

kernel "kthread_cpus" option is introduced by commit:
ced4c0a3c71df821b2af0ebbb5a11fd3a34ff8f4
affine compute kernel threads to cpu 0

it make "isolcpus" option invalid,
but, "isolcpus" is a standard kernel option,
make kthread_cpus affected by isolcpus.

Signed-off-by: Li Wang <li.wang@windriver.com>
---
 kernel/sched/core.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/kernel/sched/core.c b/kernel/sched/core.c
index 476c4bc..51c3129 100644
--- a/kernel/sched/core.c
+++ b/kernel/sched/core.c
@@ -7225,6 +7225,9 @@ void __init sched_init_smp(void)
 	cpumask_andnot(non_isolated_cpus, cpu_possible_mask, cpu_isolated_map);
 	if (cpumask_empty(non_isolated_cpus))
 		cpumask_set_cpu(smp_processor_id(), non_isolated_cpus);
+	cpumask_andnot(cpu_kthread_mask, cpu_kthread_mask, cpu_isolated_map);
+	if (cpumask_empty(cpu_kthread_mask))
+		cpumask_set_cpu(smp_processor_id(), cpu_kthread_mask);
 	mutex_unlock(&sched_domains_mutex);
 	put_online_cpus();
 
-- 
1.7.5.4

