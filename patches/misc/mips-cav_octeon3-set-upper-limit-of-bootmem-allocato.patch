From cdbcc4886aa59cea8b80d435b8ff3c4169183a77 Mon Sep 17 00:00:00 2001
From: Shan Hai <shan.hai@windriver.com>
Date: Mon, 25 Apr 2016 15:43:02 +0800
Subject: [PATCH] mips/cav_octeon3: set upper limit of bootmem allocator to
 max_memory

The kernel would panic when the following condition holds for Cavium Octeon 3
boards:
Hardware RAM size: 64GB
Set "mem=16GB" on the kernel command line

The reason of the panic is that the Cavium Octeon 3 specific bootmem
allocator returns physical memory chunk address of which exceeds the
specified 16GB by the "mem" kernel option, fix it by setting upper
limit of the bootmem allocator to value of the "mem" option (max_memory).

The kernel stack trace on a panic:
bootmem alloc of 67108864 bytes failed!
Kernel panic - not syncing: Out of memory
CPU: 0 PID: 0 Comm: swapper Not tainted 3.10.62-ltsi-xxx_standard #1
Stack : ffffffff81207a90 ffffffff8089660c 0000000000000001 00000000000000c6
ffffffff81300000 0000000000000004 0000000000000001 0000000000000000
ffffffff81207ad0 ffffffff80896410 000000000000004b ffffffff81300000
ffffffff81207af0 ffffffff80896a3c 0000000000000000 0000000000000000
0000000000000000 ffffffff81400000 ffffffff813fc608 ffffffff81400000
ffffffff81156620 ffffffff812402f7 ffffffff813fc608 ffffffff81240788
0000000000000000 0000000000000000 ffffffff813f91a0 0000000000000018
ffffffff81207b70 ffffffff81207a80 ffffffff81207b98 ffffffff810118b8
ffffffff81207bd0 ffffffff80898498 ffffffff812403f0 ffffffff81156620
0000000000000000 ffffffff8086e6b8 0000000000000000 0000000000000000
...
Call Trace:
[<ffffffff8086e6b8>] show_stack+0xd8/0xf8
[<ffffffff810118b8>] panic+0xe8/0x214
[<ffffffff813759ac>] __alloc_bootmem_low+0x48/0x60
[<ffffffff813606c4>] plat_swiotlb_setup+0x1a0/0x244
[<ffffffff81364d68>] setup_arch+0x2e0/0x580
[<ffffffff813586e4>] start_kernel+0xa8/0x4fc

Signed-off-by: Shan Hai <shan.hai@windriver.com>
Signed-off-by: Zhenbo Gao <zhenbo.gao@windriver.com>
---
 arch/mips/cavium-octeon/setup.c |   14 ++++++++++++++
 1 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index 3d90c3f..9b804a8 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -1052,6 +1052,20 @@ void __init plat_mem_setup(void)
 	while ((boot_mem_map.nr_map < BOOT_MEM_MAP_MAX)	&& (total < max_memory)) {
 			if (total >= mem_32_size)
 				limit_max = ~0ull;              /* unlimitted */
+
+			/*
+			 * Use max_memory as upper limit of the physical memory
+			 * allocation otherwise the cvmx_bootmem_phy_alloc will
+			 * return physical address above max_memory when the
+			 * size of the installed RAM is lager than the value set
+			 * by "mem" kernel option, this would cause kernel panic
+			 * in the bootmem allocator.
+			 *
+			 * For instance, the hardware has 64GB RAM installed but
+			 * the kernel has "mem=16GB" option set.
+			 */
+			limit_max = (limit_max > max_memory) ? max_memory : limit_max;
+
 			memory = cvmx_bootmem_phy_alloc(mem_alloc_size,
 				limit_min, limit_max, 0x100000,
 				CVMX_BOOTMEM_FLAG_NO_LOCKING);
-- 
1.7.5.4

