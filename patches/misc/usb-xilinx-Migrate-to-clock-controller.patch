From a6e41973d6012f9ae84b3cf49574b35065c5dbc8 Mon Sep 17 00:00:00 2001
From: Soren Brinkmann <soren.brinkmann@xilinx.com>
Date: Tue, 16 Apr 2013 14:38:33 -0700
Subject: [PATCH 543/628] usb: xilinx: Migrate to clock controller

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit 28581ed9 arm: zynq: Migrate to clock controller

Switch Zynq, including its drivers, over to use the new clock
controller. And remove old clock implementation.

Signed-off-by: Soren Brinkmann <soren.brinkmann@xilinx.com>
[cherry picked the xilinx usb driver modification only]
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/usb/gadget/xilinx_usbps_udc.c |    7 ++-----
 drivers/usb/host/ehci-xilinx-usbps.c  |    7 ++-----
 drivers/usb/host/xusbps-dr-of.c       |    7 ++-----
 drivers/usb/phy/phy-zynq-usb.c        |    7 ++-----
 4 files changed, 8 insertions(+), 20 deletions(-)

diff --git a/drivers/usb/gadget/xilinx_usbps_udc.c b/drivers/usb/gadget/xilinx_usbps_udc.c
index 2535e7a..fa9a27b 100644
--- a/drivers/usb/gadget/xilinx_usbps_udc.c
+++ b/drivers/usb/gadget/xilinx_usbps_udc.c
@@ -396,12 +396,9 @@ static int xusbps_udc_clk_init(struct platform_device *pdev)
 	struct xusbps_usb2_platform_data *pdata = pdev->dev.platform_data;
 	int rc;
 
-	if (pdata->irq == 53)
-		pdata->clk = clk_get_sys("USB0_APER", NULL);
-	else
-		pdata->clk = clk_get_sys("USB1_APER", NULL);
+	pdata->clk = clk_get(&pdev->dev, NULL);
 	if (IS_ERR(pdata->clk)) {
-		dev_err(&pdev->dev, "APER clock not found.\n");
+		dev_err(&pdev->dev, "input clock not found.\n");
 		return PTR_ERR(pdata->clk);
 	}
 
diff --git a/drivers/usb/host/ehci-xilinx-usbps.c b/drivers/usb/host/ehci-xilinx-usbps.c
index a1618ee..da9203a 100644
--- a/drivers/usb/host/ehci-xilinx-usbps.c
+++ b/drivers/usb/host/ehci-xilinx-usbps.c
@@ -168,12 +168,9 @@ static int usb_hcd_xusbps_probe(const struct hc_driver *driver,
 		goto err2;
 	}
 
-	if (pdata->irq == 53)
-		pdata->clk = clk_get_sys("USB0_APER", NULL);
-	else
-		pdata->clk = clk_get_sys("USB1_APER", NULL);
+	pdata->clk = clk_get(&pdev->dev, NULL);
 	if (IS_ERR(pdata->clk)) {
-		dev_err(&pdev->dev, "APER clock not found.\n");
+		dev_err(&pdev->dev, "input clock not found.\n");
 		retval = PTR_ERR(pdata->clk);
 		goto err2;
 	}
diff --git a/drivers/usb/host/xusbps-dr-of.c b/drivers/usb/host/xusbps-dr-of.c
index c75e23e..0afd469 100644
--- a/drivers/usb/host/xusbps-dr-of.c
+++ b/drivers/usb/host/xusbps-dr-of.c
@@ -202,12 +202,9 @@ static int xusbps_dr_of_probe(struct platform_device *ofdev)
 	}
 	platform_set_drvdata(ofdev, hdata);
 
-	if (pdata->irq == 53)
-		hdata->clk = clk_get_sys("USB0_APER", NULL);
-	else
-		hdata->clk = clk_get_sys("USB1_APER", NULL);
+	hdata->clk = clk_get(&ofdev->dev, NULL);
 	if (IS_ERR(hdata->clk)) {
-		dev_err(&ofdev->dev, "APER clock not found.\n");
+		dev_err(&ofdev->dev, "input clock not found.\n");
 		ret = PTR_ERR(hdata->clk);
 		goto err_free;
 	}
diff --git a/drivers/usb/phy/phy-zynq-usb.c b/drivers/usb/phy/phy-zynq-usb.c
index f94128e..7b21498 100644
--- a/drivers/usb/phy/phy-zynq-usb.c
+++ b/drivers/usb/phy/phy-zynq-usb.c
@@ -1996,12 +1996,9 @@ static int xusbps_otg_probe(struct platform_device *pdev)
 	}
 	INIT_WORK(&xotg->work, xusbps_otg_work);
 
-	if (xotg->irq == 53)
-		xotg->clk = clk_get_sys("USB0_APER", NULL);
-	else
-		xotg->clk = clk_get_sys("USB1_APER", NULL);
+	xotg->clk = clk_get(&pdev->dev, NULL);
 	if (IS_ERR(xotg->clk)) {
-		dev_err(&pdev->dev, "APER clock not found.\n");
+		dev_err(&pdev->dev, "input clock not found.\n");
 		retval = PTR_ERR(xotg->clk);
 		goto err;
 	}
-- 
1.7.5.4

