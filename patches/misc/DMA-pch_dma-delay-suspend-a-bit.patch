From 245ae69730d5a56b9f78e0d6fbe328bb1bda4c13 Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Thu, 8 Mar 2012 15:18:53 +0800
Subject: [PATCH] DMA: pch_dma: delay suspend a bit

Since the dependence between pch_dma and its client, pch_dma
has to suspend after its client finish suspending. Otherwise
resume will fail. A typical scenario is like below (the client
is uart):
1) Keep uart open when suspending (cat /dev/ttyS1 &)
2) rtcwake -m mem -s 30
   Then you can get below error message:
   serial 0000:02:0a.2: suspend
   pch_dma: pch_free_dma -> Device is in suspend mode.
   pch_dma: pch_free_dma returns -11.
   pch_dma: pch_free_dma -> Device is in suspend mode.
   pch_dma: pch_free_dma returns -11.

3) And when resume, the task created in step-1 will be
   terminated. With below error message:
   serial 0000:02:0a.2: resume
   pch_dma: dma_request_ch ->  Not able to allocate channel.
   pch_dma: dma_request_ch returns -16.
   pch_dma: pch_request_dma -> Function dma_request_ch returned -16.
   pch_dma: pch_request_dma returns -16.
   serial8250_startup -> DMA channelallocation for reception failed.

Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 drivers/dma/pch_dma.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/dma/pch_dma.c b/drivers/dma/pch_dma.c
index 7781bde..e4d549a 100644
--- a/drivers/dma/pch_dma.c
+++ b/drivers/dma/pch_dma.c
@@ -2406,7 +2406,7 @@ static struct pci_driver pch_dma_controller_driver = {
 	.id_table = pch_dma_pcidev_id,
 	.probe = pch_dma_probe,
 	.remove = __devexit_p(pch_dma_remove),
-	.suspend = pch_dma_suspend,
+	.suspend_late = pch_dma_suspend,
 	.resume = pch_dma_resume
 };
 MODULE_DEVICE_TABLE(pci, pch_dma_pcidev_id);
-- 
1.7.0.4

