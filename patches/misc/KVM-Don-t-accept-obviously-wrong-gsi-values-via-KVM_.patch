From 7e705721707826aa60c9b3c2fba400d608203a4e Mon Sep 17 00:00:00 2001
From: Catalin Enache <catalin.enache@windriver.com>
Date: Wed, 27 Sep 2017 11:31:19 +0300
Subject: [PATCH] KVM: Don't accept obviously wrong gsi values via KVM_IRQFD
 MIME-Version: 1.0 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

commit 36ae3c0a36b7456432fedce38ae2f7bd3e01a563 upstream

We cannot add routes for gsi values >= KVM_MAX_IRQ_ROUTES -- see
kvm_set_irq_routing(). Hence, there is no sense in accepting them
via KVM_IRQFD. Prevent them from entering the system in the first
place.

Signed-off-by: Jan H. Sch√∂nherr <jschoenh@amazon.de>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[ce: adjusted context for kernel v3.4]
Signed-off-by: Catalin Enache <catalin.enache@windriver.com>
---
 virt/kvm/eventfd.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/virt/kvm/eventfd.c b/virt/kvm/eventfd.c
index 7d7e2aa..b1e11ba 100644
--- a/virt/kvm/eventfd.c
+++ b/virt/kvm/eventfd.c
@@ -343,6 +343,9 @@ kvm_irqfd(struct kvm *kvm, struct kvm_irqfd *args)
 	if (args->flags & ~KVM_IRQFD_FLAG_DEASSIGN)
 		return -EINVAL;
 
+	if (args->gsi >= KVM_MAX_IRQ_ROUTES)
+		return -EINVAL;
+
 	if (args->flags & KVM_IRQFD_FLAG_DEASSIGN)
 		return kvm_irqfd_deassign(kvm, args);
 
-- 
1.7.5.4

