From 06020bfa103fb87a6dbe378908cc96d94079fd61 Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Thu, 10 Apr 2014 13:16:56 +0800
Subject: [PATCH 036/628] arm: zynq: slcr: add slcr driver to support
 reconfiguration

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7

7f84e2a arm: zynq: slcr: Remove 'X' prefix from #defines
87b3c58 arm: zynq: Coding style cleanup slcr.c
d75ee0b Xilinx: ARM: BSP: make slcr functions more visible to drivers
c668969 Xilinx: ARM: Clean-up and removed locking/unlocking of SLCR during reconfig.
41dae7d Xilinx: ARM: Devcfg and SLCR drivers updated to support reconfiguration.

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 arch/arm/mach-zynq/slcr.c |   33 +++++++++++++++++++++++++++++++++
 1 files changed, 33 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-zynq/slcr.c b/arch/arm/mach-zynq/slcr.c
index 238025b..2445b27 100644
--- a/arch/arm/mach-zynq/slcr.c
+++ b/arch/arm/mach-zynq/slcr.c
@@ -22,8 +22,10 @@
 /* register offsets */
 #define SLCR_UNLOCK_OFFSET		0x8   /* SCLR unlock register */
 #define SLCR_PS_RST_CTRL_OFFSET		0x200 /* PS Software Reset Control */
+#define SLCR_FPGA_RST_CTRL_OFFSET	0x240 /* FPGA Software Reset Control */
 #define SLCR_A9_CPU_RST_CTRL_OFFSET	0x244 /* CPU Software Reset Control */
 #define SLCR_REBOOT_STATUS_OFFSET	0x258 /* PS Reboot Status */
+#define SLCR_LVL_SHFTR_EN_OFFSET	0x900 /* Level Shifters Enable */
 
 #define SLCR_UNLOCK_MAGIC		0xDF0D
 #define SLCR_A9_CPU_CLKSTOP		0x10
@@ -81,6 +83,37 @@ u32 xslcr_read(u32 offset)
 EXPORT_SYMBOL(xslcr_read);
 
 /**
+ * xslcr_init_preload_fpga - Disable communication from the PL to PS.
+ */
+void xslcr_init_preload_fpga(void)
+{
+
+	/* Assert FPGA top level output resets */
+	xslcr_write(0xF, SLCR_FPGA_RST_CTRL_OFFSET);
+
+	/* Disable level shifters */
+	xslcr_write(0, SLCR_LVL_SHFTR_EN_OFFSET);
+
+	/* Enable output level shifters */
+	xslcr_write(0xA, SLCR_LVL_SHFTR_EN_OFFSET);
+}
+EXPORT_SYMBOL(xslcr_init_preload_fpga);
+
+/**
+ * xslcr_init_postload_fpga - Re-enable communication from the PL to PS.
+ */
+void xslcr_init_postload_fpga(void)
+{
+
+	/* Enable level shifters */
+	xslcr_write(0xf, SLCR_LVL_SHFTR_EN_OFFSET);
+
+	/* Deassert AXI interface resets */
+	xslcr_write(0, SLCR_FPGA_RST_CTRL_OFFSET);
+}
+EXPORT_SYMBOL(xslcr_init_postload_fpga);
+
+/**
  * zynq_slcr_cpu_start - Start cpu
  * @cpu:	cpu number
  */
-- 
1.7.5.4

