From aaa876d9c82d7509f9af0fba6be900a90038b68d Mon Sep 17 00:00:00 2001
From: Haiqing Bai <Haiqing.Bai@windriver.com>
Date: Fri, 30 Dec 2016 11:33:54 +0800
Subject: [PATCH] Don't feed anything but regular iovec's to
 blk_rq_map_user_iov

commit a0ac402cfcdc904f9772e1762b3fda112dcc56a0 upstream

In theory we could map other things, but there's a reason that function
is called "user_iov".  Using anything else (like splice can do) just
confuses it.

Reported-and-tested-by: Johannes Thumshirn <jthumshirn@suse.de>
Cc: Al Viro <viro@ZenIV.linux.org.uk>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

[Different base, so slight adjust some codes to align.]
Signed-off-by: Haiqing Bai <Haiqing.Bai@windriver.com>
---
 block/blk-map.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/block/blk-map.c b/block/blk-map.c
index da310a1..4fedd6e 100644
--- a/block/blk-map.c
+++ b/block/blk-map.c
@@ -69,6 +69,9 @@ int blk_rq_map_user_iov(struct request_queue *q, struct request *rq,
 	struct iov_iter i;
 	struct iovec iov;
 
+	if (!iter_is_iovec(iter))
+		goto fail;
+
 	if (!iter || !iter->count)
 		return -EINVAL;
 
@@ -105,6 +108,8 @@ int blk_rq_map_user_iov(struct request_queue *q, struct request *rq,
 		bio_get(bio);
 		bio_endio(bio, 0);
 		__blk_rq_unmap_user(bio);
+fail:
+		rq->bio = NULL;
 		return -EINVAL;
 	}
 
-- 
1.7.5.4

