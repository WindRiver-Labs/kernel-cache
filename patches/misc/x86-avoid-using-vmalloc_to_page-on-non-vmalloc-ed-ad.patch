From 42befa4cacb31b5970d412fabd9a9275ff039c4b Mon Sep 17 00:00:00 2001
From: Mark Asselstine <mark.asselstine@windriver.com>
Date: Fri, 20 Aug 2010 08:43:48 -0700
Subject: [PATCH] x86: avoid using vmalloc_to_page on non-vmalloc'ed addresses

It is possible that addresses passed to text_poke() fall beyond
_etext but are also not vmalloc'ed and thus should be using
virt_to_page() and not vmalloc_to_page(). Using virt_addr_valid()
rather then core_kernel_text() extends the use of virt_to_page()
to these additional addresses.

Signed-off-by: Mark Asselstine <mark.asselstine@windriver.com>
---
 arch/x86/kernel/alternative.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/arch/x86/kernel/alternative.c b/arch/x86/kernel/alternative.c
index c7772b7..e826179 100644
--- a/arch/x86/kernel/alternative.c
+++ b/arch/x86/kernel/alternative.c
@@ -539,7 +539,7 @@ void *__kprobes text_poke(void *addr, const void *opcode, size_t len)
 	struct page *pages[2];
 	int i;
 
-	if (!core_kernel_text((unsigned long)addr)) {
+	if (!virt_addr_valid(addr)) {
 		pages[0] = vmalloc_to_page(addr);
 		pages[1] = vmalloc_to_page(addr + PAGE_SIZE);
 	} else {
-- 
1.6.5.2

