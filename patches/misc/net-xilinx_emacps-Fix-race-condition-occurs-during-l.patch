From cf46ad150cefed939e12598ba6299761193a7dc2 Mon Sep 17 00:00:00 2001
From: Punnaiah Choudary Kalluri <punnaiah.choudary.kalluri@xilinx.com>
Date: Thu, 24 Oct 2013 13:04:53 +0530
Subject: [PATCH 418/628] net: xilinx_emacps: Fix race condition occurs during
 link up/down

git://github.com/Xilinx/linux-xlnx.git xilinx-v2013.4
commit 49028589bcd9c7d2657b3b6fec82d216a9c9f5c6

Enable the NAPI before enabling the interrupts and Rx engine.

Signed-off-by: Punnaiah Choudary Kalluri <punnaia@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/net/ethernet/xilinx/xilinx_emacps.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/xilinx/xilinx_emacps.c b/drivers/net/ethernet/xilinx/xilinx_emacps.c
index 325e5ea..9a3ce54 100644
--- a/drivers/net/ethernet/xilinx/xilinx_emacps.c
+++ b/drivers/net/ethernet/xilinx/xilinx_emacps.c
@@ -1830,6 +1830,7 @@ static int xemacps_open(struct net_device *ndev)
 		goto err_free_rings;
 	}
 
+	napi_enable(&lp->napi);
 	xemacps_init_hw(lp);
 	rc = xemacps_mii_probe(ndev);
 	if (rc != 0) {
@@ -1849,7 +1850,6 @@ static int xemacps_open(struct net_device *ndev)
 	mod_timer(&(lp->gen_purpose_timer),
 		jiffies + msecs_to_jiffies(XEAMCPS_GEN_PURPOSE_TIMER_LOAD));
 
-	napi_enable(&lp->napi);
 	netif_carrier_on(ndev);
 	netif_start_queue(ndev);
 	tasklet_enable(&lp->tx_bdreclaim_tasklet);
-- 
1.7.5.4

