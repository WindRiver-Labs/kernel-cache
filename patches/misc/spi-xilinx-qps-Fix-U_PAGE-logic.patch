From caaf10e0dfd3df2979b811079fc5af21c4a0ab17 Mon Sep 17 00:00:00 2001
From: Peter Crosthwaite <peter.crosthwaite@xilinx.com>
Date: Tue, 23 Jul 2013 18:54:59 +1000
Subject: [PATCH 271/628] spi/xilinx-qps: Fix U_PAGE logic

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit b4aae94f430a487606ecaaaa035098cd4c794a2d

A bracing error was such that the LQSPI config regsiter containing
the U_PAGE bit was only updating on transition out of U_PAGE mode and
not into U_PAGE mode. It needs to work both ways. Fix.

Signed-off-by: Peter Crosthwaite <peter.crosthwaite@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/spi/spi-xilinx-qps.c |    7 +++----
 1 files changed, 3 insertions(+), 4 deletions(-)

diff --git a/drivers/spi/spi-xilinx-qps.c b/drivers/spi/spi-xilinx-qps.c
index f48f141..513e2e1 100644
--- a/drivers/spi/spi-xilinx-qps.c
+++ b/drivers/spi/spi-xilinx-qps.c
@@ -720,11 +720,10 @@ static void xqspips_work_queue(struct work_struct *work)
 					XQSPIPS_LINEAR_CFG_OFFSET);
 		if (qspi->master->flags & SPI_MASTER_U_PAGE)
 			lqspi_cfg_reg |= XQSPIPS_LCFG_U_PAGE_MASK;
-		else {
+		else
 			lqspi_cfg_reg &= ~XQSPIPS_LCFG_U_PAGE_MASK;
-			xqspips_write(xqspi->regs + XQSPIPS_LINEAR_CFG_OFFSET,
-					lqspi_cfg_reg);
-		}
+		xqspips_write(xqspi->regs + XQSPIPS_LINEAR_CFG_OFFSET,
+			      lqspi_cfg_reg);
 #endif
 
 		list_for_each_entry(transfer, &msg->transfers, transfer_list) {
-- 
1.7.5.4

