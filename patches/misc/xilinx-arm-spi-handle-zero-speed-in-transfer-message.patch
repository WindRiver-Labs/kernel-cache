From 0018ace1e19afddddd458e48b9d4679f08387925 Mon Sep 17 00:00:00 2001
From: Suneel Garapati <suneel.garapati@xilinx.com>
Date: Wed, 24 Apr 2013 15:03:10 +0530
Subject: [PATCH 240/628] xilinx: arm: spi: handle zero speed in transfer
 message

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit 3af42ee4c222799972cf791dbff988781048fcd3

If the transfer speed is 0 in spi message, default the
transfer speed to maximum supported flash frequency.

Signed-off-by: Suneel Garapati <suneelg@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/spi/spi-xilinx-qps.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/spi/spi-xilinx-qps.c b/drivers/spi/spi-xilinx-qps.c
index c433cee..8883524 100644
--- a/drivers/spi/spi-xilinx-qps.c
+++ b/drivers/spi/spi-xilinx-qps.c
@@ -428,6 +428,10 @@ static int xqspips_setup_transfer(struct spi_device *qspi,
 		return -EINVAL;
 	}
 
+	if (transfer && (transfer->speed_hz == 0)) {
+		req_hz = qspi->max_speed_hz;
+	}
+
 	/* Set the clock frequency */
 	if (xqspi->speed_hz != req_hz) {
 		while ((baud_rate_val < 8)  &&
-- 
1.7.5.4

