From f6153015ea07af9afd7c46e197fdb1144eaf9386 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Thu, 13 Mar 2014 15:17:41 +0800
Subject: [PATCH] arm:enable irq in do_signal()

Enable irq in do_signal() to prevent following calltrace when enable
CONFIG_DEBUG_ATOMIC_SLEEP option in kernel:

BUG: sleeping function called from invalid context at
linux/include/linux/freezer.h:46
in_atomic(): 0, irqs_disabled(): 128, pid: 1810, name: syslogd
INFO: lockdep is turned off.
[<c0017d48>] (unwind_backtrace+0x0/0x104) from [<c06ac17c>] (dump_stack+0x20/0x24)
[<c06ac17c>] (dump_stack+0x20/0x24) from [<c00a6390>] (__might_sleep+0x130/0x134)
[<c00a6390>] (__might_sleep+0x130/0x134) from [<c001221c>] (do_signal+0x80/0x4f8)
[<c001221c>] (do_signal+0x80/0x4f8) from [<c0012bc8>] (do_notify_resume+0x64/0x70)
[<c0012bc8>] (do_notify_resume+0x64/0x70) from [<c000e858>] (work_pending+0x24/0x28)

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/arm/kernel/signal.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/arch/arm/kernel/signal.c b/arch/arm/kernel/signal.c
index b2abc46..52065a9 100644
--- a/arch/arm/kernel/signal.c
+++ b/arch/arm/kernel/signal.c
@@ -617,6 +617,8 @@ static void do_signal(struct pt_regs *regs, int syscall)
 	if (!user_mode(regs))
 		return;
 
+	local_irq_enable();
+
 	/*
 	 * If we were from a system call, check for system call restarting...
 	 */
-- 
1.7.5.4

