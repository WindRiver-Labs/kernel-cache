From 80382edd908994753d634e4e71b2cfb0737f0700 Mon Sep 17 00:00:00 2001
From: Michal Simek <michal.simek@xilinx.com>
Date: Mon, 17 Jun 2013 13:43:33 +0200
Subject: [PATCH 112/628] xilinx: Use platform_{get,set}_drvdata()

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit 3bd0d0850bf5f96cda184200997264d31a51dfd8

Based on mainline commit:
"serial: use platform_{get,set}_drvdata()"
(sha1: 696faedd616e202f5c510cd03dcc8853c11ca6db)

Signed-off-by: Michal Simek <michal.simek@xilinx.com>
[cherry picked the xilinx dma driver modification only]
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/dma/xilinx/xilinx_axicdma.c |    5 ++---
 drivers/dma/xilinx/xilinx_axidma.c  |    5 ++---
 drivers/dma/xilinx/xilinx_axivdma.c |    5 ++---
 3 files changed, 6 insertions(+), 9 deletions(-)

diff --git a/drivers/dma/xilinx/xilinx_axicdma.c b/drivers/dma/xilinx/xilinx_axicdma.c
index 3b89249..4d9c224 100644
--- a/drivers/dma/xilinx/xilinx_axicdma.c
+++ b/drivers/dma/xilinx/xilinx_axicdma.c
@@ -1028,7 +1028,7 @@ static int xilinx_cdma_of_probe(struct platform_device *op)
 	xdev->common.device_tx_status = xilinx_tx_status;
 	xdev->common.dev = &op->dev;
 
-	dev_set_drvdata(&op->dev, xdev);
+	platform_set_drvdata(op, xdev);
 
 	for_each_child_of_node(node, child) {
 		xilinx_cdma_chan_probe(xdev, child, xdev->feature);
@@ -1050,7 +1050,7 @@ static int xilinx_cdma_of_remove(struct platform_device *op)
 	struct xilinx_cdma_device *xdev;
 	int i;
 
-	xdev = dev_get_drvdata(&op->dev);
+	xdev = platform_get_drvdata(op);
 	dma_async_device_unregister(&xdev->common);
 
 	for (i = 0; i < XILINX_CDMA_MAX_CHANS_PER_DEVICE; i++) {
@@ -1059,7 +1059,6 @@ static int xilinx_cdma_of_remove(struct platform_device *op)
 	}
 
 	iounmap(xdev->regs);
-	dev_set_drvdata(&op->dev, NULL);
 	kfree(xdev);
 
 	return 0;
diff --git a/drivers/dma/xilinx/xilinx_axidma.c b/drivers/dma/xilinx/xilinx_axidma.c
index 6dca5ea..f779759 100644
--- a/drivers/dma/xilinx/xilinx_axidma.c
+++ b/drivers/dma/xilinx/xilinx_axidma.c
@@ -1132,7 +1132,7 @@ static int xilinx_dma_of_probe(struct platform_device *op)
 	xdev->common.device_tx_status = xilinx_tx_status;
 	xdev->common.dev = &op->dev;
 
-	dev_set_drvdata(&op->dev, xdev);
+	platform_set_drvdata(op, xdev);
 
 	for_each_child_of_node(node, child) {
 		xilinx_dma_chan_probe(xdev, child, xdev->feature);
@@ -1154,7 +1154,7 @@ static int xilinx_dma_of_remove(struct platform_device *op)
 	struct xilinx_dma_device *xdev;
 	int i;
 
-	xdev = dev_get_drvdata(&op->dev);
+	xdev = platform_get_drvdata(op);
 	dma_async_device_unregister(&xdev->common);
 
 	for (i = 0; i < XILINX_DMA_MAX_CHANS_PER_DEVICE; i++) {
@@ -1163,7 +1163,6 @@ static int xilinx_dma_of_remove(struct platform_device *op)
 	}
 
 	iounmap(xdev->regs);
-	dev_set_drvdata(&op->dev, NULL);
 	kfree(xdev);
 
 	return 0;
diff --git a/drivers/dma/xilinx/xilinx_axivdma.c b/drivers/dma/xilinx/xilinx_axivdma.c
index ef74643..400a5b4 100644
--- a/drivers/dma/xilinx/xilinx_axivdma.c
+++ b/drivers/dma/xilinx/xilinx_axivdma.c
@@ -1251,7 +1251,7 @@ static int xilinx_vdma_of_probe(struct platform_device *op)
 	xdev->common.device_tx_status = xilinx_tx_status;
 	xdev->common.dev = &op->dev;
 
-	dev_set_drvdata(&op->dev, xdev);
+	platform_set_drvdata(op, xdev);
 
 	for_each_child_of_node(node, child) {
 		xilinx_vdma_chan_probe(xdev, child, xdev->feature);
@@ -1278,7 +1278,7 @@ static int xilinx_vdma_of_remove(struct platform_device *op)
 	struct xilinx_vdma_device *xdev;
 	int i;
 
-	xdev = dev_get_drvdata(&op->dev);
+	xdev = platform_get_drvdata(op);
 	dma_async_device_unregister(&xdev->common);
 
 	for (i = 0; i < XILINX_VDMA_MAX_CHANS_PER_DEVICE; i++) {
@@ -1287,7 +1287,6 @@ static int xilinx_vdma_of_remove(struct platform_device *op)
 	}
 
 	iounmap(xdev->regs);
-	dev_set_drvdata(&op->dev, NULL);
 	kfree(xdev);
 
 	return 0;
-- 
1.7.5.4

