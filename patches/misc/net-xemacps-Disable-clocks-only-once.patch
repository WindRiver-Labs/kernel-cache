From 69f27d5f1ff0f7ea291f54d79569ad28ade4df48 Mon Sep 17 00:00:00 2001
From: Soren Brinkmann <soren.brinkmann@xilinx.com>
Date: Wed, 29 May 2013 11:20:47 -0700
Subject: [PATCH 403/628] net: xemacps: Disable clocks only once

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit c2e3db41e2259f40773ed23d03018e2c2b5066ab

When the driver is removed clocks may be disabled due to runtime PM. If
this happens, remove() must not disable the clocks again. Therefore,
check the runtime PM status in remove() and take the appropriate action.

Signed-off-by: Soren Brinkmann <soren.brinkmann@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/net/ethernet/xilinx/xilinx_emacps.c |    9 +++++++--
 1 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/xilinx/xilinx_emacps.c b/drivers/net/ethernet/xilinx/xilinx_emacps.c
index 9a5c863..030ad5e 100644
--- a/drivers/net/ethernet/xilinx/xilinx_emacps.c
+++ b/drivers/net/ethernet/xilinx/xilinx_emacps.c
@@ -2789,9 +2789,14 @@ static int __exit xemacps_remove(struct platform_device *pdev)
 		platform_set_drvdata(pdev, NULL);
 
 		clk_notifier_unregister(lp->devclk, &lp->clk_rate_change_nb);
-		clk_disable_unprepare(lp->devclk);
+		if (!pm_runtime_suspended(&pdev->dev)) {
+			clk_disable_unprepare(lp->devclk);
+			clk_disable_unprepare(lp->aperclk);
+		} else {
+			clk_unprepare(lp->devclk);
+			clk_unprepare(lp->aperclk);
+		}
 		clk_put(lp->devclk);
-		clk_disable_unprepare(lp->aperclk);
 		clk_put(lp->aperclk);
 	}
 
-- 
1.7.5.4

