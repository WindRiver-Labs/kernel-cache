From b34f5d06b3f029c925c7de440e1934057d5a92f9 Mon Sep 17 00:00:00 2001
From: "yadi.hu@windriver.com" <yadi.hu@windriver.com>
Date: Thu, 21 Aug 2014 10:21:40 +0800
Subject: [PATCH] PPC: Fix IBM Erratum #47

See https://lists.ozlabs.org/pipermail/linuxppc-dev/2014-August/119892.html

This patch disables the branch target address CAM which under specific
circumstances may cause the processor to skip execution of 1-4
instructions. This fixes IBM Erratum #47.

Signed-off-by: Alistair Popple <alistair at popple.id.au>
Signed-off-by: Hu <yadi.hu@windriver.com>
---
 arch/powerpc/kernel/head_44x.S |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/kernel/head_44x.S b/arch/powerpc/kernel/head_44x.S
index d1192c5..13852fc 100644
--- a/arch/powerpc/kernel/head_44x.S
+++ b/arch/powerpc/kernel/head_44x.S
@@ -1226,10 +1226,12 @@ clear_utlb_entry:
 
 	/* We configure icbi to invalidate 128 bytes at a time since the
 	 * current 32-bit kernel code isn't too happy with icache != dcache
-	 * block size
-	 */
+	 * block size. We also disable the BTAC as this can cause errors
+	 * in some circumstances (see IBM Erratum 47).
+	*/
 	mfspr	r3,SPRN_CCR0
 	oris	r3,r3,0x0020
+	ori 	r3,r3,0x0040
 	mtspr	SPRN_CCR0,r3
 	isync
 
-- 
1.7.5.4

