From 502f7c36e32bc13a4e36138b5150e9344f9a29ef Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Mon, 26 Nov 2012 16:52:23 +0800
Subject: [PATCH] bman: drain bpool for only one time

Move bman_drain_bpool() to bman_init() and call it for only one
time; otherwise, in multi-node system, next call unexpectedly
acquired previous bpool usage for kexeced kernel.

Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 drivers/staging/fsl_qbman/bman_driver.c |    9 +++++----
 1 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/drivers/staging/fsl_qbman/bman_driver.c b/drivers/staging/fsl_qbman/bman_driver.c
index 8af3f6a..3384736 100644
--- a/drivers/staging/fsl_qbman/bman_driver.c
+++ b/drivers/staging/fsl_qbman/bman_driver.c
@@ -377,10 +377,6 @@ static int __init fsl_bpool_init(struct device_node *node)
 		return -ENODEV;
 	}
 
-#ifdef CONFIG_KEXEC_POWERPC_SMP_BOOTABLE
-	bman_drain_bpool();
-#endif
-
 	if (cfg)
 		ret = __bm_pool_add(*bpid, cfg, ret / 24);
 	else
@@ -578,6 +574,11 @@ static __init int bman_init(void)
 		if (ret)
 			return ret;
 	}
+
+#ifdef CONFIG_KEXEC_POWERPC_SMP_BOOTABLE
+	bman_drain_bpool();
+#endif
+
 	for_each_compatible_node(dn, NULL, "fsl,bpool") {
 		ret = fsl_bpool_init(dn);
 		if (ret)
-- 
1.7.0

