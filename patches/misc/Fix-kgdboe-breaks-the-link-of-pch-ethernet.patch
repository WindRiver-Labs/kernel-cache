From 8e0577a1c583947437f551388f31bb5ae35ecfea Mon Sep 17 00:00:00 2001
From: Jiang Bin <bin.jiang@windriver.com>
Date: Wed, 25 May 2011 11:37:32 +0800
Subject: [PATCH] Fix: kgdboe breaks the link of pch ethernet

Net poll may break the original principle of irq_sem thus mis-disable
the NIC's interrupt. Add a judgment to avoid it.

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
Integrated-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/net/pch_gbe/pch_gbe_main.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/net/pch_gbe/pch_gbe_main.c b/drivers/net/pch_gbe/pch_gbe_main.c
index 4369db1..31ad114 100644
--- a/drivers/net/pch_gbe/pch_gbe_main.c
+++ b/drivers/net/pch_gbe/pch_gbe_main.c
@@ -1115,6 +1115,11 @@ static int pch_gbe_napi_poll(struct napi_struct *napi, int budget)
  if (poll_end_flag == 1) {
   napi_complete(napi);
   pch_gbe_irq_enable(adapter);
+#ifdef CONFIG_NET_POLL_CONTROLLER
+  /* Net poll may break the original principle of irq_sem. */
+  if (atomic_read(&adapter->irq_sem) < 0)
+    atomic_set(&adapter->irq_sem, 0);
+#endif /* CONFIG_NET_POLL_CONTROLLER */
  }
 
  PCH_DEBUG("poll_end_flag : %d  work_done : %d  budget : %d\n",
-- 
1.7.0.4

