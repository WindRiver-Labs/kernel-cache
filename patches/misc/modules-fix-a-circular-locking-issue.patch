From 65c959890e2a4c2eba4752c6568bd7b5b90bf24a Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Tue, 18 Nov 2014 10:47:13 +0800
Subject: [PATCH] modules: fix a circular locking issue

Function blocking_notifier_call_chain doesn't require the
protection of module_mutex. Move it out of the lock/unlock
pair to avoid circular locking.

Two keys here:
module_notify_list.rwsem and module_mutex.

The module_notify_list.rwsem is used to protect the whole
notifier_call_chain. While function module_notify is the notify
handler of kernel module. In this very function, the module
list maybe accessed thus module_mutex was used here. So the order
of them is module_notify_list.rwsem -> module_mutex. We should
never require module_notify_list.rwsem when holding module_mutex.

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 kernel/module.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/kernel/module.c b/kernel/module.c
index ddc1229..df34453 100644
--- a/kernel/module.c
+++ b/kernel/module.c
@@ -718,9 +718,9 @@ static void module_unload_free(struct module *mod)
 		list_del(&use->target_list);
 		kfree(use);
 	}
+	mutex_unlock(&module_mutex);
 	blocking_notifier_call_chain(&module_notify_list,
 				     MODULE_STATE_GONE, mod);
-	mutex_unlock(&module_mutex);
 
 	free_percpu(mod->refptr);
 }
-- 
1.7.5.4

