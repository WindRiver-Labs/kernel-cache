From d7970a2a2221bc5060b450fa12361e67133f70b6 Mon Sep 17 00:00:00 2001
From: "J. R. Okajima" <hooanon05g@gmail.com>
Date: Tue, 16 Feb 2016 15:22:52 +0900
Subject: [PATCH 1/3] aufs: tiny, extract a part of copy-up dir

commit 7493a6346066bb9f7c55143b6a98e49f51324f22 from
https://github.com/sfjro/aufs4-standalone.git aufs4.0

No changes in the behaviour.

Signed-off-by: J. R. Okajima <hooanon05g@gmail.com>
(cherry picked from commit c60d34fa07cddcd50c03d4bfcd75d115a5cee6cd)
Signed-off-by: Qi Hou <qi.hou@windriver.com>
---
 fs/aufs/cpup.c |   27 ++++++++++++++++-----------
 1 files changed, 16 insertions(+), 11 deletions(-)

diff --git a/fs/aufs/cpup.c b/fs/aufs/cpup.c
index 3ea177a..29c0f13 100644
--- a/fs/aufs/cpup.c
+++ b/fs/aufs/cpup.c
@@ -509,6 +509,20 @@ out:
 	return err;
 }
 
+static void au_do_cpup_dir(struct au_cp_generic *cpg, struct dentry *dst_parent)
+{
+	struct inode *dir;
+
+	/*
+	 * strange behaviour from the users view,
+	 * particularry setattr case
+	 */
+	dir = dst_parent->d_inode;
+	if (au_ibstart(dir) == cpg->bdst)
+		au_cpup_attr_nlink(dir, /*force*/1);
+	au_cpup_attr_nlink(cpg->dentry->d_inode, /*force*/1);
+}
+
 static noinline_for_stack
 int cpup_entry(struct au_cp_generic *cpg, struct dentry *dst_parent,
 	       struct au_cpup_reg_attr *h_src_attr)
@@ -561,17 +575,8 @@ int cpup_entry(struct au_cp_generic *cpg, struct dentry *dst_parent,
 	case S_IFDIR:
 		isdir = 1;
 		err = vfsub_mkdir(h_dir, &h_path, mode);
-		if (!err) {
-			/*
-			 * strange behaviour from the users view,
-			 * particularry setattr case
-			 */
-			dir = d_inode(dst_parent);
-			if (au_ibstart(dir) == cpg->bdst)
-				au_cpup_attr_nlink(dir, /*force*/1);
-			inode = d_inode(cpg->dentry);
-			au_cpup_attr_nlink(inode, /*force*/1);
-		}
+		if (!err)
+			au_do_cpup_dir(cpg, dst_parent);
 		break;
 	case S_IFLNK:
 		err = au_do_cpup_symlink(&h_path, h_src, h_dir);
-- 
1.7.5.4

