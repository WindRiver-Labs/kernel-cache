From 8f6f7c950c658b09c7c3e2277569790a2eb57061 Mon Sep 17 00:00:00 2001
From: Qi Hou <qi.hou@windriver.com>
Date: Thu, 30 Jun 2016 16:01:04 +0800
Subject: [PATCH] aufs: refer to "owner" field of mutex through rt_mutex,in
 preempt-rt kernel

In preempt-rt kernel,mutex in mutex_rt.h acts as a proxy who maps general
mutex into rt_mutex,and the existence of "owner" field of rt_mutex doesn't
depend on CONFIG_DEBUG_MUTEXES or CONFIG_SMP at all.

So,in preempt-rt kernel,when the "owner" filed of mutex is referred to,it
will be referred to through rt_mutex.

Signed-off-by: Qi Hou <qi.hou@windriver.com>
---
 fs/aufs/i_op.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/fs/aufs/i_op.c b/fs/aufs/i_op.c
index 036a54a..fd65920 100644
--- a/fs/aufs/i_op.c
+++ b/fs/aufs/i_op.c
@@ -433,9 +433,13 @@ out:
 
 void au_pin_hdir_set_owner(struct au_pin *p, struct task_struct *task)
 {
+#ifndef CONFIG_PREEMPT_RT_FULL
 #if defined(CONFIG_DEBUG_MUTEXES) || defined(CONFIG_SMP)
 	p->hdir->hi_inode->i_mutex.owner = task;
 #endif
+#else
+	p->hdir->hi_inode->i_mutex.lock.owner = task;
+#endif
 }
 
 void au_pin_hdir_acquire_nest(struct au_pin *p)
-- 
1.7.5.4

