From ccfee129146ce2fa6246f7f7c03100c20b949842 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Wed, 14 Jan 2015 11:31:18 -0800
Subject: [PATCH] Samples: Clean up so modules and hostprogs build correctly

Add the samples directory to the core so that modules will
build.

Only build hostprogs if not cross compiling.  Otherwise the
resulting executables would be pretty much useless.

Signed-off-by: Jim Somerville <Jim.Somerville@windriver.com>
[Uprev to apply to 3.14]
Signed-off-by: He Zhe <zhe.he@windriver.com>
[Adjust context for grsec change]
Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 Makefile                 | 5 +----
 samples/hidraw/Makefile  | 2 ++
 samples/seccomp/Makefile | 2 ++
 3 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/Makefile b/Makefile
index 7be1086..97dc0c5 100644
--- a/Makefile
+++ b/Makefile
@@ -855,7 +855,7 @@ export mod_sign_cmd
 
 
 ifeq ($(KBUILD_EXTMOD),)
-core-y		+= kernel/ mm/ fs/ ipc/ security/ crypto/ block/ grsecurity/
+core-y		+= kernel/ mm/ fs/ ipc/ security/ crypto/ block/ grsecurity/ samples/
 
 vmlinux-dirs	:= $(patsubst %/,%,$(filter %/, $(init-y) $(init-m) \
 		     $(core-y) $(core-m) $(drivers-y) $(drivers-m) \
@@ -894,9 +894,6 @@ vmlinux: scripts/link-vmlinux.sh $(vmlinux-deps) FORCE
 ifdef CONFIG_HEADERS_CHECK
 	$(Q)$(MAKE) -f $(srctree)/Makefile headers_check
 endif
-ifdef CONFIG_SAMPLES
-	$(Q)$(MAKE) $(build)=samples
-endif
 ifdef CONFIG_BUILD_DOCSRC
 	$(Q)$(MAKE) $(build)=Documentation
 endif
diff --git a/samples/hidraw/Makefile b/samples/hidraw/Makefile
index 1e6aabc..583afd5 100644
--- a/samples/hidraw/Makefile
+++ b/samples/hidraw/Makefile
@@ -4,7 +4,9 @@ obj- := dummy.o
 # List of programs to build
 hostprogs-y := hid-example
 
+ifeq ($(CROSS_COMPILE),)
 # Tell kbuild to always build the programs
 always := $(hostprogs-y)
+endif
 
 HOSTCFLAGS_hid-example.o += -I$(srctree)/usr/include
diff --git a/samples/seccomp/Makefile b/samples/seccomp/Makefile
index 64648e4..cf810c3 100644
--- a/samples/seccomp/Makefile
+++ b/samples/seccomp/Makefile
@@ -38,5 +38,7 @@ HOSTLOADLIBES_dropper += $(MFLAG)
 endif
 endif
 
+ifeq ($(CROSS_COMPILE),)
 # Tell kbuild to always build the programs
 always := $(hostprogs-y)
+endif
-- 
2.0.2

