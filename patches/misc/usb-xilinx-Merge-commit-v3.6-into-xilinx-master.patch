From 75b5b0858f69d9eb92a326ce14371b221067d193 Mon Sep 17 00:00:00 2001
From: Michal Simek <monstr@monstr.eu>
Date: Fri, 5 Oct 2012 13:50:18 +0200
Subject: [PATCH 475/628] usb: xilinx: Merge commit 'v3.6' into xilinx-master

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit 2d60bedf Merge commit 'v3.6' into xilinx-master

Some fixes have to be done in the usb subsystem.

Signed-off-by: Michal Simek <monstr@monstr.eu>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/usb/host/ehci-xilinx-usbps.c |   18 ++++++++++--------
 1 files changed, 10 insertions(+), 8 deletions(-)

diff --git a/drivers/usb/host/ehci-xilinx-usbps.c b/drivers/usb/host/ehci-xilinx-usbps.c
index 47ae1de..c6cbd3d 100755
--- a/drivers/usb/host/ehci-xilinx-usbps.c
+++ b/drivers/usb/host/ehci-xilinx-usbps.c
@@ -40,8 +40,7 @@ static int ehci_xusbps_reinit(struct ehci_hcd *ehci);
 static int ehci_xusbps_update_device(struct usb_hcd *hcd, struct usb_device
 		*udev)
 {
-	struct ehci_hcd *ehci = hcd_to_ehci(hcd);
-	struct xusbps_otg *xotg = xceiv_to_xotg(ehci->transceiver);
+	struct xusbps_otg *xotg = xceiv_to_xotg(hcd->phy);
 
 	if (udev->portnum == hcd->self.otg_port) {
 		/* HNP test device */
@@ -60,6 +59,7 @@ static int ehci_xusbps_update_device(struct usb_hcd *hcd, struct usb_device
 static void ehci_xusbps_start_hnp(struct ehci_hcd *ehci)
 {
 	const unsigned	port = ehci_to_hcd(ehci)->self.otg_port - 1;
+	struct usb_hcd *hcd = ehci_to_hcd(ehci);
 	unsigned long	flags;
 	u32 portsc;
 
@@ -69,14 +69,14 @@ static void ehci_xusbps_start_hnp(struct ehci_hcd *ehci)
 	ehci_writel(ehci, portsc, &ehci->regs->port_status[port]);
 	local_irq_restore(flags);
 
-	otg_start_hnp(ehci->transceiver->otg);
+	otg_start_hnp(hcd->phy->otg);
 }
 
 static int ehci_xusbps_otg_start_host(struct usb_phy *otg)
 {
 	struct usb_hcd		*hcd = bus_to_hcd(otg->otg->host);
 	struct xusbps_otg *xotg =
-			xceiv_to_xotg(hcd_to_ehci(hcd)->transceiver);
+			xceiv_to_xotg(hcd->phy);
 
 	usb_add_hcd(hcd, xotg->irq, IRQF_SHARED | IRQF_DISABLED);
 	return 0;
@@ -165,12 +165,12 @@ static int usb_hcd_xusbps_probe(const struct hc_driver *driver,
 #ifdef CONFIG_USB_XUSBPS_OTG
 	ehci = hcd_to_ehci(hcd);
 	if (pdata->otg) {
-		ehci->transceiver = pdata->otg;
-		retval = otg_set_host(ehci->transceiver->otg,
+		hcd->phy = pdata->otg;
+		retval = otg_set_host(hcd->phy->otg,
 				&ehci_to_hcd(ehci)->self);
 		if (retval)
 			return retval;
-		xotg = xceiv_to_xotg(ehci->transceiver);
+		xotg = xceiv_to_xotg(hcd->phy);
 		ehci->start_hnp = ehci_xusbps_start_hnp;
 		xotg->start_host = ehci_xusbps_otg_start_host;
 		xotg->stop_host = ehci_xusbps_otg_stop_host;
@@ -276,10 +276,12 @@ static void ehci_xusbps_usb_setup(struct ehci_hcd *ehci)
 /* called after powerup, by probe or system-pm "wakeup" */
 static int ehci_xusbps_reinit(struct ehci_hcd *ehci)
 {
+	struct usb_hcd *hcd = ehci_to_hcd(ehci);
+
 	ehci_xusbps_usb_setup(ehci);
 #ifdef CONFIG_USB_XUSBPS_OTG
 	/* Don't turn off port power in OTG mode */
-	if (!ehci->transceiver)
+	if (!hcd->phy)
 #endif
 		ehci_port_power(ehci, 0);
 
-- 
1.7.5.4

