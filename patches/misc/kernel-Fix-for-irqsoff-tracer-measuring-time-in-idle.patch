From e17b54d489577969f7c2ebef87c5d5e251cdb557 Mon Sep 17 00:00:00 2001
From: Fredrik Markstrom <fredrik.markstrom@gmail.com>
Date: Tue, 3 Mar 2015 14:09:40 +0100
Subject: [PATCH] kernel: Fix for irqsoff tracer measuring time in idle/wfi

rcu_idle_enter() restarts critical timing since it's enabling/disabling
interrupts. So in order for the irqsoff tracer not to measure the time
spent waiting for an interrupt in armv7 idle we disable critical timing
after the call to rcu_idle_enter() instead of before.

Signed-off-by: Fredrik Markstrom <fredrik.markstrom@gmail.com>
Signed-off-by: Li Zhou <li.zhou@windriver.com>
---
 kernel/cpu/idle.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/kernel/cpu/idle.c b/kernel/cpu/idle.c
index 277f494..27c5a72 100644
--- a/kernel/cpu/idle.c
+++ b/kernel/cpu/idle.c
@@ -93,8 +93,8 @@ static void cpu_idle_loop(void)
 				cpu_idle_poll();
 			} else {
 				if (!current_clr_polling_and_test()) {
-					stop_critical_timings();
 					rcu_idle_enter();
+					stop_critical_timings();
 					arch_cpu_idle();
 					WARN_ON_ONCE(irqs_disabled());
 					rcu_idle_exit();
-- 
1.7.5.4

