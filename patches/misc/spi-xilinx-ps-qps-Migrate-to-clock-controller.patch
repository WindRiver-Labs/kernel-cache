From 0d79057bcbaec00be94402117264cebfde2ecbcf Mon Sep 17 00:00:00 2001
From: Soren Brinkmann <soren.brinkmann@xilinx.com>
Date: Tue, 16 Apr 2013 14:38:33 -0700
Subject: [PATCH 268/628] spi: xilinx-ps/qps: Migrate to clock controller

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit 28581ed9 arm: zynq: Migrate to clock controller

cherry picked the xilinx spi driver modification.

Signed-off-by: Soren Brinkmann <soren.brinkmann@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/spi/spi-xilinx-ps.c  |   16 ++++------------
 drivers/spi/spi-xilinx-qps.c |    8 ++++----
 2 files changed, 8 insertions(+), 16 deletions(-)

diff --git a/drivers/spi/spi-xilinx-ps.c b/drivers/spi/spi-xilinx-ps.c
index b3f05c8..f408469 100644
--- a/drivers/spi/spi-xilinx-ps.c
+++ b/drivers/spi/spi-xilinx-ps.c
@@ -687,24 +687,16 @@ static int xspips_probe(struct platform_device *pdev)
 		goto remove_master;
 	}
 
-	if (xspi->irq == 58)
-		xspi->aperclk = clk_get_sys("SPI0_APER", NULL);
-	else
-		xspi->aperclk = clk_get_sys("SPI1_APER", NULL);
-
+	xspi->aperclk = clk_get(&pdev->dev, "aper_clk");
 	if (IS_ERR(xspi->aperclk)) {
-		dev_err(&pdev->dev, "APER clock not found.\n");
+		dev_err(&pdev->dev, "aper_clk clock not found.\n");
 		ret = PTR_ERR(xspi->aperclk);
 		goto remove_master;
 	}
 
-	if (xspi->irq == 58)
-		xspi->devclk = clk_get_sys("SPI0", NULL);
-	else
-		xspi->devclk = clk_get_sys("SPI1", NULL);
-
+	xspi->devclk = clk_get(&pdev->dev, "ref_clk");
 	if (IS_ERR(xspi->devclk)) {
-		dev_err(&pdev->dev, "Device clock not found.\n");
+		dev_err(&pdev->dev, "ref_clk clock not found.\n");
 		ret = PTR_ERR(xspi->devclk);
 		goto clk_put_aper;
 	}
diff --git a/drivers/spi/spi-xilinx-qps.c b/drivers/spi/spi-xilinx-qps.c
index 68cc344..aeb0e7f 100644
--- a/drivers/spi/spi-xilinx-qps.c
+++ b/drivers/spi/spi-xilinx-qps.c
@@ -1050,16 +1050,16 @@ static int xqspips_probe(struct platform_device *pdev)
 		dev_warn(&pdev->dev, "couldn't determine configuration info "
 			 "about dual memories. defaulting to single memory\n");
 
-	xqspi->aperclk = clk_get_sys("LQSPI_APER", NULL);
+	xqspi->aperclk = clk_get(&pdev->dev, "aper_clk");
 	if (IS_ERR(xqspi->aperclk)) {
-		dev_err(&pdev->dev, "APER clock not found.\n");
+		dev_err(&pdev->dev, "aper_clk clock not found.\n");
 		ret = PTR_ERR(xqspi->aperclk);
 		goto remove_master;
 	}
 
-	xqspi->devclk = clk_get_sys("LQSPI", NULL);
+	xqspi->devclk = clk_get(&pdev->dev, "ref_clk");
 	if (IS_ERR(xqspi->devclk)) {
-		dev_err(&pdev->dev, "Device clock not found.\n");
+		dev_err(&pdev->dev, "ref_clk clock not found.\n");
 		ret = PTR_ERR(xqspi->devclk);
 		goto clk_put_aper;
 	}
-- 
1.7.5.4

