From 4cb52c7466679c81781e922873b9277138612219 Mon Sep 17 00:00:00 2001
From: Liu Haitao <haitao.liu@windriver.com>
Date: Tue, 12 Dec 2017 11:14:52 +0800
Subject: [PATCH] key: fix warning of the key which is used uninitialized.

In function keyring_search_aux, the variable 'key' is used uninitialized.

Signed-off-by: Liu Haitao <haitao.liu@windriver.com>
---
 security/keys/keyring.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/security/keys/keyring.c b/security/keys/keyring.c
index 0126202..b73a769 100644
--- a/security/keys/keyring.c
+++ b/security/keys/keyring.c
@@ -334,7 +334,7 @@ key_ref_t keyring_search_aux(key_ref_t keyring_ref,
 	key_ref_t key_ref;
 	long err;
 	int sp, nkeys, kix;
-	int state = ACCESS_ONCE(key->state);
+	int state;
 
 	if (!match) {
 		key_ref = ERR_PTR(-EINVAL);
@@ -366,6 +366,8 @@ key_ref_t keyring_search_aux(key_ref_t keyring_ref,
 	 * are looking for */
 	key_ref = ERR_PTR(-EAGAIN);
 	kflags = keyring->flags;
+	state = ACCESS_ONCE(keyring->state);
+
 	if (keyring->type == type && match(keyring, description)) {
 		key = keyring;
 		if (no_state_check)
@@ -409,6 +411,7 @@ descend:
 	for (kix = 0; kix < nkeys; kix++) {
 		key = rcu_dereference(keylist->keys[kix]);
 		kflags = key->flags;
+		state = ACCESS_ONCE(key->state);
 
 		/* ignore keys not of this type */
 		if (key->type != type)
-- 
1.7.5.4

