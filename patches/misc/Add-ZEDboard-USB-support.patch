From 8af2aba6998fd54f6807626c8388c0200be6d087 Mon Sep 17 00:00:00 2001
From: Michal Simek <monstr@monstr.eu>
Date: Fri, 19 Oct 2012 13:12:50 +0200
Subject: [PATCH 480/628] Add ZEDboard USB support

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit f460f44e8a819de88323460eb3d05303322ceeb2

This is based on digilent usb fix from
https://github.com/Digilent/linux-3.3-digilent/commit/2ce5ab37ba6fc3ced54ee53275619c91cd7aa1be

Signed-off-by: Jason Wu <jason.wu@petalogix.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/usb/host/ehci-xilinx-usbps.c |   25 +++++++++++++++++++++++++
 1 files changed, 25 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/host/ehci-xilinx-usbps.c b/drivers/usb/host/ehci-xilinx-usbps.c
index c6cbd3d..9c96b85 100755
--- a/drivers/usb/host/ehci-xilinx-usbps.c
+++ b/drivers/usb/host/ehci-xilinx-usbps.c
@@ -23,6 +23,9 @@
 #include <linux/platform_device.h>
 #include <linux/xilinx_devices.h>
 #include <linux/usb/otg.h>
+#ifdef CONFIG_XILINX_ZED_USB_OTG
+#include <linux/usb/ulpi.h>
+#endif
 #include <linux/usb/xilinx_usbps_otg.h>
 
 #include "ehci-xilinx-usbps.h"
@@ -165,6 +168,15 @@ static int usb_hcd_xusbps_probe(const struct hc_driver *driver,
 #ifdef CONFIG_USB_XUSBPS_OTG
 	ehci = hcd_to_ehci(hcd);
 	if (pdata->otg) {
+#ifdef CONFIG_XILINX_ZED_USB_OTG
+		pr_info ("usb_hcd_xusbps_probe: Have OTG assigned.\n");
+
+		retval = otg_init(pdata->otg);
+		if (retval) {
+			dev_err(&pdev->dev, "Unable to init transceiver, probably missing\n");
+			return ENODEV;
+		}
+#endif
 		hcd->phy = pdata->otg;
 		retval = otg_set_host(hcd->phy->otg,
 				&ehci_to_hcd(ehci)->self);
@@ -177,6 +189,19 @@ static int usb_hcd_xusbps_probe(const struct hc_driver *driver,
 		/* inform otg driver about host driver */
 		xusbps_update_transceiver();
 	} else {
+#ifdef CONFIG_XILINX_ZED_USB_OTG
+		pr_info ("usb_hcd_xusbps_probe: No OTG assigned!\n");
+		if (!pdata->otg) {
+			pdata->otg = otg_ulpi_create (&ulpi_viewport_access_ops,
+				ULPI_OTG_DRVVBUS | ULPI_OTG_DRVVBUS_EXT);
+			if (pdata->otg) {
+				pdata->otg->io_priv = hcd->regs + XUSBPS_SOC_USB_ULPIVP;
+				ehci->ulpi = pdata->otg;
+			}
+		}
+		pr_info ("usb_hcd_xusbps_probe: OTG now assigned!\n");
+#endif
+
 		retval = usb_add_hcd(hcd, irq, IRQF_DISABLED | IRQF_SHARED);
 		if (retval != 0)
 			goto err2;
-- 
1.7.5.4

