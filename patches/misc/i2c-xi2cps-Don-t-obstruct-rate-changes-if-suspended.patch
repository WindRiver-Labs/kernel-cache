From 21cb03299e85979ba61ba19e171ee778678df8cf Mon Sep 17 00:00:00 2001
From: Soren Brinkmann <soren.brinkmann@xilinx.com>
Date: Thu, 21 Mar 2013 11:22:41 -0700
Subject: [PATCH 313/628] i2c: xi2cps: Don't obstruct rate changes if
 suspended

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit 023b66ff4af4992113a63c824094e19ab337eded

When the driver is suspended its input frequency doesn't matter and
changes to it should not be prevented.

Signed-off-by: Soren Brinkmann <soren.brinkmann@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/i2c/busses/i2c-xilinx_ps.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/drivers/i2c/busses/i2c-xilinx_ps.c b/drivers/i2c/busses/i2c-xilinx_ps.c
index fe9122d..ae5117f 100644
--- a/drivers/i2c/busses/i2c-xilinx_ps.c
+++ b/drivers/i2c/busses/i2c-xilinx_ps.c
@@ -114,6 +114,7 @@
  * @xfer_done:		Transfer complete status
  * @p_send_buf:		Pointer to transmit buffer
  * @p_recv_buf:		Pointer to receive buffer
+ * @suspended:		Flag holding the device's PM status
  * @send_count:		Number of bytes still expected to send
  * @recv_count:		Number of bytes still expected to receive
  * @irq:		IRQ number
@@ -132,6 +133,7 @@ struct xi2cps {
 	struct completion xfer_done;
 	unsigned char *p_send_buf;
 	unsigned char *p_recv_buf;
+	u8 suspended;
 	int send_count;
 	int recv_count;
 	int irq;
@@ -709,6 +711,9 @@ static int xi2cps_clk_notifier_cb(struct notifier_block *nb, unsigned long
 	struct clk_notifier_data *ndata = data;
 	struct xi2cps *id = to_xi2cps(nb);
 
+	if (id->suspended)
+		return NOTIFY_OK;
+
 	switch (event) {
 	case PRE_RATE_CHANGE:
 	{
@@ -759,6 +764,7 @@ static int xi2cps_suspend(struct device *_dev)
 	struct xi2cps *xi2c = platform_get_drvdata(pdev);
 
 	clk_disable(xi2c->clk);
+	xi2c->suspended = 1;
 
 	return 0;
 }
@@ -783,6 +789,8 @@ static int xi2cps_resume(struct device *_dev)
 		return ret;
 	}
 
+	xi2c->suspended = 0;
+
 	return 0;
 }
 
-- 
1.7.5.4

