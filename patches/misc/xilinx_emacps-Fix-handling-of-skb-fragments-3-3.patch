From 9ef256bc94c050ecf1fab1387c125817672cac41 Mon Sep 17 00:00:00 2001
From: Thomas Betker <thomas.betker@rohde-schwarz.com>
Date: Sat, 6 Apr 2013 11:56:41 +0200
Subject: [PATCH 382/628] xilinx_emacps: Fix handling of skb fragments (3/3)

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit 99be3b1e4d154f59a8291ad53e6f46173913aad4

When a Tx packet is fragmented, the controller sets USED=1 only in the
first buffer. This means that xemacps_tx_poll() cannot "preserve" the
USED bit (which may be 0), but must set USED=1 explicitly once the
packet has been transmitted.

Signed-off-by: Thomas Betker <thomas.betker@rohde-schwarz.com>
Tested-by: Anirudha Sarangi <anirudh@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/net/ethernet/xilinx/xilinx_emacps.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/xilinx/xilinx_emacps.c b/drivers/net/ethernet/xilinx/xilinx_emacps.c
index 04c5651..8ddcb49 100644
--- a/drivers/net/ethernet/xilinx/xilinx_emacps.c
+++ b/drivers/net/ethernet/xilinx/xilinx_emacps.c
@@ -1366,7 +1366,8 @@ static void xemacps_tx_poll(unsigned long data)
 			}
 		}
 
-		/* Preserve used and wrap bits; clear everything else. */
+		/* Set used bit, preserve wrap bit; clear everything else. */
+		cur_p->ctrl |= XEMACPS_TXBUF_USED_MASK;
 		cur_p->ctrl &= (XEMACPS_TXBUF_USED_MASK |
 					XEMACPS_TXBUF_WRAP_MASK);
 
-- 
1.7.5.4

