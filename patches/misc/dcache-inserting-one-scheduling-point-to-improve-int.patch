From 56cc0d2a662ad4718bf28abc5dead54f6e59f722 Mon Sep 17 00:00:00 2001
From: Aaro Koskinen <aaro.koskinen@nokia.com>
Date: Thu, 31 Dec 2015 10:13:22 +0100
Subject: [PATCH] dcache: inserting one scheduling point to improve
 interactivity

Add a new scheduling point to improve the responsiveness of the kernel
based on the fact that there are too many iterations in the dentries
reclamation operation.

The new added scheduling point will provide extra scheduling opportunities
to prevent the umount from monopolizing CPU for long time and starving other
tasks on the system,  especially on the system with non-preemptive kernel
and huge dcache, size of which approaches several Gigabytes for instance.

Original-author:Aaro Koskinen <aaro.koskinen@nokia.com>
Reviewed-by: Jason Wessel <jason.wessel@windriver.com>
Reviewed-by: Paul Gortmaker <paul.gortmaker@windriver.com>
Signed-off-by: Shan Hai <shan.hai@windriver.com>
Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
Signed-off-by: Yadi.hu <yadi.hu@windriver.com>
---
 fs/dcache.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/fs/dcache.c b/fs/dcache.c
index 945c115..d7e7a40 100644
--- a/fs/dcache.c
+++ b/fs/dcache.c
@@ -706,6 +706,12 @@ static void shrink_dcache_for_umount_subtree(struct dentry *dentry)
 
 			dentry = parent;
 
+			/* 
+			 * manually inserting another scheduling point to 
+			 * improve system interactivity 
+			 */
+			cond_resched();
+
 		} while (list_empty(&dentry->d_subdirs));
 
 		dentry = list_entry(dentry->d_subdirs.next,
-- 
1.7.5.4

