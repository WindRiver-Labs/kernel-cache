From 5ec934a29df72b5d9e7cdf95f418684826cb72d0 Mon Sep 17 00:00:00 2001
From: Michal Hocko <mhocko@suse.com>
Date: Wed, 14 Jun 2017 08:17:15 +0200
Subject: [PATCH 2/4] mm, proc: cap the stack gap for unpopulated growing vmas

Patch from mailing list distros@vs.openwall.org

Oleg has noticed that show_map_vma has been overly eager to cut the
the vma range for growing VMAs. This wasn't a big deal with 4kB stack
gap but now that the gap is much larger we can simply get a bogus VMA
range in show_map_vma.

To quote Oleg:

 "On ppc PAGE_SIZE == 64K, so stack_guard_gap == 16M, the application
  does mmap(..., length=4M, ... MAP_GROWSDOWN) and /proc/pid/maps
  happily reports

       30001000000-30000400000 rw-p 00000000 00:00 0"

Let's cap the reported range and show an empty range for this peculiar
case which is what we have been doing for a long time.  Note that the
range will expand as soon as the first page fault happens on this range.

Reported-by: Jan Stancek <jstancek@redhat.com>
Signed-off-by: Michal Hocko <mhocko@suse.com>
Tested-by: Tony Luck <tony.luck@intel.com> # ia64
Tested-by: Laura Abbott <labbott@redhat.com>
Tested-by: Helge Deller <deller@gmx.de> # parisc
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Willy Tarreau <w@1wt.eu>
Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 fs/proc/task_mmu.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/fs/proc/task_mmu.c b/fs/proc/task_mmu.c
index f2bae95..1188b9e 100644
--- a/fs/proc/task_mmu.c
+++ b/fs/proc/task_mmu.c
@@ -236,10 +236,10 @@ show_map_vma(struct seq_file *m, struct vm_area_struct *vma, int is_pid)
 	end = vma->vm_end;
 	if (vma->vm_flags & VM_GROWSDOWN) {
 		if (stack_guard_area(vma, start))
-			start += stack_guard_gap;
+			start = min(end, start + stack_guard_gap);
 	} else if (vma->vm_flags & VM_GROWSUP) {
 		if (stack_guard_area(vma, end))
-			end -= stack_guard_gap;
+			end = max(start, end - stack_guard_gap);
 	}
 
 	seq_printf(m, "%08lx-%08lx %c%c%c%c %08llx %02x:%02x %lu %n",
-- 
1.7.5.4

