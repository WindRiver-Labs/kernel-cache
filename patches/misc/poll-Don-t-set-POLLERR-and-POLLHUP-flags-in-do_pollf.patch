From 94f81d8c02eb6ecbcd6c499b1a63113ee9053786 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Mon, 24 Mar 2014 13:09:07 +0800
Subject: [PATCH] poll: Don't set POLLERR and POLLHUP flags in do_pollfd()

Since commit 754a1991("poll: avoid extra wakeups in select/poll"), we
set POLLERR and POLLHUP flags in do_pollfd() to avoid extra wakeups,
but we only backported part of the original upstream commit, and the
changes in do_pollfd() is actually not needed, and it may lead to low
throughout for certain-sized TCP packet.
So just reverting the changes in do_pollfd().

Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 fs/select.c |    6 +-----
 1 files changed, 1 insertions(+), 5 deletions(-)

diff --git a/fs/select.c b/fs/select.c
index cacb107..ca34936 100644
--- a/fs/select.c
+++ b/fs/select.c
@@ -583,12 +583,8 @@ static inline unsigned int do_pollfd(struct pollfd *pollfd, poll_table *pwait)
 		if (file != NULL) {
 			trace_fs_poll(fd);
 			mask = DEFAULT_POLLMASK;
-			if (file->f_op && file->f_op->poll) {
-				if (pwait)
-					pwait->key = pollfd->events |
-							POLLERR | POLLHUP;
+			if (file->f_op && file->f_op->poll)
 				mask = file->f_op->poll(file, pwait);
-			}
 			/* Mask out unneeded events. */
 			mask &= pollfd->events | POLLERR | POLLHUP;
 			fput_light(file, fput_needed);
-- 
1.7.0

