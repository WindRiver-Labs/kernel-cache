From fb2102e257aaae01698b65ea58167f85f06e5064 Mon Sep 17 00:00:00 2001
From: John Linn <john.linn@xilinx.com>
Date: Tue, 28 Jun 2011 14:57:57 -0600
Subject: [PATCH 289/628] Xilinx: ARM: I2C: Updated to support sub-devices in
 device tree

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit cf49b7507a3e6655c9ee24906d7f6a6635809f49

This allows the i2c eeproms and rtc to be moved into the
device tree so it is a more complete solution.

Signed-off-by: John Linn <john.linn@xilinx.com>
[cherry picked the xilinx i2c driver modification only]
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/i2c/busses/i2c-xilinx_ps.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/drivers/i2c/busses/i2c-xilinx_ps.c b/drivers/i2c/busses/i2c-xilinx_ps.c
index f0cfc77..a6c5080 100644
--- a/drivers/i2c/busses/i2c-xilinx_ps.c
+++ b/drivers/i2c/busses/i2c-xilinx_ps.c
@@ -45,6 +45,7 @@
 #include <linux/xilinx_devices.h>
 #include <linux/platform_device.h>
 #include <linux/slab.h>
+#include <linux/of_i2c.h>
 
 /*
  * Register Map
@@ -611,6 +612,7 @@ static int __devinit xi2cps_probe(struct platform_device *pdev)
 		dev_err(&pdev->dev, "couldn't determine bus-id\n");
 		goto err_unmap ;
 	}
+	id->adap.dev.of_node = pdev->dev.of_node;
 #else
 	id->adap.nr = pdev->id;
 #endif
@@ -674,6 +676,11 @@ static int __devinit xi2cps_probe(struct platform_device *pdev)
 		goto err_free_irq;
 	}
 
+
+#ifdef CONFIG_OF
+	of_i2c_register_devices(&id->adap);
+#endif
+
 	dev_info(&pdev->dev, "%d kHz mmio %08lx irq %d\n",
 		 i2c_clk/1000, (unsigned long)r_mem->start, id->irq);
 
-- 
1.7.5.4

