From 5cacb0362bdf87700f26780d5e6e3fb6c953e6cf Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Tue, 26 Feb 2013 16:40:36 +0800
Subject: [PATCH 149/169] net: can: fix not proper part from commit 0e55b9f1

The commit 0e55b9f1 introduces two not proper points as follows:

1. return failure when ID is not set.
2. version should be only for all mxc series.
3. fifo register is not proper for mxs platform(oops).

This should be removed if ID comes from DTB; And there may be
another choice to dynamically set ID value in some drivers enen
if it comes from platform mode.

Since version is only introduced by mxc platform for platform
mode, so it is no reason for this out of CONFIG_ARCH_MXC scope
as other parts do in that commit ID.

Hardware features has been used to tell from the different
version of Flexcan in mainline, so they should be confined
by CONFIG_ARCH_MXC as well.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/can/flexcan.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/drivers/net/can/flexcan.c b/drivers/net/can/flexcan.c
index 81828da..bf7f4df 100644
--- a/drivers/net/can/flexcan.c
+++ b/drivers/net/can/flexcan.c
@@ -804,9 +804,11 @@ static int flexcan_chip_start(struct net_device *dev)
 	flexcan_write(0x0, &regs->rx14mask);
 	flexcan_write(0x0, &regs->rx15mask);
 
+#ifdef CONFIG_ARCH_MXC
 	/* clear rx fifo global mask */
 	if (priv->version >= FLEXCAN_VER_10_0_12)
 		flexcan_write(0x0, &regs->rxfgmask);
+#endif
 
 	flexcan_transceiver_switch(priv, 1);
 
@@ -1011,8 +1013,10 @@ static int __devinit flexcan_probe(struct platform_device *pdev)
 	int err, irq;
 	u32 clock_freq = 0;
 
+#ifdef CONFIG_ARCH_MXC
 	if (pdev->id < 0)
 		return -ENODEV;
+#endif
 
 	pinctrl = devm_pinctrl_get_select_default(&pdev->dev);
 	if (IS_ERR(pinctrl))
@@ -1079,7 +1083,9 @@ static int __devinit flexcan_probe(struct platform_device *pdev)
 	priv->clk = clk;
 	priv->id = pdev->id;
 	priv->pdata = pdev->dev.platform_data;
+#ifdef CONFIG_ARCH_MXC
 	priv->version = pdev->id_entry->driver_data;
+#endif
 
 	netif_napi_add(dev, &priv->napi, flexcan_poll, FLEXCAN_NAPI_WEIGHT);
 
-- 
1.7.0

