From d1eafc4a64714a3c54428287e260b168e91c286e Mon Sep 17 00:00:00 2001
From: Soren Brinkmann <soren.brinkmann@xilinx.com>
Date: Tue, 16 Apr 2013 14:38:33 -0700
Subject: [PATCH 620/628] arm: zynq: Migrate to clock controller

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit 28581ed98730ec40c31c66bb9e276786a76f4edf

Switch Zynq, including its drivers, over to use the new clock
controller. And remove old clock implementation.

Signed-off-by: Soren Brinkmann <soren.brinkmann@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 arch/arm/boot/dts/zynq-zc706.dts |   64 ++++++++++++++++++++-----------------
 1 files changed, 35 insertions(+), 29 deletions(-)

diff --git a/arch/arm/boot/dts/zynq-zc706.dts b/arch/arm/boot/dts/zynq-zc706.dts
index 6512e4f..4f6f52e 100644
--- a/arch/arm/boot/dts/zynq-zc706.dts
+++ b/arch/arm/boot/dts/zynq-zc706.dts
@@ -60,6 +60,8 @@
 
 		uart@e0001000 {
 			compatible = "xlnx,ps7-uart-1.00.a", "xlnx,xuartps";
+			clocks = <&clkc 24>, <&clkc 41>;
+			clock-names = "ref_clk", "aper_clk";
 			reg = <0xe0001000 0x1000>;
 			interrupts = <0 50 4>;
 			interrupt-parent = <&gic>;
@@ -72,41 +74,29 @@
 			clocks {
 				#address-cells = <1>;
 				#size-cells = <0>;
-				armpll: armpll {
-					#clock-cells = <0>;
-					clock-output-names = "armpll";
-					clocks = <&ps_clk>;
-					compatible = "xlnx,zynq-pll";
-					lockbit = <0>;
-					reg = < 0x100 0x110 0x10c >;
-				} ;
-				ddrpll: ddrpll {
-					#clock-cells = <0>;
-					clock-output-names = "ddrpll";
-					clocks = <&ps_clk>;
-					compatible = "xlnx,zynq-pll";
-					lockbit = <1>;
-					reg = < 0x104 0x114 0x10c >;
-				} ;
-				iopll: iopll {
-					#clock-cells = <0>;
-					clock-output-names = "iopll";
-					clocks = <&ps_clk>;
-					compatible = "xlnx,zynq-pll";
-					lockbit = <2>;
-					reg = < 0x108 0x118 0x10c >;
-				} ;
-				ps_clk: ps_clk {
-					#clock-cells = <0>;
-					compatible = "fixed-clock";
-					clock-frequency = <33333333>;
-					clock-output-names = "ps_clk";
+
+				clkc: clkc {
+					#clock-cells = <1>;
+					compatible = "xlnx,ps7-clkc";
+					ps-clk-frequency = <33333333>;
+					clock-output-names = "armpll", "ddrpll", "iopll", "cpu_6or4x",
+							"cpu_3or2x", "cpu_2x", "cpu_1x", "ddr2x", "ddr3x",
+							"dci", "lqspi", "smc", "pcap", "gem0", "gem1",
+							"fclk0", "fclk1", "fclk2", "fclk3", "can0", "can1",
+							"sdio0", "sdio1", "uart0", "uart1", "spi0", "spi1",
+							"dma", "usb0_aper", "usb1_aper", "gem0_aper",
+							"gem1_aper", "sdio0_aper", "sdio1_aper",
+							"spi0_aper", "spi1_aper", "can0_aper", "can1_aper",
+							"i2c0_aper", "i2c1_aper", "uart0_aper", "uart1_aper",
+							"gpio_aper", "lqspi_aper", "smc_aper", "swdt",
+							"dbg_trc", "dbg_apb";
 				};
 			};
 		};
 
 		timer@0xf8001000 {
 			compatible = "xlnx,ps7-ttc-1.00.a", "cdns,ttc";
+			clocks = <&clkc 6>;
 			reg = <0xf8001000 0x1000>;
 			interrupts = <0 10 4>,<0 11 4>,<0 12 4>;
 			interrupt-parent = <&gic>;
@@ -114,6 +104,7 @@
 
 		timer@f8f00600 {
 			compatible = "arm,cortex-a9-twd-timer";
+			clocks = <&clkc 4>;
 			reg = <0xf8f00600 0x20>;
 			interrupts = <1 13 0x301>;
 			interrupt-parent = <&gic>;
@@ -122,6 +113,7 @@
 		swdt@f8005000 {
 			device_type = "watchdog";
 			compatible = "xlnx,ps7-wdt-1.00.a";
+			clocks = <&clkc 45>;
 			reg = <0xf8005000 0x100>;
 			reset = <0>;
 			timeout = <10>;
@@ -130,6 +122,7 @@
 		scuwdt@f8f00620 {
 			device_type = "watchdog";
 			compatible = "arm,mpcore_wdt";
+			clocks = <&clkc 4>;
 			reg = <0xf8f00620 0x20>;
 			clock-frequency = <333333333>;
 			reset = <1>;
@@ -137,6 +130,8 @@
 
 		eth@e000b000 {
 			compatible = "xlnx,ps7-ethernet-1.00.a";
+			clocks = <&clkc 13>, <&clkc 30>;
+			clock-names = "ref_clk", "aper_clk";
 			reg = <0xe000b000 0x1000>;
 			interrupts = <0 22 4>;
 			interrupt-parent = <&gic>;
@@ -164,6 +159,7 @@
 
 		i2c0: i2c@e0004000 {
 			compatible = "xlnx,ps7-i2c-1.00.a";
+			clocks = <&clkc 38>;
 			reg = <0xE0004000 0x1000>;
 			interrupts = <0 25 4>;
 			interrupt-parent = <&gic>;
@@ -227,6 +223,8 @@
 
 		sdhci@e0100000 {
 			compatible = "xlnx,ps7-sdhci-1.00.a";
+			clocks = <&clkc 21>, <&clkc 32>;
+			clock-names = "ref_clk", "aper_clk";
 			reg = <0xe0100000 0x1000>;
 			xlnx,has-cd = <0x1>;
 			interrupts = <0 24 4>;
@@ -236,6 +234,7 @@
 
 		usb@e0002000 {
 			compatible = "xlnx,ps7-usb-1.00.a";
+			clocks = <&clkc 28>;
 			reg = <0xe0002000 0x1000>;
 			interrupts = <0 21 4>;
 			interrupt-parent = <&gic>;
@@ -245,6 +244,7 @@
 
 		gpio@e000a000 {
 			compatible = "xlnx,ps7-gpio-1.00.a";
+			clocks = <&clkc 42>;
 			reg = <0xe000a000 0x1000>;
 			interrupts = <0 20 4>;
 			interrupt-parent = <&gic>;
@@ -252,6 +252,8 @@
 
 		qspi0: spi@e000d000 {
 			compatible = "xlnx,ps7-qspi-1.00.a";
+			clocks = <&clkc 10>, <&clkc 43>;
+			clock-names = "ref_clk", "aper_clk";
 			reg = <0xE000D000 0x1000>;
 			interrupts = <0 19 4>;
 			interrupt-parent = <&gic>;
@@ -291,6 +293,8 @@
 
 		devcfg@f8007000 {
 			compatible = "xlnx,ps7-dev-cfg-1.00.a";
+			clocks = <&clkc 12>, <&clkc 15>, <&clkc 16>, <&clkc 17>, <&clkc 18>;
+			clock-names = "ref_clk", "fclk0", "fclk1", "fclk2", "fclk3";
 			reg = <0xf8007000 0x100>;
 			interrupts = <0 8 4>;
 			interrupt-parent = <&gic>;
@@ -298,6 +302,7 @@
 
 		xadc@f8007100 {
 			compatible = "xlnx,ps7-xadc-1.00.a";
+			clocks = <&clkc 12>;
 			reg = <0xf8007100 0x20>;
 			interrupts = <0 7 4>;
 			interrupt-parent = <&gic>;
@@ -308,6 +313,7 @@
 			#dma-requests = <4>;
 			arm,primecell-periphid = <0x41330>;
 			compatible = "xlnx,ps7-dma-1.00.a", "arm,primecell", "arm,pl330";
+			clocks = <&clkc 27>;
 			interrupt-parent = <&gic>;
 			interrupts = < 0 13 4 0 14 4 0 15 4 0 16 4 0 17 4 0 40 4 0 41 4 0 42 4 0 43 4 >;
 			reg = < 0xf8003000 0x1000 >;
-- 
1.7.5.4

