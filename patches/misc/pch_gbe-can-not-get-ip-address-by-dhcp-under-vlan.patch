From 881580be746cceeb94ead72928a5d4cec9ee4260 Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Wed, 24 Oct 2012 16:28:25 +0800
Subject: [PATCH] pch_gbe: can not get ip address by dhcp under vlan

When setting up vlan, pch_gbe driver can send out dhcp request package.
The package has already put into dma buffer, but the pch_gbe does not
send it on net wire.

When send net package including vlan tag, it need PCH_GBE_TXD_CTRL_ITAG flag.
While vlan package does not support TCP/IP accelerate function.

Signed-off-by: Li Wang <li.wang@windriver.com>
---
 drivers/net/pch_gbe/pch_gbe_main.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/drivers/net/pch_gbe/pch_gbe_main.c b/drivers/net/pch_gbe/pch_gbe_main.c
index f4a42ce..ff90101 100644
--- a/drivers/net/pch_gbe/pch_gbe_main.c
+++ b/drivers/net/pch_gbe/pch_gbe_main.c
@@ -2342,6 +2342,12 @@ pch_gbe_tx_queue(struct pch_gbe_adapter *adapter,
   frame_ctrl |= PCH_GBE_TXD_CTRL_APAD;
  if (unlikely(adapter->tx_csum == FALSE))
   frame_ctrl |= PCH_GBE_TXD_CTRL_TCPIP_ACC_OFF;
+ /*
+  * When send net package including vlan tag, it needs PCH_GBE_TXD_CTRL_ITAG flag.
+  * While vlan package does not support TCP/IP accelerate function.
+  */
+ if (skb->protocol == htons(ETH_P_8021Q))
+  frame_ctrl |= PCH_GBE_TXD_CTRL_ITAG | PCH_GBE_TXD_CTRL_TCPIP_ACC_OFF;
 
  /* Performs checksum processing */
  /*
-- 
1.7.0

