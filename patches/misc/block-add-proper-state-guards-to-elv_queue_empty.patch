From a94453bf11ee78e0eaebd79027ec4be1acd9cae0 Mon Sep 17 00:00:00 2001
From: Yue Tao <Yue.Tao@windriver.com>
Date: Thu, 13 Sep 2012 13:28:16 +0800
Subject: [PATCH] block: add proper state guards to elv_queue_empty()

This change does not exist upstream - as elv_queue_empty()
was deleted in 2.6.39.  However, the change made here to
test for a dead queue before operating on it is very similar
to upstream commit 0a58e077eb600 ("block: add proper state
guards to __elv_next_request"

Reference:

https://lkml.org/lkml/2011/6/3/33

Signed-Off-By: Michael Tokarev <mjt@tls.msk.ru>
Integrated-by: Yue Tao <Yue.Tao@windriver.com>
---
 block/elevator.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/block/elevator.c b/block/elevator.c
index 76e3702..5be39e5 100644
--- a/block/elevator.c
+++ b/block/elevator.c
@@ -751,7 +751,8 @@ int elv_queue_empty(struct request_queue *q)
 	if (!list_empty(&q->queue_head))
 		return 0;
 
-	if (e->ops->elevator_queue_empty_fn)
+	if (!test_bit(QUEUE_FLAG_DEAD, &q->queue_flags) &&
+	    e->ops->elevator_queue_empty_fn)
 		return e->ops->elevator_queue_empty_fn(q);
 
 	return 1;
-- 
1.7.0

