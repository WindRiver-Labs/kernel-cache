From 87a3cad2298367cc6a1b8a004030d4332f068844 Mon Sep 17 00:00:00 2001
From: Zhenbo Gao <zhenbo.gao@windriver.com>
Date: Mon, 6 Feb 2017 16:10:28 +0800
Subject: [PATCH] Revert "squashfs: modify the method of sleep in
 squashfs_read_data from TASK_UNINTERRUPTIBLE to
 TASK_KILLABLE"

This reverts commit eb30ba30f35d729c2d028d44c28993af63c67985.

Jianchao Wang asked to revert this commit as it will lead to
errors under some situations.

Signed-off-by: Zhenbo Gao <zhenbo.gao@windriver.com>
---
 fs/squashfs/block.c |   28 +---------------------------
 1 files changed, 1 insertions(+), 27 deletions(-)

diff --git a/fs/squashfs/block.c b/fs/squashfs/block.c
index 10bf5b7..a7e2efc 100644
--- a/fs/squashfs/block.c
+++ b/fs/squashfs/block.c
@@ -39,26 +39,6 @@
 #include "decompressor.h"
 #include "page_actor.h"
 
-
-static int squashfs_sleep_on_buffer(void *word)
-{
-	io_schedule();
-	return fatal_signal_pending(current) ? -EINTR : 0;
-}
-/* Wait on the buffer head until the buffer comes unlocked or a SIGKILL
- * If a task is waken up by a SIGKILL, the buffer should be not uptodate,
- * so squashfs_read_data() will return ERROR.
- * */
-static int squashfs_wait_on_buffer_killable(struct buffer_head *bh)
-{
-	int ret = 0;
-
-	might_sleep();
-	if (buffer_locked(bh))
-		ret = wait_on_bit(&bh->b_state, BH_Lock, squashfs_sleep_on_buffer, 
-				TASK_KILLABLE);
-	return ret;
-}
 /*
  * Read the metadata block length, this is stored in the first two
  * bytes of the metadata block.
@@ -181,13 +161,7 @@ int squashfs_read_data(struct super_block *sb, u64 index, int length,
 	}
 
 	for (i = 0; i < b; i++) {
-		if (unlikely(squashfs_wait_on_buffer_killable(bh[i]))) {
-			/* If the read operation has been interrupted by SIGKILL,
-			 * no matter whether the bh has been uptodate, ignore it.
-			 */
-			ERROR("squashfs_read_data interrupted by SIGKILL\n");
-			goto block_release;
-		}
+		wait_on_buffer(bh[i]);
 		if (!buffer_uptodate(bh[i]))
 			goto block_release;
 	}
-- 
1.7.5.4

