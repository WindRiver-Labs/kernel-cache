From 74bb052e413a40c781b9500bbf3873237ad60a1f Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Thu, 11 Apr 2013 12:09:35 +0800
Subject: [PATCH 16/16] perf/x86: resolve the undeclared PERF_EFLAGS_EXACT and PERF_RECORD_MISC_EXACT symbols

This is part of upstream commit ef21f683a045a79b6aa86ad81e5fdfc0d5ddd250:
"perf, x86: use LBR for PEBS IP+1 fixup".

Resolve the below building errors:
  CC      arch/x86/kernel/cpu/perf_event.o
  linux/arch/x86/kernel/cpu/perf_event.c: In function 'perf_misc_flags':
  linux/arch/x86/kernel/cpu/perf_event.c:1782: error: 'PERF_EFLAGS_EXACT' undeclared \
  (first use in this function)
  linux/arch/x86/kernel/cpu/perf_event.c:1782: error: (Each undeclared identifier \
  is reported only once
  linux/arch/x86/kernel/cpu/perf_event.c:1782: error: for each function it appears in.)
  linux/arch/x86/kernel/cpu/perf_event.c:1783: error: 'PERF_RECORD_MISC_EXACT' undeclared \
  (first use in this function)
  linux/scripts/Makefile.build:411: *** [arch/x86/kernel/cpu/perf_event.o] Error 1

Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 arch/x86/include/asm/perf_event.h |    7 +++++++
 include/linux/perf_event.h        |    6 ++++++
 2 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/arch/x86/include/asm/perf_event.h b/arch/x86/include/asm/perf_event.h
index f409362..1e979f7 100644
--- a/arch/x86/include/asm/perf_event.h
+++ b/arch/x86/include/asm/perf_event.h
@@ -136,6 +136,13 @@ extern void perf_events_lapic_init(void);
 
 #define PERF_EVENT_INDEX_OFFSET			0
 
+/*
+ * Abuse bit 3 of the cpu eflags register to indicate proper PEBS IP fixups.
+ * This flag is otherwise unused and ABI specified to be 0, so nobody should
+ * care what we do with it.
+ */
+#define PERF_EFLAGS_EXACT       (1UL << 3)
+
 struct pt_regs;
 extern unsigned long perf_instruction_pointer(struct pt_regs *regs);
 extern unsigned long perf_misc_flags(struct pt_regs *regs);
diff --git a/include/linux/perf_event.h b/include/linux/perf_event.h
index 05f0c8e..9f8ad48 100644
--- a/include/linux/perf_event.h
+++ b/include/linux/perf_event.h
@@ -295,6 +295,12 @@ struct perf_event_mmap_page {
 #define PERF_RECORD_MISC_GUEST_KERNEL		(4 << 0)
 #define PERF_RECORD_MISC_GUEST_USER		(5 << 0)
 
+#define PERF_RECORD_MISC_EXACT                 (1 << 14)
+/*
+ * Reserve the last bit to indicate some extended misc field
+ */
+#define PERF_RECORD_MISC_EXT_RESERVED          (1 << 15)
+
 struct perf_event_header {
 	__u32	type;
 	__u16	misc;
-- 
1.7.0

