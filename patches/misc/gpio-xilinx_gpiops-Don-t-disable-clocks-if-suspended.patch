From 08f7942b3d69ae9b7a77cc223633ee3bf79d23fb Mon Sep 17 00:00:00 2001
From: Soren Brinkmann <soren.brinkmann@xilinx.com>
Date: Thu, 8 Nov 2012 18:32:51 -0800
Subject: [PATCH 330/628] gpio: xilinx_gpiops: Don't disable clocks if
 suspended

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit c6bd5bb2ac83beccae1d5c043e6022049b3dbfd3

When entering suspend the device clocks were disabled, even
when they were already gated off due to RUNTIME_PM. Triggering
a kernel warning.

Signed-off-by: Soren Brinkmann <soren.brinkmann@xilinx.com>
Acked: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/gpio/gpio-xilinxps.c |    8 ++++++--
 1 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/gpio/gpio-xilinxps.c b/drivers/gpio/gpio-xilinxps.c
index b89739d..5849500 100644
--- a/drivers/gpio/gpio-xilinxps.c
+++ b/drivers/gpio/gpio-xilinxps.c
@@ -439,7 +439,8 @@ static int xgpiops_suspend(struct device *_dev)
 			struct platform_device, dev);
 	struct xgpiops *gpio = platform_get_drvdata(pdev);
 
-	clk_disable(gpio->clk);
+	if (!pm_runtime_suspended(_dev))
+		clk_disable(gpio->clk);
 	return 0;
 }
 
@@ -449,7 +450,10 @@ static int xgpiops_resume(struct device *_dev)
 			struct platform_device, dev);
 	struct xgpiops *gpio = platform_get_drvdata(pdev);
 
-	return clk_enable(gpio->clk);
+	if (!pm_runtime_suspended(_dev))
+		return clk_enable(gpio->clk);
+
+	return 0;
 }
 
 #ifdef CONFIG_PM_RUNTIME
-- 
1.7.5.4

