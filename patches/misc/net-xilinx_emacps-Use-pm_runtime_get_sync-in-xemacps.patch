From 057b920f0ddef6fd67f0a8ea304a64f518a5a90c Mon Sep 17 00:00:00 2001
From: Thomas Betker <thomas.betker@rohde-schwarz.com>
Date: Sat, 8 Jun 2013 11:03:14 +0200
Subject: [PATCH 405/628] net: xilinx_emacps: Use pm_runtime_get_sync() in
 xemacps_open().

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit 81d39496b02d9ba8d766768cf9362a44f94273ff

In xemacps_open(), use pm_runtime_get_sync(), not pm_runtime_get().
When the latter returns, the clocks may not be enabled, leading to
all kinds of problems when accessing the controller immediately
afterwards.

Signed-off-by: Thomas Betker <thomas.betker@rohde-schwarz.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Acked-by: Soren Brinkmann <soren.brinkmann@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/net/ethernet/xilinx/xilinx_emacps.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/xilinx/xilinx_emacps.c b/drivers/net/ethernet/xilinx/xilinx_emacps.c
index 076488f..2c1d218 100644
--- a/drivers/net/ethernet/xilinx/xilinx_emacps.c
+++ b/drivers/net/ethernet/xilinx/xilinx_emacps.c
@@ -1830,9 +1830,10 @@ static int xemacps_open(struct net_device *ndev)
 		return rc;
 	}
 
-	rc = pm_runtime_get(&lp->pdev->dev);
+	rc = pm_runtime_get_sync(&lp->pdev->dev);
 	if (rc < 0) {
-		dev_err(&lp->pdev->dev, "pm_runtime_get() failed, rc %d\n", rc);
+		dev_err(&lp->pdev->dev,
+			"pm_runtime_get_sync() failed, rc %d\n", rc);
 		goto err_free_rings;
 	}
 
-- 
1.7.5.4

