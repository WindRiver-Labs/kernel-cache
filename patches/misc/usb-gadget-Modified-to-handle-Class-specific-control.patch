From d0f939133a72b40f9f918c6a2e7df03fce83b9d9 Mon Sep 17 00:00:00 2001
From: Subbaraya Sundeep Bhatta <subbaraya.sundeep.bhatta@xilinx.com>
Date: Mon, 23 Sep 2013 21:20:41 +0530
Subject: [PATCH 551/628] usb: gadget: Modified to handle Class specific
 control requests properly.

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit e680ea2cb440c76d10c108670143be89bd137ad7

Offload setup packet processing to gadget layer for USB Class specific
requests with bRequest as 0x0. Ex: SEND_ENCAPSULATED_COMMAND of
CDC class

Signed-off-by: Subbaraya Sundeep Bhatta <sbhatta@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/usb/gadget/xilinx_udc.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/usb/gadget/xilinx_udc.c b/drivers/usb/gadget/xilinx_udc.c
index 71baf6a..609caa2 100644
--- a/drivers/usb/gadget/xilinx_udc.c
+++ b/drivers/usb/gadget/xilinx_udc.c
@@ -1969,8 +1969,8 @@ static void control_ep_intrhandler(void *callbackref, u32 intrstatus)
 			udc->write_fn(intrreg,
 				(udc->base_address + XUSB_IER_OFFSET));
 			status = process_setup_pkt(udc, &ctrl);
-			if (status) {
-
+			if (status || ((ch9_cmdbuf.setup.bRequestType &
+			USB_TYPE_MASK) == USB_TYPE_CLASS)) {
 				/*
 				 * Request is to be handled by the gadget
 				 * driver.
-- 
1.7.5.4

