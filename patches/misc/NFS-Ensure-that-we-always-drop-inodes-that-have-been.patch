From 1a5ecda7ec5733dc6d7f2c4d0c07a294b7d908e0 Mon Sep 17 00:00:00 2001
From: Lans Zhang <jia.zhang@windriver.com>
Date: Fri, 1 Feb 2013 17:43:02 +0800
Subject: [PATCH 1/3] NFS: Ensure that we always drop inodes that have been
 marked as stale

commit eed9935745cc44071043ec8c4cde64c820b5c601	upstream

There is no need to cache stale inodes.

Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>
[LZ: make minor changes to adapt to 3.4.]
Signed-off-by: Lans Zhang <jia.zhang@windriver.com>
---
 fs/nfs/inode.c    |    6 ++++++
 fs/nfs/internal.h |    1 +
 fs/nfs/super.c    |    1 +
 3 files changed, 8 insertions(+)

diff --git a/fs/nfs/inode.c b/fs/nfs/inode.c
index edf4119..901e8ce 100644
--- a/fs/nfs/inode.c
+++ b/fs/nfs/inode.c
@@ -106,6 +106,12 @@ u64 nfs_compat_user_ino64(u64 fileid)
 	return ino;
 }
 
+int nfs_drop_inode(struct inode *inode)
+{
+	return NFS_STALE(inode) || generic_drop_inode(inode);
+}
+EXPORT_SYMBOL_GPL(nfs_drop_inode);
+
 static void nfs_clear_inode(struct inode *inode)
 {
 	/*
diff --git a/fs/nfs/internal.h b/fs/nfs/internal.h
index c7d5aa1..e15b2cd 100644
--- a/fs/nfs/internal.h
+++ b/fs/nfs/internal.h
@@ -257,6 +257,7 @@ extern struct workqueue_struct *nfsiod_workqueue;
 extern struct inode *nfs_alloc_inode(struct super_block *sb);
 extern void nfs_destroy_inode(struct inode *);
 extern int nfs_write_inode(struct inode *, struct writeback_control *);
+extern int nfs_drop_inode(struct inode *);
 extern void nfs_evict_inode(struct inode *);
 #ifdef CONFIG_NFS_V4
 extern void nfs4_evict_inode(struct inode *);
diff --git a/fs/nfs/super.c b/fs/nfs/super.c
index ebf5b5e..6329063 100644
--- a/fs/nfs/super.c
+++ b/fs/nfs/super.c
@@ -315,6 +315,7 @@ static const struct super_operations nfs_sops = {
 	.alloc_inode	= nfs_alloc_inode,
 	.destroy_inode	= nfs_destroy_inode,
 	.write_inode	= nfs_write_inode,
+	.drop_inode	= nfs_drop_inode,
 	.put_super	= nfs_put_super,
 	.statfs		= nfs_statfs,
 	.evict_inode	= nfs_evict_inode,
-- 
1.7.9.7

