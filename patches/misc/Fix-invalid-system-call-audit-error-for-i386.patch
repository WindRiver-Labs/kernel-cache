From 417c9bc8dff62a2e1637c6e9f1d8acf63d180d00 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Wed, 26 Mar 2014 08:57:15 -0700
Subject: [PATCH 14/26] Fix invalid system call audit error for i386

In the i386 kernel, if pass invalid parameter to syscall() function
from userspace, there is call trace dumped on auditsc.c.
Because in the bad system call handle process does not clear
context->in_syscall to 0.

Add system call audit exit to bad system call handle procedure
can fix it.

Signed-off-by: Kai Sun <kai.sun@windriver.com>
Signed-off-by: Han Chao <chan@windriver.com>
[Fix context conflict on secure kernel]
Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/x86/kernel/entry_32.S |    5 +++++
 1 file changed, 5 insertions(+)

diff --git a/arch/x86/kernel/entry_32.S b/arch/x86/kernel/entry_32.S
index 9b482fa..3e56c6c 100644
--- a/arch/x86/kernel/entry_32.S
+++ b/arch/x86/kernel/entry_32.S
@@ -923,6 +923,11 @@ ENDPROC(syscall_fault)
 
 syscall_badsys:
 	movl $-ENOSYS,PT_EAX(%esp)
+#ifdef CONFIG_AUDITSYSCALL
+	movl TI_flags(%ebp), %ecx
+	testl $_TIF_ALLWORK_MASK, %ecx
+	jne sysexit_audit
+#endif
 	jmp resume_userspace
 ENDPROC(syscall_badsys)
 	CFI_ENDPROC
-- 
1.7.9.5

