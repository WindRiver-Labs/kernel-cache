From 10134469e57b9775a64283e982330a8c9d1c1a7b Mon Sep 17 00:00:00 2001
From: Yue Tao <yue.tao@windriver.com>
Date: Mon, 10 Mar 2014 08:14:44 -0700
Subject: [PATCH] Fix invalid system call audit error for i386

In the i386 kernel, if pass invalid parameter to syscall() function
from userspace, there is call trace dumped on auditsc.c.
Because in the bad system call handle process does not clear
context->in_syscall to 0.

Add system call audit exit to bad system call handle procedure
can fix it.

Signed-off-by: Kai Sun <kai.sun@windriver.com>
Signed-off-by: Han Chao <chan@windriver.com>

diff --git a/arch/x86/kernel/entry_32.S b/arch/x86/kernel/entry_32.S
index 599dcc1175d2..e1ebb65df6c8 100644
--- a/arch/x86/kernel/entry_32.S
+++ b/arch/x86/kernel/entry_32.S
@@ -700,6 +700,11 @@ END(syscall_fault)
 
 syscall_badsys:
 	movl $-ENOSYS,%eax
+#ifdef CONFIG_AUDITSYSCALL
+	movl TI_flags(%ebp), %ecx
+	testl $_TIF_ALLWORK_MASK, %ecx
+	jne sysexit_audit
+#endif
 	jmp syscall_after_call
 END(syscall_badsys)
 
-- 
2.0.1

