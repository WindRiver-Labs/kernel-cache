From 026c0a1149355690ec5bd8e5e9c2c5979f1408d7 Mon Sep 17 00:00:00 2001
From: Michal Simek <michal.simek@xilinx.com>
Date: Fri, 12 Jul 2013 15:54:02 +0200
Subject: [PATCH 267/628] spi: xilinx-ps/qps: Fix kernel module unloading

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit 7e83b88ededfc719bf0537ebca0c7f3b17f10fa0

Disable clock before spi unregistration.
Not doing this is causing:
Unable to handle kernel paging request at virtual address 6b6b6b93

Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/spi/spi-xilinx-ps.c  |    6 +++---
 drivers/spi/spi-xilinx-qps.c |    8 +++++---
 2 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/drivers/spi/spi-xilinx-ps.c b/drivers/spi/spi-xilinx-ps.c
index 82d4ba0..b3f05c8 100644
--- a/drivers/spi/spi-xilinx-ps.c
+++ b/drivers/spi/spi-xilinx-ps.c
@@ -816,15 +816,15 @@ static int xspips_remove(struct platform_device *pdev)
 
 	xspips_write(xspi->regs + XSPIPS_ER_OFFSET, ~XSPIPS_ER_ENABLE_MASK);
 
-	spi_unregister_master(master);
-	spi_master_put(master);
-
 	clk_notifier_unregister(xspi->devclk, &xspi->clk_rate_change_nb);
 	clk_disable_unprepare(xspi->devclk);
 	clk_disable_unprepare(xspi->aperclk);
 	clk_put(xspi->devclk);
 	clk_put(xspi->aperclk);
 
+	spi_unregister_master(master);
+	spi_master_put(master);
+
 	dev_dbg(&pdev->dev, "remove succeeded\n");
 	return 0;
 
diff --git a/drivers/spi/spi-xilinx-qps.c b/drivers/spi/spi-xilinx-qps.c
index 1ff20d9..68cc344 100644
--- a/drivers/spi/spi-xilinx-qps.c
+++ b/drivers/spi/spi-xilinx-qps.c
@@ -1173,15 +1173,17 @@ static int xqspips_remove(struct platform_device *pdev)
 	xqspips_write(xqspi->regs + XQSPIPS_ENABLE_OFFSET,
 			~XQSPIPS_ENABLE_ENABLE_MASK);
 
-	spi_unregister_master(master);
-	spi_master_put(master);
-
 	clk_notifier_unregister(xqspi->devclk, &xqspi->clk_rate_change_nb);
 	clk_disable_unprepare(xqspi->devclk);
 	clk_disable_unprepare(xqspi->aperclk);
 	clk_put(xqspi->devclk);
 	clk_put(xqspi->aperclk);
 
+
+	spi_unregister_master(master);
+	spi_master_put(master);
+
+
 	dev_dbg(&pdev->dev, "remove succeeded\n");
 	return 0;
 }
-- 
1.7.5.4

