From 7027d10bd548667bb2cf1d57d4b129c77b3c13db Mon Sep 17 00:00:00 2001
From: Lei Liu <lei.liu2@windriver.com>
Date: Sun, 22 Sep 2013 12:57:40 +0800
Subject: [PATCH] Fix compat_do_readv_writev always return failure

Function compat_do_readv_writev is broken to always return
-EFAULT after an incomplete merge with 3.4.43 kernel.  The
original patch is not fully applied which causes x86_64
32-bit applications fail in writev syscall.  Fix it by merge
the patch completely.

Signed-off-by: Lei Liu <lei.liu2@windriver.com>
---
 fs/compat.c |    8 ++------
 1 files changed, 2 insertions(+), 6 deletions(-)

diff --git a/fs/compat.c b/fs/compat.c
index 5eb8d0e..185e472 100644
--- a/fs/compat.c
+++ b/fs/compat.c
@@ -1094,12 +1094,8 @@ static ssize_t compat_do_readv_writev(int type, struct file *file,
 	if (nr_segs > UIO_MAXIOV)
 		goto out;
 
-	ret = -EFAULT;
-	if (!access_ok(VERIFY_READ, uvector, nr_segs*sizeof(*uvector)))
-		goto out;
-
-	tot_len = compat_rw_copy_check_uvector(type, uvector, nr_segs,
-					       UIO_FASTIOV, iovstack, &iov, 1);
+	ret = compat_rw_copy_check_uvector(type, uvector, nr_segs,
+					   UIO_FASTIOV, iovstack, &iov, 1);
 	if (ret <= 0)
 		goto out;
 
-- 
1.7.5.4

