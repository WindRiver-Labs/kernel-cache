From b61458df9a73e3025b300bbaabc6ebd1c0f40c22 Mon Sep 17 00:00:00 2001
From: Jianchuan Wang <jianchuan.wang@windriver.com>
Date: Fri, 17 Mar 2017 03:58:08 -0400
Subject: [PATCH] grsecurity: Fix warning caused by grsecurity

Fix warnings caused by grecurity.

Signed-off-by: Jianchuan Wang <jianchuan.wang@windriver.com>
---
 arch/arm/mm/fault.c        |    4 ++++
 mm/slub.c                  |    4 +++-
 net/core/sysctl_net_core.c |    2 +-
 3 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mm/fault.c b/arch/arm/mm/fault.c
index 1d2a418..fb4a7e9 100644
--- a/arch/arm/mm/fault.c
+++ b/arch/arm/mm/fault.c
@@ -638,9 +638,11 @@ do_DataAbort(unsigned long addr, unsigned int fsr, struct pt_regs *regs)
 	if (!inf->fn(addr, fsr & ~FSR_LNX_PF, regs))
 		return;
 
+#ifdef CONFIG_PAX_MEMORY_UDEREF
 die:
 	printk(KERN_ALERT "Unhandled fault: %s (0x%03x) at 0x%08lx\n",
 		inf->name, fsr, addr);
+#endif
 
 	info.si_signo = inf->sig;
 	info.si_errno = 0;
@@ -759,9 +761,11 @@ do_PrefetchAbort(unsigned long addr, unsigned int ifsr, struct pt_regs *regs)
 	if (!inf->fn(addr, ifsr | FSR_LNX_PF, regs))
 		return;
 
+#if defined(CONFIG_PAX_KERNEXEC) || defined(CONFIG_PAX_MEMORY_UDEREF)
 die:
 	printk(KERN_ALERT "Unhandled prefetch abort: %s (0x%03x) at 0x%08lx\n",
 		inf->name, ifsr, addr);
+#endif
 
 	info.si_signo = inf->sig;
 	info.si_errno = 0;
diff --git a/mm/slub.c b/mm/slub.c
index 3d5e216..a25c7f4 100644
--- a/mm/slub.c
+++ b/mm/slub.c
@@ -3730,7 +3730,7 @@ void __init kmem_cache_init(void)
 #endif
 
 	printk(KERN_INFO
-		"SLUB: HWalign=%d, Order=%d-%d, MinObjects=%d,"
+		"SLUB: HWalign=%ld, Order=%d-%d, MinObjects=%d,"
 		" CPUs=%d, Nodes=%d\n",
 		cache_line_size(),
 		slub_min_order, slub_max_order, slub_min_objects,
@@ -3955,6 +3955,7 @@ static int count_total(struct page *page)
 #endif
 
 #ifdef CONFIG_SLUB_DEBUG
+#if defined(CONFIG_SYSFS) && !defined(CONFIG_GRKERNSEC_PROC_ADD)
 static int validate_slab(struct kmem_cache *s, struct page *page,
 						unsigned long *map)
 {
@@ -4277,6 +4278,7 @@ static int list_locations(struct kmem_cache *s, char *buf,
 	return len;
 }
 #endif
+#endif
 
 #ifdef SLUB_RESILIENCY_TEST
 static void resiliency_test(void)
diff --git a/net/core/sysctl_net_core.c b/net/core/sysctl_net_core.c
index 26d07e0..2af4370 100644
--- a/net/core/sysctl_net_core.c
+++ b/net/core/sysctl_net_core.c
@@ -23,7 +23,7 @@
 #include <net/pkt_sched.h>
 
 static int zero = 0;
-static int one = 1;
+//static int one = 1;
 static int ushort_max = USHRT_MAX;
 static int min_sndbuf = SOCK_MIN_SNDBUF;
 static int min_rcvbuf = SOCK_MIN_RCVBUF;
-- 
1.7.5.4

