From a32ed1fd5f523e8c3bec6f6b47549131c85f52fa Mon Sep 17 00:00:00 2001
From: Thomas Betker <thomas.betker@rohde-schwarz.com>
Date: Sat, 11 May 2013 11:10:45 +0200
Subject: [PATCH 401/628] xilinx_emacps: Fix deadlock in
 xemacps_reinit_for_txtimeout()

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit 2102eab50d0480540e5db577c4db7386cec7c921

In xemacps_reinit_for_txtimeout(), do not hold tx_lock when calling
tasklet_disable(). If xemacps_tx_poll() starts to run between acquiring
tx_lock and tasklet_disable(), we are caught in a deadlock because
tasklet_disable() waits until xemacps_tx_poll() has finished.

Also use netif_wake_queue() instead of netif_start_queue(), and don't
forget to update ndev->trans_start.

Signed-off-by: Thomas Betker <thomas.betker@rohde-schwarz.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/net/ethernet/xilinx/xilinx_emacps.c |    7 +++++--
 1 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/xilinx/xilinx_emacps.c b/drivers/net/ethernet/xilinx/xilinx_emacps.c
index c2f0809..8e48636 100644
--- a/drivers/net/ethernet/xilinx/xilinx_emacps.c
+++ b/drivers/net/ethernet/xilinx/xilinx_emacps.c
@@ -1914,9 +1914,9 @@ static void xemacps_reinit_for_txtimeout(struct work_struct *data)
 	int rc;
 
 	netif_stop_queue(lp->ndev);
-	spin_lock_bh(&lp->tx_lock);
 	napi_disable(&lp->napi);
 	tasklet_disable(&lp->tx_bdreclaim_tasklet);
+	spin_lock_bh(&lp->tx_lock);
 	xemacps_reset_hw(lp);
 	spin_unlock_bh(&lp->tx_lock);
 
@@ -1936,11 +1936,14 @@ static void xemacps_reinit_for_txtimeout(struct work_struct *data)
 	lp->link    = 0;
 	lp->speed   = 0;
 	lp->duplex  = -1;
+
 	if (lp->phy_dev)
 		phy_start(lp->phy_dev);
+
 	napi_enable(&lp->napi);
 	tasklet_enable(&lp->tx_bdreclaim_tasklet);
-	netif_start_queue(lp->ndev);
+	lp->ndev->trans_start = jiffies;
+	netif_wake_queue(lp->ndev);
 }
 
 /**
-- 
1.7.5.4

