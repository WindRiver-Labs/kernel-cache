From 717c14dcc24d35a7ee18ab17d74a021e232eadfc Mon Sep 17 00:00:00 2001
From: Suneel <suneelg@xilinx.com>
Date: Wed, 13 Jun 2012 20:00:55 +0530
Subject: [PATCH 061/628] Xilinx: ARM: SD: Add support for card detect

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit 6e881de14f258bf25f1487c981ce94c3e52e2277

This patch adds support for card detect pin of controller
which enables the detection of insertion/removal of card
in SD slot.

Signed-off-by: Suneel <suneelg@xilinx.com>
[cherry picked the driver modification only]
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/mmc/host/sdhci-of-xilinxps.c |   21 ++++++++++++++++++++-
 1 files changed, 20 insertions(+), 1 deletions(-)

diff --git a/drivers/mmc/host/sdhci-of-xilinxps.c b/drivers/mmc/host/sdhci-of-xilinxps.c
index 127ca9c..59865f0 100644
--- a/drivers/mmc/host/sdhci-of-xilinxps.c
+++ b/drivers/mmc/host/sdhci-of-xilinxps.c
@@ -18,6 +18,7 @@
  * your option) any later version.
  */
 
+#include <linux/of.h>
 #include <linux/io.h>
 #include <linux/delay.h>
 #include <linux/module.h>
@@ -43,7 +44,25 @@ static struct sdhci_pltfm_data sdhci_zynq_pdata = {
 
 static int __devinit sdhci_zynq_probe(struct platform_device *pdev)
 {
-	return sdhci_pltfm_register(pdev, &sdhci_zynq_pdata);
+	int ret;
+	const void *prop = NULL;
+	struct device_node *np = pdev->dev.of_node;
+	struct sdhci_host *host = NULL;
+
+	ret = sdhci_pltfm_register(pdev, &sdhci_zynq_pdata);
+	if (ret == 0) {
+		prop = of_get_property(np, "xlnx,has-cd", NULL);
+		if (prop == NULL) {
+			host = platform_get_drvdata(pdev);
+			host->quirks |= SDHCI_QUIRK_BROKEN_CARD_DETECTION;
+		} else if (!(u32) be32_to_cpup(prop))  {
+			host = platform_get_drvdata(pdev);
+			host->quirks |= SDHCI_QUIRK_BROKEN_CARD_DETECTION;
+		}
+	} else
+		printk("sdhci platform registration failed\n");
+
+	return ret;
 }
 
 static int __devexit sdhci_zynq_remove(struct platform_device *pdev)
-- 
1.7.5.4

