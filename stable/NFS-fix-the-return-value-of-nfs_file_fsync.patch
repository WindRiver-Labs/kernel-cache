From 70b1b12e94d37a432016e8f71fc0b25845bc988d Mon Sep 17 00:00:00 2001
From: J. R. Okajima <hooanon05@yahoo.co.jp>
Date: Wed, 11 Aug 2010 13:10:16 -0400
Subject: [PATCH] NFS: fix the return value of nfs_file_fsync()

commit 0702099bd86c33c2dcdbd3963433a61f3f503901 upstream.

By the commit af7fa16 2010-08-03 NFS: Fix up the fsync code
close(2) became returning the non-zero value even if it went well.
nfs_file_fsync() should return 0 when "status" is positive.

[PG: in 34, nfs_file_fsync is just a wrapper around nfs_do_fsync,
 so the related code and actual change lands in nfs_do_fsync here.]

Signed-off-by: J. R. Okajima <hooanon05@yahoo.co.jp>
Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>
Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/fs/nfs/file.c b/fs/nfs/file.c
index 7f7df1d..1c91289 100644
--- a/fs/nfs/file.c
+++ b/fs/nfs/file.c
@@ -219,7 +219,7 @@ static int nfs_do_fsync(struct nfs_open_context *ctx, struct inode *inode)
 	have_error |= test_bit(NFS_CONTEXT_ERROR_WRITE, &ctx->flags);
 	if (have_error)
 		ret = xchg(&ctx->error, 0);
-	if (!ret)
+	if (!ret && status < 0)
 		ret = status;
 	return ret;
 }
-- 
1.7.4.4

