From 923e8e6959a0366bedbf5a1bc84d6b0e74cbf2d0 Mon Sep 17 00:00:00 2001
From: Jan Kara <jack@suse.cz>
Date: Fri, 5 Jun 2015 14:09:56 +0100
Subject: [PATCH] udf: Check length of extended attributes and allocation
 descriptors

Check length of extended attributes and allocation descriptors when
loading inodes from disk. Otherwise corrupted filesystems could confuse
the code and make the kernel oops.

Reported-by: Carl Henrik Lunde <chlunde@ping.uio.no>
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara <jack@suse.cz>
(backported from commit 23b133bdc452aa441fcb9b82cbf6dd05cfd342d0)
CVE-2015-4167
BugLink: https://bugs.launchpad.net/bugs/1462173
[ luis: used Ben's backport to 3.16:
  - use make_bad_inode() instead of returning error ]
Signed-off-by: Luis Henriques <luis.henriques@canonical.com>
Acked-by: Tim Gardner <tim.gardner@canonical.com>
Acked-by: Seth Forshee <seth.forshee@canonical.com>
Signed-off-by: Brad Figg <brad.figg@canonical.com>
[PG: take backport from git://kernel.ubuntu.com/ubuntu/ubuntu-trusty.git ]
Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

diff --git a/fs/udf/inode.c b/fs/udf/inode.c
index 974ba547c0a1..31900f4d55f5 100644
--- a/fs/udf/inode.c
+++ b/fs/udf/inode.c
@@ -1503,6 +1503,19 @@ static void udf_fill_inode(struct inode *inode, struct buffer_head *bh)
 	if (udf_file_entry_alloc_offset(inode) + iinfo->i_lenAlloc > inode->i_sb->s_blocksize)
 		return;
 
+	/*
+	 * Sanity check length of allocation descriptors and extended attrs to
+	 * avoid integer overflows
+	 */
+	if (iinfo->i_lenEAttr > bs || iinfo->i_lenAlloc > bs) {
+		make_bad_inode(inode);
+		return;
+	}
+	/* Now do exact checks */
+	if (udf_file_entry_alloc_offset(inode) + iinfo->i_lenAlloc > bs) {
+		make_bad_inode(inode);
+		return;
+	}
 	/* Sanity checks for files in ICB so that we don't get confused later */
 	if (iinfo->i_alloc_type == ICBTAG_FLAG_AD_IN_ICB) {
 		/*
-- 
2.4.3

