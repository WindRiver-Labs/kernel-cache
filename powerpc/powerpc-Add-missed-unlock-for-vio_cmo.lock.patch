From e21efbd8d31621e2ed2ca62cdbe088ff1f5fb95e Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Wed, 7 Apr 2010 14:15:45 +0800
Subject: [PATCH] powerpc: Add missed unlock for vio_cmo.lock

The vio_cmo.lock is taken at the start of vio_cmo_set_dev_desired
but is not unlocked in the case of early exit. To fix it, we
add the unlock before the early return.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/powerpc/kernel/vio.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/kernel/vio.c b/arch/powerpc/kernel/vio.c
index 2750fba..243b272 100644
--- a/arch/powerpc/kernel/vio.c
+++ b/arch/powerpc/kernel/vio.c
@@ -642,8 +642,10 @@ void vio_cmo_set_dev_desired(struct vio_dev *viodev, size_t desired)
 			found = 1;
 			break;
 		}
-	if (!found)
+	if (!found){
+		spin_unlock_irqrestore(&vio_cmo.lock, flags);
 		return;
+	}
 
 	/* Increase/decrease in desired device entitlement */
 	if (desired >= viodev->cmo.desired) {
-- 
1.6.0.4

