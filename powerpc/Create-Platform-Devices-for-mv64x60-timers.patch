From fdda7c799528e2499c50e8bae84c5248bbb68822 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Thu, 25 Dec 2008 18:25:32 +0800
Subject: [PATCH] Create Platform Devices for mv64x60 timers

Add support for creating platform devices for mv64x60 timers
if the dtb describes them.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/sysdev/mv64x60_dev.c |   47 +++++++++++++++++++++++++++++++++++++
 1 files changed, 47 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/sysdev/mv64x60_dev.c b/arch/powerpc/sysdev/mv64x60_dev.c
index 32e0ad0..1305ac1 100644
--- a/arch/powerpc/sysdev/mv64x60_dev.c
+++ b/arch/powerpc/sysdev/mv64x60_dev.c
@@ -380,6 +380,44 @@ error:
 }
 
 /*
+ * Create mv64x60_timer platform devices
+ */
+static int __init mv64x60_timer_device_setup(struct device_node *np, int id)
+{
+        struct resource r[2];
+        struct platform_device *pdev;
+        int err = 0;
+        int irq = 0;
+
+        memset(r, 0, sizeof(r));
+
+        err = of_address_to_resource(np, 0, &r[0]);
+        if (err)
+                return err;
+
+        irq = of_irq_to_resource(np, 0, &r[1]);
+
+        pdev = platform_device_alloc("MV64X60-Timer", id);
+        if (!pdev)
+                return -ENOMEM;
+
+        err = platform_device_add_resources(pdev, r, 2);
+        if (err)
+                goto error;
+
+        err = platform_device_add(pdev);
+        if (err)
+                goto error;
+
+        return 0;
+
+error:
+        platform_device_put(pdev);
+        return err;
+}
+
+
+/*
  * Create mv64x60_wdt platform devices
  */
 static int __init mv64x60_wdt_device_setup(struct device_node *np, int id)
@@ -480,6 +518,15 @@ static int __init mv64x60_device_setup(void)
 					np->full_name, err);
 	}
 
+        id = 0;
+        for_each_compatible_node(np, "timer", "marvell,mv64360-timer") {
+                err = mv64x60_timer_device_setup(np, id++);
+                if (err)
+                        printk(KERN_ERR "Failed to initialize MV64x60 Timer "
+                                        "bus %s: error %d.\n",
+                                        np->full_name, err);
+        }
+
 	/* support up to one watchdog timer */
 	np = of_find_compatible_node(np, NULL, "marvell,mv64360-wdt");
 	if (np) {
-- 
1.6.0.3

