From c6e7afef7be9b8af872d25ca7ca7abbbff11333d Mon Sep 17 00:00:00 2001
From: Dave Liu <daveliu@freescale.com>
Date: Thu, 6 Nov 2008 11:59:28 +0800
Subject: [PATCH 3/5] powerpc/85xx: Fix the cache coherency issue on booting secondary core

Original patch taken from rev 1.1 board support ISO image for fsl_p4080.
[Known as P4080SW_01_01_00B-ltib.iso]

The TLB of secondary core is missing the memory global bit,
It will cause the issue as below when kick the secondary core.

mpic: requesting IPIs ...
waited 1000 msecs for CPU #1.
Processor 1 found.
Brought up 2 CPUs

Signed-off-by: Dave Liu <daveliu@freescale.com>
Signed-off-by: Kumar Gala <galak@kernel.crashing.org>
Integrated-by: Liang Li <liang.li@windriver.com>
---
 arch/powerpc/kernel/head_fsl_booke.S |    3 +++
 arch/powerpc/platforms/85xx/smp.c    |    2 +-
 2 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/kernel/head_fsl_booke.S b/arch/powerpc/kernel/head_fsl_booke.S
index 04a10b8..367c247 100644
--- a/arch/powerpc/kernel/head_fsl_booke.S
+++ b/arch/powerpc/kernel/head_fsl_booke.S
@@ -246,6 +246,9 @@ skpinv:	addi	r6,r6,1				/* Increment */
 	lis	r6,PAGE_OFFSET@h
 	ori	r6,r6,PAGE_OFFSET@l
 	rlwimi	r6,r7,0,20,31
+#ifdef CONFIG_SMP
+	ori	r6,r6,(MAS2_M)@l
+#endif
 	mtspr	SPRN_MAS2,r6
 	mtspr	SPRN_MAS3,r8
 	tlbwe
diff --git a/arch/powerpc/platforms/85xx/smp.c b/arch/powerpc/platforms/85xx/smp.c
index c91576a..c32f6ca 100644
--- a/arch/powerpc/platforms/85xx/smp.c
+++ b/arch/powerpc/platforms/85xx/smp.c
@@ -74,7 +74,7 @@ smp_85xx_kick_cpu(int nr)
 
 	local_irq_restore(flags);
 
-	pr_debug("waited %d msecs for CPU #%d.\n", nr, n);
+	pr_debug("waited %d msecs for CPU #%d.\n", n, nr);
 }
 
 static void __init
-- 
1.6.3.3

