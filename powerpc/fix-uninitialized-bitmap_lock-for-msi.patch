From d6516e0ad81198969144680effdc00c9ab092869 Mon Sep 17 00:00:00 2001
From: Lans Zhang <jia.zhang@windriver.com>
Date: Tue, 23 Mar 2010 12:32:28 +0800
Subject: [PATCH] fix uninitialized bitmap_lock for msi

[PATCH][powerpc]fix uninitialized bitmap_lock for msi

fsl_of_msi_probe() forgets to initialize bitmap_lock and thus triggers
a kernel bug as the following,

BUG: spinlock bad magic on CPU#0, swapper/1
  lock: ef929be0, .magic: 00000000, .owner: swapper/1, .owner_cpu: 0
Call Trace:
[ef831ce0] [c00085c8] show_stack+0x64/0x1a4 (unreliable)
[ef831d10] [c01e4ad0] spin_bug+0xa8/0xe0
[ef831d30] [c01e4b38] _raw_spin_unlock+0x30/0xbc
[ef831d40] [c03d05ac] _spin_unlock_irqrestore+0x18/0x54
[ef831d60] [c001a9f8] fsl_msi_free_hwirqs+0x70/0x94
[ef831d90] [c03d4050] fsl_of_msi_probe+0x174/0x3dc
[ef831de0] [c030e354] of_platform_device_probe+0x68/0xb8
[ef831e00] [c0229754] driver_probe_device+0xc4/0x218
[ef831e20] [c0228a30] bus_for_each_drv+0x7c/0xc4
[ef831e50] [c0229a20] device_attach+0x94/0xc0
[ef831e70] [c022843c] bus_attach_device+0x74/0x80
[ef831e80] [c0226fcc] device_add+0x5d4/0x694
[ef831ed0] [c030df70] of_device_register+0x24/0x34
[ef831ee0] [c000a33c] of_platform_device_create+0x44/0x74
[ef831ef0] [c000a3f4] of_platform_bus_create+0x88/0xf8
[ef831f10] [c000a574] of_platform_bus_probe+0x110/0x174
[ef831f30] [c04a309c] __machine_initcall_p2020_ds_mpc85xxds_publish_devices+0x4c/0x50
[ef831f40] [c0001d24] do_one_initcall+0x50/0x1c0
[ef831fb0] [c04942ec] kernel_init+0x1a8/0x230
[ef831ff0] [c00112a0] original_kernel_thread+0x44/0x60

Signed-off-by: Lans Zhang <jia.zhang@windriver.com>
---
 arch/powerpc/sysdev/fsl_msi.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/sysdev/fsl_msi.c b/arch/powerpc/sysdev/fsl_msi.c
index 2c5187c..7bb215d 100644
--- a/arch/powerpc/sysdev/fsl_msi.c
+++ b/arch/powerpc/sysdev/fsl_msi.c
@@ -317,6 +317,8 @@ static int __devinit fsl_of_msi_probe(struct of_device *dev,
 		goto error_out;
 	}
 
+	spin_lock_init(&msi->bitmap_lock);
+
 	msi->of_node = of_node_get(dev->node);
 
 	msi->irqhost = irq_alloc_host(of_node_get(dev->node),
-- 
1.6.0.4

