From 4c7575cbd3ef8207bdbcffa18337a48c4e63ddc5 Mon Sep 17 00:00:00 2001
From: Greg Moffatt <greg.moffatt@windriver.com>
Date: Mon, 2 Nov 2009 13:58:19 -0500
Subject: [PATCH] p4080ds: implement work-around for erratum CPU6

Do not enable interrupts right before the fourth (and final) call to tlbsync.

Erratum CPU6 says that ME, CE, DE, and EE cannot be enabled when executing a
tlbsync.  The kernel uses tlbsync four times during early boot-up.

A recent change in U-Boot ("ppc/85xx: Disable all async interrupt
sources when we boot") disabled all of these when the kernel boots, but
the kernel turns them back on right before the final call to tlbsync.
However, interrupts dont' need to be enabled at this point; and indeed,
the kernel redundantly enables them again a short time later.  So we
change the code not to enable interrupts right before that last tlbsync
instruction.

Signed-off-by: Timur Tabi <timur@freescale.com>

[ Hand merged to account for opcode changes in lines preceeding the
  change.
  Integrated-by: Greg Moffatt <greg.moffatt@windriver.com> ]
---
 arch/powerpc/kernel/head_fsl_booke.S |    3 +--
 1 files changed, 1 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/kernel/head_fsl_booke.S b/arch/powerpc/kernel/head_fsl_booke.S
index d0a1542..e4e2f3e 100644
--- a/arch/powerpc/kernel/head_fsl_booke.S
+++ b/arch/powerpc/kernel/head_fsl_booke.S
@@ -257,8 +257,7 @@ skpinv:	addi	r6,r6,1				/* Increment */
 	lis	r6,KERNELBASE@h
 	ori	r6,r6,KERNELBASE@l
 	rlwimi	r6,r7,0,20,31
-	lis	r7,MSR_KERNEL@h
-	ori	r7,r7,MSR_KERNEL@l
+	li	r7,0
 	bl	1f			/* Find our address */
 1:	mflr	r9
 	rlwimi	r6,r9,0,20,31
-- 
1.6.5.2

