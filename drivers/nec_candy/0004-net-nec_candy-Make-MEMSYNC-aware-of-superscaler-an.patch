From b611f4f9c1dc9dd3b5bb16da375f1565bcf819a0 Mon Sep 17 00:00:00 2001
From: Shinya Kuribayashi <shinya.kuribayashi@necel.com>
Date: Tue, 28 Apr 2009 14:12:06 +0900
Subject: [PATCH] net: nec_candy: Make MEMSYNC aware of superscaler and out-of-order

In case of VR5500A processor core based environment, you can't just emit
an uncached load operation to guarantee that all preceeding instructions
are completed.  A SYNC instruction following an uncached load operation
will take care of it.

This patch also changes a pointer type of `p' to unsigned long, as there
is no need for u32.

Signed-off-by: Shinya Kuribayashi <shinya.kuribayashi@necel.com>
---
 drivers/net/nec_candy.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/net/nec_candy.c b/drivers/net/nec_candy.c
index b8590fd..cde7f49 100644
--- a/drivers/net/nec_candy.c
+++ b/drivers/net/nec_candy.c
@@ -135,8 +135,9 @@ static struct candy_private *candy_priv_head;
 
 #define MEMSYNC(x)							\
 	do {								\
-		volatile u32 *p = (volatile u32 *)x;			\
+		volatile unsigned long *p = (unsigned long *)x;		\
 		(void)(*p);						\
+		__asm__ __volatile__("sync");				\
 	} while (0)
 
 /***********************************************************************
-- 
1.6.0.4

