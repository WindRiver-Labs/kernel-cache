From a27d6a3714c5ecd0356777f1e6746db4633fa55f Mon Sep 17 00:00:00 2001
From: Benjamin Walsh <benjamin.walsh@windriver.com>
Date: Mon, 11 May 2009 12:21:04 -0400
Subject: [PATCH] Enabling CGL on cav_ebt5800 - Fix redefinition of arch_align_stack() function

Fix redefinition of arch_align_stack() function

PaX redefines the function arch_align_stack to be a simpler
macro that does not do randomization. Remove function implementation.

Signed-off by: Benjamin Walsh <benjamin.walsh@windriver.com>
---
 arch/mips/kernel/process.c |   11 -----------
 include/asm-mips/system.h  |    7 ++++++-
 2 files changed, 6 insertions(+), 12 deletions(-)

diff --git a/arch/mips/kernel/process.c b/arch/mips/kernel/process.c
index 3685b6e..10e5303 100644
--- a/arch/mips/kernel/process.c
+++ b/arch/mips/kernel/process.c
@@ -465,14 +465,3 @@ out:
 	return pc;
 }
 
-/*
- * Don't forget that the stack pointer must be aligned on a 8 bytes
- * boundary for 32-bits ABI and 16 bytes for 64-bits ABI.
- */
-unsigned long arch_align_stack(unsigned long sp)
-{
-	if (!(current->personality & ADDR_NO_RANDOMIZE) && randomize_va_space)
-		sp -= get_random_int() & ~PAGE_MASK;
-
-	return sp & ALMASK;
-}
diff --git a/include/asm-mips/system.h b/include/asm-mips/system.h
index 9c5b6d1..5009e54 100644
--- a/include/asm-mips/system.h
+++ b/include/asm-mips/system.h
@@ -21,6 +21,7 @@
 #include <asm/cpu-features.h>
 #include <asm/dsp.h>
 #include <asm/war.h>
+#include <asm/asm.h>
 
 
 /*
@@ -215,6 +216,10 @@ extern void per_cpu_trap_init(void);
  */
 #define __ARCH_WANT_UNLOCKED_CTXSW
 
-#define arch_align_stack(x) (x)
+/*
+ * Don't forget that the stack pointer must be aligned on a 8 bytes
+ * boundary for 32-bits ABI and 16 bytes for 64-bits ABI.
+ */
+#define arch_align_stack(x) ((x) & ALMASK)
 
 #endif /* _ASM_SYSTEM_H */
-- 
1.6.0.4

