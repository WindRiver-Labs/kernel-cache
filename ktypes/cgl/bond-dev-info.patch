From 3354a539890fe8496dee5573de688ce59286f625 Mon Sep 17 00:00:00 2001
From: Yongli He <yongli.he@windriver.com>
Date: Thu, 24 Jul 2008 14:52:50 +0800
Subject: [PATCH] Bonding device info support

This provides the physical device the packet came in from
for a bonded ethernet device. (as ancillary data)

Signed-off-by: Liming Wang <liming.wang@windriver.com>
Integrated-by: Yongli he   <yongli.he@windriver.com>
---
 drivers/net/Kconfig    |    7 +++++++
 include/linux/skbuff.h |    3 +++
 net/8021q/vlan_core.c  |    4 ++++
 net/core/dev.c         |    3 +++
 net/packet/af_packet.c |   11 +++++++++++
 5 files changed, 28 insertions(+), 0 deletions(-)

diff --git a/drivers/net/Kconfig b/drivers/net/Kconfig
index 8a03875..75afe0f 100644
--- a/drivers/net/Kconfig
+++ b/drivers/net/Kconfig
@@ -90,6 +90,13 @@ config MACVLAN
 	  To compile this driver as a module, choose M here: the module
 	  will be called macvlan.
 
+config BONDING_DEVINFO
+	bool "Bonding driver device info support"
+	depends on BONDING
+	---help---
+	  This provides the physical device the packet came in from
+	  for a bonded ethernet device. (as ancillary data)
+
 config EQUALIZER
 	tristate "EQL (serial line load balancing) support"
 	---help---
diff --git a/include/linux/skbuff.h b/include/linux/skbuff.h
index cfcc45b..74ebf86 100644
--- a/include/linux/skbuff.h
+++ b/include/linux/skbuff.h
@@ -259,6 +259,9 @@ struct sk_buff {
 	ktime_t			tstamp;
 	struct net_device	*dev;
 
+#ifdef CONFIG_BONDING_DEVINFO
+	struct net_device	*real_dev;
+#endif
 	union {
 		struct  dst_entry	*dst;
 		struct  rtable		*rtable;
diff --git a/net/8021q/vlan_core.c b/net/8021q/vlan_core.c
index 916061f..82a47be 100644
--- a/net/8021q/vlan_core.c
+++ b/net/8021q/vlan_core.c
@@ -17,6 +17,10 @@ int __vlan_hwaccel_rx(struct sk_buff *skb, struct vlan_group *grp,
 	skb->vlan_tci = vlan_tci;
 	netif_nit_deliver(skb);
 
+#ifdef CONFIG_BONDING_DEVINFO
+	skb->real_dev = skb->dev;
+#endif
+
 	skb->dev = vlan_group_get_device(grp, vlan_tci & VLAN_VID_MASK);
 	if (skb->dev == NULL) {
 		dev_kfree_skb_any(skb);
diff --git a/net/core/dev.c b/net/core/dev.c
index 01993ad..7e961b3 100644
--- a/net/core/dev.c
+++ b/net/core/dev.c
@@ -1948,6 +1948,9 @@ static inline struct net_device *skb_bond(struct sk_buff *skb)
 			kfree_skb(skb);
 			return NULL;
 		}
+#ifdef CONFIG_BONDING_DEVINFO
+		skb->real_dev = skb->dev;
+#endif
 		skb->dev = dev->master;
 	}
 
diff --git a/net/packet/af_packet.c b/net/packet/af_packet.c
index c718e7e..97b428f 100644
--- a/net/packet/af_packet.c
+++ b/net/packet/af_packet.c
@@ -1102,6 +1102,9 @@ static int packet_recvmsg(struct kiocb *iocb, struct socket *sock,
 	struct sk_buff *skb;
 	int copied, err;
 	struct sockaddr_ll *sll;
+#ifdef CONFIG_BONDING_DEVINFO
+	int index = 0;
+#endif
 
 	err = -EINVAL;
 	if (flags & ~(MSG_PEEK|MSG_DONTWAIT|MSG_TRUNC|MSG_CMSG_COMPAT))
@@ -1162,6 +1165,14 @@ static int packet_recvmsg(struct kiocb *iocb, struct socket *sock,
 
 	sock_recv_timestamp(msg, sk, skb);
 
+#ifdef CONFIG_BONDING_DEVINFO
+	if (msg->msg_controllen == 16 && msg->msg_control != NULL &&
+	    ((struct cmsghdr *)msg->msg_control)->cmsg_type == IP_PKTINFO) {
+		if (skb->real_dev)
+			index = skb->real_dev->ifindex;
+		put_cmsg(msg, SOL_SOCKET, IP_PKTINFO, sizeof(int), &index);
+	}
+#endif
 	if (msg->msg_name)
 		memcpy(msg->msg_name, &PACKET_SKB_CB(skb)->sa,
 		       msg->msg_namelen);
-- 
1.5.5.1

