From ed9c5f029253f2665ae5fcd745b648cded6a8365 Mon Sep 17 00:00:00 2001
From: Zhenbo Gao <zhenbo.gao@windriver.com>
Date: Thu, 1 Sep 2016 09:48:38 +0800
Subject: [PATCH] grsec: correct the domain of function setup_pcid()

function setup_pcid() is only used when macros
CONFIG_X86_64 and CONFIG_PAX_MEMORY_UDEREF are defined

This issue is introduced by commit id
45f445edce9326aa3885cbe9113a9aabedb55331

Signed-off-by: Zhenbo Gao <zhenbo.gao@windriver.com>
---
 arch/x86/kernel/cpu/common.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/arch/x86/kernel/cpu/common.c b/arch/x86/kernel/cpu/common.c
index 77c8929..e0e4f77 100644
--- a/arch/x86/kernel/cpu/common.c
+++ b/arch/x86/kernel/cpu/common.c
@@ -371,6 +371,7 @@ static __init int setup_disable_pcid(char *arg)
 }
 __setup("nopcid", setup_disable_pcid);
 
+#ifdef CONFIG_PAX_MEMORY_UDEREF
 static void setup_pcid(struct cpuinfo_x86 *c)
 {
 	if (cpu_has(c, X86_FEATURE_PCID)) {
@@ -382,7 +383,6 @@ static void setup_pcid(struct cpuinfo_x86 *c)
 	if (cpu_has(c, X86_FEATURE_INVPCID))
 		printk("PAX: INVPCID detected\n");
 
-#ifdef CONFIG_PAX_MEMORY_UDEREF
 	if (!uderef_enabled) {
 		printk("PAX: UDEREF disabled\n");
 		return;
@@ -407,10 +407,10 @@ static void setup_pcid(struct cpuinfo_x86 *c)
 		set_cpu_cap(c, X86_FEATURE_STRONGUDEREF);
 		printk("PAX: strong UDEREF enabled\n");
 	}
-#endif
 
 }
 #endif
+#endif
 
 /*
  * Some CPU features depend on higher CPUID levels, which may not always
-- 
1.7.5.4

