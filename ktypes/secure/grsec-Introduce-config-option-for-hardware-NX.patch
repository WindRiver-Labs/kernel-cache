From 39c485c97901c297c90ee87a5e844a5d8dad4a37 Mon Sep 17 00:00:00 2001
From: Han Chao <chan@windriver.com>
Date: Mon, 17 Mar 2014 16:09:20 +0800
Subject: [PATCH 1/3] grsec: Introduce config option for hardware NX

Due to potential performance impacts on P4-based systems, PAX rules out
the possibility of hardware-based paging on x86_32 systems entirely.  So
long as there is actual hardware-based paging, however, the impact is
negligible, therefore we will provide an option to get NX back on through
Kconfig.

Signed-off-by: Joe MacDonald <joe.macdonald@windriver.com>
Signed-off-by: Han Chao <chan@windriver.com>
Signed-off-by: Jianchuan Wang <jianchuan.wang@windriver.com>
---
 arch/x86/Kconfig |   13 +++++++++++++
 security/Kconfig |    2 +-
 2 files changed, 14 insertions(+), 1 deletions(-)

diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig
index 32b57cf..1106c58 100644
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@ -328,6 +328,19 @@ config SMP
 
 	  If you don't know what to do here, say N.
 
+config ARCH_HAS_HW_NX
+	bool "Platform has hardware-based Execute-Disable (NX)"
+	default n if X86_32
+	default y if X86_64
+	help
+	  If your target platform has hardware-based Execute Disable, also called
+	  No-eXecute, NX, Enhanced Virus Protection (AMD), or eXecute-Never (XN)
+	  on ARM platforms, and you wish to make use of this feature, you should
+	  say 'y' here.
+
+	  If your platform does not have some sort of hardware-based write-or-
+	  exeucte support, you should say 'n' here.
+
 config X86_FEATURE_NAMES
 	bool "Processor feature human-readable names" if EMBEDDED
 	default y
diff --git a/security/Kconfig b/security/Kconfig
index 5c2f77a..0a6dbd4 100644
--- a/security/Kconfig
+++ b/security/Kconfig
@@ -121,7 +121,7 @@ config PAX_NOEXEC
 config PAX_PAGEEXEC
 	bool "Paging based non-executable pages"
 	default y if GRKERNSEC_ALL
-	depends on PAX_NOEXEC && (!X86_32 || M586 || M586TSC || M586MMX || M686 || MPENTIUMII || MPENTIUMIII || MPENTIUMM || MCORE2 || MATOM || MPENTIUM4 || MPSC || MK7 || MK8 || MWINCHIPC6 || MWINCHIP2 || MWINCHIP3D || MVIAC3_2 || MVIAC7)
+	depends on PAX_NOEXEC &&(ARCH_HAS_HW_NX || (!X86_32 || M586 || M586TSC || M586MMX || M686 || MPENTIUMII || MPENTIUMIII || MPENTIUMM || MCORE2 || MATOM || MPENTIUM4 || MPSC || MK7 || MK8 || MWINCHIPC6 || MWINCHIP2 || MWINCHIP3D || MVIAC3_2 || MVIAC7))
 	select ARCH_TRACK_EXEC_LIMIT if X86_32
 	help
 	  This implementation is based on the paging feature of the CPU.
-- 
1.7.5.4

