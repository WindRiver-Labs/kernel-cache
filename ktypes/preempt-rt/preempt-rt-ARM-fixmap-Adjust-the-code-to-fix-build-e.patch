From 7d5b2e9d55b1c7c241fe8b8c217d6051911f5b64 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Fri, 1 Aug 2014 14:33:11 +0800
Subject: [PATCH] preempt-rt: ARM: fixmap: Adjust the code to fix build error

Since commit 74ab820407e and e0cae11e7 change the fixmap mapping
region. Adust the CONFIG_PREEMPT_RT_FULL code to fix the build error.

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mm/highmem.c |    9 ++++-----
 1 files changed, 4 insertions(+), 5 deletions(-)

diff --git a/arch/arm/mm/highmem.c b/arch/arm/mm/highmem.c
index 045af49..189c78b 100644
--- a/arch/arm/mm/highmem.c
+++ b/arch/arm/mm/highmem.c
@@ -95,7 +95,7 @@ void *kmap_atomic(struct page *page)
 #ifdef CONFIG_PREEMPT_RT_FULL
 	current->kmap_pte[type] = pte;
 #endif
-	set_fixmap_pte(idx, mk_pte(page, kmap_prot));
+	set_fixmap_pte(idx, pte);
 
 	return (void *)vaddr;
 }
@@ -147,7 +147,7 @@ void *kmap_atomic_pfn(unsigned long pfn)
 #ifdef CONFIG_PREEMPT_RT_FULL
 	current->kmap_pte[type] = pte;
 #endif
-	set_fixmap_pte(idx, pfn_pte(pfn, kmap_prot));
+	set_fixmap_pte(idx, pte);
 
 	return (void *)vaddr;
 }
@@ -173,7 +173,7 @@ void switch_kmaps(struct task_struct *prev_p, struct task_struct *next_p)
 	for (i = 0; i < prev_p->kmap_idx; i++) {
 		int idx = i + KM_TYPE_NR * smp_processor_id();
 
-		set_top_pte(__fix_to_virt(FIX_KMAP_BEGIN + idx), __pte(0));
+		set_top_pte(idx, __pte(0));
 	}
 	/*
 	 * Restore @next_p's kmap_atomic mappings
@@ -182,8 +182,7 @@ void switch_kmaps(struct task_struct *prev_p, struct task_struct *next_p)
 		int idx = i + KM_TYPE_NR * smp_processor_id();
 
 		if (!pte_none(next_p->kmap_pte[i]))
-			set_top_pte(__fix_to_virt(FIX_KMAP_BEGIN + idx),
-					next_p->kmap_pte[i]);
+			set_top_pte(idx, next_p->kmap_pte[i]);
 	}
 }
 #endif
-- 
1.7.5.4

