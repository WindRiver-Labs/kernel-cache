From df593fdaddfabfcb7b0d2570f8da6ec04d86e665 Mon Sep 17 00:00:00 2001
From: Liwei Song <liwei.song@windriver.com>
Date: Mon, 24 Aug 2015 16:33:21 +0800
Subject: [PATCH] Revert "rt: cpufreq: check whether cpufreq_rwsem is locked
 before trying to acquire it"

it led the follwing error:
cat: /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_cur_freq: Invalid argument

this commit is use to avoid rwsem nest in cpufreq, but the commit
f0c8e4837(Revert "rwsem-rt: Do not allow readers to nest")has clear that
it is a right logic , Lockdep will check if one try a read_lock twice in
RT kernel. We needn't this patch in cpufreq any more.
so revert the commit for the right logic in cpufreq as it is;

Signed-off-by: Liwei Song <liwei.song@windriver.com>
---
 drivers/cpufreq/cpufreq.c |    7 ++-----
 1 files changed, 2 insertions(+), 5 deletions(-)

diff --git a/drivers/cpufreq/cpufreq.c b/drivers/cpufreq/cpufreq.c
index a1e1550..5d239bc 100644
--- a/drivers/cpufreq/cpufreq.c
+++ b/drivers/cpufreq/cpufreq.c
@@ -198,11 +198,8 @@ struct cpufreq_policy *cpufreq_cpu_get(unsigned int cpu)
 	if (cpufreq_disabled() || (cpu >= nr_cpu_ids))
 		return NULL;
 
-	/* rwse is disallowed nest on -rt kernel */
-	if (!rwsem_is_locked(&cpufreq_rwsem)) {
-		if (!down_read_trylock(&cpufreq_rwsem))
-			return NULL;
-	}
+	if (!down_read_trylock(&cpufreq_rwsem))
+		return NULL;
 
 	/* get the cpufreq driver */
 	read_lock_irqsave(&cpufreq_driver_lock, flags);
-- 
1.7.5.4

