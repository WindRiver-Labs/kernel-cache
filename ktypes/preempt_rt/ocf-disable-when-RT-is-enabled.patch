From aa33baa1a81612f24f4898e0ec1c1fc8b017951e Mon Sep 17 00:00:00 2001
From: Mark Asselstine <mark.asselstine@windriver.com>
Date: Mon, 13 Jun 2011 14:39:49 -0400
Subject: [PATCH] ocf: disable when RT is enabled

OCF does not have any protection for read and writes for two
key structs (cryptop and cryptkop) yet has two kthreads which
operate on these, making it not very preemption safe. This causes
kernel Oops for example when running kftp OCF tests
/opt/kftp/testcases/ocf/runtest.sh

ast sysfs file: /sys/devices/virtual/misc/crypto/uevent
Modules linked in: binfmt_misc ipv6 ocf(P) cryptodev(P) ...
NIP: c00399d4 LR: c0044ed0 CTR: c0044e84
REGS: ef8f5ce0 TRAP: 0300   Tainted: P (2.6.34.8-rt-WR4.2.0.0_preempt_rt)
MSR: 00029000 <EE,ME,CE>  CR: 24282028  XER: 20000000
DEAR: 00000000, ESR: 00000000
TASK = ef8cf040[25] 'sirq-tasklet/1' THREAD: ef8f4000 CPU: 1
GPR00: c0044ed0 ef8f5d90 ef8cf040 ece1f9c8 00000002 00000001 00000001 00000000
GPR08: c07bc09c fffffff4 00000000 ef8f5dc0 24282024 fba16c17 00000004 c082ee10
GPR16: c082ee30 ef35a30c c06c4f8c eeded8d8 eed54500 c04e4a4c ff000000 00000000
GPR24: 00000000 00000000 ef3fda90 f2b8d958 00000001 00000002 ece1f9e8 ef8f5d90
NIP [c00399d4] __wake_up_common+0x40/0xbc
LR [c0044ed0] __wake_up+0x4c/0x6c
Call Trace:
[ef8f5d90] [ef8f5d94] 0xef8f5d94 (unreliable)
[ef8f5dc0] [c0044ed0] __wake_up+0x4c/0x6c
[ef8f5de0] [f2bcd434] cryptodev_cb+0x74/0xc8 [cryptodev]
[ef8f5e00] [f2b88350] crypto_done+0x12c/0x220 [ocf]
[ef8f5e20] [f2c0228c] swcr_process_callback+0x74/0x190 [cryptosoft]

We therefor are disabling OCF when building RT.

Signed-off-by: Mark Asselstine <mark.asselstine@windriver.com>
---
 crypto/ocf/Kconfig |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/crypto/ocf/Kconfig b/crypto/ocf/Kconfig
index 07736ad..82a4263 100644
--- a/crypto/ocf/Kconfig
+++ b/crypto/ocf/Kconfig
@@ -2,6 +2,7 @@ menu "OCF Configuration"
 
 config OCF_OCF
 	tristate "OCF (Open Cryptograhic Framework)"
+	depends on !PREEMPT_RT
 	help
 	  A linux port of the OpenBSD/FreeBSD crypto framework.
 
-- 
1.7.0.4

