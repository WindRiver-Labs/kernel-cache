From 41d83fa41fe7911799ec7fa5e29a958da34f0ec6 Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Wed, 11 May 2011 13:18:48 +0800
Subject: [PATCH] rt_optimize: MMC replace local_irq* by local_irq*_nort

hard irq is threaded in preempt_rt kernel, so we don't need
local_irq_save and local_irq_restore somewhere anymore. Here
usb local_irq*_nort to replace them in order to reduce irq
disable times.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 drivers/mmc/card/queue.c |    8 ++++----
 drivers/mmc/host/sdhci.c |   12 ++++++------
 2 files changed, 10 insertions(+), 10 deletions(-)

diff --git a/drivers/mmc/card/queue.c b/drivers/mmc/card/queue.c
index d6ded24..44b5faa 100644
--- a/drivers/mmc/card/queue.c
+++ b/drivers/mmc/card/queue.c
@@ -336,10 +336,10 @@ void mmc_queue_bounce_pre(struct mmc_queue *mq)
 	if (rq_data_dir(mq->req) != WRITE)
 		return;
 
-	local_irq_save(flags);
+	local_irq_save_nort(flags);
 	sg_copy_to_buffer(mq->bounce_sg, mq->bounce_sg_len,
 		mq->bounce_buf, mq->sg[0].length);
-	local_irq_restore(flags);
+	local_irq_restore_nort(flags);
 }
 
 /*
@@ -356,9 +356,9 @@ void mmc_queue_bounce_post(struct mmc_queue *mq)
 	if (rq_data_dir(mq->req) != READ)
 		return;
 
-	local_irq_save(flags);
+	local_irq_save_nort(flags);
 	sg_copy_from_buffer(mq->bounce_sg, mq->bounce_sg_len,
 		mq->bounce_buf, mq->sg[0].length);
-	local_irq_restore(flags);
+	local_irq_restore_nort(flags);
 }
 
diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.c
index 79a21ba..337468b 100644
--- a/drivers/mmc/host/sdhci.c
+++ b/drivers/mmc/host/sdhci.c
@@ -257,7 +257,7 @@ static void sdhci_read_block_pio(struct sdhci_host *host)
 	blksize = host->data->blksz;
 	chunk = 0;
 
-	local_irq_save(flags);
+	local_irq_save_nort(flags);
 
 	while (blksize) {
 		if (!sg_miter_next(&host->sg_miter))
@@ -287,7 +287,7 @@ static void sdhci_read_block_pio(struct sdhci_host *host)
 
 	sg_miter_stop(&host->sg_miter);
 
-	local_irq_restore(flags);
+	local_irq_restore_nort(flags);
 }
 
 static void sdhci_write_block_pio(struct sdhci_host *host)
@@ -303,7 +303,7 @@ static void sdhci_write_block_pio(struct sdhci_host *host)
 	chunk = 0;
 	scratch = 0;
 
-	local_irq_save(flags);
+	local_irq_save_nort(flags);
 
 	while (blksize) {
 		if (!sg_miter_next(&host->sg_miter))
@@ -333,7 +333,7 @@ static void sdhci_write_block_pio(struct sdhci_host *host)
 
 	sg_miter_stop(&host->sg_miter);
 
-	local_irq_restore(flags);
+	local_irq_restore_nort(flags);
 }
 
 static void sdhci_transfer_pio(struct sdhci_host *host)
@@ -378,14 +378,14 @@ static void sdhci_transfer_pio(struct sdhci_host *host)
 
 static char *sdhci_kmap_atomic(struct scatterlist *sg, unsigned long *flags)
 {
-	local_irq_save(*flags);
+	local_irq_save_nort(*flags);
 	return kmap_atomic(sg_page(sg), KM_BIO_SRC_IRQ) + sg->offset;
 }
 
 static void sdhci_kunmap_atomic(void *buffer, unsigned long *flags)
 {
 	kunmap_atomic(buffer, KM_BIO_SRC_IRQ);
-	local_irq_restore(*flags);
+	local_irq_restore_nort(*flags);
 }
 
 static void sdhci_set_adma_desc(u8 *desc, u32 addr, int len, unsigned cmd)
-- 
1.7.4.4

