From 28f57109fe33b43c75dcb5084f54fdb419334a41 Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Mon, 21 Feb 2011 12:47:46 -0500
Subject: [PATCH] vmstat: revert delayed local var init changes.

Compared to mainline kernel.org, the initialization of the local vars
pcp and p* was delayed so that a preempt_disable() could be inserted
prior to the use of this_cpu_ptr.

This makes for a big footprint change, when instead, simply replacing
the this_cpu_ptr() with a per_cpu_ptr(... , get_cpu()) will achieve
the exact same thing in a one-line change.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
---
 mm/vmstat.c |   30 +++++++++---------------------
 1 files changed, 9 insertions(+), 21 deletions(-)

diff --git a/mm/vmstat.c b/mm/vmstat.c
index b27a853..280eee0 100644
--- a/mm/vmstat.c
+++ b/mm/vmstat.c
@@ -164,13 +164,9 @@ static void refresh_zone_stat_thresholds(void)
 void __mod_zone_page_state(struct zone *zone, enum zone_stat_item item,
 				int delta)
 {
-	s8 *p;
+	struct per_cpu_pageset *pcp = per_cpu_ptr(zone->pageset, get_cpu());
+	s8 *p = pcp->vm_stat_diff + item;
 	long x;
-	struct per_cpu_pageset *pcp;
-	
-	preempt_disable();
-	pcp = this_cpu_ptr(zone->pageset);
-	p = pcp->vm_stat_diff + item;
 
 	x = delta + *p;
 
@@ -179,7 +175,7 @@ void __mod_zone_page_state(struct zone *zone, enum zone_stat_item item,
 		x = 0;
 	}
 	*p = x;
-	preempt_enable();
+	put_cpu();
 }
 EXPORT_SYMBOL(__mod_zone_page_state);
 
@@ -222,12 +218,8 @@ EXPORT_SYMBOL(mod_zone_page_state);
  */
 void __inc_zone_state(struct zone *zone, enum zone_stat_item item)
 {
-	s8 *p;
-	struct per_cpu_pageset *pcp;
-	
-	preempt_disable();
-	pcp = this_cpu_ptr(zone->pageset);
-	p = pcp->vm_stat_diff + item;
+	struct per_cpu_pageset *pcp = per_cpu_ptr(zone->pageset, get_cpu());
+	s8 *p = pcp->vm_stat_diff + item;
 
 	(*p)++;
 
@@ -237,7 +229,7 @@ void __inc_zone_state(struct zone *zone, enum zone_stat_item item)
 		zone_page_state_add(*p + overstep, zone, item);
 		*p = -overstep;
 	}
-	preempt_enable();
+	put_cpu();
 }
 
 void __inc_zone_page_state(struct page *page, enum zone_stat_item item)
@@ -258,12 +250,8 @@ EXPORT_SYMBOL(__inc_zone_page_state);
 
 void __dec_zone_state(struct zone *zone, enum zone_stat_item item)
 {
-	s8 *p;
-	struct per_cpu_pageset *pcp;
-	
-	preempt_disable();
-	pcp = this_cpu_ptr(zone->pageset);
-	p = pcp->vm_stat_diff + item;
+	struct per_cpu_pageset *pcp = per_cpu_ptr(zone->pageset, get_cpu());
+	s8 *p = pcp->vm_stat_diff + item;
 
 	(*p)--;
 
@@ -273,7 +261,7 @@ void __dec_zone_state(struct zone *zone, enum zone_stat_item item)
 		zone_page_state_add(*p - overstep, zone, item);
 		*p = overstep;
 	}
-	preempt_enable();
+	put_cpu();
 }
 
 void __dec_zone_page_state(struct page *page, enum zone_stat_item item)
-- 
1.7.4

