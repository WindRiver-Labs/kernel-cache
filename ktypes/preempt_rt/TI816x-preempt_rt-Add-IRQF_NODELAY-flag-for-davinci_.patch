From 49e0f8816b80c013956d11752181cc445dec471f Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Mon, 4 Jul 2011 09:50:46 +0800
Subject: [PATCH] TI816x preempt_rt: Add IRQF_NODELAY flag for davinci_emac isr

In davinci emac driver, ISR does a little task(disable interrupt
and record isr_count), after that it will schedule napi poll function
which is the place to handle rx/tx packet.

In rt kernel, we need to add IRQF_NODELAY flag to make sure davinci_emac
ISR  can't be thread, otherwise system can't mount nfs successfully which
is due to the isr will be schedule at that point. Since the ISR doesn't
handle packet, it will not cause lots of latency problem after add the flag.

Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 drivers/net/davinci_emac.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/net/davinci_emac.c b/drivers/net/davinci_emac.c
index 99b1983..e0dee5f 100644
--- a/drivers/net/davinci_emac.c
+++ b/drivers/net/davinci_emac.c
@@ -2446,8 +2446,8 @@ static int emac_dev_open(struct net_device *ndev)
 
 	while ((res = platform_get_resource(priv->pdev, IORESOURCE_IRQ, k))) {
 		for (i = res->start; i <= res->end; i++) {
-			if (request_irq(i, emac_irq, IRQF_DISABLED,
-					ndev->name, ndev))
+			if (request_irq(i, emac_irq, IRQF_DISABLED | \
+					IRQF_NODELAY, ndev->name, ndev))
 				goto rollback;
 #ifdef CONFIG_ARCH_TI816X
 			priv->irqs_table[irq_num++] = i;
-- 
1.7.0.4

