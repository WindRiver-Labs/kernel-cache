From 3cfe7881bbfb5419ba43ab6075186591b38804b6 Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Tue, 1 Mar 2011 12:07:20 -0500
Subject: [PATCH] rt: fix cwq assignment in workqueue.c

The big merge forward in tip to 33-rc8 at 5f854cfc (aka the CFC
merge) does this:

+              int cpu = raw_smp_processor_id();
-              cwq = wq_per_cpu(keventd_wq, get_cpu());
+              cwq = wq_per_cpu(keventd_wq, cpu);
               __queue_work(cwq, &dwork->work);
-              put_cpu();

In the context of 2.6.34, the default lines of kernel.org code are:

                cwq = wq_per_cpu(get_wq_data(&dwork->work)->wq, get_cpu());
                __queue_work(cwq, &dwork->work);
                put_cpu();

Hence the proper merge should result in:

                int cpu = raw_smp_processor_id();
                cwq = wq_per_cpu(get_wq_data(&dwork->work)->wq, cpu);
                __queue_work(cwq, &dwork->work);

Fix the cwq assignment to match the above.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
---
 kernel/workqueue.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/kernel/workqueue.c b/kernel/workqueue.c
index 26b8839..abc7af1 100644
--- a/kernel/workqueue.c
+++ b/kernel/workqueue.c
@@ -779,7 +779,7 @@ void flush_delayed_work(struct delayed_work *dwork)
 	if (del_timer_sync(&dwork->timer)) {
 		struct cpu_workqueue_struct *cwq;
 		int cpu = raw_smp_processor_id();
-		cwq = wq_per_cpu(keventd_wq, cpu);
+		cwq = wq_per_cpu(get_wq_data(&dwork->work)->wq, cpu);
 		__queue_work(cwq, &dwork->work);
 	}
 	flush_work(&dwork->work);
-- 
1.7.4

