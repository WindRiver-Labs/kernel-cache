From 725d54dee2623d5c46a4db95bd52491447c87b17 Mon Sep 17 00:00:00 2001
From: Thomas Gleixner <tglx@linutronix.de>
Date: Fri, 3 Sep 2010 00:07:37 -0700
Subject: [PATCH 24/27] powerpc: cpu-hotplug: Prevent softirq wakeup on wrong CPU

(cherry picked from tip commit 59fdcc01a4952a521dbae619254d1d4e3f0651e7)

When the plugged CPU sets the online flag it enables interrupts and
goes idle. When an interrupt happens and tried to wakeup a softirq
thread before the other cpu sets the active flag, then the softirq
thread is put on one of the active cpus. Prevent this by waiting for
the cpu_active bit.

Temporary workaround. Needs more thought.

Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
---
 arch/powerpc/kernel/smp.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/smp.c b/arch/powerpc/kernel/smp.c
index 3a8c805..c46ace3 100644
--- a/arch/powerpc/kernel/smp.c
+++ b/arch/powerpc/kernel/smp.c
@@ -551,6 +551,9 @@ int __devinit start_secondary(void *unused)
 	of_node_put(l2_cache);
 	ipi_call_unlock();
 
+	while (!cpumask_test_cpu(smp_processor_id(), cpu_active_mask))
+		cpu_relax();
+
 	local_irq_enable();
 
 	cpu_idle();
-- 
1.6.5.2

