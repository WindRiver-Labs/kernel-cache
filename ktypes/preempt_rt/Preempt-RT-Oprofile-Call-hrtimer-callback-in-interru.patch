From 8b8c7459aa324bba22bdd9f07d3fa50309f8b0c6 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Tue, 11 Oct 2011 15:47:04 +0800
Subject: [PATCH] Preempt-RT:Oprofile:Call hrtimer callback in interrupt context

Oprofile needs to get sample in an IRQ context. When oprofile working
in timer mode, it is driven by a hrtimer, and gets sample in the
hrtimer's callback routine. The callback must involved in an IRQ
context.

In preempt-rt, the callback of hrtimer called from the timer interrupt
context only if the timer set the irqsafe flag.

The patch sets the irqsafe flag for oprofile's hrtimer to make sure
the callback working in an IRQ context.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/oprofile/timer_int.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/oprofile/timer_int.c b/drivers/oprofile/timer_int.c
index dc0ae4d..57029ae 100644
--- a/drivers/oprofile/timer_int.c
+++ b/drivers/oprofile/timer_int.c
@@ -34,6 +34,7 @@ static void __oprofile_hrtimer_start(void *unused)
 	struct hrtimer *hrtimer = &__get_cpu_var(oprofile_hrtimer);
 
 	hrtimer_init(hrtimer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);
+	hrtimer->irqsafe = 1;
 	hrtimer->function = oprofile_hrtimer_notify;
 
 	hrtimer_start(hrtimer, ns_to_ktime(TICK_NSEC),
-- 
1.7.0.4

