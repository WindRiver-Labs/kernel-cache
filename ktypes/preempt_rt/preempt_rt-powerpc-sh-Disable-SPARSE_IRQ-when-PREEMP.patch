From 5a1728b61960545fd0a99c0273c0ab750d32ea4a Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Sun, 25 Jul 2010 19:36:15 -0700
Subject: [PATCH] preempt_rt: powerpc, sh: Disable SPARSE_IRQ when PREEMPT_RT=y

Memory allocations in irq/preempt disabled regions have introduced "BUG:
sleeping function called from invalid context". As the commit "x86: Disable
SPARSE_IRQ, DMAR, INTR_REMAP when PREEMPT_RT=y" from 2.6.31-rt11 did, before
the real work for fixing the problem comes, we just disable this feature.

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/powerpc/Kconfig |    1 +
 arch/sh/Kconfig      |    1 +
 2 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/Kconfig b/arch/powerpc/Kconfig
index b33a75f..6816e31 100644
--- a/arch/powerpc/Kconfig
+++ b/arch/powerpc/Kconfig
@@ -425,6 +425,7 @@ config IRQ_ALL_CPUS
 
 config SPARSE_IRQ
 	bool "Support sparse irq numbering"
+	depends on !PREEMPT_RT
 	default y
 	help
 	  This enables support for sparse irqs. This is useful for distro
diff --git a/arch/sh/Kconfig b/arch/sh/Kconfig
index 14eb666..e6a9108 100644
--- a/arch/sh/Kconfig
+++ b/arch/sh/Kconfig
@@ -87,6 +87,7 @@ config IRQ_PER_CPU
 config SPARSE_IRQ
 	def_bool y
 	depends on SUPERH32
+	depends on !PREEMPT_RT
 
 config GENERIC_GPIO
 	def_bool n
-- 
1.6.5.2

