From 499973ccef335a25c861a9e24c170acf6ce1b122 Mon Sep 17 00:00:00 2001
From: Mark Asselstine <mark.asselstine@windriver.com>
Date: Thu, 3 Jun 2010 15:42:03 -0400
Subject: [PATCH] Updates to unionfs to support preempt-rt

Although there is evidence that unionfs has been written to
behave well will preempt-rt there have been recent changes to
preempt-rt which require further coding changes in unionfs to
allow things to build and function correctly. Here we incorporate
the changes to the inode i_count and inode locking.

There was also a #define used for unionfs_rw_semaphore which was
designed for previous versions of preempt-rt which made use of
compat-rw-semaphore which is no longer required. Cleaned this
out.

Signed-off-by: Mark Asselstine <mark.asselstine@windriver.com>
----

diff --git a/fs/unionfs/union.h b/fs/unionfs/union.h
index 99335a3..73ab5ea 100644
--- a/fs/unionfs/union.h
+++ b/fs/unionfs/union.h
@@ -81,13 +81,6 @@ extern struct vm_operations_struct unionfs_vm_ops;
 /* How long should an entry be allowed to persist */
 #define RDCACHE_JIFFIES	(5*HZ)
 
-/* compatibility with Real-Time patches */
-#ifdef CONFIG_PREEMPT_RT
-# define unionfs_rw_semaphore	compat_rw_semaphore
-#else /* not CONFIG_PREEMPT_RT */
-# define unionfs_rw_semaphore	rw_semaphore
-#endif /* not CONFIG_PREEMPT_RT */
-
 /* file private data. */
 struct unionfs_file_info {
 	int bstart;
@@ -163,7 +156,7 @@ struct unionfs_sb_info {
 	 * branch-management is used on a pivot_root'ed union, because we
 	 * have to ->lookup paths which belong to the same union.
 	 */
-	struct unionfs_rw_semaphore rwsem;
+	struct rw_semaphore rwsem;
 	pid_t write_lock_owner;	/* PID of rw_sem owner (write lock) */
 	int high_branch_id;	/* last unique branch ID given */
 	char *dev_name;		/* to identify different unions in pr_debug */
