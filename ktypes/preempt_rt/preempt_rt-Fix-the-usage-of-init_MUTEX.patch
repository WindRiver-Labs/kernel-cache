From 74eeb7bd4f4a1ca750d9e888e067011c81eb9921 Mon Sep 17 00:00:00 2001
From: Mark Asselstine <mark.asselstine@windriver.com>
Date: Fri, 13 Aug 2010 06:24:21 -0700
Subject: [PATCH] preempt_rt: Fix the usage of init_MUTEX*

init_MUTEX* should be converted to sema_init() in preempt_rt, this patch
fixes all of the related usage.

Without this patch, we may get the error of "implicit declaration of
function 'init_MUTEX'".

And a wrong usage of sema_init() is fixed in this patch too.

Signed-off-by: Mark Asselstine <mark.asselstine@windriver.com>
Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 drivers/staging/comedi/drivers/usbdux.c |    2 +-
 fs/xfs/linux-2.6/xfs_buf.c              |    2 +-
 fs/yaffs2/yaffs_fs.c                    |    4 ++--
 3 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/staging/comedi/drivers/usbdux.c b/drivers/staging/comedi/drivers/usbdux.c
index d0a3710..c769f3d 100644
--- a/drivers/staging/comedi/drivers/usbdux.c
+++ b/drivers/staging/comedi/drivers/usbdux.c
@@ -2369,7 +2369,7 @@ static int usbduxsub_probe(struct usb_interface *uinterf,
 	dev_dbg(dev, "comedi_: usbdux: "
 		"usbduxsub[%d] is ready to connect to comedi.\n", index);
 
-	sema_init(&(usbduxsub[index].sem)), 1;
+	sema_init(&(usbduxsub[index].sem), 1);
 	/* save a pointer to the usb device */
 	usbduxsub[index].usbdev = udev;
 
diff --git a/fs/xfs/linux-2.6/xfs_buf.c b/fs/xfs/linux-2.6/xfs_buf.c
index 44c2b0e..845f9a3 100644
--- a/fs/xfs/linux-2.6/xfs_buf.c
+++ b/fs/xfs/linux-2.6/xfs_buf.c
@@ -189,7 +189,7 @@ _xfs_buf_initialize(
 	init_completion(&bp->b_iowait);
 	INIT_LIST_HEAD(&bp->b_list);
 	INIT_LIST_HEAD(&bp->b_hash_list);
-	init_MUTEX_LOCKED(&bp->b_sema); /* held, no waiters */
+	sema_init(&bp->b_sema, 0); /* held, no waiters */
 	XB_SET_OWNER(bp);
 	bp->b_target = target;
 	bp->b_file_offset = range_base;
diff --git a/fs/yaffs2/yaffs_fs.c b/fs/yaffs2/yaffs_fs.c
index 921929d..081f4c3 100644
--- a/fs/yaffs2/yaffs_fs.c
+++ b/fs/yaffs2/yaffs_fs.c
@@ -2493,7 +2493,7 @@ static struct super_block *yaffs_internal_read_super(int yaffsVersion,
         YINIT_LIST_HEAD(&(yaffs_DeviceToContext(dev)->searchContexts));
         param->removeObjectCallback = yaffs_RemoveObjectCallback;
 
-	init_MUTEX(&(yaffs_DeviceToContext(dev)->grossLock));
+	sema_init(&(yaffs_DeviceToContext(dev)->grossLock), 1);
 
 	yaffs_GrossLock(dev);
 
@@ -2946,7 +2946,7 @@ static int __init init_yaffs_fs(void)
 	T(YAFFS_TRACE_ALWAYS,
 	  ("yaffs " __DATE__ " " __TIME__ " Installing. \n"));
 
-	init_MUTEX(&yaffs_context_lock);
+	sema_init(&yaffs_context_lock, 1);
 
 	/* Install the proc_fs entries */
 	my_proc_entry = create_proc_entry("yaffs",
-- 
1.6.5.2

