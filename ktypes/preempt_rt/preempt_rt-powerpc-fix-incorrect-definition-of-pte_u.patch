From 9142b039e0aacb841a7c698fdd731a37394a9cac Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Fri, 10 Feb 2012 14:16:38 +0800
Subject: [PATCH] preempt_rt/powerpc: fix incorrect definition of pte_unmap

The input parameter of pte_unmap is an virtual address while kunmap needs a
pointer to page structure. kunmap is not fit for this process so use kunmap_virt
to make it.

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 arch/powerpc/include/asm/pgtable-ppc32.h |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/include/asm/pgtable-ppc32.h b/arch/powerpc/include/asm/pgtable-ppc32.h
index 62a1c50..2567d67 100644
--- a/arch/powerpc/include/asm/pgtable-ppc32.h
+++ b/arch/powerpc/include/asm/pgtable-ppc32.h
@@ -11,6 +11,7 @@
 extern unsigned long va_to_phys(unsigned long address);
 extern pte_t *va_to_pte(unsigned long address);
 extern unsigned long ioremap_bot;
+extern void kunmap_virt(void *ptr);
 
 #ifdef CONFIG_44x
 extern int icache_44x_need_flush;
@@ -342,9 +343,9 @@ static inline void __ptep_set_access_flags(pte_t *ptep, pte_t entry)
 	((pte_t *) kmap(pmd_page(*(dir))) + pte_index(addr))
 
 #define pte_unmap(pte)	\
-	kunmap((struct page *)_ALIGN_DOWN((unsigned int)pte, PAGE_SIZE))
+	kunmap_virt(pte)
 #define pte_unmap_nested(pte)	\
-	kunmap((struct page *)_ALIGN_DOWN((unsigned int)pte, PAGE_SIZE))
+	kunmap_virt(pte)
 #else
 #define pte_offset_map(dir, addr)		\
 	((pte_t *) kmap_atomic(pmd_page(*(dir)), KM_PTE0) + pte_index(addr))
-- 
1.7.0.4

