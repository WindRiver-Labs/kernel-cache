From 63fcc64981a94c40486534293dcdcc61d532115c Mon Sep 17 00:00:00 2001
From: Mark Asselstine <mark.asselstine@windriver.com>
Date: Wed, 28 Jul 2010 11:53:38 -0400
Subject: [PATCH] preempt_rt: dcache_lock removal from fs/namei.c

RT commit 6465e96519 [fs-dcache_lock-remove] removed the use of
dcache_lock.

The commit:

  "fs/namei/LSB: donot call dget when dentries with zero ref counter"

Introduces a classic dcache_lock that needs to be converted to the
per-dcache lock. Which matches the preempt_rt implementation.

Signed-off-by: Mark Asselstine <mark.asselstine@windriver.com>
---
 fs/namei.c |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/fs/namei.c b/fs/namei.c
index 8c98bdf..e6fb6ac 100644
--- a/fs/namei.c
+++ b/fs/namei.c
@@ -2468,9 +2468,9 @@ SYSCALL_DEFINE2(mkdir, const char __user *, pathname, int, mode)
  */
 void dentry_unhash(struct dentry *dentry)
 {
-	spin_lock(&dcache_lock);
-	dget_locked(dentry);
-	spin_unlock(&dcache_lock);
+	spin_lock(&dentry->d_lock);
+	dget_dlock(dentry);
+	spin_unlock(&dentry->d_lock);
 	shrink_dcache_parent(dentry);
 	spin_lock(&dentry->d_lock);
 	if (atomic_read(&dentry->d_count) == 2)
-- 
1.6.5.2

