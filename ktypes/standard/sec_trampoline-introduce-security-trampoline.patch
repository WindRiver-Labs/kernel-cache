From 90216c4018173340b443bbc0bf4427dd0b86568f Mon Sep 17 00:00:00 2001
From: Bruce Ashfield <bruce.ashfield@windriver.com>
Date: Sun, 13 Feb 2011 01:18:33 -0500
Subject: [PATCH] sec_trampoline: introduce security trampoline

Introduce a variable size location in the text segment
that can be used as a trampoline for security purposes.

This option is controlled by CONFIG_SECURITY_TRAMPOLINE and depends
on an architecture specific implementation and enablement.

Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 arch/powerpc/Kconfig                 |    4 ++++
 arch/powerpc/kernel/Makefile         |    1 +
 arch/powerpc/kernel/sec_trampoline.S |   31 +++++++++++++++++++++++++++++++
 arch/x86/Kconfig                     |    3 +++
 arch/x86/kernel/Makefile             |    4 +++-
 arch/x86/kernel/sec_trampoline.S     |   30 ++++++++++++++++++++++++++++++
 include/linux/sec_trampoline.h       |   31 +++++++++++++++++++++++++++++++
 security/Kconfig                     |    7 +++++++
 8 files changed, 110 insertions(+), 1 deletions(-)
 create mode 100644 arch/powerpc/kernel/sec_trampoline.S
 create mode 100644 arch/x86/kernel/sec_trampoline.S
 create mode 100644 include/linux/sec_trampoline.h

diff --git a/arch/powerpc/Kconfig b/arch/powerpc/Kconfig
index ea39e55..95104d7 100644
--- a/arch/powerpc/Kconfig
+++ b/arch/powerpc/Kconfig
@@ -101,6 +101,10 @@ config ARCH_HAS_ILOG2_U64
 	bool
 	default y if 64BIT
 
+config ARCH_HAS_SEC_TRAMPOLINE
+        bool
+        default y if !64bit
+
 config GENERIC_HWEIGHT
 	bool
 	default y
diff --git a/arch/powerpc/kernel/Makefile b/arch/powerpc/kernel/Makefile
index 5240041..06bba95 100644
--- a/arch/powerpc/kernel/Makefile
+++ b/arch/powerpc/kernel/Makefile
@@ -104,6 +104,7 @@ extra-y				+= vmlinux.lds
 obj-y				+= time.o prom.o traps.o setup-common.o \
 				   udbg.o misc.o io.o dma.o \
 				   misc_$(CONFIG_WORD_SIZE).o
+obj-$(CONFIG_SEC_TRAMPOLINE)	+= sec_trampoline.o
 obj-$(CONFIG_PPC32)		+= entry_32.o setup_32.o
 obj-$(CONFIG_PPC64)		+= dma-iommu.o iommu.o
 obj-$(CONFIG_KGDB)		+= kgdb.o
diff --git a/arch/powerpc/kernel/sec_trampoline.S b/arch/powerpc/kernel/sec_trampoline.S
new file mode 100644
index 0000000..9789bd1
--- /dev/null
+++ b/arch/powerpc/kernel/sec_trampoline.S
@@ -0,0 +1,31 @@
+#  Copyright (c) 2011 Wind River Systems, Inc.
+
+#  This program is free software; you can redistribute it and/or modify
+#  it under the terms of the GNU General Public License version 2 as
+#  published by the Free Software Foundation.
+
+#  This program is distributed in the hope that it will be useful,
+#  but WITHOUT ANY WARRANTY; without even the implied warranty of
+#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
+#  See the GNU General Public License for more details.
+
+#  You should have received a copy of the GNU General Public License
+#  along with this program; if not, write to the Free Software
+#  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+#include <asm/asm-offsets.h>
+
+
+_ENTRY(sec_trampoile_data);
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+.globl sec_trampoline_end
+sec_trampoline_end:
diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig
index 7fce01c..0346dd6 100644
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@ -73,6 +73,9 @@ config ARCH_DEFCONFIG
 	default "arch/x86/configs/i386_defconfig" if X86_32
 	default "arch/x86/configs/x86_64_defconfig" if X86_64
 
+config ARCH_HAS_SEC_TRAMPOLINE
+        def_bool y
+
 config GENERIC_TIME
 	def_bool y
 
diff --git a/arch/x86/kernel/Makefile b/arch/x86/kernel/Makefile
index a44e6d8..c0861fe 100644
--- a/arch/x86/kernel/Makefile
+++ b/arch/x86/kernel/Makefile
@@ -32,7 +32,9 @@ GCOV_PROFILE_hpet.o		:= n
 GCOV_PROFILE_tsc.o		:= n
 GCOV_PROFILE_paravirt.o		:= n
 
-obj-y			:= process_$(BITS).o signal.o entry_$(BITS).o
+obj-y			:= process_$(BITS).o signal.o 
+obj-$(CONFIG_SEC_TRAMPOLINE) += sec_trampoline.o
+obj-y                   += entry_$(BITS).o
 obj-y			+= traps.o irq.o irq_$(BITS).o dumpstack_$(BITS).o
 obj-y			+= time.o ioport.o ldt.o dumpstack.o
 obj-y			+= setup.o x86_init.o i8259.o irqinit.o
diff --git a/arch/x86/kernel/sec_trampoline.S b/arch/x86/kernel/sec_trampoline.S
new file mode 100644
index 0000000..c75f8ac
--- /dev/null
+++ b/arch/x86/kernel/sec_trampoline.S
@@ -0,0 +1,30 @@
+#  Copyright (c) 2011 Wind River Systems, Inc.
+
+#  This program is free software; you can redistribute it and/or modify
+#  it under the terms of the GNU General Public License version 2 as
+#  published by the Free Software Foundation.
+
+#  This program is distributed in the hope that it will be useful,
+#  but WITHOUT ANY WARRANTY; without even the implied warranty of
+#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
+#  See the GNU General Public License for more details.
+
+#  You should have received a copy of the GNU General Public License
+#  along with this program; if not, write to the Free Software
+#  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+#include <linux/linkage.h>
+
+ENTRY(sec_trampoile_data);
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+.globl sec_trampoline_end
+sec_trampoline_end:
diff --git a/include/linux/sec_trampoline.h b/include/linux/sec_trampoline.h
new file mode 100644
index 0000000..d3a2971
--- /dev/null
+++ b/include/linux/sec_trampoline.h
@@ -0,0 +1,31 @@
+#  Copyright (c) 2011 Wind River Systems, Inc.
+
+#  This program is free software; you can redistribute it and/or modify
+#  it under the terms of the GNU General Public License version 2 as
+#  published by the Free Software Foundation.
+
+#  This program is distributed in the hope that it will be useful,
+#  but WITHOUT ANY WARRANTY; without even the implied warranty of
+#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
+#  See the GNU General Public License for more details.
+
+#  You should have received a copy of the GNU General Public License
+#  along with this program; if not, write to the Free Software
+#  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
+#ifndef _SEC_TRAMPOLINE_H_
+#define _SEC_TRAMPOLINE_H_
+
+#ifndef __ASSEMBLY__
+
+#ifdef CONFIG_SEC_TRAMPOLINE
+
+extern const unsigned char sec_trampoline_data [];
+extern const unsigned char sec_trampoline_end  [];
+
+#endif /* CONFIG_SEC_TRAMPOLINE */
+
+#endif /* __ASSEMBLY__ */
+
+#endif /* _SEC_TRAMPOLINE_H_ */
+
diff --git a/security/Kconfig b/security/Kconfig
index 9647a24..ed8e922 100644
--- a/security/Kconfig
+++ b/security/Kconfig
@@ -4,6 +4,13 @@
 
 menu "Security options"
 
+config SEC_TRAMPOLINE
+        bool "Enable security trampoline region"
+        default y if ARCH_HAS_SEC_TRAMPOLINE
+        help
+          This option creates a 10 word space in the text segment that
+          can be used for security trampoline purposes.
+
 config KEYS
 	bool "Enable access key retention support"
 	help
-- 
1.6.5.2

