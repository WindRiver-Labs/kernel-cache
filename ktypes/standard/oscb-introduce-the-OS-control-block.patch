From 736953a9a331f5ce1449f84d70112803cc740177 Mon Sep 17 00:00:00 2001
From: Bruce Ashfield <bruce.ashfield@windriver.com>
Date: Fri, 25 Mar 2011 16:30:27 -0400
Subject: [PATCH] oscb: introduce the OS control block

The OS Control Block (OSCB) is a block of memory than an execution
environment (operating system, executive, hypervisor etc) can use to
describe itself to the world. It is particularily useful for tools to
adapt how they interact with a target.

This change introduces the OSCB and enables it by default. All
fields are initialized at compile time and modules can reference
the OSCB via the variable oscb_header.

Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 include/linux/oscb.h |   58 ++++++++++++++++++++++++++++++++++++
 init/Kconfig         |    9 +++++
 init/Makefile        |    1 +
 init/oscb.c          |   80 ++++++++++++++++++++++++++++++++++++++++++++++++++
 4 files changed, 148 insertions(+), 0 deletions(-)
 create mode 100644 include/linux/oscb.h
 create mode 100644 init/oscb.c

diff --git a/include/linux/oscb.h b/include/linux/oscb.h
new file mode 100644
index 0000000..1ca7a04
--- /dev/null
+++ b/include/linux/oscb.h
@@ -0,0 +1,58 @@
+#ifndef _LINUX_OSCB_H
+#define _LINUX_OSCB_H
+
+/*Copyright (c) 2011 Wind River Systems, Inc.
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License version 2 as
+  published by the Free Software Foundation.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
+  See the GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+*/
+
+/* The OS Control Block (OSCB) is a block of memory than an execution
+ * environment (operating system, executive, hypervisor etc) can use to
+ * describe itself to the world. It is particularily useful for tools to
+ * adapt how they interact with a target. */
+
+#include <linux/types.h>
+
+#define OSCB_VENDOR_NAME "WR\0"
+#define OSCB_OS_NAME "WR Linux\0"
+#define OSCB_SIGNATURE 0x05CBBC50
+#define OSCB_VERSION 0
+#define OSCB_BIG_ENDIAN 0
+#define OSCB_LITTLE_ENDIAN 1
+#define OSCB_ILP32  0x0
+#define OSCB_LP64   0x1
+#define OSCB_ILP64  0x2
+
+struct oscb_header {
+	uint32_t	signature;
+
+	/* This field identifies the programming model of the compiler.
+	   Only the 4 least significant bits are used. The upper bits
+	   are reserved. The following values are used:
+	       0 = ILP32
+	       1 = LP64
+	       2 = ILP64
+	*/
+	uint8_t		programming_model;
+	/* 0=big, 1=little */
+	uint8_t		endianess;
+	uint16_t	version;
+	char*		vendor_id;
+	char*		os_name;
+	char*		os_version;
+	void*		data;
+};
+
+#endif
+
diff --git a/init/Kconfig b/init/Kconfig
index 134a45f..73c8947 100644
--- a/init/Kconfig
+++ b/init/Kconfig
@@ -866,6 +866,15 @@ config KALLSYMS_EXTRA_PASS
 	   reported.  KALLSYMS_EXTRA_PASS is only a temporary workaround while
 	   you wait for kallsyms to be fixed.
 
+config OSCB
+	bool "Enable OS Control Block"
+	default n
+	help
+	   The OS Control Block (OSCB) is a block of memory than an execution
+	   environment (operating system, executive, hypervisor etc) can use to
+	   describe itself to the world. It is particularily useful for tools to
+	   adapt how they interact with a target
+
 
 config HOTPLUG
 	bool "Support for hot-pluggable devices" if EMBEDDED
diff --git a/init/Makefile b/init/Makefile
index 0bf677a..3ec7676 100644
--- a/init/Makefile
+++ b/init/Makefile
@@ -3,6 +3,7 @@
 #
 
 obj-y                          := main.o version.o mounts.o
+obj-$(CONFIG_OSCB)             += oscb.o
 ifneq ($(CONFIG_BLK_DEV_INITRD),y)
 obj-y                          += noinitramfs.o
 else
diff --git a/init/oscb.c b/init/oscb.c
new file mode 100644
index 0000000..d13212d
--- /dev/null
+++ b/init/oscb.c
@@ -0,0 +1,80 @@
+/*Copyright (c) 2011 Wind River Systems, Inc.
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License version 2 as
+  published by the Free Software Foundation.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
+  See the GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+*/
+
+#include <linux/oscb.h>
+#include <generated/autoconf.h>
+#include <generated/utsrelease.h>
+
+#if defined(CONFIG_ARM)
+#ifdef __ARMEB__
+#define OSCB_ENDIAN OSCB_BIG_ENDIAN
+#else
+#define OSCB_ENDIAN OSCB_LITTLE_ENDIAN
+#endif
+#endif /* CONFIG_ARM */
+
+#if defined(CONFIG_MIPS)
+#if defined(__MIPSEB__)
+#define OSCB_ENDIAN OSCB_BIG_ENDIAN
+#else defined(__MIPSEL__)
+#define OSCB_ENDIAN OSCB_LITTLE_ENDIAN
+#endif
+#endif
+
+#if defined(CONFIG_X86)
+#define OSCB_ENDIAN OSCB_LITTLE_ENDIAN
+#endif
+
+#if defined(CONFIG_PPC32)
+#define OSCB_ENDIAN OSCB_BIG_ENDIAN
+#endif
+
+#if defined(CONFIG_PPC64)
+#define OSCB_ENDIAN OSCB_BIG_ENDIAN
+#endif
+
+#ifndef OSCB_ENDIAN
+#warning WARNING. defining a default endianess
+#define OSCB_ENDIAN OSCB_LITTLE_ENDIAN
+#endif
+
+/* This table lists the breakdown of sizes in the various programming models.
+Datatype	LP64	ILP64	LLP64	ILP32	LP32
+char	          8	 8	 8	 8	 8
+short	         16	 16	 16	 16	 16
+_int	         32	 --	 32	 --	 --
+int	         32	 64	 32	 32	 16
+long	         64	 64	 32	 32	 32
+long long	 --	 --	 64	 --	 --
+pointer	         64	 64	 64	 32	 32
+*/
+#if BITS_PER_LONG == 32
+#define OSCB_MODEL OSCB_ILP32
+#else
+#define OSCB_MODEL OSCB_ILP64
+#endif
+
+struct oscb_header __oscb_hdr = {
+	.signature		= OSCB_SIGNATURE,
+	.programming_model	= OSCB_MODEL,
+	.endianess		= OSCB_ENDIAN,
+	.version		= OSCB_VERSION,
+	.os_name		= OSCB_OS_NAME,
+	.os_version		= UTS_RELEASE,
+	.data			= NULL
+};
+
+
-- 
1.6.5.2

