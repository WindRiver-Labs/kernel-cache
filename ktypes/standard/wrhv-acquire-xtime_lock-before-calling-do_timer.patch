From 71434365f8c78be7016de561bbab2ab93678b564 Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Thu, 21 Oct 2010 17:00:29 +0800
Subject: [PATCH] wrhv: acquire xtime_lock before calling do_timer

The function do_timer will update jiffies_64 and xtime, and should
be invoked with xtime_lock acquired. Otherwise we will get inaccurate
time when the do_timer is running.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
Integrated-by: Li Wang <li.wang@windriver.com>
---
 kernel/vbi/wrhv.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/kernel/vbi/wrhv.c b/kernel/vbi/wrhv.c
index 59fa6a7..fe383b7 100644
--- a/kernel/vbi/wrhv.c
+++ b/kernel/vbi/wrhv.c
@@ -158,7 +158,9 @@ irqreturn_t __weak wrhv_timer_interrupt(int irq, void *dev_id)
 	mark_offset = wr_vb_status->tick_count;
 
 	do {
+		write_seqlock(&xtime_lock);
 		do_timer(1);
+		write_sequnlock(&xtime_lock);
 		update_process_times(user_mode(regs));
 		profile_tick(CPU_PROFILING);
 		if (lost_jiffies > (2*HZ)) {
-- 
1.7.0.4

