From 597c5f75ef6c3fc521d14ebc074862b92d62e3e0 Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Thu, 31 Mar 2011 16:30:20 +0800
Subject: [PATCH 1/2] sched: add extended sched_dl syscalls for all arches.

add four syscalls interface for x86, x86_64,
arm, powerpc and mips arches:

 - sys_sched_setscheduler_ex
 - sys_sched_setparam_ex
 - sys_sched_getparam_ex
 - sys_sched_wait_interval

split from EDF patches.

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 arch/arm/include/asm/unistd.h      |    6 +++++-
 arch/arm/kernel/calls.S            |    4 ++++
 arch/mips/include/asm/unistd.h     |   24 ++++++++++++++++++------
 arch/mips/kernel/scall32-o32.S     |    4 ++++
 arch/mips/kernel/scall64-64.S      |    4 ++++
 arch/mips/kernel/scall64-n32.S     |    4 ++++
 arch/mips/kernel/scall64-o32.S     |    4 ++++
 arch/powerpc/include/asm/systbl.h  |    4 ++++
 arch/powerpc/include/asm/unistd.h  |    7 ++++++-
 arch/x86/ia32/ia32entry.S          |    4 ++++
 arch/x86/include/asm/unistd_32.h   |    7 ++++++-
 arch/x86/include/asm/unistd_64.h   |    9 +++++++++
 arch/x86/kernel/syscall_table_32.S |    4 ++++
 13 files changed, 76 insertions(+), 9 deletions(-)

diff --git a/arch/arm/include/asm/unistd.h b/arch/arm/include/asm/unistd.h
index 7fe62cf..cba7c03 100644
--- a/arch/arm/include/asm/unistd.h
+++ b/arch/arm/include/asm/unistd.h
@@ -393,8 +393,12 @@
 #define __NR_perf_event_open		(__NR_SYSCALL_BASE+364)
 #define __NR_recvmmsg			(__NR_SYSCALL_BASE+365)
 #define __NR_accept4			(__NR_SYSCALL_BASE+366)
+#define __NR_sched_setscheduler_ex	(__NR_SYSCALL_BASE+367)
+#define __NR_sched_setparam_ex		(__NR_SYSCALL_BASE+368)
+#define __NR_sched_getparam_ex		(__NR_SYSCALL_BASE+369)
+#define __NR_sched_wait_interval	(__NR_SYSCALL_BASE+370)
 
-#define __NR_syscall_max 367
+#define __NR_syscall_max 371
 
 /*
  * The following SWIs are ARM private.
diff --git a/arch/arm/kernel/calls.S b/arch/arm/kernel/calls.S
index afeb71f..4c2ebcc 100644
--- a/arch/arm/kernel/calls.S
+++ b/arch/arm/kernel/calls.S
@@ -376,6 +376,10 @@
 		CALL(sys_perf_event_open)
 /* 365 */	CALL(sys_recvmmsg)
 		CALL(sys_accept4)
+		CALL(sys_sched_setscheduler_ex)
+		CALL(sys_sched_setparam_ex)
+		CALL(sys_sched_getparam_ex)
+/* 370 */	CALL(sys_sched_wait_interval)
 #ifndef syscalls_counted
 .equ syscalls_padding, ((NR_syscalls + 3) & ~3) - NR_syscalls
 #define syscalls_counted
diff --git a/arch/mips/include/asm/unistd.h b/arch/mips/include/asm/unistd.h
index baa318a..c3129ea 100644
--- a/arch/mips/include/asm/unistd.h
+++ b/arch/mips/include/asm/unistd.h
@@ -356,16 +356,20 @@
 #define __NR_perf_event_open		(__NR_Linux + 333)
 #define __NR_accept4			(__NR_Linux + 334)
 #define __NR_recvmmsg			(__NR_Linux + 335)
+#define __NR_sched_setscheduler_ex	(__NR_Linux + 336)
+#define __NR_sched_setparam_ex		(__NR_Linux + 337)
+#define __NR_sched_getparam_ex		(__NR_Linux + 338)
+#define __NR_sched_wait_interval	(__NR_Linux + 339)
 
 /*
  * Offset of the last Linux o32 flavoured syscall
  */
-#define __NR_Linux_syscalls		335
+#define __NR_Linux_syscalls		339
 
 #endif /* _MIPS_SIM == _MIPS_SIM_ABI32 */
 
 #define __NR_O32_Linux			4000
-#define __NR_O32_Linux_syscalls		335
+#define __NR_O32_Linux_syscalls		339
 
 #if _MIPS_SIM == _MIPS_SIM_ABI64
 
@@ -668,16 +672,20 @@
 #define __NR_perf_event_open		(__NR_Linux + 292)
 #define __NR_accept4			(__NR_Linux + 293)
 #define __NR_recvmmsg			(__NR_Linux + 294)
+#define __NR_sched_setscheduler_ex	(__NR_Linux + 295)
+#define __NR_sched_setparam_ex		(__NR_Linux + 296)
+#define __NR_sched_getparam_ex		(__NR_Linux + 297)
+#define __NR_sched_wait_interval	(__NR_Linux + 298)
 
 /*
  * Offset of the last Linux 64-bit flavoured syscall
  */
-#define __NR_Linux_syscalls		294
+#define __NR_Linux_syscalls		298
 
 #endif /* _MIPS_SIM == _MIPS_SIM_ABI64 */
 
 #define __NR_64_Linux			5000
-#define __NR_64_Linux_syscalls		294
+#define __NR_64_Linux_syscalls		298
 
 #if _MIPS_SIM == _MIPS_SIM_NABI32
 
@@ -985,16 +993,20 @@
 #define __NR_accept4			(__NR_Linux + 297)
 #define __NR_recvmmsg			(__NR_Linux + 298)
 #define __NR_getdents64			(__NR_Linux + 299)
+#define __NR_sched_setscheduler_ex	(__NR_Linux + 300)
+#define __NR_sched_setparam_ex		(__NR_Linux + 301)
+#define __NR_sched_getparam_ex		(__NR_Linux + 302)
+#define __NR_sched_wait_interval	(__NR_Linux + 303)
 
 /*
  * Offset of the last N32 flavoured syscall
  */
-#define __NR_Linux_syscalls		299
+#define __NR_Linux_syscalls		303
 
 #endif /* _MIPS_SIM == _MIPS_SIM_NABI32 */
 
 #define __NR_N32_Linux			6000
-#define __NR_N32_Linux_syscalls		299
+#define __NR_N32_Linux_syscalls		303
 
 #ifdef __KERNEL__
 
diff --git a/arch/mips/kernel/scall32-o32.S b/arch/mips/kernel/scall32-o32.S
index c7a7c81..3d76c7b 100644
--- a/arch/mips/kernel/scall32-o32.S
+++ b/arch/mips/kernel/scall32-o32.S
@@ -588,6 +588,10 @@ einval:	li	v0, -ENOSYS
 	sys	sys_vbi_mem		5
 	sys 	sys_vbi_activate_vb	2
 	sys 	sys_vbi_control		3
+	sys     sys_sched_setscheduler_ex 4
+	sys     sys_sched_setparam_ex	3
+	sys     sys_sched_getparam_ex	3
+	sys     sys_sched_wait_interval	2
 	.endm
 
 	/* We pre-compute the number of _instruction_ bytes needed to
diff --git a/arch/mips/kernel/scall64-64.S b/arch/mips/kernel/scall64-64.S
index cf9582b..63c53fb 100644
--- a/arch/mips/kernel/scall64-64.S
+++ b/arch/mips/kernel/scall64-64.S
@@ -424,4 +424,8 @@ EXPORT(sys_call_table)
 	PTR	sys_perf_event_open
 	PTR	sys_accept4
 	PTR     sys_recvmmsg
+	PTR     sys_sched_setscheduler_ex
+	PTR     sys_sched_setparam_ex
+	PTR     sys_sched_getparam_ex
+	PTR     sys_sched_wait_interval
 	.size	sys_call_table,.-sys_call_table
diff --git a/arch/mips/kernel/scall64-n32.S b/arch/mips/kernel/scall64-n32.S
index c7f9a2e..f26f0f0 100644
--- a/arch/mips/kernel/scall64-n32.S
+++ b/arch/mips/kernel/scall64-n32.S
@@ -427,4 +427,8 @@ EXPORT(sysn32_call_table)
 	PTR     sys_vbi_mem
 	PTR     sys_vbi_activate_vb
 	PTR     sys_vbi_control
+	PTR     sys_sched_setscheduler_ex
+	PTR     sys_sched_setparam_ex
+	PTR     sys_sched_getparam_ex
+	PTR     sys_sched_wait_interval
 	.size	sysn32_call_table,.-sysn32_call_table
diff --git a/arch/mips/kernel/scall64-o32.S b/arch/mips/kernel/scall64-o32.S
index bfb0bcb..78b675b 100644
--- a/arch/mips/kernel/scall64-o32.S
+++ b/arch/mips/kernel/scall64-o32.S
@@ -543,4 +543,8 @@ EXPORT(syso32_call_table)
 	PTR     sys_vbi_mem
 	PTR     sys_vbi_activate_vb
 	PTR     sys_vbi_control
+	PTR     sys_sched_setscheduler_ex
+	PTR     sys_sched_setparam_ex
+	PTR     sys_sched_getparam_ex
+	PTR     sys_sched_wait_interval
 	.size	sys_call_table,.-sys_call_table
diff --git a/arch/powerpc/include/asm/systbl.h b/arch/powerpc/include/asm/systbl.h
index 5b747a1..0860f27 100644
--- a/arch/powerpc/include/asm/systbl.h
+++ b/arch/powerpc/include/asm/systbl.h
@@ -329,3 +329,7 @@ COMPAT_SYS(rt_tgsigqueueinfo)
 SYSCALL(vbi_mem)
 SYSCALL(vbi_activate_vb)
 SYSCALL(vbi_control)
+COMPAT_SYS_SPU(sched_setscheduler_ex)
+COMPAT_SYS_SPU(sched_setparam_ex)
+COMPAT_SYS_SPU(sched_getparam_ex)
+COMPAT_SYS_SPU(sched_wait_interval)
diff --git a/arch/powerpc/include/asm/unistd.h b/arch/powerpc/include/asm/unistd.h
index 3b413e0..7b49d0e 100644
--- a/arch/powerpc/include/asm/unistd.h
+++ b/arch/powerpc/include/asm/unistd.h
@@ -348,6 +348,11 @@
 #define __NR_vbi_mem		323
 #define __NR_vbi_activate_vb	324
 #define __NR_vbi_control		325
+#define __NR_sched_setscheduler_ex	326
+#define __NR_sched_setparam_ex		327
+#define __NR_sched_getparam_ex		328
+#define __NR_sched_wait_interval	329
+
 #define VBI_MEM_READ		0x0010
 #define VBI_MEM_WRITE		0x0100
 #define SYS_VBI_VB_SUSPEND	0x10001
@@ -356,7 +361,7 @@
 
 #ifdef __KERNEL__
 
-#define __NR_syscalls		326
+#define __NR_syscalls		330
 
 #define __NR__exit __NR_exit
 #define NR_syscalls	__NR_syscalls
diff --git a/arch/x86/ia32/ia32entry.S b/arch/x86/ia32/ia32entry.S
index 449d5f4..d06acb5 100644
--- a/arch/x86/ia32/ia32entry.S
+++ b/arch/x86/ia32/ia32entry.S
@@ -889,4 +889,8 @@ ia32_sys_call_table:
 	.quad compat_sys_rt_tgsigqueueinfo	/* 335 */
 	.quad sys_perf_event_open
 	.quad compat_sys_recvmmsg
+	.quad sys_sched_setscheduler_ex
+	.quad sys_sched_setparam_ex
+	.quad sys_sched_getparam_ex		/* 340 */
+	.quad sys_sched_wait_interval
 ia32_syscall_end:
diff --git a/arch/x86/include/asm/unistd_32.h b/arch/x86/include/asm/unistd_32.h
index 773e01f..b969e56 100644
--- a/arch/x86/include/asm/unistd_32.h
+++ b/arch/x86/include/asm/unistd_32.h
@@ -346,6 +346,11 @@
 #define __NR_vbi_mem		338
 #define __NR_vbi_activate_vb	339
 #define __NR_vbi_control		340
+#define __NR_sched_setscheduler_ex	341
+#define __NR_sched_setparam_ex		342
+#define __NR_sched_getparam_ex		343
+#define __NR_sched_wait_interval	344
+
 #define VBI_MEM_READ		0x0010
 #define VBI_MEM_WRITE		0x0100
 #define SYS_VBI_VB_SUSPEND	0x10001
@@ -354,7 +359,7 @@
 
 #ifdef __KERNEL__
 
-#define NR_syscalls 341
+#define NR_syscalls 345
 
 #define __ARCH_WANT_IPC_PARSE_VERSION
 #define __ARCH_WANT_OLD_READDIR
diff --git a/arch/x86/include/asm/unistd_64.h b/arch/x86/include/asm/unistd_64.h
index 0491dda..420b2e8 100644
--- a/arch/x86/include/asm/unistd_64.h
+++ b/arch/x86/include/asm/unistd_64.h
@@ -669,6 +669,15 @@ __SYSCALL(__NR_vbi_mem, sys_vbi_mem)
 __SYSCALL(__NR_vbi_activate_vb, sys_vbi_activate_vb)
 #define __NR_vbi_control			302
 __SYSCALL(__NR_vbi_control, sys_vbi_control)
+#define __NR_sched_setscheduler_ex		303
+__SYSCALL(__NR_sched_setscheduler_ex, sys_sched_setscheduler_ex)
+#define __NR_sched_setparam_ex			304
+__SYSCALL(__NR_sched_setparam_ex, sys_sched_setparam_ex)
+#define __NR_sched_getparam_ex			305
+__SYSCALL(__NR_sched_getparam_ex, sys_sched_getparam_ex)
+#define __NR_sched_wait_interval		306
+__SYSCALL(__NR_sched_wait_interval, sys_sched_wait_interval)
+
 #define VBI_MEM_READ           0x0010
 #define VBI_MEM_WRITE          0x0100
 #define SYS_VBI_VB_SUSPEND	0x10001
diff --git a/arch/x86/kernel/syscall_table_32.S b/arch/x86/kernel/syscall_table_32.S
index b803225..520579a 100644
--- a/arch/x86/kernel/syscall_table_32.S
+++ b/arch/x86/kernel/syscall_table_32.S
@@ -340,3 +340,7 @@ ENTRY(sys_call_table)
 	.long sys_vbi_mem		/* 338 */
 	.long sys_vbi_activate_vb	/* 339 */
 	.long sys_vbi_control		/* 340 */
+	.long sys_sched_setscheduler_ex
+	.long sys_sched_setparam_ex
+	.long sys_sched_getparam_ex	/* 343 */
+	.long sys_sched_wait_interval	/* 344 */
-- 
1.7.0.4

