From 90b9bde77c557b209b49de6a3d8dcb4fe39393d8 Mon Sep 17 00:00:00 2001
From: Ralf Baechle <ralf.baechle@windriver.com>
Date: Fri, 14 Aug 2009 03:19:02 +0100
Subject: [PATCH] MIPS: CGL: Enable kernel snapshots.

This allows taking a snapshot of the state of a running system.  The
snapshot file will be a standard core file so all common tools can be
used to analyze it.  To take a snapshot just echo the filename of the
snapshot to be created into the control file like
"echo /root/snapshot > /sys/ksnap/ksnap".

Depending on the amount of memory in the system and filesystem performance
taking a snapshot may be a slow process; to allow a consistent snapshot
being taken the system will be mostly frozen during the time of the
snapshot.

The implementation is restricted to non-NUMA, non-HIGHMEM systems.

Signed-off-by: Ralf Baechle <ralf.baechle@windriver.com>
---
 arch/mips/Kconfig      |    4 ++++
 include/linux/mmzone.h |    8 ++++++++
 kernel/power/Kconfig   |   15 +++++++++++++++
 3 files changed, 27 insertions(+), 0 deletions(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index 54ce213..e07f53f 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -2212,6 +2212,10 @@ config ARCH_PM_SNAPSHOT_POSSIBLE
 	def_bool y
 	depends on SYS_SUPPORTS_HOTPLUG_CPU || !SMP
 
+config ARCH_PM_SNAPSHOT_POSSIBLE
+	def_bool y
+	depends on SYS_SUPPORTS_HOTPLUG_CPU || !SMP
+
 source "kernel/power/Kconfig"
 
 endmenu
diff --git a/include/linux/mmzone.h b/include/linux/mmzone.h
index 2fa3b1a..785acaa 100644
--- a/include/linux/mmzone.h
+++ b/include/linux/mmzone.h
@@ -813,6 +813,14 @@ extern struct zone *next_zone(struct zone *zone);
 			; /* do nothing */		\
 		else
 
+#define for_each_populated_zone(zone)			\
+	for (zone = (first_online_pgdat())->node_zones;	\
+	     zone;					\
+	     zone = next_zone(zone))			\
+		if (!populated_zone(zone))		\
+			; /* do nothing */		\
+		else
+
 static inline struct zone *zonelist_zone(struct zoneref *zoneref)
 {
 	return zoneref->zone;
diff --git a/kernel/power/Kconfig b/kernel/power/Kconfig
index a769c58..78069e1 100644
--- a/kernel/power/Kconfig
+++ b/kernel/power/Kconfig
@@ -190,6 +190,21 @@ config PM_SNAPSHOT
 	  consistent snapshot being taken the system will be mostly frozen
 	  during the time of the snapshot.
 
+config PM_SNAPSHOT
+	bool "Live snapshots"
+	depends on PM && PM_SLEEP && ARCH_PM_SNAPSHOT_POSSIBLE && !NUMA && !HIGHMEM
+	---help---
+	  This allows taking a snapshot of the state of a running system.  The
+	  snapshot file will be a standard core file so all common tools can be
+	  used to analyze it.  To take a snapshot just echo the filename of the
+	  snapshot to be created into the control file like
+	  "echo /root/snapshot > /sys/ksnap/ksnap".
+
+	  Depending on the amount of memory in the system and filesystem
+	  performance taking a snapshot may be a slow process; to allow a
+	  consistent snapshot being taken the system will be mostly frozen
+	  during the time of the snapshot.
+
 config PM_STD_PARTITION
 	string "Default resume partition"
 	depends on HIBERNATION
-- 
1.6.5.2

