From 79ecfb5300ccdf7082ee4002ba72119df90a9729 Mon Sep 17 00:00:00 2001
From: Rob Woolley <rob.woolley@windriver.com>
Date: Thu, 22 Jan 2009 19:05:18 -0500
Subject: [PATCH] 8250: faulty 8250 Serial UARTs is optional

We need a new Kconfig option which may be used to disable the
UART_BUG_TXEN auto-detection feature.

This feature from mainline is intended to detect UARTs that don't
properly raise an interrupt when the transmitter buffer is empty.
It can occassionally give false positives which interferes with
IPMI messages causing a race condition between serial8250_interrupt
and serial8250_start_tx.

This new option defaults to on to match the mainline kernel.  This
patch turns it off for the boards with 8250-compatible UARTs.

The targets were booted with the option disabled and IPMI messages
were successfully exchanged with the IPMC through the ipmitool.
The serial console output also functioned properly without incident.

Signed-off-by: Rob Woolley <rob.woolley@windriver.com>
---
 drivers/serial/8250.c  |    2 ++
 drivers/serial/Kconfig |   13 +++++++++++++
 2 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/drivers/serial/8250.c b/drivers/serial/8250.c
index b67051f..f786864 100644
--- a/drivers/serial/8250.c
+++ b/drivers/serial/8250.c
@@ -1983,6 +1983,7 @@ static int serial8250_startup(struct uart_port *port)
 	if (up->port.flags & UPF_NO_TXEN_TEST)
 		goto dont_test_tx_en;
 
+#ifdef CONFIG_SERIAL_8250_BUG_TXEN
 	/*
 	 * Do a quick test to see if we receive an
 	 * interrupt when we enable the TX irq.
@@ -2001,6 +2002,7 @@ static int serial8250_startup(struct uart_port *port)
 	} else {
 		up->bugs &= ~UART_BUG_TXEN;
 	}
+#endif /* CONFIG_SERIAL_8250_BUG_TXEN */
 
 dont_test_tx_en:
 	spin_unlock_irqrestore(&up->port.lock, flags);
diff --git a/drivers/serial/Kconfig b/drivers/serial/Kconfig
index 0658b32..26f2868 100644
--- a/drivers/serial/Kconfig
+++ b/drivers/serial/Kconfig
@@ -182,6 +182,19 @@ config SERIAL_8250_MANY_PORTS
 	  say N here to save some memory. You can also say Y if you have an
 	  "intelligent" multiport card such as Cyclades, Digiboards, etc.
 
+config SERIAL_8250_BUG_TXEN
+	bool "Autodetect faulty 8250 UARTs"
+	depends on SERIAL_8250
+	default y
+	help
+	  Say Y here if you want the kernel to try to determine if your
+	  UART raises an interrupt when its transmit buffer is empty.
+
+	  The auto-detection of UARTs with faulty TXEN has been known to
+	  occasionally return false positives.  If you know that your
+	  UART is okay for your board then you may disable this.
+
+
 #
 # Multi-port serial cards
 #
-- 
1.6.0.4

