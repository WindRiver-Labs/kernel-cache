From 7874eb3f287b7ab745168b01986288c647a8c3a3 Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Mon, 21 Nov 2011 10:57:18 +0800
Subject: [PATCH] cgl: apic-level-smp-affinity.patch

Cherry pick from preempt_rt, this will fix the 'setting smp affinity'
of some IRQs.

The upstream url is:
http://www.kernel.org/pub/linux/kernel/projects/rt/2.6.26/
patch name: apic-level-smp-affinity.patch

Integrated-by: Yong Zhang <yong.zhang@windriver.com>
---
 arch/x86/kernel/io_apic_64.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/arch/x86/kernel/io_apic_64.c b/arch/x86/kernel/io_apic_64.c
index 6ad530f..7722733 100644
--- a/arch/x86/kernel/io_apic_64.c
+++ b/arch/x86/kernel/io_apic_64.c
@@ -1512,6 +1512,15 @@ static void ack_apic_level(unsigned int irq)
 			move_masked_irq(irq);
 		unmask_IO_APIC_irq(irq);
 	}
+#if (defined(CONFIG_GENERIC_PENDING_IRQ) || defined(CONFIG_IRQBALANCE)) && \
+	defined(CONFIG_PREEMPT_HARDIRQS)
+	/*
+	 * With threaded interrupts, we always have IRQ_INPROGRESS
+	 * when acking.
+	 */
+	else if (unlikely(irq_desc[irq].status & IRQ_MOVE_PENDING))
+		move_masked_irq(irq);
+#endif
 }
 
 static struct irq_chip ioapic_chip __read_mostly = {
-- 
1.7.0.4

