From 26dc968ef7f40be7be540b3d254efd7f1e877da6 Mon Sep 17 00:00:00 2001
From: fli <fupan.li@windriver.com>
Date: Wed, 8 Jan 2014 14:12:45 +0800
Subject: [PATCH 2/3] emgd: add the mode_config.lock to protect the
 unreference of fb

To unreference the fb should be under the protection of
mode_config.lock. Otherwise, function of drm_framebuffer_unreference
will complain the following warning:

WARNING: at linux/drivers/gpu/drm/drm_crtc.c:328 drm_framebuffer_unreference+0x7f/0x90()
Hardware name: VALLEYVIEW B3 PLATFORM
Modules linked in: drm_kms_helper emgd dwc3_pci video igb(O) dwc3 x_tables ip_tables
Pid: 1184, comm: Xorg Tainted: G           O 3.4.43-rt56-WR5.0.1.0_preempt-rt #3
Call Trace:
 [<ffffffff81037164>] warn_slowpath_common+0x84/0xc0
 [<ffffffff810371ba>] warn_slowpath_null+0x1a/0x20
 [<ffffffff8142d9bf>] drm_framebuffer_unreference+0x7f/0x90
 [<ffffffffa0011691>] emgd_fbcon_initial_config+0x131/0x10f0 [emgd]
 [<ffffffff8135e89f>] ? string.isra.4+0x3f/0xf0
 [<ffffffff8135f926>] ? vsnprintf+0x216/0x620
 [<ffffffff8106b772>] ? get_parent_ip+0x12/0x60
 [<ffffffff8135fd72>] ? sprintf+0x42/0x50
 [<ffffffff8106b772>] ? get_parent_ip+0x12/0x60
 [<ffffffff8106b772>] ? get_parent_ip+0x12/0x60
 [<ffffffff817e73fd>] ? sub_preempt_count+0x9d/0xd0
 [<ffffffff8106cbd8>] ? migrate_enable+0x88/0x1a0
 [<ffffffff8106b772>] ? get_parent_ip+0x12/0x60
 [<ffffffff8106b772>] ? get_parent_ip+0x12/0x60
 [<ffffffff817e73fd>] ? sub_preempt_count+0x9d/0xd0
 [<ffffffffa001b146>] emgd_driver_lastclose+0x36/0xe0 [emgd]
 [<ffffffff8112c63b>] ? unlock_slab_and_free_delayed.isra.41+0x8b/0xc0
 [<ffffffff8141f9c9>] drm_lastclose+0x49/0x290
 [<ffffffff814202c5>] drm_release+0x465/0x640
 [<ffffffff81139788>] fput+0xf8/0x270
 [<ffffffff811358a9>] filp_close+0x69/0x90
 [<ffffffff8113599c>] sys_close+0xcc/0x1c0
 [<ffffffff817eaf12>] system_call_fastpath+0x16/0x1b
---[ end trace 0000000000000002 ]---

Signed-off-by: fupan li <fupan.li@windriver.com>
---
 drivers/gpu/drm/emgd/src/core/emgd_fbcon.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/gpu/drm/emgd/src/core/emgd_fbcon.c b/drivers/gpu/drm/emgd/src/core/emgd_fbcon.c
index a207d45..5529e7d 100644
--- a/drivers/gpu/drm/emgd/src/core/emgd_fbcon.c
+++ b/drivers/gpu/drm/emgd/src/core/emgd_fbcon.c
@@ -1078,8 +1078,11 @@ int emgd_fbcon_initial_config(emgd_fbdev_t *emgd_fbdev, int alloc_fb)
 			/* Capture currently attach fb so we can unpin it */
 			oldfb = crtc->fb;
 #if LINUX_VERSION_CODE > KERNEL_VERSION(3, 4, 0)
-			if (oldfb)
+			if (oldfb) {
+				mutex_lock(&oldfb->dev->mode_config.mutex);
 				drm_framebuffer_unreference(oldfb);
+				mutex_unlock(&oldfb->dev->mode_config.mutex);
+			}
 #endif
 
 			crtc->fb = &emgd_fbdev->emgd_fb->base;
-- 
1.7.5.4

