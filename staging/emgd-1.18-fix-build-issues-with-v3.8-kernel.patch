From a18cbb7a2886206815dbf6c85caed3cb020801e0 Mon Sep 17 00:00:00 2001
From: Nitin A Kamble <nitin.a.kamble@intel.com>
Date: Tue, 26 Feb 2013 10:13:27 -0800
Subject: [PATCH 3/3] emgd-1.18 fix build issues with v3.8 kernel

These changes are made according to these existing commits in the v3.8 tree

b0071efe : drm: kill reclaim_buffers callback
760285e7 : UAPI: (Scripted) Convert #include "..." to #include <path/...> in drivers/gpu/
56550d94 : Drivers: gpu: remove __dev* attributes.
314e51b9 : mm: kill vma flag VM_RESERVED and mm->reserved_vm counter
a69ac9ea : drm/gma500: drm_connector_property -> drm_object_property

Signed-off-by: Nitin A Kamble <nitin.a.kamble@intel.com>
---
 drivers/gpu/drm/emgd/emgd/drm/emgd_connector.c              |    2 +-
 drivers/gpu/drm/emgd/emgd/drm/emgd_drv.c                    |    3 +--
 drivers/gpu/drm/emgd/emgd/drm/emgd_fb.c                     |   10 +++++-----
 drivers/gpu/drm/emgd/emgd/drm/emgd_interface.c              |    2 +-
 drivers/gpu/drm/emgd/emgd/drm/emgd_mmap.c                   |    2 +-
 drivers/gpu/drm/emgd/emgd/drm/emgd_test_pvrsrv.c            |    2 +-
 drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/mmap.c   |    2 +-
 drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/module.c |    2 +-
 drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/osfunc.c |    2 +-
 9 files changed, 13 insertions(+), 14 deletions(-)

diff --git a/drivers/gpu/drm/emgd/emgd/drm/emgd_connector.c b/drivers/gpu/drm/emgd/emgd/drm/emgd_connector.c
index b62c2ca..6aa461a 100644
--- a/drivers/gpu/drm/emgd/emgd/drm/emgd_connector.c
+++ b/drivers/gpu/drm/emgd/emgd/drm/emgd_connector.c
@@ -299,7 +299,7 @@ static int emgd_connector_set_property(struct drm_connector *connector,
 
 	/* Set the property value to the new one.  This doesn't actually change
      * anything on the HW. */
-	ret = drm_connector_property_set_value(connector, property, value);
+	ret = drm_object_property_set_value(&connector->base, property, value);
 	if (ret) {
 		return ret;
 	}
diff --git a/drivers/gpu/drm/emgd/emgd/drm/emgd_drv.c b/drivers/gpu/drm/emgd/emgd/drm/emgd_drv.c
index 58927c6..21f1c41 100755
--- a/drivers/gpu/drm/emgd/emgd/drm/emgd_drv.c
+++ b/drivers/gpu/drm/emgd/emgd/drm/emgd_drv.c
@@ -2372,7 +2372,7 @@ irqreturn_t emgd_driver_irq_handler(int irq, void *arg)
 } /* emgd_driver_irq_handler() */
 
 
-static int __devinit emgd_pci_probe(struct pci_dev *pdev,
+static int emgd_pci_probe(struct pci_dev *pdev,
 		const struct pci_device_id *ent)
 {
 	if (PCI_FUNC(pdev->devfn)) {
@@ -2503,7 +2503,6 @@ static struct drm_driver driver = {
 	.irq_postinstall    = emgd_driver_irq_postinstall,
 	.irq_uninstall      = emgd_driver_irq_uninstall,
 	.irq_handler        = emgd_driver_irq_handler,
-	.reclaim_buffers    = drm_core_reclaim_buffers,
 #if LINUX_VERSION_CODE < KERNEL_VERSION(2,6,37)
 	.get_map_ofs        = drm_core_get_map_ofs,
 	.get_reg_ofs        = drm_core_get_reg_ofs,
diff --git a/drivers/gpu/drm/emgd/emgd/drm/emgd_fb.c b/drivers/gpu/drm/emgd/emgd/drm/emgd_fb.c
index 8683477..6bd3a47 100644
--- a/drivers/gpu/drm/emgd/emgd/drm/emgd_fb.c
+++ b/drivers/gpu/drm/emgd/emgd/drm/emgd_fb.c
@@ -41,7 +41,7 @@
 #include <linux/module.h>
 #endif
 #include <drmP.h>
-#include <drm.h>
+#include <uapi/drm/drm.h>
 #include <drm_crtc.h>
 #include <drm_crtc_helper.h>
 #include <drm_fb_helper.h>
@@ -539,7 +539,7 @@ static void create_connector_properties(struct drm_device *dev,
 				continue;
 		}
 
-		drm_connector_attach_property(drm_connector, new_prop, current_value);
+		drm_object_attach_property(&drm_connector->base, new_prop, current_value);
 		emgd_connector->properties[num_of_properties++] = new_prop;
 	}
 
@@ -646,12 +646,12 @@ static void create_connectors(struct drm_device *dev,
 
 
 #if 0
-        drm_connector_attach_property(&connector->base,
+        drm_object_attach_property(&connector->base,
                         dev->mode_config.scaling_mode_property,
                         DRM_MODE_SCALE_FULLSCREEN);
-        drm_connector_attach_property(&connector->base,
+        drm_object_attach_property(&connector->base,
                        dev->mode_config.edid_property, 0);
-        drm_connector_attach_property(&connector->base,
+        drm_object_attach_property(&connector->base,
                        dev->mode_config.dpms_property, 0);
 #endif
 
diff --git a/drivers/gpu/drm/emgd/emgd/drm/emgd_interface.c b/drivers/gpu/drm/emgd/emgd/drm/emgd_interface.c
index 5625442..e6e07a2 100755
--- a/drivers/gpu/drm/emgd/emgd/drm/emgd_interface.c
+++ b/drivers/gpu/drm/emgd/emgd/drm/emgd_interface.c
@@ -36,7 +36,7 @@
 #define MODULE_NAME hal.oal
 
 #include "drmP.h"
-#include "drm.h"
+#include "uapi/drm/drm.h"
 
 #include "drm_emgd_private.h"
 #include "emgd_drm.h"
diff --git a/drivers/gpu/drm/emgd/emgd/drm/emgd_mmap.c b/drivers/gpu/drm/emgd/emgd/drm/emgd_mmap.c
index c1d13a2..01ebdae 100644
--- a/drivers/gpu/drm/emgd/emgd/drm/emgd_mmap.c
+++ b/drivers/gpu/drm/emgd/emgd/drm/emgd_mmap.c
@@ -101,7 +101,7 @@ int emgd_mmap(struct file *filp, struct vm_area_struct *vma)
 	 */
 	vma->vm_ops = &emgd_vm_ops;
 	vma->vm_private_data = chunk;
-	vma->vm_flags |= VM_RESERVED | VM_IO | VM_MIXEDMAP | VM_DONTEXPAND;
+	vma->vm_flags |= VM_IO | VM_MIXEDMAP | VM_DONTEXPAND | VM_DONTDUMP;
 	pgprot_val(vma->vm_page_prot) =
 		pgprot_val(vma->vm_page_prot) | _PAGE_CACHE_UC_MINUS;
 
diff --git a/drivers/gpu/drm/emgd/emgd/drm/emgd_test_pvrsrv.c b/drivers/gpu/drm/emgd/emgd/drm/emgd_test_pvrsrv.c
index 6ba4567..835adc3 100644
--- a/drivers/gpu/drm/emgd/emgd/drm/emgd_test_pvrsrv.c
+++ b/drivers/gpu/drm/emgd/emgd/drm/emgd_test_pvrsrv.c
@@ -34,7 +34,7 @@
 #define MODULE_NAME hal.oal
 
 #include "drmP.h"
-#include "drm.h"
+#include "uapi/drm/drm.h"
 
 #include "drm_emgd_private.h"
 #include "emgd_drm.h"
diff --git a/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/mmap.c b/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/mmap.c
index a273689..5f3ec9b 100644
--- a/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/mmap.c
+++ b/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/mmap.c
@@ -639,7 +639,7 @@ PVRMMap(struct file* pFile, struct vm_area_struct* ps_vma)
     PVR_DPF((PVR_DBG_MESSAGE, "%s: Mapped psLinuxMemArea 0x%p\n",
          __FUNCTION__, psOffsetStruct->psLinuxMemArea));
 #endif
-    ps_vma->vm_flags |= VM_RESERVED;
+    ps_vma->vm_flags |= VM_DONTEXPAND | VM_DONTDUMP;
     ps_vma->vm_flags |= VM_IO;
 
 
diff --git a/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/module.c b/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/module.c
index 0fd336b..b49a19b 100644
--- a/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/module.c
+++ b/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/module.c
@@ -218,7 +218,7 @@ static struct platform_device powervr_device = {
 static IMG_INT PVRSRVDriverProbe(LDM_DEV *pDevice)
 #endif
 #if defined(PVR_LDM_PCI_MODULE)
-static IMG_INT __devinit PVRSRVDriverProbe(LDM_DEV *pDevice, const struct pci_device_id *id)
+static IMG_INT PVRSRVDriverProbe(LDM_DEV *pDevice, const struct pci_device_id *id)
 #endif
 {
 	SYS_DATA *psSysData;
diff --git a/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/osfunc.c b/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/osfunc.c
index ba666a9..7b98722 100644
--- a/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/osfunc.c
+++ b/drivers/gpu/drm/emgd/pvr/services4/srvkm/env/linux/osfunc.c
@@ -2382,7 +2382,7 @@ PVRSRV_ERROR OSAcquirePhysPageAddr(IMG_VOID* pvCPUVAddr,
     }
 
 
-    if ((psVMArea->vm_flags & (VM_IO | VM_RESERVED)) != (VM_IO | VM_RESERVED))
+    if ((psVMArea->vm_flags & (VM_IO | VM_DONTEXPAND | VM_DONTDUMP)) != (VM_IO | VM_DONTEXPAND | VM_DONTDUMP))
     {
         PVR_DPF((PVR_DBG_ERROR,
             "OSAcquirePhysPageAddr: Memory region does not represent memory mapped I/O (VMA flags: 0x%lx)", psVMArea->vm_flags));
-- 
1.7.10.4

