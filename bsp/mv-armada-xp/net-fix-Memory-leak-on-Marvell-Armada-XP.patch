From be4cf4cd4f5192eca2505a04e614bff6d3874a87 Mon Sep 17 00:00:00 2001
From: Baogen Shang <baogen.shang@windriver.com>
Date: Fri, 16 May 2014 11:13:42 +0800
Subject: [PATCH] net:fix Memory leak on Marvell Armada XP

On Marvell Armada XP,If Let the NET_SKB_RECYCLE = y,It will be lead to the
memory leak When the network card receive packages.the root cause is that the
callback function "mv_eth_skb_recycle" responsible for recycling of memory
never be called.But considering the SKB recycling mechanism has been unused,
and dropped from Linux completely since 3.5.x.So the fix is that disable it
in the BSP config, and then patch the kernel and add:

   depends on BROKEN

To the NET_SKB_RECYCLE Kconfig. This let it can't be enabled again.

Signed-off-by: baogen shang <baogen.shang@windriver.com>
---
 .../arm/plat-armada/mv_drivers_lsp/mv_neta/Kconfig |    3 ++-
 .../plat-armada/mv_drivers_lsp/mv_network/Kconfig  |    3 ++-
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/Kconfig b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/Kconfig
index 415d0e2..067f1e1 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/Kconfig
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/Kconfig
@@ -548,8 +548,9 @@ config  NET_SKB_HEADROOM
           Customize SKB headroom size. Must be power of 2.
 
 config NET_SKB_RECYCLE
+        depends on BROKEN
         bool "Skb recycle"
-        default y
+        default n
         ---help---
           Work-in-progress and experimental.
 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_network/Kconfig b/arch/arm/plat-armada/mv_drivers_lsp/mv_network/Kconfig
index a67f8c2..330bf89 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_network/Kconfig
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_network/Kconfig
@@ -184,8 +184,9 @@ config  NET_SKB_HEADROOM
           Customize SKB headroom size. Must be power of 2.
 
 config  NET_SKB_RECYCLE
+        depends on BROKEN
         bool "Try to recycle SKB"
-        default y
+        default n
         ---help---
           Recycle SKB via callback in 'struct sk_buff'
 
-- 
1.7.5.4

