From fca2e8a4dd19047e8066461f2eab5e33f212d909 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Mon, 14 Jan 2013 19:39:11 +0800
Subject: [PATCH 2/5] mv_ethernet: change smp_call_function_many to smp_call_function

Before using smp_call_function_many, Preemption must be disabled.
smp_call_function do this function.

> ifconfig eth0 up
added eth0: link up BUG: using smp_processor_id() in
preemptible [00000000 00000000] code: ifconfig/871 caller
is smp_call_function_many+0x2c/0x284 [<c0017c18>]
(unwind_backtrace+0x0/0x104) from [<c0650a48>]
(dump_stack+0x20/0x24) [<c0650a48>] (dump_stack+0x20/0x24)
from [<c038cab8>] (debug_smp_processor_id+0x128/0x138)
[<c038cab8>] (debug_smp_processor_id+0x128/0x138) from
[<c00aea7c>] (smp_call_function_many+0x2c/0x284)
[<c00aea7c>] (smp_call_function_many+0x2c/0x284) from
[<c04531d4>] (mv_eth_start+0x1a8/0x300) [<c04531d4>]
(mv_eth_start+0x1a8/0x300) from [<c04537ac>]
(mv_eth_open+0x3c/0x74) [<c04537ac>]
(mv_eth_open+0x3c/0x74) from [<c054c098>]
(__dev_open+0xb0/0x110) [<c054c098>]
(__dev_open+0xb0/0x110) from [<c054c310>]
(__dev_change_flags+0x94/0x14c) [<c054c310>]
(__dev_change_flags+0x94/0x14c) from [<c054c454>]
(dev_change_flags+0x20/0x58) [<c054c454>]
(dev_change_flags+0x20/0x58) from [<c05af4ec>]
(devinet_ioctl+0x684/0x728) [<c05af4ec>]
(devinet_ioctl+0x684/0x728) from [<c05b01b8>]
(inet_ioctl+0x1c0/0x1d0) [<c05b01b8>]
(inet_ioctl+0x1c0/0x1d0) from [<c0530ec4>]
(sock_ioctl+0x74/0x2a8) [<c0530ec4>]
(sock_ioctl+0x74/0x2a8) from [<c016df20>]
(do_vfs_ioctl+0x94/0x5f0) [<c016df20>]
(do_vfs_ioctl+0x94/0x5f0) from [<c016e514>]
(sys_ioctl+0x98/0x124) [<c016e514>] (sys_ioctl+0x98/0x124)
from [<c000e7c0>] (ret_fast_syscall+0x0/0x30) BUG: using

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_neta/net_dev/mv_ethernet.c   |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_ethernet.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_ethernet.c
index 1c0cb11..02aa3d1 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_ethernet.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_ethernet.c
@@ -110,7 +110,7 @@ static int mv_eth_start(struct net_device *dev)
 
 		/* unmask interrupts */
 		mv_eth_interrupts_unmask(priv);
-		smp_call_function_many(cpu_online_mask, (smp_call_func_t)mv_eth_interrupts_unmask, (void *)priv, 1);
+		smp_call_function((smp_call_func_t)mv_eth_interrupts_unmask, (void *)priv, 1);
 
 		printk(KERN_NOTICE "%s: started\n", dev->name);
 	}
-- 
1.7.0

