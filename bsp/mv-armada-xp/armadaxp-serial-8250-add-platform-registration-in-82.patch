From c1e0547603c71aafd036d16175631f705b5a38a9 Mon Sep 17 00:00:00 2001
From: Wang Hui <Hui.Wang@windriver.com>
Date: Wed, 16 Jan 2013 11:01:59 +0800
Subject: [PATCH 18/50] armadaxp: serial: 8250: add platform registration in 8250_dw

Current 8250_dw only supports device tree registration, while Marvell
vendor linux registers uart via platform, so add platform interface
support in this file.

The code is extracted from linux-3.2.27-axp_a370-2012_Q4.1, which
can be downloaded from:
https://extranet.marvell.com/extranet/dms/documents.do?groupID=4&\
subGroupID=53015

Signed-off-by: Wang Hui <Hui.Wang@windriver.com>
---
 drivers/tty/serial/8250/8250_dw.c |   12 ++++++++++++
 drivers/tty/serial/8250/Kconfig   |    2 +-
 2 files changed, 13 insertions(+), 1 deletions(-)

diff --git a/drivers/tty/serial/8250/8250_dw.c b/drivers/tty/serial/8250/8250_dw.c
index b6dc908..4fecf11 100644
--- a/drivers/tty/serial/8250/8250_dw.c
+++ b/drivers/tty/serial/8250/8250_dw.c
@@ -89,6 +89,10 @@ static int dw8250_handle_irq(struct uart_port *p)
 
 static int __devinit dw8250_probe(struct platform_device *pdev)
 {
+
+#ifdef CONFIG_ARCH_ARMADA_XP
+struct plat_serial8250_port *p = pdev->dev.platform_data;
+#endif
 	struct uart_port port = {};
 	struct resource *regs = platform_get_resource(pdev, IORESOURCE_MEM, 0);
 	struct resource *irq = platform_get_resource(pdev, IORESOURCE_IRQ, 0);
@@ -118,6 +122,7 @@ static int __devinit dw8250_probe(struct platform_device *pdev)
 	port.iotype = UPIO_MEM;
 	port.serial_in = dw8250_serial_in;
 	port.serial_out = dw8250_serial_out;
+#ifndef CONFIG_ARCH_ARMADA_XP
 	if (!of_property_read_u32(np, "reg-io-width", &val)) {
 		switch (val) {
 		case 1:
@@ -142,6 +147,13 @@ static int __devinit dw8250_probe(struct platform_device *pdev)
 		return -EINVAL;
 	}
 	port.uartclk = val;
+#else
+	port.iotype = p->iotype;
+	port.serial_in = dw8250_serial_in32;
+	port.serial_out = dw8250_serial_out32;
+	port.regshift = p->regshift;
+	port.uartclk = p->uartclk;
+#endif
 
 	data->line = serial8250_register_port(&port);
 	if (data->line < 0)
diff --git a/drivers/tty/serial/8250/Kconfig b/drivers/tty/serial/8250/Kconfig
index 8bc7ecb..64eca4e 100644
--- a/drivers/tty/serial/8250/Kconfig
+++ b/drivers/tty/serial/8250/Kconfig
@@ -274,7 +274,7 @@ config SERIAL_8250_FSL
 
 config SERIAL_8250_DW
 	tristate "Support for Synopsys DesignWare 8250 quirks"
-	depends on SERIAL_8250 && OF
+	depends on SERIAL_8250 && (OF || ARCH_ARMADA_XP)
 	help
 	  Selecting this option will enable handling of the extra features
 	  present in the Synopsys DesignWare APB UART.
-- 
1.7.0

