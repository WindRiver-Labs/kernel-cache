From e9d185c46cdd9a83c21d4fe9598d7b3582f27319 Mon Sep 17 00:00:00 2001
From: Wang Hui <Hui.Wang@windriver.com>
Date: Tue, 15 Jan 2013 11:44:41 +0800
Subject: [PATCH 08/50] arm: armadaxp: vfp: add vfp save and restore for deep idle

When aramdaxp enter deep idle, the vfp coprocessor will be powered
off, we need to save and restore its state for deep idle.

The code is extracted from linux-3.2.27-axp_a370-2012_Q4.1, which
can be downloaded from:
https://extranet.marvell.com/extranet/dms/documents.do?groupID=4&\
subGroupID=53015

Signed-off-by: Wang Hui <Hui.Wang@windriver.com>
---
 arch/arm/include/asm/vfp.h |    7 +++++++
 arch/arm/vfp/vfpmodule.c   |   17 +++++++++++++++++
 2 files changed, 24 insertions(+), 0 deletions(-)

diff --git a/arch/arm/include/asm/vfp.h b/arch/arm/include/asm/vfp.h
index f4ab34f..d152efd 100644
--- a/arch/arm/include/asm/vfp.h
+++ b/arch/arm/include/asm/vfp.h
@@ -82,3 +82,10 @@
 #define VFPOPDESC_UNUSED_BIT	(24)
 #define VFPOPDESC_UNUSED_MASK	(0xFF << VFPOPDESC_UNUSED_BIT)
 #define VFPOPDESC_OPDESC_MASK	(~(VFPOPDESC_LENGTH_MASK | VFPOPDESC_UNUSED_MASK))
+
+#ifndef __ASSEMBLY__
+#ifdef CONFIG_CPU_PM
+extern void vfp_save(void);
+extern void vfp_restore(void);
+#endif
+#endif /* __ASSEMBLY__ */
diff --git a/arch/arm/vfp/vfpmodule.c b/arch/arm/vfp/vfpmodule.c
index 3b36062..224220e 100644
--- a/arch/arm/vfp/vfpmodule.c
+++ b/arch/arm/vfp/vfpmodule.c
@@ -648,6 +648,23 @@ static int vfp_hotplug(struct notifier_block *b, unsigned long action,
 	return NOTIFY_OK;
 }
 
+#ifdef CONFIG_CPU_PM
+void vfp_save(void)
+{
+        /*
+         * if VFP was not initialized yet, then do nothing
+         */
+        if (VFP_arch)
+                vfp_pm_suspend();
+}
+
+void vfp_restore(void)
+{
+        if (VFP_arch)
+                vfp_pm_resume();
+}
+#endif
+
 /*
  * VFP support code initialisation.
  */
-- 
1.7.0

