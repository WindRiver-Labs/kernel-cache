From 4e8a6a8e8351b222077ad4f3c6f8bd4bcbc1f865 Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Thu, 14 May 2015 17:10:07 +0800
Subject: [PATCH] ARM: armadaxp: Set SMP bit for IO coherency

Coherency mode should be enabled when device I/O coherency
is activated.

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 arch/arm/mm/proc-sheeva_pj4bv7lpae.S |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mm/proc-sheeva_pj4bv7lpae.S b/arch/arm/mm/proc-sheeva_pj4bv7lpae.S
index 234b8e3..7de23ad 100644
--- a/arch/arm/mm/proc-sheeva_pj4bv7lpae.S
+++ b/arch/arm/mm/proc-sheeva_pj4bv7lpae.S
@@ -280,7 +280,8 @@ __pj4bv7_setup:
 
 /* Auxiliary Functional Modes Control Register 0 */
 	mrc        p15, 1, r0, c15, c2, 0                         /* Read */
-#ifdef CONFIG_SMP
+/* SMP mode is necessay for IO coherency */
+#if defined(CONFIG_SMP) || defined(CONFIG_AURORA_IO_CACHE_COHERENCY)
 	orr          r0, r0, #0x00002                                /* BIT1 SMP/nAMP --> '1' taking part in coherency */
 #endif
 	orr     r0, r0, #0x00004                                /* BIT2 L1 parity --> '1' Enabled */
@@ -319,7 +320,8 @@ __pj4bv7_setup:
 
 /* Auxiliary Functional Modes Control Register 0 */
 	mrc        p15, 1, r0, c15, c2, 0                         /* Read */
-#ifdef CONFIG_SMP
+/* SMP mode is necessay for IO coherency */
+#if defined(CONFIG_SMP) || defined(CONFIG_AURORA_IO_CACHE_COHERENCY)
 	orr          r0, r0, #0x00002                                /* BIT1 SMP/nAMP --> '1' taking part in coherency */
 #endif
 	orr     r0, r0, #0x00004                                /* BIT2 L1 parity --> '1' Enabled */
-- 
1.7.5.4

