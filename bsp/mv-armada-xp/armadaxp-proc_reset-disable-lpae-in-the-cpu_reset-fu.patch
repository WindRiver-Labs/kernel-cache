From 73f930e1e56b03763b70671ee42c6deb90945b1c Mon Sep 17 00:00:00 2001
From: Wang Hui <Hui.Wang@windriver.com>
Date: Wed, 26 Dec 2012 15:26:55 +0800
Subject: [PATCH 42/50] armadaxp: proc_reset: disable lpae in the cpu_reset function

When enter cpu_reset from kexec, we will disable mmu first then jump
to a new physical address to execute the loaded kernel, this can work
under non-lpae kernel, but if it is a lpae kernel, we need to disable
lpae via TTBCR, otherwise cpu can't jump to loaded kernel successfully.

Signed-off-by: Wang Hui <Hui.Wang@windriver.com>
---
 arch/arm/mm/proc-sheeva_pj4bv7lpae.S |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mm/proc-sheeva_pj4bv7lpae.S b/arch/arm/mm/proc-sheeva_pj4bv7lpae.S
index 33cf39d..1d67518 100644
--- a/arch/arm/mm/proc-sheeva_pj4bv7lpae.S
+++ b/arch/arm/mm/proc-sheeva_pj4bv7lpae.S
@@ -95,6 +95,11 @@ ENTRY(cpu_pj4bv7_reset)
 	mcr	p15, 0, r1, c1, c0, 0		@ disable MMU
 	isb
 
+	mrc	p15, 0, r1, c2, c0, 2		@ TTB control register
+	bic	r1, r1, #1<<31
+	mcr	p15, 0, r1, c2, c0, 2		@ TTB control register
+	isb
+
 	mov	pc, r0
 ENDPROC(cpu_pj4bv7_reset)
 	.popsection
-- 
1.7.0

