From 1d9f72d62b66fedbb0f0cbfa1ac7ce948f93ff19 Mon Sep 17 00:00:00 2001
From: Shan Hai <shan.hai@windriver.com>
Date: Tue, 10 Dec 2013 16:28:45 +0800
Subject: [PATCH] arm/mv_ethernet: fix erroenous smp_call_function_many
 calling

The below kernel BUG will be triggered by running 'ifconfig ethX up',
because of the smp_call_function_many is called from preemption enabled
context. Fix it by calling the function with the preemption disabled.

BUG: using smp_processor_id() in preemptible [00000000] code: ifconfig/718
caller is smp_call_function_many+0x2c/0x288
[<c0017d3c>] (unwind_backtrace+0x0/0x104) from [<c0655618>] (dump_stack+0x20/0x24)
[<c0655618>] (dump_stack+0x20/0x24) from [<c03b11f4>] (debug_smp_processor_id+0xe0/0xf0)
[<c03b11f4>] (debug_smp_processor_id+0xe0/0xf0) from [<c00c5da8>] (smp_call_function_many+0x2c/0x288)
[<c00c5da8>] (smp_call_function_many+0x2c/0x288) from [<c00692f8>] (mv_eth_start+0x1a8/0x300)
[<c00692f8>] (mv_eth_start+0x1a8/0x300) from [<c00698d0>] (mv_eth_open+0x3c/0x74)
[<c00698d0>] (mv_eth_open+0x3c/0x74) from [<c0557f30>] (__dev_open+0xb0/0x10c)
[<c0557f30>] (__dev_open+0xb0/0x10c) from [<c05581a4>] (__dev_change_flags+0x94/0x14c)
[<c05581a4>] (__dev_change_flags+0x94/0x14c) from [<c05582e8>] (dev_change_flags+0x20/0x58)
[<c05582e8>] (dev_change_flags+0x20/0x58) from [<c05b984c>] (devinet_ioctl+0x684/0x728)
[<c05b984c>] (devinet_ioctl+0x684/0x728) from [<c05ba508>] (inet_ioctl+0x1c0/0x1d0)
[<c05ba508>] (inet_ioctl+0x1c0/0x1d0) from [<c053d250>] (sock_ioctl+0x74/0x2a8)
[<c053d250>] (sock_ioctl+0x74/0x2a8) from [<c01883f4>] (do_vfs_ioctl+0x94/0x5e8)
[<c01883f4>] (do_vfs_ioctl+0x94/0x5e8) from [<c01889e0>] (sys_ioctl+0x98/0x124)
[<c01889e0>] (sys_ioctl+0x98/0x124) from [<c000e7e0>] (ret_fast_syscall+0x0/0x48)

Signed-off-by: Shan Hai <shan.hai@windriver.com>
---
 .../mv_drivers_lsp/mv_neta/net_dev/mv_ethernet.c   |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_ethernet.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_ethernet.c
index 1c0cb11..342441b 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_ethernet.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_ethernet.c
@@ -110,8 +110,9 @@ static int mv_eth_start(struct net_device *dev)
 
 		/* unmask interrupts */
 		mv_eth_interrupts_unmask(priv);
+		preempt_disable();
 		smp_call_function_many(cpu_online_mask, (smp_call_func_t)mv_eth_interrupts_unmask, (void *)priv, 1);
-
+		preempt_enable();
 		printk(KERN_NOTICE "%s: started\n", dev->name);
 	}
 	return 0;
-- 
1.7.5.4

