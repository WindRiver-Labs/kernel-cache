From 87730dfeb596dce0ab06b6ac644d10eabbd266b0 Mon Sep 17 00:00:00 2001
From: Wang Hui <Hui.Wang@windriver.com>
Date: Wed, 16 Jan 2013 10:37:39 +0800
Subject: [PATCH 16/50] arm: armadaxp: pci: fix pci resource assignment

Marvell's original driver was based on linux-3.2, and as such,
some modifications are required to make it compile against
linux-3.4.

In the linux-3.2, the struct pci_sys_data has member struct
resource[], but in the linux-3.4, the member is changed to struct
list_head resources, so we need to modify relating code.

Signed-off-by: Wang Hui <Hui.Wang@windriver.com>
---
 arch/arm/mach-armadaxp/pci.c |   10 ++++------
 arch/arm/mach-armadaxp/pex.c |   13 ++++---------
 2 files changed, 8 insertions(+), 15 deletions(-)

diff --git a/arch/arm/mach-armadaxp/pci.c b/arch/arm/mach-armadaxp/pci.c
index 6951093..d00793b 100644
--- a/arch/arm/mach-armadaxp/pci.c
+++ b/arch/arm/mach-armadaxp/pci.c
@@ -192,12 +192,10 @@ int __init mv_pci_setup(int nr, struct pci_sys_data *sys)
 
 	if (request_resource(&iomem_resource, &res[1]))
 		printk ("Memory Request resource failed - Pci If %x\n",nr);
- 
-        sys->resource[0] = &res[0];
-        sys->resource[1] = &res[1];
-        sys->resource[2] = NULL;
-        sys->io_offset   = 0x0;
- 
+
+	pci_add_resource_offset(&sys->resources, &res[0], sys->io_offset);
+	pci_add_resource_offset(&sys->resources, &res[1], sys->io_offset);
+
         return 1;
 
 }
diff --git a/arch/arm/mach-armadaxp/pex.c b/arch/arm/mach-armadaxp/pex.c
index ab2f3bd..6063cd2 100644
--- a/arch/arm/mach-armadaxp/pex.c
+++ b/arch/arm/mach-armadaxp/pex.c
@@ -297,15 +297,10 @@ int __init mv_pex_setup(int nr, struct pci_sys_data *sys)
 		printk ("Memory Request resource failed - Pci If %x\n",nr);
 	}
  
-	sys->resource[0] = &res[0];
-	if (index > 0) 
-	{
-		sys->resource[1] = &res[1];
-		sys->resource[2] = NULL;
-	}
-	else
-		sys->resource[1] = NULL;
-	sys->io_offset   = 0x0;
+	sys->io_offset = 0x0;
+	pci_add_resource_offset(&sys->resources, &res[0], sys->io_offset);
+	if (index > 0)
+		pci_add_resource_offset(&sys->resources, &res[1], sys->io_offset);
 
 	return 1;
 }
-- 
1.7.0

