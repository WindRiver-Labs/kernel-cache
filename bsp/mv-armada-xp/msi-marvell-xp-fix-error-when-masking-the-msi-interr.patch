From f15a26dc5b2cf98f69593b1d077e6c99cfaa19a2 Mon Sep 17 00:00:00 2001
From: Auto Configured <auto.configured>
Date: Fri, 19 Feb 2016 17:23:45 +0800
Subject: [PATCH] msi: marvell-xp: fix error when masking the msi interrupt

This patch fix an error  when mask msi interrupt, original code can not
enable msi for cpu0 and mask for the other cpus.

Signed-off-by: Auto Configured <auto.configured>
---
 arch/arm/plat-armada/msi.c |   21 ++++++++++++++++++---
 1 files changed, 18 insertions(+), 3 deletions(-)

diff --git a/arch/arm/plat-armada/msi.c b/arch/arm/plat-armada/msi.c
index 202a4dd..5a0988b 100644
--- a/arch/arm/plat-armada/msi.c
+++ b/arch/arm/plat-armada/msi.c
@@ -95,15 +95,15 @@ void __init armada_msi_init(void)
 	irq_set_chained_handler(IRQ_AURORA_SHARE_INB_DB2, armada_msi_irq_handler3);
 
 	temp = MV_REG_READ(CPU_INT_SOURCE_CONTROL_REG(IRQ_AURORA_SHARE_INB_DB0));
-	temp |= 0x1;
+	temp = (temp & ~0xf) | 1;
 	MV_REG_WRITE(CPU_INT_SOURCE_CONTROL_REG(IRQ_AURORA_SHARE_INB_DB0), temp);
 
 	temp = MV_REG_READ(CPU_INT_SOURCE_CONTROL_REG(IRQ_AURORA_SHARE_INB_DB1));
-	temp |= 0x1;
+	temp = (temp & ~0xf) | 1;
 	MV_REG_WRITE(CPU_INT_SOURCE_CONTROL_REG(IRQ_AURORA_SHARE_INB_DB1), temp);
 
 	temp = MV_REG_READ(CPU_INT_SOURCE_CONTROL_REG(IRQ_AURORA_SHARE_INB_DB2));
-	temp |= 0x1;
+	temp = (temp & ~0xf) | 1;
 	MV_REG_WRITE(CPU_INT_SOURCE_CONTROL_REG(IRQ_AURORA_SHARE_INB_DB2), temp);
 
 }
@@ -174,10 +174,25 @@ int armada_msi_set_affinity(struct irq_data *d, const struct cpumask *mask_val,b
 void second_cpu_msi_init(void)
 {
 	unsigned long temp;
+	struct cpumask mask_val;
+	struct irq_data *d;
 	/* Unmask private doorbells 16-31 */
 	temp = MV_REG_READ(AXP_IN_DRBEL_MSK) | (0xFFFF0000);
 	MV_REG_WRITE(AXP_IN_DRBEL_MSK, temp);
 
+	cpumask_set_cpu(0, &mask_val);
+	d = irq_get_irq_data(IRQ_AURORA_SHARE_INB_DB0);
+	if (d)
+		cpumask_copy((*d).affinity, &mask_val);
+
+	d = irq_get_irq_data(IRQ_AURORA_SHARE_INB_DB1);
+	if (d)
+		cpumask_copy((*d).affinity, &mask_val);
+
+	d = irq_get_irq_data(IRQ_AURORA_SHARE_INB_DB2);
+	if (d)
+		cpumask_copy((*d).affinity, &mask_val);
+
 }
 #endif
 
-- 
1.7.5.4

