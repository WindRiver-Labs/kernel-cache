From fccc730c7318270d0fd958ef3d13ca656a25a9b0 Mon Sep 17 00:00:00 2001
From: Baogen Shang <baogen.shang@windriver.com>
Date: Fri, 16 May 2014 16:48:44 +0800
Subject: [PATCH] When CONFIG_ERROR_HANDLING is enabled in kernel
 configuration. Below error can be seen at boot on Armada XP
 board

[ 155.495791] ------------[ cut here ]------------
[ 155.495812] WARNING: at linux-windriver-3.4-r0/linux/kernel/irq/manage.c:1367 request_threaded_irq+0x144/0x154()
[ 155.495829] Modules linked in:
[ 155.495855] [<c0017b70>] (unwind_backtrace+0x0/0x104) from [<c062723c>] (dump_stack+0x20/0x24)
[ 155.495875] [<c062723c>] (dump_stack+0x20/0x24) from [<c00647fc>] (warn_slowpath_common+0x64/0x74)
[ 155.495892] [<c00647fc>] (warn_slowpath_common+0x64/0x74) from [<c0064838>] (warn_slowpath_null+0x2c/0x34)
[ 155.495908] [<c0064838>] (warn_slowpath_null+0x2c/0x34) from [<c00dceb8>] (request_threaded_irq+0x144/0x154)
[ 155.495928] [<c00dceb8>] (request_threaded_irq+0x144/0x154) from [<c08690d0>] (errorhandling_notification_setup+0x110/0x1c8)
[ 155.495946] [<c08690d0>] (errorhandling_notification_setup+0x110/0x1c8) from [<c00084e0>] (do_one_initcall+0x44/0x180)
[ 155.495965] [<c00084e0>] (do_one_initcall+0x44/0x180) from [<c085fa6c>] (kernel_init+0x18c/0x258)
[ 155.495984] [<c085fa6c>] (kernel_init+0x18c/0x258) from [<c000f9fc>] (kernel_thread_exit+0x0/0x8)
[ 155.496014] ---[ end trace 1b75b31a2719ed1c ]---
[ 155.496025] opps: request_irq failed to requestin IRQ# 4, returning now !

The root cause is that In axp_init_irq() function, the system uses the irq_set_percpu_devid(irq)
function set IRQ_PER_CPU_DEVID flag.When register irq,the system will be check the IRQ_PER_CPU_DEVID
flag, if the flag is set,the system will trigger WARN_ON(irq_settings_is_per_cpu_devid(desc)))
and return failed.So the fix is clear the IRQ_PER_CPU_DEVID flag before register the irq.

Signed-off-by: baogen shang <baogen.shang@windriver.com>
---
 arch/arm/plat-armada/error_handling.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/error_handling.c b/arch/arm/plat-armada/error_handling.c
index b38dd13..6805f4d 100644
--- a/arch/arm/plat-armada/error_handling.c
+++ b/arch/arm/plat-armada/error_handling.c
@@ -251,6 +251,7 @@ static int __init errorhandling_notification_setup(void)
 
 		/* the MBUS units part of the error handling setup*/
 	INIT_LIST_HEAD(&mbusunit_error_list.list);
+	irq_clear_status_flags(IRQ_AURORA_SOC_ERROR, IRQ_PER_CPU_DEVID);
 	err = request_irq(IRQ_AURORA_SOC_ERROR, armadaxp_mbusunit_error_isr,IRQF_DISABLED , "Armada MBUS unit Error Handler", NULL );
         if(err)
         {
-- 
1.7.5.4

