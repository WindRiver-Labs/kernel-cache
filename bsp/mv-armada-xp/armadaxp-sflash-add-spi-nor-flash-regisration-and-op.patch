From 15043673af5d4d2822c014d6c9e765be9f40c21e Mon Sep 17 00:00:00 2001
From: Wang Hui <Hui.Wang@windriver.com>
Date: Wed, 14 Nov 2012 13:35:37 +0800
Subject: [PATCH 31/50] armadaxp: sflash: add spi nor flash regisration and operation command

On the armadaxp gp and db board, a 16MB spi nor flash is soldered, we
need to reigster it and add its operation to support it.

Signed-off-by: Wang Hui <Hui.Wang@windriver.com>
---
 arch/arm/plat-armada/mv_hal/sflash/mvSFlash.c     |   24 ++++++++++++
 arch/arm/plat-armada/mv_hal/sflash/mvSFlashSpec.h |   42 +++++++++++++++++++++
 2 files changed, 66 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/sflash/mvSFlash.c b/arch/arm/plat-armada/mv_hal/sflash/mvSFlash.c
index 1ec3a86..5d63f98 100644
--- a/arch/arm/plat-armada/mv_hal/sflash/mvSFlash.c
+++ b/arch/arm/plat-armada/mv_hal/sflash/mvSFlash.c
@@ -176,6 +176,30 @@ static MV_SFLASH_DEVICE_PARAMS sflash[] = {
      MV_M25P128_MAX_FAST_SPI_FREQ,
      MV_M25P128_FAST_READ_DUMMY_BYTES
     },
+    /* ST M25Q128 SPI flash, 16MB, 256 sectors of 64K each */
+    {
+     MV_M25Q_WREN_CMND_OPCD,
+     MV_M25Q_WRDI_CMND_OPCD,
+     MV_M25Q_RDID_CMND_OPCD,
+     MV_M25Q_RDSR_CMND_OPCD,
+     MV_M25Q_WRSR_CMND_OPCD,
+     MV_M25Q_READ_CMND_OPCD,
+     MV_M25Q_FAST_RD_CMND_OPCD,
+     MV_M25Q_PP_CMND_OPCD,
+     MV_M25Q_SE_CMND_OPCD,
+     MV_M25Q_BE_CMND_OPCD,
+     MV_M25Q_RES_CMND_OPCD,
+     MV_M25Q_DP_CMND_OPCD,
+     MV_M25Q128_SECTOR_SIZE,
+     MV_M25Q128_SECTOR_NUMBER,
+     MV_M25Q_PAGE_SIZE,
+     "ST M25Q128",
+     MV_M25QXXX_ST_MANF_ID,
+     MV_M25Q128_DEVICE_ID,
+     MV_M25Q128_MAX_SPI_FREQ,
+     MV_M25Q128_MAX_FAST_SPI_FREQ,
+     MV_M25Q128_FAST_READ_DUMMY_BYTES
+    },
     /* Macronix MXIC MX25L6405 SPI flash, 8MB, 128 sectors of 64K each */
     {
      MV_MX25L_WREN_CMND_OPCD,
diff --git a/arch/arm/plat-armada/mv_hal/sflash/mvSFlashSpec.h b/arch/arm/plat-armada/mv_hal/sflash/mvSFlashSpec.h
index 88cc3d1..c3bb890 100644
--- a/arch/arm/plat-armada/mv_hal/sflash/mvSFlashSpec.h
+++ b/arch/arm/plat-armada/mv_hal/sflash/mvSFlashSpec.h
@@ -249,6 +249,48 @@ extern "C" {
 #define     	MV_S25FL_STATUS_BP_1_OF_2           	(0x07 << MV_SFLASH_STATUS_REG_WP_OFFSET)
 #define     	MV_S25FL_STATUS_BP_ALL              	(0x0F << MV_SFLASH_STATUS_REG_WP_OFFSET)
 
+/************************************/
+/*  ST M25Qxxx Device Specific  */
+/************************************/
+
+/* Manufacturer IDs and Device IDs for SFLASHs supported by the driver */
+#define     MV_M25QXXX_ST_MANF_ID               0x20
+#define     MV_M25Q128_DEVICE_ID                0xBA18
+#define     MV_M25Q128_MAX_SPI_FREQ             54000000    /* 54MHz */
+#define     MV_M25Q128_MAX_FAST_SPI_FREQ        108000000   /* 108MHz */
+#define     MV_M25Q128_FAST_READ_DUMMY_BYTES    1
+
+/* Sector Sizes and population per device model*/
+#define     MV_M25Q128_SECTOR_SIZE      0x10000 /* 64K */
+#define     MV_M25Q128_SECTOR_NUMBER    256
+#define     MV_M25Q_PAGE_SIZE           0x100   /* 256 byte */
+
+#define     MV_M25Q_WREN_CMND_OPCD      0x06    /* Write Enable */
+#define     MV_M25Q_WRDI_CMND_OPCD      0x04    /* Write Disable */
+#define     MV_M25Q_RDID_CMND_OPCD      0x9F    /* Read ID */
+#define     MV_M25Q_RDSR_CMND_OPCD      0x05    /* Read Status Register */
+#define     MV_M25Q_WRSR_CMND_OPCD      0x01    /* Write Status Register */
+#define     MV_M25Q_READ_CMND_OPCD      0x03    /* Sequential Read */
+#define     MV_M25Q_FAST_RD_CMND_OPCD   0x0B    /* Fast Read */
+#define     MV_M25Q_PP_CMND_OPCD        0x02    /* Page Program */
+#define     MV_M25Q_SE_CMND_OPCD        0xD8    /* Sector Erase */
+#define     MV_M25Q_BE_CMND_OPCD        0xC7    /* Bulk Erase */
+#define     MV_M25Q_DP_CMND_OPCD        0xB9    /* Deep Power Down */
+#define     MV_M25Q_RES_CMND_OPCD       0xAB    /* Read Electronic Signature */
+
+/* Status Register Write Protect Bit Masks - 4bits */
+#define     MV_M25Q_STATUS_REG_WP_MASK  (0x0F << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define     MV_M25Q_STATUS_BP_NONE      (0x00 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define     MV_M25Q_STATUS_BP_1_OF_128  (0x01 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define     MV_M25Q_STATUS_BP_1_OF_64   (0x02 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define     MV_M25Q_STATUS_BP_1_OF_32   (0x03 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define     MV_M25Q_STATUS_BP_1_OF_16   (0x04 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define     MV_M25Q_STATUS_BP_1_OF_8    (0x05 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define     MV_M25Q_STATUS_BP_1_OF_4    (0x06 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define     MV_M25Q_STATUS_BP_1_OF_2    (0x07 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define     MV_M25Q_STATUS_BP_ALL       (0x0F << MV_SFLASH_STATUS_REG_WP_OFFSET)
+
+
 #ifdef __cplusplus
 }
 #endif
-- 
1.7.0

