From 31dc19c0ad9a1b81138c798c7005355ebf39ae0b Mon Sep 17 00:00:00 2001
From: Wang Hui <Hui.Wang@windriver.com>
Date: Tue, 15 Jan 2013 16:45:38 +0800
Subject: [PATCH 14/50] arm: armadaxp: errata: add workaround for Sheeva errata 4413

Sheeva Errata 4413: Add SB before L1 Invalidate by MVA.

The code is extracted from linux-3.2.27-axp_a370-2012_Q4.1, which
can be downloaded from:
https://extranet.marvell.com/extranet/dms/documents.do?groupID=4&\
subGroupID=53015

Signed-off-by: Wang Hui <Hui.Wang@windriver.com>
---
 arch/arm/mm/cache-v7.S |   11 +++++++++++
 1 files changed, 11 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mm/cache-v7.S b/arch/arm/mm/cache-v7.S
index ac1ab0b..2b7d70f 100644
--- a/arch/arm/mm/cache-v7.S
+++ b/arch/arm/mm/cache-v7.S
@@ -289,6 +289,17 @@ v7_dma_inv_range:
 	bic	r1, r1, r3
 	mcrne	p15, 0, r1, c7, c14, 1		@ clean & invalidate D / U line
 1:
+#if defined (CONFIG_SHEEVA_ERRATA_ARM_CPU_4413)
+#ifdef CONFIG_SHEEVA_ERRATA_ARM_CPU_6075
+#ifdef CONFIG_ARMADA_XP_A0_WITH_B0
+	a0_with_b0_errata_6075 r3
+#else
+	dsb
+#endif
+#else
+	dmb					@ ensure ordering with previous memory accesses
+#endif
+#endif
 	mcr	p15, 0, r0, c7, c6, 1		@ invalidate D / U line
 	add	r0, r0, r2
 	cmp	r0, r1
-- 
1.7.0

