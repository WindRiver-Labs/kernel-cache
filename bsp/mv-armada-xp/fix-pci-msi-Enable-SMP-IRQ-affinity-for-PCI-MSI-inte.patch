From 8af9e2c028ee3e3fa2a8bd42b5f1031c29b339b8 Mon Sep 17 00:00:00 2001
From: Nadav Haklai <nadavh@marvell.com>
Date: Mon, 2 Sep 2013 11:26:14 +0300
Subject: [PATCH] fix: pci: msi: Enable SMP IRQ affinity for PCI MSI interupts

	Fix the bug by unmasking the doorbell 1 IRQ for all CPUs
	The actual affinity is set at the second level at the SW triggered
	interrupt register and not at the IRQ source control register

Signed-off-by: Nadav Haklai <nadavh@marvell.com>

Change-Id: I0e50625217939818cb565f651ee6d931d4dd384a
Reviewed-on: http://vgitil04.il.marvell.com:8080/3430
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Tested-by: Nadav Haklai <nadavh@marvell.com>
[zou: Original patch taken from axp-linux-3.2.58-2014_T2.0]
Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 arch/arm/plat-armada/msi.c |   14 ++++++++++++++
 1 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/msi.c b/arch/arm/plat-armada/msi.c
index 241c6bd..77ac0cc 100644
--- a/arch/arm/plat-armada/msi.c
+++ b/arch/arm/plat-armada/msi.c
@@ -45,6 +45,13 @@ void __init armada_msi_init(void)
 	/* Unmask private doorbells 16-31 */
 	temp = MV_REG_READ(AXP_IN_DRBEL_MSK) | (0xFFFF0000);
 	MV_REG_WRITE(AXP_IN_DRBEL_MSK, temp);
+
+#ifdef CONFIG_SMP
+	/* Unmask doorbell high IRQ for all CPUs */
+	temp = MV_REG_READ(CPU_INT_SOURCE_CONTROL_REG(IRQ_AURORA_IN_DRBL_HIGH));
+	temp |= 0xf;
+	MV_REG_WRITE(CPU_INT_SOURCE_CONTROL_REG(IRQ_AURORA_IN_DRBL_HIGH), temp);
+#endif
 }
 
 /*
@@ -116,6 +123,13 @@ void second_cpu_msi_init(void)
 	/* Unmask private doorbells 16-31 */
 	temp = MV_REG_READ(AXP_IN_DRBEL_MSK) | (0xFFFF0000);
 	MV_REG_WRITE(AXP_IN_DRBEL_MSK, temp);
+
+#ifdef CONFIG_SMP
+	/* Unmask doorbell high IRQ for all CPUs */
+	temp = MV_REG_READ(CPU_INT_SOURCE_CONTROL_REG(IRQ_AURORA_IN_DRBL_HIGH));
+	temp |= 0xf;
+	MV_REG_WRITE(CPU_INT_SOURCE_CONTROL_REG(IRQ_AURORA_IN_DRBL_HIGH), temp);
+#endif
 }
 #endif
 
-- 
1.7.5.4

