From 522b8af8a5cec5a7ae1b2c5340902fcb6fc67e2a Mon Sep 17 00:00:00 2001
From: Wang Hui <Hui.Wang@windriver.com>
Date: Wed, 26 Dec 2012 15:14:16 +0800
Subject: [PATCH 38/50] armadaxp: cpuidle: fix deepidle problem for be8 kernel

In the deepidle function, it needs to access some peripheral
registers with assembly language, peripheral registers are little
endian, we need to swap register contents.

Signed-off-by: Wang Hui <Hui.Wang@windriver.com>
---
 arch/arm/plat-armada/armada_suspend.S |   25 +++++++++++++++++++++++++
 1 files changed, 25 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/armada_suspend.S b/arch/arm/plat-armada/armada_suspend.S
index eaf56d2..25500ce 100644
--- a/arch/arm/plat-armada/armada_suspend.S
+++ b/arch/arm/plat-armada/armada_suspend.S
@@ -222,6 +222,9 @@ ENTRY(armadaxp_cpu_suspend)
 	ldr	r4, =0xFBB20500
 1:
 	ldr	r2, [r4]
+#ifdef CONFIG_CPU_ENDIAN_BE8
+	lsr	r2, r2, #24
+#endif
 	and	r2, r2, #0xF
 	cmp	r1, r2
 	bne	1b
@@ -230,16 +233,26 @@ ENTRY(armadaxp_cpu_suspend)
 	mrc	15, 0, r1, cr0, cr0, 5
 	and	r1, r1, #15
 	mov	r6, #1
+#ifndef CONFIG_CPU_ENDIAN_BE8
 	add	r7, r1, #24
+#else
+	mov	r7, r1
+#endif
 	ldr	r2, =0xFBB20200
+
 	ldr	r3, [r2]
 	bic	r3, r3, r6, lsl r7
 	str	r3, [r2]
 
 /* Release Semaphore */
 	ldr	r2, =0xFBB20500
+#ifndef CONFIG_CPU_ENDIAN_BE8
 	ldr 	r0, =0xff
 	strb	r0, [r2]
+#else
+	ldr 	r0, =0xff000000
+	str	r0, [r2]
+#endif
 
 dowfi:
 /* WFI */
@@ -305,6 +318,9 @@ ENTRY(armadaxp_cpu_resume)
 	ldr	r4, =0xD0020500
 1:
 	ldr	r2, [r4]
+#ifdef CONFIG_CPU_ENDIAN_BE8
+	lsr	r2, r2, #24
+#endif
 	and	r2, r2, #0xF
 	cmp	r1, r2
 	bne	1b
@@ -313,7 +329,11 @@ ENTRY(armadaxp_cpu_resume)
 	mrc	15, 0, r1, cr0, cr0, 5
 	and	r1, r1, #15
 	mov	r6, #1
+#ifndef CONFIG_CPU_ENDIAN_BE8
 	add	r7, r1, #24
+#else
+	mov	r7, r1
+#endif
 	ldr	r2, =0xD0020200
 	ldr	r3, [r2]
 	orr	r3, r3, r6, lsl r7
@@ -321,8 +341,13 @@ ENTRY(armadaxp_cpu_resume)
 
 /* Release Semaphore */
 	ldr	r2, =0xD0020500
+#ifndef CONFIG_CPU_ENDIAN_BE8
 	ldr 	r0, =0xff
 	strb	r0, [r2]
+#else
+	ldr 	r0, =0xff000000
+	str	r0, [r2]
+#endif
 
 #ifdef CONFIG_SMP
 	adr     r0, suspend_saved_sp
-- 
1.7.0

