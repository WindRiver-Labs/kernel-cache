From b8e5c8572ab600e97cf20de2f4efdb650ac04acf Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Thu, 23 Jan 2014 16:59:00 +0800
Subject: [PATCH] ARM: armada: make kexec+smp work

Make the nonboot cpus keep in busy-loop mode when system running in
RESTART state, this will make armada be able to run kexec with SMP
enabled. There is no side effect because we know that we will reboot
quickly thus keeping the cpu in whatever mode doesn't matter.

Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 arch/arm/kernel/process.c      |    3 ---
 arch/arm/plat-armada/hotplug.c |   11 ++++++-----
 2 files changed, 6 insertions(+), 8 deletions(-)

diff --git a/arch/arm/kernel/process.c b/arch/arm/kernel/process.c
index cee93fd..0fb44d8 100644
--- a/arch/arm/kernel/process.c
+++ b/arch/arm/kernel/process.c
@@ -265,9 +265,6 @@ __setup("reboot=", reboot_setup);
 void machine_shutdown(void)
 {
 	disable_nonboot_cpus();
-#ifdef CONFIG_SMP
-	smp_send_stop();
-#endif
 }
 
 void machine_halt(void)
diff --git a/arch/arm/plat-armada/hotplug.c b/arch/arm/plat-armada/hotplug.c
index 17b5f10..e4dfec0 100644
--- a/arch/arm/plat-armada/hotplug.c
+++ b/arch/arm/plat-armada/hotplug.c
@@ -16,8 +16,6 @@
 #include <asm/cacheflush.h>
 #include <../cpuidle.h>
 
-#define DEBUG
-
 #define hard_smp_processor_id()                 \
         ({                                              \
                 unsigned int cpunum;                    \
@@ -38,6 +36,11 @@ static inline void platform_do_lowpower(unsigned int cpu)
 	 * code will have already disabled interrupts
 	 */
 
+	if (system_state == SYSTEM_RESTART) {
+		while (1)
+			cpu_relax();
+	}
+
 	for (;;) {
 
 		/*
@@ -95,9 +98,7 @@ void __ref platform_cpu_die(unsigned int cpu)
 	 */
 
 	flush_cache_all();
-#ifdef CONFIG_SHEEVA_DEEP_IDLE
-	armadaxp_fabric_prepare_hotplug();
-#endif
+
 	/* none zero means deepIdle wasn't entered and regret event happened */
 
 	platform_do_lowpower(cpu);
-- 
1.7.5.4

