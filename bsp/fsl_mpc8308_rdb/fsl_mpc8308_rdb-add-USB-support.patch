From 128e81c521d0c375c3b83603e1f3bd3bc4ff51e4 Mon Sep 17 00:00:00 2001
From: Tonyliu <Bo.Liu@windriver.com>
Date: Mon, 9 Aug 2010 17:07:24 +0800
Subject: [PATCH 3/5] fsl_mpc8308_rdb: add USB support

Bits[8:9] of System Clock Control Register (SCCR) are used to
select USB DR clock/csb_clk ratio. mpc8308_rdb also needs to set it
1:1.

Bits[12:13] of System I/O Configuration Register High (SICRH) are used to
select multiplexing GPIOs as USB function.

Signed-off-by: Tonyliu <Bo.Liu@windriver.com>
---
 arch/powerpc/platforms/83xx/mpc83xx.h |    2 ++
 arch/powerpc/platforms/83xx/usb.c     |    7 ++++++-
 2 files changed, 8 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/platforms/83xx/mpc83xx.h b/arch/powerpc/platforms/83xx/mpc83xx.h
index 0fea881..946b318 100644
--- a/arch/powerpc/platforms/83xx/mpc83xx.h
+++ b/arch/powerpc/platforms/83xx/mpc83xx.h
@@ -40,6 +40,8 @@
 #define MPC831X_SICRH_USB_ULPI     0x000000a0
 #define MPC8315_SICRH_USB_MASK     0x0000ff00
 #define MPC8315_SICRH_USB_ULPI     0x00000000
+#define MPC830X_SICRH_USB_MASK		0x000c0000
+#define MPC830X_SICRH_USB_ULPI		0x00040000
 #define MPC837X_SICRH_SPI_MASK     0x00000003
 #define MPC837X_SICRH_SD           0x00000001
 
diff --git a/arch/powerpc/platforms/83xx/usb.c b/arch/powerpc/platforms/83xx/usb.c
index 3ba4bb7..9a58560 100644
--- a/arch/powerpc/platforms/83xx/usb.c
+++ b/arch/powerpc/platforms/83xx/usb.c
@@ -127,7 +127,8 @@ int mpc831x_usb_cfg(void)
 
 	/* Configure clock */
 	immr_node = of_get_parent(np);
-	if (immr_node && of_device_is_compatible(immr_node, "fsl,mpc8315-immr"))
+	if ((immr_node && of_device_is_compatible(immr_node, "fsl,mpc8315-immr")) ||
+		(immr_node && of_device_is_compatible(immr_node, "fsl,mpc8308-immr")))
 		clrsetbits_be32(immap + MPC83XX_SCCR_OFFS,
 		                MPC8315_SCCR_USB_MASK,
 		                MPC8315_SCCR_USB_DRCM_01);
@@ -145,6 +146,10 @@ int mpc831x_usb_cfg(void)
 			clrsetbits_be32(immap + MPC83XX_SICRH_OFFS,
 					MPC8315_SICRH_USB_MASK,
 					MPC8315_SICRH_USB_ULPI);
+		} else if (of_device_is_compatible(immr_node, "fsl,mpc8308-immr")) {
+			clrsetbits_be32(immap + MPC83XX_SICRH_OFFS,
+					MPC830X_SICRH_USB_MASK,
+					MPC830X_SICRH_USB_ULPI);
 		} else {
 			clrsetbits_be32(immap + MPC83XX_SICRL_OFFS,
 					MPC831X_SICRL_USB_MASK,
-- 
1.6.5.2

