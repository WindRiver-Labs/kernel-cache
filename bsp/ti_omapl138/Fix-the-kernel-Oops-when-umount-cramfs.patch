From 835a52cf2f13736ab0924f7d78a1321db799b47b Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Mon, 30 Aug 2010 16:17:47 +0800
Subject: [PATCH 2/2] Fix the kernel Oops when umount cramfs

When cramfs is mounted with a linear physical address, sb->s_bdev
is NULL. In this scenario, we don't need to close the block device
so checking for NULL and skipping the close is safe.

Signed-off-by: Stanley.Miao <stanley.miao@windriver.com>
---
 fs/super.c |    8 +++++---
 1 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/fs/super.c b/fs/super.c
index 0ce92ff..71e51cf 100644
--- a/fs/super.c
+++ b/fs/super.c
@@ -858,10 +858,12 @@ void kill_block_super(struct super_block *sb)
 	struct block_device *bdev = sb->s_bdev;
 	fmode_t mode = sb->s_mode;
 
-	bdev->bd_super = NULL;
 	generic_shutdown_super(sb);
-	sync_blockdev(bdev);
-	close_bdev_exclusive(bdev, mode);
+	if (bdev) {
+		bdev->bd_super = NULL;
+		sync_blockdev(bdev);
+		close_bdev_exclusive(bdev, mode);
+	}
 }
 
 EXPORT_SYMBOL(kill_block_super);
-- 
1.6.5.2

