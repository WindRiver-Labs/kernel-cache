From fc89caf775176542e834fba569c97b0be45c9b06 Mon Sep 17 00:00:00 2001
From: Sudhakar Rajashekhara <sudhakar.raj@ti.com>
Date: Wed, 13 Jan 2010 16:56:26 +0530
Subject: [PATCH 1/5] da8xx: Fix GLCD initialization sequence

Original codes from TI Linux Platform Support Package
DaVinci-PSP-SDK-03.20.00.12.tgz http://software-dl.ti.com/dsps/
dsps_public_sw/sdo_sb/targetcontent/psp/DaVinci-PSP-SDK/03_20/index_FDS.html

Sometimes system comes up with a 'white screen' on the LCD after
boot, and nothing is ever displayed. This was consistent with the
'reset' button (or linux reboot). This is fixed by switching off
and switching on the panel power and backlight after enabling
raster. Earlier this sequence was done before enabling the raster.

Signed-off-by: Sudhakar Rajashekhara <sudhakar.raj@ti.com>
Integrated-by: Stanley.Miao <stanley.miao@windriver.com>
---
 arch/arm/mach-davinci/board-da850-evm.c |   15 ++++++---------
 drivers/video/da8xx-fb.c                |    8 ++++++++
 2 files changed, 14 insertions(+), 9 deletions(-)

diff --git a/arch/arm/mach-davinci/board-da850-evm.c b/arch/arm/mach-davinci/board-da850-evm.c
index 573397a..3f2b578 100644
--- a/arch/arm/mach-davinci/board-da850-evm.c
+++ b/arch/arm/mach-davinci/board-da850-evm.c
@@ -18,6 +18,7 @@
 #include <linux/i2c/at24.h>
 #include <linux/i2c/pca953x.h>
 #include <linux/gpio.h>
+#include <linux/delay.h>
 #include <linux/platform_device.h>
 #include <linux/mtd/mtd.h>
 #include <linux/mtd/nand.h>
@@ -429,11 +430,13 @@ static struct davinci_mmc_config da850_mmc_config = {
 
 static void da850_panel_power_ctrl(int val)
 {
-	/* lcd backlight */
-	gpio_set_value(DA850_LCD_BL_PIN, val);
-
 	/* lcd power */
 	gpio_set_value(DA850_LCD_PWR_PIN, val);
+
+	mdelay(200);
+
+	/* lcd backlight */
+	gpio_set_value(DA850_LCD_BL_PIN, val);
 }
 
 static int da850_lcd_hw_init(void)
@@ -453,12 +456,6 @@ static int da850_lcd_hw_init(void)
 	gpio_direction_output(DA850_LCD_BL_PIN, 0);
 	gpio_direction_output(DA850_LCD_PWR_PIN, 0);
 
-	/* Switch off panel power and backlight */
-	da850_panel_power_ctrl(0);
-
-	/* Switch on panel power and backlight */
-	da850_panel_power_ctrl(1);
-
 	return 0;
 }
 
diff --git a/drivers/video/da8xx-fb.c b/drivers/video/da8xx-fb.c
index 8d244ba..d653c61 100644
--- a/drivers/video/da8xx-fb.c
+++ b/drivers/video/da8xx-fb.c
@@ -923,6 +923,14 @@ static int __init fb_probe(struct platform_device *device)
 	/* enable raster engine */
 	lcd_enable_raster();
 
+	if (par->panel_power_ctrl) {
+		/* Switch off panel power and backlight */
+		par->panel_power_ctrl(0);
+
+		/* Switch on panel power and backlight */
+		par->panel_power_ctrl(1);
+	}
+
 	return 0;
 
 #ifdef CONFIG_CPU_FREQ
-- 
1.6.5.2

