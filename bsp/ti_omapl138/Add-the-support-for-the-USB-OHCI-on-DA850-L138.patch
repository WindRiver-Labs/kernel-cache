From 6ad51642393829f11b6a0aff14917c34039e331d Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Thu, 5 Nov 2009 17:53:18 +0800
Subject: [PATCH 12/43] Add the support for the USB OHCI on DA850/L138

Original codes from TI Linux Platform Support Package
DaVinci-PSP-SDK-03.20.00.05.tgz http://software-dl.ti.com/dsps/
dsps_public_sw/sdo_sb/targetcontent/psp/DaVinci-PSP-SDK/03_20/index_FDS.html

Register the L138 USB OHCI platform data.

Signed-off-by: Stanley.Miao <stanley.miao@windriver.com>
---
 arch/arm/mach-davinci/da850.c            |   30 ++++++++++++++-
 arch/arm/mach-davinci/include/mach/usb.h |   60 ++++++++++++++++++++++++++++++
 drivers/usb/Kconfig                      |    2 +-
 drivers/usb/host/ohci-da8xx.c            |   10 ++--
 drivers/usb/host/ohci-hcd.c              |    2 +-
 5 files changed, 96 insertions(+), 8 deletions(-)
 create mode 100644 arch/arm/mach-davinci/include/mach/usb.h

diff --git a/arch/arm/mach-davinci/da850.c b/arch/arm/mach-davinci/da850.c
index c59da03..751a9f4 100644
--- a/arch/arm/mach-davinci/da850.c
+++ b/arch/arm/mach-davinci/da850.c
@@ -22,7 +22,7 @@
 #include <mach/irqs.h>
 #include <mach/psc.h>
 #include <mach/mux.h>
-#include <mach/io.h>
+#include <mach/usb.h>
 
 #include "clock.h"
 #include "mux.h"
@@ -853,6 +853,33 @@ void da850_init_emac(struct emac_platform_data *pdata)
 void da850_init_emac(struct emac_platform_data *unused) {}
 
 #endif
+
+struct  da8xx_ohci_root_hub da850_ohci_rh_data = {0, 0, 0, 0, 1};
+static struct resource da850_ohci_resources[] = {
+	{
+		/* physical address */
+		.start	=	DA8XX_USB1_BASE,
+		.end	=	DA8XX_USB1_BASE + 0xfff,
+		.flags	=	IORESOURCE_MEM,
+	},
+	{
+		.start	=	IRQ_DA8XX_IRQN,
+		.flags	=	IORESOURCE_IRQ,
+	}
+};
+
+static u64 da8xx_usb1_dma_mask = ~(u32)0;
+static struct platform_device da850_ohci_device = {
+	.name	= "usb1",
+	.id	= -1,
+	.dev = {
+		.platform_data          = &da850_ohci_rh_data,
+		.dma_mask               = &da8xx_usb1_dma_mask,
+		.coherent_dma_mask      = 0xffffffff,
+	},
+	.num_resources  = ARRAY_SIZE(da850_ohci_resources),
+	.resource       = da850_ohci_resources,
+};
 int get_async3_src(void)
 {
 	unsigned int *addr = IO_ADDRESS(DA8XX_CFGCHIP3);
@@ -874,6 +901,7 @@ static int __init da850_init_devices(void)
 
 	platform_device_register(&da850_edma0_device);
 	platform_device_register(&da850_edma1_device);
+	platform_device_register(&da850_ohci_device);
 
 	return 0;
 }
diff --git a/arch/arm/mach-davinci/include/mach/usb.h b/arch/arm/mach-davinci/include/mach/usb.h
new file mode 100644
index 0000000..41b1dd9
--- /dev/null
+++ b/arch/arm/mach-davinci/include/mach/usb.h
@@ -0,0 +1,60 @@
+/*
+ * USB related definitions
+ *
+ * Copyright (C) 2009 MontaVista Software, Inc. <source@mvista.com>
+ *
+ * This file is licensed under the terms of the GNU General Public License
+ * version 2. This program is licensed "as is" without any warranty of any
+ * kind, whether express or implied.
+ */
+
+#ifndef __ASM_ARCH_USB_H
+#define __ASM_ARCH_USB_H
+
+/* DA8xx has 5 CFGCHIP registers */
+#define DA8XX_CFGCHIP(n)	(DA8XX_BOOT_CFG_BASE + 0x17c + (n) * 4)
+
+/* DA8xx CFGCHIP2 (USB 2.0 PHY Control) register bits */
+#define CFGCHIP2_PHYCLKGD	(1 << 17)
+#define CFGCHIP2_VBUSSENSE	(1 << 16)
+#define CFGCHIP2_RESET		(1 << 15)
+#define CFGCHIP2_OTGMODE	(3 << 13)
+#define CFGCHIP2_NO_OVERRIDE	(0 << 13)
+#define CFGCHIP2_FORCE_HOST	(1 << 13)
+#define CFGCHIP2_FORCE_DEVICE 	(2 << 13)
+#define CFGCHIP2_FORCE_HOST_VBUS_LOW (3 << 13)
+#define CFGCHIP2_USB1PHYCLKMUX	(1 << 12)
+#define CFGCHIP2_USB2PHYCLKMUX	(1 << 11)
+#define CFGCHIP2_PHYPWRDN	(1 << 10)
+#define CFGCHIP2_OTGPWRDN	(1 << 9)
+#define CFGCHIP2_DATPOL 	(1 << 8)
+#define CFGCHIP2_USB1SUSPENDM	(1 << 7)
+#define CFGCHIP2_PHY_PLLON	(1 << 6)	/* override PLL suspend */
+#define CFGCHIP2_SESENDEN	(1 << 5)	/* Vsess_end comparator */
+#define CFGCHIP2_VBDTCTEN	(1 << 4)	/* Vbus comparator */
+#define CFGCHIP2_REFFREQ	(0xf << 0)
+#define CFGCHIP2_REFFREQ_12MHZ	(1 << 0)
+#define CFGCHIP2_REFFREQ_24MHZ	(2 << 0)
+#define CFGCHIP2_REFFREQ_48MHZ	(3 << 0)
+
+struct	da8xx_ohci_root_hub;
+
+typedef void (*da8xx_ocic_handler_t)(struct da8xx_ohci_root_hub *hub,
+					unsigned port);
+
+/* Passed as the platform data to the OHCI driver */
+struct	da8xx_ohci_root_hub {
+	/* Switch the port power on/off */
+	int	(*set_power)(unsigned port, int on);
+	/* Read the port power status */
+	int	(*get_power)(unsigned port);
+	/* Read the port over-current indicator */
+	int	(*get_oci)(unsigned port);
+	/* Over-current indicator change notification (pass NULL to disable) */
+	int	(*ocic_notify)(da8xx_ocic_handler_t handler);
+	/* Time from power on to power good (in 2 ms units) */
+	u8	potpgt;
+};
+
+#endif	/* ifndef __ASM_ARCH_USB_H */
+
diff --git a/drivers/usb/Kconfig b/drivers/usb/Kconfig
index f2df4f2..084a876 100644
--- a/drivers/usb/Kconfig
+++ b/drivers/usb/Kconfig
@@ -37,7 +37,7 @@ config USB_ARCH_HAS_OHCI
 	default y if ARCH_EP93XX
 	default y if ARCH_AT91
 	default y if ARCH_PNX4008
-	default y if ARCH_DAVINCI_DA8XX
+	default y if ARCH_DA8XX
 	# PPC:
 	default y if STB03xxx
 	default y if PPC_MPC52xx
diff --git a/drivers/usb/host/ohci-da8xx.c b/drivers/usb/host/ohci-da8xx.c
index 94b9c1b..6aa7bc8 100644
--- a/drivers/usb/host/ohci-da8xx.c
+++ b/drivers/usb/host/ohci-da8xx.c
@@ -19,8 +19,8 @@
 #include <mach/da8xx.h>
 #include <mach/usb.h>
 
-#ifndef CONFIG_ARCH_DAVINCI_DA8XX
-#error "This file is DA8XX bus glue.  Define CONFIG_ARCH_DAVINCI_DA8XX."
+#ifndef CONFIG_ARCH_DA8XX
+#error "This file is DA8XX bus glue.  Define CONFIG_ARCH_DA8XX."
 #endif
 
 #define CFGCHIP2	IO_ADDRESS(DA8XX_CFGCHIP(2))
@@ -322,11 +322,11 @@ static int usb_hcd_da8xx_probe(const struct hc_driver *driver,
 	if (hub == NULL)
 		return -ENODEV;
 
-	usb11_clk = clk_get(&pdev->dev, "usb11");
+	usb11_clk = clk_get(&pdev->dev, "usb1");
 	if (IS_ERR(usb11_clk))
 		return PTR_ERR(usb11_clk);
 
-	usb20_clk = clk_get(&pdev->dev, "usb20");
+	usb20_clk = clk_get(&pdev->dev, "usb0");
 	if (IS_ERR(usb20_clk)) {
 		error = PTR_ERR(usb20_clk);
 		goto err0;
@@ -471,6 +471,6 @@ static struct platform_driver ohci_hcd_da8xx_driver = {
 #endif
 	.driver		= {
 		.owner	= THIS_MODULE,
-		.name	= "usb_ohci",
+		.name	= "usb1",
 	},
 };
diff --git a/drivers/usb/host/ohci-hcd.c b/drivers/usb/host/ohci-hcd.c
index 403dd32..c28477c 100644
--- a/drivers/usb/host/ohci-hcd.c
+++ b/drivers/usb/host/ohci-hcd.c
@@ -1055,7 +1055,7 @@ MODULE_LICENSE ("GPL");
 #define PLATFORM_DRIVER		usb_hcd_pnx4008_driver
 #endif
 
-#ifdef CONFIG_ARCH_DAVINCI_DA8XX
+#ifdef CONFIG_ARCH_DA8XX
 #include "ohci-da8xx.c"
 #define PLATFORM_DRIVER		ohci_hcd_da8xx_driver
 #endif
-- 
1.6.5.2

