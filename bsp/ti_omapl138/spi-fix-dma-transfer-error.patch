From 38a407a98da36271ed3e4858cd22980334576f45 Mon Sep 17 00:00:00 2001
From: Bi Junxiao <Junxiao.Bi@windriver.com>
Date: Fri, 22 Oct 2010 17:02:11 +0800
Subject: [PATCH] spi: fix dma transfer error

SPI can not work in dma mode. All results of reading are wrong.
The CS setting should be done before enable the spi.

Signed-off-by: Junxiao Bi <junxiao.bi@windriver.com>
---
 drivers/spi/davinci_spi.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/spi/davinci_spi.c b/drivers/spi/davinci_spi.c
index 54d2092..0f2e939 100644
--- a/drivers/spi/davinci_spi.c
+++ b/drivers/spi/davinci_spi.c
@@ -751,6 +751,7 @@ static int davinci_spi_bufs_dma(struct spi_device *spi, struct spi_transfer *t)
 	clear_bits(davinci_spi->base + SPIINT, SPI_SPIINT_MASKALL);
 	/* Disable SPI to write configuration bits in SPIDAT */
 	clear_bits(davinci_spi->base + SPIGCR1, SPI_SPIGCR1_SPIENA_MASK);
+	iowrite32(data1_reg_val, davinci_spi->base + SPIDAT1);
 	/* Enable SPI */
 	set_bits(davinci_spi->base + SPIGCR1, SPI_SPIGCR1_SPIENA_MASK);
 
@@ -765,6 +766,9 @@ static int davinci_spi_bufs_dma(struct spi_device *spi, struct spi_transfer *t)
 	}
 
 	if (t->rx_buf != NULL) {
+		if (t->tx_buf == NULL) {
+			iowrite32(data1_reg_val, davinci_spi->base + SPIDAT1);
+		}
 		t->rx_dma = dma_map_single(&spi->dev, (void *)t->rx_buf, count,
 				DMA_FROM_DEVICE);
 		rx_param.opt = TCINTEN | EDMA_TCC(davinci_spi_dma->dma_rx_channel);
@@ -791,7 +795,6 @@ static int davinci_spi_bufs_dma(struct spi_device *spi, struct spi_transfer *t)
 	edma_link(davinci_spi_dma->dma_tx_channel,
                         davinci_spi_dma->dummy_param_slot);
 
-	iowrite32(data1_reg_val, davinci_spi->base + SPIDAT1);
 	if ((t->tx_buf != NULL) || (t->rx_buf != NULL))
 		edma_start(davinci_spi_dma->dma_tx_channel);
 
-- 
1.7.0.4

