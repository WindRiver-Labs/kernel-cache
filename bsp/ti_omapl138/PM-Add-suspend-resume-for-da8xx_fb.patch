From 68e69093ce53b40804df98f3ff521eac1f5f9dc6 Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Thu, 5 Nov 2009 17:53:28 +0800
Subject: [PATCH 20/43] PM: Add suspend/resume for da8xx_fb

Add suspend/resume method for da8xx framebuffer device.

Signed-off-by: Stanley.Miao <stanley.miao@windriver.com>
---
 drivers/video/da8xx/da8xx_fb.c |   26 ++++++++++++++++++++++++--
 1 files changed, 24 insertions(+), 2 deletions(-)

diff --git a/drivers/video/da8xx/da8xx_fb.c b/drivers/video/da8xx/da8xx_fb.c
index d4c5b21..7b4ec09 100644
--- a/drivers/video/da8xx/da8xx_fb.c
+++ b/drivers/video/da8xx/da8xx_fb.c
@@ -30,6 +30,7 @@
 #include <linux/device.h>
 #include <linux/interrupt.h>
 #include <linux/clk.h>
+#include <linux/gpio.h>
 #include "da8xx_fb.h"
 #include "da8xx_lcdc.h"
 #ifdef CONFIG_GLCD_SHARP_COLOR
@@ -919,11 +920,32 @@ static struct fb_ops da830_fb_ops = {
 #ifdef CONFIG_PM
 static int da830_fb_suspend(struct platform_device *dev, pm_message_t state)
 {
-	 /*TODO*/ return -EBUSY;
+	struct fb_info *info = dev_get_drvdata(&dev->dev);
+	
+	if (info) {
+		struct da830fb_par *par = info->par;
+		if (da830_fb_read(LCD_RASTER_CTRL_REG) & LCD_RASTER_ENABLE)
+			lcd_disable_raster(&dev->dev);
+		clk_disable(par->lcdc_clk);
+	}
+	return 0;
 }
 static int da830_fb_resume(struct platform_device *dev)
 {
-	 /*TODO*/ return -EBUSY;
+	struct fb_info *info = dev_get_drvdata(&dev->dev);
+
+	if (info) {
+		struct da830fb_par *par = info->par;
+		clk_enable(par->lcdc_clk);
+		lcd_cfg_dma(&dev->dev, lcd_cfg.dma_burst_sz);
+		lcd_blit(LOAD_DATA, par->p_palette_base);
+	}
+
+	/* enable raster engine */
+	da830_fb_write(da830_fb_read(LCD_RASTER_CTRL_REG) |
+					LCD_RASTER_ENABLE, LCD_RASTER_CTRL_REG);
+
+	return 0;
 }
 #else
 #define da830_fb_suspend NULL
-- 
1.6.5.2

