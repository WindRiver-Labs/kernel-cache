From 6ca011a66fc703187b70cbaabb0d806e1769626d Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Thu, 5 Nov 2009 17:53:32 +0800
Subject: [PATCH 21/43] PM: add suspend/resume for DaVinci Audio

Add suspend/resume methods for DaVinci McAsp Audio device.

Signed-off-by: Stanley.Miao <stanley.miao@windriver.com>
---
 sound/soc/davinci/davinci-i2s-mcasp.c |   53 +++++++++++++++++++++++++++++++++
 1 files changed, 53 insertions(+), 0 deletions(-)

diff --git a/sound/soc/davinci/davinci-i2s-mcasp.c b/sound/soc/davinci/davinci-i2s-mcasp.c
index 580aee8..4948db6 100644
--- a/sound/soc/davinci/davinci-i2s-mcasp.c
+++ b/sound/soc/davinci/davinci-i2s-mcasp.c
@@ -658,12 +658,65 @@ static int davinci_i2s_mcasp_trigger(struct snd_pcm_substream *substream,
 	return ret;
 }
 
+#ifdef CONFIG_PM
+static int davinci_i2s_mcasp_suspend(struct platform_device *pdev,
+		struct snd_soc_dai *dai)
+{
+	struct snd_soc_device *socdev = platform_get_drvdata(pdev);
+	struct snd_soc_card *card = socdev->card;
+	struct snd_soc_dai *cpu_dai = card->dai_link->cpu_dai;
+	struct davinci_audio_dev *dev_list = cpu_dai->private_data;
+	struct davinci_audio_dev *dev;
+	int i;
+
+	if (!dai->active)
+		return 0;
+
+	/*Since each cpu_dai channel has been disabled in davinci_i2s_mcasp_trigger()
+	 * by responding to SNDRV_PCM_TRIGGER_SUSPEND, here we turn off clock to 
+	 * reduce power comsuming.
+	 */
+	for (i = 0; i < card->num_links; i++) {
+		dev = &dev_list[i];
+		clk_disable(dev->clk);
+	}
+	
+	return 0;
+}
+
+static int davinci_i2s_mcasp_resume(struct platform_device *pdev,
+		struct snd_soc_dai *dai)
+{
+	struct snd_soc_device *socdev = platform_get_drvdata(pdev);
+	struct snd_soc_card *card = socdev->card;
+	struct snd_soc_dai *cpu_dai = card->dai_link->cpu_dai;
+	struct davinci_audio_dev *dev_list = cpu_dai->private_data;
+	struct davinci_audio_dev *dev;
+	int i;
+
+	if (!dai->active)
+		return 0;
+	
+	for (i = 0; i < card->num_links; i++) {
+        dev = &dev_list[i];
+        clk_enable(dev->clk);
+    }
+
+	return 0;
+}
+#else
+#define davinci_i2s_mcasp_suspend	NULL
+#define davinci_i2s_mcasp_resume	NULL
+#endif
+
 struct snd_soc_dai davinci_iis_mcasp_dai[] = {
 	{
 		.name = "davinci-i2s",
 		.id = 0,
 		.probe = davinci_i2s_mcasp_probe,
 		.remove = davinci_i2s_mcasp_remove,
+		.suspend = davinci_i2s_mcasp_suspend,
+		.resume = davinci_i2s_mcasp_resume,
 		.playback = {
 			.channels_min = 1,
 			.channels_max = 384,
-- 
1.6.5.2

