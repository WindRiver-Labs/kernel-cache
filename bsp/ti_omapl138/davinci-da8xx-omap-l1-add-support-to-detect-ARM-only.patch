From ac844f23fdb119047a8b22cc3120223f5b691728 Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Mon, 24 May 2010 18:44:02 +0800
Subject: [PATCH 13/23] davinci: da8xx/omap-l1: add support to detect ARM only devices

Original codes from TI Linux Platform Support Package
DaVinci-PSP-SDK-03.20.00.12.tgz http://software-dl.ti.com/dsps/
dsps_public_sw/sdo_sb/targetcontent/psp/DaVinci-PSP-SDK/03_20/index_FDS.html

Add a function to read hardware register to determine if a
device is ARM only or ARM + DSP variant. This is used later
to check if EDMA channels/slots need to be reserved for DSP
or not.

Signed-off-by: Sekhar Nori <nsekhar@ti.com>
Integrated-by: Stanley.Miao <stanley.miao@windriver.com>
---
 arch/arm/mach-davinci/include/mach/da8xx.h |   12 ++++++++++++
 1 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-davinci/include/mach/da8xx.h b/arch/arm/mach-davinci/include/mach/da8xx.h
index 2fade64..22ecead 100644
--- a/arch/arm/mach-davinci/include/mach/da8xx.h
+++ b/arch/arm/mach-davinci/include/mach/da8xx.h
@@ -24,6 +24,7 @@
 #include <mach/mmc.h>
 #include <mach/usb.h>
 #include <mach/pm.h>
+#include <mach/cputype.h>
 
 extern void __iomem *da8xx_syscfg0_base;
 extern void __iomem *da8xx_syscfg1_base;
@@ -42,6 +43,7 @@ extern void __iomem *da8xx_syscfg1_base;
 #define DA8XX_SYSCFG0_BASE	(IO_PHYS + 0x14000)
 #define DA8XX_SYSCFG0_VIRT(x)	(da8xx_syscfg0_base + (x))
 #define DA8XX_JTAG_ID_REG	0x18
+#define DA8XX_CHIPREV_ID_REG	0x24
 #define DA8XX_CFGCHIP0_REG	0x17c
 #define DA8XX_CFGCHIP2_REG	0x184
 #define DA8XX_CFGCHIP3_REG	0x188
@@ -87,6 +89,16 @@ extern void __iomem *da8xx_syscfg1_base;
 #define PINMUX18		0x48
 #define PINMUX19		0x4c
 
+static inline int cpu_is_davinci_da8xx_arm_only(void)
+{
+	if (!cpu_is_davinci_da850() && !cpu_is_davinci_da830())
+		return 0;
+
+	/* BIT(5) is 0 for ARM only or DSP only devices. */
+	return !(__raw_readl(DA8XX_SYSCFG0_VIRT(DA8XX_CHIPREV_ID_REG))
+								& BIT(5));
+}
+
 void __init da830_init(void);
 void __init da850_init(void);
 
-- 
1.6.5.2

