From 4787c4c52b5bcc5339e234311939f72d259ee61c Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Wed, 9 Dec 2009 16:29:11 +0800
Subject: [PATCH 40/43] usb: fix a bug in USB_DUAL_ROLE_MODE

When usb is in USB_OTG_MODE or Gadget mode, the usb gadget driver is
registed when the target is connected to a PC. But in USB_DUAL_ROLE_MODE
mode, the usb gadget driver is registed when the target is booted, even
it is not connected to a PC. So the "is_active" can't be set to 1 when it
is in USB_DUAL_ROLE_MODE.

Signed-off-by: Stanley.Miao <stanley.miao@windriver.com>
---
 drivers/usb/musb/musb_gadget.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/drivers/usb/musb/musb_gadget.c b/drivers/usb/musb/musb_gadget.c
index e217e5e..85368d8 100644
--- a/drivers/usb/musb/musb_gadget.c
+++ b/drivers/usb/musb/musb_gadget.c
@@ -1722,7 +1722,9 @@ int usb_gadget_register_driver(struct usb_gadget_driver *driver)
 		spin_lock_irqsave(&musb->lock, flags);
 
 		otg_set_peripheral(musb->xceiv, &musb->g);
-		musb->is_active = 1;
+
+		if (!is_dr_enabled(musb))
+			musb->is_active = 1;
 
 		/* FIXME this ignores the softconnect flag.  Drivers are
 		 * allowed hold the peripheral inactive until for example
-- 
1.6.5.2

