From 6fc6476ea354a4cc5489b48c6c72015a8aed2870 Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Thu, 7 Jan 2010 15:20:14 +0800
Subject: [PATCH 42/43] usb: fix the bug that usb2.0 module can't be installed after usb1.1 module

USB1.1 clock is sourced from USB2.0 clock, USB1.1 module will enable usb2.0
clock and drive on USB2.0 PHY. If USB2.0 module is installed after USB1.1
module, it find USB2.0 PHY is on and will not do the initialization. Now
fix the bug by checking both USB0PHY_PLLON and USB0SESNDEN when USB2.0
is installed.

Signed-off-by: Stanley.Miao <stanley.miao@windriver.com>
---
 arch/arm/mach-davinci/devices.c |    8 +++++---
 1 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/arch/arm/mach-davinci/devices.c b/arch/arm/mach-davinci/devices.c
index 6e156e1..09b4721 100644
--- a/arch/arm/mach-davinci/devices.c
+++ b/arch/arm/mach-davinci/devices.c
@@ -620,7 +620,8 @@ static int da8xx_usb_phy_config(struct device *dev, u8 mode, int is_on)
 
 	if (is_on) {
 		/* Check whether USB0 PHY is already powered on */
-		if (cfgchip2 & CFGCHIP2_PHY_PLLON)
+		if ((cfgchip2 & (CFGCHIP2_PHY_PLLON | CFGCHIP2_SESENDEN)) \
+				== (CFGCHIP2_PHY_PLLON | CFGCHIP2_SESENDEN))
 			return 0;
 
 		cfgchip2 &= ~(CFGCHIP2_RESET | CFGCHIP2_PHYPWRDN |
@@ -644,6 +645,7 @@ static int da8xx_usb_phy_config(struct device *dev, u8 mode, int is_on)
 			break;
 		}
 	} else {
+		cfgchip2 &= ~(CFGCHIP2_SESENDEN | CFGCHIP2_VBDTCTEN);
 		/* Ensure that usb1.1 interface clk is not being sourced from
 		 * usb0 interface.  If so do not power down usb0 PHY
 		 */
@@ -651,13 +653,13 @@ static int da8xx_usb_phy_config(struct device *dev, u8 mode, int is_on)
 			!(cfgchip2 & CFGCHIP2_USB1PHYCLKMUX)) {
 			printk(KERN_WARNING "USB1 interface active -\
 				Cannot Power down USB0 PHY\n");
-			return 0;
+			goto end;
 		}
 
 		cfgchip2 &= ~CFGCHIP2_PHY_PLLON;
 		cfgchip2 |= CFGCHIP2_PHYPWRDN | CFGCHIP2_OTGPWRDN;
 	}
-
+end:
 	__raw_writel(cfgchip2, CFGCHIP2);
 
 	if (is_on) {
-- 
1.6.5.2

