From 7e281f84bc184293793fd6319e2f28f725ea6a02 Mon Sep 17 00:00:00 2001
From: Madhvapathi Sriram <sriram.m@ti.com>
Date: Mon, 15 Feb 2010 16:23:13 +0530
Subject: [PATCH 21/23] da850/omapl138: cpufreq: New platform data for PLL async rate

Original codes from TI Linux Platform Support Package
DaVinci-PSP-SDK-03.20.00.12.tgz http://software-dl.ti.com/dsps/
dsps_public_sw/sdo_sb/targetcontent/psp/DaVinci-PSP-SDK/03_20/index_FDS.html

Added a new member, asyncrate, to struct davinci_cpufreq_config,
to facilitate the specification for maximum async frequency to be
used for the platform. This would be used, to (re-)configure the async
related PLL dividers, when frequency change occurs as a result of
DVFS.

Without this change, the async freq would be configured based on
the "previous" divider settings, which may not actually be the
maximum frequency that could be set for async.

Signed-off-by: Madhvapathi Sriram <sriram.m@ti.com>
Integrated-by: Stanley.Miao <stanley.miao@windriver.com>
---
 arch/arm/mach-davinci/cpufreq.c              |    2 +-
 arch/arm/mach-davinci/da850.c                |    1 +
 arch/arm/mach-davinci/include/mach/cpufreq.h |    1 +
 3 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-davinci/cpufreq.c b/arch/arm/mach-davinci/cpufreq.c
index ea0ae0d..e79751f 100644
--- a/arch/arm/mach-davinci/cpufreq.c
+++ b/arch/arm/mach-davinci/cpufreq.c
@@ -216,7 +216,7 @@ static int __init davinci_cpufreq_probe(struct platform_device *pdev)
 	asyncclk = clk_get(NULL, "async");
 	if (!IS_ERR(asyncclk)) {
 		cpufreq.asyncclk = asyncclk;
-		cpufreq.asyncrate = clk_get_rate(asyncclk);
+		cpufreq.asyncrate = pdata->asyncrate;
 	}
 
 	return cpufreq_register_driver(&davinci_driver);
diff --git a/arch/arm/mach-davinci/da850.c b/arch/arm/mach-davinci/da850.c
index 426e5aa..50355e7 100644
--- a/arch/arm/mach-davinci/da850.c
+++ b/arch/arm/mach-davinci/da850.c
@@ -1005,6 +1005,7 @@ static struct davinci_cpufreq_config cpufreq_info = {
 	.init = da850_regulator_init,
 	.set_voltage = da850_set_voltage,
 #endif
+	.asyncrate = 100000000,
 };
 
 static struct platform_device da850_cpufreq_device = {
diff --git a/arch/arm/mach-davinci/include/mach/cpufreq.h b/arch/arm/mach-davinci/include/mach/cpufreq.h
index 3c089cf..37a703f 100644
--- a/arch/arm/mach-davinci/include/mach/cpufreq.h
+++ b/arch/arm/mach-davinci/include/mach/cpufreq.h
@@ -21,6 +21,7 @@ struct davinci_cpufreq_config {
 	struct cpufreq_frequency_table *freq_table;
 	int (*set_voltage) (unsigned int index);
 	int (*init) (void);
+	unsigned long asyncrate;
 };
 
 #endif
-- 
1.6.5.2

