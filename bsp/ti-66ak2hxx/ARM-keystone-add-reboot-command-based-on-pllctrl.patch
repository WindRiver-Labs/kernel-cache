From 4da7aeb6584c933136db3a8f816b1241a74a2eaf Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Wed, 17 Jul 2013 16:22:10 +0800
Subject: [PATCH 28/61] ARM: keystone: add reboot command based on pllctrl

Commit bd72273d403032edb8c7c8d0ba7c6471a7191562 from arago tree
git://arago-project.org/git/projects/linux-keystone.git releases/03.00.00.11/master

This adds pllctrl based reboot code to keystone devices.

Signed-off-by: Murali Karicheri <m-karicheri2@ti.com>
Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 arch/arm/mach-keystone/keystone.c |   30 ++++++++++++++++++++++++++++++
 1 files changed, 30 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-keystone/keystone.c b/arch/arm/mach-keystone/keystone.c
index cd04440..21ff63f 100644
--- a/arch/arm/mach-keystone/keystone.c
+++ b/arch/arm/mach-keystone/keystone.c
@@ -18,6 +18,7 @@
 #include <linux/init.h>
 #include <linux/of_irq.h>
 #include <linux/of_platform.h>
+#include <linux/of_address.h>
 #include <linux/platform_data/davinci-clock.h>
 
 #include <asm/setup.h>
@@ -125,6 +126,34 @@ static void __init keystone_init_meminfo(void)
 					 KEYSTONE_LOW_PHYS_START);
 }
 
+void keystone_restart(char mode, const char *cmd)
+{
+	struct device_node *node;
+	void __iomem *rstctrl;
+	u32 val;
+
+	node = of_find_compatible_node(NULL, NULL, "ti,pllctrl-reset");
+	if (WARN_ON(!node)) {
+		pr_warn("ti, pllctrl-reset node undefined\n");
+		return;
+	}
+
+	rstctrl = of_iomap(node, 0);
+	if (WARN_ON(!rstctrl)) {
+		pr_warn("ti, pllctrl-reset iomap error\n");
+		return;
+	}
+
+	val = __raw_readl(rstctrl);
+	val &= 0xffff0000;
+	val |= 0x5a69;
+	__raw_writel(val, rstctrl);
+
+	val = __raw_readl(rstctrl);
+	val &= 0xfffe0000;
+	__raw_writel(val, rstctrl);
+}
+
 DT_MACHINE_START(KEYSTONE, "KeyStone")
 	.smp		= smp_ops(keystone_smp_ops)
 	.map_io		= keystone_map_io,
@@ -137,4 +166,5 @@ DT_MACHINE_START(KEYSTONE, "KeyStone")
 #ifdef CONFIG_ZONE_DMA
 	.dma_zone_size  = SZ_2G,
 #endif
+	.restart	= keystone_restart,
 MACHINE_END
-- 
1.7.5.4

