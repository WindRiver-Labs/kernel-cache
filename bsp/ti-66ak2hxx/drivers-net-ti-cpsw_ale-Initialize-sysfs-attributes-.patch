From 3f39a44f8087b00413d972e7fea742ea43ca4621 Mon Sep 17 00:00:00 2001
From: Shan Hai <shan.hai@windriver.com>
Date: Thu, 16 Jan 2014 15:27:57 +0800
Subject: [PATCH] drivers/net/ti/cpsw_ale: Initialize sysfs attributes with
 sysfs_attr_init

The below kernel warning message can be seen when CONFIG_DEBUG_LOCKDEP
is enabled, because the lockdep needs static initialisers but the cpsw_ale
driver dynamically allocate the sysfs attributes, fix it by calling
sysfs_attr_init to initialize the attributes.

[ 7684.422861] BUG: key de2737d0 not in .data!
[ 7684.425672] ------------[ cut here ]------------
[ 7684.428919] WARNING: at linux/kernel/lockdep.c:2987 )
[ 7684.444282] DEBUG_LOCKS_WARN_ON(1)
[ 7684.446160] Modules linked in:

[ 7684.448058] CPU: 2 PID: 1 Comm: swapper/0 Not tainted
[ 7684.454869] [<c001570c>] (unwind_backtrace+0x0/0xec) from [<c0011cd4>] (show_stack+0x20/0x24)
[ 7684.461933] [<c0011cd4>] (show_stack+0x20/0x24) from [<c05248bc>] (dump_stack+0x20/0x28)
[ 7684.468840] [<c05248bc>] (dump_stack+0x20/0x28) from [<c001db70>] (warn_slowpath_common+0x5c/0x7c)
[ 7684.476325] [<c001db70>] (warn_slowpath_common+0x5c/0x7c) from [<c001dbd0>] (warn_slowpath_fmt+0x40/0x48)
[ 7684.484400] [<c001dbd0>] (warn_slowpath_fmt+0x40/0x48) from [<c006a07c>] (lockdep_init_map+0x118/0x548)
[ 7684.492313] [<c006a07c>] (lockdep_init_map+0x118/0x548) from [<c01689dc>] (sysfs_add_file_mode+0x80/0xf4)
[ 7684.500392] [<c01689dc>] (sysfs_add_file_mode+0x80/0xf4) from [<c0168a6c>] (sysfs_add_file+0x1c/0x20)
[ 7684.508132] [<c0168a6c>] (sysfs_add_file+0x1c/0x20) from [<c0168aac>] (sysfs_create_file+0x3c/0x40)
[ 7684.515704] [<c0168aac>] (sysfs_create_file+0x3c/0x40) from [<c030f520>] (device_create_file+0x5c/0xa4)
[ 7684.523613] [<c030f520>] (device_create_file+0x5c/0xa4) from [<c035b004>] (cpsw_ale_start+0x80/0x174)
[ 7684.531387] [<c035b004>] (cpsw_ale_start+0x80/0x174) from [<c035d5ac>] (cpsw_open+0x26c/0x404)
[ 7684.538531] [<c035d5ac>] (cpsw_open+0x26c/0x404) from [<c035f160>] (netcp_ndo_open+0x1b4/0x290)
[ 7684.545763] [<c035f160>] (netcp_ndo_open+0x1b4/0x290) from [<c0415d40>] (__dev_open+0xb0/0x104)
[ 7684.552992] [<c0415d40>] (__dev_open+0xb0/0x104) from [<c0415f8c>] (__dev_change_flags+0x9c/0x120)
[ 7684.560473] [<c0415f8c>] (__dev_change_flags+0x9c/0x120) from [<c041609c>] (dev_change_flags+0x20/0x54)
[ 7684.568380] [<c041609c>] (dev_change_flags+0x20/0x54) from [<c0790ac4>] (ip_auto_config+0x1d4/0xfa4)
[ 7684.576032] [<c0790ac4>] (ip_auto_config+0x1d4/0xfa4) from [<c00086d0>] (do_one_initcall+0x60/0x144)
[ 7684.583686] [<c00086d0>] (do_one_initcall+0x60/0x144) from [<c0764d58>] (kernel_init_freeable+0x1b4/0x2ac)
[ 7684.591848] [<c0764d58>] (kernel_init_freeable+0x1b4/0x2ac) from [<c051ea48>] (kernel_init+0x1c/0xf4)
[ 7684.599586] [<c051ea48>] (kernel_init+0x1c/0xf4) from [<c000dc88>] (ret_from_fork+0x14/0x20)
[ 7684.606554] ---[ end trace 0000000000000002 ]---
[ 7684.609817] BUG: key de2737ec not in .data!
[ 7684.612654] BUG: key de273808 not in .data!

Signed-off-by: Shan Hai <shan.hai@windriver.com>
---
 drivers/net/ethernet/ti/cpsw_ale.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/ti/cpsw_ale.c b/drivers/net/ethernet/ti/cpsw_ale.c
index 6e325a7..7d911c2 100644
--- a/drivers/net/ethernet/ti/cpsw_ale.c
+++ b/drivers/net/ethernet/ti/cpsw_ale.c
@@ -1450,14 +1450,17 @@ void cpsw_ale_start(struct cpsw_ale *ale)
 	cpsw_ale_control_set(ale, 0, ALE_CLEAR, 1);
 
 	ale->ale_control_attr = dev_attr_ale_control;
+	sysfs_attr_init(&ale->ale_control_attr.attr);
 	ret = device_create_file(ale->params.dev, &ale->ale_control_attr);
 	WARN_ON(ret < 0);
 
 	ale->ale_table_attr = dev_attr_ale_table;
+	sysfs_attr_init(&ale->ale_table_attr.attr);
 	ret = device_create_file(ale->params.dev, &ale->ale_table_attr);
 	WARN_ON(ret < 0);
 
 	ale->ale_table_raw_attr = dev_attr_ale_table_raw;
+	sysfs_attr_init(&ale->ale_table_raw_attr.attr);
 	ret = device_create_file(ale->params.dev, &ale->ale_table_raw_attr);
 	WARN_ON(ret < 0);
 
-- 
1.7.5.4

