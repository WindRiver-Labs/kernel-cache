From e928c8a578acbbe1f3743cc44a256e7a50c1bed6 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Wed, 13 Nov 2013 15:49:15 +0800
Subject: [PATCH 1/2] drivers: net: keystone: fix a NULL reference on
 entries[idx]

Before entries[idx] being indexed, a NULL pointer test should be
done on it, so this patch is to do the adjustment to avoid the
following kernel panic:

IPv6: eth1: IPv6 duplicate address 2001:db8:0:f102::34 detected!
Unable to handle kernel NULL pointer dereference at virtual address 00000008
pgd = dc2f2ac0
[00000008] *pgd=81c32e003, *pmd=81bab0003, *pte=00000000
Internal error: Oops: a07 [#1] PREEMPT SMP ARM
Modules linked in: nfsd ofpart m25p80 mtd
CPU: 0 PID: 1210 Comm: ifconfig Not tainted 3.10.10-xxx #1
task: dc2c3b80 ti: dc398000 task.ti: dc398000
PC is at pa_add_addr+0xf8/0x210
LR is at netcp_set_rx_mode+0x17c/0x1bc
pc : [<c0446b34>]    lr : [<c0443bb0>]    psr: 60000013
sp : dc399c90  ip : 0000000c  fp : dc399cd4
r10: 00000001  r9 : 00000040  r8 : 00000001
r7 : 00000002  r6 : db82d980  r5 : dc8fc210  r4 : dc399c98
r3 : 00000001  r2 : 00000000  r1 : 00000000  r0 : dc8fd310
Flags: nZCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user
Control: 30c5387d  Table: 1c2f2ac0  DAC: fffffffd
Process ifconfig (pid: 1210, stack limit = 0xdc398238)
Stack: (0xdc399c90 to 0xdc39a000)
9c80:                                     00000fff c0443bb0 00000000 dc399ca8
9ca0: c043dad4 00000001 00000003 df114000 df114440 dc900780 df114520 db82d980
9cc0: df1144f4 df114500 dc399d0c dc399cd8 c0443bb0 c0446a48 00000006 df11414c
9ce0: df114140 df114000 00000000 c063bdf8 00000000 00000000 dc927f60 00000000
9d00: dc399d2c dc399d10 c04f3a28 c0443a40 00000005 df114000 df114130 00000000
9d20: dc399d54 dc399d30 c04f7eac c04f39a0 00000000 00000000 db96f800 db96f858
9d40: df114000 dc927f14 dc399d64 dc399d58 c04f7edc c04f7e54 dc399dac dc399d68
9d60: c059c4ac c04f7ecc 00ff3333 c0023500 dc399d94 dc399d80 c0028260 c05e7e70
9d80: c059cc14 db96f800 dc399dac dc927f00 db96f800 00000000 dc927f14 00000000
9da0: dc399ddc dc399db0 c059cc78 c059c440 00000000 00000000 db96f580 dc927f60
9dc0: db96f5a0 dc927f00 df114000 00000040 dc399dfc dc399de0 c05855d8 c059c948
9de0: 000002ff 00000000 01000000 350000ff dc399e24 dc399e00 c0585e68 c0585598
9e00: c08db7f8 ffffffff ffffffff db96f580 00000000 db96f5a0 dc399e6c dc399e28
9e20: c05866cc c0585e40 00000000 c03693b4 dc398000 c08d0680 df114000 dc399e80
9e40: c03693b4 be98ca4c c08d0680 be98ca4c c08d0680 dc4df360 00000005 be98ca4c
9e60: dc399eac dc399e70 c0587a28 c0586574 00000080 ffffffff ffffffff 00000000
9e80: b80d0120 02f10000 00000000 35000000 00000040 00000003 db870f00 0000890c
9ea0: dc399ec4 dc399eb0 c057bfc4 c0587998 00008916 dba67600 dc399ee4 dc399ec8
9ec0: c04db394 c057bf40 00000000 dba67600 be98ca4c 00008916 dc399ef4 dc399ee8
9ee0: c0126e14 c04db16c dc399f74 dc399ef8 c0127920 c0126de8 dc399fac dc399f08
9f00: c00083b8 c05e7750 c0094174 c03abd48 db892600 00000004 00000001 fffffffe
9f20: ffffff9c 00010950 dc399f44 dc399f38 c00942a4 c0094058 dc399f54 dc399f48
9f40: c004827c c0094290 dc399f94 00000000 dba67600 be98ca4c 00008916 00000000
9f60: 00000005 00000000 dc399fa4 dc399f78 c0127a2c c0127454 00000021 00000000
9f80: be98ca4c be98cca0 00000040 00000036 c000dd08 dc398000 00000000 dc399fa8
9fa0: c000dac0 c01279d8 be98ca4c be98cca0 00000005 00008916 be98ca4c 00000003
9fc0: be98ca4c be98cca0 00000040 00000036 00000005 00000000 fffffff1 00000000
9fe0: 00019170 be98c9ec 0000a359 b6ed91c6 60000030 00000005 00000000 00000000
[<c0446b34>] (pa_add_addr+0xf8/0x210) from [<c0443bb0>] (netcp_set_rx_mode+0x17c/0x1bc)
[<c0443bb0>] (netcp_set_rx_mode+0x17c/0x1bc) from [<c04f3a28>] (__dev_set_rx_mode+0x94/0x98)
[<c04f3a28>] (__dev_set_rx_mode+0x94/0x98) from [<c04f7eac>] (__dev_mc_add+0x64/0x78)
[<c04f7eac>] (__dev_mc_add+0x64/0x78) from [<c04f7edc>] (dev_mc_add+0x1c/0x20)
[<c04f7edc>] (dev_mc_add+0x1c/0x20) from [<c059c4ac>] (igmp6_group_added+0x78/0x1ac)
[<c059c4ac>] (igmp6_group_added+0x78/0x1ac) from [<c059cc78>] (ipv6_dev_mc_inc+0x33c/0x374)
[<c059cc78>] (ipv6_dev_mc_inc+0x33c/0x374) from [<c05855d8>] (addrconf_join_solict+0x4c/0x54)
[<c05855d8>] (addrconf_join_solict+0x4c/0x54) from [<c0585e68>] (addrconf_dad_start+0x34/0x128)
[<c0585e68>] (addrconf_dad_start+0x34/0x128) from [<c05866cc>] (inet6_addr_add+0x164/0x1d8)
[<c05866cc>] (inet6_addr_add+0x164/0x1d8) from [<c0587a28>] (addrconf_add_ifaddr+0x9c/0xcc)
[<c0587a28>] (addrconf_add_ifaddr+0x9c/0xcc) from [<c057bfc4>] (inet6_ioctl+0x90/0xf4)
[<c057bfc4>] (inet6_ioctl+0x90/0xf4) from [<c04db394>] (sock_ioctl+0x234/0x288)
[<c04db394>] (sock_ioctl+0x234/0x288) from [<c0126e14>] (vfs_ioctl+0x38/0x4c)
[<c0126e14>] (vfs_ioctl+0x38/0x4c) from [<c0127920>] (do_vfs_ioctl+0x4d8/0x584)
[<c0127920>] (do_vfs_ioctl+0x4d8/0x584) from [<c0127a2c>] (SyS_ioctl+0x60/0x8c)
[<c0127a2c>] (SyS_ioctl+0x60/0x8c) from [<c000dac0>] (ret_fast_syscall+0x0/0x30)

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/ti/keystone_pa.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/ti/keystone_pa.c b/drivers/net/ethernet/ti/keystone_pa.c
index 4fc4e75..1e3aa00 100644
--- a/drivers/net/ethernet/ti/keystone_pa.c
+++ b/drivers/net/ethernet/ti/keystone_pa.c
@@ -2065,9 +2065,9 @@ int pa_add_addr(void *intf_priv, struct netcp_addr *naddr)
 
 	for (idx = 0; idx < count; idx++) {
 		entries[idx] = pa_lut_alloc(pa_dev, naddr->type == ADDR_ANY);
-		entries[idx]->naddr = naddr;
 		if (!entries[idx])
 			goto fail_alloc;
+		entries[idx]->naddr = naddr;
 	}
 
 	addr = (naddr->type == ADDR_ANY) ? NULL : naddr->addr;
-- 
1.8.4.93.g57e4c17

