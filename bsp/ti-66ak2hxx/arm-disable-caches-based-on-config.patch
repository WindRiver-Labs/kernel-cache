From e234f3167e4149918f7e08b9d0f2784c68e284dd Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Mon, 15 Jul 2013 15:42:08 +0800
Subject: [PATCH 10/61] arm: disable caches based on config

Commit c6fbb3ffc423691f49a0f580c137473386a05389 from arago tree
git://arago-project.org/git/projects/linux-keystone.git releases/03.00.00.11/master

Currently the code doesn't check the config variable before enable I and D
cache. This patch fix this issue.

Signed-off-by: Murali Karicheri <m-karicheri2@ti.com>
Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 arch/arm/boot/compressed/head.S |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/arm/boot/compressed/head.S b/arch/arm/boot/compressed/head.S
index e9389dc..ca21fff 100644
--- a/arch/arm/boot/compressed/head.S
+++ b/arch/arm/boot/compressed/head.S
@@ -661,6 +661,12 @@ __armv7_mmu_cache_on:
 		orr	r0, r0, #1 << 25	@ big-endian page tables
 #endif
 		mrcne   p15, 0, r6, c2, c0, 2   @ read ttb control reg
+#ifdef CONFIG_CPU_DCACHE_DISABLE
+		bic	r0, r0, #1 << 2
+#endif
+#ifdef CONFIG_CPU_ICACHE_DISABLE
+		bic	r0, r0, #1 << 12
+#endif
 		orrne	r0, r0, #1		@ MMU enabled
 		movne	r1, #0xfffffffd		@ domain 0 = client
 		bic     r6, r6, #1 << 31        @ 32-bit translation system
-- 
1.7.5.4

