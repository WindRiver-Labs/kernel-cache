From d369aa53bde15791ff58f3ca142a03c629e397cd Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Wed, 17 Jul 2013 16:34:04 +0800
Subject: [PATCH 35/61] ARM: keystone: add support for KeyStone I class
 devices

Commit 7a6887a9d600c081997953846d1f83fd07bbb349 from arago tree
git://arago-project.org/git/projects/linux-keystone.git releases/03.00.00.11/master

Signed-off-by: Cyril Chemparathy <cyril@ti.com>
Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 arch/arm/mach-keystone/keystone.c |   60 ++++++++++++++++++++++++++++--------
 arch/arm/mach-keystone/keystone.h |    2 +
 2 files changed, 48 insertions(+), 14 deletions(-)

diff --git a/arch/arm/mach-keystone/keystone.c b/arch/arm/mach-keystone/keystone.c
index 2496d77..4000061 100644
--- a/arch/arm/mach-keystone/keystone.c
+++ b/arch/arm/mach-keystone/keystone.c
@@ -19,6 +19,7 @@
 #include <linux/of_irq.h>
 #include <linux/of_platform.h>
 #include <linux/of_address.h>
+#include <linux/irqchip/tci6614.h>
 #include <linux/platform_data/davinci-clock.h>
 
 #include <asm/setup.h>
@@ -55,6 +56,10 @@ static const struct of_device_id irq_match[] = {
 		.compatible = "arm,cortex-a15-gic",
 		.data = gic_of_init,
 	},
+	{
+		.compatible = "ti,tci6614-intctrl",
+		.data = tci6614_of_init_irq,
+	},
 	{}
 };
 
@@ -72,9 +77,21 @@ static void __init keystone_init_irq(void)
 
 static void __init keystone_timer_init(void)
 {
+	int error;
+
 	davinci_of_clk_init();
-	arch_timer_of_register();
-	arch_timer_sched_clock_init();
+
+	error = tci6614_timer_init();
+	if (!error)
+		return;
+
+	error = arch_timer_of_register();
+	if (!error) {
+		arch_timer_sched_clock_init();
+		return;
+	}
+
+	panic("no timer!\n");
 }
 
 static struct sys_timer keystone_timer = {
@@ -122,8 +139,14 @@ static int __init keystone_wd_rstmux_init(void)
 }
 postcore_initcall(keystone_wd_rstmux_init);
 
-static const char *keystone_match[] __initconst = {
+static const char *keystone1_match[] __initconst = {
+	"ti,tci6614-evm",
+	NULL,
+};
+
+static const char *keystone2_match[] __initconst = {
 	"ti,keystone-evm",
+	"ti,tci6638-evm",
 	NULL,
 };
 
@@ -160,11 +183,11 @@ static void __init keystone_init_meminfo(void)
 	if (mem_start < KEYSTONE_HIGH_PHYS_START ||
 	    mem_end   > KEYSTONE_HIGH_PHYS_END) {
 		panic("Invalid address space for memory (%08llx-%08llx)\n",
-		      mem_start, mem_end);
+		      (u64)mem_start, (u64)mem_end);
 	}
 
 	offset += KEYSTONE_HIGH_PHYS_START;
-	pr_info("switching to high address space at 0x%llx\n", offset);
+	pr_info("switching to high address space at 0x%llx\n", (u64)offset);
 	__pv_phys_offset = offset;
 	__pv_offset	= offset - PAGE_OFFSET;
 
@@ -204,17 +227,26 @@ void keystone_restart(char mode, const char *cmd)
 	__raw_writel(val, rstctrl);
 }
 
-DT_MACHINE_START(KEYSTONE, "KeyStone")
-	.smp		= smp_ops(keystone_smp_ops)
-	.map_io		= keystone_map_io,
-	.init_irq	= keystone_init_irq,
-	.timer		= &keystone_timer,
+#define KEYSTONE_MACHINE_DEFS				\
+	.map_io		= keystone_map_io,		\
+	.init_irq	= keystone_init_irq,		\
+	.timer		= &keystone_timer,		\
+	.init_machine	= keystone_init,		\
+	.init_meminfo	= keystone_init_meminfo,	\
+	.restart	= keystone_restart,
+
+DT_MACHINE_START(KEYSTONE1, "KeyStone1")
+	KEYSTONE_MACHINE_DEFS
+	.handle_irq	= tci6614_handle_irq,
+	.dt_compat	= keystone1_match,
+MACHINE_END
+
+DT_MACHINE_START(KEYSTONE2, "KeyStone2")
+	KEYSTONE_MACHINE_DEFS
+	.smp		= smp_ops(keystone_smp_ops),
 	.handle_irq	= gic_handle_irq,
-	.init_machine	= keystone_init,
-	.dt_compat	= keystone_match,
-	.init_meminfo	= keystone_init_meminfo,
+	.dt_compat	= keystone2_match,
 #ifdef CONFIG_ZONE_DMA
 	.dma_zone_size  = SZ_2G,
 #endif
-	.restart	= keystone_restart,
 MACHINE_END
diff --git a/arch/arm/mach-keystone/keystone.h b/arch/arm/mach-keystone/keystone.h
index dabb4cd..695df12 100644
--- a/arch/arm/mach-keystone/keystone.h
+++ b/arch/arm/mach-keystone/keystone.h
@@ -22,4 +22,6 @@ extern void secondary_startup(void);
 
 extern int __init keystone_pm_runtime_init(void);
 
+extern int __init tci6614_timer_init(void);
+
 #endif /* __KEYSTONE_H__ */
-- 
1.7.5.4

