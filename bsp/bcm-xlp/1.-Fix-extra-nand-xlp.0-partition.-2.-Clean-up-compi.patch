From e217a26d13ff5aa79d2c1f13d7fcbdf46f705e05 Mon Sep 17 00:00:00 2001
From: henry shao <hshao@netlogicmicro.com>
Date: Fri, 15 Apr 2011 23:06:30 -0700
Subject: [PATCH 272/761] 1. Fix extra nand-xlp.0 partition. 2. Clean up
 compile warning

Based on Broadcom SDK 2.3.

Signed-off-by: henry shao <hshao@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/mtd/nand/xlp_plat_nand.c |   27 +++++++++++++++++++++++----
 1 file changed, 23 insertions(+), 4 deletions(-)

diff --git a/drivers/mtd/nand/xlp_plat_nand.c b/drivers/mtd/nand/xlp_plat_nand.c
index 6826140..195b3c6 100644
--- a/drivers/mtd/nand/xlp_plat_nand.c
+++ b/drivers/mtd/nand/xlp_plat_nand.c
@@ -123,6 +123,7 @@ static int dma_wait(int cs)
         return 0;
 }
 
+#ifdef NAND_DEBUG
 static void print_onfi_params(struct nand_onfi_params * p)
 {
 	printk("OFNI parameter \n"); 
@@ -180,6 +181,7 @@ static void print_onfi_params(struct nand_onfi_params * p)
 
 	return;
 }
+#endif
 
 void onfi_init(struct nand_chip *chip)
 {
@@ -655,7 +657,6 @@ int board_nand_init(struct nand_chip *nand)
  */
 static int __devinit xlp_plat_nand_probe(struct platform_device *pdev)
 {
-        struct platform_nand_data *pdata = pdev->dev.platform_data;
         struct xlp_nand_data *data;
         struct nand_state *state ;
         int res = 0;
@@ -732,9 +733,27 @@ static int __devinit xlp_plat_nand_probe(struct platform_device *pdev)
 	print_onfi_params(&data->chip.onfi_params);
 #endif
 
-	/* Register the partitions */
-	add_mtd_partitions(&data->mtd, xlp_nand_partition_info, ARRAY_SIZE(xlp_nand_partition_info));
-        res = add_mtd_device(&data->mtd);
+#ifdef CONFIG_MTD_PARTITIONS
+	if (mtd_has_partitions()) {
+                if (mtd_has_cmdlinepart()) {
+                        static const char *part_probes[] = { "cmdlinepart", NULL, };
+                        data->nr_parts = parse_mtd_partitions(&data->mtd, part_probes, &data->parts, 0);
+                }
+                if(data->nr_parts <= 0)
+                {
+                        data->nr_parts = ARRAY_SIZE(xlp_nand_partition_info);
+                        if(!data->parts)
+                                data->parts = xlp_nand_partition_info;
+                }
+                if(data->nr_parts > 0)
+                {
+			/* Register the partitions */
+                        res = add_mtd_partitions(&data->mtd, data->parts, data->nr_parts);
+                }
+        }
+	else
+#endif
+		res = add_mtd_device(&data->mtd);
 
         if (!res)
                 return res;
-- 
1.7.10.4

