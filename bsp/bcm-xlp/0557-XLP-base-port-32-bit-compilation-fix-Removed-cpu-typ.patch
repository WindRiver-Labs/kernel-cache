From 318cab438fda6db91660099c7b42c71d63c7e54e Mon Sep 17 00:00:00 2001
From: Jayanthi A <jayanthi.annadurai@broadcom.com>
Date: Fri, 20 Jul 2012 11:41:23 +0530
Subject: [PATCH 557/762] XLP base port: 32 bit compilation fix Removed cpu type check in data path

Based on Broadcom SDK 2.3.

Signed-off-by: Jayanthi A <jayanthi.annadurai@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/netlogic/xlp_hal_pic.h |   31 +++++++++++++++++++++----
 arch/mips/mm/c-phoenix.c                     |    1 -
 arch/mips/netlogic/xlp/on_chip.c             |   27 +++++++++-------------
 drivers/char/nlm_msgring.c                   |    1 +
 4 files changed, 38 insertions(+), 22 deletions(-)

diff --git a/arch/mips/include/asm/netlogic/xlp_hal_pic.h b/arch/mips/include/asm/netlogic/xlp_hal_pic.h
index 5be880f..ca8fdf9 100644
--- a/arch/mips/include/asm/netlogic/xlp_hal_pic.h
+++ b/arch/mips/include/asm/netlogic/xlp_hal_pic.h
@@ -178,7 +178,7 @@ static __inline__ pic_reg_t* nlm_hal_pic_offset(void)
 {
 	unsigned int cpu = nlm_hal_cpu_id();
 
-	return ((pic_reg_t *) (XLP_IO_PIC_OFFSET + NODE_OFFSET(CPU_TO_NODE(cpu))));
+	return ((pic_reg_t *) (unsigned long) (XLP_IO_PIC_OFFSET + NODE_OFFSET(CPU_TO_NODE(cpu))));
 }
 
 #ifdef CONFIG_64BIT
@@ -197,6 +197,27 @@ static __inline__ unsigned long long nlm_hal_read_pic_reg(pic_reg_t *base,
 
 #else
 
+#include <linux/types.h>
+
+#define nlm_enable_KX(flags)       \
+ __asm__ __volatile__ (        \
+        ".set push\n"          \
+        ".set noat\n"          \
+        ".set noreorder\n"     \
+        "mfc0 %0, $12\n\t"     \
+        "ori $1, %0, 0x81\n\t" \
+        "xori $1, 1\n\t"       \
+        "mtc0 $1, $12\n"       \
+        ".set pop\n"           \
+        : "=r"(flags) );
+
+#define nlm_disable_KX(flags)   \
+ __asm__ __volatile__ (     \
+        ".set push\n"       \
+        "mtc0 %0, $12\n"    \
+        ".set pop\n"        \
+        : : "r"(flags) )
+
 static __inline__ void nlm_hal_write_pic_reg(pic_reg_t *base, unsigned int offset, unsigned long long value)
 {
         uint32_t lsw, msw;
@@ -211,7 +232,7 @@ static __inline__ void nlm_hal_write_pic_reg(pic_reg_t *base, unsigned int offse
         ls = (uint32_t) (val & 0xffffffff);
         ms = (uint32_t) (val >> 32);
 
-        enable_KX(flags);
+        nlm_enable_KX(flags);
         __asm__ __volatile__(".set push\n"
                         ".set noreorder\n"
                         ".set mips64\n"
@@ -230,7 +251,7 @@ static __inline__ void nlm_hal_write_pic_reg(pic_reg_t *base, unsigned int offse
                         :
                         :"r"(val), "r"(lsw), "r"(msw), "r"(ls), "r"(ms)
                         :"$1", "$8");
-        disable_KX(flags);
+        nlm_disable_KX(flags);
 }
  
 static __inline__ unsigned long long nlm_hal_read_pic_reg(pic_reg_t *base, unsigned int offset)
@@ -243,7 +264,7 @@ static __inline__ unsigned long long nlm_hal_read_pic_reg(pic_reg_t *base, unsig
         lsw = (uint32_t) (base+offset);
         msw = (uint32_t) 0xffffffffUL;
 
-        enable_KX(flags);
+        nlm_enable_KX(flags);
         __asm__ __volatile__(".set push\n"
                         ".set noreorder\n"
                         ".set mips64\n"
@@ -262,7 +283,7 @@ static __inline__ unsigned long long nlm_hal_read_pic_reg(pic_reg_t *base, unsig
                         :"r"(lsw), "r"(msw)
                         :"$1", "$8");
 
-        disable_KX(flags);
+        nlm_disable_KX(flags);
         value = hi;
         value = (uint64_t) ((value<<32) | lo);
         return (value);
diff --git a/arch/mips/mm/c-phoenix.c b/arch/mips/mm/c-phoenix.c
index 6978edf..d6a8474 100644
--- a/arch/mips/mm/c-phoenix.c
+++ b/arch/mips/mm/c-phoenix.c
@@ -504,7 +504,6 @@ static void nlm_common_local_flush_icache_range_paddr(phys_t start, phys_t end)
 	phys_t addr;
 #ifdef CONFIG_32BIT
 	unsigned long flags;
-	phys_t temp;
 #endif
 #ifdef CONFIG_NLM_XLP
 	int sets_per_way, niter, i;
diff --git a/arch/mips/netlogic/xlp/on_chip.c b/arch/mips/netlogic/xlp/on_chip.c
index acc3044..325151b 100644
--- a/arch/mips/netlogic/xlp/on_chip.c
+++ b/arch/mips/netlogic/xlp/on_chip.c
@@ -253,6 +253,8 @@ static uint16_t xlp2xx_vc_to_handle_map[MAX_VC] = {
 
 };
 
+static uint16_t *vc_to_handle = vc_to_handle_map;
+
 /******************************************************************************************
  *  dummy_handler 
  *
@@ -440,15 +442,7 @@ void nlm_xlp_msgring_int_handler(unsigned int irq, struct pt_regs *regs)
 			if(status != 0)
 				continue;
 
-			if (is_nlm_xlp2xx()) {
-				handler = &msg_handler_map[xlp2xx_vc_to_handle_map[src_id]];
-			}
-			else if (is_nlm_xlp3xx()) {
-				handler = &msg_handler_map[xlp3xx_vc_to_handle_map[src_id]];
-			}
-			else {
-				handler = &msg_handler_map[vc_to_handle_map[src_id]];
-			}
+			handler = &msg_handler_map[vc_to_handle[src_id]];
 
 			/* Execute device driver fmn handler */
 			(handler->action)(vc, src_id, size, code,
@@ -713,13 +707,7 @@ int xlp_fmn_poll(struct napi_struct *napi, int budget)
 				continue;
 			}
 			count++;
-			if (is_nlm_xlp3xx()) {
-				hndlr_id = xlp3xx_vc_to_handle_map[src_id];
-			}
-			else {
-				hndlr_id = vc_to_handle_map[src_id];
-			}
-
+			hndlr_id = vc_to_handle[src_id];
 			handler = &msg_handler_map[hndlr_id];
 
 			/* Execute device driver fmn handler */
@@ -842,6 +830,13 @@ void on_chip_init(void)
 			atomic_set(&nlm_common_counters[i][j], 0);
 
 #ifdef CONFIG_XLP_FMN_SUPPORT
+	if (is_nlm_xlp2xx())
+		vc_to_handle = xlp2xx_vc_to_handle_map;
+	else if (is_nlm_xlp3xx())
+		vc_to_handle = xlp3xx_vc_to_handle_map;
+	else
+		vc_to_handle = vc_to_handle_map;
+
 	if(xlp_napi_vc_mask)
 		xlp_napi_fmn_setup();
 #endif
diff --git a/drivers/char/nlm_msgring.c b/drivers/char/nlm_msgring.c
index e58e6e2..4ea391f 100644
--- a/drivers/char/nlm_msgring.c
+++ b/drivers/char/nlm_msgring.c
@@ -36,6 +36,7 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #include <linux/mman.h>
 #include <linux/slab.h>
 #include <linux/device.h>
+#include <asm/netlogic/msgring.h>
 #include <asm/netlogic/hal/nlm_hal_macros.h>
 #include <asm/netlogic/hal/nlm_hal_xlp_dev.h>
 
-- 
1.7.0.4

