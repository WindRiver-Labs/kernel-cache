From 4c513c57247eb155238054fabd459b84903ac6fd Mon Sep 17 00:00:00 2001
From: henry shao <hshao@netlogicmicro.com>
Date: Thu, 16 Jun 2011 15:02:51 -0700
Subject: [PATCH 300/762] Add OHCI support. Enable USB Keyboard and Mouse. Add /dev/sdc and /dev/sdd to initramfs.

Based on Broadcom SDK 2.3.

Signed-off-by: henry shao <hshao@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/platform.c |   18 +++++++++++-------
 drivers/usb/host/Kconfig          |    1 +
 drivers/usb/host/ohci-pci.c       |   37 +++++++++++++++++++++++++++++++------
 3 files changed, 43 insertions(+), 13 deletions(-)

diff --git a/arch/mips/netlogic/xlp/platform.c b/arch/mips/netlogic/xlp/platform.c
index a827659..c3db12e 100644
--- a/arch/mips/netlogic/xlp/platform.c
+++ b/arch/mips/netlogic/xlp/platform.c
@@ -109,23 +109,27 @@ static void xlp_init_uart(int port_id)
 static void xlp_usb_hw_start(int ctrl_no)
 {
 	int val;
+	
+	/* Disable 64bit enable
+ 	 */
+	val = usb_reg_read( 0, ctrl_no, XLP_USB_CTL0);
+	val &= ~USBEHCI64BITEN;
+	usb_reg_write(0, ctrl_no, XLP_USB_CTL0, val);
 
-	/* reset USB phy 
+	/* Reset USB phy 
 	 */
 	val = usb_reg_read( 0, ctrl_no, XLP_USB_PHY0);
 
 	if(ctrl_no == 0)
 		val &= ~(USBPHYRESET | USBPHYPORTRESET0 | USBPHYPORTRESET1);
 	else if(ctrl_no == 3)
-		val &= ~(USBPHYRESET | USBPHYPORTRESET0 | USBPHYPORTRESET1);
-
+		val &= ~(USBPHYPORTRESET0 | USBPHYPORTRESET1);
 	usb_reg_write(0, ctrl_no, XLP_USB_PHY0, val);
-
-	udelay(2000);
-
+	
+	/* Bring usb controller out of reset
+ 	 */
 	val = usb_reg_read( 0, ctrl_no, XLP_USB_CTL0);
 	val &= ~(USBCONTROLLERRESET );
-	val |= 0x4;
 	usb_reg_write(0, ctrl_no, XLP_USB_CTL0, val);
 
 	return;
diff --git a/drivers/usb/host/Kconfig b/drivers/usb/host/Kconfig
index 08d0def..1d1f0d3 100644
--- a/drivers/usb/host/Kconfig
+++ b/drivers/usb/host/Kconfig
@@ -482,6 +482,7 @@ config USB_EHCI_HCD_PLATFORM
 config USB_OHCI_BIG_ENDIAN_DESC
 	bool
 	depends on USB_OHCI_HCD
+	default n if NLM_XLP
 	default y 
 
 config USB_OHCI_BIG_ENDIAN_MMIO
diff --git a/drivers/usb/host/ohci-pci.c b/drivers/usb/host/ohci-pci.c
index 23514be..9abe999 100644
--- a/drivers/usb/host/ohci-pci.c
+++ b/drivers/usb/host/ohci-pci.c
@@ -43,7 +43,6 @@ static void xlp_usb_start_ohc(int ctrl_no)
 	 */
 	usb_reg_write(0, ctrl_no, XLP_USB_INT_EN,
 			USB_CTRL_INTERRUPT_EN
-			| USB_OHCI_INTERRUPT_EN
 			| USB_OHCI_INTERRUPT12_EN
 			| USB_OHCI_INTERRUPT1_EN);
 	return;
@@ -53,9 +52,10 @@ static void xlp_usb_stop_ohc(int ctrl_no)
 {
 	int val;
 
+	/* disable interrupts
+	 */
 	val = usb_reg_read(0, ctrl_no, XLP_USB_INT_EN);
 	val &= ~(USB_CTRL_INTERRUPT_EN
-			| USB_OHCI_INTERRUPT_EN
 			| USB_OHCI_INTERRUPT12_EN
 			| USB_OHCI_INTERRUPT1_EN);
 	usb_reg_write(0, ctrl_no, XLP_USB_INT_EN, val);
@@ -66,7 +66,7 @@ static void xlp_usb_stop_ohc(int ctrl_no)
 int xlp_ohci_hcd_pci_probe(struct pci_dev *dev, 
 		const struct pci_device_id *id)
 {
-	int irq, irt, ctrl_no;
+	int irq, irt, ctrl_no, val;
 
 	ctrl_no = dev->devfn & 0xF;
 
@@ -80,8 +80,31 @@ int xlp_ohci_hcd_pci_probe(struct pci_dev *dev,
 	}
 
 	dev->irq = irq;
+	val = usb_hcd_pci_probe(dev, id);
 	xlp_usb_start_ohc(ctrl_no);
-	return usb_hcd_pci_probe(dev, id);
+	return val;
+}
+
+void xlp_ohci_hcd_pci_remove(struct pci_dev *dev)
+{
+	int ctrl_no;
+
+	ctrl_no = dev->devfn & 0xF;
+	xlp_usb_stop_ohc(ctrl_no);
+
+	usb_hcd_pci_remove(dev);
+	return;
+}
+
+void xlp_ohci_hcd_pci_shutdown(struct pci_dev *dev)
+{
+	int ctrl_no;
+
+	ctrl_no = dev->devfn & 0xF;
+	xlp_usb_stop_ohc(ctrl_no);
+
+	usb_hcd_pci_shutdown(dev);
+	return;
 }
 #endif
 
@@ -485,12 +508,14 @@ static struct pci_driver ohci_pci_driver = {
 	.name =		(char *) hcd_name,
 	.id_table =	pci_ids,
 #if defined(CONFIG_NLM_XLP) && defined(CONFIG_USB)
-	.probe =    xlp_ohci_hcd_pci_probe,
+	.probe =	xlp_ohci_hcd_pci_probe,
+	.remove =	xlp_ohci_hcd_pci_remove,
+	.shutdown =	xlp_ohci_hcd_pci_shutdown,
 #else
 	.probe =	usb_hcd_pci_probe,
-#endif
 	.remove =	usb_hcd_pci_remove,
 	.shutdown =	usb_hcd_pci_shutdown,
+#endif
 
 #ifdef CONFIG_PM_SLEEP
 	.driver =	{
-- 
1.7.0.4

