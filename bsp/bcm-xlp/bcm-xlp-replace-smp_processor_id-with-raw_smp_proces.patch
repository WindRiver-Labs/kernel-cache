From 7e7e8a3d5fdddd44ef0dc74c163232bb3c226770 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Fri, 8 Nov 2013 15:35:00 +0800
Subject: [PATCH] bcm-xlp: replace smp_processor_id with raw_smp_processor_id

When CONFIG_DEBUG_PREEMPT is enabled, use raw_smp_processor_id() instead of
smp_processor_id() to access current_cpu_data, else system would report the
call trace as below:

[157885.610000] debug_smp_processor_id: 1601 callbacks suppressed
[157885.610000] BUG: using smp_processor_id() in preemptible [00000000] code: gdb/24531
[157885.620000] caller is ptrace_get_watch_regs+0x5c/0x248
[157885.690000] Call Trace:
[157885.690000] [<ffffffffc1045768>] show_stack+0xc0/0xe0
[157885.700000] [<ffffffffc14a78c8>] debug_smp_processor_id+0xe8/0x100
[157885.700000] [<ffffffffc1042734>] ptrace_get_watch_regs+0x5c/0x248
[157885.710000] [<ffffffffc104cc60>] compat_arch_ptrace+0xf0/0x820
[157885.710000] [<ffffffffc107e1b8>] compat_sys_ptrace+0x150/0x188
[157885.720000] [<ffffffffc10550a4>] handle_sys+0x184/0x1a8

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/cpu-info.h | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/arch/mips/include/asm/cpu-info.h b/arch/mips/include/asm/cpu-info.h
index 41401d8..dda129d 100644
--- a/arch/mips/include/asm/cpu-info.h
+++ b/arch/mips/include/asm/cpu-info.h
@@ -82,7 +82,11 @@ struct cpuinfo_mips {
 } __attribute__((aligned(SMP_CACHE_BYTES)));
 
 extern struct cpuinfo_mips cpu_data[];
+#ifdef CONFIG_DEBUG_PREEMPT
+#define current_cpu_data cpu_data[raw_smp_processor_id()]
+#else
 #define current_cpu_data cpu_data[smp_processor_id()]
+#endif
 #define raw_current_cpu_data cpu_data[raw_smp_processor_id()]
 
 extern void cpu_probe(void);
-- 
1.8.4.93.g57e4c17

