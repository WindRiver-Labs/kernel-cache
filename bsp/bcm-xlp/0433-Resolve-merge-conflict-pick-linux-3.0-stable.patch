From 904cd1f872702662cc2f75949470c1b574df9e13 Mon Sep 17 00:00:00 2001
From: Zi Shen Lim <zlim@netlogicmicro.com>
Date: Mon, 3 Oct 2011 12:03:51 -0700
Subject: [PATCH 433/762] Resolve merge conflict: pick linux-3.0-stable

Based on Broadcom SDK 2.3.

Signed-off-by: Zi Shen Lim <zlim@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 net/key/af_key.c |   33 ++-------------------------------
 1 files changed, 2 insertions(+), 31 deletions(-)

diff --git a/net/key/af_key.c b/net/key/af_key.c
index ea8de28..7e5d927 100644
--- a/net/key/af_key.c
+++ b/net/key/af_key.c
@@ -1158,7 +1158,6 @@ static struct xfrm_state * pfkey_msg2xfrm_state(struct net *net,
 		/* x->algo.flags = sa->sadb_sa_flags; */
 	}
 	if (sa->sadb_sa_encrypt) {
-		int try_aead = 0;
 		if (hdr->sadb_msg_satype == SADB_X_SATYPE_IPCOMP) {
 			struct xfrm_algo_desc *a = xfrm_calg_get_byid(sa->sadb_sa_encrypt);
 			if (!a) {
@@ -1174,8 +1173,8 @@ static struct xfrm_state * pfkey_msg2xfrm_state(struct net *net,
 			int keysize = 0;
 			struct xfrm_algo_desc *a = xfrm_ealg_get_byid(sa->sadb_sa_encrypt);
 			if (!a) {
-				try_aead = 1;
-                                goto try_aead;
+				err = -ENOSYS;
+				goto out;
 			}
 			key = (struct sadb_key*) ext_hdrs[SADB_EXT_KEY_ENCRYPT-1];
 			if (key)
@@ -1191,32 +1190,6 @@ static struct xfrm_state * pfkey_msg2xfrm_state(struct net *net,
 			}
 			x->props.ealgo = sa->sadb_sa_encrypt;
 		}
-try_aead:
-		if (try_aead) {
-                        int keysize = 0;
-                        struct xfrm_algo_desc *aead = xfrm_aead_get_byid(sa->sadb_sa_encrypt);
-                        if (!aead) {
-                                printk("xfrm_aead_get_byid(%d) failed !\n",
-                                                sa->sadb_sa_encrypt);
-                                err = -ENOSYS;
-                                goto out;
-                        }
-                        key = (struct sadb_key*) ext_hdrs[SADB_EXT_KEY_ENCRYPT-1];
-                        if (key)
-                                keysize = (key->sadb_key_bits + 7) / 8;
-                        x->aead = kmalloc(sizeof(*x->aead) + keysize, GFP_KERNEL);
-                        if (!x->aead)
-                                goto out;
-                        strcpy(x->aead->alg_name, aead->name);
-                        x->aead->alg_key_len = 0;
-                        if (key) {
-                                x->aead->alg_key_len = key->sadb_key_bits;
-                                memcpy(x->aead->alg_key, key+1, keysize);
-                        }
-                        x->aead->alg_icv_len = aead->uinfo.aead.icv_truncbits;
-                        printk("Configured AEAD algorithm !\n");
-                }
-
 	}
 	/* x->algo.flags = sa->sadb_sa_flags; */
 
@@ -1276,11 +1249,9 @@ try_aead:
 		memset(&natt->encap_oa, 0, sizeof(natt->encap_oa));
 	}
 
-	printk("xfrm_init_state: start\n");
 	err = xfrm_init_state(x);
 	if (err)
 		goto out;
-	printk("xfrm_init_state: done\n");
 
 	x->km.seq = hdr->sadb_msg_seq;
 	return x;
-- 
1.7.0.4

