From e94fab1f148155df8e817779db91e153600c41cc Mon Sep 17 00:00:00 2001
From: henry shao <hshao@netlogicmicro.com>
Date: Sat, 19 Jun 2010 18:47:44 -0700
Subject: [PATCH 063/762] make cpu node aware when process ebase(5) register

Based on Broadcom SDK 2.3.

Signed-off-by: henry shao <hshao@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/cpu_control_asm.S |   18 +++++++++++++++---
 1 files changed, 15 insertions(+), 3 deletions(-)

diff --git a/arch/mips/netlogic/xlp/cpu_control_asm.S b/arch/mips/netlogic/xlp/cpu_control_asm.S
index f814af9..ca4b444 100644
--- a/arch/mips/netlogic/xlp/cpu_control_asm.S
+++ b/arch/mips/netlogic/xlp/cpu_control_asm.S
@@ -48,7 +48,11 @@
 	prog_c0_status 0 ST0_BEV
 #endif
 	mfc0 		t0, $15, 1
-	andi 		t0, 0x1f
+	mfc0	    	t2, $15, 1
+	andi		t2, 0x180
+	srl		t2, 2
+	andi 		t0, 0x7f
+	or		t0, t0, t2
 	PTR_LA		t1, xlr_stack_pages_temp
 	li   		t2, _THREAD_SIZE
 	srl  		t2, 2
@@ -69,8 +73,12 @@
 	 */
 EXPORT(reset_entry)
 	mfc0    t0, $15, 1
+	mfc0	t2, $15, 1
+	andi	t2, 0x180
+	srl	t2,  2
 	srl     t0, t0 , 2
-	and     t0, t0 , 0x7 # t0 contains the core number
+	or	t0, t0, t2
+	and     t0, t0 , 0x7f # t0 contains the core number
 	li      t1, 0x1
 	sll     t0, t1, t0
 	nor     t0, t0, zero
@@ -127,7 +135,11 @@ EXPORT(__boot_siblings)
 	 * start fetching from this point
 	 */
 	mfc0    t0, $15, 1		/* EBASE, Select 1 	*/
-	andi    t0, 0x1f		/* Linear CPU ID	*/
+	mfc0	t2, $15, 1
+	andi	t2, 0x180
+	srl	t2,  2
+	andi    t0, 0x7f		/* Linear CPU ID	*/
+	or	t0, t0, t2
 	beqz    t0, 2f
 	nop
 1:
-- 
1.7.0.4

