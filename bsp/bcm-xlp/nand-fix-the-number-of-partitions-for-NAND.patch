From da78f17d56d67e3383a64dbb1f51763836e6629e Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Mon, 22 Apr 2013 17:44:24 +0800
Subject: [PATCH 653/761] nand: fix the number of partitions for NAND.

1) Number of partition(s) should not be filled as static data.
2) XMC NAND partitions changed.

Based on Broadcom SDK 2.3.

Signed-off-by: Vikas Gupta <vikas.gupta@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/xlp_plat_nand.c |   20 +++++++++++++-------
 1 file changed, 13 insertions(+), 7 deletions(-)

diff --git a/arch/mips/netlogic/xlp/xlp_plat_nand.c b/arch/mips/netlogic/xlp/xlp_plat_nand.c
index 8294579..69df1aa 100644
--- a/arch/mips/netlogic/xlp/xlp_plat_nand.c
+++ b/arch/mips/netlogic/xlp/xlp_plat_nand.c
@@ -823,7 +823,7 @@ static int __devinit xlp_plat_nand_probe(struct platform_device *pdev)
  */
 #if defined(CONFIG_NLM_XMC_SUPPORT)
 static struct mtd_partition xlp_nand_partitions[] = {
-        {
+	{
         .name = "X-LOADER",
         .offset = 0,
         .size = 4 * 64 * 2048,
@@ -831,23 +831,29 @@ static struct mtd_partition xlp_nand_partitions[] = {
         {
         .name = "U-BOOT",
         .offset = MTDPART_OFS_APPEND,
-        .size = 4 * 64 * 2048,
-        },
+        .size = 8 * 64 * 2048,
+        }, 
         {
         .name = "U-BOOT ENV",
         .offset = MTDPART_OFS_APPEND,
-        .size = 4 * 64 * 2048,
+        .size = 1 * 64 * 2048,
         },
         {
         .name = "U-BOOT ENV COPY",
         .offset = MTDPART_OFS_APPEND,
-        .size = 4 * 64 * 2048,
+        .size = 1 * 64 * 2048,
+        },
+        {
+         .name = "SYSCONFIG",
+         .offset = MTDPART_OFS_APPEND,
+         .size = 2 * 64 * 2048,
         },
         {
         .name = "USER",
         .offset = MTDPART_OFS_APPEND ,
         .size = MTDPART_SIZ_FULL ,
         },
+
 };
 #else
 
@@ -873,7 +879,6 @@ static struct resource xlp_nand_flash_resource = {
 static struct platform_nand_data xlp_nand_flash_data __refdata = {
 	.chip= {
 		.nr_chips = 1,
-		.nr_partitions = 2,
 		.partitions = &xlp_nand_partitions[0],
 	        .chip_delay = 15,
 		.options = NAND_NO_READRDY | NAND_NO_AUTOINCR,
@@ -908,7 +913,8 @@ int xlp_nand_flash_dev_init(void){
 
 			xlp_nand_flash_resource.start  = mmio;
 			xlp_nand_flash_resource.end    = mmio + (0x1000 -1);
-
+			
+			xlp_nand_flash_data.chip.nr_partitions = sizeof(xlp_nand_partitions)/sizeof(struct mtd_partition);
 			pplatdev = platform_device_register_resndata( NULL, "gen_nand", i,
 					&xlp_nand_flash_resource, 1, &xlp_nand_flash_data, sizeof(xlp_nand_flash_data));
 			if(pplatdev)	{
-- 
1.7.10.4

