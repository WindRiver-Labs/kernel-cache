From a377eb8cb36866e6a09deb57577199fc4793ea28 Mon Sep 17 00:00:00 2001
From: Prasad Boddupalli <pboddupalli@netlogicmicro.com>
Date: Thu, 24 Jun 2010 15:39:58 -0700
Subject: [PATCH 041/762] changes to remove dependency on boot_info{} structure of the bootloader netlboot

Based on Broadcom SDK 2.3.

Signed-off-by: Prasad Boddupalli <pboddupalli@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/xenbootinfo.c |   82 ++++++++++------------------------
 1 files changed, 24 insertions(+), 58 deletions(-)

diff --git a/arch/mips/netlogic/xlp/xenbootinfo.c b/arch/mips/netlogic/xlp/xenbootinfo.c
index a0726f4..1b532dd 100644
--- a/arch/mips/netlogic/xlp/xenbootinfo.c
+++ b/arch/mips/netlogic/xlp/xenbootinfo.c
@@ -10,80 +10,46 @@
 #include <xen/interface/xen.h>
 #include <asm/xen/hypervisor.h>
 
-static unsigned long memmap_start;
-extern char _end[];
-
-static int deserialize_strings(char **dst, char *src)
-{
-	int narg, i;
-	char *_src = src;
-        
-	memcpy(&narg, src, sizeof(int)); 
-	src += sizeof(int);
-	for (i = 0; i < narg; ++i) {
-		dst[i] = src;
-		src += strlen(src) + 1;
-	}
-	dst[i] = (void *)0;
+#include <asm/netlogic/debug.h>
 
-	return (src - _src);
-}
+extern char _end[];
 
-int read_cmdline_args(int *argc, char *g_argv[], char *g_envp[])
+int fdt_process(void)
 {
-	unsigned long dst;
-
-	dst = (unsigned long)__va((unsigned long) PFN_ALIGN(__pa_symbol(&_end)));
+#if defined(CONFIG_NLM_XLP_SIM)
+	const char *DEFAULT_CONSOLE_BOOT_PARAMS = "boot_noi2c mem=191m@64m mem=512m@512m console=ttyS0,115200 ";
+#else
+	const char *DEFAULT_CONSOLE_BOOT_PARAMS = "mem=255m@1m mem=512m@512m console=ttyS0,115200 ";
+#endif
+	const char *DEFAULT_INITRD_BOOT_PARAMS = "rdinit=/sbin/init ";
 
-	/*
-	 * skip xen start_info page and prom_info structures
-	 */
-	dst += ALIGN(sizeof(struct start_info), sizeof(void *));
-	dst += ALIGN(sizeof(struct psb_info), sizeof(void *));
+    if ((strstr(arcs_cmdline, "console=")) == NULL)
+        strcat(arcs_cmdline, DEFAULT_CONSOLE_BOOT_PARAMS);
+    strcat(arcs_cmdline, " ");
 
-	memcpy((void *)argc, (void *)dst, sizeof(int));
+    strcat(arcs_cmdline, DEFAULT_INITRD_BOOT_PARAMS);
+    strcat(arcs_cmdline, " ");
 
-	printk("dst = 0x%lx\n", dst);
+	xen_start_info = (struct start_info *)__va((unsigned long) PFN_ALIGN(__pa_symbol(&_end)));
 
-	dst += ALIGN(sizeof(int), sizeof(void *));
-	dst += ALIGN(deserialize_strings(g_argv, (char *)dst), sizeof(void *));
-	dst += ALIGN(deserialize_strings(g_envp, (char *)dst), sizeof(void *));
+#define DEF_PHYMEM_START_ADDR   0x100000
+#define DEF_PHYMEM_SIZE       0x0ff00000
 
-	memmap_start = dst;
+	add_memory_region(DEF_PHYMEM_START_ADDR, 
+					  DEF_PHYMEM_SIZE - 512, (long)BOOT_MEM_RAM);
 
 	return 0;
 }
 
-int read_prominfo(void)
+#ifdef CONFIG_FDT
+int wakeup_secondary_cpus(void)
 {
-	unsigned long dst;
-
-	dst = (unsigned long)__va((unsigned long) PFN_ALIGN(__pa_symbol(&_end)));
-
-	xen_start_info = (struct start_info *)dst;
-	dst += ALIGN(sizeof(struct start_info), sizeof(void *));
-
-	prom_info = (struct psb_info *)dst;
-
-	/*
-	 * FIXME: we do not check the validity of start_info 
-	 *        page and prom_info structure.
-	 */
 	return 0;
 }
-
-int read_dram_info(void)
+#else
+int wakeup_secondary_cpus(void (*wakeup)(void *, void *, __u32), struct psb_info *prom_info)
 {
-	memcpy ((void *)&prom_map, (void *)memmap_start, sizeof(struct boot_mem_map));
-	memmap_start += sizeof(struct boot_mem_map);
-
 	return 0;
 }
+#endif
 
-int read_physaddr_map(void)
-{
-	memcpy(&boot_physaddr_info, (void *)memmap_start, sizeof(struct boot_mem_map));
-	memmap_start += sizeof(struct boot_mem_map);
-
-	return 0;
-}
-- 
1.7.0.4

