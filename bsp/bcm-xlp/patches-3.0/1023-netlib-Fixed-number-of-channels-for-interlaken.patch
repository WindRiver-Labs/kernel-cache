From de4ce7c6f5919c7308d8bb0a9e336b9826a88a6f Mon Sep 17 00:00:00 2001
From: Jayanthi A <jayanthi.annadurai@broadcom.com>
Date: Fri, 25 Oct 2013 16:06:29 -0700
Subject: [PATCH 023/160] netlib: Fixed number of channels for interlaken

Signed-off-by: Jack Tan <jack.tan@windriver.com>
Signed-off-by: Jack Tan <jiankemeng@gmail.com>
---
 arch/mips/netlogic/lib/netlib/include/nlm_nae.h   |    1 +
 arch/mips/netlogic/lib/netlib/src/netsoc_config.c |    2 +-
 arch/mips/netlogic/lib/netlib/src/netsoc_nae.c    |    5 ++++-
 3 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/arch/mips/netlogic/lib/netlib/include/nlm_nae.h b/arch/mips/netlogic/lib/netlib/include/nlm_nae.h
index c177857..a0b9323 100644
--- a/arch/mips/netlogic/lib/netlib/include/nlm_nae.h
+++ b/arch/mips/netlogic/lib/netlib/include/nlm_nae.h
@@ -400,6 +400,7 @@ struct nlm_hal_nae_config {
 	uint32_t parser_enable;
 	uint32_t freein_uniq_sz;
 	uint32_t ptp1588_enabled;
+	uint32_t str_fwd_enabled;
         /* POE */
 	poe_t *poe;
 };
diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_config.c b/arch/mips/netlogic/lib/netlib/src/netsoc_config.c
index 3c7fb8f..c18f51b 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_config.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_config.c
@@ -429,7 +429,7 @@ static int __netsoc_update_context_mapping(nae_t *nae, net_port_t **cntx)
                         nae->cntx2port[context] = i;
 			cntx[context] = port;
                         nae->ports[i].num_free_desc /= ctxsize;
-                        nae->ports[i].num_channels = 1;
+                        nae->ports[i].num_channels = ctxsize;
                         nae->ports[i].ext_phy_addr = 0;             //cortina logical port id
                         txq = nae->ports[i].txq;
 
diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
index 2b13285..faf82ff 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
@@ -1282,7 +1282,7 @@ void __netsoc_config_rxbuffer(nae_t *nae, int context_base, int num_channels, ui
 				context_base + offset, base, size, thrgrp);
 		val = 0x80000000 | ((base << 2) & 0x3fff); /* base */
                 val |= (((size << 2)  & 0x3fff) << 16); /* size */
-		if (is_nlm_xlp9xx()) 
+		if ((is_nlm_xlp9xx()) && (nae->str_fwd_enabled)) 
 			val |= (1<<15);
                 netsoc_write_nae_reg(nae_base, RX_BUFFER_BASE_DEPTH_REG, val);
 
@@ -4043,6 +4043,9 @@ static int __netsoc_init_all_ports(nae_t *nae)
 			netsoc_api_print(NETSOC_APIDBG_PORT, "Failed to initialize node %d nae %d port %d\n",nae->node, nae->nae_id, port);
 			while(1);
 		}
+		if ((nae->ports[port].iftype == INTERLAKEN_IF) && (nae->ports[port].ext_phy_addr == 0)) {
+			nae->ports[port].num_channels = 1;
+		}
 		context += contexts_allocated;
 	}
 	return NETSOC_API_SUCCESS;
-- 
1.7.9.5

