From 27d8bf73d1a91c2baf06e4aa6c7360b5752b9918 Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Wed, 12 Feb 2014 17:25:12 +0800
Subject: [PATCH 08/58] bcm-xlp2: add the 'ehb' instructions for xlp2

Based on SDK 3.0 (2013-10-29)

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/kernel/genex.S |    3 +++
 arch/mips/kernel/traps.c |    4 ++++
 arch/mips/mm/tlbex.c     |    5 +++++
 3 files changed, 12 insertions(+)

diff --git a/arch/mips/kernel/genex.S b/arch/mips/kernel/genex.S
index 31fa856..e93b4ee 100644
--- a/arch/mips/kernel/genex.S
+++ b/arch/mips/kernel/genex.S
@@ -46,6 +46,9 @@
 NESTED(except_vec3_generic, 0, sp)
 	.set	push
 	.set	noat
+#ifdef CONFIG_CPU_XLP
+	_ehb
+#endif
 #if R5432_CP0_INTERRUPT_WAR
 	mfc0	k0, CP0_INDEX
 #endif
diff --git a/arch/mips/kernel/traps.c b/arch/mips/kernel/traps.c
index b7abb3c..8db3cfd 100644
--- a/arch/mips/kernel/traps.c
+++ b/arch/mips/kernel/traps.c
@@ -1485,6 +1485,10 @@ void __init *set_except_vector(int n, void *addr)
 #endif
 		u32 *buf = (u32 *)(ebase + 0x200);
 		unsigned int k0 = 26;
+
+		if (current_cpu_type() == CPU_XLP)
+			uasm_i_ehb(&buf);
+
 		if ((handler & jump_mask) == ((ebase + 0x200) & jump_mask)) {
 			uasm_i_j(&buf, handler & ~jump_mask);
 			uasm_i_nop(&buf);
diff --git a/arch/mips/mm/tlbex.c b/arch/mips/mm/tlbex.c
index 0f25e00..6ae175d 100644
--- a/arch/mips/mm/tlbex.c
+++ b/arch/mips/mm/tlbex.c
@@ -491,6 +491,8 @@ static void __cpuinit __maybe_unused build_tlb_probe_entry(u32 **p)
 
 	default:
 		uasm_i_tlbp(p);
+		if (cpu_has_mips_r2)
+			uasm_i_ehb(p);
 		break;
 	}
 }
@@ -1287,6 +1289,9 @@ static void __cpuinit build_r4000_tlb_refill_handler(void)
 	memset(relocs, 0, sizeof(relocs));
 	memset(final_handler, 0, sizeof(final_handler));
 
+	if (current_cpu_type() == CPU_XLP)
+		uasm_i_ehb(&p);
+
 	if ((scratch_reg > 0 || scratchpad_available()) && use_bbit_insns()) {
 		htlb_info = build_fast_tlb_refill_handler(&p, &l, &r, K0, K1,
 							  scratch_reg);
-- 
1.7.9.5

