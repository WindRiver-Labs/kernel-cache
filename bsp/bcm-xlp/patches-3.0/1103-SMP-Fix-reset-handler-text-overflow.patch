From ea04d685d7aae3d11157d3ee22d2d5c5c70b3c4d Mon Sep 17 00:00:00 2001
From: Ashok Kumar <ashoks@broadcom.com>
Date: Thu, 3 Apr 2014 07:15:31 -0700
Subject: [PATCH 103/163] SMP: Fix reset handler text overflow.

reset handler at 0x1fc00000 started overflowing for CONFIG_KVM
after the addition of xlp_mmu_init(enabling ELPA)
in reset handler text. Moved the RESTORE_ALL which is specific
to boot cpu, to xlp_boot_core0_siblings which is part of kernel text.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/netlogic/common/reset.S   |    6 +-----
 arch/mips/netlogic/common/smpboot.S |   10 ++++++++++
 2 files changed, 11 insertions(+), 5 deletions(-)

diff --git a/arch/mips/netlogic/common/reset.S b/arch/mips/netlogic/common/reset.S
index 20bb3c1..6d00807 100644
--- a/arch/mips/netlogic/common/reset.S
+++ b/arch/mips/netlogic/common/reset.S
@@ -300,11 +300,7 @@ EXPORT(nlm_boot_siblings)
 	 * For the boot CPU, we have to restore registers and
 	 * return
 	 */
-4:	dmfc0	t0, $4, 2	/* restore SP from UserLocal */
-	li	t1, 0xfadebeef
-	dmtc0	t1, $4, 2	/* restore SP from UserLocal */
-	PTR_SUBU sp, t0, PT_SIZE
-	RESTORE_ALL
+4:	PTR_LA	ra, restore_boot_cpu
 	jr	ra
 	nop
 EXPORT(nlm_reset_entry_end)
diff --git a/arch/mips/netlogic/common/smpboot.S b/arch/mips/netlogic/common/smpboot.S
index 32add19..8b8c89e 100644
--- a/arch/mips/netlogic/common/smpboot.S
+++ b/arch/mips/netlogic/common/smpboot.S
@@ -73,6 +73,16 @@ FEXPORT(xlp_boot_core0_siblings)	/* "Master" cpu starts from here */
 	nop
 	/* not reached */
 
+FEXPORT(restore_boot_cpu)
+	dmfc0	t0, $4, 2	/* restore SP from UserLocal */
+	li	t1, 0xfadebeef
+	dmtc0	t1, $4, 2	/* restore SP from UserLocal */
+	PTR_SUBU sp, t0, PT_SIZE
+	RESTORE_ALL
+	jr	ra
+	nop
+	/* not reached */
+
 	__CPUINIT
 NESTED(nlm_boot_secondary_cpus, 16, sp)
 	/* Initialize CP0 Status */
-- 
1.7.9.5

