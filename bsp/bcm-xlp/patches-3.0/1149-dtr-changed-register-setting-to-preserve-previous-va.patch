From 613afed9bf0ba1e613f460f9734a4989e2c91972 Mon Sep 17 00:00:00 2001
From: Abhishek Joshi <abjoshi@broadcom.com>
Date: Fri, 28 Mar 2014 12:01:37 +0530
Subject: [PATCH 149/163] dtr: changed register setting to preserve previous
 value

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/netlogic/lib/syslib/src/nlm_hal.c |    7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/arch/mips/netlogic/lib/syslib/src/nlm_hal.c b/arch/mips/netlogic/lib/syslib/src/nlm_hal.c
index 3950f19..eeaf1b0 100644
--- a/arch/mips/netlogic/lib/syslib/src/nlm_hal.c
+++ b/arch/mips/netlogic/lib/syslib/src/nlm_hal.c
@@ -920,6 +920,7 @@ static void nlm_hal_dtr_9xx_init(void *fdt)
 {
 
 	int node=0;
+	uint32_t val =0;
 	const uint64_t mhz = 1000000;
 	uint64_t frequency;
 	uint64_t base0 = nlm_hal_get_dev_base (XLP_DTR_NODE, 1, XLP_DTR_DEVICE, XLP_DTR_FUNC);
@@ -930,7 +931,8 @@ static void nlm_hal_dtr_9xx_init(void *fdt)
 	/* for engine DTRE0 */
 
 	/* Enable Master Control register */
-	nlm_hal_write_32bit_reg (base0, XLP_DTR_MASTER_CONTROL_REG, 0x1);
+	val = nlm_hal_read_32bit_reg (base0, XLP_DTR_MASTER_CONTROL_REG);
+	nlm_hal_write_32bit_reg (base0, XLP_DTR_MASTER_CONTROL_REG, val | 0x1);
 	/* Channel control registers */
 	nlm_hal_write_32bit_reg (base0, XLP_DTR_CHANNEL_CONTROL_REG_0, 0x3fe);
 	nlm_hal_write_32bit_reg (base0, XLP_DTR_CHANNEL_CONTROL_REG_1, 0x3fe);
@@ -950,7 +952,8 @@ static void nlm_hal_dtr_9xx_init(void *fdt)
 	/* for engine DTRE1 */
 
 	/* Enable Master Control register */
-	nlm_hal_write_32bit_reg (base1, XLP_DTR_MASTER_CONTROL_REG, 0x1);
+	val = nlm_hal_read_32bit_reg (base1, XLP_DTR_MASTER_CONTROL_REG);
+	nlm_hal_write_32bit_reg (base1, XLP_DTR_MASTER_CONTROL_REG, val | 0x1);
 	/* Channel control registers */
 	nlm_hal_write_32bit_reg (base1, XLP_DTR_CHANNEL_CONTROL_REG_0, 0x3fe);
 	nlm_hal_write_32bit_reg (base1, XLP_DTR_CHANNEL_CONTROL_REG_1, 0x3fe);
-- 
1.7.9.5

