From bc092b0cbca3272b89c3973698b644801914454d Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Wed, 12 Feb 2014 17:34:03 +0800
Subject: [PATCH 11/58] bcm-xlp2: setup user pgd support

Based on SDK 3.0 (2013-10-29)

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/include/asm/mmu_context.h |    8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/arch/mips/include/asm/mmu_context.h b/arch/mips/include/asm/mmu_context.h
index 516e6e9..21cfb6e 100644
--- a/arch/mips/include/asm/mmu_context.h
+++ b/arch/mips/include/asm/mmu_context.h
@@ -24,6 +24,12 @@
 #endif /* SMTC */
 #include <asm-generic/mm_hooks.h>
 
+#ifdef CONIFG_CPU_XLP
+extern void setup_hwp_user_pgd(unsigned long pgd);
+#else
+#define setup_hwp_user_pgd(pdg)
+#endif
+
 #ifdef CONFIG_MIPS_PGD_C0_CONTEXT
 
 #define TLBMISS_HANDLER_SETUP_PGD(pgd)					\
@@ -196,6 +202,7 @@ static inline void switch_mm(struct mm_struct *prev, struct mm_struct *next,
 	write_c0_entryhi(cpu_asid(cpu, next));
 #endif /* CONFIG_MIPS_MT_SMTC */
 	TLBMISS_HANDLER_SETUP_PGD(next->pgd);
+	setup_hwp_user_pgd((unsigned long)next->pgd);
 
 	/*
 	 * Mark current->active_mm as not "active" anymore.
@@ -256,6 +263,7 @@ activate_mm(struct mm_struct *prev, struct mm_struct *next)
 	write_c0_entryhi(cpu_asid(cpu, next));
 #endif /* CONFIG_MIPS_MT_SMTC */
 	TLBMISS_HANDLER_SETUP_PGD(next->pgd);
+	setup_hwp_user_pgd((unsigned long)next->pgd);
 
 	/* mark mmu ownership change */
 	cpumask_clear_cpu(cpu, mm_cpumask(prev));
-- 
1.7.9.5

