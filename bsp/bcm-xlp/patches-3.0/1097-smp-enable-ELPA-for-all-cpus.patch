From d11ec73141b6f0653a808757f61f994bd59a0039 Mon Sep 17 00:00:00 2001
From: Jayachandran C <jchandra@broadcom.com>
Date: Fri, 28 Mar 2014 15:29:34 +0530
Subject: [PATCH 097/160] smp: enable ELPA for all cpus

Needed for memory >64GB

Signed-off-by: Jack Tan <jack.tan@windriver.com>
Signed-off-by: Jack Tan <jiankemeng@gmail.com>
---
 arch/mips/netlogic/common/reset.S |   14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/arch/mips/netlogic/common/reset.S b/arch/mips/netlogic/common/reset.S
index 9c8ebb0..20bb3c1 100644
--- a/arch/mips/netlogic/common/reset.S
+++ b/arch/mips/netlogic/common/reset.S
@@ -75,6 +75,17 @@
 .endm
 
 /*
+ * mmu init needed before going to C code
+ */
+.macro xlp_early_mmu_init
+	/* setup ELPA in pagegrain register */
+	mfc0	t0, CP0_PAGEMASK, 1
+	li	t1, (1 << 29)
+	or	t0, t1
+	mtc0	t0, CP0_PAGEMASK, 1
+.endm
+
+/*
  * Low level flush for L1D cache on XLP, the normal cache ops does
  * not do the complete and correct cache flush.
  */
@@ -267,6 +278,8 @@ EXPORT(nlm_boot_siblings)
 #endif
 	mtc0	t1, CP0_STATUS
 
+	xlp_early_mmu_init
+
 	/* mark CPU ready */
 	li	t3, CKSEG1ADDR(RESET_DATA_PHYS)
 	ADDIU	t1, t3, BOOT_CPU_READY
@@ -299,6 +312,7 @@ EXPORT(nlm_reset_entry_end)
 LEAF(nlm_init_boot_cpu)
 #ifdef CONFIG_CPU_XLP
 	xlp_config_lsu
+	xlp_early_mmu_init
 #endif
 	jr	ra
 	nop
-- 
1.7.9.5

