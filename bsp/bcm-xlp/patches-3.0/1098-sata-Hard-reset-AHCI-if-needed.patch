From 9ce99b44a2def6c0473145ab8364eb3f2d7739db Mon Sep 17 00:00:00 2001
From: Jayachandran C <jchandra@broadcom.com>
Date: Thu, 3 Apr 2014 23:05:05 +0530
Subject: [PATCH 098/160] sata: Hard reset AHCI if needed

Workaround for the case where u-boot leaves the SATA interface in
unknown state.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
Signed-off-by: Jack Tan <jiankemeng@gmail.com>
---
 arch/mips/netlogic/xlp/ahci-init-xlp2.c |    8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/arch/mips/netlogic/xlp/ahci-init-xlp2.c b/arch/mips/netlogic/xlp/ahci-init-xlp2.c
index 3332001..563d8c1 100644
--- a/arch/mips/netlogic/xlp/ahci-init-xlp2.c
+++ b/arch/mips/netlogic/xlp/ahci-init-xlp2.c
@@ -270,6 +270,14 @@ static void nlm_sata_firmware_init(int node)
 	pr_info("Initializing XLP9XX On-chip AHCI...\n");
 	regbase = nlm_get_sata_regbase(node);
 
+	/* Work around for u-boot leaving SATA in in-determinate mode */
+	reg_val = nlm_read_sata_reg(regbase, SATA_CTL);
+	if (reg_val != 0x800800acU) {
+		pr_info("Hard reset AHCI...\n");
+		nlm_write_sata_reg(regbase, SATA_CTL, 0x800800acU);
+		udelay(1000);
+	}
+
 	/* Reset port0 */
 	sata_clear_glue_reg(regbase, SATA_CTL, P0_IRST_POR);
 	sata_clear_glue_reg(regbase, SATA_CTL, P0_IRST_HARD_TXRX);
-- 
1.7.9.5

