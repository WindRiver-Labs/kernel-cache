From 2d05ba65621ac5072a1631d40f7e105d7c294694 Mon Sep 17 00:00:00 2001
From: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Date: Fri, 22 Oct 2010 10:52:57 -0700
Subject: [PATCH 208/761] Disable prom_reconfigure_thr_resources for XLP

Based on Broadcom SDK 2.3.

Signed-off-by: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/Kconfig       |    2 +-
 arch/mips/netlogic/xlp/on_chip.c |    4 ++--
 arch/mips/netlogic/xlp/setup.c   |   17 +++++++++--------
 3 files changed, 12 insertions(+), 11 deletions(-)

diff --git a/arch/mips/netlogic/Kconfig b/arch/mips/netlogic/Kconfig
index d6678c1..3559f4b 100644
--- a/arch/mips/netlogic/Kconfig
+++ b/arch/mips/netlogic/Kconfig
@@ -26,7 +26,7 @@ config NLMCOMMON_SMP_PREFIX
 
 config NLMCOMMON_GLOBAL_TLB_SPLIT_ASID
         bool "Enable Shared TLB in each CPU core"
-	depends on NLM_COMMON
+	depends on NLM_XLR
 	default n
 	help
 		This option enables the sharing of TLBs by all the threads in core.
diff --git a/arch/mips/netlogic/xlp/on_chip.c b/arch/mips/netlogic/xlp/on_chip.c
index 69b0d99..60c78a2 100644
--- a/arch/mips/netlogic/xlp/on_chip.c
+++ b/arch/mips/netlogic/xlp/on_chip.c
@@ -150,9 +150,9 @@ void dummy_handler(uint32_t vc, uint32_t src_id, uint32_t size, uint32_t code,
 		   uint64_t msg0, uint64_t msg1, uint64_t msg2, uint64_t msg3, void *dev_id)
 {
 	printk("[%s]: No Handler for message from stn_id=%d, bucket=%d, "
-	       "size=%d, msg0=%llx, dropping message\n",
+	       "size=%d, msg0=%llx, msg1=%llx dropping message\n",
 	       __FUNCTION__, src_id, vc, size,
-	       (unsigned long long)msg0);
+	       (unsigned long long)msg0, (unsigned long long)msg1);
 }
 
 /******************************************************************************************
diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index 31b61e8..ad9ecd5 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -225,6 +225,9 @@ void __init bus_error_init(void)
 {
 }
 
+#ifdef CONFIG_NLM_XLP
+void prom_reconfigure_thr_resources(void) {}
+#else
 void prom_reconfigure_thr_resources(void)
 {
 	unsigned int mmu_setup = 0;
@@ -235,8 +238,6 @@ void prom_reconfigure_thr_resources(void)
 	/* Configure thread resources only if it is thread_0 of that core */
 	if (netlogic_thr_id() != 0) return;
 
-#if 0 /* Fix for Multi-Node */
-
 #ifdef CONFIG_NLMCOMMON_GLOBAL_TLB_SPLIT_ASID
 	uint32_t map;
 
@@ -261,9 +262,9 @@ void prom_reconfigure_thr_resources(void)
 			map >>= 4;
 		}
 		if ((nlm_asid_mask == 0x3f) && (netlogic_thr_id() == 0)) {
-			mmu_setup = read_32bit_nlm_ctrl_reg(4, 0);
+			mmu_setup = read_32bit_nlm_ctrl_reg(CPU_BLOCKID_MMU, 0);
 			mmu_setup = mmu_setup | 0x1;
-			write_32bit_nlm_ctrl_reg(4, 0, mmu_setup);
+			write_32bit_nlm_ctrl_reg(CPU_BLOCKID_MMU, 0, mmu_setup);
 
 			printk("CPU %d: Enabled Shared TLB mode \n",
 					netlogic_cpu_id());
@@ -273,7 +274,6 @@ void prom_reconfigure_thr_resources(void)
 	return;
 #endif /* CONFIG_NLMCOMMON_GLOBAL_TLB_SPLIT_ASID */
 
-#endif
 	/* cpu has to be thread@0 */
 	cpu = hard_smp_processor_id();
 
@@ -295,11 +295,12 @@ void prom_reconfigure_thr_resources(void)
 
 	if (dis_contig)	value = 0x3;
 
-	mmu_setup = read_32bit_nlm_ctrl_reg(4, 0);
+	mmu_setup = read_32bit_nlm_ctrl_reg(CPU_BLOCKID_MMU, 0);
 	mmu_setup = mmu_setup & ~0x06;
 	mmu_setup |= (value << 1);
-	write_32bit_nlm_ctrl_reg(4, 0, mmu_setup);
+	write_32bit_nlm_ctrl_reg(CPU_BLOCKID_MMU, 0, mmu_setup);
 }
+#endif
 
 unsigned int __cpuinit get_c0_compare_int(void)
 {
@@ -575,7 +576,7 @@ char* get_cpu_info(void)
 {
 	get_xlp_proc_name();
 	get_xlp_revision();
-	
+
 	return cpu_model_info;
 }
 
-- 
1.7.10.4

