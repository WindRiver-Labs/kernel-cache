From 6d3a8b5c3ec085afa66270505c35de63ec884b18 Mon Sep 17 00:00:00 2001
From: Wangrui Shen <wangrui.shen@windriver.com>
Date: Mon, 2 Sep 2013 12:33:33 +0800
Subject: [PATCH] Wait phy autonegotiation complete for sgmii port

Ethtool uses auto-negotiation mechanism to change the speed/duplex
of SGMII ports in XLP832. Because autoneg is not configured properly,
SGMII ports doesn't work after auto-negotiation.

The root cause is that driver doesn't wait for the completion of
autoneg in PHY chip, and immediately setup the operating mode of
MAC layer according to the unstable operating mode of PHY.

This patch adds a check to wait MAC set-up.

Signed-off-by: Wangrui Shen <wangrui.shen@windriver.com>
---
 drivers/net/nae/xlpge_sgmii.c |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/drivers/net/nae/xlpge_sgmii.c b/drivers/net/nae/xlpge_sgmii.c
index e7d11d4..0fa7112 100644
--- a/drivers/net/nae/xlpge_sgmii.c
+++ b/drivers/net/nae/xlpge_sgmii.c
@@ -43,6 +43,8 @@ int xlp_enable_autoneg(struct net_device *dev, u32 adv)
 	int mii_status;
 	u32 adv1, adv2;
 	unsigned long flags;
+	int bmsr_status = 0;
+	int timeout = 0x1000;
 
 	spin_lock_irqsave(&priv->lock, flags);
 	nlm_xlp_mac_set_enable(priv, 0);
@@ -78,6 +80,14 @@ int xlp_enable_autoneg(struct net_device *dev, u32 adv)
 	mii_status |= (BMCR_ANENABLE | BMCR_ANRESTART);
 	nlm_xlp_mac_mii_write(priv, MII_BMCR, mii_status);
 
+	/* Wait until auto-negotiation finishes, so we can 
+	 * get a right status for MAC layer setup.
+	 */
+	do {
+		bmsr_status = nlm_xlp_mac_mii_read(priv, MII_BMSR);
+
+	} while (!(bmsr_status & BMSR_ANEGCOMPLETE) && timeout--);
+
 	nlm_xlp_mac_set_enable(priv, 1);
 	spin_unlock_irqrestore(&priv->lock, flags);
 
-- 
1.7.5.4

