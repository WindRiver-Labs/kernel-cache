From 594c1822ec54ec193e5999d4db26718c4eb89c67 Mon Sep 17 00:00:00 2001
From: kopal <kopal@broadcom.com>
Date: Thu, 11 Oct 2012 17:18:44 +0530
Subject: [PATCH 611/762] I2C: fixed 32-bit linux crash.

	32-bit linux when enabled with i2c, was crashing as the
i2c device base address was incorrect.

Based on Broadcom SDK 2.3.

Signed-off-by: kopal <kopal@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/i2c/busses/i2c-xlp.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/i2c/busses/i2c-xlp.c b/drivers/i2c/busses/i2c-xlp.c
index 8c7db1f..ca1391e 100644
--- a/drivers/i2c/busses/i2c-xlp.c
+++ b/drivers/i2c/busses/i2c-xlp.c
@@ -445,6 +445,7 @@ i2c_xlp_probe(struct platform_device *pdev)
 {
 	struct i2c_xlp_data *priv;
 	int ret;
+        unsigned long phys;
 #ifdef XLP_I2C_DEBUG
 	i2c_dump_reg();	
 #endif
@@ -461,8 +462,9 @@ i2c_xlp_probe(struct platform_device *pdev)
 	priv->xfer_timeout = 200;
 	priv->ack_timeout = 200;
        	priv->speed	  =i2c_speed; 
-	priv->ioreg = (uint64_t*) (DEFAULT_VIRT_BASE + 
-			nlm_hal_get_dev_base(0, 0, XLP_PCIE_GIO_DEV, priv->func) + 0x100);
+	
+	phys = nlm_hal_get_dev_base(0, 0, XLP_PCIE_GIO_DEV, priv->func) + 0x100;	
+	priv->ioreg = ioremap_nocache(phys, PAGE_SIZE);	
 	priv->adap.nr = pdev->id;
 	priv->adap.algo = &xlp_i2c_algo;
 	priv->adap.algo_data = priv;
-- 
1.7.0.4

