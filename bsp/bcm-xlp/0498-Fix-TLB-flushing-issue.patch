From b9a6a9a03fb409eced92a270b91eb4bc9b4239b5 Mon Sep 17 00:00:00 2001
From: Zi Shen Lim <zlim@netlogicmicro.com>
Date: Wed, 4 Jan 2012 16:23:54 -0800
Subject: [PATCH 498/762] Fix TLB flushing issue

Stale tlbsize was used resulting in incomplete TLB flushes.
During mmu_init, make sure we update tlbsize *after* configuration.

Based on Broadcom SDK 2.3.

Signed-off-by: Zi Shen Lim <zlim@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/kernel/traps.c     |    3 +++
 arch/mips/netlogic/xlp/mmu.c |   11 ++++++-----
 2 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/arch/mips/kernel/traps.c b/arch/mips/kernel/traps.c
index 7ec163e..e239449 100644
--- a/arch/mips/kernel/traps.c
+++ b/arch/mips/kernel/traps.c
@@ -1450,6 +1450,9 @@ void __init *set_except_vector(int n, void *addr)
 		unsigned long jump_mask = ~((1 << 28) - 1);
 		u32 *buf = (u32 *)(ebase + 0x200);
 		unsigned int k0 = 26;
+#ifdef CONFIG_NLM_XLP
+		uasm_i_ehb(&buf);
+#endif /* CONFIG_NLM_XLP */
 		if ((handler & jump_mask) == ((ebase + 0x200) & jump_mask)) {
 			uasm_i_j(&buf, handler & ~jump_mask);
 			uasm_i_nop(&buf);
diff --git a/arch/mips/netlogic/xlp/mmu.c b/arch/mips/netlogic/xlp/mmu.c
index a654e25..4aac3fa 100644
--- a/arch/mips/netlogic/xlp/mmu.c
+++ b/arch/mips/netlogic/xlp/mmu.c
@@ -296,11 +296,6 @@ void mmu_init(void)
 	pgwalker_workaround_setup();
 
 	/*
-	 * Read back TLB entries after configuration
-	 */
-	current_cpu_data.tlbsize = (read_c0_config6() >> 16 ) & 0xffff;
-
-	/*
 	 * shift right half the number of 1s in
 	 * the pagemask and populate that value
 	 */
@@ -337,4 +332,10 @@ void mmu_init(void)
 
 	/* Intialize after pgwalker and others are configured! */
 	write_c0_config6(read_c0_config6() | tlb_config);
+
+	/*
+	 * Read back TLB entries after configuration
+	 */
+	current_cpu_data.tlbsize = ((read_c0_config6() >> 16) & 0xffff) + 1;
 }
+
-- 
1.7.0.4

