From 1812af2b38b2e996e1a0c606ea56764bb5d096a3 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Thu, 24 Jan 2013 15:22:51 +0800
Subject: [PATCH 08/10] nlm_xlp_64_be: fix some kexec issues

1. The size of the newest DTB has increased to 32k, reserve more space for it;
2. Remove some invalid restrictions;
3. Some codes about CONFIG_NLM_16G_MEM_SUPPORT depend on CONFIG_MAPPED_KERNEL,
   add this dependence into Kconfig.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Guojian Zhou <guojian.zhou@windriver.com>
---
 arch/mips/include/asm/mach-netlogic/nlm_kexec.h |    9 +++------
 arch/mips/netlogic/common/nlm_kexec.c           |    5 -----
 arch/mips/netlogic/xlp/setup.c                  |    4 ++++
 3 files changed, 7 insertions(+), 11 deletions(-)

diff --git a/arch/mips/include/asm/mach-netlogic/nlm_kexec.h b/arch/mips/include/asm/mach-netlogic/nlm_kexec.h
index 035a131..d3a4e30 100644
--- a/arch/mips/include/asm/mach-netlogic/nlm_kexec.h
+++ b/arch/mips/include/asm/mach-netlogic/nlm_kexec.h
@@ -26,15 +26,12 @@
 #include <asm/mach-netlogic/nlm_kexec.h>
 #include <linux/bootmem.h>
 #include <asm/setup.h>
+#include "../../../netlogic/boot/ops.h"
 
-/* DTB is about 9kb */
-#define DTB_SIZE	(1 << 14)	/* 16kb */
+/* DTB is about 32kb */
+#define DTB_SIZE       (1 << 16)       /* 64kb */
 #define DTB_ORDER	((DTB_SIZE >> PAGE_SHIFT) - 1)
 
-#ifndef MAX_PROP_LEN
-#define MAX_PROP_LEN 256
-#endif
-
 #define KEXEC_CMDLINE_OFFSET (DTB_SIZE - MAX_PROP_LEN - 1)
 #define kexec_cmdline_addr(base) (base + KEXEC_CMDLINE_OFFSET)
 
diff --git a/arch/mips/netlogic/common/nlm_kexec.c b/arch/mips/netlogic/common/nlm_kexec.c
index 0cd580e..05ce2cb 100644
--- a/arch/mips/netlogic/common/nlm_kexec.c
+++ b/arch/mips/netlogic/common/nlm_kexec.c
@@ -135,8 +135,6 @@ static void shutdown_secondary_cpus(void *crash)
 	/* NOTREACHED */
 }
 
-extern void fixup_irqs(unsigned int cpu, int flag);
-
 static void prepare_cpus(const unsigned long crash)
 {
 	int cpu;
@@ -144,9 +142,6 @@ static void prepare_cpus(const unsigned long crash)
 	smp_call_function(shutdown_secondary_cpus, (void *)crash, 0);
 	smp_wmb();
 	local_irq_disable();
-	/* Reset some devices for rebooting */
-	for_each_online_cpu(cpu)
-		fixup_irqs(cpu, 0);
 }
 
 static void wait_for_cpus(void)
diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index ae20a35..a35274b 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -1080,6 +1080,10 @@ void __init prom_init(void)
 
 	xen_init();
 
+#ifndef CONFIG_MAPPED_KERNEL
+	write_c0_ebase(read_c0_ebase() | 0x10000);
+#endif
+
 	nlm_common_ebase = read_c0_ebase() & (~((1 << 12) - 1));
 
 	/* FIXME: we should also remove it for xlp8xx a2, but we do not have interface function
-- 
1.7.2.1

