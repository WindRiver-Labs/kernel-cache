From 0fba07058499ac934140feb434532bbfb5b50a88 Mon Sep 17 00:00:00 2001
From: Zi Shen Lim <zlim@netlogicmicro.com>
Date: Thu, 29 Sep 2011 16:22:54 -0700
Subject: [PATCH 402/762] Resolve merge conflict: merge

Based on Broadcom SDK 2.3.

Signed-off-by: Zi Shen Lim <zlim@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 mm/memory.c |   51 +++++++++++++++++++++++++++++++++++++++++++++++++++
 1 files changed, 51 insertions(+), 0 deletions(-)

diff --git a/mm/memory.c b/mm/memory.c
index 3b15794..0c4347e 100644
--- a/mm/memory.c
+++ b/mm/memory.c
@@ -4044,6 +4044,57 @@ void might_fault(void)
 EXPORT_SYMBOL(might_fault);
 #endif
 
+#ifdef CONFIG_NLMCOMMON_VM_DEBUG
+void dump_pgtable(struct mm_struct *mm)
+{
+  pgd_t *pgd = 0;
+  pte_t *ptep=0;
+  int i=0, j=0;
+  int pgd_counter = 0;
+
+  if (!mm) {
+    printk("[%s]: mm == NULL (Kernel Thread?)\n", __FUNCTION__);
+    return;
+  }
+  pgd = mm->pgd;
+  printk("dumping page table: mm=%lx, pgd=%lx\n", 
+	 (unsigned long)mm, (unsigned long)mm->pgd);   
+  for(i=0;i<PTRS_PER_PGD;i++) 
+    {    
+      pgd = mm->pgd + i;      
+      if (pgd_none(*pgd) || pgd_val(*pgd)==(unsigned long)invalid_pte_table) {
+	pgd_counter++;
+	continue;	
+      }
+
+      printk("pgd[%d]= %lx: \n", i, pgd_val(*pgd));
+      for(j=0;j<PTRS_PER_PTE;j++) 
+        {
+	  ptep = (pte_t *)page_address(pmd_page(*(pmd_t*)(pgd))) + j;
+
+          if (pte_none(*ptep) || 
+	      pte_val(*ptep)==(unsigned long)invalid_pte_table) {	    
+	    continue;
+	  }
+          printk("\t\tpte[%d] = %lx, vpage=%lx\n", j, pte_val(*ptep), 
+		 (((unsigned long)i<<PGDIR_SHIFT)
+		  |((unsigned long)j<<PAGE_SHIFT))
+		 );
+        }
+    }
+  printk("[%s]: pgd_counter = %d\n", __FUNCTION__, pgd_counter);
+}
+
+void dump_current_pgtable(void)
+{
+  printk("[%s]: current = %lx, current->mm=%lx, current->active_mm=%lx\n", 
+	 __FUNCTION__,
+	 (unsigned long)current, (unsigned long)current->mm,
+	 (unsigned long)current->active_mm);
+  dump_pgtable(current->mm);
+}
+#endif /* CONFIG_NLMCOMMON_VM_DEBUG */
+
 #if defined(CONFIG_TRANSPARENT_HUGEPAGE) || defined(CONFIG_HUGETLBFS)
 static void clear_gigantic_page(struct page *page,
 				unsigned long addr,
-- 
1.7.0.4

