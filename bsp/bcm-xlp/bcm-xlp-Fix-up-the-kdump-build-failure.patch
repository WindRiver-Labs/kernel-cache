From 90ce5277a66f60ad0caa21d8773d6eb1d2f1d891 Mon Sep 17 00:00:00 2001
From: GuoJian Zhou <GuoJian.Zhou@windriver.com>
Date: Mon, 10 Jun 2013 16:43:54 +0800
Subject: [PATCH 11/11] bcm-xlp: Fix up the kdump build failure.

1. The "elfcorehdr_addr" redefined, which was defined in the
   kernel/crash_dump.c at first.
2. Remove obsolete parameter for kmap_atomic_pfn() and kunmap_atomic().

Signed-off-by: GuoJian Zhou <GuoJian.Zhou@windriver.com>
---
 arch/mips/kernel/crash_dump.c |   17 +++--------------
 1 file changed, 3 insertions(+), 14 deletions(-)

diff --git a/arch/mips/kernel/crash_dump.c b/arch/mips/kernel/crash_dump.c
index 35c3a3d..17935ac 100644
--- a/arch/mips/kernel/crash_dump.c
+++ b/arch/mips/kernel/crash_dump.c
@@ -12,17 +12,6 @@
 #include <linux/crash_dump.h>
 #include <linux/uaccess.h>
 
-#ifdef CONFIG_PROC_VMCORE
-unsigned long long elfcorehdr_addr = ELFCORE_ADDR_MAX;
-static int __init parse_elfcorehdr(char *p) {
-	if (p)
-		elfcorehdr_addr = memparse(p, &p);
-	return 1;
-}
-
-__setup("elfcorehdr=", parse_elfcorehdr);
-#endif
-
 static int __init parse_savemaxmem(char *p) {
 	if (p)
 		saved_max_pfn = (memparse(p, &p) >> PAGE_SHIFT) - 1;
@@ -72,11 +61,11 @@ ssize_t copy_oldmem_page(unsigned long pfn, char *buf,
 
 	/* see if the PFN is valid and present */
 	if (_machine_check_pfn_validity(pfn)) {
-		vaddr = kmap_atomic_pfn(pfn, KM_PTE0);
+		vaddr = kmap_atomic_pfn(pfn);
 
 		if (!userbuf) {
 			memcpy(buf, (vaddr + offset), csize);
-			kunmap_atomic(vaddr, KM_PTE0);
+			kunmap_atomic(vaddr);
 		} else {
 			if (!kdump_buf_page) {
 				printk(KERN_WARNING "Kdump: Kdump buffer " \
@@ -84,7 +73,7 @@ ssize_t copy_oldmem_page(unsigned long pfn, char *buf,
 				return -EFAULT;
 			}
 			copy_page(kdump_buf_page, vaddr);
-			kunmap_atomic(vaddr, KM_PTE0);
+			kunmap_atomic(vaddr);
 			if (copy_to_user(buf,
 				(kdump_buf_page + offset), csize))
 				return -EFAULT;
-- 
1.7.10.4

