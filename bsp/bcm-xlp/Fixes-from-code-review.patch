From eb6e6069908676b40e40125d3381c3e0b23d1b2a Mon Sep 17 00:00:00 2001
From: "P. Sadik" <psadik@netlogicmicro.com>
Date: Wed, 1 Jun 2011 13:05:43 +0530
Subject: [PATCH 285/761] Fixes from code review

Based on Broadcom SDK 2.3.

Signed-off-by: P. Sadik <psadik@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/dma/nlm_adma.c |   17 +++++++++--------
 1 file changed, 9 insertions(+), 8 deletions(-)

diff --git a/drivers/dma/nlm_adma.c b/drivers/dma/nlm_adma.c
index ab4a1bd..bcf7179 100644
--- a/drivers/dma/nlm_adma.c
+++ b/drivers/dma/nlm_adma.c
@@ -114,10 +114,8 @@ static void nlm_dtre_msgring_handler(uint32_t vc, uint32_t src_id,
 
 	struct nlm_tx_desc *desc;
 	struct nlm_adma_chan *nlm_chan ;
+	uint64_t addr = (unsigned long) (msg1<<1);
 
-	uint64_t addr = msg1;
-	// addr |= (1ULL << 63);
-	addr |= NLH_XKSEG;
 
 	desc = (struct nlm_tx_desc *)addr;
 
@@ -152,6 +150,7 @@ static void nlm_dtre_msgring_handler(uint32_t vc, uint32_t src_id,
 	nlm_chan = (struct nlm_adma_chan *)(desc->chan);
 
 	desc->done_flag = 1;
+	wmb();
 
 	tasklet_schedule(&nlm_chan->irq_tasklet);
 }               
@@ -282,7 +281,7 @@ static dma_cookie_t nlm_tx_submit (struct dma_async_tx_descriptor *tx)
 
 	raid_list_msg [0] = gen_dtr_raid_msg_format_0((nlm_tx->entries_count), nlm_tx->hw_desc.entries);
 	raid_list_msg [1] = gen_dtr_raid_msg_format_1(raid_type, operation, disks, freeback_msg_dest_id);
-	raid_list_msg [2] = gen_dtr_raid_msg_format_2(nlm_tx);
+	raid_list_msg [2] = gen_dtr_raid_msg_format_2((void *)((unsigned long)nlm_tx>>1));
 
 	for (i=0; i<16; i++)
 	{
@@ -392,7 +391,7 @@ static void __process_completed_tx(struct nlm_adma_chan * chan)
 {
 	struct nlm_tx_desc *ptr;
 	dma_cookie_t cookie = 0;
-	int i, loop;
+	int i;
 
 	if (chan->process_idx == chan->pending_idx)
 	{
@@ -409,7 +408,6 @@ static void __process_completed_tx(struct nlm_adma_chan * chan)
 		return;
 	}
 
-	loop = 0;
 	while (1)
 	{
 		ptr = chan->tx_queue[chan->process_idx];
@@ -421,6 +419,7 @@ static void __process_completed_tx(struct nlm_adma_chan * chan)
 			cookie = ptr->async_tx.cookie;
 			ptr->async_tx.cookie = 0;
 			ptr->done_flag = 2;
+			wmb();
 
 			if (ptr->async_tx.callback)
 			{
@@ -443,6 +442,7 @@ static void __process_completed_tx(struct nlm_adma_chan * chan)
 			if (nlm_dtre_debug)
 				printk("pro_idx: %d.\n", chan->process_idx);
 			ptr->done_flag = 0;
+			wmb();
 			chan->tx_queue[chan->process_idx] = NULL;
 			chan->process_idx = (chan->process_idx + 1) & DTRE_MAX_TX_Q_MASK;
 			free_tx_desc(ptr);
@@ -461,9 +461,10 @@ static void __process_completed_tx(struct nlm_adma_chan * chan)
 		}
 
 		/* exit clause */
-		if (loop++ > 1000)
+		if ((chan->process_idx<chan->pending_idx) &&
+				(ptr != NULL) &&
+				(ptr->done_flag == 0))
 		{
-			loop = 0;
 			tasklet_schedule(&chan->irq_tasklet);
 			break;
 		}
-- 
1.7.10.4

