From f54681429ba4942aa545da56b46980bbe6c21cf8 Mon Sep 17 00:00:00 2001
From: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Date: Wed, 6 Oct 2010 22:50:38 -0700
Subject: [PATCH 199/761] Handle messages from 4K outqs

Based on Broadcom SDK 2.3.

Signed-off-by: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/on_chip.c |   20 +++++++++-----------
 1 file changed, 9 insertions(+), 11 deletions(-)

diff --git a/arch/mips/netlogic/xlp/on_chip.c b/arch/mips/netlogic/xlp/on_chip.c
index ec73064..5f7cb0d 100644
--- a/arch/mips/netlogic/xlp/on_chip.c
+++ b/arch/mips/netlogic/xlp/on_chip.c
@@ -41,7 +41,7 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #include <asm/netlogic/hal/nlm_hal_fmn.h>
 #include <asm/netlogic/hal/nlm_hal_pic.h>
 
-#define MAX_VC	1024	
+#define MAX_VC	4096
 
 unsigned long netlogic_io_base = (unsigned long)(DEFAULT_NETLOGIC_IO_BASE);
 EXPORT_SYMBOL(netlogic_io_base);
@@ -130,7 +130,7 @@ static uint16_t vc_to_handle_map[MAX_VC] = {
 	[1016] 	      = XLP_MSG_HANDLE_NAE_0,
 	[1017] 	      = XLP_MSG_HANDLE_NAE_0,
 	[1018 ... 1019] = XLP_MSG_HANDLE_NAE_0,
-	[1020 ... 1023] = XLP_MSG_HANDLE_INVALID
+	[1020 ... 4095] = XLP_MSG_HANDLE_INVALID
 };
 
 /******************************************************************************************
@@ -214,14 +214,13 @@ void nlm_xlp_msgring_int_handler(unsigned int irq, struct pt_regs *regs)
 			status = xlp_message_receive( vc, &src_id, &size, &code, &msg0, &msg1, &msg2, &msg3);
 			if(status != 0)
 				continue;
-			if(src_id >= 0 && src_id < MAX_VC)
-			{
-				handler = &msg_handler_map[vc_to_handle_map[src_id]];
-
-				/* Execute device driver fmn handler */
-				(handler->action)(vc, src_id, size, code,
-						  msg0, msg1, msg2, msg3, handler->dev_id);
-			}
+
+			handler = &msg_handler_map[vc_to_handle_map[src_id]];
+
+			/* Execute device driver fmn handler */
+			(handler->action)(vc, src_id, size, code,
+					  msg0, msg1, msg2, msg3, handler->dev_id);
+
 		}
 
 		/* Simulator currently doesn't simulate vc_empty_status1 bits! */
@@ -291,7 +290,6 @@ void enable_msgconfig_int(void)
 	msgrng_access_enable(flags);
 	nlm_hal_set_fmn_interrupt(IRQ_MSGRING);
 	msgrng_access_disable(flags);
-	printk("[%s]: Enabled FMN interrupts on cpu@%d\n", __func__, hard_smp_processor_id());
 }
 
 
-- 
1.7.10.4

