From 26a69ce39b5f4104870d2de990fde1c7df099bc2 Mon Sep 17 00:00:00 2001
From: Sreenidhi BR <sreenidhibr@netlogicmicro.com>
Date: Tue, 17 Jan 2012 14:59:42 +0530
Subject: [PATCH 521/762] OProfile interrupts conflict with msgring interrupts. Fixed. Remove the conflict by: - using IP6 for oprofile - using IP5 for msgring do some cleanup in xlp oprofile code also.

Based on Broadcom SDK 2.3.

Signed-off-by: Sreenidhi BR <sreenidhibr@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/netlogic/xlp_irq.h |   15 ++++++++-------
 arch/mips/netlogic/xlp/smp.c             |    2 --
 arch/mips/oprofile/op_model_mips_xlp.c   |    8 --------
 3 files changed, 8 insertions(+), 17 deletions(-)

diff --git a/arch/mips/include/asm/netlogic/xlp_irq.h b/arch/mips/include/asm/netlogic/xlp_irq.h
index 1a299d6..1a17003 100644
--- a/arch/mips/include/asm/netlogic/xlp_irq.h
+++ b/arch/mips/include/asm/netlogic/xlp_irq.h
@@ -1,6 +1,3 @@
-#ifndef CONFIG_NLM_XLP /* temporary tripwire */
-#error "Should only be used by XLP"
-#endif
 /***********************************************************************
 Copyright 2003-2010 Netlogic Microsystems (“Netlogic”). All rights
 reserved.
@@ -48,8 +45,9 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #define XLP_IRQ_DUMMY_UART           2
 #define XLP_IRQ_IPI_SMP_FUNCTION     3
 #define XLP_IRQ_IPI_SMP_RESCHEDULE   4
-#define XLP_IRQ_REMOTE_DEBUG         5
-#define XLP_IRQ_MSGRING              6
+// #define XLP_IRQ_REMOTE_DEBUG         5
+#define XLP_IRQ_MSGRING              5
+#define XLP_IRQ_OPROFILE             6
 #define XLP_IRQ_TIMER                7
 #define XLP_IRQ_RESERVED_MAX		8
 #define XLP_PIC_IRQ_BASE		XLP_IRQ_RESERVED_MAX
@@ -58,7 +56,11 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #define xlp_pic_irq_to_irt(irq) ((irq) - XLP_PIC_IRQ_BASE)
 
 #define XLP_IRQ_IPI_SMP_KGDB	     50
-#define XLP_IRQ_IPI_OPROFILE         51
+
+#ifdef CONFIG_NLMCOMMON_IP_FLOW_AFFINITY
+#define XLP_IRQ_IPI_NETRX		49
+#define SMP_NETRX_IPI			32
+#endif /* CONFIG_NLMCOMMON_IP_FLOW_AFFINITY */
 
 /* if you want some common #defines, please do it here */
 #define NLM_IRQ_DUMMY_UART		XLP_IRQ_DUMMY_UART
@@ -68,7 +70,6 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #define NLM_IRQ_MSGRING			XLP_IRQ_MSGRING
 #define NLM_IRQ_TIMER			XLP_IRQ_TIMER
 #define NLM_IRQ_IPI_SMP_KGDB		XLP_IRQ_IPI_SMP_KGDB
-#define NLM_IRQ_IPI_OPROFILE		XLP_IRQ_IPI_OPROFILE
 
 /* These are flags required for SMP
  * Not XLP specifc -- possibly mips specific.
diff --git a/arch/mips/netlogic/xlp/smp.c b/arch/mips/netlogic/xlp/smp.c
index 4422e43..146046b 100644
--- a/arch/mips/netlogic/xlp/smp.c
+++ b/arch/mips/netlogic/xlp/smp.c
@@ -86,8 +86,6 @@ void nlm_send_ipi_single(int lcpu, unsigned int action)
                 ipi |= XLP_IRQ_IPI_SMP_KGDB;
 		/* for KGDB enable NMI also */
 		nmi = 1;
-	} else if (action & SMP_OPROFILE_IPI) {
-                ipi |= XLP_IRQ_IPI_OPROFILE;
         } else
 		return;
 
diff --git a/arch/mips/oprofile/op_model_mips_xlp.c b/arch/mips/oprofile/op_model_mips_xlp.c
index 56facc9..b62eac9 100644
--- a/arch/mips/oprofile/op_model_mips_xlp.c
+++ b/arch/mips/oprofile/op_model_mips_xlp.c
@@ -147,19 +147,11 @@ void nlm_common_oprofile_int_handler(int irq, void * dev_id,
 {
 	uint64_t counter1, counter2;
 	uint64_t counter3, counter4;
-	uint32_t control1, control2;
-	uint32_t control3, control4;
 	int h_id = hard_smp_processor_id();/* 0, 1, 2, 3, 4, .....31 */
 
 	if(g_stop_pmc[h_id])
 		return;
 
-	control1 = __read_32bit_c0_register ($25, 0);
-	control2 = __read_32bit_c0_register ($25, 2);
-	control3 = __read_32bit_c0_register ($25, 4);
-	control4 = __read_32bit_c0_register ($25, 6);
-
-
 	counter1 = __read_64bit_c0_register ($25, 1);
 	counter2 = __read_64bit_c0_register ($25, 3);
 	counter3 = __read_64bit_c0_register ($25, 5);
-- 
1.7.0.4

