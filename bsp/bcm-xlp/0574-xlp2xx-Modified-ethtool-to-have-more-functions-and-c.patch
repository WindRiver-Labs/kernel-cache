From 3b7288b54cfd9e9d0b6a181c51e3cea236d567ee Mon Sep 17 00:00:00 2001
From: Alok Agrawat <alok@broadcom.com>
Date: Wed, 11 Jul 2012 18:25:04 +0530
Subject: [PATCH 574/762] xlp2xx: Modified ethtool to have more functions and commands for macsec support

Based on Broadcom SDK 2.3.

Signed-off-by: Alok Agrawat <alok@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 include/linux/ethtool.h |   28 +++++++++++++++++++
 net/core/ethtool.c      |   68 ++++++++++++++++++++++++++++++++++++++++++++++-
 2 files changed, 95 insertions(+), 1 deletions(-)

diff --git a/include/linux/ethtool.h b/include/linux/ethtool.h
index f5647b5..1f98cfe 100644
--- a/include/linux/ethtool.h
+++ b/include/linux/ethtool.h
@@ -48,6 +48,20 @@ struct ethtool_cmd {
 	__u8	eth_tp_mdix;
 	__u8	reserved2;
 	__u32	lp_advertising;	/* Features the link partner advertises */
+#ifdef CONFIG_NLM_XLP
+/* MAC SEC related params */
+	__u8   	node; 
+	__u8	port_enable;
+	__u8	index;
+	__u8	tci;
+	__u16	preamble_len;
+	__u32	packet_num;
+	__u32	win_size_thrshld;
+	__u64 	sci;
+	__u64	sci_mask;
+	unsigned char key[16];
+/* End MAC SEC */
+#endif
 	__u32	reserved[2];
 };
 
@@ -904,6 +918,12 @@ static inline u32 ethtool_rxfh_indir_default(u32 index, u32 n_rx_rings)
  * of the generic netdev features interface.
  */
 struct ethtool_ops {
+#ifdef CONFIG_NLM_XLP
+	int	(*msec_tx_config)(struct net_device *, struct ethtool_cmd *);
+	int	(*msec_tx_mem_config)(struct net_device *, struct ethtool_cmd *);
+	int	(*msec_rx_config)(struct net_device *, struct ethtool_cmd *);
+	int	(*msec_rx_mem_config)(struct net_device *, struct ethtool_cmd *);
+#endif
 	int	(*get_settings)(struct net_device *, struct ethtool_cmd *);
 	int	(*set_settings)(struct net_device *, struct ethtool_cmd *);
 	void	(*get_drvinfo)(struct net_device *, struct ethtool_drvinfo *);
@@ -1007,6 +1027,7 @@ struct ethtool_ops {
 #define ETHTOOL_SRXFH		0x0000002a /* Set RX flow hash configuration */
 #define ETHTOOL_GGRO		0x0000002b /* Get GRO enable (ethtool_value) */
 #define ETHTOOL_SGRO		0x0000002c /* Set GRO enable (ethtool_value) */
+
 #define ETHTOOL_GRXRINGS	0x0000002d /* Get RX rings available for LB */
 #define ETHTOOL_GRXCLSRLCNT	0x0000002e /* Get RX class rule count */
 #define ETHTOOL_GRXCLSRULE	0x0000002f /* Get RX classification rule */
@@ -1029,6 +1050,13 @@ struct ethtool_ops {
 #define ETHTOOL_GET_DUMP_FLAG	0x0000003f /* Get dump settings */
 #define ETHTOOL_GET_DUMP_DATA	0x00000040 /* Get dump data */
 
+#ifdef CONFIG_NLM_XLP
+#define	ETHTOOL_MAC_SEC_TX	0x00000044 /* MACSec TX config to device */
+#define	ETHTOOL_MAC_SEC_TX_MEM	0x00000045 /* MACSec TX mem config to device */
+#define	ETHTOOL_MAC_SEC_RX	0x00000046 /* MACSec RX config to device */
+#define	ETHTOOL_MAC_SEC_RX_MEM	0x00000047 /* MACSec RX mem config to device */
+#endif
+
 /* compatibility with older code */
 #define SPARC_ETH_GSET		ETHTOOL_GSET
 #define SPARC_ETH_SSET		ETHTOOL_SSET
diff --git a/net/core/ethtool.c b/net/core/ethtool.c
index 6d6d7d2..9006bc8 100644
--- a/net/core/ethtool.c
+++ b/net/core/ethtool.c
@@ -334,8 +334,60 @@ static int ethtool_set_settings(struct net_device *dev, void __user *useraddr)
 	return dev->ethtool_ops->set_settings(dev, &cmd);
 }
 
+#ifdef CONFIG_NLM_XLP
+static int ethtool_msec_tx_config(struct net_device *dev, void __user *useraddr)
+{
+	struct ethtool_cmd cmd;
+
+	if (!dev->ethtool_ops->set_settings)
+		return -EOPNOTSUPP;
+
+	if (copy_from_user(&cmd, useraddr, sizeof(cmd)))
+		return -EFAULT;
+
+	return dev->ethtool_ops->msec_tx_config(dev, &cmd);
+}
+
+static int ethtool_msec_tx_mem_config(struct net_device *dev, void __user *useraddr)
+{
+	struct ethtool_cmd cmd;
+
+	if (!dev->ethtool_ops->set_settings)
+		return -EOPNOTSUPP;
+
+	if (copy_from_user(&cmd, useraddr, sizeof(cmd)))
+		return -EFAULT;
+
+	return dev->ethtool_ops->msec_tx_mem_config(dev, &cmd);
+}
+static int ethtool_msec_rx_config(struct net_device *dev, void __user *useraddr)
+{
+	struct ethtool_cmd cmd;
+
+	if (!dev->ethtool_ops->set_settings)
+		return -EOPNOTSUPP;
+
+	if (copy_from_user(&cmd, useraddr, sizeof(cmd)))
+		return -EFAULT;
+
+	return dev->ethtool_ops->msec_rx_config(dev, &cmd);
+}
+static int ethtool_msec_rx_mem_config(struct net_device *dev, void __user *useraddr)
+{
+	struct ethtool_cmd cmd;
+
+	if (!dev->ethtool_ops->set_settings)
+		return -EOPNOTSUPP;
+
+	if (copy_from_user(&cmd, useraddr, sizeof(cmd)))
+		return -EFAULT;
+
+	return dev->ethtool_ops->msec_rx_mem_config(dev, &cmd);
+}
+#endif
+
 static noinline_for_stack int ethtool_get_drvinfo(struct net_device *dev,
-						  void __user *useraddr)
+                                                  void __user *useraddr)
 {
 	struct ethtool_drvinfo info;
 	const struct ethtool_ops *ops = dev->ethtool_ops;
@@ -1344,6 +1396,20 @@ int dev_ethtool(struct net *net, struct ifreq *ifr)
 	old_features = dev->features;
 
 	switch (ethcmd) {
+#ifdef CONFIG_NLM_XLP
+	case ETHTOOL_MAC_SEC_TX:
+		rc = ethtool_msec_tx_config(dev, useraddr);
+		break;
+	case ETHTOOL_MAC_SEC_TX_MEM:
+		rc = ethtool_msec_tx_mem_config(dev, useraddr);
+		break;
+	case ETHTOOL_MAC_SEC_RX:
+		rc = ethtool_msec_rx_config(dev, useraddr);
+		break;
+	case ETHTOOL_MAC_SEC_RX_MEM:
+		rc = ethtool_msec_rx_mem_config(dev, useraddr);
+		break;
+#endif
 	case ETHTOOL_GSET:
 		rc = ethtool_get_settings(dev, useraddr);
 		break;
-- 
1.7.0.4

