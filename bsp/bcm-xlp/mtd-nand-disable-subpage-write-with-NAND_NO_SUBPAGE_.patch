From fefb81a05c253ae22f54a3b76ce403b57edb599d Mon Sep 17 00:00:00 2001
From: "yanjun.zhu" <yanjun.zhu@windriver.com>
Date: Tue, 9 Sep 2014 17:54:16 +0800
Subject: [PATCH] mtd:nand:disable subpage write with NAND_NO_SUBPAGE_WRITE

PMECC controler conflicts with subpage write feature on bcm_xlp board.
Similar to the patch [mtd: atmel_nand: Disable subpage NAND write when
using Atmel PMECC], set NAND_NO_SUBPAGE_WRITE for PMECC controller in
order to disable sub page access in nand_write_page.

Signed-off-by: yanjun.zhu <yanjun.zhu@windriver.com>
---
 drivers/mtd/nand/spinand_lld.c |    4 ++++
 drivers/mtd/nand/xlp_nand.c    |    4 ++++
 2 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/drivers/mtd/nand/spinand_lld.c b/drivers/mtd/nand/spinand_lld.c
index 3ea0662..dfb828e 100644
--- a/drivers/mtd/nand/spinand_lld.c
+++ b/drivers/mtd/nand/spinand_lld.c
@@ -890,6 +890,10 @@ static int spinand_probe(struct spi_device *spi_nand)
 	chip->options	|= NAND_CACHEPRG;
 	chip->select_chip = spinand_select_chip;
 
+	if (chip->ecc.mode == NAND_ECC_HW){
+		chip->options |= NAND_NO_SUBPAGE_WRITE; 
+	}
+
 	mtd = devm_kzalloc(&spi_nand->dev, sizeof(struct mtd_info), GFP_KERNEL);
 	if (!mtd)
 		return -ENOMEM;
diff --git a/drivers/mtd/nand/xlp_nand.c b/drivers/mtd/nand/xlp_nand.c
index d9eb1db..511b57b 100644
--- a/drivers/mtd/nand/xlp_nand.c
+++ b/drivers/mtd/nand/xlp_nand.c
@@ -760,6 +760,10 @@ static int of_xlp_nand_devices(void __iomem *io_base,
 	data->chip.ecc.mode = ecc_mode < 0 ? NAND_ECC_SOFT : ecc_mode;
 	data->hwecc = ecc_mode == NAND_ECC_HW ? 1 : 0;
 
+	if (ecc_mode == NAND_ECC_HW){
+		data->chip.options |= NAND_NO_SUBPAGE_WRITE;
+	}
+
 	if (data->hwecc)
 		data->mtd.oobsize = XLP_HWECC_OOBSIZE;
 	else
-- 
1.7.5.4

