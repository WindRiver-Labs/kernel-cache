From f72e5277cc60fc986f14cf3d381a8cec5cfa5462 Mon Sep 17 00:00:00 2001
From: henry shao <hshao@netlogicmicro.com>
Date: Tue, 14 Jun 2011 17:35:58 -0700
Subject: [PATCH 291/762] NAND: Add support to systems that have memory large than 4G.

Based on Broadcom SDK 2.3.

Signed-off-by: henry shao <hshao@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/mtd/nand/xlp_plat_nand.c |    3 ++-
 drivers/mtd/nand/xlp_plat_nand.h |    2 ++
 2 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/mtd/nand/xlp_plat_nand.c b/drivers/mtd/nand/xlp_plat_nand.c
index e6c2b2f..b17ddb3 100644
--- a/drivers/mtd/nand/xlp_plat_nand.c
+++ b/drivers/mtd/nand/xlp_plat_nand.c
@@ -367,7 +367,7 @@ static void send_cmd(struct mtd_info *mtd,
 {
         struct nand_chip *chip = mtd->priv;
         struct nand_state *state = chip->priv;
-	uint32_t val;
+	uint64_t val;
 
         nand_reg_write(0, NAND_DATA_SIZE, len);
         nand_reg_write(0, NAND_DMA_CNT, len);
@@ -378,6 +378,7 @@ static void send_cmd(struct mtd_info *mtd,
         nand_reg_write(0, NAND_ADDR0_L, val) ;
 	val = virt_to_phys((void *) state->buf) + state->buf_ptr;
         nand_reg_write(0, NAND_DMA_ADDR, val);
+	nand_reg_write(0, NAND_DMA_ADDR_H, (val >> 32));
 
         if ( (command == NAND_READ_PAGE_CMD) ||
              (command == NAND_READ_ID_CMD)   ||
diff --git a/drivers/mtd/nand/xlp_plat_nand.h b/drivers/mtd/nand/xlp_plat_nand.h
index 0f392bd..1ad7ae2 100644
--- a/drivers/mtd/nand/xlp_plat_nand.h
+++ b/drivers/mtd/nand/xlp_plat_nand.h
@@ -47,6 +47,8 @@
 #define NAND_TIMINGS_ASYN	0x64
 #define NAND_TIMINGS_SYN	0x65
 #define NAND_FIFO_DATA		0x66
+#define NAND_TIME_MODE		0x67
+#define NAND_DMA_ADDR_H		0x68
 #define NAND_FIFO_INIT		0x6C
 #define NAND_GENERIC_SEQ	0x6D
 #define NAND_FIFO_STATE		0x6E
-- 
1.7.0.4

