From 4abf2a21d551f02fc7348ebd6d224d2171c5afbe Mon Sep 17 00:00:00 2001
From: Jayanthi A <jayanthi.annadurai@broadcom.com>
Date: Wed, 8 Aug 2012 14:51:05 +0530
Subject: [PATCH 561/761] XLP base port: Compile against hal:qaq/32

Based on Broadcom SDK 2.3.

Signed-off-by: Jayanthi A <jayanthi.annadurai@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/kernel/cpu-probe.c       |   42 ++++++------------------------------
 arch/mips/netlogic/msgcfg/Makefile |    2 +-
 arch/mips/netlogic/xlp/on_chip.c   |    2 ++
 arch/mips/netlogic/xlp/setup.c     |    2 +-
 4 files changed, 11 insertions(+), 37 deletions(-)

diff --git a/arch/mips/kernel/cpu-probe.c b/arch/mips/kernel/cpu-probe.c
index 02423ab..0149f2f 100644
--- a/arch/mips/kernel/cpu-probe.c
+++ b/arch/mips/kernel/cpu-probe.c
@@ -1109,44 +1109,16 @@ static inline void cpu_probe_netlogic(struct cpuinfo_mips *c, int cpu)
 		      MIPS_CPU_NLM_CACHE |
 		      MIPS_CPU_LLSC);
 
-	switch ((c->processor_id & 0xff00) >> 8) {
-	case CHIP_PROCESSOR_ID_XLP_8_4_XX:
-	case CHIP_PROCESSOR_ID_XLP_8XX:
-	case CHIP_PROCESSOR_ID_XLP_816:
-	case CHIP_PROCESSOR_ID_XLP_432:
-	case CHIP_PROCESSOR_ID_XLP_416:
-	case CHIP_PROCESSOR_ID_XLP_408:
-	case CHIP_PROCESSOR_ID_XLP_3XX:
-	case CHIP_PROCESSOR_ID_XLP_208:
-	case CHIP_PROCESSOR_ID_XLP_204:
-	case CHIP_PROCESSOR_ID_XLP_104:
-	case CHIP_PROCESSOR_ID_XLP_2XX:
-	{
-		c->cputype = CPU_XLP;
-
-		c->isa_level = MIPS_CPU_ISA_M64R2;
-		c->options |= (MIPS_CPU_FPU | MIPS_CPU_ULRI | MIPS_CPU_MCHECK);
-
-		c->tlbsize = ((read_c0_config6() >> 16 ) & 0xffff) + 1;
-		__cpu_name[cpu] = (const char *)get_cpu_info();
-
-		printk("Enabling XLP CPU (%s): pr id 0x%x  smp id %d\n",
-		       cpu_name_string(), c->processor_id, cpu);
-	}
-	break;
-	default:
-		c->isa_level = MIPS_CPU_ISA_M64R2;
-		c->options |= (MIPS_CPU_FPU | MIPS_CPU_ULRI | MIPS_CPU_MCHECK);
+	c->cputype = CPU_XLP;
 
-		c->tlbsize = ((read_c0_config6() >> 16) & 0xffff) + 1;
+	c->isa_level = MIPS_CPU_ISA_M64R2;
+	c->options |= (MIPS_CPU_FPU | MIPS_CPU_ULRI | MIPS_CPU_MCHECK);
 
-		c->cputype = CPU_XLP;
-		__cpu_name[cpu] = "Netlogic XLP";
-		printk(KERN_INFO "Unknown Netlogic chip id [%02x]!\n",
-		       c->processor_id);
-		break;
+	c->tlbsize = ((read_c0_config6() >> 16) & 0xffff) + 1;
+	__cpu_name[cpu] = (const char *)get_cpu_info();
 
-	}
+	printk("Enabling XLP CPU (%s): pr id 0x%x  smp id %d\n",
+	       cpu_name_string(), c->processor_id, cpu);
 }
 #endif /* CONFIG_NLM_XLP */
 
diff --git a/arch/mips/netlogic/msgcfg/Makefile b/arch/mips/netlogic/msgcfg/Makefile
index 645dde7..2231346 100644
--- a/arch/mips/netlogic/msgcfg/Makefile
+++ b/arch/mips/netlogic/msgcfg/Makefile
@@ -17,7 +17,7 @@ ifneq ("$(HAL_DIR)", "")
 	$(Q)cp -fr $(HAL_DIR)/nlm_evp_cpld.c  ../common
 	$(Q)cp -fr $(HAL_DIR)/cortina_cs34x7  ../common
 	$(Q)cp -fr $(HAL_DIR)/nlm_hal_nae.c  ../common
-
+	$(Q)cp -fr $(HAL_DIR)/nlm_hal_vsemi_config.c ../common
 	$(Q)cp -fr $(HAL_DIR)/nlm_hal_cpu_info.c  ../common
 	$(Q)cp -fr $(FDT_DIR)/libfdt/contrib/fdt_helper.c  ../common
 	/bin/rm -rf $(LOCAL_HAL_DIR)/nlm_hal_pic.h
diff --git a/arch/mips/netlogic/xlp/on_chip.c b/arch/mips/netlogic/xlp/on_chip.c
index 900163a..06662af 100644
--- a/arch/mips/netlogic/xlp/on_chip.c
+++ b/arch/mips/netlogic/xlp/on_chip.c
@@ -830,6 +830,8 @@ void on_chip_init(void)
 			atomic_set(&nlm_common_counters[i][j], 0);
 
 #ifdef CONFIG_XLP_FMN_SUPPORT
+	enable_msgconfig_int();
+
 	if (is_nlm_xlp2xx())
 		vc_to_handle = xlp2xx_vc_to_handle_map;
 	else if (is_nlm_xlp3xx())
diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index 002dbf1..89142b9 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -705,7 +705,7 @@ char* get_cpu_info(void)
 	if (!nlm_hal_get_cpuinfo(&cpu_info)){
 		strcpy(cpu_model_info, cpu_info.cpu_info_str);
 	}else{
-		strcpy(cpu_model_info, "Unknown CPU");
+		strcpy(cpu_model_info, "Unknown CPU ID");
 	}
 	return cpu_model_info;
 }
-- 
1.7.10.4

