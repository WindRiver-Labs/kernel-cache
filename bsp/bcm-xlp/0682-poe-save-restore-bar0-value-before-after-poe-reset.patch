From 5817418e05ef9fe0257d6e9d2ba2b2be5b6e2916 Mon Sep 17 00:00:00 2001
From: Prasanna Mumbai <prasanna.mumbai@broadcom.com>
Date: Fri, 18 Jan 2013 11:28:58 +0530
Subject: [PATCH 682/762] poe: save/restore bar0 value before/after poe reset

Based on Broadcom SDK 2.3.

Signed-off-by: Sreenidhi B R <sreenira@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/common/nlm_hal_nae.c |   41 +++++++++++++++++-------------
 1 files changed, 23 insertions(+), 18 deletions(-)

diff --git a/arch/mips/netlogic/common/nlm_hal_nae.c b/arch/mips/netlogic/common/nlm_hal_nae.c
index 64ac3c2..b9de738 100644
--- a/arch/mips/netlogic/common/nlm_hal_nae.c
+++ b/arch/mips/netlogic/common/nlm_hal_nae.c
@@ -3013,6 +3013,24 @@ static void reset_nae(int node)
 	nae_reset_done[node] = 1;
 }
 
+#if defined(__MIPSEL__)
+static uint32_t membar_fixup(uint32_t l)
+{
+	unsigned char b;
+	uint32_t fixup;
+
+	if (!is_nlm_xlp8xx_ax())
+		return l;
+
+	b = (l >> 24) & 0xff;
+	fixup = ((b << 24) | (b << 16) | (b << 8) | (b));
+
+	return fixup;
+}
+#else
+#define membar_fixup(x) (x)
+#endif
+
 #if !defined(NLM_HAL_UBOOT)
 /**
  * @brief reset_poe function resets the POE.
@@ -3028,6 +3046,10 @@ static void reset_nae(int node)
 static void reset_poe(int node)
 {
 	int reset_bit = 10;
+	uint32_t bar0;
+
+	bar0 = nlm_hal_read_32bit_reg(nlm_hal_get_dev_base(node, 0, XLP_POE_DEVICE, XLP_POE_FUNC), 0x4);
+	bar0 = membar_fixup(bar0);
 
 	if (is_nlm_xlp3xx() || is_nlm_xlp2xx())
 		reset_bit = 7;
@@ -3042,28 +3064,11 @@ static void reset_poe(int node)
 	nlm_hal_write_sys_reg(node, SYS_RESET, (0 << reset_bit));
 	nlm_mdelay(1);
 
+	nlm_hal_write_32bit_reg(nlm_hal_get_dev_base(node, 0, XLP_POE_DEVICE, XLP_POE_FUNC), 0x4, bar0);
 	return;
 }
 #endif
 
-#if defined(__MIPSEL__)
-static uint32_t membar_fixup(uint32_t l)
-{
-	unsigned char b;
-	uint32_t fixup;
-
-	if (!is_nlm_xlp8xx_ax())
-		return l;
-
-	b = (l >> 24) & 0xff;
-	fixup = ((b << 24) | (b << 16) | (b << 8) | (b));
-
-	return fixup;
-}
-#else
-#define membar_fixup(x) (x)
-#endif
-
 
 /**
 * @brief reset_nae_mgmt function deain the frin fifo followed by the reset_nae .
-- 
1.7.0.4

