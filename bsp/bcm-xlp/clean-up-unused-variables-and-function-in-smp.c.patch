From 6f641d7f3c49498ac73d774bc37bcbca9445a2d3 Mon Sep 17 00:00:00 2001
From: henry shao <hshao@netlogicmicro.com>
Date: Tue, 31 Aug 2010 03:41:40 -0700
Subject: [PATCH 165/761] clean up unused variables and function in smp.c

Based on Broadcom SDK 2.3.

Signed-off-by: henry shao <hshao@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/smp.c |   85 ++++++++++--------------------------------
 1 file changed, 20 insertions(+), 65 deletions(-)

diff --git a/arch/mips/netlogic/xlp/smp.c b/arch/mips/netlogic/xlp/smp.c
index e99ab9f..bc3e651 100644
--- a/arch/mips/netlogic/xlp/smp.c
+++ b/arch/mips/netlogic/xlp/smp.c
@@ -47,25 +47,19 @@ THE POSSIBILITY OF SUCH DAMAGE.
 
 
 unsigned int fast_syscall_cpumask_phy = 0x1;
-extern void smp_tune_scheduling (void);
-extern void ptr_smp_boot(unsigned long, unsigned long, unsigned long);
 struct smp_boot_info smp_boot;
 struct node_mask smp_node;
+cpumask_t phys_cpu_present_map;
+
+extern void ptr_smp_boot(unsigned long, unsigned long, unsigned long);
 extern void prom_reconfigure_thr_resources(void);
 extern unsigned long nlm_common_ebase;
 extern void enable_cpus(unsigned int node, unsigned online_mask);
-extern void enable_cores(unsigned int node, unsigned int cbitmap, unsigned int thread_num);
-
-int phys_proc_id[NR_CPUS]; /* cpuid+thrid of each logical CPU */
-cpumask_t phys_cpu_present_map;
+extern void nlm_smp_irq_init(void);
 extern void asmlinkage smp_bootstrap(void);
-/*extern void core_send_ipi(int cpu, unsigned int action);*/
-
-extern void enable_cpus( unsigned int node, unsigned int onlinemask );
 
 void nlm_send_ipi_single(int cpu, unsigned int action)
 {
-printk("[%s] cpu: %d\n",__func__,  cpu);
         __u32 node = cpu / 32;
         __u32 ipi = 0;
 	cpu = cpu % 32;
@@ -89,14 +83,12 @@ void nlm_send_ipi_mask(const struct cpumask * mask, unsigned int action)
     int cpu;
     for_each_cpu(cpu, mask){
 	 nlm_send_ipi_single(cpu, action);
-/*        core_send_ipi(cpu, action);*/
     }
 }
 
 /*
  * Code to run on secondary just after probing the CPU
  */
-extern void nlm_smp_irq_init(void);
 static void __cpuinit nlm_init_secondary(void)
 {
     /* Time init for this cpu is done in mips_clockevent_init() */
@@ -105,9 +97,6 @@ static void __cpuinit nlm_init_secondary(void)
 
 void nlm_smp_finish(void)
 {
-#if !defined(CONFIG_NLM_XLP)
-    nlm_common_msgring_cpu_init();
-#endif
 }
 
 void nlm_cpus_done(void)
@@ -120,8 +109,6 @@ void nlm_boot_secondary(int cpu, struct task_struct *idle)
 {
 	unsigned long gp = (unsigned long)task_thread_info(idle);
 	unsigned long sp = (unsigned long)__KSTK_TOS(idle);
-//	int cpu = cpu_logical_map(logical_cpu);
-//printk("[%s] logical_cpu: %x  cpu: %x\n",__func__, logical_cpu, cpu);
 
 	smp_boot.boot_info[cpu].sp = sp;
 	smp_boot.boot_info[cpu].gp = gp;
@@ -144,20 +131,10 @@ void __init nlm_smp_setup(void)
 	boot_cpu = hard_smp_processor_id();
 
 	cpus_clear(phys_cpu_present_map);
-	/*	cpu_set(0, phys_cpu_present_map);
-	__cpu_number_map[0] = 0;
-	__cpu_logical_map[0] = 0;  
-	dev_tree_en fix , and also not required for the existing case also */
-
-	/* cpu_set(0, cpu_possible_map); */
-
-	/* Initialize the ipi debug stat variables */
 
 	boot_cpu_online_map = smp_node.onlinemask[0];
 	smp_boot.online_map = smp_node.onlinemask[0];
 
-	/* 0th entry in the logical_map should be the bootcpu and all
-       others proceeds after that */
 	/* Fill the entries for boot cpu */
 	boot_cpu_online_map &= (~(1 << boot_cpu));
 	cpu_set(boot_cpu, phys_cpu_present_map);
@@ -195,7 +172,6 @@ void __init nlm_smp_setup(void)
 	cpu_present_map		= cpu_possible_map;
 
 	fast_syscall_cpumask_phy = (unsigned int)phys_cpu_present_map.bits[0];
-printk("phys_cpu_present_map: %x  cpu_possible_map: %x cpu_present_map: %x\n", phys_cpu_present_map,  cpu_possible_map, cpu_present_map); 
 	printk("Phys CPU present map: %lx, possible map %lx\n", 
 	       (unsigned long)phys_cpu_present_map.bits[0], 
 	       (unsigned long)cpu_possible_map.bits[0]);
@@ -203,24 +179,34 @@ printk("phys_cpu_present_map: %x  cpu_possible_map: %x cpu_present_map: %x\n", p
 	printk("Detected %i Slave CPU(s)\n", num_cpus);
 }
 
-void nlm_prepare_cpus(unsigned int max_cpus)
+int wakeup_secondary_cpus(void)
 {
+	int i;
+	for(i = 0; i < 4; i++)
+	{
+		if(smp_node.onlinemask[i] == 0)
+			continue;
+		enable_cpus( i, smp_node.onlinemask[i]);
+		printk("enable node %d  smp_node.onlinemask[%d]): %x\n", i,i, smp_node.onlinemask[i]);
+	}
+	return 0;
 }
 
+void nlm_prepare_cpus(unsigned int max_cpus)
+{
+}
 
 struct plat_smp_ops nlm_smp_ops = {
     .send_ipi_single    = nlm_send_ipi_single,
     .send_ipi_mask      = nlm_send_ipi_mask,
     .init_secondary     = nlm_init_secondary,
-    .smp_finish     = nlm_smp_finish,
-    .cpus_done      = nlm_cpus_done,
+    .smp_finish     	= nlm_smp_finish,
+    .cpus_done      	= nlm_cpus_done,
     .boot_secondary     = nlm_boot_secondary,
-    .smp_setup      = nlm_smp_setup,
+    .smp_setup      	= nlm_smp_setup,
     .prepare_cpus       = nlm_prepare_cpus,
 };
 
-
-
 void prom_boot_cpus_secondary(void *args)
 {
 	int cpu = hard_smp_processor_id();
@@ -239,34 +225,3 @@ void prom_boot_cpus_secondary(void *args)
 	ptr_smp_boot(smp_boot.boot_info[cpu].fn, smp_boot.boot_info[cpu].sp, 
 		     smp_boot.boot_info[cpu].gp);
 }
-
-#ifdef CONFIG_NLM_XLP
-
-extern void prom_pre_boot_secondary_cpus(void *);
- 
-#ifdef CONFIG_MAPPED_KERNEL
-#define secondary_cpus_bootup_func \
-       ((unsigned long)prom_pre_boot_secondary_cpus - \
-        (unsigned long)LOADADDR + (unsigned long)PHYSADDR)
-#else
-#define secondary_cpus_bootup_func prom_pre_boot_secondary_cpus
-#endif
-
-int wakeup_secondary_cpus(void)
-{
-	int i;
-	smp_node.onlinemask[0] = 0x000000ff;
-	smp_node.onlinemask[1] = 0x000000ff;
-	smp_node.onlinemask[2] = 0x00000000;
-	smp_node.onlinemask[3] = 0x00000000;
-	for(i = 0; i < 4; i++)
-	{
-		if(smp_node.onlinemask[i] == 0)
-			continue;
-		enable_cpus( i, smp_node.onlinemask[i]);
-		printk("enable node %d  smp_node.onlinemask[%d]): %x\n", i,i, smp_node.onlinemask[i]);
-	}
-	return 0;
-}
-
-#endif /* #ifdef CONFIG_NLM_XLP */
-- 
1.7.10.4

