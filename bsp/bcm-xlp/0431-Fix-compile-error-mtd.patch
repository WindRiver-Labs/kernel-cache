From 22c99976ca8dbe578e9aa89115b9e12e06c66873 Mon Sep 17 00:00:00 2001
From: Zi Shen Lim <zlim@netlogicmicro.com>
Date: Mon, 3 Oct 2011 11:12:29 -0700
Subject: [PATCH 431/762] Fix compile error: mtd

mtd_device_{,un}register replaced {add,del}_mtd_partitions in mainline.
mtd_has_partitions check deprecated in mainline.

existing code always return 0 for xlp_nor_probe - revisit

Based on Broadcom SDK 2.3.

Signed-off-by: Zi Shen Lim <zlim@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/mtd/maps/xlp-flash.c |   34 +++++++++++++++-------------------
 1 files changed, 15 insertions(+), 19 deletions(-)

diff --git a/drivers/mtd/maps/xlp-flash.c b/drivers/mtd/maps/xlp-flash.c
index 4b3dbf0..bed4340 100644
--- a/drivers/mtd/maps/xlp-flash.c
+++ b/drivers/mtd/maps/xlp-flash.c
@@ -156,29 +156,25 @@ int __init xlp_nor_probe(struct platform_device *pdev)
 	info->mtd->owner	= THIS_MODULE;
 	info->mtd->dev.parent	= &pdev->dev;
 	
-	if (mtd_has_partitions()) {
-		if (mtd_has_cmdlinepart()) {
-                        static const char *part_probes[]
-                                        = { "cmdlinepart", NULL, };
-			nb_parts = parse_mtd_partitions(info->mtd, part_probes, &info->parts, 0);
-		}
-		if(nb_parts <= 0)
-		{
-			nb_parts = ARRAY_SIZE(xlp_nor_partitions);
-			if(!info->parts)
-				info->parts = xlp_nor_partitions;
-		}
-		if(nb_parts > 0)
-		{
-			err = add_mtd_partitions(info->mtd, info->parts, nb_parts);
-		}
+	if (mtd_has_cmdlinepart()) {
+		static const char *part_probes[] = { "cmdlinepart", NULL, };
+		nb_parts = parse_mtd_partitions(info->mtd, part_probes, &info->parts, 0);
+	}
+	if (nb_parts <= 0) {
+		nb_parts = ARRAY_SIZE(xlp_nor_partitions);
+		if (!info->parts)
+			info->parts = xlp_nor_partitions;
+	}
+	if (nb_parts > 0) {
+		err = mtd_device_register(info->mtd, info->parts, nb_parts);
 	}
 	else {
-		err = add_mtd_device(info->mtd);
+		err = mtd_device_register(info->mtd, NULL, 0);
 	}
 
 	platform_set_drvdata(pdev, info);
 
+	/* XLP_MERGE_TODO: always return 0? */
 	return 0;
 out_unmap:
 	iounmap(info->map.virt);
@@ -195,11 +191,11 @@ static int __exit xlp_nor_remove(struct platform_device *pdev)
 
 	if (info) {
 		if(info->parts) {
-			del_mtd_partitions(info->mtd);
+			mtd_device_unregister(info->mtd);
 			kfree(info->parts);
 		}
 		else
-			del_mtd_device(info->mtd);
+			mtd_device_unregister(info->mtd);
 		map_destroy(info->mtd);
 		iounmap(info->map.virt);
 		kfree(info);
-- 
1.7.0.4

