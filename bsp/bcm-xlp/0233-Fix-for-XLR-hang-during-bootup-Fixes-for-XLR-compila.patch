From cd9b801413d76bf74c451f85564f6cfd85c817b1 Mon Sep 17 00:00:00 2001
From: Krishnamurthy D V <kmurthy@netlogicmicro.com>
Date: Thu, 9 Dec 2010 18:12:05 +0530
Subject: [PATCH 233/762] Fix for XLR hang during bootup Fixes for XLR compilation Also added a fix for XLR memory param input through FDT file and increased the number of memory segments that can be passed in the FDT file.

Based on Broadcom SDK 2.3.

Signed-off-by: Krishnamurthy D V <kmurthy@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 .../asm/mach-netlogic/cpu-feature-overrides.h      |    2 ++
 arch/mips/include/asm/mach-netlogic/mmu.h          |    2 +-
 arch/mips/include/asm/pgtable-bits.h               |    2 +-
 arch/mips/netlogic/xlr/setup.c                     |    2 +-
 4 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/arch/mips/include/asm/mach-netlogic/cpu-feature-overrides.h b/arch/mips/include/asm/mach-netlogic/cpu-feature-overrides.h
index 01e9a84..8b0dccb 100644
--- a/arch/mips/include/asm/mach-netlogic/cpu-feature-overrides.h
+++ b/arch/mips/include/asm/mach-netlogic/cpu-feature-overrides.h
@@ -4,6 +4,8 @@
 
 #ifdef CONFIG_NLM_RIXI
 #define kernel_uses_smartmips_rixi (cpu_data[0].cputype == CPU_XLP)
+#else 
+#define kernel_uses_smartmips_rixi  0
 #endif
 
 #endif  /* __ASM_MACH_NLM_CPU_FEATURE_OVERRIDES_H */
diff --git a/arch/mips/include/asm/mach-netlogic/mmu.h b/arch/mips/include/asm/mach-netlogic/mmu.h
index 100df36..3478715 100644
--- a/arch/mips/include/asm/mach-netlogic/mmu.h
+++ b/arch/mips/include/asm/mach-netlogic/mmu.h
@@ -10,7 +10,7 @@
 #include <asm/mach-netlogic/xlp-mmu.h>
 #endif
 
-#define ENTRYLO_PFN_SHIFT 6
+#define ENTRYLO_PFN_SHIFT _PAGE_GLOBAL_SHIFT
 
 #ifndef __ASSEMBLY__
 
diff --git a/arch/mips/include/asm/pgtable-bits.h b/arch/mips/include/asm/pgtable-bits.h
index 08033cd..7e2325c 100644
--- a/arch/mips/include/asm/pgtable-bits.h
+++ b/arch/mips/include/asm/pgtable-bits.h
@@ -172,7 +172,7 @@ static inline uint64_t pte_to_entrylo(unsigned long pte_val)
 {
 	if (kernel_uses_smartmips_rixi) {
 #ifdef CONFIG_NLM_XLP
-       return (pte_val >> _PAGE_GLOBAL_SHIFT);
+		return (pte_val >> _PAGE_GLOBAL_SHIFT);
 #else
 		int sa;
 #ifdef CONFIG_32BIT
diff --git a/arch/mips/netlogic/xlr/setup.c b/arch/mips/netlogic/xlr/setup.c
index 4cfefa6..e50e3fa 100644
--- a/arch/mips/netlogic/xlr/setup.c
+++ b/arch/mips/netlogic/xlr/setup.c
@@ -1059,7 +1059,7 @@ static int xlr_fdt_process(void)
 {
 	int  domain=0;
 	char domstr[32] = "";
-	int  i,j, na, ns, regs[4], entries;
+	unsigned int  i,j, na, ns, regs[16], entries;
 	char macaddress[6];
 	uint32_t shmem_addr;
 
-- 
1.7.0.4

