From c09bb0f06289d319b62523a706c80d90087cfd48 Mon Sep 17 00:00:00 2001
From: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Date: Thu, 9 Dec 2010 19:44:54 -0800
Subject: [PATCH 230/762] Enable reading cpu_freq from a fast_syscall for XLP also

Based on Broadcom SDK 2.3.

Signed-off-by: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/netlogic/nlm_uaccess_fs.h |    2 +-
 arch/mips/kernel/syscall.c                      |    2 +-
 arch/mips/kernel/xlr_fast_sys_call_handler.S    |    8 ++++----
 3 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/arch/mips/include/asm/netlogic/nlm_uaccess_fs.h b/arch/mips/include/asm/netlogic/nlm_uaccess_fs.h
index a1df580..f64b5c1 100644
--- a/arch/mips/include/asm/netlogic/nlm_uaccess_fs.h
+++ b/arch/mips/include/asm/netlogic/nlm_uaccess_fs.h
@@ -57,8 +57,8 @@ extern void nlm_uaccess_fs_is_endian_reversed(void);
 extern void nlm_uaccess_fs_uspace_64bit_ins_enabled(void);
 #if defined(CONFIG_NLM_XLR)
 extern void xlr_fast_syscall_prominfo(void);
-extern void nlm_uaccess_fs_cpu_max_freq(void);
 #endif
+extern void nlm_uaccess_fs_cpu_max_freq(void);
 #endif
 
 #endif /* _ASM_NLM_XLR_UACCESS_H */
diff --git a/arch/mips/kernel/syscall.c b/arch/mips/kernel/syscall.c
index 0a43bc8..9dc022b 100644
--- a/arch/mips/kernel/syscall.c
+++ b/arch/mips/kernel/syscall.c
@@ -88,8 +88,8 @@ unsigned long xlr_fast_sys_call_table[] = {
 
 #if defined(CONFIG_NLM_XLR)
 	[NLM_UACCESS_FS_PROMINFO] = (unsigned long)xlr_fast_syscall_prominfo,
-	[NLM_UACCESS_FS_CPU_MAX_FREQ] = (unsigned long)nlm_uaccess_fs_cpu_max_freq,
 #endif
+	[NLM_UACCESS_FS_CPU_MAX_FREQ] = (unsigned long)nlm_uaccess_fs_cpu_max_freq,
 
 #if defined(CONFIG_NLM_XLP)
 	[NLM_UACCESS_FS_MEM_READ64] = (unsigned long)nlm_uaccess_fs_mem_read64,
diff --git a/arch/mips/kernel/xlr_fast_sys_call_handler.S b/arch/mips/kernel/xlr_fast_sys_call_handler.S
index 1c35471..ab88dc9 100644
--- a/arch/mips/kernel/xlr_fast_sys_call_handler.S
+++ b/arch/mips/kernel/xlr_fast_sys_call_handler.S
@@ -503,16 +503,16 @@ END(nlm_uaccess_fs_mem_write32)
 
 	fs_eret
 	END(nlm_uaccess_fs_uspace_64bit_ins_enabled)
-#if defined(CONFIG_NLM_XLR)
+
 	/* {hi=T1, lo=T0} nlm_uaccess_fs_cpu_max_freq(void) */
 	NESTED(nlm_uaccess_fs_cpu_max_freq, PT_SIZE, sp)
-	PTR_LA k0, prom_info_copy
-	ld     k1, PSB_CPU_FREQUENCY(k0)
+	PTR_LA k0, mips_hpt_frequency
+	lw     k1, 0(k0)
 	dsrl32 T1, k1, 0
 	dsll32 k1, k1, 0
 	dsrl32 T0, k1, 0
 
 	fs_eret
 	END(nlm_uaccess_fs_cpu_max_freq)
-#endif
+
 	.set pop
-- 
1.7.0.4

