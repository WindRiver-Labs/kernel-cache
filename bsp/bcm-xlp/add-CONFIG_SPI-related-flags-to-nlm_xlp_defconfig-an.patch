From 3f25416ccea275cc29c0750283de48f2a16a8d6e Mon Sep 17 00:00:00 2001
From: henry shao <hshao@netlogicmicro.com>
Date: Tue, 28 Dec 2010 12:42:03 -0800
Subject: [PATCH 257/761] add CONFIG_SPI related flags to nlm_xlp_defconfig
 and misc cleanup

Based on Broadcom SDK 2.3.

Signed-off-by: henry shao <hshao@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/spi/spi_xlp.c |    8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/drivers/spi/spi_xlp.c b/drivers/spi/spi_xlp.c
index 35a4230..ba73b82 100644
--- a/drivers/spi/spi_xlp.c
+++ b/drivers/spi/spi_xlp.c
@@ -50,6 +50,8 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #define OPCODE_SE			0xd8
 #define DEFAULT_CS_FDIV			0x10
 #define XLP_SPI_MAX_XFER_SIZE		0x2000
+#define XLP_SPI_FIFO_SIZE		8
+#define NOR_SPI_CMD_SIZE		5
 
 struct spi_xlp {
 	/* bitbang has to be first */
@@ -197,7 +199,7 @@ static void spi_xlp_fill_txfifo(struct spi_xlp *pspi, uint32_t* len, unsigned ch
         txfifo_cnt = spi_reg_read(0, pspi->cs, XLP_SPI_FIFO_WCNT);
 	txfifo_cnt >>= XLP_SPI_TXFIFO_WCNT_POS;
 
-        while ((*len) && (txfifo_cnt < 8))
+        while ((*len) && (txfifo_cnt < XLP_SPI_FIFO_SIZE))
         {
                 if (*len <= 1) {
                         tx_data = (*data)[0];
@@ -261,7 +263,7 @@ static int spi_xlp_xfer_block(struct spi_device *spi, struct spi_transfer *t, ui
         if (tx_len) {
                 spi_xlp_fill_txfifo(pspi, &tx_len, &pspi->ptxbuf);
 		t->len = tx_len;
-		if(xfer_len <= 5){
+		if(xfer_len <= NOR_SPI_CMD_SIZE){
 			val |= XLP_SPI_CMD_CONT;
 		}
 
@@ -276,7 +278,7 @@ static int spi_xlp_xfer_block(struct spi_device *spi, struct spi_transfer *t, ui
 	if(pspi->prxbuf != 0)
 		val |= XLP_SPI_CMD_RX;
         if(xfer_len)
-		val |= ((xfer_len* 8 -1) << XLP_SPI_XFR_BITCNT_POS);
+		val |= ((xfer_len * 8 -1) << XLP_SPI_XFR_BITCNT_POS);
 
 	spi_reg_write(0, pspi->cs, XLP_SPI_CMD, val);
 
-- 
1.7.10.4

