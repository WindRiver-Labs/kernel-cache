From 1ae47688560ad14174a2182133dc98be4f81c522 Mon Sep 17 00:00:00 2001
From: henry shao <hshao@netlogicmicro.com>
Date: Fri, 27 Aug 2010 15:18:07 -0700
Subject: [PATCH 152/761] make cpu_control_asm.S smpboot.S multinode aware
 based on latest XLP manual

Based on Broadcom SDK 2.3.

Signed-off-by: henry shao <hshao@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/cpu_control_asm.S |   26 ++++++++++----------------
 arch/mips/netlogic/xlp/smpboot.S         |    8 ++------
 2 files changed, 12 insertions(+), 22 deletions(-)

diff --git a/arch/mips/netlogic/xlp/cpu_control_asm.S b/arch/mips/netlogic/xlp/cpu_control_asm.S
index a466c50..0af94b3 100644
--- a/arch/mips/netlogic/xlp/cpu_control_asm.S
+++ b/arch/mips/netlogic/xlp/cpu_control_asm.S
@@ -47,12 +47,8 @@
 #else
 	prog_c0_status 0 ST0_BEV
 #endif
-	mfc0 		t0, $15, 1
-	mfc0	    	t2, $15, 1
-	andi		t2, 0x180
-	srl		t2, 2
+	mfc0 		t0, CP0_PRID, 1
 	andi 		t0, 0x7f
-	or		t0, t0, t2
 	PTR_LA		t1, xlp_stack_pages_temp
 	li   		t2, _THREAD_SIZE
 	srl  		t2, 2
@@ -83,17 +79,19 @@
 	 * (@0xbfc00000)
 	 */
 EXPORT(reset_entry)
-	mfc0    t0, $15, 1
-	mfc0	t2, $15, 1
-	andi	t2, 0x180
-	srl	t2,  2
+	mfc0    t0, CP0_PRID, 1
+	mfc0	t1, CP0_PRID, 1
+	andi	t1, 0x60
+	srl	t1,  5
+	li	t2, 0x40000  #load 0x40000
+	mul	t3, t2, t1  #t3 = node * 0x40000
 	srl     t0, t0 , 2
-	or	t0, t0, t2
-	and     t0, t0 , 0x7f # t0 contains the core number
+	and     t0, t0 , 0x7 # t0 contains the core number
 	li      t1, 0x1
 	sll     t0, t1, t0
 	nor     t0, t0, zero
 	dla     t2, CPU_MMIO_OFFSET(SYS)
+	add	t2, t2, t3  #get node based SYS offset
 	lw      t1, (SYS_CPUNONCOHERENTMODE_REG << 2)(t2)
 	and     t1, t1, t0
 	sw      t1, (SYS_CPUNONCOHERENTMODE_REG << 2)(t2)
@@ -148,12 +146,8 @@ EXPORT(__boot_siblings)
 	/* threads (incl. T0) of this core 
 	 * start fetching from this point
 	 */
-	mfc0    t0, $15, 1		/* EBASE, Select 1 	*/
-	mfc0	t2, $15, 1
-	andi	t2, 0x180
-	srl	t2,  2
+	mfc0    t0, CP0_PRID, 1		/* EBASE, Select 1 	*/
 	andi    t0, 0x7f		/* Linear CPU ID	*/
-	or	t0, t0, t2
 	beqz    t0, 2f
 	nop
 1:
diff --git a/arch/mips/netlogic/xlp/smpboot.S b/arch/mips/netlogic/xlp/smpboot.S
index 9045aa0..0c77c31 100644
--- a/arch/mips/netlogic/xlp/smpboot.S
+++ b/arch/mips/netlogic/xlp/smpboot.S
@@ -47,12 +47,8 @@ END(ptr_smp_boot)
 NESTED(prom_pre_boot_secondary_cpus, 16, sp)
 	SET_MIPS64
 	MAPPED_KERNEL_SETUP_TLB
-	mfc0 t0, $15, 1 #read ebase
-	mfc0 t2, $15, 1 #read ebase
-	andi t2, 0x180 # get node id
-	srl  t2, 2
-	andi t0, 0x1f #t0 has the processor_id()
-	or   t0, t0, t2 #now t0 has node_id + process_id
+	mfc0 t0, CP0_PRID, 1 #read ebase
+	andi t0, 0x7f #t0 has the processor_id()
 	PTR_LA	t1, xlp_stack_pages_temp
 	li   t2, _THREAD_SIZE
 	srl  t2, 2
-- 
1.7.10.4

