From 5372ace9ee1826ab26ff193de910b468c0466797 Mon Sep 17 00:00:00 2001
From: Hareesh R <hareeshr@broadcom.com>
Date: Thu, 7 Mar 2013 17:09:44 +0530
Subject: [PATCH 675/761] nae: Increased the number of descriptors for jumbo
 queue

Number of jumbo descriptors should be greater than Parser Sequencer
Threshold in RX FRIN LIFO .

Based on Broadcom SDK 2.3.

Signed-off-by: Hareesh R <hareeshr@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/nae/xlpge_nae.c |    2 +-
 drivers/net/nae/xlpge_rx.c  |    7 +++++++
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/drivers/net/nae/xlpge_nae.c b/drivers/net/nae/xlpge_nae.c
index 15a1f93..c6e023a 100644
--- a/drivers/net/nae/xlpge_nae.c
+++ b/drivers/net/nae/xlpge_nae.c
@@ -67,7 +67,7 @@ int num_descs_per_normalq = 64;
 module_param(num_descs_per_normalq, int, 0);
 /* Descriptors for each jumbo fifo. For xaui ports, if port fifo mode 
    is enabled, this will be multiplied by 4 (3 fifos are unused) */
-int num_descs_per_jumboq = 32;
+int num_descs_per_jumboq = 48;
 module_param(num_descs_per_jumboq, int, 0);
 
 static uint32_t lnx_normal_mask[NLM_MAX_NODES];
diff --git a/drivers/net/nae/xlpge_rx.c b/drivers/net/nae/xlpge_rx.c
index 0f7a632..352db3a 100644
--- a/drivers/net/nae/xlpge_rx.c
+++ b/drivers/net/nae/xlpge_rx.c
@@ -718,6 +718,13 @@ static inline void process_rx_packets(int cpu, unsigned int src_id,
 	last_rcvd_priv[CPU_INDEX(cpu)] = priv;
 #endif
 
+#ifndef CONFIG_NLM_NET_OPTS
+	/* Setting this with NET_OPTS enabled can cause replenishment 
+	*  wrong for jumbo packets, as the hw-replenishment logic is 
+	*  depended on the skb->truesize */
+	skb->truesize = skb->len + sizeof(struct sk_buff);
+#endif
+
 #ifdef CONFIG_INET_LRO
 	if ((skb->dev->features & NETIF_F_LRO) &&
 			(msg1 & RX_IP_CSUM_VALID) && (msg1 & RX_TCP_CSUM_VALID)) {
-- 
1.7.10.4

