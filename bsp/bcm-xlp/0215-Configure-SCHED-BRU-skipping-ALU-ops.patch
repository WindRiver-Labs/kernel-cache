From 5bb2689b44e35539e39d1aad970e32f76dd088e8 Mon Sep 17 00:00:00 2001
From: Siva Pochiraju <sivap@netlogicmicro.com>
Date: Tue, 26 Oct 2010 22:46:30 -0700
Subject: [PATCH 215/762] Configure SCHED (BRU skipping ALU ops)

Based on Broadcom SDK 2.3.

Signed-off-by: Siva Pochiraju <sivap@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/cpu_control.c        |    3 +++
 arch/mips/netlogic/xlp/cpu_control_asm.S    |    5 +++++
 arch/mips/netlogic/xlp/cpu_control_macros.h |    1 +
 3 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/arch/mips/netlogic/xlp/cpu_control.c b/arch/mips/netlogic/xlp/cpu_control.c
index c855a08..1fd9090 100644
--- a/arch/mips/netlogic/xlp/cpu_control.c
+++ b/arch/mips/netlogic/xlp/cpu_control.c
@@ -84,6 +84,9 @@ static inline void config_lsu(void)
 		"li	 %2, ~0xe\n"
 		"and	 %1, %1, %2\n"
 		"mtcr    %1, %0\n"
+		"li      %0, "STR(SCHED_DEFEATURE)"\n"
+		"lui     %1, 0x0100\n"
+		"mtcr    %1, %0\n"
 		".set pop\n"
 		: "=r" (tmp0), "=r" (tmp1), "=r" (tmp2)
 	);
diff --git a/arch/mips/netlogic/xlp/cpu_control_asm.S b/arch/mips/netlogic/xlp/cpu_control_asm.S
index 6385c8f..12fce72 100644
--- a/arch/mips/netlogic/xlp/cpu_control_asm.S
+++ b/arch/mips/netlogic/xlp/cpu_control_asm.S
@@ -74,6 +74,11 @@
 	and	t1, t1, t2
 
 	mtcr    t1, t0
+	
+	li      t0, LSU_DEFEATURE
+	lui     t1, 0x0100 # Experimental: Disable BRU accepting ALU ops
+	mtcr    t1, t0
+	
 	.set pop
 .endm
 
diff --git a/arch/mips/netlogic/xlp/cpu_control_macros.h b/arch/mips/netlogic/xlp/cpu_control_macros.h
index aebf7ea..69ac013 100644
--- a/arch/mips/netlogic/xlp/cpu_control_macros.h
+++ b/arch/mips/netlogic/xlp/cpu_control_macros.h
@@ -35,6 +35,7 @@
 
 #define LSU_DEFEATURE 0x304
 #define MMU_SETUP 0x400
+#define SCHED_DEFEATURE 0x700
 
 /* ----------------------------------
  *   XLP RESET Physical Address Map
-- 
1.7.0.4

