From 149ec7f377325b645c183b7e8e5b02406110824b Mon Sep 17 00:00:00 2001
From: Sreenidhi BR <sreenidhibr@netlogicmicro.com>
Date: Thu, 13 Oct 2011 15:12:24 +0530
Subject: [PATCH 451/761] LE fix for DTRE/RAID driver.

Based on Broadcom SDK 2.3.

Signed-off-by: Sreenidhi BR <sreenidhibr@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/dma/nlm_adma.c |   12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/drivers/dma/nlm_adma.c b/drivers/dma/nlm_adma.c
index da5f905..b4ca868 100644
--- a/drivers/dma/nlm_adma.c
+++ b/drivers/dma/nlm_adma.c
@@ -398,7 +398,7 @@ static dma_cookie_t nlm_tx_submit (struct dma_async_tx_descriptor *tx)
 	int vc_id;
 	uint32_t disks, freeback_msg_dest_id;
 	dma_cookie_t cookie;
-	int i, index, loopout;
+	int i, index, loopout, j=0;
 
 	enum nlm_raid_type raid_type;
 	enum nlm_write_syndrome operation;
@@ -518,6 +518,12 @@ static dma_cookie_t nlm_tx_submit (struct dma_async_tx_descriptor *tx)
 
 			}
 
+#ifdef CONFIG_CPU_LITTLE_ENDIAN
+			for (j=0; j<(DTRE_MAX_MEMCPY_DESC_LIST*4); j++)
+				nlm_tx->list_desc[j] = __swab64(nlm_tx->list_desc[j]);
+
+#endif
+
 			/* construct msgtype 7 (p2p) */
 			/* 8 bytes per entry * 4 entry msg */
 			raid_list_msg[0] = gen_dtr_xfer_p2pmsg_format_0((i+1)*8*4, (unsigned long)(virt_to_phys((volatile void*)nlm_tx->list_desc)));
@@ -590,6 +596,10 @@ static dma_cookie_t nlm_tx_submit (struct dma_async_tx_descriptor *tx)
 		disks = (nlm_tx->hw_desc.src_cnt) + 2;
 	}
 
+#ifdef CONFIG_CPU_LITTLE_ENDIAN
+	for (j=0; j<nlm_tx->entries_count; j++)
+		nlm_tx->hw_desc.entries[j] = __swab64(nlm_tx->hw_desc.entries[j]);
+#endif
 
 	raid_list_msg [0] = gen_dtr_raid_msg_format_0((nlm_tx->entries_count), nlm_tx->hw_desc.entries);
 	raid_list_msg [1] = gen_dtr_raid_msg_format_1(raid_type, operation, disks, freeback_msg_dest_id);
-- 
1.7.10.4

