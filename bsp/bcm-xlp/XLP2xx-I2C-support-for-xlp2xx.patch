From 54b1644203a1c7151c694da2bd3f4aa4e4fa1a25 Mon Sep 17 00:00:00 2001
From: kopal <kopal@broadcom.com>
Date: Fri, 21 Dec 2012 03:10:38 +0530
Subject: [PATCH 649/761] XLP2xx: I2C support for xlp2xx.

	The PCI Device ID for XLP2xx is different from previous silicons.
Also the PCI Function is different.

Based on Broadcom SDK 2.3.

Signed-off-by: kopal <kopal@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/netlogic/xlp.h |    1 +
 arch/mips/netlogic/xlp/platform.c    |   11 ++++++++++-
 drivers/i2c/busses/i2c-xlp.c         |   22 +++++++++++++++++-----
 3 files changed, 28 insertions(+), 6 deletions(-)

diff --git a/arch/mips/include/asm/netlogic/xlp.h b/arch/mips/include/asm/netlogic/xlp.h
index bdb2f62..5541076 100644
--- a/arch/mips/include/asm/netlogic/xlp.h
+++ b/arch/mips/include/asm/netlogic/xlp.h
@@ -58,6 +58,7 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #define XLP_DEVID_CPM           0x100F
 #define XLP_DEVID_UART          0x1010
 #define XLP_DEVID_I2C           0x1011
+#define XLP2XX_DEVID_I2C        0x101C
 #define XLP_DEVID_GPIO          0x1012
 #define XLP_DEVID_SYS           0x1013
 #define XLP_DEVID_JTAG          0x1014
diff --git a/arch/mips/netlogic/xlp/platform.c b/arch/mips/netlogic/xlp/platform.c
index 0679833..13f3045 100644
--- a/arch/mips/netlogic/xlp/platform.c
+++ b/arch/mips/netlogic/xlp/platform.c
@@ -167,12 +167,21 @@ static int get_dev2drv(uint32_t x)
 
 static int xlp_find_pci_dev(void)
 {
-	uint16_t i, j, id, idx = 0;
+	uint16_t i, j, id, idx = 0,count;
 	volatile uint64_t mmio;
 	uint32_t val, devid, vid, irt, irq;
 	struct platform_device* pplatdev;
 	struct resource* pres;
 
+	/* xlp2xx has different pcie device id */
+	if(is_nlm_xlp2xx()){
+                for(count=0; count<MAX_DEV2DRV; count++) {
+                        if(XLP_DEVID_I2C == dev2drv_table[count].devid){
+                                dev2drv_table[count].devid = XLP2XX_DEVID_I2C;
+                        }
+                }
+        }
+
 	pres = (struct resource*) kzalloc(sizeof(struct resource) * 2, GFP_KERNEL);
 
 	if(!pres) {
diff --git a/drivers/i2c/busses/i2c-xlp.c b/drivers/i2c/busses/i2c-xlp.c
index ca1391e..235bff0 100644
--- a/drivers/i2c/busses/i2c-xlp.c
+++ b/drivers/i2c/busses/i2c-xlp.c
@@ -455,16 +455,25 @@ i2c_xlp_probe(struct platform_device *pdev)
 		goto out;
 	}
 
-
 	priv->node = 0;
 	priv->bus = pdev->id;
 	priv->func = priv-> bus + 2;
 	priv->xfer_timeout = 200;
 	priv->ack_timeout = 200;
        	priv->speed	  =i2c_speed; 
-	
-	phys = nlm_hal_get_dev_base(0, 0, XLP_PCIE_GIO_DEV, priv->func) + 0x100;	
-	priv->ioreg = ioremap_nocache(phys, PAGE_SIZE);	
+	/* xlp2xx has different pcie function */
+	if(is_nlm_xlp2xx()) {
+		priv->func = 7;
+                phys = nlm_hal_get_dev_base(0, 0, XLP_PCIE_GIO_DEV, priv->func) + 0x100;
+		priv->ioreg = ioremap_nocache(phys+0x20, PAGE_SIZE);
+	}else
+        {       phys = nlm_hal_get_dev_base(0, 0, XLP_PCIE_GIO_DEV, priv->func) + 0x100;
+                priv->ioreg = ioremap_nocache(phys, PAGE_SIZE);
+        }
+		
+	if(is_nlm_xlp2xx())
+	priv->adap.nr = 1;
+	else
 	priv->adap.nr = pdev->id;
 	priv->adap.algo = &xlp_i2c_algo;
 	priv->adap.algo_data = priv;
@@ -478,7 +487,10 @@ i2c_xlp_probe(struct platform_device *pdev)
 	ret = i2c_add_numbered_adapter(&priv->adap);
 	if (ret == 0) {
 		platform_set_drvdata(pdev, priv);
-		printk("Initializing i2c-xlp host driver for i2c-xlp.%d\n",pdev->id);
+		if(is_nlm_xlp2xx())
+			printk("Initializing i2c-xlp host driver for i2c-xlp.%d\n",priv->adap.nr);
+		else
+			printk("Initializing i2c-xlp host driver for i2c-xlp.%d\n",pdev->id);
 		return 0;
 	}
 
-- 
1.7.10.4

