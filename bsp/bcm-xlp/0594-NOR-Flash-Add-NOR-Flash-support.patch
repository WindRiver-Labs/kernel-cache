From 9db2f592e2ad608072adee2ec0c10912a9e5ae33 Mon Sep 17 00:00:00 2001
From: Divya Sakthidharan <divyas@broadcom.com>
Date: Tue, 25 Sep 2012 19:20:38 +0530
Subject: [PATCH 594/762] NOR Flash: Add NOR Flash support.

Based on Broadcom SDK 2.3.

Signed-off-by: Divya Sakthidharan <divyas@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/Makefile   |    2 +-
 arch/mips/netlogic/xlp/platform.c |    4 +-
 arch/mips/netlogic/xlp/xlp_nor.c  |   94 +++++++++++++++++++++++++++++++++++++
 3 files changed, 97 insertions(+), 3 deletions(-)
 create mode 100644 arch/mips/netlogic/xlp/xlp_nor.c

diff --git a/arch/mips/netlogic/xlp/Makefile b/arch/mips/netlogic/xlp/Makefile
index 62ea137..a24ed59 100644
--- a/arch/mips/netlogic/xlp/Makefile
+++ b/arch/mips/netlogic/xlp/Makefile
@@ -3,7 +3,7 @@ EXTRA_CFLAGS := $(CFLAGS) -DNLM_HAL_LINUX_KERNEL -Iarch/mips/include/asm/netlogi
 
 obj-y                    	= setup.o nmi.o
 obj-y 				+= irq.o time.o on_chip.o mmu.o
-obj-$(CONFIG_NLM_XLP) 		+= platform.o board.o  xlp_gpio.o
+obj-$(CONFIG_NLM_XLP) 		+= platform.o board.o  xlp_gpio.o xlp_nor.o
 obj-$(CONFIG_SMP)       	+= smp.o
 obj-y				+= pic/
 obj-$(CONFIG_PCI_MSI)		+= msi.o
diff --git a/arch/mips/netlogic/xlp/platform.c b/arch/mips/netlogic/xlp/platform.c
index 1c00414..fcee2d8 100644
--- a/arch/mips/netlogic/xlp/platform.c
+++ b/arch/mips/netlogic/xlp/platform.c
@@ -53,6 +53,7 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #define UART_CLK_66MHz   66666666
 #define XLP_UART_PORTIO_OFFSET	0x1000
 
+extern int xlp_nor_flash_dev_init(void);
 static struct plat_serial8250_port xlp_uart_port[MAX_NUM_UARTS];
 
 static u64 xlp_dev_dmamask = DMA_BIT_MASK(32);
@@ -157,7 +158,6 @@ struct dev2drv dev2drv_table[MAX_DEV2DRV] = {
 	//{XLP_DEVID_MMC,	 "mmc-xlp",	8,	0, 	PLAT_DRV},
         {XLP_DEVID_MMC,  "sdhci",       8,      0,      PLAT_DRV},        
 	{XLP_DEVID_SPI,	 "spi-xlp",	8,	0, 	PLAT_DRV},
-	{XLP_DEVID_NOR,	 "nor-xlp",	8,	0, 	PLAT_DRV},
 	{XLP_DEVID_NAND, "nand-xlp",	9,	0, 	PLAT_DRV},
 	{XLP_DEVID_RIO,  "xlp-rio",     8,      0,      PLAT_DRV},
 	{0x0, 			 "",	0,	0,	PLAT_DRV},
@@ -262,7 +262,7 @@ static int xlp_find_pci_dev(void)
 static int __init platform_devinit(void)
 {
 	xlp_find_pci_dev();
-
+	xlp_nor_flash_dev_init();
 #ifdef CONFIG_USB
 	xlp_usb_hw_start();
 #endif
diff --git a/arch/mips/netlogic/xlp/xlp_nor.c b/arch/mips/netlogic/xlp/xlp_nor.c
new file mode 100644
index 0000000..8d5077d
--- /dev/null
+++ b/arch/mips/netlogic/xlp/xlp_nor.c
@@ -0,0 +1,94 @@
+#include <linux/platform_device.h>
+#include <linux/mtd/mtd.h>
+#include <linux/mtd/map.h>
+#include <linux/mtd/partitions.h>
+#include <linux/mtd/physmap.h>
+#include <asm/netlogic/xlp.h>
+
+#define XLP_NOR_BASEADDR       0x40
+#define XLP_NOR_SIZE           0x01000000 /* 16MB */
+#define XLP_NOR_WIDTH          2 /* 16-bits */
+
+
+static __inline__ int32_t nor_reg_read(int node,  int regidx)
+{
+        volatile uint64_t mmio;
+        mmio = nlm_hal_get_dev_base(node, 0, XLP_PCIE_SPI_NOR_FLASH_DEV,
+		XLP_PCIE_SPI_NOR); 
+        return nlm_hal_read_32bit_reg(mmio, regidx);
+}
+
+
+#define XLP_NOR_STARTADDR       (nor_reg_read(0, XLP_NOR_BASEADDR) << 8)
+#define XLP_NOR_ENDADDR         XLP_NOR_STARTADDR + XLP_NOR_SIZE
+
+static struct mtd_partition xlp_nor_partitions[] = {
+        {
+                .name   = "X-Loader(RO)",
+                .offset = 0,
+                .size   = 0x100000,     /* 1M */
+                .mask_flags = MTD_WRITEABLE,
+        },
+        {
+                .name   = "U-boot(RW)",
+                .offset = 0x100000,
+                .size   = 0x60000,      /* 384k */
+        },
+        {
+                .name   = "DTB(RW)",
+                .offset = 0x160000,
+                .size   = 0x20000,      /* 128K */
+        },
+        {
+                .name   = "Kernel(RW)",
+                .offset = 0x180000,
+                .size   = 0x580000,     /* 5.5M */
+        },
+        {
+                .name   = "Rootfs(RW)",
+                .offset = 0x700000,
+                .size   = 0x800000,     /* 8M */
+        },
+        {
+                .name   = "Env(RO)",
+                .offset = 0xf00000,     /* 1M */
+                .size   = MTDPART_SIZ_FULL,
+                .mask_flags = MTD_WRITEABLE,
+        },
+};
+
+
+static struct resource xlp_nor_flash_resource = {
+        .name   = "mem",
+        .flags  = IORESOURCE_MEM,
+};
+
+static struct physmap_flash_data xlp_nor_flash_data = {
+        .width  = 2,
+       .nr_parts = 6 ,
+       .parts = &xlp_nor_partitions[0],
+       .probe_type = "cfi_probe",
+};
+
+struct platform_device xlp_nor_flash = {
+        .name   =       "physmap-flash",
+        .id    =       XLP_DEVID_NOR,
+        .num_resources = 1,
+        .dev = {
+                .platform_data  = &xlp_nor_flash_data,
+        },
+        .resource = &xlp_nor_flash_resource,
+};
+
+
+int xlp_nor_flash_dev_init(void){
+        int res;
+	
+        xlp_nor_flash_resource.start  = XLP_NOR_STARTADDR,
+        xlp_nor_flash_resource.end    = XLP_NOR_ENDADDR,
+        res = platform_device_register(&xlp_nor_flash);
+        if (res)
+                printk("unable to register xlp-nor-flash: %d\n", res);
+       
+        return 0;
+}
-- 
1.7.0.4

