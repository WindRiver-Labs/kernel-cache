From db16e20e52b5fe14574a63b887b9e88d0c265143 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Tue, 9 Jul 2013 15:37:37 +0800
Subject: [PATCH 2/2] bcm-xlp-rt: modify bp HANDLER

Mask interrupts only when CONFIG_PREEMPT_RT_FULL is disabled, else we would
get the below errors during ptrace test:

<3>BUG: sleeping function called from invalid context at ./kernel/rtmutex.c:658
<3>in_atomic(): 0, irqs_disabled(): 1, pid: 2283, name: dummy
Call Trace:
[<ffffffffc17c19d8>] dump_stack+0x1c/0x50
[<ffffffffc1135a50>] __might_sleep+0x140/0x148
[<ffffffffc17ce420>] rt_spin_lock+0x38/0x100
[<ffffffffc110f1ec>] do_force_sig_info+0x4c/0x140
[<ffffffffc110f308>] force_sig+0x28/0x40
[<ffffffffc10c7ee0>] do_trap_or_bp+0xb0/0x1c0
[<ffffffffc10c8888>] do_bp+0x80/0x138
[<ffffffffc10c0284>] ret_from_exception+0x0/0x10

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/kernel/genex.S |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/arch/mips/kernel/genex.S b/arch/mips/kernel/genex.S
index bf405ee..1e8e8ae 100644
--- a/arch/mips/kernel/genex.S
+++ b/arch/mips/kernel/genex.S
@@ -457,7 +457,8 @@ NESTED(nmi_handler, PT_SIZE, sp)
 	BUILD_HANDLER ades ade ade silent		/* #5  */
 	BUILD_HANDLER ibe be cli silent			/* #6  */
 	BUILD_HANDLER dbe be cli silent			/* #7  */
-#if defined(CONFIG_NLM_XLP) && defined (CONFIG_KGDB)
+#if defined(CONFIG_NLM_XLP) && defined (CONFIG_KGDB) \
+	&& !defined (CONFIG_PREEMPT_RT_FULL)
 	BUILD_HANDLER bp bp cli silent			/* #9  */
 #else
 	BUILD_HANDLER bp bp sti silent			/* #9  */
-- 
1.7.0.4

