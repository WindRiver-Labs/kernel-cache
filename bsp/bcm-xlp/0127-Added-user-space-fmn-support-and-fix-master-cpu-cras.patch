From 3b9c6f66a355893e3d0009d76eeeab89950ed6e3 Mon Sep 17 00:00:00 2001
From: Mehul <vmehul@netlogicmicro.com>
Date: Fri, 6 Aug 2010 12:02:55 +0530
Subject: [PATCH 127/762] Added user space fmn support and fix master cpu crash due to invalid delay slot.

Based on Broadcom SDK 2.3.

Signed-off-by: Mehul <vmehul@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/ptrace.h           |   16 +++++
 arch/mips/include/asm/stackframe.h       |   94 ++++++++++++++++++++++++++++++
 arch/mips/kernel/asm-offsets.c           |   15 +++++
 arch/mips/netlogic/Kconfig               |    5 ++
 arch/mips/netlogic/xlp/cpu_control_asm.S |    1 +
 5 files changed, 131 insertions(+), 0 deletions(-)

diff --git a/arch/mips/include/asm/ptrace.h b/arch/mips/include/asm/ptrace.h
index dfe6e2b..af9d653 100644
--- a/arch/mips/include/asm/ptrace.h
+++ b/arch/mips/include/asm/ptrace.h
@@ -52,6 +52,22 @@ struct pt_regs {
 	unsigned long long mpl[3];        /* MTM{0,1,2} */
 	unsigned long long mtp[3];        /* MTP{0,1,2} */
 #endif
+#ifdef CONFIG_NLM_USER_COP2_ACCESS
+	unsigned long long tx_buf_0;
+	unsigned long long tx_buf_1;
+	unsigned long long tx_buf_2;
+	unsigned long long tx_buf_3;
+	unsigned long long rx_buf_0;
+	unsigned long long rx_buf_1;
+	unsigned long long rx_buf_2;
+	unsigned long long rx_buf_3;
+	unsigned int tx_msg_status;
+	unsigned int rx_msg_status;
+	unsigned int misc_status;
+	unsigned int msg_config;
+	unsigned int msg_err;
+#endif
+
 } __attribute__ ((aligned (8)));
 
 /* Arbitrarily choose the same ptrace numbers as used by the Sparc code. */
diff --git a/arch/mips/include/asm/stackframe.h b/arch/mips/include/asm/stackframe.h
index 8b1940a..823d4f3 100644
--- a/arch/mips/include/asm/stackframe.h
+++ b/arch/mips/include/asm/stackframe.h
@@ -217,6 +217,52 @@
 		LONG_S	v1, PT_EPC(sp)
 		ori	$28, sp, _THREAD_MASK
 		xori	$28, _THREAD_MASK
+#ifdef CONFIG_NLM_USER_COP2_ACCESS
+		.set push
+		.set arch=xlp 
+		.set noreorder
+		/*status backup..*/
+		mfc0	k0, CP0_STATUS
+		/*enable cop2 access..*/
+		li	v1, 0x40000000
+		or	v1, v1, k0
+		mtc0	v1, CP0_STATUS
+		/*msgring tx buf reg*/
+		dmfc2 v1, $0, 0
+		sd  v1, NLM_COP2_TX_BUF_0(sp)
+		dmfc2 v1, $0, 1
+		sd  v1, NLM_COP2_TX_BUF_1(sp)
+		dmfc2 v1, $0, 2
+		sd  v1, NLM_COP2_TX_BUF_2(sp)
+		dmfc2 v1, $0, 3
+		sd  v1, NLM_COP2_TX_BUF_3(sp)
+	
+		/*msgring rx buf reg*/
+		dmfc2 v1, $1, 0
+		sd  v1, NLM_COP2_RX_BUF_0(sp)
+		dmfc2 v1, $1, 1
+		sd  v1, NLM_COP2_RX_BUF_1(sp)
+		dmfc2 v1, $1, 2
+		sd  v1, NLM_COP2_RX_BUF_2(sp)
+		dmfc2 v1, $1, 3
+		sd  v1, NLM_COP2_RX_BUF_3(sp)
+		mfc2 v1, $2, 0
+		sw  v1, NLM_COP2_TX_MSG_STATUS(sp)
+	
+		mfc2 v1, $3, 0
+		sw v1, NLM_COP2_RX_MSG_STATUS(sp)
+
+		mfc2 v1, $4, 0
+		sw v1, NLM_COP2_MISC_STATUS(sp)
+		
+		mfc2 v1, $5, 0
+		sw v1, NLM_COP2_MSG_CONFIG(sp)
+
+		/*write back status..*/	
+		mtc0	k0, CP0_STATUS
+		.set pop
+#endif
+
 #ifdef CONFIG_CPU_CAVIUM_OCTEON
 		.set    mips64
 		pref    0, 0($28)       /* Prefetch the current pointer */
@@ -360,6 +406,54 @@
 		DVPE	5				# dvpe a1
 		jal	mips_ihb
 #endif /* CONFIG_MIPS_MT_SMTC */
+#ifdef CONFIG_NLM_USER_COP2_ACCESS
+		.set push
+		.set arch=xlp 
+		.set noreorder
+		/*status backup..*/
+		mfc0	k0, CP0_STATUS
+		/*enable cop2 access..*/
+		li	v1, 0x40000000
+		or	v1, v1, k0
+		mtc0	v1, CP0_STATUS
+
+		/*msgring tx buf reg*/
+		ld  v1, NLM_COP2_TX_BUF_0(sp)
+		dmtc2 v1, $0, 0
+		ld  v1, NLM_COP2_TX_BUF_1(sp)
+		dmtc2 v1, $0, 1
+		ld  v1, NLM_COP2_TX_BUF_2(sp)
+		dmtc2 v1, $0, 2
+		ld  v1, NLM_COP2_TX_BUF_3(sp)
+		dmtc2 v1, $0, 3
+
+		/*msgring rx buf reg*/
+		ld  v1, NLM_COP2_RX_BUF_0(sp)
+		dmtc2 v1, $1, 0
+		ld  v1, NLM_COP2_RX_BUF_1(sp)
+		dmtc2 v1, $1, 1
+
+		ld  v1, NLM_COP2_RX_BUF_2(sp)
+		dmtc2 v1, $1, 2
+		ld  v1, NLM_COP2_RX_BUF_3(sp)
+		dmtc2 v1, $1, 3
+
+		lw  v1, NLM_COP2_TX_MSG_STATUS(sp)
+		mtc2 v1, $2, 0
+	
+		lw v1, NLM_COP2_RX_MSG_STATUS(sp)
+		mtc2 v1, $3, 0
+
+		lw v1, NLM_COP2_MISC_STATUS(sp)
+		mtc2 v1, $4, 0
+		
+		lw v1, NLM_COP2_MSG_CONFIG(sp)
+		mtc2 v1, $5, 0
+
+		/*writeback original status..*/
+		mtc0	k0, CP0_STATUS
+		.set pop
+#endif
 #ifdef CONFIG_CPU_CAVIUM_OCTEON
 		/* Restore the Octeon multiplier state */
 		jal	octeon_mult_restore
diff --git a/arch/mips/kernel/asm-offsets.c b/arch/mips/kernel/asm-offsets.c
index 1a0bcda..7849899 100644
--- a/arch/mips/kernel/asm-offsets.c
+++ b/arch/mips/kernel/asm-offsets.c
@@ -69,6 +69,21 @@ void output_ptreg_defines(void)
 	OFFSET(PT_MPL, pt_regs, mpl);
 	OFFSET(PT_MTP, pt_regs, mtp);
 #endif /* CONFIG_CPU_CAVIUM_OCTEON */
+#ifdef CONFIG_NLM_USER_COP2_ACCESS
+	OFFSET(NLM_COP2_TX_BUF_0, pt_regs, tx_buf_0);
+	OFFSET(NLM_COP2_TX_BUF_1, pt_regs, tx_buf_1);
+	OFFSET(NLM_COP2_TX_BUF_2, pt_regs, tx_buf_2);
+	OFFSET(NLM_COP2_TX_BUF_3, pt_regs, tx_buf_3);
+	OFFSET(NLM_COP2_RX_BUF_0, pt_regs, rx_buf_0);
+	OFFSET(NLM_COP2_RX_BUF_1, pt_regs, rx_buf_1);
+	OFFSET(NLM_COP2_RX_BUF_2, pt_regs, rx_buf_2);
+	OFFSET(NLM_COP2_RX_BUF_3, pt_regs, rx_buf_3);
+	OFFSET(NLM_COP2_TX_MSG_STATUS, pt_regs, tx_msg_status);
+	OFFSET(NLM_COP2_RX_MSG_STATUS, pt_regs, rx_msg_status);
+	OFFSET(NLM_COP2_MISC_STATUS, pt_regs, misc_status);
+	OFFSET(NLM_COP2_MSG_CONFIG, pt_regs, msg_config);
+	OFFSET(NLM_COP2_MSG_ERR, pt_regs, msg_err);
+#endif
 
 #ifdef XLP_MERGE_TODO /*CONFIG_NLM_XLP_SIM*/
 	OFFSET("#define PT_CRC_POLY_0 ", pt_regs, crc_poly_0);
diff --git a/arch/mips/netlogic/Kconfig b/arch/mips/netlogic/Kconfig
index 4774bc5..d6678c1 100644
--- a/arch/mips/netlogic/Kconfig
+++ b/arch/mips/netlogic/Kconfig
@@ -203,3 +203,8 @@ config XEN
        bool "Enable Paravirtualization for Xen"
        depends on NLM_XLP
        default n
+
+config NLM_USER_COP2_ACCESS
+       bool "Enable User space Cop2 Access"
+       depends on NLM_XLP && 64BIT
+       default n
diff --git a/arch/mips/netlogic/xlp/cpu_control_asm.S b/arch/mips/netlogic/xlp/cpu_control_asm.S
index ca4b444..e54dcf6 100644
--- a/arch/mips/netlogic/xlp/cpu_control_asm.S
+++ b/arch/mips/netlogic/xlp/cpu_control_asm.S
@@ -149,4 +149,5 @@ EXPORT(__boot_siblings)
 	PTR_SUBU sp, PT_SIZE
 	RESTORE_ALL
 	jr   ra
+	nop
 EXPORT(boot_siblings_end)
-- 
1.7.0.4

