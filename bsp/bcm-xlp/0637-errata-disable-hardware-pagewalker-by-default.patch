From 312499ca76d65d80a18f7ee9979476e759ae4ccd Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Wed, 5 Dec 2012 09:58:26 -0800
Subject: [PATCH 637/762] errata: disable hardware pagewalker by default

  o To enable hardware pagewalker, put "enable_pgwalker" in the linux booting command line

Based on Broadcom SDK 2.3.

Signed-off-by: Yonghong Song <ysong@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/mmu.c |   14 +++++++++-----
 1 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/arch/mips/netlogic/xlp/mmu.c b/arch/mips/netlogic/xlp/mmu.c
index c5713d9..8e4c493 100644
--- a/arch/mips/netlogic/xlp/mmu.c
+++ b/arch/mips/netlogic/xlp/mmu.c
@@ -37,7 +37,7 @@
 
 #define _PMD_T_LOG2 3
 
-static int __cpuinitdata tlb_config = (ENABLE_ETLB | ENABLE_128_TLB | ENABLE_PGWALKER);
+static int __cpuinitdata tlb_config = (ENABLE_ETLB | ENABLE_128_TLB);
 
 int __init disable_etlb(char *str)
 {
@@ -54,13 +54,13 @@ int __init disable_128tlb(char *str)
 }
 __setup("disable_128tlb", disable_128tlb);
 
-int __init disable_pgwalker_cmdline(char *str)
+int __init enable_pgwalker_cmdline(char *str)
 {
-	tlb_config &= ~ENABLE_PGWALKER;
+	tlb_config |= ENABLE_PGWALKER;
 
 	return 1;
 }
-__setup("disable_pgwalker", disable_pgwalker_cmdline);
+__setup("enable_pgwalker", enable_pgwalker_cmdline);
 
 /*
  * Page Walker
@@ -79,7 +79,11 @@ static void __cpuinit pgwalker_init(void)
 	unsigned int value;
 	int i = 0;
 
-	if (!(tlb_config & ENABLE_PGWALKER)) return;
+	if (!(tlb_config & ENABLE_PGWALKER)) {
+		/* disable hardware page walker */
+		write_c0_config6(read_c0_config6() & (~ENABLE_PGWALKER));
+		return;
+	}
 
 	/* Initialize pgd_bases to default values */
 	for(i = 0; i < NR_ADDR_SEGMENTS; i++) {
-- 
1.7.0.4

