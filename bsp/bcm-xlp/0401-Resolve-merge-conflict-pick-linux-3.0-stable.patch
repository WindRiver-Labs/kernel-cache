From a586aa2b29ba7bc9d8148685941a358efb7a4671 Mon Sep 17 00:00:00 2001
From: Zi Shen Lim <zlim@netlogicmicro.com>
Date: Thu, 29 Sep 2011 16:21:18 -0700
Subject: [PATCH 401/762] Resolve merge conflict: pick linux-3.0-stable

Based on Broadcom SDK 2.3.

Signed-off-by: Zi Shen Lim <zlim@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 kernel/smp.c |    5 ++---
 1 files changed, 2 insertions(+), 3 deletions(-)

diff --git a/kernel/smp.c b/kernel/smp.c
index 5a40576..d5f3238 100644
--- a/kernel/smp.c
+++ b/kernel/smp.c
@@ -190,7 +190,6 @@ void generic_smp_call_function_interrupt(void)
 	 */
 	smp_mb();
 
-	raw_spin_lock(&call_function.lock);
 	/*
 	 * It's ok to use list_for_each_rcu() here even though we may
 	 * delete 'pos', since list_del_rcu() doesn't clear ->next
@@ -239,7 +238,9 @@ void generic_smp_call_function_interrupt(void)
 
 		WARN_ON(!cpumask_empty(data->cpumask));
 
+		raw_spin_lock(&call_function.lock);
 		list_del_rcu(&data->csd.list);
+		raw_spin_unlock(&call_function.lock);
 
 		csd_unlock(&data->csd);
 	}
@@ -344,8 +345,6 @@ int smp_call_function_single(int cpu, smp_call_func_t func, void *info,
 		}
 	}
 
-	raw_spin_unlock(&call_function.lock);
-
 	put_cpu();
 
 	return err;
-- 
1.7.0.4

