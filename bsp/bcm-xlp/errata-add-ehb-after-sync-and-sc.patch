From a19df77fb017a22a9320f6a94d48647fa9260331 Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Wed, 3 Oct 2012 10:36:49 -0700
Subject: [PATCH 597/761] errata: add "ehb" after "sync" and "sc"

Based on Broadcom SDK 2.3.

Signed-off-by: Yonghong Song <ysong@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/barrier.h              |   25 +++++++++++++++++++++++++
 arch/mips/include/asm/io.h                   |    2 ++
 arch/mips/include/asm/netlogic/nlm_rw_lock.h |    2 +-
 3 files changed, 28 insertions(+), 1 deletion(-)

diff --git a/arch/mips/include/asm/barrier.h b/arch/mips/include/asm/barrier.h
index a230cde..002591b 100644
--- a/arch/mips/include/asm/barrier.h
+++ b/arch/mips/include/asm/barrier.h
@@ -66,16 +66,31 @@
 #define smp_read_barrier_depends()	do { } while(0)
 
 #ifdef CONFIG_CPU_HAS_SYNC
+
+#ifdef CONFIG_NLM_XLP
 #define __sync()				\
 	__asm__ __volatile__(			\
 		".set	push\n\t"		\
 		".set	noreorder\n\t"		\
+		".set	mips64r2\n\t"		\
+		"sync\n\t"			\
+		"ehb\n\t"			\
+		".set	pop"			\
+		: /* no output */		\
+		: /* no input */		\
+		: "memory")
+#else /* !CONFIG_NLM_XLP */
+	__asm__ __volatile__(			\
+		".set	push\n\t"		\
+		".set	noreorder\n\t"		\
 		".set	mips2\n\t"		\
 		"sync\n\t"			\
 		".set	pop"			\
 		: /* no output */		\
 		: /* no input */		\
 		: "memory")
+#endif /* CONFIG_NLM_XLP */
+
 #else
 #define __sync()	do { } while(0)
 #endif
@@ -146,6 +161,10 @@
 #  define smp_mb()	__sync()
 #  define smp_rmb()	barrier()
 #  define smp_wmb()	__syncw()
+# elif defined(CONFIG_NLM_XLP)
+#  define smp_mb()	__sync()
+#  define smp_rmb()	__sync()
+#  define smp_wmb()	__sync()
 # else
 #  define smp_mb()	__asm__ __volatile__("sync" : : :"memory")
 #  define smp_rmb()	__asm__ __volatile__("sync" : : :"memory")
@@ -158,7 +177,13 @@
 #endif
 
 #if defined(CONFIG_WEAK_REORDERING_BEYOND_LLSC) && defined(CONFIG_SMP)
+
+#ifdef CONFIG_NLM_XLP
+#define __WEAK_LLSC_MB		".set push\n\t .set mips64r2\n\t sync\n\t ehb\n\t .set pop\n"
+#else /* !CONFIG_NLM_XLP */
 #define __WEAK_LLSC_MB		"       sync	\n"
+#endif /* CONFIG_NLM_XLP */
+
 #else
 #define __WEAK_LLSC_MB		"		\n"
 #endif
diff --git a/arch/mips/include/asm/io.h b/arch/mips/include/asm/io.h
index a58f229..eeeef42 100644
--- a/arch/mips/include/asm/io.h
+++ b/arch/mips/include/asm/io.h
@@ -534,6 +534,8 @@ BUILDSTRING(q, u64)
 
 #ifdef CONFIG_CPU_CAVIUM_OCTEON
 #define mmiowb() wmb()
+#elif defined(CONFIG_NLM_XLP)
+#define mmiowb() asm volatile ("sync\n ehb" ::: "memory")
 #else
 /* Depends on MIPS II instruction set */
 #define mmiowb() asm volatile ("sync" ::: "memory")
diff --git a/arch/mips/include/asm/netlogic/nlm_rw_lock.h b/arch/mips/include/asm/netlogic/nlm_rw_lock.h
index 020fb8cf..b07c6f3 100644
--- a/arch/mips/include/asm/netlogic/nlm_rw_lock.h
+++ b/arch/mips/include/asm/netlogic/nlm_rw_lock.h
@@ -35,7 +35,7 @@ typedef struct {
 	int write_cpu; /* CPU that is currently holding wr lock */
 } nlm_rwlock_t;
 
-#define nlm_sync() __asm__ __volatile__("sync": : :"memory")
+#define nlm_sync() __asm__ __volatile__("sync\n ehb": : :"memory")
 __asm__ (
 		".macro\tnlm_local_irq_save result\n\t"
 		".set\tpush\n\t"
-- 
1.7.10.4

