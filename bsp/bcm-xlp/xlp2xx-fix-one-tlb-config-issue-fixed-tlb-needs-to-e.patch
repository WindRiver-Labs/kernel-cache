From 3dd755c7651ad64eb621da9cb08faa181b0de140 Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Fri, 20 Apr 2012 23:08:37 -0700
Subject: [PATCH 562/761] xlp2xx: fix one tlb config issue (fixed tlb needs to
 enabled earlier before config4 access)

Based on Broadcom SDK 2.3.

Signed-off-by: Yonghong Song <ysong@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/mmu.c |   16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/arch/mips/netlogic/xlp/mmu.c b/arch/mips/netlogic/xlp/mmu.c
index 73dfe17..ff1b4b5 100644
--- a/arch/mips/netlogic/xlp/mmu.c
+++ b/arch/mips/netlogic/xlp/mmu.c
@@ -269,7 +269,7 @@ static void pgwalker_workaround_setup(void) {}
 
 void __cpuinit mmu_init(void)
 {
-	uint32_t config4_val = 0;
+	uint32_t config4_val = 0, value;
 
 	/* For XLP832 A0-A2 chips, the page walker needs to be shutdown to
 	 * prevent potential errors.
@@ -277,6 +277,15 @@ void __cpuinit mmu_init(void)
 	pgwalker_workaround_setup();
 
 	if (is_cpu_core_xlp_ii) {
+		/* MMU_SETUP:
+		 * [3]: using fixed TLB or not.
+		 * [4]: PTE format compatible with XLP8XX/XLP4XX/XLP3XX, mostly useful for RI/XI support
+		 */
+		value = 0;
+		value |= ((tlb_config & ENABLE_ETLB)) << 3;
+		value |= 1 << 4;
+		pgw_register_write_w(PGW_MMU_SETUP, value);
+
 		/* set config4 to use 64KB page */
 		config4_val = read_c0_config4();
 		config4_val &= ~(((uint32_t)0x1f) << CFG4_FTLBPAGESIZE_O); /*clear 5-bit width field*/
@@ -296,6 +305,11 @@ void __cpuinit mmu_init(void)
 #endif
         }
 
+	/*
+	 * Read back TLB entries after configuration
+	 */
+	current_cpu_data.tlbsize = (read_c0_config6() >> 16 ) & 0xffff;
+
 #ifdef CONFIG_EXEC_INHIBIT
 	pagegrain_write(pagegrain_read() | EXEC_INHIBIT);
 #endif
-- 
1.7.10.4

