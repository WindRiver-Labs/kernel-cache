From 06f2667ea5258813cd35b34be5a2006427e21776 Mon Sep 17 00:00:00 2001
From: Om Narasimhan <omn@broadcom.com>
Date: Wed, 30 Jan 2013 11:01:18 -0800
Subject: [PATCH 667/761] pic : changed ITE dump implementation

ITE now reads values from the registers directly. Previously used to print
static values.

Based on Broadcom SDK 2.3.

Signed-off-by: Om Narasimhan <omn@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/pic/xlp_pic.c |   24 ++++++++++++++++++++----
 1 file changed, 20 insertions(+), 4 deletions(-)

diff --git a/arch/mips/netlogic/xlp/pic/xlp_pic.c b/arch/mips/netlogic/xlp/pic/xlp_pic.c
index d926d05..a509442 100644
--- a/arch/mips/netlogic/xlp/pic/xlp_pic.c
+++ b/arch/mips/netlogic/xlp/pic/xlp_pic.c
@@ -9,15 +9,31 @@
  */
 static struct cpumask xlp_ites[NLM_MAX_NODES][XLP_ITE_ENTRIES];
 
-static void dump_all_ites(void)
+void ite_to_cpumask(u8 node, u8 idx, cpumask_t *m)
+{
+	int ii;
+	u64 ite[2] = {0, 0};
+
+	ite[0] = nlh_pic_r64r(node, XLP_PIC_INT_THREADEN01(idx));
+	ite[1] = nlh_pic_r64r(node, XLP_PIC_INT_THREADEN23(idx));
+	cpumask_clear(m);
+
+	for (ii = 0; ii < NR_CPUS; ii++) {
+		if (ite[ii/64] & (1ULL << (ii % 64))) cpumask_set_cpu(ii, m);
+	}
+}
+
+void dump_all_ites(void)
 {
 	u8 node, i;
+	cpumask_t mask;
 	char buf[140];
 
 	for_each_online_node(node) {
 	for (i = 0; i < XLP_ITE_ENTRIES; i++) {
-		cpumask_scnprintf(buf, 140, &xlp_ites[node][i]);
-		printk(KERN_DEBUG "node %d: Supported CPUMASK (%d) -> %s\n",
+		ite_to_cpumask(node, i, &mask);
+		cpumask_scnprintf(buf, 140, &mask);
+		printk(KERN_DEBUG "node %d: Current ITE CPUMASK (%d) -> %s\n",
 				node, i, buf);
 	}
 	}
@@ -91,7 +107,6 @@ void xlp_prog_all_node_ites(void)
 	u8 i, node;
 	struct pic_dev *pic;
 
-	dump_all_ites();
 	for_each_online_node(node) {
 		if (retrieve_node_pic_dev(node, &pic) < 0) {
 			panic("Cannot retrieve node(%d) pic dev", node);
@@ -101,6 +116,7 @@ void xlp_prog_all_node_ites(void)
 			xlp_cpumask_to_node_ite(&xlp_ites[node][i], pic, i, (i == 4));
 		}
 	}
+	dump_all_ites();
 }
 
 /* Checks if a mask spans multiple nodes
-- 
1.7.10.4

