From 0415c596837a6a3ead9ad815bac7d1de60e74137 Mon Sep 17 00:00:00 2001
From: henry shao <hshao@netlogicmicro.com>
Date: Tue, 31 Aug 2010 03:38:07 -0700
Subject: [PATCH 162/761] clean up for irq.c common/smp.c

Based on Broadcom SDK 2.3.

Signed-off-by: henry shao <hshao@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/common/smp.c |   73 ++++-----------------------------------
 arch/mips/netlogic/xlp/irq.c    |   27 ++-------------
 2 files changed, 9 insertions(+), 91 deletions(-)

diff --git a/arch/mips/netlogic/common/smp.c b/arch/mips/netlogic/common/smp.c
index 81d04d9..5f6e6ff 100644
--- a/arch/mips/netlogic/common/smp.c
+++ b/arch/mips/netlogic/common/smp.c
@@ -37,11 +37,6 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #include <asm/netlogic/pic.h>
 #include <asm/netlogic/msgring.h>
 
-#if defined(CONFIG_NLM_XLP)
-#include <asm/netlogic/hal/nlm_hal_pic.h>
-#endif
-
-//#define IPI_PRINTK_DEBUG
 
 /* ipi statistics counters for debugging */
 __u32 ipi_3_counter_tx[NR_CPUS][NR_CPUS];
@@ -49,10 +44,10 @@ __u32 ipi_3_counter_rx[NR_CPUS];
 
 extern void save_epc(unsigned long *epc);
 extern void smp_call_function_interrupt(void);
-//extern void nlm_common_smp_time_init(void);
 static int nlm_common_ipi_stats[NR_CPUS];
 static unsigned long nlm_common_ipi_epc[NR_CPUS];
 
+#ifdef CONFIG_NLM_XLR
 #define SET_IPI_VECTOR(x, y) x |= y
 
 void core_send_ipi(int logical_cpu, unsigned int action)
@@ -64,57 +59,24 @@ void core_send_ipi(int logical_cpu, unsigned int action)
 
 	if (action & SMP_CALL_FUNCTION) {
 		SET_IPI_VECTOR(ipi, IRQ_IPI_SMP_FUNCTION);
-
-#ifdef IPI_PRINTK_DEBUG
-		printk("[%s]: cpu_%d sending ipi_3 to cpu_%d \t\t\t[->%u] \n",
-		       __FUNCTION__, smp_processor_id(), cpu,
-		       ipi_3_counter_tx[smp_processor_id()][cpu] + 1);
-#endif
-		++ipi_3_counter_tx[smp_processor_id()][cpu];
-
 	} else if (action & SMP_RESCHEDULE_YOURSELF) {
 		SET_IPI_VECTOR(ipi, IRQ_IPI_SMP_RESCHEDULE);
-
-#ifdef IPI_PRINTK_DEBUG
-		printk("[%s]: cpu_%d sending ipi_4 to cpu_%d\n", __FUNCTION__,
-		       smp_processor_id(), cpu);
-#endif
 	} else if (action & SMP_CALL_KGDB_HOOK) {
-
 		SET_IPI_VECTOR(ipi, IRQ_IPI_SMP_KGDB);
-
-#ifdef IPI_PRINTK_DEBUG
-		printk("Sending KGDB IPI 0x%08x to tid %d pid %d\n", ipi, tid,
-		       pid);
-#endif
 	} else if (action & SMP_OPROFILE_IPI) {
 		SET_IPI_VECTOR(ipi, IRQ_IPI_OPROFILE);
-
-#ifdef IPI_PRINTK_DEBUG
-		printk("Sending OPROFILE IPI 0x%08x to tid %d pid %d\n", ipi,
-		       tid, pid);
-#endif
 	}
 #ifdef CONFIG_NLMCOMMON_IP_FLOW_AFFINITY
 	else if (action & SMP_NETRX_IPI) {
 		SET_IPI_VECTOR(ipi, IRQ_IPI_NETRX);
-
-#ifdef IPI_PRINTK_DEBUG
-		printk(KERN_ALERT
-		       "%s: Sending NETRX IPI 0x%08x to tid %d pid %d\n",
-		       __FUNCTION__, ipi, tid, pid);
-#endif				/* IPI_PRINTK_DEBUG */
 	}
 #endif				/* CONFIG_NLMCOMMON_IP_FLOW_AFFINITY */
 	else
-		BUG();
-	//  printk(" -- Sending Ipi %lx\n", ipi);
-#if defined(XLP_SIM)
-	nlm_hal_pic_send_ipi(0, (ipi & 0x3f), 0, cpu);
-#else
-	//pic_send_ipi(ipi);
-#endif
+		return;
+
+	pic_send_ipi(ipi);
 }
+#endif
 
 extern __u64 nlm_common_irq_mask;
 
@@ -143,12 +105,6 @@ void nlm_smp_function_ipi_handler(unsigned int irq, struct irq_desc *desc)
 {
 	nlm_common_ipi_stats[smp_processor_id()]++;
 	save_epc(&nlm_common_ipi_epc[smp_processor_id()]);
-#ifdef IPI_PRINTK_DEBUG
-	printk("[%s]: cpu_%d processing ipi_%d [->%u]\n", __FUNCTION__,
-			smp_processor_id(), irq,
-			ipi_3_counter_rx[smp_processor_id()]++);
-#endif
-	++ipi_3_counter_rx[smp_processor_id()];
 	smp_call_function_interrupt();
 	nlm_common_ipi_stats[smp_processor_id()]--;
 }
@@ -159,10 +115,6 @@ void nlm_smp_resched_ipi_handler(unsigned int irq, struct irq_desc *desc)
 	nlm_common_ipi_stats[smp_processor_id()]++;
 	save_epc(&nlm_common_ipi_epc[smp_processor_id()]);
 
-#ifdef IPI_PRINTK_DEBUG
-	printk("[%s]: cpu_%d processing ipi_%d\n", __FUNCTION__,
-			smp_processor_id(), irq);
-#endif
 	/* Announce that we are for reschduling */
 	set_need_resched();
 	nlm_common_ipi_stats[smp_processor_id()]--;
@@ -189,12 +141,6 @@ void nlm_common_ipi_handler(int irq, struct pt_regs *regs)
 	save_epc(&nlm_common_ipi_epc[smp_processor_id()]);
 
 	if (irq == IRQ_IPI_SMP_FUNCTION) {
-#ifdef IPI_PRINTK_DEBUG
-		printk("[%s]: cpu_%d processing ipi_%d [->%u]\n", __FUNCTION__,
-		       smp_processor_id(), irq,
-		       ipi_3_counter_rx[smp_processor_id()]++);
-#endif
-		++ipi_3_counter_rx[smp_processor_id()];
 		smp_call_function_interrupt();
 	}
 #ifdef CONFIG_NLMCOMMON_IP_FLOW_AFFINITY
@@ -206,17 +152,10 @@ void nlm_common_ipi_handler(int irq, struct pt_regs *regs)
 		/* run soft IRQ at the end */
 		irq_exit();
 	}
-#endif				/* CONFIG_NLMCOMMON_IP_FLOW_AFFINITY */
-
+#endif	/* CONFIG_NLMCOMMON_IP_FLOW_AFFINITY */
 	else {
-#ifdef IPI_PRINTK_DEBUG
-		printk("[%s]: cpu_%d processing ipi_%d\n", __FUNCTION__,
-		       smp_processor_id(), irq);
-#endif
-
 		/* Announce that we are for reschduling */
 		set_need_resched();
-
 	}
 	nlm_common_ipi_stats[smp_processor_id()]--;
 }
diff --git a/arch/mips/netlogic/xlp/irq.c b/arch/mips/netlogic/xlp/irq.c
index 4109086..6ab54bf 100644
--- a/arch/mips/netlogic/xlp/irq.c
+++ b/arch/mips/netlogic/xlp/irq.c
@@ -365,41 +365,20 @@ void __init init_nlm_common_irqs(void)
 	nlm_xlp_irq_mask |= (1ULL << IRQ_TIMER);
 }
 
-#ifdef CONFIG_KGDB
-extern irqreturn_t xlp_kgdb_ipi_handler(int irq, struct pt_regs *regs);
-#endif
-#ifdef CONFIG_OPROFILE
-extern void nlm_common_oprofile_int_handler(int irq, void *dev_id,
-					 struct pt_regs *regs);
-#endif
-
 void do_nlm_common_IRQ(unsigned int irq, struct pt_regs *regs)
 {
-#ifdef CONFIG_SMP
-
-#ifdef CONFIG_NLMCOMMON_IP_FLOW_AFFINITY
-	if (irq == IRQ_IPI_SMP_FUNCTION || irq == IRQ_IPI_SMP_RESCHEDULE
-	    || irq == IRQ_IPI_NETRX) {
-#else
 	if (irq == IRQ_IPI_SMP_FUNCTION || irq == IRQ_IPI_SMP_RESCHEDULE) {
-#endif				/* CONFIG_NLMCOMMON_IP_FLOW_AFFINITY */
 		nlm_common_ipi_handler(irq, regs);
 		return;
 	}
-#endif
 	if (irq == IRQ_MSGRING) nlm_xlp_msgring_int_handler(irq, regs);
 
-#ifdef CONFIG_KGDB
 	else if (irq == IRQ_IPI_SMP_KGDB) {
-  }
-#endif
-#ifdef CONFIG_OPROFILE
+  	}
 	else if (irq == IRQ_IPI_OPROFILE) {
-		if (netlogic_thr_id() != 0)
-			nlm_common_oprofile_int_handler(irq, NULL, regs);
 	}
-#endif
-  else do_IRQ(irq);
+  	else 
+		do_IRQ(irq);
 }
 
 void __cpuinit nlm_smp_irq_init(void)
-- 
1.7.10.4

