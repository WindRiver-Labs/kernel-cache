From 9c5577975e00eeb884f1f4b5e7025c47c957c946 Mon Sep 17 00:00:00 2001
From: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Date: Wed, 6 Oct 2010 10:58:20 -0700
Subject: [PATCH 193/761] Configure LSU (S1RCM)

Based on Broadcom SDK 2.3.

Signed-off-by: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/cpu_control.c     |   12 +++++++-----
 arch/mips/netlogic/xlp/cpu_control_asm.S |   13 +++++++++----
 2 files changed, 16 insertions(+), 9 deletions(-)

diff --git a/arch/mips/netlogic/xlp/cpu_control.c b/arch/mips/netlogic/xlp/cpu_control.c
index 22d667c..1962f73 100644
--- a/arch/mips/netlogic/xlp/cpu_control.c
+++ b/arch/mips/netlogic/xlp/cpu_control.c
@@ -79,8 +79,8 @@ static inline void jump_address(unsigned long entry)
 			:: "r"(entry));
 }
 
-/* Enable unaligned access - LSU Defeature: bit 30. */
-static inline void enable_unaligned(void)
+/* Configure LSU */
+static inline void config_lsu(void)
 {
 	uint32_t tmp0, tmp1, tmp2;
 	__asm__ __volatile__ (
@@ -90,6 +90,8 @@ static inline void enable_unaligned(void)
 		"mfcr    %1, %0\n"
 		"lui     %2, 0x4000\n"
 		"or      %1, %1, %2\n"
+		"li	 %2, ~0xe\n"
+		"and	 %1, %1, %2\n"
 		"mtcr    %1, %0\n"
 		".set pop\n"
 		: "=r" (tmp0), "=r" (tmp1), "=r" (tmp2)
@@ -159,9 +161,9 @@ void enable_cpus( unsigned int node, unsigned int onlinemask)
 		index+=3;
 	}
 
-		/* Enable unaligned access on Core0. */
-		if (node == 0)
-			enable_unaligned();
+	/* Configure LSU on Core0. */
+	if (node == 0)
+		config_lsu();
 
 	/* As for the threads to be enabled
 	* per core, use Core0 as a reference
diff --git a/arch/mips/netlogic/xlp/cpu_control_asm.S b/arch/mips/netlogic/xlp/cpu_control_asm.S
index 8662e16..c7a0bc2 100644
--- a/arch/mips/netlogic/xlp/cpu_control_asm.S
+++ b/arch/mips/netlogic/xlp/cpu_control_asm.S
@@ -67,13 +67,18 @@
 	.set pop
     .endm
 
-.macro __enable_unaligned
+.macro __config_lsu
 	.set push
 	.set noreorder
 	li      t0, LSU_DEFEATURE
 	mfcr    t1, t0
-	lui     t2, 0x4000  # Bit30
+
+	lui     t2, 0x4000  # Enable Unaligned Access
 	or      t1, t1, t2
+
+	li	t2, ~0xe    # S1RCM
+	and	t1, t1, t2
+
 	mtcr    t1, t0
 	.set pop
 .endm
@@ -105,8 +110,8 @@ EXPORT(reset_entry)
 	lw      t1, (SYS_CPUNONCOHERENTMODE_REG << 2)(t2)
 	sync
 
-	/* Enable unaligned access on Non-0 Cores. */
-	__enable_unaligned
+	/* Configure LSU on Non-0 Cores. */
+	__config_lsu
 
 	dla     t1, boot_siblings_start
 	dla     t2, __boot_siblings
-- 
1.7.10.4

