From 5d2453e65ab47e4694fb89570443831b6d54aed4 Mon Sep 17 00:00:00 2001
From: Jayanthi A <jayanthi.annadurai@broadcom.com>
Date: Tue, 24 Jul 2012 20:33:32 +0530
Subject: [PATCH 559/762] XLP base port: Disabled COP2 in prom_init if CONFIG_NLM_ENABLE_COP2 is not defined. Fixed config lsu

Based on Broadcom SDK 2.3.

Signed-off-by: Jayanthi A <jayanthi.annadurai@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/cpu_control.c     |    5 -----
 arch/mips/netlogic/xlp/cpu_control_asm.S |    3 +--
 arch/mips/netlogic/xlp/setup.c           |    5 +++--
 3 files changed, 4 insertions(+), 9 deletions(-)

diff --git a/arch/mips/netlogic/xlp/cpu_control.c b/arch/mips/netlogic/xlp/cpu_control.c
index 3f95734..04c664a 100644
--- a/arch/mips/netlogic/xlp/cpu_control.c
+++ b/arch/mips/netlogic/xlp/cpu_control.c
@@ -134,11 +134,6 @@ static void enable_cores(unsigned int node, unsigned int cores_bitmap)
                         nlm_hal_write_32bit_reg(sys_mmio, 0x4E, value);
                 }
 
-		/* Enable CPU clock
-		 */
-		value = nlm_hal_read_32bit_reg(sys_mmio,0x4E) & ~core;
-		nlm_hal_write_32bit_reg(sys_mmio, 0x4E, value);
-
 		/* Remove CPU Reset */
 		value = nlm_hal_read_32bit_reg(sys_mmio, 0x4B) & ~core;
 		nlm_hal_write_32bit_reg(sys_mmio, 0x4B, value);
diff --git a/arch/mips/netlogic/xlp/cpu_control_asm.S b/arch/mips/netlogic/xlp/cpu_control_asm.S
index 5c01250..41d6f83 100644
--- a/arch/mips/netlogic/xlp/cpu_control_asm.S
+++ b/arch/mips/netlogic/xlp/cpu_control_asm.S
@@ -83,12 +83,11 @@
 .macro __config_lsu
 	.set push
 	.set noreorder
-	li      t0, LSU_DEFEATURE
-
         li      t0, SCHED_DEFEATURE
         lui     t1, 0x0100 # Experimental: Disable BRU accepting ALU ops
         mtcr    t1, t0
 
+	li      t0, LSU_DEFEATURE
 	mfcr    t1, t0
 	lui     t2, 0x4080  # Enable Unaligned Access, L2HPE
 	or      t1, t1, t2
diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index 56db462..002dbf1 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -788,9 +788,7 @@ void __init build_node_cpu_map(void)
 
 void __init prom_init(void)
 {
-#ifdef CONFIG_NLM_ENABLE_COP2
 	unsigned int c0status;
-#endif
 
 #ifdef CONFIG_MAPPED_KERNEL
 	setup_mapped_kernel_tlbs(TRUE, TRUE);
@@ -815,6 +813,9 @@ void __init prom_init(void)
 	// workaround. trap_init enables cop2. But this function gets called before trap_init
 	c0status = read_c0_status() | ST0_CU2;
 	write_c0_status(c0status);
+#else
+	c0status = read_c0_status() & ~ST0_CU2;
+	write_c0_status(c0status);
 #endif
 	cpumask_clear(&smp_boot.online_map);
 	cpumask_set_cpu(hard_smp_processor_id(), &smp_boot.online_map);
-- 
1.7.0.4

