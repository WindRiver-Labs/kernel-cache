From ec2c8c6f918f4ea6bd8240bb067a4f919f611d74 Mon Sep 17 00:00:00 2001
From: Anurag <anurag.gopinath@broadcom.com>
Date: Fri, 13 Jul 2012 19:32:49 +0530
Subject: [PATCH 575/761] Fix : Use HAL cpu freq calculation functions in
 Linux

Use HAL cpu freq calculation functions in Linux, instead
of having separate function in Linux

Based on Broadcom SDK 2.3.

Signed-off-by: Anurag <anurag.gopinath@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/Makefile                                 |    2 +-
 .../asm/netlogic/xlp8xx/cpu_control_macros.h       |    4 +--
 arch/mips/kernel/proc.c                            |    1 +
 arch/mips/netlogic/xlp/cpu_control.c               |   31 --------------------
 arch/mips/netlogic/xlp/time.c                      |    3 +-
 5 files changed, 6 insertions(+), 35 deletions(-)

diff --git a/arch/mips/Makefile b/arch/mips/Makefile
index 7579cd1..3a872f4 100644
--- a/arch/mips/Makefile
+++ b/arch/mips/Makefile
@@ -212,7 +212,7 @@ include $(srctree)/arch/mips/Kbuild.platforms
 # NETLOGIC XLP Soc, Simulator and boards
 #
 core-$(CONFIG_NLM_XLP) 		+= arch/mips/netlogic/boot/
-cflags-$(CONFIG_NLM_XLP)	+= -I$(srctree)/arch/mips/include/asm/netlogic/hal
+cflags-$(CONFIG_NLM_XLP)	+= -I$(srctree)/arch/mips/include/asm/netlogic/hal -DNLM_HAL_LINUX_KERNEL
 cflags-$(CONFIG_NLM_XLP)	+= -I$(srctree)/arch/mips/netlogic/boot
 cflags-$(CONFIG_NLMCOMMON)    	+= -DXLP -I$(srctree)/arch/mips/include/asm/mach-netlogic
 cflags-$(CONFIG_NLMCOMMON)    	+= -I$(srctree)/arch/mips/include/asm/netlogic
diff --git a/arch/mips/include/asm/netlogic/xlp8xx/cpu_control_macros.h b/arch/mips/include/asm/netlogic/xlp8xx/cpu_control_macros.h
index e851b4a..3358235 100644
--- a/arch/mips/include/asm/netlogic/xlp8xx/cpu_control_macros.h
+++ b/arch/mips/include/asm/netlogic/xlp8xx/cpu_control_macros.h
@@ -5,6 +5,7 @@
 #define __CPUCONTROL_MACROS_H__
 #include <asm/netlogic/xlp8xx/cpu.h>
 #include <asm/netlogic/xlp8xx/xlp_sys.h>
+
 #define CP0_EBASE	$15
 #ifdef CONFIG_64BIT
 #define NMI_BASE    	0xffffffffbfc00000UL
@@ -22,13 +23,12 @@
 #ifndef __ASSEMBLY__
 #define	 XLP_THREADS_PER_CORE	4
 #define  XLP_CORES_PER_NODE	7
-u32 get_cpu_freq(int);
 void enable_cpus(unsigned int, unsigned int);
 u32 get_core_dfs(int);
 u32 change_cpu_freq(int, int);
 extern int xlp8xx_a01_workaround_needed;
 #define get_cpu_freq_masked(cpu_num, mask)\
-	((get_cpu_freq(cpu_num)/1000ULL) & (mask))
+	((nlm_hal_cpu_freq()/1000ULL) & (mask))
 #define XLP_FREQ_MASK	(0xfffffff0)
 #define XLP_CPU0	0
 #endif	// __ASSEMBLY__
diff --git a/arch/mips/kernel/proc.c b/arch/mips/kernel/proc.c
index e1af073..4b4ce88 100644
--- a/arch/mips/kernel/proc.c
+++ b/arch/mips/kernel/proc.c
@@ -14,6 +14,7 @@
 #include <asm/processor.h>
 #include <asm/mips_machine.h>
 #ifdef CONFIG_NLM_XLP
+#include <asm/netlogic/hal/nlm_hal.h>
 #include <asm/netlogic/xlp8xx/cpu_control_macros.h>
 #endif
 
diff --git a/arch/mips/netlogic/xlp/cpu_control.c b/arch/mips/netlogic/xlp/cpu_control.c
index acb6326..057f475 100644
--- a/arch/mips/netlogic/xlp/cpu_control.c
+++ b/arch/mips/netlogic/xlp/cpu_control.c
@@ -264,37 +264,6 @@ static uint64_t get_pll_freq(int divf,int divr)
 	return hz_freq;
 }
 
-/* Return frequency in Hz
- */
-u32 get_cpu_freq(int cpu_num)
-{
-	volatile u32* mmio;
-	uint64_t pll_freq;
-	u32 pwron_rst_reg;
-	u32 core_dfs, divf, divr, dfs, core, ext_div;
-	mmio = (volatile u32 *) cpu_io_mmio(cpu_num/32,SYS);
-
-	pwron_rst_reg = nlm_hal_read_32bit_reg((uint64_t)mmio, SYS_POWERONRESETCFG);
-        if (!is_cpu_core_xlp_ii) {
-                core_dfs      = nlm_hal_read_32bit_reg((uint64_t)mmio, SYS_COREDFSDIVCTRL);
-                core          = cpu_num >> 2;
-
-                divf = SYS_PWRON_DIVF(pwron_rst_reg);
-                divr = SYS_PWRON_DIVR(pwron_rst_reg);
-                ext_div = SYS_PWRON_EXTDIV(pwron_rst_reg) + 1;
-                dfs  = SYS_CORE_DFS(core_dfs,core) + 1;
-
-                pll_freq = get_pll_freq(divf,divr);
-                do_div( pll_freq, ((uint64_t)(ext_div * dfs)));
-	}
-	else {
-		pll_freq = (400 + 33 * (pwron_rst_reg >> 26)) * 1024 * 1024ULL;
-	}
-	return ((u32) pll_freq);
-}
-
-EXPORT_SYMBOL(get_cpu_freq);
-
 u32 get_core_dfs(int cpu_num)
 {
 	u32 core_dfs, dfs;
diff --git a/arch/mips/netlogic/xlp/time.c b/arch/mips/netlogic/xlp/time.c
index acfffeb..ae6962e 100644
--- a/arch/mips/netlogic/xlp/time.c
+++ b/arch/mips/netlogic/xlp/time.c
@@ -31,6 +31,7 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #include <asm/netlogic/xlp_irq.h>
 #include <asm/netlogic/xlp_hal_pic.h>
 #include <asm/netlogic/xlp8xx/cpu_control_macros.h>
+#include <asm/netlogic/hal/nlm_hal.h>
 
 extern spinlock_t xlp_pic_lock;
 
@@ -64,7 +65,7 @@ unsigned int __cpuinit get_c0_compare_int(void)
 
 void __init plat_time_init(void)
 {
-	mips_hpt_frequency = (unsigned int) get_cpu_freq(XLP_CPU0);
+	mips_hpt_frequency = (unsigned int) nlm_hal_cpu_freq();
 	pr_info("mips_hpt_frequency = %u\n", mips_hpt_frequency);
 	xlp_timer_setup();
 
-- 
1.7.10.4

