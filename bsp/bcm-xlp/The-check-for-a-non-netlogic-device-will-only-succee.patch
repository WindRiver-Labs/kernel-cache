From 95b9eee5980337394f684eb69020865181a0f26b Mon Sep 17 00:00:00 2001
From: Om Narasimhan <onarasimhan@netlogicmicro.com>
Date: Wed, 7 Sep 2011 11:11:26 -0700
Subject: [PATCH 325/761] The check for a non-netlogic device will only
 succeed if the device id is less than 0x1000 due to
 which SATA controller didn't work. Modified to
 check for ids greater than 0x1018 as well.

Based on Broadcom SDK 2.3.

Signed-off-by: Om Narasimhan <onarasimhan@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/pci/probe.c |    9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/drivers/pci/probe.c b/drivers/pci/probe.c
index 690384e..6e9843b 100644
--- a/drivers/pci/probe.c
+++ b/drivers/pci/probe.c
@@ -242,9 +242,14 @@ static u32 nlm_xlp_membar_fixup(u32 l, struct pci_dev *dev,
 			(rev == XLP_REVISION_A2))){
 		return l;
 	}
-	if ((dev->vendor != PCI_VENDOR_ID_NETLOGIC) &&
-			(dev->device < XLP_PCI_DEV_BASE))
+	/* If not xlp chip or if the device < 0x1000 skip this device.
+	 * (XLP onchip devices start with device id 0x1000) and this fix
+	 * is applicable only to onchip devices
+	 */
+	if ((dev->vendor != PCI_VENDOR_ID_NETLOGIC) ||
+			(dev->device < XLP_PCI_DEV_BASE)) {
 		return l;
+	}
 	if (type == pci_bar_unknown) {
 		if ((l & PCI_BASE_ADDRESS_SPACE) == PCI_BASE_ADDRESS_SPACE_MEMORY) {
 			if ((l & ~PCI_BASE_ADDRESS_MEM_MASK) & PCI_BASE_ADDRESS_MEM_TYPE_64)
-- 
1.7.10.4

