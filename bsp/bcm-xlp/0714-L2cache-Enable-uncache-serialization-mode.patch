From ccbf05f20c41bcd533a7433e6319b56a387e18c2 Mon Sep 17 00:00:00 2001
From: Ashok Kumar <ashoks@broadcom.com>
Date: Mon, 25 Mar 2013 17:27:19 +0530
Subject: [PATCH 714/762] L2cache: Enable uncache serialization mode.

Based on Broadcom SDK 2.3.

Signed-off-by: Ashok Kumar <ashoks@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 .../asm/netlogic/xlp8xx/cpu_control_macros.h       |    2 ++
 arch/mips/netlogic/xlp/cpu_control.c               |   12 ++++++++++--
 arch/mips/netlogic/xlp/cpu_control_asm.S           |    4 ++++
 3 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/arch/mips/include/asm/netlogic/xlp8xx/cpu_control_macros.h b/arch/mips/include/asm/netlogic/xlp8xx/cpu_control_macros.h
index a8c6afd..8c944c0 100644
--- a/arch/mips/include/asm/netlogic/xlp8xx/cpu_control_macros.h
+++ b/arch/mips/include/asm/netlogic/xlp8xx/cpu_control_macros.h
@@ -20,6 +20,8 @@
 #define MMU_SETUP 0x400
 #define SCHED_DEFEATURE 0x700
 
+#define L2_FEATURE_CTRL0 0x800
+
 #ifndef __ASSEMBLY__
 #define	 XLP_THREADS_PER_CORE	4
 #define  XLP_CORES_PER_NODE	7
diff --git a/arch/mips/netlogic/xlp/cpu_control.c b/arch/mips/netlogic/xlp/cpu_control.c
index 9be1a7e..718fee0 100644
--- a/arch/mips/netlogic/xlp/cpu_control.c
+++ b/arch/mips/netlogic/xlp/cpu_control.c
@@ -94,6 +94,10 @@ static inline void config_lsu(void)
 			"li      %0, "STR(SCHED_DEFEATURE)"\n"
 			"lui     %1, 0x0100\n"
 			"mtcr    %1, %0\n"
+			"li      %0, "STR(L2_FEATURE_CTRL0)"\n"
+			"mfcr    %1, %0\n"
+			"ori    %1, %1, 0x200\n"
+			"mtcr    %1, %0\n"
 			".set pop\n"
 			: "=r" (tmp0), "=r" (tmp1), "=r" (tmp2)
 		);
@@ -107,8 +111,12 @@ static inline void config_lsu(void)
 			"or      %1, %1, %2\n"
 			"mtcr    %1, %0\n"
 			"li      %0, "STR(SCHED_DEFEATURE)"\n"
-                        "lui     %1, 0x0100\n"
-                        "mtcr    %1, %0\n"
+			"lui     %1, 0x0100\n"
+			"mtcr    %1, %0\n"
+			"li      %0, "STR(L2_FEATURE_CTRL0)"\n"
+			"mfcr    %1, %0\n"
+			"ori    %1, %1, 0x200\n"
+			"mtcr    %1, %0\n"
 			".set pop\n"
 			: "=r" (tmp0), "=r" (tmp1), "=r" (tmp2)
 		);
diff --git a/arch/mips/netlogic/xlp/cpu_control_asm.S b/arch/mips/netlogic/xlp/cpu_control_asm.S
index 20c9bef..45e9eb7 100644
--- a/arch/mips/netlogic/xlp/cpu_control_asm.S
+++ b/arch/mips/netlogic/xlp/cpu_control_asm.S
@@ -103,6 +103,10 @@
 	mtcr    t1, t0
 
 10:
+	li      t0, L2_FEATURE_CTRL0
+	mfcr    t1, t0
+	ori      t1, t1, 0x200
+	mtcr    t1, t0
 
 	.set pop
 .endm
-- 
1.7.0.4

