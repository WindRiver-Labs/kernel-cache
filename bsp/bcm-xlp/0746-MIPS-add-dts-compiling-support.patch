From 2c0b67ed55bdbc04b93149c832d30c40a4e9b807 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Tue, 28 May 2013 15:59:17 +0800
Subject: [PATCH 746/762] MIPS: add dts compiling support

Allows to put the dts file to arch/mips/boot/dts/ and compile it with
the following command:

$ make <dts-file-name>.dtb

It is based on the powerpc implementation.

Based on Broadcom SDK 2.3.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/Kconfig       |    3 +++
 arch/mips/Makefile      |    7 ++++++-
 arch/mips/boot/Makefile |    9 +++++++++
 3 files changed, 18 insertions(+), 1 deletions(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index e6d0ff8..a563fe5 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -2503,6 +2503,9 @@ config STACKTRACE_SUPPORT
 	bool
 	default y
 
+config DTC
+	def_bool y
+
 source "init/Kconfig"
 
 source "kernel/Kconfig.freezer"
diff --git a/arch/mips/Makefile b/arch/mips/Makefile
index 784fe65..c36487e 100644
--- a/arch/mips/Makefile
+++ b/arch/mips/Makefile
@@ -296,6 +296,8 @@ vmlinux.32: vmlinux
 # gcc461 supports the below option, gcc445 does not
 cflags-$(CONFIG_CPU_XLP)    += $(call cc-option,-Wno-error=unused-but-set-variable)
 
+boot := arch/$(ARCH)/boot
+
 #
 # The 64-bit ELF tools are pretty broken so at this time we generate 64-bit
 # ELF files from 32-bit files by conversion.
@@ -315,7 +317,7 @@ vmlinuz vmlinuz.bin vmlinuz.ecoff vmlinuz.srec: $(vmlinux-32) FORCE
 	   VMLINUX_LOAD_ADDRESS=$(load-y) 32bit-bfd=$(32bit-bfd) $@
 
 
-CLEAN_FILES += vmlinux.32 vmlinux.64 vmlinuz 
+CLEAN_FILES += vmlinux.32 vmlinux.64 vmlinuz  *.dtb
 
 archprepare:
 ifdef CONFIG_MIPS32_N32
@@ -340,6 +342,9 @@ archclean:
 	$(Q)$(MAKE) $(clean)=arch/mips/boot/compressed
 	$(Q)$(MAKE) $(clean)=arch/mips/lasat
 
+%.dtb:
+	$(Q)$(MAKE) ARCH=mips $(build)=$(boot) $(patsubst %,$(boot)/%,$@)
+
 define archhelp
 	echo '  install              - install kernel into $(INSTALL_PATH)'
 	echo '  vmlinux.ecoff        - ECOFF boot image'
diff --git a/arch/mips/boot/Makefile b/arch/mips/boot/Makefile
index 85bcb5a..787aa57 100644
--- a/arch/mips/boot/Makefile
+++ b/arch/mips/boot/Makefile
@@ -40,3 +40,12 @@ quiet_cmd_srec = OBJCOPY $@
       cmd_srec = $(OBJCOPY) -S -O srec $(strip-flags) $(VMLINUX) $@
 $(obj)/vmlinux.srec: $(VMLINUX) FORCE
 	$(call if_changed,srec)
+
+# Rule to build device tree blobs
+ifndef CONFIG_CPU_XLP
+DTS_FLAGS ?= -p 1024
+endif
+dtstree		:= $(srctree)/$(src)/dts
+
+$(obj)/%.dtb: $(src)/dts/%.dts FORCE
+	$(call if_changed_dep,dtc)
-- 
1.7.0.4

