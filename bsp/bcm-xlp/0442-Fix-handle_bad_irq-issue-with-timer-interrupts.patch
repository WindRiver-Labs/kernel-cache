From 692d0d8aea3d75f1ed42b39fc3fa515b0ba26a25 Mon Sep 17 00:00:00 2001
From: Zi Shen Lim <zlim@netlogicmicro.com>
Date: Thu, 6 Oct 2011 11:14:09 -0700
Subject: [PATCH 442/762] Fix handle_bad_irq issue with timer interrupts.

Install handler for cpu interrupts, mimic XLR code in mainline.

Based on Broadcom SDK 2.3.

Signed-off-by: Zi Shen Lim <zlim@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/irq.c |   24 +++++++++++++++++++++++-
 1 files changed, 23 insertions(+), 1 deletions(-)

diff --git a/arch/mips/netlogic/xlp/irq.c b/arch/mips/netlogic/xlp/irq.c
index 0495c04..c7ef077 100644
--- a/arch/mips/netlogic/xlp/irq.c
+++ b/arch/mips/netlogic/xlp/irq.c
@@ -1473,6 +1473,24 @@ EXPORT_SYMBOL(arch_setup_msi_irqs);
 #endif
 #endif /* CONFIG_PCI_MSI_XLP */
 
+#define PIC_IRQ_BASE XLP_IRQ_RESERVED_MAX
+
+static void rsvd_irq_handler(struct irq_data *d)
+{
+	WARN(d->irq >= PIC_IRQ_BASE, "Bad irq %d", d->irq);
+}
+
+/*
+ * Chip definition for CPU originated interrupts(timer, msg) and
+ * IPIs
+ */
+struct irq_chip nlm_cpu_intr = {
+	.name           = "XLP-CPU-INTR",
+	.irq_enable     = rsvd_irq_handler,
+	.irq_mask       = rsvd_irq_handler,
+	.irq_ack        = rsvd_irq_handler,
+};
+
 static inline void irq_desc_set_chip(struct irq_desc *desc, struct irq_chip *chip)
 {
 	irq_desc_get_irq_data(desc)->chip = chip;
@@ -1483,7 +1501,11 @@ void __init init_nlm_common_irqs(void)
 	int i;
 
 	for (i = 0; i < XLP_IRQ_MAX; i++) {	// IRQ : 0 - 167
-		irq_set_chip(i, &nlm_irq_pic);
+		if (i >= PIC_IRQ_BASE)
+			irq_set_chip(i, &nlm_irq_pic);
+		else
+			irq_set_chip_and_handler(i, &nlm_cpu_intr,
+						 handle_percpu_irq);
 	}
 #ifdef CONFIG_PCI_MSI_XLP
 	for (i = XLP_MSI_INDEX_START; i <= XLP_MSI_INDEX_END; i++) {
-- 
1.7.0.4

