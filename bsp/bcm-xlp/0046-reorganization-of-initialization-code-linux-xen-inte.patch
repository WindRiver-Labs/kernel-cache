From f60c38e04de1d97a2c8af456f046629932637fcd Mon Sep 17 00:00:00 2001
From: Prasad Boddupalli <pboddupalli@netlogicmicro.com>
Date: Tue, 29 Jun 2010 12:28:17 -0700
Subject: [PATCH 046/762] reorganization of initialization code linux-xen interface

The shared info page must be set early in the Linux bootup so that
calls to Xen (such as triggering secondary cpus) can be made earlier
than is permitted before this change. In the process, removed dead
/commented out code and removed debugging printks

Based on Broadcom SDK 2.3.

Signed-off-by: Prasad Boddupalli <pboddupalli@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/xenbootinfo.c |    4 ++++
 arch/mips/xen/enlighten.c            |   23 +----------------------
 2 files changed, 5 insertions(+), 22 deletions(-)

diff --git a/arch/mips/netlogic/xlp/xenbootinfo.c b/arch/mips/netlogic/xlp/xenbootinfo.c
index c1022b4..6f249b2 100644
--- a/arch/mips/netlogic/xlp/xenbootinfo.c
+++ b/arch/mips/netlogic/xlp/xenbootinfo.c
@@ -14,6 +14,8 @@
 
 extern char _end[];
 
+extern void xen_setup_shared_info(void);
+
 int fdt_process(void)
 {
 #if defined(CONFIG_NLM_XLP_SIM)
@@ -38,6 +40,8 @@ int fdt_process(void)
 	add_memory_region(DEF_PHYMEM_START_ADDR, 
 					  DEF_PHYMEM_SIZE - 512, (long)BOOT_MEM_RAM);
 
+	xen_setup_shared_info();
+
 	return 0;
 }
 
diff --git a/arch/mips/xen/enlighten.c b/arch/mips/xen/enlighten.c
index 9b780c1..9fda1eb 100644
--- a/arch/mips/xen/enlighten.c
+++ b/arch/mips/xen/enlighten.c
@@ -147,26 +147,15 @@ static void __init xen_banner(void)
 
 	HYPERVISOR_console_io(CONSOLEIO_write, strlen(banner), banner);
 
-//	printk(KERN_INFO "Booting paravirtualized kernel on Xen\n");
-
-#if 0
-	printk(KERN_INFO "Xen version: %d.%d%s%s%s\n",
-	       version >> 16, version & 0xffff, extra.extraversion,
-	       xen_feature(XENFEAT_mmu_pt_update_preserve_ad) ?
-			" (preserve-AD)" : "",
-	       xen_initial_domain() ? " (dom0)" : "");
-#else
 	printk(KERN_INFO "Xen version: %d.%d%s%s\n",
 	       version >> 16, version & 0xffff, extra.extraversion,
 	       xen_initial_domain() ? " (dom0)" : "");
-#endif
 }
 
 void xen_setup_shared_info(void)
 {
 	HYPERVISOR_shared_info =
 		(struct shared_info *) xen_start_info->shared_info;
-//		(struct shared_info *)__va(xen_start_info->shared_info);
 
 #ifndef CONFIG_SMP
 	/* In UP this is as good a place as any to set up shared info */
@@ -174,7 +163,7 @@ void xen_setup_shared_info(void)
 #endif
 }
 
-#if 0
+#ifndef CONFIG_SMP
 /* This is called once we have the cpu_possible_map */
 void xen_setup_vcpu_info_placement(void)
 {
@@ -263,16 +252,6 @@ static int __init xen_start_kernel(void)
 {
 	xen_domain_type = XEN_PV_DOMAIN;
 
-	printk("[%s@%d] magic=\"%s\"\n", __FUNCTION__, __LINE__, xen_start_info->magic);
-	BUG_ON(memcmp(xen_start_info->magic, "xen-3.0-mips", 5) != 0);
-
-	printk("[%s@%d]\n", __FUNCTION__, __LINE__);
-/* 	xen_setup_features(); */
-
-	printk("[%s@%d] pt_base=%lx\n", __FUNCTION__, __LINE__, xen_start_info->pt_base);
-
-	xen_setup_shared_info();
-
 	/* Don't do the full vcpu_info placement stuff until we have a
 	   possible map and a non-dummy shared_info. */
 	per_cpu(xen_vcpu, 0) = &HYPERVISOR_shared_info->vcpu_info[0];
-- 
1.7.0.4

