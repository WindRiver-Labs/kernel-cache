From fd1810cb54dae55625c9d3aca7db98dd374cccfc Mon Sep 17 00:00:00 2001
From: henry shao <hshao@netlogicmicro.com>
Date: Sun, 30 May 2010 16:01:01 -0700
Subject: [PATCH 049/762] change xlr_linux_cpu_mask to xlp_linux_cpu_mask

Based on Broadcom SDK 2.3.

Signed-off-by: henry shao <hshao@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/smp.c |   29 ++++++++++++++++++++++++++++-
 1 files changed, 28 insertions(+), 1 deletions(-)

diff --git a/arch/mips/netlogic/xlp/smp.c b/arch/mips/netlogic/xlp/smp.c
index e884e4c..e99f85c 100644
--- a/arch/mips/netlogic/xlp/smp.c
+++ b/arch/mips/netlogic/xlp/smp.c
@@ -223,7 +223,7 @@ void prom_boot_cpus_secondary(void *args)
 #ifdef CONFIG_NLM_XLP
 
 extern void prom_pre_boot_secondary_cpus(void *);
-extern uint32_t xlr_linux_cpu_mask;
+extern uint32_t xlp_linux_cpu_mask;
  
 #ifdef CONFIG_MAPPED_KERNEL
 #define secondary_cpus_bootup_func \
@@ -237,6 +237,33 @@ int wakeup_secondary_cpus(void)
 {
 	printk("Enabling CPU Mask [0x%x]\n", onlinemask);
 	enable_cpus(onlinemask);
+	__u32 wakeup_mask;
+#if defined(CONFIG_NLM_XLP_SIM)
+	unsigned int wait_count = 0;
+#endif
+
+	if (xlr_loader_support) {
+		wakeup_mask = xlp_linux_cpu_mask | nlm_common_loader_mask;
+		if (wakeup != NULL)
+			wakeup((void *)secondary_cpus_bootup_func, 0, wakeup_mask);
+	} 
+	else {
+		if (wakeup != NULL) {
+			wakeup((void *)secondary_cpus_bootup_func, 0, 
+				   (__u32)prom_info->nlm_cpu_online_map & (~smp_boot.online_map));
+#if defined(CONFIG_NLM_XLP_SIM)
+			while (smp_boot.online_map != prom_info->nlm_cpu_online_map) {
+				if ((wait_count++ % 1000000) == 0) {
+					printk("[%s%d]: Master cpu waiting for slave cpus to wakeup from bootloader (%x != %llx)\n",
+					       __FUNCTION__, __LINE__, smp_boot.online_map, 
+						   (unsigned long long) prom_info->nlm_cpu_online_map);
+				}
+			}
+			printk("[%s@%d]: woke up prom_info->nlm_cpu_online_map=%016llx\n", __FILE__, __LINE__, 
+				   (unsigned long long) prom_info->nlm_cpu_online_map);
+#endif
+		}
+	}
 
 	return 0;
 }
-- 
1.7.0.4

