From 005eac74b3961e1a08a14feb2327321476c43b9d Mon Sep 17 00:00:00 2001
From: Zi Shen Lim <zlim@netlogicmicro.com>
Date: Mon, 6 Feb 2012 15:33:10 -0800
Subject: [PATCH 537/762] XLP: register msgring interrupt handler

Based on Broadcom SDK 2.3.

Signed-off-by: Zi Shen Lim <zlim@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/irq.c     |    2 ++
 arch/mips/netlogic/xlp/on_chip.c |   14 ++++++++++++++
 2 files changed, 16 insertions(+), 0 deletions(-)

diff --git a/arch/mips/netlogic/xlp/irq.c b/arch/mips/netlogic/xlp/irq.c
index 56c3600..f5e864c 100644
--- a/arch/mips/netlogic/xlp/irq.c
+++ b/arch/mips/netlogic/xlp/irq.c
@@ -260,6 +260,8 @@ static void xlp_pic_irt_setup(int irt, int rvec)
 		pr_info("(%s) cpu=%3d irt=%3d rvec=%2d\n", __func__, cpu, irt, rvec);
 }
 
+extern void msgring_irq_init(void);
+
 static void __init init_xlp_irqs(void)
 {
 	int irt;
diff --git a/arch/mips/netlogic/xlp/on_chip.c b/arch/mips/netlogic/xlp/on_chip.c
index bcc0612..295c47c 100644
--- a/arch/mips/netlogic/xlp/on_chip.c
+++ b/arch/mips/netlogic/xlp/on_chip.c
@@ -637,7 +637,21 @@ static int xlp_napi_fmn_setup(void)
 	return 0;
 }
 
+static irqreturn_t msgring_irq_handler(int irq, void *dev_id)
+{
+	nlm_xlp_msgring_int_handler(irq, NULL);
+	return IRQ_HANDLED;
+}
 
+void msgring_irq_init(void)
+{
+	if (request_irq(XLP_IRQ_MSGRING, msgring_irq_handler,
+			IRQF_PERCPU | IRQF_NO_THREAD,
+			"FMN", NULL)) {
+		panic("Cannot request_irq(XLP_IRQ_MSGRING)\n");
+	}
+}
+EXPORT_SYMBOL(msgring_irq_init);
 
 /*********************************************************************
  * on_chip_init
-- 
1.7.0.4

