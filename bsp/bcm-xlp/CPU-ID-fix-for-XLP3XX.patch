From 59ca6586255f371753e224cb394d0c331d56bbb9 Mon Sep 17 00:00:00 2001
From: Vikas Gupta <vikasg@netlogicmicro.com>
Date: Thu, 28 Jul 2011 14:57:01 +0530
Subject: [PATCH 303/761] CPU-ID fix for XLP3XX.

Based on Broadcom SDK 2.3.

Signed-off-by: Vikas Gupta <vikasg@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/netlogic/xlp.h |    9 ++++++---
 arch/mips/netlogic/xlp/setup.c       |   28 ++++++++++++++++++++--------
 2 files changed, 26 insertions(+), 11 deletions(-)

diff --git a/arch/mips/include/asm/netlogic/xlp.h b/arch/mips/include/asm/netlogic/xlp.h
index cbb1ab8..997d856 100644
--- a/arch/mips/include/asm/netlogic/xlp.h
+++ b/arch/mips/include/asm/netlogic/xlp.h
@@ -36,9 +36,12 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #define CHIP_PROCESSOR_ID_XLP_432   0x90
 #define CHIP_PROCESSOR_ID_XLP_416   0x94
 #define CHIP_PROCESSOR_ID_XLP_408   0x95
-#define CHIP_PROCESSOR_ID_XLP_316   0xD4
-#define CHIP_PROCESSOR_ID_XLP_308   0xD5
-#define CHIP_PROCESSOR_ID_XLP_304   0xD7
+
+/*3XX series*/
+#define CHIP_PROCESSOR_ID_XLP_3XX   0x11
+	#define CHIP_PROCESSOR_ID_XLP_316   0x00	
+	#define CHIP_PROCESSOR_ID_XLP_308   0x11
+	#define CHIP_PROCESSOR_ID_XLP_304   0x11
 #define CHIP_PROCESSOR_ID_XLP_208   0xB5
 #define CHIP_PROCESSOR_ID_XLP_204   0xB7
 #define CHIP_PROCESSOR_ID_XLP_104   0xF7
diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index 9f62e962..631989d 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -671,6 +671,7 @@ noloadermask:
 
 static int get_xlp_proc_name(void)
 {
+	unsigned int cfg0;
 	int processor_id = ((read_c0_prid() & 0xff00) >> 8);
 
 	switch (processor_id) {
@@ -690,14 +691,25 @@ static int get_xlp_proc_name(void)
 	case CHIP_PROCESSOR_ID_XLP_408:
 		strcpy(cpu_model_info, "XLP408");
 		break;
-	case CHIP_PROCESSOR_ID_XLP_316:
-		strcpy(cpu_model_info, "XLP316");
-		break;
-	case CHIP_PROCESSOR_ID_XLP_308:
-		strcpy(cpu_model_info, "XLP308");
-		break;
-	case CHIP_PROCESSOR_ID_XLP_304:
-		strcpy(cpu_model_info, "XLP304");
+	case CHIP_PROCESSOR_ID_XLP_3XX:
+		strcpy(cpu_model_info, "XLP3");
+		cfg0 = nlm_hal_read_32bit_reg((((KSEG1 + 0x18000000 + 0x35000) & 0x1fffffff) + 0x100), (EFUSE_DEVICE_CFG0));
+		switch (cfg0 & 0xf){
+			case CPU_XLP_316:
+				strcat(cpu_model_info, "16");
+				break;
+			case CPU_XLP_308:
+				strcat(cpu_model_info, "08");
+				break;
+			case CPU_XLP_304:
+				strcat(cpu_model_info, "04");
+				break;
+			default:
+				strcat(cpu_model_info, "??");
+				break;
+
+		}
+		
 		break;
 	case CHIP_PROCESSOR_ID_XLP_208:
 		strcpy(cpu_model_info, "XLP208");
-- 
1.7.10.4

