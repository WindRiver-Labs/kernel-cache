From a74742c24278cf513cfdf13329463920ecaa4bed Mon Sep 17 00:00:00 2001
From: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Date: Thu, 30 Sep 2010 15:32:35 -0700
Subject: [PATCH 188/762] Enable Machine Check exception, TLB/MMU config A0 bug workaround, use hal based cpu freq call

Based on Broadcom SDK 2.3.

Signed-off-by: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/cpu_control_asm.S    |    7 ++++++-
 arch/mips/netlogic/xlp/cpu_control_macros.h |    1 +
 arch/mips/netlogic/xlp/setup.c              |    2 +-
 3 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/arch/mips/netlogic/xlp/cpu_control_asm.S b/arch/mips/netlogic/xlp/cpu_control_asm.S
index 20a6a1d..8662e16 100644
--- a/arch/mips/netlogic/xlp/cpu_control_asm.S
+++ b/arch/mips/netlogic/xlp/cpu_control_asm.S
@@ -23,6 +23,12 @@
 	 * cpus for KSEG2 access
 	 */
 	.macro 	SETUP_PERTHREAD_TLB
+       /*
+        * Dummy write for A0 bug in MMU
+        */
+        li      t0, MMU_SETUP
+        mtcr    zero, t0
+        ehb
 	dli     t3, CKSSEG
 	dmtc0   t3, CP0_ENTRYHI
 	li      t1, 0x1f
@@ -40,7 +46,6 @@
 
 	.macro 	__start_secondary
 	.set push
-	SET_MIPS64
 	SETUP_PERTHREAD_TLB
 #ifdef CONFIG_64BIT
 	prog_c0_status ST0_KX ST0_BEV
diff --git a/arch/mips/netlogic/xlp/cpu_control_macros.h b/arch/mips/netlogic/xlp/cpu_control_macros.h
index 55450ab..aebf7ea 100644
--- a/arch/mips/netlogic/xlp/cpu_control_macros.h
+++ b/arch/mips/netlogic/xlp/cpu_control_macros.h
@@ -34,6 +34,7 @@
 #define CPU_BLOCKID_FPU                         9
 
 #define LSU_DEFEATURE 0x304
+#define MMU_SETUP 0x400
 
 /* ----------------------------------
  *   XLP RESET Physical Address Map
diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index 2f4a4cb..c61a277 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -301,7 +301,7 @@ unsigned int __cpuinit get_c0_compare_int(void)
 void plat_time_init(void)
 {
 	extern void nlm_common_timer_setup(void);
-	mips_hpt_frequency = (unsigned int)0x5f5e1000;
+	mips_hpt_frequency = (unsigned int) nlm_hal_cpu_freq();
 	printk("mips_hpt_frequency = %u\n", mips_hpt_frequency);
 	nlm_common_timer_setup();
 }
-- 
1.7.0.4

