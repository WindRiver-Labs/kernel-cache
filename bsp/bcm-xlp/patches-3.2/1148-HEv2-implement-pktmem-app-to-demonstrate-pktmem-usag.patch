From d2f93afc86feaf30b51ef911fd1a21ab6a2ae610 Mon Sep 17 00:00:00 2001
From: Sreenidhi B R <sreenira@broadcom.com>
Date: Fri, 7 Jun 2013 17:03:45 +0530
Subject: HEv2: implement pktmem app to demonstrate pktmem usage

- alloc/free/print usage
- few fixes in pktmem kernel module
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c b/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c
index a91ee4a..6971a2a 100644
--- a/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c
+++ b/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c
@@ -36,6 +36,8 @@ enum pktmem_ops {
 	PRINT_POOL,
 };
 
+#undef PKTMEM_DEBUG
+
 static int print_memory(brcm_devmem_ioctl_t * param)
 {
 	memory_pool_t *mem;
@@ -89,7 +91,7 @@ static int alloc_memory (brcm_devmem_ioctl_t * param)
 				if (param->shr_id != NULL)
 					sprintf(mem->shr_id, param->shr_id);
 				else
-					sprintf(mem->shr_id, NULL);
+					memset(mem->shr_id, '\0', 64);
 				mem->in_use = 1;
 				alloc = 1;
 				break;
@@ -111,7 +113,7 @@ static int alloc_memory (brcm_devmem_ioctl_t * param)
 				if (param->shr_id != NULL)
 					sprintf(newmem->shr_id, param->shr_id);
 				else
-					sprintf(newmem->shr_id, NULL);
+					memset(mem->shr_id, '\0', 64);
 				newmem->in_use = 1;
 
 				param->phys_addr = newmem->start;
@@ -150,7 +152,7 @@ static int free_memory (brcm_devmem_ioctl_t * param)
 	{
 		if (param->phys_addr == mem->start)
 		{
-			sprintf(mem->shr_id, NULL);
+			memset(mem->shr_id, '\0', 64);
 			mem->in_use = 0;
 			free = 1;
 			break;
@@ -169,13 +171,17 @@ static long pktmem_ioctl (struct file *fptr, unsigned int cmd, unsigned long dp)
 	int rc;
 	brcm_devmem_ioctl_t *dptr;
 
+#ifdef PKTMEM_DEBUG
 	printk("pktmem: icoctl enter, cmd %d.\n", cmd);
+#endif
 
 	dptr = (brcm_devmem_ioctl_t *)dp;
 	rc = 0;
 
+#ifdef PKTMEM_DEBUG
 	printk("pktmem: memory map before\n");
 	print_memory(dptr);
+#endif
 
 	switch (cmd)
 	{
@@ -193,10 +199,12 @@ static long pktmem_ioctl (struct file *fptr, unsigned int cmd, unsigned long dp)
 			break;
 	}
 
+#ifdef PKTMEM_DEBUG
 	printk("pktmem: memory map after\n");
 	print_memory(dptr);
-
 	printk("pktmem: ioctl returns rc %d.\n", rc);
+#endif
+
 	return rc;
 }
 
@@ -268,7 +276,7 @@ static int __init brcm_xlp_ppm_init (void)
 				i, mem_pool_data[i].start, mem_pool_data[i].size);
 	}
 
-	printk (" brcm pkt mem module init.\n");
+	printk ("pktmem module init done.\n");
 	return 0;
 }
 
-- 
1.7.1

