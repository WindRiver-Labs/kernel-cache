From a5220058b5ecbe7b6ed709acda180a843d19da42 Mon Sep 17 00:00:00 2001
From: Tanmay Jagdale <tanmayj@broadcom.com>
Date: Thu, 27 Nov 2014 09:33:38 +0530
Subject: fdtconf: set default device frequencies

Set the default frequencies for SoC devices if the value in the device
tree is zero.
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/drivers/misc/netlogic/fdtconf/fdtconf.c b/drivers/misc/netlogic/fdtconf/fdtconf.c
index a2414b5..2e4254b 100644
--- a/drivers/misc/netlogic/fdtconf/fdtconf.c
+++ b/drivers/misc/netlogic/fdtconf/fdtconf.c
@@ -59,6 +59,17 @@
  */
 #define	UCODE_SZ	(1024 * 4)
 
+/*
+ * Default Frequency for SoC Blocks
+ */
+#define	NAE_FREQ	500
+#define	NAE_2XX_FREQ	400
+#define	SAE_FREQ	500
+#define	RSA_FREQ	500
+#define	DTRE_FREQ	500
+#define	CDE_FREQ	250
+
+
 void *fdt;
 EXPORT_SYMBOL(fdt);
 extern void *initial_boot_params;
@@ -233,6 +244,60 @@ static void parse_and_fill_kern_params(void)
 			"freein-fifo-replenish-addr-info\n");
 }
 
+
+/*
+ * Set default device frequencies.
+ */
+static void set_default_device_frequency(void)
+{
+	int	node;
+	const uint32_t *prop;
+	uint32_t	plen, val = 0;
+
+	node = fdt_path_offset(fdt, "/frequency-config");
+	if (node < 0)
+		return;
+
+	/* NAE Frequency */
+	prop = fdt_getprop(fdt, node, "nae", &plen);
+	if ((*prop == 0) || (prop == NULL)) {
+		if (is_nlm_xlp2xx())
+			val = cpu_to_fdt32(NAE_2XX_FREQ);
+		else
+			val = cpu_to_fdt32(NAE_FREQ);
+		fdt_setprop(fdt, node, "nae", &val, sizeof(val));
+	}
+
+	/* SAE Frequency */
+	prop = fdt_getprop(fdt, node, "sae", &plen);
+	if ((*prop == 0) || (prop == NULL)) {
+		val = cpu_to_fdt32(SAE_FREQ);
+		fdt_setprop(fdt, node, "sae", &val, sizeof(val));
+	}
+
+	/* RSA Frequency */
+	prop = fdt_getprop(fdt, node, "rsa", &plen);
+	if ((*prop == 0) || (prop == NULL)) {
+		val = cpu_to_fdt32(RSA_FREQ);
+		fdt_setprop(fdt, node, "rsa", &val, sizeof(val));
+	}
+
+	/* DTRE Frequency */
+	prop = fdt_getprop(fdt, node, "dtre", &plen);
+	if ((*prop == 0) || (prop == NULL)) {
+		val = cpu_to_fdt32(DTRE_FREQ);
+		fdt_setprop(fdt, node, "dtre", &val, sizeof(val));
+	}
+
+	/* CDE Frequency */
+	prop = fdt_getprop(fdt, node, "cde", &plen);
+	if ((*prop == 0) || (prop == NULL)) {
+		val = cpu_to_fdt32(CDE_FREQ);
+		fdt_setprop(fdt, node, "cde", &val, sizeof(val));
+	}
+}
+
+
 /*
  * Load ucore opcodes in the dtb.
  */
@@ -575,6 +640,12 @@ static int __init fdtconf_init(void)
 	parse_and_fill_kern_params();
 
 	/*
+	 * Add default frequency values for the devices incase they are not
+	 * set in the DTB.
+	 */
+	set_default_device_frequency();
+
+	/*
 	 * Release the dtb file.
 	 */
 	release_firmware(fw);
-- 
1.7.1

