From bd664e97f2ab313c07438abc818798e9563c9a60 Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Tue, 18 Jun 2013 13:28:03 -0700
Subject: kmod: pkt_pool_mem: make pkt_pool_mem module depends on libraries directly

   o Previous pkt_pool_mem module depends on soc_interface which itself will try
     to initialize certain I/O devices.
   o This is not suitable for virtualization guest as directly register-level
     initialization of I/O devices will trap and will not support.
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c b/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c
index 6971a2a..a64d11d 100644
--- a/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c
+++ b/drivers/misc/netlogic/pkt_pool_mem/pkt_pool_mem.c
@@ -233,12 +233,14 @@ static inline int get_fdt_prop(void *fdt, const char* node_path,
 	return 0;
 }
 
-extern void*fdt;
+extern void *initial_boot_params;
+
 /* see "pktmem" section in DTS file for providing memory */
 
 static int __init brcm_xlp_ppm_init (void)
 {
 	int i, node;
+	void *fdt;
 
 	i = register_chrdev(PKTMEM_MAJOR, "brcm_pktmem", &pktmem_ops);
 	if (i < 0)
@@ -250,6 +252,7 @@ static int __init brcm_xlp_ppm_init (void)
 	for (i=0; i<MAX_NODES*4; i++) pktregs[i] = 0;
 
 	/* read from FDT and fill the array */
+	fdt = initial_boot_params;
 	if (get_fdt_prop(fdt, "/pktmem", "reg", pktregs, 1) == 0)
 	{
 		for (i=0; i<MAX_NODES*4; i=i+4)
-- 
1.7.1

