From 7b95beebe85779f696c723d65080d4c7207dd553 Mon Sep 17 00:00:00 2001
From: Ashwin Sekhar T K <ashwin@broadcom.com>
Date: Thu, 4 Dec 2014 12:48:32 +0530
Subject: fmnlib: Fix FMN credit validation

Signed-off-by: Ashwin Sekhar T K <ashwin@broadcom.com>
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c b/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
index 86c703a..29446dd 100644
--- a/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
+++ b/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
@@ -742,12 +742,16 @@ static void fmn_validate_credit(int node, int max_nodes)
 			continue;
 		qsize = fmn_q_config[d_stn].q_size;
 		credits = 0;
-	        for(src_node = 0; src_node < max_nodes; src_node++) {
-  		    for(s_stn = 0; s_stn < max_msg_blks; s_stn++)  {
-		 	if(!fmn_q_config[s_stn].valid)
-				continue;
-			credits += (fmn_q_config[s_stn].credits[src_node][d_stn] * fmn_q_config[s_stn].n_txstns);
-                    }
+		for (src_node = 0; src_node < max_nodes; src_node++) {
+			struct fmn_qsize_credit_config *fmn_src_q_config;
+
+			fmn_src_q_config = nlm_node_cfg.fmn_cfg[src_node]->fmn_q_config;
+			for (s_stn = 0; s_stn < max_msg_blks; s_stn++)  {
+				if (!fmn_src_q_config[s_stn].valid)
+					continue;
+				credits += (fmn_src_q_config[s_stn].credits[node][d_stn] *
+					    fmn_src_q_config[s_stn].n_txstns);
+			}
 		}
 
 		/* considering single entry message only */
@@ -1242,8 +1246,18 @@ static void nlm_hal_write_fmn_credit(int node, int max_nodes)
 		}
 	}
 
-	/* Validae the credit config */
-	fmn_validate_credit(node, max_nodes);
+	/*
+	 * Validate fmn credits only after all the nodes have been configured.
+	 */
+	if (node == (max_nodes - 1)) {
+		int cur_node;
+
+		/* Validate credits for all nodes one by one */
+		for (cur_node = 0; cur_node < max_nodes; cur_node++) {
+			nlm_print("Validating credits configured for Node-%d\n", cur_node);
+			fmn_validate_credit(cur_node, max_nodes);
+		}
+	}
 }
 /*********************************************************************
  * nlm_hal_fmn_init
-- 
1.7.1

