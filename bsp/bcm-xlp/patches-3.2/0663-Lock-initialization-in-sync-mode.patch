From 89c91ce967f9eef55ac9acb6d01fffdfda6b51c4 Mon Sep 17 00:00:00 2001
From: Hareesh R <hareesh@netlogicmicro.com>
Date: Wed, 21 Dec 2011 09:35:13 +0530
Subject: Lock initialization in sync mode

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/crypto/cryptoapi.c b/crypto/cryptoapi.c
index 502ca55..dc2a674 100644
--- a/crypto/cryptoapi.c
+++ b/crypto/cryptoapi.c
@@ -173,6 +173,7 @@ nlm_crypto_ctx_t *nlm_crypto_open_sync_session(int sync_mode, int cpu, void *arg
 	ctx->max_msgs = max_outstanding_reqs;
 	ctx->rsp_pend = 0;
 	ctx->arg = (uint64_t)arg;
+	ctx->lock = 0;
 
 	if((sync_mode == NLM_CRYPTO_MODE_SYNC_EXLVC) && (iparam.sae_rx_sync_vc >= 0)) {
 		ctx->rx_vc = iparam.sae_rx_sync_vc;
@@ -185,7 +186,6 @@ nlm_crypto_ctx_t *nlm_crypto_open_sync_session(int sync_mode, int cpu, void *arg
 	}
 #ifdef NLM_CRYPTO_LINUX_U
 	else if((sync_mode == NLM_CRYPTO_MODE_SYNC_SHDVC) && (iparam.sae_rx_vc >= 0))  {
-		ctx->lock = 0;
 		ctx->rx_vc = iparam.sae_rx_vc;
 		ctx->fd = eventfd(0, 0);
 		if(ctx->fd < 0) 
diff --git a/crypto/include/cryptodev.h b/crypto/include/cryptodev.h
index c7eec0f..466f3c1 100644
--- a/crypto/include/cryptodev.h
+++ b/crypto/include/cryptodev.h
@@ -82,7 +82,7 @@ struct nlm_crypto_ctx {
 	unsigned int pad;
 
 	unsigned int rsp_pend; /* number of pending responses */
-	unsigned int lock; /* */
+	volatile unsigned int lock; /* */
 	unsigned int mhead; /* head and tail for async operation */
 	unsigned int mtail;
 
-- 
1.7.1

