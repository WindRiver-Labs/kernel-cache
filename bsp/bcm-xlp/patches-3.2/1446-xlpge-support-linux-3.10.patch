From ba12c0d146c7cd8f2598a4cf28d7c4b47e16f84d Mon Sep 17 00:00:00 2001
From: Jayachandran C <jchandra@broadcom.com>
Date: Mon, 16 Jun 2014 11:51:42 +0530
Subject: xlpge: support linux 3.10

Fixes for the API changes in Linux 3.10
 - linux/timecompare.h and the timecompare API removed, comment out
   for 3.10 compilation
 - __devinit* APIs removed in 3.8, remove these
 - create_proc_read_entry() no longer supported, comment out for 3.10
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/drivers/net/ethernet/broadcom/nae/xlpge.h b/drivers/net/ethernet/broadcom/nae/xlpge.h
index b23d579..5cc0646 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge.h
+++ b/drivers/net/ethernet/broadcom/nae/xlpge.h
@@ -31,6 +31,12 @@
 #define	__XLPGE_H__
 #include <asm/atomic.h>
 //#include <nlm_hal_nae.h>
+
+#include <linux/version.h>
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(3, 8, 0))
+#include <linux/timecompare.h>
+#endif
+
 #include "netsoc_nae.h"
 #include "netsoc_haliface.h"
 #include "netsoc_msg.h"
@@ -310,7 +316,9 @@ struct dev_data
 	/*1588 ptp timer*/
 	struct cyclecounter cycles;
 	struct timecounter clock;
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(3, 8, 0))
 	struct timecompare compare;
+#endif
 };
 
 
diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_board.c b/drivers/net/ethernet/broadcom/nae/xlpge_board.c
index c95943c..bf5c3ee 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_board.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_board.c
@@ -33,7 +33,6 @@
 #include <linux/etherdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 
 #include <nlm_hal_nae.h>
 #include <nlm_eeprom.h>
diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_ethtool.c b/drivers/net/ethernet/broadcom/nae/xlpge_ethtool.c
index 3cb659b..3ed091b 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_ethtool.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_ethtool.c
@@ -33,7 +33,6 @@
 #include <linux/etherdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 #include <linux/ethtool.h>
 #include <linux/mii.h>
 
diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_lro.h b/drivers/net/ethernet/broadcom/nae/xlpge_lro.h
index 4bf1172..5eb8600 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_lro.h
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_lro.h
@@ -34,7 +34,6 @@
 #include <linux/netdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 
 #include <nlm_xlp.h>
 #include "xlpge.h"
diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_main.c b/drivers/net/ethernet/broadcom/nae/xlpge_main.c
index 0ad28f5..07fb1fa 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_main.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_main.c
@@ -32,7 +32,6 @@
 #include <linux/netdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 
 #include "xlpge.h"
 int dis_link_scan_timer = 0;
@@ -40,7 +39,7 @@ module_param(dis_link_scan_timer, int, 0);
 MODULE_PARM_DESC(dis_link_scan_timer, "Disable Link Scan Timer");
 
 
-static const struct pci_device_id xlpnae_pci_table[] __devinitdata = {
+static const struct pci_device_id xlpnae_pci_table[] = {
 	{
 		.vendor		= PCI_VENDOR_NETLOGIC,
 		.device		= PCI_DEVICE_ID_NLM_NAE,
@@ -49,13 +48,13 @@ static const struct pci_device_id xlpnae_pci_table[] __devinitdata = {
 	},
 };
 
-static int __devinit brcmxlp_nae_pci_probe(struct pci_dev *pdev,
+static int brcmxlp_nae_pci_probe(struct pci_dev *pdev,
 					   const struct pci_device_id *ent)
 {
 	return pci_enable_device(pdev);
 }
 
-static void __devexit brcmxlp_nae_pci_remove(struct pci_dev *pdev)
+static void brcmxlp_nae_pci_remove(struct pci_dev *pdev)
 {
 	pci_disable_device(pdev);
 }
diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_msec.c b/drivers/net/ethernet/broadcom/nae/xlpge_msec.c
index 5d3c1af..3622ccd 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_msec.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_msec.c
@@ -32,7 +32,6 @@
 #include <linux/netdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 
 #include "xlpge.h"
 
diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_nae.c b/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
index 8ae33a3..af18a62 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
@@ -33,7 +33,6 @@
 #include <linux/etherdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 #include <linux/proc_fs.h>
 #include <linux/timer.h>
 #include <linux/kthread.h>
@@ -1564,6 +1563,7 @@ void nlm_xlp_nae_init(void)
 		}
 	}
 
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(3, 8, 0))
 	entry = create_proc_read_entry("mac_stats",
 				       0,			/* def mode */
 				       nlm_root_proc,		/* parent */
@@ -1582,6 +1582,7 @@ void nlm_xlp_nae_init(void)
 		nae_print(NAE_DBG_ERROR,"[%s]: Unable to create proc entry for nae_proc!\n",
 		       __func__);
 	}
+#endif
 
 	if (!enable_napi) {
 		nlm_xlp_disable_napi();
@@ -1594,6 +1595,7 @@ void nlm_xlp_nae_init(void)
 	if ((perf_mode == NLM_TCP_MODE) && load_balance_en) {
 		nlm_prepad_len = PREPAD_LEN;
 
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(3, 8, 0))
 		entry = create_proc_entry(
 				"load_info",
 				0,		/* def mode */
@@ -1601,6 +1603,7 @@ void nlm_xlp_nae_init(void)
 				);
 		if (entry)
 			entry->proc_fops = &nlm_load_balance_proc_fops;
+#endif
 		nae_print(NAE_DBG_DEFAULT, "Enabling load balance option\n");
 		nlm_init_load_balance();
 	} else {
diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_proc.c b/drivers/net/ethernet/broadcom/nae/xlpge_proc.c
index bdcd8b2..7d5c1e2 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_proc.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_proc.c
@@ -32,7 +32,6 @@
 #include <linux/netdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 #include <linux/proc_fs.h>
 
 #include "xlpge.h"
diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_ptp.c b/drivers/net/ethernet/broadcom/nae/xlpge_ptp.c
index 04ab077..e7789f1 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_ptp.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_ptp.c
@@ -32,7 +32,6 @@
 #include <linux/netdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 
 #include "xlpge.h"
 
@@ -75,9 +74,13 @@ static void nlm_1588_ptp_hwtstamp_tx(struct sk_buff *skb)
 	regval |= (uint64_t)nlm_hal_ptp_timer_hi(node, if_num)<<32;
 	acc_1588[node] = regval;
 	ns = timecounter_cyc2time(&priv->clock, regval);
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(3, 8, 0))
 	timecompare_update(&priv->compare, ns);
+#endif
 	shhwtstamps.hwtstamp = ns_to_ktime(ns);
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(3, 8, 0))
 	shhwtstamps.syststamp =	timecompare_transform(&priv->compare, ns);
+#endif
 	skb_tstamp_tx(skb, &shhwtstamps);
 	Message("nlm_1588_ptp_hwtstamp_tx regval=0x%llx ns=0x%llx node=0x%x\n",
 		regval, ns, node);	
diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_rx.c b/drivers/net/ethernet/broadcom/nae/xlpge_rx.c
index 68866a5..8a11dbe 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_rx.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_rx.c
@@ -33,7 +33,6 @@
 #include <linux/etherdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 #include <linux/kthread.h>
 
 #include <nlm_xlp.h>
diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_sgmii.c b/drivers/net/ethernet/broadcom/nae/xlpge_sgmii.c
index 86254e2..3e95cc3 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_sgmii.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_sgmii.c
@@ -32,7 +32,6 @@
 #include <linux/netdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 #include <linux/mii.h>
 
 #include "xlpge.h"
diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_tso.h b/drivers/net/ethernet/broadcom/nae/xlpge_tso.h
index c3d2028..0eb2c86 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_tso.h
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_tso.h
@@ -34,7 +34,6 @@
 #include <linux/netdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 #include <linux/ethtool.h>
 
 #include <nlm_msgring.h>
diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_tx.c b/drivers/net/ethernet/broadcom/nae/xlpge_tx.c
index 4c03194..ceacfc1 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_tx.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_tx.c
@@ -33,7 +33,6 @@
 #include <linux/etherdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 #include <linux/kthread.h>
 
 #include <nlm_msgring.h>
-- 
1.7.1

