From c8000e4f841134953a0577541a7867edd2f6ca7e Mon Sep 17 00:00:00 2001
From: Sreenidhi B R <sreenira@broadcom.com>
Date: Tue, 13 Aug 2013 15:59:24 +0530
Subject: fmnlib: correct output queue config for xlp9xx.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c b/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
index 89a76cd..cb90103 100644
--- a/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
+++ b/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
@@ -994,6 +994,7 @@ int nlm_hal_setup_outq(int node, int max_nodes)
 	uint32_t q_ram_start_page = 0;
 	const int q_ram_pages = 1;
 	const uint32_t q_ram_page_entries = 32; /* entries, not bytes */
+	const uint32_t q_ram_page_entries_9xx = 64; /* entries, not bytes */
 	int cnt =0;
 
 	if (is_nlm_xlp3xx() || is_nlm_xlp2xx()) {
@@ -1022,7 +1023,14 @@ int nlm_hal_setup_outq(int node, int max_nodes)
 
 			for (; qid <= xlp9xx_fmn_config[station].vc_limit; qid++) {
 				/* enable output queue and setup on-chip output queue */
-				val = (1ULL << 63) | (qid << 6) | (qid << 0);
+				val = 1ULL << 63; /* enable */
+
+				q_ram_base = ram_base + (qid * q_ram_pages * q_ram_page_entries_9xx);
+				val |= ( ((q_ram_base >> 12) & 0x1f) << 12); /* [16:12] of q_ram_base */
+				q_ram_start_page = (q_ram_base >> 6) & 0x3f; /* [11:6] of q_ram_base */
+				val |= (q_ram_start_page << 0);
+				val |= ( (q_ram_start_page + q_ram_pages - 1) << 6);
+
 
 #if !defined(NLM_HAL_UBOOT) && !defined(NLM_HAL_NETLBOOT)
 				/* spills, maximum spill per VC: 64 * 4KB = 256KB,
-- 
1.7.1

