From 8a13a54b4a093bb0b3b7fc4dee7b240b579c98e6 Mon Sep 17 00:00:00 2001
From: Joa-Yu Wu <joayuwu@broadcom.com>
Date: Tue, 6 Aug 2013 20:01:19 -0700
Subject: ale: Fixed ALE memory search code.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/netlogic/lib/alelib/ale_api.c b/arch/mips/netlogic/lib/alelib/ale_api.c
index 6b0c972..a18d5d2 100644
--- a/arch/mips/netlogic/lib/alelib/ale_api.c
+++ b/arch/mips/netlogic/lib/alelib/ale_api.c
@@ -113,7 +113,7 @@ alelib_init(void *fdt,
  * @return None
  */
 void
-alelib_deinit() {
+alelib_deinit(void) {
 
     ale_t *ale;
     int i, j;
@@ -393,6 +393,8 @@ ale_insert_prefix(ale_t* ale, uint16_t vc, ale_prefix_t* prefix, int last_update
         ale_insert_prefix_internal(ale, vc, prefix, last_update);
         if(ale){
           ale_db_hw = (!ale->active_db) ? ale->node_base_addr[1] : ale->node_base_addr[0]; 
+          ale_print(ALE_DBG_INFO, "%s: ale_db_hw = %llx\n",
+                    __func__, (long long unsigned int)ale_virt_to_phys(ale_db_hw));
           ale_download_node_bank(ale, vc, 0x3f, ale_virt_to_phys(ale_db_hw), (uint64_t)NULL);
         }
         return 0;
diff --git a/arch/mips/netlogic/lib/alelib/ale_api.h b/arch/mips/netlogic/lib/alelib/ale_api.h
index 8b01529..a7f900f 100644
--- a/arch/mips/netlogic/lib/alelib/ale_api.h
+++ b/arch/mips/netlogic/lib/alelib/ale_api.h
@@ -256,6 +256,7 @@ ale_memory_search_req(ale_t* ale,             //ale pointer
     int       str_len, i;
     int       req_cnt = 0, desc_cnt = 0;
     uint64_t  desc0, desc2;
+    uint64_t  req_ptr_phys = ale_virt_to_phys(req_ptr);
         
     /* fill valid lpm request into request memory */
     for (i = 0; i < num_prefix; i++) {
@@ -283,10 +284,13 @@ ale_memory_search_req(ale_t* ale,             //ale pointer
         prefix++;
     }
     
-    desc0 = ale_memory_search_desc0(1, fb_vc, desc_cnt, ale_virt_to_phys(req_ptr));
+    ale_print(ALE_DBG_INFO, "%s: req_ptr %llx, rsp_ptr %llx\n",
+              __func__, (long long unsigned int)req_ptr_phys,
+              (long long unsigned int)ale_virt_to_phys(rsp_ptr));
+    desc0 = ale_memory_search_desc0(1, fb_vc, desc_cnt, req_ptr_phys);
     desc2 = ale_memory_search_desc2(req_cnt, ale_virt_to_phys(rsp_ptr)); 
    
-    while (nlm_hal_send_msg3(ALE_VC, 0, desc0, 0, desc2)); 
+    while (nlm_hal_send_msg3(ALE_VC, 0, desc0, software_data, desc2)); 
     return 0;
 }
 
-- 
1.7.1

