From 80cbafb0c1f6a6c70112ab6b65fafea8a5b98eb7 Mon Sep 17 00:00:00 2001
From: Siva Pochiraju <sivap@broadcom.com>
Date: Tue, 2 Jul 2013 02:37:44 -0700
Subject: xlp416: Fixed FMN initialization

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c b/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
index 8d2b985..df16cf0 100644
--- a/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
+++ b/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
@@ -660,11 +660,9 @@ void enable_interface(int interface, short value) {
 
 	switch (interface) {
 		case CPU: {
-				int i;
-				for (i=0; i<8; i++) {
-					if ((value  & (1 << i)) == 0)
-						clearbit(i << 4);
-				}
+				int i, nCore;
+				nCore = 8-bitcount(value);
+				for (i=0; i < nCore; i++) clearbit(i << 4);
 			} break;
 		case PCIE: {
 				int i;
diff --git a/arch/mips/netlogic/lib/syslib/include/nlm_hal.h b/arch/mips/netlogic/lib/syslib/include/nlm_hal.h
index baea9c8..88bc0a7 100644
--- a/arch/mips/netlogic/lib/syslib/include/nlm_hal.h
+++ b/arch/mips/netlogic/lib/syslib/include/nlm_hal.h
@@ -281,6 +281,15 @@ static inline uint64_t __get_nae_soc_phys_base(int node, int nae_id)
 	}
 }
 
+static inline int bitcount(unsigned int n)
+{
+	register unsigned int tmp;
+
+	tmp = n - ((n >> 1) & 033333333333)
+	      - ((n >> 2) & 011111111111);
+	return ((tmp + (tmp >> 3)) & 030707070707) % 63;
+}
+
 #endif /* __ASSEMBLY__ */
 
 #endif /* #ifndef _NLM_HAL_H_ */
diff --git a/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c b/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c
index cac02e3..f068177 100644
--- a/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c
+++ b/arch/mips/netlogic/lib/syslib/src/nlm_hal_cpu_info.c
@@ -51,15 +51,6 @@
 #define XLP3XX_REVISION_B1  0x03
 
 extern void *memset(void *s, int c, size_t n);
-static inline int bitcount(unsigned int n)                          
-{
-  register unsigned int tmp;
-    
-  tmp = n - ((n >> 1) & 033333333333)
-            - ((n >> 2) & 011111111111);
-  return ((tmp + (tmp >> 3)) & 030707070707) % 63;
-}
-
 
 __inline__ uint32_t efuse_cfg0(void)
 {
-- 
1.7.1

