From da4e1f7746046f49952abcc0aa1eb7f3d41eb8c8 Mon Sep 17 00:00:00 2001
From: Saswat Kumar Dash <saswat.dash@broadcom.com>
Date: Mon, 1 Dec 2014 05:36:01 -0800
Subject: fmn: fixed spill mem allocation

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c b/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
index 4e4e4f3..06ad9b0 100644
--- a/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
+++ b/arch/mips/netlogic/lib/fmnlib/nlm_hal_fmn_config.c
@@ -275,6 +275,8 @@ nlm_fmn_config_t xlp5xx_fmn_config[] = {
 };
 
 extern struct nlm_node_config nlm_node_cfg;
+extern unsigned long spill_mem_address;
+extern unsigned long spill_mem_size;
 
 //#define FMN_DEBUG 1
 static int max_msg_blks = XLP_MSG_BLK_MAX;
@@ -1707,16 +1709,24 @@ int parse_fdt_fmn_config(void *fdt)
 				nlm_node_cfg.fmn_cfg[node]->fmn_spill_base = spill_base;
 			}
 		}
+
+		if ((nlm_node_cfg.fmn_cfg[node]->fmn_spill_size != 0ULL) && (spill_base == 0ULL)) {
+			nlm_print("Invalid configuration.\n");
+			continue;
+		}
+
 #ifdef NLM_HAL_LINUX_KERNEL
+		if (nlm_node_cfg.fmn_cfg[node]->fmn_spill_size == 0ULL) {
+			nlm_node_cfg.fmn_cfg[node]->fmn_spill_size = spill_mem_size;
+			spill_base = spill_mem_address;
+		}
 		if ((pval == NULL) || (spill_base == 0ULL)){
-			spill_base = nlm_spill_alloc(node, (nlm_node_cfg.fmn_cfg[node]->fmn_spill_size));
 			if (spill_base == 0ULL) {
 				nlm_print("Node %d FMN spill_mem alloc failed \n", node);
 				nlm_node_cfg.fmn_cfg[node]->fmn_spill_size = 0;
 			}
-			else
-				nlm_node_cfg.fmn_cfg[node]->fmn_spill_base = spill_base;
 		}
+		nlm_node_cfg.fmn_cfg[node]->fmn_spill_base = spill_base;
 #endif
 #endif
 		nlm_print("spillsize 0x%llx @ 0x%016llx \n", (unsigned long long)nlm_node_cfg.fmn_cfg[node]->fmn_spill_size,(unsigned long long)nlm_node_cfg.fmn_cfg[node]->fmn_spill_base);
-- 
1.7.1

