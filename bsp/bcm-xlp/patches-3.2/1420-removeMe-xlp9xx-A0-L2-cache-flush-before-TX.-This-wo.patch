From d21861fbff5b3bb330c622455ca0bf2923aad471 Mon Sep 17 00:00:00 2001
From: Vikas Gupta <vikas.gupta@broadcom.com>
Date: Tue, 6 Aug 2013 02:37:16 -0700
Subject: removeMe: xlp9xx A0: L2 cache flush before TX. This workaround needed for xlp9xx A0 chip.

This commit should be removed eventually since it is only a temporary workaround.
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_nae.c b/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
index c287dd5..2d83234 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
@@ -647,7 +647,7 @@ int replenish_freein_fifos(void)
 
 			/* Xaui/rxaui/interlaken uses only one fifo per complex */
 			blk_cmplx_map = nae_cfg->xaui_complex_map |  nae_cfg->rxaui_complex_map |
-				nae_cfg->ilk_complex_map;
+				nae_cfg->ilk_complex_map | nae_cfg->xlgmac_complex_map;
 
 			/* configure the descs */
 			for (i = 0; i < nae_cfg->frin_total_queue; i++) {
diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_tx.c b/drivers/net/ethernet/broadcom/nae/xlpge_tx.c
index b6786be..b39ad84 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_tx.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_tx.c
@@ -45,6 +45,8 @@
 #ifdef CONFIG_NLM_NET_OPTS
 extern struct dev_data *last_rcvd_priv[NR_CPUS * 8] ____cacheline_aligned;
 #endif
+//#include <asm/netlogic/kvm_xlp.h>
+extern void nlm_flush_cache_L2_local (unsigned long, unsigned long);
 
 uint64_t fast_replenish_count[NR_CPUS * 8] __cacheline_aligned;
 uint64_t slow_replenish_count[NR_CPUS * 8] __cacheline_aligned;
@@ -195,6 +197,9 @@ int nlm_xlp_nae_start_xmit(struct sk_buff *skb, struct net_device *dev)
 		mac_put_skb_back_ptr(skb); */
 		skb_reserve(skb, SKB_BACK_PTR_SIZE);
 	}
+	
+	if(is_nlm_xlp9xx())	
+	       nlm_flush_cache_L2_local((virt_to_bus((unsigned long)skb->data) & ~(64 -1)) ,  256);        
 
 
 retry_send:
-- 
1.7.1

