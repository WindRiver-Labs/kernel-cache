From fef96f0d71275772991250576bf4fcc866587854 Mon Sep 17 00:00:00 2001
From: Manoj Vellala <manojv@broadcom.com>
Date: Wed, 4 Dec 2013 20:36:29 -0800
Subject: kernel ipsec:3DES key SWAP_SUPPORT flag is not set for 2xx and 9xx

	1) Modified nlmcrypto.c/cryptosoc_lib_priv_init() to set
	3DES key SWAP SUPPORT flag in saesoc_feature_set.
	2) Modified xlp_3des_setkey() in nlm_aead.c to reflect the
	3des key swap changes (similar to xlp_setkey() in nlm_enc.c)
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/drivers/crypto/sae/nlm_aead.c b/drivers/crypto/sae/nlm_aead.c
index 8d65d59..c21e798 100755
--- a/drivers/crypto/sae/nlm_aead.c
+++ b/drivers/crypto/sae/nlm_aead.c
@@ -91,7 +91,7 @@ struct nlm_aead_ctx
 #define PKT_DESC_OFF 64
 
 extern struct nlm_crypto_stat crypto_stat[MAX_CPU];
-
+extern struct cryptosoc_lib_params lparam;
 
 /*
    All extern declaration goes here.
@@ -412,6 +412,21 @@ static int  xlp_3des_setkey(struct crypto_aead *tfm, u8 *key, unsigned int keyle
 
 	s_desc = &ctx->dec_s_desc;
 
+        if((initp->cipher.type == SAESOC_CIPHER_TYPE_TDES) &&
+                               (!(initp->cipher.flags & SAESOC_CF_ENCRYPT)) &&
+                               (!(lparam.saesoc_feature_set & SAESOC_FF_3DES_KEY_SWAP_SUPPORT))) {
+
+                 /* Software needs to swap the keys for 3DES
+                  * as hardware has no support for key swap
+                  */
+                 unsigned long long  * key = (unsigned long long  *)initp->cipher.key;
+                 unsigned long long decrypt_key[3];
+                 decrypt_key[0] = key[2];
+                 decrypt_key[1] = key[1];
+                 decrypt_key[2] = key[0];
+                 initp->cipher.key = (char *)decrypt_key;
+        }
+
 	if(saesoc_new_session(&ctx->initp,&s_desc,nsdescs, NULL) < 0)
 		 printk("%s,%d Error \n", __FUNCTION__, __LINE__); 
 
diff --git a/drivers/crypto/sae/nlm_crypto.c b/drivers/crypto/sae/nlm_crypto.c
index b81754b..f9e3a74 100644
--- a/drivers/crypto/sae/nlm_crypto.c
+++ b/drivers/crypto/sae/nlm_crypto.c
@@ -19,10 +19,10 @@
 #include <nlm_xlp.h>
 #include <linux/crypto.h>
 #include <nlm_msgring.h>
+#include "cryptosoc_lib.h"
 #include "saesoc_lib.h"
 #include "nlm_async.h"
-
-
+#include "nlm_hal.h"
 
 #ifdef TRACING
 #define TRACE_TEXT(str) printk(str);
@@ -34,10 +34,22 @@
 #undef NLM_CRYPTO_DEBUG
 #define NETL_OP_ENCRYPT 1
 #define NETL_OP_DECRYPT 0
-int cryptosoc_lib_priv_init(struct cryptosoc_lib_params *param)
+extern int cryptosoc_ptype_gen;
+
+int cryptosoc_lib_priv_init(struct cryptosoc_lib_params *params)
 {
-	return 0;
+        if (is_nlm_xlp9xx())
+                cryptosoc_ptype_gen = CRYPTOSOC_PTYPE_IS_GEN2;
+        else
+                cryptosoc_ptype_gen = CRYPTOSOC_PTYPE_IS_GEN1;
+
+        if(is_nlm_xlp2xx())
+                params->saesoc_feature_set |= (
+                                SAESOC_FF_3DES_KEY_SWAP_SUPPORT | SAESOC_FF_CIPHER_ZUC_SUPPORT);
+
+        return CRYPTOSOC_OK;
 }
+
 int cryptosoc_lib_priv_finish(void){
 	return 0;
 }
diff --git a/drivers/crypto/sae/nlm_enc.c b/drivers/crypto/sae/nlm_enc.c
index 08b89f9..442ee6d 100755
--- a/drivers/crypto/sae/nlm_enc.c
+++ b/drivers/crypto/sae/nlm_enc.c
@@ -92,7 +92,7 @@ xlp_setkey(struct crypto_ablkcipher *tfm, uint16_t stat)
 	nlm_ctx->initp.cipher.flags = 0;
 
 	s_desc = &nlm_ctx->dec_s_desc;
-	
+
         if((nlm_ctx->initp.cipher.type == SAESOC_CIPHER_TYPE_TDES) &&
                                (!(nlm_ctx->initp.cipher.flags & SAESOC_CF_ENCRYPT)) && 
                                (!(lparam.saesoc_feature_set & SAESOC_FF_3DES_KEY_SWAP_SUPPORT))) {
-- 
1.7.1

