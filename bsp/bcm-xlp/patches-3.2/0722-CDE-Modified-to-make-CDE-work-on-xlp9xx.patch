From 0bedbe06dd5f658887e196a50008fedd7701cf68 Mon Sep 17 00:00:00 2001
From: Alok Agrawat <alok@broadcom.com>
Date: Mon, 10 Jun 2013 19:19:12 -0700
Subject: CDE: Modified to make CDE work on xlp9xx.

     Changed bus number for CDE when it is xlp9xx.
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/netlogic/lib/syslib/include/nlm_hal_cde.h b/arch/mips/netlogic/lib/syslib/include/nlm_hal_cde.h
index 7a9b3b1..cfe9b94 100644
--- a/arch/mips/netlogic/lib/syslib/include/nlm_hal_cde.h
+++ b/arch/mips/netlogic/lib/syslib/include/nlm_hal_cde.h
@@ -40,6 +40,15 @@
 
 #include "nlm_hal.h"
 
+#define nlm_hal_9xx_write_cde_reg(reg, val) nlm_hal_write_32bit_reg \
+					(nlm_hal_get_dev_base \
+					(XLP_CDE_NODE, XLP_CDE_BUS_9XX, XLP_CDE_DEVICE, XLP_CDE_FUNC), \
+					 (reg), (val))
+#define nlm_hal_9xx_read_cde_reg(reg) nlm_hal_read_32bit_reg( \
+					nlm_hal_get_dev_base \
+					(XLP_CDE_NODE, XLP_CDE_BUS_9XX, XLP_CDE_DEVICE, XLP_CDE_FUNC), \
+					 (reg))
+
 #define nlm_hal_write_cde_reg(reg, val) nlm_hal_write_32bit_reg \
 					(nlm_hal_get_dev_base \
 					(XLP_CDE_NODE, XLP_CDE_BUS, XLP_CDE_DEVICE, XLP_CDE_FUNC), \
@@ -98,25 +107,29 @@ static __inline__ int nlm_hal_9xxcde_make_cmp_msg(uint64_t *msg0, uint64_t *msg1
                 ((uint64_t) op << 62)  | 
                 ((uint64_t) length << 40) |
                 ((uint64_t) src_addr & 0xffffffffffULL))
-                &0xc003ffffffffffff) );
+                /*&0xc003ffffffffffff*/) );
   *msg1 = ( ((
                 ((uint64_t) rtn_bkt << 50) |
                 ((uint64_t) 0x3ffffffffffff))
-                &0x7fffffffffffffff));
+                /*&0x7fffffffffffffff*/));
   return stid;
 }
 
 
 /* Return error when parameter are invalid */
-static __inline__ int nlm_hal_cde_send_request(uint32_t dst_vc, uint64_t entry0, uint64_t entry1)
+static __inline__ int nlm_hal_cde_send_request_1(uint32_t dst_vc, uint64_t entry0)
 {
-    if ( is_nlm_xlp9xx())
-	return nlm_hal_send_msg2(dst_vc, 0, entry0, entry1);
-    else
 	return nlm_hal_send_msg1(dst_vc, 0, entry0);
 
 }
 
+/* Return error when parameter are invalid */
+static __inline__ int nlm_hal_cde_send_request_2(uint32_t dst_vc, uint64_t entry0, uint64_t entry1)
+{
+	return nlm_hal_send_msg2(dst_vc, 0, entry0, entry1);
+
+}
+
 static __inline__ void nlm_hal_cde_receive_response(uint32_t rx_vc, uint64_t *entry0, uint64_t *entry1)
 {
         uint32_t size = 0, code = 0, src = 0;
diff --git a/arch/mips/netlogic/lib/syslib/include/nlm_hal_xlp_dev.h b/arch/mips/netlogic/lib/syslib/include/nlm_hal_xlp_dev.h
index 77cd9a2..ca93486 100644
--- a/arch/mips/netlogic/lib/syslib/include/nlm_hal_xlp_dev.h
+++ b/arch/mips/netlogic/lib/syslib/include/nlm_hal_xlp_dev.h
@@ -469,6 +469,7 @@ extern int is_nlm_xlp(unsigned int chipid, unsigned int rev,  unsigned int ext);
 /*CDE related */
 #define XLP_CDE_NODE                    0x0
 #define XLP_CDE_BUS                     0x0
+#define XLP_CDE_BUS_9XX                 0x1
 #define XLP_CDE_DEVICE                  0x5
 #define XLP_CDE_FUNC                    0x3
 
-- 
1.7.1

