From 34786f50b0e92f94d451c907ec895a2e0488c7dd Mon Sep 17 00:00:00 2001
From: Vikas Gupta <vikasg@netlogicmicro.com>
Date: Thu, 10 Nov 2011 18:52:18 +0530
Subject: Fix for error counters. 1) Packet dropped at HW is counted as 'errors'. 2) Packet not dropped by HW but at mac driver is counted as 'dropped'.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/drivers/net/ethernet/broadcom/nae/xlp_hw.c b/drivers/net/ethernet/broadcom/nae/xlp_hw.c
index a93909f..a015baf 100755
--- a/drivers/net/ethernet/broadcom/nae/xlp_hw.c
+++ b/drivers/net/ethernet/broadcom/nae/xlp_hw.c
@@ -326,11 +326,10 @@ void xlp_get_mac_stats(struct net_device *dev, struct net_device_stats *stats)
 {
 	struct dev_data *priv = netdev_priv(dev);
 
-	if (priv->type != SGMII_IF)
+	if (priv->type == INTERLAKEN_IF)
 		return;
 
 	stats->tx_errors = nlm_hal_read_mac_reg( priv->block, priv->index, TX_FCS_ERROR_COUNTER);
-	stats->rx_dropped = nlm_hal_read_mac_reg( priv->block, priv->index, RX_DROP_PACKET_COUNTER);
 	stats->tx_dropped = nlm_hal_read_mac_reg( priv->block, priv->index, TX_DROP_FRAME_COUNTER);
 	stats->multicast = nlm_hal_read_mac_reg( priv->block, priv->index, RX_MULTICAST_PACKET_COUNTER);
 	stats->collisions = nlm_hal_read_mac_reg( priv->block, priv->index, TX_TOTAL_COLLISION_COUNTER);
diff --git a/drivers/net/ethernet/broadcom/nae/xlp_nae.c b/drivers/net/ethernet/broadcom/nae/xlp_nae.c
index 846617c..8a5269a 100755
--- a/drivers/net/ethernet/broadcom/nae/xlp_nae.c
+++ b/drivers/net/ethernet/broadcom/nae/xlp_nae.c
@@ -1465,7 +1465,6 @@ static void nlm_xlp_nae_msgring_handler(uint32_t vc, uint32_t src_id,
 		if (bad_pkt) {
 			struct page *pg;
 			int rx_offset;
-			STATS_INC(priv->stats.rx_errors);
 			STATS_INC(priv->stats.rx_dropped);
 			/*increase free count for used pages*/
 			for(idx=0; idx<num_p2d; idx++){
@@ -1483,7 +1482,7 @@ static void nlm_xlp_nae_msgring_handler(uint32_t vc, uint32_t src_id,
 		skb = dev_alloc_skb(NETL_JUMBO_SKB_HDR_LEN + 16);
 		if(skb == NULL) {
 			printk("FAILED TO ALLOCATE skb\n");
-			STATS_INC(priv->stats.rx_errors);
+			STATS_INC(priv->stats.rx_dropped);
 			
 			recycle_rx_desc(addr, pdev);
 			return;
-- 
1.7.1

