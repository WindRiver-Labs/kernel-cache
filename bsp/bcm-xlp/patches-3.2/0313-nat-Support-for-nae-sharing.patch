From 4e2f14c3723f70eefa1ddf8c218cab1824b5a4c4 Mon Sep 17 00:00:00 2001
From: Hareesh R <hareeshr@broadcom.com>
Date: Tue, 22 May 2012 14:51:30 +0530
Subject: nat : Support for nae sharing

Added support for nae sharing b/w linux and nat application in
helinux mode.
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/boot/dts/xlp8xx-helinux-nat.dts b/arch/mips/boot/dts/xlp8xx-helinux-nat.dts
index 473b5b0..38aec57 100644
--- a/arch/mips/boot/dts/xlp8xx-helinux-nat.dts
+++ b/arch/mips/boot/dts/xlp8xx-helinux-nat.dts
@@ -28,11 +28,9 @@
 
 			cpu {
 				onlinemask = <0xffffffff>;
-                                nae-rx-vc = <1>;
+                                nae-rx-vc = <0>;
                                 nae-fb-vc = <1>;
-				sae-rx-vc = <1>; /* sharing with nae */
-				sae-rx-sync-vc = <3>; /* should be exclusive */
-                                napi-vc-mask = <0x0>;
+                                napi-vc-mask = <0x3>;
 
 			};
 			uart {
@@ -45,13 +43,26 @@
 					0x20000000 0x40000000>;  //  1GB @ 512MB
 			};
                         fmn {
-                                node_0_vc_mask = <0x00000000 0x00000000 0x00000000 0x00000000>;
-                                node_1_vc_mask = <0x22222222 0x22222222 0x22222222 0x22222222>;
-                                node_2_vc_mask = <0x22222222 0x22222222 0x22222222 0x22222222>;
-                                node_3_vc_mask = <0x22222222 0x22222222 0x22222222 0x22222222>;
+                                node_0_vc_mask = <0x33333333 0x33333333 0x33333333 0x33333333>;
+                                node_1_vc_mask = <0x33333333 0x33333333 0x33333333 0x33333333>;
+                                node_2_vc_mask = <0x33333333 0x33333333 0x33333333 0x33333333>;
+                                node_3_vc_mask = <0x33333333 0x33333333 0x33333333 0x33333333>;
                         };
 			pic {
 			};
+			nae {
+				owner = <1 0 0 0>;
+				sh-domains = <1>;
+				freein-fifo-mask = <0x30000 0 0 0>;
+				/* node offsets and size */
+				vfbtbl-sw-offset = <0 0 0 0>;
+				vfbtbl-sw-nentries = <32 32 32 32>;
+				/* hw entries */
+				vfbtbl-hw-offset = <32 32 32 32>;
+				vfbtbl-hw-nentries = <0 0 0 0>;
+				dummy-pktdata-addr = <0x0 0x0ff00000>; // 255 MB
+			};
+
 		};
 
 		dom@1 {
@@ -80,15 +91,8 @@
 
 			cpu {
 				onlinemask = <0xffffffff>;
-                                nae-rx-vc = <0>;
+                                nae-rx-vc = <2>;
                                 nae-fb-vc = <3>;
-				sae-rx-vc = <0>; /* sharing with nae */
-				sae-rx-sync-vc = <0>;  /* sharing with nae */
-				/* helinux, as only 1 thread per cpu, it should poll for both nae and sae 
-				   responses. Also there is no other vc as linux is using other 2 vcs */
-                                /* Setting this to '1' makes NAE driver to skip buf alloction and initial
-                                   sending of packet buffers*/
-                                nae-buf-alloc-by-app = <1>; 
 			};
 			uart {
 				id = <0>;
@@ -100,108 +104,17 @@
 				onlinemask = <0xffff>;
 			};
 			nae{
-				owner = <1>;
-			};
-
-                        fmn {
-                                node_0_vc_mask = <0x99999999 0x99999999 0x99999999 0x99999999>;
-                                node_1_vc_mask = <0x99999999 0x99999999 0x99999999 0x99999999>;
-                                node_2_vc_mask = <0x99999999 0x99999999 0x99999999 0x99999999>;
-                                node_3_vc_mask = <0x99999999 0x99999999 0x99999999 0x99999999>;
-                        };
-            kbp {
-                /* distribute total of 4096 buffer id across cpus. required only for cpus sending requests.
-                 * note : KBP compare/search instructions must use even-numbered buffers. i.e. (buffer_id & 0x1 == 0) is True
-                 */
-                buffers-cpuid-offset-quantity = <  0    0   64
-                                                   1   64   64
-                                                   2  128   64
-                                                   3  192   64
-                                                   4  256   64
-                                                   5  320   64
-                                                   6  384   64
-                                                   7  448   64
-                                                   8  512   64
-                                                   9  576   64
-                                                  10  640   64
-                                                  11  704   64
-                                                  12  768   64
-                                                  13  832   64
-                                                  14  896   64
-                                                  15  960   64
-                                                  16 1024   64
-                                                  17 1088   64
-                                                  18 1152   64
-                                                  19 1216   64
-                                                  20 1280   64
-                                                  21 1344   64
-                                                  22 1408   64
-                                                  23 1472   64
-                                                  24 1536   64
-                                                  25 1600   64
-                                                  26 1664   64
-                                                  27 1728   64
-                                                  28 1792   64
-                                                  29 1856   64
-                                                  30 1920   64
-                                                  31 1984   64>;
-                /* starting address for KBP Driver Data. two 32-bit unsigned integers forms one 64-bit memory address.
-                 * kbp driver requires 2 MBytes of dedicated memory space to store data */
-                memory-offsethigh-offsetlow = <0x00000001 0x00000000>;
-            };
-		};
-
-		dom@2 {
-			device_type = "domain";
-			os = "netos";
-
-			heap-size = <0x0 0x8000000>; // 128M
-			shared-mem = <0x0 0x48000000 0x0 0x10000000>; // 128M @ 1152Mb
-
-			#address-cells = <1>;
-			#size-cells = <1>;
-
-			app-bootcmd = "smpload";
-			app-loadaddr = "0xf0000000"; // 3.75GB
-
-			kernel {
-				/* Kernel Memory allocated from xen domain-heap */
-				size = <0x02000000>;  // 32M
-
-				/* Location in Dom0 ramdisk */
-				location = "/tmp/xen/netos.elf";
-
-				/* Domain destroy currently doesn't work with hyperexec */
-				dom_destroy_hack = <0>;
-			};
-
-			cpu {
-				onlinemask = <0xffff0000>;
-                                nae-rx-vc = <0>;
-                                nae-fb-vc = <3>;
-                                /* Setting this to '1' makes NAE driver to skip buf alloction and initial
-                                   sending of packet buffers*/
-                                nae-buf-alloc-by-app = <1>; 
-			};
-			uart {
-				id = <0>;
-			};
-			memory {
-				reg = <0xE0000000 0x60000000>;  // 1.5Gb @ 3584Mb
-			};
-			app-param{
-				onlinemask = <0xffff0000>;
-			};
-			nae{
-				owner = <0>;
+				owner = <0 0 0 0>;
+				sh-domains = <0>;
+				freein-fifo-mask = <0xffff 0 0 0>;
+				/* node offsets and size */
+				vfbtbl-sw-offset = <0 0 0 0>;
+				vfbtbl-sw-nentries = <0 0 0 0>;
+				/* hw entries */
+				vfbtbl-hw-offset = <32 32 32 32>;
+				vfbtbl-hw-nentries = <20 20 20 20>;
+				dummy-pktdata-addr = <0x0 0x0ff00000>; // 255 MB
 			};
-
-                        fmn {
-                                node_0_vc_mask = <0x99999999 0x99999999 0x99999999 0x99999999>;
-                                node_1_vc_mask = <0x99999999 0x99999999 0x99999999 0x99999999>;
-                                node_2_vc_mask = <0x99999999 0x99999999 0x99999999 0x99999999>;
-                                node_3_vc_mask = <0x99999999 0x99999999 0x99999999 0x99999999>;
-                        };
 		};
 	};
 
diff --git a/arch/mips/boot/dts/xlp8xx-netos-nat.dts b/arch/mips/boot/dts/xlp8xx-netos-nat.dts
index 8efcf6c..e8c6294 100644
--- a/arch/mips/boot/dts/xlp8xx-netos-nat.dts
+++ b/arch/mips/boot/dts/xlp8xx-netos-nat.dts
@@ -46,14 +46,9 @@
 
 			cpu {
 				onlinemask = <0xffffffff>;
-                                nae-rx-vc = <0>;
+                                nae-rx-vc = <2>;
                                 nae-fb-vc = <3>;
-				sae-rx-vc = <0>; /* sharing with nae */
-				sae-rx-sync-vc = <2>; /* should be exclusive */
 
-                                /* Setting this to '1' makes NAE driver to skip buf alloction and initial
-                                   sending of packet buffers*/
-                                nae-buf-alloc-by-app = <1>; 
 			};
 			uart {
 				id = <0>;
@@ -65,56 +60,17 @@
                                 onlinemask = <0xffff>;
 				enable-nae-jumbo = <0>;
                         };
-			nae{
-				owner = <1>;
+			nae {
+				owner = <1 0 0 0>;
+				freein-fifo-mask = <0xffff 0 0 0>;
+				/* node offsets and size */
+				vfbtbl-sw-offset = <0 0 0 0>;
+				vfbtbl-sw-nentries = <0 0 0 0>;
+				/* hw entries */
+				vfbtbl-hw-offset = <32 32 32 32>;
+				vfbtbl-hw-nentries = <20 20 20 20>;
+				dummy-pktdata-addr = <0x0 0x0ff00000>; // 255 MB
 			};
-			/* In hyperexec-linux mode, vc_mask needs to be synchronized with linux fmn node! */
-                        fmn {
-                                node_0_vc_mask = <0x99999999 0x99999999 0x99999999 0x99999999>;
-                                node_1_vc_mask = <0x99999999 0x99999999 0x99999999 0x99999999>;
-                                node_2_vc_mask = <0x99999999 0x99999999 0x99999999 0x99999999>;
-                                node_3_vc_mask = <0x99999999 0x99999999 0x99999999 0x99999999>;
-                        };
-            kbp {
-                /* distribute total of 4096 buffer id across cpus. required only for cpus sending requests.
-                 * note : KBP compare/search instructions must use even-numbered buffers. i.e. (buffer_id & 0x1 == 0) is True
-                 */
-                buffers-cpuid-offset-quantity = <  0    0   64
-                                                   1   64   64
-                                                   2  128   64
-                                                   3  192   64
-                                                   4  256   64
-                                                   5  320   64
-                                                   6  384   64
-                                                   7  448   64
-                                                   8  512   64
-                                                   9  576   64
-                                                  10  640   64
-                                                  11  704   64
-                                                  12  768   64
-                                                  13  832   64
-                                                  14  896   64
-                                                  15  960   64
-                                                  16 1024   64
-                                                  17 1088   64
-                                                  18 1152   64
-                                                  19 1216   64
-                                                  20 1280   64
-                                                  21 1344   64
-                                                  22 1408   64
-                                                  23 1472   64
-                                                  24 1536   64
-                                                  25 1600   64
-                                                  26 1664   64
-                                                  27 1728   64
-                                                  28 1792   64
-                                                  29 1856   64
-                                                  30 1920   64
-                                                  31 1984   64>;
-                /* starting address for KBP Driver Data. two 32-bit unsigned integers forms one 64-bit memory address.
-                 * kbp driver requires 2 MBytes of dedicated memory space to store data */
-                memory-offsethigh-offsetlow = <0x00000001 0x00000000>;
-            };
 		};
 	};
 
-- 
1.7.1

