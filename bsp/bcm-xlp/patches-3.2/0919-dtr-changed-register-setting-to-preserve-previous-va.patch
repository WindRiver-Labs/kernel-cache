From e5d891d2ec8dce42d55a30e8bbb112de5e063b3a Mon Sep 17 00:00:00 2001
From: Abhishek Joshi <abjoshi@broadcom.com>
Date: Fri, 28 Mar 2014 12:01:37 +0530
Subject: dtr: changed register setting to preserve previous value

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/netlogic/lib/syslib/src/nlm_hal.c b/arch/mips/netlogic/lib/syslib/src/nlm_hal.c
index 8492a9b..7d7320c 100644
--- a/arch/mips/netlogic/lib/syslib/src/nlm_hal.c
+++ b/arch/mips/netlogic/lib/syslib/src/nlm_hal.c
@@ -922,6 +922,7 @@ static void nlm_hal_dtr_9xx_init(void *fdt)
 {
 
 	int node=0;
+	uint32_t val =0;
 	const uint64_t mhz = 1000000;
 	uint64_t frequency;
 	uint64_t base0 = nlm_hal_get_dev_base (XLP_DTR_NODE, 1, XLP_DTR_DEVICE, XLP_DTR_FUNC);
@@ -932,7 +933,8 @@ static void nlm_hal_dtr_9xx_init(void *fdt)
 	/* for engine DTRE0 */
 
 	/* Enable Master Control register */
-	nlm_hal_write_32bit_reg (base0, XLP_DTR_MASTER_CONTROL_REG, 0x1);
+	val = nlm_hal_read_32bit_reg (base0, XLP_DTR_MASTER_CONTROL_REG);
+	nlm_hal_write_32bit_reg (base0, XLP_DTR_MASTER_CONTROL_REG, val | 0x1);
 	/* Channel control registers */
 	nlm_hal_write_32bit_reg (base0, XLP_DTR_CHANNEL_CONTROL_REG_0, 0x3fe);
 	nlm_hal_write_32bit_reg (base0, XLP_DTR_CHANNEL_CONTROL_REG_1, 0x3fe);
@@ -952,7 +954,8 @@ static void nlm_hal_dtr_9xx_init(void *fdt)
 	/* for engine DTRE1 */
 
 	/* Enable Master Control register */
-	nlm_hal_write_32bit_reg (base1, XLP_DTR_MASTER_CONTROL_REG, 0x1);
+	val = nlm_hal_read_32bit_reg (base1, XLP_DTR_MASTER_CONTROL_REG);
+	nlm_hal_write_32bit_reg (base1, XLP_DTR_MASTER_CONTROL_REG, val | 0x1);
 	/* Channel control registers */
 	nlm_hal_write_32bit_reg (base1, XLP_DTR_CHANNEL_CONTROL_REG_0, 0x3fe);
 	nlm_hal_write_32bit_reg (base1, XLP_DTR_CHANNEL_CONTROL_REG_1, 0x3fe);
-- 
1.7.1

