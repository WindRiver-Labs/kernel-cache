From 4e7b5c9740c9dd38efd54140589481e7eb4fd95e Mon Sep 17 00:00:00 2001
From: Vikas Gupta <vikas.gupta@broadcom.com>
Date: Wed, 22 Oct 2014 15:42:39 +0530
Subject: soc_interface: fix for per cpu initialized array which should be accessed against online cpu only.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/drivers/misc/netlogic/soc_interface/on_chip.c b/drivers/misc/netlogic/soc_interface/on_chip.c
index 6ab44d0..a4dc975 100644
--- a/drivers/misc/netlogic/soc_interface/on_chip.c
+++ b/drivers/misc/netlogic/soc_interface/on_chip.c
@@ -1280,7 +1280,7 @@ static inline int num_ones(unsigned int mask)
 
 static int xlp_napi_fmn_setup(void)
 {
-	int i, cpu_count;
+	int cpu;
 	struct napi_struct *napi;
 	int weight_p = 300;
 
@@ -1288,17 +1288,14 @@ static int xlp_napi_fmn_setup(void)
 
 	init_dummy_netdev(&xlp_napi_fmn_dummy_dev);
 
-	for (cpu_count = 0; cpu_count < NR_CPUS; cpu_count++)
-	{
-		napi = &per_cpu(xlp_napi_fmn_poll_struct, cpu_count);
+	for_each_present_cpu(cpu) {
+		napi = &per_cpu(xlp_napi_fmn_poll_struct, cpu);
 		memset(napi, 0, sizeof(*napi));
 		netif_napi_add(&xlp_napi_fmn_dummy_dev, napi, xlp_fmn_poll, weight_p);
 		napi_enable(napi);
+		per_cpu(xlp_napi_fmn_rx_count, cpu) = 0;
 	}
 
-	for (i = 0; i < NR_CPUS; i++) {
-		per_cpu(xlp_napi_fmn_rx_count, i) = 0;
-	}
 	return 0;
 }
 
-- 
1.7.1

