From 92fff4b8e6222b618e562e0ead6aba3d4a1ba6e8 Mon Sep 17 00:00:00 2001
From: PUNYA BHEEMESH <bheemesh@broadcom.com>
Date: Fri, 25 Jul 2014 10:36:55 +0530
Subject: kmod/nae: Fixed the wrong qid selection while replenshing Rx buffers in cpu_fifo mode. Also added configuration of UCORE_INTF_MASK in cpu_fifo mode for better performance.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_nae.c b/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
index 30734cc..dbf2aaf 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
@@ -1022,11 +1022,11 @@ int get_hw_frfifo_queue_id(int rxnode, nae_t* nae_cfg,
 	if(nae_cfg->port_fifo_en) {
 		qid = hw_port_id;
 	} else {
-		qid = cpu_2_normal_frfifo[rxnode][node_cpu];
+		qid = cpu_2_normal_frfifo[rxnode][nae_cfg->nae_id][node_cpu];
 
 		if (enable_jumbo)
 			if(truesize > NLM_RX_JUMBO_BUF_SIZE)
-				qid = cpu_2_jumbo_frfifo[rxnode][node_cpu];
+				qid = cpu_2_jumbo_frfifo[rxnode][nae_cfg->nae_id][node_cpu];
 	}
 	/*
 	 * all the nodes vfbtable should be filled with starting node of
@@ -1576,9 +1576,11 @@ void nlm_xlp_nae_init(void)
 			nae_cfg = get_nae(node, num_nae);
 			if (nae_cfg == NULL)
 				continue;
-			for(i = 0; i < nae_cfg->num_ports; i++) {
-				nlm_per_port_nae_init(nae_cfg, i, maxnae, hw_mac_addr);
+			for(i = 0; i < nae_cfg->num_ports; i++){
+				nlm_per_port_nae_init(nae_cfg, i, maxnae);
 				hw_mac_addr[5]++;
+				if(!(nae_cfg->port_fifo_en))
+					netsoc_map_interface_to_lifo(nae_cfg, i, 0xffff);
 			}
 		}
 	}
-- 
1.7.1

