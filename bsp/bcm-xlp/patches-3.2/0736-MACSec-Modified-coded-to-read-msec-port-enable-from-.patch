From af7b9f161d45e5f595db614e7e4f81b053c7913b Mon Sep 17 00:00:00 2001
From: Alok Agrawat <alok@broadcom.com>
Date: Mon, 24 Jun 2013 20:21:54 -0700
Subject: MACSec: Modified coded to read msec-port-enable from sysconfig.

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/netlogic/lib/netlib/include/nlm_hal_nae.h b/arch/mips/netlogic/lib/netlib/include/nlm_hal_nae.h
index 45f4fe9..6e28f31 100644
--- a/arch/mips/netlogic/lib/netlib/include/nlm_hal_nae.h
+++ b/arch/mips/netlogic/lib/netlib/include/nlm_hal_nae.h
@@ -135,7 +135,8 @@ struct nae_complex_config {
 	uint32_t higig_mode;
 	uint32_t xgmii_speed;
 	uint32_t vlan_pri_en[MAX_PORTS_PERBLOCK];
-	uint32_t msec_port_enable[MAX_PORTS_PERBLOCK];
+	//uint32_t msec_port_enable[MAX_PORTS_PERBLOCK];
+	uint32_t msec_port_enable;
 	uint32_t rxaui_submode[MAX_PORTS_PERBLOCK];
 	uint32_t rxaui_scrambler[MAX_PORTS_PERBLOCK];
 };
diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_fdt.c b/arch/mips/netlogic/lib/netlib/src/netsoc_fdt.c
index 87220a5..71931ef 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_fdt.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_fdt.c
@@ -909,15 +909,9 @@ static void extract_complex_params(void *fdt, int intf_type, char *nae_port_str,
 			cmplx->xgmii_speed = get_xgmii_speed(intf_type);
 	}
 
-        if (GET_PORT_PROP("msec-port-enable",&cmplx->msec_port_enable, sizeof(cmplx->msec_port_enable)) < 0) {
-		for(i=0; i<sizeof(cmplx->msec_port_enable)/sizeof(uint32_t); i++)
-		{
-			cmplx->msec_port_enable[i] = get_msec_port_enable(intf_type);
-			//printk("\n####################################%s  cmplx->msec_port_enable[i] = %x\n", __FUNCTION__,  cmplx->msec_port_enable[i]);
-		}	
-		
-	}
-
+        GET_PORT_PROP("msec-port-enable",&cmplx->msec_port_enable, sizeof(cmplx->msec_port_enable)); 
+	//printk("\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ cmplx->msec_port_enable = %x", cmplx->msec_port_enable);
+        
         if (GET_PORT_PROP("submode",&cmplx->rxaui_submode, sizeof(cmplx->rxaui_submode)) < 0) {
 		for(i=0; i<sizeof(cmplx->rxaui_submode)/sizeof(uint32_t); i++)
 			cmplx->rxaui_submode[i] = NLP1042_PHY_10G_NONE;
@@ -1128,14 +1122,15 @@ static int fdt_parse_port_config(void *fdt, nae_t *nae_cfg)
 
                 if(intf_type == XAUI_IF || intf_type == RXAUI_IF)
                 {
- //                       if(cmplx_cfg.msec_port_enable)
+                        if(cmplx_cfg.msec_port_enable)
                                 nae_cfg->msec_port_enable |=  0xf << (4 * block);
                         nae_cfg->higig_mode[block]=cmplx_cfg.higig_mode;
                         nae_cfg->xgmii_speed[block]=cmplx_cfg.xgmii_speed;
                 }
                 else{
-                        //nae_cfg->msec_port_enable |= cmplx_cfg.msec_port_enable << (4 * block);
-                        nae_cfg->msec_port_enable |= 0xf << (4 * block);
+                        if(cmplx_cfg.msec_port_enable)
+                        	nae_cfg->msec_port_enable |= cmplx_cfg.msec_port_enable << (4 * block);
+                        	//nae_cfg->msec_port_enable |= 0xf << (4 * block);
                         nae_cfg->higig_mode[block]=0;
                         nae_cfg->xgmii_speed[block]=1; /*1G SGMII*/
                 }
@@ -1161,9 +1156,11 @@ static int fdt_parse_port_config(void *fdt, nae_t *nae_cfg)
                         nae_port->ext_phy_bus = cmplx_cfg.ext_phy_bus[offset];
                         nae_port->loopback = cmplx_cfg.loopback[offset];
                         nae_port->rxaui_mode = cmplx_cfg.rxaui_submode[offset];;
-                        nae_port->msec_enable = cmplx_cfg.msec_port_enable[offset];;
+                        //nae_port->msec_enable = cmplx_cfg.msec_port_enable[offset];;
+                        nae_port->msec_enable = (cmplx_cfg.msec_port_enable >> offset) & 0x1;
                         //nae_port->msec_enable = 1;
-
+			//printk("\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^nae_port->msec_enable = %d\n", nae_port->msec_enable);
+ 
                         if (is_nlm_xlp9xx()|| is_nlm_xlp3xx() || is_nlm_xlp2xx()) {
                                 nae_port->ext_phy_bus = 0;
                         }
diff --git a/arch/mips/netlogic/lib/netlib/src/nlm_hal_nae.c b/arch/mips/netlogic/lib/netlib/src/nlm_hal_nae.c
index 88c0367..192ff37 100644
--- a/arch/mips/netlogic/lib/netlib/src/nlm_hal_nae.c
+++ b/arch/mips/netlogic/lib/netlib/src/nlm_hal_nae.c
@@ -3518,19 +3518,19 @@ static int parse_port_config(void *fdt, int node, nlm_nae_config_ptr nae_cfg)
 
 		if(intf_type == XAUI_IF || intf_type == RXAUI_IF)
 		{
-			if(cmplx_cfg.msec_port_enable[0])
+			if(cmplx_cfg.msec_port_enable)
 				nae_cfg->msec_port_enable |=  0xf << (4 * block);
 			nae_cfg->higig_mode[block]=cmplx_cfg.higig_mode;
 			nae_cfg->xgmii_speed[block]=cmplx_cfg.xgmii_speed;
 		}
 		else{
-			nae_cfg->msec_port_enable |= cmplx_cfg.msec_port_enable[0] << (4 * block);
+			nae_cfg->msec_port_enable |= cmplx_cfg.msec_port_enable << (4 * block);
 			nae_cfg->higig_mode[block]=0;
 			nae_cfg->xgmii_speed[block]=1; /*1G SGMII*/
 		}	
 #ifdef MACSEC_DEBUG
 		nlm_print(" nae_cfg->msec_port_enable = %x block = %d cmplx_cfg.msec_port_enable = %x\n", 
-		nae_cfg->msec_port_enable, block, cmplx_cfg.msec_port_enable[0]);
+		nae_cfg->msec_port_enable, block, cmplx_cfg.msec_port_enable);
 #endif
 		for(offset = 0; offset < num_ports; offset++, port++) {
 			nae_port = &nae_cfg->ports[port];
-- 
1.7.1

