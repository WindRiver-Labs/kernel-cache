From 243bbe323bea8f6a9e77bb87fd4908fff5dbb455 Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Wed, 26 Sep 2012 12:40:14 -0700
Subject: errata: add ehb after sync/sc for linux-loader kernel module

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/drivers/misc/netlogic/linux-loader/xlr_lib_platform.h b/drivers/misc/netlogic/linux-loader/xlr_lib_platform.h
index adcd9ab..8ee6b2c 100644
--- a/drivers/misc/netlogic/linux-loader/xlr_lib_platform.h
+++ b/drivers/misc/netlogic/linux-loader/xlr_lib_platform.h
@@ -75,7 +75,8 @@ static __inline__ void lib_spin_lock(lib_spinlock_t *lock)
 	    " li\t%1, 1\n\t"
 	    "sc\t%1, %0\n\t"
 	    "beqz\t%1, 1b\n\t"
-	    " sync\n\t"
+	    " nop\n\t"
+	    " ehb\n\t"
 	    ".set\treorder"
 	    : "=m" (lock->lock), "=&r" (tmp)
 	    : "m" (lock->lock)
@@ -87,6 +88,7 @@ static __inline__ void lib_spin_unlock(lib_spinlock_t *lock)
 	__asm__ __volatile__(
 	    ".set\tnoreorder\t\t\t# spin_unlock\n\t"
 	    "sync\n\t"
+	    "ehb\n\t"
 	    "sw\t$0, %0\n\t"
 	    ".set\treorder"
 	    : "=m" (lock->lock)
-- 
1.7.1

