From 4cf2cd6590550c426dbca76385ab599c3778e1c9 Mon Sep 17 00:00:00 2001
From: Virendra Pathak <vpathak@broadcom.com>
Date: Tue, 22 Jul 2014 14:46:48 +0530
Subject: netlib: added API to get frinq desc size

[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/netlogic/lib/netlib/include/export_sym.h b/arch/mips/netlogic/lib/netlib/include/export_sym.h
index a361da6..a30fb34 100644
--- a/arch/mips/netlogic/lib/netlib/include/export_sym.h
+++ b/arch/mips/netlogic/lib/netlib/include/export_sym.h
@@ -35,6 +35,7 @@ EXPORT_SYMBOL(netsoc_init_ingress);
 EXPORT_SYMBOL(netsoc_get_frinq_base);
 EXPORT_SYMBOL(netsoc_get_txq_base);
 EXPORT_SYMBOL(netsoc_drain_frinq);
+EXPORT_SYMBOL(netsoc_get_frinq_desc_sz);
 EXPORT_SYMBOL(netsoc_drain_all_frinq);
 EXPORT_SYMBOL(netsoc_get_free_desc);
 EXPORT_SYMBOL(netsoc_set_config_free_desc);
diff --git a/arch/mips/netlogic/lib/netlib/include/netsoc_haliface.h b/arch/mips/netlogic/lib/netlib/include/netsoc_haliface.h
index 5e889e5..d9d3d17 100644
--- a/arch/mips/netlogic/lib/netlib/include/netsoc_haliface.h
+++ b/arch/mips/netlogic/lib/netlib/include/netsoc_haliface.h
@@ -72,6 +72,7 @@ extern int __netsoc_write_ucore_shared_mem(nae_t *nae, unsigned int *data, uint3
 extern void __netsoc_init_ingress(nae_t *nae, uint32_t desc_size);
 extern int __netsoc_config_vfbid_table(nae_t *nae, uint32_t start, uint32_t num_entries, uint32_t *vfbid_tbl);
 extern int __netsoc_drain_frin_fifo_descs(nae_t *nae, uint32_t frin_q);
+extern int __netsoc_get_frinq_desc_sz(nae_t *nae, uint32_t frinq_num);
 extern int __netsoc_drain_allfrin_fifo_descs(nae_t *nae);
 
 extern int __netsoc_init_poe_ext_storage(poe_t *poe, uint64_t fbp_base_phys, uint64_t fbp_base_virt,uint64_t msg_base_phys,uint64_t msg_base_virt);
diff --git a/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h b/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h
index 670a90f..5ff3cd8 100644
--- a/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h
+++ b/arch/mips/netlogic/lib/netlib/include/netsoc_libiface.h
@@ -541,6 +541,7 @@ extern int netsoc_get_free_desc(nae_t *nae, uint32_t frin_qnum);
 extern void netsoc_set_config_free_desc(nae_t *nae, uint32_t size, uint32_t start, uint32_t frin_qnum);
 extern int netsoc_drain_all_frinq(nae_t *nae);
 extern int netsoc_drain_frinq(nae_t *nae, uint32_t frin_q);
+extern int netsoc_get_frinq_desc_sz(nae_t *nae, uint32_t frinq_num);
 extern int netsoc_get_frinq_base(nae_t *nae);
 extern int netsoc_get_txq_base(nae_t *nae);
 extern int netsoc_get_total_frinq(nae_t *nae);
diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_api.c b/arch/mips/netlogic/lib/netlib/src/netsoc_api.c
index cd79a47..973c0f3 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_api.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_api.c
@@ -948,6 +948,15 @@ int netsoc_drain_frinq(nae_t *nae, uint32_t frin_q)
 	return __netsoc_drain_frin_fifo_descs(nae, frin_q);
 }
 
+int netsoc_get_frinq_desc_sz(nae_t *nae, uint32_t frinq_num)
+{
+	if (nae == NULL) {
+		return -NAE_INSTANCE_INVALID;
+	}
+
+	return __netsoc_get_frinq_desc_sz(nae, frinq_num);
+}
+
 /**
 * @brief netsoc_drain_all_frinq function is used to drain all
 * 
diff --git a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
index 968b4ab..2bb151b 100644
--- a/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
+++ b/arch/mips/netlogic/lib/netlib/src/netsoc_nae.c
@@ -1669,6 +1669,33 @@ int __netsoc_drain_frin_fifo_descs(nae_t *nae, uint32_t frin_q)
 	return timeout? 0 : -NETSOC_ERROR_INTERNAL;
 }
 
+int __netsoc_get_frinq_desc_sz(nae_t *nae, uint32_t frinq_num)
+{
+	uint32_t rx_config, val;
+	int desc_sz;
+
+	rx_config = netsoc_read_nae_reg(nae->nae_base, RX_CONFIG);
+	netsoc_api_print(NETSOC_APIDBG_GLOBAL, "%s rx_config 0x%x\n", __func__, rx_config);
+
+	if ((rx_config & (1 << 31)) == 0) {
+		netsoc_api_print(NETSOC_APIDBG_GLOBAL, "FSU is not set in RX config\n");
+		desc_sz = (rx_config >> 4) & 0xff;
+		desc_sz = desc_sz * XLP_CACHE_LINE_SIZE;
+	} else {
+		netsoc_api_print(NETSOC_APIDBG_GLOBAL, "FSU is set in RX config\n");
+		netsoc_write_nae_reg(nae->nae_base, FREE_IN_FIFO_UNIQ_SZ_CFG, ((1 << 31) | (frinq_num & 0xf)));
+		val = netsoc_read_nae_reg(nae->nae_base, FREE_IN_FIFO_UNIQ_SZ_CFG);
+		netsoc_api_print(NETSOC_APIDBG_GLOBAL, "%s val 0x%x\n", __func__, val);
+		desc_sz = ((val >> 8) & 0xff) * XLP_CACHE_LINE_SIZE;
+	}
+		
+	if (desc_sz == 0) {
+		desc_sz = (16 * 1024); /*0 means 16KBytes*/
+	}
+
+	return desc_sz;
+}
+
 #ifdef INCLUDE_NAE_DEBUG
 static int debug = 1;
 void __netsoc_print_frin_desc_carving(nae_t *nae)
-- 
1.7.1

