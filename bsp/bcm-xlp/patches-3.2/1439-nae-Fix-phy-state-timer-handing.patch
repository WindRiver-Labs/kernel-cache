From 5148c622a93f4d4c3cc324ec479bc9ea08529195 Mon Sep 17 00:00:00 2001
From: Subhendu Sekhar Behera <sbehera@broadcom.com>
Date: Thu, 27 Mar 2014 18:11:49 +0530
Subject: nae: Fix phy state timer handing.

Fix is for multinode and XLP9XX. On Multinode boards, save
the states for all the nodes' ports. On XLP9XX, the port
numbers are same for nae-0 & nae-1. Take care of it using nae_id.
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/drivers/net/ethernet/broadcom/nae/xlpge_nae.c b/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
index 39096d4..8c9fd55 100644
--- a/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
+++ b/drivers/net/ethernet/broadcom/nae/xlpge_nae.c
@@ -802,9 +802,9 @@ void nlm_xlp_nae_remove(void)
 static void phy_st_timer_handler(unsigned long data)
 {
         struct timer_list *timer = &phy_int_timer;
-	uint32_t i,num_ports,maxnae,node,speed,duplex;
+	uint32_t i,num_ports,maxnae,node,speed,duplex,port_index;
 	nae_t *nae_cfg;
-	static int arr[18];
+	static int arr[NLM_MAX_NODES][18];
 	maxnae = get_num_nae_pernode();
         for (node = 0; node < NLM_MAX_NODES; node++) {
                 int num_nae, tmp;
@@ -813,9 +813,10 @@ static void phy_st_timer_handler(unsigned long data)
                         if (nae_cfg == NULL)
                                 continue;
 				for(i=0;i<nae_cfg->num_ports;i++){
-					tmp=arr[i];
-					arr[i]=netsoc_get_phy_status(&nae_cfg->ports[i],&speed,&duplex);
-					if((arr[i]>-1)&&(arr[i]<tmp))
+					port_index = i + (nae_cfg->nae_id * nae_cfg->num_ports);
+					tmp=arr[node][port_index];
+					arr[node][port_index]=netsoc_get_phy_status(&nae_cfg->ports[i],&speed,&duplex);
+					if((arr[node][port_index]>-1)&&(arr[node][port_index]<tmp))
 						netsoc_start_autoneg(&nae_cfg->ports[i]);
 					else
 						continue;
-- 
1.7.1

