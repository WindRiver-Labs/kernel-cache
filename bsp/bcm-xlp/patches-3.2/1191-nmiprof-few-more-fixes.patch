From d6cb8c936e43362b10297ff03cb59d37b1345bc4 Mon Sep 17 00:00:00 2001
From: Jayachandran C <jchandra@broadcom.com>
Date: Tue, 8 Oct 2013 19:26:45 +0530
Subject: nmiprof: few more fixes

hwcpu calculation was incorrect, change it to use use_cpu.
Remove unnecessary casts in memcpy
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/drivers/misc/netlogic/nmiprof/nmiprof-sys.c b/drivers/misc/netlogic/nmiprof/nmiprof-sys.c
index 66e4ffb..19e4ab9 100644
--- a/drivers/misc/netlogic/nmiprof/nmiprof-sys.c
+++ b/drivers/misc/netlogic/nmiprof/nmiprof-sys.c
@@ -89,8 +89,7 @@ static ssize_t nlm_nmiprofcontrol_write(struct file *filp, struct kobject *kobj,
 			return -EINVAL;
 		}
 		nlm_pic_set_timer(xlp_pic_base, 6, ~0ULL, 0, 0);
-		memcpy(reset_data, (void *)nmiprofsave,
-				(nlm_nmiprof_end - nlm_nmiprof));
+		memcpy(reset_data, nmiprofsave, nlm_nmiprof_end - nlm_nmiprof);
 		ndev->state = 0;
 		dev_info(&ndev->dev->dev, "Stopped tracing on cpu %d\n",
 								ndev->nlm_cpu);
@@ -106,8 +105,6 @@ static ssize_t nlm_nmiprofcontrol_write(struct file *filp, struct kobject *kobj,
 		return -EINVAL;
 	}
 
-	hwcpu = cpu_logical_map(ndev->nlm_cpu);
-	memset(ndev->base, 0xa5, NMIPROF_LOG_SIZE);
 	ret = smp_call_function_single(use_cpu, nlm_config_cpu,
 			ndev->base, 1);
 	if (ret) {
@@ -116,11 +113,12 @@ static ssize_t nlm_nmiprofcontrol_write(struct file *filp, struct kobject *kobj,
 	}
 
 	ndev->nlm_cpu = use_cpu;
+	hwcpu = cpu_logical_map(use_cpu);
 	dev_info(&ndev->dev->dev, "nmiprof: start tracing on cpu %d (hw %d)\n",
 							ndev->nlm_cpu, hwcpu);
-	memcpy((void *)nmiprofsave, reset_data,
-			(nlm_nmiprof_end - nlm_nmiprof));
-	memcpy(reset_data, nlm_nmiprof, (nlm_nmiprof_end - nlm_nmiprof));
+	memset(ndev->base, 0xa5, NMIPROF_LOG_SIZE);
+	memcpy(nmiprofsave, reset_data, nlm_nmiprof_end - nlm_nmiprof);
+	memcpy(reset_data, nlm_nmiprof, nlm_nmiprof_end - nlm_nmiprof);
 
 	write_asm = (u32 *) (reset_data + (&pic_entry - nlm_nmiprof));
 	*write_asm |= (xlp_pic_base & 0xffff0000) >> 16;
-- 
1.7.1

