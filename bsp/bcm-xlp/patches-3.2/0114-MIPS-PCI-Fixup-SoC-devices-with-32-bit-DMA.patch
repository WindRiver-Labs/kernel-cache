From 2df4d9333ac9319f6efdbe9632d11b025e7fb25f Mon Sep 17 00:00:00 2001
From: Jayachandran C <jchandra@broadcom.com>
Date: Fri, 2 May 2014 13:54:51 +0530
Subject: MIPS: PCI: Fixup SoC devices with 32-bit DMA

Fixup SD/MMC device DMA operations to do 32-bit.
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/pci/pci-xlp.c b/arch/mips/pci/pci-xlp.c
index 9ea47ee..4fc5813 100644
--- a/arch/mips/pci/pci-xlp.c
+++ b/arch/mips/pci/pci-xlp.c
@@ -227,6 +227,36 @@ int __init pcibios_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)
 /* Do platform specific device initialization at pci_enable_device() time */
 int pcibios_plat_dev_init(struct pci_dev *dev)
 {
+	int dma32 = 0;
+
+	/* use SWIOTLB dma for some devices */
+	switch (dev->vendor) {
+	case PCI_VENDOR_ID_BROADCOM:	/* XLP9XX has this vendor id */
+		switch (dev->device) {
+		case PCI_DEVICE_ID_XLP9XX_MMC:
+			dma32 = 1;
+			break;
+		}
+		break;
+	case PCI_VENDOR_NETLOGIC:
+		switch (dev->device) {
+		case PCI_DEVICE_ID_NLM_MMC:
+		case PCI_DEVICE_ID_NLM_EHCI:
+		case PCI_DEVICE_ID_NLM_OHCI:
+			dma32 = 1;
+			break;
+		}
+		break;
+	}
+	if (dma32) {
+		dev->dev.archdata.dma_ops = &nlm_swiotlb_dma_ops;
+		dev->dma_mask = DMA_BIT_MASK(32);
+		dev->dev.coherent_dma_mask = DMA_BIT_MASK(32);
+	} else {
+		/* We do 64-bit DMA */
+		dev->dma_mask = DMA_BIT_MASK(64);
+		dev->dev.coherent_dma_mask = DMA_BIT_MASK(64);
+	}
 	return 0;
 }
 
-- 
1.7.1

