From bf4b3706c2d07f71dde95e8d2c7dd286f6203f72 Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Sat, 13 Jul 2013 23:30:14 -0700
Subject: xlp9xx: kvm: dtre: add attribute in xlp9xx-helinux/linux-guest dts file for dtre virtualization

  o root xlp9xx-helinux.dts: add /hypervisor:guest_use_dtre=1 so that kvm_io_manager
    would enable virtualization support for dtre.
  o Add /doms/dom@0/dtre:dtre_init_only so that root dtre driver can initialize the hardware only.
    Default is "0" to preserve existing behavior (hooking dtre with kernel ADMA support)
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/boot/dts/xlp9xx-helinux.dts b/arch/mips/boot/dts/xlp9xx-helinux.dts
index 81ada94..8992e6d 100644
--- a/arch/mips/boot/dts/xlp9xx-helinux.dts
+++ b/arch/mips/boot/dts/xlp9xx-helinux.dts
@@ -28,10 +28,8 @@
         };
 
 	hypervisor {
-		hypervisor-name = "Xen";
-		alloc_dom0_memory = <0>;
-		bootargs = "ncores=8 dom0_loadaddr=0x72000000 dom0_size=0x1c000000 dom0_cpumask=0xffffffff -- ";
-		domain_heap = <0x80000000 0x20000000>;
+		hypervisor-name = "KVM";
+		guest_use_dtre = <1>;
 	};
 	doms {
 		#address-cells = <1>;
@@ -65,6 +63,9 @@
                         };
 			pic {
 			};
+			dtre {
+				dtre_init_only = <0>;
+			};
 			owner-config {
 				nae = <0x0>;
 				sae = <0x1>;
@@ -100,6 +101,7 @@
 				onlinemask = <0xffff>;
                                 nae-rx-vc = <0>;
                                 nae-fb-vc = <3>;
+				dtre-rx-vc = <2>;
 				sae-rx-vc = <0>; /* sharing with nae */
 				sae-rx-sync-vc = <0>;  /* sharing with nae */
 				/* helinux, as only 1 thread per cpu, it should poll for both nae and sae 
diff --git a/arch/mips/boot/dts/xlp9xx-linux-guest.dts b/arch/mips/boot/dts/xlp9xx-linux-guest.dts
index 5bfb5cd..9647b14 100644
--- a/arch/mips/boot/dts/xlp9xx-linux-guest.dts
+++ b/arch/mips/boot/dts/xlp9xx-linux-guest.dts
@@ -36,6 +36,7 @@
 			os = "linux";
 
 			cpu {
+				dtre-rx-vc = <2>;
 			};
 		};
 	};
-- 
1.7.1

