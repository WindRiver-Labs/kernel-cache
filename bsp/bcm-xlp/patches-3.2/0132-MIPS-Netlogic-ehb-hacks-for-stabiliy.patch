From 7842df3a7f4ec7247175017178e637ac91d792a2 Mon Sep 17 00:00:00 2001
From: Jayachandran C <jchandra@broadcom.com>
Date: Fri, 26 Jul 2013 11:43:03 +0530
Subject: MIPS: Netlogic: ehb hacks for stabiliy

Add ehb at all exception entry points.
Add ehb after tlbp in tlbex.c (this may be a bug in the MIPS code).
[Based on SDK 3.2]
Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/kernel/genex.S b/arch/mips/kernel/genex.S
index 31fa856..e93b4ee 100644
--- a/arch/mips/kernel/genex.S
+++ b/arch/mips/kernel/genex.S
@@ -46,6 +46,9 @@
 NESTED(except_vec3_generic, 0, sp)
 	.set	push
 	.set	noat
+#ifdef CONFIG_CPU_XLP
+	_ehb
+#endif
 #if R5432_CP0_INTERRUPT_WAR
 	mfc0	k0, CP0_INDEX
 #endif
diff --git a/arch/mips/kernel/traps.c b/arch/mips/kernel/traps.c
index 61af13e..072ab3a 100644
--- a/arch/mips/kernel/traps.c
+++ b/arch/mips/kernel/traps.c
@@ -1480,6 +1480,8 @@ void __init *set_except_vector(int n, void *addr)
 #endif
 		u32 *buf = (u32 *)(ebase + 0x200);
 		unsigned int k0 = 26;
+		if (current_cpu_type() == CPU_XLP)
+			uasm_i_ehb(&buf);
 		if ((handler & jump_mask) == ((ebase + 0x200) & jump_mask)) {
 			uasm_i_j(&buf, handler & ~jump_mask);
 			uasm_i_nop(&buf);
diff --git a/arch/mips/mm/tlbex.c b/arch/mips/mm/tlbex.c
index c967255..6c44494 100644
--- a/arch/mips/mm/tlbex.c
+++ b/arch/mips/mm/tlbex.c
@@ -482,6 +482,8 @@ static void __cpuinit __maybe_unused build_tlb_probe_entry(u32 **p)
 
 	default:
 		uasm_i_tlbp(p);
+		if (cpu_has_mips_r2)
+			uasm_i_ehb(p);
 		break;
 	}
 }
@@ -1262,6 +1264,9 @@ static void __cpuinit build_r4000_tlb_refill_handler(void)
 	memset(relocs, 0, sizeof(relocs));
 	memset(final_handler, 0, sizeof(final_handler));
 
+	if (current_cpu_type() == CPU_XLP)
+		uasm_i_ehb(&p);
+
 	if ((scratch_reg >= 0 || scratchpad_available()) && use_bbit_insns()) {
 		htlb_info = build_fast_tlb_refill_handler(&p, &l, &r, K0, K1,
 							  scratch_reg);
-- 
1.7.1

