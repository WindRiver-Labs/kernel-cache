From: Nam Ninh <nam.ninh@windriver.com>
Subject: kvm-netl: fix guest hang during second boot
Date: Wed, 10 Jun 2015 13:36:13 -0400
MIME-Version: 1.0
Status: RO
X-Status: A
Content-Length: 1548
Lines: 46

The guest boots fine the first time, but always hangs when
it boots the second time on the same KVM host. The problem only
happens when we load any kernel module on the KVM host before
we boot the guest. Without any kernel modules loaded on the host,
the guest can be rebooted many times. The problem is caused by
the following commit:

    Author: Ashok Kumar <ashoks@broadcom.com>
    Date:   Wed Apr 8 13:01:15 2015 -0400

    kvm: Make kvm support compatible to CONFIG_MIPS_HUGE_TLB_SUPPORT

This commit adds support compatible to huge page in KVM and isolates
the original codes around (!pmd_huge) macro. However, in xlp.c,
the original codes should be kept unchanged when huge page is off.
This patch restores the unexpected changes to the original codes
to fix the guest reboot problem.

diff --git a/arch/mips/kvm-netl/xlp.c b/arch/mips/kvm-netl/xlp.c
index 7f0c7b3..21d4c1c 100644
--- a/arch/mips/kvm-netl/xlp.c
+++ b/arch/mips/kvm-netl/xlp.c
@@ -287,16 +287,16 @@ static void xlp_kvm_free_gpa_pgd(pgd_t *gpa_pgd)
 			if (!pmd_huge(*(pmd_t *)p1)) {
 				for (i = 0; i < PTRS_PER_PMD; i++) {
 					if (p1[i] != (unsigned long)invalid_pte_table) {
-						free_page((unsigned long)p1[i]);
+						__free_page((void *)p1[i]);
 					}
 				}
 			}
-			free_page((unsigned long)*p);
+			__free_page((void *)*p);
 		}
 #else
 		if (*p != (unsigned long)invalid_pte_table &&
 			!pud_huge(*(pud_t *)p)) {
-			free_page((unsigned long)*p);
+			__free_page((void *)*p);
 		}
 #endif
 	}
-- 
1.7.1
