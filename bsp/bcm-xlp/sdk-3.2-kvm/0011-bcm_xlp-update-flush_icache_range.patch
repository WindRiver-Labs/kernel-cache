From d93754005b843841f30e5234091270210ad8db57 Mon Sep 17 00:00:00 2001
From: Nam Ninh <nam.ninh@windriver.com>
Date: Wed, 8 Apr 2015 13:26:02 -0400
Subject: bcm_xlp: update flush_icache_range

The function smp_call_function_many() can't be called with irqs_disabled.
But ftrace_init() disables interrupts before calling it, so use
for_each_cpu to replace on_each_cpu(), else we got the below call trace.

WARNING: at kernel/smp.c:382 smp_call_function_many+0x14c/0x3f8()
Modules linked in:
CPU: 0 PID: 0 Comm: swapper/0 Not tainted 3.10.67-ovp-rt68-WR6.0.0.0_preempt-rt #3
Stack : 0000000000000006 0000000000000000 0000000000000000 0000000000000000
	  0000000000000052 ffffffffffffffff 0000000000000052 ffffffffc0c70000
	  ffffffffc0b30000 0000000000000004 0000000000000000 0000000000000000
	  0000000000000000 0000000000000000 ffffffffc0abfa98 ffffffffc014836c
	  ffffffffc09fab08 ffffffffc0abfb50 0000000000000000 0000000000000000
	  0000000000000000 ffffffffc0c90000 ffffffffc0c756e8 ffffffffc0c70000
	  ffffffffc09f8238 ffffffffc0b2dff7 000000000000017e ffffffffc09ff830
	  ffffffffc0128a88 ffffffffc0abfa18 ffffffffc0b27688 ffffffffc01452f4
	  ffffffffc0abfb28 ffffffffc08ded98 ffffffffc0abfb50 ffffffffc0145134
	  ffffffffc0abfb88 ffffffffc010fb50 ffffffffc0b2e4a8 ffffffffc09f8238
	  ...
Call Trace:
[<ffffffffc010fb50>] show_stack+0x90/0xa8
[<ffffffffc01452f4>] warn_slowpath_common+0x8c/0xc0
[<ffffffffc01b49dc>] smp_call_function_many+0x14c/0x3f8
[<ffffffffc01b4f84>] smp_call_function+0x54/0xa0
[<ffffffffc01b505c>] on_each_cpu+0x4c/0xc8
[<ffffffffc0127f70>] nlm_flush_icache_range+0x38/0x50
[<ffffffffc01145dc>] ftrace_modify_code+0x2c/0x50
[<ffffffffc0ba83d0>] ftrace_dyn_arch_init+0x8c/0xb0
[<ffffffffc0bb0abc>] ftrace_init+0x38/0x1a8
[<ffffffffc0ba0ab0>] start_kernel+0x47c/0x4ac

Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/mm/c-netlogic.c b/arch/mips/mm/c-netlogic.c
index c8c4aba..ecc15ef 100644
--- a/arch/mips/mm/c-netlogic.c
+++ b/arch/mips/mm/c-netlogic.c
@@ -360,10 +360,21 @@ static void nlm_flush_icache_range_ipi(void *info)
 void nlm_flush_icache_range(unsigned long start, unsigned long end)
 {
 	struct flush_icache_range_args args;
+	int cpu;
+	cpumask_t mask;
 
 	args.start = start;
 	args.end = end;
-	on_each_cpu(nlm_flush_icache_range_ipi, &args, 1);
+
+	preempt_disable();
+	cpu = smp_processor_id();
+	mask = *cpu_online_mask;
+	cpumask_clear_cpu(cpu, &mask);
+
+	for_each_cpu(cpu, &mask)
+		nlm_flush_icache_range_ipi(&args);
+
+	preempt_enable();
 }
 
 static void nlm_flush_cache_sigtramp_ipi(void *info)
-- 
1.7.1

