From 954a275463c7b7047179f2d8e41bb0050fc09dd7 Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Wed, 8 Apr 2015 12:46:01 -0400
Subject: cop2: kvm: enable COP2 early for root cpu

  o In below call stack, COP2 registers saves happened.
	   setup_arch
	     arch_mem_init
	       plat_mem_setup
	         nlm_wakeup_secondary_cpus
	           xlp_wakeup_secondary_cpus
	             xlp_boot_core0_siblings
	               SAVEALL
     In linux/init/main.c, setup_arch is called earlier
     than trap_init. The trap_init setups exception vectors properly
     including enabling CU2 bit in the status register.

     For guestOS, if COP2 is not enabled, accessing COP2
     registers will produce guest level exceptions. Since
     exception vectors has not been setup yet, incorrect
     execution will happen.

     So we need to enable COP2 earlier.

Signed-off-by: Yonghong Song <ysong@broadcom.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index d847ad2..1e3609b 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -211,6 +211,14 @@ void __init prom_init(void)
 			(nlm_reset_entry_end - nlm_reset_entry));
 
 	set_system_type();
+#ifdef CONFIG_NLM_ENABLE_COP2
+	/*
+	 * SAVE_ALL / RESTORE_ALL has been hacked to save COP2
+	 * registers, this fails in guest because COP2 is not
+	 * enabled for the guest when it boots up
+	 */
+	write_c0_status(read_c0_status() | ST0_CU2);
+#endif
 
 #ifdef CONFIG_KEXEC
 	nlm_kexec_init();
-- 
1.7.1

