From e01196486d9f7d7fd4104920bb348ae5258c2ae7 Mon Sep 17 00:00:00 2001
From: Jayachandran C <jchandra@broadcom.com>
Date: Wed, 8 Apr 2015 12:48:01 -0400
Subject: kvm: Add flag for guest kernel

Add variable is_nlm_guest_os to identify the guest kernel under KVM

Signed-off-by: Jayachandran C <jchandra@broadcom.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/include/asm/netlogic/xlp-hal/xlp.h b/arch/mips/include/asm/netlogic/xlp-hal/xlp.h
index 8fa27af..60f7a2f 100644
--- a/arch/mips/include/asm/netlogic/xlp-hal/xlp.h
+++ b/arch/mips/include/asm/netlogic/xlp-hal/xlp.h
@@ -145,5 +145,9 @@ static inline int cpu_is_xlp5xx(void)
 
 	return chip == PRID_IMP_NETLOGIC_XLP5XX;
 }
+
+/* virutalization */
+extern int is_nlm_guest_os;
+
 #endif /* !__ASSEMBLY__ */
 #endif /* _ASM_NLM_XLP_H */
diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index 1e3609b..3642abd 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -53,6 +53,9 @@
 uint64_t nlm_io_base;
 EXPORT_SYMBOL(nlm_io_base);
 
+int is_nlm_guest_os = 0;
+EXPORT_SYMBOL(is_nlm_guest_os);
+
 struct nlm_soc_info nlm_nodes[NLM_NR_NODES];
 cpumask_t nlm_cpumask = CPU_MASK_CPU0;
 unsigned int nlm_threads_per_core;
@@ -183,6 +186,23 @@ void xlp_mmu_init(void)
 	}
 }
 
+static void xlp_guest_check(void)
+{
+	uint32_t saved_val, tmp_val;
+
+	saved_val = __read_32bit_c0_register($12, 6); /* read guestctl0 register */
+	__write_32bit_c0_register($12, 6, (1 << 30)); /* guest RI redirect bit */
+	tmp_val = __read_32bit_c0_register($12, 6);
+	if (tmp_val == 0) {
+		/* write has no effect */
+		is_nlm_guest_os = 1;
+	} else {
+		/* not guest mode, restore the original value */
+		__write_32bit_c0_register($12, 6, saved_val);
+	}
+}
+
+
 void nlm_percpu_init(int hwcpuid)
 {
 }
@@ -194,6 +214,8 @@ void __init prom_init(void)
 {
 	void *reset_vec;
 
+	if (cpu_is_xlp9xx())
+		xlp_guest_check();
 	nlm_io_base = CKSEG1ADDR(XLP_DEFAULT_IO_BASE);
 	if (cpu_is_xlp9xx())
 		xlp_cores_per_node = 32;
-- 
1.7.1

