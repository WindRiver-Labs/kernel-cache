From 87a5324a157998224283e8c864feeb37d6c21793 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Thu, 25 Apr 2013 17:00:06 +0800
Subject: [PATCH 702/761] Kernel: Compressed Linux Kernel support.

Based on Broadcom SDK 2.3.

Signed-off-by: Manish Duggal <manishd@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/Kconfig                                  |    1 +
 arch/mips/Makefile                                 |    2 +-
 arch/mips/boot/compressed/Makefile                 |   14 +++++++++++---
 arch/mips/boot/compressed/calc_vmlinuz_load_addr.c |    2 +-
 arch/mips/boot/compressed/decompress.c             |    1 +
 arch/mips/boot/compressed/head.S                   |    2 +-
 arch/mips/boot/compressed/uart-16550.c             |   11 ++++++++---
 arch/mips/netlogic/Kconfig                         |    1 +
 8 files changed, 25 insertions(+), 9 deletions(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index e130852..82f22b3 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -783,6 +783,7 @@ config NLM_XLP_EVP_BOARD
         select SYNC_R4K
         select SYS_HAS_EARLY_PRINTK
 	select SYS_SUPPORTS_NUMA
+	select SYS_SUPPORTS_ZBOOT
         help
           This board is based on Netlogic XLP Processor.
           Say Y here to support this machine type
diff --git a/arch/mips/Makefile b/arch/mips/Makefile
index 3a872f4..784fe65 100644
--- a/arch/mips/Makefile
+++ b/arch/mips/Makefile
@@ -315,7 +315,7 @@ vmlinuz vmlinuz.bin vmlinuz.ecoff vmlinuz.srec: $(vmlinux-32) FORCE
 	   VMLINUX_LOAD_ADDRESS=$(load-y) 32bit-bfd=$(32bit-bfd) $@
 
 
-CLEAN_FILES += vmlinux.32 vmlinux.64
+CLEAN_FILES += vmlinux.32 vmlinux.64 vmlinuz 
 
 archprepare:
 ifdef CONFIG_MIPS32_N32
diff --git a/arch/mips/boot/compressed/Makefile b/arch/mips/boot/compressed/Makefile
index 5042d51..080ed54 100644
--- a/arch/mips/boot/compressed/Makefile
+++ b/arch/mips/boot/compressed/Makefile
@@ -19,11 +19,18 @@ BOOT_HEAP_SIZE := 0x400000
 KBUILD_CFLAGS := $(shell echo $(KBUILD_CFLAGS) | sed -e "s/-pg//")
 
 KBUILD_CFLAGS := $(LINUXINCLUDE) $(KBUILD_CFLAGS) -D__KERNEL__ \
-	-DBOOT_HEAP_SIZE=$(BOOT_HEAP_SIZE) -D"VMLINUX_LOAD_ADDRESS_ULL=$(VMLINUX_LOAD_ADDRESS)ull"
+	-DBOOT_HEAP_SIZE=$(BOOT_HEAP_SIZE) -D"VMLINUX_LOAD_ADDRESS_ULL=$(CONFIG_PHYS_LOAD_ADDRESS)ull"
+
+ifdef CONFIG_MAPPED_KERNEL
+ENTRY_POINT=" phys_entry"
+else
+ENTRY_POINT=" kernel_entry"
+endif
 
 KBUILD_AFLAGS := $(LINUXINCLUDE) $(KBUILD_AFLAGS) -D__ASSEMBLY__ \
 	-DBOOT_HEAP_SIZE=$(BOOT_HEAP_SIZE) \
-	-DKERNEL_ENTRY=0x$(shell $(NM) $(objtree)/$(KBUILD_IMAGE) 2>/dev/null | grep " kernel_entry" | cut -f1 -d \ )
+	-DKERNEL_ENTRY=0x$(shell $(NM) $(objtree)/$(KBUILD_IMAGE) 2>/dev/null | grep $(ENTRY_POINT) | cut -f1 -d \ )
+
 
 targets := head.o decompress.o dbg.o uart-16550.o uart-alchemy.o
 
@@ -59,7 +66,8 @@ $(obj)/piggy.o: $(obj)/dummy.o $(obj)/vmlinux.bin.z FORCE
 hostprogs-y := calc_vmlinuz_load_addr
 
 VMLINUZ_LOAD_ADDRESS = $(shell $(obj)/calc_vmlinuz_load_addr \
-		$(obj)/vmlinux.bin $(VMLINUX_LOAD_ADDRESS))
+		$(obj)/vmlinux.bin $(CONFIG_PHYS_LOAD_ADDRESS))
+
 
 vmlinuzobjs-y += $(obj)/piggy.o
 
diff --git a/arch/mips/boot/compressed/calc_vmlinuz_load_addr.c b/arch/mips/boot/compressed/calc_vmlinuz_load_addr.c
index 9a62436..cd3fcc8 100644
--- a/arch/mips/boot/compressed/calc_vmlinuz_load_addr.c
+++ b/arch/mips/boot/compressed/calc_vmlinuz_load_addr.c
@@ -50,7 +50,7 @@ int main(int argc, char *argv[])
 	 */
 
 	vmlinuz_load_addr += (16 - vmlinux_size % 16);
-
+	
 	printf("0x%llx\n", vmlinuz_load_addr);
 
 	return EXIT_SUCCESS;
diff --git a/arch/mips/boot/compressed/decompress.c b/arch/mips/boot/compressed/decompress.c
index 5cad0fa..ae9e0fe 100644
--- a/arch/mips/boot/compressed/decompress.c
+++ b/arch/mips/boot/compressed/decompress.c
@@ -16,6 +16,7 @@
 
 #include <asm/addrspace.h>
 
+
 /*
  * These two variables specify the free mem region
  * that can be used for temporary malloc area
diff --git a/arch/mips/boot/compressed/head.S b/arch/mips/boot/compressed/head.S
index 4e65a84..67110b3 100644
--- a/arch/mips/boot/compressed/head.S
+++ b/arch/mips/boot/compressed/head.S
@@ -44,7 +44,7 @@ start:
 	move	a1, s1
 	move	a2, s2
 	move	a3, s3
-	PTR_LI	k0, KERNEL_ENTRY
+	PTR_LI	k0, ( KERNEL_ENTRY )
 	jr	k0
 	 nop
 3:
diff --git a/arch/mips/boot/compressed/uart-16550.c b/arch/mips/boot/compressed/uart-16550.c
index c9caaf4..faf494d 100644
--- a/arch/mips/boot/compressed/uart-16550.c
+++ b/arch/mips/boot/compressed/uart-16550.c
@@ -18,23 +18,28 @@
 #define PORT(offset) (CKSEG1ADDR(AR7_REGS_UART0) + (4 * offset))
 #endif
 
+#ifdef CONFIG_NLM_XLP
+#define UART_BASE 0x18030100
+#define PORT(offset) (CKSEG1ADDR(UART_BASE) + (4 * offset))
+#endif
+
 #ifndef PORT
 #error please define the serial port address for your own machine
 #endif
 
 static inline unsigned int serial_in(int offset)
 {
-	return *((char *)PORT(offset));
+	return *((u32 *)PORT(offset));
 }
 
 static inline void serial_out(int offset, int value)
 {
-	*((char *)PORT(offset)) = value;
+	*((u32 *)PORT(offset)) = value;
 }
 
 void putc(char c)
 {
-	int timeout = 1024;
+	int timeout = 1024000;
 
 	while (((serial_in(UART_LSR) & UART_LSR_THRE) == 0) && (timeout-- > 0))
 		;
diff --git a/arch/mips/netlogic/Kconfig b/arch/mips/netlogic/Kconfig
index e6c8dd5..dfcf79f 100644
--- a/arch/mips/netlogic/Kconfig
+++ b/arch/mips/netlogic/Kconfig
@@ -9,6 +9,7 @@ config NLMCOMMON
 
 config NLM_XLP
 	select NLM_ATOMICS if !NLM_XLP_A0_WORKAROUNDS
+	select SYS_SUPPORTS_ZBOOT_UART16550
 	bool
 
 config NLM_ATOMICS
-- 
1.7.10.4

