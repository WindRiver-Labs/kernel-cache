From 30a6bd8f32ab9f61119f64fc7fddab5e859991a5 Mon Sep 17 00:00:00 2001
From: Virendra Pathak <vpathak@broadcom.com>
Date: Wed, 27 Feb 2013 13:49:10 +0530
Subject: [PATCH 691/762] gbu : cortina support in frequency value

Based on Broadcom SDK 2.3.

Signed-off-by: Virendra Pathak <vpathak@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/netlogic/hal/nlm_evp_cpld.h |    4 +++-
 arch/mips/netlogic/common/nlm_evp_cpld.c          |   15 +++++++++------
 2 files changed, 12 insertions(+), 7 deletions(-)

diff --git a/arch/mips/include/asm/netlogic/hal/nlm_evp_cpld.h b/arch/mips/include/asm/netlogic/hal/nlm_evp_cpld.h
index d9bf075..bf784cc 100644
--- a/arch/mips/include/asm/netlogic/hal/nlm_evp_cpld.h
+++ b/arch/mips/include/asm/netlogic/hal/nlm_evp_cpld.h
@@ -47,7 +47,9 @@
 #endif
 
 #define CORTINA_ILK1_BASE	0x17100000
-#define CORTINA_ILK2_BASE       0x17200000
+#define CORTINA_ILK2_BASE	0x17200000
+#define NLM_GBU_FREQ_DEFAULT	133
+#define NLM_GBU_FREQ_ILK	16
 	
 #define NLM_XLP_MAX_CS  7
 
diff --git a/arch/mips/netlogic/common/nlm_evp_cpld.c b/arch/mips/netlogic/common/nlm_evp_cpld.c
index 5329b4f..9dde1f8 100644
--- a/arch/mips/netlogic/common/nlm_evp_cpld.c
+++ b/arch/mips/netlogic/common/nlm_evp_cpld.c
@@ -211,23 +211,26 @@ int xlp_cpld_init(uint32_t cs)
 void set_gbu_frequency(int node, int frequency)
 {
 	const uint64_t mhz = 1000000;
-	nlm_print("GBU Frequency set to %d\n", frequency);
+	uint64_t set_freq;
 	if(is_nlm_xlp2xx()) {
-		nlm_hal_xlp2xx_set_clkdev_frq(node, XLP2XX_CLKDEVICE_GBU, frequency * mhz);
+		set_freq = nlm_hal_xlp2xx_set_clkdev_frq(node, XLP2XX_CLKDEVICE_GBU, frequency * mhz);
 	}
 	else {
-		uint64_t set_freq;
 		set_freq = nlm_hal_set_soc_freq(node, DFS_DEVICE_NOR, frequency * mhz);
-		NLM_HAL_DO_DIV(set_freq,mhz);
-		nlm_print("GBU Frequency set to %lluMHz\n", set_freq);
 	}
+	NLM_HAL_DO_DIV(set_freq,mhz);
+	nlm_print("GBU Frequency set to %lluMHz\n", set_freq);
 }
 
 void nlm_hal_cpld_init(int node)
 {
 #if !defined(XLP_SIM) || defined(NLM_BOARD)
 	int i;
-	set_gbu_frequency(node, 16);
+#if defined(NLM_CORTINA_SUPPORT)
+	set_gbu_frequency(node, NLM_GBU_FREQ_ILK);
+#else
+	set_gbu_frequency(node, NLM_GBU_FREQ_DEFAULT);
+#endif
 	for(i=2; i<5; i++)
         	xlp_cpld_init(i);
 #endif
-- 
1.7.0.4

