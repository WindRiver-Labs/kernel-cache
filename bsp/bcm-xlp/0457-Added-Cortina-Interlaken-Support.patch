From f92c72cbc05789c41ad6c571789de3a00f9c0ce9 Mon Sep 17 00:00:00 2001
From: Jayanthi A <jayanthia@netlogicmicro.com>
Date: Tue, 18 Oct 2011 17:49:10 +0530
Subject: [PATCH 457/762] Added Cortina Interlaken Support.

Based on Broadcom SDK 2.3.

Signed-off-by: Jayanthi A <jayanthia@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/netlogic/nlm_fs.h |    4 ++++
 arch/mips/kernel/nlm_fs.c               |    2 ++
 arch/mips/kernel/nlm_fs_handler.S       |   24 ++++++++++++++++++++++++
 arch/mips/netlogic/Kconfig              |    7 +++++++
 arch/mips/netlogic/common/Makefile      |   10 +++++++++-
 arch/mips/netlogic/msgcfg/Makefile      |    2 ++
 6 files changed, 48 insertions(+), 1 deletions(-)

diff --git a/arch/mips/include/asm/netlogic/nlm_fs.h b/arch/mips/include/asm/netlogic/nlm_fs.h
index 67200f5..4156f79 100644
--- a/arch/mips/include/asm/netlogic/nlm_fs.h
+++ b/arch/mips/include/asm/netlogic/nlm_fs.h
@@ -26,9 +26,13 @@
 #define NLM_FS_MEM_WRITE32        22
 #define NLM_FS_MSGSND3            23
 #define NLM_FS_MSGRCV1            24
+#define NLM_FS_MEM_READ16        25
+#define NLM_FS_MEM_WRITE16       26
 
 #ifndef __ASSEMBLY__
 
+extern void nlm_fs_mem_read16(void);
+extern void nlm_fs_mem_write16(void);
 extern void nlm_fs_mem_read32(void);
 extern void nlm_fs_mem_write32(void);
 extern void nlm_fs_mem_read64(void);
diff --git a/arch/mips/kernel/nlm_fs.c b/arch/mips/kernel/nlm_fs.c
index 4f6e24d..d46ad83 100644
--- a/arch/mips/kernel/nlm_fs.c
+++ b/arch/mips/kernel/nlm_fs.c
@@ -42,6 +42,8 @@ unsigned long nlm_fs_table[] = {
 	[NLM_FS_MSGSND3]          = (unsigned long)nlm_fs_msgsnd3,
 	[NLM_FS_MSGRCV1]          = (unsigned long)nlm_fs_msgrcv1,
 #endif /* CONFIG_NLM_XLR */
+	[NLM_FS_MEM_READ16]       = (unsigned long)nlm_fs_mem_read16,
+        [NLM_FS_MEM_WRITE16]      = (unsigned long)nlm_fs_mem_write16,
 	0
 };
 
diff --git a/arch/mips/kernel/nlm_fs_handler.S b/arch/mips/kernel/nlm_fs_handler.S
index c6b3bdf..70b1c10 100644
--- a/arch/mips/kernel/nlm_fs_handler.S
+++ b/arch/mips/kernel/nlm_fs_handler.S
@@ -305,6 +305,30 @@ NESTED(nlm_fs_mem_write32, PT_SIZE, sp)
 	fs_eret
 END(nlm_fs_mem_write32)
 
+NESTED(nlm_fs_mem_read16, PT_SIZE, sp)
+       /* address is in (t0-msb, t1-lsb) */
+       dsll32  k0, T0, 0
+       dsll32  k1, T1, 0
+       dsrl32  T1, k1, 0
+       or      T0, k0, T1
+
+       /* data is in t2 */
+       lh      T2, (T0)
+       fs_eret
+END(nlm_fs_mem_read16)
+
+NESTED(nlm_fs_mem_write16, PT_SIZE, sp)
+        /* address is in (t0-msb, t1-lsb) */
+        dsll32  k0, T0, 0
+        dsll32  k1, T1, 0
+        dsrl32  T1, k1, 0
+        or      T0, k0, T1
+
+        /* data is in t2 */
+        sh      T2, (T0)
+        fs_eret
+END(nlm_fs_mem_write16)
+
 NESTED(nlm_fs_c0_count, PT_SIZE, sp)
 
 	mfc0    T0, $9, 0
diff --git a/arch/mips/netlogic/Kconfig b/arch/mips/netlogic/Kconfig
index ef4aa44..3a90704 100644
--- a/arch/mips/netlogic/Kconfig
+++ b/arch/mips/netlogic/Kconfig
@@ -221,6 +221,13 @@ config NLM_ENABLE_COP2
 	help
 	  This option enables cop2 access for both user and kernel space.
 
+config NLM_CORTINA_SUPPORT
+	bool "Enable Cortina Interlaken Support "
+	depends on NLM_XLP
+	default n
+	help
+	  This option enables Cortina Interlaken Card Support.
+
 config NLM_XLP_DEVMODE
 	depends on NLM_XLP
 	bool "Enable XLP device mode"
diff --git a/arch/mips/netlogic/common/Makefile b/arch/mips/netlogic/common/Makefile
index dafba61..54bd989 100644
--- a/arch/mips/netlogic/common/Makefile
+++ b/arch/mips/netlogic/common/Makefile
@@ -6,9 +6,17 @@ obj-$(CONFIG_NLM_XLR)			+= msgring.o
 obj-$(CONFIG_NLM_XLR)			+= msgring_xls.o
 obj-$(CONFIG_NLM_XLR)			+= msgring_shared.o
 
-obj-$(CONFIG_NLM_XLP)			+= nlm_hal_fmn_config.o
+obj-$(CONFIG_NLM_XLP)			+= nlm_hal_fmn_config.o nlm_evp_cpld.o
 obj-$(CONFIG_NLM_XLP)			+= nlm_hal.o nlm_hal_nae.o fdt_helper.o
 
+ifeq ($(CONFIG_NLM_CORTINA_SUPPORT),y)
+obj-y					+= cortina_cs34x7/nlm_cortina_cs34x7.o cortina_cs34x7/nlm_cortina_cs34x7_p1.o cortina_cs34x7/nlm_cortina_cs34x7_p2.o \
+					   cortina_cs34x7/nlm_cortina_cs34x7_p3.o cortina_cs34x7/nlm_cortina_cs34x7_p4.o cortina_cs34x7/nlm_cortina_cs34x7_p5.o \
+					   cortina_cs34x7/nlm_cortina_cs34x7_p6.o cortina_cs34x7/nlm_cortina_cs34x7_p7.o cortina_cs34x7/nlm_cortina_cs34x7_p8.o \
+					   cortina_cs34x7/nlm_cortina_cs34x7_p9.o cortina_cs34x7/nlm_cortina_cs34x7_p10.o cortina_cs34x7/nlm_cortina_cs34x7_p11.o \
+					   cortina_cs34x7/nlm_cortina_cs34x7_p12.o
+EXTRA_CFLAGS += -DNLM_CORTINA_SUPPORT
+endif
 obj-$(CONFIG_RAPIDIO)             	+= srio.o
 obj-$(CONFIG_NLMCOMMON_IP_OVER_PCI) 	+= dma.o
 obj-$(CONFIG_SMP)                 	+= smp.o
diff --git a/arch/mips/netlogic/msgcfg/Makefile b/arch/mips/netlogic/msgcfg/Makefile
index dbe1479..795da4c 100644
--- a/arch/mips/netlogic/msgcfg/Makefile
+++ b/arch/mips/netlogic/msgcfg/Makefile
@@ -26,6 +26,8 @@ ifneq ("$(HAL_DIR)", "")
 	$(Q)cp -fr $(FDT_DIR)/libfdt/contrib/fdt_helper.h $(LOCAL_HAL_DIR)/
 	$(Q)cp -fr $(HAL_DIR)/nlm_hal.c  ../common
 	$(Q)cp -fr $(HAL_DIR)/nlm_hal_fmn_config.c  ../common
+	$(Q)cp -fr $(HAL_DIR)/nlm_evp_cpld.c  ../common
+	$(Q)cp -fr $(HAL_DIR)/cortina_cs34x7  ../common
 	$(Q)cp -fr $(HAL_DIR)/nlm_hal_nae.c  ../common
 	$(Q)cp -fr $(FDT_DIR)/libfdt/contrib/fdt_helper.c  ../common
 	/bin/rm -rf $(LOCAL_HAL_DIR)/nlm_hal_pic.h
-- 
1.7.0.4

