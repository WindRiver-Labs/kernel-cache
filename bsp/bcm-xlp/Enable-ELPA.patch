From 1c7e62f872e95bf092258211e9848f3eba10acb4 Mon Sep 17 00:00:00 2001
From: Jayanthi Annadurai <jayanthia@netlogicmicro.com>
Date: Fri, 17 Jun 2011 13:20:25 -0700
Subject: [PATCH 301/761] Enable ELPA

Based on Broadcom SDK 2.3.

Signed-off-by: Jayanthi Annadurai <jayanthia@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/kernel/traps.c |    8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/arch/mips/kernel/traps.c b/arch/mips/kernel/traps.c
index 2c7c560..8e6ed97 100644
--- a/arch/mips/kernel/traps.c
+++ b/arch/mips/kernel/traps.c
@@ -1598,6 +1598,9 @@ void __cpuinit per_cpu_trap_init(void)
 {
 	unsigned int cpu = smp_processor_id();
 	unsigned int status_set = ST0_CU0;
+#if defined(CONFIG_NLM_XLP) && (CONFIG_64BIT)
+        unsigned int pagegrain;
+#endif
 	unsigned int hwrena = cpu_hwrena_impl_bits;
 #ifdef CONFIG_MIPS_MT_SMTC
 	int secondaryTC = 0;
@@ -1642,6 +1645,11 @@ void __cpuinit per_cpu_trap_init(void)
 	change_c0_status(ST0_CU|ST0_MX|ST0_RE|ST0_FR|ST0_BEV|ST0_TS|ST0_KX|ST0_SX|ST0_UX,
 			 status_set);
 
+#if defined(CONFIG_NLM_XLP) && (CONFIG_64BIT)
+	pagegrain = read_c0_pagegrain();
+	pagegrain |= PG_ELPA;
+	write_c0_pagegrain(pagegrain);
+#endif
 	if (cpu_has_mips_r2)
 		hwrena |= 0x0000000f;
 
-- 
1.7.10.4

