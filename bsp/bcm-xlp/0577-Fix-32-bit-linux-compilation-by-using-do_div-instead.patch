From ba32b43050c5783848a401bc765fee58f2247d0b Mon Sep 17 00:00:00 2001
From: Anurag <anurag.gopinath@broadcom.com>
Date: Mon, 23 Jul 2012 17:36:40 +0530
Subject: [PATCH 577/762] Fix : 32 bit linux compilation by using do_div instead of direct division.

    Also updating CPU freq value in proc entries to MHz.

Based on Broadcom SDK 2.3.

Signed-off-by: Anurag <anurag.gopinath@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 .../asm/netlogic/xlp8xx/cpu_control_macros.h       |    4 ----
 arch/mips/kernel/proc.c                            |    8 ++++++--
 arch/mips/netlogic/xlp/xlp-cpufreq.c               |   11 +++++++++++
 3 files changed, 17 insertions(+), 6 deletions(-)

diff --git a/arch/mips/include/asm/netlogic/xlp8xx/cpu_control_macros.h b/arch/mips/include/asm/netlogic/xlp8xx/cpu_control_macros.h
index 3358235..a8c6afd 100644
--- a/arch/mips/include/asm/netlogic/xlp8xx/cpu_control_macros.h
+++ b/arch/mips/include/asm/netlogic/xlp8xx/cpu_control_macros.h
@@ -27,9 +27,5 @@ void enable_cpus(unsigned int, unsigned int);
 u32 get_core_dfs(int);
 u32 change_cpu_freq(int, int);
 extern int xlp8xx_a01_workaround_needed;
-#define get_cpu_freq_masked(cpu_num, mask)\
-	((nlm_hal_cpu_freq()/1000ULL) & (mask))
-#define XLP_FREQ_MASK	(0xfffffff0)
-#define XLP_CPU0	0
 #endif	// __ASSEMBLY__
 #endif /* __CPUCONTROL_MACROS_H__ */
diff --git a/arch/mips/kernel/proc.c b/arch/mips/kernel/proc.c
index 4b4ce88..f57d760 100644
--- a/arch/mips/kernel/proc.c
+++ b/arch/mips/kernel/proc.c
@@ -27,6 +27,8 @@ static int show_cpuinfo(struct seq_file *m, void *v)
 	unsigned int fp_vers = cpu_data[n].fpu_id;
 	char fmt [64];
 	int cpu __maybe_unused, i;
+	uint64_t freq;
+	const uint64_t mhz = 1000000;
 
 #ifdef CONFIG_SMP
 	if (!cpu_online(n))
@@ -54,9 +56,11 @@ static int show_cpuinfo(struct seq_file *m, void *v)
 	/* workaround for compiler warning */
 	version = fp_vers = 0;
 
-	seq_printf(m, "cpu model\t\t: %s %s @%lldkHz\n", __cpu_name[n],
+        freq = nlm_hal_cpu_freq();
+        do_div(freq, mhz);
+	seq_printf(m, "cpu model\t\t: %s %s @%lld MHz\n", __cpu_name[n],
 		   (cpu_data[n].options & MIPS_CPU_FPU ? "  FPU " : ""),
-		   get_cpu_freq_masked(n, XLP_FREQ_MASK));
+		    freq);
 #else
 	sprintf(fmt, "cpu model\t\t: %%s V%%d.%%d%s\n",
 	        cpu_data[n].options & MIPS_CPU_FPU ? "  FPU V%d.%d" : "");
diff --git a/arch/mips/netlogic/xlp/xlp-cpufreq.c b/arch/mips/netlogic/xlp/xlp-cpufreq.c
index c689cdc..bca080c 100644
--- a/arch/mips/netlogic/xlp/xlp-cpufreq.c
+++ b/arch/mips/netlogic/xlp/xlp-cpufreq.c
@@ -10,6 +10,17 @@
 
 #define XLP_CPU_PER_NODE	4
 
+static int get_cpu_freq_masked(int cpu_num, int mask)
+{
+        uint64_t freq = nlm_hal_cpu_freq();
+        const uint64_t khz = 1000;
+
+        do_div(freq, khz);
+        return (freq & (mask));
+}
+#define XLP_FREQ_MASK  (0xfffffff0)
+#define XLP_CPU0       0
+
 static spinlock_t freq_lock = SPIN_LOCK_UNLOCKED;
 static struct cpumask xlp_affected_cpus[NR_CPUS];
 /* The following are the possible devisors
-- 
1.7.0.4

