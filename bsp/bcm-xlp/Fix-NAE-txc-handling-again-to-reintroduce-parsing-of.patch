From d6427e006c56ebe8b50865b7b0d430268e03da82 Mon Sep 17 00:00:00 2001
From: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Date: Sun, 5 Sep 2010 12:47:24 -0700
Subject: [PATCH 176/761] Fix NAE txc handling again to reintroduce parsing of
 context field

Based on Broadcom SDK 2.3.

Signed-off-by: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/on_chip.c |    1 -
 arch/mips/netlogic/xlp/setup.c   |    2 --
 drivers/net/xlp_nae/xlp_nae.c    |   21 +++++++++++++--------
 3 files changed, 13 insertions(+), 11 deletions(-)

diff --git a/arch/mips/netlogic/xlp/on_chip.c b/arch/mips/netlogic/xlp/on_chip.c
index 981db64..854fc2a 100644
--- a/arch/mips/netlogic/xlp/on_chip.c
+++ b/arch/mips/netlogic/xlp/on_chip.c
@@ -46,7 +46,6 @@ THE POSSIBILITY OF SUCH DAMAGE.
 unsigned long netlogic_io_base = (unsigned long)(DEFAULT_NETLOGIC_IO_BASE);
 EXPORT_SYMBOL(netlogic_io_base);
 
-extern uint32_t xlp_linux_cpu_mask;
 extern int hwemul;
 
 extern void nlm_cpu_stat_update_msgring_int(void);
diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index a73e224..97ead89 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -132,8 +132,6 @@ EXPORT_SYMBOL(chip_is_xls_b0);
 EXPORT_SYMBOL(xlp_sgmii_ports);
 EXPORT_SYMBOL(hwemul);
 
-uint32_t xlp_linux_cpu_mask;
-
 void *nlm_common_psb_shm = 0;
 unsigned long nlm_common_psb_shm_size = 0;
 extern unsigned long _text[];
diff --git a/drivers/net/xlp_nae/xlp_nae.c b/drivers/net/xlp_nae/xlp_nae.c
index f26af2f..663cbde 100644
--- a/drivers/net/xlp_nae/xlp_nae.c
+++ b/drivers/net/xlp_nae/xlp_nae.c
@@ -896,20 +896,25 @@ static void nlm_xlp_nae_msgring_handler(uint32_t vc, uint32_t src_id,
 
 	if( vc == 1 && size == 1)
 	{
-		/* Transmit Complete */
-		addr = msg0 & 0xfffffffff0ULL;
-		port = msg0 & 0x0f;
-		len = (msg0 >> 40) & 0x3fff;
+		/* Process Transmit Complete */
+		addr = msg0 & 0xffffffffffULL;
+
+		/* context is XLP_SGMII_RCV_CONTEXT_NUM + three bit vlan type
+		 * or vlan priority
+		 */
+		context = (msg0 >> 40) & 0x3fff;
+		port = context / XLP_SGMII_RCV_CONTEXT_NUM;
 
         	/* update dev and port to be accurate */
-		if(port < 0 || port >= MAX_GMAC_PORT)
-		{
-			port = 0;
+		if(port >= MAX_GMAC_PORT) {
+			printk("[%s]: [txc] Bad port %d (context=%d)\n",
+			       __func__, port, context);
 		}
 
 		pdev = (struct net_device*)dev_mac[port];
 		if(!pdev) {
-			printk("[%s]: [txc] wrong port=%d? pdev = NULL!\n", __func__, port);
+			printk("[%s]: [txc] wrong port=%d? pdev = NULL!\n",
+			       __func__, port);
 			return;
 		}
 		priv = netdev_priv(pdev);
-- 
1.7.10.4

