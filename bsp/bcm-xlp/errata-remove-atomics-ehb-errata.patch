From d01a96d4673f4b5fa11a578bb949747f8265be5b Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Thu, 14 Mar 2013 09:10:17 -0700
Subject: [PATCH 711/761] errata: remove atomics/ehb errata

Based on Broadcom SDK 2.3.

Signed-off-by: Yonghong Song <ysong@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/barrier.h              |   23 +----------------------
 arch/mips/include/asm/io.h                   |    2 --
 arch/mips/include/asm/netlogic/nlm_rw_lock.h |    2 +-
 3 files changed, 2 insertions(+), 25 deletions(-)

diff --git a/arch/mips/include/asm/barrier.h b/arch/mips/include/asm/barrier.h
index 002591b..e45aeb6 100644
--- a/arch/mips/include/asm/barrier.h
+++ b/arch/mips/include/asm/barrier.h
@@ -66,20 +66,7 @@
 #define smp_read_barrier_depends()	do { } while(0)
 
 #ifdef CONFIG_CPU_HAS_SYNC
-
-#ifdef CONFIG_NLM_XLP
-#define __sync()				\
-	__asm__ __volatile__(			\
-		".set	push\n\t"		\
-		".set	noreorder\n\t"		\
-		".set	mips64r2\n\t"		\
-		"sync\n\t"			\
-		"ehb\n\t"			\
-		".set	pop"			\
-		: /* no output */		\
-		: /* no input */		\
-		: "memory")
-#else /* !CONFIG_NLM_XLP */
+	#define __sync()			\
 	__asm__ __volatile__(			\
 		".set	push\n\t"		\
 		".set	noreorder\n\t"		\
@@ -89,8 +76,6 @@
 		: /* no output */		\
 		: /* no input */		\
 		: "memory")
-#endif /* CONFIG_NLM_XLP */
-
 #else
 #define __sync()	do { } while(0)
 #endif
@@ -177,13 +162,7 @@
 #endif
 
 #if defined(CONFIG_WEAK_REORDERING_BEYOND_LLSC) && defined(CONFIG_SMP)
-
-#ifdef CONFIG_NLM_XLP
-#define __WEAK_LLSC_MB		".set push\n\t .set mips64r2\n\t sync\n\t ehb\n\t .set pop\n"
-#else /* !CONFIG_NLM_XLP */
 #define __WEAK_LLSC_MB		"       sync	\n"
-#endif /* CONFIG_NLM_XLP */
-
 #else
 #define __WEAK_LLSC_MB		"		\n"
 #endif
diff --git a/arch/mips/include/asm/io.h b/arch/mips/include/asm/io.h
index eeeef42..a58f229 100644
--- a/arch/mips/include/asm/io.h
+++ b/arch/mips/include/asm/io.h
@@ -534,8 +534,6 @@ BUILDSTRING(q, u64)
 
 #ifdef CONFIG_CPU_CAVIUM_OCTEON
 #define mmiowb() wmb()
-#elif defined(CONFIG_NLM_XLP)
-#define mmiowb() asm volatile ("sync\n ehb" ::: "memory")
 #else
 /* Depends on MIPS II instruction set */
 #define mmiowb() asm volatile ("sync" ::: "memory")
diff --git a/arch/mips/include/asm/netlogic/nlm_rw_lock.h b/arch/mips/include/asm/netlogic/nlm_rw_lock.h
index 5fded8b..74527e0 100644
--- a/arch/mips/include/asm/netlogic/nlm_rw_lock.h
+++ b/arch/mips/include/asm/netlogic/nlm_rw_lock.h
@@ -40,7 +40,7 @@ typedef struct {
 	int write_cpu; /* CPU that is currently holding wr lock */
 } nlm_rwlock_t;
 
-#define nlm_sync() __asm__ __volatile__("sync\n ehb": : :"memory")
+#define nlm_sync() __asm__ __volatile__("sync": : :"memory")
 __asm__ (
 		".macro\tnlm_local_irq_save result\n\t"
 		".set\tpush\n\t"
-- 
1.7.10.4

