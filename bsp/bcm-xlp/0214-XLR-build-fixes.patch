From 7f3d9dd4f57a3e5798ec1422a7fdede77e8bc150 Mon Sep 17 00:00:00 2001
From: Zi Shen Lim <zlim@netlogicmicro.com>
Date: Tue, 19 Oct 2010 21:40:01 -0700
Subject: [PATCH 214/762] XLR build fixes

Based on Broadcom SDK 2.3.

Signed-off-by: Zi Shen Lim <zlim@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/netlogic/mips-exts.h |    5 +++++
 arch/mips/mm/cerr-nlm.c                    |    2 +-
 arch/mips/netlogic/msgcfg/Makefile         |    4 ++--
 arch/mips/netlogic/xlr/on_chip.c           |    1 -
 arch/mips/netlogic/xlr/setup.c             |    3 +--
 arch/mips/pci/pci-xlr.c                    |   10 +++++-----
 drivers/net/xlr_mac.c                      |    4 ----
 7 files changed, 14 insertions(+), 15 deletions(-)

diff --git a/arch/mips/include/asm/netlogic/mips-exts.h b/arch/mips/include/asm/netlogic/mips-exts.h
index 247d6dd..e618ee1 100644
--- a/arch/mips/include/asm/netlogic/mips-exts.h
+++ b/arch/mips/include/asm/netlogic/mips-exts.h
@@ -266,6 +266,11 @@ static __inline__ int hard_smp_processor_id(void)
 	return cpu;
 }
 
+static __inline__ int netlogic_cpu_id(void)
+{
+	return hard_smp_processor_id() >> 2;
+}
+
 static __inline__ int netlogic_thr_id(void)
 {
 	return hard_smp_processor_id() & 0x03;
diff --git a/arch/mips/mm/cerr-nlm.c b/arch/mips/mm/cerr-nlm.c
index 744fda5..9ee643d 100644
--- a/arch/mips/mm/cerr-nlm.c
+++ b/arch/mips/mm/cerr-nlm.c
@@ -127,7 +127,7 @@ static void print_cerr_info(void)
 	cerr_printk("Bridge: The devices reporting AERR are:\n");
 	tmp = netlogic_read_reg(mmio, 41);
 	for(i = 0; i < 16; i++) {
-		if (tmp & (1<<i)) xlr_cerr_printk("\t%s\n", bridge_aerr_intr_devstat[i]);
+		if (tmp & (1<<i)) cerr_printk("\t%s\n", bridge_aerr_intr_devstat[i]);
 	}
 
 	cerr_cpu_log = read_64bit_nlm_ctrl_reg(CPU_BLOCKID_LSU, LSU_CERRLOG_REGID);
diff --git a/arch/mips/netlogic/msgcfg/Makefile b/arch/mips/netlogic/msgcfg/Makefile
index 83b16c9..124d1ee 100644
--- a/arch/mips/netlogic/msgcfg/Makefile
+++ b/arch/mips/netlogic/msgcfg/Makefile
@@ -3,7 +3,7 @@ LOCAL_HAL_DIR :=$(srctree)/arch/mips/include/asm/netlogic/hal
 EXTRA_CFLAGS := $(CFLAGS) -DNLM_HAL_LINUX_KERNEL -I$(LOCAL_HAL_DIR)
 EXTRA_AFLAGS := $(CFLAGS)
 
-ifdef CONFIG_NLM_XLR
+ifneq ($(CONFIG_NLM_XLR), "")
 clean-files += msgring_shared.lex.c
 clean-files += msgring_xls.lex.c
 clean-files += msgring.yacc.c
@@ -28,8 +28,8 @@ ifneq ("$(HAL_DIR)", "")
 	$(Q)cp -fr $(HAL_DIR)/nlm_hal_nae.c  ../common
 endif
 
+ifneq ($(CONFIG_NLM_XLR), "")
 msgring:
-ifdef CONFIG_NLM_XLR
 	make -f Makefile.msgring all
 	make -f Makefile.msgring.xls all
 	make -f Makefile.msgring.shared all
diff --git a/arch/mips/netlogic/xlr/on_chip.c b/arch/mips/netlogic/xlr/on_chip.c
index 9be91ed..35cb87a 100644
--- a/arch/mips/netlogic/xlr/on_chip.c
+++ b/arch/mips/netlogic/xlr/on_chip.c
@@ -180,7 +180,6 @@ void nlm_common_msgring_cpu_init(void)
 	int id;
 	unsigned long flags;
 	int shared_msgring = 0;
-	static int only_once = 0;
 
 	id = cpu_logical_map(get_cpu());
 
diff --git a/arch/mips/netlogic/xlr/setup.c b/arch/mips/netlogic/xlr/setup.c
index 25f70c3..de01ab4 100644
--- a/arch/mips/netlogic/xlr/setup.c
+++ b/arch/mips/netlogic/xlr/setup.c
@@ -61,9 +61,9 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #include <linux/proc_fs.h>
 #include <asm/mach-netlogic/mmu.h>
 #include <asm/netlogic/xlr_board.h>
-#include "libfdt/libfdt_env.h"
 #include "ops.h"
 
+#define fdt32_to_cpu(x) be32_to_cpu(x)
 
 #ifdef NLM_BRIDGE_WKAROUND
 #include <asm/netlogic/nlm_rw_lock.h>
@@ -998,7 +998,6 @@ static int wakeup_secondary_cpus(void)
 
 	prepare_wakeup((unsigned long)secondary_cpus_bootup_func);
 
-	//wakeup_mask = (__u32)prom_info->nlm_cpu_online_map & (~smp_boot.online_map);
 	wakeup_mask = (__u32)xlr_linux_cpu_mask & (~smp_boot.online_map);
 
 	for(i=0; i < NR_CPUS; i++) {
diff --git a/arch/mips/pci/pci-xlr.c b/arch/mips/pci/pci-xlr.c
index 542c5c6..dc3c800 100644
--- a/arch/mips/pci/pci-xlr.c
+++ b/arch/mips/pci/pci-xlr.c
@@ -498,11 +498,6 @@ void nlm_ide_mm_outb (u8 value, unsigned long port)
 	__raw_writeb(value, pci_ide_phys_to_virt(port));
 }
 
-static void nlm_ide_mm_outbsync (ide_drive_t *drive, u8 value, unsigned long port)
-{
-	__raw_writeb(value, pci_ide_phys_to_virt(port));
-}
-
 void nlm_ide_mm_outw (u16 value, unsigned long port)
 {
 	__raw_writew(swab16(value), pci_ide_phys_to_virt(port));
@@ -514,6 +509,11 @@ void nlm_ide_mm_outl (u32 value, unsigned long port)
 }
 
 #if 0
+static void nlm_ide_mm_outbsync (ide_drive_t *drive, u8 value, unsigned long port)
+{
+	__raw_writeb(value, pci_ide_phys_to_virt(port));
+}
+
 void xlr_hwif_mmiops (ide_hwif_t *hwif)
 {
 	hwif->OUTB      = nlm_ide_mm_outb;
diff --git a/drivers/net/xlr_mac.c b/drivers/net/xlr_mac.c
index 62db521..1c3dbf8 100644
--- a/drivers/net/xlr_mac.c
+++ b/drivers/net/xlr_mac.c
@@ -1713,10 +1713,6 @@ xlr_napi_poll_upper(struct net_device *dummy_dev, int budget)
 	int size = 0, code = 0;
 	struct tx_stn_handler *handler;
 	int tx_stid, rcv_mask;
-#ifdef CONFIG_64BIT
-	unsigned long tmp;
-#endif /* CONFIG_64BIT */
-
 
 	data_rx_bucket = netlogic_thr_id() + 4;
 
-- 
1.7.0.4

