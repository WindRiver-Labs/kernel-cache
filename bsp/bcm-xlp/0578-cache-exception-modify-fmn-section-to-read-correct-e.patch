From 353e5efbfea087b2f89d2aa953a429b7ed27df54 Mon Sep 17 00:00:00 2001
From: Lakshan Dias <ldias@broadcom.com>
Date: Thu, 2 Aug 2012 01:12:02 -0700
Subject: [PATCH 578/762] cache-exception: modify fmn section to read correct error registers

Based on Broadcom SDK 2.3.

Signed-off-by: Lakshan Dias <ldias@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/mm/cerr-nlm.c |   54 ++++++++++++++++++++++++++++------------------
 1 files changed, 33 insertions(+), 21 deletions(-)

diff --git a/arch/mips/mm/cerr-nlm.c b/arch/mips/mm/cerr-nlm.c
index beed0cd..4efb76d 100644
--- a/arch/mips/mm/cerr-nlm.c
+++ b/arch/mips/mm/cerr-nlm.c
@@ -193,21 +193,20 @@ static void dump_cerr_info(void)
 	uint32_t l3_reg1 = nlm_hal_read_32bit_reg(mmio, 0xDA);
 	uint32_t l3_reg2 = nlm_hal_read_32bit_reg(mmio, 0xDB);
 
-	uint32_t cop2_txmsgstatus, cop2_msgstatus1, cop2_msgerr0;
-	uint32_t cop2_msgerr1, cop2_msgerr2, cop2_msgerr3;
+	uint32_t cop2_txmsgstatus, cop2_msgstatus1;
+	uint64_t fmn_msgerr, fmn_mmio;
+
+	mmio = nlm_hal_get_dev_base(node, 0, NLH_FMN, 0);
+    fmn_mmio = nlm_hal_read_32bit_reg(mmio, 0x04);
+    fmn_msgerr = nlm_hal_read_64bit_reg(fmn_mmio, 0x2010);
+	mmio = nlm_hal_get_dev_base(node, 0, NLH_BRIDGE, 0);
+
 	cop2_txmsgstatus = (uint32_t) _read_32bit_cp2_register($2);
 	cop2_msgstatus1  = (uint32_t) _read_32bit_cp2_register($4);
-	cop2_msgerr0 = (uint32_t) _read_32bit_cp2_register_sel($6, 0);
-	cop2_msgerr1 = (uint32_t) _read_32bit_cp2_register_sel($6, 1);
-	cop2_msgerr2 = (uint32_t) _read_32bit_cp2_register_sel($6, 2);
-	cop2_msgerr3 = (uint32_t) _read_32bit_cp2_register_sel($6, 3);
-	cop2_msgerr3 = (uint32_t) _read_32bit_cp2_register_sel($6, 3);
 
 	cerr_printk("CPU (XLP specific) registers dump: Node=%d \n", node);
-	cerr_printk("    COP2: TxMsgStatus = 0x%08x, MsgStatus1 = 0x%08x, MsgError0 = 0x%08x\n",
-				cop2_txmsgstatus, cop2_msgstatus1, cop2_msgerr0 );
-	cerr_printk("          MsgError1 = 0x%08x, MsgError2 = 0x%08x, MsgError3 = 0x%08x\n",
-				cop2_msgerr1, cop2_msgerr2, cop2_msgerr3 );
+	cerr_printk("    COP2: TxMsgStatus = 0x%08x, MsgStatus1 = 0x%08x, FMNMsgError = 0x%016x\n",
+				cop2_txmsgstatus, cop2_msgstatus1, fmn_msgerr );
 
 	cerr_printk("     ICU: log0 = 0x%08x, log1 = 0x%08x, log2 = 0x%08x\n",
 				icu_log0, icu_log1, icu_log2);
@@ -247,16 +246,16 @@ static void dump_cerr_info(void)
 
 static int check_COP2_error(void)
 {
-	uint32_t cop2_txmsgstatus, cop2_msgstatus1, cop2_msgerr0;
-	uint32_t cop2_msgerr1, cop2_msgerr2, cop2_msgerr3;
+	uint32_t cop2_txmsgstatus, cop2_msgstatus1;
+	int node = hard_smp_processor_id() / NLM_MAX_CPU_PER_NODE;
+	uint64_t mmio = nlm_hal_get_dev_base(node, 0, NLH_FMN, 0);
+    uint64_t fmn_mmio, fmn_msgerr;
+    fmn_mmio = nlm_hal_read_32bit_reg(mmio, 0x04);
+    fmn_msgerr = nlm_hal_read_64bit_reg(fmn_mmio, 0x2010);
 	cop2_txmsgstatus = (uint32_t)_read_32bit_cp2_register( $2 );
 	cop2_msgstatus1  = (uint32_t)_read_32bit_cp2_register( $4 );
-	cop2_msgerr0 = (uint32_t)_read_32bit_cp2_register_sel($6, 0);
-	cop2_msgerr1 = (uint32_t)_read_32bit_cp2_register_sel($6, 1);
-	cop2_msgerr2 = (uint32_t)_read_32bit_cp2_register_sel($6, 2);
-	cop2_msgerr3 = (uint32_t)_read_32bit_cp2_register_sel($6, 3);
 
-	if( ((cop2_txmsgstatus >> 3) & 1) == 0 && ((cop2_msgstatus1 >> 12) & 1) == 0 ) return 0;
+	if( ((cop2_txmsgstatus >> 3) & 1) == 0 && ((cop2_msgstatus1 >> 12) & 1) == 0 && (fmn_msgerr & 0x3ff) == 0 ) return 0;
 
 	cerr_printk("COP2 Cache error: \n");
 	if( (cop2_txmsgstatus >> 3) & 1 )
@@ -281,9 +280,22 @@ static int check_COP2_error(void)
 		cerr_printk("     OQID: 0x%03x\n", cop2_msgstatus1 & 0xFFF );
 	}
 
-	cerr_printk("  The receive massage that has error:\n");
-	cerr_printk("    bits[31:0]=0x%08x, bits[63:32]=0x%08x, bits[95:64]=0x%08x, bits[103:96]=0x%x\n",
-				cop2_msgerr0, cop2_msgerr1, cop2_msgerr2, cop2_msgerr3);
+    if (fmn_msgerr & 0x00000000000003ff) {
+		cerr_printk("       RI: 0x%x\n", (fmn_msgerr >> 44 ) & 0x7FFF );
+		cerr_printk("       SD: %d\n",   (fmn_msgerr >> 32 ) & 0x1FF );
+		cerr_printk("       OQ: %d\n",   (fmn_msgerr >> 16 ) & 0xFFF );
+		cerr_printk("       EC: %d\n",   (fmn_msgerr >> 12 ) & 0xF );
+		cerr_printk("       FF: %d\n",   (fmn_msgerr >> 9 ) & 1 );
+		cerr_printk("       ID: %d\n",   (fmn_msgerr >> 8 ) & 1 );
+		cerr_printk("       BT: %d\n",   (fmn_msgerr >> 7 ) & 1 );
+		cerr_printk("       BE: %d\n",   (fmn_msgerr >> 6 ) & 1 );
+		cerr_printk("       SU: %d\n",   (fmn_msgerr >> 5 ) & 1 );
+		cerr_printk("       SC: %d\n",   (fmn_msgerr >> 4 ) & 1 );
+		cerr_printk("       BU: %d\n",   (fmn_msgerr >> 3 ) & 1 );
+		cerr_printk("       BC: %d\n",   (fmn_msgerr >> 2 ) & 1 );
+		cerr_printk("       OU: %d\n",   (fmn_msgerr >> 1 ) & 1 );
+		cerr_printk("       OC: %d\n",   (fmn_msgerr >> 0 ) & 1 );
+    }
 
 	return -1;
 }
-- 
1.7.0.4

