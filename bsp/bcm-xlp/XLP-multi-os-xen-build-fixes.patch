From 7788c98a0f4d64ac4cb009936a83c9ba15bdeb79 Mon Sep 17 00:00:00 2001
From: Zi Shen Lim <zlim@netlogicmicro.com>
Date: Thu, 2 Feb 2012 20:41:34 -0800
Subject: [PATCH 536/761] XLP: multi-os/xen build fixes

Workaround for run-time initialization crashes due to
unsupported features and unused code path.

Based on Broadcom SDK 2.3.

Signed-off-by: Zi Shen Lim <zlim@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/tty/hvc/Kconfig           |    2 +-
 drivers/xen/Kconfig               |   10 ++++++----
 drivers/xen/Makefile              |    4 +---
 drivers/xen/xenbus/xenbus_probe.c |    4 ++++
 4 files changed, 12 insertions(+), 8 deletions(-)

diff --git a/drivers/tty/hvc/Kconfig b/drivers/tty/hvc/Kconfig
index 0282a83..9262db6 100644
--- a/drivers/tty/hvc/Kconfig
+++ b/drivers/tty/hvc/Kconfig
@@ -59,7 +59,7 @@ config HVC_IUCV
 
 config HVC_XEN
 	bool "Xen Hypervisor Console support"
-	depends on XEN
+	depends on XEN && !NLM_XLP
 	select HVC_DRIVER
 	select HVC_IRQ
 	default y
diff --git a/drivers/xen/Kconfig b/drivers/xen/Kconfig
index ea20c51..0bd11d6 100644
--- a/drivers/xen/Kconfig
+++ b/drivers/xen/Kconfig
@@ -3,6 +3,7 @@ menu "Xen driver support"
 
 config XEN_BALLOON
 	bool "Xen memory balloon driver"
+	depends on !NLM_XLP
 	default y
 	help
 	  The balloon driver allows the Xen domain to request more memory from
@@ -69,6 +70,7 @@ config XEN_SCRUB_PAGES
 
 config XEN_DEV_EVTCHN
 	tristate "Xen /dev/xen/evtchn device"
+	depends on !NLM_XLP
 	default y
 	help
 	  The evtchn driver allows a userspace process to triger event
@@ -78,7 +80,7 @@ config XEN_DEV_EVTCHN
 
 config XEN_BACKEND
 	bool "Backend driver support"
-	depends on XEN_DOM0
+	depends on XEN_DOM0 && !NLM_XLP
 	default y
 	help
 	  Support for backend device drivers that provide I/O services
@@ -123,7 +125,7 @@ config XEN_XENBUS_FRONTEND
 
 config XEN_GNTDEV
 	tristate "userspace grant access device driver"
-	depends on XEN
+	depends on XEN && !NLM_XLP
 	default m
 	select MMU_NOTIFIER
 	help
@@ -131,7 +133,7 @@ config XEN_GNTDEV
 
 config XEN_GRANT_DEV_ALLOC
 	tristate "User-space grant reference allocator driver"
-	depends on XEN
+	depends on XEN && !NLM_XLP
 	default m
 	help
 	  Allows userspace processes to create pages with access granted
@@ -140,7 +142,7 @@ config XEN_GRANT_DEV_ALLOC
 
 config SWIOTLB_XEN
 	def_bool y
-	depends on PCI
+	depends on PCI && !NLM_XLP
 	select SWIOTLB
 
 config XEN_TMEM
diff --git a/drivers/xen/Makefile b/drivers/xen/Makefile
index 1f375bf..61c9459 100644
--- a/drivers/xen/Makefile
+++ b/drivers/xen/Makefile
@@ -28,10 +28,8 @@ xen-privcmd-y				:= privcmd.o
 
 ifeq ("$(CONFIG_NLM_XLP)", "y")
 ## skip unsupported features
-obj-unsupported	:= balloon.o xen-balloon.o
+obj-unsupported	:= balloon.o
 obj-unsupported	+= tmem.o
 obj-unsupported	+= pci.o
-obj-unsupported += xen-gntdev.o xen-gntalloc.o
 obj-y	:= $(filter-out $(obj-unsupported),$(obj-y))
-obj-m	:= $(filter-out $(obj-unsupported),$(obj-m))
 endif
diff --git a/drivers/xen/xenbus/xenbus_probe.c b/drivers/xen/xenbus/xenbus_probe.c
index d7f2b62..f196686 100644
--- a/drivers/xen/xenbus/xenbus_probe.c
+++ b/drivers/xen/xenbus/xenbus_probe.c
@@ -754,6 +754,9 @@ static int __init xenbus_init(void)
 		xen_store_interface = mfn_to_virt(xen_store_mfn);
 	}
 
+#ifdef CONFIG_NLM_XLP
+	pr_info("XENBUS: not yet supported\n");
+#else
 	/* Initialize the interface to xenstore. */
 	err = xs_init();
 	if (err) {
@@ -761,6 +764,7 @@ static int __init xenbus_init(void)
 		       "XENBUS: Error initializing xenstore comms: %i\n", err);
 		goto out_error;
 	}
+#endif
 
 #ifdef CONFIG_XEN_COMPAT_XENFS
 	/*
-- 
1.7.10.4

