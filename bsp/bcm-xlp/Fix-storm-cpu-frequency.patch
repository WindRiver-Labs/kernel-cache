From 3fb5ef2c6df79af94b5d9c84aef7da1d8671f958 Mon Sep 17 00:00:00 2001
From: Jayanthi Annadurai <jayanthia@netlogicmicro.com>
Date: Mon, 1 Aug 2011 03:06:55 -0700
Subject: [PATCH 304/761] Fix: storm cpu frequency

Based on Broadcom SDK 2.3.

Signed-off-by: Jayanthi Annadurai <jayanthia@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/setup.c |   28 +++++++++++++++++++++++++++-
 1 file changed, 27 insertions(+), 1 deletion(-)

diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index 631989d..1aaabf4 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -310,11 +310,37 @@ unsigned int __cpuinit get_c0_compare_int(void)
     return IRQ_TIMER;
 }
 
+unsigned long long storm_cpu_freq(void)  //TODO After fixing nlm_hal_cpu_freq(), remove this function
+{
+        unsigned long long mips_counter_frequency;
+        unsigned int pwron_rst_reg = nlm_hal_read_sys_reg(POWER_ON_RESET_CFG);
+        int core = (read_c0_ebase() >> 2) & 0x7;
+
+        int pll_divf = (pwron_rst_reg >> 10) & 0x7f;
+        int pll_divr = (pwron_rst_reg >> 8)  & 0x3;
+        int dfs_div  = (pwron_rst_reg >> 17) & 0x3;
+        int ext_div  = ((pwron_rst_reg >> 30) & 0x3) + 1;
+
+        unsigned long long vco_fs         = (((7500 * 1000) * (pll_divr+1))/(4 * (pll_divf+1)));
+        unsigned long long pll_period_fs  = vco_fs * 2; /* pll output is divided by 2 */
+
+        mips_counter_frequency = 1000000000000000ULL/pll_period_fs;
+
+        dfs_div = ((nlm_hal_read_sys_reg(CORE_DFS_DIV_VALUE) >> (core * 4)) & 0xF) + 1;
+
+        mips_counter_frequency = mips_counter_frequency / (ext_div * dfs_div);
+
+        return mips_counter_frequency;
+}
+
 /* TODO: Get this from FDT */
 void plat_time_init(void)
 {
 	extern void nlm_common_timer_setup(void);
-	mips_hpt_frequency = (unsigned int) nlm_hal_cpu_freq();
+        if (is_nlm_xlp3xx())
+                mips_hpt_frequency = (unsigned int) storm_cpu_freq();
+        else
+                mips_hpt_frequency = (unsigned int) nlm_hal_cpu_freq();
 	printk("mips_hpt_frequency = %u\n", mips_hpt_frequency);
 	nlm_common_timer_setup();
 }
-- 
1.7.10.4

