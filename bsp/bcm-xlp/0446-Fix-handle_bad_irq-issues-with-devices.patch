From 8f0b4f7ed579c5ec19614dea963c44758fb6b53d Mon Sep 17 00:00:00 2001
From: Zi Shen Lim <zlim@netlogicmicro.com>
Date: Mon, 10 Oct 2011 14:10:08 -0700
Subject: [PATCH 446/762] Fix handle_bad_irq issues with devices

install default handler: handle_level_irq
fix irq_ack(), purge deprecated end(), general cleanup

Based on Broadcom SDK 2.3.

Signed-off-by: Zi Shen Lim <zlim@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/irq.c |   34 ++++++----------------------------
 1 files changed, 6 insertions(+), 28 deletions(-)

diff --git a/arch/mips/netlogic/xlp/irq.c b/arch/mips/netlogic/xlp/irq.c
index c7ef077..e1fda3a 100644
--- a/arch/mips/netlogic/xlp/irq.c
+++ b/arch/mips/netlogic/xlp/irq.c
@@ -567,31 +567,9 @@ static void nlm_irq_ack(struct irq_data *d)
 		pr_err("irq = %d. Invalid irq requested\n", irq);
 		return;
 	}
-	/* If edge triggered, ack it ASAP. Handle the interrupt later */
-	if (PIC_IRQ_IS_EDGE_TRIGGERED(xlp_irq_to_irt(irq))) {
-		spin_lock_irqsave(&xlp_pic_lock, flags);
-		nlm_hal_ack_pic(xlp_irq_to_irt(irq));
-		spin_unlock_irqrestore(&xlp_pic_lock, flags);
-	}
-}
-
-static void nlm_irq_end(unsigned int irq)
-{
-	unsigned long flags;
-
-	if((irq < XLP_IRQ_RESERVED_MAX) && (irq >= 0)) {
-		return;
-	} else if(irq >= XLP_IRQ_MAX) {
-		pr_err("irq = %d. Invalid irq requested\n", irq);
-		return;
-	}
-	/* If level triggered, ack it after the device condition is cleared */
-	if (!PIC_IRQ_IS_EDGE_TRIGGERED(xlp_irq_to_irt(irq))) {
-		spin_lock_irqsave(&xlp_pic_lock, flags);
-		nlm_hal_ack_pic(xlp_irq_to_irt(irq));
-		spin_unlock_irqrestore(&xlp_pic_lock, flags);
-	}
-	return;
+	spin_lock_irqsave(&xlp_pic_lock, flags);
+	nlm_hal_ack_pic(xlp_irq_to_irt(irq));
+	spin_unlock_irqrestore(&xlp_pic_lock, flags);
 }
 
 /*
@@ -749,9 +727,8 @@ static struct irq_chip nlm_irq_pic = {
 	.irq_mask = nlm_irq_mask,
 	.irq_unmask = nlm_irq_unmask,
 	.irq_startup = nlm_irq_startup,
-	.irq_mask = nlm_irq_shutdown,
+	.irq_shutdown = nlm_irq_shutdown,
 	.irq_ack = nlm_irq_ack,
-	// .end = nlm_irq_end, /* deprecated */
 	.irq_set_affinity = nlm_irq_set_affinity
 };
 
@@ -1502,7 +1479,8 @@ void __init init_nlm_common_irqs(void)
 
 	for (i = 0; i < XLP_IRQ_MAX; i++) {	// IRQ : 0 - 167
 		if (i >= PIC_IRQ_BASE)
-			irq_set_chip(i, &nlm_irq_pic);
+			irq_set_chip_and_handler(i, &nlm_irq_pic,
+						 handle_level_irq);
 		else
 			irq_set_chip_and_handler(i, &nlm_cpu_intr,
 						 handle_percpu_irq);
-- 
1.7.0.4

