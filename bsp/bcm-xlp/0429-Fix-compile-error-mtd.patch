From 6e4812531b57d080f96fb5515103070d302465c1 Mon Sep 17 00:00:00 2001
From: Zi Shen Lim <zlim@netlogicmicro.com>
Date: Fri, 30 Sep 2011 20:29:06 -0700
Subject: [PATCH 429/762] Fix compile error: mtd

mtd_device_{,un}register replaced {add,del}_mtd_partitions in mainline.
mtd_has_partitions check deprecated in mainline.

Based on Broadcom SDK 2.3.

Signed-off-by: Zi Shen Lim <zlim@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/mtd/devices/mt29f_spi.c |   61 ++++++++++++++++----------------------
 1 files changed, 26 insertions(+), 35 deletions(-)

diff --git a/drivers/mtd/devices/mt29f_spi.c b/drivers/mtd/devices/mt29f_spi.c
index 7de0684..3ea51b5 100644
--- a/drivers/mtd/devices/mt29f_spi.c
+++ b/drivers/mtd/devices/mt29f_spi.c
@@ -633,6 +633,8 @@ static int __devinit mt29f_probe(struct spi_device *spi)
 	struct mt29f	*snand;
 	uint16_t snand_id;
 	int	i;
+	struct mtd_partition *parts = NULL;
+	int nr_parts = 0;
 
 	pdata = spi->dev.platform_data;
 	snand = kzalloc(sizeof(struct mt29f), GFP_KERNEL);
@@ -701,42 +703,34 @@ static int __devinit mt29f_probe(struct spi_device *spi)
 				snand->mtd.eraseregions[i].erasesize / 1024,
 				snand->mtd.eraseregions[i].numblocks);
 
+	if (mtd_has_cmdlinepart()) {
+		static const char *part_probes[]
+				= { "cmdlinepart", NULL, };
 
-	if (mtd_has_partitions()) {
-		struct mtd_partition	*parts = NULL;
-		int			nr_parts = 0;
-
-		if (mtd_has_cmdlinepart()) {
-			static const char *part_probes[]
-					= { "cmdlinepart", NULL, };
-
-			nr_parts = parse_mtd_partitions(&snand->mtd,
-					part_probes, &parts, 0);
-		}
+		nr_parts = parse_mtd_partitions(&snand->mtd,
+				part_probes, &parts, 0);
+	}
 
-                if((nr_parts == 0) && (pdata == 0)) {
-                        parts    = xlp_mt29f_part;
-                        nr_parts = ARRAY_SIZE(xlp_mt29f_part);
-                }
+	if ((nr_parts == 0) && (pdata == 0)) {
+		parts    = xlp_mt29f_part;
+		nr_parts = ARRAY_SIZE(xlp_mt29f_part);
+	}
 
-		if (nr_parts > 0) {
-			for (i = 0; i < nr_parts; i++) {
-				DEBUG(MTD_DEBUG_LEVEL2, "partitions[%d] = "
-					"{.name = %s, .offset = 0x%llx, "
-						".size = 0x%llx (%lldKiB) }\n",
-					i, parts[i].name,
-					(long long)parts[i].offset,
-					(long long)parts[i].size,
-					(long long)(parts[i].size >> 10));
-			}
-			snand->partitioned = 1;
-			return add_mtd_partitions(&snand->mtd, parts, nr_parts);
+	if (nr_parts > 0) {
+		for (i = 0; i < nr_parts; i++) {
+			DEBUG(MTD_DEBUG_LEVEL2, "partitions[%d] = "
+				"{.name = %s, .offset = 0x%llx, "
+				".size = 0x%llx (%lldKiB) }\n",
+				i, parts[i].name,
+				(long long)parts[i].offset,
+				(long long)parts[i].size,
+				(long long)(parts[i].size >> 10));
 		}
-	} else if (pdata && pdata->nr_parts) {
-		dev_warn(&spi->dev, "ignoring %d default partitions on %s\n",
-				pdata->nr_parts, pdata->name);
+		snand->partitioned = 1;
+		return mtd_device_register(&snand->mtd, parts, nr_parts);
 	}
-	return add_mtd_device(&snand->mtd) == 1 ? -ENODEV : 0;
+
+	return mtd_device_register(&snand->mtd, NULL, 0) ? -ENODEV : 0;
 }
 
 
@@ -745,10 +739,7 @@ static int __devexit mt29f_remove(struct spi_device *spi)
 	struct mt29f	*snand = dev_get_drvdata(&spi->dev);
 	int		status;
 
-	if (mtd_has_partitions() && snand->partitioned)
-		status = del_mtd_partitions(&snand->mtd);
-	else
-		status = del_mtd_device(&snand->mtd);
+	status = mtd_device_unregister(&snand->mtd);
 	if (status == 0)
 		kfree(snand);
 	return 0;
-- 
1.7.0.4

