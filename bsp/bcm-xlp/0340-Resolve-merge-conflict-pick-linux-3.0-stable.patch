From a2f91c63d29b784aeebc533188452f333854e464 Mon Sep 17 00:00:00 2001
From: Zi Shen Lim <zlim@netlogicmicro.com>
Date: Thu, 29 Sep 2011 14:08:35 -0700
Subject: [PATCH 340/762] Resolve merge conflict: pick linux-3.0-stable

Deprecate CONFIG_PREEMPT

Based on Broadcom SDK 2.3.

Signed-off-by: Zi Shen Lim <zlim@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/asmmacro.h |   25 -------------------------
 arch/mips/include/asm/irqflags.h |   34 ----------------------------------
 2 files changed, 0 insertions(+), 59 deletions(-)

diff --git a/arch/mips/include/asm/asmmacro.h b/arch/mips/include/asm/asmmacro.h
index 3d41593..6c8342a 100644
--- a/arch/mips/include/asm/asmmacro.h
+++ b/arch/mips/include/asm/asmmacro.h
@@ -20,27 +20,6 @@
 #include <asm/mipsmtregs.h>
 #endif
 
-#ifdef CONFIG_PREEMPT
-
-.macro __preempt_disable
-lw  t0, TI_PRE_COUNT($28);
-addiu t0, 1;
-sw t0, TI_PRE_COUNT($28);
-.endm
-
-	.macro __preempt_enable
-lw  t0, TI_PRE_COUNT($28)
-	subu t0, 1
-sw t0, TI_PRE_COUNT($28)
-	.endm
-
-#else
-
-#define __preempt_disable
-#define __preempt_enable
-
-#endif
-
 #ifdef CONFIG_MIPS_MT_SMTC
 	.macro	local_irq_enable reg=t0
 	mfc0	\reg, CP0_TCSTATUS
@@ -68,21 +47,17 @@ sw t0, TI_PRE_COUNT($28)
 	.endm
 #else
 	.macro	local_irq_enable reg=t0
-	__preempt_disable
 	mfc0	\reg, CP0_STATUS
 	ori	\reg, \reg, 1
 	mtc0	\reg, CP0_STATUS
-	__preempt_enable
 	irq_enable_hazard
 	.endm
 
 	.macro	local_irq_disable reg=t0
-	__preempt_disable
 	mfc0	\reg, CP0_STATUS
 	ori	\reg, \reg, 1
 	xori	\reg, \reg, 1
 	mtc0	\reg, CP0_STATUS
-	__preempt_enable
 	irq_disable_hazard
 	.endm
 #endif /* CONFIG_MIPS_MT_SMTC */
diff --git a/arch/mips/include/asm/irqflags.h b/arch/mips/include/asm/irqflags.h
index 33b1a0e..309cbcd 100644
--- a/arch/mips/include/asm/irqflags.h
+++ b/arch/mips/include/asm/irqflags.h
@@ -15,32 +15,6 @@
 
 #include <linux/compiler.h>
 #include <asm/hazards.h>
-#include <asm/mipsregs.h>
-
-#ifdef CONFIG_64BIT
-#define TI_PREEMPT_COUNT 36
-#else
-#define TI_PREEMPT_COUNT 20
-#endif
-
-#ifdef CONFIG_PREEMPT
-
-#define __preempt_disable \
-	"lw  $1, "STR(TI_PREEMPT_COUNT)"($28) \n" \
-	"addiu $1, 1 \n" \
-	"sw $1, "STR(TI_PREEMPT_COUNT)"($28) \n"
-
-#define __preempt_enable \
-	"lw  $1, "STR(TI_PREEMPT_COUNT)"($28) \n" \
-	"subu $1, 1 \n" \
-	"sw $1, "STR(TI_PREEMPT_COUNT)"($28) \n"
-
-#else
-
-#define __preempt_disable
-#define __preempt_enable
-
-#endif
 
 __asm__(
 	"	.macro	arch_local_irq_enable				\n"
@@ -55,12 +29,10 @@ __asm__(
 #elif defined(CONFIG_CPU_MIPSR2)
 	"	ei							\n"
 #else
-	__preempt_disable
 	"	mfc0	$1,$12						\n"
 	"	ori	$1,0x1f						\n"
 	"	xori	$1,0x1e						\n"
 	"	mtc0	$1,$12						\n"
-	__preempt_enable
 #endif
 	"	irq_enable_hazard					\n"
 	"	.set	pop						\n"
@@ -115,13 +87,11 @@ __asm__(
 #elif defined(CONFIG_CPU_MIPSR2)
 	"	di							\n"
 #else
-	__preempt_disable
 	"	mfc0	$1,$12						\n"
 	"	ori	$1,0x1f						\n"
 	"	xori	$1,0x1f						\n"
 	"	.set	noreorder					\n"
 	"	mtc0	$1,$12						\n"
-	__preempt_enable
 #endif
 	"	irq_disable_hazard					\n"
 	"	.set	pop						\n"
@@ -170,13 +140,11 @@ __asm__(
 	"	di	\\result					\n"
 	"	andi	\\result, 1					\n"
 #else
-	__preempt_disable
 	"	mfc0	\\result, $12					\n"
 	"	ori	$1, \\result, 0x1f				\n"
 	"	xori	$1, 0x1f					\n"
 	"	.set	noreorder					\n"
 	"	mtc0	$1, $12						\n"
-	__preempt_enable
 #endif
 	"	irq_disable_hazard					\n"
 	"	.set	pop						\n"
@@ -221,14 +189,12 @@ __asm__(
 	"	ins	$1, \\flags, 0, 1				\n"
 	"	mtc0	$1, $12						\n"
 #else
-	__preempt_disable
 	"	mfc0	$1, $12						\n"
 	"	andi	\\flags, 1					\n"
 	"	ori	$1, 0x1f					\n"
 	"	xori	$1, 0x1f					\n"
 	"	or	\\flags, $1					\n"
 	"	mtc0	\\flags, $12					\n"
-	__preempt_enable
 #endif
 	"	irq_disable_hazard					\n"
 	"	.set	pop						\n"
-- 
1.7.0.4

