From d6201b66a59d8d6c0b6e8d0250b9d5b376a52726 Mon Sep 17 00:00:00 2001
From: "P. Sadik" <psadik@netlogicmicro.com>
Date: Tue, 6 Sep 2011 12:42:58 +0530
Subject: [PATCH 321/761] Fix compilation error when PNOR enabled. Enable
 PNOR, PNAND and JFFS2 in defconfig.

Based on Broadcom SDK 2.3.

Signed-off-by: P. Sadik <psadik@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/mtd/maps/xlp-flash.c |   43 +++++++++++++++++++++++++++++++++---------
 1 file changed, 34 insertions(+), 9 deletions(-)

diff --git a/drivers/mtd/maps/xlp-flash.c b/drivers/mtd/maps/xlp-flash.c
index 9fdedd0..4b3dbf0 100644
--- a/drivers/mtd/maps/xlp-flash.c
+++ b/drivers/mtd/maps/xlp-flash.c
@@ -36,7 +36,6 @@
 #include <asm/io.h>
 #ifdef CONFIG_NLM_XLP
 #include <asm/netlogic/hal/nlm_hal.h>
-#include <asm/netlogic/hal/nlm_hal_pic.h>
 #include <asm/netlogic/xlp.h>
 #endif
 
@@ -52,12 +51,39 @@ struct xlp_nor_info {
         struct map_info         map;
 };
 
-static struct mtd_partition xlp_partitions[] = {
+static struct mtd_partition xlp_nor_partitions[] = {
         {
-                .name = "XLP NOR FLASH",
-                .offset = 0x00000000,
-		.size = MTDPART_SIZ_FULL,
-        }
+                .name   = "X-Loader(RO)",
+                .offset = 0,
+                .size   = 0x100000,     /* 1M */
+                .mask_flags = MTD_WRITEABLE,
+        },
+        {
+                .name   = "U-boot(RW)",
+                .offset = 0x100000,
+                .size   = 0x60000,      /* 384k */
+        },
+        {
+                .name   = "DTB(RW)",
+                .offset = 0x160000,
+                .size   = 0x20000,      /* 128K */
+        },
+        {
+                .name   = "Kernel(RW)",
+                .offset = 0x180000,
+                .size   = 0x580000,     /* 5.5M */
+        },
+        {
+                .name   = "Rootfs(RW)",
+                .offset = 0x700000,
+                .size   = 0x800000,     /* 8M */
+        },
+        {
+                .name   = "Env(RO)",
+                .offset = 0xf00000,     /* 1M */
+                .size   = MTDPART_SIZ_FULL,
+                .mask_flags = MTD_WRITEABLE,
+        },
 };
 
 static __inline__ int32_t nor_reg_read(int node,  int regidx)
@@ -107,7 +133,6 @@ static void nor_dump_reg(void)
 int __init xlp_nor_probe(struct platform_device *pdev)
 {
 	struct xlp_nor_info *info;
-	unsigned long base_addr;
 	int nb_parts, err;
 
 	info = kzalloc(sizeof(struct xlp_nor_info), GFP_KERNEL);
@@ -139,9 +164,9 @@ int __init xlp_nor_probe(struct platform_device *pdev)
 		}
 		if(nb_parts <= 0)
 		{
-			nb_parts = ARRAY_SIZE(xlp_partitions);
+			nb_parts = ARRAY_SIZE(xlp_nor_partitions);
 			if(!info->parts)
-				info->parts = xlp_partitions;
+				info->parts = xlp_nor_partitions;
 		}
 		if(nb_parts > 0)
 		{
-- 
1.7.10.4

