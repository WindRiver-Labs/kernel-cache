From 0a3aa9e20daba5dafd4f0486569e0f2e001ef794 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Sat, 27 Apr 2013 15:53:00 +0800
Subject: [PATCH 719/761] bcm_xlp: update NUMA

1. Broadcom SDK is based on kernel 3.0.26, and it uses add_active_range()
to update early_node_map[]. All of them have been dropped in 3.2.
Use memblock instead;
2. Import this BSP's special mach-netlogic/topology.h.

Based on Broadcom SDK 2.3.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/numa.c |    4 +++-
 include/linux/topology.h      |    1 +
 2 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/arch/mips/netlogic/xlp/numa.c b/arch/mips/netlogic/xlp/numa.c
index 89121e3..c8492b8 100644
--- a/arch/mips/netlogic/xlp/numa.c
+++ b/arch/mips/netlogic/xlp/numa.c
@@ -9,6 +9,7 @@
 #include <linux/pfn.h>
 #include <linux/highmem.h>
 #include <linux/swap.h>
+#include <linux/memblock.h>
 
 #include <asm/addrspace.h>
 #include <asm/pgalloc.h>
@@ -266,7 +267,8 @@ void __init nlm_numa_bootmem_init(unsigned long reserved_end)
 		if (end <= start)
 			continue;
 #endif
-		add_active_range(dram_get_node_id(start, end), start, end);
+		memblock_add_node(PFN_PHYS(start), PFN_PHYS(end - start),
+					dram_get_node_id(start, end));
 	}
 
 	/*
diff --git a/include/linux/topology.h b/include/linux/topology.h
index e26db03..8cc45ce 100644
--- a/include/linux/topology.h
+++ b/include/linux/topology.h
@@ -33,6 +33,7 @@
 #include <linux/smp.h>
 #include <linux/percpu.h>
 #include <asm/topology.h>
+#include <asm/mach-netlogic/topology.h>
 
 #ifndef node_has_online_mem
 #define node_has_online_mem(nid) (1)
-- 
1.7.10.4

