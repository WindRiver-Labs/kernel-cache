From 65004e8736704edd1d03408268cf8c40162d3778 Mon Sep 17 00:00:00 2001
From: Hareesh R <hareeshr@broadcom.com>
Date: Thu, 7 Mar 2013 17:08:23 +0530
Subject: [PATCH 695/762] nae: Egress fifo configuration fix

Aligning the pktmem fifo and pktlen fifo

Based on Broadcom SDK 2.3.

Signed-off-by: Hareesh R <hareeshr@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/common/nlm_hal_nae.c |   10 ++++------
 1 files changed, 4 insertions(+), 6 deletions(-)

diff --git a/arch/mips/netlogic/common/nlm_hal_nae.c b/arch/mips/netlogic/common/nlm_hal_nae.c
index 0233a2d..da9d1f4 100644
--- a/arch/mips/netlogic/common/nlm_hal_nae.c
+++ b/arch/mips/netlogic/common/nlm_hal_nae.c
@@ -1294,14 +1294,12 @@ static void config_egress_fifo_carvings(int node, int start_ctxt, int num_ctxts,
 	/* PKT FIFO */
 	start  = nae_cfg->pktfifo_base;
 	for(i=start_ctxt;i<limit;i++){
-		int maxoff = max_pmem_offset();
 		size   = nlm_pkt_fifo_sz() / nae_cfg->num_contexts;
 		/* align size to 8 byte */
-		size = (size + 7) & (~7);
-		maxoff = ((maxoff) & (~7)) - 1;
+		size = size & (~7);
 		if(size) offset = size -1; else offset = size ;
-		if(offset > maxoff)
-			offset = maxoff;
+		if(offset > max_pmem_offset())
+			offset = max_pmem_offset();
 		nlm_hal_write_nae_reg(node, TX_PKT_PMEM_CMD1, offset);
 
 		data =   start << 11 |
@@ -1319,7 +1317,7 @@ static void config_egress_fifo_carvings(int node, int start_ctxt, int num_ctxts,
 	for(i=start_ctxt;i<limit;i++){
 		size   = nlm_pktlen_fifo_sz() / nae_cfg->num_contexts;
 		/* align size to 8 bytes */
-		size = (size + 7) & (~7);
+		size = size & (~7);
 		if(size) offset = size -1; else offset = size ;
 		if(offset > 127)
 			offset = 127;
-- 
1.7.0.4

