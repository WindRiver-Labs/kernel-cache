From 0a35b2e6f7050f107546a647c3dc2da8d45076b6 Mon Sep 17 00:00:00 2001
From: Zi Shen Lim <zlim@netlogicmicro.com>
Date: Fri, 21 Oct 2011 16:24:35 -0700
Subject: [PATCH 282/565] Fix PIC ack

Fix PIC ack: ack after handling irq

Based on Broadcom SDK 2.3.

Signed-off-by: Zi Shen Lim <zlim@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/irq.c | 23 ++++++++++++++++++-----
 1 file changed, 18 insertions(+), 5 deletions(-)

diff --git a/arch/mips/netlogic/xlp/irq.c b/arch/mips/netlogic/xlp/irq.c
index e1fda3a..4b8376b 100644
--- a/arch/mips/netlogic/xlp/irq.c
+++ b/arch/mips/netlogic/xlp/irq.c
@@ -494,6 +494,7 @@ static void __nlm_irq_mask(unsigned int irq)
 	return;
 }
 
+#if 0 /* DEPRECATED */
 /*
  * Interface function (unlocked version) to mask an IRQ
  * Calls helper function after input tests and spin_lock holds
@@ -516,7 +517,7 @@ static void nlm_irq_mask(struct irq_data *d)
 	//spin_unlock_irqrestore(&xlp_pic_lock, flags);	// XXX remove
 	return;
 }
-
+#endif
 
 /*
  * Changes eimr bit value corresponding to IRT
@@ -533,6 +534,7 @@ static void __nlm_irq_unmask(int irq)
 	return;
 }
 
+#if 0 /* DEPRECATED */
 /*
  * Interface function (unlocked version) to mask an IRQ
  * Calls helper function after input tests and spin_lock holds
@@ -555,8 +557,9 @@ static void nlm_irq_unmask(struct irq_data *d)
 	//spin_unlock_irqrestore(&xlp_pic_lock, flags);
 	return;
 }
+#endif
 
-static void nlm_irq_ack(struct irq_data *d)
+static void xlp_pic_unmask(struct irq_data *d)
 {
 	unsigned int irq = d->irq;
 	unsigned long flags;
@@ -722,13 +725,23 @@ static int nlm_irq_set_affinity(struct irq_data *d, const struct cpumask *mask,
 	return 0;
 }
 
+/* For default handle_level_irq, the flow is as follows:
+	desc->irq_data.chip->irq_mask_ack();
+	handle_irq_event(desc->action);
+	desc->irq_data.chip->irq_unmask();
+*/
+static void xlp_pic_mask_ack(struct irq_data *d)
+{
+	/* Do nothing here. */
+	/* Since rvec is multiplexed, we do not ack eirr here. */
+}
+
 static struct irq_chip nlm_irq_pic = {
 	.name = "XLP-PIC",
-	.irq_mask = nlm_irq_mask,
-	.irq_unmask = nlm_irq_unmask,
+	.irq_mask_ack = xlp_pic_mask_ack,
+	.irq_unmask = xlp_pic_unmask,
 	.irq_startup = nlm_irq_startup,
 	.irq_shutdown = nlm_irq_shutdown,
-	.irq_ack = nlm_irq_ack,
 	.irq_set_affinity = nlm_irq_set_affinity
 };
 
-- 
1.8.4.93.g57e4c17

