From e541a46883a621f4eeda198763b982d08fb93129 Mon Sep 17 00:00:00 2001
From: Jayanthi A <jayanthia@netlogicmicro.com>
Date: Wed, 8 Feb 2012 15:39:37 +0530
Subject: [PATCH 350/565] Added physical cpu present map

Added physical cpu present map

Based on Broadcom SDK 2.3.

Signed-off-by: Jayanthi A <jayanthia@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/netlogic/xlp.h | 1 +
 arch/mips/netlogic/xlp/smp.c         | 5 +++++
 2 files changed, 6 insertions(+)

diff --git a/arch/mips/include/asm/netlogic/xlp.h b/arch/mips/include/asm/netlogic/xlp.h
index 58c3ca6..be9f411 100644
--- a/arch/mips/include/asm/netlogic/xlp.h
+++ b/arch/mips/include/asm/netlogic/xlp.h
@@ -80,6 +80,7 @@ struct smp_boot_info {
 
 extern struct smp_boot_info smp_boot;
 extern void prom_boot_cpus_secondary(void *);
+extern cpumask_t phys_cpu_present_map;
 
 extern char cpu_model_info[MAX_CPU_REV_LEN];
 extern char* get_cpu_info(void);
diff --git a/arch/mips/netlogic/xlp/smp.c b/arch/mips/netlogic/xlp/smp.c
index 74f69cda..f524db8 100644
--- a/arch/mips/netlogic/xlp/smp.c
+++ b/arch/mips/netlogic/xlp/smp.c
@@ -56,6 +56,8 @@ struct smp_boot_info smp_boot;
 EXPORT_SYMBOL(smp_boot);
 cpumask_t fdt_cpumask;
 cpumask_t fdt_loadermask;
+cpumask_t phys_cpu_present_map;
+EXPORT_SYMBOL(phys_cpu_present_map);
 
 void nlm_enable_vc_intr(void);
 extern void ptr_smp_boot(unsigned long, unsigned long, unsigned long);
@@ -185,7 +187,9 @@ void __init nlm_smp_setup(void)
 	num_cpus = 1;
 	cpumask_clear(&cpu_possible_map);
 	cpumask_clear(&cpu_present_map);
+	cpumask_clear(&phys_cpu_present_map);
 	cpu_set(0, cpu_possible_map);
+	cpu_set(boot_cpu, phys_cpu_present_map);
 
 	/* Setup map for other cpus */
 	for (i = 0; i < NR_CPUS; i++) {
@@ -197,6 +201,7 @@ void __init nlm_smp_setup(void)
 			__cpu_logical_map[num_cpus] = i;
 			cpu_data[num_cpus].core = (int) (__cpu_logical_map[num_cpus]/XLP_THREADS_PER_CORE);
 			cpu_set(num_cpus, cpu_possible_map);
+			cpu_set(i, phys_cpu_present_map);
 			num_cpus++;
 		}
 	}
-- 
1.8.4.93.g57e4c17

