From 4b1787e8ed1e7c3d6abe02bae735995eec919e30 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Mon, 9 Sep 2013 11:06:24 +0800
Subject: [PATCH 558/565] bcm-xlp: add some PAGE table debug functions

Add some PAGE table debug functions for this BSP.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/mm/c-phoenix.c | 63 ++++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 63 insertions(+)

diff --git a/arch/mips/mm/c-phoenix.c b/arch/mips/mm/c-phoenix.c
index b181aac..c81b40c 100644
--- a/arch/mips/mm/c-phoenix.c
+++ b/arch/mips/mm/c-phoenix.c
@@ -609,4 +609,67 @@ void nlm_common_flush_icache_range_paddr(phys_t start)
 	preempt_enable();
 }
 
+#if defined(CONFIG_NLMCOMMON_USERSEGV_DEBUG) || \
+	defined(CONFIG_NLMCOMMON_VM_DEBUG)
+static void print_pte_range(pte_t *pte, int pgd_index, int pmd_index)
+{
+	int i;
+
+	for (i = 0; i < PTRS_PER_PTE; ++pte, ++i) {
+		if (pte_none(*pte))
+			continue;
+		pr_debug("\t\tpte[%d] = %llx, vpage = %lx\n",
+			i, pte_val(*pte),
+			((unsigned long)pgd_index << PGDIR_SHIFT)
+			| ((unsigned long)pmd_index << PAGE_SHIFT));
+	}
+}
+
+static void print_pmd_range(pmd_t *pmd, int pgd_index)
+{
+	int i;
+
+	for (i = 0; i < PTRS_PER_PMD; ++pmd, ++i) {
+		if (pmd_none(*pmd))
+			continue;
+		print_pte_range((pte_t *) pmd_val(*pmd), pgd_index, i);
+	}
+}
+
+void dump_pgtable(pgd_t *pgd)
+{
+	int i = 0;
+
+	if (pgd == NULL) {
+		pr_debug("NULL pgd ... bailing out\n");
+		return;
+	}
 
+	pr_debug("dumping page table: pgd=%lx\n", (unsigned long)pgd);
+	for (i = 0; i < PTRS_PER_PGD; ++pgd, ++i) {
+		if (pgd_none(*pgd))
+			continue;
+		print_pmd_range((pmd_t *) pgd_val(*pgd), i);
+	}
+}
+
+void dump_mm_pgtable(struct mm_struct *mm)
+{
+	if (!mm) {
+		pr_debug("[%s]: mm == NULL (Kernel Thread?)\n",
+			__func__);
+		return;
+	}
+
+	return dump_pgtable(mm->pgd);
+}
+
+void dump_current_pgtable(void)
+{
+	pr_debug("[%s]: current=%lx, current->mm=%lx, current->active_mm=%lx\n",
+		__func__,
+		(unsigned long)current, (unsigned long)current->mm,
+		(unsigned long)current->active_mm);
+	dump_mm_pgtable(current->mm);
+}
+#endif
-- 
1.8.4.93.g57e4c17

