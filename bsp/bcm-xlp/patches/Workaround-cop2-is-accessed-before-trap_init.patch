From 746f0738914ff476f8aad54de9703fbce2d15fe4 Mon Sep 17 00:00:00 2001
From: Jayanthi Annadurai <jayanthia@netlogicmicro.com>
Date: Thu, 31 Mar 2011 21:00:16 -0700
Subject: [PATCH 196/565] Workaround: cop2 is accessed before trap_init

Workaround: cop2 is accessed before trap_init

Based on Broadcom SDK 2.3.

Signed-off-by: Jayanthi Annadurai <jayanthia@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/setup.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index 5688711..6a6d86f 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -687,6 +687,9 @@ static void xen_init(void) {}
 
 void __init prom_init(void)
 {
+#ifdef CONFIG_NLM_ENABLE_COP2
+	unsigned int c0status;
+#endif
 	setup_mapped_kernel_tlbs(TRUE, TRUE);
 
 	fdt_process();
@@ -695,6 +698,11 @@ void __init prom_init(void)
 
 	nlm_common_ebase = read_c0_ebase() & (~((1 << 12) - 1));
 
+#ifdef CONFIG_NLM_ENABLE_COP2
+	// workaround. trap_init enables cop2. But this function gets called before trap_init
+	c0status = read_c0_status() | ST0_CU2;
+	write_c0_status(c0status);
+#endif
 	cpumask_clear(&smp_boot.online_map);
 	cpumask_set_cpu(hard_smp_processor_id(), &smp_boot.online_map);
 
-- 
1.8.4.93.g57e4c17

