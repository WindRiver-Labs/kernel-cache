From 098b1f2f445c303f55a7aecf0aae29f3a2881911 Mon Sep 17 00:00:00 2001
From: henry shao <hshao@netlogicmicro.com>
Date: Tue, 31 Aug 2010 03:40:24 -0700
Subject: [PATCH 120/565] fix non node 0 thread 1 premature return bug

Fix non node 0 thread 1 premature return bug.

Based on Broadcom SDK 2.3.

Signed-off-by: henry shao <hshao@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/cpu_control.c | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/arch/mips/netlogic/xlp/cpu_control.c b/arch/mips/netlogic/xlp/cpu_control.c
index 2f3601c..22d667c 100644
--- a/arch/mips/netlogic/xlp/cpu_control.c
+++ b/arch/mips/netlogic/xlp/cpu_control.c
@@ -109,6 +109,13 @@ void enable_cores(unsigned int node, unsigned int cbitmap, unsigned int thread_n
 
 	for (core=start_core; core!=(0x1<<8); core<<=1) {
 		if (cbitmap & core) {
+
+	                if(thread_num != 4)
+        	        {
+                	        value = (thread_num-1) << (i*2);
+                        	nlm_hal_write_32bit_reg(sys_mmio, 0x4C, value);
+                	}
+
 			/* Enable CPU clock 
 			 */
                         value = nlm_hal_read_32bit_reg(sys_mmio,0x4E) & ~core;
@@ -163,7 +170,7 @@ void enable_cpus( unsigned int node, unsigned int onlinemask)
 
 	switch (thread_bitmask) {
 		case 0x1:
-		if (num_ones(cores_bitmap) == 1) {
+		if ((num_ones(cores_bitmap) == 1) && (node == 0)) {
 			printk("Core0/Thread0 is enabled.\n");
 			return;
 		}
-- 
1.8.4.93.g57e4c17

