From 37535c64e9d7623d5793dcffb01f86b161abdf68 Mon Sep 17 00:00:00 2001
From: Anurag <anurag.gopinath@broadcom.com>
Date: Sun, 21 Oct 2012 16:27:05 +0530
Subject: [PATCH 410/565] SD/MMC : Fix for data copy from SD/MMC0 to SD/MMC1

Fix for data copy issue, when copying data from SD/MMC0 to SD/MMC1

Based on Broadcom SDK 2.3.

Signed-off-by: Anurag <anurag.gopinath@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/mmc/host/sdhci.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.c
index 4dac2fe..0d7e3d3 100644
--- a/drivers/mmc/host/sdhci.c
+++ b/drivers/mmc/host/sdhci.c
@@ -50,6 +50,7 @@
 
 static unsigned int debug_quirks = 0;
 static unsigned int debug_quirks2;
+int cmd_inprogress = 0;
 
 static void sdhci_finish_data(struct sdhci_host *);
 
@@ -1336,10 +1337,13 @@ static void sdhci_request(struct mmc_host *mmc, struct mmc_request *mrq)
 	u32 tuning_opcode;
 
 	host = mmc_priv(mmc);
+        while(cmd_inprogress)
+                schedule();
 
 	sdhci_runtime_pm_get(host);
 
 	spin_lock_irqsave(&host->lock, flags);
+        cmd_inprogress = 1;
 
 	WARN_ON(host->mrq != NULL);
 
@@ -2172,6 +2176,7 @@ static void sdhci_tasklet_finish(unsigned long param)
 	mmiowb();
 	spin_unlock_irqrestore(&host->lock, flags);
 
+        cmd_inprogress = 0;
 	mmc_request_done(host->mmc, mrq);
 	sdhci_runtime_pm_put(host);
 }
-- 
1.8.4.93.g57e4c17

