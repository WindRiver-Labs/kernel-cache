From 786396aa6c234781ed419cb5ced5aa87be43e655 Mon Sep 17 00:00:00 2001
From: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Date: Thu, 4 Mar 2010 14:33:43 -0800
Subject: [PATCH 005/565] MIPS: NETL: merge xen prasad patch

MIPS: NETL: merged prasad patch for booting linux from xen.

Based on Broadcom SDK 2.3.

Signed-off-by: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/bootinfo.h | 8 +++++++-
 arch/mips/kernel/setup.c         | 5 +----
 2 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/arch/mips/include/asm/bootinfo.h b/arch/mips/include/asm/bootinfo.h
index 5f35b7f..0014011 100644
--- a/arch/mips/include/asm/bootinfo.h
+++ b/arch/mips/include/asm/bootinfo.h
@@ -118,7 +118,7 @@ struct boot_mem_map {
 		uint64_t addr;	/* start of memory segment */
 		uint64_t size;	/* size of memory segment */
 		uint32_t type;		/* type of memory segment */
-	} map[BOOT_MEM_MAP_MAX];
+	} map[BOOT_MEM_MAP_MAX + 1];
 };
 
 extern struct boot_mem_map boot_mem_map;
@@ -164,4 +164,10 @@ struct boot_mem_map_exclude_region {
 	uint64_t end;
 };
 
+#ifdef CONFIG_MIPS_XEN
+#define PROMDATA_HIDE(ptr, field) (((ptr)->field == 0) ? 0 : __va((unsigned long)(ptr)->field))
+#else
+#define PROMDATA_HIDE(ptr, field) ((unsigned long)(ptr)->field)
+#endif
+
 #endif /* _ASM_BOOTINFO_H */
diff --git a/arch/mips/kernel/setup.c b/arch/mips/kernel/setup.c
index 94fb74e..6623401 100644
--- a/arch/mips/kernel/setup.c
+++ b/arch/mips/kernel/setup.c
@@ -340,7 +340,7 @@ static void __init bootmem_init(void)
 	 * of usable memory.
 	 */
 	reserved_end = max(init_initrd(),
-			   (unsigned long) PFN_UP(__pa_symbol(&_end)));
+			   (unsigned long) PFN_UP(__pa_symbol(&_end) + PAGE_SIZE));
 
 	/*
 	 * max_low_pfn is not a number of pages. The number of pages
@@ -605,9 +605,6 @@ static void __init arch_mem_init(char **cmdline_p)
 	tweak_avail_dram_map();
 #endif
     
-/*
-	setup_mapped_kernel_tlbs(TRUE, TRUE);
-*/
 	bootmem_init();
 /*
 	setup_mapped_kernel_tlbs(FALSE, TRUE);
-- 
1.8.4.93.g57e4c17

