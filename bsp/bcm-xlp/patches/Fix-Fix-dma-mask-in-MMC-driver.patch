From c9838693d6d6a73bd8b312635fc61187f2cff39c Mon Sep 17 00:00:00 2001
From: Anurag <anurag.gopinath@broadcom.com>
Date: Fri, 14 Dec 2012 11:36:01 +0530
Subject: [PATCH 440/565] Fix : Fix dma mask in MMC driver

Fix : Fix dma mask in MMC driver.

Based on Broadcom SDK 2.3.

Signed-off-by: Anurag <anurag.gopinath@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/mmc/host/sdhci.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.c
index 0d7e3d3..8965ca3 100644
--- a/drivers/mmc/host/sdhci.c
+++ b/drivers/mmc/host/sdhci.c
@@ -2857,8 +2857,8 @@ int sdhci_add_host(struct sdhci_host *host)
 		 * (128) and potentially one alignment transfer for
 		 * each of those entries.
 		 */
-		host->adma_desc = kmalloc((128 * 2 + 1) * 4, GFP_KERNEL);
-		host->align_buffer = kmalloc(128 * 4, GFP_KERNEL);
+		host->adma_desc = kmalloc((128 * 2 + 1) * 4, GFP_DMA);
+		host->align_buffer = kmalloc(128 * 4, GFP_DMA);
 		if (!host->adma_desc || !host->align_buffer) {
 			kfree(host->adma_desc);
 			kfree(host->align_buffer);
@@ -2879,6 +2879,10 @@ int sdhci_add_host(struct sdhci_host *host)
 		mmc_dev(host->mmc)->dma_mask = &host->dma_mask;
 	}
 
+        host->dma_mask = DMA_BIT_MASK(24);
+	mmc_dev(host->mmc)->dma_mask = &host->dma_mask;
+        mmc_dev(host->mmc)->coherent_dma_mask = DMA_BIT_MASK(24);
+
 	if (host->version >= SDHCI_SPEC_300)
 		host->max_clk = (caps[0] & SDHCI_CLOCK_V3_BASE_MASK)
 			>> SDHCI_CLOCK_BASE_SHIFT;
-- 
1.8.4.93.g57e4c17

