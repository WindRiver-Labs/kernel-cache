From 081d4955d370cd008824e180874b11290bb7f317 Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Thu, 14 Mar 2013 09:10:17 -0700
Subject: [PATCH 498/565] errata: remove atomics/ehb errata

Based on Broadcom SDK 2.3.

Signed-off-by: Yonghong Song <ysong@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/barrier.h              | 23 +----------------------
 arch/mips/include/asm/netlogic/nlm_rw_lock.h |  2 +-
 2 files changed, 2 insertions(+), 23 deletions(-)

diff --git a/arch/mips/include/asm/barrier.h b/arch/mips/include/asm/barrier.h
index 002591b..e45aeb6 100644
--- a/arch/mips/include/asm/barrier.h
+++ b/arch/mips/include/asm/barrier.h
@@ -66,20 +66,7 @@
 #define smp_read_barrier_depends()	do { } while(0)
 
 #ifdef CONFIG_CPU_HAS_SYNC
-
-#ifdef CONFIG_NLM_XLP
-#define __sync()				\
-	__asm__ __volatile__(			\
-		".set	push\n\t"		\
-		".set	noreorder\n\t"		\
-		".set	mips64r2\n\t"		\
-		"sync\n\t"			\
-		"ehb\n\t"			\
-		".set	pop"			\
-		: /* no output */		\
-		: /* no input */		\
-		: "memory")
-#else /* !CONFIG_NLM_XLP */
+	#define __sync()			\
 	__asm__ __volatile__(			\
 		".set	push\n\t"		\
 		".set	noreorder\n\t"		\
@@ -89,8 +76,6 @@
 		: /* no output */		\
 		: /* no input */		\
 		: "memory")
-#endif /* CONFIG_NLM_XLP */
-
 #else
 #define __sync()	do { } while(0)
 #endif
@@ -177,13 +162,7 @@
 #endif
 
 #if defined(CONFIG_WEAK_REORDERING_BEYOND_LLSC) && defined(CONFIG_SMP)
-
-#ifdef CONFIG_NLM_XLP
-#define __WEAK_LLSC_MB		".set push\n\t .set mips64r2\n\t sync\n\t ehb\n\t .set pop\n"
-#else /* !CONFIG_NLM_XLP */
 #define __WEAK_LLSC_MB		"       sync	\n"
-#endif /* CONFIG_NLM_XLP */
-
 #else
 #define __WEAK_LLSC_MB		"		\n"
 #endif
diff --git a/arch/mips/include/asm/netlogic/nlm_rw_lock.h b/arch/mips/include/asm/netlogic/nlm_rw_lock.h
index 5fded8b..74527e0 100644
--- a/arch/mips/include/asm/netlogic/nlm_rw_lock.h
+++ b/arch/mips/include/asm/netlogic/nlm_rw_lock.h
@@ -40,7 +40,7 @@ typedef struct {
 	int write_cpu; /* CPU that is currently holding wr lock */
 } nlm_rwlock_t;
 
-#define nlm_sync() __asm__ __volatile__("sync\n ehb": : :"memory")
+#define nlm_sync() __asm__ __volatile__("sync": : :"memory")
 __asm__ (
 		".macro\tnlm_local_irq_save result\n\t"
 		".set\tpush\n\t"
-- 
1.8.4.93.g57e4c17

