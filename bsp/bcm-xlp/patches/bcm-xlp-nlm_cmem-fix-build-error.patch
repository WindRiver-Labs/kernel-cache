From 2f4f6cb04a0a7be4c316467797d40b5ac8de7748 Mon Sep 17 00:00:00 2001
From: Krishnamurthy D V <krishnad@broadcom.com>
Date: Thu, 28 Jun 2012 00:22:49 -0700
Subject: [PATCH 374/565] bcm-xlp: nlm_cmem: fix build error

nlm_cmem: Fix build error when CONFIG_SWAP is enabled.

Based on Broadcom SDK 2.3.

Signed-off-by: Krishnamurthy D V <krishnad@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/cpu_control.c | 11 +++++++++--
 arch/mips/netlogic/xlp/platform.c    | 10 ++++++++--
 arch/mips/netlogic/xlp/setup.c       | 12 ++++++++----
 drivers/char/nlm_cmem.c              |  1 +
 4 files changed, 26 insertions(+), 8 deletions(-)

diff --git a/arch/mips/netlogic/xlp/cpu_control.c b/arch/mips/netlogic/xlp/cpu_control.c
index 04c664a..acb6326 100644
--- a/arch/mips/netlogic/xlp/cpu_control.c
+++ b/arch/mips/netlogic/xlp/cpu_control.c
@@ -46,7 +46,8 @@ THE POSSIBILITY OF SUCH DAMAGE.
 
 #define XLP_ECFG_BASE           0x18000000
 #define XLP_SYS_DEV_BASE        0x35000
-#define PLL_REF_CLK_PS		7500
+#define PLL_REF_CLK_PS_133MHz	7500
+#define PLL_REF_CLK_PS_66MHz	15000
 
 /* temporary storage space for
  * stack pointers
@@ -229,6 +230,7 @@ static u32 get_pll_period(int divf,int divr) {
 
 	u32 vco_fs;		/* vco in femto-seconds */
 	u32 pll_period_fs;	/* pll output in femto-seconds */
+	u32 pll_ref_clk_ps;
 
 	if (divr == 2) {
 		printk (KERN_ERR "Error! Illegal divr value %d!\n", divr);
@@ -239,7 +241,12 @@ static u32 get_pll_period(int divf,int divr) {
 		return 0;
 	}
 
-	vco_fs = (((PLL_REF_CLK_PS * 1000) * (divr+1))/(4 * (divf+1)));
+	if(nlm_hal_is_ref_clk_133MHz())
+		pll_ref_clk_ps = PLL_REF_CLK_PS_133MHz;
+	else
+		pll_ref_clk_ps = PLL_REF_CLK_PS_66MHz;
+
+	vco_fs = (((pll_ref_clk_ps * 1000) * (divr+1))/(4 * (divf+1)));
 	pll_period_fs  = vco_fs * 2; /* pll output is divided by 2 */
 
 	return pll_period_fs;
diff --git a/arch/mips/netlogic/xlp/platform.c b/arch/mips/netlogic/xlp/platform.c
index c11b3dc..6a6066c 100644
--- a/arch/mips/netlogic/xlp/platform.c
+++ b/arch/mips/netlogic/xlp/platform.c
@@ -49,7 +49,8 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #define XLP_MAX_FUNC		8
 #define MAX_DEV2DRV		10
 #define MAX_NUM_UARTS		4
-#define UART_CLK 		133333333
+#define UART_CLK_133MHz 133333333
+#define UART_CLK_66MHz   66666666
 #define XLP_UART_PORTIO_OFFSET	0x1000
 
 static struct plat_serial8250_port xlp_uart_port[MAX_NUM_UARTS];
@@ -99,8 +100,13 @@ static void xlp_init_uart(int port_id)
         xlp_uart_port[port_id].membase       = (void __iomem *)((unsigned long)xlp_uart_port[port_id].mapbase);
         xlp_uart_port[port_id].irq           = xlp_pic_irt_to_irq(XLP_PIC_IRT_UART(port_id));
 
-        xlp_uart_port[port_id].uartclk       = UART_CLK;
         xlp_uart_port[port_id].iotype        = UPIO_MEM32;
+	
+	if(nlm_hal_is_ref_clk_133MHz())
+		xlp_uart_port[port_id].uartclk       = UART_CLK_133MHz;
+	else
+		xlp_uart_port[port_id].uartclk       = UART_CLK_66MHz;
+
         xlp_uart_port[port_id].flags         = UPF_SKIP_TEST|UPF_FIXED_TYPE|UPF_BOOT_AUTOCONF;
         xlp_uart_port[port_id].type          = PORT_16550A;
         xlp_uart_port[port_id].regshift      = 2;
diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index ec86ddd..2a69499 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -328,7 +328,8 @@ void __init nlm_nmi_setup (void)
 
 /* setup early serial port driver */
 #ifdef CONFIG_SERIAL_8250
-#define UART_CLK 133333333
+#define UART_CLK_133MHz 133333333
+#define UART_CLK_66MHz   66666666
 
 static void __init nlm_early_serial_setup(int uart_id)
 {
@@ -341,7 +342,12 @@ static void __init nlm_early_serial_setup(int uart_id)
 	s.regshift = 2; /* registers are 4 bytes wide */
 	/* hardware int 4 - the serial int, is CPU int 6
 	 but poll for now */
-	s.uartclk = UART_CLK;
+
+	if(nlm_hal_is_ref_clk_133MHz())
+		s.uartclk = UART_CLK_133MHz;
+	else
+		s.uartclk = UART_CLK_66MHz;
+
 	switch(uart_id){
 		default:
 		case 0:
@@ -488,7 +494,6 @@ static void ici_read_vc_parameter(void *node, int max_vc, struct nlm_ici_vc_para
 }
 static void ici_dump_vc_info(const char *header, int max_vc, struct nlm_ici_vc_param *vc)
 {
-	int i = 0;
 	printk("[=== %s ===]\n", header);
 	
 	if(max_vc == 8){
@@ -520,7 +525,6 @@ static void parse_ici_parameters(void)
 {
 	char domstr[32] = "";
 	void *node;
-	int temp;
 	int domain = 0;
 
 	sprintf(domstr, "/doms/dom@%d/ici-config", domain);
diff --git a/drivers/char/nlm_cmem.c b/drivers/char/nlm_cmem.c
index 42130d0..a6fce70 100644
--- a/drivers/char/nlm_cmem.c
+++ b/drivers/char/nlm_cmem.c
@@ -30,6 +30,7 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #include <linux/pfn.h>
 #include <linux/fdtable.h>
 #include <linux/module.h>
+#include <linux/pagemap.h>
 #include <asm/mman.h>
 #include <asm/io.h>
 #include <asm/tlb.h>
-- 
1.8.4.93.g57e4c17

