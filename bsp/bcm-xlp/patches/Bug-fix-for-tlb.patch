From 08debd26072181a743409624432724c638dc621a Mon Sep 17 00:00:00 2001
From: Prasad Boddupalli <pboddupalli@netlogicmicro.com>
Date: Tue, 19 Oct 2010 14:35:28 -0700
Subject: [PATCH 164/565] Bug fix for tlb

Bug fix to accommodate speculative tlb eviction by pagewalker.

Based on Broadcom SDK 2.3.

Signed-off-by: Prasad Boddupalli <pboddupalli@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/mm/tlb-r4k.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/arch/mips/mm/tlb-r4k.c b/arch/mips/mm/tlb-r4k.c
index cfabccd..d7b1e15 100644
--- a/arch/mips/mm/tlb-r4k.c
+++ b/arch/mips/mm/tlb-r4k.c
@@ -349,6 +349,7 @@ void __update_tlb(struct vm_area_struct * vma, unsigned long address, pte_t pte)
 	pmd_t *pmdp;
 	pte_t *ptep;
 	int idx, pid;
+	unsigned long config7_flags;
 
 	/*
 	 * Handle debugger faulting in for debugee.
@@ -357,6 +358,7 @@ void __update_tlb(struct vm_area_struct * vma, unsigned long address, pte_t pte)
 		return;
 
 	ENTER_CRITICAL(flags);
+	disable_pgwalker(config7_flags);
 
 	pid = read_c0_entryhi() & ASID_MASK;
 	address &= (PAGE_MASK << 1);
@@ -405,6 +407,7 @@ void __update_tlb(struct vm_area_struct * vma, unsigned long address, pte_t pte)
 	}
 	tlbw_use_hazard();
 	FLUSH_ITLB_VM(vma);
+	enable_pgwalker(config7_flags);
 	EXIT_CRITICAL(flags);
 }
 
@@ -415,8 +418,10 @@ void __init add_wired_entry(unsigned long entrylo0, unsigned long entrylo1,
 	unsigned long wired;
 	unsigned long old_pagemask;
 	unsigned long old_ctx;
+	unsigned long config7_flags;
 
 	ENTER_CRITICAL(flags);
+	disable_pgwalker(config7_flags);
 	/* Save old context and create impossible VPN2 value */
 	old_ctx = read_c0_entryhi();
 	old_pagemask = read_c0_pagemask();
@@ -436,6 +441,7 @@ void __init add_wired_entry(unsigned long entrylo0, unsigned long entrylo1,
 	tlbw_use_hazard();	/* What is the hazard here? */
 	write_c0_pagemask(old_pagemask);
 	local_flush_tlb_all();
+	enable_pgwalker(config7_flags);
 	EXIT_CRITICAL(flags);
 }
 
@@ -455,8 +461,10 @@ __init int add_temporary_entry(unsigned long entrylo0, unsigned long entrylo1,
 	unsigned long wired;
 	unsigned long old_pagemask;
 	unsigned long old_ctx;
+	unsigned long config7_flags;
 
 	ENTER_CRITICAL(flags);
+	disable_pgwalker(config7_flags);
 	/* Save old context and create impossible VPN2 value */
 	old_ctx = read_c0_entryhi();
 	old_pagemask = read_c0_pagemask();
@@ -480,6 +488,7 @@ __init int add_temporary_entry(unsigned long entrylo0, unsigned long entrylo1,
 	write_c0_entryhi(old_ctx);
 	write_c0_pagemask(old_pagemask);
 out:
+	enable_pgwalker(config7_flags);
 	EXIT_CRITICAL(flags);
 	return ret;
 }
-- 
1.8.4.93.g57e4c17

