From 7686eddee27097c1f947f8be62abba7a2027ebd7 Mon Sep 17 00:00:00 2001
From: Mehul <vmehul@netlogicmicro.com>
Date: Tue, 21 Sep 2010 18:45:27 +0530
Subject: [PATCH 176/565] bcm-xlp: Incorporated Below comments from Prasad

1. remove changes from process.c;
2. add "jump cop2_save/restore" code in stackframe.h to reduce
the changes in generic file;
3. modify asm-offsets.c to have only one TX and one RX offset macro.

Also, changed traps.c to not to handle "cop2 unusable" exception for
user space. Application should no longer get this exception.

Based on Broadcom SDK 2.3.

Signed-off-by: Mehul <vmehul@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/stackframe.h | 80 ++++++--------------------------------
 arch/mips/kernel/asm-offsets.c     | 10 +----
 2 files changed, 14 insertions(+), 76 deletions(-)

diff --git a/arch/mips/include/asm/stackframe.h b/arch/mips/include/asm/stackframe.h
index 22a7ee9..236148c 100644
--- a/arch/mips/include/asm/stackframe.h
+++ b/arch/mips/include/asm/stackframe.h
@@ -218,37 +218,13 @@
 		ori	$28, sp, _THREAD_MASK
 		xori	$28, _THREAD_MASK
 #ifdef CONFIG_NLM_ENABLE_COP2
-		.set push
-		.set	noat
-		.set noreorder
-		/*msgring tx buf reg*/
-		dmfc2 v1, $0, 0
-		LONG_S  v1, NLM_COP2_TX_BUF_0(sp)
-		dmfc2 v1, $0, 1
-		LONG_S  v1, NLM_COP2_TX_BUF_1(sp)
-		dmfc2 v1, $0, 2
-		LONG_S v1, NLM_COP2_TX_BUF_2(sp)
-		dmfc2 v1, $0, 3
-		LONG_S v1, NLM_COP2_TX_BUF_3(sp)
-	
-		/*msgring rx buf reg*/
-		dmfc2 v1, $1, 0
-		LONG_S  v1, NLM_COP2_RX_BUF_0(sp)
-		dmfc2 v1, $1, 1
-		LONG_S  v1, NLM_COP2_RX_BUF_1(sp)
-		dmfc2 v1, $1, 2
-		LONG_S  v1, NLM_COP2_RX_BUF_2(sp)
-		dmfc2 v1, $1, 3
-		LONG_S  v1, NLM_COP2_RX_BUF_3(sp)
-
-		mfc2 v1, $2, 0
-		sw  v1, NLM_COP2_TX_MSG_STATUS(sp)
-	
-		mfc2 v1, $3, 0
-		sw v1, NLM_COP2_RX_MSG_STATUS(sp)
-		.set pop
+		.set    mips64
+		dla k0, nlm_cop2_save
+		jalr k0
+		nop
+		LONG_L  ra, PT_R31(sp)
+		LONG_L	k0, PT_R29(sp)
 #endif
-
 #ifdef CONFIG_CPU_CAVIUM_OCTEON
 		.set    mips64
 		pref    0, 0($28)       /* Prefetch the current pointer */
@@ -401,45 +377,13 @@
 		xori	a0, STATMASK
 		mtc0	a0, CP0_STATUS
 #ifdef CONFIG_NLM_ENABLE_COP2
-		.set push
-		.set	noat
-		.set noreorder
-		/*msgring tx buf reg*/
-		LONG_L  v1, NLM_COP2_TX_BUF_0(sp)
-		dmtc2 v1, $0, 0
-		LONG_L  v1, NLM_COP2_TX_BUF_1(sp)
-		dmtc2 v1, $0, 1
-		LONG_L  v1, NLM_COP2_TX_BUF_2(sp)
-		dmtc2 v1, $0, 2
-		LONG_L  v1, NLM_COP2_TX_BUF_3(sp)
-		dmtc2 v1, $0, 3
-
-		/*msgring rx buf reg*/
-		LONG_L  v1, NLM_COP2_RX_BUF_0(sp)
-		dmtc2 v1, $1, 0
-		LONG_L  v1, NLM_COP2_RX_BUF_1(sp)
-		dmtc2 v1, $1, 1
-		LONG_L  v1, NLM_COP2_RX_BUF_2(sp)
-		dmtc2 v1, $1, 2
-		LONG_L  v1, NLM_COP2_RX_BUF_3(sp)
-		dmtc2 v1, $1, 3
-
-		lw  v1, NLM_COP2_TX_MSG_STATUS(sp)
-		mtc2 v1, $2, 0
-	
-		/*leave bits 28-31 up to date*/
-		li k0, 0xf0000000
-		lw v1, NLM_COP2_RX_MSG_STATUS(sp)
-		or v1, k0, v1
-		xor v1, k0, v1
-		mfc2 k0, $3, 0
-		srl k0, k0, 28
-		sll k0, k0, 28
-		or v1, k0, v1
-		mtc2 v1, $3, 0
-		.set pop
-#endif
+		dla v1, nlm_cop2_restore
+		jalr v1
+		nop
 		li	v1, 0x4000ff00
+#else
+		li	v1, 0xff00
+#endif
 		and	a0, v1
 		LONG_L	v0, PT_STATUS(sp)
 		nor	v1, $0, v1
diff --git a/arch/mips/kernel/asm-offsets.c b/arch/mips/kernel/asm-offsets.c
index 05ed318..70811e2 100644
--- a/arch/mips/kernel/asm-offsets.c
+++ b/arch/mips/kernel/asm-offsets.c
@@ -73,14 +73,8 @@ void output_ptreg_defines(void)
 	OFFSET(PT_MTP, pt_regs, mtp);
 #endif /* CONFIG_CPU_CAVIUM_OCTEON */
 #ifdef CONFIG_NLM_ENABLE_COP2
-	OFFSET(NLM_COP2_TX_BUF_0, pt_regs, tx_buf[0]);
-	OFFSET(NLM_COP2_TX_BUF_1, pt_regs, tx_buf[1]);
-	OFFSET(NLM_COP2_TX_BUF_2, pt_regs, tx_buf[2]);
-	OFFSET(NLM_COP2_TX_BUF_3, pt_regs, tx_buf[3]);
-	OFFSET(NLM_COP2_RX_BUF_0, pt_regs, rx_buf[0]);
-	OFFSET(NLM_COP2_RX_BUF_1, pt_regs, rx_buf[1]);
-	OFFSET(NLM_COP2_RX_BUF_2, pt_regs, rx_buf[2]);
-	OFFSET(NLM_COP2_RX_BUF_3, pt_regs, rx_buf[3]);
+	OFFSET(NLM_COP2_TX_BUF, pt_regs, tx_buf);
+	OFFSET(NLM_COP2_RX_BUF, pt_regs, rx_buf);
 	OFFSET(NLM_COP2_TX_MSG_STATUS, pt_regs, tx_msg_status);
 	OFFSET(NLM_COP2_RX_MSG_STATUS, pt_regs, rx_msg_status);
 	OFFSET(NLM_COP2_MISC_STATUS, pt_regs, misc_status);
-- 
1.8.4.93.g57e4c17

