From ee76885ba6af8ec14007b9db539655f281754406 Mon Sep 17 00:00:00 2001
From: Rahul Jain <rajain@netlogicmicro.com>
Date: Mon, 7 Nov 2011 12:31:36 +0530
Subject: [PATCH 298/565] Moodified the device ID allocation

Moodify the device ID allocation for nlm_sharedmem from staic to dynamic

Based on Broadcom SDK 2.3.

Signed-off-by: Rahul Jain <rajain@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/char/nlm_sharedmem.c | 16 +++++++++-------
 1 file changed, 9 insertions(+), 7 deletions(-)

diff --git a/drivers/char/nlm_sharedmem.c b/drivers/char/nlm_sharedmem.c
index 7d5eccf..4674acc 100644
--- a/drivers/char/nlm_sharedmem.c
+++ b/drivers/char/nlm_sharedmem.c
@@ -41,7 +41,6 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #include <xen/grant_table.h>
 #include <asm/xen/hypercall.h>
 
-#define SHAREDMEM_MAJOR            (252)
 #define SHAREDMEM_NAME             "nlm_sharedmem"
 #define NUM_SHAREDMEMS             (1)
 #define NLM_SHAREDMEM_ID           (101)
@@ -55,6 +54,7 @@ THE POSSIBILITY OF SUCH DAMAGE.
 static unsigned long shared_memory_mfn[MAX_MINOR_NUMBERS] = {0};
 static int num_order[MAX_MINOR_NUMBERS] = {0};
 static int domain_id = 1;
+static int sharedmem_major_num = 0;
 
 extern int gnttab_grant_foreign_access(domid_t domid, unsigned long frame, int readonly);
 extern int gnttab_update_service (uint32_t service_for_dom_id, uint32_t start_ref_id, 
@@ -185,22 +185,24 @@ static int sharedmem_init (void)
 {
 	int ret;
 
-	ret = register_chrdev (SHAREDMEM_MAJOR, SHAREDMEM_NAME, &sharedmem_fops);
-	if (ret != 0) {
+	ret = register_chrdev (0, SHAREDMEM_NAME, &sharedmem_fops);
+	if (ret < 0) {
 		printk("[%s] Failed to register packet memory char device major=%d\n", 
-			   __FUNCTION__, SHAREDMEM_MAJOR);
+			   __FUNCTION__, 0);
 		return -EIO;
 	}
+	sharedmem_major_num = ret;
+	printk("[%s] Registered nlm_sharedmem char device major=%d\n", 
+		   __FUNCTION__, sharedmem_major_num);
+	
 
-	printk("[%s] Registered packet memory char device major=%d\n", 
-		   __FUNCTION__, SHAREDMEM_MAJOR);
 	return 0;
 }
 
 static void sharedmem_cleanup (void)
 {
 	printk("cleaning up module\n");
-	unregister_chrdev (SHAREDMEM_MAJOR, SHAREDMEM_NAME);
+	unregister_chrdev (sharedmem_major_num, SHAREDMEM_NAME);
 }
 
 module_init(sharedmem_init);
-- 
1.8.4.93.g57e4c17

