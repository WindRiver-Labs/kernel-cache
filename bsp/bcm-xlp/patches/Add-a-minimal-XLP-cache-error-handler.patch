From 3a29ce23b07adf42de4e4d0925256bdeaa5c6528 Mon Sep 17 00:00:00 2001
From: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Date: Wed, 6 Oct 2010 15:57:27 -0700
Subject: [PATCH 147/565] Add a minimal XLP cache error handler

Add a minimal XLP cache error handler.

Based on Broadcom SDK 2.3.

Signed-off-by: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/netlogic/iomap.h     |  2 +-
 arch/mips/include/asm/netlogic/mips-exts.h | 16 ++++++++++++++++
 arch/mips/mm/cex-gen.S                     | 20 ++++++--------------
 3 files changed, 23 insertions(+), 15 deletions(-)

diff --git a/arch/mips/include/asm/netlogic/iomap.h b/arch/mips/include/asm/netlogic/iomap.h
index 6fcde45..8cb2610 100644
--- a/arch/mips/include/asm/netlogic/iomap.h
+++ b/arch/mips/include/asm/netlogic/iomap.h
@@ -26,7 +26,7 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #ifndef _ASM_RFI_IO_H
 #define _ASM_RFI_IO_H
 
-#if !defined(CONFIG_NLM_XLP)
+#if defined(CONFIG_NLM_XLR)
 #define DEFAULT_NETLOGIC_IO_BASE 0xffffffffbef00000ULL
 #define NETLOGIC_IO_DDR2_CHN0_OFFSET       0x01000
 #define NETLOGIC_IO_DDR2_CHN1_OFFSET       0x02000
diff --git a/arch/mips/include/asm/netlogic/mips-exts.h b/arch/mips/include/asm/netlogic/mips-exts.h
index e214350..ca30429 100644
--- a/arch/mips/include/asm/netlogic/mips-exts.h
+++ b/arch/mips/include/asm/netlogic/mips-exts.h
@@ -301,7 +301,23 @@ static __inline__ int hard_smp_processor_id(void)
 #define CPU_BLOCKID_MMU      4
 #define CPU_BLOCKID_PRF      5
 
+#ifdef CONFIG_NLM_XLR
 #define LSU_CERRLOG_REGID    9
+#else
+#define CPU_BLOCKID_SCU      8
+
+#define ICU_CERRLOG0_REGID   0x10
+#define ICU_CERRLOG1_REGID   0x11
+#define ICU_CERRLOG2_REGID   0x12
+
+#define LSU_CERRLOG0_REGID   0x08
+#define LSU_CERRLOG1_REGID   0x09
+
+#define SCU_CERRLOG0_REGID   0x10
+#define SCU_CERRLOG1_REGID   0x11
+#define SCU_CERRLOG2_REGID   0x12
+
+#endif
 
 static __inline__ unsigned int read_32bit_nlm_ctrl_reg(int block, int reg)
 {
diff --git a/arch/mips/mm/cex-gen.S b/arch/mips/mm/cex-gen.S
index ef88f02..2e4274b 100644
--- a/arch/mips/mm/cex-gen.S
+++ b/arch/mips/mm/cex-gen.S
@@ -48,25 +48,17 @@ the header of the original work apply to this derived work.
 
 	/* If some other cpu is already in the handler
 	 * just wait... */
-	PTR_LA	k0, xlr_cerr_lock
+	PTR_LA	k0, nlm_cerr_lock
 1:	lw	k1, 0(k0)
 	bnez	k1, 1b
 	nop
-	
+
 	/* switch stack to a new one */
-	PTR_LA	sp, xlr_cerr_stack
-	li	k1, 8192 - 64
+	PTR_LA		sp, nlm_cerr_stack
+	li		k1, 8192 - 64
 	PTR_ADDU	sp, sp, k1
-	
-	/* set up first argument - pt_regs */
-	move	a0, sp
-	/* read the cache error log reg in the cpu */
-	li	k1, 0x309
-	/*mfcr	k0, k1*/
-	PTR	0x737a0018
-	move	a1, k0
-	
-    j nlm_cache_error
+
+	jal	nlm_cache_error
 	nop
 	/* should never get here */
 
-- 
1.8.4.93.g57e4c17

