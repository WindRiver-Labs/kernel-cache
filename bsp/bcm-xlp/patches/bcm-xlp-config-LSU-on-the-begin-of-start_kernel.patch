From cc2d85f7e5850f68d51848b0b6edd1f4ca95f108 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Mon, 9 Sep 2013 10:29:34 +0800
Subject: [PATCH 559/565] bcm-xlp: config LSU on the begin of start_kernel()

XLP2xx needs to config LSU before the first printk(), else system would hang.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 .../include/asm/mach-netlogic/kernel-entry-init.h  | 22 ++++++++++++++++++++++
 arch/mips/kernel/head.S                            |  5 +++++
 2 files changed, 27 insertions(+)

diff --git a/arch/mips/include/asm/mach-netlogic/kernel-entry-init.h b/arch/mips/include/asm/mach-netlogic/kernel-entry-init.h
index 7e48651..b7c8417 100644
--- a/arch/mips/include/asm/mach-netlogic/kernel-entry-init.h
+++ b/arch/mips/include/asm/mach-netlogic/kernel-entry-init.h
@@ -5,6 +5,10 @@
 
 #ifdef CONFIG_NLM_XLP
 
+#define LSU_DEFEATURE 0x304
+#define SCHED_DEFEATURE 0x700
+#define L2_FEATURE_CTRL0 0x800
+
 /* XLP_MERGE_TODO */
 #if !defined(CKSSEG)
 #ifdef CONFIG_64BIT
@@ -63,6 +67,24 @@ mapped_space:
 #endif
 	.endm
 
+	.macro CONFIG_LSU
+	.set push
+	.set noreorder
+	li      t0, LSU_DEFEATURE
+	mfcr    t1, t0
+	lui     t2, 0x4080
+	or      t1, t1, t2
+	mtcr    t1, t0
+	li      t0, SCHED_DEFEATURE
+	lui     t1, 0x0100
+	mtcr    t1, t0
+	li      t0, L2_FEATURE_CTRL0
+	mfcr    t1, t0
+	ori    t1, t1, 0x200
+	mtcr    t1, t0
+	.set pop
+	.endm
+
 #endif /* CONFIG_NLM_XLP */
 
 #endif /* __ASM_MACH_NLM_KERNEL_ENTRY_H */
diff --git a/arch/mips/kernel/head.S b/arch/mips/kernel/head.S
index 03a514c..ec8b4c6 100644
--- a/arch/mips/kernel/head.S
+++ b/arch/mips/kernel/head.S
@@ -207,6 +207,11 @@ NESTED(kernel_entry, 16, sp)			# kernel entry point
 1:	b		1b
 	nop
 #else
+	/*
+	 * XLP2xx needs to config LSU before the first printk(),
+	 * else system would hang.
+	 */
+	CONFIG_LSU
 	j		start_kernel
 #endif
 	END(kernel_entry)
-- 
1.8.4.93.g57e4c17

