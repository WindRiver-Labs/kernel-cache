From 4fd0ce9cbb2cf6f87d40589ccc906214ba6f4a20 Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@netlogicmicro.com>
Date: Tue, 5 Apr 2011 16:32:40 -0700
Subject: [PATCH 216/565] Fix bug 15422

Fix bug 15422 (turn off hpw for A0-A2 chips)

Based on Broadcom SDK 2.3.

Signed-off-by: Yonghong Song <ysong@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/mmu.c | 28 ++++++++++++++++++++++++++++
 1 file changed, 28 insertions(+)

diff --git a/arch/mips/netlogic/xlp/mmu.c b/arch/mips/netlogic/xlp/mmu.c
index adeece0..cc927eb 100644
--- a/arch/mips/netlogic/xlp/mmu.c
+++ b/arch/mips/netlogic/xlp/mmu.c
@@ -29,6 +29,7 @@
 #include <asm/asm-offsets.h>
 #include <asm/page.h>
 #include <asm/pgtable.h>
+#include <asm/netlogic/xlp.h>
 
 #define READ_INHIBIT (1 << 31)
 #define EXEC_INHIBIT (1 << 30)
@@ -166,9 +167,36 @@ void dump_pgwalker_config(void)
 #endif
 }
 
+#ifdef CONFIG_NLM_XLP
+static void pgwalker_workaround_setup(void)
+{
+	uint32_t prid, chip_id, rev_id;
+
+	prid = read_c0_prid();
+	chip_id = (prid >> 8) & 0xff;
+	rev_id  = prid & 0xff;
+
+	/* Disable hardware page walker for XLP832 (with fake chip id),
+	 * Revision A0/A1/A2 chips.
+	 */
+	if (chip_id == 0x0) {
+		if (rev_id == XLP_REVISION_A0 || rev_id == XLP_REVISION_A1
+			|| rev_id == XLP_REVISION_A2)
+			tlb_config &= ~ENABLE_PGWALKER;
+	}
+}
+#else
+static void pgwalker_workaround_setup(void) {}
+#endif
+
 void mmu_init(void)
 {
 
+	/* For XLP832 A0-A2 chips, the page walker needs to be shutdown to
+	 * prevent potential errors.
+	 */
+	pgwalker_workaround_setup();
+
 	/* 
 	 * Read back TLB entries after configuration
 	 */
-- 
1.8.4.93.g57e4c17

