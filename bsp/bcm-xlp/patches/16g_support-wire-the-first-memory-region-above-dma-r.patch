From 4547837dc9cbbe06f7057f983d45d8b2bcd0436b Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Mon, 26 Nov 2012 13:59:01 -0800
Subject: [PATCH 537/565] 16g_support: wire the first memory region above dma
 region

  o If the first memory region above dma region is not wired by default,
    wire it. This memory region is used before the exception handlers
    are properly set up.

Based on Broadcom SDK 2.3.

Signed-off-by: Yonghong Song <ysong@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/kernel/setup.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/arch/mips/kernel/setup.c b/arch/mips/kernel/setup.c
index 2384ce9..0d1e5a4 100644
--- a/arch/mips/kernel/setup.c
+++ b/arch/mips/kernel/setup.c
@@ -56,6 +56,10 @@ EXPORT_SYMBOL(cpu_data);
 struct screen_info screen_info;
 #endif
 
+#if defined(CONFIG_NLM_16G_MEM_SUPPORT) && !defined(CONFIG_NUMA)
+unsigned long non_dma_start_pfn = 0;
+#endif
+
 /*
  * Despite it's name this variable is even if we don't have PCI
  */
@@ -422,6 +426,18 @@ static void __init bootmem_init(void)
 			continue;
 #endif
 
+#if defined(CONFIG_NLM_16G_MEM_SUPPORT) && !defined(CONFIG_NUMA)
+		{
+			/* 40 bit physical address, min_start_pfn is the minimum above dma region */
+			unsigned long max_dma_pfn = (MAX_DMA_ADDRESS & 0xffffffffffULL) >> PAGE_SHIFT;
+
+			if (start >= max_dma_pfn) {
+				if (non_dma_start_pfn == 0 || non_dma_start_pfn > start)
+					non_dma_start_pfn = start;
+			}
+		}
+#endif
+
 		memblock_add_node(PFN_PHYS(start), PFN_PHYS(end - start), 0);
 	}
 
-- 
1.8.4.93.g57e4c17

