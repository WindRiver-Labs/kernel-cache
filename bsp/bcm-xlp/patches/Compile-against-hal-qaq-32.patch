From d2677bb30def9727b6e5dd140959d4027308c5f7 Mon Sep 17 00:00:00 2001
From: Jayanthi A <jayanthi.annadurai@broadcom.com>
Date: Wed, 8 Aug 2012 14:51:05 +0530
Subject: [PATCH 369/565] Compile against hal:qaq/32

XLP base port: Compile against hal:qaq/32

Based on Broadcom SDK 2.3.

Signed-off-by: Jayanthi A <jayanthi.annadurai@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/kernel/cpu-probe.c     | 42 +++++++---------------------------------
 arch/mips/netlogic/xlp/on_chip.c |  2 ++
 arch/mips/netlogic/xlp/setup.c   |  2 +-
 3 files changed, 10 insertions(+), 36 deletions(-)

diff --git a/arch/mips/kernel/cpu-probe.c b/arch/mips/kernel/cpu-probe.c
index 23fb6d5..59b514f 100644
--- a/arch/mips/kernel/cpu-probe.c
+++ b/arch/mips/kernel/cpu-probe.c
@@ -981,44 +981,16 @@ static inline void cpu_probe_netlogic(struct cpuinfo_mips *c, int cpu)
 		      MIPS_CPU_NLM_CACHE |
 		      MIPS_CPU_LLSC);
 
-	switch ((c->processor_id & 0xff00) >> 8) {
-	case CHIP_PROCESSOR_ID_XLP_8_4_XX:
-	case CHIP_PROCESSOR_ID_XLP_8XX:
-	case CHIP_PROCESSOR_ID_XLP_816:
-	case CHIP_PROCESSOR_ID_XLP_432:
-	case CHIP_PROCESSOR_ID_XLP_416:
-	case CHIP_PROCESSOR_ID_XLP_408:
-	case CHIP_PROCESSOR_ID_XLP_3XX:
-	case CHIP_PROCESSOR_ID_XLP_208:
-	case CHIP_PROCESSOR_ID_XLP_204:
-	case CHIP_PROCESSOR_ID_XLP_104:
-	case CHIP_PROCESSOR_ID_XLP_2XX:
-	{
-		c->cputype = CPU_XLP;
-
-		c->isa_level = MIPS_CPU_ISA_M64R2;
-		c->options |= (MIPS_CPU_FPU | MIPS_CPU_ULRI | MIPS_CPU_MCHECK);
-
-		c->tlbsize = ((read_c0_config6() >> 16 ) & 0xffff) + 1;
-		__cpu_name[cpu] = (const char *)get_cpu_info();
-
-		printk("Enabling XLP CPU (%s): pr id 0x%x  smp id %d\n",
-		       cpu_name_string(), c->processor_id, cpu);
-	}
-	break;
-	default:
-		c->isa_level = MIPS_CPU_ISA_M64R2;
-		c->options |= (MIPS_CPU_FPU | MIPS_CPU_ULRI | MIPS_CPU_MCHECK);
+	c->cputype = CPU_XLP;
 
-		c->tlbsize = ((read_c0_config6() >> 16) & 0xffff) + 1;
+	c->isa_level = MIPS_CPU_ISA_M64R2;
+	c->options |= (MIPS_CPU_FPU | MIPS_CPU_ULRI | MIPS_CPU_MCHECK);
 
-		c->cputype = CPU_XLP;
-		__cpu_name[cpu] = "Netlogic XLP";
-		printk(KERN_INFO "Unknown Netlogic chip id [%02x]!\n",
-		       c->processor_id);
-		break;
+	c->tlbsize = ((read_c0_config6() >> 16) & 0xffff) + 1;
+	__cpu_name[cpu] = (const char *)get_cpu_info();
 
-	}
+	printk("Enabling XLP CPU (%s): pr id 0x%x  smp id %d\n",
+	       cpu_name_string(), c->processor_id, cpu);
 }
 #endif /* CONFIG_NLM_XLP */
 
diff --git a/arch/mips/netlogic/xlp/on_chip.c b/arch/mips/netlogic/xlp/on_chip.c
index 900163a..06662af 100644
--- a/arch/mips/netlogic/xlp/on_chip.c
+++ b/arch/mips/netlogic/xlp/on_chip.c
@@ -830,6 +830,8 @@ void on_chip_init(void)
 			atomic_set(&nlm_common_counters[i][j], 0);
 
 #ifdef CONFIG_XLP_FMN_SUPPORT
+	enable_msgconfig_int();
+
 	if (is_nlm_xlp2xx())
 		vc_to_handle = xlp2xx_vc_to_handle_map;
 	else if (is_nlm_xlp3xx())
diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index 002dbf1..89142b9 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -705,7 +705,7 @@ char* get_cpu_info(void)
 	if (!nlm_hal_get_cpuinfo(&cpu_info)){
 		strcpy(cpu_model_info, cpu_info.cpu_info_str);
 	}else{
-		strcpy(cpu_model_info, "Unknown CPU");
+		strcpy(cpu_model_info, "Unknown CPU ID");
 	}
 	return cpu_model_info;
 }
-- 
1.8.4.93.g57e4c17

