From d8a7001453b04beb5ff35db4942130b7b4b3b612 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Mon, 9 Sep 2013 10:20:19 +0800
Subject: [PATCH 555/565] bcm-xlp: clean up NAE driver

1. remove some deprecated codes in Linux V3.10: such as the reference
   of timecompare, __devinitdata;
2. use the new proc FS operations to replace the old.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/nae/xlpge.h         | 17 ++++++++--------
 drivers/net/nae/xlpge_board.c   |  1 -
 drivers/net/nae/xlpge_ethtool.c |  1 -
 drivers/net/nae/xlpge_lro.c     |  1 -
 drivers/net/nae/xlpge_main.c    |  7 +++----
 drivers/net/nae/xlpge_msec.c    |  1 -
 drivers/net/nae/xlpge_nae.c     | 43 ++++++++++++++++++++++++++++++-----------
 drivers/net/nae/xlpge_proc.c    | 30 +++++++---------------------
 drivers/net/nae/xlpge_ptp.c     |  1 -
 drivers/net/nae/xlpge_rx.c      |  1 -
 drivers/net/nae/xlpge_sgmii.c   |  1 -
 drivers/net/nae/xlpge_tso.c     |  1 -
 drivers/net/nae/xlpge_tx.c      |  1 -
 13 files changed, 50 insertions(+), 56 deletions(-)

diff --git a/drivers/net/nae/xlpge.h b/drivers/net/nae/xlpge.h
index f8f9ad0..d92bbf0 100644
--- a/drivers/net/nae/xlpge.h
+++ b/drivers/net/nae/xlpge.h
@@ -280,7 +280,6 @@ struct dev_data
 	/*1588 ptp timer*/
 	struct cyclecounter cycles;
 	struct timecounter clock;
-	struct timecompare compare;
 };
 
 
@@ -429,8 +428,8 @@ void nlm_xlp_nae_init(void);
 void nlm_xlp_nae_remove(void);
 extern int xlpge_eeprom_init(void);
 void init_phy_state_timer(void *);
-inline void process_tx_complete(int , uint32_t , uint64_t);
-inline void napi_lro_flush(int);
+void process_tx_complete(int , uint32_t , uint64_t);
+void napi_lro_flush(int);
 struct eeprom_data * get_nlm_eeprom(void);
 unsigned int nlm_xlp_mac_mii_read(struct dev_data *, int);
 void nlm_xlp_mac_mii_write(struct dev_data *, int , uint16_t);
@@ -447,8 +446,8 @@ cycle_t nlm_1588_read_clock1(const struct cyclecounter *);
 cycle_t nlm_1588_read_clock2(const struct cyclecounter *);
 cycle_t nlm_1588_read_clock3(const struct cyclecounter *);
 void gen_mac_address(void);
-int xlp_mac_proc_read(char *, char **, off_t , int , int *, void *);
-int nae_proc_read(char *, char **, off_t , int , int *, void *);
+int xlp_mac_proc_show(struct seq_file *m, void *v);
+int nae_proc_show(struct seq_file *m, void *v);
 int nlm_xlp_disable_napi(void);
 void nlm_spawn_kthread(void);
 int nlm_xlp_enable_napi(void);
@@ -456,13 +455,13 @@ int mac_refill_frin_skb(int , int , uint64_t , uint32_t, int);
 int mac_refill_frin_one_buffer(struct net_device *, int , uint32_t);
 void xlp_napi_lro_flush(void *);
 void nlm_xlp_mac_set_enable(struct dev_data *priv, int flag);
-inline void *alloc_p2p_desc_mem(int);
+void *alloc_p2p_desc_mem(int);
 uint16_t pseuodo_chksum(uint16_t *, uint16_t);
-inline int create_p2p_desc(uint64_t , uint64_t , uint64_t *, int);
-inline void create_last_p2p_desc(uint64_t *, struct sk_buff *, int);
+int create_p2p_desc(uint64_t , uint64_t , uint64_t *, int);
+void create_last_p2p_desc(uint64_t *, struct sk_buff *, int);
 void xlp_poll_upper(int);
 void free_p2p_desc_mem(int cpu, void *);
-inline int tso_xmit_skb(struct sk_buff *, struct net_device *);
+int tso_xmit_skb(struct sk_buff *, struct net_device *);
 int xlp_config_msec_tx(struct net_device *, struct ethtool_cmd *);
 int xlp_config_msec_tx_mem(struct net_device *, struct ethtool_cmd *);
 int xlp_config_msec_rx(struct net_device *, struct ethtool_cmd *);
diff --git a/drivers/net/nae/xlpge_board.c b/drivers/net/nae/xlpge_board.c
index bdb2e45..355d0aa 100644
--- a/drivers/net/nae/xlpge_board.c
+++ b/drivers/net/nae/xlpge_board.c
@@ -33,7 +33,6 @@
 #include <linux/etherdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 
 #include <asm/netlogic/hal/nlm_hal_nae.h>
 #include <asm/netlogic/hal/nlm_eeprom.h>
diff --git a/drivers/net/nae/xlpge_ethtool.c b/drivers/net/nae/xlpge_ethtool.c
index 94bb680..bc970cf 100644
--- a/drivers/net/nae/xlpge_ethtool.c
+++ b/drivers/net/nae/xlpge_ethtool.c
@@ -33,7 +33,6 @@
 #include <linux/etherdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 #include <linux/ethtool.h>
 #include <linux/mii.h>
 
diff --git a/drivers/net/nae/xlpge_lro.c b/drivers/net/nae/xlpge_lro.c
index 5f67a58..b3a15ad 100644
--- a/drivers/net/nae/xlpge_lro.c
+++ b/drivers/net/nae/xlpge_lro.c
@@ -32,7 +32,6 @@
 #include <linux/netdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 
 #include "xlpge.h"
 
diff --git a/drivers/net/nae/xlpge_main.c b/drivers/net/nae/xlpge_main.c
index 358d7b1..081c932 100644
--- a/drivers/net/nae/xlpge_main.c
+++ b/drivers/net/nae/xlpge_main.c
@@ -32,12 +32,11 @@
 #include <linux/netdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 
 #include "xlpge.h"
 
 
-static const struct pci_device_id xlpnae_pci_table[] __devinitdata = {
+static const struct pci_device_id xlpnae_pci_table[] = {
 	{
 		.vendor		= PCI_VENDOR_NETLOGIC,
 		.device		= PCI_DEVICE_ID_NLM_NAE,
@@ -46,13 +45,13 @@ static const struct pci_device_id xlpnae_pci_table[] __devinitdata = {
 	},
 };
 
-static int __devinit brcmxlp_nae_pci_probe(struct pci_dev *pdev,
+static int brcmxlp_nae_pci_probe(struct pci_dev *pdev,
 					   const struct pci_device_id *ent)
 {
 	return pci_enable_device(pdev);
 }
 
-static void __devexit brcmxlp_nae_pci_remove(struct pci_dev *pdev)
+static void brcmxlp_nae_pci_remove(struct pci_dev *pdev)
 {
 	pci_disable_device(pdev);
 }
diff --git a/drivers/net/nae/xlpge_msec.c b/drivers/net/nae/xlpge_msec.c
index 5eca3dc..6ce709e 100644
--- a/drivers/net/nae/xlpge_msec.c
+++ b/drivers/net/nae/xlpge_msec.c
@@ -32,7 +32,6 @@
 #include <linux/netdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 
 #include "xlpge.h"
 
diff --git a/drivers/net/nae/xlpge_nae.c b/drivers/net/nae/xlpge_nae.c
index 16e2a24..094f321 100644
--- a/drivers/net/nae/xlpge_nae.c
+++ b/drivers/net/nae/xlpge_nae.c
@@ -33,7 +33,6 @@
 #include <linux/etherdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 #include <linux/proc_fs.h>
 #include <linux/timer.h>
 #include <asm/netlogic/xlp.h>
@@ -1404,6 +1403,30 @@ static int nlm_per_port_nae_init(int node, int port,
 	return 0;
 }
 
+static int nae_proc_open(struct inode *inode, struct file *file)
+{
+	return single_open(file, nae_proc_show, NULL);
+}
+
+static const struct file_operations nae_proc_fops = {
+	.open		= nae_proc_open,
+	.read		= seq_read,
+	.llseek		= seq_lseek,
+	.release	= single_release,
+};
+
+static int xlp_mac_proc_open(struct inode *inode, struct file *file)
+{
+	return single_open(file, xlp_mac_proc_show, NULL);
+}
+
+static const struct file_operations xlp_mac_proc_fops = {
+	.open		= xlp_mac_proc_open,
+	.read		= seq_read,
+	.llseek		= seq_lseek,
+	.release	= single_release,
+};
+
 /**********************************************************************
  * nlm_xlp_nae_init -  xlp_nae device driver init function
  * @dev  -  this is per device based function
@@ -1456,20 +1479,18 @@ void nlm_xlp_nae_init(void)
 
 	}
 
-	entry = create_proc_read_entry("mac_stats",
-				       0,			/* def mode */
-				       nlm_root_proc,		/* parent */
-				       xlp_mac_proc_read,	/* proc fn */
-				       0	/* no client data */);
+	entry = proc_create_data("mac_stats", 0, /* def mode */
+					nlm_root_proc,	/* parent */
+					&xlp_mac_proc_fops,
+					0 /* no client data */);
 	if (!entry) {
 		printk("[%s]: Unable to create proc entry for xlp_mac!\n",
 		       __func__);
 	}
-	entry = create_proc_read_entry("nae_stat",
-				       0,
-				       nlm_root_proc,
-				       nae_proc_read,
-				       0);
+	entry = proc_create_data("nae_stat", 0,
+					nlm_root_proc,	/* parent */
+					&nae_proc_fops,
+					0);
 	if (!entry) {
 		printk("[%s]: Unable to create proc entry for nae_proc!\n",
 		       __func__);
diff --git a/drivers/net/nae/xlpge_proc.c b/drivers/net/nae/xlpge_proc.c
index 31233ca..c6428e6 100644
--- a/drivers/net/nae/xlpge_proc.c
+++ b/drivers/net/nae/xlpge_proc.c
@@ -32,7 +32,6 @@
 #include <linux/netdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 #include <linux/proc_fs.h>
 
 #include "xlpge.h"
@@ -43,16 +42,14 @@ void nlm_nae_remove_procentries(void)
 	remove_proc_entry("mac_stats", nlm_root_proc);
 }
 
-int nae_proc_read(char *page, char **start, off_t off,
-			     int count, int *eof, void *data)
+int nae_proc_show(struct seq_file *m, void *v)
 {
-	int len = 0;
 	int i = 0;
 	uint64_t total_err = 0, total_fast = 0;
 	uint64_t total_slow = 0, total_recv = 0;
 
 	for (i = 0; i < NR_CPUS; i++) {
-		printk("cpu%d, recv %ld fast_repl %ld, slow_repl %ld "
+		seq_printf(m, "cpu%d, recv %ld fast_repl %ld, slow_repl %ld "
 			"err_repl %ld p2pdalloc %lld\n", i,
 			(ulong)receive_count[CPU_INDEX(i)],
 			(ulong)fast_replenish_count[CPU_INDEX(i)],
@@ -72,15 +69,14 @@ int nae_proc_read(char *page, char **start, off_t off,
 		receive_count[CPU_INDEX(i)] = 0;
 	}
 	/*check how many hash are empty...*/
-	printk("TOTAL_FAST_REPL %ld, TOTAL_SLOW_REPL %ld,"
+	seq_printf(m, "TOTAL_FAST_REPL %ld, TOTAL_SLOW_REPL %ld,"
 	       " TOTAL_ERR_REPL %ld TOTAL_RECV %ld\n",
 			(ulong)total_fast,
 			(ulong)total_slow,
 			(ulong)total_err,
 			(ulong)total_recv);
 
-	*eof = 1;
-	return len;
+	return 0;
 }
 
 /**********************************************************************
@@ -89,11 +85,8 @@ int nae_proc_read(char *page, char **start, off_t off,
  * @dev_id  -  this device
  *
  **********************************************************************/
-int xlp_mac_proc_read(char *page, char **start, off_t off,
-			     int count, int *eof, void *data)
+int xlp_mac_proc_show(struct seq_file *m, void *v)
 {
-	int len = 0;
-	off_t begin = 0;
 	int i = 0, cpu = 0, node;
 	struct net_device *dev = 0;
 	struct dev_data *priv = 0;
@@ -115,7 +108,7 @@ int xlp_mac_proc_read(char *page, char **start, off_t off,
 
 				if (!tx && !txc && !rx && !ints) continue;
 
-				len += sprintf(page + len,
+				seq_printf(m,
 					"per cpu@%d: %lu(txp) %lu(txcp) "
 					"%lu(rxp) %lu(int)\n",
 					cpu, tx, txc, rx, ints);
@@ -123,15 +116,6 @@ int xlp_mac_proc_read(char *page, char **start, off_t off,
 		}
 	}
 
-	*eof = 1;
-
-	*start = page + (off - begin);
-	len -= (off - begin);
-	if (len > count)
-		len = count;
-	if (len < 0)
-		len = 0;
-
-	return len;
+	return 0;
 }
 
diff --git a/drivers/net/nae/xlpge_ptp.c b/drivers/net/nae/xlpge_ptp.c
index 04ab077..c59fca2 100644
--- a/drivers/net/nae/xlpge_ptp.c
+++ b/drivers/net/nae/xlpge_ptp.c
@@ -32,7 +32,6 @@
 #include <linux/netdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 
 #include "xlpge.h"
 
diff --git a/drivers/net/nae/xlpge_rx.c b/drivers/net/nae/xlpge_rx.c
index 15ee9fd..087e5a8 100644
--- a/drivers/net/nae/xlpge_rx.c
+++ b/drivers/net/nae/xlpge_rx.c
@@ -33,7 +33,6 @@
 #include <linux/etherdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 #include <linux/kthread.h>
 
 #include <asm/netlogic/xlp.h>
diff --git a/drivers/net/nae/xlpge_sgmii.c b/drivers/net/nae/xlpge_sgmii.c
index e7d11d4..c5a54d7 100644
--- a/drivers/net/nae/xlpge_sgmii.c
+++ b/drivers/net/nae/xlpge_sgmii.c
@@ -32,7 +32,6 @@
 #include <linux/netdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 #include <linux/mii.h>
 
 #include "xlpge.h"
diff --git a/drivers/net/nae/xlpge_tso.c b/drivers/net/nae/xlpge_tso.c
index 3f8e33c..dc8264a 100644
--- a/drivers/net/nae/xlpge_tso.c
+++ b/drivers/net/nae/xlpge_tso.c
@@ -32,7 +32,6 @@
 #include <linux/netdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 
 #include <asm/netlogic/msgring.h>
 #include <asm/netlogic/hal/nlm_hal_fmn.h>
diff --git a/drivers/net/nae/xlpge_tx.c b/drivers/net/nae/xlpge_tx.c
index 4ccb95d..6f96002 100644
--- a/drivers/net/nae/xlpge_tx.c
+++ b/drivers/net/nae/xlpge_tx.c
@@ -33,7 +33,6 @@
 #include <linux/etherdevice.h>
 #include <linux/inet_lro.h>
 #include <linux/clocksource.h>
-#include <linux/timecompare.h>
 #include <linux/kthread.h>
 
 #include <asm/netlogic/msgring.h>
-- 
1.8.4.93.g57e4c17

