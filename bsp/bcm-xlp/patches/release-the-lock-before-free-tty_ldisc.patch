From d4cbdccf8c49262cb5b303a9c4ba8d49d72f24be Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Wed, 18 Sep 2013 13:09:39 +0800
Subject: [PATCH 7/7] release the lock before free tty_ldisc.

Commit ebc9baed4 ("tty: Separate release semantics of ldisc reference")
moved kfree() within raw_spin_unlock_irqrsave()/raw_spin_unlock_irqrestore(),
this introduces the below error.
Because tty_ldisc_lock is to protect ld->ops, not for ld itself, we don't need
to hold the lock during ld freeing.

BUG: sleeping function called from invalid context at .../kernel/rtmutex.c:659
in_atomic(): 1, irqs_disabled(): 1, pid: 1, name: init
Preemption disabled at:[<          (null)>]           (null)

CPU: 2 PID: 1 Comm: init Tainted: G        W
Stack : 00000000000003e0 ffffffffc18e0000 0000000000000004 ffffffffc18e0000
	  0000000000000000 ffffffffc18e0000 0000000000000000 0000000000000000
	  ffffffffc1cd0000 0000000000000000 0000000000000053 ffffffffc104d66c
	  0000000000000000 0000000000000000 0000000000000000 ffffffffc1cb0000
	  ffffffffc1caf8e8 ffffffffc1cb0000 ffffffffc178d310 ffffffffc18d4037
	  ffffffffc1caf8e8 c0000000fc6d0390 0000000000000001 0000000000000002
	  0000000000000001 ffffffffc18c0000 c0000000f40e7000 ffffffffc1689150
	  c0000000fc59fb80 c0000000fc59fa78 0000000000000000 ffffffffc1693c90
	  c0000000fc6d0000 ffffffffc178d310 0000000000000002 0000000000000001
	  0000000000000000 ffffffffc1022230 0000000000000000 0000000000000000
	  ...
Call Trace:
[<ffffffffc1022230>] show_stack+0x78/0x90
[<ffffffffc1693c90>] __rt_spin_lock+0x30/0xd8
[<ffffffffc1694040>] rt_read_lock+0x38/0x58
[<ffffffffc169407c>] rt_read_lock_irqsave+0x1c/0x30
[<ffffffffc1172c10>] find_and_get_object+0x68/0x220
[<ffffffffc11731bc>] delete_object_full+0x4c/0xc0
[<ffffffffc1164018>] kfree+0x1c8/0x368
[<ffffffffc13d546c>] tty_ldisc_kill+0x154/0x3b8
[<ffffffffc13d72f4>] tty_ldisc_release+0x74/0xe0
[<ffffffffc13cd8b4>] tty_release+0x674/0x690
[<ffffffffc117916c>] __fput+0xd4/0x288
[<ffffffffc1076000>] task_work_run+0xf0/0x1d0
[<ffffffffc101bb88>] work_notifysig+0x10/0x18

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/tty/tty_ldisc.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/tty/tty_ldisc.c b/drivers/tty/tty_ldisc.c
index 1afe192..8efeb38e 100644
--- a/drivers/tty/tty_ldisc.c
+++ b/drivers/tty/tty_ldisc.c
@@ -198,8 +198,8 @@ static inline void tty_ldisc_put(struct tty_ldisc *ld)
 
 	ld->ops->refcount--;
 	module_put(ld->ops->owner);
-	kfree(ld);
 	raw_spin_unlock_irqrestore(&tty_ldisc_lock, flags);
+	kfree(ld);
 }
 
 static void *tty_ldiscs_seq_start(struct seq_file *m, loff_t *pos)
-- 
1.8.4.93.g57e4c17

