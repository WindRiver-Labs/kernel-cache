From ac1c4a6a0e4c5194a882a21061f10f4b7d9e060a Mon Sep 17 00:00:00 2001
From: Mehul <vmehul@netlogicmicro.com>
Date: Mon, 19 Dec 2011 19:21:45 +0530
Subject: [PATCH 315/565] local_irq_save/restore when acking the vc interrupt

Do local_irq_save/restore while acking the vc interrupt in softirq context.

Based on Broadcom SDK 2.3.

Signed-off-by: Mehul <vmehul@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/on_chip.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/arch/mips/netlogic/xlp/on_chip.c b/arch/mips/netlogic/xlp/on_chip.c
index a04f2b3..31b015c 100644
--- a/arch/mips/netlogic/xlp/on_chip.c
+++ b/arch/mips/netlogic/xlp/on_chip.c
@@ -762,12 +762,15 @@ int xlp_fmn_poll(struct napi_struct *napi, int budget)
 	/*Ack fmn interrupts.*/
 	if(count < budget) {
 		uint32_t val;
+		unsigned long flags;
+		local_irq_save(flags);
                 napi_complete(napi);
 		/* Need write vc into the register */
 		val =  _read_32bit_cp2_register(XLP_MSG_STATUS1_REG);
 		//val |= ((1 << vc) << 16);
 		val |= (napi_vc_mask << 16);
 		_write_32bit_cp2_register(XLP_MSG_STATUS1_REG, val);
+		local_irq_restore(flags);
 		return count;
 	}
 	return budget;
-- 
1.8.4.93.g57e4c17

