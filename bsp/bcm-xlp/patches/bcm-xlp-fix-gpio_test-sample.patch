From a79c17c705361005d856c547af7b9dae9ca397a7 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Wed, 5 Jun 2013 12:49:46 +0800
Subject: [PATCH 541/565] bcm-xlp: fix gpio_test() sample

Use nlm_gpio_direction_output()/nlm_gpio_direction_input() to replace
gpio_direction_output()/gpio_direction_input() in function gpio_test().
Else system will print the below calltrace:

Call Trace:
[<ffffffff80219588>] dump_stack+0x8/0x34
[<ffffffff80271248>] warn_slowpath_common+0x70/0x98
[<ffffffff802712c4>] warn_slowpath_fmt+0x34/0x40
[<ffffffff805ea710>] gpio_ensure_requested+0xa0/0x218
[<ffffffff805ea984>] gpio_direction_output+0xfc/0x170
[<ffffffff80236e44>] gpio_test+0x12c/0x2c8
[<ffffffff80a48c9c>] xlp_gpiolib_init+0x1c/0x2c
[<ffffffff8021d7f0>] do_one_initcall+0x38/0x1a8
[<ffffffff80a443d4>] kernel_init+0x1fc/0x2d8
[<ffffffff80239d88>] kernel_thread_helper+0x10/0x18

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/xlp_gpio.c | 54 ++++++++++++++++++++++-----------------
 1 file changed, 30 insertions(+), 24 deletions(-)

diff --git a/arch/mips/netlogic/xlp/xlp_gpio.c b/arch/mips/netlogic/xlp/xlp_gpio.c
index d1a480a..3b4df93 100644
--- a/arch/mips/netlogic/xlp/xlp_gpio.c
+++ b/arch/mips/netlogic/xlp/xlp_gpio.c
@@ -181,6 +181,16 @@ static int nlm_gpio_direction_output(struct gpio_chip *chip,
         return xlp_gpio_direction_output(offset, value);
 }
 
+struct gpio_chip xlp_gpio_chip = {
+	.label                  = "xlp-gpio",
+	.direction_input        = nlm_gpio_direction_input,
+	.direction_output       = nlm_gpio_direction_output,
+	.get                    = gpio_get,
+	.set                    = gpio_set,
+	.base                   = 0,
+	.ngpio                  = XLP_GPIO_MAX,
+};
+
 #define XLP_GPIO_DEBUG	0
 #if XLP_GPIO_DEBUG
 static void gpio_dump_reg(void)
@@ -200,40 +210,36 @@ void gpio_test(void)
 
 	printk("read gpio value\n");
         for(i = 0; i < 41; i++) {
-                printk("gpio%d = 0x%8x\n", i, gpio_get_value(i));
+		printk(KERN_INFO "gpio%d = 0x%8x\n", i, xlp_gpio_get_value(i));
         }
 	printk("set gpio value 1\n");
+	gpio_dump_reg();
 
         for(i = 0; i < 41; i++) {
-		gpio_direction_output(i, 1);
-		printk("0x%0x = 0x%8x\n",  i < 32 ? 40 : 41, gpio_reg_read(0, i < 32 ? 40 : 41));
-		gpio_direction_input(i);
-		printk("0x%0x = 0x%8x\n",  i < 32 ? 40 : 41, gpio_reg_read(0, i < 32 ? 40 : 41));
-                printk("gpio%d = 0x%8x\n", i, gpio_get_value(i));
-        }
+		nlm_gpio_direction_output(&xlp_gpio_chip, i, 1);
+		printk(KERN_INFO "0x%0x = 0x%8x\n",
+			i < 32 ? 40 : 41, gpio_reg_read(0, i < 32 ? 40 : 41));
+		nlm_gpio_direction_input(&xlp_gpio_chip, i);
+		printk(KERN_INFO "0x%0x = 0x%8x\n",
+			i < 32 ? 40 : 41, gpio_reg_read(0, i < 32 ? 40 : 41));
+		printk(KERN_INFO "gpio%d = 0x%8x\n", i, xlp_gpio_get_value(i));
+	}
 
-	printk("set gpio value 0\n");
+	printk(KERN_INFO "set gpio value 0\n");
         for(i = 0; i < 41; i++) {
-		gpio_direction_output(i, 0);
-		printk("0x%0x = 0x%8x\n",  i < 32 ? 40 : 41, gpio_reg_read(0, i < 32 ? 40 : 41));
-		gpio_direction_input(i);
-		printk("0x%0x = 0x%8x\n",  i < 32 ? 40 : 41, gpio_reg_read(0, i < 32 ? 40 : 41));
-                printk("gpio%d = 0x%8x\n", i, gpio_get_value(i));
-        }
+		nlm_gpio_direction_output(&xlp_gpio_chip, i, 0);
+		printk(KERN_INFO "0x%0x = 0x%8x\n",
+			i < 32 ? 40 : 41, gpio_reg_read(0, i < 32 ? 40 : 41));
+		nlm_gpio_direction_input(&xlp_gpio_chip, i);
+		printk(KERN_INFO "0x%0x = 0x%8x\n",
+			i < 32 ? 40 : 41, gpio_reg_read(0, i < 32 ? 40 : 41));
+		printk(KERN_INFO "gpio%d = 0x%8x\n", i, xlp_gpio_get_value(i));
+	}
+	gpio_dump_reg();
 
 }
 #endif
 
-struct gpio_chip xlp_gpio_chip = {
-	.label                  = "xlp-gpio",
-	.direction_input        = nlm_gpio_direction_input,
-	.direction_output       = nlm_gpio_direction_output,
-	.get                    = gpio_get,
-	.set                    = gpio_set,
-	.base                   = 0,
-	.ngpio                  = XLP_GPIO_MAX,
-};
-
 static int __init xlp_gpiolib_init(void)
 {
         gpiochip_add(&xlp_gpio_chip);
-- 
1.8.4.93.g57e4c17

