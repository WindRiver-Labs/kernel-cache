From 19f62baf8e66d554fa39a17d8f3f1accb2d0b5ac Mon Sep 17 00:00:00 2001
From: Zi Shen Lim <zlim@netlogicmicro.com>
Date: Tue, 1 Nov 2011 14:51:17 -0700
Subject: [PATCH 291/565] on_chip.c: pic_init fixup

on_chip.c: pic_init fixup

Based on Broadcom SDK 2.3.

Signed-off-by: Zi Shen Lim <zlim@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/on_chip.c | 19 ++++++++++++-------
 1 file changed, 12 insertions(+), 7 deletions(-)

diff --git a/arch/mips/netlogic/xlp/on_chip.c b/arch/mips/netlogic/xlp/on_chip.c
index 35e9323..bd70769 100644
--- a/arch/mips/netlogic/xlp/on_chip.c
+++ b/arch/mips/netlogic/xlp/on_chip.c
@@ -588,18 +588,23 @@ void xlp_set_cpumask(const struct cpumask *m, int irt)
  ********************************************************************/
 static void pic_init(void)
 {
-	int i = 0;
-	int vcpu;
+	int irt = 0;
+	int cpu;
+	int cpugroup;
 	uint32_t thread_mask;
 
-	vcpu = hard_smp_processor_id() & 0x1F;
-
-	thread_mask = (1 << vcpu);
+	cpu = hard_smp_processor_id();
+	cpugroup = cpu >> 16;
+	thread_mask = (1 << (cpu & 0xffff));
 
-	for (i = XLP_IRQ_RESERVED_MAX; i < XLP_IRT_NUM; i++) {
+	for (irt = 0; irt < XLP_IRT_NUM; irt++) {
 		/* Use local scheduling
 		 * Invalidate all IRTs, by default */
-		nlm_hal_pic_write_irt(xlp_irq_to_irt(i), 0, 0, 1, xlp_rvec_from_irq(i), 1, 0, thread_mask);
+		nlm_hal_pic_write_irt(irt, 0 /* en:0=disable */, 0 /* nmi */,
+				      1 /* sch:1=local */, 0 /* vec */,
+				      1 /* dt:1=ID */,
+				      cpugroup /* db */,
+				      thread_mask /* dte */);
 	}
 
 	/* On XLP, MSGRING config register is per hw-thread */
-- 
1.8.4.93.g57e4c17

