From 259c68a2cebe874e811b0f262a5871b7c15acc50 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Thu, 25 Apr 2013 17:00:06 +0800
Subject: [PATCH 492/565] Kernel: Compressed Linux Kernel support.

Based on Broadcom SDK 2.3.

Signed-off-by: Manish Duggal <manishd@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/Kconfig                      |  1 +
 arch/mips/Makefile                     |  2 +-
 arch/mips/boot/compressed/Makefile     | 13 ++++++++++---
 arch/mips/boot/compressed/uart-16550.c | 11 ++++++++---
 arch/mips/netlogic/Kconfig             |  1 +
 5 files changed, 21 insertions(+), 7 deletions(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index 33a4a43..8229997 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -839,6 +839,7 @@ config NLM_XLP_BOARD
 	select SYS_SUPPORTS_NUMA
 	select SYS_SUPPORTS_HUGETLBFS
 	select ARCH_THREAD_INFO_ALLOCATOR
+	select SYS_SUPPORTS_ZBOOT
 	help
 	  This board is based on Netlogic XLP Processor.
 	  Say Y here if you have a XLP based board.
diff --git a/arch/mips/Makefile b/arch/mips/Makefile
index 827ca99..5f224f4 100644
--- a/arch/mips/Makefile
+++ b/arch/mips/Makefile
@@ -314,7 +314,7 @@ vmlinuz vmlinuz.bin vmlinuz.ecoff vmlinuz.srec: $(vmlinux-32) FORCE
 	   VMLINUX_LOAD_ADDRESS=$(load-y) 32bit-bfd=$(32bit-bfd) $@
 
 
-CLEAN_FILES += vmlinux.32 vmlinux.64
+CLEAN_FILES += vmlinux.32 vmlinux.64 vmlinuz 
 
 archprepare:
 ifdef CONFIG_MIPS32_N32
diff --git a/arch/mips/boot/compressed/Makefile b/arch/mips/boot/compressed/Makefile
index bbaa1d4..0a1352b 100644
--- a/arch/mips/boot/compressed/Makefile
+++ b/arch/mips/boot/compressed/Makefile
@@ -19,11 +19,18 @@ BOOT_HEAP_SIZE := 0x400000
 KBUILD_CFLAGS := $(shell echo $(KBUILD_CFLAGS) | sed -e "s/-pg//")
 
 KBUILD_CFLAGS := $(LINUXINCLUDE) $(KBUILD_CFLAGS) -D__KERNEL__ \
-	-DBOOT_HEAP_SIZE=$(BOOT_HEAP_SIZE) -D"VMLINUX_LOAD_ADDRESS_ULL=$(VMLINUX_LOAD_ADDRESS)ull"
+	-DBOOT_HEAP_SIZE=$(BOOT_HEAP_SIZE) -D"VMLINUX_LOAD_ADDRESS_ULL=$(CONFIG_PHYS_LOAD_ADDRESS)ull"
+
+ifdef CONFIG_MAPPED_KERNEL
+ENTRY_POINT=" phys_entry"
+else
+ENTRY_POINT=" kernel_entry"
+endif
 
 KBUILD_AFLAGS := $(LINUXINCLUDE) $(KBUILD_AFLAGS) -D__ASSEMBLY__ \
 	-DBOOT_HEAP_SIZE=$(BOOT_HEAP_SIZE) \
-	-DKERNEL_ENTRY=0x$(shell $(NM) $(objtree)/$(KBUILD_IMAGE) 2>/dev/null | grep " kernel_entry" | cut -f1 -d \ )
+	-DKERNEL_ENTRY=0x$(shell $(NM) $(objtree)/$(KBUILD_IMAGE) 2>/dev/null | grep $(ENTRY_POINT) | cut -f1 -d \ )
+
 
 targets := head.o decompress.o dbg.o uart-16550.o uart-alchemy.o
 
@@ -62,7 +69,7 @@ ifeq ($(CONFIG_MACH_JZ4740),y)
 VMLINUZ_LOAD_ADDRESS := 0x80600000
 else
 VMLINUZ_LOAD_ADDRESS = $(shell $(obj)/calc_vmlinuz_load_addr \
-		$(obj)/vmlinux.bin $(VMLINUX_LOAD_ADDRESS))
+		$(obj)/vmlinux.bin $(CONFIG_PHYS_LOAD_ADDRESS))
 endif
 
 vmlinuzobjs-y += $(obj)/piggy.o
diff --git a/arch/mips/boot/compressed/uart-16550.c b/arch/mips/boot/compressed/uart-16550.c
index 1c7b739..8dbee9a 100644
--- a/arch/mips/boot/compressed/uart-16550.c
+++ b/arch/mips/boot/compressed/uart-16550.c
@@ -18,6 +18,11 @@
 #define PORT(offset) (CKSEG1ADDR(AR7_REGS_UART0) + (4 * offset))
 #endif
 
+#ifdef CONFIG_NLM_XLP
+#define UART_BASE 0x18030100
+#define PORT(offset) (CKSEG1ADDR(UART_BASE) + (4 * offset))
+#endif
+
 #ifdef CONFIG_MACH_JZ4740
 #define UART0_BASE  0xB0030000
 #define PORT(offset) (UART0_BASE + (4 * offset))
@@ -29,17 +34,17 @@
 
 static inline unsigned int serial_in(int offset)
 {
-	return *((char *)PORT(offset));
+	return *((u32 *)PORT(offset));
 }
 
 static inline void serial_out(int offset, int value)
 {
-	*((char *)PORT(offset)) = value;
+	*((u32 *)PORT(offset)) = value;
 }
 
 void putc(char c)
 {
-	int timeout = 1024;
+	int timeout = 1024000;
 
 	while (((serial_in(UART_LSR) & UART_LSR_THRE) == 0) && (timeout-- > 0))
 		;
diff --git a/arch/mips/netlogic/Kconfig b/arch/mips/netlogic/Kconfig
index e6c8dd5..dfcf79f 100644
--- a/arch/mips/netlogic/Kconfig
+++ b/arch/mips/netlogic/Kconfig
@@ -9,6 +9,7 @@ config NLMCOMMON
 
 config NLM_XLP
 	select NLM_ATOMICS if !NLM_XLP_A0_WORKAROUNDS
+	select SYS_SUPPORTS_ZBOOT_UART16550
 	bool
 
 config NLM_ATOMICS
-- 
1.8.4.93.g57e4c17

