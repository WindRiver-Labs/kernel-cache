From f00a63ae4c778480672fb3c96fed34a8b395ed3e Mon Sep 17 00:00:00 2001
From: henry shao <hshao@netlogicmicro.com>
Date: Wed, 9 Jun 2010 15:22:10 -0700
Subject: [PATCH 044/565] bcm-xlp: change smp_processor_id

Change smp_processor_id to hard_smp_processor_id.

Based on Broadcom SDK 2.3.

Signed-off-by: henry shao <hshao@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/on_chip.c | 3 ++-
 arch/mips/netlogic/xlp/time.c    | 6 ++++--
 2 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/arch/mips/netlogic/xlp/on_chip.c b/arch/mips/netlogic/xlp/on_chip.c
index 031b275..3261753 100644
--- a/arch/mips/netlogic/xlp/on_chip.c
+++ b/arch/mips/netlogic/xlp/on_chip.c
@@ -334,7 +334,8 @@ void nlm_xlp_msgring_int_handler(unsigned int irq, struct pt_regs *regs)
 
 	cycles = read_c0_count();
 
-	core = cpu_logical_map(smp_processor_id()) >> 2;
+//	core = cpu_logical_map(smp_processor_id()) >> 2;
+	core = cpu_logical_map(hard_smp_processor_id()) >> 2;
 //	msgring_process_rx_msgs(pop_bucket_start[core], pop_bucket_end[core], pop_bucket_mask[core]);
         msgrng_access_enable(mflags);
 	for( vc = 0; vc < 4; vc++){
diff --git a/arch/mips/netlogic/xlp/time.c b/arch/mips/netlogic/xlp/time.c
index d4eb942..3253e74 100644
--- a/arch/mips/netlogic/xlp/time.c
+++ b/arch/mips/netlogic/xlp/time.c
@@ -73,7 +73,8 @@ extern void nlm_common_oprofile_int_handler(int irq, void *dev_id,
 #endif
 void nlm_common_timer_interrupt(struct pt_regs *regs, int irq)
 {
-	int cpu = smp_processor_id();
+//	int cpu = smp_processor_id();
+	int cpu = hard_smp_processor_id();
 
 #ifdef CONFIG_NLM_WATCHDOG
         pic_reg_t *mmio = (pic_reg_t *) XLP_IO_PIC_OFFSET;
@@ -181,7 +182,8 @@ static int nlm_timer_proc_read(char *page, char **start, off_t off, int count,
 
 	preempt_disable();
 	len += sprintf(page + len, "cpu = %d, eimr = 0x%016llx, status = 0x%x\n", 
-				   smp_processor_id(), 
+				   /*smp_processor_id(), */
+				   hard_smp_processor_id(), 
                    (unsigned long long)read_64bit_cp0_eimr(), read_c0_status());
 	preempt_enable();
 	*eof = 1;
-- 
1.8.4.93.g57e4c17

