From fdc88a562bc7a4574c68635f759c21b27ccd0596 Mon Sep 17 00:00:00 2001
From: henry shao <hshao@netlogicmicro.com>
Date: Sun, 27 Jun 2010 07:18:57 -0700
Subject: [PATCH 049/565] Use DUMP_RCV_PKT and DUMP_XMIT_PKT

Use DUMP_RCV_PKT and DUMP_XMIT_PKT to turn on/off DUMP_PKT.

Based on Broadcom SDK 2.3.

Signed-off-by: henry shao <hshao@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/xlp_nae/xlp_nae.c | 53 ++++++++++++++++++++++++++-----------------
 1 file changed, 32 insertions(+), 21 deletions(-)

diff --git a/drivers/net/xlp_nae/xlp_nae.c b/drivers/net/xlp_nae/xlp_nae.c
index 25b981a..f80d135 100644
--- a/drivers/net/xlp_nae/xlp_nae.c
+++ b/drivers/net/xlp_nae/xlp_nae.c
@@ -95,21 +95,23 @@ unsigned char icmp_pck[200] = {0x00,0x22,0x19,0x05,0xf0,0xb8,0x00,
 uint8_t broadcast[6] = {0xff,0xff,0xff,0xff,0xff,0xff};	\
 uint8_t myeth[6]     = {0x00,0x01,0x02,0x03,0x04,0x05};	\
 uint8_t hosteth[6]   = {0x00,0x1a,0xa0,0x1e,0x5d,0xc9};	\
-uint8_t myip[4]	     = {0x0a,0x1a,0x70,0xd6};	i	\
+uint8_t myip[4]	     = {0x0a,0x1a,0x70,0xd6};		\
 	if(memcmp(buf, hosteth, 6) == 0)		\
 		if(memcmp(&buf[MYIP_OFFSET],myip,4)==0)	\
 			memcpy(buf,myeth,6); 		 
 
+#define  DUMP_RCV_PKT				0	
+#define  DUMP_XMIT_PKT				0
+#define  DUMP_PKT(x, y)				\
+	int i;      				\
+        for(i = 0; i < y; i++)			\
+        {					\
+                printk("%02x ", x[i]);		\
+                if( i % 16 == 15)		\
+                        printk("\n");		\
+        }					\
+	printk("\n");				
 
-#define  DUMP_PKT()					\ 
-	int i;      					\
-        for(i = 0; i < skb->len; i++)			\
-        {						\
-                printk("%02x ",skb->data[i]);		\
-                if( i % 16 == 15)			\
-                        printk("\n");			\
-        }						\
-	printk("\n");
 
 unsigned char eth_hw_addr[18][6] = {
 					{0x00,0x01,0x02,0x03,0x04,0x05},
@@ -698,9 +700,9 @@ static int nlm_xlp_nae_start_xmit(struct sk_buff *skb, struct net_device *dev)
 	msg.entry[2] = msg.entry[3] = 0;
 
 //	printk("[nlm_xlp_nae_start_xmit] port:%d send %d skb %llx skb->data %llx len %d to qid %d \n", priv->port,(int)priv->stats.tx_packets, (uint64_t)skb, (uint64_t)skb->data,skb->len, priv->nae_tx_qid);
-
-  	//DUMP_PKT() 
-
+#if DUMP_XMIT_PKT
+  	//DUMP_PKT(skb->data, skb->len) 
+#endif
 	__sync(); 
 	msgrng_access_enable(mflags);
 retry_send:
@@ -730,10 +732,12 @@ retry_send:
                 else if(ret & MSG_INFLIGHT_MSG_EX)
                         goto retry_send;
                 else if(ret & MSG_TXQ_FULL)
+		{
                         printk("TX message Q fulll\n");
-                priv->stats.tx_errors++;
-                msgrng_access_disable(mflags);
-                return NETDEV_TX_BUSY;
+                	priv->stats.tx_errors++;
+        	        msgrng_access_disable(mflags);
+	                return NETDEV_TX_BUSY;
+		}
         }
 
 	msgrng_access_disable(mflags);
@@ -1112,9 +1116,15 @@ static void nlm_xlp_nae_msgring_handler(uint32_t vc, uint32_t src_id,
         	}
         	vaddr = (uint64_t)bus_to_virt(addr);
         	buf = (unsigned char *)vaddr;
-		//RUN_ON_SIM()
-//printk("RX: port:%d src_id: %d context: %d recv buf: 0x%llx len:%d addr:0x%010llx  \n",priv->port,src_id,context,(uint64_t)buf, len, vaddr);
-       
+		
+		RUN_ON_SIM()
+
+#if DUMP_RCV_PKT
+		printk("RX: port:%d src_id: %d context: %d recv buf: 0x%llx len:%d addr:0x%010llx  \n",
+					priv->port,src_id,context,(uint64_t)buf, len, vaddr);
+
+		DUMP_PKT(buf , len)
+#endif       
         	if(len - MAC_CRC_LEN  < 0)
         	{
                 	priv->stats.rx_errors++;
@@ -1136,7 +1146,6 @@ static void nlm_xlp_nae_msgring_handler(uint32_t vc, uint32_t src_id,
        		}
         	skb = mac_get_skb_back_ptr(vaddr);
         	if (skb) {
-		//DUMP_PKT()
 #if 1 
 			{
 			struct sk_buff *myskb = __dev_alloc_skb(NLM_RX_BUF_SIZE, GFP_KERNEL);
@@ -1160,7 +1169,9 @@ static void nlm_xlp_nae_msgring_handler(uint32_t vc, uint32_t src_id,
                 	priv->stats.rx_packets++;
                 	priv->cpu_stats[cpu].rx_packets++;
                 	priv->num_desc--;
-			//DUMP_PKT();
+#if DUMP_RCV_PKT
+			DUMP_PKT(skb->data, skb->len)
+#endif
         	}
         	else if(!skb)
         	{
-- 
1.8.4.93.g57e4c17

