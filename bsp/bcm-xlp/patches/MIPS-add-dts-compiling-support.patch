From 9646cd8ae77ffd9ed7c211bdc3bf31f3c54691c4 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Tue, 28 May 2013 15:59:17 +0800
Subject: [PATCH 532/565] MIPS: add dts compiling support

Allows to put the dts file to arch/mips/boot/dts/ and compile it with
the following command:

$ make <dts-file-name>.dtb

It is based on the powerpc implementation.

Based on Broadcom SDK 2.3.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/Kconfig       | 3 +++
 arch/mips/Makefile      | 7 ++++++-
 arch/mips/boot/Makefile | 9 +++++++++
 3 files changed, 18 insertions(+), 1 deletion(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index 2ab0a30..e379c0f 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -2482,6 +2482,9 @@ config STACKTRACE_SUPPORT
 	bool
 	default y
 
+config DTC
+	def_bool y
+
 source "init/Kconfig"
 
 source "kernel/Kconfig.freezer"
diff --git a/arch/mips/Makefile b/arch/mips/Makefile
index 5f224f4..626180d 100644
--- a/arch/mips/Makefile
+++ b/arch/mips/Makefile
@@ -295,6 +295,8 @@ vmlinux.32: vmlinux
 # gcc461 supports the below option, gcc445 does not
 cflags-$(CONFIG_CPU_XLP)    += $(call cc-option,-Wno-error=unused-but-set-variable)
 
+boot := arch/$(ARCH)/boot
+
 #
 # The 64-bit ELF tools are pretty broken so at this time we generate 64-bit
 # ELF files from 32-bit files by conversion.
@@ -314,7 +316,7 @@ vmlinuz vmlinuz.bin vmlinuz.ecoff vmlinuz.srec: $(vmlinux-32) FORCE
 	   VMLINUX_LOAD_ADDRESS=$(load-y) 32bit-bfd=$(32bit-bfd) $@
 
 
-CLEAN_FILES += vmlinux.32 vmlinux.64 vmlinuz 
+CLEAN_FILES += vmlinux.32 vmlinux.64 vmlinuz  *.dtb
 
 archprepare:
 ifdef CONFIG_MIPS32_N32
@@ -339,6 +341,9 @@ archclean:
 	$(Q)$(MAKE) $(clean)=arch/mips/boot/compressed
 	$(Q)$(MAKE) $(clean)=arch/mips/lasat
 
+%.dtb:
+	$(Q)$(MAKE) ARCH=mips $(build)=$(boot) $(patsubst %,$(boot)/%,$@)
+
 define archhelp
 	echo '  install              - install kernel into $(INSTALL_PATH)'
 	echo '  vmlinux.ecoff        - ECOFF boot image'
diff --git a/arch/mips/boot/Makefile b/arch/mips/boot/Makefile
index 851261e..22ae657 100644
--- a/arch/mips/boot/Makefile
+++ b/arch/mips/boot/Makefile
@@ -40,3 +40,12 @@ quiet_cmd_srec = OBJCOPY $@
       cmd_srec = $(OBJCOPY) -S -O srec $(strip-flags) $(VMLINUX) $@
 $(obj)/vmlinux.srec: $(VMLINUX) FORCE
 	$(call if_changed,srec)
+
+# Rule to build device tree blobs
+ifndef CONFIG_CPU_XLP
+DTS_FLAGS ?= -p 1024
+endif
+dtstree		:= $(srctree)/$(src)/dts
+
+$(obj)/%.dtb: $(src)/dts/%.dts FORCE
+	$(call if_changed_dep,dtc)
-- 
1.8.4.93.g57e4c17

