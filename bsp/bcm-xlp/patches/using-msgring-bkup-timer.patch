From 47fd97b6259818aff8260867d10d5f3bd6bb5754 Mon Sep 17 00:00:00 2001
From: Krishnamurthy D V <kmurthy@netlogicmicro.com>
Date: Tue, 21 Jun 2011 18:30:50 +0530
Subject: [PATCH 217/565] using msgring bkup timer

Using msgring bkup timer instead of ipi intr

Based on Broadcom SDK 2.3.

Signed-off-by: Krishnamurthy D V <kmurthy@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/on_chip.c | 31 +++++++++++++++++++++++++++++++
 1 file changed, 31 insertions(+)

diff --git a/arch/mips/netlogic/xlp/on_chip.c b/arch/mips/netlogic/xlp/on_chip.c
index 82fee52..f006731 100644
--- a/arch/mips/netlogic/xlp/on_chip.c
+++ b/arch/mips/netlogic/xlp/on_chip.c
@@ -242,6 +242,30 @@ void nlm_xlp_msgring_int_handler(unsigned int irq, struct pt_regs *regs)
 
 EXPORT_SYMBOL(nlm_xlp_msgring_int_handler);
 
+static DEFINE_PER_CPU(struct timer_list, msg_int_bkup_timer);
+static int msg_handler_timer_enabled=0;
+static void msg_timer_handler(unsigned long data)
+{
+	int cpu = smp_processor_id();
+	struct timer_list *timer = &per_cpu(msg_int_bkup_timer, cpu);
+
+
+	nlm_xlp_msgring_int_handler(IRQ_MSGRING, NULL);
+
+	timer->expires = jiffies + (HZ/100);
+	add_timer(timer);
+}
+void init_msg_bkp_timer(void *data)
+{
+	int cpu = smp_processor_id();
+	struct timer_list *timer = &per_cpu(msg_int_bkup_timer, cpu);
+
+	init_timer(timer);
+	timer->expires = jiffies + 10;
+	timer->data = 0;
+	timer->function = msg_timer_handler;
+	add_timer(timer);
+}
 /*******************************************************************************************
  *  register_xlp_msgring_handler 
  *
@@ -267,6 +291,13 @@ int register_xlp_msgring_handler(int major,
 	/* Check if the message station is valid, if not return error */
 	spin_lock_irqsave(&msgrng_lock, flags);
 
+	if(msg_handler_timer_enabled == 0) {
+		msg_handler_timer_enabled = 1;
+		spin_unlock_irqrestore(&msgrng_lock, flags);
+		on_each_cpu(init_msg_bkp_timer, 0, 1);
+		spin_lock_irqsave(&msgrng_lock, flags);
+	}
+
 
 	msg_handler_map[major].action = action;
 	msg_handler_map[major].dev_id = dev_id;
-- 
1.8.4.93.g57e4c17

