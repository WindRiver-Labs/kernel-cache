From dcaf4e6a471f359904354e3bf4693c41e44d48ae Mon Sep 17 00:00:00 2001
From: Mehul <vmehul@netlogicmicro.com>
Date: Fri, 18 Nov 2011 17:05:29 +0530
Subject: [PATCH 305/565] Do logical AND operation

Do logical AND operation between napi-vc-mask and node-x-vcmask.

Based on Broadcom SDK 2.3.

Signed-off-by: Mehul <vmehul@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/on_chip.c | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/arch/mips/netlogic/xlp/on_chip.c b/arch/mips/netlogic/xlp/on_chip.c
index e5d8128..228af24 100644
--- a/arch/mips/netlogic/xlp/on_chip.c
+++ b/arch/mips/netlogic/xlp/on_chip.c
@@ -234,7 +234,8 @@ void nlm_xlp_msgring_int_handler(unsigned int irq, struct pt_regs *regs)
 	int cpu = hard_smp_processor_id();
 	int pop_vc_mask = nlm_cpu_vc_mask[cpu];
 	msg0 = msg1 = msg2 = msg3 = 0;
-
+	uint32_t napi_vc_mask = xlp_napi_vc_mask & pop_vc_mask;
+	
 	if (irq == XLP_IRQ_MSGRING) {
                 /* normal message ring interrupt */
                 /* xlr_inc_counter(MSGRNG_INT);  */
@@ -254,13 +255,13 @@ void nlm_xlp_msgring_int_handler(unsigned int irq, struct pt_regs *regs)
 		/* Read latest VC empty mask */
 		msg_status1 = xlp_read_status1();
 
-		if(xlp_fmn_init_done && (~(msg_status1>>24) & xlp_napi_vc_mask)){
+		if((~(msg_status1>>24) & napi_vc_mask) && xlp_fmn_init_done) {
 			struct napi_struct *napi;
 
 			/*Schedule napi routine to process messages from napi vc*/
 		        napi = &__get_cpu_var(xlp_napi_fmn_poll_struct);
 		        napi_schedule(napi);
-			pop_vc_mask = pop_vc_mask & ~xlp_napi_vc_mask;
+			pop_vc_mask = pop_vc_mask & ~napi_vc_mask;
 		}
 
 		vc_empty_status = (msg_status1 >> 24) & pop_vc_mask;
@@ -638,11 +639,12 @@ int xlp_fmn_poll(struct napi_struct *napi, int budget)
 	int cpu = hard_smp_processor_id();
 	int count = 0;
 	int no_msg = 0;
+	uint32_t napi_vc_mask = xlp_napi_vc_mask & nlm_cpu_vc_mask[cpu];
 
 	while(count < budget){
 		for( no_msg = 0, vc = 0; vc < 4; vc++)
 		{
-			if(!(xlp_napi_vc_mask & (1<<vc)))
+			if(!(napi_vc_mask & (1<<vc)))
 				continue;
 
 			status = xlp_message_receive( vc, &src_id, &size, &code, &msg0, &msg1, &msg2, &msg3);
@@ -673,7 +675,7 @@ int xlp_fmn_poll(struct napi_struct *napi, int budget)
 		/* Need write vc into the register */
 		val =  _read_32bit_cp2_register(XLP_MSG_STATUS1_REG);
 		//val |= ((1 << vc) << 16);
-		val |= (xlp_napi_vc_mask << 16);
+		val |= (napi_vc_mask << 16);
 		_write_32bit_cp2_register(XLP_MSG_STATUS1_REG, val);
 		return count;
 	}
-- 
1.8.4.93.g57e4c17

