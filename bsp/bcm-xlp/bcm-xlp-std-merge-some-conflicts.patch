From c94364b482f9b9724c3f7d72e89dc6bdc1845685 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Tue, 4 Jun 2013 14:43:24 +0800
Subject: [PATCH 2/7] bcm-xlp-std: merge some conflicts

Merge some conflicts.

Based on Broadcom SDK 2.3.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/atomic.h |    4 ++++
 drivers/misc/Makefile          |    1 +
 drivers/usb/core/hcd.c         |    8 ++++++++
 init/main.c                    |    4 ++++
 4 files changed, 17 insertions(+)

diff --git a/arch/mips/include/asm/atomic.h b/arch/mips/include/asm/atomic.h
index 733a2d8..6cf792b 100644
--- a/arch/mips/include/asm/atomic.h
+++ b/arch/mips/include/asm/atomic.h
@@ -21,6 +21,10 @@
 #include <asm/cmpxchg.h>
 #include <asm/war.h>
 
+#ifdef CONFIG_NLM_ATOMICS
+#include <asm/netlogic/mips-exts.h>
+#endif
+
 #define ATOMIC_INIT(i)    { (i) }
 
 /*
diff --git a/drivers/misc/Makefile b/drivers/misc/Makefile
index d468803..9dfa608 100644
--- a/drivers/misc/Makefile
+++ b/drivers/misc/Makefile
@@ -51,3 +51,4 @@ obj-$(CONFIG_ALTERA_STAPL)	+=altera-stapl/
 obj-$(CONFIG_MAX8997_MUIC)	+= max8997-muic.o
 obj-$(CONFIG_ARM_CCI)		+= arm-cci.o
 obj-$(CONFIG_ARCH_VEXPRESS)	+= vexpress/
+obj-$(CONFIG_XLP_CDE)		+= nlm_cde/
diff --git a/drivers/usb/core/hcd.c b/drivers/usb/core/hcd.c
index 0f0388b..2e605c1 100644
--- a/drivers/usb/core/hcd.c
+++ b/drivers/usb/core/hcd.c
@@ -2176,6 +2176,14 @@ irqreturn_t usb_hcd_irq (int irq, void *__hcd)
 	else
 		rc = IRQ_HANDLED;
 
+#if defined(CONFIG_NLM_XLP)
+    dev = to_pci_dev(hcd->self.controller);
+    fun = dev->devfn & 0x7;
+    node = xlp_soc_pcidev_to_node(dev);
+    /* clear all interrupts */
+    usb_reg_write(node, fun, 0x102, 0xffffffff);
+#endif
+
 	local_irq_restore(flags);
 	return rc;
 }
diff --git a/init/main.c b/init/main.c
index 5fc43ca..0211b36 100644
--- a/init/main.c
+++ b/init/main.c
@@ -895,6 +895,10 @@ static int __init kernel_init(void * unused)
 
 	do_basic_setup();
 
+#ifdef CONFIG_NLM_XLP
+	set_cpus_allowed_ptr(current, &old_mask);
+#endif
+
 	/* Use /dev/console to infer if the rootfs is setup properly */
 	if (sys_newlstat((char __user *) "/dev/console", (struct stat __user *) &console_stat)
 			|| !S_ISCHR(console_stat.st_mode)) {
-- 
1.7.10.4

