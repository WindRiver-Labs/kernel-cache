From 987766f4369e8501840e7038e3babe9b92d4d70b Mon Sep 17 00:00:00 2001
From: reshmic <reshmic@broadcom.com>
Date: Fri, 11 May 2012 19:13:46 +0530
Subject: [PATCH 564/762] fdt param read: sae_sync_vc value was expected to be exclusive in all the four node_vc_mask

Read the active nodes from dtb soc/nodes/num-nodes

Based on Broadcom SDK 2.3.

Signed-off-by: reshmic <reshmic@broadcom.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/setup.c |   13 ++++++++++---
 1 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index 89142b9..cae7e05 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -376,7 +376,9 @@ int ipsec_async_vc = -1, ipsec_sync_vc = -1;
 static void parse_fdt_sae_vc_config(void)
 {
 	void *node;
+	void * valid_node;
 	int i;
+	int num_nodes = 1;
 	extern uint32_t nlm_cpu_vc_mask[NLM_MAX_CPU_NODE*NLM_MAX_CPU_PER_NODE];
 	node = finddevice("/doms/dom@0/cpu");
 	if(node) {
@@ -397,12 +399,17 @@ static void parse_fdt_sae_vc_config(void)
 
 		if (getprop(node, "ipsec-sync-vc", &ipsec_sync_vc, 4) > 0)
 			ipsec_sync_vc = fdt32_to_cpu(ipsec_sync_vc);
-		
-		for(i =0 ; i < NLM_MAX_CPU_NODE*NLM_MAX_CPU_PER_NODE; i++) {
+
+		valid_node  = finddevice("/soc/nodes");
+
+		if (getprop(valid_node, "num-nodes", &num_nodes, 4) > 0 )
+			num_nodes = fdt32_to_cpu(num_nodes);
+
+		for(i =0 ; i < num_nodes*NLM_MAX_CPU_PER_NODE; i++) {
 			if(nlm_cpu_vc_mask[i] & (1 << ipsec_sync_vc)) {
 				ipsec_sync_vc = -1;
 			}
-				 
+
 		}
 	}
 
-- 
1.7.0.4

