From 09a5ae564304cd7f323f0eaf761f062bfb4bb869 Mon Sep 17 00:00:00 2001
From: Om Narasimhan <onarasimhan@netlogicmicro.com>
Date: Tue, 12 Oct 2010 17:29:54 -0700
Subject: [PATCH 220/762] XLP PCI bringup fixes

Based on Broadcom SDK 2.3.

Signed-off-by: Om Narasimhan <onarasimhan@netlogicmicro.com>
Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/pci/pci-xlp.c       |    2 +-
 drivers/usb/host/pci-quirks.c |    2 ++
 include/linux/pci_ids.h       |    2 ++
 3 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/arch/mips/pci/pci-xlp.c b/arch/mips/pci/pci-xlp.c
index 98957fb..aeac050 100644
--- a/arch/mips/pci/pci-xlp.c
+++ b/arch/mips/pci/pci-xlp.c
@@ -165,7 +165,7 @@ struct pci_controller xlp_controller = {
 
 int __init pcibios_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)
 {
-	return 0;
+	return slot + 43;
 }
 
 /* Do platform specific device initialization at pci_enable_device() time */
diff --git a/drivers/usb/host/pci-quirks.c b/drivers/usb/host/pci-quirks.c
index 54a1e31..39e9659 100644
--- a/drivers/usb/host/pci-quirks.c
+++ b/drivers/usb/host/pci-quirks.c
@@ -982,5 +982,7 @@ static void __devinit quirk_usb_early_handoff(struct pci_dev *pdev)
 		quirk_usb_handoff_xhci(pdev);
 	pci_disable_device(pdev);
 }
+#ifndef CONFIG_CPU_XLP		/* Commented out. Hangs in netl code */
 DECLARE_PCI_FIXUP_CLASS_FINAL(PCI_ANY_ID, PCI_ANY_ID,
 			PCI_CLASS_SERIAL_USB, 8, quirk_usb_early_handoff);
+#endif
diff --git a/include/linux/pci_ids.h b/include/linux/pci_ids.h
index d7dbf4e..f72cf78 100644
--- a/include/linux/pci_ids.h
+++ b/include/linux/pci_ids.h
@@ -587,6 +587,8 @@
 #define PCI_DEVICE_ID_TRIDENT_8420	0x8420
 #define PCI_DEVICE_ID_TRIDENT_8500	0x8500
 
+#define PCI_VENDOR_ID_NETLOGIC		0x184E
+
 #define PCI_VENDOR_ID_AI		0x1025
 #define PCI_DEVICE_ID_AI_M1435		0x1435
 
-- 
1.7.0.4

