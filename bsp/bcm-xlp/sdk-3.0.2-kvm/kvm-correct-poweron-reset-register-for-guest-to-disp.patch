From 612fa43c534ae5de5d5330be9e9bd0800895a136 Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Fri, 31 May 2013 20:06:30 -0700
Subject: [PATCH] kvm: correct poweron reset register for guest (to display
 correct cpu frequency)

Commit 10c74c270e0d327ccaf30d23b61a7168ecc614aa from Broadcom SDK 3.0.2

Correct poweron reset register for guest (to display correct cpu frequency)

Signed-off-by: Yonghong Song <ysong@broadcom.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/kvm/xlp.c b/arch/mips/kvm/xlp.c
index ebf43e6..7c962a0 100644
--- a/arch/mips/kvm/xlp.c
+++ b/arch/mips/kvm/xlp.c
@@ -11,6 +11,10 @@
 #include <asm/kvm_host.h>
 #include <asm/netlogic/kvm_xlp.h>
 
+#include <asm/netlogic/haldefs.h>
+#include <asm/netlogic/common.h>
+#include <asm/netlogic/xlp-hal/sys.h>
+
 /* KVM_MAX_NUM_GID is multiple of 64 */
 static uint64_t occupied_gids[KVM_MAX_NUM_GID/sizeof(uint64_t)];
 static uint64_t overlapped_gid1_count;
@@ -317,11 +321,15 @@ static void xlp_kvm_init_pic(struct kvm_arch *arch)
 
 static void xlp_kvm_init_sysmgt(struct kvm_arch *arch)
 {
+	uint64_t sysbase;
+
+	sysbase = nlm_get_node(0)->sysbase;
+
 	arch->sysmgt.regs[0] = 0xffffffff;
 	arch->sysmgt.regs[1] = 0x0;
 	arch->sysmgt.regs[2] = 0x0;
 	arch->sysmgt.regs[3] = 0x0;
-	arch->sysmgt.regs[0x40] = 0x0;
+	arch->sysmgt.regs[0x40] = nlm_read_sys_reg(sysbase, 0x0);
 	arch->sysmgt.regs[0x41] = 0x0;
 	arch->sysmgt.regs[0x42] = 0xffffe;
 	arch->sysmgt.regs[0x43] = 0xffffe;
-- 
1.9.1

