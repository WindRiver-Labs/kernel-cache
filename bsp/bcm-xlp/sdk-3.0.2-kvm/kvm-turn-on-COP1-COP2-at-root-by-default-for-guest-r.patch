From ea8e2e8dca9947a629a4b51c0eb3594d700293f3 Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Mon, 1 Jul 2013 16:17:11 -0700
Subject: [PATCH] kvm: turn on COP1/COP2 at root by default for guest run

Commit 4788582253202ff247478c10550cd184a8ab2d1a from Broadcom SDK 3.0.2

o For virtualization, guest COP1/COP2 access will be determined
  by both guest.status.CU1/CU2 and root.status.CU1/CU2. Both
  must be enabled for guest COP1/COP2 to succeed.
o This change enables root COP1/COP2 access right before passing
  control to guest.

Signed-off-by: Yonghong Song <ysong@broadcom.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/kvm/context_switch.S b/arch/mips/kvm/context_switch.S
index 07ffd53..8f5801d 100644
--- a/arch/mips/kvm/context_switch.S
+++ b/arch/mips/kvm/context_switch.S
@@ -183,13 +183,12 @@ FEXPORT(__kvm_vcpu_run_guest)
 	move	a1, a0
 
 	/*
-	 * set the Root.status.EXL
-	 * permit the CU1 access so that the guess CU1 access will be satisfied.
-	 * permit the Guest access to CU2 (more elegant solution may be needed later)
+	 * set the Root.status.EXL.
+	 * permit the guest CU1 and CU2 access.
 	 */
 	mfc0 t0, $12, 0
 	ori  t0, t0, 0x2
-	lui  t1, 0x2400
+	lui  t1, 0x6400
 	or   t0, t0, t1
 	mtc0 t0, $12, 0
 
-- 
1.9.1

