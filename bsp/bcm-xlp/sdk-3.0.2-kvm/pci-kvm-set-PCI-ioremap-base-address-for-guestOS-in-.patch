From 212f9339665ae2295a67c147eafbce190542d6a2 Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Wed, 11 Sep 2013 16:26:49 -0700
Subject: [PATCH] pci: kvm: set PCI ioremap base address for guestOS in I/O
 region.

Commit c4ddd22438788ce8225c99d231832346e7f35a4f from Broadcom SDK 3.0.2

o For guest virtio drivers, the qemu limit the I/O port address range
  to be 0 - 0xffff. To ensure this address range not covered by
  RAM, shift the ioremap base address for guest to the I/O hole
  in the memory map.

Signed-off-by: Yonghong Song <ysong@broadcom.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/pci/pci-xlp.c b/arch/mips/pci/pci-xlp.c
index 2c63463..fa34565 100644
--- a/arch/mips/pci/pci-xlp.c
+++ b/arch/mips/pci/pci-xlp.c
@@ -57,6 +57,7 @@
 #include <asm/netlogic/xlp-hal/sys.h>
 #include <asm/netlogic/xlp-hal/pcibus.h>
 #include <asm/netlogic/xlp-hal/bridge.h>
+#include <asm/netlogic/kvm_para.h> /* is_nlm_guest_os */
 
 static void *pci_config_base;
 #define PCIE_HOT_RESET_ENABLE 1
@@ -512,8 +513,18 @@ static int __init pcibios_init(void)
 		}
 	}
 
-	set_io_port_base(CKSEG1);
-	nlm_pci_controller.io_map_base = CKSEG1;
+	/* FIXME: for guest OS, let us set the ioport/iomap base address
+	 * at physical address 0x14000000. For qemu virtio emulation,
+	 * the device ioport address is from 0 to 0xffff. If io_map_base
+	 * is CKSEG1, the ioport address will collide with RAM address 0-0xffff.
+	 */
+	if (is_nlm_guest_os) {
+		set_io_port_base(CKSEG1 + 0x14000000);
+		nlm_pci_controller.io_map_base = CKSEG1 + 0x14000000;
+	} else {
+		set_io_port_base(CKSEG1);
+		nlm_pci_controller.io_map_base = CKSEG1;
+	}
 
 	register_pci_controller(&nlm_pci_controller);
 	pr_info("XLP PCIe Controller %pR%pR.\n", &nlm_pci_io_resource,
-- 
1.9.1

