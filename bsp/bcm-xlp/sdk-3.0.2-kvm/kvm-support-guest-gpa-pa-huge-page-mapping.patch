From f3f713fabf780618ca01a351ac3ef40ad55c086b Mon Sep 17 00:00:00 2001
From: Yonghong Song <ysong@broadcom.com>
Date: Thu, 9 May 2013 15:39:47 -0700
Subject: [PATCH] kvm: support guest gpa->pa huge page mapping

Commit dbc77d09c8fa9d858b0d12a573864cf36c786357 from Broadcom SDK 3.0.2

o Currently, we only support non-mips-style hugepage. This provides
  flexibility of different hugepage sizes.

Signed-off-by: Yonghong Song <ysong@broadcom.com>
Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/include/asm/kvm.h b/arch/mips/include/asm/kvm.h
index e65a528..40702c7 100644
--- a/arch/mips/include/asm/kvm.h
+++ b/arch/mips/include/asm/kvm.h
@@ -13,7 +13,8 @@ struct kvm_guest_info {
 #define KVM_MIPS_GUEST_INPUT      _IOW(KVMIO,  0xa0, struct kvm_guest_input)
 #define KVM_MIPS_EXIT_REQUEST	  _IOW(KVMIO,  0xa1, int)
 #define KVM_MIPS_INFO_REQUEST     _IOW(KVMIO,  0xa2, struct kvm_guest_info)
-#define KVM_MIPS_SYNC_GPA_MAP	  _IOW(KVMIO,  0xa3, struct kvm_guest_info)
+#define KVM_MIPS_SYNC_GPA_MAP	  _IOW(KVMIO,  0xa3, int)
+#define KVM_MIPS_HUGEPAGE_SIZE	  _IOW(KVMIO,  0xa4, unsigned long long)
 
 /* Used to capture a guest state */
 struct kvm_regs {
diff --git a/arch/mips/kvm/kvm.c b/arch/mips/kvm/kvm.c
index f366afd..507054a 100644
--- a/arch/mips/kvm/kvm.c
+++ b/arch/mips/kvm/kvm.c
@@ -665,6 +665,19 @@ long kvm_arch_vm_ioctl(struct file *filp, unsigned int ioctl, unsigned long arg)
 	case KVM_MIPS_SYNC_GPA_MAP:
 		kvm_sync_gpa_map(kvm);
 		break;
+	case KVM_MIPS_HUGEPAGE_SIZE:
+	{
+		unsigned long long hugepage_size = 0;
+
+		/* Only support non-mips-default huge page size */
+#ifdef CONFIG_HUGEPAGE_NOT_MIPS_DEFAULT
+		hugepage_size = HPAGE_SIZE;
+#endif
+		if (copy_to_user(argp, &hugepage_size, sizeof(unsigned long long))) {
+			r = -EFAULT;
+		}
+		break;
+	}
 	default:
 		r = -EINVAL;
 		break;
-- 
1.9.1

