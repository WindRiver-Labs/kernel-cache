From 11acfaac7f38c2761eaf0860fcce4c060979449a Mon Sep 17 00:00:00 2001
From: Nam Ninh <nam.ninh@windriver.com>
Date: Thu, 27 Nov 2014 12:52:07 -0500
Subject: [PATCH] bcm_xlp: flush L2 cache on the current CPU

Revert L2 changes from patch [bcm_xlp: update flush_icache_range]

We also need to flush L2 cache on the current cpu so that the guest
does not access invalid virtual address with the following call trace:

ftrace: allocating 20972 entries in 6 pages
ftrace: Allocated trace_printk buffers
PSI (unhandled): epc ffffffffbfc001c0, cause 80006c, badinstr: 718d0019, epc_badinstr: 718d0019
CPU 13 Unable to handle kernel paging request at virtual address 000000001fc10000, epc == ffffffffbfc10000, ra == 0000000000000000
Oops[#1]:
Exception in KVM: due to guest ...
CPU: 13 PID: 961 Comm: qemu-system-mip Tainted: P             3.10.58-ovp-rt58-WR6.0.0.0_preempt-rt+ #11
task: c0000000a2d1b360 ti: c0000000a0630000 task.ti: c0000000a0630000
$ 0   : 0000000000000000 0000000000000000 0000000000000001 0000000000000004
$ 4   : ffffffff80080000 0000000000000000 0000000000000000 0000000000000000
$ 8   : 0000000000000000 0000000000000000 0000000000000000 0000000000000000
$12   : 0000000020000000 ffffffffbfc00c04 0000000000000001 ffffffffbfc00400
$16   : 0000000000000000 0000000000000000 0000000000000000 0000000000000000
$20   : 0000000000000000 0000000000000000 0000000000000000 0000000000000000
$24   : 0000000000000000 0000000000000000
$28   : 0000000000000000 0000000000000000 0000000000000000 0000000000000000
Hi    : 0000000000000000
Lo    : 0000000000000000
epc   : ffffffffbfc10000
    Tainted: P
	ra    : 0000000000000000
	Status: 7400f8e3	KX SX UX KERNEL EXL IE
	Cause : 00800008
	Exception in KVM: due to guest ...
	BadVA : 000000001fc10000
	PrId  : 000c1501 (Broadcom XLPII)
	Badinstr  : 408d6000
	Badinstrp : 14400009
	GuestCtl0 : 9fd00028
	GuestCtl1 : 00010001
	Modules linked in: pktmem(P)
	Process qemu-system-mip (pid: 961, threadinfo=c0000000a0630000, task=c0000000a2d1b360, tls=000000ffd4006750)
	---[ end trace 0000000000000002 ]---

Signed-off-by: Nam Ninh <nam.ninh@windriver.com>

diff --git a/arch/mips/mm/c-netlogic.c b/arch/mips/mm/c-netlogic.c
index bc8a47b..d9362b9 100644
--- a/arch/mips/mm/c-netlogic.c
+++ b/arch/mips/mm/c-netlogic.c
@@ -778,22 +778,12 @@ void nlm_flush_cache_L2L3 (unsigned long start_paddr, unsigned long size)
 {
 	struct nlm_l2_flush_t flush;
 	int n;
-	int cpu;
-	cpumask_t mask;
 
 	/* flush L2 */
 	flush.start = start_paddr;
 	flush.size  = size;
 
-	preempt_disable();
-	cpu = smp_processor_id();
-	mask = *cpu_online_mask;
-	cpumask_clear_cpu(cpu, &mask);
-
-	for_each_cpu(cpu, &mask)
-		local_nlm_flush_l2((void *)&flush);
-
-	preempt_enable();
+	on_each_cpu(local_nlm_flush_l2, (void *)&flush, 1);
 
 	/* flush L3 */
 	for (n = 0; n < NLM_NR_NODES; n++) {
-- 
1.9.1

