From 82f74f6038782ba2df8ad78d4819b1e01814ba6c Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Fri, 12 Jun 2009 21:25:45 +0800
Subject: [PATCH 75/77] MX2: Fix sysfs interface malfunction issue for GPIO lib

Setting OUT direction and value for a GPIO fails when we use
/sys/class/gpio/... (sysfs interface),that is because we didn't
enable GPIO-function mode and select Data Register as output source
for the specific GPIO on MX2. Here set register GPIO_GIUS and OCR
correspondingly to fix it.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/arm/plat-mxc/gpio.c              |   19 +++++++++++++++++++
 arch/arm/plat-mxc/include/mach/mx27.h |    3 +++
 2 files changed, 22 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-mxc/gpio.c b/arch/arm/plat-mxc/gpio.c
index 2fc578f..1f180e9 100644
--- a/arch/arm/plat-mxc/gpio.c
+++ b/arch/arm/plat-mxc/gpio.c
@@ -171,6 +171,25 @@ static void _set_gpio_direction(struct gpio_chip *chip, unsigned offset,
 	else
 		l &= ~(1 << offset);
 	__raw_writel(l, port->base + GPIO_GDIR);
+
+#ifdef CONFIG_ARCH_MX2
+	/* Eable GPIO function by setting register GIUS */
+	l = __raw_readl(port->base + GPIO_GIUS) | (1 << offset);
+	 __raw_writel(l, port->base + GPIO_GIUS);
+
+	/* Select Data Register as output source by setting OCR */
+	if (dir) {
+		if (offset < 16) {
+			l = __raw_readl(port->base + GPIO_OCR1)
+					| (3 << (offset * 2));
+			 __raw_writel(l, port->base + GPIO_OCR1);
+		} else {
+			l = __raw_readl(port->base + GPIO_OCR2)
+					| (3 << ((offset - 16) * 2));
+			 __raw_writel(l, port->base + GPIO_OCR2);
+			}
+	}
+#endif
 }
 
 static void mxc_gpio_set(struct gpio_chip *chip, unsigned offset, int value)
diff --git a/arch/arm/plat-mxc/include/mach/mx27.h b/arch/arm/plat-mxc/include/mach/mx27.h
index e86d483..4c97b19 100644
--- a/arch/arm/plat-mxc/include/mach/mx27.h
+++ b/arch/arm/plat-mxc/include/mach/mx27.h
@@ -294,6 +294,9 @@ extern int mx27_revision(void);
 /* gpio and gpio based interrupt handling */
 #define GPIO_DR		 	0x1C
 #define GPIO_GDIR	 	0x00
+#define GPIO_OCR1		0x04
+#define GPIO_OCR2		0x08
+#define GPIO_GIUS		0x20
 #define GPIO_PSR	 	0x24
 #define GPIO_ICR1	 	0x28
 #define GPIO_ICR2	 	0x2C
-- 
1.6.3.1

