From c8414dbc845cdfd86510717706210ed5d8c2a8ee Mon Sep 17 00:00:00 2001
From: Alexander Smirnov <asmirnov@embeddedalley.com>
Date: Wed, 3 Dec 2008 18:05:29 +0300
Subject: [PATCH] fsl_imx27ads NOR support

Add NOR flash support for FreeScale i.MX27ads board.

Signed-off-by: Alexander Smirnov <asmirnov@embeddedalley.com>
Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 arch/arm/mach-mx2/mx27ads.c |   55 +++++++++++++++++++++++++++++++++++++-----
 1 files changed, 48 insertions(+), 7 deletions(-)

diff --git a/arch/arm/mach-mx2/mx27ads.c b/arch/arm/mach-mx2/mx27ads.c
index 4ce56ef..e38d4fe 100644
--- a/arch/arm/mach-mx2/mx27ads.c
+++ b/arch/arm/mach-mx2/mx27ads.c
@@ -26,6 +26,7 @@
 #include <mach/common.h>
 #include <mach/hardware.h>
 #include <asm/mach-types.h>
+#include <asm/mach/flash.h>
 #include <asm/mach/arch.h>
 #include <asm/mach/time.h>
 #include <asm/mach/map.h>
@@ -35,25 +36,65 @@
 #include <mach/board-mx27ads.h>
 
 /* ADS's NOR flash */
-static struct physmap_flash_data mx27ads_flash_data = {
-	.width = 2,
+static struct mtd_partition mxc_nor_partitions[] = {
+	{
+	 .name = "Bootloader",
+	 .size = 512 * 1024,
+	 .offset = 0x00000000,
+	 .mask_flags = MTD_WRITEABLE	/* force read-only */
+	},
+	{
+	 .name = "nor.Kernel",
+	 .size = 2 * 1024 * 1024,
+	 .offset = MTDPART_OFS_APPEND,
+	 .mask_flags = 0},
+	{
+	 .name = "nor.userfs",
+	 .size = 14 * 1024 * 1024,
+	 .offset = MTDPART_OFS_APPEND,
+	 .mask_flags = 0},
+	{
+	 .name = "nor.rootfs",
+	 .size = 12 * 1024 * 1024,
+	 .offset = MTDPART_OFS_APPEND,
+	 .mask_flags = MTD_WRITEABLE},
+	{
+	 .name = "FIS directory",
+	 .size = 12 * 1024,
+	 .offset = 0x01FE0000,
+	 .mask_flags = MTD_WRITEABLE	/* force read-only */
+	},
+	{
+	 .name = "Redboot config",
+	 .size = MTDPART_SIZ_FULL,
+	 .offset = 0x01FFF000,
+	 .mask_flags = MTD_WRITEABLE	/* force read-only */
+	},
+};
+
+static struct flash_platform_data mxc_flash_data[1] = {
+	{
+	 .map_name = "cfi_probe",
+	 .parts = mxc_nor_partitions,
+	 .nr_parts = ARRAY_SIZE(mxc_nor_partitions),
+	 .width = 2,
+	}
 };
 
-static struct resource mx27ads_flash_resource = {
+static struct resource mxc_flash_resource = {
 	.start = 0xc0000000,
 	.end = 0xc0000000 + 0x02000000 - 1,
 	.flags = IORESOURCE_MEM,
-
 };
 
 static struct platform_device mx27ads_nor_mtd_device = {
-	.name = "physmap-flash",
+	.name = "mxc_nor_flash",
 	.id = 0,
 	.dev = {
-		.platform_data = &mx27ads_flash_data,
+	 .platform_data = &mxc_flash_data,
 	},
 	.num_resources = 1,
-	.resource = &mx27ads_flash_resource,
+	.resource = &mxc_flash_resource,
 };
 
 static int mxc_uart0_pins[] = {
-- 
1.6.0.2.GIT

