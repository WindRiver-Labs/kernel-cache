From ef9ac7e1e43c94442f413723a01f81f010a20834 Mon Sep 17 00:00:00 2001
From: Chunbo Luo <chunbo.luo@windriver.com>
Date: Fri, 18 Apr 2008 16:13:29 +0800
Subject: [PATCH] patches-imx27ads/imx27ads_arch

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 arch/arm/Makefile          |    1 +
 arch/arm/mm/Kconfig        |    4 ++--
 arch/arm/mm/consistent.c   |    9 +++++++++
 arch/arm/plat-mxc/Kconfig  |    8 ++++++++
 arch/arm/plat-mxc/Makefile |    1 +
 arch/arm/plat-mxc/gpio.c   |   12 ++++++++++++
 6 files changed, 33 insertions(+), 2 deletions(-)

diff --git a/arch/arm/Makefile b/arch/arm/Makefile
index 9481807..2e41044 100644
--- a/arch/arm/Makefile
+++ b/arch/arm/Makefile
@@ -139,6 +139,7 @@ endif
  machine-$(CONFIG_ARCH_KS8695)     := ks8695
   incdir-$(CONFIG_ARCH_MXC)	   := mxc
  machine-$(CONFIG_ARCH_MX3)	   := mx3
+ machine-$(CONFIG_ARCH_MX27)	   := mx27
  machine-$(CONFIG_ARCH_ORION5X)	   := orion5x
  machine-$(CONFIG_ARCH_MSM7X00A)   := msm
 
diff --git a/arch/arm/mm/Kconfig b/arch/arm/mm/Kconfig
index 84c1387..7da8bd7 100644
--- a/arch/arm/mm/Kconfig
+++ b/arch/arm/mm/Kconfig
@@ -180,8 +180,8 @@ config CPU_ARM925T
 # ARM926T
 config CPU_ARM926T
 	bool "Support ARM926T processor"
-	depends on ARCH_INTEGRATOR || ARCH_VERSATILE_PB || MACH_VERSATILE_AB || ARCH_OMAP730 || ARCH_OMAP16XX || MACH_REALVIEW_EB || ARCH_PNX4008 || ARCH_NETX || CPU_S3C2412 || ARCH_AT91SAM9260 || ARCH_AT91SAM9261 || ARCH_AT91SAM9263 || ARCH_AT91SAM9RL || ARCH_AT91CAP9 || ARCH_NS9XXX || ARCH_DAVINCI
-	default y if ARCH_VERSATILE_PB || MACH_VERSATILE_AB || ARCH_OMAP730 || ARCH_OMAP16XX || ARCH_PNX4008 || ARCH_NETX || CPU_S3C2412 || ARCH_AT91SAM9260 || ARCH_AT91SAM9261 || ARCH_AT91SAM9263 || ARCH_AT91SAM9RL || ARCH_AT91CAP9 || ARCH_NS9XXX || ARCH_DAVINCI
+	depends on ARCH_INTEGRATOR || ARCH_VERSATILE_PB || MACH_VERSATILE_AB || ARCH_OMAP730 || ARCH_OMAP16XX || MACH_REALVIEW_EB || ARCH_PNX4008 || ARCH_NETX || CPU_S3C2412 || ARCH_AT91SAM9260 || ARCH_AT91SAM9261 || ARCH_AT91SAM9263 || ARCH_AT91SAM9RL || ARCH_AT91CAP9 || ARCH_NS9XXX || ARCH_DAVINCI || ARCH_MX27
+	default y if ARCH_VERSATILE_PB || MACH_VERSATILE_AB || ARCH_OMAP730 || ARCH_OMAP16XX || ARCH_PNX4008 || ARCH_NETX || CPU_S3C2412 || ARCH_AT91SAM9260 || ARCH_AT91SAM9261 || ARCH_AT91SAM9263 || ARCH_AT91SAM9RL || ARCH_AT91CAP9 || ARCH_NS9XXX || ARCH_DAVINCI || ARCH_MX27
 	select CPU_32v5
 	select CPU_ABRT_EV5TJ
 	select CPU_PABRT_NOIFAR
diff --git a/arch/arm/mm/consistent.c b/arch/arm/mm/consistent.c
index 333a82a..21b18f2 100644
--- a/arch/arm/mm/consistent.c
+++ b/arch/arm/mm/consistent.c
@@ -504,3 +504,12 @@ void dma_cache_maint(const void *start, size_t size, int direction)
 	}
 }
 EXPORT_SYMBOL(dma_cache_maint);
+
+#ifdef CONFIG_MACH_MX27ADS
+void inv_ioremap_region(void __iomem *virt_start, void __iomem *virt_end)
+{
+	dmac_inv_range(virt_start,virt_end);
+}
+
+EXPORT_SYMBOL(inv_ioremap_region);
+#endif /* CONFIG_MACH_MX27ADS */
diff --git a/arch/arm/plat-mxc/Kconfig b/arch/arm/plat-mxc/Kconfig
index bb6e127..e4358f3 100644
--- a/arch/arm/plat-mxc/Kconfig
+++ b/arch/arm/plat-mxc/Kconfig
@@ -11,8 +11,16 @@ config ARCH_MX3
 	help
 	  This enables support for systems based on the Freescale i.MX3 family
 
+config ARCH_MX27
+	bool "MX27-based"
+	select MXC_EMMA
+	help
+	  This enables support for systems based on Freescale i.MX27
+
 endchoice
 
+source "arch/arm/mach-mx27/Kconfig"
+
 source "arch/arm/mach-mx3/Kconfig"
 
 endmenu
diff --git a/arch/arm/plat-mxc/Makefile b/arch/arm/plat-mxc/Makefile
index 49b9b2f..8e26cc7 100644
--- a/arch/arm/plat-mxc/Makefile
+++ b/arch/arm/plat-mxc/Makefile
@@ -5,3 +5,4 @@
 # Common support
 obj-y := irq.o gpio.o
 obj-$(CONFIG_MXC_SDMA_API)  += sdma/
+obj-$(CONFIG_ARCH_MX27) += dma_mx2.o
diff --git a/arch/arm/plat-mxc/gpio.c b/arch/arm/plat-mxc/gpio.c
index ab52612..072d6f3 100644
--- a/arch/arm/plat-mxc/gpio.c
+++ b/arch/arm/plat-mxc/gpio.c
@@ -36,6 +36,17 @@
  */
 
 /* GPIO related defines */
+#if defined(CONFIG_ARCH_MX27) || defined(CONFIG_ARCH_MX21)
+enum gpio_reg {
+	GPIO_DR = 0x1C,
+	GPIO_GDIR = 0x00,
+	GPIO_PSR = 0x24,
+	GPIO_ICR1 = 0x028,
+	GPIO_ICR2 = 0x2C,
+	GPIO_IMR = 0x30,
+	GPIO_ISR = 0x34,
+};
+#else
 enum gpio_reg {
 	GPIO_DR = 0x00,
 	GPIO_GDIR = 0x04,
@@ -45,6 +56,7 @@ enum gpio_reg {
 	GPIO_IMR = 0x14,
 	GPIO_ISR = 0x18,
 };
+#endif
 
 extern struct mxc_gpio_port mxc_gpio_ports[];
 
