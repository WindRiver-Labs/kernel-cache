From b51c65d96596652c2ce05181acf5633fdaff47e2 Mon Sep 17 00:00:00 2001
From: Alexander Smirnov <asmirnov@embeddedalley.com>
Date: Mon, 29 Dec 2008 19:06:16 +0300
Subject: [PATCH 30/77] Add i.MX27ads support for Frame Buffer

Add i.MX27ads support for Frame Buffer

Signed-off-by: Alexander Smirnov <asmirnov@embeddedalley.com>
---
 arch/arm/mach-mx2/mx27ads.c |   78 +++++++++++++++++++++++++++++++++++++++++++
 1 files changed, 78 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-mx2/mx27ads.c b/arch/arm/mach-mx2/mx27ads.c
index b2e2699..cf376d7 100644
--- a/arch/arm/mach-mx2/mx27ads.c
+++ b/arch/arm/mach-mx2/mx27ads.c
@@ -42,6 +42,8 @@
 #include <mach/imx_i2c.h>
 #include <mach/imx_spi.h>
 #include <asm/plat-mxc/pmic_platform.h>
+#include <asm/plat-mxc/pmic_power.h>
+#include <mach/imxfb.h>
 
 #include "devices.h"
 
@@ -603,6 +605,81 @@ static struct spi_board_info mx27ads_spi_board_info[] __initdata = {
 };
 #endif /* CONFIG_SPI */
 
+static int mxc_fb_pins[] = {
+	PA5_PF_LSCLK,	PA6_PF_LD0,	PA7_PF_LD1,	PA8_PF_LD2,
+	PA9_PF_LD3,	PA10_PF_LD4,	PA11_PF_LD5,	PA12_PF_LD6,
+	PA13_PF_LD7,	PA14_PF_LD8,	PA15_PF_LD9,	PA16_PF_LD10,
+	PA17_PF_LD11,	PA18_PF_LD12,	PA19_PF_LD13,	PA20_PF_LD14,
+	PA21_PF_LD15,	PA22_PF_LD16,	PA23_PF_LD17,	PA24_PF_REV,
+	PA25_PF_CLS,	PA26_PF_PS,	PA27_PF_SPL_SPR, PA28_PF_HSYNC,
+	PA29_PF_VSYNC,	PA30_PF_CONTRAST, PA31_PF_OE_ACD,
+};
+
+static int gpio_fb_active(struct platform_device *pdev)
+{
+	mxc_gpio_setup_multiple_pins(mxc_fb_pins,
+				     ARRAY_SIZE(mxc_fb_pins),
+				     MXC_GPIO_ALLOC_MODE_NORMAL, "FB");
+
+	return 0;
+}
+
+static int gpio_fb_inactive(struct platform_device *pdev)
+{
+	mxc_gpio_setup_multiple_pins(mxc_fb_pins,
+				     ARRAY_SIZE(mxc_fb_pins),
+				     MXC_GPIO_ALLOC_MODE_RELEASE, "FB");
+
+	return 0;
+}
+
+void lcd_power(int on)
+{
+	if (on)
+		__raw_writew(PBC_BCTRL1_LCDON, PBC_BCTRL1_SET_REG);
+	else
+		__raw_writew(PBC_BCTRL1_LCDON, PBC_BCTRL1_CLEAR_REG);
+}
+
+void backlight_power(int on)
+{
+}
+
+static struct imx_fb_platform_data mx27ads_fb_data = {
+	.pixclock	= 5300,
+	.xres		= 240,
+	.yres		= 320,
+
+	.bpp		= 16,
+	.hsync_len	= 1,
+	.left_margin	= 9,
+	.right_margin	= 16,
+
+	.vsync_len	= 1,
+	.upper_margin	= 7,
+	.lower_margin	= 9,
+	.fixed_screen_cpu = 0,
+
+	/*
+	 * - HSYNC active high
+	 * - VSYNC active high
+	 * - clk notenabled while idle
+	 * - clock inverted
+	 * - data not inverted
+	 * - data enable low active
+	 * - enable sharp mode
+	*/
+	.pcr		= 0xFB008BC0,
+	.pwmr		= 0x00A903FF,
+	.lscr1		= 0x00120300,
+	.dmacr		= 0x00020010,
+
+	.backlight_power = backlight_power,
+	.lcd_power = lcd_power,
+	.init = gpio_fb_active,
+	.exit = gpio_fb_inactive,
+};
+
 static void __init mx27ads_board_init(void)
 {
 	gpio_fec_active();
@@ -641,6 +718,7 @@ static void __init mx27ads_board_init(void)
 #endif
 	mxc_register_device(&mxc_wdt, NULL);
 	mxc_register_device(&mxc_rtc, NULL);
+	mxc_register_device(&mxc_fb_device, &mx27ads_fb_data);
 
 	platform_add_devices(platform_devices, ARRAY_SIZE(platform_devices));
 }
-- 
1.6.3.1

