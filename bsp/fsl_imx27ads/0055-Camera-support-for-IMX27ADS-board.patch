From e3af20b3e9f52b7475514298d969bc1cce2606a2 Mon Sep 17 00:00:00 2001
From: builder <builder@black.easi.ru>
Date: Fri, 6 Feb 2009 18:11:44 +0300
Subject: [PATCH 55/77] Camera support for IMX27ADS board

IMX27ADS: add camera support for IMX27ADS board

Signed-off-by: Vladimir Barinov <vbarinov@embeddedlley.com>
---
 arch/arm/mach-mx2/mx27ads.c |   91 ++++++++++++++++++++++++++++++++++++++++++-
 1 files changed, 89 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-mx2/mx27ads.c b/arch/arm/mach-mx2/mx27ads.c
index 63e642d..bba4e3a 100644
--- a/arch/arm/mach-mx2/mx27ads.c
+++ b/arch/arm/mach-mx2/mx27ads.c
@@ -32,6 +32,7 @@
 #include <linux/delay.h>
 #include <linux/input.h>
 #include <linux/clk.h>
+#include <media/soc_camera.h>
 
 #include <asm/mach-types.h>
 #include <asm/mach/arch.h>
@@ -59,6 +60,7 @@
 #include <mach/keypad.h>
 #include <mach/mxc_gadget.h>
 #include <mach/isp1301.h>
+#include <mach/imx_cam.h>
 
 #include "devices.h"
 
@@ -648,7 +650,16 @@ static struct imx_i2c_platform_data mx27ads_i2c_1_data = {
 	.exit = mx27ads_i2c_1_exit,
 };
 
+static struct soc_camera_link iclink = {
+	.bus_id = 0,
+};
+
 static struct i2c_board_info mx27ads_i2c_devices[] = {
+	{
+		I2C_BOARD_INFO("ov2640", 0x30),
+		.platform_data = &iclink,
+		.type = "ov2640",
+	},
 };
 #endif
 
@@ -1172,6 +1183,76 @@ struct mxc_gadget_platform_data gadget_pdata = {
 };
 #endif
 
+#ifdef CONFIG_VIDEO_MX27
+static int mxc_csi_pins[] = {
+	PB10_PF_CSI_D0,
+	PB11_PF_CSI_D1,
+	PB12_PF_CSI_D2,
+	PB13_PF_CSI_D3,
+	PB14_PF_CSI_D4,
+	PB15_PF_CSI_MCLK,
+	PB16_PF_CSI_PIXCLK,
+	PB17_PF_CSI_D5,
+	PB18_PF_CSI_D6,
+	PB19_PF_CSI_D7,
+	PB20_PF_CSI_VSYNC,
+	PB21_PF_CSI_HSYNC
+};
+
+static int mx27ads_camera_init(struct platform_device *pdev)
+{
+#ifdef CONFIG_MXC_PMIC
+	t_regulator_voltage voltage;
+
+	/* AVDD 2.8V */
+	voltage.vmmc1 = VMMC1_2_8V;
+	pmic_power_regulator_set_voltage(REGU_VMMC1, voltage);
+
+	pmic_power_regulator_on(REGU_VMMC1);
+
+	/* DVDD 1.3V */
+	voltage.vvib = VVIB_1_3V;
+	pmic_power_regulator_set_voltage(REGU_VVIB, voltage);
+
+	pmic_power_regulator_on(REGU_VVIB);
+
+	/* DOVDD 2V (1.8-3.0) */
+	voltage.sw2b = SW2B_2V;
+	pmic_power_regulator_set_voltage(SW_SW2B, voltage);
+
+	pmic_power_set_regen_assig(REGU_GPO3, 1);
+	pmic_power_regulator_on(REGU_GPO3);
+#endif
+
+	__raw_writew(0x400, PBC_BCTRL2_SET_REG);
+
+	return mxc_gpio_setup_multiple_pins(mxc_csi_pins,
+					    ARRAY_SIZE(mxc_csi_pins),
+					    MXC_GPIO_ALLOC_MODE_NORMAL, "CSI");
+}
+
+static int mx27ads_camera_exit(struct platform_device *pdev)
+{
+	__raw_writew(0x400, PBC_BCTRL2_CLEAR_REG);
+
+#ifdef CONFIG_MXC_PMIC
+	pmic_power_regulator_off(REGU_GPO3);
+#endif
+
+	return mxc_gpio_setup_multiple_pins(mxc_csi_pins,
+					    ARRAY_SIZE(mxc_csi_pins),
+					    MXC_GPIO_ALLOC_MODE_RELEASE, "CSI");
+}
+
+struct mx27_camera_platform_data mx27ads_camera = {
+	.init = mx27ads_camera_init,
+	.exit = mx27ads_camera_exit,
+	.clk  = 26600000,
+	.flags = MX27_CAMERA_HSYNC_HIGH | MX27_CAMERA_GATED_CLOCK |
+		 MX27_CAMERA_PACK_DIR_MSB,
+};
+#endif
+
 static struct platform_device *platform_devices[] __initdata = {
 	&mx27ads_nor_mtd_device,
 #ifdef CONFIG_SND
@@ -1193,15 +1274,18 @@ static void __init mx27ads_board_init(void)
 	mxc_register_device(&mxc_uart_device1, &uart_pdata[1]);
 	mxc_register_device(&mxc_uart_device2, &uart_pdata[2]);
 	mxc_register_device(&mxc_uart_device3, &uart_pdata[3]);
+#ifndef CONFIG_VIDEO_MX27
+	/* CSI pins conflict with UART4 and UAT5 pins */
 	mxc_register_device(&mxc_uart_device4, &uart_pdata[4]);
 	mxc_register_device(&mxc_uart_device5, &uart_pdata[5]);
+#endif
 #ifdef CONFIG_MTD_NAND
 	mxc_register_device(&mxc_nand_device, &mx27ads_nand_board_info);
 #endif
 
 #ifdef CONFIG_I2C
-	/* only the i2c master 1 is used on this CPU card */
-	i2c_register_board_info(1, mx27ads_i2c_devices,
+	/* only the i2c master 0 is used on this CPU card */
+	i2c_register_board_info(0, mx27ads_i2c_devices,
 				ARRAY_SIZE(mx27ads_i2c_devices));
 
 	mxc_register_device(&imx_i2c_device0, &mx27ads_i2c_0_data);
@@ -1224,6 +1308,9 @@ static void __init mx27ads_board_init(void)
 	mxc_register_device(&mxc_wdt, NULL);
 	mxc_register_device(&mxc_rtc, NULL);
 	mxc_register_device(&mxc_fb_device, &mx27ads_fb_data);
+#ifdef CONFIG_VIDEO_MX27
+	mxc_register_device(&mx27_camera_device, &mx27ads_camera);
+#endif
 
 #ifdef CONFIG_SND
 	mxc_register_device(&mxc_dam_device, NULL);
-- 
1.6.3.1

