From db82976bbcacdf0cfcb2dc569e35ca89e92b9456 Mon Sep 17 00:00:00 2001
From: Alexander Smirnov <asmirnov@embeddedalley.com>
Date: Mon, 29 Dec 2008 18:26:51 +0300
Subject: [PATCH 13/77] Add i.MX2 support for SPI V2

Add i.MX2 support for SPI

Signed-off-by: Alexander Smirnov <asmirnov@embeddedalley.com>
---
 arch/arm/mach-mx2/mx27ads.c                    |  121 ++++++++++++++++++++++++
 arch/arm/plat-mxc/include/mach/iomux-mx1-mx2.h |    6 +
 2 files changed, 127 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-mx2/mx27ads.c b/arch/arm/mach-mx2/mx27ads.c
index 70d17aa..a22acfe 100644
--- a/arch/arm/mach-mx2/mx27ads.c
+++ b/arch/arm/mach-mx2/mx27ads.c
@@ -26,6 +26,7 @@
 #include <mach/common.h>
 #include <mach/hardware.h>
 #include <linux/interrupt.h>
+#include <linux/spi/spi.h>
 #include <asm/mach-types.h>
 #include <asm/mach/arch.h>
 #include <asm/mach/flash.h>
@@ -37,6 +38,7 @@
 #include <mach/iomux-mx1-mx2.h>
 #include <mach/board-mx27ads.h>
 #include <mach/mxc_nand.h>
+#include <mach/imx_spi.h>
 
 #include "devices.h"
 
@@ -418,6 +420,113 @@ static struct imxuart_platform_data uart_pdata[] = {
 	},
 };
 
+#ifdef CONFIG_SPI
+
+#ifdef CONFIG_SPI_MXC_SELECT1
+static int mxc_cspi0_pins[] = {
+	PD25_PF_CSPI1_RDY,
+	PD26_PF_CSPI1_SS2,
+	PD27_PF_CSPI1_SS1,
+	PD28_PF_CSPI1_SS0,
+	PD29_PF_CSPI1_SCLK,
+	PD30_PF_CSPI1_MISO,
+	PD31_PF_CSPI1_MOSI,
+};
+
+static int gpio_spi_active_0(struct platform_device *pdev)
+{
+	mxc_gpio_setup_multiple_pins(mxc_cspi0_pins,
+				     ARRAY_SIZE(mxc_cspi0_pins),
+				     MXC_GPIO_ALLOC_MODE_NORMAL, "CSPI0");
+	return 0;
+}
+
+static int gpio_spi_inactive_0(struct platform_device *pdev)
+{
+	mxc_gpio_setup_multiple_pins(mxc_cspi0_pins,
+				     ARRAY_SIZE(mxc_cspi0_pins),
+				     MXC_GPIO_ALLOC_MODE_RELEASE, "CSPI0");
+
+	return 0;
+}
+
+static struct mxc_spi_master mx27ads_spi_0_data = {
+	.maxchipselect = 4,
+	.init = gpio_spi_active_0,
+	.exit = gpio_spi_inactive_0,
+};
+#endif /* CONFIG_SPI_MXC_SELECT1 */
+
+#ifdef CONFIG_SPI_MXC_SELECT2
+static int mxc_cspi1_pins[] = {
+	PD19_PF_CSPI2_SS2,
+	PD20_PF_CSPI2_SS1,
+	PD21_PF_CSPI2_SS0,
+	PD22_PF_CSPI2_SCLK,
+	PD23_PF_CSPI2_MISO,
+	PD24_PF_CSPI2_MOSI,
+};
+
+static int gpio_spi_active_1(struct platform_device *pdev)
+{
+	mxc_gpio_setup_multiple_pins(mxc_cspi1_pins,
+				     ARRAY_SIZE(mxc_cspi1_pins),
+				     MXC_GPIO_ALLOC_MODE_NORMAL, "CSPI1");
+
+	return 0;
+}
+
+static int gpio_spi_inactive_1(struct platform_device *pdev)
+{
+	mxc_gpio_setup_multiple_pins(mxc_cspi1_pins,
+				     ARRAY_SIZE(mxc_cspi1_pins),
+				     MXC_GPIO_ALLOC_MODE_RELEASE, "CSPI1");
+
+	return 0;
+}
+
+static struct mxc_spi_master mx27ads_spi_1_data = {
+	.maxchipselect = 4,
+	.init = gpio_spi_active_1,
+	.exit = gpio_spi_inactive_1,
+};
+#endif  /* CONFIG_SPI_MXC_SELECT2 */
+
+#ifdef CONFIG_SPI_MXC_SELECT3
+static int mxc_cspi2_pins[] = {
+	PE18_AF_CSPI3_MISO,
+	PE21_AF_CSPI3_SS,
+	PE22_AF_CSPI3_MOSI,
+	PE23_AF_CSPI3_SCLK,
+};
+
+static int gpio_spi_active_2(struct platform_device *pdev)
+{
+	mxc_gpio_setup_multiple_pins(mxc_cspi2_pins,
+				     ARRAY_SIZE(mxc_cspi2_pins),
+				     MXC_GPIO_ALLOC_MODE_NORMAL, "CSPI2");
+
+	return 0;
+}
+
+static int gpio_spi_inactive_2(struct platform_device *pdev)
+{
+	mxc_gpio_setup_multiple_pins(mxc_cspi2_pins,
+				     ARRAY_SIZE(mxc_cspi2_pins),
+				     MXC_GPIO_ALLOC_MODE_RELEASE, "CSPI2");
+
+	return 0;
+}
+
+static struct mxc_spi_master mx27ads_spi_2_data = {
+	.maxchipselect = 4,
+	.init = gpio_spi_active_2,
+	.exit = gpio_spi_inactive_2,
+};
+#endif  /* CONFIG_SPI_MXC_SELECT3 */
+
+#endif /* CONFIG_SPI */
+
 static void __init mx27ads_board_init(void)
 {
 	gpio_fec_active();
@@ -432,6 +541,18 @@ static void __init mx27ads_board_init(void)
 	mxc_register_device(&mxc_nand_device, &mx27ads_nand_board_info);
 #endif
 
+#ifdef CONFIG_SPI
+#ifdef CONFIG_SPI_MXC_SELECT1
+	mxc_register_device(&mxc_spi_device0, &mx27ads_spi_0_data);
+#endif
+#ifdef CONFIG_SPI_MXC_SELECT2
+	mxc_register_device(&mxc_spi_device1, &mx27ads_spi_1_data);
+#endif
+#ifdef CONFIG_SPI_MXC_SELECT3
+	mxc_register_device(&mxc_spi_device2, &mx27ads_spi_2_data);
+#endif
+#endif
+
 	platform_add_devices(platform_devices, ARRAY_SIZE(platform_devices));
 }
 
diff --git a/arch/arm/plat-mxc/include/mach/iomux-mx1-mx2.h b/arch/arm/plat-mxc/include/mach/iomux-mx1-mx2.h
index 0b9af93..2db57f0 100644
--- a/arch/arm/plat-mxc/include/mach/iomux-mx1-mx2.h
+++ b/arch/arm/plat-mxc/include/mach/iomux-mx1-mx2.h
@@ -363,6 +363,12 @@ extern int mxc_gpio_setup_multiple_pins(const int *pin_list, unsigned count,
 #define PD17_PF_I2C_DATA	(GPIO_PORTD | GPIO_OUT | GPIO_PF | 17)
 #define PD23_AF_USBH2_DATA2	(GPIO_PORTD | GPIO_AF | 23)
 #define PD18_PF_I2C_CLK		(GPIO_PORTD | GPIO_OUT | GPIO_PF | 18)
+#define PD19_PF_CSPI2_SS2       (GPIO_PORTD | GPIO_OUT | GPIO_PF  | 19)
+#define PD20_PF_CSPI2_SS1       (GPIO_PORTD | GPIO_OUT | GPIO_PF  | 20)
+#define PD21_PF_CSPI2_SS0       (GPIO_PORTD | GPIO_OUT | GPIO_PF  | 21)
+#define PD22_PF_CSPI2_SCLK      (GPIO_PORTD | GPIO_OUT | GPIO_PF  | 22)
+#define PD23_PF_CSPI2_MISO      (GPIO_PORTD | GPIO_OUT | GPIO_PF  | 23)
+#define PD24_PF_CSPI2_MOSI      (GPIO_PORTD | GPIO_OUT | GPIO_PF  | 24)
 #define PD24_AF_USBH2_DATA1	(GPIO_PORTD | GPIO_AF | 24)
 #define PD25_PF_CSPI1_RDY	(GPIO_PORTD | GPIO_OUT | GPIO_PF  | 25)
 #define PD26_PF_CSPI1_SS2	(GPIO_PORTD | GPIO_OUT | GPIO_PF  | 26)
-- 
1.6.3.1

