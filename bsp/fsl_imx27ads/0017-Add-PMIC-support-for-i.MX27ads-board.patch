From cebdc0a697c7fcbe2b7dbcd06f474cdc167e902e Mon Sep 17 00:00:00 2001
From: Alexander Smirnov <asmirnov@embeddedalley.com>
Date: Mon, 29 Dec 2008 18:34:13 +0300
Subject: [PATCH] Add PMIC support for i.MX27ads board

Add PMIC support for i.MX27ads board

Signed-off-by: Alexander Smirnov <asmirnov@embeddedalley.com>
---
 arch/arm/mach-mx2/mx27ads.c                    |   25 ++++++++++++++++++++++++
 arch/arm/plat-mxc/include/mach/iomux-mx1-mx2.h |    1 +
 drivers/mxc/pmic/Kconfig                       |    2 +-
 3 files changed, 27 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-mx2/mx27ads.c b/arch/arm/mach-mx2/mx27ads.c
index ca22a2f..8ceb87d 100644
--- a/arch/arm/mach-mx2/mx27ads.c
+++ b/arch/arm/mach-mx2/mx27ads.c
@@ -39,6 +39,7 @@
 #include <mach/board-mx27ads.h>
 #include <mach/mxc_nand.h>
 #include <mach/imx_spi.h>
+#include <asm/plat-mxc/pmic_platform.h>
 
 #include "devices.h"
 
@@ -525,6 +526,28 @@ static struct mxc_spi_master mx27ads_spi_2_data = {
 };
 #endif  /* CONFIG_SPI_MXC_SELECT3 */
 
+static int gpio_pmic_active(void)
+{
+	mxc_gpio_mode(PC15_PF_TOUT);
+
+	return 0;
+}
+
+static struct pmic_platform_data mx27ads_pmic_irq = {
+	.init = gpio_pmic_active,
+	.exit = NULL
+};
+
+static struct spi_board_info mx27ads_spi_board_info[] __initdata = {
+	{
+		.modalias = "pmic_spi",
+		.irq = IRQ_GPIOC(14),
+		.max_speed_hz = 4000000,
+		.bus_num = 0,
+		.chip_select = 0,
+		.platform_data = &mx27ads_pmic_irq,
+	}
+};
 #endif /* CONFIG_SPI */
 
 static void __init mx27ads_board_init(void)
@@ -551,6 +574,8 @@ static void __init mx27ads_board_init(void)
 #ifdef CONFIG_SPI_MXC_SELECT3
 	mxc_register_device(&mxc_spi_device2, &mx27ads_spi_2_data);
 #endif
+	spi_register_board_info(mx27ads_spi_board_info,
+				ARRAY_SIZE(mx27ads_spi_board_info));
 #endif
 	mxc_register_device(&mxc_wdt, NULL);
 
diff --git a/arch/arm/plat-mxc/include/mach/iomux-mx1-mx2.h b/arch/arm/plat-mxc/include/mach/iomux-mx1-mx2.h
index 2db57f0..8e0540f 100644
--- a/arch/arm/plat-mxc/include/mach/iomux-mx1-mx2.h
+++ b/arch/arm/plat-mxc/include/mach/iomux-mx1-mx2.h
@@ -322,6 +322,7 @@ extern int mxc_gpio_setup_multiple_pins(const int *pin_list, unsigned count,
 #define PC11_PF_USBOTG_DATA1	(GPIO_PORTC | GPIO_OUT | GPIO_PF | 11)
 #define PC12_PF_USBOTG_DATA4	(GPIO_PORTC | GPIO_OUT | GPIO_PF | 12)
 #define PC13_PF_USBOTG_DATA3	(GPIO_PORTC | GPIO_OUT | GPIO_PF | 13)
+#define PC15_PF_TOUT		(GPIO_PORTC | GPIO_IN  | GPIO_PF | 14)
 #define PC15_PF_TIN		(GPIO_PORTC | GPIO_IN  | GPIO_PF | 15)
 #define PC16_PF_SSI4_FS		(GPIO_PORTC | GPIO_IN  | GPIO_PF | 16)
 #define PC17_PF_SSI4_RXD	(GPIO_PORTC | GPIO_IN  | GPIO_PF | 17)
diff --git a/drivers/mxc/pmic/Kconfig b/drivers/mxc/pmic/Kconfig
index ac9c05b..21208da 100644
--- a/drivers/mxc/pmic/Kconfig
+++ b/drivers/mxc/pmic/Kconfig
@@ -31,7 +31,7 @@ comment "MXC PMIC Client Drivers"
 
 config MXC_PMIC_MC13783
 	tristate "MC13783 Client Drivers"
-	depends on MXC_SPI_PMIC_CORE && (ARCH_MX3 || ARCH_MX27)
+	depends on MXC_SPI_PMIC_CORE && (ARCH_MX3 || MACH_MX27)
 	default n
 	help
 	This is the MXC MC13783(PMIC) client drivers support. It include
-- 
1.6.0.3

