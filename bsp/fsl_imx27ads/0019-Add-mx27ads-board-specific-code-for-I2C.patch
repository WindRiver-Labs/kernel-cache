From 439010459b37265a9481cbf9363d8b2897f8e2cc Mon Sep 17 00:00:00 2001
From: Alexander Smirnov <asmirnov@embeddedalley.com>
Date: Mon, 29 Dec 2008 18:46:42 +0300
Subject: [PATCH 19/77] Add mx27ads board specific code for I2C

Add mx27ads board specific code for I2C. This is available via
CONFIG_I2C.

Signed-off-by: Alexander Smirnov
---
 arch/arm/mach-mx2/mx27ads.c |   62 +++++++++++++++++++++++++++++++++++++++++++
 1 files changed, 62 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-mx2/mx27ads.c b/arch/arm/mach-mx2/mx27ads.c
index 8ceb87d..222e5f0 100644
--- a/arch/arm/mach-mx2/mx27ads.c
+++ b/arch/arm/mach-mx2/mx27ads.c
@@ -26,6 +26,7 @@
 #include <mach/common.h>
 #include <mach/hardware.h>
 #include <linux/interrupt.h>
+#include <linux/i2c.h>
 #include <linux/spi/spi.h>
 #include <asm/mach-types.h>
 #include <asm/mach/arch.h>
@@ -38,6 +39,7 @@
 #include <mach/iomux-mx1-mx2.h>
 #include <mach/board-mx27ads.h>
 #include <mach/mxc_nand.h>
+#include <mach/imx_i2c.h>
 #include <mach/imx_spi.h>
 #include <asm/plat-mxc/pmic_platform.h>
 
@@ -421,6 +423,57 @@ static struct imxuart_platform_data uart_pdata[] = {
 	},
 };
 
+#ifdef CONFIG_I2C
+static int mxc_i2c0_pins[] = {
+	PD17_PF_I2C_DATA,
+	PD18_PF_I2C_CLK
+};
+
+static int mxc_i2c1_pins[] = {
+	PC5_PF_I2C2_SDA,
+	PC6_PF_I2C2_SCL
+};
+
+static int mx27ads_i2c_0_init(struct platform_device *pdev)
+{
+	return mxc_gpio_setup_multiple_pins(mxc_i2c0_pins, ARRAY_SIZE(mxc_i2c0_pins),
+					    MXC_GPIO_ALLOC_MODE_NORMAL, "I2C0");
+}
+
+static int mx27ads_i2c_0_exit(struct platform_device *pdev)
+{
+	return mxc_gpio_setup_multiple_pins(mxc_i2c0_pins, ARRAY_SIZE(mxc_i2c0_pins),
+					    MXC_GPIO_ALLOC_MODE_RELEASE, "I2C0");
+}
+
+static int mx27ads_i2c_1_init(struct platform_device *pdev)
+{
+	return mxc_gpio_setup_multiple_pins(mxc_i2c1_pins, ARRAY_SIZE(mxc_i2c1_pins),
+					    MXC_GPIO_ALLOC_MODE_NORMAL, "I2C1");
+}
+
+static int mx27ads_i2c_1_exit(struct platform_device *pdev)
+{
+	return mxc_gpio_setup_multiple_pins(mxc_i2c1_pins, ARRAY_SIZE(mxc_i2c1_pins),
+					    MXC_GPIO_ALLOC_MODE_RELEASE, "I2C1");
+}
+
+static struct imx_i2c_platform_data mx27ads_i2c_0_data = {
+	.max_clk = 100000,
+	.init = mx27ads_i2c_0_init,
+	.exit = mx27ads_i2c_0_exit,
+};
+
+static struct imx_i2c_platform_data mx27ads_i2c_1_data = {
+	.max_clk = 100000,
+	.init = mx27ads_i2c_1_init,
+	.exit = mx27ads_i2c_1_exit,
+};
+
+static struct i2c_board_info mx27ads_i2c_devices[] = {
+};
+#endif
+
 #ifdef CONFIG_SPI
 
 #ifdef CONFIG_SPI_MXC_SELECT1
@@ -564,6 +617,15 @@ static void __init mx27ads_board_init(void)
 	mxc_register_device(&mxc_nand_device, &mx27ads_nand_board_info);
 #endif
 
+#ifdef CONFIG_I2C
+	/* only the i2c master 1 is used on this CPU card */
+	i2c_register_board_info(1, mx27ads_i2c_devices,
+				ARRAY_SIZE(mx27ads_i2c_devices));
+
+	mxc_register_device(&imx_i2c_device0, &mx27ads_i2c_0_data);
+	mxc_register_device(&imx_i2c_device1, &mx27ads_i2c_1_data);
+#endif
+
 #ifdef CONFIG_SPI
 #ifdef CONFIG_SPI_MXC_SELECT1
 	mxc_register_device(&mxc_spi_device0, &mx27ads_spi_0_data);
-- 
1.6.3.1

