From 8203446221fdd660f0dfe825e40064db66f937da Mon Sep 17 00:00:00 2001
From: Vladimir Barinov <vbarinov@embeddedlley.com>
Date: Tue, 3 Feb 2009 19:39:00 +0300
Subject: [PATCH] Enable 26Mhz clock on CKO1 used by PMIC audio

IMX27ADS: Enable 26Mhz clock on CKO1 used by PMIC audio.
	  The imx27ads platform support different clock sources for audio PMIC
	  controller h/w. The factory defaults are CKO1 from IMX cpu.

Signed-off-by: Vladimir Barinov <vbarinov@embeddedlley.com>
---
 arch/arm/mach-mx2/mx27ads.c |   16 ++++++++++++++++
 1 files changed, 16 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-mx2/mx27ads.c b/arch/arm/mach-mx2/mx27ads.c
index 8d15ac3..63e642d 100644
--- a/arch/arm/mach-mx2/mx27ads.c
+++ b/arch/arm/mach-mx2/mx27ads.c
@@ -31,6 +31,7 @@
 #include <linux/dma-mapping.h>
 #include <linux/delay.h>
 #include <linux/input.h>
+#include <linux/clk.h>
 
 #include <asm/mach-types.h>
 #include <asm/mach/arch.h>
@@ -872,6 +873,21 @@ static int mxc_ssi_pins[] = {
 static int gpio_ssi_activate(struct platform_device *pdev)
 {
 	int err;
+	struct clk *ckih_clk;
+	struct clk *cko_clk;
+
+	/* Enable 26 mhz clock on CKO1 for PMIC audio */
+	ckih_clk = clk_get(NULL, "ckih");
+	cko_clk = clk_get(NULL, "clko_clk");
+	if (IS_ERR(ckih_clk) || IS_ERR(cko_clk)) {
+		printk(KERN_ERR "Unable to set CLKO output to CKIH\n");
+	} else {
+		clk_set_parent(cko_clk, ckih_clk);
+		clk_set_rate(cko_clk, clk_get_rate(ckih_clk));
+		clk_enable(cko_clk);
+	}
+	clk_put(ckih_clk);
+	clk_put(cko_clk);
 
 	err = mxc_gpio_setup_multiple_pins(mxc_ssi_pins, ARRAY_SIZE(mxc_ssi_pins),
 					   MXC_GPIO_ALLOC_MODE_NORMAL, "imx-sound");
-- 
1.6.0.3

