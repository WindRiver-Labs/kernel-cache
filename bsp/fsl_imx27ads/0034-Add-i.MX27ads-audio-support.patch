From 6a7b32055b7c6ad33529df7700eab69c0aa5c551 Mon Sep 17 00:00:00 2001
From: Alexander Smirnov <asmirnov@embeddedalley.com>
Date: Mon, 29 Dec 2008 19:21:13 +0300
Subject: [PATCH] Add i.MX27ads audio support

Add i.MX27ads audio support. Available via CONFIG_SND.

Signed-off-by: Alexander Smirnov <asmirnov@embeddedalley.com>
---
 arch/arm/mach-mx2/mx27ads.c |   83 ++++++++++++++++++++++++++++++++++++++++--
 1 files changed, 79 insertions(+), 4 deletions(-)

diff --git a/arch/arm/mach-mx2/mx27ads.c b/arch/arm/mach-mx2/mx27ads.c
index cf376d7..3c923c4 100644
--- a/arch/arm/mach-mx2/mx27ads.c
+++ b/arch/arm/mach-mx2/mx27ads.c
@@ -28,6 +28,8 @@
 #include <linux/interrupt.h>
 #include <linux/i2c.h>
 #include <linux/spi/spi.h>
+#include <linux/dma-mapping.h>
+
 #include <asm/mach-types.h>
 #include <asm/mach/arch.h>
 #include <asm/mach/flash.h>
@@ -44,6 +46,9 @@
 #include <asm/plat-mxc/pmic_platform.h>
 #include <asm/plat-mxc/pmic_power.h>
 #include <mach/imxfb.h>
+#include <mach/imx_ssi.h>
+#include <mach/imx_dam.h>
+#include <mach/imx_sound.h>
 
 #include "devices.h"
 
@@ -358,10 +363,6 @@ static int uart_mxc_port5_exit(struct platform_device *pdev)
 			MXC_GPIO_ALLOC_MODE_RELEASE, "UART5");
 }
 
-static struct platform_device *platform_devices[] __initdata = {
-	&mx27ads_nor_mtd_device,
-};
-
 static int mxc_fec_pins[] = {
 	PD0_AIN_FEC_TXD0,
 	PD1_AIN_FEC_TXD1,
@@ -680,6 +681,74 @@ static struct imx_fb_platform_data mx27ads_fb_data = {
 	.exit = gpio_fb_inactive,
 };
 
+#ifdef CONFIG_SND
+
+static int mxc_ssi_pins[] = {
+	PC20_PF_SSI1_FS,
+	PC21_PF_SSI1_RXD,
+	PC22_PF_SSI1_TXD,
+	PC23_PF_SSI1_CLK,
+
+	PC24_PF_SSI2_FS,
+	PC25_PF_SSI2_RXD,
+	PC26_PF_SSI2_TXD,
+	PC27_PF_SSI2_CLK,
+};
+
+static int gpio_ssi_activate(struct platform_device *pdev)
+{
+	int err;
+
+	err = mxc_gpio_setup_multiple_pins(mxc_ssi_pins, ARRAY_SIZE(mxc_ssi_pins),
+					   MXC_GPIO_ALLOC_MODE_NORMAL, "imx-sound");
+	if (err < 0)
+		pr_err("Cannot register SSI pins for sound usage\n");
+
+	return err;
+}
+
+static struct imx_sound_platform_data mx27ads_alsa_sound = {
+	.connection = {
+		[0] = {
+			.cpu_port = 1,	/* SSI1_* pin group */
+			.dev_port = 1	/* connected to port 1 of the PMIC */
+		},
+		[1] = {
+			.cpu_port = 2,	/* SSI2_* pin group */
+			.dev_port = 2	/* connected to port 2 of the PMIC */
+		}
+	},
+	.init = gpio_ssi_activate,
+	.exit = NULL	/* FIXME */
+};
+
+static struct platform_device mx27ads_alsa_sound_device = {
+	.name = "imx-alsa",
+	.id = 0,
+	.dev = {
+		.platform_data = &mx27ads_alsa_sound,
+		.coherent_dma_mask = DMA_BIT_MASK(32)
+	}
+};
+
+static struct imx_ssi_platform_data mx27ads_ssi0 = {
+	.init = NULL,	/* FIXME currently done in the audio device */
+	.exit = NULL	/* FIXME */
+};
+
+static struct imx_ssi_platform_data mx27ads_ssi1 = {
+	.init = NULL,   /* FIXME currently done in the audio device */
+	.exit = NULL    /* FIXME */
+};
+#endif
+
+static struct platform_device *platform_devices[] __initdata = {
+	&mx27ads_nor_mtd_device,
+#ifdef CONFIG_SND
+	&mx27ads_alsa_sound_device,
+#endif
+};
+
 static void __init mx27ads_board_init(void)
 {
 	gpio_fec_active();
@@ -720,6 +789,12 @@ static void __init mx27ads_board_init(void)
 	mxc_register_device(&mxc_rtc, NULL);
 	mxc_register_device(&mxc_fb_device, &mx27ads_fb_data);
 
+#ifdef CONFIG_SND
+	mxc_register_device(&mxc_dam_device, NULL);
+	mxc_register_device(&imx_ssi_device0, &mx27ads_ssi0);
+	mxc_register_device(&imx_ssi_device1, &mx27ads_ssi1);
+#endif
+
 	platform_add_devices(platform_devices, ARRAY_SIZE(platform_devices));
 }
 
-- 
1.5.5.1

