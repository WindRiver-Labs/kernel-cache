From 3134458cd882580d06b3d3cc0d6ba1e7e992b58b Mon Sep 17 00:00:00 2001
From: Wang Hui <Hui.Wang@windriver.com>
Date: Wed, 27 May 2009 09:58:39 +0800
Subject: [PATCH] fec_mx2: modify fec_mx2 to support kgdboe and avoid transmit timeout

Adding poll_controller interface to support net_poll, because the
KGDBoE is based on this interface.
Adding netif_start_queue in net_open to avoid transmit timeout at
first time when using the device.

Signed-off-by: Wang Hui <Hui.Wang@windriver.com>
---
 drivers/net/fec_mx2.c |   22 ++++++++++++++++++++++
 1 files changed, 22 insertions(+), 0 deletions(-)

diff --git a/drivers/net/fec_mx2.c b/drivers/net/fec_mx2.c
index 52b4fd3..2a67898 100644
--- a/drivers/net/fec_mx2.c
+++ b/drivers/net/fec_mx2.c
@@ -212,6 +212,9 @@ static void set_multicast_list(struct net_device *dev);
 static void fec_restart(struct net_device *dev, int duplex);
 static void fec_stop(struct net_device *dev);
 static void fec_set_mac_address(struct net_device *dev);
+#ifdef CONFIG_NET_POLL_CONTROLLER
+static void fec_poll_controller(struct net_device *dev);
+#endif
 
 static inline void fec_dcache_inv_range(void *start, void *end);
 static inline void fec_dcache_flush_range(void *start, void *end);
@@ -473,6 +476,20 @@ static irqreturn_t fec_enet_interrupt(int irq, void *dev_id)
 	return IRQ_RETVAL(handled);
 }
 
+#ifdef CONFIG_NET_POLL_CONTROLLER
+/*
+ * Polling receive - used by netconsole and other diagnostic tools
+ * to allow network i/o with interrupts disabled.
+ */
+
+static void fec_poll_controller(struct net_device *dev)
+{
+	disable_irq(dev->irq);
+	fec_enet_interrupt(dev->irq, dev);
+	enable_irq(dev->irq);
+}
+#endif
+
 static void fec_enet_tx(struct net_device *dev)
 {
 	struct fec_enet_private *fep;
@@ -1211,6 +1228,8 @@ static int fec_enet_open(struct net_device *dev)
 		 * so we are never notified of link change.
 		 */
 		fep->link = 1;
+
+		netif_start_queue(dev);
 	} else {
 		fep->link = 1;	/* lets just try it and see */
 		/* no phy,  go full duplex,  it's most likely a hub chip */
@@ -1489,6 +1508,9 @@ int __init fec_enet_init(struct net_device *dev)
 	dev->stop = fec_enet_close;
 	dev->get_stats = fec_enet_get_stats;
 	dev->set_multicast_list = set_multicast_list;
+#ifdef CONFIG_NET_POLL_CONTROLLER
+	dev->poll_controller	= fec_poll_controller;
+#endif
 
 	for (i = 0; i < NMII - 1; i++)
 		mii_cmds[i].mii_next = &mii_cmds[i + 1];
-- 
1.5.5.1

