From a66dcc75e07e1ef26b76c1b76ba3ea8d0df1380c Mon Sep 17 00:00:00 2001
From: builder <builder@black.easi.ru>
Date: Fri, 6 Feb 2009 18:11:11 +0300
Subject: [PATCH] SoC camera cleanup and mx27 camera driver fix

1) SoC Camera driver cleanup after penqutronux patch with dbg info
2) fix mx27_camera driver to be able to query video format in
   camera chip driver

Signed-off-by: Vladimir Barinov <vbarinov@embeddedlley.com>
---
 drivers/media/video/mx27_camera.c |    8 ++++++--
 drivers/media/video/soc_camera.c  |    2 --
 2 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/drivers/media/video/mx27_camera.c b/drivers/media/video/mx27_camera.c
index b61dec1..ab34a4a 100644
--- a/drivers/media/video/mx27_camera.c
+++ b/drivers/media/video/mx27_camera.c
@@ -717,7 +717,7 @@ static int mx27_camera_set_fmt_cap(struct soc_camera_device *icd,
 static int mx27_camera_try_fmt_cap(struct soc_camera_device *icd,
 				  struct v4l2_format *f)
 {
-	return 0;
+	return icd->ops->try_fmt_cap(icd, f);
 }
 
 static int mx27_camera_querycap(struct soc_camera_host *ici,
@@ -1069,7 +1069,11 @@ static int mx27_camera_probe(struct platform_device *pdev)
 	pcdev->base_csi = base_csi;
 	pcdev->dev = &pdev->dev;
 
-	pcdev->pdata->init(pdev);
+	err = pcdev->pdata->init(pdev);
+	if (err) {
+		dev_err(pcdev->dev, "Camera platform init failed \n");
+		goto exit_iounmap;
+	}
 
 	err = request_irq(pcdev->irq_csi, mx27_camera_irq, 0, MX27_CAM_DRV_NAME,
 			  pcdev);
diff --git a/drivers/media/video/soc_camera.c b/drivers/media/video/soc_camera.c
index 9730c07..784bd22 100644
--- a/drivers/media/video/soc_camera.c
+++ b/drivers/media/video/soc_camera.c
@@ -709,14 +709,12 @@ static int soc_camera_probe(struct device *dev)
 
 	/* We only call ->add() here to activate and probe the camera.
 	 * We shall ->remove() and deactivate it immediately afterwards. */
-	printk("ADD\n");
 	ret = ici->ops->add(icd);
 	if (ret < 0) {
 		printk("add failed\n");
 		return ret;
 	}
 
-	printk("probe\n");
 	ret = icd->ops->probe(icd);
 	if (ret < 0)
 		printk("probe failed\n");
-- 
1.6.0.3

