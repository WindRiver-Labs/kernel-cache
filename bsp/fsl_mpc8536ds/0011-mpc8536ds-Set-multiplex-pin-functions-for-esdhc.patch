From 4cf1164a36659919b2d8d3c6db12c51bdabc0f8e Mon Sep 17 00:00:00 2001
From: Thomas Tai <thomas.tai@windriver.com>
Date: Wed, 29 Apr 2009 10:30:20 -0400
Subject: [PATCH] mpc8536ds: Set multiplex pin functions for esdhc

According to "MPC8536E PowerQUICC III Integrated Processor
Reference Manual", the mpc8536ds MMC/SD card detection
pin is multiplexed with gpio pin. A function is added to set
the gpio to be use as card detection pin.

Signed-off-by: Thomas Tai <thomas.tai@windriver.com>
---
 arch/powerpc/platforms/85xx/mpc8536_ds.c |   28 ++++++++++++++++++++++++++++
 1 files changed, 28 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/mpc8536_ds.c b/arch/powerpc/platforms/85xx/mpc8536_ds.c
index 0d53a21..08c4de1 100644
--- a/arch/powerpc/platforms/85xx/mpc8536_ds.c
+++ b/arch/powerpc/platforms/85xx/mpc8536_ds.c
@@ -34,6 +34,30 @@
 #include <sysdev/fsl_soc.h>
 #include <sysdev/fsl_pci.h>
 
+/*
+ * Global Utilites Features
+ */
+/* Alternate Function Signal Multiplex Control Register */
+#define PMUXCR_ADDRESS  (0xE0060)
+
+#define PMUXCR_SDHC_CD  (0x40000000)
+#define PMUXCR_SDHC_WP  (0x20000000)
+
+static int mpc8536ds_sd_cfg(void)
+{
+	u32 __iomem *pmuxcr;
+	u32 value;
+
+	/* Configure SDHC_CD as MMC/SD card detection pin */
+	pmuxcr = ioremap(get_immrbase() + PMUXCR_ADDRESS, 4);
+	if (pmuxcr){
+		value = in_be32(pmuxcr);
+		out_be32(pmuxcr, value | PMUXCR_SDHC_CD | PMUXCR_SDHC_WP);
+		iounmap(pmuxcr);
+	}
+	return 0;
+}
+
 void __init mpc8536_ds_pic_init(void)
 {
 	struct mpic *mpic;
@@ -200,6 +224,10 @@ static void __init mpc8536_ds_setup_arch(void)
 
 #endif
 
+#if defined(CONFIG_MMC_ESDHC) || defined(CONFIG_MMC_ESDHC_MODULE)
+	mpc8536ds_sd_cfg();
+#endif
+
 	printk("MPC8536 DS board from Freescale Semiconductor\n");
 }
 
-- 
1.6.0.4

