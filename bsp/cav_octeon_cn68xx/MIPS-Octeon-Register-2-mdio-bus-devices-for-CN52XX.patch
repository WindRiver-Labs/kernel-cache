From a23a24dc14dfe9bd84855a7c71a25a1cda44b16c Mon Sep 17 00:00:00 2001
From: David Daney <ddaney@caviumnetworks.com>
Date: Tue, 28 Sep 2010 13:47:43 -0700
Subject: [PATCH 62/97] MIPS: Octeon: Register 2 mdio bus devices for CN52XX

Source: Cavium SDK 2.1.0-407

Previously only the first device was being registered.

Signed-off-by: David Daney <ddaney@caviumnetworks.com>
Integrated-by: Phil Staub <Phil.Staub@windriver.com>
---
 arch/mips/cavium-octeon/octeon-platform.c |   37 ++++++++++++----------------
 1 files changed, 16 insertions(+), 21 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-platform.c b/arch/mips/cavium-octeon/octeon-platform.c
index 72bce02..6089604 100644
--- a/arch/mips/cavium-octeon/octeon-platform.c
+++ b/arch/mips/cavium-octeon/octeon-platform.c
@@ -259,6 +259,7 @@ static int __init octeon_mdiobus_device_init(void)
 {
 	struct platform_device *pd;
 	int ret = 0;
+	int num_mdio, i;
 
 	if (octeon_is_simulation())
 		return 0; /* No mdio in the simulator. */
@@ -270,31 +271,25 @@ static int __init octeon_mdiobus_device_init(void)
 	if (octeon_bootinfo->board_type == CVMX_BOARD_TYPE_NIC_XLE_10G)
 		return 0;
 
-	/* The bus number is the platform_device id.  */
-	pd = platform_device_alloc("mdio-octeon", 0);
-	if (!pd) {
-		ret = -ENOMEM;
-		goto out;
-	}
-
-	ret = platform_device_add(pd);
-	if (ret)
-		goto fail;
+	if (OCTEON_IS_MODEL(OCTEON_CN56XX) || OCTEON_IS_MODEL(OCTEON_CN52XX)
+	    || OCTEON_IS_MODEL(OCTEON_CN63XX))
+		num_mdio = 2;
+	else
+		num_mdio = 1;
 
-	if (!OCTEON_IS_MODEL(OCTEON_CN56XX) && !OCTEON_IS_MODEL(OCTEON_CN6XXX))
-		goto out;
+	for (i = 0; i < num_mdio; i++) {
+		/* The bus number is the platform_device id.  */
+		pd = platform_device_alloc("mdio-octeon", i);
+		if (!pd) {
+			ret = -ENOMEM;
+			goto out;
+		}
 
-	/* The bus number is the platform_device id.  */
-	pd = platform_device_alloc("mdio-octeon", 1);
-	if (!pd) {
-		ret = -ENOMEM;
-		goto out;
+		ret = platform_device_add(pd);
+		if (ret)
+			goto fail;
 	}
 
-	ret = platform_device_add(pd);
-	if (ret)
-		goto fail;
-
 	return ret;
 fail:
 	platform_device_put(pd);
-- 
1.7.0

