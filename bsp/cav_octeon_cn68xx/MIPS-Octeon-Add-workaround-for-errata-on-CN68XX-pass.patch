From 1119a343605693b800a29e1430000ba153ba175c Mon Sep 17 00:00:00 2001
From: Chad Reese <kreese@caviumnetworks.com>
Date: Fri, 1 Apr 2011 16:32:24 -0700
Subject: [PATCH 88/97] MIPS: Octeon: Add workaround for errata on CN68XX pass 1.x.

Source: Cavium SDK 2.1.0-407

CN68XX pass 1.x has an errata where reading the CIU2 ACK registers can
cause interrupts to be blocked from the core until another CIU2 access
is performed.  Since interrupts are blocked, nobody is going ot access
the CIU2, so interrupts stop being delivered permantently. The READY
register is a much slower alternative that works on CN68XX pass 1.x.

Signed-off-by: Chad Reese <kreese@caviumnetworks.com>
Signed-off-by: David Daney <ddaney@caviumnetworks.com>
Integrated-by: Phil Staub <Phil.Staub@windriver.com>
---
 arch/mips/cavium-octeon/octeon-irq.c |   14 ++++++++++++--
 1 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-irq.c b/arch/mips/cavium-octeon/octeon-irq.c
index bed0039..65f34ca 100644
--- a/arch/mips/cavium-octeon/octeon-irq.c
+++ b/arch/mips/cavium-octeon/octeon-irq.c
@@ -1188,7 +1188,12 @@ static void octeon_irq_ciu2(void)
 spurious:
 	spurious_interrupt();
 out:
-	cvmx_read_csr(CVMX_CIU2_ACK_PPX_IP2(core_id));
+	/* CN68XX pass 1.x has an errata that accessing the ACK registers
+		can stop interrupts from propagating */
+	if (OCTEON_IS_MODEL(OCTEON_CN68XX_PASS1_X))
+		cvmx_read_csr(CVMX_CIU2_INTR_CIU_READY);
+	else
+		cvmx_read_csr(CVMX_CIU2_ACK_PPX_IP2(core_id));
 	return;
 }
 
@@ -1210,7 +1215,12 @@ static void octeon_irq_ciu2_mbox(void)
 spurious:
 	spurious_interrupt();
 out:
-	cvmx_read_csr(CVMX_CIU2_ACK_PPX_IP3(core_id));
+	/* CN68XX pass 1.x has an errata that accessing the ACK registers
+		can stop interrupts from propagating */
+	if (OCTEON_IS_MODEL(OCTEON_CN68XX_PASS1_X))
+		cvmx_read_csr(CVMX_CIU2_INTR_CIU_READY);
+	else
+		cvmx_read_csr(CVMX_CIU2_ACK_PPX_IP3(core_id));
 	return;
 }
 
-- 
1.7.0

