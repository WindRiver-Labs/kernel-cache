From 7b32261b4d2cde5cd37654edfc1daa01b5c3619f Mon Sep 17 00:00:00 2001
From: David Daney <ddaney@caviumnetworks.com>
Date: Tue, 5 Apr 2011 14:30:59 -0700
Subject: [PATCH 75/97] netdev: mdio-octeon: There can be upto four busses.

Source: Cavium SDK 2.1.0-407

Allow for a maximum of four Octeon MDIO busses. CN68XX has four of
them, so we need enough space in octeon_mdiobuses.

Signed-off-by: David Daney <ddaney@caviumnetworks.com>
Integrated-by: Phil Staub <Phil.Staub@windriver.com>
---
 arch/mips/cavium-octeon/setup.c       |    2 +-
 arch/mips/include/asm/octeon/octeon.h |    2 +-
 drivers/net/phy/mdio-octeon.c         |    1 +
 3 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index d3ae782..5c33975 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -112,7 +112,7 @@ extern asmlinkage void handle_int(void);
 extern asmlinkage void plat_irq_dispatch(void);
 
 /* Any mdio busses that are configured for this kernel. */
-struct mii_bus *octeon_mdiobuses[2];
+struct mii_bus *octeon_mdiobuses[4];
 EXPORT_SYMBOL(octeon_mdiobuses);
 
 /*
diff --git a/arch/mips/include/asm/octeon/octeon.h b/arch/mips/include/asm/octeon/octeon.h
index b147c80..37b5c5b 100644
--- a/arch/mips/include/asm/octeon/octeon.h
+++ b/arch/mips/include/asm/octeon/octeon.h
@@ -273,7 +273,7 @@ static inline uint32_t octeon_npi_read32(uint64_t address)
 }
 
 extern struct cvmx_bootinfo *octeon_bootinfo;
-extern struct mii_bus *octeon_mdiobuses[2];
+extern struct mii_bus *octeon_mdiobuses[];
 
 extern u64 octeon_bootloader_entry_addr;
 
diff --git a/drivers/net/phy/mdio-octeon.c b/drivers/net/phy/mdio-octeon.c
index b457e74..5a00a69 100644
--- a/drivers/net/phy/mdio-octeon.c
+++ b/drivers/net/phy/mdio-octeon.c
@@ -99,6 +99,7 @@ static int __init octeon_mdiobus_probe(struct platform_device *pdev)
 
 	/* The platform_device id is our unit number.  */
 	bus->unit = pdev->id;
+	BUG_ON(bus->unit > 3 || bus->unit < 0);
 
 	bus->mii_bus = mdiobus_alloc();
 
-- 
1.7.0

