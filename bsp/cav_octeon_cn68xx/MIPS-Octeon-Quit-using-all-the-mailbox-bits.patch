From d35c40deb2154584aa3d74b82572fad39afe89da Mon Sep 17 00:00:00 2001
From: David Daney <ddaney@caviumnetworks.com>
Date: Thu, 10 Feb 2011 13:11:34 -0800
Subject: [PATCH 86/97] MIPS: Octeon: Quit using all the mailbox bits.

Source: Cavium SDK 2.1.0-407

The SMP support in the kernel only really uses three of the mailbox
bits.  The mailbox bits are grouped in either 16-bit or 8-bit chunks,
so use only the low-order chunk leaving the others available for
drivers.

Signed-off-by: David Daney <ddaney@caviumnetworks.com>
Integrated-by: Phil Staub <Phil.Staub@windriver.com>
---
 arch/mips/cavium-octeon/smp.c |   18 ++++++++++++------
 1 files changed, 12 insertions(+), 6 deletions(-)

diff --git a/arch/mips/cavium-octeon/smp.c b/arch/mips/cavium-octeon/smp.c
index 5dc6d5c..fd2a662 100644
--- a/arch/mips/cavium-octeon/smp.c
+++ b/arch/mips/cavium-octeon/smp.c
@@ -52,6 +52,11 @@ static irqreturn_t mailbox_interrupt(int irq, void *dev_id)
 	/* Load the mailbox register to figure out what we're supposed to do */
 	action = cvmx_read_csr(CVMX_CIU_MBOX_CLRX(coreid));
 
+	if (OCTEON_IS_MODEL(OCTEON_CN68XX))
+		action &= 0xff;
+	else
+		action &= 0xffff;
+
 	/* Clear the mailbox to clear the interrupt */
 	cvmx_write_csr(CVMX_CIU_MBOX_CLRX(coreid), action);
 
@@ -251,6 +256,7 @@ static void octeon_init_secondary(void)
  */
 void octeon_prepare_cpus(unsigned int max_cpus)
 {
+	u64 mask;
 #ifdef CONFIG_HOTPLUG_CPU
 	unsigned long t;
 	struct linux_app_boot_info *labi;
@@ -271,16 +277,16 @@ void octeon_prepare_cpus(unsigned int max_cpus)
 #ifdef CONFIG_WRHV
 	wrhv_request_ipis();
 #else
-
-	cvmx_write_csr(CVMX_CIU_MBOX_CLRX(cvmx_get_core_num()), 0xffffffff);
+	/* Only the low order MBOX bits are used.  Leave the other alone. */
+	if (OCTEON_IS_MODEL(OCTEON_CN68XX))
+		mask = 0xff;
+	else
+		mask = 0xffff;
+	cvmx_write_csr(CVMX_CIU_MBOX_CLRX(cvmx_get_core_num()), mask);
 	if (request_irq(OCTEON_IRQ_MBOX0, mailbox_interrupt, IRQF_DISABLED,
 			"mailbox0", mailbox_interrupt)) {
 		panic("Cannot request_irq(OCTEON_IRQ_MBOX0)\n");
 	}
-	if (request_irq(OCTEON_IRQ_MBOX1, mailbox_interrupt, IRQF_DISABLED,
-			"mailbox1", mailbox_interrupt)) {
-		panic("Cannot request_irq(OCTEON_IRQ_MBOX1)\n");
-	}
 #endif
 }
 
-- 
1.7.0

