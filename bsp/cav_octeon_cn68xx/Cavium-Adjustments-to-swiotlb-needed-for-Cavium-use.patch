From 56e8e54f099692aa055600c40490305be9ce20a6 Mon Sep 17 00:00:00 2001
From: Phil Staub <Phil.Staub@windriver.com>
Date: Thu, 16 Jun 2011 16:15:14 -0700
Subject: [PATCH 32/97] Cavium: Adjustments to swiotlb needed for Cavium use

Source: Cavium SDK 2.1.0-407

Add dma_length field to struct scatterlist.

Add declaration of swiotlb_init_with_default_size() so it can be used
by external code.

Signed-off-by: Phil Staub <Phil.Staub@windriver.com>
---
 arch/mips/include/asm/scatterlist.h |    1 +
 include/linux/swiotlb.h             |    9 +++++++++
 lib/swiotlb.c                       |    2 +-
 3 files changed, 11 insertions(+), 1 deletions(-)

diff --git a/arch/mips/include/asm/scatterlist.h b/arch/mips/include/asm/scatterlist.h
index 83d69fe..9d7c822 100644
--- a/arch/mips/include/asm/scatterlist.h
+++ b/arch/mips/include/asm/scatterlist.h
@@ -11,6 +11,7 @@ struct scatterlist {
 	unsigned int	offset;
 	dma_addr_t	dma_address;
 	unsigned int	length;
+	u32		dma_length; /* For SWIOTLB*/
 };
 
 /*
diff --git a/include/linux/swiotlb.h b/include/linux/swiotlb.h
index febedcf..85dc6ef 100644
--- a/include/linux/swiotlb.h
+++ b/include/linux/swiotlb.h
@@ -24,6 +24,12 @@ extern int swiotlb_force;
 
 extern void swiotlb_init(int verbose);
 
+/*
+ * The memory range used by the swiotlb
+ */
+extern char *io_tlb_start;
+extern char *io_tlb_end;
+
 extern void
 *swiotlb_alloc_coherent(struct device *hwdev, size_t size,
 			dma_addr_t *dma_handle, gfp_t flags);
@@ -40,6 +46,9 @@ extern void swiotlb_unmap_page(struct device *hwdev, dma_addr_t dev_addr,
 			       size_t size, enum dma_data_direction dir,
 			       struct dma_attrs *attrs);
 
+extern void
+swiotlb_init_with_default_size(size_t, int verbose);
+
 extern int
 swiotlb_map_sg(struct device *hwdev, struct scatterlist *sg, int nents,
 	       int direction);
diff --git a/lib/swiotlb.c b/lib/swiotlb.c
index 5fddf72..d5a7e1e 100644
--- a/lib/swiotlb.c
+++ b/lib/swiotlb.c
@@ -65,7 +65,7 @@ int swiotlb_force;
  * sync_single_*, to see if the memory was in fact allocated by this
  * API.
  */
-static char *io_tlb_start, *io_tlb_end;
+char *io_tlb_start, *io_tlb_end;
 
 /*
  * The number of IO TLB blocks (in groups of 64) betweeen io_tlb_start and
-- 
1.7.0

