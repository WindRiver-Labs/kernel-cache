From 50566c1c7e13bec738c55761d1265521584f06f2 Mon Sep 17 00:00:00 2001
From: Shinya Kuribayashi <shinya.kuribayashi@necel.com>
Date: Mon, 7 Sep 2009 09:45:36 +0900
Subject: [PATCH 14/15] MIPS: nec_emma3pf: Adapt to updated PROM library

Our common PROM library routines have been updated so that they can
handle environment variables.  This patch adapts EMMA3PF et10121 port
to a new implementation.

At the same time, we are going to take a different approach in picking
up an ethernet MAC address for NEC Candy; basically try to obtain via
get_ethernet_addr().

Signed-off-by: Shinya Kuribayashi <shinya.kuribayashi@necel.com>
---
 arch/mips/emma/et10121/init.c     |    4 ++++
 arch/mips/emma/et10121/platform.c |   16 +++++++++++++---
 2 files changed, 17 insertions(+), 3 deletions(-)

diff --git a/arch/mips/emma/et10121/init.c b/arch/mips/emma/et10121/init.c
index 47f46e9..849eccc 100644
--- a/arch/mips/emma/et10121/init.c
+++ b/arch/mips/emma/et10121/init.c
@@ -18,6 +18,10 @@ const char *get_system_type(void)
 
 void __init prom_init(void)
 {
+	prom_argc = (int)fw_arg0;
+	prom_argv = (char **)fw_arg1;
+	prom_envp = (char **)fw_arg2;
+
 	prom_init_cmdline();
 
 	/*
diff --git a/arch/mips/emma/et10121/platform.c b/arch/mips/emma/et10121/platform.c
index e6b3aef..daaf02b 100644
--- a/arch/mips/emma/et10121/platform.c
+++ b/arch/mips/emma/et10121/platform.c
@@ -30,6 +30,7 @@
 
 #include <asm/addrspace.h>
 #include <asm/emma/emmaxxx.h>
+#include <asm/emma/prom.h>
 #include <linux/nec_candy_pd.h>
 
 #define I2C_EMMA "emma-iic" /* must be in sync with IIC driver */
@@ -105,8 +106,6 @@ struct platform_device sata_emma_devices[] = {
 	}
 };
 
-#define EMMA3P_MAC_FLASH	0xbfe20000
-
 static struct nec_candy_platform_data nec_candy_pdata = {
 	.pmd_addr	= 0x1f,
 	.rmii		= 1,
@@ -223,12 +222,23 @@ static struct mtd_partition et10121_parts[] = {
 };
 #endif
 
+#define EMMA_MAC_FLASH	0xbfe20000
+
 static int __init platform_devices_setup(void)
 {
 #ifdef CONFIG_MTD
 	physmap_set_partitions(et10121_parts, ARRAY_SIZE(et10121_parts));
 #endif
-	memcpy(nec_candy_pdata.mac_addr, (void *) EMMA3P_MAC_FLASH, 6);
+
+	if (get_ethernet_addr(nec_candy_pdata.mac_addr)) {
+		/*
+		 * No 'ethaddr' string found in the environment variables.
+		 * Then finally try to copy bytes from the flash device
+		 * to maintain backward compatibility with earlier releases.
+		 */
+		memcpy(nec_candy_pdata.mac_addr, (void *)EMMA_MAC_FLASH, 6);
+	}
+
 	return platform_add_devices(devices, ARRAY_SIZE(devices));
 }
 
-- 
1.6.3.3

