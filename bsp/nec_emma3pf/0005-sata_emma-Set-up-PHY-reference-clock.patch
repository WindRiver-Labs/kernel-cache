From d39bb2772ac715c84e39dc00df71b5c0a8333509 Mon Sep 17 00:00:00 2001
From: Shinya Kuribayashi <shinya.kuribayashi@necel.com>
Date: Tue, 28 Apr 2009 14:31:48 +0900
Subject: [PATCH] sata_emma: Set up PHY reference clock

On EMMA3PF evaluation board (ET-MC10121), we need to set bit 15 in the
PHY setup register, to configure a reference clock properly.

This patch is board-specific at the moment.  We'll prepare an updated
patch to utilize 'platform_data' as a means to make the driver platform-
independent.

Signed-off-by: Shinya Kuribayashi <shinya.kuribayashi@necel.com>
---
 drivers/ata/sata_emma.c |   11 +++++++++++
 1 files changed, 11 insertions(+), 0 deletions(-)

diff --git a/drivers/ata/sata_emma.c b/drivers/ata/sata_emma.c
index 0665a23..589cc00 100644
--- a/drivers/ata/sata_emma.c
+++ b/drivers/ata/sata_emma.c
@@ -65,6 +65,9 @@
 #define EMMA_SATA_INT_OFFSET		0xb0
 #define EMMA_SATA_INT_EN_OFFSET		0xb4
 
+/* Phy Setup registers */
+#define EMMA_SATA_PHY_SETUP_OFFSET	0xbc
+
 /* emma specific registers */
 #define EMMA_SATA_BM_CTL_OFFSET		0x48
 #define EMMA_SATA_SCR_MISC_OFFSET	0xe0
@@ -425,6 +428,7 @@ static int emma_sata_init_one(struct platform_device *pdev)
 	struct ata_host *host;
 	void __iomem *mmio_base;
 	struct resource *r;
+	u32 tmp;
 
 	DPRINTK("emma_sata_init_one start\n");
 
@@ -453,6 +457,13 @@ static int emma_sata_init_one(struct platform_device *pdev)
 	/* endian/swap ctl */
 	writel(0x2, mmio_base + EMMA_SATA_BM_CTL_OFFSET);
 
+#ifdef CONFIG_NEC_ET10121
+	/* phy setup */
+	tmp = readl(mmio_base + EMMA_SATA_PHY_SETUP_OFFSET);
+	tmp |= 1UL << 15;
+	writel(tmp, mmio_base + EMMA_SATA_PHY_SETUP_OFFSET);
+#endif
+
 	/* staggered spin up for channel1-2 */
 	writel(0x10000, mmio_base + EMMA_SATA_SCR_MISC_OFFSET);
 
-- 
1.6.0.4

