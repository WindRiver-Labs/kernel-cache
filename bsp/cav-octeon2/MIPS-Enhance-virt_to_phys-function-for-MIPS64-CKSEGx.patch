From b67723e36c8a60bdaee623be6e87f892750a0311 Mon Sep 17 00:00:00 2001
From: Bin Jiang <bin.jiang@windriver.com>
Date: Wed, 29 May 2013 14:02:15 +0800
Subject: [PATCH] MIPS: Enhance virt_to_phys function for MIPS64 CKSEGx

For MIPS64, virt_to_phys function can only handle the virtual address in
XKPHYS, so take CKSEGx into consideration.

Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/include/asm/io.h |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/arch/mips/include/asm/io.h b/arch/mips/include/asm/io.h
index a58f229..b5ca8e6 100644
--- a/arch/mips/include/asm/io.h
+++ b/arch/mips/include/asm/io.h
@@ -116,6 +116,11 @@ static inline void set_io_port_base(unsigned long base)
  */
 static inline unsigned long virt_to_phys(volatile const void *address)
 {
+#ifdef CONFIG_64BIT
+	if((unsigned long)address >= CKSEG0)
+		return CPHYSADDR((unsigned long)address);
+#endif
+
 	return (unsigned long)address - PAGE_OFFSET + PHYS_OFFSET;
 }
 
-- 
1.7.5.4

