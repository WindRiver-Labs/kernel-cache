From c7b0c983f8e3f5eb7685c9521993ef2a24a081ea Mon Sep 17 00:00:00 2001
From: Yang Wei <Wei.Yang@windriver.com>
Date: Sat, 26 Jul 2014 13:11:47 +0800
Subject: [PATCH] mips/octeon2: expand kernel memory region to include
 kernel's BSS section

We should expand kernel memory region range from _text to _end, and then
the range from _text to _end would be considered as system memory by kernel,
otherwise, if loading the second kernel via kexec, it would run into
invalid memory segment. The root cause is that in order to load vmlinux
kernel, it needs to create memory segment, but the length of added memory
segment is defined by the memsz field of vmlinux program header, the length
is larger than the value of _text - _edata.

Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 arch/mips/cavium-octeon/setup.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index e093362..e27a871 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -1101,7 +1101,7 @@ void __init plat_mem_setup(void)
 
 	/* Add Kernel text/data memory region. */
 	memory = __pa_symbol(&_text);
-	mem_alloc_size = (__pa_symbol(&_edata)) - memory;
+	mem_alloc_size = PFN_ALIGN(__pa_symbol(&_end)) - memory;
 	if (mem_alloc_size > 0) {
 		add_memory_region(memory, mem_alloc_size, BOOT_MEM_RAM);
 		total += mem_alloc_size;
-- 
1.7.5.4

