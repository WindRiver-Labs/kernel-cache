From c43bf75e748a4d8580b9fb9ffe6220ed2976485a Mon Sep 17 00:00:00 2001
From: Bin Jiang <bin.jiang@windriver.com>
Date: Tue, 26 Mar 2013 16:03:49 +0800
Subject: [PATCH 06/17] MIPS: Octeon: fixed two warning message in irqdomain

1. The hwirq is DMA, it failed in "octeon_irq_ciu_to_irq[line][bit] != 0".
This condition should be used for GPIO, need more investigatation.

irq: irq-121==>hwirq-0x3f mapping failed: -22
------------[ cut here ]------------
WARNING: at linux/kernel/irq/irqdomain.c:444 irq_domain_associate_many+0x230/0x250()
Modules linked in:
Call Trace:
[<ffffffff80832068>] dump_stack+0x1c/0x50
[<ffffffff8017110c>] warn_slowpath_common+0x8c/0xc0
[<ffffffff8017116c>] warn_slowpath_null+0x2c/0x40
[<ffffffff80200b48>] irq_domain_associate_many+0x230/0x250
[<ffffffff80200c0c>] irq_create_mapping+0xa4/0x180
[<ffffffff80200d6c>] irq_create_of_mapping+0x84/0x190
[<ffffffff806cdf08>] irq_of_parse_and_map+0x50/0x68
[<ffffffff806cdf5c>] of_irq_to_resource+0x3c/0xe8
[<ffffffff806ce04c>] of_irq_count+0x44/0x68
[<ffffffff806ce91c>] of_device_alloc+0x8c/0x230
[<ffffffff806ceb10>] of_platform_device_create_pdata+0x50/0xe0
[<ffffffff806cece8>] of_platform_bus_create+0x148/0x210
[<ffffffff806ced48>] of_platform_bus_create+0x1a8/0x210
[<ffffffff806cee74>] of_platform_bus_probe+0xc4/0x108
[<ffffffff80a9d220>] octeon_publish_devices+0x24/0x38
[<ffffffff8010044c>] do_one_initcall+0x4c/0x180

2. GPIO irq is add to linear map, but the linear map size is 16, so failed.

ARNING: at linux/kernel/irq/irqdomain.c:743 irq_linear_revmap+0x68/0x70()
Modules linked in:
Call Trace:
[<ffffffff80831fe8>] dump_stack+0x1c/0x50
[<ffffffff8017108c>] warn_slowpath_common+0x8c/0xc0
[<ffffffff801710ec>] warn_slowpath_null+0x2c/0x40
[<ffffffff80200378>] irq_linear_revmap+0x68/0x70
[<ffffffff80200478>] irq_find_mapping+0xf8/0x168
[<ffffffff80200b2c>] irq_create_mapping+0x44/0x180
[<ffffffff80200cec>] irq_create_of_mapping+0x84/0x190
[<ffffffff806cde88>] irq_of_parse_and_map+0x50/0x68
[<ffffffff806cfc58>] of_mdiobus_register+0x1a0/0x288
[<ffffffff80820f58>] octeon_mdiobus_probe+0x188/0x214
[<ffffffff8059e0fc>] platform_drv_probe+0x2c/0x40
[<ffffffff8059c60c>] driver_probe_device+0x8c/0x230
[<ffffffff8059c898>] __driver_attach+0xe8/0xf0
[<ffffffff8059a3e0>] bus_for_each_dev+0x70/0xc8
[<ffffffff8059bfc4>] driver_attach+0x34/0x48
[<ffffffff8059ba88>] bus_add_driver+0x1e8/0x2d8
[<ffffffff8059ccfc>] driver_register+0xa4/0x198
[<ffffffff8059e47c>] platform_driver_register+0x6c/0x80
[<ffffffff80abbbe4>] octeon_mdiobus_driver_init+0x1c/0x30
[<ffffffff8010044c>] do_one_initcall+0x4c/0x180

Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/cavium-octeon/octeon-irq.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-irq.c b/arch/mips/cavium-octeon/octeon-irq.c
index 95b9d75..9b24432 100644
--- a/arch/mips/cavium-octeon/octeon-irq.c
+++ b/arch/mips/cavium-octeon/octeon-irq.c
@@ -1620,7 +1620,7 @@ static int octeon_irq_ciu2_map(struct irq_domain *d,
 		return -EINVAL;
 
 	/* Line 7  are the GPIO lines */
-	if (line > 6 || octeon_irq_ciu_to_irq[line][bit] != 0)
+	if (line > 6 )
 		return -EINVAL;
 
 	if (octeon_irq_ciu2_is_edge(line, bit))
@@ -1767,7 +1767,7 @@ static void __init octeon_irq_init_ciu2(void)
 		if (gpiod) {
 			/* gpio domain host_data is the base hwirq number. */
 			gpiod->base_hwirq = 7 << 6;
-			irq_domain_add_linear(gpio_node, 16, &octeon_irq_domain_ciu2_gpio_ops, gpiod);
+			irq_domain_add_linear(gpio_node, gpiod->base_hwirq+16, &octeon_irq_domain_ciu2_gpio_ops, gpiod);
 			of_node_put(gpio_node);
 		} else
 			pr_warning("Cannot allocate memory for GPIO irq_domain.\n");
-- 
1.7.5.4

