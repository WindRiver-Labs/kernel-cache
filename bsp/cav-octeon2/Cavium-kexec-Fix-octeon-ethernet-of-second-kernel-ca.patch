From e56b4309f7c6535f903154fe64462dc0dc112923 Mon Sep 17 00:00:00 2001
From: Bin Jiang <bin.jiang@windriver.com>
Date: Tue, 16 Apr 2013 18:20:03 +0800
Subject: [PATCH 14/17] Cavium: kexec: Fix octeon ethernet of second kernel
 can't start.

The octeon ethernet can't start when boot secondary kernel, since
the resources of octeon ethernet is not released.

Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 .../executive/cvmx-global-resources.c              |   21 ++++++++++++++++++++
 arch/mips/cavium-octeon/executive/cvmx-range.c     |    9 ++++++++
 drivers/net/ethernet/octeon/octeon-kexec-net.c     |    5 ++++
 3 files changed, 35 insertions(+), 0 deletions(-)

diff --git a/arch/mips/cavium-octeon/executive/cvmx-global-resources.c b/arch/mips/cavium-octeon/executive/cvmx-global-resources.c
index d707c47..1752075 100644
--- a/arch/mips/cavium-octeon/executive/cvmx-global-resources.c
+++ b/arch/mips/cavium-octeon/executive/cvmx-global-resources.c
@@ -521,3 +521,24 @@ void cvmx_global_resources_show(void)
 
 }
 EXPORT_SYMBOL(free_global_resources);
+
+void cvmx_range_cleanup(uint64_t range_addr);
+void cvmx_resource_cleanup(struct global_resource_tag tag)
+{
+	uint64_t range_addr = cvmx_get_global_resource(tag, 1);
+	if (range_addr == 0) {
+		char tagname[256];
+		 __cvmx_get_tagname(&tag, tagname);
+		 cvmx_dprintf("ERROR: cannot find resource %s\n", tagname);
+	}
+	__cvmx_global_resource_lock();
+	cvmx_range_cleanup(range_addr);
+	 __cvmx_global_resource_unlock();
+}
+void octeon_ethernet_resource_cleanup(void)
+{
+	cvmx_resource_cleanup(CVMX_GR_TAG_PKO_QUEUES);
+	cvmx_resource_cleanup(CVMX_GR_TAG_PKO_IPORTS);
+	cvmx_resource_cleanup(CVMX_GR_TAG_FPA);
+}
+EXPORT_SYMBOL(octeon_ethernet_resource_cleanup);
diff --git a/arch/mips/cavium-octeon/executive/cvmx-range.c b/arch/mips/cavium-octeon/executive/cvmx-range.c
index 9eb1eb2..cac5da2 100644
--- a/arch/mips/cavium-octeon/executive/cvmx-range.c
+++ b/arch/mips/cavium-octeon/executive/cvmx-range.c
@@ -194,3 +194,12 @@ void cvmx_range_show (uint64_t range_addr)
 	}
 	cvmx_dprintf ("i=%d : %d \n", (int) pindex, (int)pval);
 }
+
+void cvmx_range_cleanup(uint64_t range_addr)
+{
+	uint64_t size, i;
+	size = cvmx_read64_uint64(addr_of_size(range_addr));
+	for (i = 0; i < size; i++) {
+		cvmx_write64_uint64(addr_of_element(range_addr, i), CVMX_RANGE_AVAILABLE);
+	}
+}
diff --git a/drivers/net/ethernet/octeon/octeon-kexec-net.c b/drivers/net/ethernet/octeon/octeon-kexec-net.c
index 72225ae..205c1cd 100644
--- a/drivers/net/ethernet/octeon/octeon-kexec-net.c
+++ b/drivers/net/ethernet/octeon/octeon-kexec-net.c
@@ -14,7 +14,9 @@
 #include <asm/octeon/cvmx-pow.h>
 #include <asm/octeon/cvmx-asxx-defs.h>
 #include <asm/octeon/cvmx-gmxx-defs.h>
+#include <asm/octeon/cvmx-global-resources.h>
 
+void octeon_ethernet_resource_cleanup(void);
 void octeon_shutdown_network_hw(void)
 {
 	cvmx_wqe_t *work = NULL;
@@ -108,4 +110,7 @@ void octeon_shutdown_network_hw(void)
 
 	/* free the cvmx_cmd_queues from bootmemory */
 	cvmx_bootmem_free_named("cvmx_cmd_queues");
+
+	/* Cleanup octeon ethernet resources */
+	octeon_ethernet_resource_cleanup();
 }
-- 
1.7.5.4

