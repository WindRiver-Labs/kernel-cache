From 9e3d543222bf850a055b34a5980ca62bbac1b99d Mon Sep 17 00:00:00 2001
From: Yang Wei <Wei.Yang@windriver.com>
Date: Thu, 14 Aug 2014 12:27:42 +0800
Subject: [PATCH] fs/binfmt: Invoking SET_PERSONALITY prior to setting
 pax_task_size

Since TASK_SIZE also depend on the personality, so we
need invoke SET_PERSONALITY prior to setting pax_task_size

Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 fs/binfmt_elf.c |   12 +++++++-----
 1 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/fs/binfmt_elf.c b/fs/binfmt_elf.c
index a83f688..e4924edf 100644
--- a/fs/binfmt_elf.c
+++ b/fs/binfmt_elf.c
@@ -948,7 +948,7 @@ static int load_elf_binary(struct linux_binprm *bprm, struct pt_regs *regs)
 		struct elfhdr elf_ex;
 		struct elfhdr interp_elf_ex;
 	} *loc;
-	unsigned long pax_task_size = TASK_SIZE;
+	unsigned long pax_task_size = 0;
 
 	loc = kmalloc(sizeof(*loc), GFP_KERNEL);
 	if (!loc) {
@@ -1125,6 +1125,12 @@ static int load_elf_binary(struct linux_binprm *bprm, struct pt_regs *regs)
 	}
 #endif
 
+	/* Do this immediately, since TASK_SIZE and STACK_TOP as used
+	 * in setup_arg_pages may depend on the personality.  */
+	SET_PERSONALITY(loc->elf_ex);
+
+	pax_task_size = TASK_SIZE;
+
 #ifdef CONFIG_PAX_SEGMEXEC
 	if (current->mm->pax_flags & MF_PAX_SEGMEXEC) {
 		current->mm->context.user_cs_base = SEGMEXEC_TASK_SIZE;
@@ -1141,10 +1147,6 @@ static int load_elf_binary(struct linux_binprm *bprm, struct pt_regs *regs)
 	}
 #endif
 
-	/* Do this immediately, since STACK_TOP as used in setup_arg_pages
-	   may depend on the personality.  */
-	SET_PERSONALITY(loc->elf_ex);
-
 #ifdef CONFIG_PAX_ASLR
 	if (current->mm->pax_flags & MF_PAX_RANDMMAP) {
 		current->mm->delta_mmap = (pax_get_random_long() & ((1UL << PAX_DELTA_MMAP_LEN)-1)) << PAGE_SHIFT;
-- 
1.7.5.4

