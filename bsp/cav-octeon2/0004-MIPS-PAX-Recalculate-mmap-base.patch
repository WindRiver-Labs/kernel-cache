From 2d71f7f7655ba62bd5384d3799a90521af8262b4 Mon Sep 17 00:00:00 2001
From: Bin Jiang <bin.jiang@windriver.com>
Date: Thu, 2 May 2013 15:53:43 +0800
Subject: [PATCH] MIPS: PAX: Recalculate mmap base

PAX ASLR may randomize the top of the task's userland stack and the base
address for mmap() requests. So the mmap base should be recalculated.

source: http://grsecurity.net/test/grsecurity-2.9.1-3.8.11-201305011917.patch

Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/mips/mm/mmap.c |   12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/arch/mips/mm/mmap.c b/arch/mips/mm/mmap.c
index a451234..267ff59 100644
--- a/arch/mips/mm/mmap.c
+++ b/arch/mips/mm/mmap.c
@@ -238,10 +238,22 @@ void arch_pick_mmap_layout(struct mm_struct *mm)
 
 	if (mmap_is_legacy()) {
 		mm->mmap_base = TASK_UNMAPPED_BASE + random_factor;
+
+#ifdef CONFIG_PAX_RANDMMAP
+	if (mm->pax_flags & MF_PAX_RANDMMAP)
+		mm->mmap_base += mm->delta_mmap;
+#endif
+
 		mm->get_unmapped_area = arch_get_unmapped_area;
 		mm->unmap_area = arch_unmap_area;
 	} else {
 		mm->mmap_base = mmap_base(random_factor);
+
+#ifdef CONFIG_PAX_RANDMMAP
+	if (mm->pax_flags & MF_PAX_RANDMMAP)
+		mm->mmap_base -= mm->delta_mmap + mm->delta_stack;
+#endif
+
 		mm->get_unmapped_area = arch_get_unmapped_area_topdown;
 		mm->unmap_area = arch_unmap_area_topdown;
 	}
-- 
1.7.10.4

