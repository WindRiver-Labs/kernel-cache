From 9cccd361a2143a613e7d18ce0ac60f8f008d49c7 Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Wed, 24 Aug 2011 11:50:34 +0800
Subject: [PATCH 1/6] intel_xeon_core_dh89xx_pch: add DH8900CC Series Gigabit Ethernet support

add DH8900CC Series Gigabit Ethernet support

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 drivers/net/igb/igb_main.c      |   27 +++++++++++++++++++++++++++
 5 files changed, 39 insertions(+), 0 deletions(-)

--- a/drivers/net/igb/igb_main.c
+++ b/drivers/net/igb/igb_main.c
@@ -8967,6 +8967,13 @@ static int igb_suspend(struct pci_dev *pdev, pm_message_t state)
 #ifdef HAVE_SYSTEM_SLEEP_PM_OPS
 	struct pci_dev *pdev = to_pci_dev(dev);
 #endif /* HAVE_SYSTEM_SLEEP_PM_OPS */
+#define E1000_PMCSR       0x0044
+#define E1000_PMCSR_PS_D3 0x00000003
+	struct net_device *netdev = NULL;
+	struct igb_adapter *adapter = NULL; 
+	struct e1000_hw *hw = NULL;
+	u32 pmcsr = 0;
+
 	int retval;
 	bool wake;
 
@@ -8981,6 +8988,25 @@ static int igb_suspend(struct pci_dev *pdev, pm_message_t state)
 		pci_set_power_state(pdev, PCI_D3hot);
 	}
 
+	/* This is WoL workaround for DH89xxCC */
+	switch (pdev->device) {
+		case E1000_DEV_ID_DH89XXCC_SFP:
+		case E1000_DEV_ID_DH89XXCC_BACKPLANE:
+		case E1000_DEV_ID_DH89XXCC_SERDES:
+		case E1000_DEV_ID_DH89XXCC_SGMII:
+			netdev = pci_get_drvdata(pdev);
+			adapter = netdev_priv(netdev);
+			hw = &adapter->hw;
+			pmcsr = E1000_READ_REG(hw, E1000_PMCSR);
+			pmcsr |= E1000_PMCSR_PS_D3;
+			E1000_WRITE_REG(hw, E1000_PMCSR, pmcsr);
+			E1000_WRITE_REG(hw, E1000_PMCSR, pmcsr);
+			break;
+		default:
+			break;
+	}
+
+
 	return 0;
 }
 
-- 
1.6.3.1

