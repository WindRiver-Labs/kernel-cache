From e9e7cfc5b8ca713f57dd618e8d2df1ea35fec906 Mon Sep 17 00:00:00 2001
From: Hui Wang <Hui.Wang@windriver.com>
Date: Fri, 2 Dec 2011 18:29:19 +0800
Subject: [PATCH] drivers/net/ixgbe: add a flag to ignore eeprom checksum error

Some 82599 ethernet cards have been reported to have an uncorrect
eeprom checksum, this will make the ixgbe driver probe process fail.

If except eeprom checksum, other content in the eeprom is right, we
can let the driver to ignore the checksum validation error, in this
situation, the driver and the card can still work well.

To implement this idea, we add a flag for whether ignore checksum
error, this flag is set to false by default, users can set a bootarg
to enable this flag.

Signed-off-by: Hui Wang <Hui.Wang@windriver.com>
---
 Documentation/kernel-parameters.txt |    4 ++++
 drivers/net/ixgbe/ixgbe_main.c      |   26 ++++++++++++++++++++++++--
 2 files changed, 28 insertions(+), 2 deletions(-)

diff --git a/Documentation/kernel-parameters.txt b/Documentation/kernel-parameters.txt
index e9ec52d..4c90199 100644
--- a/Documentation/kernel-parameters.txt
+++ b/Documentation/kernel-parameters.txt
@@ -2887,6 +2887,10 @@ and is between 256 and 4096 characters. It is defined in the file
 			Format:
 			<irq>,<irq_mask>,<io>,<full_duplex>,<do_sound>,<lockup_hack>[,<irq2>[,<irq3>[,<irq4>]]]
 
+	ixgbe_ignore_ecv_err
+			[HW,NET,IXGBE] Set this bootarg will let ixgbe driver to ignore net card EEPROM checksum
+			validation error.
+
 ______________________________________________________________________
 
 TODO:
diff --git a/drivers/net/ixgbe/ixgbe_main.c b/drivers/net/ixgbe/ixgbe_main.c
index 9e90d37..004caff 100644
--- a/drivers/net/ixgbe/ixgbe_main.c
+++ b/drivers/net/ixgbe/ixgbe_main.c
@@ -127,6 +127,13 @@ MODULE_VERSION(DRV_VERSION);
 
 #define DEFAULT_DEBUG_LEVEL_SHIFT 3
 
+/* flag of ignoring eeprom checksum validation error */
+static int ixgbe_ignore_ecv_err;
+
+#ifdef MODULE
+module_param(ixgbe_ignore_ecv_err, int, 0);
+#endif
+
 static inline void ixgbe_disable_sriov(struct ixgbe_adapter *adapter)
 {
 	struct ixgbe_hw *hw = &adapter->hw;
@@ -8265,8 +8272,14 @@ static int __devinit ixgbe_probe(struct pci_dev *pdev,
 	if (hw->eeprom.ops.validate_checksum &&
 	    (hw->eeprom.ops.validate_checksum(hw, NULL) < 0)) {
 		DPRINTK(PROBE, ERR, "The EEPROM Checksum Is Not Valid\n");
-		err = -EIO;
-		goto err_sw_init;
+		if (!ixgbe_ignore_ecv_err) {
+			DPRINTK(PROBE, ERR, "Passing ixgbe_ignore_ecv_err in the bootargs "
+				"can ignore this error and continue the probe process.\n");
+			err = -EIO;
+			goto err_sw_init;
+		}
+		DPRINTK(PROBE, WARNING, "You passed a ixgbe_ignore_ecv_err in the bootargs "
+			"to skip this checksum error.\n");
 	}
 
 	memcpy(netdev->dev_addr, hw->mac.perm_addr, netdev->addr_len);
@@ -8650,6 +8663,15 @@ bool ixgbe_is_ixgbe(struct pci_dev *pcidev)
 		return true;
 }
 
+#ifndef MODULE
+static int __init ixgbe_ignore_eeprom_checksum_val_err(char *str)
+{
+	ixgbe_ignore_ecv_err = 1;
+	return 0;
+}
+early_param("ixgbe_ignore_ecv_err", ixgbe_ignore_eeprom_checksum_val_err);
+#endif
+
 /**
  * ixgbe_init_module - Driver Registration Routine
  *
-- 
1.6.3.1

