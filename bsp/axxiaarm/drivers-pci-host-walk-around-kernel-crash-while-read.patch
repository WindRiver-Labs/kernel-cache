From c0e72bc38258f44533cfe291fdd1536d963cff99 Mon Sep 17 00:00:00 2001
From: Qi Hou <qi.hou@windriver.com>
Date: Sat, 8 Oct 2016 17:34:22 +0800
Subject: [PATCH] drivers/pci/host: walk around kernel crash while reading PCI
 config space

While reading PCI config space, kernel crashed.

Kernel panic info is below:
root@axxiaarm:~# cat /proc/bus/pci/00/00.0
cat /proc/bus/pci/00/00.0
[ 1139.645469] Unhandled fault: asynchronous external abort (0x1211) at 0x00000000
[ 1142.126454] [<c09aa0d4>] axxia_pciex_read_config
[ 1142.243143] [<c098da80>] pci_user_read_config_dword
[ 1142.354620] [<c099e62c>] proc_bus_pci_read
[ 1142.451513] [<c063c730>] proc_reg_read
[ 1142.540072] [<c05d3040>] vfs_read
[ 1142.622385] [<c05d39c8>] SyS_read
[ 1142.711982] Code: e5953000 f57ff04f e3570001 0a000012 (e3570002)
[ 1142.784939] ---[ end trace 081b9318a7043f44 ]---
[ 1142.840164] Kernel panic - not syncing: Fatal exception

After investigation, found that as the reading offset in pci config space
reached to 0x5C, the kernel crashed.

Referring to axm55xx.dtsi, we can figure out that the memory-mapped address
of the register whose offset is 0x5C in PCI config space is 0x20_2012_005C.
But referring to AXX5500 reference manual, there is no description about
that register, nor these registers whose addresses range from 0x20_2012_0048
to 0x20_2012_005c.

This issue will not happen if AXXIA_RIO is enabled. When AXXIA_RIO enabled,
a function named "axxia_rio_fault" will be registered to intercept SRIO bus
fault due to unimplemented register location.

Since AXXIA_RIO depends on APIDIO, both of APIDIO and AXXIA_RIO are selected
under the menu "config PCI_AXXIA".

Signed-off-by: Qi Hou <qi.hou@windriver.com>
---
 drivers/pci/host/Kconfig |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/pci/host/Kconfig b/drivers/pci/host/Kconfig
index 3484e10..d1abc90 100644
--- a/drivers/pci/host/Kconfig
+++ b/drivers/pci/host/Kconfig
@@ -5,6 +5,8 @@ config PCI_AXXIA
 	bool "AXXIA PCIe controller"
 	depends on ARCH_AXXIA && !ARM64
 	default ARCH_AXXIA
+	select RAPIDIO
+	select AXXIA_RIO
 	help
 	 Enables support for the Axxia X7 PCIe controller.
 	 There are two PEI controllers on X7. Only RootComplex
-- 
1.7.5.4

