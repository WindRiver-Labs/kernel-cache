From 7f00af27db2e5fd2d0d22a1cb8fce2ef76114292 Mon Sep 17 00:00:00 2001
From: Quanyang Wang <quanyang.wang@windriver.com>
Date: Sat, 25 Jun 2016 02:23:16 +0000
Subject: [PATCH] drivers/pci/host: redefine axxia_is_x9 to avoid using
 ioremap

Move ioremap from axxia_is_x9 to initialization of pci driver to avoid
that ioremap is called by pci_bus_read_config_dword which runs in
irq-disabled environment. Or else it will occur the error as below:

------------[ cut here ]------------
WARNING: CPU: 1 PID: 1 at kernel/locking/lockdep.c:2755 lockdep_trace_alloc+0x124/0x128()
DEBUG_LOCKS_WARN_ON(irqs_disabled_flags(flags))
Modules linked in:
CPU: 1 PID: 1 Comm: swapper/0 Not tainted 4.1.21-WR8.0.0.0_standard #28
Hardware name: AXM56xx Simulator (DT)
Call trace:
[<ffffffc00008a9a0>] dump_backtrace+0x0/0x128
[<ffffffc00008aaec>] show_stack+0x24/0x30
[<ffffffc0006e5dfc>] dump_stack+0xa8/0xe0
[<ffffffc0000c13dc>] warn_slowpath_common+0xa4/0xe0
[<ffffffc0000c147c>] warn_slowpath_fmt+0x64/0x78
[<ffffffc000116064>] lockdep_trace_alloc+0x124/0x128
[<ffffffc00020f2b0>] kmem_cache_alloc_trace+0x48/0x4c8
[<ffffffc0001f4f40>] __get_vm_area_node.isra.12+0x80/0x1a8
[<ffffffc0001f52c4>] get_vm_area_caller+0x4c/0x60
[<ffffffc000097b50>] __ioremap_caller+0x78/0xf8
[<ffffffc000097c0c>] __ioremap+0x3c/0x50
[<ffffffc00041ba3c>] axxia_pcie_prog_viewport_cfg0+0x5c/0xf8
[<ffffffc00041c504>] axxia_pciex_read_config+0x12c/0x158
[<ffffffc0003fd944>] pci_bus_read_config_dword+0x84/0xb8
[<ffffffc0003fff20>] pci_bus_read_dev_vendor_id+0x40/0x118
[<ffffffc000401864>] pci_scan_single_device+0x64/0xd8
[<ffffffc00040192c>] pci_scan_slot+0x54/0x118
[<ffffffc0004028d0>] pci_scan_child_bus+0x38/0xe0
[<ffffffc00040255c>] pci_scan_bridge+0x1e4/0x520
[<ffffffc00040292c>] pci_scan_child_bus+0x94/0xe0
[<ffffffc0009ad2ac>] axxia_pcie_host_init+0x3e8/0x438
[<ffffffc0009ad3c0>] axxia_pcie_probe+0xc4/0xfc
[<ffffffc0004bd03c>] platform_drv_probe+0x54/0xc0
[<ffffffc0004ba7a0>] driver_probe_device+0x1b0/0x2d0
[<ffffffc0004ba9d4>] __driver_attach+0xb4/0xb8
[<ffffffc0004b8768>] bus_for_each_dev+0x70/0xb0
[<ffffffc0004ba100>] driver_attach+0x30/0x40
[<ffffffc0004b9d18>] bus_add_driver+0x160/0x218
[<ffffffc0004bba60>] driver_register+0x68/0x128
[<ffffffc0004bcf50>] __platform_driver_register+0x70/0x80
[<ffffffc0004bd118>] __platform_driver_probe+0x40/0xe0
[<ffffffc0009acebc>] pcie_init+0x20/0x28
[<ffffffc0000842f4>] do_one_initcall+0x94/0x1b8
[<ffffffc000985ad4>] kernel_init_freeable+0x144/0x218
[<ffffffc0006e16b8>] kernel_init+0x20/0xe8
---[ end trace d627072344895f43 ]---

Signed-off-by: Quanyang Wang <quanyang.wang@windriver.com>
---
 drivers/pci/host/pcie-axxia.c |   10 +++++++---
 1 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/drivers/pci/host/pcie-axxia.c b/drivers/pci/host/pcie-axxia.c
index 28d4ccc..d1d68dd 100644
--- a/drivers/pci/host/pcie-axxia.c
+++ b/drivers/pci/host/pcie-axxia.c
@@ -100,6 +100,7 @@
 
 /* SYSCON */
 #define AXXIA_SYSCON_BASE             0x8002C00000
+static void __iomem *axxiaarm_syscon_base;
 
 static inline uint32_t axxia_mmio_read_32(uintptr_t addr)
 {
@@ -110,10 +111,8 @@ int
 axxia_is_x9(void)
 {
 	unsigned int pfuse;
-	static void __iomem *base;
 
-	base = ioremap(AXXIA_SYSCON_BASE, 0x1024);
-	pfuse = axxia_mmio_read_32((uintptr_t)(base + 0x34));
+	pfuse = axxia_mmio_read_32((uintptr_t)(axxiaarm_syscon_base + 0x34));
 	return (0xb == (pfuse & 0x1f));
 }
 
@@ -741,6 +740,11 @@ int __init axxia_pcie_host_init(struct pcie_port *pp)
 	LIST_HEAD(res);
 	int i;
 
+	axxiaarm_syscon_base = ioremap(AXXIA_SYSCON_BASE, 0x1024);
+	if (axxiaarm_syscon_base == NULL) {
+		dev_err(pp->dev, "ioremap axxiaarm_syscon_base error!\n");
+		return -EINVAL;
+	}
 	/* Find the address cell size and the number of cells in order to get
 	 * the untranslated address.
 	 */
-- 
1.7.5.4

