From f9be4b657792e07952564fe839f2678800eb27da Mon Sep 17 00:00:00 2001
From: Fredrik Markstrom <fredrik.markstrom@gmail.com>
Date: Thu, 2 Jun 2016 14:58:54 +0200
Subject: [PATCH] ARM: probes: Make sure to trace hardirqs_on when returning
 from jprobes

This fixes the following:

 [   33.416532] WARNING: CPU: 1 PID: 1 at kernel/locking/lockdep.c:3561 check_flags.part.15+0x114/0x13c()
 [   33.416541] DEBUG_LOCKS_WARN_ON(!current->hardirqs_enabled)
 [   33.416545] Modules linked in:
 [   33.416555] CPU: 1 PID: 1 Comm: swapper/0 Not tainted 4.1.15-rt13-wrl800.1_1.21_1p7-03560-g3c8d9a90-dirty #198
 [   33.416558] Hardware name: LSI Axxia
 [   33.416574] [<c041bca8>] (unwind_backtrace) from [<c0415aa8>] (show_stack+0x20/0x24)
 [   33.416589] [<c0415aa8>] (show_stack) from [<c0e3d1a0>] (dump_stack+0x8c/0xa0)
 [   33.416602] [<c0e3d1a0>] (dump_stack) from [<c0434e84>] (warn_slowpath_common+0x94/0xc4)
 [   33.416612] [<c0434e84>] (warn_slowpath_common) from [<c0434ef4>] (warn_slowpath_fmt+0x40/0x48)
 [   33.416622] [<c0434ef4>] (warn_slowpath_fmt) from [<c049310c>] (check_flags.part.15+0x114/0x13c)
 [   33.416631] [<c049310c>] (check_flags.part.15) from [<c0497228>] (lock_acquire+0x234/0x394)
 [   33.416645] [<c0497228>] (lock_acquire) from [<c0e47030>] (_mutex_lock+0x40/0x50)
 [   33.416659] [<c0e47030>] (_mutex_lock) from [<c050b254>] (unregister_jprobes.part.4+0x28/0xb0)
 [   33.416671] [<c050b254>] (unregister_jprobes.part.4) from [<c050b32c>] (unregister_jprobe+0x2c/0x34)
 [   33.416681] [<c050b32c>] (unregister_jprobe) from [<c05044fc>] (init_test_probes+0x1b4/0x590)
 [   33.416693] [<c05044fc>] (init_test_probes) from [<c1220c60>] (init_kprobes+0x174/0x194)
 [   33.416702] [<c1220c60>] (init_kprobes) from [<c0409b98>] (do_one_initcall+0xd4/0x22c)
 [   33.416716] [<c0409b98>] (do_one_initcall) from [<c120d0a4>] (kernel_init_freeable+0x2a0/0x374)
 [   33.416727] [<c120d0a4>] (kernel_init_freeable) from [<c0e384a8>] (kernel_init+0x1c/0xf8)
 [   33.416736] [<c0e384a8>] (kernel_init) from [<c0410c58>] (ret_from_fork+0x14/0x3c)
 [   33.416740] ---[ end trace 0000000000000001 ]---
 [   33.416743] possible reason: unannotated irqs-on.
 [   33.416748] irq event stamp: 932512
 [   33.416758] hardirqs last  enabled at (932511): [<c0e46928>] _raw_spin_unlock_irq+0x34/0x78
 [   33.416768] hardirqs last disabled at (932512): [<c0e47734>] __und_svc+0x34/0x48
 [   33.416779] softirqs last  enabled at (0): [<c04323d0>] copy_process.part.5+0x3f4/0x19fc
 [   33.416786] softirqs last disabled at (0): [<  (null)>]   (null)

Signed-off-by: Fredrik Markstrom <fredrik.markstrom@gmail.com>
Signed-off-by: Zhenbo Gao <zhenbo.gao@windriver.com>
---
 arch/arm/probes/kprobes/core.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/arch/arm/probes/kprobes/core.c b/arch/arm/probes/kprobes/core.c
index a4ec240..cbc8890 100644
--- a/arch/arm/probes/kprobes/core.c
+++ b/arch/arm/probes/kprobes/core.c
@@ -600,6 +600,9 @@ int __kprobes longjmp_break_handler(struct kprobe *p, struct pt_regs *regs)
 		memcpy((void *)stack_addr, kcb->jprobes_stack,
 		       MIN_STACK_SIZE(stack_addr));
 		preempt_enable_no_resched();
+
+		if (!(regs->ARM_cpsr & PSR_I_BIT))
+			trace_hardirqs_on();
 		return 1;
 	}
 	return 0;
-- 
1.7.5.4

