From ada2fdc88d8ff75e7acec19b64318610bfd51e7c Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Tue, 16 Dec 2008 19:07:04 +0800
Subject: [PATCH] rmi xlr mm init and mm build support

RMI XLR can use 1GB low memory as its DMA zone.

XLR 32-bit kernel using highmem, max_mapnr need a correction.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/mm/Makefile |    3 +++
 arch/mips/mm/init.c   |   14 ++++++++++++++
 2 files changed, 17 insertions(+), 0 deletions(-)

diff --git a/arch/mips/mm/Makefile b/arch/mips/mm/Makefile
index 44e8dd8..e41c424 100644
--- a/arch/mips/mm/Makefile
+++ b/arch/mips/mm/Makefile
@@ -27,6 +27,9 @@ obj-$(CONFIG_CPU_TX39XX)	+= c-tx39.o tlb-r3k.o
 obj-$(CONFIG_CPU_TX49XX)	+= c-r4k.o cex-gen.o tlb-r4k.o
 obj-$(CONFIG_CPU_VR41XX)	+= c-r4k.o cex-gen.o tlb-r4k.o
 
+obj-$(CONFIG_CPU_PHOENIX)	+= c-phoenix.o tlb-r4k.o \
+							cex-gen.o cerr-phoenix.o 
+
 obj-$(CONFIG_IP22_CPU_SCACHE)	+= sc-ip22.o
 obj-$(CONFIG_R5000_CPU_SCACHE)  += sc-r5k.o
 obj-$(CONFIG_RM7000_CPU_SCACHE)	+= sc-rm7k.o
diff --git a/arch/mips/mm/init.c b/arch/mips/mm/init.c
index 137c14b..1426be8 100644
--- a/arch/mips/mm/init.c
+++ b/arch/mips/mm/init.c
@@ -342,6 +342,12 @@ static int __init page_is_ram(unsigned long pagenr)
 	return 0;
 }
 
+#if defined (CONFIG_RMI_PHOENIX) && defined (CONFIG_64BIT)
+/* This is to restrict the DMA zone to < 1GB */
+#define XLR_MAX_DMA_ADDRESS (1024UL << 20)
+#define XLR_MAX_DMA_PFN (XLR_MAX_DMA_ADDRESS >> PAGE_SHIFT)
+#endif
+
 void __init paging_init(void)
 {
 	unsigned long max_zone_pfns[MAX_NR_ZONES];
@@ -355,8 +361,12 @@ void __init paging_init(void)
 	kmap_coherent_init();
 
 #ifdef CONFIG_ZONE_DMA
+#ifdef CONFIG_RMI_PHOENIX
+    max_zone_pfns[ZONE_DMA] = XLR_MAX_DMA_PFN;
+#else
 	max_zone_pfns[ZONE_DMA] = MAX_DMA_PFN;
 #endif
+#endif
 #ifdef CONFIG_ZONE_DMA32
 	max_zone_pfns[ZONE_DMA32] = MAX_DMA32_PFN;
 #endif
@@ -393,6 +403,10 @@ void __init mem_init(void)
 #error "CONFIG_HIGHMEM and CONFIG_DISCONTIGMEM dont work together yet"
 #endif
 	max_mapnr = highend_pfn;
+#ifdef CONFIG_RMI_PHOENIX
+	if(max_mapnr == 0) /* No highmem available */
+		max_mapnr = max_low_pfn;
+#endif
 #else
 	max_mapnr = max_low_pfn;
 #endif
-- 
1.6.0.2.GIT

