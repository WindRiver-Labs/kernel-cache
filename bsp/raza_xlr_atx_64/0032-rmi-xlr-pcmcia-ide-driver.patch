From 9d08cd61ba6d519657e552679fda98d72232983a Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Wed, 17 Dec 2008 19:04:14 +0800
Subject: [PATCH] rmi xlr pcmcia ide driver

RMI XLR PCMCIA IDE driver (CF card).

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 drivers/ide/Kconfig            |    5 ++
 drivers/ide/mips/Makefile      |    1 +
 drivers/ide/mips/phoenix_ide.c |  143 ++++++++++++++++++++++++++++++++++++++++
 3 files changed, 149 insertions(+), 0 deletions(-)
 create mode 100644 drivers/ide/mips/phoenix_ide.c

diff --git a/drivers/ide/Kconfig b/drivers/ide/Kconfig
index 052879a..24ad2b5 100644
--- a/drivers/ide/Kconfig
+++ b/drivers/ide/Kconfig
@@ -783,6 +783,11 @@ config BLK_DEV_IDEDMA_PMAC
 config BLK_DEV_IDE_AU1XXX
        bool "IDE for AMD Alchemy Au1200"
        depends on SOC_AU1200
+
+config BLK_DEV_IDE_PHOENIX
+	bool "PCMCIA IDE for RMI XLR eval boards"
+	depends on RMI_PHOENIX 
+
 choice
        prompt "IDE Mode for AMD Alchemy Au1200"
        default CONFIG_BLK_DEV_IDE_AU1XXX_PIO_DBDMA
diff --git a/drivers/ide/mips/Makefile b/drivers/ide/mips/Makefile
index 5873fa0..7c67375 100644
--- a/drivers/ide/mips/Makefile
+++ b/drivers/ide/mips/Makefile
@@ -1,3 +1,4 @@
 obj-$(CONFIG_BLK_DEV_IDE_AU1XXX)	+= au1xxx-ide.o
+obj-$(CONFIG_BLK_DEV_IDE_PHOENIX)  += phoenix_ide.o
 
 EXTRA_CFLAGS    := -Idrivers/ide
diff --git a/drivers/ide/mips/phoenix_ide.c b/drivers/ide/mips/phoenix_ide.c
new file mode 100644
index 0000000..98e760a
--- /dev/null
+++ b/drivers/ide/mips/phoenix_ide.c
@@ -0,0 +1,143 @@
+/*
+ *  Copyright 2008 Wind River Systems, Inc. 
+ *
+ *  Author: Jack Tan <jack.tan@windriver.com>
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+ */
+
+#include <linux/kernel.h>
+#include <linux/ide.h>
+#include <linux/platform_device.h>
+
+#include <asm/rmi/phoenix_ide.h>
+#include <asm/rmi/64bit.h>
+#include <asm/rmi/pic.h>
+#include <asm/rmi/iomap.h>
+#include <asm/rmi/sim.h>
+
+#define DRV_NAME "ide-phoenix"
+
+static char phoenix_ide_string[] = DRV_NAME;
+
+static struct platform_device *phoenix_ide_dev;
+
+static const struct ide_port_info phoenix_port_info = {
+	.name = DRV_NAME,
+	.host_flags = IDE_HFLAG_MMIO | IDE_HFLAG_NO_DMA,
+};
+
+int __devinit phoenix_ide_probe(struct device *dev) 
+{	
+#if defined(PHOENIX_HAVE_IDE) && defined(IDE_PHYS)
+    unsigned int i = 0, rc;
+	struct ide_host *host;
+	unsigned long base;
+	hw_regs_t hw, *hws[] = {&hw, NULL, NULL, NULL};
+
+    if (xlr_board_atx_iii() || xlr_board_atx_v()) {
+        printk("Skipping PCMCIA Interface Probe.\n");
+		return 0;
+    }
+
+	printk ("Initializing Phoenix PCMCIA IDE...\n");
+
+	base = CKSEG1ADDR(IDE_PHYS);
+
+	memset(&hw, 0, sizeof(hw));
+	for (i = 0; i <= 7; i++)
+		hw.io_ports_array[i] =
+			(unsigned long)(base + (0x1f0 + i));
+	hw.io_ports.ctl_addr =
+		(unsigned long)(base + 0x3f6);
+	hw.irq = PIC_PCMCIA_IRQ;
+	hw.chipset = ide_generic;
+
+	rc = ide_host_add(&phoenix_port_info, hws, &host);
+	if (rc)
+		return rc;
+
+	dev_set_drvdata(dev, host);
+
+	return 0;
+#endif
+}
+
+static struct device_driver phoenix_ide_driver = {
+	.name	= phoenix_ide_string,
+	.bus	= &platform_bus_type,
+	.probe	= phoenix_ide_probe,
+};
+
+static void phoenix_ide_platform_release(struct device *device)
+{
+	struct platform_device *pldev;
+
+	/* free device */
+	pldev = to_platform_device(device);
+	kfree(pldev);
+}
+
+static int __devinit phoenix_ide_init_module(void)
+{
+	struct platform_device *pldev;
+	int err;
+
+	printk(KERN_INFO "Phoenix IDE driver\n");
+
+	if (driver_register(&phoenix_ide_driver)) {
+		printk(KERN_ERR "Driver registration failed\n");
+		err = -ENODEV;
+		goto out;
+	}
+
+        if (!(pldev = kzalloc(sizeof (*pldev), GFP_KERNEL))) {
+		err = -ENOMEM;
+		goto out_unregister_driver;
+	}
+
+	pldev->name		= phoenix_ide_string;
+	pldev->id		= 0;
+	pldev->dev.release	= phoenix_ide_platform_release;
+
+	if (platform_device_register(pldev)) {
+		err = -ENODEV;
+		goto out_free_pldev;
+	}
+
+        if (!pldev->dev.driver) {
+		/*
+		 * The driver was not bound to this device, there was
+		 * no hardware at this address. Unregister it, as the
+		 * release fuction will take care of freeing the
+		 * allocated structure
+		 */
+		platform_device_unregister (pldev);
+	}
+
+	phoenix_ide_dev = pldev;
+
+	return 0;
+
+out_free_pldev:
+	kfree(pldev);
+
+out_unregister_driver:
+	driver_unregister(&phoenix_ide_driver);
+out:
+	return err;
+}
+
+module_init(phoenix_ide_init_module);
-- 
1.6.0.2.GIT

