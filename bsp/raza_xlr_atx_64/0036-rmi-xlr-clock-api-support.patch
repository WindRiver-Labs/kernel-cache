From 2269bbcdb36d906e83640a877375d818fa2309ac Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Fri, 19 Dec 2008 17:19:05 +0800
Subject: [PATCH] rmi xlr clock api support

Support Wind River generic hardware timer API.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
Signed-off-by: Steve Yang <steve.yang@windriver.com>
diff --git a/arch/mips/kernel/cevt-r4k.c b/arch/mips/kernel/cevt-r4k.c
index afe06db..0de7a68 100644
--- a/arch/mips/kernel/cevt-r4k.c
+++ b/arch/mips/kernel/cevt-r4k.c
@@ -48,6 +48,10 @@ static struct hwtimer mips_hwtimer = {
 	.hook = NULL,
 	.hook_data = NULL
 };
+
+#if defined (CONFIG_SMP) && defined (CONFIG_RMI_PHOENIX)
+atomic_t hwtimer_cpu_trigger[NR_CPUS];
+#endif
 #endif
 
 static int mips_next_event(unsigned long delta,
@@ -104,10 +108,22 @@ irqreturn_t c0_compare_interrupt(int irq, void *dev_id)
 	}
 
 #if defined (CONFIG_SYS_R4K_CVET_HWTIMER) && defined (CONFIG_HWTIMER_HOOKS)
+
+#if defined (CONFIG_SMP) && defined (CONFIG_RMI_PHOENIX)
+    if (atomic_dec_and_test(&hwtimer_cpu_trigger[smp_processor_id()])) {
+        atomic_set(&hwtimer_cpu_trigger[smp_processor_id()],
+            num_online_cpus());
+#endif
+
 	spin_lock(mips_hwtimer.lock);
 	if (mips_hwtimer.hook != NULL)
 		(mips_hwtimer.hook)(mips_hwtimer.hook_data);
 	spin_unlock(mips_hwtimer.lock);
+
+#if defined (CONFIG_SMP) && defined (CONFIG_RMI_PHOENIX)
+	}
+#endif
+
 #endif
 out:
 	return IRQ_HANDLED;
@@ -209,6 +225,14 @@ int __cpuinit mips_clockevent_init(void)
 		return -ENXIO;
 
 #if defined (CONFIG_SYS_R4K_CVET_HWTIMER) && defined (CONFIG_HWTIMER_HOOKS)
+
+#if defined (CONFIG_SMP) && defined (CONFIG_RMI_PHOENIX)
+    unsigned int i;
+	for_each_possible_cpu(i)
+		atomic_set(&hwtimer_cpu_trigger[i], i + 1);
+
+	if (smp_processor_id() == 0)
+#endif
 	register_hwtimer(&mips_hwtimer);
 #endif
 	/*
