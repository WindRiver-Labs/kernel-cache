From 29ac03b14a60c22ea317f053e590706f66a079ea Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Sun, 21 Jun 2009 19:26:14 -0400
Subject: [PATCH 49/49] rmi: early initialization of pgd_current

This is a carry forward of 2.0/2.6.21 work by Ralf Baechle;
it points pgd_current to something sane during early boot
as insurance against unhandled TLB misses (see arch/mips
mmu_context.h -- TLBMISS_HANDLER_SETUP_PGD)

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
---
 arch/mips/rmi/phoenix/irq.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/arch/mips/rmi/phoenix/irq.c b/arch/mips/rmi/phoenix/irq.c
index f108241..21bf005 100644
--- a/arch/mips/rmi/phoenix/irq.c
+++ b/arch/mips/rmi/phoenix/irq.c
@@ -389,11 +389,18 @@ void __init init_phoenix_irqs(void)
 
 void __init phoenix_smp_init(void)
 {
+
+	unsigned int cpu = smp_processor_id();
+
 	/* Set up kseg0 to be cachable coherent */
 	change_c0_config(CONF_CM_CMASK, _page_cachable_default >> _CACHE_SHIFT);
 
 	/* set interrupt mask for non-zero cpus */
 	write_64bit_cp0_eimr(phnx_irq_mask | (1 << IRQ_TIMER));
+
+	pgd_current[cpu] = (unsigned long)init_mm.pgd;
+
+	local_irq_enable();
 }
 
 /* 
-- 
1.6.3.2

