From 995a073ad716b2a422fa112c8c14dad2ad4b6a97 Mon Sep 17 00:00:00 2001
From: Madalin Bucur <madalin.bucur@freescale.com>
Date: Mon, 11 Jun 2012 14:33:22 +0000
Subject: [PATCH 5/7] dpaa_eth: increase number of buffers in bpool

Doubled the number of buffers in bpool and raised the refill level.
This change provides a larger jitter buffer that prevents the
unstable results measured in the forwarding tests while leaving
the termination tests performance unaffected.
Also doubled the taildrop limit to align to the new buffers number.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2.1-20120824-yocto.tar.gz tarball.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c |    9 +++++----
 1 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index b8e6810..b656cb5 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -67,7 +67,8 @@
 
 #define ARRAY2_SIZE(arr)	(ARRAY_SIZE(arr) * ARRAY_SIZE((arr)[0]))
 
-#define DEFAULT_COUNT		64
+#define DEFAULT_COUNT		128
+#define REFILL_THRESHOLD	80
 
 #define DPA_NAPI_WEIGHT		64
 
@@ -79,7 +80,7 @@
  * In the future, we may want to have different values for queues
  * belonging to 1G vs 10G ports.
  */
-#define DPA_TAILDROP_THRESHOLD	0x100000
+#define DPA_TAILDROP_THRESHOLD	0x200000
 
 /* S/G table requires at least 256 bytes */
 #define SGT_BUFFER_SIZE		DPA_BP_SIZE(256)
@@ -1068,14 +1069,14 @@ static int dpaa_eth_poll(struct napi_struct *napi, int budget)
 	count = *percpu_priv->dpa_bp_count;
 
 #ifndef CONFIG_DPAA_ETH_SG_SUPPORT
-	if (count < DEFAULT_COUNT / 4) {
+	if (count < REFILL_THRESHOLD) {
 		int i;
 
 		for (i = count; i < DEFAULT_COUNT; i += 8)
 			dpa_bp_add_8(percpu_priv->dpa_bp);
 	}
 #else
-	if (count < DEFAULT_COUNT / 4) {
+	if (count < REFILL_THRESHOLD) {
 		int i;
 
 		/* Add pages to the buffer pool */
-- 
1.7.0.5

