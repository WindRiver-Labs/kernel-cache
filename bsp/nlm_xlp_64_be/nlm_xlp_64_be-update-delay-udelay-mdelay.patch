From 7f828a9e4a740ba42eb274126c9cd5169967fa8a Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Thu, 17 Jan 2013 18:00:13 +0800
Subject: [PATCH] nlm_xlp_64_be: update delay/udelay/mdelay

Workaround:
Broadcom committed a patch in SDK2.2.6 to use pic timer as the precision of
delay/udelay/mdelay. Sometimes this brings the below errors on XLP316 board,
so restore to non pic timer.

rb_consumer invoked oom-killer: gfp_mask=0xd0, order=0, oom_adj=0
rb_consumer cpuset=/ mems_allowed=0
Call Trace:
[<ffffffffc16e468c>] dump_stack+0x1c/0x50
[<ffffffffc1151434>] dump_header+0x94/0x208
[<ffffffffc1151da4>] __out_of_memory+0x11c/0x128
[<ffffffffc1151e60>] out_of_memory+0xb0/0x248
[<ffffffffc1158c2c>] __alloc_pages_nodemask+0x764/0x798
[<ffffffffc11a0e10>] alloc_pages_current+0x98/0x108
[<ffffffffc1156cdc>] ____get_free_pages+0x24/0xa0
[<ffffffffc1118424>] ring_buffer_alloc_read_page+0x24/0x48
[<ffffffffc111e83c>] ring_buffer_consumer_thread+0x16c/0x510
[<ffffffffc10b4570>] kthread+0x98/0xa0
[<ffffffffc103c34c>] kernel_thread_helper+0x24/0x30
..................
Kernel panic - not syncing: Out of memory and no killable processes...

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/lib/delay.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/arch/mips/lib/delay.c b/arch/mips/lib/delay.c
index 27ceba0..e61970f 100644
--- a/arch/mips/lib/delay.c
+++ b/arch/mips/lib/delay.c
@@ -23,7 +23,7 @@
 #include <asm/compiler.h>
 #include <asm/war.h>
 
-#if defined CONFIG_NLM_XLP /* For XLP with PIC timer */
+#if defined CONFIG_NLM_XLP && defined CONFIG_XLP_REPLACE_R4K_TIMER
 #include <asm/netlogic/xlp_irq.h>
 #include <linux/clockchips.h>
 extern int read_current_timer(unsigned long *cyc);
-- 
1.7.0

