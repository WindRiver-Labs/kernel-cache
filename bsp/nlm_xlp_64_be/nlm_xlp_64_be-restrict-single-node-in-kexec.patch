From d5cb7cec508064d23897dc8052c8da492d922f13 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Mon, 6 Aug 2012 09:28:38 +0800
Subject: [PATCH 47/47] nlm_xlp_64_be: restrict single node in kexec

Restrict single node in kexec, add more memories for XLP316.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/boot/dts/xlp316.dts  |    8 ++++++--
 arch/mips/netlogic/xlp/setup.c |   14 ++++++++++----
 2 files changed, 16 insertions(+), 6 deletions(-)

diff --git a/arch/mips/boot/dts/xlp316.dts b/arch/mips/boot/dts/xlp316.dts
index e9aaddd..7b751fd 100644
--- a/arch/mips/boot/dts/xlp316.dts
+++ b/arch/mips/boot/dts/xlp316.dts
@@ -805,8 +805,12 @@ nae@node-3 {
 		/* For kdump,CONFIG_PHYSICAL_START=0xffffffff84000000
 		 * Only PCIe ethernet driver(eth0) survive after booting
 		 * by kexec.
-		 */
-		bootargs = "crashkernel=128M@63M root=/dev/nfs rw nfsroot=192.168.0.1:/opt/rootfs,nfsvers=3 ip=192.168.0.2:192.168.0.1:192.168.0.1:255.255.254.0:xlp:eth0:off console=ttyS0,115200";
+		 * Note that mem=1168m@3584m are arbitrary. Their values
+		 * depend on how much memory you want to give to Linux.
+		 * 3584m and 1168m are related to how much memory you put
+		 * on your boards. You need to read x-loader and find out
+		 * the starting address of each node. */
+		bootargs = "crashkernel=128M@63M root=/dev/nfs rw nfsroot=192.168.0.1:/opt/rootfs,nfsvers=3 ip=192.168.0.2:192.168.0.1:192.168.0.1:255.255.254.0:xlp:eth0:off console=ttyS0,115200  mem=1168m@3584m";
 
 	};
 
diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index fbfd8a5..645c9b5 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -523,10 +523,16 @@ static void parse_fdt_sae_vc_config(void)
 		if (getprop(node, "ipsec-sync-vc", &ipsec_sync_vc, 4) > 0)
 			ipsec_sync_vc = fdt32_to_cpu(ipsec_sync_vc);
 
-		valid_node  = finddevice("/soc/nodes");
-
-		if (getprop(valid_node, "num-nodes", &num_nodes, 4) > 0 )
-			num_nodes = fdt32_to_cpu(num_nodes);
+		if (is_kexec_boot()) {
+			/* only supports single node in kexec now*/
+			num_nodes = 1;
+		} else {
+			valid_node  = finddevice("/soc/nodes");
+
+			if (getprop(valid_node, "num-nodes",
+				&num_nodes, 4) > 0)
+				num_nodes = fdt32_to_cpu(num_nodes);
+		}
 
 		for(i =0 ; i < num_nodes*NLM_MAX_CPU_PER_NODE; i++) {
 			if(nlm_cpu_vc_mask[i] & (1 << ipsec_sync_vc)) {
-- 
1.7.0

