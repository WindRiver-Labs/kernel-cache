From 5941fcd0c5d5af4c6f9011cad95ef9a37d568551 Mon Sep 17 00:00:00 2001
From: Vipul Nataraj <vnataraj@broadcom.com>
Date: Wed, 20 Jun 2012 11:28:00 -0700
Subject: [PATCH] nand: fixes writing/reading of oob bytes to NAND page

commit 2fff03ed0e30940d4f07c590008e9fda79ab586b from SDK-2.2.7

Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 drivers/mtd/nand/xlp_plat_nand.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/mtd/nand/xlp_plat_nand.c b/drivers/mtd/nand/xlp_plat_nand.c
index a8b6944..70ca9cf 100644
--- a/drivers/mtd/nand/xlp_plat_nand.c
+++ b/drivers/mtd/nand/xlp_plat_nand.c
@@ -376,7 +376,7 @@ static void send_cmd(struct mtd_info *mtd,
         nand_reg_write(0, NAND_DMA_CNT, len);
 
 	val = (page_addr >> (32 - (state->col_cyc * 8)));
-        nand_reg_write(0, NAND_ADDR1_L, val);
+        nand_reg_write(0, NAND_ADDR0_H, val);
 	val = ( (page_addr << (state->col_cyc * 8) ) | column);
         nand_reg_write(0, NAND_ADDR0_L, val) ;
 	val = virt_to_phys((void *) state->buf) + state->buf_ptr;
@@ -477,7 +477,7 @@ static void cmdfunc(struct mtd_info *mtd,
                     "page_addr: 0x%x, column: 0x%x.\n",
                     page_addr, column);
                 val = (page_addr >> (32 - (state->col_cyc*8)));
-		nand_reg_write(0, NAND_ADDR1_L, val);
+		nand_reg_write(0, NAND_ADDR0_H, val);
                 val = ((page_addr << (state->col_cyc * 8)));
 		nand_reg_write(0, NAND_ADDR0_L, val);
 		break;
@@ -606,6 +606,7 @@ static int read_page(struct mtd_info *mtd,
 
         dbp_print ("Read page %s\n",buf);
         read_buf(mtd, buf, mtd->writesize);
+	read_buf(mtd, chip->oob_poi, mtd->oobsize);
 
         return 0;
 }
@@ -620,6 +621,7 @@ static void write_page(struct mtd_info *mtd,
                 return;
         dbp_print ("Write page %p\n",buf);
         write_buf(mtd, buf, mtd->writesize);
+	write_buf(mtd, chip->oob_poi, mtd->oobsize);
 }
 
 static int waitfunc(struct mtd_info *mtd, struct nand_chip *chip)
-- 
1.7.0

