From b098a5025d966543837b49ee67f733baf35fa34b Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Thu, 14 Jun 2012 17:34:49 +0800
Subject: [PATCH 1/2] make the kernel can boot when we disable the mapped_kernel option

We enable the MAPPED_KERNEL in commit f3792c7d1. Some XLP special features
(such as PAGE_WALKER) only run normally with MAPPED_KERNEL, otherwise we
usually get "BUS error" or "Segmentation fault" when running some userspace
applications.

The MAPPED_KERNEL modify the LOAD_ADDRESS of the ELF kernel to
0xffff ffff c100 0000 (the original is 0xffff ffff 8100 0000). This is a
TLB mapped address space so it add a wired TLB entry to map the 
0xffff ffff c000 0000 to physical address 0x0000 0000 (256MB page size).
And then the 0xffff ffff c100 0000 is mapped to physical address
0x0100 0000.

When we use the KDUMP it use the PHYSICAL_START (the value is 0xffff ffff
 8400 0000) option to re-write the LOAD_ADDRESS. KDUMP always failed
when we load the dump-capture kernel in mapped kernel (enable MAPPED_KERNEL)

So we need to disable the MAPPED_KERNEL option in all kernel(kexec kernel,
kdump first kernel, kdump dump-capture kernel) if we want to use the kexec/
kdump feature.

We remove the kernel crash fix (commit id is 6d1d1a24a) when we add the
MAPPED_KERNEL support. So this need to be added when we disable the
MAPPED_KERNEL option


Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/netlogic/xlp/setup.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index 46444df..f9767d5 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -956,6 +956,10 @@ void __init prom_init(void)
 
 	xen_init();
 
+#ifndef CONFIG_MAPPED_KERNEL
+	write_c0_ebase(read_c0_ebase() | 0x10000);
+#endif
+
 	nlm_common_ebase = read_c0_ebase() & (~((1 << 12) - 1));
 
 	/* FIXME: we should also remove it for xlp8xx a2, but we do not have interface function
-- 
1.7.4.1

