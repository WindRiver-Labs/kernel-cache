From f5fb1c1549b1620e495ed15e3b36d99d6f264a2e Mon Sep 17 00:00:00 2001
From: Shan Hai <shan.hai@windriver.com>
Date: Mon, 9 Sep 2013 11:16:32 +0800
Subject: [PATCH 1/2] mips/netlogic: provide PIC as an optional clocksource device

The system time drift would occur in the XLP NUMA(by ICI configuration)
when using the MIPS CP0 counter as clocksource because the counter is not
sychroinzed between nodes, get sychronized system time by using PIC from
node 0 as clocksource, because the PIC is a per node device and the other
nodes get time from global clocksource.

Select PIC as current clocksource by setting rating of PIC to 350 which
is higher than rating of CP0 counter which has rating value 300. Based on
the fact that the kernel selects the clocksource with best rating when
a new clocksource device is registered, the PIC will be selected because
of its higher rating value compared to the CP0 counter.

The above is only done if the number of available CPUs is > 32, since there
are 32 in a package, and hence anything >32 means a NUMA configuration.

Remove the read_current_timer() from pic-timer.c which is duplicate of the
one defined in arch/mips/netlogic/xlp/time.c.

Signed-off-by: Shan Hai <shan.hai@windriver.com>
---
 arch/mips/netlogic/xlp/pic/Makefile    |    3 +-
 arch/mips/netlogic/xlp/pic/pic-timer.c |   37 ++++++++++++++++++++++++-------
 2 files changed, 29 insertions(+), 11 deletions(-)

diff --git a/arch/mips/netlogic/xlp/pic/Makefile b/arch/mips/netlogic/xlp/pic/Makefile
index 14a206a..ce3791f 100644
--- a/arch/mips/netlogic/xlp/pic/Makefile
+++ b/arch/mips/netlogic/xlp/pic/Makefile
@@ -1,7 +1,6 @@
 EXTRA_CFLAGS := -Werror
 EXTRA_CFLAGS := $(CFLAGS) -DNLM_HAL_LINUX_KERNEL -Iarch/mips/include/asm/netlogic/hal
 
-obj-$(CONFIG_XLP_PIC_TIMER)		+= timer-base.o
-obj-$(CONFIG_XLP_REPLACE_R4K_TIMER)	+= pic-timer.o
+obj-y					+= timer-base.o pic-timer.o
 obj-$(CONFIG_XLP_PIC_TIMER_GENERIC)	+= timer-wd.o
 obj-y					+= ite.o
diff --git a/arch/mips/netlogic/xlp/pic/pic-timer.c b/arch/mips/netlogic/xlp/pic/pic-timer.c
index c060ad5..c8bc3e0 100644
--- a/arch/mips/netlogic/xlp/pic/pic-timer.c
+++ b/arch/mips/netlogic/xlp/pic/pic-timer.c
@@ -31,6 +31,9 @@
 #include <asm/netlogic/xlp.h>
 #include "timer-base.h"
 
+/* Number of cpus on a single XLP node */
+#define NUM_CPUS_ON_A_NODE 32
+
 /* Clocksource functions start START_CS */
 static cycle_t xlp_cs_read(struct clocksource *cs)
 {
@@ -58,7 +61,11 @@ static void xlp_cs_disable(struct clocksource *cs)
 static struct clocksource xlp_pit_cs[NLM_MAX_CPU_NODE] = {
 	[0 ... NLM_MAX_CPU_NODE-1] = {
 	.name		= XLP_CSDTIMER,
-	.rating		= 300,
+	.rating		= 350, /* Value higher than rating of CP0 counter
+				* to make sure the PIC is selected as
+				* clocksource device for XLP NUMA non-sync
+				* CP0 counter workaround.
+				*/
 	.read		= xlp_cs_read,
 	.mask		= CLOCKSOURCE_MASK(64),		/* clock is 64 bit */
 	.flags		= CLOCK_SOURCE_IS_CONTINUOUS,
@@ -69,14 +76,6 @@ static struct clocksource xlp_pit_cs[NLM_MAX_CPU_NODE] = {
 	}
 };
 
-#if defined ARCH_HAS_READ_CURRENT_TIMER
-int read_current_timer(unsigned long *tv)
-{
-	*tv = (unsigned long)(xlp_cs_read(&xlp_pit_cs[0]));
-	return 0;
-}
-#endif
-
 /* Run time initialization of the clock source structure */
 static void xlp_pit_cs_init(u8 node)
 {
@@ -329,3 +328,23 @@ void __init xlp_pic_cs_timer_init(int cs)
 	xlp_pit_cs_init(node);
 	return;
 }
+
+static __init int xlp_pic_late_init(void)
+{
+	/*
+	 * A workaround for nonsync clocksource hardware bug in the XLP NUMA
+	 * systems.
+	 * Select PIC as clocksource on the XLP NUMA system instead of CP0
+	 * counter which is not synchronized between NUMA nodes and would
+	 * cause system time drifting.
+	 */
+	if (num_online_cpus() > NUM_CPUS_ON_A_NODE) {
+		/* Register PIC on node 0 as clocksource to get synchronized
+	 	 * clocksource on XLP NUMA.
+	 	 */
+		xlp_pit_cs_init(0);
+	}
+
+	return 0;
+}
+late_initcall(xlp_pic_late_init);
-- 
1.7.0

