From 0d81dd7f787280e7910b9d6f3069860ccc9b58f0 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Mon, 4 Jul 2011 15:16:25 +0800
Subject: [PATCH 30/37] nlm_xlp_64_be: Identify all of the memory

The old DTS file can only describe memory smaller than 8G for the unit
used by the 32bit addr and size is Byte, In order to identify memory
bigger than 8G and even more, "mem" argument should be passed to
kernel, which is not convenient, In order to overcome this issue, use
unit MB instead of Byte in DTS file and change the related parts in
fdt_process() to get the right memory range.

The current memory map is based on the output of bootloader:

NBU0 DRAM BAR0 base: 00000000 limit: 0013f000 xlate: 0000000f node: 00000001 (    0 MB ->   320 MB, size:   320 MB)
NBU0 DRAM BAR1 base: 001d0000 limit: 00bff000 xlate: 0009000f node: 00000001 (  464 MB ->  3072 MB, size:  2608 MB)
NBU0 DRAM BAR2 base: 00e00000 limit: 0428f000 xlate: 0029000f node: 00000001 ( 3584 MB ->  17040 MB, size:  13456 MB)

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/mips/boot/dts/xlp832.dts  |    7 ++++---
 arch/mips/netlogic/xlp/setup.c |    2 +-
 2 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/arch/mips/boot/dts/xlp832.dts b/arch/mips/boot/dts/xlp832.dts
index b103c81..4f501b3 100644
--- a/arch/mips/boot/dts/xlp832.dts
+++ b/arch/mips/boot/dts/xlp832.dts
@@ -37,9 +37,10 @@
 				sharedcfg = <0x1f000000>;
 			};
 			memory {
-				reg = <0x01000000 0x0B000000	// 176M at 16M
-					0x20000000 0xa0000000  // 2586M at 512M
-					0xe0000000 0x20000000>;  // 512M at 3584M
+				/* <Start Size>, Unit: M */
+				reg = <0x00000000 0x00000140 /* 320M@0M */
+				       0x000001d0 0x00000a30 /* 2608M@464M */
+				       0x00000e00 0x00003490>; /* 13456M@3584M */
 			};
 			fmn {
 				node_0_vc_mask = <0xffffffff 0xffffffff 0xffffffff 0xffffffff>;
diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index 4097507..12f13d4 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -428,7 +428,7 @@ static int fdt_process(void)
 			if (size == 0)
 				continue;
 
-			sprintf(domstr, " mem=%lldm@%lldm ", (size >> 20), (addr >> 20));
+			sprintf(domstr, " mem=%lldm@%lldm ", size, addr);
 			strcat(arcs_cmdline, domstr);
 			memset((void *)&domstr, '\0', sizeof(domstr));
 		}
-- 
1.7.0.2

