From f0bd495bae9cd0789584eb24e3380ee5571d6fb0 Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Fri, 27 Apr 2012 17:47:49 +0800
Subject: [PATCH 27/47] fixed the kernel crash when enable the pcieportbus in xlp

The issuse is caused by the pcie portbus driver place the msi-x table in
physical address 0x0. It would write the physical address 0x0 when the
other driver call the pci_enable_msix --> msix_capability_init -->
arch_setup_msi_irqs -->  xlp_setup_msix_irq --> write_msi_msg

Now the physical address 0x0 is the TLB refill handler place.

We set the cp0_ebase to make the TLB refill handler in physical address
0x10000

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/boot/dts/xlp316.dts  |    2 +-
 arch/mips/boot/dts/xlp832.dts  |    2 +-
 arch/mips/netlogic/xlp/setup.c |    2 ++
 3 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/arch/mips/boot/dts/xlp316.dts b/arch/mips/boot/dts/xlp316.dts
index 3fb41aa..4fa951f 100644
--- a/arch/mips/boot/dts/xlp316.dts
+++ b/arch/mips/boot/dts/xlp316.dts
@@ -46,7 +46,7 @@
 
 			memory {
 				/* <Start Size>, Unit: M */
-				reg = <0x00000000 0x14000000 // 320M@0M
+				reg = <0x00010000 0x13ff0000 // 320M@64K
 				       0x1d000000 0xa3000000 >; // 2608M@464M
 			};
                         fmn {
diff --git a/arch/mips/boot/dts/xlp832.dts b/arch/mips/boot/dts/xlp832.dts
index 493ba0e..ee34503 100644
--- a/arch/mips/boot/dts/xlp832.dts
+++ b/arch/mips/boot/dts/xlp832.dts
@@ -46,7 +46,7 @@
 
 			memory {
 				/* <Start Size>, Unit: M */
-				reg = <0x00000000 0x14000000 // 320M@0M
+				reg = <0x00010000 0x13ff0000 // 320M@64K
 				       0x1d000000 0xa3000000 >; // 2608M@464M
 			};
                         fmn {
diff --git a/arch/mips/netlogic/xlp/setup.c b/arch/mips/netlogic/xlp/setup.c
index b0ca7db..7b07f15 100644
--- a/arch/mips/netlogic/xlp/setup.c
+++ b/arch/mips/netlogic/xlp/setup.c
@@ -909,6 +909,8 @@ void __init prom_init(void)
 
 	xen_init();
 
+	write_c0_ebase(read_c0_ebase() | 0x10000);
+
 	nlm_common_ebase = read_c0_ebase() & (~((1 << 12) - 1));
 
 	/* FIXME: we should also remove it for xlp8xx a2, but we do not have interface function
-- 
1.7.0

