From 73abacbeb4d049f7dac9680ae172661656e0874f Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Thu, 31 Jan 2013 15:54:47 +0800
Subject: [PATCH] nlm_xlp_64_be: update for NLM_16G_MEM_SUPPORT

1. Use 0xc0000000 as the base of MAX_DMA_ADDRESS only
   both NLM_16G_MEM_SUPPORT and NUMA are enabled;
2. Workaround: NLM_16G_MEM_SUPPORT is only valid with PAGE_SIZE_64KB.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/Kconfig           |    2 +-
 arch/mips/include/asm/dma.h |    2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index 6e1b48c..1fcaa97 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -1602,7 +1602,7 @@ config 64BIT
 
 config NLM_16G_MEM_SUPPORT
 	bool "more than 16GB memory support"
-	depends on 64BIT && MAPPED_KERNEL
+	depends on 64BIT && MAPPED_KERNEL && PAGE_SIZE_64KB
 	help
 	  Support more than 16GB memory
 
diff --git a/arch/mips/include/asm/dma.h b/arch/mips/include/asm/dma.h
index bc9f9ce..574569d 100644
--- a/arch/mips/include/asm/dma.h
+++ b/arch/mips/include/asm/dma.h
@@ -89,7 +89,7 @@
 #define MAX_DMA_ADDRESS		PAGE_OFFSET
 #else
 #if defined(CONFIG_NLM_COMMON) && defined(CONFIG_64BIT)
-#ifdef CONFIG_NLM_16G_MEM_SUPPORT
+#if defined(CONFIG_NLM_16G_MEM_SUPPORT) && defined(CONFIG_NUMA)
 #define MAX_DMA_ADDRESS		(PAGE_OFFSET + 0xc0000000)
 #else
 #define MAX_DMA_ADDRESS		(PAGE_OFFSET + 0x80000000)
-- 
1.7.0

