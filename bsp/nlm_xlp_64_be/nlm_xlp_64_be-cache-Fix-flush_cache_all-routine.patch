From 36c03a512d510f6f21c5c9cb1fee4e241e01ef64 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Wed, 26 Dec 2012 18:19:08 +0800
Subject: [PATCH 3/9] nlm_xlp_64_be: cache: Fix flush_cache_all routine.

Clearing probe valid array in addition to the valid array.

This patch is also for erratum E28_CPU: L1D Cache Incomplete Flush.

Signed-off-by: Ashok Kumar <ashoks@broadcom.com>
Integrated-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/xlp/cpu_control_asm.S |   24 ++++++++++++++++++++++++
 1 files changed, 24 insertions(+), 0 deletions(-)

diff --git a/arch/mips/netlogic/xlp/cpu_control_asm.S b/arch/mips/netlogic/xlp/cpu_control_asm.S
index 7c755cc..d9e5a28 100644
--- a/arch/mips/netlogic/xlp/cpu_control_asm.S
+++ b/arch/mips/netlogic/xlp/cpu_control_asm.S
@@ -136,6 +136,30 @@
 	addi	t2, 1
 	bne	t3, t2, 1b
 	nop
+
+    li t2, 0
+4:
+	sll	v0, t2, 5
+	mtcr	zero, t0
+	ori	v1, v0, 0x4003
+	mtcr	v1, t1
+5:
+	mfcr	v1, t1
+	andi	v1, 0x1
+	bnez	v1, 5b
+	nop
+	mtcr    zero, t0
+	ori	v1, v0, 0x4007
+	mtcr    v1, t1
+6:
+	mfcr    v1, t1
+	andi    v1, 0x1
+	bnez    v1, 6b
+	nop
+	addi	t2, 1
+	bne	t3, t2, 4b
+	nop
+
 	.set pop
 .endm
 
-- 
1.7.0

