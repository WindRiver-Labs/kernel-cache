From ead9676d8ac6ebd5bb9bc1a572aaa24783fd2b13 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Fri, 13 Jul 2012 10:42:19 +0800
Subject: [PATCH 36/47] nlm_xlp_64_be: add XLP832 B1 support

Add XLP832 B1 support. Based on Broadcom SDK 2.2.4.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/include/asm/netlogic/hal/nlm_hal.h       |    2 +
 .../include/asm/netlogic/hal/nlm_hal_xlp_dev.h     |    2 +
 arch/mips/netlogic/common/nlm_hal_cpu_info.c       |   33 ++++++++++++++++++++
 3 files changed, 37 insertions(+), 0 deletions(-)

diff --git a/arch/mips/include/asm/netlogic/hal/nlm_hal.h b/arch/mips/include/asm/netlogic/hal/nlm_hal.h
index 6a395a4..3548e7e 100644
--- a/arch/mips/include/asm/netlogic/hal/nlm_hal.h
+++ b/arch/mips/include/asm/netlogic/hal/nlm_hal.h
@@ -57,6 +57,8 @@ extern void nlm_hal_init(void);
 extern int is_nlm_xlpxxx(void);
 extern int is_nlm_xlp8xx(void);
 extern int is_nlm_xlp8xx_b0(void);
+extern int is_nlm_xlp8xx_b1(void);
+extern int is_nlm_xlp8xx_bx(void);
 extern int is_nlm_xlp3xx(void);
 extern int is_nlm_xlp316(void);
 extern int is_nlm_xlp308(void);
diff --git a/arch/mips/include/asm/netlogic/hal/nlm_hal_xlp_dev.h b/arch/mips/include/asm/netlogic/hal/nlm_hal_xlp_dev.h
index 14cffa2..7a4dd66 100644
--- a/arch/mips/include/asm/netlogic/hal/nlm_hal_xlp_dev.h
+++ b/arch/mips/include/asm/netlogic/hal/nlm_hal_xlp_dev.h
@@ -85,6 +85,8 @@ THE POSSIBILITY OF SUCH DAMAGE.
 #define XLP_REVISION_A1 	0x01
 #define XLP_REVISION_A2 	0x02
 #define XLP_REVISION_B0	 	0x03
+#define XLP_REVISION_B1		0x04
+#define XLP_REVISION_BX		0xBF
 
 /*
  *    FMN
diff --git a/arch/mips/netlogic/common/nlm_hal_cpu_info.c b/arch/mips/netlogic/common/nlm_hal_cpu_info.c
index b0c855f..559679a 100644
--- a/arch/mips/netlogic/common/nlm_hal_cpu_info.c
+++ b/arch/mips/netlogic/common/nlm_hal_cpu_info.c
@@ -57,6 +57,16 @@ __inline__ int is_nlm_rev_b0(void)
 	return ((nlm_read_prid() & 0xff) == XLP_REVISION_B0);
 }
 
+__inline__ int is_nlm_rev_b1(void)
+{
+	return ((nlm_read_prid() & 0xff) == XLP_REVISION_B1);
+}
+
+__inline__ int is_nlm_rev_bx(void)
+{
+	return ((nlm_read_prid() & 0xff) == XLP_REVISION_BX);
+}
+
 extern char *strcat(char *dest, const char *src);
 static  void get_cpu_rev(int *revid, char *rev)
 {
@@ -76,6 +86,10 @@ static  void get_cpu_rev(int *revid, char *rev)
 		*revid = XLP_REVISION_B0;
 		strcat(rev, " Rev B0"); 
 	} 
+	if(is_nlm_rev_b1()){
+		*revid = XLP_REVISION_B1;
+		strcat(rev, " Rev B1");
+	}
 	return;
 }
 
@@ -241,6 +255,17 @@ __inline__ int is_nlm_xlp8xx_b0(void)
 	return (is_nlm_xlp_8_4_x() && is_nlm_rev_b0());
 }
 
+__inline__ int is_nlm_xlp8xx_b1(void)
+{
+	return (is_nlm_xlp_8_4_x() && is_nlm_rev_b1());
+}
+
+__inline__ int is_nlm_xlp8xx_bx(void)
+{
+	return (is_nlm_xlp8xx_b1() || is_nlm_xlp8xx_b0()
+		|| (is_nlm_xlp_8_4_x() && is_nlm_rev_bx()));
+}
+
 __inline__ int is_nlm_xlp3xx(void)
 {
 	return (get_proc_id() == CHIP_PROCESSOR_ID_XLP_3XX);
@@ -388,6 +413,12 @@ int  nlm_hal_get_cpuinfo(struct nlm_netl_proc_info* cpu_info)
 {
 	if(is_nlm_xlp8xx()){
 		strcpy(cpu_info->cpu_info_str, "XLP");
+		if(is_nlm_xlp8xx_b1()){
+			strcat(cpu_info->cpu_info_str, "832 Rev B1");
+			cpu_info->proc_id = CHIP_PROCESSOR_ID_XLP_8_4_XX;
+			cpu_info->revision= XLP_REVISION_B1;
+			return 1;
+		}
 		if(is_nlm_xlp832_b0()){
 			strcat(cpu_info->cpu_info_str, "832 Rev B0");
 			cpu_info->proc_id = CHIP_PROCESSOR_ID_XLP_8_4_XX;
@@ -503,6 +534,8 @@ EXPORT_SYMBOL(efuse_cfg6);
 EXPORT_SYMBOL(get_proc_id);
 EXPORT_SYMBOL(is_nlm_xlp8xx);
 EXPORT_SYMBOL(is_nlm_xlp8xx_b0);
+EXPORT_SYMBOL(is_nlm_xlp8xx_b1);
+EXPORT_SYMBOL(is_nlm_xlp8xx_bx);
 EXPORT_SYMBOL(is_nlm_xlp832_ax);
 EXPORT_SYMBOL(is_nlm_xlp8xx_ax);
 EXPORT_SYMBOL(is_nlm_xlp3xx);
-- 
1.7.0

