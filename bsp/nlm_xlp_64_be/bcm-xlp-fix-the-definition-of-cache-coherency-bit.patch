From 606c48e0142a148d5bed5f6d29b052f4c81767c0 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Thu, 6 Jun 2013 15:03:13 +0800
Subject: [PATCH 14/16] bcm-xlp: fix the definition of cache coherency bit

SDK use the fixed offset value in the three cache attributes macro.
It's incorrect when we disable the HUGETLB_PAGE.
The _CACHE_CACHABLE_NONCOHERENT affects the PAGE_NONE macro in protection_map[]
which is the mapping table of vm and hardware protection attributes.
The kernel would get incorrect attribute bits when using the table. The cache
attribute becomes 0x7 on mprotect() system call, but 0x7 is illegal in XLS/XLR/XLP
platform and it will cause kernel unaligned access.

The Call Trace info as follow:
====================================================================================
root@xlp:/opt/wr-test# ./main_test.sh -s tracing
Unhandled kernel unaligned access[#1]:
Cpu 28
$ 0 : 0000000000000000 0000000000000001 0000000000000000 ffffff0000000000
$ 4 : a80000012201feb0 000000002aac8000 0000000000409b94 0000000000000000
$ 8 : 000000002aac8000 0000000000000000 0000000000420000 000000002adc7160
$12 : 000000001000dce1 000000001000001e ffffffffffffffff 0000000000430000
$16 : a80000012201feb0 000000002aac8000 ffffffff8e050000 ffffffff8342049c
$20 : 0000000000000129 0000000000000000 0000000000000000 0000000000000000
$24 : 000000000042e674 000000002ae2a84c
$28 : a80000012201c000 a80000012201fbe0 0000000000420000 ffffffff8342049c
Hi : 000000000000026b
Lo : 00000000000001b6
epc : ffffffff834202b8 emulate_load_store_insn+0x3b0/0x470
Not tainted
ra : ffffffff8342049c do_ade+0x124/0x2b0
Status: 1000dce3 KX SX UX KERNEL EXL IE
Cause : 00800010
BadVA : 000000002aac8000
PrId : 000c0009 (XLP832 Rev B2)
Modules linked in: ..........
a800000123feeb40 ffffffff8340fa3c 00000000906c0397 ffffffff83522d5c
0000000023b9a0c0 a80000012418fe40 0000000000000180 ffffffff8340ff08
000000001000dce1 ffffffff8340ff08 000000001000dce1 000000000043006c
a800000123feeba0 ffffffff838c9dc0 ffffffff83e50000 ffffffff83400484
a800000123f2ab40 ffffffff8340f9f8 000000000043006c ffffffff8342aad4
a800000100030002 a8000001263f5ce0 0000000000000000 a800000123feeb40
000000000000001c ffffffff8342cc24 000000002aac8000 000000002aac9000
a8000001238f0540 000000002aac9000 000000002aac8000 a800000123feeb40
a800000123feeb40 ffffffffffe00000 a8000001238f0540 a80000012201feb0
...
Call Trace:
[<ffffffff834202b8>] emulate_load_store_insn+0x3b0/0x470
[<ffffffff8342049c>] do_ade+0x124/0x2b0
[<ffffffff83400484>] ret_from_exception+0x0/0x10

Code: 00431024 5440ff4c de030100 <8a230000> 9a230003 24020000
Disabling lock debugging due to kernel taint

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Jack Tan <jack.tan@windriver.com>
Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 arch/mips/include/asm/pgtable-bits.h |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/mips/include/asm/pgtable-bits.h b/arch/mips/include/asm/pgtable-bits.h
index 97b9e8c..8945e03 100644
--- a/arch/mips/include/asm/pgtable-bits.h
+++ b/arch/mips/include/asm/pgtable-bits.h
@@ -214,9 +214,9 @@ static inline uint64_t pte_to_entrylo(unsigned long pte_val)
 
 #elif defined(CONFIG_CPU_XLP)
 
-#define _CACHE_UNCACHED             (2<<9)
-#define _CACHE_CACHABLE_COW         (3<<9)
-#define _CACHE_CACHABLE_NONCOHERENT (3<<9)
+#define _CACHE_UNCACHED             (2<<_CACHE_SHIFT)
+#define _CACHE_CACHABLE_COW         (3<<_CACHE_SHIFT)
+#define _CACHE_CACHABLE_NONCOHERENT (3<<_CACHE_SHIFT)
 
 #elif defined(CONFIG_CPU_RM9000)
 
-- 
1.7.0

