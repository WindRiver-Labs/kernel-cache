From ebe1b8a8a3572d3453afe9f1c51ef9bb314453ae Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Wed, 30 Jan 2013 18:26:17 +0800
Subject: [PATCH] nlm_xlp_64_be: replace cpu_has_fpu with raw_cpu_has_fpu

The function cop1_64bit() needs to confirm if an FPU is present by checking
the macro cpu_has_fpu which is defined as below:

cpu_has_fpu		(current_cpu_data.options & MIPS_CPU_FPU)
raw_cpu_has_fpu		(raw_current_cpu_data.options & MIPS_CPU_FPU)

current_cpu_data	cpu_data[smp_processor_id()]
raw_current_cpu_data	cpu_data[raw_smp_processor_id()]

But smp_processor_id() is only safe if it's used in a preemption-off critical
section, or in a thread that is bound to the current CPU. Else kernel
will complain as below, so use raw_cpu_has_fpu to replace cpu_has_fpu.

BUG: using smp_processor_id() in preemptible
caller is fpu_emu+0xb4c/0x1858
Call Trace:
[<ffffffffc1715d20>] dump_stack+0x1c/0x50
[<ffffffffc143c79c>] debug_smp_processor_id+0xfc/0x110
[<ffffffffc105e724>] fpu_emu+0xb4c/0x1858
[<ffffffffc105f7cc>] cop1Emulate+0x39c/0x1d68
[<ffffffffc10612bc>] fpu_emulator_cop1Handler+0x124/0x238
[<ffffffffc1042d50>] do_fpe+0x208/0x538
[<ffffffffc1039ba4>] ret_from_exception+0x0/0x10

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 arch/mips/math-emu/cp1emu.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/arch/mips/math-emu/cp1emu.c b/arch/mips/math-emu/cp1emu.c
index ec72448..f67c7d0 100644
--- a/arch/mips/math-emu/cp1emu.c
+++ b/arch/mips/math-emu/cp1emu.c
@@ -179,7 +179,7 @@ static int isBranchInstr(mips_instruction * i)
  */
 static inline int cop1_64bit(struct pt_regs *xcp)
 {
-	if (cpu_has_fpu)
+	if (raw_cpu_has_fpu)
 		return xcp->cp0_status & ST0_FR;
 #ifdef CONFIG_64BIT
 	return !test_thread_flag(TIF_32BIT_REGS);
-- 
1.7.0

