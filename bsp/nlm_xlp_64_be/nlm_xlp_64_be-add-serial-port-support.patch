From c9012475862b03fff094f9d202af93035428397c Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Thu, 7 Apr 2011 14:23:16 +0800
Subject: [PATCH 20/37] nlm_xlp_64_be: add serial port support

[ Based on netlogic SDK 20110329 ]

Add 8250 compatible serial port support, but workaround is needed, so,
a new UPIO_NLM is added and the real workaround is implemented in the
board support code.

Signed-off-by: Krishnamurthy D V <kmurthy@netlogicmicro.com>
Integrated-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 drivers/serial/8250.c        |    4 ++++
 drivers/serial/serial_core.c |    2 ++
 include/linux/serial_core.h  |    1 +
 3 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/drivers/serial/8250.c b/drivers/serial/8250.c
index c1c7aaf..81349c0 100644
--- a/drivers/serial/8250.c
+++ b/drivers/serial/8250.c
@@ -669,6 +669,9 @@ static void set_io_from_upio(struct uart_port *p)
 		p->serial_out = dwapb_serial_out;
 		break;
 
+	case UPIO_NLM:
+		/* serial_in and serial_out are set in uart_port */
+		break;
 	default:
 		p->serial_in = io_serial_in;
 		p->serial_out = io_serial_out;
@@ -692,6 +695,7 @@ serial_out_sync(struct uart_8250_port *up, int offset, int value)
 	switch (p->iotype) {
 	case UPIO_MEM:
 	case UPIO_MEM32:
+	case UPIO_NLM:
 #ifdef CONFIG_SERIAL_8250_AU1X00
 	case UPIO_AU:
 #endif
diff --git a/drivers/serial/serial_core.c b/drivers/serial/serial_core.c
index 255cc26..4186d45 100644
--- a/drivers/serial/serial_core.c
+++ b/drivers/serial/serial_core.c
@@ -2161,6 +2161,7 @@ uart_report_port(struct uart_driver *drv, struct uart_port *port)
 	case UPIO_AU:
 	case UPIO_TSI:
 	case UPIO_DWAPB:
+	case UPIO_NLM:
 		if (port->mapbase == 0)
 			snprintf(address, sizeof(address),
 			 "MMIO 0x%llx membase %p",
@@ -2601,6 +2602,7 @@ int uart_match_port(struct uart_port *port1, struct uart_port *port2)
 	case UPIO_MEM32:
 	case UPIO_AU:
 	case UPIO_TSI:
+	case UPIO_NLM:
 	case UPIO_DWAPB:
 		if (port1->mapbase == 0 && port2->mapbase == 0)
 			return (port1->membase == port2->membase);
diff --git a/include/linux/serial_core.h b/include/linux/serial_core.h
index 989125a..318bc88 100644
--- a/include/linux/serial_core.h
+++ b/include/linux/serial_core.h
@@ -289,6 +289,7 @@ struct uart_port {
 #define UPIO_TSI		(5)			/* Tsi108/109 type IO */
 #define UPIO_DWAPB		(6)			/* DesignWare APB UART */
 #define UPIO_RM9000		(7)			/* RM9000 type IO */
+#define UPIO_NLM		(8)			/* Netlogic XLR(S)/XLP */
 
 	unsigned int		read_status_mask;	/* driver specific */
 	unsigned int		ignore_status_mask;	/* driver specific */
-- 
1.7.0.2

