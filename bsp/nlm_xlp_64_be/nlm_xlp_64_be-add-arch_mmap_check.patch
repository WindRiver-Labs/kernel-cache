From f12ba03c2e00f8bf25439015d711b4a09c9dcc47 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Thu, 7 Apr 2011 14:15:29 +0800
Subject: [PATCH 14/37] nlm_xlp_64_be: add arch_mmap_check()

[ Based on netlogic SDK 20110329 ]

Add sanity check in mmap for NLM XLP family in order to guarantee the
address and length of mapped memory region not exceed valid range for
32 bit process.

Signed-off-by: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Integrated-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/mips/include/asm/mman.h |    6 ++++++
 arch/mips/kernel/syscall.c   |   17 +++++++++++++++++
 2 files changed, 23 insertions(+), 0 deletions(-)

diff --git a/arch/mips/include/asm/mman.h b/arch/mips/include/asm/mman.h
index c892bfb..e9aa284 100644
--- a/arch/mips/include/asm/mman.h
+++ b/arch/mips/include/asm/mman.h
@@ -80,4 +80,10 @@
 /* compatibility flags */
 #define MAP_FILE	0
 
+#if defined(CONFIG_NLM_COMMON) && defined(CONFIG_64BIT)
+#define arch_mmap_check(addr, len, flags) mips_mmap_check(addr, len, flags)
+int mips_mmap_check(unsigned long addr, unsigned long len,
+		unsigned long flags);
+#endif
+
 #endif /* _ASM_MMAN_H */
diff --git a/arch/mips/kernel/syscall.c b/arch/mips/kernel/syscall.c
index b8405bc..4121bd2 100644
--- a/arch/mips/kernel/syscall.c
+++ b/arch/mips/kernel/syscall.c
@@ -6,6 +6,7 @@
  * Copyright (C) 1995, 1996, 1997, 2000, 2001, 05 by Ralf Baechle
  * Copyright (C) 1999, 2000 Silicon Graphics, Inc.
  * Copyright (C) 2001 MIPS Technologies, Inc.
+ * Copyright (C) 2003-2010 Netlogic Microsystems Inc.
  */
 #include <linux/capability.h>
 #include <linux/errno.h>
@@ -136,6 +137,22 @@ unsigned long arch_get_unmapped_area(struct file *filp, unsigned long addr,
 	}
 }
 
+#if defined(CONFIG_NLM_COMMON) && defined(CONFIG_64BIT)
+int mips_mmap_check(unsigned long addr, unsigned long len,
+		    unsigned long flags)
+{
+	int app_is_32bit = test_thread_flag(TIF_32BIT_ADDR);
+
+	if (app_is_32bit) {
+		if (len >= TASK_SIZE32)
+			return -EINVAL;
+		if ((flags & MAP_FIXED) && addr > (TASK_SIZE32 - len))
+			return -EINVAL;
+	}
+	return 0;
+}
+#endif
+
 SYSCALL_DEFINE6(mips_mmap, unsigned long, addr, unsigned long, len,
 	unsigned long, prot, unsigned long, flags, unsigned long,
 	fd, off_t, offset)
-- 
1.7.0.2

