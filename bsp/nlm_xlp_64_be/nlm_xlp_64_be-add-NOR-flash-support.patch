From a21759108b0d621813ee47949a8cea1032d0fd21 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Tue, 28 Jun 2011 19:13:11 +0800
Subject: [PATCH 24/37] nlm_xlp_64_be: add NOR flash support

Add platform driver for the 16M on-board NOR flash.

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/mips/boot/dts/xlp832.dts  |    4 ++
 arch/mips/netlogic/xlp/board.c |   89 ++++++++++++++++++++++++++++++++++++++-
 2 files changed, 90 insertions(+), 3 deletions(-)

diff --git a/arch/mips/boot/dts/xlp832.dts b/arch/mips/boot/dts/xlp832.dts
index 500d880..b103c81 100644
--- a/arch/mips/boot/dts/xlp832.dts
+++ b/arch/mips/boot/dts/xlp832.dts
@@ -54,7 +54,11 @@
 
 	chosen {
 		/* For NFS root filesystem */
+		/*
 		bootargs = "root=/dev/nfs rw nfsroot=192.168.0.1:/opt/rootfs/xlp832-n32 ip=192.168.0.2:192.168.0.1:192.168.0.1:255.255.254.0:xlp:eth4:off console=ttyS0,115200";
+		*/
+		/* For NOR root filesystem */
+		bootargs = "root=/dev/mtdblock4 rw rootfstype=jffs2 ip=192.168.0.2:192.168.0.1:192.168.0.1:255.255.254.0:xlp:eth4:off console=ttyS0,115200";
 	};
 
 	/* These binaries are downloaded at the resp physical memory locations
diff --git a/arch/mips/netlogic/xlp/board.c b/arch/mips/netlogic/xlp/board.c
index 1c94bdf..b400628 100644
--- a/arch/mips/netlogic/xlp/board.c
+++ b/arch/mips/netlogic/xlp/board.c
@@ -1,3 +1,7 @@
+/* Copyright (c) 2011 Windriver Systems, Inc.
+ * Author: Wu Zhangjin <zhangjin.wu@windriver.com>
+ */
+
 /***********************************************************************
  * Copyright 2003-2010 Netlogic Microsystems ("Netlogic"). All rights
  * reserved.
@@ -27,6 +31,9 @@
 #include <linux/init.h>
 #include <linux/platform_device.h>
 #include <linux/i2c.h>
+#include <linux/mtd/partitions.h>
+#include <linux/mtd/physmap.h>
+#include <mtd/mtd-abi.h>
 
 static struct i2c_board_info xlp_i2c_device_info[] __initdata = {
 	{
@@ -40,9 +47,85 @@ static struct i2c_board_info xlp_i2c_device_info[] __initdata = {
 	}
 };
 
-static int __init xlp_i2c_device_init(void)
+static struct mtd_partition xlp_mtd_partitions[] = {
+	{
+		.name	= "X-Loader(RO)",
+		.offset	= 0,
+		.size	= 0x100000,	/* 1M */
+		.mask_flags = MTD_WRITEABLE,
+	},
+	{
+		.name	= "U-boot(RW)",
+		.offset	= 0x100000,
+		.size	= 0x60000,	/* 384k */
+	},
+	{
+		.name	= "DTB(RW)",
+		.offset	= 0x160000,
+		.size	= 0x20000,	/* 128K */
+	},
+	{
+		.name	= "Kernel(RW)",
+		.offset	= 0x180000,
+		.size	= 0x580000,	/* 5.5M */
+	},
+	{
+		.name	= "Rootfs(RW)",
+		.offset	= 0x700000,
+		.size	= 0x800000,	/* 8M */
+	},
+	{
+		.name	= "Env(RO)",
+		.offset	= 0xf00000,	/* 1M */
+		.size	= MTDPART_SIZ_FULL,
+		.mask_flags = MTD_WRITEABLE,
+	},
+};
+
+#define BOARD_FLASH_SIZE 0x01000000 /* 16MB */
+#define BOARD_FLASH_BASE 0x16000000
+#define BOARD_FLASH_WIDTH 2 /* 16-bits */
+
+static struct physmap_flash_data xlp_flash_data = {
+	.width		= BOARD_FLASH_WIDTH,
+	.nr_parts	= ARRAY_SIZE(xlp_mtd_partitions),
+	.parts		= xlp_mtd_partitions,
+};
+
+static struct resource xlp_mtd_resource = {
+	.start	= BOARD_FLASH_BASE,
+	.end	= BOARD_FLASH_BASE + BOARD_FLASH_SIZE - 1,
+	.flags	= IORESOURCE_MEM,
+};
+
+static struct platform_device xlp_mtd_device = {
+	.name		= "physmap-flash",
+	.dev		= {
+		.platform_data	= &xlp_flash_data,
+	},
+	.num_resources	= 1,
+	.resource	= &xlp_mtd_resource,
+};
+
+static struct platform_device *xlp_mtd_devices[] __initdata = {
+	&xlp_mtd_device,
+};
+
+static int __init xlp_device_init(void)
 {
-	return i2c_register_board_info(1, xlp_i2c_device_info, ARRAY_SIZE(xlp_i2c_device_info));
+	int err;
+
+	err = i2c_register_board_info(1, xlp_i2c_device_info, ARRAY_SIZE(xlp_i2c_device_info));
+
+	if (err < 0)
+		pr_err("xlp-i2c: cannot register board I2C devices\n");
+
+	pr_info("Register xlp mtd devices\n");
+	err = platform_add_devices(xlp_mtd_devices, ARRAY_SIZE(xlp_mtd_devices));
+
+	if (err < 0)
+		pr_err("xlp-mtd: cannot register board mtd devices\n");
+	return err;
 }
 
-arch_initcall(xlp_i2c_device_init);
+arch_initcall(xlp_device_init);
-- 
1.7.0.2

