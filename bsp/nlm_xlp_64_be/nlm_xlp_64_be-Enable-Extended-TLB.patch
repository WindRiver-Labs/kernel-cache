From 4fa615a8c5aebed4ad11c405238fbb53f357d910 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Tue, 19 Jul 2011 15:24:45 +0800
Subject: [PATCH 36/37] nlm_xlp_64_be: Enable Extended TLB

[ Based on netlogic SDK 20110720 ]

For operating systems that prefer smaller page sizes(e.g. 4K), the
standard TLB design of 32 entries per thread(or 128 entries per four
threads) is not sufficient. The extended TLB design(128 + 2K(2176)
entries for per four threads) has been developed for the XLP processor,
this enables it.

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/mips/netlogic/xlp/mmu.c |   10 +++++++++-
 1 files changed, 9 insertions(+), 1 deletions(-)

diff --git a/arch/mips/netlogic/xlp/mmu.c b/arch/mips/netlogic/xlp/mmu.c
index 44e13f0..aef53b6 100644
--- a/arch/mips/netlogic/xlp/mmu.c
+++ b/arch/mips/netlogic/xlp/mmu.c
@@ -188,10 +188,18 @@ void mmu_init(void)
 
 #else	/* !CONFIG_PGWALKER */
 
+static int __initdata tlb_config = (ENABLE_ETLB | ENABLE_128_TLB);
+
 void mmu_init(void)
 {
+	/*
+	 * shift right half the number of 1s in
+	 * the pagemask and populate that value
+	 */
+	write_c0_config7(PM_DEFAULT_MASK >> (13 + (ffz(PM_DEFAULT_MASK >> 13) / 2)));
+
 	/* Intialize after pgwalker and others are configured! */
-	write_c0_config6(read_c0_config6());
+	write_c0_config6(read_c0_config6() | tlb_config);
 
 	/*
 	 * Read back TLB entries after configuration
-- 
1.7.0.2

