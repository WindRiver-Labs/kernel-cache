From 72beae55b2d24b332aa813b475b26fff71b1ae23 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Thu, 7 Jul 2011 22:13:06 +0800
Subject: [PATCH 31/37] nlm_xlp_64_be: Enable workaround for USB support with >2GB memory

Enable USB support with >2GB memory through setting the dma_mask in 31
bits and also force dma_alloc_coherent() allocate memory from DMA zone(0
~ 2G defined in arch/mips/include/asm/dma.h).

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/mips/mm/dma-default.c  |    8 ++++++++
 drivers/usb/host/ehci-pci.c |   10 ++++++++++
 drivers/usb/host/ohci-pci.c |   12 ++++++++++++
 3 files changed, 30 insertions(+), 0 deletions(-)

diff --git a/arch/mips/mm/dma-default.c b/arch/mips/mm/dma-default.c
index 9547bc0..0d46ae9 100644
--- a/arch/mips/mm/dma-default.c
+++ b/arch/mips/mm/dma-default.c
@@ -52,6 +52,14 @@ static gfp_t massage_gfp_flags(const struct device *dev, gfp_t gfp)
 		gfp |= __GFP_DMA;
 	else if (dev->coherent_dma_mask < DMA_BIT_MASK(24))
 		gfp |= __GFP_DMA;
+#ifdef CONFIG_NLM_XLP
+	/*
+	 * Enable XLP workaround for >2GB RAM, force buffer to be allocated in
+	 * DMA Zone(0 ~ 2GB defined in arch/mips/include/asm/dma.h)
+	 */
+	else if (dev->coherent_dma_mask < DMA_BIT_MASK(32))
+		gfp |= __GFP_DMA;
+#endif
 	else
 #endif
 #ifdef CONFIG_ZONE_DMA32
diff --git a/drivers/usb/host/ehci-pci.c b/drivers/usb/host/ehci-pci.c
index 2e37d24..0b87394 100644
--- a/drivers/usb/host/ehci-pci.c
+++ b/drivers/usb/host/ehci-pci.c
@@ -217,6 +217,16 @@ static int ehci_pci_setup(struct usb_hcd *hcd)
 			break;
 		}
 		break;
+
+	case PCI_VENDOR_ID_NETLOGIC:
+		/* XLP USB controller doesn't work with >2GB RAM */
+		if (pci_set_consistent_dma_mask(pdev,
+					DMA_BIT_MASK(31)) < 0)
+			ehci_warn(ehci, "can't enable XLP "
+					"workaround for >2GB RAM\n");
+		else
+			ehci_info(ehci, "Enable XLP workaround for >2GB RAM\n");
+		break;
 	}
 
 	/* cache this readonly data; minimize chip reads */
diff --git a/drivers/usb/host/ohci-pci.c b/drivers/usb/host/ohci-pci.c
index 784ffac..b9473ab 100644
--- a/drivers/usb/host/ohci-pci.c
+++ b/drivers/usb/host/ohci-pci.c
@@ -456,7 +456,19 @@ static int ohci_pci_reset (struct usb_hcd *hcd)
 			quirk = (void *)quirk_id->driver_data;
 			ret = quirk(hcd);
 		}
+		switch (pdev->vendor) {
+		case PCI_VENDOR_ID_NETLOGIC:
+			/* XLP USB controller doesn't work with >2GB RAM */
+			if (pci_set_consistent_dma_mask(pdev,
+						DMA_BIT_MASK(31)) < 0)
+				ohci_warn(ohci, "can't enable XLP "
+						"workaround for >2GB RAM\n");
+			else
+				ohci_info(ohci, "Enable XLP workaround for >2GB RAM\n");
+			break;
+		}
 	}
+
 	if (ret == 0) {
 		ohci_hcd_init (ohci);
 		return ohci_init (ohci);
-- 
1.7.0.2

