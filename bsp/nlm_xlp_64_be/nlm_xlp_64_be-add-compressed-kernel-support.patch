From 9a57b88a74468fdebf24e37ae84f7b6e8e30f1a7 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Thu, 7 Apr 2011 14:41:56 +0800
Subject: [PATCH 26/37] nlm_xlp_64_be: add compressed kernel support

Allow to produce smaller kernel image(vmlinuz) and make it possible to
be placed in a small NOR flash partition.

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/mips/Kconfig                    |    1 +
 arch/mips/Makefile                   |    2 +-
 arch/mips/boot/compressed/Makefile   |   13 +++++++++++++
 arch/mips/boot/compressed/uart-xlp.c |   24 ++++++++++++++++++++++++
 arch/mips/netlogic/Kconfig           |    9 +++++++++
 5 files changed, 48 insertions(+), 1 deletions(-)
 create mode 100644 arch/mips/boot/compressed/uart-xlp.c

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index 55d23b1..eb51191 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -675,6 +675,7 @@ config NLM_XLP_SIM
 	select SYS_SUPPORTS_LITTLE_ENDIAN
 	select SYS_SUPPORTS_HIGHMEM
 	select SYS_SUPPORTS_HOTPLUG_CPU
+	select SYS_SUPPORTS_ZBOOT
 	select DMA_COHERENT
 	select CEVT_R4K
 	select CSRC_R4K
diff --git a/arch/mips/Makefile b/arch/mips/Makefile
index c5267b6..c6592ac 100644
--- a/arch/mips/Makefile
+++ b/arch/mips/Makefile
@@ -759,7 +759,7 @@ boot := arch/$(ARCH)/boot
 
 makeboot =$(Q)$(MAKE) $(build)=$(boot) VMLINUX=$(vmlinux-32) $(1)
 makezboot =$(Q)$(MAKE) $(build)=$(boot)/compressed \
-	   VMLINUX_LOAD_ADDRESS=$(load-y) 32bit-bfd=$(32bit-bfd) $(1)
+	   LOADADDR=$(load-y) 32bit-bfd=$(32bit-bfd) $(1)
 
 all:	$(all-y)
 
diff --git a/arch/mips/boot/compressed/Makefile b/arch/mips/boot/compressed/Makefile
index 790ddd3..34328f9 100644
--- a/arch/mips/boot/compressed/Makefile
+++ b/arch/mips/boot/compressed/Makefile
@@ -12,6 +12,12 @@
 # Author: Wu Zhangjin <wuzhangjin@gmail.com>
 #
 
+ifdef CONFIG_PHYS_LOAD_ADDRESS
+VMLINUX_LOAD_ADDRESS := $(CONFIG_PHYS_LOAD_ADDRESS)
+else
+VMLINUX_LOAD_ADDRESS = $(LOADADDR)
+endif
+
 # compressed kernel load addr: VMLINUZ_LOAD_ADDRESS > VMLINUX_LOAD_ADDRESS + VMLINUX_SIZE
 VMLINUX_SIZE := $(shell wc -c $(objtree)/$(KBUILD_IMAGE) 2>/dev/null | cut -d' ' -f1)
 VMLINUX_SIZE := $(shell [ -n "$(VMLINUX_SIZE)" ] && echo -n $$(($(VMLINUX_SIZE) + (65536 - $(VMLINUX_SIZE) % 65536))))
@@ -29,13 +35,20 @@ KBUILD_CFLAGS := $(shell echo $(KBUILD_CFLAGS) | sed -e "s/-pg//")
 KBUILD_CFLAGS := $(LINUXINCLUDE) $(KBUILD_CFLAGS) -D__KERNEL__ \
 	-DBOOT_HEAP_SIZE=$(BOOT_HEAP_SIZE) -D"VMLINUX_LOAD_ADDRESS_ULL=$(VMLINUX_LOAD_ADDRESS)ull"
 
+ifdef CONFIG_PHYS_LOAD_ADDRESS
+KBUILD_AFLAGS := $(LINUXINCLUDE) $(KBUILD_AFLAGS) -D__ASSEMBLY__ \
+	-DBOOT_HEAP_SIZE=$(BOOT_HEAP_SIZE) \
+	-DKERNEL_ENTRY=0x$(shell $(NM) $(objtree)/$(KBUILD_IMAGE) 2>/dev/null | grep " phys_entry" | cut -f1 -d \ )
+else
 KBUILD_AFLAGS := $(LINUXINCLUDE) $(KBUILD_AFLAGS) -D__ASSEMBLY__ \
 	-DBOOT_HEAP_SIZE=$(BOOT_HEAP_SIZE) \
 	-DKERNEL_ENTRY=0x$(shell $(NM) $(objtree)/$(KBUILD_IMAGE) 2>/dev/null | grep " kernel_entry" | cut -f1 -d \ )
+endif
 
 obj-y := $(obj)/head.o $(obj)/decompress.o $(obj)/dbg.o
 
 ifdef CONFIG_DEBUG_ZBOOT
+obj-$(CONFIG_NLM_XLP_SIM)		   += $(obj)/uart-xlp.o
 obj-$(CONFIG_SYS_SUPPORTS_ZBOOT_UART16550) += $(obj)/uart-16550.o
 obj-$(CONFIG_MACH_ALCHEMY)		   += $(obj)/uart-alchemy.o
 endif
diff --git a/arch/mips/boot/compressed/uart-xlp.c b/arch/mips/boot/compressed/uart-xlp.c
new file mode 100644
index 0000000..bb4b3f6
--- /dev/null
+++ b/arch/mips/boot/compressed/uart-xlp.c
@@ -0,0 +1,24 @@
+/*
+ * Copyright (C) 2011 Wind River Systems, Inc.
+ * Author: Wu Zhangjin <zhangjin.wu@windriver.com>
+ *
+ * This file is subject to the terms and conditions of the GNU General Public
+ * License.  See the file "COPYING" in the main directory of this archive
+ * for more details.
+ */
+
+#include <asm/netlogic/iomap.h>
+
+#ifdef CONFIG_DEFAULT_XLP_UART_PORTID
+#define DEFAULT_XLP_UART_PORTID CONFIG_DEFAULT_XLP_UART_PORTID
+#else
+#define DEFAULT_XLP_UART_PORTID 0
+#endif
+
+unsigned long netlogic_io_base = (unsigned long)(DEFAULT_NETLOGIC_IO_BASE);
+unsigned int xlp_uart_portid = DEFAULT_XLP_UART_PORTID;
+
+void putc(char c)
+{
+	xlp_prom_putchar(c);
+}
diff --git a/arch/mips/netlogic/Kconfig b/arch/mips/netlogic/Kconfig
index e0ec8b3..7ad474c 100644
--- a/arch/mips/netlogic/Kconfig
+++ b/arch/mips/netlogic/Kconfig
@@ -39,3 +39,12 @@ config NLM_COMMON_LOAD_ADDRESS
           should be good for most of the applications unless specified
           explicitly: e.g. running Netlogic ToE requires kernel to be linked
 	  at address 0xffffffff86000000.
+
+config DEFAULT_XLP_UART_PORTID
+	int "default serial port id"
+	default 0
+	range 0 1
+	depends on SYS_SUPPORTS_ZBOOT
+	help
+	  This option allow to set the default serial port for compressed kernel
+	  debugging support.
-- 
1.7.0.2

