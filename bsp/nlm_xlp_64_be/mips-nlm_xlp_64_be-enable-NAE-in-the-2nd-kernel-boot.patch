From 14d8efae42e920e84950a1918ae6a98180edc0a3 Mon Sep 17 00:00:00 2001
From: Jin Yanjiang <yanjiang.jin@windriver.com>
Date: Wed, 14 Sep 2011 15:57:44 +0800
Subject: [PATCH] mips/nlm_xlp_64_be: enable NAE in the 2nd kernel booted by kexec

If you boot a 2nd kernel via kexec it will hang if the frequency is
set again. To fix this issue, we should not call the function
set_nae_frequency() on booting in the 2nd kernel.
The function set_nae_frequency() will set the net field of
SYS_DFS_DIV_DEC_CTRL to 1 for NAE.
As the Programming Reference Manual of XLP Processor said:
"Setting a read/write field to 1 will increment the DFS clock divider for
a device or interface by one."
The system clock of net was set by the first kernel, and was not cleared
after the secondary kernel booted up.
So if the secondary kernel set it again, the NAE frequency will double, and
then system will hang.

Signed-off-by: Jin Yanjiang <yanjiang.jin@windriver.com>
---
 arch/mips/netlogic/common/nlm_hal_nae.c |    5 ++++-
 drivers/net/nae/xlp_nae.c               |    6 ------
 2 files changed, 4 insertions(+), 7 deletions(-)

diff --git a/arch/mips/netlogic/common/nlm_hal_nae.c b/arch/mips/netlogic/common/nlm_hal_nae.c
index 9649d9e..3e6127c 100644
--- a/arch/mips/netlogic/common/nlm_hal_nae.c
+++ b/arch/mips/netlogic/common/nlm_hal_nae.c
@@ -22,6 +22,7 @@ CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 THE POSSIBILITY OF SUCH DAMAGE.
 *****************************#NETL_2#********************************/
+#include <asm/mach-netlogic/nlm_kexec.h>
 
 #include "nlm_hal_fmn.h"
 #include "nlm_hal_nae.h"
@@ -587,7 +588,9 @@ static void parse_fdt_nae_config(void *fdt)
 
 	if(GET_NAE_PROP("frequency", &frequency, sizeof(uint32_t)) < 0)
 		nlm_print("fdt missing frequency\n");
-	set_nae_frequency(frequency);
+
+	if (!is_kexec_boot())
+		set_nae_frequency(frequency);
 
 	/*******************************************************************************/
 	/* Read range of ports allocated per domain
diff --git a/drivers/net/nae/xlp_nae.c b/drivers/net/nae/xlp_nae.c
index d002ed0..a52947d 100644
--- a/drivers/net/nae/xlp_nae.c
+++ b/drivers/net/nae/xlp_nae.c
@@ -54,7 +54,6 @@
 #include <asm/netlogic/hal/nlm_hal_pic.h>
 
 #include <asm/netlogic/hal/nlm_hal_macros.h>
-#include <asm/mach-netlogic/nlm_kexec.h>
 
 #include <asm/netlogic/mips-exts.h>
 
@@ -1108,11 +1107,6 @@ static struct pci_driver soc_driver = {
 
 static int __init nlm_xlp_mac_init(void)
 {
-	if (is_kexec_boot()) {
-		pr_err("%s: NAE driver doesn't work when booting from kexec\n", __func__);
-		return -ENODEV;
-	}
-
 	nlm_xlp_nae_init();
 
 	return pci_register_driver(&soc_driver);
-- 
1.7.0.2

