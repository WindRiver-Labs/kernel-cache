From 19f6608cce9466e6747b231e06d5d4ec37bf5282 Mon Sep 17 00:00:00 2001
From: Yanjiang Jin <yanjiang.jin@windriver.com>
Date: Fri, 4 May 2012 13:45:28 +0800
Subject: [PATCH] nlm_xlp_64_be: adjust the nae driver

Adjust the nae driver, user can compile it as a module.

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
---
 drivers/net/Kconfig       |    2 ++
 drivers/net/nae/Makefile  |    2 +-
 drivers/net/nae/xlp_nae.c |    6 ++++--
 kernel/sched.c            |    2 ++
 4 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/drivers/net/Kconfig b/drivers/net/Kconfig
index 9a0b167..c583eea 100644
--- a/drivers/net/Kconfig
+++ b/drivers/net/Kconfig
@@ -3434,6 +3434,8 @@ config XLP_NAE
 	select NLM_ENABLE_COP2
 	help
 	  This driver supports netlogic xls/xlr/xlp soc network driver.
+	  To compile this driver as a module, choose M here.
+	  The module will be called nae.
 	  For more information on xls/xlr/xlp mac driver, please visit
 
 	  <http://support.netlogicmicro.com/support>
diff --git a/drivers/net/nae/Makefile b/drivers/net/nae/Makefile
index 7860498..38ab618 100644
--- a/drivers/net/nae/Makefile
+++ b/drivers/net/nae/Makefile
@@ -5,5 +5,5 @@
 EXTRA_CFLAGS := -DNLM_HAL_LINUX_KERNEL -Iarch/mips/include/asm/netlogic/hal
 EXTRA_CFLAGS += -Iarch/mips/netlogic/boot
 
-obj-y 		+= nae.o
+obj-$(CONFIG_XLP_NAE) += nae.o
 nae-objs 	:= xlp_nae.o init_nae.o xlp_hw.o
diff --git a/drivers/net/nae/xlp_nae.c b/drivers/net/nae/xlp_nae.c
index 0211bed..d939de6 100644
--- a/drivers/net/nae/xlp_nae.c
+++ b/drivers/net/nae/xlp_nae.c
@@ -1778,7 +1778,7 @@ static int __devinit nlm_xlp_nae_pci_probe(struct pci_dev *pdev, const struct pc
  * nlm_xlp_nae_remove - driver remove routine
  * @pdev - pci device.
  */
-static void nlm_xlp_nae_remove(struct pci_dev *pdev)
+static void nlm_xlp_nae_remove(void)
 {
 	int i;
 	struct net_device *dev = 0;
@@ -1804,7 +1804,7 @@ static struct pci_driver soc_driver = {
 	.name             = XLP_SOC_MAC_DRIVER,
 	.id_table         = soc_pci_table,
 	.probe            = nlm_xlp_nae_pci_probe,
-	.remove		  = nlm_xlp_nae_remove,
+	.remove		  = NULL,
 };
 
 static int __init nlm_xlp_mac_init(void)
@@ -1817,6 +1817,8 @@ static int __init nlm_xlp_mac_init(void)
 static void __exit nlm_xlp_mac_exit(void)
 {
 	/* unregister mac driver */
+	nlm_xlp_nae_remove();
+
 	pci_unregister_driver(&soc_driver);
 }
 
diff --git a/kernel/sched.c b/kernel/sched.c
index f0d2319..df01d01 100644
--- a/kernel/sched.c
+++ b/kernel/sched.c
@@ -4869,6 +4869,7 @@ out_put_task:
 	put_online_cpus();
 	return retval;
 }
+EXPORT_SYMBOL(sched_setaffinity);
 
 static int get_user_cpu_mask(unsigned long __user *user_mask_ptr, unsigned len,
 			     struct cpumask *new_mask)
@@ -4932,6 +4933,7 @@ out_unlock:
 
 	return retval;
 }
+EXPORT_SYMBOL(sched_getaffinity);
 
 /**
  * sys_sched_getaffinity - get the cpu affinity of a process
-- 
1.7.0.4

