From 33f5edcb22ebe12ccc10ef172cc13fec51a944e3 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Thu, 7 Apr 2011 14:07:49 +0800
Subject: [PATCH 15/37] nlm_xlp_64_be: add specific __cmpxchg_called_with_bad_pointer

[ Based on netlogic SDK 20110329 ]

Add half word case for __cmpxchg_called_with_bad_pointer method.

Signed-off-by: Venu Vadapalli <vvadapalli@netlogicmicro.com>
Integrated-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/mips/include/asm/cmpxchg.h |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/arch/mips/include/asm/cmpxchg.h b/arch/mips/include/asm/cmpxchg.h
index 2d28017..1b6e1a3 100644
--- a/arch/mips/include/asm/cmpxchg.h
+++ b/arch/mips/include/asm/cmpxchg.h
@@ -82,6 +82,14 @@ extern void __cmpxchg_called_with_bad_pointer(void);
 	pre_barrier;							\
 									\
 	switch (sizeof(*(__ptr))) {					\
+	case 2: {							\
+		unsigned long __flags;					\
+		raw_local_irq_save(__flags);				\
+		__res = *__ptr;						\
+		if (__res == __old)					\
+			*__ptr = __new;					\
+		raw_local_irq_restore(__flags);				\
+		} break;                                                \
 	case 4:								\
 		__res = __cmpxchg_asm("ll", "sc", __ptr, __old, __new);	\
 		break;							\
-- 
1.7.0.2

