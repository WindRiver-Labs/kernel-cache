From 6d0d6a90677d148d03267394db16620b35a84600 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Thu, 14 Apr 2011 11:34:02 +0800
Subject: [PATCH 10/37] nlm_xlp_64_be: add cop2 access support

[ Based on netlogic SDK 20110329 ]

Add support to enable cop2 access in kernel/user space

Signed-off-by: Mehul <vmehul@netlogicmicro.com>
Integrated-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/mips/include/asm/mipsregs.h   |    6 ++++++
 arch/mips/include/asm/stackframe.h |    2 +-
 arch/mips/kernel/r4k_switch.S      |    2 +-
 arch/mips/kernel/traps.c           |    3 +++
 arch/mips/netlogic/Kconfig         |    7 +++++++
 5 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/arch/mips/include/asm/mipsregs.h b/arch/mips/include/asm/mipsregs.h
index a173815..3e19ee4 100644
--- a/arch/mips/include/asm/mipsregs.h
+++ b/arch/mips/include/asm/mipsregs.h
@@ -420,6 +420,12 @@
 #define ST0_CU3			0x80000000
 #define ST0_XX			0x80000000	/* MIPS IV naming */
 
+#ifdef CONFIG_NLM_ENABLE_COP2
+#define ST0_CU2_IM	ST0_CU2
+#else
+#define ST0_CU2_IM	0
+#endif
+
 /*
  * Bitfields and bit numbers in the coprocessor 0 IntCtl register. (MIPSR2)
  *
diff --git a/arch/mips/include/asm/stackframe.h b/arch/mips/include/asm/stackframe.h
index 58730c5..12c9736 100644
--- a/arch/mips/include/asm/stackframe.h
+++ b/arch/mips/include/asm/stackframe.h
@@ -368,7 +368,7 @@
 		ori	a0, STATMASK
 		xori	a0, STATMASK
 		mtc0	a0, CP0_STATUS
-		li	v1, 0xff00
+		li	v1, (0xff00 | ST0_CU2_IM)
 		and	a0, v1
 		LONG_L	v0, PT_STATUS(sp)
 		nor	v1, $0, v1
diff --git a/arch/mips/kernel/r4k_switch.S b/arch/mips/kernel/r4k_switch.S
index 8893ee1..f11dc1e 100644
--- a/arch/mips/kernel/r4k_switch.S
+++ b/arch/mips/kernel/r4k_switch.S
@@ -97,7 +97,7 @@
 	move	ra,t1
 #endif /* CONFIG_MIPS_MT_SMTC */
 	mfc0	t1, CP0_STATUS		/* Do we really need this? */
-	li	a3, 0xff01
+	li	a3, (0xff01 | ST0_CU2_IM)
 	and	t1, a3
 	LONG_L	a2, THREAD_STATUS(a1)
 	nor	a3, $0, a3
diff --git a/arch/mips/kernel/traps.c b/arch/mips/kernel/traps.c
index 8c39bd2..1f5c4aa 100644
--- a/arch/mips/kernel/traps.c
+++ b/arch/mips/kernel/traps.c
@@ -1514,6 +1514,9 @@ void __cpuinit per_cpu_trap_init(void)
 	if (cpu_has_dsp)
 		status_set |= ST0_MX;
 
+	/* Allow to enable cop2 access with CONFIG_NLM_ENABLE_COP2 */
+	status_set |= ST0_CU2_IM;
+
 	change_c0_status(ST0_CU|ST0_MX|ST0_RE|ST0_FR|ST0_BEV|ST0_TS|ST0_KX|ST0_SX|ST0_UX,
 			 status_set);
 
diff --git a/arch/mips/netlogic/Kconfig b/arch/mips/netlogic/Kconfig
index 1c28804..1747edb 100644
--- a/arch/mips/netlogic/Kconfig
+++ b/arch/mips/netlogic/Kconfig
@@ -4,6 +4,13 @@ config NLM_COMMON
 config NLM_XLP
 	bool
 
+config NLM_ENABLE_COP2
+	bool "Enable Cop2 Access"
+	depends on NLM_XLP && 64BIT
+	default n
+	help
+	  This option enables cop2 access for both user and kernel space.
+
 config NLM_COMMON_LOAD_ADDRESS
 	hex "Netlogic Linux kernel start address"
 	depends on NLM_COMMON
-- 
1.7.0.2

