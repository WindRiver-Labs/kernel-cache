From da612f84b91626f7d643b3348511377e07537d36 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Tue, 12 Apr 2011 20:35:24 +0800
Subject: [PATCH] nlm_xlp_64_be: Prevent softirq wakeup on wrong CPU

commit 96c5397b25bfa8910d4f89ec99190edafc251525 in tip.

When the plugged CPU sets the online flag it enables interrupts and
goes idle. When an interrupt happens and tried to wakeup a softirq
thread before the other cpu sets the active flag, then the softirq
thread is put on one of the active cpus. Prevent this by waiting for
the cpu_active bit.

Temporary workaround. Needs more thought.

Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
[ Port from X86 to MIPS ]
Integrated-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/mips/kernel/smp.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/arch/mips/kernel/smp.c b/arch/mips/kernel/smp.c
index 0aaa22b..c675c88 100644
--- a/arch/mips/kernel/smp.c
+++ b/arch/mips/kernel/smp.c
@@ -125,6 +125,11 @@ asmlinkage __cpuinit void start_secondary(void)
 
 	synchronise_count_slave();
 
+	while (!cpumask_test_cpu(cpu, cpu_active_mask))
+		cpu_relax();
+	/* enable local interrupts */
+	local_irq_enable();
+
 	cpu_idle();
 }
 
-- 
1.7.0.2

