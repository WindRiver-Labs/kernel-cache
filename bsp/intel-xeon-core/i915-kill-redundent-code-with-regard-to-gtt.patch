From 4e1552b8077e6f1ec637e91416d5f144feccb0e2 Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Fri, 29 Aug 2014 10:10:38 +0800
Subject: [PATCH] i915: kill redundent code with regard to gtt

gtt has been initialized in i915_gem_gtt_init(), initialize
it again will make the work in i915_kick_out_firmware_fb()
lose effectiveness, and below boot failure will happen:

kernel BUG at arch/x86/mm/pat.c:264!
invalid opcode: 0000 [#1] PREEMPT SMP
LTT NESTING LEVEL : 0
Modules linked in:

Pid: 1, comm: swapper/0 Not tainted 3.4.88-WR5.0.1.16_standard #1 Wind River WRHV20
EIP: 0060:[<c102fb8f>] EFLAGS: 00010246 CPU: 1
EIP is at reserve_memtype+0x1f/0x4c0
EAX: 00000000 EBX: 00000000 ECX: 00000000 EDX: 00000000
ESI: 00000000 EDI: 00000000 EBP: df44fc68 ESP: df44fc24
 DS: 007b ES: 007b FS: 00d8 GS: 0000 SS: 0068
CR0: 8005003b CR2: ffff4000 CR3: 01acd000 CR4: 000007b0
DR0: 00000000 DR1: 00000000 DR2: 00000000 DR3: 00000000
DR6: ffff0ff0 DR7: 00000400
Process swapper/0 (pid: 1, ti=df44e000 task=df480000 task.ti=df44e000)
Stack:
 ffffffff ffffffff ffffffff 000fffff 00000000 00000000 00000000 00000000
 00000001 df44fc54 00000000 00000000 80000022 e0a00000 00000000 00000000
 00000000 df44fc9c c103072b 00000000 00000000 00000008 df44fc8c df44fcbc
Call Trace:
 [<c103072b>] io_reserve_memtype+0x5b/0x130
 [<c102d93f>] ? ioremap_nocache+0x1f/0x30
 [<c10321e4>] iomap_create_wc+0x34/0x60
 [<c13eb2e3>] i915_driver_load+0x463/0xe30
 [<c13d8793>] drm_get_pci_dev+0x143/0x260
 [<c1063f8b>] ? get_parent_ip+0xb/0x40
 [<c1063f8b>] ? get_parent_ip+0xb/0x40
 [<c13e7189>] i915_pci_probe+0x49/0xa0
 [<c134a6a7>] local_pci_probe+0x47/0xb0
 [<c134ae08>] pci_device_probe+0xe8/0x110
 [<c118c977>] ? sysfs_create_link+0x17/0x20
 [<c1442588>] driver_probe_device+0x68/0x1e0
 [<c134a632>] ? pci_match_device+0xb2/0xc0
 [<c1442791>] __driver_attach+0x91/0xa0
 [<c1442700>] ? driver_probe_device+0x1e0/0x1e0
 [<c1440e7a>] bus_for_each_dev+0x4a/0x80
 [<c1442161>] driver_attach+0x21/0x30
 [<c1442700>] ? driver_probe_device+0x1e0/0x1e0
 [<c1441dc7>] bus_add_driver+0x187/0x260
 [<c134ac10>] ? pci_dev_put+0x20/0x20
 [<c1442c16>] driver_register+0x66/0x110
 [<c134bc02>] __pci_register_driver+0x42/0xa0
 [<c13d89aa>] drm_pci_init+0xfa/0x110
 [<c1a5a40f>] i915_init+0x5e/0x60
 [<c1001114>] do_one_initcall+0x34/0x170
 [<c1a5a3b1>] ? drm_core_init+0x130/0x130
 [<c1a308a1>] kernel_init+0x116/0x1e3
 [<c1a30214>] ? do_early_param+0x74/0x74
 [<c1063195>] ? schedule_tail+0x25/0xa0
 [<c172d846>] ? ret_from_fork+0x6/0x1c
 [<c1a3078b>] ? start_kernel+0x361/0x361
 [<c1a3078b>] ? start_kernel+0x361/0x361
 [<c172ddf6>] kernel_thread_helper+0x6/0x10
Code: 8d c1 e8 e8 ca 6e 00 0f 0b 8d 76 00 55 89 e5 83 ec 44 89 5d f4 89 75 f8 89 7d fc 66 66 66 66 90 3b 55 0c 89 c6 89 d7 72 10 76 0
9 <0f> 0b 8d b4 26 00 00 00 00 3b 45 08 73 f2 a1 f8 b5 a2 c1 85 c0
EIP: [<c102fb8f>] reserve_memtype+0x1f/0x4c0 SS:ESP 0068:df44fc24

Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 drivers/gpu/drm/i915/i915_dma.c |    7 -------
 1 files changed, 0 insertions(+), 7 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_dma.c b/drivers/gpu/drm/i915/i915_dma.c
index 90eabe9..99daa89 100644
--- a/drivers/gpu/drm/i915/i915_dma.c
+++ b/drivers/gpu/drm/i915/i915_dma.c
@@ -1479,13 +1479,6 @@ int i915_driver_load(struct drm_device *dev, unsigned long flags)
 	if (drm_core_check_feature(dev, DRIVER_MODESET))
 		i915_kick_out_firmware_fb(dev_priv);
 
-	dev_priv->mm.gtt = intel_gtt_get();
-	if (!dev_priv->mm.gtt) {
-		DRM_ERROR("Failed to initialize GTT\n");
-		ret = -ENODEV;
-		goto put_bridge;
-	}
-
 	pci_set_master(dev->pdev);
 
 	/* overlay on gen2 is broken and can't address above 1G */
-- 
1.7.5.4

