From f8db32214b6b7b3d449f029cfb85ffada5868972 Mon Sep 17 00:00:00 2001
From: Yunguo Wei <yunguo.wei@windriver.com>
Date: Wed, 17 Jul 2013 14:47:22 +0800
Subject: [PATCH] Fix build error when unset DMA_ENGINE

Commit b2f31e06f (async_tx: allow generic async_memcpy() not be effected
by channel switch) introduced this issue, and causes the following build
error if DMA_ENGINE is unset:
| crypto/built-in.o: In function `async_memcpy':
|
/buildarea2/fli/bitbake_build/tmp/work/intel_xeon_core_haswell-wrs-linux/linux-windriver-3.4-r0/linux/crypto/async_tx/async_memcpy.c:107:
undefined reference to `dma_find_channel'
| make[2]: *** [.tmp_vmlinux1] Error 1
| make[1]: *** [sub-make] Error 2
| make: *** [all] Error 2
| ERROR: oe_runmake failed
| WARNING:
/buildarea2/fli/bitbake_build/tmp/work/intel_xeon_core_haswell-wrs-linux/linux-windriver-3.4-r0/temp/do_compile/run.do_compile.14818:121
exit 1 from

Pick up the orignal implementation for async_memcpy() if DMA_ENGINE is
not set.

Signed-off-by: Yunguo Wei <yunguo.wei@windriver.com>
---
 crypto/async_tx/async_memcpy.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/crypto/async_tx/async_memcpy.c b/crypto/async_tx/async_memcpy.c
index da3f5f9..8698f1b 100644
--- a/crypto/async_tx/async_memcpy.c
+++ b/crypto/async_tx/async_memcpy.c
@@ -98,6 +98,7 @@ async_memcpy(struct page *dest, struct page *src, unsigned int dest_offset,
 	     struct async_submit_ctl *submit)
 {
 	struct dma_chan *chan;
+#ifdef CONFIG_DMA_ENGINE
 	struct dma_async_tx_descriptor *depend_tx = submit->depend_tx;
 
 	if (depend_tx &&
@@ -105,7 +106,10 @@ async_memcpy(struct page *dest, struct page *src, unsigned int dest_offset,
 		chan = depend_tx->chan;
 	else
 		chan = dma_find_channel(DMA_MEMCPY);
-
+#else
+	chan = async_tx_find_channel(submit, DMA_MEMCPY,
+					&dest, 1, &src, 1, len);
+#endif
 	return __async_memcpy(chan, dest, src, dest_offset, src_offset,
 			      len, submit);
 }
-- 
1.7.5.4

