From 9d7283e5f60727208352d9ecdd98723d1f0e575f Mon Sep 17 00:00:00 2001
From: Bin Jiang <bin.jiang@windriver.com>
Date: Wed, 4 Jun 2014 16:59:34 +0800
Subject: [PATCH 3/3] usb: bcm-ehci: set ehci reset() function as ehci_setup()

When boot kernel, there are following call trace:
CPU: 1 PID: 1 Comm: swapper/0 Not tainted 3.10.38-ltsi-rt34-WR6.0.0.0_preempt-rt #1
[<c0017b2c>] (unwind_backtrace+0x0/0x100) from [<c0012cd4>] (show_stack+0x20/0x24)
[<c0012cd4>] (show_stack+0x20/0x24) from [<c05b396c>] (dump_stack+0x24/0x28)
[<c05b396c>] (dump_stack+0x24/0x28) from [<c007a188>] (__lock_acquire.isra.22+0x9e8/0xda0)
[<c007a188>] (__lock_acquire.isra.22+0x9e8/0xda0) from [<c007a5e8>] (lock_acquire+0xa8/0x158)
[<c007a5e8>] (lock_acquire+0xa8/0x158) from [<c05b873c>] (_raw_spin_lock+0x4c/0x5c)
[<c05b873c>] (_raw_spin_lock+0x4c/0x5c) from [<c05b756c>] (rt_spin_lock_slowlock+0x40/0x294)
[<c05b756c>] (rt_spin_lock_slowlock+0x40/0x294) from [<c05b7d14>] (rt_spin_lock+0x3c/0x68)
[<c05b7d14>] (rt_spin_lock+0x3c/0x68) from [<c03ff4b0>] (ehci_halt+0x28/0x158)
[<c03ff4b0>] (ehci_halt+0x28/0x158) from [<c04067cc>] (hcd_init+0x28/0xd0)
[<c04067cc>] (hcd_init+0x28/0xd0) from [<c03ee5fc>] (usb_add_hcd+0x1a4/0x614)
[<c03ee5fc>] (usb_add_hcd+0x1a4/0x614) from [<c03fffa8>] (bcm_ehci_probe+0x144/0x2dc)
[<c03fffa8>] (bcm_ehci_probe+0x144/0x2dc) from [<c03667cc>] (platform_drv_probe+0x28/0x2c)

Above call trace is caused by locking the uninitialized lock(ehci->lock).
The reset() function should be set as ehci_setup() nor hcd_init().

Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/usb/host/usb2h/ehci-bcm.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/usb/host/usb2h/ehci-bcm.c b/drivers/usb/host/usb2h/ehci-bcm.c
index c710dfc..a73b309 100644
--- a/drivers/usb/host/usb2h/ehci-bcm.c
+++ b/drivers/usb/host/usb2h/ehci-bcm.c
@@ -54,7 +54,7 @@ static const struct hc_driver ehci_hcd_driver =
 	/*
 	 * basic lifecycle operations
 	 */
-	.reset = hcd_init,
+	.reset = ehci_setup,
 	.start = ehci_run,
 	.stop = ehci_stop,
 	.shutdown = ehci_shutdown,
-- 
1.7.5.4

