From 5c5ff15287ff8c826fdfa356a44cdb9fea4a24c8 Mon Sep 17 00:00:00 2001
From: Bin Jiang <bin.jiang@windriver.com>
Date: Fri, 23 May 2014 19:35:54 +0800
Subject: [PATCH 2/3] mtd: m25p80: support write operation for TMicro spi
 flash

Before write command, the enable instruction should be
sent to the chip.

[Original changes taken from iProcLDK_3.4.6.package.tgz]
Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 drivers/mtd/devices/m25p80.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/drivers/mtd/devices/m25p80.c b/drivers/mtd/devices/m25p80.c
index d16e550..8c4381e 100644
--- a/drivers/mtd/devices/m25p80.c
+++ b/drivers/mtd/devices/m25p80.c
@@ -203,6 +203,14 @@ static inline int set_4byte(struct m25p *flash, u32 jedec_id, int enable)
 	case 0xEF /* winbond */:
 		flash->command[0] = enable ? OPCODE_EN4B : OPCODE_EX4B;
 		return spi_write(flash->spi, flash->command, 1);
+	case CFI_MFR_ST:
+		flash->command[0] = enable ? OPCODE_EN4B : OPCODE_EX4B;
+		ret = write_enable(flash);
+		if (!ret)
+			ret = spi_write(flash->spi, flash->command, 1);
+		if (!ret)
+			ret = write_disable(flash);
+		return ret;
 	default:
 		/* Spansion style */
 		flash->command[0] = OPCODE_BRWR;
-- 
1.7.5.4

