From b030135ccfa64b99dac4cfa6a4647bc7e529eb6a Mon Sep 17 00:00:00 2001
From: Bin Jiang <bin.jiang@windriver.com>
Date: Tue, 10 Jun 2014 14:14:15 +0800
Subject: [PATCH] mtd: iproc: limit to access 16M SPI flash.

Add a kernel option to limit to access 16M SPI flash.
If flash requires 4-byte address to access address larger than 16M,
there will be a reset problem. This is a workaround for the reset
problem.

Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/arm/mach-iproc/flash.c  |    2 ++
 drivers/mtd/devices/Kconfig  |    9 +++++++++
 drivers/mtd/devices/m25p80.c |    4 ++++
 3 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-iproc/flash.c b/arch/arm/mach-iproc/flash.c
index 3563e02..cf496ee 100644
--- a/arch/arm/mach-iproc/flash.c
+++ b/arch/arm/mach-iproc/flash.c
@@ -58,11 +58,13 @@ static struct mtd_partition sflash_partition_map[] = {
         .offset = MTDPART_OFS_APPEND,
         .size = 15 * 1024 * 1024,
     },
+#ifndef CONFIG_IPROC_M25PXX_16M_FLASH
     {
         .name = "rootfs",
         .offset = MTDPART_OFS_APPEND,
         .size = MTDPART_SIZ_FULL,
     },
+#endif
 };
 #endif /* CONFIG_IPROC_QSPI || CONFIG_IPROC_QSPI_MODULE */
 
diff --git a/drivers/mtd/devices/Kconfig b/drivers/mtd/devices/Kconfig
index 2a4d55e..d8ed2fd 100644
--- a/drivers/mtd/devices/Kconfig
+++ b/drivers/mtd/devices/Kconfig
@@ -102,6 +102,15 @@ config M25PXX_USE_FAST_READ
 	help
 	  This option enables FAST_READ access supported by ST M25Pxx.
 
+config IPROC_M25PXX_16M_FLASH
+	bool "Only access 16M iProc SPI flash"
+	depends on MTD_M25P80
+	default n
+	help
+	  This limits to access 16M SPI flash. If flash requires 4-byte
+	  address to access address larger than 16M, there will be a reset
+	  problem.
+
 config MTD_SPEAR_SMI
 	tristate "SPEAR MTD NOR Support through SMI controller"
 	depends on PLAT_SPEAR
diff --git a/drivers/mtd/devices/m25p80.c b/drivers/mtd/devices/m25p80.c
index 8c4381e..a204075 100644
--- a/drivers/mtd/devices/m25p80.c
+++ b/drivers/mtd/devices/m25p80.c
@@ -992,7 +992,11 @@ static const struct spi_device_id m25p_ids[] = {
 	{ "n25q064",  INFO(0x20ba17, 0, 64 * 1024, 128, 0) },
 	{ "n25q128a11",  INFO(0x20bb18, 0, 64 * 1024, 256, 0) },
 	{ "n25q128a13",  INFO(0x20ba18, 0, 64 * 1024, 256, 0) },
+#ifdef CONFIG_IPROC_M25PXX_16M_FLASH
+	{ "n25q256a", INFO(0x20ba19, 0, 64 * 1024, 256, SECT_4K) },
+#else
 	{ "n25q256a", INFO(0x20ba19, 0, 64 * 1024, 512, SECT_4K) },
+#endif
 	/* Numonyx flash n25q128 - FIXME check the name */
 	{ "n25q128",   INFO(0x20bb18, 0, 64 * 1024, 256, 0) },
 	{ "n25q128a11",  INFO(0x20bb18, 0, 64 * 1024, 256, E_FSR) },
-- 
1.7.5.4

