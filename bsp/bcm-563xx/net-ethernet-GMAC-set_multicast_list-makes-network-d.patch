From 713a156ad04dfaba1078ff7250078fc4aad677df Mon Sep 17 00:00:00 2001
From: Bin Jiang <bin.jiang@windriver.com>
Date: Fri, 23 May 2014 13:47:41 +0800
Subject: [PATCH 13/13] net: ethernet: GMAC: set_multicast_list() makes
 network down

set_multicast_list() calls et_init() which clears carrier
and causes network not work.
gmac watchdog timer monitors link state periodically and UP the linked
network. But for BCM56340 chip, the ethernet port is always thought as
linked and does not UP it. So if carrier is set to off, the network keeps
down.
Add UP operation to fix.

Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 .../net/ethernet/broadcom/gmac/src/et/sys/etc.c    |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/broadcom/gmac/src/et/sys/etc.c b/drivers/net/ethernet/broadcom/gmac/src/et/sys/etc.c
index 868b4ee..4e77ab5 100755
--- a/drivers/net/ethernet/broadcom/gmac/src/et/sys/etc.c
+++ b/drivers/net/ethernet/broadcom/gmac/src/et/sys/etc.c
@@ -575,6 +575,10 @@ etc_watchdog(etc_info_t *etc)
 		/* if GMAC does not have access to MDIO then exit */
 		etc->linkstate = TRUE;
 		etc->duplex = 1;
+		if (etc->pm_modechange)
+			etc->pm_modechange = FALSE;
+		else
+			et_link_up(etc->et);
 		/* keep emac txcontrol duplex bit consistent with current phy duplex */
 		(*etc->chops->duplexupd)(etc->ch);
 		return;
-- 
1.7.5.4

