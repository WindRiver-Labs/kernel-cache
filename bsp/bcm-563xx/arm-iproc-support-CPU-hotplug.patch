From 066d827d722fc08dc9bf9ca52372ad5ddef9d904 Mon Sep 17 00:00:00 2001
From: Bin Jiang <bin.jiang@windriver.com>
Date: Thu, 12 Jun 2014 16:59:37 +0800
Subject: [PATCH] arm: iproc: support CPU hotplug

Add CPU hotplug operations to struct smp_operations.

Signed-off-by: Bin Jiang <bin.jiang@windriver.com>
---
 arch/arm/plat-iproc/hotplug.c          |    6 +++---
 arch/arm/plat-iproc/include/mach/smp.h |    6 ++++++
 arch/arm/plat-iproc/platsmp.c          |    5 +++++
 3 files changed, 14 insertions(+), 3 deletions(-)

diff --git a/arch/arm/plat-iproc/hotplug.c b/arch/arm/plat-iproc/hotplug.c
index b47c7cb..da4824b 100644
--- a/arch/arm/plat-iproc/hotplug.c
+++ b/arch/arm/plat-iproc/hotplug.c
@@ -99,7 +99,7 @@ static inline void platform_do_lowpower(unsigned int cpu)
     }
 }
 
-int platform_cpu_kill(unsigned int cpu)
+int iproc_cpu_kill(unsigned int cpu)
 {
     return wait_for_completion_timeout(&cpu_killed, 5000);
 }
@@ -109,7 +109,7 @@ int platform_cpu_kill(unsigned int cpu)
  *
  * Called with IRQs disabled
  */
-void platform_cpu_die(unsigned int cpu)
+void iproc_cpu_die(unsigned int cpu)
 {
 #ifdef DEBUG
     unsigned int this_cpu = hard_smp_processor_id();
@@ -137,7 +137,7 @@ void platform_cpu_die(unsigned int cpu)
     cpu_leave_lowpower();
 }
 
-int platform_cpu_disable(unsigned int cpu)
+int iproc_cpu_disable(unsigned int cpu)
 {
     /*
      * we don't allow CPU 0 to be shutdown (it is still too special
diff --git a/arch/arm/plat-iproc/include/mach/smp.h b/arch/arm/plat-iproc/include/mach/smp.h
index 0a70b2a..9fb1b16 100644
--- a/arch/arm/plat-iproc/include/mach/smp.h
+++ b/arch/arm/plat-iproc/include/mach/smp.h
@@ -39,3 +39,9 @@ extern void iproc_secondary_startup(void);
 	})
 
 #endif /* __ASM_ARCH_SMP_H */
+
+#ifdef CONFIG_HOTPLUG_CPU
+extern int iproc_cpu_disable(unsigned int cpu);
+extern int iproc_cpu_kill(unsigned int cpu);
+extern int iproc_cpu_die(unsigned int cpu);
+#endif
diff --git a/arch/arm/plat-iproc/platsmp.c b/arch/arm/plat-iproc/platsmp.c
index 66ee137..c9c72ac 100644
--- a/arch/arm/plat-iproc/platsmp.c
+++ b/arch/arm/plat-iproc/platsmp.c
@@ -248,5 +248,10 @@ struct smp_operations iproc_smp_ops __initdata = {
 	.smp_prepare_cpus	= iproc_smp_prepare_cpus,
 	.smp_secondary_init	= iproc_secondary_init,
 	.smp_boot_secondary	= iproc_boot_secondary,
+#ifdef CONFIG_HOTPLUG_CPU
+	.cpu_die		= iproc_cpu_die,
+	.cpu_kill		= iproc_cpu_kill,
+	.cpu_disable		= iproc_cpu_disable,
+#endif
 };
 
-- 
1.7.5.4

