From 873ee26617c878146b8e5ec768a46b8ea8a40da6 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Thu, 22 Dec 2011 17:58:11 +0800
Subject: [PATCH 11/18] PowerPC:QMAN_SELFTEST:Set DMA_MASK for device

On P3041DS board with 8G DDR3, installing qman_tester module leads to
kernel panic:

Kernel panic - not syncing: map_single: bounce buffer is not DMA'ble
Call Trace:
ground
[ea8fdde0] [c0007b10] show_stack+0x44/0x160 (unreliable)
[ea8fde10] [c063d704] panic+0x12c/0x1a0
[ea8fde60] [c035dd30] swiotlb_map_page+0x1ec/0x238
[ea8fde80] [f955d6f0] qman_test_hotpotato+0x17c/0x59c [qman_tester]
[ea8fdee0] [f955d014] test_init+0x10/0x2c [qman_tester]
[ea8fdef0] [c0001d44] do_one_initcall+0x3c/0x1e0
[ea8fdf20] [c0085bb0] sys_init_module+0xf8/0x21c
[ea8fdf40] [c0010fc4] ret_from_syscall+0x0/0x4
---
 drivers/staging/fsl_qbman/qman_test_hotpotato.c |    2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/staging/fsl_qbman/qman_test_hotpotato.c b/drivers/staging/fsl_qbman/qman_test_hotpotato.c
index 9381a5f..05fcd5d 100644
--- a/drivers/staging/fsl_qbman/qman_test_hotpotato.c
+++ b/drivers/staging/fsl_qbman/qman_test_hotpotato.c
@@ -200,6 +200,8 @@ static void allocate_frame_data(void)
 	struct platform_device *pdev = platform_device_alloc("foobar", -1);
 	if (!pdev)
 		panic("platform_device_alloc() failed");
+	if (dma_set_mask(&pdev->dev, DMA_BIT_MASK(36)) < 0)
+		panic("set_dma_mask() failed");
 	if (platform_device_add(pdev))
 		panic("platform_device_add() failed");
 	__frame_ptr = kmalloc(4 * HP_NUM_WORDS, GFP_KERNEL);
-- 
1.7.9.7

