From ddb87e214df073205ba66ca82774eac95521f36a Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Fri, 19 Jul 2013 15:14:55 +0800
Subject: [PATCH] fmd: modified the value used for TBIANA initialization

Commit 5638bc8089a26a05c2eb409c0e851b462b02b6ae from
http://git.freescale.com/git/cgit.cgi/ppc/sdk/linux.git/

The TBI ANA register must be programmed with the value 0x4001 for SGMII
autonegotiation. The previous value, 0x1a0 is fit only for 1000Base-X.

Signed-off-by: Madalin Bucur <madalin.bucur@freescale.com>
Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 .../net/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c   |   13 ++++++-------
 .../net/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.h   |    7 ++++++-
 2 files changed, 12 insertions(+), 8 deletions(-)

diff --git a/drivers/net/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c b/drivers/net/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c
index f7797e6..f3eaa87 100644
--- a/drivers/net/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c
+++ b/drivers/net/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.c
@@ -1630,23 +1630,22 @@ static t_Error DtsecInit(t_Handle h_Dtsec)
         uint16_t            tmpReg16;
 
         /* Configure the TBI PHY Control Register */
-        tmpReg16 = PHY_TBICON_SPEED2 | PHY_TBICON_SRESET;
-
+	tmpReg16 = PHY_TBICON_CLK_SEL | PHY_TBICON_SRESET;
         DTSEC_MII_WritePhyReg(p_Dtsec, p_DtsecDriverParam->tbiPhyAddr, 17, tmpReg16);
 
-        tmpReg16 = PHY_TBICON_SPEED2;
-
+	tmpReg16 = PHY_TBICON_CLK_SEL;
         DTSEC_MII_WritePhyReg(p_Dtsec, p_DtsecDriverParam->tbiPhyAddr, 17, tmpReg16);
 
+	tmpReg16 = PHY_CR_SPEED1;
         if(!p_DtsecDriverParam->halfDuplex)
-            tmpReg16 |= PHY_CR_FULLDUPLEX | 0x8000 | PHY_CR_ANE;
+		tmpReg16 |= PHY_CR_FULLDUPLEX | PHY_CR_PHY_RESET | PHY_CR_ANE;
 
         DTSEC_MII_WritePhyReg(p_Dtsec, p_DtsecDriverParam->tbiPhyAddr, 0, tmpReg16);
 
-        tmpReg16 = 0x01a0;
+	tmpReg16 = PHY_TBIANA_SGMII;
         DTSEC_MII_WritePhyReg(p_Dtsec, p_DtsecDriverParam->tbiPhyAddr, 4, tmpReg16);
 
-        tmpReg16 = 0x1340;
+	tmpReg16 = PHY_CR_ANE | PHY_CR_RESET_AN | PHY_CR_FULLDUPLEX | PHY_CR_SPEED1;
         DTSEC_MII_WritePhyReg(p_Dtsec, p_DtsecDriverParam->tbiPhyAddr, 0, tmpReg16);
     }
 
diff --git a/drivers/net/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.h b/drivers/net/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.h
index 3a53077..b948577 100644
--- a/drivers/net/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.h
+++ b/drivers/net/dpa/NetCommSw/Peripherals/FM/MAC/dtsec.h
@@ -322,14 +322,19 @@ typedef  uint32_t t_ErrorDisable;
 #define     VAL12BIT    0x00001000
 
 /* PHY Control Register */
+#define PHY_CR_PHY_RESET    0x8000
 #define PHY_CR_LOOPBACK     0x4000
 #define PHY_CR_SPEED0       0x2000
 #define PHY_CR_ANE          0x1000
 #define PHY_CR_FULLDUPLEX   0x0100
+#define PHY_CR_RESET_AN     0x0200
 #define PHY_CR_SPEED1       0x0040
 
 #define PHY_TBICON_SRESET   0x8000
-#define PHY_TBICON_SPEED2   0x0020
+#define PHY_TBICON_CLK_SEL  0x0020
+
+#define PHY_TBIANA_SGMII    0x4001
+#define PHY_TBIANA_1000X    0x01a0
 
 /* CAR1/2 bits */
 #define CAR1_TR64   0x80000000
-- 
1.7.0

