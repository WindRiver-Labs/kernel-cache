From 8c06a6542bbd828671754b521fa28455ae445f22 Mon Sep 17 00:00:00 2001
From: Shan Hai <shan.hai@windriver.com>
Date: Wed, 1 Feb 2012 13:41:04 +0800
Subject: [PATCH] bcm53000/hndpci add delay between successive pci config reads

The pci configuration registers need time to respond to the read operations.
Successive reads without delay between them fail to discover the devices on
the bus.

Signed-off-by: Shan Hai <shan.hai@windriver.com>
---
 arch/mips/bcm53000/hndpci.c |    9 ++++++++-
 1 files changed, 8 insertions(+), 1 deletions(-)

diff --git a/arch/mips/bcm53000/hndpci.c b/arch/mips/bcm53000/hndpci.c
index c1f5450..450ecd1 100644
--- a/arch/mips/bcm53000/hndpci.c
+++ b/arch/mips/bcm53000/hndpci.c
@@ -96,6 +96,7 @@ static uint8 pci_hbslot = 0;
 /* Internal macros */
 #define PCI_SLOTAD_MAP  16	/* SLOT<n> mapps to AD<n+16> */
 #define PCI_HBSBCFG_REV 8	/* MIN corerev to access host bridge PCI cfg space from SB */
+#define PCI_ACCESS_DELAY 500	/* PCI config space access delay in microsec */
 
 /* Functions for accessing external PCI configuration space, Assume one-hot slot wiring */
 #define PCI_SLOT_MAX    16	/* Max. PCI Slots */
@@ -567,8 +568,14 @@ hndpci_read_config(si_t *sih, uint bus, uint dev, uint func, uint off,
 {
     if (bus == 0)
 	return si_read_config(sih, bus, dev, func, off, buf, len);
-    else
+    else {
+	/* The external PCI configuration space registers need time on 
+	 * responding to the read operation, delay for the response.
+	 * The read without delay would cause device enumeration failure!
+	 */
+	udelay(PCI_ACCESS_DELAY);
 	return extpci_read_config(sih, bus, dev, func, off, buf, len);
+    }
 }
 
 int
-- 
1.7.0.4

