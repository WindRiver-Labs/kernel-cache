From fc6c1e8db206367abc64663230ef793d5a47cbeb Mon Sep 17 00:00:00 2001
From: Moffatt, Greg <Greg.Moffatt@windriver.com>
Date: Tue, 11 Aug 2009 20:29:17 +0200
Subject: [PATCH] mips/cavium: kexec management port special handling

For cavium targets where the management port is used for booting
kexec fails to mount the rootfs.  The management ports require
some special handling and notification to correctly re-initialize
after a kexec.  If a kexec has just occurred, the mac address
for the mgmt port will be derived from the bootinfo, rather than
being set later by the interface initialization.

Signed-off-by: Greg Moffatt <greg.moffatt@windriver.com>
---
 arch/mips/cavium-octeon/executive/cvmx-mgmt-port.c |   21 +++++++++++++++++--
 1 files changed, 18 insertions(+), 3 deletions(-)

diff --git a/arch/mips/cavium-octeon/executive/cvmx-mgmt-port.c b/arch/mips/cavium-octeon/executive/cvmx-mgmt-port.c
index 9cb9ed9..a42bc6c 100644
--- a/arch/mips/cavium-octeon/executive/cvmx-mgmt-port.c
+++ b/arch/mips/cavium-octeon/executive/cvmx-mgmt-port.c
@@ -153,12 +153,16 @@ cvmx_mgmt_port_result_t cvmx_mgmt_port_initialize(int port)
 		}
 	}
 
+	/* see if we stored a MAC from a previous kernel */
+	uint64_t *prev_mac = cvmx_bootmem_find_named_block("kexec_previous_mac");
+
 	/* Reset the MIX block if the previous user had a different TX ring size */
 	mix_ctl.u64 = cvmx_read_csr(CVMX_MIXX_CTL(port));
 	if (!mix_ctl.s.reset)
 	{
 		oring1.u64 = cvmx_read_csr(CVMX_MIXX_ORING1(port));
-		if (oring1.s.osize != CVMX_MGMT_PORT_NUM_TX_BUFFERS)
+		if (oring1.s.osize != CVMX_MGMT_PORT_NUM_TX_BUFFERS || 
+			cvmx_mgmt_port_state_ptr[port].tx_ring[0].u64 == 0)
 		{
 			mix_ctl.u64 = cvmx_read_csr(CVMX_MIXX_CTL(port));
 			mix_ctl.s.en = 0;
@@ -211,8 +215,19 @@ cvmx_mgmt_port_result_t cvmx_mgmt_port_initialize(int port)
 			state->phy_id = port;	/* Will need to be change to match the board */
 
 		/* Create a default MAC address */
-		state->mac = 0x000000dead000000ull;
-		state->mac += 0xffffff & CAST64(state);
+		if(prev_mac) {
+			/* get the mac from the bootinfo */
+			cvmx_sysinfo_t *sysinfo = cvmx_sysinfo_get();
+			state->mac = 0ull;
+			for(i=0; i < 6; i++) {
+				state->mac = state->mac << 8;
+				state->mac += (uint64_t)sysinfo->mac_addr_base[i];
+			}
+			cvmx_bootmem_free_named("kexec_previous_mac");
+		} else {
+			state->mac = 0x000000dead000000ull;
+			state->mac += 0xffffff & CAST64(state);
+		}
 
 		/* Setup the TX ring */
 		for (i = 0; i < CVMX_MGMT_PORT_NUM_TX_BUFFERS; i++) {
-- 
1.6.3.3

