From f7d2066e960c5db5d780c06cc8e14975c21cf98d Mon Sep 17 00:00:00 2001
From: Benjamin Walsh <benjamin.walsh@windriver.com>
Date: Mon, 13 Jul 2009 13:00:58 -0400
Subject: [PATCH 2/2] Cavium/kexec: Add cavium handler for page validity check on crash kernel

The generic MIPS crash dump code has a default handler that always
return true when checking for page frame validity when copying the
vmcore file. The cavium needs specific handling by checking validity
of pages via pfn_present and pfn_valid.

Signed-off-by: Benjamin Walsh <benjamin.walsh@windriver.com>
---
 arch/mips/cavium-octeon/hal.c   |   16 ++++++++++++++++
 arch/mips/cavium-octeon/hal.h   |    3 +++
 arch/mips/cavium-octeon/setup.c |    3 +++
 3 files changed, 22 insertions(+), 0 deletions(-)

diff --git a/arch/mips/cavium-octeon/hal.c b/arch/mips/cavium-octeon/hal.c
index 8c2205d..e6895c0 100644
--- a/arch/mips/cavium-octeon/hal.c
+++ b/arch/mips/cavium-octeon/hal.c
@@ -56,6 +56,14 @@ extern void (*_machine_kexec_shutdown)(void);
 extern void (*_machine_crash_shutdown)(struct pt_regs *);
 #endif
 
+#ifdef CONFIG_CRASH_DUMP
+extern int (*_machine_check_pfn_validity)(unsigned long pfn);
+static int octeon_check_pfn_validity(unsigned long pfn)
+{
+	return (pfn_present(pfn) && pfn_valid(pfn));
+}
+#endif
+
 /**
  * Write to the LCD display connected to the bootbus. This display
  * exists on most Cavium evaluation boards. If it doesn't exist, then
@@ -906,3 +914,11 @@ void octeon_kexec_setup(void)
 	_machine_crash_shutdown = &octeon_crash_shutdown;
 }
 #endif /* CONFIG_KEXEC */
+
+#ifdef CONFIG_CRASH_DUMP
+void octeon_crash_dump_setup(void)
+{
+	_machine_check_pfn_validity = octeon_check_pfn_validity;
+}
+#endif
+
diff --git a/arch/mips/cavium-octeon/hal.h b/arch/mips/cavium-octeon/hal.h
index 162e952..ff829ae 100644
--- a/arch/mips/cavium-octeon/hal.h
+++ b/arch/mips/cavium-octeon/hal.h
@@ -140,5 +140,8 @@ extern void octeon_shutdown_network_hw(void);
 extern void octeon_kexec_shutdown(void);
 extern void octeon_kexec_setup(void);
 #endif
+#ifdef CONFIG_CRASH_DUMP
+void octeon_crash_dump_setup(void);
+#endif
 
 #endif
diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index b6b5f83..20b9887 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -291,6 +291,9 @@ void __init prom_init(void)
 	octeon_kexec_setup();
 	octeon_shutdown_network_hw();
 #endif
+#ifdef CONFIG_CRASH_DUMP
+	octeon_crash_dump_setup();
+#endif
 }
 
 /* constants for memory initialization */
-- 
1.6.3.1

