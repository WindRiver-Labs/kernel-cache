From cdd51d02094573165b42f694359356dae4f0c461 Mon Sep 17 00:00:00 2001
From: Phil Staub <phil.staub@windriver.com>
Date: Mon, 3 Nov 2008 09:41:49 -0800
Subject: [PATCH] Cavium: Use Simple Exec layer if available

Make adjustments to Makefiles that reference OCTEON_ROOT such that the
build uses the Simple Exec sources in the sysroot if they have been
installed. Otherwise, use sources in the kernel tree. This allows a usable
kernel to built with or without the Simple Exec integration layer present.

Signed-off-by: Phil Staub <Phil.Staub@windriver.com>
---
 arch/mips/cavium-octeon/Makefile               |   12 ++++++++--
 arch/mips/cavium-octeon/gpl-executive/Makefile |   26 +++++++++++++++++++----
 arch/mips/kernel/Makefile                      |    9 +++++--
 arch/mips/mm/Makefile                          |    7 +++--
 drivers/i2c/busses/Makefile                    |    6 +++-
 drivers/net/cavium-ethernet/Makefile           |    6 +++-
 6 files changed, 48 insertions(+), 18 deletions(-)

diff --git a/arch/mips/cavium-octeon/Makefile b/arch/mips/cavium-octeon/Makefile
index 75c2816..e33aa5c 100644
--- a/arch/mips/cavium-octeon/Makefile
+++ b/arch/mips/cavium-octeon/Makefile
@@ -9,9 +9,15 @@
 # Copyright (C) 2005-2007 Cavium Networks
 #
 
-OCTEON_ROOT = $(srctree)/arch/mips/cavium-octeon
-EXTRA_CFLAGS +=	-I$(OCTEON_ROOT)/gpl-executive/config \
-		-I$(OCTEON_ROOT)/executive
+OCTEON_ROOT_IN_KERNEL = $(srctree)/arch/mips/cavium-octeon
+OCTEON_ROOT = $(srctree)/../../host-cross/mips-wrs-linux-gnu/sysroot/usr/include/simple_exec_open
+
+CAVIUM_INCLUDES := -I$(OCTEON_ROOT)/target/include \
+		   -I$(OCTEON_ROOT_IN_KERNEL)/executive
+
+# Common flags
+EXTRA_CFLAGS += ${CAVIUM_INCLUDES}
+
 
 obj-y := setup.o serial.o irq.o hal.o perf_counters.o octeon_info.o
 obj-y += dma-octeon.o userio.o
diff --git a/arch/mips/cavium-octeon/gpl-executive/Makefile b/arch/mips/cavium-octeon/gpl-executive/Makefile
index 7515e3a..420b0b4 100644
--- a/arch/mips/cavium-octeon/gpl-executive/Makefile
+++ b/arch/mips/cavium-octeon/gpl-executive/Makefile
@@ -8,11 +8,21 @@
 #
 # Copyright (C) 2005-2007 Cavium Networks
 #
-export OCTEON_ROOT = $(srctree)/arch/mips/cavium-octeon
+
+OCTEON_ROOT_IN_KERNEL = $(srctree)/arch/mips/cavium-octeon
+
+# make this visible to the cvmx-config script
+export OCTEON_ROOT = $(srctree)/../../host-cross/mips-wrs-linux-gnu/sysroot/usr/include/simple_exec_open
+
+CAVIUM_INCLUDES := -I$(OCTEON_ROOT)/target/include \
+		   -I$(OCTEON_ROOT_IN_KERNEL)/executive
+
+# Common flags
+EXTRA_CFLAGS += ${CAVIUM_INCLUDES}
 
 source:=$(srctree)/$(src)
 
-EXTRA_CFLAGS += -I $(obj)/config -I $(source)/config -I $(OCTEON_ROOT)/executive
+EXTRA_CFLAGS += -I $(obj)/config -I $(source)/config
 
 executive-files := cvmx-bootmem.o
 executive-files += cvmx-cmd-queue.o
@@ -53,10 +63,16 @@ executive-src-files := $(executive-obj-files:%.o=%.c)
 cvmx-linux-kernel-exports.o $(executive-src-files): $(obj)/config/cvmx-config.h
 
 $(executive-src-files):
-	$(Q)ln -fs $(@:$(obj)/%.c=$(OCTEON_ROOT)/executive/%.c) $@
+	$(Q)if [ -d ${OCTEON_ROOT} ] ; then \
+		ln -fs $(@:$(obj)/%.c=${OCTEON_ROOT}/executive/%.c) $@ ; \
+	else \
+		ln -fs $(@:$(obj)/%.c=${OCTEON_ROOT_IN_KERNEL}/executive/%.c) $@ ; \
+	fi;
 
-#$(obj)/config/cvmx-config.h: $(source)/config/executive-config.h
-#	cd $(obj) && cvmx-config $< 
+$(obj)/config/cvmx-config.h: $(source)/config/executive-config.h
+	if [ -d ${OCTEON_ROOT} ] ; then \
+		cd $(obj) && ${OCTEON_ROOT}/host/bin/cvmx-config $< ; \
+	fi;
 
 clean:
 	rm -f *.o $(executive-src-files)
diff --git a/arch/mips/kernel/Makefile b/arch/mips/kernel/Makefile
index 019dc06..10b4bec 100644
--- a/arch/mips/kernel/Makefile
+++ b/arch/mips/kernel/Makefile
@@ -99,8 +99,11 @@ obj-$(CONFIG_HAVE_STD_PC_SERIAL_PORT)	+= 8250-platform.o
 #EXTRA_CFLAGS += -Werror
 
 ifdef CONFIG_CPU_CAVIUM_OCTEON
-OCTEON_ROOT = $(srctree)/arch/mips/cavium-octeon
+OCTEON_ROOT_IN_KERNEL = $(srctree)/arch/mips/cavium-octeon
+OCTEON_ROOT = $(srctree)/../../host-cross/mips-wrs-linux-gnu/sysroot/usr/include/simple_exec_open
 
-CFLAGS_irq-octeon.o    = -I$(OCTEON_ROOT)/executive
-CFLAGS_ptrace.o        = -I$(OCTEON_ROOT)/executive
+CFLAGS_irq-octeon.o    = -I$(OCTEON_ROOT)/target/include \
+			 -I$(OCTEON_ROOT_IN_KERNEL)/executive
+CFLAGS_ptrace.o        = -I$(OCTEON_ROOT)/target/include \
+			 -I$(OCTEON_ROOT_IN_KERNEL)/executive
 endif
diff --git a/arch/mips/mm/Makefile b/arch/mips/mm/Makefile
index 4ad0194..8a8116b 100644
--- a/arch/mips/mm/Makefile
+++ b/arch/mips/mm/Makefile
@@ -2,7 +2,8 @@
 # Makefile for the Linux/MIPS-specific parts of the memory manager.
 #
 
-OCTEON_ROOT = $(srctree)/arch/mips/cavium-octeon
+OCTEON_ROOT_IN_KERNEL = $(srctree)/arch/mips/cavium-octeon
+OCTEON_ROOT = $(srctree)/../../host-cross/mips-wrs-linux-gnu/sysroot/usr/include/simple_exec_open
 
 obj-y				+= cache.o extable.o fault.o \
 				   init.o tlbex.o tlbex-fault.o uasm.o
@@ -51,6 +52,6 @@ obj-$(CONFIG_MIPS_CPU_SCACHE)	+= sc-mips.o
 
 EXTRA_CFLAGS += -Werror
 
-OCTEON_ROOT = $(srctree)/arch/mips/cavium-octeon
-CFLAGS_c-octeon.o	= -I$(OCTEON_ROOT)/executive
+CFLAGS_c-octeon.o	= -I$(OCTEON_ROOT)/target/include \
+			  -I$(OCTEON_ROOT_IN_KERNEL)/executive
 
diff --git a/drivers/i2c/busses/Makefile b/drivers/i2c/busses/Makefile
index 104d0a5..6c364e0 100644
--- a/drivers/i2c/busses/Makefile
+++ b/drivers/i2c/busses/Makefile
@@ -74,7 +74,9 @@ EXTRA_CFLAGS += -DDEBUG
 endif
 
 ifdef CONFIG_I2C_OCTEON_TWSI
-OCTEON_ROOT = $(srctree)/arch/mips/cavium-octeon
+OCTEON_ROOT_IN_KERNEL = $(srctree)/arch/mips/cavium-octeon
+OCTEON_ROOT = $(srctree)/../../host-cross/mips-wrs-linux-gnu/sysroot/usr/include/simple_exec_open
 
-CFLAGS_i2c-octeon_twsi.o	= -I$(OCTEON_ROOT)/executive
+CFLAGS_i2c-octeon_twsi.o	= -I$(OCTEON_ROOT)/target/include \
+				  -I$(OCTEON_ROOT_IN_KERNEL)/executive
 endif
diff --git a/drivers/net/cavium-ethernet/Makefile b/drivers/net/cavium-ethernet/Makefile
index e439c9d..3127060 100644
--- a/drivers/net/cavium-ethernet/Makefile
+++ b/drivers/net/cavium-ethernet/Makefile
@@ -40,12 +40,14 @@
 # OF USE OR PERFORMANCE OF THE SOFTWARE LIES WITH YOU.
 
 # Common flags to be passed for driver compilation
-OCTEON_ROOT = $(srctree)/arch/mips/cavium-octeon
+OCTEON_ROOT_IN_KERNEL = $(srctree)/arch/mips/cavium-octeon
+OCTEON_ROOT = $(srctree)/../../host-cross/mips-wrs-linux-gnu/sysroot/usr/include/simple_exec_open
 
 EXTRA_CFLAGS += -Winline -Wall \
 	-I arch/mips/cavium-octeon/gpl-executive/config \
 	-I $(srctree)/arch/mips/cavium-octeon/gpl-executive/config \
-	-I ${OCTEON_ROOT}/executive
+	-I ${OCTEON_ROOT}/target/include \
+	-I ${OCTEON_ROOT_IN_KERNEL}/executive
 
 obj-${CONFIG_CAVIUM_ETHERNET} :=  cavium-ethernet.o
 
-- 
1.6.0.4

