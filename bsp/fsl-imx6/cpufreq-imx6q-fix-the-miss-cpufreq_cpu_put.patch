From 1123589ada239a4acf9f260e384b27e04bd010f1 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Tue, 25 Feb 2014 13:29:04 +0800
Subject: [PATCH 1070/1072] cpufreq: imx6q: fix the miss cpufreq_cpu_put

The cpufreq_cpu_get function tries to get cpufreq_rwsem
in the suspend, but it is not released. When the system
suspends again, cpufreq_cpu_get will return NULL. So all
reference the NULL value will hang the system.

imx6_cpufreq_pm_notify -> cpufreq_cpu_get
		       -> cpufreq_update_policy -> cpufreq_cpu_get

[ BUG: lock held at task exit time! ]
rtcwakeup.out/582 is exiting with locks still held!
2 locks held by rtcwakeup.out/582:
 #0:  (cpufreq_rwsem){......}, at: [<8054a588>] cpufreq_cpu_get+0x48/0xe4
 #1:  (cpufreq_rwsem){......}, at: [<8054a588>] cpufreq_cpu_get+0x48/0xe4

stack backtrace:
CPU: 3 PID: 582 Comm: rtcwakeup.out Not tainted 3.10.19-WR6.0.0.0_standard #15
[<80015e44>] (unwind_backtrace+0x0/0x100) from [<80012804>] (show_stack+0x20/0x24)
[<80012804>] (show_stack+0x20/0x24) from [<807a8ab4>] (dump_stack+0x24/0x28)
[<807a8ab4>] (dump_stack+0x24/0x28) from [<80084910>] (debug_check_no_locks_held+0x9c/0xa0)
[<80084910>] (debug_check_no_locks_held+0x9c/0xa0) from [<8002fefc>] (do_exit+0x608/0x988)
[<8002fefc>] (do_exit+0x608/0x988) from [<80030318>] (do_group_exit+0x50/0xc0)
[<80030318>] (do_group_exit+0x50/0xc0) from [<800303a8>] (__wake_up_parent+0x0/0x30)
[<800303a8>] (__wake_up_parent+0x0/0x30) from [<8000e5c0>] (ret_fast_syscall+0x0/0x48)

Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 drivers/cpufreq/cpufreq-imx6.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/cpufreq/cpufreq-imx6.c b/drivers/cpufreq/cpufreq-imx6.c
index eb7baac..4773295 100644
--- a/drivers/cpufreq/cpufreq-imx6.c
+++ b/drivers/cpufreq/cpufreq-imx6.c
@@ -281,6 +281,7 @@ static int imx6_cpufreq_pm_notify(struct notifier_block *nb,
 		break;
 	}
 
+	cpufreq_cpu_put(data);
 	cpufreq_update_policy(0);
 
 	return NOTIFY_OK;
-- 
1.7.5.4

