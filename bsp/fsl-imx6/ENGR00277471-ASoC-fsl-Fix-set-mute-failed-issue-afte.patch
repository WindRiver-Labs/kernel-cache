From 1b551deff2d69f36c7296f40f362ca49c72e8a24 Mon Sep 17 00:00:00 2001
From: Nicolin Chen <b42378@freescale.com>
Date: Fri, 30 Aug 2013 16:02:35 +0800
Subject: [PATCH 0518/1072] ENGR00277471 ASoC: fsl: Fix set-mute-failed issue
 after WM8962 capture

git://git.freescale.com/imx/linux-2.6-imx.git imx_3.10.17_1.0.0_beta
commit 47cdfa9f7a155192c750783b409e40bde2b40fba

We only need to mute WM8962 after playback, so add direction check
before doing mute.

And a mute failure would cause hw_free() abruptly return after it,
which might drop the essential procedure code for FLL controlling.
Thus put mute before FLL controlling code and drop its return check.

Acked-by: Wang Shengjiu <b02247@freescale.com>
Signed-off-by: Nicolin Chen <b42378@freescale.com>
Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 sound/soc/fsl/imx-wm8962.c |   17 +++++++----------
 1 files changed, 7 insertions(+), 10 deletions(-)

diff --git a/sound/soc/fsl/imx-wm8962.c b/sound/soc/fsl/imx-wm8962.c
index 504c735..56aaaa7 100644
--- a/sound/soc/fsl/imx-wm8962.c
+++ b/sound/soc/fsl/imx-wm8962.c
@@ -122,6 +122,13 @@ static int imx_hifi_hw_free(struct snd_pcm_substream *substream)
 
 	if (!priv->first_stream) {
 		/*
+		 * Continuously setting FLL would cause playback distortion.
+		 * We can fix it just by mute codec after playback.
+		 */
+		if (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)
+			snd_soc_dai_digital_mute(codec_dai, 1, substream->stream);
+
+		/*
 		 * WM8962 doesn't allow us to continuously setting FLL,
 		 * So we set MCLK as sysclk once, which'd remove the limitation.
 		 */
@@ -132,16 +139,6 @@ static int imx_hifi_hw_free(struct snd_pcm_substream *substream)
 			return ret;
 		}
 
-		/*
-		 * Continuously setting FLL would cause playback distortion.
-		 * We can fix it just by mute codec after playback.
-		 */
-		ret = snd_soc_dai_digital_mute(codec_dai, 1, substream->stream);
-		if (ret < 0) {
-			dev_err(dev, "failed to set MUTE: %d\n", ret);
-			return ret;
-		}
-
 		/* Disable FLL and let codec do pm_runtime_put() */
 		ret = snd_soc_dai_set_pll(codec_dai, WM8962_FLL,
 				WM8962_FLL_MCLK, 0, 0);
-- 
1.7.5.4

