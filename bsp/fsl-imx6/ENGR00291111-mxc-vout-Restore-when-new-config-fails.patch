From fb87dda9f609fe0230e58d6572991ec325f9f033 Mon Sep 17 00:00:00 2001
From: Liu Ying <Ying.Liu@freescale.com>
Date: Tue, 10 Dec 2013 17:28:09 +0800
Subject: [PATCH 0868/1072] ENGR00291111 mxc vout:Restore when new config
 fails

git://git.freescale.com/imx/linux-2.6-imx.git imx_3.10.17_1.0.0_beta
commit 98e62d0bf4cbea3e058aa02b47690f100d90820b

Users may call VIDIOC_S_CTRL and VIDIOC_S_CROP ioctrls
to change rotation and cropping settings when streaming.
The driver should restore the original settings if new
configuration fails, otherwise, it might break the
present pipeline.

This patch fixes the issue which can be reproduced by
this test case with a 1080P HDMI primary display:
gplay Mpeg4_SP1_480x260_24_1200_aac_48_128_2_terminator3.mp4
Type 't' to set rotation to 90.

Signed-off-by: Liu Ying <Ying.Liu@freescale.com>
(cherry picked from commit 9407867d7f05e4246aab5a9e383c01099a464958)
Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 drivers/media/platform/mxc/output/mxc_vout.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/media/platform/mxc/output/mxc_vout.c b/drivers/media/platform/mxc/output/mxc_vout.c
index 05b9d93..bd7d1f0 100644
--- a/drivers/media/platform/mxc/output/mxc_vout.c
+++ b/drivers/media/platform/mxc/output/mxc_vout.c
@@ -1515,6 +1515,7 @@ static int mxc_vidioc_s_crop(struct file *file, void *fh,
 		if (ret < 0) {
 			v4l2_err(vout->vfd->v4l2_dev,
 					"vout check task failed\n");
+			memcpy(vout, pre_vout, sizeof(*vout));
 			goto done;
 		}
 
@@ -1683,6 +1684,7 @@ static int mxc_vidioc_s_ctrl(struct file *file, void *fh,
 		if (ret < 0) {
 			v4l2_err(vout->vfd->v4l2_dev,
 					"vout check task failed\n");
+			memcpy(vout, pre_vout, sizeof(*vout));
 			goto done;
 		}
 
-- 
1.7.5.4

