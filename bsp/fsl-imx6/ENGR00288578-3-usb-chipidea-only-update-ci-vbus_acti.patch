From bbd80a0575f53f7d103d879236878bbc0f0cd53b Mon Sep 17 00:00:00 2001
From: Peter Chen <peter.chen@freescale.com>
Date: Tue, 19 Nov 2013 14:29:33 +0800
Subject: [PATCH 0743/1072] ENGR00288578-3 usb: chipidea: only update
 ci->vbus_active at peripheral mode

git://git.freescale.com/imx/linux-2.6-imx.git imx_3.10.17_1.0.0_beta
commit d0dd347816b0f6a9465bb1584a881208fcda0439

If we connect between otg-host and host pc with Male-A-To-Male-A cable,
the ci->vbus_active will be error, and cause the controller run when
we load gadget module (ci_udc_start will be run), it causes the kernel
panic since no one will handle irq at that mode.

Signed-off-by: Peter Chen <peter.chen@freescale.com>
(cherry picked from commit 4f08812d63678db21308b1c73fae0775665ff9c2)
Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 drivers/usb/chipidea/core.c |    4 ++++
 drivers/usb/chipidea/udc.c  |    3 ---
 2 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/drivers/usb/chipidea/core.c b/drivers/usb/chipidea/core.c
index a940de8..96b15fd 100644
--- a/drivers/usb/chipidea/core.c
+++ b/drivers/usb/chipidea/core.c
@@ -653,6 +653,10 @@ static int ci_hdrc_probe(struct platform_device *pdev)
 			: CI_ROLE_GADGET;
 	}
 
+	/* Notify vbus connected event if it is existed */
+	if (ci->role == CI_ROLE_GADGET)
+		ci_handle_vbus_connected(ci);
+
 	ret = ci_role_start(ci, ci->role);
 	if (ret) {
 		dev_err(dev, "can't start %s role\n", ci_role(ci)->name);
diff --git a/drivers/usb/chipidea/udc.c b/drivers/usb/chipidea/udc.c
index 2359ce5..cf746ca 100644
--- a/drivers/usb/chipidea/udc.c
+++ b/drivers/usb/chipidea/udc.c
@@ -1821,9 +1821,6 @@ static int udc_start(struct ci_hdrc *ci)
 	pm_runtime_no_callbacks(&ci->gadget.dev);
 	pm_runtime_enable(&ci->gadget.dev);
 
-	/* Notify vbus connected event if it is existed */
-	ci_handle_vbus_connected(ci);
-
 	return retval;
 
 destroy_eps:
-- 
1.7.5.4

