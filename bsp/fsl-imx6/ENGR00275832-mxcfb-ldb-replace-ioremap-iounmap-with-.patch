From cf5fd069381cb8816fb161ad3c4d9ea5e2c49784 Mon Sep 17 00:00:00 2001
From: Liu Ying <Ying.Liu@freescale.com>
Date: Tue, 20 Aug 2013 14:19:46 +0800
Subject: [PATCH 0557/1072] ENGR00275832 mxcfb: ldb: replace ioremap/iounmap
 with devm_ioremap

git://git.freescale.com/imx/linux-2.6-imx.git imx_3.10.17_1.0.0_beta
commit 031e1e6c295f93a30ab66cfd736272a64455fa90

This patch replaces ioremap()/iounmap() with devm_ioremap() to
simplify the code.

Signed-off-by: Liu Ying <Ying.Liu@freescale.com>
Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 drivers/video/mxc/ldb.c |    9 ++-------
 1 files changed, 2 insertions(+), 7 deletions(-)

diff --git a/drivers/video/mxc/ldb.c b/drivers/video/mxc/ldb.c
index 8cba8bc..cd7c61a 100644
--- a/drivers/video/mxc/ldb.c
+++ b/drivers/video/mxc/ldb.c
@@ -530,7 +530,6 @@ static int ldb_disp_init(struct mxc_dispdrv_handle *disp,
 	struct ldb_data *ldb = mxc_dispdrv_getdata(disp);
 	struct fsl_mxc_ldb_platform_data *plat_data = ldb->pdev->dev.platform_data;
 	struct resource *res;
-	uint32_t base_addr;
 	uint32_t reg, setting_idx;
 	uint32_t ch_mask = 0, ch_val = 0;
 	uint32_t ipu_id, disp_id;
@@ -554,8 +553,8 @@ static int ldb_disp_init(struct mxc_dispdrv_handle *disp,
 			return -ENOMEM;
 		}
 
-		base_addr = res->start;
-		ldb->reg = ioremap(base_addr, res->end - res->start + 1);
+		ldb->reg = devm_ioremap(&ldb->pdev->dev, res->start,
+					resource_size(res));
 		ldb->control_reg = ldb->reg + 2;
 		ldb->gpr3_reg = ldb->reg + 3;
 
@@ -708,7 +707,6 @@ static int ldb_disp_init(struct mxc_dispdrv_handle *disp,
 								ldb_clk);
 		if (IS_ERR(ldb->setting[setting_idx].ldb_di_clk)) {
 			dev_err(&ldb->pdev->dev, "get ldb clk0 failed\n");
-			iounmap(ldb->reg);
 			return PTR_ERR(ldb->setting[setting_idx].ldb_di_clk);
 		}
 		di_clk[3] += setting->dev_id;
@@ -717,7 +715,6 @@ static int ldb_disp_init(struct mxc_dispdrv_handle *disp,
 								di_clk);
 		if (IS_ERR(ldb->setting[setting_idx].di_clk)) {
 			dev_err(&ldb->pdev->dev, "get di clk0 failed\n");
-			iounmap(ldb->reg);
 			return PTR_ERR(ldb->setting[setting_idx].di_clk);
 		}
 
@@ -876,8 +873,6 @@ static void ldb_disp_deinit(struct mxc_dispdrv_handle *disp)
 	}
 
 	fb_unregister_client(&ldb->nb);
-
-	iounmap(ldb->reg);
 }
 
 static struct mxc_dispdrv_driver ldb_drv = {
-- 
1.7.5.4

