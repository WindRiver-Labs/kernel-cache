From 6703fd1459aefc44f4209a4bceda6ae20c88436a Mon Sep 17 00:00:00 2001
From: Anson Huang <b20788@freescale.com>
Date: Wed, 14 Aug 2013 13:26:54 -0400
Subject: [PATCH 0116/1072] ENGR00275023-3 ARM: imx: Correct CCM setting for
 DSM mode

git://git.freescale.com/imx/linux-2.6-imx.git imx_3.10.17_1.0.0_beta
commit 0b0929a9554763b7a0942552e63c29fc5af48a5e

RBC is already enabled right before suspend, so no need to
enable it in the CCM lpm setting;

Need to disable CCM int_mem_clk_lpm before entering DSM and
enable it after resume, as the whole ARM core will be powered
down in DSM.

Signed-off-by: Anson Huang <b20788@freescale.com>
Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 arch/arm/mach-imx/clk-imx6q.c |    1 -
 arch/arm/mach-imx/pm-imx6q.c  |    2 ++
 2 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-imx/clk-imx6q.c b/arch/arm/mach-imx/clk-imx6q.c
index 9d0253b..3b01484 100644
--- a/arch/arm/mach-imx/clk-imx6q.c
+++ b/arch/arm/mach-imx/clk-imx6q.c
@@ -191,7 +191,6 @@ int imx6q_set_lpm(enum mxc_cpu_pwr_mode mode)
 		val |= BM_CLPCR_VSTBY;
 		val |= BM_CLPCR_SBYOS;
 		imx6q_enable_wb(true);
-		imx6q_enable_rbc(true);
 		break;
 	default:
 		imx_gpc_irq_mask(&desc->irq_data);
diff --git a/arch/arm/mach-imx/pm-imx6q.c b/arch/arm/mach-imx/pm-imx6q.c
index f86c762..0095916 100644
--- a/arch/arm/mach-imx/pm-imx6q.c
+++ b/arch/arm/mach-imx/pm-imx6q.c
@@ -47,6 +47,7 @@ static int imx6q_pm_enter(suspend_state_t state)
 {
 	switch (state) {
 	case PM_SUSPEND_MEM:
+		imx6q_set_cache_lpm_in_wait(false);
 		imx6q_set_lpm(STOP_POWER_OFF);
 		imx_gpc_pre_suspend();
 		imx_anatop_pre_suspend();
@@ -56,6 +57,7 @@ static int imx6q_pm_enter(suspend_state_t state)
 		imx_smp_prepare();
 		imx_anatop_post_resume();
 		imx_gpc_post_resume();
+		imx6q_set_cache_lpm_in_wait(true);
 		imx6q_set_lpm(WAIT_CLOCKED);
 		break;
 	default:
-- 
1.7.5.4

