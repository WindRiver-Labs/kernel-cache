From 494e42045f2da8a331680f7daac598666d39754b Mon Sep 17 00:00:00 2001
From: Peter Chen <peter.chen@freescale.com>
Date: Wed, 27 Nov 2013 15:35:42 +0800
Subject: [PATCH 0749/1072] ENGR00289855 usb: chipidea: udc: pull down dp
 before the charger detection

git://git.freescale.com/imx/linux-2.6-imx.git imx_3.10.17_1.0.0_beta
commit 72ddc9c8f537d0c326bc204a88bda1c4da21d191

If rom code or bootloader has used usb before loading kernel, the dp
may still be pulled up, it will cause USB charger detection fail.

Signed-off-by: Peter Chen <peter.chen@freescale.com>
Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 drivers/usb/chipidea/udc.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/usb/chipidea/udc.c b/drivers/usb/chipidea/udc.c
index 0b2023f..7ee9b92 100644
--- a/drivers/usb/chipidea/udc.c
+++ b/drivers/usb/chipidea/udc.c
@@ -1479,10 +1479,12 @@ static int ci_udc_vbus_session(struct usb_gadget *_gadget, int is_active)
 		 * It can make disconnect interrupt (BSV 1->0) occur when
 		 * the cable is disconnected.
 		 */
-		if (is_active)
+		if (is_active) {
 			pm_runtime_get_sync(&_gadget->dev);
-		else
+			hw_write(ci, OP_USBCMD, USBCMD_RS, 0);
+		} else {
 			pm_runtime_put_sync(&_gadget->dev);
+		}
 
 		ret = ci->platdata->notify_event
 			(ci, CI_HDRC_CONTROLLER_CHARGER_EVENT);
-- 
1.7.5.4

