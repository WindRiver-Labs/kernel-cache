From bc659497e0267da573638f6fa3a1d4efc85c61da Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Wed, 13 Mar 2013 17:35:20 +0800
Subject: [PATCH 13/13] ARM: imx: disable cpu in .cpu_kill hook

commit: 837576642167d701f983e4def0d3936b514a28ae upstream

It's buggy to disable the cpu that is being hot-unplugged in .cpu_die
hook which runs on the cpu itself.  Instead, it should be done in
.cpu_kill which runs on the thread (another cpu) that asks for shutting
down the cpu.  Move imx_enable_cpu(cpu, false) call into .cpu_kill
hook, and leave the cpu to be hot-unplugged in WFI within .cpu_die,
so that we can get a more stable cpu hot-plug operation.

Signed-off-by: Shawn Guo <shawn.guo@linaro.org>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-mx6/plat_hotplug.c |    5 +----
 1 files changed, 1 insertions(+), 4 deletions(-)

diff --git a/arch/arm/mach-mx6/plat_hotplug.c b/arch/arm/mach-mx6/plat_hotplug.c
index ab2be5f..6160df5 100644
--- a/arch/arm/mach-mx6/plat_hotplug.c
+++ b/arch/arm/mach-mx6/plat_hotplug.c
@@ -72,10 +72,7 @@ static inline void cpu_enter_lowpower(void)
 void platform_cpu_die(unsigned int cpu)
 {
 	cpu_enter_lowpower();
-
-	/* spin here until hardware takes it down */
-	while (1)
-	;
+	cpu_do_idle();
 }
 
 int platform_cpu_disable(unsigned int cpu)
-- 
1.7.0

