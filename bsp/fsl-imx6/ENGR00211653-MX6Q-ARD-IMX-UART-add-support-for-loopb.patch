From 1fe3655e8076702f96d421a064468ef217ebfdff Mon Sep 17 00:00:00 2001
From: Israel Perez <B37753@freescale.com>
Date: Thu, 28 Nov 2013 15:00:33 +0800
Subject: [PATCH 0417/1072] ENGR00211653 [MX6Q ARD] IMX UART add support for
 loopback mode.

git://git.freescale.com/imx/linux-2.6-imx.git imx_3.10.17_1.0.0_beta
commit a0f1e9be214ad6b759fee302f72c1d33e05612e0

ttymxc serial uart driver add  support loopback mode.
returns TIOCM_LOOP set when reading the status.

[original hash:42d5723   fix a litte for 3.10.17]
Signed-off-by: Israel Perez <B37753@freescale.com>
Signed-off-by: Huang Shijie <b32955@freescale.com>
Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 drivers/tty/serial/imx.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/drivers/tty/serial/imx.c b/drivers/tty/serial/imx.c
index 9a83b15..67c2d23 100644
--- a/drivers/tty/serial/imx.c
+++ b/drivers/tty/serial/imx.c
@@ -806,6 +806,9 @@ static unsigned int imx_get_mctrl(struct uart_port *port)
 	if (readl(sport->port.membase + UCR2) & UCR2_CTS)
 		tmp |= TIOCM_RTS;
 
+	if (readl(sport->port.membase + uts_reg(sport)) & UTS_LOOP)
+		tmp |= TIOCM_LOOP;
+
 	return tmp;
 }
 
@@ -821,6 +824,11 @@ static void imx_set_mctrl(struct uart_port *port, unsigned int mctrl)
 			temp |= UCR2_CTS;
 
 	writel(temp, sport->port.membase + UCR2);
+
+	temp = readl(sport->port.membase + uts_reg(sport)) & ~UTS_LOOP;
+	if (mctrl & TIOCM_LOOP)
+		temp |= UTS_LOOP;
+	writel(temp, sport->port.membase + uts_reg(sport));
 }
 
 /*
-- 
1.7.5.4

