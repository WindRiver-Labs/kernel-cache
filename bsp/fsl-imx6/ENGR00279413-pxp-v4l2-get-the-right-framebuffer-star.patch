From 7af00b731ea1dde1352376ba5ecad61703027c45 Mon Sep 17 00:00:00 2001
From: Robby Cai <R63905@freescale.com>
Date: Thu, 12 Sep 2013 19:11:54 +0800
Subject: [PATCH 0859/1072] ENGR00279413 pxp/v4l2: get the right framebuffer
 start address at run time

git://git.freescale.com/imx/linux-2.6-imx.git imx_3.10.17_1.0.0_beta
commit 002a35101a27eb0028cbce5df1d4037a00941320

Previously the driver gets the framebuffer start address at probe time.
But this address might be changed if the framebuffer drivers re-allocate
the frame buffers due to the application changes the yres_virtual.
As a result, some garbage data can be observed on display.
This patch adjusts the way to detect the start address at run time to
fix this problem.

Signed-off-by: Robby Cai <R63905@freescale.com>
Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 drivers/media/platform/mxc/output/mxc_pxp_v4l2.c |   12 ++++++++++++
 1 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c b/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c
index 6a57d2c..355b925 100644
--- a/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c
+++ b/drivers/media/platform/mxc/output/mxc_pxp_v4l2.c
@@ -291,6 +291,12 @@ static int pxp_show_buf(struct pxps *pxp, bool toshow)
 	struct fb_info *fbi = pxp->fbi;
 	int ret;
 
+	ret = pxp_set_fbinfo(pxp);
+	if (ret) {
+		dev_err(&pxp->pdev->dev, "failed to call pxp_set_fbinfo\n");
+		return ret;
+	}
+
 	console_lock();
 	fbi->fix.smem_start = toshow ?
 			pxp->outb_phys : (unsigned long)pxp->fb.base;
@@ -787,6 +793,12 @@ static int pxp_buf_prepare(struct videobuf_queue *q,
 					sizeof(struct pxp_layer_param));
 			} else if (pxp_conf->ol_param[0].combine_enable) {
 				/* Overlay */
+				ret = pxp_set_fbinfo(pxp);
+				if (ret) {
+					dev_err(&pxp->pdev->dev,
+						"call pxp_set_fbinfo failed");
+					goto fail;
+				}
 				pxp_conf->ol_param[0].paddr =
 						(dma_addr_t)pxp->fb.base;
 				pxp_conf->ol_param[0].width = pxp->fb.fmt.width;
-- 
1.7.5.4

