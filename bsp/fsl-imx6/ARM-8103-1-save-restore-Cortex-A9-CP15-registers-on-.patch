From 20a340c7141deaf6706d3c64e65e6472d99ce1f8 Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Thu, 21 Jul 2016 13:44:49 +0800
Subject: [PATCH] ARM: 8103/1: save/restore Cortex-A9 CP15 registers on
 suspend/resume

commit ddd0c53018222df6bd9b2f61c881887b56b75d88 upstream.

The CP15 diagnostic register holds ARM errata bits on Cortex-A9, so it
needs to be saved/restored on suspend/resume.  Otherwise, the
effectiveness of errata workaround gets lost together with diagnostic
register bit across suspend/resume cycle.  And the CP15 power control
register of Cortex-A9 shares the same problem.

The patch adds a couple of Cortex-A9 specific suspend/resume functions
to save/restore these two Cortex-A9 CP15 registers across the
suspend/resume cycle.

Not backport the upstream commit as its original form but just get
its key operation to fit for linux-3.4.

Signed-off-by: Shawn Guo <shawn.guo@freescale.com>
Acked-by: Nicolas Pitre <nico@linaro.org>
Signed-off-by: Russell King <rmk+kernel@arm.linux.org.uk>
Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 arch/arm/mach-mx6/mx6_suspend.S |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-mx6/mx6_suspend.S b/arch/arm/mach-mx6/mx6_suspend.S
index ca90014..cd4dd68 100644
--- a/arch/arm/mach-mx6/mx6_suspend.S
+++ b/arch/arm/mach-mx6/mx6_suspend.S
@@ -1056,6 +1056,11 @@ ddr_io_save_done:
 	mov	r6, lr			@ Store lr
 	stmfd	r0!, {r4-r6}
 
+	/* c15 registers */
+	mrc	p15, 0, r4, c15, c0, 1	@ Diagnostic register
+	mrc	p15, 0, r5, c15, c0, 0	@ Power register
+	stmfd	r0!, {r4-r5}
+
 	/* c1 and c2 registers */
 	mrc	p15, 0, r4, c1, c0, 2	@ CPACR
 	mrc	p15, 0, r5, c2, c0, 0	@ TTBR0
@@ -1524,6 +1529,11 @@ poll_dvfs_clear_2:
 	msr spsr_cxsf, r5		@ Restore spsr
 	mov lr, r6			@ Restore lr
 
+	/* c15 registers */
+	ldmea	r0!, {r4-r5}
+	mcr	p15, 0, r4, c15, c0, 1	@ Diagnostic register
+	mcr	p15, 0, r5, c15, c0, 0	@ Power register
+
 	/* c1 and c2 registers */
 	ldmea	r0!, {r4-r7}
 	mcr	p15, 0, r4, c1, c0, 2	@ CPACR
-- 
1.7.5.4

