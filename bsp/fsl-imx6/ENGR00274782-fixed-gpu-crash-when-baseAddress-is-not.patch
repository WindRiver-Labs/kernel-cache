From 7c5c657d66be97a30c2fc88510406da8eb2d8792 Mon Sep 17 00:00:00 2001
From: Xianzhong <b07117@freescale.com>
Date: Tue, 13 Aug 2013 23:16:24 +0800
Subject: [PATCH 0604/1072] ENGR00274782 fixed gpu crash when baseAddress is
 not 0 or 2G

git://git.freescale.com/imx/linux-2.6-imx.git imx_3.10.17_1.0.0_beta
commit ac7f08d49ada990c44c935c387ff94cf68e7e67f

The baseAddress of contiguousVidMem is the actual physical address
which is not subtracted by gpu baseAddress, but the allocated physical address
has been subtracted by gpu baseAddress in gckVIDMEM_Lock,
so the invalid offset is produced and used to calculate the logical address.

Signed-off-by: Xianzhong <b07117@freescale.com>
Acked-by: Shawn Guo
Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 .../hal/os/linux/kernel/gc_hal_kernel_linux.c      |    9 ++++++++-
 1 files changed, 8 insertions(+), 1 deletions(-)

diff --git a/drivers/mxc/gpu-viv/hal/os/linux/kernel/gc_hal_kernel_linux.c b/drivers/mxc/gpu-viv/hal/os/linux/kernel/gc_hal_kernel_linux.c
index 22c4071..de82c12 100644
--- a/drivers/mxc/gpu-viv/hal/os/linux/kernel/gc_hal_kernel_linux.c
+++ b/drivers/mxc/gpu-viv/hal/os/linux/kernel/gc_hal_kernel_linux.c
@@ -332,9 +332,16 @@ gckKERNEL_MapVideoMemoryEx(
         else
 #endif
         {
+            gctUINT32 baseAddress = 0;
+
+            if (Kernel->hardware->mmuVersion == 0)
+            {
+                gcmkONERROR(gckOS_GetBaseAddress(Kernel->os, &baseAddress));
+            }
+
             gcmkVERIFY_OK(
                 gckHARDWARE_SplitMemory(Kernel->hardware,
-                                        device->contiguousVidMem->baseAddress,
+                                        device->contiguousVidMem->baseAddress - baseAddress,
                                         &pool,
                                         &base));
         }
-- 
1.7.5.4

