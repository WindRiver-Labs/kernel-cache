From b970b4fdf5333330ea1099f9813c57b49ed45ef9 Mon Sep 17 00:00:00 2001
From: "yadi.hu@windriver.com" <yadi.hu@windriver.com>
Date: Mon, 29 Sep 2014 13:27:20 +0800
Subject: [PATCH] ARM: pcie: random link down issue after warm-rst

Source: git://git.freescale.com/imx/linux-2.6-imx.git imx_3.10.31_1.1.0_beta
commit ddd7803a15dd195dbc5030dc9acdc6b7a9e95fea

There are about 0.02% percentage on some imx6q/dl/solo hw boards,
random pcie link down when warm-reset is used. Make sure to clear
the ref_ssp_en bit16 of gpr1 before warm-rst, and set ref_ssp_en
after the pcie clks are stable to workaround it.

rootcause:
* gpr regisers wouldn't be reset by warm-rst, while the
ref_ssp_en is required to be reset by pcie. (work-around in u-boot)
* ref_ssp_en should be set after pcie clks are stable.
(work-around in kernel)

Signed-off-by: Richard Zhu <r65037@freescale.com>
Signed-off-by: Hu <yadi.hu@windriver.com>
---
 drivers/pci/host/pci-imx6.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/pci/host/pci-imx6.c b/drivers/pci/host/pci-imx6.c
index 0b963c8..1b88972 100644
--- a/drivers/pci/host/pci-imx6.c
+++ b/drivers/pci/host/pci-imx6.c
@@ -224,8 +224,6 @@ static int imx6_pcie_deassert_core_reset(struct pcie_port *pp)
 
 	regmap_update_bits(imx6_pcie->iomuxc_gpr, IOMUXC_GPR1,
 			IMX6Q_GPR1_PCIE_TEST_PD, 0 << 18);
-	regmap_update_bits(imx6_pcie->iomuxc_gpr, IOMUXC_GPR1,
-			IMX6Q_GPR1_PCIE_REF_CLK_EN, 1 << 16);
 	request_bus_freq(BUS_FREQ_HIGH);
 
 	ret = clk_prepare_enable(imx6_pcie->sata_ref_100m);
@@ -255,6 +253,10 @@ static int imx6_pcie_deassert_core_reset(struct pcie_port *pp)
 		goto err_pcie_axi;
 	}
 
+	udelay(10);
+	regmap_update_bits(imx6_pcie->iomuxc_gpr, IOMUXC_GPR1,
+			IMX6Q_GPR1_PCIE_REF_CLK_EN, 1 << 16);
+
 	/* allow the clocks to stabilize */
 	usleep_range(200, 500);
 
-- 
1.7.5.4

