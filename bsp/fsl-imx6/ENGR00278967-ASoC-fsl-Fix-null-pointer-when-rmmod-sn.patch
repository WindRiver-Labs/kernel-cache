From cf8a09822bf20a2f4f0fded660e25071aa323916 Mon Sep 17 00:00:00 2001
From: Nicolin Chen <b42378@freescale.com>
Date: Tue, 10 Sep 2013 17:25:52 +0800
Subject: [PATCH 0531/1072] ENGR00278967 ASoC: fsl: Fix null pointer when
 rmmod snd-soc-imx-hdmi

git://git.freescale.com/imx/linux-2.6-imx.git imx_3.10.17_1.0.0_beta
commit 2bf463e4cb92aec1a7b79352f84e78cd3ab2abcb

When rmmod snd-soc-imx-hdmi if loadable module feature of HDMI audio
is being used, there would be a kernel dump promt:
Unable to handle kernel NULL pointer dereference at virtual address

This was caused by inappropriate priv pointer fetching, thus fix it.

Acked-by: Wang Shengjiu <b02247@freescale.com>
Signed-off-by: Nicolin Chen <b42378@freescale.com>
Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 sound/soc/fsl/imx-hdmi-dma.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/sound/soc/fsl/imx-hdmi-dma.c b/sound/soc/fsl/imx-hdmi-dma.c
index 372f48c..b76bd79 100644
--- a/sound/soc/fsl/imx-hdmi-dma.c
+++ b/sound/soc/fsl/imx-hdmi-dma.c
@@ -1002,8 +1002,8 @@ static void imx_hdmi_dma_pcm_free(struct snd_pcm *pcm)
 {
 	int stream = SNDRV_PCM_STREAM_PLAYBACK;
 	struct snd_pcm_substream *substream = pcm->streams[stream].substream;
-	struct snd_pcm_runtime *runtime = substream->runtime;
-	struct hdmi_dma_priv *priv = runtime->private_data;
+	struct snd_soc_pcm_runtime *rtd = pcm->private_data;
+	struct hdmi_dma_priv *priv = dev_get_drvdata(rtd->platform->dev);
 
 	if (substream) {
 		snd_dma_free_pages(&substream->dma_buffer);
-- 
1.7.5.4

