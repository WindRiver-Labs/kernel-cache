From ed3177978020e0b3d933a7fce7dfa5cd3fc11705 Mon Sep 17 00:00:00 2001
From: Richard Zhu <r65037@freescale.com>
Date: Thu, 7 Nov 2013 16:34:15 +0800
Subject: [PATCH 0353/1072] ENGR00288563 Revert "ENGR00277654 imx: pcie:
 enable pcie lm errata when pcie is enabled"

git://git.freescale.com/imx/linux-2.6-imx.git imx_3.10.17_1.0.0_beta
commit a18ef65b897b7a6a12b25f5277cefad2b9307e1b

switch to community upstreamed pcie driver.
Revert "ENGR00277654 imx: pcie: enable pcie lm errata when pcie is enabled"
This reverts commit 72524b16f5cb4e13c1a194dda4cc0c4f206e4e46.

Signed-off-by: Richard Zhu <r65037@freescale.com>
Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 arch/arm/mach-imx/pm-imx6.c |   22 +++++++++-------------
 1 files changed, 9 insertions(+), 13 deletions(-)

diff --git a/arch/arm/mach-imx/pm-imx6.c b/arch/arm/mach-imx/pm-imx6.c
index 8ef90ee..aa73979 100644
--- a/arch/arm/mach-imx/pm-imx6.c
+++ b/arch/arm/mach-imx/pm-imx6.c
@@ -226,7 +226,7 @@ static int imx6_suspend_finish(unsigned long val)
 
 static int imx6_pm_enter(suspend_state_t state)
 {
-	struct regmap *g;
+	struct regmap *gpr;
 
 	/*
 	 * L2 can exit by 'reset' or Inband beacon (from remote EP)
@@ -234,15 +234,13 @@ static int imx6_pm_enter(suspend_state_t state)
 	 * So, toggle bit18 of GPR1, to fix errata
 	 * "PCIe PCIe does not support L2 Power Down"
 	 */
-	if (IS_ENABLED(CONFIG_PCIE_IMX)) {
-		g = syscon_regmap_lookup_by_compatible("fsl,imx6q-iomuxc-gpr");
-		if (IS_ERR(g)) {
-			pr_err("failed to find fsl,imx6q-iomux-gpr regmap\n");
-			return PTR_ERR(g);
-		}
-		regmap_update_bits(g, IOMUXC_GPR1, IMX6Q_GPR1_PCIE_TEST_PD,
-				IMX6Q_GPR1_PCIE_TEST_PD);
+	gpr = syscon_regmap_lookup_by_compatible("fsl,imx6q-iomuxc-gpr");
+	if (IS_ERR(gpr)) {
+		pr_err("failed to find fsl,imx6q-iomux-gpr regmap\n");
+		return PTR_ERR(gpr);
 	}
+	regmap_update_bits(gpr, IOMUXC_GPR1, IMX6Q_GPR1_PCIE_TEST_PD,
+			IMX6Q_GPR1_PCIE_TEST_PD);
 
 	switch (state) {
 	case PM_SUSPEND_STANDBY:
@@ -286,10 +284,8 @@ static int imx6_pm_enter(suspend_state_t state)
 	 * So, toggle bit18 of GPR1, to fix errata
 	 * "PCIe PCIe does not support L2 Power Down"
 	 */
-	if (IS_ENABLED(CONFIG_PCIE_IMX)) {
-		regmap_update_bits(g, IOMUXC_GPR1, IMX6Q_GPR1_PCIE_TEST_PD,
-				!IMX6Q_GPR1_PCIE_TEST_PD);
-	}
+	regmap_update_bits(gpr, IOMUXC_GPR1, IMX6Q_GPR1_PCIE_TEST_PD,
+			!IMX6Q_GPR1_PCIE_TEST_PD);
 
 	return 0;
 }
-- 
1.7.5.4

