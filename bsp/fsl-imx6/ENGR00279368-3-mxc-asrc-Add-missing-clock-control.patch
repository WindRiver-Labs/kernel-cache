From d266778935f0275dc3d2b54c6da192c1670a032d Mon Sep 17 00:00:00 2001
From: Nicolin Chen <b42378@freescale.com>
Date: Thu, 12 Sep 2013 14:56:36 +0800
Subject: [PATCH 0582/1072] ENGR00279368-3 mxc: asrc: Add missing clock
 control

git://git.freescale.com/imx/linux-2.6-imx.git imx_3.10.17_1.0.0_beta
commit 4c52ab44232f5786679391d3b0ee3fadb6794061

* Add missing clock control
* Set ASRC clock to 7.5MHz as 3.0.35 does
* Use the same divisor for ideal ratio mode as 3.0.35 does

Acked-by: Wang Shengjiu <b02247@freescale.com>
Signed-off-by: Nicolin Chen <b42378@freescale.com>
Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 arch/arm/mach-imx/clk-imx6q.c |    2 ++
 drivers/mxc/asrc/mxc_asrc.c   |    9 ++++++++-
 include/linux/mxc_asrc.h      |    2 +-
 3 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-imx/clk-imx6q.c b/arch/arm/mach-imx/clk-imx6q.c
index b42ccb2..d08999b 100644
--- a/arch/arm/mach-imx/clk-imx6q.c
+++ b/arch/arm/mach-imx/clk-imx6q.c
@@ -550,6 +550,8 @@ static void __init imx6q_clocks_init(struct device_node *ccm_node)
 	clk_set_parent(clk[ssi2_sel], clk[pll4_audio_div]);
 	clk_set_parent(clk[ssi3_sel], clk[pll4_audio_div]);
 	clk_set_parent(clk[spdif_sel], clk[pll3_pfd3_454m]);
+	clk_set_parent(clk[asrc_sel], clk[pll3_usb_otg]);
+	clk_set_rate(clk[asrc_sel], 7500000);
 
 	/* Set pll4_audio to a value that can derive 5K-88.2KHz and 8K-96KHz */
 	clk_set_rate(clk[pll4_audio_div], 541900800);
diff --git a/drivers/mxc/asrc/mxc_asrc.c b/drivers/mxc/asrc/mxc_asrc.c
index 3bba8f4..5ae4221 100644
--- a/drivers/mxc/asrc/mxc_asrc.c
+++ b/drivers/mxc/asrc/mxc_asrc.c
@@ -680,6 +680,8 @@ EXPORT_SYMBOL(asrc_get_per_addr);
 
 static int mxc_init_asrc(void)
 {
+	clk_enable(asrc->asrc_clk);
+
 	/* Halt ASRC internal FP when input FIFO needs data for pair A, B, C */
 	asrc_regmap_write(asrc->regmap, REG_ASRCTR, ASRCTR_ASRCEN);
 
@@ -708,6 +710,8 @@ static int mxc_init_asrc(void)
 	/* Set the processing clock for 56KHz, 133M */
 	asrc_regmap_write(asrc->regmap, REG_ASR56K, 0x0947);
 
+	clk_disable(asrc->asrc_clk);
+
 	return 0;
 }
 
@@ -1927,7 +1931,7 @@ static int mxc_asrc_probe(struct platform_device *pdev)
 		goto err_iomap;
 	}
 #ifndef ASRC_USE_REGMAP
-	clk_prepare_enable(asrc->asrc_clk);
+	clk_prepare(asrc->asrc_clk);
 #endif
 
 	ret = of_property_read_u32_array(pdev->dev.of_node,
@@ -1984,6 +1988,9 @@ err_iomap:
 
 static int mxc_asrc_remove(struct platform_device *pdev)
 {
+#ifndef ASRC_USE_REGMAP
+	clk_unprepare(asrc->asrc_clk);
+#endif
 	asrc_proc_remove();
 	misc_deregister(&asrc_miscdev);
 
diff --git a/include/linux/mxc_asrc.h b/include/linux/mxc_asrc.h
index 9f742a9..ecee963 100644
--- a/include/linux/mxc_asrc.h
+++ b/include/linux/mxc_asrc.h
@@ -30,7 +30,7 @@
 
 
 /* Ideal Ratio mode doesn't care the outclk frequency, so be fixed */
-#define ASRC_PRESCALER_IDEAL_RATIO	7
+#define ASRC_PRESCALER_IDEAL_RATIO	5
 /* SPDIF rxclk pulse rate is 128 * samplerate, so 2 ^ 7 */
 #define ASRC_PRESCALER_SPDIF_RX		7
 /* SPDIF txclk pulse rate is 64 * samplerate, so 2 ^ 6 */
-- 
1.7.5.4

