From f7437bd5350c97806559641f174fc79a4e5dff41 Mon Sep 17 00:00:00 2001
From: Fugang Duan <B38611@freescale.com>
Date: Mon, 4 Nov 2013 11:13:12 +0800
Subject: [PATCH 0541/1072] ENGR00286017: net:fec: fix clock enable/disable
 usecount mismatch

git://git.freescale.com/imx/linux-2.6-imx.git imx_3.10.17_1.0.0_beta
commit 9268001524a9e4b1a43039aef264fd6087052e7f

Reproduce:
1. Boot up kernel with DHCP;
2. ifconfig eth0 down;
3. echo mem > /sys/power/state;

There have clock enable/disable usecount mismatch warning dump.

Fix this by checking device's netif_running state is up and then
enable/disable clock.

Signed-off-by: Fugang Duan  <B38611@freescale.com>
Signed-off-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 drivers/net/ethernet/freescale/fec_main.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fec_main.c b/drivers/net/ethernet/freescale/fec_main.c
index 3836f5d..d48fb53 100644
--- a/drivers/net/ethernet/freescale/fec_main.c
+++ b/drivers/net/ethernet/freescale/fec_main.c
@@ -2358,9 +2358,9 @@ fec_suspend(struct device *dev)
 	if (netif_running(ndev)) {
 		fec_stop(ndev);
 		netif_device_detach(ndev);
+		fec_enet_clk_enable(ndev, false);
 	}
 
-	fec_enet_clk_enable(ndev, false);
 	if (fep->reg_phy)
 		regulator_disable(fep->reg_phy);
 
@@ -2384,8 +2384,8 @@ fec_resume(struct device *dev)
 			return ret;
 	}
 
-	fec_enet_clk_enable(ndev, true);
 	if (netif_running(ndev)) {
+		fec_enet_clk_enable(ndev, true);
 		fec_restart(ndev, fep->full_duplex);
 		netif_device_attach(ndev);
 	}
-- 
1.7.5.4

