From ca200619b207cd884c4a8e449dde6b60664902d7 Mon Sep 17 00:00:00 2001
From: Ioana Radulescu <ruxandra.radulescu@freescale.com>
Date: Tue, 19 Jun 2012 23:16:50 +0000
Subject: [PATCH 38/57] fmd: Don't access debug registers

commit 95d395285dd9c8ac4397940ec45c0e19f8dadcda from
https://git.freescale.com/git-private/cgit.cgi/ppc/t4240/linux.git

The T4 simulator doesn't implement some FMan debug registers,
so refrain from using them until things get fixed.

Signed-off-by: Ioana Radulescu <ruxandra.radulescu@freescale.com>
---
 .../freescale/dpa/NetCommSw/Peripherals/FM/fm.c    |    7 +++++++
 .../dpa/NetCommSw/src/wrapper/lnxwrp_fm.c          |    3 +++
 2 files changed, 10 insertions(+)

diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/fm.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/fm.c
index e7f8fcf..02326be 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/fm.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/fm.c
@@ -3170,7 +3170,9 @@ t_Error FM_Init(t_Handle h_Fm)
     if (p_FmDriverParam->resetOnInit)
     {
         t_FMIramRegs    *p_Iram = (t_FMIramRegs *)UINT_TO_PTR(p_Fm->baseAddr + FM_MM_IMEM);
+#ifndef CONFIG_T4_SIMULATOR_WORKAROUND
         uint32_t        debug_reg;
+#endif
 
         /* write to IRAM first location the debug instruction */
         WRITE_UINT32(p_Iram->iadd, 0);
@@ -3189,10 +3191,15 @@ t_Error FM_Init(t_Handle h_Fm)
         WRITE_UINT32(p_Fm->p_FmFpmRegs->fmrstc, FPM_RSTC_FM_RESET);
         XX_UDelay(100);
 
+#ifndef CONFIG_T4_SIMULATOR_WORKAROUND
+	/* FIXME: Temporary workaround, since simulator doesn't implement
+	 * FMan debug registers */
+
         /* verify breakpoint debug status register */
         debug_reg = GET_UINT32(*(uint32_t *)UINT_TO_PTR(p_Fm->baseAddr + FM_DEBUG_STATUS_REGISTER_OFFSET));
         if(!debug_reg)
             RETURN_ERROR(MAJOR, E_INVALID_VALUE, ("Invalid debug status register value = 0"));
+#endif
 
         /*************************************/
         /* Load FMan-Controller code to Iram */
diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_fm.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_fm.c
index 1a28b79..6d9ed36 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_fm.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_fm.c
@@ -788,9 +788,12 @@ static int /*__devinit*/ fm_probe(struct platform_device *of_dev)
     if (InitFmDev(p_LnxWrpFmDev) != E_OK)
         return -EIO;
 
+#if 0
+    /* FIXME: ioctl support for FMan v3 features is not ready yet */
     /* IOCTL ABI checking */
     LnxWrpPCDIOCTLEnumChecking();
     LnxWrpPCDIOCTLTypeChecking();
+#endif
 
     Sprint (p_LnxWrpFmDev->name, "%s%d", DEV_FM_NAME, p_LnxWrpFmDev->id);
 
-- 
1.7.9.7

