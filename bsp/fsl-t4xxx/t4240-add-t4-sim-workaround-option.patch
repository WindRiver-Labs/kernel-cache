From 43f3c639a943154dbe0078a0a0459a40f54b8ee6 Mon Sep 17 00:00:00 2001
From: Hai-Ying Wang <Haiying.Wang@freescale.com>
Date: Thu, 17 May 2012 20:13:19 +0000
Subject: [PATCH 16/57] t4240: add t4 sim workaround option

commit 3f4c9917a5a85055b3cdf84d8df5040557eec7ef from
https://git.freescale.com/git-private/cgit.cgi/ppc/t4240/linux.git

Workarounds will be applied for issues on T4 simulator

Signed-off-by: Haiying Wang <Haiying.Wang@freescale.com>
---
 arch/powerpc/platforms/85xx/Kconfig   |    7 +++++++
 drivers/staging/fsl_qbman/dpa_alloc.c |    2 ++
 2 files changed, 9 insertions(+)

diff --git a/arch/powerpc/platforms/85xx/Kconfig b/arch/powerpc/platforms/85xx/Kconfig
index 2cc39b0..934a8c3 100644
--- a/arch/powerpc/platforms/85xx/Kconfig
+++ b/arch/powerpc/platforms/85xx/Kconfig
@@ -289,6 +289,12 @@ config P5020_DS
 config WORKAROUND_E5500_MFCR
 	bool
 
+config T4_SIMULATOR_WORKAROUND
+	bool "apply the workaround for t4 simulator"
+	default n
+	help
+	  This option enables the workaround on t4 simulator
+
 config T4240_QDS
 	bool "Freescale T4240 QDS"
 	select DEFAULT_UIMAGE
@@ -302,6 +308,7 @@ config T4240_QDS
 	select WORKAROUND_E5500_MFCR
 	select HAS_FSL_PAMU
 	select HAS_FSL_QBMAN
+	select T4_SIMULATOR_WORKAROUND
 	help
 	  This option enables support for the T4240 QDS board
 
diff --git a/drivers/staging/fsl_qbman/dpa_alloc.c b/drivers/staging/fsl_qbman/dpa_alloc.c
index d7752de..6360b6b 100644
--- a/drivers/staging/fsl_qbman/dpa_alloc.c
+++ b/drivers/staging/fsl_qbman/dpa_alloc.c
@@ -158,7 +158,9 @@ static int qp_valid(u32 qp)
 	do {
 		struct qm_mcr_queryfq_np np;
 		err = qman_query_fq_np(&fq, &np);
+#ifndef CONFIG_T4_SIMULATOR_WORKAROUND
 		if (err)
+#endif
 			/* FQID range exceeded, found no problems */
 			return 1;
 		if ((np.state & QM_MCR_NP_STATE_MASK) != QM_MCR_NP_STATE_OOS) {
-- 
1.7.9.7

