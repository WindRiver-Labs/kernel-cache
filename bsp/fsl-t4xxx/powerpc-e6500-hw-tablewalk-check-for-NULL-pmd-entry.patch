From aaa8b00e6ee6f3827c6ce898700a2fe4fa033d21 Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Sat, 9 Jun 2012 06:00:40 +0000
Subject: [PATCH 26/57] powerpc/e6500: hw tablewalk: check for NULL pmd entry

commit 43646fd68f0aae7fcb8af76827785e5d88ecdeaf from
https://git.freescale.com/git-private/cgit.cgi/ppc/t4240/linux.git

We need to check for a NULL entry at each level -- the last one was
forgotten.  This resulted in an indirect entry getting loaded pointing
at NULL, which occasionally resulted in CCM errors.

Signed-off-by: Scott Wood <scottwood@freescale.com>
---
 arch/powerpc/mm/tlb_low_64e.S |    5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/arch/powerpc/mm/tlb_low_64e.S b/arch/powerpc/mm/tlb_low_64e.S
index 1a52e02..bca8d85 100644
--- a/arch/powerpc/mm/tlb_low_64e.S
+++ b/arch/powerpc/mm/tlb_low_64e.S
@@ -338,6 +338,10 @@ tlb_miss_common_fsl_htw:
 	bge	tlb_miss_fault_fsl_htw
 	ldx	r14,r14,r15		/* Grab pmd entry */
 
+	mfspr	r10,SPRN_MAS0
+	cmpdi	cr0,r14,0
+	bge	tlb_miss_fault_fsl_htw
+
 	/* Now we build the MAS for a 2M indirect page:
 	 *
 	 * MAS 0   :	ESEL needs to be filled by software round-robin
@@ -349,7 +353,6 @@ tlb_miss_common_fsl_htw:
 	 */
 
 
-	mfspr	r10,SPRN_MAS0
 	rldicr	r16,r11,0,62
 	lwz	r15,0(r16)
 
-- 
1.7.9.7

