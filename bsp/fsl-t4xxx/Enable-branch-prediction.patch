From cd6258b06747d0bb194970991209aa00254e1d0b Mon Sep 17 00:00:00 2001
From: Andy Fleming <afleming@freescale.com>
Date: Fri, 3 Feb 2012 11:12:31 -0600
Subject: [PATCH 05/57] Enable branch prediction

commit 76d4c81acbc32182b64fefb7294f398b827405c7 from
https://git.freescale.com/git-private/cgit.cgi/ppc/t4240/linux.git
---
 arch/powerpc/include/asm/reg_booke.h |    7 +++++++
 arch/powerpc/kernel/head_64.S        |    6 ++++++
 2 files changed, 13 insertions(+)

diff --git a/arch/powerpc/include/asm/reg_booke.h b/arch/powerpc/include/asm/reg_booke.h
index ab2c9a5..6388e3e 100644
--- a/arch/powerpc/include/asm/reg_booke.h
+++ b/arch/powerpc/include/asm/reg_booke.h
@@ -583,6 +583,13 @@
 /* Bit definitions for L1CSR2. */
 #define L1CSR2_DCWS	0x40000000	/* Data Cache write shadow */
 
+/* Bit definitions for BUCSR. */
+#define BUCSR_STAC_EN	0x01000000	/* Segment Target Address Cache */
+#define BUCSR_LS_EN	0x00400000	/* Link Stack */
+#define BUCSR_BBFI	0x00000200	/* Branch Buffer flash invalidate */
+#define BUCSR_BPEN	0x00000001	/* Branch prediction enable */
+#define BUCSR_INIT	(BUCSR_STAC_EN | BUCSR_LS_EN | BUCSR_BBFI | BUCSR_BPEN)
+
 /* Bit definitions for L2CSR0. */
 #define L2CSR0_L2E	0x80000000	/* L2 Cache Enable */
 #define L2CSR0_L2PE	0x40000000	/* L2 Cache Parity/ECC Enable */
diff --git a/arch/powerpc/kernel/head_64.S b/arch/powerpc/kernel/head_64.S
index 0ad03f7..9c65e57 100644
--- a/arch/powerpc/kernel/head_64.S
+++ b/arch/powerpc/kernel/head_64.S
@@ -163,6 +163,12 @@ exception_marker:
 
 #ifdef CONFIG_FSL_THREADS
 _GLOBAL(fsl_secondary_thread_init)
+	/* Enable branch prediction */
+	lis     r3,BUCSR_INIT@h
+	ori     r3,r3,BUCSR_INIT@l
+	mtspr   SPRN_BUCSR,r3
+	isync
+
 	mfspr	r3, SPRN_PIR
 	rlwimi	r3, r3, 30, 2, 30
 #endif
-- 
1.7.9.7

