From 31e1a18776acfded54545f5d4015d5bfaf086000 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Fri, 15 Aug 2014 11:15:44 +0800
Subject: [PATCH 3/5] arm: omap2: hwmod: unprepare the clock when error

Unprepare the clock after errors are popped out by clk_prepare.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-omap2/omap_hwmod.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-omap2/omap_hwmod.c b/arch/arm/mach-omap2/omap_hwmod.c
index b09fc83..db261b9 100644
--- a/arch/arm/mach-omap2/omap_hwmod.c
+++ b/arch/arm/mach-omap2/omap_hwmod.c
@@ -892,12 +892,19 @@ static int _init_opt_clks_dt(struct omap_hwmod *oh, struct device_node *np)
 			pr_warn("omap_hwmod: %s: cannot clk_get opt_clk %s\n",
 				oh->name, opt_clk_names[i]);
 			ret = -EINVAL;
+			break;
 		}
 		oh->opt_clks[i]._clk = c;
 		oh->opt_clks[i].role = opt_clk_names[i];
 		clk_prepare(oh->opt_clks[i]._clk);
 	}
 
+	if (ret && i > 0) {
+		for (i -= 1; i >= 0; i--)
+			clk_unprepare(oh->opt_clks[i]._clk);
+		kfree(oh->opt_clks);
+	}
+
 	kfree(opt_clk_names);
 	return ret;
 }
-- 
1.7.5.4

