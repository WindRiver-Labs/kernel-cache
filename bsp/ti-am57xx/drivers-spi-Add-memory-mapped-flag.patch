From 0c30f1d3a98102eebe45a34a66b7fd37c2820bb4 Mon Sep 17 00:00:00 2001
From: Sourav Poddar <sourav.poddar@ti.com>
Date: Wed, 7 Aug 2013 11:15:41 +0530
Subject: [PATCH 105/263] drivers: spi: Add memory mapped flag.

This commit comes from branch ti-linux-3.12.y:
  git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git

Add memory map flag to indicate that the qspi controller
supports it.

Signed-off-by: Sourav Poddar <sourav.poddar@ti.com>
(cherry picked from commit ff72e7f61b6c0e07f47ff9c03a68f6d9ed56160a)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/spi/spi-ti-qspi.c |    3 ++-
 include/linux/spi/spi.h   |    1 +
 2 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/drivers/spi/spi-ti-qspi.c b/drivers/spi/spi-ti-qspi.c
index b7762e3..278c185 100644
--- a/drivers/spi/spi-ti-qspi.c
+++ b/drivers/spi/spi-ti-qspi.c
@@ -253,6 +253,7 @@ static int ti_qspi_setup(struct spi_device *spi)
 			break;
 		}
 		ti_qspi_write(qspi, memval, QSPI_SPI_SETUP0_REG);
+		spi->mode |= SPI_RX_MMAP;
 	}
 
 	pm_runtime_mark_last_busy(qspi->dev);
@@ -524,7 +525,7 @@ static int ti_qspi_probe(struct platform_device *pdev)
 	if (!master)
 		return -ENOMEM;
 
-	master->mode_bits = SPI_CPOL | SPI_CPHA | SPI_RX_QUAD;
+	master->mode_bits = SPI_CPOL | SPI_CPHA | SPI_RX_QUAD | SPI_RX_MMAP;
 
 	master->bus_num = -1;
 	master->flags = SPI_MASTER_HALF_DUPLEX;
diff --git a/include/linux/spi/spi.h b/include/linux/spi/spi.h
index ccb0c56..cbab9d5 100644
--- a/include/linux/spi/spi.h
+++ b/include/linux/spi/spi.h
@@ -91,6 +91,7 @@ struct spi_device {
 #define	SPI_TX_QUAD	0x200			/* transmit with 4 wires */
 #define	SPI_RX_DUAL	0x400			/* receive with 2 wires */
 #define	SPI_RX_QUAD	0x800			/* receive with 4 wires */
+#define SPI_RX_MMAP	0x1000			/* Memory mapped Reas */
 	u8			bits_per_word;
 	int			irq;
 	void			*controller_state;
-- 
1.7.5.4

