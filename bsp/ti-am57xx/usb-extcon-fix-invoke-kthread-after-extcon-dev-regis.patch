From 15b98c5fd9f7fbc65f4bfe013ce47f2cc0eaeac1 Mon Sep 17 00:00:00 2001
From: Ravi Babu <ravibabu@ti.com>
Date: Fri, 7 Mar 2014 13:35:47 +0530
Subject: [PATCH 220/263] usb: extcon: fix: invoke kthread after extcon dev
 registration

This commit comes from branch ti-linux-3.12.y:
  git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git

this patch fixes the bug where usbvid polling thread invoked
before the extcon device registration.

Change-Id: I9ab0b37cca04463c9f3b6fb87ddeaedc421c8274
Signed-off-by: Ravi Babu <ravibabu@ti.com>
(cherry picked from commit 7abdbc9153baca5ca38769511b586af4e2ab7c56)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/extcon/extcon-gpio-usbvid.c |   18 ++++++++----------
 1 files changed, 8 insertions(+), 10 deletions(-)

diff --git a/drivers/extcon/extcon-gpio-usbvid.c b/drivers/extcon/extcon-gpio-usbvid.c
index c325a41..d235fd6 100644
--- a/drivers/extcon/extcon-gpio-usbvid.c
+++ b/drivers/extcon/extcon-gpio-usbvid.c
@@ -227,7 +227,7 @@ static int gpio_usbvid_probe(struct platform_device *pdev)
 	struct gpio_usbvid *gpio_usbvid;
 	int ret, gpio;
 	int intr_mode;
-	u8 mode;
+	enum usb_dr_mode  mode;
 
 	if (!node)
 		return -EINVAL;
@@ -288,10 +288,17 @@ static int gpio_usbvid_probe(struct platform_device *pdev)
 		}
 	}
 
+	ret = extcon_dev_register(&gpio_usbvid->edev, gpio_usbvid->dev);
+	if (ret) {
+		dev_err(&pdev->dev, "failed to register extcon device\n");
+		return ret;
+	}
+
 	if (intr_mode) {
 		ret = gpio_usbvid_request_irq(gpio_usbvid);
 		if (ret)
 			return ret;
+		gpio_usbvid_set_initial_state(gpio_usbvid);
 	} else {
 		gpio_usbvid->id_current = -1;
 		gpio_usbvid->usbid_thread = kthread_run(poll_usbvbus_id_task,
@@ -300,16 +307,7 @@ static int gpio_usbvid_probe(struct platform_device *pdev)
 			return -1;
 	}
 
-	ret = extcon_dev_register(&gpio_usbvid->edev, gpio_usbvid->dev);
-	if (ret) {
-		dev_err(&pdev->dev, "failed to register extcon device\n");
-		return ret;
-	}
-
-	gpio_usbvid_set_initial_state(gpio_usbvid);
-
 	return 0;
-
 }
 
 static int gpio_usbvid_remove(struct platform_device *pdev)
-- 
1.7.5.4

