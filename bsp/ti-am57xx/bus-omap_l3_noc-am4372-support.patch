From fbbc2fab70d81b42030766ea5ff49f596b47394b Mon Sep 17 00:00:00 2001
From: Afzal Mohammed <afzal@ti.com>
Date: Mon, 2 Dec 2013 17:48:57 +0530
Subject: [PATCH 046/263] bus: omap_l3_noc: am4372 support

This commit comes from branch ti-linux-3.12.y:
  git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git

Add AM43x information to handle L3 error.

Timeout doesn't have STDERRLOG_MAIN register. And per hardware team, L3
timeout error cannot be cleared the normal way (by setting bit 31 in
STDERRLOG_MAIN), instead it may be required to do system reset.
L3 error handler can't help in such scenarios.

Hence indicate timeout target offset as "0xdeadbeef" as is done for
undocumented bits. This will also help to handle these cases seperately
in isr.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
Signed-off-by: Afzal Mohammed <afzal@ti.com>
(cherry picked from commit 6530aa9de897cb84a936ea44729c08b86dec6090)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 .../devicetree/bindings/arm/omap/l3-noc.txt        |    1 +
 drivers/bus/omap_l3_noc.c                          |    1 +
 drivers/bus/omap_l3_noc.h                          |  129 +++++++++++++++++++-
 3 files changed, 126 insertions(+), 5 deletions(-)

diff --git a/Documentation/devicetree/bindings/arm/omap/l3-noc.txt b/Documentation/devicetree/bindings/arm/omap/l3-noc.txt
index c0105de..b299bac 100644
--- a/Documentation/devicetree/bindings/arm/omap/l3-noc.txt
+++ b/Documentation/devicetree/bindings/arm/omap/l3-noc.txt
@@ -6,6 +6,7 @@ provided by Arteris.
 Required properties:
 - compatible : Should be "ti,omap3-l3-smx" for OMAP3 family
                Should be "ti,omap4-l3-noc" for OMAP4 family
+               Should be "ti,am4372-l3-noc" for AM43 family
 - reg:	Contains L3 register address range for each noc domain.
 - ti,hwmods: "l3_main_1", ... One hwmod for each noc domain.
 
diff --git a/drivers/bus/omap_l3_noc.c b/drivers/bus/omap_l3_noc.c
index 4110572..0a16e01 100644
--- a/drivers/bus/omap_l3_noc.c
+++ b/drivers/bus/omap_l3_noc.c
@@ -147,6 +147,7 @@ static irqreturn_t l3_interrupt_handler(int irq, void *_l3)
 
 static const struct of_device_id l3_noc_match[] = {
 	{.compatible = "ti,omap4-l3-noc", .data = &omap_l3_data},
+	{.compatible = "ti,am4372-l3-noc", .data = &am4372_l3_data},
 	{},
 };
 MODULE_DEVICE_TABLE(of, l3_noc_match);
diff --git a/drivers/bus/omap_l3_noc.h b/drivers/bus/omap_l3_noc.h
index 59cd395..9696251 100644
--- a/drivers/bus/omap_l3_noc.h
+++ b/drivers/bus/omap_l3_noc.h
@@ -23,6 +23,7 @@
 #ifndef OMAP_L3_NOC_H
 #define OMAP_L3_NOC_H
 
+#define AM4372_L3_MODULES		2
 #define OMAP_L3_MODULES			3
 #define CLEAR_STDERR_LOG		(1 << 31)
 #define CUSTOM_ERROR			0x2
@@ -42,6 +43,7 @@
 #define L3_FLAGMUX_TARGET_OFS_TIMEOUT	L3_FLAGMUX_TARGET_OFS_INVALID
 
 #define OMAP_NUM_OF_L3_MASTERS	(sizeof(omap_l3_masters)/sizeof(l3_masters[0]))
+#define MAX_TARGETS_IN_CLKDM		21
 
 static u32 omap_l3_flagmux[] = {
 	0x500,
@@ -49,6 +51,11 @@ static u32 omap_l3_flagmux[] = {
 	0X0200
 };
 
+static u32 am4372_l3_flagmux[] = {
+	0x1000,
+	0x600,
+};
+
 /* L3 Target standard Error register offsets */
 static u32 omap_l3_targ_inst_clk1[] = {
 	0x100, /* DMM1 */
@@ -90,10 +97,46 @@ static u32 omap_l3_targ_inst_clk3[] = {
 	0x0 /* HOST CLK3 */
 };
 
-static struct l3_masters_data {
+static u32 am4372_l3_targ_inst_200f[] = {
+	0xF00, /* EMIF */
+	0x1200, /* DES */
+	0x400, /* OCMCRAM */
+	0x700, /* TPTC0 */
+	0x800, /* TPTC1 */
+	0x900, /* TPTC2 */
+	0xB00, /* TPCC */
+	0xD00, /* DEBUGSS */
+	L3_FLAGMUX_TARGET_OFS_TIMEOUT, /* TIMEOUT */
+	0x200, /* SHA */
+	0xC00, /* SGX530 */
+	0x500, /* AES0 */
+	0xA00, /* L4_FAST */
+	0x300, /* MPUSS L2 RAM */
+	0x100, /* ICSS */
+};
+
+static u32 am4372_l3_targ_inst_100s[] = {
+	0x100, /* L4_PER 0 */
+	0x200, /* L4_PER 1 */
+	0x300, /* L4_PER 2 */
+	0x400, /* L4_PER 3 */
+	0x800, /* McASP 0 */
+	0x900, /* McASP 1 */
+	0xC00, /* MMCHS2 */
+	0x700, /* GPMC */
+	0xD00, /* L4_FW */
+	L3_FLAGMUX_TARGET_OFS_TIMEOUT, /* TIMEOUT */
+	0x500, /* ADCTSC */
+	0xE00, /* L4_WKUP */
+	0xA00, /* MAG_CARD */
+};
+
+struct l3_masters_data {
 	u32 id;
-	char name[10];
-} omap_l3_masters[] = {
+	char name[20];
+};
+
+static struct l3_masters_data omap_l3_masters[] = {
 	{ 0x0 , "MPU"},
 	{ 0x10, "CS_ADP"},
 	{ 0x14, "xxx"},
@@ -121,7 +164,33 @@ static struct l3_masters_data {
 	{ 0xC8, "USBHOSTFS"}
 };
 
-static char *omap_l3_targ_inst_name[][21] = {
+static struct l3_masters_data am4372_l3_masters[] = {
+	{ 0x0, "M1 (128-bit)"},
+	{ 0x0, "M2 (64-bit)"},
+	{ 0x4, "DAP"},
+	{ 0x5, "P1500"},
+	{ 0xC, "ICSS0"},
+	{ 0xD, "ICSS1"},
+	{ 0x18, "TPTC0 Read"},
+	{ 0x19, "TPTC0 Write"},
+	{ 0x1A, "TPTC1 Read"},
+	{ 0x1B, "TPTC1 Write"},
+	{ 0x1C, "TPTC2 Read"},
+	{ 0x1D, "TPTC2 Write"},
+	{ 0x20, "SGX530"},
+	{ 0x25, "DSS"},
+	{ 0x28, "Crypto DMA RD"},
+	{ 0x29, "Crypto DMA WR"},
+	{ 0x2C, "VPFE0"},
+	{ 0x2D, "VPFE1"},
+	{ 0x30, "GEMAC"},
+	{ 0x34, "USB0 RD"},
+	{ 0x35, "USB0 WR"},
+	{ 0x36, "USB1 RD"},
+	{ 0x37, "USB1 WR"},
+};
+
+static char *omap_l3_targ_inst_name[][MAX_TARGETS_IN_CLKDM] = {
 	{
 		"DMM1",
 		"DMM2",
@@ -161,12 +230,52 @@ static char *omap_l3_targ_inst_name[][21] = {
 	},
 };
 
+static char *am4372_l3_targ_inst_name[][MAX_TARGETS_IN_CLKDM] = {
+	{
+		"EMIF",
+		"DES",
+		"OCMCRAM",
+		"TPTC0",
+		"TPTC1",
+		"TPTC2",
+		"TPCC",
+		"DEBUGSS",
+		"TIMEOUT",
+		"SHA",
+		"SGX530",
+		"AES0",
+		"L4_FAST",
+		"MPUSS L2 RAM",
+		"ICSS",
+	},
+	{
+		"L4_PER 0",
+		"L4_PER 1",
+		"L4_PER 2",
+		"L4_PER 3",
+		"McASP 0",
+		"McASP 1",
+		"MMCHS2",
+		"GPMC",
+		"L4_FW",
+		"TIMEOUT",
+		"ADCTSC",
+		"L4_WKUP",
+		"MAG_CARD",
+	},
+};
+
 static u32 *omap_l3_targ[] = {
 	omap_l3_targ_inst_clk1,
 	omap_l3_targ_inst_clk2,
 	omap_l3_targ_inst_clk3,
 };
 
+static u32 *am4372_l3_targ[] = {
+	am4372_l3_targ_inst_200f,
+	am4372_l3_targ_inst_100s,
+};
+
 struct omap_l3 {
 	struct device *dev;
 	struct clk *ick;
@@ -176,7 +285,7 @@ struct omap_l3 {
 
 	u32 **l3_targets;
 	struct l3_masters_data *masters_names;
-	char *(*target_names)[21];
+	char *(*target_names)[MAX_TARGETS_IN_CLKDM];
 	u32 **l3_timeout_targets;
 	u32 *l3_flag_mux;
 	int debug_irq;
@@ -195,4 +304,14 @@ struct omap_l3 omap_l3_data = {
 	.l3_flag_mux = omap_l3_flagmux,
 };
 
+struct omap_l3 am4372_l3_data = {
+	.l3_targets = am4372_l3_targ,
+	.masters_names = am4372_l3_masters,
+	.target_names = am4372_l3_targ_inst_name,
+	.l3_timeout_targets = NULL,
+	.num_modules = AM4372_L3_MODULES,
+	.num_masters = sizeof(am4372_l3_masters)/sizeof(struct l3_masters_data),
+	.l3_flag_mux = am4372_l3_flagmux,
+};
+
 #endif
-- 
1.7.5.4

