From ee44ff5c4ddca7fb235c472c9e858a82cbeb979c Mon Sep 17 00:00:00 2001
From: Ravi Babu <ravibabu@ti.com>
Date: Tue, 17 Dec 2013 18:31:02 +0530
Subject: [PATCH 195/263] usb: dwc3: device: added device suspend callback
 support

This commit comes from branch ti-linux-3.12.y:
  git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git

-when the device is disconnect the controller enter U3 state
and generates suspend event.
-adding support to invoke device suspend callback during
 device disconnect.

Change-Id: Ib7de000853160be0d79aeaeb994c1bd12f8a10c0
Signed-off-by: Ravi Babu <ravibabu@ti.com>
(cherry picked from commit 31e0e7be9443be25139daada346b8ee67ea7602f)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/usb/dwc3/gadget.c |   11 +++++++++++
 1 files changed, 11 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.c
index d9946e2..d62454c 100644
--- a/drivers/usb/dwc3/gadget.c
+++ b/drivers/usb/dwc3/gadget.c
@@ -2386,6 +2386,17 @@ static void dwc3_gadget_linksts_change_interrupt(struct dwc3 *dwc,
 	 * STAR#9000446952: RTL: Device SS : if U1/U2 ->U0 takes >128us
 	 * core send LGO_Ux entering U0
 	 */
+	if (next == DWC3_LINK_STATE_U3 &&
+		dwc->link_state == DWC3_LINK_STATE_RX_DET) {
+		if (dwc->gadget_driver) {
+			if (dwc->gadget_driver->suspend && dwc->gadget_loaded
+				&& dwc->drd_state) {
+				dev_vdbg(dwc->dev, "gadget: bus suspended");
+				dwc->gadget_driver->suspend(&dwc->gadget);
+			}
+		}
+	}
+
 	if (dwc->revision < DWC3_REVISION_183A) {
 		if (next == DWC3_LINK_STATE_U0) {
 			u32	u1u2;
-- 
1.7.5.4

