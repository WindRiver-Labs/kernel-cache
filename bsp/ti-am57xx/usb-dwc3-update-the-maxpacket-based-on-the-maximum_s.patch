From 926305b3dd8fde091afdb1229d566e67feb2c8ca Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Sun, 6 Jul 2014 10:57:58 +0800
Subject: [PATCH 191/263] usb: dwc3: update the maxpacket based on the
 maximum_speed

This commit comes from branch ti-linux-3.12.y:
  git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git

During initialization of endpoints, the maximum_speed is used
to determine the maxpacket size of the control endpoint.
For non control endpoints it appears alright to set the maxpacketsize to
be 1024 for the controller, but the function dwc3_gadget_get_maxpacket() is
introduced merely for consistency.

Change-Id: Iececaa685f1dd1901d254bbdf8d83c517bab8c72
Signed-off-by: Ruchika Kharwar <ruchika@ti.com>
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/usb/dwc3/gadget.c |   21 +++++++++++++++++++++
 1 files changed, 21 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.c
index 02e44fc..7f32403 100644
--- a/drivers/usb/dwc3/gadget.c
+++ b/drivers/usb/dwc3/gadget.c
@@ -1619,6 +1619,25 @@ static const struct usb_gadget_ops dwc3_gadget_ops = {
 	.udc_stop		= dwc3_gadget_stop,
 };
 
+static int dwc3_gadget_get_maxpacket_ep0(struct dwc3 *dwc)
+{
+	switch (dwc->maximum_speed) {
+	case USB_SPEED_HIGH:
+	case USB_SPEED_FULL:
+			return 64;
+	case USB_SPEED_LOW:
+			return 8;
+	case USB_SPEED_SUPER:
+	default:
+			return 512;
+	}
+}
+
+static int dwc3_gadget_get_maxpacket(struct dwc3 *dwc)
+{
+	return 1024;
+}
+
 /* -------------------------------------------------------------------------- */
 
 static int dwc3_gadget_init_hw_endpoints(struct dwc3 *dwc,
@@ -1651,6 +1670,7 @@ static int dwc3_gadget_init_hw_endpoints(struct dwc3 *dwc,
 
 		if (epnum == 0 || epnum == 1) {
 			dep->endpoint.maxpacket = 512;
+			dep->endpoint.maxpacket = dwc3_gadget_get_maxpacket_ep0(dwc);
 			dep->endpoint.maxburst = 1;
 			dep->endpoint.ops = &dwc3_gadget_ep0_ops;
 			if (!epnum)
@@ -1659,6 +1679,7 @@ static int dwc3_gadget_init_hw_endpoints(struct dwc3 *dwc,
 			int		ret;
 
 			dep->endpoint.maxpacket = 1024;
+			dep->endpoint.maxpacket = dwc3_gadget_get_maxpacket(dwc);
 			dep->endpoint.max_streams = 15;
 			dep->endpoint.ops = &dwc3_gadget_ep_ops;
 			list_add_tail(&dep->endpoint.ep_list,
-- 
1.7.5.4

