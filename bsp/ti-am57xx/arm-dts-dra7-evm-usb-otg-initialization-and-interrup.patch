From ad6579c13f7cac71a3022d4bb2173bd22f71d77b Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Tue, 5 Aug 2014 10:34:36 +0800
Subject: [PATCH 229/263] arm: dts: dra7-evm: usb otg initialization and
 interrupt enable

This commit comes from branch ti-linux-3.12.y:
  git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git
  git://git.omapzoom.org/kernel/omap.git

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/boot/dts/dra7-evm.dts |   14 +++++---
 arch/arm/boot/dts/dra7.dtsi    |   77 +++++++++++++++++-----------------------
 2 files changed, 42 insertions(+), 49 deletions(-)

diff --git a/arch/arm/boot/dts/dra7-evm.dts b/arch/arm/boot/dts/dra7-evm.dts
index cd1c28c..c89a268 100644
--- a/arch/arm/boot/dts/dra7-evm.dts
+++ b/arch/arm/boot/dts/dra7-evm.dts
@@ -70,11 +70,15 @@
 	extcon1: gpio_usbvid_extcon1 {
 		compatible = "ti,gpio-usb-id";
 		gpios = <&gpio21 1 0>;
+		interrupt_mode = <0>;
+		dr_mode = "otg";
 	};
 
 	extcon2: gpio_usbvid_extcon2 {
 		compatible = "ti,gpio-usb-id";
 		gpios = <&gpio21 2 0>;
+		interrupt_mode = <0>;
+		dr_mode = "otg";
 	};
 
 	evm_3v3_sd: fixedregulator-sd {
@@ -239,13 +243,13 @@
 
 	usb1_pins: pinmux_usb1_pins {
                 pinctrl-single,pins = <
-			0x280	0xc0000	/* usb1_drvvbus, SLOW_SLEW | PULLUPEN | MODE0 */
+			0x280	0xc000e	/* usb1_drvvbus, SLOW_SLEW | PULLUPEN | MODE14 */
                 >;
         };
 
 	usb2_pins: pinmux_usb2_pins {
                 pinctrl-single,pins = <
-			0x284	0xc0000 /* usb2_drvvbus, SLOW_SLEW | PULLUPEN | MODE0 */
+			0x284	0xc000e /* usb2_drvvbus, SLOW_SLEW | PULLUPEN | MODE14 */
                 >;
         };
 
@@ -660,7 +664,7 @@
 		lines-initial-states = <0x1408>;
 		gpio-controller;
 		#gpio-cells = <2>;
-		interrupt-parent = <&pcf_gpio_20>;
+		interrupt-parent = <&gpio6>;
 		interrupts = <14 2>;
 		interrupt-controller;
 		#interrupt-cells = <2>;
@@ -858,13 +862,13 @@
 };
 
 &usb1 {
-	dr_mode = "peripheral";
+	dr_mode = "otg";
 	pinctrl-names = "default";
 	pinctrl-0 = <&usb1_pins>;
 };
 
 &usb2 {
-	dr_mode = "host";
+	dr_mode = "otg";
 	pinctrl-names = "default";
 	pinctrl-0 = <&usb2_pins>;
 };
diff --git a/arch/arm/boot/dts/dra7.dtsi b/arch/arm/boot/dts/dra7.dtsi
index d2099b1..5613077 100644
--- a/arch/arm/boot/dts/dra7.dtsi
+++ b/arch/arm/boot/dts/dra7.dtsi
@@ -1174,67 +1174,56 @@
 
 		omap_control_usb2phy1: control-phy@4a002300 {
 			compatible = "ti,control-phy-usb2";
-			reg = <0x4a002300 0x4>;
-			reg-names = "power";
-		};
-
-		omap_control_usb3phy1: control-phy@4a002370 {
-			compatible = "ti,control-phy-pipe3";
-			reg = <0x4a002370 0x4>;
-			reg-names = "power";
+			reg = <0x4a002300 0x4>,
+			      <0x4a002370 0x4>;
+			reg-names = "control_dev_conf", "phy_power_usb", "power";
+			ti,type = <2>;
 		};
 
-		omap_control_usb2phy2: control-phy@0x4a002e74 {
+		omap_control_usb3phy1: control-phy@0x4a002e74 {
 			compatible = "ti,control-phy-dra7usb2";
-			reg = <0x4a002e74 0x4>;
-			reg-names = "power";
+			reg = <0x4a002e74 0x4>,
+			      <0x4a0086c0 0x4>;
+			reg-names = "ctrl_core_srcomp_north_side", "dummy_reg";
+			ti,type = <3>;
 		};
 
+		/* OCP2SCP1 */
 		ocp2scp@4a080000 {
 			compatible = "ti,omap-ocp2scp";
 			#address-cells = <1>;
 			#size-cells = <1>;
 			ranges;
+			reg = <0x4a080000 0x20>;
 			ti,hwmods = "ocp2scp1";
-			reg = <0x4a080000 0x400>;	/* ocp2scp1 */
-			clocks = <&l4_root_clk_div>;
-			clock-names = "fck";
 
-			usb2_phy1: usb2phy1@4a084000 {
+			usb2_phy1: phy@4a084000 {
 				compatible = "ti,dra7x-usb2";
 				reg = <0x4a084000 0x400>;
 				ctrl-module = <&omap_control_usb2phy1>;
-				clocks = <&usb_phy1_always_on_clk32k>,
-					 <&usb_otg_ss1_refclk960m>;
-				clock-names =	"wkupclk",
-						"refclk";
+				wkupclk =  "usb_phy1_always_on_clk32k";
+				optclk = "usb_otg_ss1_refclk960m";
 				#phy-cells = <0>;
 			};
 
-			usb2_phy2: usb2phy2@4a085000 {
+			usb2_phy2: phy@4a085000 {
 				compatible = "ti,dra7x-usb2";
 				reg = <0x4a085000 0x400>;
-				ctrl-module = <&omap_control_usb2phy2>;
-				clocks = <&usb_phy2_always_on_clk32k>,
-					 <&usb_otg_ss2_refclk960m>;
-				clock-names =	"wkupclk",
-						"refclk";
+				ctrl-module = <&omap_control_usb3phy1>;
+				wkupclk =  "usb_phy1_always_on_clk32k";
+				optclk = "usb_otg_ss1_refclk960m";
 				#phy-cells = <0>;
 			};
 
-			usb3_phy1: usb3phy@4a084400 {
-				compatible = "ti,phy-pipe3-usb3";
+			usb3_phy: phy@4a084400 {
+				compatible = "ti,omap-usb3";
 				reg = <0x4a084400 0x80>,
 				      <0x4a084800 0x64>,
 				      <0x4a084c00 0x40>;
 				reg-names = "phy_rx", "phy_tx", "pll_ctrl";
-				ctrl-module = <&omap_control_usb3phy1>;
-				clocks = <&usb_phy1_always_on_clk32k>,
-					 <&usb_otg_ss1_refclk960m>,
-					 <&dpll_core_h13x2_ck>;
-				clock-names =	"wkupclk",
-						"refclk",
-						"refclk2";
+				ctrl-module = <&omap_control_usb2phy1>;
+				wkupclk =  "usb_phy1_always_on_clk32k";
+				optclk = "usb_otg_ss1_refclk960m";
 				#phy-cells = <0>;
 			};
 		};
@@ -1242,7 +1231,7 @@
 		dwc3_1: omap_dwc3_1@48880000 {
 			compatible = "ti,dwc3";
 			ti,hwmods = "usb_otg_ss1";
-			reg = <0x48880000 0x10000>;
+                        reg = <0x48880000 0x1ff>;
 			interrupts = <0 77 4>;
 			clocks = <&dpll_core_h13x2_ck>;
 			clock-names = "fck";
@@ -1251,21 +1240,21 @@
 			utmi-mode = <2>;
 			ranges;
 			usb1: usb@48890000 {
-				compatible = "synopsys,dwc3";
-				reg = <0x48890000 0x17000>;
-				interrupts = <0 76 4>;
-				phys = <&usb2_phy1>, <&usb3_phy1>;
-				phy-names = "usb2-phy", "usb3-phy";
+                                compatible = "synopsys,dra7xx-dwc3";
+                                reg = <0x48890000 0xcfff>;
+				interrupts = <0 76 4>, <0 77 4>;
+				usb-phy = <&usb2_phy1>, <&usb3_phy>;
 				tx-fifo-resize;
 				maximum-speed = "super-speed";
 				dr_mode = "otg";
+				gpios = <&gpio6 12 0>;
 			};
 		};
 
 		dwc3_2: omap_dwc3_2@488c0000 {
 			compatible = "ti,dwc3";
 			ti,hwmods = "usb_otg_ss2";
-			reg = <0x488c0000 0x10000>;
+                        reg = <0x488c0000 0x1ff>;
 			interrupts = <0 92 4>;
 			clocks = <&dpll_core_h13x2_ck>;
 			clock-names = "fck";
@@ -1276,11 +1265,11 @@
 			usb2: usb@488d0000 {
 				compatible = "synopsys,dwc3";
 				reg = <0x488d0000 0x17000>;
-				interrupts = <0 78 4>;
-				phys = <&usb2_phy2>;
-				phy-names = "usb2-phy";
+				interrupts = <0 78 4>, <0 92 4>;
+				usb-phy = <&usb2_phy2>;
 				tx-fifo-resize;
 				maximum-speed = "high-speed";
+				gpios = <&gpio6 13 0>;
 				dr_mode = "otg";
 			};
 		};
-- 
1.7.5.4

