From 54334958bb8b2ba32fa2dc7eb5448a3b397a6767 Mon Sep 17 00:00:00 2001
From: Ravi Babu <ravibabu@ti.com>
Date: Tue, 25 Mar 2014 17:20:47 +0530
Subject: [PATCH 203/263] usb: dwc3: debugfs: allow the dual role switch only
 in otg/drd mode

The patch comes from the following git repo:

  git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git

The dual role mode switch is allowed only in otg/drd mode, in other modes
switching is not valid.

Change-Id: I28cefd49b3470c77a98012b21aee770966fc8d17
Signed-off-by: Ravi Babu <ravibabu@ti.com>
(cherry picked from commit 808d39ca5a82baee9ad706fbf3212ce94c5791e8)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/usb/dwc3/debugfs.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/dwc3/debugfs.c b/drivers/usb/dwc3/debugfs.c
index 9057e79..2d00bae 100644
--- a/drivers/usb/dwc3/debugfs.c
+++ b/drivers/usb/dwc3/debugfs.c
@@ -399,6 +399,15 @@ static ssize_t dwc3_mode_write(struct file *file,
 	unsigned long		flags;
 	u32			mode = 0;
 	char			buf[32];
+	u32			reg;
+
+	spin_lock_irqsave(&dwc->lock, flags);
+	reg = dwc3_readl(dwc->regs, DWC3_GCTL);
+	spin_unlock_irqrestore(&dwc->lock, flags);
+
+	/* mode change is valid for DRD/otg mode only */
+	if (DWC3_GCTL_PRTCAP(reg) != DWC3_GCTL_PRTCAP_OTG)
+		return -EFAULT;
 
 	if (copy_from_user(&buf, ubuf, min_t(size_t, sizeof(buf) - 1, count)))
 		return -EFAULT;
-- 
1.7.5.4

