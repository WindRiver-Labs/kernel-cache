From 0cd50a7cfad68af7fc6b6ff427a5963c43c1ebf2 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Mon, 14 Jul 2014 12:49:03 +0800
Subject: [PATCH 033/263] Add a reboot reason to sar ram for logs

This commit comes from branch ti-linux-3.12.y:
  git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git

Still need a confirmation the address confliction between
reboot reason and ocp registers.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-omap2/omap4-common.c     |    2 +-
 arch/arm/mach-omap2/omap4-restart.c    |   28 +++++++++++++++++++++++++++-
 arch/arm/mach-omap2/omap4-sar-layout.h |    7 +++++++
 arch/arm/mach-omap2/omap54xx.h         |    1 +
 4 files changed, 36 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-omap2/omap4-common.c b/arch/arm/mach-omap2/omap4-common.c
index 199c9c6..e73f2bd 100644
--- a/arch/arm/mach-omap2/omap4-common.c
+++ b/arch/arm/mach-omap2/omap4-common.c
@@ -259,7 +259,7 @@ static int __init omap4_sar_ram_init(void)
 	 */
 	if (cpu_is_omap44xx())
 		sar_base = OMAP44XX_SAR_RAM_BASE;
-	else if (soc_is_omap54xx())
+	else if (soc_is_omap54xx() || soc_is_dra7xx())
 		sar_base = OMAP54XX_SAR_RAM_BASE;
 	else
 		return -ENOMEM;
diff --git a/arch/arm/mach-omap2/omap4-restart.c b/arch/arm/mach-omap2/omap4-restart.c
index f90e02e..c73c263 100644
--- a/arch/arm/mach-omap2/omap4-restart.c
+++ b/arch/arm/mach-omap2/omap4-restart.c
@@ -8,7 +8,14 @@
  */
 
 #include <linux/types.h>
+#include <linux/init.h>
+#include <linux/io.h>
+
 #include "prminst44xx.h"
+#include "omap4-sar-layout.h"
+#include "soc.h"
+#include "common.h"
+
 
 /**
  * omap44xx_restart - trigger a software restart of the SoC
@@ -20,7 +27,26 @@
  */
 void omap44xx_restart(char mode, const char *cmd)
 {
-	/* XXX Should save 'cmd' into scratchpad for use after reboot */
+	int offset = 0;
+	char *reason = "normal";
+	void __iomem * sar_ram = omap4_get_sar_ram_base();
+
+	if (cpu_is_omap44xx())
+		offset = OMAP4_REBOOT_REASON_OFFSET;
+	else if (soc_is_omap54xx())
+		offset = OMAP5_REBOOT_REASON_OFFSET;
+	else if (soc_is_dra7xx())
+		offset = DRA7XX_REBOOT_REASON_OFFSET;
+	else
+		WARN("undefined chip, %s", __func__);
+
+	if (sar_ram) {
+	if (cmd != NULL && *(char *)cmd)
+		reason = (char *)cmd;
+
+	strlcpy(sar_ram + offset, reason, min((int)strlen(reason) + 1,
+				OMAP_REBOOT_REASON_SIZE - 1));
+	}
 	omap4_prminst_global_warm_sw_reset(); /* never returns */
 	while (1)
 		;
diff --git a/arch/arm/mach-omap2/omap4-sar-layout.h b/arch/arm/mach-omap2/omap4-sar-layout.h
index 5b2966a..a3658f3 100644
--- a/arch/arm/mach-omap2/omap4-sar-layout.h
+++ b/arch/arm/mach-omap2/omap4-sar-layout.h
@@ -20,6 +20,13 @@
 #define SAR_BANK4_OFFSET		0x3000
 
 /* Scratch pad memory offsets from SAR_BANK1 */
+#define OMAP4_REBOOT_REASON_OFFSET             0xa0c
+#define OMAP5_REBOOT_REASON_OFFSET             0xfe0
+#define DRA7XX_REBOOT_REASON_OFFSET            0xfe0
+#define OMAP_REBOOT_REASON_SIZE                0xf
+
+
+/* Scratch pad memory offsets from SAR_BANK1 */
 #define SCU_OFFSET0				0xfe4
 #define SCU_OFFSET1				0xfe8
 #define OMAP_TYPE_OFFSET			0xfec
diff --git a/arch/arm/mach-omap2/omap54xx.h b/arch/arm/mach-omap2/omap54xx.h
index 2d35c57..262cbf9 100644
--- a/arch/arm/mach-omap2/omap54xx.h
+++ b/arch/arm/mach-omap2/omap54xx.h
@@ -33,5 +33,6 @@
 #define DRA7XX_CM_CORE_AON_BASE		0x4a005000
 #define DRA7XX_CTRL_BASE		0x4a003400
 #define DRA7XX_TAP_BASE			0x4ae0c000
+#define DRA7XX_SAR_RAM_BASE             0x4ae26000
 
 #endif /* __ASM_SOC_OMAP555554XX_H */
-- 
1.7.5.4

