From 658ebbfd334c559510f316f2f466de38fd9f4759 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Mon, 7 Jul 2014 15:08:20 +0800
Subject: [PATCH 201/263] usb: dwc3: dra7xx: control drvvbus for usb1/2 using
 gpio6

The 3c228146 comes from the following git repo:

  git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git

-drive the drvvbus using gpio control
-by default the VBUS is set high

Change-Id: Icdd3a6ab0f45c93db16278cdb7aa53bc653e35d8
Signed-off-by: Shankar Rao <shankar.nrao@ti.com>
Signed-off-by: Ravi Babu <ravibabu@ti.com>
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/usb/dwc3/core.c |   23 +++++++++++++++++++----
 drivers/usb/dwc3/core.h |    2 ++
 drivers/usb/dwc3/otg.c  |    7 +++++++
 3 files changed, 28 insertions(+), 4 deletions(-)

diff --git a/drivers/usb/dwc3/core.c b/drivers/usb/dwc3/core.c
index 80ecfaa..cc567fa 100644
--- a/drivers/usb/dwc3/core.c
+++ b/drivers/usb/dwc3/core.c
@@ -39,6 +39,8 @@
 #include <linux/usb/of.h>
 #include <linux/usb/otg.h>
 #include <linux/usb/dwc3-omap.h>
+#include <linux/gpio.h>
+#include <linux/of_gpio.h>
 
 #include "platform_data.h"
 #include "core.h"
@@ -524,16 +526,27 @@ static int dwc3_probe(struct platform_device *pdev)
 	if (dwc->dr_mode == USB_DR_MODE_UNKNOWN)
 		dwc->dr_mode = USB_DR_MODE_OTG;
 
+	if (mode != USB_DR_MODE_PERIPHERAL) {
+		dwc->gpio_count = of_gpio_count(node);
+		if (dwc->gpio_count < 1) {
+			dev_err(dev, "No gpio to configure\n");
+			goto err1;
+		}
+		dwc->gpio = of_get_gpio(node, 0);
+		if (gpio_is_valid(dwc->gpio)) {
+			gpio_request(dwc->gpio, NULL);
+			gpio_direction_output(dwc->gpio, 1);
+		}
+	}
+
 	switch (dwc->dr_mode) {
 	case USB_DR_MODE_PERIPHERAL:
 		/* dra7xx-dwc3 in peripheral mode does not detect
 		 * vbus change event, hence set vbus and session
 		 * to cause connect to host-machine
 		 */
-		if (of_device_is_compatible(node, "synopsys,dra7xx-dwc3")) {
-			dwc3_omap_usbvbus_id_handler(dwc->dev->parent,
-				OMAP_DWC3_VBUS_VALID);
-		}
+		dwc3_omap_usbvbus_id_handler(dwc->dev->parent,
+					OMAP_DWC3_VBUS_VALID);
 
 		dwc3_set_mode(dwc, DWC3_GCTL_PRTCAP_DEVICE);
 		ret = dwc3_gadget_init(dwc);
@@ -543,6 +556,8 @@ static int dwc3_probe(struct platform_device *pdev)
 		}
 		break;
 	case USB_DR_MODE_HOST:
+		dwc3_omap_usbvbus_id_handler(dwc->dev->parent,
+			OMAP_DWC3_ID_GROUND);
 		dwc3_set_mode(dwc, DWC3_GCTL_PRTCAP_HOST);
 		ret = dwc3_host_init(dwc);
 		if (ret) {
diff --git a/drivers/usb/dwc3/core.h b/drivers/usb/dwc3/core.h
index 5fbb383..3c865ff 100644
--- a/drivers/usb/dwc3/core.h
+++ b/drivers/usb/dwc3/core.h
@@ -734,6 +734,8 @@ struct dwc3 {
 	u32			oevt;
 	u8			xhci_loaded;
 	u8			gadget_loaded;
+	u8			gpio_count;
+	u32			gpio;
 };
 
 /* -------------------------------------------------------------------------- */
diff --git a/drivers/usb/dwc3/otg.c b/drivers/usb/dwc3/otg.c
index 3d58a34..a903421 100644
--- a/drivers/usb/dwc3/otg.c
+++ b/drivers/usb/dwc3/otg.c
@@ -20,6 +20,9 @@
 #include <linux/interrupt.h>
 #include <linux/usb.h>
 #include <linux/usb/hcd.h>
+#include <linux/gpio.h>
+#include <linux/of_gpio.h>
+
 #include "core.h"
 #include "io.h"
 #include "../host/xhci.h"
@@ -117,6 +120,10 @@ int dwc3_otg_role_switch(void *_dwc, int mode)
 		dwc->drd_state = 0;
 	}
 
+	/* drive vbus always ON */
+	gpio_request(dwc->gpio, NULL);
+	gpio_set_value(dwc->gpio, 1);
+
 	return IRQ_HANDLED;
 }
 
-- 
1.7.5.4

