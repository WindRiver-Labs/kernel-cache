From eca2a177d88038a63d4a3892d9709ba1f9a7c997 Mon Sep 17 00:00:00 2001
From: Wei Yongjun <yongjun_wei@trendmicro.com.cn>
Date: Sun, 1 Sep 2013 09:01:00 +0800
Subject: [PATCH 067/263] spi/qspi: fix missing unlock on error in
 ti_qspi_start_transfer_one()

This commit comes from branch ti-linux-3.12.y:
  git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git

Add the missing unlock before return from function ti_qspi_start_transfer_one()
in the error handling case.

Signed-off-by: Wei Yongjun <yongjun_wei@trendmicro.com.cn>
Signed-off-by: Mark Brown <broonie@linaro.org>
(cherry picked from commit b6460366fbadc160604f50047d0394c7fc39ceab)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/spi/spi-ti-qspi.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/spi/spi-ti-qspi.c b/drivers/spi/spi-ti-qspi.c
index 136d71e..e12d962 100644
--- a/drivers/spi/spi-ti-qspi.c
+++ b/drivers/spi/spi-ti-qspi.c
@@ -376,6 +376,7 @@ static int ti_qspi_start_transfer_one(struct spi_master *master,
 		ret = qspi_transfer_msg(qspi, t);
 		if (ret) {
 			dev_dbg(qspi->dev, "transfer message failed\n");
+			mutex_unlock(&qspi->list_lock);
 			return -EINVAL;
 		}
 
-- 
1.7.5.4

