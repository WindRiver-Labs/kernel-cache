From 30311a3dd45dd94eaea74f2bac0448d8495fc2d4 Mon Sep 17 00:00:00 2001
From: Ravi Babu <ravibabu@ti.com>
Date: Thu, 27 Mar 2014 13:04:57 +0530
Subject: [PATCH 221/263] extcon: usbvid: fixes unwanted role-switch during
 first cable-type plugin.

This commit comes from branch ti-linux-3.12.y:
  git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git

- Set the initial usb-id value for usb port0 and port1 for
  extcon-usbvid-gpio driver.
- This fixes unwanted usb-mode change during first time plugin
  of usb cable type.
- Based on usb cable type-A/type-B is plugged into usbX port,
  the respective port switch role to host or device respectively.

Change-Id: Iee54f38df84544262f65dc572d9c39d92ca54194
Signed-off-by: Ravi Babu <ravibabu@ti.com>
(cherry picked from commit 0092cbbd9cfc66c4d059acad563e4fa0b7045c18)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/extcon/extcon-gpio-usbvid.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/drivers/extcon/extcon-gpio-usbvid.c b/drivers/extcon/extcon-gpio-usbvid.c
index d235fd6..289db19 100644
--- a/drivers/extcon/extcon-gpio-usbvid.c
+++ b/drivers/extcon/extcon-gpio-usbvid.c
@@ -228,6 +228,7 @@ static int gpio_usbvid_probe(struct platform_device *pdev)
 	int ret, gpio;
 	int intr_mode;
 	enum usb_dr_mode  mode;
+	int id_current;
 
 	if (!node)
 		return -EINVAL;
@@ -300,7 +301,8 @@ static int gpio_usbvid_probe(struct platform_device *pdev)
 			return ret;
 		gpio_usbvid_set_initial_state(gpio_usbvid);
 	} else {
-		gpio_usbvid->id_current = -1;
+		id_current = gpio_get_value_cansleep(gpio_usbvid->id_gpio);
+		gpio_usbvid->id_current = id_current;
 		gpio_usbvid->usbid_thread = kthread_run(poll_usbvbus_id_task,
 						 gpio_usbvid, "extcon-usbid");
 		if (IS_ERR(gpio_usbvid->usbid_thread))
-- 
1.7.5.4

