From 82150409945a8adccd52540eb994ee8b94d738fa Mon Sep 17 00:00:00 2001
From: Eli Nidam <elini@marvell.com>
Date: Thu, 24 Oct 2013 18:50:24 +0200
Subject: [PATCH 1122/1825] fix: a38x: rump up patch1

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 06b9fd04d369b8cb46341d520f504e0156d26d7a

	1. Fixed TWSI read board ID
	2. Fixed ETH max port.
	3. Fixed S@R read Tclk
	4. Fixed S@R register offset and bit map.

Signed-off-by: Eli Nidam <elini@marvell.com>

Change-Id: I0e180888789a7c15e3559858144b3dea8f5776de
Signed-off-by: Nadav Haklai <nadavh@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3855
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/boardEnv/mvBoardEnvLib.c     |   77 +++++++++++++++-----
 .../armada_38x_family/boardEnv/mvBoardEnvLib.h     |    3 +-
 .../armada_38x_family/boardEnv/mvBoardEnvSpec.c    |   30 ++++----
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.c       |   46 ++++++------
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.h       |    4 +-
 .../armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h      |   13 ++--
 .../armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h      |   21 ++++--
 7 files changed, 119 insertions(+), 75 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
index 04dd129..4eaccac 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
@@ -97,7 +97,7 @@ MV_BOARD_SATR_INFO boardSatrInfo[] = MV_SAR_INFO;
 
 /* Locals */
 static MV_DEV_CS_INFO *boardGetDevEntry(MV_32 devNum, MV_BOARD_DEV_CLASS devClass);
-static MV_BOARD_INFO *board = NULL;
+static MV_BOARD_INFO *board;
 MV_U32 boardOptionsConfig[MV_CONFIG_TYPE_MAX_OPTION];
 
 
@@ -124,6 +124,7 @@ MV_VOID mvBoardEnvInit(MV_VOID)
 	MV_U32 norDev;
 	MV_U32 syncCtrl = 0;
 
+	board = boardInfoTbl[DB_68XX_ID];	/* init for first time get the correct twsi address */
 	mvBoardIdSet(mvBoardIdGet());
 	nandDev = boardGetDevCSNum(0, BOARD_DEV_NAND_FLASH);
 	if (nandDev != 0xFFFFFFFF) {
@@ -214,7 +215,7 @@ MV_U32 mvBoardRevGet(MV_VOID)
 	MV_U32 boardECO;
 	MV_U8 readValue;
 
-	if (mvBoardTwsiGet(BOARD_DEV_TWSI_EEPROM, 0, 1, &readValue) != MV_OK) {
+	if (mvBoardTwsiGet(BOARD_DEV_TWSI_SATR, 0, 1, &readValue) != MV_OK) {
 		mvOsPrintf("%s: Error: Read from TWSI failed\n", __func__);
 		return MV_ERROR;
 	}
@@ -268,7 +269,7 @@ MV_BOOL mvBoardIsPortInSgmii(MV_U32 ethPortNum)
 	MV_U8 readValue;
 
 	if (mvBoardTwsiGet(BOARD_TWSI_MODULE_DETECT, 2, 0, &readValue) != MV_OK) {
-		mvOsPrintf("%s: Error: Read from TWSI failed\n", __func__);
+		DB(mvOsPrintf("%s: Error: Read from TWSI failed\n", __func__));
 		return MV_FALSE;
 	}
 	if (readValue == 0x0d)
@@ -465,15 +466,15 @@ MV_BOOL mvBoardIsPortLoopback(MV_U32 ethPortNum)
 MV_U32 mvBoardTclkGet(MV_VOID)
 {
 	MV_U32 tclk;
-	tclk = (MV_REG_READ(MPP_SAMPLE_AT_RESET(1)));
-	tclk = ((tclk & (1 << 22)) >> 22);
+	tclk = (MV_REG_READ(MPP_SAMPLE_AT_RESET));
+	tclk = ((tclk & (1 << 15)) >> 15);
 	switch (tclk) {
 	case 0:
-		return MV_BOARD_TCLK_166MHZ;
+		return MV_BOARD_TCLK_250MHZ;
 	case 1:
 		return MV_BOARD_TCLK_200MHZ;
 	default:
-		return MV_BOARD_TCLK_200MHZ;
+		return MV_BOARD_TCLK_250MHZ;
 	}
 }
 
@@ -820,7 +821,8 @@ MV_VOID mvBoardInfoUpdate(MV_VOID)
 	for (i = 0; i < MV_CONFIG_TYPE_MAX_OPTION; i++) {
 		if (mvBoardConfigTypeGet(i, &configInfo) == MV_TRUE) {
 			if (mvBoardTwsiGet(configInfo.twsiAddr, configInfo.offset, 0, &readValue) != MV_OK) {
-				mvOsPrintf("%s: Error: Read from TWSI failed\n", __func__);
+				mvOsPrintf("%s: Error: Read from TWSI failed addr=0x%x\n",
+					   __func__, configInfo.twsiAddr);
 				return;
 			}
 			if ((configInfo.twsiId == readValue) &&
@@ -1265,6 +1267,9 @@ MV_VOID mvBoardOtherModuleTypePrint(MV_VOID)
 *******************************************************************************/
 MV_BOOL mvBoardIsGbEPortConnected(MV_U32 ethPortNum)
 {
+	if (ethPortNum < mvCtrlEthMaxPortGet())
+		return MV_TRUE;
+
 	return MV_FALSE;
 }
 
@@ -1537,6 +1542,35 @@ MV_U8 mvBoardTwsiAddrGet(MV_BOARD_TWSI_CLASS twsiClass, MV_U32 index)
 
 	return 0xFF;
 }
+/*******************************************************************************
+* mvBoardTwsiIsMore256Get
+*
+* DESCRIPTION:
+*	Return flag if TWSI have more then 256 byte.
+*
+* INPUT:
+*	twsiClass - The TWSI device to return the address type for.
+*	index	  - The TWSI device index (Pass 0 in case of a single
+*		    device)
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*	The flag from spec table.
+*
+*******************************************************************************/
+MV_U8 mvBoardTwsiIsMore256Get(MV_BOARD_TWSI_CLASS twsiClass, MV_U32 index)
+{
+	int i;
+
+	for (i = 0; i < board->numBoardTwsiDev; i++) {
+		if ((board->pBoardTwsiDev[i].devClass == twsiClass) && (board->pBoardTwsiDev[i].devClassId == index))
+			return board->pBoardTwsiDev[i].moreThen256;
+	}
+
+	return 0xFF;
+}
 
 /*******************************************************************************
 * mvBoardEthComplexConfigGet - Return ethernet complex board configuration.
@@ -1746,22 +1780,25 @@ MV_VOID mvBoardIdSet(MV_U32 boardId)
 *       32bit board ID number, '-1' if board is undefined.
 *
 *******************************************************************************/
+static MV_U32 gBoardId = -1;
 MV_U32 mvBoardIdGet(MV_VOID)
 {
-	MV_U32 boardId;
 	MV_U8 readValue;
+	if (gBoardId != -1)
+		return gBoardId;
 
-	if (mvBoardTwsiGet(BOARD_DEV_TWSI_EEPROM, 0, 0, &readValue) != MV_OK) {
+	if (mvBoardTwsiGet(BOARD_DEV_TWSI_SATR, 0, 0, &readValue) != MV_OK) {
 		mvOsPrintf("%s: Error: Read from TWSI failed\n", __func__);
-		return MV_ERROR;
+		mvOsPrintf("%s: Set default board ID to DB-88F6820-BP", __func__);
+		readValue = DB_68XX_ID;
 	}
-	boardId = readValue & 0x07;
+	gBoardId = readValue & 0x07;
 
-	if (boardId >= MV_MAX_BOARD_ID) {
-		mvOsPrintf("%s: Error: read wrong board (%d)\n", __func__, boardId);
+	if (gBoardId >= MV_MAX_BOARD_ID) {
+		mvOsPrintf("%s: Error: read wrong board (%d)\n", __func__, gBoardId);
 		return MV_INVALID_BOARD_ID;
 	}
-	return boardId;
+	return gBoardId;
 }
 
 /*******************************************************************************
@@ -1794,14 +1831,14 @@ MV_STATUS mvBoardTwsiGet(MV_BOARD_TWSI_CLASS twsiClass, MV_U8 devNum, MV_U8 regN
 	DB(mvOsPrintf("Board: TWSI Read device\n"));
 	twsiSlave.slaveAddr.address = mvBoardTwsiAddrGet(twsiClass, devNum);
 	twsiSlave.slaveAddr.type = mvBoardTwsiAddrTypeGet(twsiClass, devNum);
+	twsiSlave.moreThen256 = mvBoardTwsiIsMore256Get(twsiClass, devNum);
 
 	twsiSlave.validOffset = MV_TRUE;
 	/* Use offset as command */
 	twsiSlave.offset = regNum;
-	twsiSlave.moreThen256 = MV_FALSE;
 
 	if (MV_OK != mvTwsiRead(0, &twsiSlave, &data, 1)) {
-		mvOsPrintf("%s: Twsi Read fail\n", __func__);
+		DB(mvOsPrintf("%s: Twsi Read fail\n", __func__));
 		return MV_ERROR;
 	}
 	DB(mvOsPrintf("Board: Read S@R succeded\n"));
@@ -1846,7 +1883,7 @@ MV_STATUS mvBoardTwsiSet(MV_BOARD_TWSI_CLASS twsiClass, MV_U8 devNum, MV_U8 regN
 		      twsiSlave.slaveAddr.address, twsiSlave.slaveAddr.type, regVal));
 	/* Use offset as command */
 	twsiSlave.offset = regNum;
-	twsiSlave.moreThen256 = MV_FALSE;
+	twsiSlave.moreThen256 = mvBoardTwsiIsMore256Get(twsiClass, devNum);
 	if (MV_OK != mvTwsiWrite(0, &twsiSlave, &regVal, 1)) {
 		DB(mvOsPrintf("%s: Write S@R fail\n", __func__));
 		return MV_ERROR;
@@ -2155,10 +2192,10 @@ MV_STATUS mvBoardTwsiSatRGet(MV_U8 devNum, MV_U8 regNum, MV_U8 *pData)
 	if (0xFF == twsiSlave.slaveAddr.address)
 		return MV_ERROR;
 	twsiSlave.slaveAddr.type = mvBoardTwsiAddrTypeGet(BOARD_DEV_TWSI_SATR, devNum);
+	twsiSlave.moreThen256 = mvBoardTwsiIsMore256Get(BOARD_DEV_TWSI_SATR, devNum);
 
 	/* Use offset as command */
 	twsiSlave.offset = regNum;
-	twsiSlave.moreThen256 = MV_FALSE;
 	twsiSlave.validOffset = MV_TRUE;
 
 	/* TWSI init */
@@ -2209,7 +2246,7 @@ MV_STATUS mvBoardTwsiSatRSet(MV_U8 devNum, MV_U8 regNum, MV_U8 regVal)
 		      twsiSlave.slaveAddr.address, twsiSlave.slaveAddr.type, regVal));
 	/* Use offset as command */
 	twsiSlave.offset = regNum;
-	twsiSlave.moreThen256 = MV_FALSE;
+	twsiSlave.moreThen256 = mvBoardTwsiIsMore256Get(BOARD_DEV_TWSI_SATR, devNum);
 	/* TWSI init */
 	slave.type = ADDR7_BIT;
 	slave.address = 0;
diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
index f543230..e3f02e4 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
@@ -113,7 +113,6 @@ typedef enum _devBoardClass {
 typedef enum _devTwsiBoardClass {
 	BOARD_DEV_TWSI_SATR,
 	BOARD_TWSI_MODULE_DETECT,
-	BOARD_DEV_TWSI_EEPROM,
 	BOARD_TWSI_OTHER
 } MV_BOARD_TWSI_CLASS;
 
@@ -207,6 +206,7 @@ typedef struct _boardTwsiInfo {
 	MV_U8 devClassId;
 	MV_U8 twsiDevAddr;
 	MV_U8 twsiDevAddrType;
+	MV_U8 moreThen256;
 } MV_BOARD_TWSI_INFO;
 
 typedef struct _boardSatrInfo {
@@ -462,6 +462,7 @@ MV_32 mvBoardGetDeviceWinSize(MV_32 devNum, MV_BOARD_DEV_CLASS devClass);
 MV_U32 boardGetDevCSNum(MV_32 devNum, MV_BOARD_DEV_CLASS devClass);
 MV_U8 mvBoardTwsiAddrTypeGet(MV_BOARD_TWSI_CLASS twsiClass, MV_U32 index);
 MV_U8 mvBoardTwsiAddrGet(MV_BOARD_TWSI_CLASS twsiClass, MV_U32 index);
+MV_U8 mvBoardTwsiIsMore256Get(MV_BOARD_TWSI_CLASS twsiClass, MV_U32 index);
 MV_U32 mvBoardEthComplexConfigGet(MV_VOID);
 MV_VOID mvBoardEthComplexConfigSet(MV_U32 ethConfig);
 MV_U32 mvBoardIdGet(MV_VOID);
diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvSpec.c b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvSpec.c
index 40d41e2..43e9ac6 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvSpec.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvSpec.c
@@ -84,18 +84,18 @@ MV_BOARD_MPP_INFO db88f68xxInfoBoardMppConfigValue[] = {
 };
 
 MV_BOARD_TWSI_INFO db88f68xxInfoBoardTwsiDev[] = {
-	/* {{devClass,		devClassId, twsiDevAddr, twsiDevAddrType}} */
-	{ BOARD_DEV_TWSI_SATR,		0,	0x54,	   ADDR7_BIT},  /* read only for HW configuration */
-	{ BOARD_DEV_TWSI_SATR,		1,	0x4c,	   ADDR7_BIT},
-	{ BOARD_DEV_TWSI_SATR,		2,	0x4d,	   ADDR7_BIT},
-	{ BOARD_DEV_TWSI_SATR,		3,	0x4e,	   ADDR7_BIT},
-	{ BOARD_DEV_TWSI_SATR,		4,	0x21,	   ADDR7_BIT},
-	{ BOARD_TWSI_MODULE_DETECT,	0,	0x20,	   ADDR7_BIT},   /* modules */
-	{ BOARD_TWSI_MODULE_DETECT,	1,	0x23,	   ADDR7_BIT},
-	{ BOARD_TWSI_MODULE_DETECT,	2,	0x24,	   ADDR7_BIT},
-	{ BOARD_TWSI_MODULE_DETECT,	3,	0x25,	   ADDR7_BIT},
-	{ BOARD_TWSI_MODULE_DETECT,	4,	0x26,	   ADDR7_BIT},
-	{ BOARD_TWSI_MODULE_DETECT,	5,	0x27,	   ADDR7_BIT},
+	/* {{devClass,		devClassId, twsiDevAddr, twsiDevAddrType, moreThen256}} */
+	{ BOARD_DEV_TWSI_SATR,		0,	0x54,	   ADDR7_BIT, MV_TRUE},  /* read only for HW configuration */
+	{ BOARD_DEV_TWSI_SATR,		1,	0x4c,	   ADDR7_BIT, MV_FALSE},
+	{ BOARD_DEV_TWSI_SATR,		2,	0x4d,	   ADDR7_BIT, MV_FALSE},
+	{ BOARD_DEV_TWSI_SATR,		3,	0x4e,	   ADDR7_BIT, MV_FALSE},
+	{ BOARD_DEV_TWSI_SATR,		4,	0x21,	   ADDR7_BIT, MV_FALSE},
+	{ BOARD_TWSI_MODULE_DETECT,	0,	0x20,	   ADDR7_BIT, MV_FALSE},   /* modules */
+	{ BOARD_TWSI_MODULE_DETECT,	1,	0x23,	   ADDR7_BIT, MV_FALSE},
+	{ BOARD_TWSI_MODULE_DETECT,	2,	0x24,	   ADDR7_BIT, MV_FALSE},
+	{ BOARD_TWSI_MODULE_DETECT,	3,	0x25,	   ADDR7_BIT, MV_FALSE},
+	{ BOARD_TWSI_MODULE_DETECT,	4,	0x26,	   ADDR7_BIT, MV_FALSE},
+	{ BOARD_TWSI_MODULE_DETECT,	5,	0x27,	   ADDR7_BIT, MV_FALSE},
 };
 MV_BOARD_MAC_INFO db88f68xxInfoBoardMacInfo[] = {
 	/* {{MV_BOARD_MAC_SPEED boardMacSpeed, MV_8 boardEthSmiAddr}} */
@@ -184,8 +184,8 @@ MV_BOARD_INFO db88f68xx_board_info = {
 
 MV_BOARD_TWSI_INFO rd88F68XXInfoBoardTwsiDev[] = {
 	/* {{MV_BOARD_DEV_CLASS devClass, MV_U8 devClassId,  MV_U8 twsiDevAddr, MV_U8 twsiDevAddrType}} */
-	{ BOARD_DEV_TWSI_SATR,	0,	0x54, ADDR7_BIT	},  /* read only for HW configuration */
-	{ BOARD_DEV_TWSI_SATR,	1,	0x4C, ADDR7_BIT	},
+	{ BOARD_DEV_TWSI_SATR,	0,	0x54, ADDR7_BIT, MV_TRUE},  /* read only for HW configuration */
+	{ BOARD_DEV_TWSI_SATR,	1,	0x4C, ADDR7_BIT, MV_FALSE},
 };
 MV_BOARD_MAC_INFO rd88F68XXInfoBoardMacInfo[] = {
 	/* {{MV_BOARD_MAC_SPEED boardMacSpeed, MV_8 boardEthSmiAddr}} */
@@ -276,7 +276,7 @@ MV_BOARD_TWSI_INFO A380_customerInfoBoardTwsiDev[] = {
 	/* {{MV_BOARD_DEV_CLASS devClass, MV_U8 devClassId,  MV_U8 twsiDevAddr, MV_U8 twsiDevAddrType}} */
 	{ BOARD_DEV_TWSI_SATR,		0,	0x4C,	   ADDR7_BIT	},
 	{ BOARD_DEV_TWSI_SATR,		1,	0x4D,	   ADDR7_BIT	},
-	{ BOARD_DEV_TWSI_EEPROM,	0,	0x54,	   ADDR7_BIT	},
+	{ BOARD_DEV_TWSI_SATR,		0,	0x54,	   ADDR7_BIT	},
 };
 
 MV_BOARD_MAC_INFO A380_customerInfoBoardMacInfo[] = {
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
index 4878761..73b27bb 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
@@ -133,10 +133,10 @@ MV_U32 mvCtrlGetCpuNum(MV_VOID)
 {
 	MV_U32 cpu1Enabled;
 
-	cpu1Enabled = MV_REG_READ(MPP_SAMPLE_AT_RESET(1));
+	cpu1Enabled = MV_REG_READ(MPP_SAMPLE_AT_RESET);
 	if (cpu1Enabled & SATR_CPU1_ENABLE_MASK)
-		return 2;
-	return 1;
+		return 1;
+	return 0;
 }
 
 /*******************************************************************************
@@ -244,30 +244,32 @@ static MV_VOID mvCtrlSerdesConfig(MV_VOID)
 	mvCtrlSocUnitInfoNumSet(USB3_UNIT_ID, usbHIfCount);
 	if (ethIfCount) /* if serdes configuration found SGMII ports replace the existing RGMII gonfiguration*/
 		mvCtrlSocUnitInfoNumSet(ETH_GIG_UNIT_ID, ethIfCount);
+	else
+		mvCtrlSocUnitInfoNumSet(ETH_GIG_UNIT_ID, MV_ETH_MAX_ON_BOARD_PORTS);
 }
 
 
 MV_UNIT_ID mvCtrlSocUnitNums[MAX_UNITS_ID][MV_68xx_INDEX_MAX] = {
 /*                          6820 */
 /* DRAM_UNIT_ID         */ { 1, 1},
-/* PEX_UNIT_ID          */ { MV_PEX_MAX_UNIT, MV_PEX_MAX_UNIT_6810},
-/* ETH_GIG_UNIT_ID      */ { MV_ETH_MAX_PORTS, MV_ETH_MAX_PORTS_6810},
-/* USB_UNIT_ID          */ { MV_USB_MAX_PORTS, MV_USB3_MAX_PORTS_6810},
-/* USB3_UNIT_ID         */ { MV_USB3_MAX_PORTS, MV_USB3_MAX_PORTS_6810},
-/* IDMA_UNIT_ID         */ { MV_IDMA_MAX_CHAN, MV_IDMA_MAX_CHAN},
-/* XOR_UNIT_ID          */ { MV_XOR_MAX_UNIT, MV_XOR_MAX_UNIT},
-/* SATA_UNIT_ID         */ { MV_SATA_MAX_CHAN, MV_SATA_MAX_CHAN},
-/* TDM_32CH_UNIT_ID     */ { 1, 1},
-/* UART_UNIT_ID         */ { MV_UART_MAX_CHAN, MV_UART_MAX_CHAN},
-/* CESA_UNIT_ID         */ { 1, 1},
-/* SPI_UNIT_ID          */ { 1, 1},
-/* AUDIO_UNIT_ID        */ { 1, 1},
-/* SDIO_UNIT_ID         */ { 1, 1},
-/* TS_UNIT_ID           */ { 0, 0},
-/* XPON_UNIT_ID         */ { 0, 0},
-/* BM_UNIT_ID           */ { 0, 0},
-/* PNC_UNIT_ID          */ { 0, 0},
-/* I2C_UNIT_ID          */ { 2, 2},
+/* PEX_UNIT_ID          */ { MV_PEX_MAX_UNIT,		MV_PEX_MAX_UNIT_6810},
+/* ETH_GIG_UNIT_ID      */ { MV_ETH_MAX_PORTS,	MV_ETH_MAX_PORTS_6810},
+/* USB_UNIT_ID          */ { MV_USB_MAX_PORTS,		MV_USB3_MAX_PORTS_6810},
+/* USB3_UNIT_ID         */ { MV_USB3_MAX_PORTS,		MV_USB3_MAX_PORTS_6810},
+/* IDMA_UNIT_ID         */ { MV_IDMA_MAX_CHAN,		MV_IDMA_MAX_CHAN},
+/* XOR_UNIT_ID          */ { MV_XOR_MAX_UNIT,		MV_XOR_MAX_UNIT},
+/* SATA_UNIT_ID         */ { MV_SATA_MAX_CHAN,		MV_SATA_MAX_CHAN},
+/* TDM_32CH_UNIT_ID     */ { 1,				1},
+/* UART_UNIT_ID         */ { MV_UART_MAX_CHAN,		MV_UART_MAX_CHAN},
+/* CESA_UNIT_ID         */ { 1,				1},
+/* SPI_UNIT_ID          */ { 1,				1},
+/* AUDIO_UNIT_ID        */ { 1,				1},
+/* SDIO_UNIT_ID         */ { 1,				1},
+/* TS_UNIT_ID           */ { 0,				0},
+/* XPON_UNIT_ID         */ { 0,				0},
+/* BM_UNIT_ID           */ { 0,				0},
+/* PNC_UNIT_ID          */ { 0,				0},
+/* I2C_UNIT_ID          */ { 2,				2},
 };
 
 MV_U32 mvCtrlSocUnitInfoNumGet(MV_UNIT_ID unit)
@@ -390,7 +392,7 @@ MV_STATUS mvCtrlCpuDdrL2FreqGet(MV_FREQ_MODE *freqMode)
 	MV_FREQ_MODE freqTable[] = MV_SAR_FREQ_MODES;
 	MV_U32 freqModeSatRValue, satrVal;
 
-	satrVal = MV_REG_READ(MPP_SAMPLE_AT_RESET(1));
+	satrVal = MV_REG_READ(MPP_SAMPLE_AT_RESET);
 	freqModeSatRValue = (satrVal & SATR_CPU_FREQ_MASK) >> SATR_CPU_FREQ_OFFS;
 
 	if (freqModeSatRValue <= 29) {
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
index efb914a..da4b5a9 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
@@ -230,9 +230,9 @@ MV_U32 mvCtrlPexMaxUnitGet(MV_VOID);
 MV_U32 mvCtrlPexActiveUnitNumGet(MV_VOID);
 
 #if defined(MV_INCLUDE_PCI)
-#define mvCtrlPciIfMaxIfGet()           1
+#define mvCtrlPciIfMaxIfGet()           3
 #else
-#define mvCtrlPciIfMaxIfGet()           0
+#define mvCtrlPciIfMaxIfGet()           3
 #endif
 
 MV_U32 mvCtrlEthMaxPortGet(MV_VOID);
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
index 63713a6..ecd3390 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
@@ -137,12 +137,10 @@ extern "C" {
 #define SGMII_SERDES_STAT_REG(port)		(MV_ETH_SGMII_PHY_REGS_BASE(port) + 0x4A4)
 
 /* Sample at Reset */
-#define MPP_SAMPLE_AT_RESET(id)		(0xE8200 + ( id * 0x4 ))
-#define SATR_DEVICE_ID_2_0_OFFS		21
-#define SATR_DEVICE_ID_2_0_MASK		(3 << SATR_DEVICE_ID_2_0_OFFS)
-#define SATR_CPU_FREQ_OFFS			17
-#define SATR_CPU_FREQ_MASK			(0x1F << SATR_CPU_FREQ_OFFS)
-#define SATR_CPU1_ENABLE_OFFS		15
+#define MPP_SAMPLE_AT_RESET		(0x18600)
+#define SATR_CPU_FREQ_OFFS		10
+#define SATR_CPU_FREQ_MASK		(0x1F << SATR_CPU_FREQ_OFFS)
+#define SATR_CPU1_ENABLE_OFFS		19
 #define SATR_CPU1_ENABLE_MASK		(1 << SATR_CPU1_ENABLE_OFFS)
 
 /* Core Divider Clock Control */
@@ -351,7 +349,8 @@ typedef enum _mvTargetId {
 	DEV_TARGET_ID    = 1,  /* Port 1  -> Device bus, BootROM, SPI, UART,
 				*	     GPIO, MPP, and Miscellaneous */
 	USB3_TARGET_ID   = 5,  /* Port 5  -> USB3 Unit,                 */
-	PEX_TARGET_ID    = 4,  /* Port 4  -> PCI Express 0 and 1        */
+	PEX_TARGET_ID_123  = 4,  /* Port 4  -> PCI Express 0 and 1        */
+	PEX_TARGET_ID_0   = 8,  /* Port 4  -> PCI Express 0 and 1        */
 	CRYPT_TARGET_ID  = 9,  /* Port 9  -> Crypto Engine SRAM         */
 	PNC_BM_TARGET_ID = 0xC,    /* Port 12 -> PP2 Unit                   */
 	MAX_TARGETS_ID
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
index e30b703..ae9d761 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -208,6 +208,7 @@ extern "C" {
 /* TODO - verify all these numbers */
 /* This define describes the maximum number of supported Ethernet ports */
 #define MV_ETH_MAX_PORTS			3
+#define MV_ETH_MAX_ON_BOARD_PORTS		2
 #define MV_ETH_MAX_PORTS_6810			2
 #define MV_ETH_VERSION				4 /* for Legacy mode */
 #define MV_NETA_VERSION				1 /* for NETA mode */
@@ -363,14 +364,14 @@ typedef enum _mvTarget {
 	{ 0x3D, DEV_TARGET_ID	},		/* DEVICE_CS1            */ \
 	{ 0x3B, DEV_TARGET_ID	},		/* DEVICE_CS2            */ \
 	{ 0x37, DEV_TARGET_ID	},		/* DEVICE_CS3            */ \
-	{ 0xE8, PEX_TARGET_ID	},		/* PEX0_MEM              */ \
-	{ 0xE0, PEX_TARGET_ID	},		/* PEX0_IO               */ \
-	{ 0xD8, PEX_TARGET_ID	},		/* PEX1_MEM              */ \
-	{ 0xD0, PEX_TARGET_ID	},		/* PEX1_IO               */ \
-	{ 0xB8, PEX_TARGET_ID	},		/* PEX2_MEM              */ \
-	{ 0xB0, PEX_TARGET_ID	},		/* PEX2_IO               */ \
-	{ 0x78, PEX_TARGET_ID	},		/* PEX3_MEM              */ \
-	{ 0x70, PEX_TARGET_ID	},		/* PEX3_IO               */ \
+	{ 0xE8, PEX_TARGET_ID_0	},		/* PEX0_MEM              */ \
+	{ 0xE0, PEX_TARGET_ID_0	},		/* PEX0_IO               */ \
+	{ 0xE8, PEX_TARGET_ID_123 },		/* PEX1_MEM              */ \
+	{ 0xE0, PEX_TARGET_ID_123 },		/* PEX1_IO               */ \
+	{ 0xB8, PEX_TARGET_ID_123 },		/* PEX2_MEM              */ \
+	{ 0xB0, PEX_TARGET_ID_123 },		/* PEX2_IO               */ \
+	{ 0x78, PEX_TARGET_ID_123 },		/* PEX3_MEM              */ \
+	{ 0x70, PEX_TARGET_ID_123 },		/* PEX3_IO               */ \
 	{ 0xFF, 0xFF		},		/* INTER_REGS            */ \
 	{ 0x01, DEV_TARGET_ID	},		/* DMA_UART              */ \
 	{ 0x1E, DEV_TARGET_ID	},		/* SPI_CS0               */ \
@@ -401,6 +402,10 @@ typedef enum _mvTarget {
 	"PEX0_IO",		/* PEX0_IO */		\
 	"PEX1_MEM",		/* PEX1_MEM */		\
 	"PEX1_IO",		/* PEX1_IO */		\
+	"PEX2_MEM",		/* PEX0_MEM */		\
+	"PEX2_IO",		/* PEX0_IO */		\
+	"PEX3_MEM",		/* PEX1_MEM */		\
+	"PEX3_IO",		/* PEX1_IO */		\
 	"INTER_REGS",		/* INTER_REGS */	\
 	"DMA_UART",		/* DMA_UART */		\
 	"SPI_CS0",		/* SPI_CS0 */		\
-- 
1.7.5.4

