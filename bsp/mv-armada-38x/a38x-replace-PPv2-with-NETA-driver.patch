From 677499a1c3979eadae876a15aa7db037155948e0 Mon Sep 17 00:00:00 2001
From: Nadav Haklai <nadavh@marvell.com>
Date: Sun, 20 Oct 2013 10:13:53 +0200
Subject: [PATCH 1104/1825] a38x: replace PPv2 with NETA driver

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 82fe74baf41d057e44bcccb70ae75f4df49bb15e

	- align to using new plat_data structure for per port driver initialization
	- add module support
	- update information about neta registers in ctrlEnv
	- disable PNC and BM

Change-Id: Ife708b7e93edf27072ccce68bbc48d9b3f935938
Signed-off-by: Marcin Wojtas <mw@semihalf.com>
Signed-off-by: Nadav Haklai <nadavh@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3762
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/configs/armada_380_v7up_defconfig         |    4 +-
 arch/arm/configs/armada_385_v7smp_defconfig        |    4 +-
 arch/arm/mach-armada38x/Makefile                   |    4 +-
 .../armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h      |    8 +
 .../armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h      |   23 +--
 arch/arm/mach-armada38x/config/mvRules.mk          |   34 +++-
 arch/arm/mach-armada38x/config/mvSysEthConfig.h    |    8 +
 arch/arm/mach-armada38x/config/mvSysHwConfig.h     |    3 -
 arch/arm/mach-armada38x/core.c                     |  200 +++++++++-----------
 arch/arm/mach-armada38x/export.c                   |   22 ++-
 arch/arm/mach-armada38x/include/mach/armada38x.h   |    7 +-
 arch/arm/mach-armada38x/include/mach/irqs.h        |   16 +-
 arch/arm/mach-armada38x/mv_hal_if/mvSysEthPhy.c    |    4 +-
 arch/arm/mach-armada38x/sysmap.c                   |   11 +-
 arch/arm/plat-armada/Kconfig                       |    4 +-
 15 files changed, 182 insertions(+), 170 deletions(-)

diff --git a/arch/arm/configs/armada_380_v7up_defconfig b/arch/arm/configs/armada_380_v7up_defconfig
index 93da650..64813af 100644
--- a/arch/arm/configs/armada_380_v7up_defconfig
+++ b/arch/arm/configs/armada_380_v7up_defconfig
@@ -20,10 +20,12 @@ CONFIG_MV_ETH_TXQ=8
 # CONFIG_MV_INCLUDE_XOR is not set
 # CONFIG_MV_INCLUDE_INTEG_SATA is not set
 # CONFIG_MV_INCLUDE_SDIO is not set
+# CONFIG_MV_ETH_BM is not set
+# CONFIG_MV_ETH_PNC is not set
 CONFIG_MV_ETH_TXQ_DESC=1024
 CONFIG_MV_ETH_DEBUG_CODE=y
 CONFIG_MV_ETH_STAT_DBG=y
-CONFIG_MV_ETH_TXQ_HWF_DESC=512
+CONFIG_MV_ETH_GROUP0_CPU=0x1
 CONFIG_PL310_ERRATA_588369=y
 CONFIG_PL310_ERRATA_727915=y
 CONFIG_PL310_ERRATA_753970=y
diff --git a/arch/arm/configs/armada_385_v7smp_defconfig b/arch/arm/configs/armada_385_v7smp_defconfig
index dbba244..e6575fb 100644
--- a/arch/arm/configs/armada_385_v7smp_defconfig
+++ b/arch/arm/configs/armada_385_v7smp_defconfig
@@ -20,10 +20,12 @@ CONFIG_MV_ETH_TXQ=8
 # CONFIG_MV_INCLUDE_XOR is not set
 # CONFIG_MV_INCLUDE_INTEG_SATA is not set
 # CONFIG_MV_INCLUDE_SDIO is not set
+# CONFIG_MV_ETH_BM is not set
+# CONFIG_MV_ETH_PNC is not set
 CONFIG_MV_ETH_TXQ_DESC=1024
 CONFIG_MV_ETH_DEBUG_CODE=y
 CONFIG_MV_ETH_STAT_DBG=y
-CONFIG_MV_ETH_TXQ_HWF_DESC=512
+CONFIG_MV_ETH_GROUP0_CPU=0x3
 # CONFIG_SWP_EMULATE is not set
 CONFIG_PL310_ERRATA_588369=y
 CONFIG_PL310_ERRATA_727915=y
diff --git a/arch/arm/mach-armada38x/Makefile b/arch/arm/mach-armada38x/Makefile
index dd1b6b3..0203b84 100644
--- a/arch/arm/mach-armada38x/Makefile
+++ b/arch/arm/mach-armada38x/Makefile
@@ -69,8 +69,8 @@ armada38x-$(CONFIG_MV_INCLUDE_USB)	+= $(HAL_USB_DIR)/mvUsb.o $(HAL_USB_DIR)/mvUs
 					   $(HAL_IF_DIR)/mvSysUsb.o
 armada38x-$(CONFIG_MV_INCLUDE_ETH_PHY)	+= $(HAL_ETHPHY_DIR)/mvEthPhy.o $(HAL_IF_DIR)/mvSysEthPhy.o
 
-# PP2 Giga driver
-obj-$(CONFIG_MV_ETH_PP2)		+= $(LSP_PP2_DIR)/
+# NETA Giga driver
+obj-$(CONFIG_MV_ETH_NETA)		+= $(LSP_NETA_DIR)/
 
 armada38x-$(CONFIG_MV_INCLUDE_CESA)	+= $(HAL_CESA_DIR)/mvCesa.o					\
 					   $(HAL_CESA_DIR)/mvCesaDebug.o				\
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
index 513866b..4cb5622 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
@@ -128,6 +128,14 @@ extern "C" {
 
 #define MPP_CONTROL_REG(id)                     (0x18000 + (id * 4))
 
+#define SGMII_PWR_PLL_CTRL_REG(port)		(MV_ETH_SGMII_PHY_REGS_BASE(port) + 0xE04)
+#define SGMII_GEN_1_SET_REG(port)		(MV_ETH_SGMII_PHY_REGS_BASE(port) + 0xE34)
+#define SGMII_DIG_LP_ENA_REG(port)		(MV_ETH_SGMII_PHY_REGS_BASE(port) + 0xE8C)
+#define SGMII_REF_CLK_SEL_REG(port)		(MV_ETH_SGMII_PHY_REGS_BASE(port) + 0xF18)
+#define SGMII_PHY_CTRL_REG(port)		(MV_ETH_SGMII_PHY_REGS_BASE(port) + 0xF20)
+#define SGMII_SERDES_CFG_REG(port)		(MV_ETH_SGMII_PHY_REGS_BASE(port) + 0x4A0)
+#define SGMII_SERDES_STAT_REG(port)		(MV_ETH_SGMII_PHY_REGS_BASE(port) + 0x4A4)
+
 /* Sample at Reset */
 #define MPP_SAMPLE_AT_RESET(id)		(0xE8200 + ( id * 0x4 ))
 #define SATR_DEVICE_ID_2_0_OFFS		21
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
index 1a2c279..ebce870 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -110,18 +110,15 @@ extern "C" {
 #define MV_CPUIF_REGS_OFFSET(cpu)               (0x21800 + (cpu) * 0x100)
 #define MV_CPU_HW_SEM_OFFSET                    (0x20500)
 
-/* PPv2 register base addresses */
-#define MV_PP2_REG_BASE                         (0xF0000)
-#define MV_ETH_BASE_ADDR                        (0xC0000)
-#define LMS_REG_BASE                            (MV_ETH_BASE_ADDR)
-#define MIB_COUNTERS_REG_BASE                   (MV_ETH_BASE_ADDR + 0x1000)
-#define GOP_MNG_REG_BASE                        (MV_ETH_BASE_ADDR + 0x3000)
-#define GOP_REG_BASE(port)                      (MV_ETH_BASE_ADDR + 0x4000 + ((port) / 2) * 0x3000 + ((port) % 2) * 0x1000)
-#define MV_PON_REGS_OFFSET                      (MV_ETH_BASE_ADDR + 0x8000)
-
-#define MV_PON_EXIST
-#define MV_ETH_MAX_TCONT                        16
-#define MV_ETH_RXQ_TOTAL_NUM                    32
+/* Network ports register base addresses */
+#if defined(MV_ETH_LEGACY)
+	#define MV_ETH_BASE_ADDR		(0x72000)
+#else
+	#define MV_ETH_BASE_ADDR		(0x70000)
+#endif
+#define MV_ETH_REGS_OFFSET(port)		(port < 1 ? MV_ETH_BASE_ADDR : MV_ETH_BASE_ADDR - 0x40000 \
+						+ ((port) / 2) * 0x4000)
+#define MV_ETH_SGMII_PHY_REGS_OFFSET(port)	(port < 1 ? 0x72000 : 0x32000 + ((port) / 2) * 0x4000)
 
 #define MV_PEX_IF_REGS_OFFSET(pexIf)            (((pexIf) == 0) ? 0x80000 : (0x40000 + ((pexIf) * 0x4000)))
 #define MV_USB_REGS_OFFSET(dev)                 (0x50000)
@@ -132,6 +129,7 @@ extern "C" {
 #define MV_SATA_REGS_OFFSET                     (0xA0000)
 #define MV_COMM_UNIT_REGS_OFFSET                (0xB0000)
 #define MV_NFC_REGS_OFFSET                      (0xD0000)
+#define MV_BM_REGS_OFFSET			(0xC8000)
 #define MV_SDMMC_REGS_OFFSET                    (0xD4000)
 
 #define MV_ETH_SMI_PORT   0
@@ -217,7 +215,6 @@ extern "C" {
 #define MV_ETH_MAX_RXQ                          16/* Maximum number of RXQs can be mapped to each port */
 #define MV_ETH_MAX_TXQ                          8
 #define MV_ETH_RXQ_TOTAL_NUM                    32      /* Total number of RXQs for usage by all ports */
-#define MV_ETH_MAX_TCONT                        16      /* Maximum number of TCONTs supported by PON port */
 #define MV_ETH_TX_CSUM_MAX_SIZE                 9800
 
 /* This define describes the the support of USB */
diff --git a/arch/arm/mach-armada38x/config/mvRules.mk b/arch/arm/mach-armada38x/config/mvRules.mk
index e7180af..b4de39f 100644
--- a/arch/arm/mach-armada38x/config/mvRules.mk
+++ b/arch/arm/mach-armada38x/config/mvRules.mk
@@ -42,8 +42,29 @@ HAL_TWSI_DIR	  = $(HAL_DIR)/twsi
 HAL_TWSI_ARCH_DIR = $(SOC_TWSI_DIR)/Arch$(CPU_ARCH)
 HAL_UART_DIR	  = $(HAL_DIR)/uart
 
-HAL_PP2_DIR	  = $(HAL_DIR)/pp2
-LSP_PP2_DIR	  = $(PLAT_DRIVERS)/mv_pp2
+# NETA driver directories
+HAL_NETA_DIR      = $(HAL_DIR)/neta
+HAL_NETA_GBE_DIR  = $(HAL_DIR)/neta/gbe
+HAL_NETA_NFP_DIR  = $(HAL_DIR)/neta/nfp
+HAL_NETA_PNC_DIR  = $(HAL_DIR)/neta/pnc
+HAL_NETA_BM_DIR   = $(HAL_DIR)/neta/bm
+HAL_NETA_PMT_DIR  = $(HAL_DIR)/neta/pmt
+LSP_NETA_DIR      = $(PLAT_DRIVERS)/mv_neta
+LSP_NETA_DEV_DIR  = $(LSP_NETA_DIR)/net_dev
+LSP_NETA_NFP_DIR  = $(LSP_NETA_DIR)/nfp_mgr
+LSP_NETA_PNC_DIR  = $(LSP_NETA_DIR)/pnc
+LSP_NETA_BM_DIR   = $(LSP_NETA_DIR)/bm
+LSP_NETA_PMT_DIR  = $(LSP_NETA_DIR)/pmt
+LSP_NETA_HWF_DIR  = $(LSP_NETA_DIR)/hwf
+LSP_NETA_L2FW_DIR = $(LSP_NETA_DIR)/l2fw
+
+# Legacy network driver directories
+HAL_ETH_DIR       = $(HAL_DIR)/eth
+HAL_ETH_GBE_DIR   = $(HAL_DIR)/eth/gbe
+HAL_ETH_NFP_DIR   = $(HAL_DIR)/eth/nfp
+LSP_NETWORK_DIR   = $(PLAT_DRIVERS)/mv_network
+LSP_NET_DEV_DIR   = $(LSP_NETWORK_DIR)/mv_etherent
+LSP_NFP_MGR_DIR   = $(LSP_NETWORK_DIR)/nfp_mgr
 
 HAL_CPU_DIR	  = $(HAL_DIR)/cpu
 HAL_SDMMC_DIR	  = $(HAL_DIR)/sdmmc
@@ -97,7 +118,8 @@ HAL_IF_DIR	= mv_hal_if
 LSP_PATH_I	= $(srctree)/arch/arm/mach-armada38x
 PLAT_PATH_I	= $(srctree)/arch/arm/plat-armada
 
-HAL_PATH	= -I$(PLAT_PATH_I)/$(HAL_DIR) -I$(PLAT_PATH_I)/$(HAL_SATA_DIR) -I$(PLAT_PATH_I)/$(HAL_ETH_DIR)
+HAL_PATH	= -I$(PLAT_PATH_I)/$(HAL_DIR) -I$(PLAT_PATH_I)/$(HAL_SATA_DIR) \
+		  -I$(PLAT_PATH_I)/$(HAL_NETA_DIR)
 A38X_FAM_PATH	= -I$(LSP_PATH_I)/$(A38X_FAM_DIR)
 QD_PATH		= -I$(PLAT_PATH_I)/$(HAL_QD_DIR)/Include  -I$(PLAT_PATH_I)/$(HAL_QD_DIR)/Include/h/msApi	\
 		  -I$(PLAT_PATH_I)/$(HAL_QD_DIR)/Include/h/driver -I$(PLAT_PATH_I)/$(HAL_QD_DIR)/Include/h/platform
@@ -107,9 +129,9 @@ COMMON_PATH	= -I$(PLAT_PATH_I)/$(COMMON_DIR) -I$(srctree)
 OSSERV_PATH	= -I$(PLAT_PATH_I)/$(OSSERV_DIR)
 LSP_PATH	= -I$(LSP_PATH_I)
 CONFIG_PATH	= -I$(LSP_PATH_I)/$(CONFIG_DIR)
-HAL_IF_PATH	= -I$(LSP_PATH_I)/$(HAL_IF) -I$(LSP_PATH_I)/$(HAL_PP2_DIR)
-DRIVERS_LSP_PATH = -I$(PLAT_PATH_I)/$(PLAT_DRIVERS) -I$(PLAT_PATH_I)/$(LSP_PP2_DIR) -I$(PLAT_PATH_I)/$(LSP_SWITCH_DIR) \
-		   -I$(PLAT_PATH_I)/$(LSP_TRACE_DIR)
+HAL_IF_PATH	= -I$(LSP_PATH_I)/$(HAL_IF)
+DRIVERS_LSP_PATH = -I$(PLAT_PATH_I)/$(PLAT_DRIVERS) -I$(PLAT_PATH_I)/$(LSP_NETA_DIR) \
+		   -I$(PLAT_PATH_I)/$(LSP_SWITCH_DIR) -I$(PLAT_PATH_I)/$(LSP_TRACE_DIR)
 
 EXTRA_INCLUDE	= $(OSSERV_PATH) $(COMMON_PATH) $(HAL_PATH)  $(A38X_FAM_PATH) \
 		  $(LSP_PATH) $(CONFIG_PATH) $(DRIVERS_LSP_PATH) $(HAL_IF_PATH)
diff --git a/arch/arm/mach-armada38x/config/mvSysEthConfig.h b/arch/arm/mach-armada38x/config/mvSysEthConfig.h
index 49d0b5a..e149c9f 100644
--- a/arch/arm/mach-armada38x/config/mvSysEthConfig.h
+++ b/arch/arm/mach-armada38x/config/mvSysEthConfig.h
@@ -82,6 +82,14 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define MV_ETH_COMPLEX_BASE		(MV_ETH_COMPLEX_OFFSET)
 #define MV_ETH_ONLY_REGS_BASE		(MV_ETH_ONLY_REGS_OFFSET)
 
+/*
+** Base address for ethernet registers.
+*/
+#define MV_PON_PORT(p)		MV_FALSE
+#define MV_ETH_REGS_BASE(p)	MV_ETH_REGS_OFFSET(p)
+#define MV_BM_REG_BASE		MV_BM_REGS_OFFSET
+#define MV_ETH_SGMII_PHY_REGS_BASE(p)  MV_ETH_SGMII_PHY_REGS_OFFSET(p)
+
 #if defined(CONFIG_MV_INCLUDE_GIG_ETH)
 /* put descriptors in uncached memory */
 /* #define ETH_DESCR_UNCACHED */
diff --git a/arch/arm/mach-armada38x/config/mvSysHwConfig.h b/arch/arm/mach-armada38x/config/mvSysHwConfig.h
index 8280012..5d3c91f 100644
--- a/arch/arm/mach-armada38x/config/mvSysHwConfig.h
+++ b/arch/arm/mach-armada38x/config/mvSysHwConfig.h
@@ -87,9 +87,6 @@ disclaimer.
 #ifdef CONFIG_MV_INCLUDE_CESA
 #define MV_INCLUDE_CESA
 #endif
-#ifdef CONFIG_MV_ETH_PP2
-#define MV_ETH_PP2
-#endif
 #ifdef CONFIG_MV_INCLUDE_GIG_ETH
 #define MV_INCLUDE_GIG_ETH
 #endif
diff --git a/arch/arm/mach-armada38x/core.c b/arch/arm/mach-armada38x/core.c
index 09b66b7..e594f03 100644
--- a/arch/arm/mach-armada38x/core.c
+++ b/arch/arm/mach-armada38x/core.c
@@ -23,6 +23,7 @@
 #include <linux/mtd/partitions.h>
 #include <linux/string.h>
 #include <linux/mbus.h>
+#include <linux/ethtool.h>
 #include <linux/mv643xx_i2c.h>
 #include <asm/smp_scu.h>
 #include <asm/setup.h>
@@ -31,6 +32,7 @@
 #include <asm/mach/arch.h>
 #include <mach/system.h>
 
+#include <linux/etherdevice.h>
 #include <linux/tty.h>
 #include <linux/platform_device.h>
 #include <linux/serial_core.h>
@@ -66,8 +68,6 @@
 
 #if defined(CONFIG_MV_ETH_NETA)
 #include <linux/mv_neta.h>
-#elif defined(CONFIG_MV_ETH_PP2)
-#include <linux/mv_pp2.h>
 #endif
 
 #if defined(CONFIG_MV_INCLUDE_CESA)
@@ -526,45 +526,39 @@ static struct platform_device mv88fx_eth = {
 	.id = 0,
 	.num_resources = 0,
 };
-#elif defined(CONFIG_MV_ETH_NETA)
-static struct platform_device mv88fx_neta = {
-	.name = "mv88fx_neta",
-	.id = 0,
-	.num_resources = 0,
-};
-#elif defined(CONFIG_MV_ETH_PP2)
-static void mv_pp2_giga_pdev_register(struct platform_device *pdev)
+#endif /* CONFIG_MV_ETH_LEGACY */
+
+#if defined(CONFIG_MV_ETH_NETA) || defined(CONFIG_MV_ETH_NETA_MODULE)
+static void mv_neta_giga_pdev_register(struct platform_device *pdev)
 {
-	struct mv_pp2_pdata *plat_data =
-	    (struct mv_pp2_pdata *)pdev->dev.platform_data;
+	struct mv_neta_pdata *plat_data = (struct mv_neta_pdata *)pdev->dev.platform_data;
 	int speed, port = pdev->id;
 
-	plat_data->max_port = mvCtrlEthMaxPortGet();
-	plat_data->tclk = mvBoardTclkGet();
+	/* Global Parameters */
 	plat_data->ctrl_model = mvCtrlModelGet();
 	plat_data->ctrl_rev = mvCtrlRevGet();
-	plat_data->cpu_mask = group_cpu_mask;
+	plat_data->pclk = mvCpuPclkGet();
+	plat_data->tclk = mvBoardTclkGet();
+	plat_data->max_port = mvCtrlEthMaxPortGet();
+	plat_data->max_cpu = mvCtrlEthMaxCPUsGet();
+	/* Per port parameters */
+	plat_data->cpu_mask  = (1 << nr_cpu_ids) - 1;
 	plat_data->phy_addr = mvBoardPhyAddrGet(port);
+	plat_data->is_sgmii = mvBoardIsPortInSgmii(port);
+	plat_data->is_rgmii = mvBoardIsPortInRgmii(port);
 	plat_data->duplex = DUPLEX_FULL;
 
-	if (mvBoardIsPortLoopback(port))
-		plat_data->flags |= MV_PP2_PDATA_F_LB;
-
 	if (port < MV_UBOOT_ETH_PORTS) {
 		plat_data->mtu = mvMtu[port];
-		if (plat_data->mtu == 0) {
+		if (plat_data->mtu == 0)
 			plat_data->mtu = 1500;
-			pr_err
-			    ("%s: warning - failed to use MTU from uboot env, changing to default MTU (1500).\n",
-			     __func__);
-		}
-
 		memcpy(plat_data->mac_addr, mvMacAddr[port], 6);
+		if (is_zero_ether_addr(plat_data->mac_addr))
+			pr_warning("Warning: port #%d - zero MAC address\n", port);
 	} else {
 		plat_data->mtu = 1500;
 		memset(plat_data->mac_addr, 0, 6);
 	}
-
 	speed = mvBoardMacSpeedGet(port);
 	switch (speed) {
 	case BOARD_MAC_SPEED_10M:
@@ -581,123 +575,101 @@ static void mv_pp2_giga_pdev_register(struct platform_device *pdev)
 		plat_data->speed = 0;
 		break;
 	}
-
+	pr_info("Register platform device: %s_%d\n", pdev->name, pdev->id);
 	platform_device_register(pdev);
 }
-
-static struct resource mv_pp2_ge0_resources[] = {
+static struct resource mv_neta_ge0_resources[] = {
 	{
-	 .start = IRQ_GLOBAL_PP_PORT0_RXTX,
-	 .end = IRQ_GLOBAL_PP_PORT0_RXTX,
-	 .flags = IORESOURCE_IRQ,
-	 },
+		.start          = IRQ_PRIV_PORT0_TH_RXTX,
+		.end            = IRQ_PRIV_PORT0_TH_RXTX,
+		.flags          = IORESOURCE_IRQ,
+	},
 };
-
-static struct mv_pp2_pdata mv_pp2_ge0_pdata = {
+static struct mv_neta_pdata mv_neta_ge0_pdata = {
 	.mtu = 1500,
 	.phy_addr = 0,
-	.flags = MV_PP2_PDATA_F_LINUX_CONNECT,
 };
-
-static struct platform_device mv_pp2_ge0_plat = {
-	.name = MV_PP2_PORT_NAME,
-	.id = 0,
-	.num_resources = ARRAY_SIZE(mv_pp2_ge0_resources),
-	.resource = mv_pp2_ge0_resources,
-	.dev = {
-		.platform_data = &mv_pp2_ge0_pdata,
-		},
+static struct platform_device mv_neta_ge0_plat = {
+	.name           = MV_NETA_PORT_NAME,
+	.id		= 0,
+	.num_resources  = ARRAY_SIZE(mv_neta_ge0_resources),
+	.resource       = mv_neta_ge0_resources,
+	.dev            = {
+		.platform_data = &mv_neta_ge0_pdata,
+	},
 };
-
-static struct resource mv_pp2_ge1_resources[] = {
+static struct resource mv_neta_ge1_resources[] = {
 	{
-	 .start = IRQ_GLOBAL_PP_PORT1_RXTX,
-	 .end = IRQ_GLOBAL_PP_PORT1_RXTX,
-	 .flags = IORESOURCE_IRQ,
-	 },
+		.start          = IRQ_PRIV_PORT1_TH_RXTX,
+		.end            = IRQ_PRIV_PORT1_TH_RXTX,
+		.flags          = IORESOURCE_IRQ,
+	},
 };
-
-static struct mv_pp2_pdata mv_pp2_ge1_pdata = {
+static struct mv_neta_pdata mv_neta_ge1_pdata = {
 	.mtu = 1500,
-	.phy_addr = 0,
-	.flags = MV_PP2_PDATA_F_LINUX_CONNECT,
+	.phy_addr = -1,
 };
-
-static struct platform_device mv_pp2_ge1_plat = {
-	.name = MV_PP2_PORT_NAME,
-	.id = 1,
-	.num_resources = ARRAY_SIZE(mv_pp2_ge1_resources),
-	.resource = mv_pp2_ge1_resources,
-	.dev = {
-		.platform_data = &mv_pp2_ge1_pdata,
-		},
+static struct platform_device mv_neta_ge1_plat = {
+	.name           = MV_NETA_PORT_NAME,
+	.id             = 1,
+	.num_resources  = ARRAY_SIZE(mv_neta_ge1_resources),
+	.resource       = mv_neta_ge1_resources,
+	.dev            = {
+		.platform_data = &mv_neta_ge1_pdata,
+	},
 };
-
-static struct resource mv_pp2_ge2_resources[] = {
+static struct resource mv_neta_ge2_resources[] = {
 	{
-	 .start = IRQ_GLOBAL_PP_PORT2_RXTX,
-	 .end = IRQ_GLOBAL_PP_PORT2_RXTX,
-	 .flags = IORESOURCE_IRQ,
-	 },
+		.start          = IRQ_PRIV_PORT2_TH_RXTX,
+		.end            = IRQ_PRIV_PORT2_TH_RXTX,
+		.flags          = IORESOURCE_IRQ,
+	},
 };
-
-static struct mv_pp2_pdata mv_pp2_ge2_pdata = {
+static struct mv_neta_pdata mv_neta_ge2_pdata = {
 	.mtu = 1500,
 	.phy_addr = -1,
-	.flags = MV_PP2_PDATA_F_LINUX_CONNECT,
 };
-
-static struct platform_device mv_pp2_ge2_plat = {
-	.name = MV_PP2_PORT_NAME,
-	.id = 2,
-	.num_resources = ARRAY_SIZE(mv_pp2_ge2_resources),
-	.resource = mv_pp2_ge2_resources,
-	.dev = {
-		.platform_data = &mv_pp2_ge2_pdata,
-		},
+static struct platform_device mv_neta_ge2_plat = {
+	.name           = MV_NETA_PORT_NAME,
+	.id             = 2,
+	.num_resources  = ARRAY_SIZE(mv_neta_ge2_resources),
+	.resource       = mv_neta_ge2_resources,
+	.dev            = {
+		.platform_data = &mv_neta_ge2_pdata,
+	},
 };
+#endif /* CONFIG_MV_ETH_NETA || CONFIG_MV_ETH_NETA_MODULE */
 
-static struct mv_pp2_pdata mv_pp2_ge3_pdata = {
-	.mtu = 1500,
-	.phy_addr = -1,
-	.flags = MV_PP2_PDATA_F_LINUX_CONNECT,
-};
+static void __init eth_init(void)
+{
+#if defined(CONFIG_MV_ETH_LEGACY)
+	platform_device_register(&mv88fx_eth);
+#endif /* CONFIG_MV_ETH_LEGACY */
 
-static struct resource mv_pp2_ge3_resources[] = {
-	{
-	 .start = IRQ_GLOBAL_PP_PORT7_RXTX,
-	 .end = IRQ_GLOBAL_PP_PORT7_RXTX,
-	 .flags = IORESOURCE_IRQ,
-	 },
-};
+#if defined(CONFIG_MV_ETH_NETA) || defined(CONFIG_MV_ETH_NETA_MODULE)
+	MV_U32 devId;
 
-static struct platform_device mv_pp2_ge3_plat = {
-	.name = MV_PP2_PORT_NAME,
-	.id = 3,
-	.num_resources = ARRAY_SIZE(mv_pp2_ge3_resources),
-	.resource = mv_pp2_ge3_resources,
-	.dev = {
-		.platform_data = &mv_pp2_ge3_pdata,
-		},
-};
-#else
-#error "Ethernet Mode is not defined (should be Legacy or NETA or PPv2)"
-#endif /* Ethernet mode: Legacy or NETA or PPv2 */
+	devId = mvCtrlModelGet();
 
-static void __init eth_init(void)
-{
-	mv_pp2_giga_pdev_register(&mv_pp2_ge0_plat);
-#ifdef CONFIG_MV_INCLUDE_PON
-	mv_pp2_giga_pdev_register(&mv_pp2_ge3_plat);
-#endif
+	if ((mvUnitMapIsMine(ETH0) == MV_TRUE) &&
+	    (mvCtrlPwrClckGet(ETH_GIG_UNIT_ID, 0))) {
+		mv_neta_giga_pdev_register(&mv_neta_ge0_plat);
+	}
+	if ((mvUnitMapIsMine(ETH1) == MV_TRUE) &&
+	    (mvCtrlPwrClckGet(ETH_GIG_UNIT_ID, 1))) {
+		mv_neta_giga_pdev_register(&mv_neta_ge1_plat);
+	}
+	if ((devId != MV_6810_DEV_ID) && (mvUnitMapIsMine(ETH2) == MV_TRUE) &&
+	    (mvCtrlPwrClckGet(ETH_GIG_UNIT_ID, 2))) {
+		mv_neta_giga_pdev_register(&mv_neta_ge2_plat);
+	}
+#endif /* CONFIG_MV_ETH_NETA) || CONFIG_MV_ETH_NETA_MODULE */
 }
-
 #endif /* CONFIG_MV_ETHERNET */
 
-static void a38x_init_eth(void)
+void __init a38x_init_eth(void)
 {
 #ifdef CONFIG_MV_ETHERNET
-	mvSysEthPhyInit();
 	eth_init();
 #endif
 }
diff --git a/arch/arm/mach-armada38x/export.c b/arch/arm/mach-armada38x/export.c
index 85d1855..0a9b105 100644
--- a/arch/arm/mach-armada38x/export.c
+++ b/arch/arm/mach-armada38x/export.c
@@ -32,7 +32,9 @@
  *************************************************************************************************************/
 EXPORT_SYMBOL(mv_early_printk);
 EXPORT_SYMBOL(mvCtrlPwrClckGet);
+EXPORT_SYMBOL(mvCtrlPwrClckSet);
 EXPORT_SYMBOL(mvCtrlModelRevGet);
+EXPORT_SYMBOL(mvCtrlAddrWinInfoGet);
 EXPORT_SYMBOL(mvCtrlModelGet);
 EXPORT_SYMBOL(mvOsIoUncachedMalloc);
 EXPORT_SYMBOL(mvOsIoUncachedFree);
@@ -54,6 +56,7 @@ EXPORT_SYMBOL(mvBoardSysClkGet);
 EXPORT_SYMBOL(mvBoardMacSpeedGet);
 EXPORT_SYMBOL(mvWinOverlapTest);
 EXPORT_SYMBOL(mvCtrlAddrWinMapBuild);
+EXPORT_SYMBOL(mvLog2);
 
 #ifdef CONFIG_MV_INCLUDE_SPI
 #include "spi/mvSpiCmnd.h"
@@ -198,12 +201,19 @@ EXPORT_SYMBOL(TRC_START);
 EXPORT_SYMBOL(TRC_RELEASE);
 #endif
 
-#ifdef CONFIG_MV_ETH_NFP_MODULE
-#ifdef CONFIG_MV_ETH_BM
-#include "bm/mvBm.h"
-EXPORT_SYMBOL(mvBmVirtBase);
-#endif
 #include "mvList.h"
 EXPORT_SYMBOL(mvListCreate);
 EXPORT_SYMBOL(mvListDestroy);
-#endif
+
+#include "mvStack.h"
+EXPORT_SYMBOL(mvStackCreate);
+EXPORT_SYMBOL(mvStackDelete);
+EXPORT_SYMBOL(mvStackStatus);
+
+#include "eth-phy/mvEthPhy.h"
+EXPORT_SYMBOL(mvEthPhyRestartAN);
+EXPORT_SYMBOL(mvEthPhyDisableAN);
+EXPORT_SYMBOL(mvEthPhyRegRead);
+EXPORT_SYMBOL(mvEthPhyRegWrite);
+EXPORT_SYMBOL(mvEthPhyAdvertiseSet);
+EXPORT_SYMBOL(mvEthPhyAdvertiseGet);
diff --git a/arch/arm/mach-armada38x/include/mach/armada38x.h b/arch/arm/mach-armada38x/include/mach/armada38x.h
index ab86f0b..d835546 100644
--- a/arch/arm/mach-armada38x/include/mach/armada38x.h
+++ b/arch/arm/mach-armada38x/include/mach/armada38x.h
@@ -67,9 +67,8 @@
 #define XOR0_HIGH_PHYS_BASE		(INTER_REGS_PHYS_BASE | 0x60A00)
 #define XOR1_HIGH_PHYS_BASE		(INTER_REGS_PHYS_BASE | 0x60B00)
 
-#define PP2_CPU0_PHYS_BASE		0xF4500000
-#define PP2_CPU1_PHYS_BASE		0xF4510000
-#define PP2_SIZE			_64K
+#define ETH_BM_PHYS_BASE		0xF4500000
+#define ETH_BM_SIZE			_1M
 
 #define BOOTROM_PHYS_BASE		0xFFF00000
 #define BOOTROM_SIZE			_1M
@@ -107,8 +106,6 @@
 #define DEVICE_CS3_VIRT_BASE		0xFEA00000
 
 #define CRYPT_ENG_VIRT_BASE(chan)	((chan == 0) ? 0xFEB00000 : 0xFEB10000)
-#define PP2_CPU0_VIRT_BASE		0xFEC00000
-#define PP2_CPU1_VIRT_BASE		0xFEC10000
 #define BOOTROM_VIRT_BASE		0xFED00000
 #define LEGACY_NAND_VIRT_BASE		0xFEF00000
 
diff --git a/arch/arm/mach-armada38x/include/mach/irqs.h b/arch/arm/mach-armada38x/include/mach/irqs.h
index 2cea272..275f8a4 100644
--- a/arch/arm/mach-armada38x/include/mach/irqs.h
+++ b/arch/arm/mach-armada38x/include/mach/irqs.h
@@ -149,10 +149,12 @@
 #define IRQ_PRIV_SOC_ERROR_SUMMARY		(IRQ_START_PRIV_SOC_PPI + 4)
 #define IRQ_PRIV_SOC_PRIV_TIMER0		(IRQ_START_PRIV_SOC_PPI + 5)
 #define IRQ_PRIV_SOC_PRIV_TIMER1		(IRQ_START_PRIV_SOC_PPI + 6)
-#define IRQ_PRIV_PP_PORT0_RXTX			(IRQ_START_PRIV_SOC_PPI + 9)
-#define IRQ_PRIV_PP_PORT1_RXTX			(IRQ_START_PRIV_SOC_PPI + 11)
-#define IRQ_PRIV_PP_PORT2_RXTX			(IRQ_START_PRIV_SOC_PPI + 13)
-#define IRQ_PRIV_PP_PORT7_RXTX			(IRQ_START_PRIV_SOC_PPI + 15)
+#define IRQ_PRIV_PORT0_TH_RXTX			(IRQ_START_PRIV_SOC_PPI + 8)
+#define IRQ_PRIV_PORT0_RXTX			(IRQ_START_PRIV_SOC_PPI + 9)
+#define IRQ_PRIV_PORT1_TH_RXTX			(IRQ_START_PRIV_SOC_PPI + 10)
+#define IRQ_PRIV_PORT1_RXTX			(IRQ_START_PRIV_SOC_PPI + 11)
+#define IRQ_PRIV_PORT2_TH_RXTX			(IRQ_START_PRIV_SOC_PPI + 12)
+#define IRQ_PRIV_PORT2_RXTX			(IRQ_START_PRIV_SOC_PPI + 13)
 #define IRQ_PRIV_GPIO_0_7			(IRQ_START_PRIV_SOC_PPI + 16)
 #define IRQ_PRIV_GPIO_8_15			(IRQ_START_PRIV_SOC_PPI + 17)
 #define IRQ_PRIV_GPIO_16_23			(IRQ_START_PRIV_SOC_PPI + 18)
@@ -161,7 +163,6 @@
 #define IRQ_PRIV_GPIO_40_47			(IRQ_START_PRIV_SOC_PPI + 21)
 #define IRQ_PRIV_GPIO_48_55			(IRQ_START_PRIV_SOC_PPI + 22)
 #define IRQ_PRIV_GPIO_56_63			(IRQ_START_PRIV_SOC_PPI + 23)
-#define IRQ_PRIV_GPIO_64_66			(IRQ_START_PRIV_SOC_PPI + 24)
 
 /*
  * Private GPIO interrupts
@@ -233,4 +234,9 @@
 #define NR_IRQS			(IRQ_START_PRIV_ERROR + NR_IRQS_PRIV_ERROR)
 #define NR_GPIO_IRQS		NR_IRQS_GLOBAL_GPIO
 
+/*
+ * IRQ HAL remapping
+ */
+#define NET_TH_RXTX_IRQ_NUM(x)		(IRQ_PRIV_PORT0_TH_RXTX + ((x) * 2))
+
 #endif /* __ASM_ARCH_IRQS_H */
diff --git a/arch/arm/mach-armada38x/mv_hal_if/mvSysEthPhy.c b/arch/arm/mach-armada38x/mv_hal_if/mvSysEthPhy.c
index c1c7408..4348542 100644
--- a/arch/arm/mach-armada38x/mv_hal_if/mvSysEthPhy.c
+++ b/arch/arm/mach-armada38x/mv_hal_if/mvSysEthPhy.c
@@ -73,8 +73,8 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "eth/gbe/mvEthRegs.h"
 #elif defined(CONFIG_MV_ETH_NETA)
 #include "neta/gbe/mvEthRegs.h"
-#elif defined(CONFIG_MV_ETH_PP2)
-#include "pp2/gbe/mvPp2GbeRegs.h"
+#else
+#error "Ethernet Mode is not defined (should be Legacy or NETA)"
 #endif
 
 /*******************************************************************************
diff --git a/arch/arm/mach-armada38x/sysmap.c b/arch/arm/mach-armada38x/sysmap.c
index c3a1990..98dc709 100644
--- a/arch/arm/mach-armada38x/sysmap.c
+++ b/arch/arm/mach-armada38x/sysmap.c
@@ -24,10 +24,6 @@
 struct map_desc MEM_TABLE[] = {
 	/* no use for pex mem remap */
 	{ INTER_REGS_VIRT_BASE,		__phys_to_pfn(INTER_REGS_PHYS_BASE),	SZ_1M,		MT_DEVICE},
-	{ PP2_CPU0_VIRT_BASE,		__phys_to_pfn(PP2_CPU0_PHYS_BASE),	PP2_SIZE,	MT_DEVICE},
-#ifdef CONFIG_SMP
-	{ PP2_CPU1_VIRT_BASE,		__phys_to_pfn(PP2_CPU1_PHYS_BASE),	PP2_SIZE,	MT_DEVICE},
-#endif
 	{ CRYPT_ENG_VIRT_BASE(0),	__phys_to_pfn(CRYPT_ENG_PHYS_BASE(0)),	CRYPT_ENG_SIZE,	MT_DEVICE},
 	{ IOCC_WA_WIN0_VIRT_BASE,	__phys_to_pfn(IOCC_WA_WIN0_PHYS_BASE),	SZ_64K,		MT_DEVICE},
 };
@@ -60,12 +56,7 @@ MV_CPU_DEC_WIN SYSMAP_A38X_68XX[] = {
 	{{DEVICE_BOOTCS_PHYS_BASE,	0,	DEVICE_BOOTCS_SIZE	},	10,		 EN}, /* DEV_BOOCS */
 	{{USB3_REGS_PHYS_BASE,		0,	USB3_REGS_SIZE		},	11,		 EN}, /* USB3 */
 	{{CRYPT_ENG_PHYS_BASE(0),	0,	CRYPT_ENG_SIZE		},	12,		 EN}, /* CRYPT_ENG */
-	{{PP2_CPU0_PHYS_BASE,		0,	PP2_SIZE		},	13,		 EN}, /* PP2 */
-#ifdef CONFIG_SMP
-	{{PP2_CPU1_PHYS_BASE,		0,	PP2_SIZE		},	15,		 EN}, /* PP2 */
-#else
-	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,	DIS}, /* PP2 */
-#endif
+	{{ETH_BM_PHYS_BASE,		0,	ETH_BM_SIZE		},	13,		 EN}, /* ETH_BM */
 	{{TBL_TERM,		 TBL_TERM,	TBL_TERM		},	TBL_TERM,  TBL_TERM}
 };
 
diff --git a/arch/arm/plat-armada/Kconfig b/arch/arm/plat-armada/Kconfig
index 95038e9..1a8107f 100644
--- a/arch/arm/plat-armada/Kconfig
+++ b/arch/arm/plat-armada/Kconfig
@@ -488,7 +488,7 @@ endif
 
 config MV_ETH_NETA
 	tristate "NETA driver"
-	depends on ARCH_FEROCEON_KW2 || ARCH_ARMADA_XP || ARCH_ARMADA370
+	depends on ARCH_FEROCEON_KW2 || ARCH_ARMADA_XP || ARCH_ARMADA370 || ARCH_ARMADA38X
 	default y
 	help
 	  Use NETA network driver
@@ -501,7 +501,7 @@ endif
 
 config MV_ETH_PP2
 	tristate "PPv2 driver "
-	depends on ARCH_AVANTA_LP || ARCH_ARMADA375 || ARMADA_38X
+	depends on ARCH_AVANTA_LP
 	default y
 	select MV_ETH_PP2_CLS2
 	select MV_ETH_PP2_CLS3
-- 
1.7.5.4

