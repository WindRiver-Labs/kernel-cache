From b23612fb91f148b2dccf315815719cda8b3cf48b Mon Sep 17 00:00:00 2001
From: Ernest Villion <ernestv@marvell.com>
Date: Thu, 6 Mar 2014 16:47:07 +0200
Subject: [PATCH 1443/1825] pp3: Adding pp3 fw load image from file and sysfs

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit b08230a3b8b5ad9a263ac7d1a68d1066872ed86b

Change-Id: I0522ecbda1592a01d2185fbd554f3a10e6451dfd
Signed-off-by: Ernest Villion <ernestv@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/6223
Reviewed-by: Yelena Krivosheev <yelena@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/net/ethernet/marvell/pp3/Makefile         |    1 +
 drivers/net/ethernet/marvell/pp3/fw/mv_fw.c       |  129 ++++++++++++++++++
 drivers/net/ethernet/marvell/pp3/fw/mv_fw.h       |   77 +++++++++++
 drivers/net/ethernet/marvell/pp3/fw/mv_fw_sysfs.c |  150 +++++++++++++++++++++
 4 files changed, 357 insertions(+), 0 deletions(-)
 create mode 100644 drivers/net/ethernet/marvell/pp3/fw/mv_fw.c
 create mode 100644 drivers/net/ethernet/marvell/pp3/fw/mv_fw.h
 create mode 100644 drivers/net/ethernet/marvell/pp3/fw/mv_fw_sysfs.c

diff --git a/drivers/net/ethernet/marvell/pp3/Makefile b/drivers/net/ethernet/marvell/pp3/Makefile
index 99df9fe..07c353f 100644
--- a/drivers/net/ethernet/marvell/pp3/Makefile
+++ b/drivers/net/ethernet/marvell/pp3/Makefile
@@ -9,3 +9,4 @@ ccflags-y       += -Idrivers/net/ethernet/marvell/pp3
 mv_pp3-objs := net_dev/mv_netdev.o hmac/mv_hmac.o emac/mv_emac.o
 mv_pp3-objs += emac/mv_emac_sysfs.o hmac/mv_hmac_sysfs.o net_dev/mv_dev_sysfs.o
 mv_pp3-objs += gmac/mv_gmac.o fw/mv_channel_if.o common/mv_stack.o
+mv_pp3-objs += fw/mv_fw.o fw/mv_fw_sysfs.o
diff --git a/drivers/net/ethernet/marvell/pp3/fw/mv_fw.c b/drivers/net/ethernet/marvell/pp3/fw/mv_fw.c
new file mode 100644
index 0000000..945d192
--- /dev/null
+++ b/drivers/net/ethernet/marvell/pp3/fw/mv_fw.c
@@ -0,0 +1,129 @@
+
+/*******************************************************************************
+Copyright (C) Marvell International Ltd. and its affiliates
+
+This software file (the "File") is owned and distributed by Marvell
+International Ltd. and/or its affiliates ("Marvell") under the following
+alternative licensing terms.  Once you have made an election to distribute the
+File under one of the following license alternatives, please (i) delete this
+introductory statement regarding license alternatives, (ii) delete the two
+license alternatives that you have not elected to use and (iii) preserve the
+Marvell copyright notice above.
+
+********************************************************************************
+Marvell Commercial License Option
+
+If you received this File from Marvell and you have entered into a commercial
+license agreement (a "Commercial License") with Marvell, the File is licensed
+to you under the terms of the applicable Commercial License.
+
+********************************************************************************
+Marvell GPL License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File in accordance with the terms and conditions of the General
+Public License Version 2, June 1991 (the "GPL License"), a copy of which is
+available along with the File in the license.txt file or by writing to the Free
+Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 or
+on the worldwide web at http://www.gnu.org/licenses/gpl.txt.
+
+THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE IMPLIED
+WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY
+DISCLAIMED.  The GPL License provides additional details about this warranty
+disclaimer.
+********************************************************************************
+Marvell BSD License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File under the following licensing terms.
+Redistribution and use in source and binary forms, with or without modification,
+are permitted provided that the following conditions are met:
+
+    *   Redistributions of source code must retain the above copyright notice,
+	this list of conditions and the following disclaimer.
+
+    *   Redistributions in binary form must reproduce the above copyright
+	notice, this list of conditions and the following disclaimer in the
+	documentation and/or other materials provided with the distribution.
+
+    *   Neither the name of Marvell nor the names of its contributors may be
+	used to endorse or promote products derived from this software without
+	specific prior written permission.
+
+THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
+ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
+ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
+ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+
+*******************************************************************************/
+#include <linux/module.h>
+#include <linux/netdevice.h>
+#include <linux/kernel.h>
+#include <linux/init.h>
+#include <linux/module.h>
+#include <linux/syscalls.h>
+#include <linux/fcntl.h>
+#include <linux/uaccess.h>
+
+#include "mv_fw.h"
+
+#define MV_PP3_FW_IMAGE_SIZE (128*1024)
+
+int mv_pp3_fw_download(char *path)
+{
+	int fd;
+	char *buf = NULL;
+	int size = 0;
+	int tmp = 0;
+	mm_segment_t old_fs = get_fs();
+
+	pr_info("DOWNLOAD PATH: %s\n", path);
+
+	buf = kzalloc(MV_PP3_FW_IMAGE_SIZE, GFP_KERNEL);
+	if (!buf) {
+		pr_err("FW Image Allocation Failed in <%s>\n", __func__);
+		return -ENOMEM;
+	}
+	pr_info("ALLOCATED: %d\n", MV_PP3_FW_IMAGE_SIZE);
+
+	set_fs(KERNEL_DS);
+
+	fd = sys_open(path, O_RDONLY, 0);
+	if (fd >= 0) {
+		while ((tmp =
+			sys_read(fd, &buf[size],
+				 MV_PP3_FW_IMAGE_SIZE - size)) > 0) {
+			size += tmp;
+			pr_info("Read %d bytes\n", tmp);
+		}
+		sys_close(fd);
+		mv_fw_write(buf, size);
+	} else {
+		pr_err("Failed to open file %s\n", path);
+	}
+	kfree(buf);
+	set_fs(old_fs);
+
+	pr_info("FW DOWNLOADED\n");
+
+	return 0;
+}
+
+int mv_fw_write(char *data, int size)
+{
+	int i;
+
+	/*TODO: probably verify checksum, version etc. */
+	pr_info("size: %d [showing 0..63]\n", size);
+
+	for (i = 0; i < ((size < 64) ? size : 64); i++)
+		pr_cont("%02X", data[i]);
+
+	return 0;
+}
diff --git a/drivers/net/ethernet/marvell/pp3/fw/mv_fw.h b/drivers/net/ethernet/marvell/pp3/fw/mv_fw.h
new file mode 100644
index 0000000..de296d1
--- /dev/null
+++ b/drivers/net/ethernet/marvell/pp3/fw/mv_fw.h
@@ -0,0 +1,77 @@
+
+/*******************************************************************************
+Copyright (C) Marvell International Ltd. and its affiliates
+
+This software file (the "File") is owned and distributed by Marvell
+International Ltd. and/or its affiliates ("Marvell") under the following
+alternative licensing terms.  Once you have made an election to distribute the
+File under one of the following license alternatives, please (i) delete this
+introductory statement regarding license alternatives, (ii) delete the two
+license alternatives that you have not elected to use and (iii) preserve the
+Marvell copyright notice above.
+
+********************************************************************************
+Marvell Commercial License Option
+
+If you received this File from Marvell and you have entered into a commercial
+license agreement (a "Commercial License") with Marvell, the File is licensed
+to you under the terms of the applicable Commercial License.
+
+********************************************************************************
+Marvell GPL License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File in accordance with the terms and conditions of the General
+Public License Version 2, June 1991 (the "GPL License"), a copy of which is
+available along with the File in the license.txt file or by writing to the Free
+Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 or
+on the worldwide web at http://www.gnu.org/licenses/gpl.txt.
+
+THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE IMPLIED
+WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY
+DISCLAIMED.  The GPL License provides additional details about this warranty
+disclaimer.
+********************************************************************************
+Marvell BSD License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File under the following licensing terms.
+Redistribution and use in source and binary forms, with or without modification,
+are permitted provided that the following conditions are met:
+
+    *   Redistributions of source code must retain the above copyright notice,
+	this list of conditions and the following disclaimer.
+
+    *   Redistributions in binary form must reproduce the above copyright
+	notice, this list of conditions and the following disclaimer in the
+	documentation and/or other materials provided with the distribution.
+
+    *   Neither the name of Marvell nor the names of its contributors may be
+	used to endorse or promote products derived from this software without
+	specific prior written permission.
+
+THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
+ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
+ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
+ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+
+*******************************************************************************/
+
+#ifndef __mvfw_h__
+#define __mvfw_h__
+
+int mv_pp3_fw_download(char *path);
+
+int mv_fw_write(char *data, int size);
+
+/* SYSFS*/
+int mv_pp3_fw_sysfs_init(struct kobject *fw_kobj);
+int mv_pp3_fw_sysfs_exit(struct kobject *fw_kobj);
+
+#endif /* __mvfw_h__ */
diff --git a/drivers/net/ethernet/marvell/pp3/fw/mv_fw_sysfs.c b/drivers/net/ethernet/marvell/pp3/fw/mv_fw_sysfs.c
new file mode 100644
index 0000000..e5d6fdc
--- /dev/null
+++ b/drivers/net/ethernet/marvell/pp3/fw/mv_fw_sysfs.c
@@ -0,0 +1,150 @@
+
+/*******************************************************************************
+Copyright (C) Marvell International Ltd. and its affiliates
+
+This software file (the "File") is owned and distributed by Marvell
+International Ltd. and/or its affiliates ("Marvell") under the following
+alternative licensing terms.  Once you have made an election to distribute the
+File under one of the following license alternatives, please (i) delete this
+introductory statement regarding license alternatives, (ii) delete the two
+license alternatives that you have not elected to use and (iii) preserve the
+Marvell copyright notice above.
+
+********************************************************************************
+Marvell Commercial License Option
+
+If you received this File from Marvell and you have entered into a commercial
+license agreement (a "Commercial License") with Marvell, the File is licensed
+to you under the terms of the applicable Commercial License.
+
+********************************************************************************
+Marvell GPL License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File in accordance with the terms and conditions of the General
+Public License Version 2, June 1991 (the "GPL License"), a copy of which is
+available along with the File in the license.txt file or by writing to the Free
+Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 or
+on the worldwide web at http://www.gnu.org/licenses/gpl.txt.
+
+THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE IMPLIED
+WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY
+DISCLAIMED.  The GPL License provides additional details about this warranty
+disclaimer.
+********************************************************************************
+Marvell BSD License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File under the following licensing terms.
+Redistribution and use in source and binary forms, with or without modification,
+are permitted provided that the following conditions are met:
+
+    *   Redistributions of source code must retain the above copyright notice,
+	this list of conditions and the following disclaimer.
+
+    *   Redistributions in binary form must reproduce the above copyright
+	notice, this list of conditions and the following disclaimer in the
+	documentation and/or other materials provided with the distribution.
+
+    *   Neither the name of Marvell nor the names of its contributors may be
+	used to endorse or promote products derived from this software without
+	specific prior written permission.
+
+THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
+ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
+ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
+ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+
+*******************************************************************************/
+#include <linux/module.h>
+#include <linux/netdevice.h>
+#include "mv_fw.h"
+
+static ssize_t mv_fw_help(char *b)
+{
+	int o = 0;
+
+	o += scnprintf(b + o, PAGE_SIZE - o,
+		       "echo [path]         > fw_dnld     - Download FW\n");
+
+	return o;
+}
+
+static ssize_t mv_fw_show(struct device *dev,
+			  struct device_attribute *attr, char *buf)
+{
+	/* TODO: const char      *name = attr->attr.name; */
+	int off = 0;
+
+	if (!capable(CAP_NET_ADMIN))
+		return -EPERM;
+
+	off = mv_fw_help(buf);
+
+	return off;
+}
+
+static ssize_t mv_fw_store(struct device *dev,
+			   struct device_attribute *attr, const char *buf,
+			   size_t len)
+{
+	const char *name = attr->attr.name;
+	int err;
+	char str[128] = "/0";
+
+	if (!capable(CAP_NET_ADMIN))
+		return -EPERM;
+
+	/* Read port and value */
+	err = 0;
+	sscanf(buf, "%s", str);
+
+	if (!strcmp(name, "fw_dnld")) {
+		mv_pp3_fw_download(str);
+	} else {
+		err = 1;
+		pr_err("%s: illegal operation <%s>\n", __func__,
+		       attr->attr.name);
+	}
+
+	return err ? -EINVAL : len;
+}
+
+static DEVICE_ATTR(help, S_IRUSR, mv_fw_show, NULL);
+static DEVICE_ATTR(fw_dnld, S_IWUSR, NULL, mv_fw_store);
+
+static struct attribute *mv_fw_attrs[] = {
+	&dev_attr_help.attr,
+	&dev_attr_fw_dnld.attr,
+	NULL
+};
+
+static struct attribute_group mv_fw_group = {
+	.name = "fw",
+	.attrs = mv_fw_attrs,
+};
+
+int mv_pp3_fw_sysfs_init(struct kobject *neta_kobj)
+{
+	int err;
+	err = sysfs_create_group(neta_kobj, &mv_fw_group);
+	if (err) {
+		pr_info("sysfs group failed %d\n", err);
+		return err;
+	}
+
+	pr_info("PP3 FW SYSFS INITALIZED\n");
+	return err;
+}
+
+int mv_pp3_fw_sysfs_exit(struct kobject *neta_kobj)
+{
+	sysfs_remove_group(neta_kobj, &mv_fw_group);
+	return 0;
+}
-- 
1.7.5.4

