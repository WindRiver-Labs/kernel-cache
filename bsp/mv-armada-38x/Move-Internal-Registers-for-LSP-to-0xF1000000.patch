From 0e018fa9ed4c3b702179eeed82abd40f413b29e3 Mon Sep 17 00:00:00 2001
From: Shadi Ammouri <shadi@marvell.com>
Date: Wed, 21 Nov 2012 16:44:55 +0200
Subject: [PATCH 0371/1825] Move Internal Registers for LSP to 0xF1000000

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 1a414647764dcdbe4901ac80a8a380dca8afd8d9

This is a preparation for changing the IO windows mapping for the LSP

Change-Id: I34be24c9fe27822f3dcfab9229b4d71bd6f637c9

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/boot/compressed/head.S                |   14 ++++++++++++++
 arch/arm/mach-armadaxp/include/mach/armadaxp.h |   20 ++------------------
 arch/arm/mm/proc-sheeva_pj4bv7.S               |   13 ++++++++++---
 3 files changed, 26 insertions(+), 21 deletions(-)

diff --git a/arch/arm/boot/compressed/head.S b/arch/arm/boot/compressed/head.S
index d2745b3..6d87813 100644
--- a/arch/arm/boot/compressed/head.S
+++ b/arch/arm/boot/compressed/head.S
@@ -9,6 +9,9 @@
  * published by the Free Software Foundation.
  */
 #include <linux/linkage.h>
+#ifdef CONFIG_ARCH_ARMADA_XP
+#include <mach/armadaxp.h>
+#endif
 
 	.arch	armv7-a
 /*
@@ -120,6 +123,17 @@
 		.align
 		.arm				@ Always enter in ARM state
 start:
+#ifdef CONFIG_ARCH_ARMADA_XP
+		/* Update Internal Regs offset in case UBoot is configured
+		** to use a different base address.
+		*/
+		mrc p15, 4, r0, c15, c0, 0	@ Get the internal registers base address
+		lsl r0, r0, #13			@ the address is R-shifted, need to recover it
+		ldr r5, =0x20080
+		add r0, r0, r5
+		ldr r6, =INTER_REGS_PHYS_BASE
+		str r6, [r0]
+#endif
 		.type	start,#function
 		.rept	7
 		mov	r0, r0
diff --git a/arch/arm/mach-armadaxp/include/mach/armadaxp.h b/arch/arm/mach-armadaxp/include/mach/armadaxp.h
index fed55a9..d0b3682 100644
--- a/arch/arm/mach-armadaxp/include/mach/armadaxp.h
+++ b/arch/arm/mach-armadaxp/include/mach/armadaxp.h
@@ -100,15 +100,7 @@
 #define SPI_CS0_VIRT_BASE		0xFAA00000
 #define SPI_CS0_SIZE			_16M
 
-#ifdef CONFIG_MACH_ARMADA_XP_FPGA
- #define INTER_REGS_PHYS_BASE		0xF1000000
- /* Make sure that no other machines are compiled in */
- #if defined (CONFIG_MACH_ARMADA_XP_DB) || defined (CONFIG_MACH_ARMADA_XP_RDSRV)
- #error	"Conflicting Board Configuration!!"
- #endif
-#else
- #define INTER_REGS_PHYS_BASE		0xD0000000
-#endif
+#define INTER_REGS_PHYS_BASE		0xF1000000
 
 /*
  * Change INTER_REGS_BASE from 0xFBB00000 to 0xFBC00000 is mainly
@@ -210,15 +202,7 @@
 #define SPI_CS0_VIRT_BASE		0xFAB00000
 #define SPI_CS0_SIZE			_16M
 
-#ifdef CONFIG_MACH_ARMADA_XP_FPGA
- #define INTER_REGS_PHYS_BASE		0xF1000000
- /* Make sure that no other machines are compiled in */
- #if defined (CONFIG_MACH_ARMADA_XP_DB) || defined (CONFIG_MACH_ARMADA_XP_RDSRV)
- #error	"Conflicting Board Configuration!!"
- #endif
-#else
- #define INTER_REGS_PHYS_BASE		0xD0000000
-#endif
+#define INTER_REGS_PHYS_BASE		0xF1000000
 #define INTER_REGS_BASE			0xFBB00000
 
 #define PEX0_IO_PHYS_BASE		0xF1100000
diff --git a/arch/arm/mm/proc-sheeva_pj4bv7.S b/arch/arm/mm/proc-sheeva_pj4bv7.S
index 0b49cfb..16cb20c 100644
--- a/arch/arm/mm/proc-sheeva_pj4bv7.S
+++ b/arch/arm/mm/proc-sheeva_pj4bv7.S
@@ -386,18 +386,25 @@ defined(CONFIG_SMP)
 #endif
 #endif
 
+
 #if defined(CONFIG_ARMADA_XP_REV_A0) || defined(CONFIG_ARMADA_XP_REV_B0)
 
 #ifdef CONFIG_ARMADA_XP_A0_WITH_B0
 /* Read and save SoC revision */
-	ldr r0, =0xd0018220		/* POWER_MNG_CTRL_REG */
+	ldr r0, =INTER_REGS_PHYS_BASE
+	ldr r6, =0x18220		/* POWER_MNG_CTRL_REG */
+	add r0, r0, r6
 	ldr r5, [r0]
 	orr r0, r5, #(1 << 5)	/* Enable PEX0 Clk */
-	ldr r0, =0xd0040008
+	ldr r0, =INTER_REGS_PHYS_BASE
+	ldr r6, =0x40008
+	add r0, r0, r6
 	ldr r0, [r0]
 	and r0, r0, #0x3
 	str r0, soc_revision
-	ldr r0, =0xd0018220		/* POWER_MNG_CTRL_REG */
+	ldr r0, =INTER_REGS_PHYS_BASE
+	ldr r6, =0x18220		/* POWER_MNG_CTRL_REG */
+	add r0, r0, r6
 	str r5, [r0]
 #endif
 
-- 
1.7.5.4

