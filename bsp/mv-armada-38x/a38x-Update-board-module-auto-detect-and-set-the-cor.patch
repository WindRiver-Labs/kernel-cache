From ba2bab60498c264eb9f5e19b1e6edd8e5953f2a6 Mon Sep 17 00:00:00 2001
From: Eli Nidam <elini@marvell.com>
Date: Tue, 22 Oct 2013 18:27:18 +0200
Subject: [PATCH 1119/1825] a38x: Update board module auto detect and set the
 correct MPP's

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 327d616496865c790cb38c6b6847b2534a7f83c3

	1. Set MPP for each module
	2. Code clean up for Avanta module style

Change-Id: I0395814fb0af8035f6f80c4a7659f78eacf04ddb
Signed-off-by: Eli Nidam <elini@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3823
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Tested-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/boardEnv/mvBoardEnvLib.c     |   70 +++++++------
 .../armada_38x_family/boardEnv/mvBoardEnvLib.h     |   34 +++++--
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.h       |   22 ++--
 .../armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h      |  110 --------------------
 4 files changed, 76 insertions(+), 160 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
index 1366a62..04dd129 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
@@ -789,34 +789,6 @@ MV_VOID mvBoardMppSet(MV_U32 mppGroupNum, MV_U32 mppValue)
 	board->pBoardMppConfigValue->mppGroup[mppGroupNum] = mppValue;
 }
 
-/*******************************************************************************
-* mvBoardMppTypeSet - Set board dependent MPP Group Type value
-*
-* DESCRIPTION:
-*	This function updates board dependend MPP Group Type value.
-*
-* INPUT:
-*       mppGroupNum - MPP group number.
-*	groupType - new MPP Group type. derrive MPP Value using groupType
-*
-* OUTPUT:
-*       None.
-*
-* RETURN:
-*       -None
-*
-*******************************************************************************/
-MV_VOID mvBoardMppTypeSet(MV_U32 mppGroupNum, MV_U32 groupType)
-{
-	MV_U32 mppVal;
-	MV_U32 mppGroups[MV_BOARD_MAX_MPP_GROUPS][MV_BOARD_MPP_GROUPS_MAX_TYPES] = MPP_GROUP_TYPES;
-
-	mppVal = mppGroups[mppGroupNum][groupType];
-	mvBoardMppSet(mppGroupNum,mppVal);
-
-	/* add Group types update here (if needed for later usage),
-	 * and add mvBoardMppTypeGet to detect which type is in use currently */
-}
 
 /*******************************************************************************
 * mvBoardInfoUpdate - Update Board information structures according to auto-detection.
@@ -884,6 +856,31 @@ MV_BOOL mvBoardIsModuleConnected(MV_U32 ModuleID)
 		return MV_TRUE;
 	return MV_FALSE;
 }
+/*******************************************************************************
+* mvModuleMppUpdate
+*
+* DESCRIPTION:
+*
+* INPUT:
+*	num of grup.
+*	pointer to arreay MV_BOARD_MPP_MODULE
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*	None.
+*
+*******************************************************************************/
+void mvModuleMppUpdate(MV_U32 numGroup, struct _mvBoardMppModule *pMpp)
+{
+	int i;
+	if (pMpp == NULL)
+		return;
+	for (i = 0; i < numGroup; i++) {
+		mvBoardMppSet(pMpp->group, pMpp->mppValue);
+		pMpp++;
+	}
+}
 
 /*******************************************************************************
 * mvBoardMppIdUpdate - Update MPP ID's according to modules auto-detection.
@@ -905,22 +902,35 @@ MV_BOOL mvBoardIsModuleConnected(MV_U32 ModuleID)
 *******************************************************************************/
 MV_VOID mvBoardMppIdUpdate(MV_VOID)
 {
-	/*
+	struct _mvBoardMppModule miiModule[3] = MPP_MII_MODULE;
+	struct _mvBoardMppModule norModule[6] = MPP_NOR_MODULE;
+	struct _mvBoardMppModule nandModule[6] = MPP_NAND_MODULE;
+	struct _mvBoardMppModule sdioModule[4] = MPP_SDIO_MODULE;
+	struct _mvBoardMppModule tdmModule[2] = MPP_TDM_MODULE;
+	struct _mvBoardMppModule i2sModule = MPP_I2S_MODULE;
+	struct _mvBoardMppModule spdifModule = MPP_SPDIF_MODULE;
+
 	if (mvBoardIsModuleConnected(MV_CONFIG_MII)) {
+		mvModuleMppUpdate(3, miiModule);
 	}
 	if (mvBoardIsModuleConnected(MV_CONFIG_NOR)) {
+		mvModuleMppUpdate(6, norModule);
 	}
 	if (mvBoardIsModuleConnected(MV_CONFIG_NAND)) {
+		mvModuleMppUpdate(6, nandModule);
 	}
 	if (mvBoardIsModuleConnected(MV_CONFIG_SDIO)) {
+		mvModuleMppUpdate(4, sdioModule);
 	}
 	if (mvBoardIsModuleConnected(MV_CONFIG_SLIC_TDM_DEVICE)) {
+		mvModuleMppUpdate(2, tdmModule);
 	}
 	if (mvBoardIsModuleConnected(MV_CONFIG_I2S_DEVICE)) {
+		mvModuleMppUpdate(1, &i2sModule);
 	}
 	if (mvBoardIsModuleConnected(MV_CONFIG_SPDIF_DEVICE)) {
+		mvModuleMppUpdate(1, &spdifModule);
 	}
-*/
 }
 
 /*******************************************************************************
diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
index df0519e4..f543230 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
@@ -363,19 +363,36 @@ typedef struct _boardInfo {
 
 /* {{MV_CONFIG_TYPE_ID ConfigID, twsi-ID,  Offset, ID,  isActiveForBoard[]}} */
 #define MV_BOARD_CONFIG_INFO { \
-{ MV_CONFIG_SGMII,				0x2,	0,	 0xD,	{ 0, 1, 0} }, \
-{ MV_CONFIG_MII,				0x1,	0,	 0x4,	{ 0, 1, 0} }, \
+{ MV_CONFIG_SGMII,		0x2,	0,	 0xD,	{ 0, 1, 0} }, \
+{ MV_CONFIG_MII,		0x1,	0,	 0x4,	{ 0, 1, 0} }, \
 { MV_CONFIG_SLIC_TDM_DEVICE,	0x0,	0,	 0x1,	{ 0, 1, 0} }, \
-{ MV_CONFIG_I2S_DEVICE,			0x1,	0,	 0x3,	{ 0, 1, 0} }, \
-{ MV_CONFIG_SPDIF_DEVICE,		0x1,	0,	 0x2,	{ 0, 1, 0} }, \
+{ MV_CONFIG_I2S_DEVICE,		0x1,	0,	 0x3,	{ 0, 1, 0} }, \
+{ MV_CONFIG_SPDIF_DEVICE,	0x1,	0,	 0x2,	{ 0, 1, 0} }, \
 { MV_CONFIG_SERDES_PEX_LAN1,	0x3,	0,	 0xC,	{ 0, 1, 0} }, \
 { MV_CONFIG_SERDES_PEX_LAN2,	0x3,	0,	 0xD,	{ 0, 1, 0} }, \
-{ MV_CONFIG_NOR,				0x4,	0,	 0xF,	{ 0, 1, 0} }, \
-{ MV_CONFIG_NAND,				0x4,	0,	 0x1,	{ 0, 1, 0} }, \
-{ MV_CONFIG_SDIO,				0x4,	0,	 0x2,	{ 0, 1, 0} }, \
-{ MV_CONFIG_GIGA,				0x27,	0,	 0xE,	{ 0, 1, 0} }, \
+{ MV_CONFIG_NOR,		0x4,	0,	 0xF,	{ 0, 1, 0} }, \
+{ MV_CONFIG_NAND,		0x4,	0,	 0x1,	{ 0, 1, 0} }, \
+{ MV_CONFIG_SDIO,		0x4,	0,	 0x2,	{ 0, 1, 0} }, \
+{ MV_CONFIG_GIGA,		0x5,	0,	 0xE,	{ 0, 1, 0} }, \
 };
 
+struct _mvBoardMppModule {
+	MV_U32 group;
+	MV_U32 mppValue;
+};
+
+
+#define MPP_MII_MODULE		{ {0, 0x12111111}, {1, 0x11111111}, {2, 0x11266011} }
+#define MPP_TDM_MODULE		{ {6, 0x45333333}, {7, 0x00004444} }
+#define MPP_I2S_MODULE		{6, 0x55544554}
+#define MPP_SPDIF_MODULE	{6, 0x55444444}
+#define MPP_NOR_MODULE		{ {0, 0x51111111}, {1, 0x11555555}, {2, 0x55566011}, \
+				  {3, 0x55555055}, {4, 0x55555555}, {5, 0x40045525 } }
+#define MPP_NAND_MODULE		{ {0, 0x55111111}, {1, 0x15555555}, {2, 0x55266011}, \
+				  {3, 0x25255051}, {4, 0x25555555}, {5, 0x40042555 } }
+#define MPP_SDIO_MODULE		{ {2, 0x11466011}, {3, 0x22242011}, {4, 0x44400002}, \
+				  {5, 0x40042024 } }
+
 /* Boot device bus width */
 #define MSAR_0_BOOT_DEV_BUS_WIDTH_OFFS          3
 /* Bus width field meaning for NOR/NAND */
@@ -434,7 +451,6 @@ MV_U32 mvBoardGpioIntMaskGet(MV_U32 gppGrp);
 MV_U32 mvBoardSlicUnitTypeGet(MV_VOID);
 MV_VOID mvBoardSlicUnitTypeSet(MV_U32 slicType);
 MV_32 mvBoardMppGet(MV_U32 mppGroupNum);
-MV_VOID mvBoardMppTypeSet(MV_U32 mppGroupNum, MV_U32 groupType);
 MV_VOID mvBoardMppSet(MV_U32 mppGroupNum, MV_U32 mppValue);
 MV_U8 mvBoardTdmSpiIdGet(MV_VOID);
 MV_VOID mvBoardConfigurationPrint(MV_VOID);
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
index 0d321dd..efb914a 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
@@ -75,17 +75,17 @@
 
 
 typedef enum _mvConfigTypeID {
-	MV_CONFIG_SGMII,		/* module SGMII       */
-	MV_CONFIG_MII,			/* only one MII board */
-	MV_CONFIG_SLIC_TDM_DEVICE,
-	MV_CONFIG_I2S_DEVICE,
-	MV_CONFIG_SPDIF_DEVICE,
-	MV_CONFIG_SERDES_PEX_LAN1,
-	MV_CONFIG_SERDES_PEX_LAN2,
-	MV_CONFIG_NOR,
-	MV_CONFIG_NAND,
-	MV_CONFIG_SDIO,
-	MV_CONFIG_GIGA,
+	MV_CONFIG_MII,			/* MII board SLM 1362	*/
+	MV_CONFIG_SLIC_TDM_DEVICE,	/* TDM board SLM 1360	*/
+	MV_CONFIG_I2S_DEVICE,		/* I2S board SLM 1360	*/
+	MV_CONFIG_SPDIF_DEVICE,		/* SPDIF board SLM 1360	*/
+	MV_CONFIG_NOR,			/* NOR board SLM 1361	*/
+	MV_CONFIG_NAND,			/* NAND board SLM 1361	*/
+	MV_CONFIG_SDIO,			/* SDIO board SLM 1361	*/
+	MV_CONFIG_GIGA,			/* GIGA board SLM	*/
+	MV_CONFIG_SGMII,		/* SERDES module SGMII	*/
+	MV_CONFIG_SERDES_PEX_LAN1,	/* SERDES module PEX	*/
+	MV_CONFIG_SERDES_PEX_LAN2,	/* SERDES module PEX	*/
 	MV_CONFIG_TYPE_MAX_OPTION
 } MV_CONFIG_TYPE_ID;
 
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
index 900e60f..b87c057 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -245,116 +245,6 @@ extern "C" {
 #define FREQ_MODES_NUM_6810	3
 #define FREQ_MODES_NUM_6820	3
 
-#define MPP_GROUP_0_TYPE { \
-	0x55555555,     /* NAND_V2_BOOT_DEVICE  */ \
-	0x00020020,     /* SPI_BOOT_DEVICE	*/ \
-}
-
-typedef enum {
-	NAND_BOOT_V2,
-	SPI0_BOOT,
-	SPI0_BOOT_SPDIF_AUDIO,
-} MV_GROUP_0_TYPE;
-
-#define MPP_GROUP_1_TYPE { \
-	0x22555555,     /* NAND_V2_BOOT_DEVICE  */ \
-	0x22000022,     /* SPI_BOOT_DEVICE	*/ \
-}
-
-#define MV_GROUP_1_TYPE         MV_GROUP_0_TYPE
-
-#define MPP_GROUP_2_TYPE { \
-	0x22222222,     /* UART, TDM  */ \
-	0x22222222,     /* UART, TDM  */ \
-}
-
-typedef enum {
-	SLIC_SSI_DEV,
-	SLIC_ISI_DEV,
-	SLIC_ZSI_DEV,
-	SLIC_EXTERNAL_DEV
-} MV_GROUP_2_TYPE;
-
-#define MPP_GROUP_3_TYPE { \
-	0x33333333,     /* SDIO */ \
-	0x33333333,     /* SDIO	*/ \
-}
-
-typedef enum {
-	GE1_UNIT,
-	SDIO_UNIT,
-	SPI1_UNIT,
-	SDIO_SPI1_UNIT,
-} MV_GROUP_3_TYPE;
-
-#define MPP_GROUP_4_TYPE { \
-	0x04403330,     /* SPI, SMI */ \
-	0x04403330,     /* SPI, SMI */ \
-}
-
-typedef enum {
-	GE1_CPU_SMI_CTRL_TDM_LQ_UNIT,
-	GE1_CPU_SMI_CTRL_REF_CLK_OUT,
-	GE1_SW_SMI_CTRL_TDM_LQ_UNIT,
-	GE1_SW_SMI_CTRL_REF_CLK_OUT,
-	SPI1_CPU_SMI_CTRL_TDM_LQ_UNIT,
-	SPI1_CPU_SMI_CTRL_REF_CLK_OUT,
-	SPI1_SW_SMI_CTRL_TDM_LQ_UNIT,
-	SPI1_SW_SMI_CTRL_REF_CLK_OUT,
-} MV_GROUP_4_TYPE;
-
-#define MPP_GROUP_5_TYPE { \
-	0x22002044,     /* UART1, GE0 */ \
-	0x22002044,     /* UART1, GE0 */ \
-}
-typedef enum {
-	GE0_UNIT_PON_TX_FAULT,
-	GE0_UNIT_PON_CLK_OUT,
-	SWITCH_P4_PON_TX_FAULT,
-	SWITCH_P4_PON_CLK_OUT,
-} MV_GROUP_5_TYPE;
-
-#define MPP_GROUP_6_TYPE { \
-	0x22222222,     /* GE0  */ \
-	0x22222222,     /* GE0	*/ \
-}
-
-typedef enum {
-	GE0_UNIT,
-	SWITCH_P4,
-} MV_GROUP_6_TYPE;
-
-#define MPP_GROUP_7_TYPE { \
-	0x00000022,     /* GE0 , LED  */ \
-	0x00000022,     /* GE0 , LED  */ \
-}
-
-typedef enum {
-	SWITCH_P4_LED_MATRIX,
-	GE0_UNIT_LED_MATRIX,
-	SWITCH_P4_UA1_PTP,
-	GE0_UNIT_UA1_PTP,
-} MV_GROUP_7_TYPE;
-
-#define MPP_GROUP_8_TYPE { \
-		0x000,\
-}
-
-typedef enum {
-	LED_MATRIX_PTP,
-} MV_GROUP_8_TYPE;
-
-#define MPP_GROUP_TYPES { \
-	MPP_GROUP_0_TYPE, \
-	MPP_GROUP_1_TYPE, \
-	MPP_GROUP_2_TYPE, \
-	MPP_GROUP_3_TYPE, \
-	MPP_GROUP_4_TYPE, \
-	MPP_GROUP_5_TYPE, \
-	MPP_GROUP_6_TYPE, \
-	MPP_GROUP_7_TYPE, \
-	MPP_GROUP_8_TYPE, \
-}
 
 /* This enumerator defines the Marvell Units ID      */
 typedef enum {
-- 
1.7.5.4

