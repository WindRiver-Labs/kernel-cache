From 68459067b2cf5f646eb0da8f9d275ff97b36b618 Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Wed, 19 Jun 2013 12:42:46 -0400
Subject: [PATCH 0723/1825] PPv2: Add wmb() before start TX operation and
 before RX buffer refill.

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit dcc9aadcc8457b345547d8d1e35cd7c5d21bfeb1

	This patch fix duplicate packets issue.
	This patch can be removed if PPv2 registers will be set as strongly ordered.

Change-Id: I2882d9733b56b6e58845e11b383ffc48c01e2ebb
Reviewed-on: http://vgitil04.il.marvell.com:8080/2280
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index 1453cf4..5fa558b 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -1591,7 +1591,7 @@ static inline int mv_eth_rx(struct eth_port *pp, int rx_todo, int rxq)
 	}
 
 	/* Update RxQ management counters */
-	mvOsCacheIoSync();
+	wmb();
 	mvPp2RxqDescNumUpdate(pp->port, rxq, rx_done, rx_filled);
 
 	return rx_done;
@@ -1739,6 +1739,7 @@ static int mv_eth_tx(struct sk_buff *skb, struct net_device *dev)
 	}
 #endif /* CONFIG_MV_ETH_DEBUG_CODE */
 	/* Enable transmit */
+	wmb();
 	mvPp2AggrTxqPendDescAdd(frags);
 
 	STAT_DBG(aggr_txq_ctrl->stats.txq_tx += frags);
@@ -2027,6 +2028,7 @@ int mv_eth_tx_tso(struct sk_buff *skb, struct net_device *dev, struct mv_eth_tx_
 	STAT_DBG(priv->stats.tx_tso_bytes += totalBytes);
 	STAT_DBG(txq_ctrl->stats.txq_tx += totalDescNum);
 
+	wmb();
 	mvPp2AggrTxqPendDescAdd(totalDescNum);
 
 	return totalDescNum;
-- 
1.7.5.4

