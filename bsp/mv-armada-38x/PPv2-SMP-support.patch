From acc5b552b5fefa7910bd08760b92d99d5fdac09f Mon Sep 17 00:00:00 2001
From: Yoni Farhadian <yonif@marvell.com>
Date: Thu, 20 Jun 2013 19:21:17 +0300
Subject: [PATCH 0739/1825] PPv2: SMP support

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 5ba230913d8b813f508689479f428844c9afbc6a

Change-Id: Ib625518d0ed3cc3f27d28d0a55ccffdf75bdc67d
Signed-off-by: Yoni Farhadian <yonif@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/2318
Reviewed-by: Star_Automation <star@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-by: Kosta Zertsekel <konszert@marvell.com>
Reviewed-by: Tawfik Bayouk <tawfik@marvell.com>
Tested-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   21 ---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h        |    1 -
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |  163 ++++++++++----------
 arch/arm/mach-avantalp/include/mach/avantalp.h     |    8 +-
 arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c        |    2 +-
 arch/arm/mach-avantalp/sysmap.c                    |   22 ++-
 arch/arm/plat-armada/linux_oss/mvOs.h              |   26 +++-
 .../plat-armada/mv_hal/pp2/common/mvPp2Common.c    |    1 +
 8 files changed, 130 insertions(+), 114 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 25d709e..121374d 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -864,27 +864,6 @@ MV_U32 mvCtrlEthMaxPortGet(MV_VOID)
 #endif
 }
 
-/*******************************************************************************
-* mvCtrlEthMaxCPUsGet - Get Marvell controller number of CPUs.
-*
-* DESCRIPTION:
-*       This function returns Marvell controller number of CPUs.
-*
-* INPUT:
-*       None.
-*
-* OUTPUT:
-*       None.
-*
-* RETURN:
-*       Marvell controller number of CPUs.
-*
-*******************************************************************************/
-MV_U8 mvCtrlEthMaxCPUsGet(MV_VOID)
-{
-	return 1;
-}
-
 #if defined(MV_INCLUDE_SATA)
 /*******************************************************************************
 * mvCtrlSataMaxPortGet - Get Marvell controller number of Sata ports.
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
index ed9ca0d..6f79c11 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
@@ -293,7 +293,6 @@ MV_U32 mvCtrlPexMaxUnitGet(MV_VOID);
 #endif
 
 MV_U32 mvCtrlEthMaxPortGet(MV_VOID);
-MV_U8 mvCtrlEthMaxCPUsGet(MV_VOID);
 #if defined(MV_INCLUDE_XOR)
 MV_U32 mvCtrlXorMaxChanGet(MV_VOID);
 MV_U32 mvCtrlXorMaxUnitGet(MV_VOID);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index 45e5b1a..672476e 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -449,32 +449,33 @@ typedef enum _mvDevice {
 /* controller can access. They are also refered as "targets"                */
 typedef enum _mvTarget {
 	TBL_TERM = -1,  /* none valid target, used as targets list terminator*/
-	SDRAM_CS0,      /*  0 SDRAM chip select 0		*/
-	SDRAM_CS1,      /*  1 SDRAM chip select 1		*/
-	SDRAM_CS2,      /*  2 SDRAM chip select 2		*/
-	SDRAM_CS3,      /*  3 SDRAM chip select 3		*/
-	DEVICE_CS0,     /*  4 Device chip select 0		*/
-	DEVICE_CS1,     /*  5 Device chip select 1		*/
-	DEVICE_CS2,     /*  6 Device chip select 2		*/
-	DEVICE_CS3,     /*  7 Device chip select 3		*/
-	PEX0_MEM,       /*  8 PCI Express 0 Memory		*/
-	PEX0_IO,        /*  9 PCI Express 0 IO			*/
-	PEX1_MEM,       /* 10 PCI Express 1 Memory		*/
-	PEX1_IO,        /* 11 PCI Express 1 IO			*/
-	INTER_REGS,     /* 12 Internal registers		*/
-	DMA_UART,       /* 13 DMA based UART request	*/
-	SPI_CS0,        /* 14 SPI_CS0					*/
-	SPI_CS1,        /* 15 SPI_CS1					*/
-	SPI_CS2,        /* 16 SPI_CS2					*/
-	SPI_CS3,        /* 17 SPI_CS3					*/
-	SPI_CS4,        /* 18 SPI_CS4					*/
-	SPI_CS5,        /* 19 SPI_CS5					*/
-	SPI_CS6,        /* 20 SPI_CS6					*/
-	SPI_CS7,        /* 21 SPI_CS7					*/
-	BOOT_ROM_CS,    /* 22 BOOT_ROM_CS				*/
-	DEV_BOOCS,      /* 23 DEV_BOOCS					*/
-	CRYPT0_ENG,      /* 24 Crypto0 Engine			*/
-	PP2,         	/* 25 PP2						*/
+	SDRAM_CS0,	/*  0 SDRAM chip select 0	*/
+	SDRAM_CS1,	/*  1 SDRAM chip select 1	*/
+	SDRAM_CS2,	/*  2 SDRAM chip select 2	*/
+	SDRAM_CS3,	/*  3 SDRAM chip select 3	*/
+	DEVICE_CS0,	/*  4 Device chip select 0	*/
+	DEVICE_CS1,	/*  5 Device chip select 1	*/
+	DEVICE_CS2,	/*  6 Device chip select 2	*/
+	DEVICE_CS3,	/*  7 Device chip select 3	*/
+	PEX0_MEM,	/*  8 PCI Express 0 Memory	*/
+	PEX0_IO,	/*  9 PCI Express 0 IO		*/
+	PEX1_MEM,	/* 10 PCI Express 1 Memory	*/
+	PEX1_IO,	/* 11 PCI Express 1 IO		*/
+	INTER_REGS,	/* 12 Internal registers	*/
+	DMA_UART,	/* 13 DMA based UART request	*/
+	SPI_CS0,	/* 14 SPI_CS0			*/
+	SPI_CS1,	/* 15 SPI_CS1			*/
+	SPI_CS2,	/* 16 SPI_CS2			*/
+	SPI_CS3,	/* 17 SPI_CS3			*/
+	SPI_CS4,	/* 18 SPI_CS4			*/
+	SPI_CS5,	/* 19 SPI_CS5			*/
+	SPI_CS6,	/* 20 SPI_CS6			*/
+	SPI_CS7,	/* 21 SPI_CS7			*/
+	BOOT_ROM_CS,	/* 22 BOOT_ROM_CS		*/
+	DEV_BOOCS,	/* 23 DEV_BOOCS			*/
+	CRYPT0_ENG,	/* 24 Crypto0 Engine		*/
+	PP2_CPU0,	/* 25 PP2 - CPU 0		*/
+	PP2_CPU1,	/* 26 PP2 - CPU 1		*/
 	MAX_TARGETS
 } MV_TARGET;
 
@@ -499,62 +500,64 @@ typedef enum _mvTarget {
 #endif
 
 #define TARGETS_DEF_ARRAY {                                                 \
-	{ DRAM_CS0_ATTR, DRAM_TARGET_ID },      /* SDRAM_CS0             */ \
-	{ DRAM_CS1_ATTR, DRAM_TARGET_ID },      /* SDRAM_CS1             */ \
-	{ DRAM_CS2_ATTR, DRAM_TARGET_ID },      /* SDRAM_CS0             */ \
-	{ DRAM_CS3_ATTR, DRAM_TARGET_ID },      /* SDRAM_CS1             */ \
-	{ 0x3E, DEV_TARGET_ID    },             /* DEVICE_CS0            */ \
-	{ 0x3D, DEV_TARGET_ID    },             /* DEVICE_CS1            */ \
-	{ 0x3B, DEV_TARGET_ID    },             /* DEVICE_CS2            */ \
-	{ 0x37, DEV_TARGET_ID    },             /* DEVICE_CS3            */ \
-	{ 0xE8, PEX_TARGET_ID    },             /* PEX0_LANE0_MEM        */ \
-	{ 0xE0, PEX_TARGET_ID    },             /* PEX0_LANE0_IO         */ \
-	{ 0xD8, PEX_TARGET_ID    },             /* PEX1_LANE0_MEM        */ \
-	{ 0xD0, PEX_TARGET_ID    },             /* PEX1_LANE0_IO         */ \
-	{ 0xFF, 0xFF             },             /* INTER_REGS            */ \
-	{ 0x01, DEV_TARGET_ID    },             /* DMA_UART              */ \
-	{ 0x1E, DEV_TARGET_ID    },             /* SPI_CS0               */ \
-	{ 0x5E, DEV_TARGET_ID    },             /* SPI_CS1               */ \
-	{ 0x9E, DEV_TARGET_ID    },             /* SPI_CS2               */ \
-	{ 0xDE, DEV_TARGET_ID    },             /* SPI_CS3               */ \
-	{ 0x1F, DEV_TARGET_ID    },             /* SPI_CS4               */ \
-	{ 0x5F, DEV_TARGET_ID    },             /* SPI_CS5               */ \
-	{ 0x9F, DEV_TARGET_ID    },             /* SPI_CS6               */ \
-	{ 0xDF, DEV_TARGET_ID    },             /* SPI_CS7               */ \
-	{ MAIN_BOOT_ATTR, DEV_TARGET_ID },      /* Main Boot device      */ \
-	{ SEC_BOOT_ATTR, DEV_TARGET_ID  },      /* Secondary Boot device */ \
-	{ 0x01, CRYPT_TARGET_ID  },             /* CRYPT_ENG0            */ \
-	{ 0x00, PP2_TARGET_ID },                /* PP2                   */ \
+	{ DRAM_CS0_ATTR, DRAM_TARGET_ID },	/* SDRAM_CS0             */ \
+	{ DRAM_CS1_ATTR, DRAM_TARGET_ID },	/* SDRAM_CS1             */ \
+	{ DRAM_CS2_ATTR, DRAM_TARGET_ID },	/* SDRAM_CS0             */ \
+	{ DRAM_CS3_ATTR, DRAM_TARGET_ID },	/* SDRAM_CS1             */ \
+	{ 0x3E, DEV_TARGET_ID	},		/* DEVICE_CS0            */ \
+	{ 0x3D, DEV_TARGET_ID	},		/* DEVICE_CS1            */ \
+	{ 0x3B, DEV_TARGET_ID	},		/* DEVICE_CS2            */ \
+	{ 0x37, DEV_TARGET_ID	},		/* DEVICE_CS3            */ \
+	{ 0xE8, PEX_TARGET_ID	},		/* PEX0_LANE0_MEM        */ \
+	{ 0xE0, PEX_TARGET_ID	},		/* PEX0_LANE0_IO         */ \
+	{ 0xD8, PEX_TARGET_ID	},		/* PEX1_LANE0_MEM        */ \
+	{ 0xD0, PEX_TARGET_ID	},		/* PEX1_LANE0_IO         */ \
+	{ 0xFF, 0xFF		},		/* INTER_REGS            */ \
+	{ 0x01, DEV_TARGET_ID	},		/* DMA_UART              */ \
+	{ 0x1E, DEV_TARGET_ID	},		/* SPI_CS0               */ \
+	{ 0x5E, DEV_TARGET_ID	},		/* SPI_CS1               */ \
+	{ 0x9E, DEV_TARGET_ID	},		/* SPI_CS2               */ \
+	{ 0xDE, DEV_TARGET_ID	},		/* SPI_CS3               */ \
+	{ 0x1F, DEV_TARGET_ID	},		/* SPI_CS4               */ \
+	{ 0x5F, DEV_TARGET_ID	},		/* SPI_CS5               */ \
+	{ 0x9F, DEV_TARGET_ID	},		/* SPI_CS6               */ \
+	{ 0xDF, DEV_TARGET_ID	},		/* SPI_CS7               */ \
+	{ MAIN_BOOT_ATTR, DEV_TARGET_ID	},	/* Main Boot device      */ \
+	{ SEC_BOOT_ATTR, DEV_TARGET_ID	},	/* Secondary Boot device */ \
+	{ 0x01, CRYPT_TARGET_ID	},		/* CRYPT_ENG0            */ \
+	{ 0x00, PP2_TARGET_ID	},		/* PP2 - CPU 0           */ \
+	{ 0x01, PP2_TARGET_ID	},		/* PP2 - CPU 1           */ \
 }
 
-#define CESA_TARGET_NAME_DEF    ("CRYPT_ENG0", "CRYPT_ENG1")
-#define TARGETS_NAME_ARRAY      {			\
-	"SDRAM_CS0",            /* SDRAM_CS0 */		\
-	"SDRAM_CS1",            /* SDRAM_CS1 */		\
-	"SDRAM_CS2",            /* SDRAM_CS1 */		\
-	"SDRAM_CS3",            /* SDRAM_CS1 */		\
-	"DEVICE_CS0",           /* DEVICE_CS0 */	\
-	"DEVICE_CS1",           /* DEVICE_CS1 */	\
-	"DEVICE_CS2",           /* DEVICE_CS2 */	\
-	"DEVICE_CS3",           /* DEVICE_CS3 */	\
-	"PEX0_MEM",             /* PEX0_MEM */		\
-	"PEX0_IO",              /* PEX0_IO */		\
-	"PEX1_MEM",             /* PEX1_MEM */		\
-	"PEX1_IO",              /* PEX1_IO */		\
-	"INTER_REGS",           /* INTER_REGS */	\
-	"DMA_UART",             /* DMA_UART */		\
-	"SPI_CS0",              /* SPI_CS0 */		\
-	"SPI_CS1",              /* SPI_CS1 */		\
-	"SPI_CS2",              /* SPI_CS2 */		\
-	"SPI_CS3",              /* SPI_CS3 */		\
-	"SPI_CS4",              /* SPI_CS4 */		\
-	"SPI_CS5",              /* SPI_CS5 */		\
-	"SPI_CS6",              /* SPI_CS6 */		\
-	"SPI_CS7",              /* SPI_CS7 */		\
-	"BOOT_ROM_CS",          /* BOOT_ROM_CS */	\
-	"DEV_BOOTCS",           /* DEV_BOOCS */		\
-	"CRYPT1_ENG",           /* CRYPT1_ENG */	\
-	"PP2"                   /* PP2 */		\
+#define CESA_TARGET_NAME_DEF	("CRYPT_ENG0", "CRYPT_ENG1")
+#define TARGETS_NAME_ARRAY	{			\
+	"SDRAM_CS0",		/* SDRAM_CS0 */		\
+	"SDRAM_CS1",		/* SDRAM_CS1 */		\
+	"SDRAM_CS2",		/* SDRAM_CS1 */		\
+	"SDRAM_CS3",		/* SDRAM_CS1 */		\
+	"DEVICE_CS0",		/* DEVICE_CS0 */	\
+	"DEVICE_CS1",		/* DEVICE_CS1 */	\
+	"DEVICE_CS2",		/* DEVICE_CS2 */	\
+	"DEVICE_CS3",		/* DEVICE_CS3 */	\
+	"PEX0_MEM",		/* PEX0_MEM */		\
+	"PEX0_IO",		/* PEX0_IO */		\
+	"PEX1_MEM",		/* PEX1_MEM */		\
+	"PEX1_IO",		/* PEX1_IO */		\
+	"INTER_REGS",		/* INTER_REGS */	\
+	"DMA_UART",		/* DMA_UART */		\
+	"SPI_CS0",		/* SPI_CS0 */		\
+	"SPI_CS1",		/* SPI_CS1 */		\
+	"SPI_CS2",		/* SPI_CS2 */		\
+	"SPI_CS3",		/* SPI_CS3 */		\
+	"SPI_CS4",		/* SPI_CS4 */		\
+	"SPI_CS5",		/* SPI_CS5 */		\
+	"SPI_CS6",		/* SPI_CS6 */		\
+	"SPI_CS7",		/* SPI_CS7 */		\
+	"BOOT_ROM_CS",		/* BOOT_ROM_CS */	\
+	"DEV_BOOTCS",		/* DEV_BOOCS */		\
+	"CRYPT1_ENG",		/* CRYPT1_ENG */	\
+	"PP2 - CPU 0",		/* PP2 - CPU 0 */	\
+	"PP2 - CPU 1"		/* PP2 - CPU 1 */	\
 }
 
 #endif /* MV_ASMLANGUAGE */
diff --git a/arch/arm/mach-avantalp/include/mach/avantalp.h b/arch/arm/mach-avantalp/include/mach/avantalp.h
index b3eb617..d422649 100644
--- a/arch/arm/mach-avantalp/include/mach/avantalp.h
+++ b/arch/arm/mach-avantalp/include/mach/avantalp.h
@@ -67,8 +67,9 @@
 #define XOR0_HIGH_PHYS_BASE		(INTER_REGS_PHYS_BASE | 0x60A00)
 #define XOR1_HIGH_PHYS_BASE		(INTER_REGS_PHYS_BASE | 0xF0B00)
 
-#define PP2_PHYS_BASE			0xF4500000
-#define PP2_SIZE			_1M
+#define PP2_CPU0_PHYS_BASE		0xF4500000
+#define PP2_CPU1_PHYS_BASE		0xF4510000
+#define PP2_SIZE			_64K
 
 #define BOOTROM_PHYS_BASE		0xFFF00000
 #define BOOTROM_SIZE			_1M
@@ -100,7 +101,8 @@
 #define DEVICE_CS3_VIRT_BASE		0xFEA00000
 
 #define CRYPT_ENG_VIRT_BASE(chan)	((chan == 0) ? 0xFEB00000 : 0xFEB10000)
-#define PP2_VIRT_BASE			0xFEC00000
+#define PP2_CPU0_VIRT_BASE		0xFEC00000
+#define PP2_CPU1_VIRT_BASE		0xFEC10000
 #define BOOTROM_VIRT_BASE		0xFED00000
 #define LEGACY_NAND_VIRT_BASE		0xFEF00000
 
diff --git a/arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c b/arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c
index d17ccc1..40f4361 100644
--- a/arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c
+++ b/arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c
@@ -121,7 +121,7 @@ void 	mvSysPp2Init(void)
 
 	halData.pClk = mvCpuPclkGet();
 	halData.tClk = mvBoardTclkGet();
-	halData.maxCPUs = mvCtrlEthMaxCPUsGet();
+	halData.maxCPUs = CONFIG_NR_CPUS;
 	halData.iocc = arch_is_coherent();
 	halData.ctrlModel = mvCtrlModelGet();
 	halData.ctrlRev = mvCtrlRevGet();
diff --git a/arch/arm/mach-avantalp/sysmap.c b/arch/arm/mach-avantalp/sysmap.c
index b53d284..60cd217 100644
--- a/arch/arm/mach-avantalp/sysmap.c
+++ b/arch/arm/mach-avantalp/sysmap.c
@@ -24,7 +24,10 @@
 struct map_desc MEM_TABLE[] = {
 	/* no use for pex mem remap */
 	{ INTER_REGS_VIRT_BASE,		__phys_to_pfn(INTER_REGS_PHYS_BASE),	SZ_1M,		MT_DEVICE },
-	{ PP2_VIRT_BASE,		__phys_to_pfn(PP2_PHYS_BASE),		SZ_1M, 	     	MT_DEVICE },
+	{ PP2_CPU0_VIRT_BASE,		__phys_to_pfn(PP2_CPU0_PHYS_BASE),	PP2_SIZE,	MT_DEVICE },
+#ifdef CONFIG_SMP
+	{ PP2_CPU1_VIRT_BASE,		__phys_to_pfn(PP2_CPU1_PHYS_BASE),	PP2_SIZE,	MT_DEVICE },
+#endif
 	{ CRYPT_ENG_VIRT_BASE(0),	__phys_to_pfn(CRYPT_ENG_PHYS_BASE(0)),	CRYPT_ENG_SIZE,	MT_DEVICE },
 	{ IOCC_WA_WIN0_VIRT_BASE,	__phys_to_pfn(IOCC_WA_WIN0_PHYS_BASE),	SZ_64K,		MT_DEVICE },
 };
@@ -56,7 +59,12 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6660[] = {
 	{{BOOTROM_PHYS_BASE,		0,	BOOTROM_SIZE		},	9,			DIS},	/* BOOTROM */
 	{{DEVICE_BOOTCS_PHYS_BASE,	0,	DEVICE_BOOTCS_SIZE	},	10,			DIS},	/* DEV_BOOCS */
 	{{CRYPT_ENG_PHYS_BASE(0),	0,	CRYPT_ENG_SIZE		},	12,			EN},	/* CRYPT_ENG */
-	{{PP2_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 */
+	{{PP2_CPU0_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 */
+#ifdef CONFIG_SMP
+	{{PP2_CPU1_PHYS_BASE,		0,	PP2_SIZE		},	15,			EN},	/* PP2 */
+#else
+	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2 */
+#endif
 	{{TBL_TERM,			TBL_TERM,	TBL_TERM	},	TBL_TERM,		TBL_TERM}
 };
 
@@ -87,7 +95,12 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6650[] = {
 	{{BOOTROM_PHYS_BASE,		0,	BOOTROM_SIZE		},	9,			DIS},	/* BOOTROM */
 	{{DEVICE_BOOTCS_PHYS_BASE,	0,	DEVICE_BOOTCS_SIZE	},	10,			DIS},	/* DEV_BOOCS */
 	{{CRYPT_ENG_PHYS_BASE(0),	0,	CRYPT_ENG_SIZE		},	12,			EN},	/* CRYPT_ENG */
-	{{PP2_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 */
+	{{PP2_CPU0_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 */
+#ifdef CONFIG_SMP
+	{{PP2_CPU1_PHYS_BASE,		0,	PP2_SIZE		},	15,			EN},	/* PP2 */
+#else
+	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2 */
+#endif
 	{{TBL_TERM,			TBL_TERM,	TBL_TERM	},	TBL_TERM,		TBL_TERM}
 };
 
@@ -118,7 +131,8 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6610[] = {
 	{{BOOTROM_PHYS_BASE,		0,	BOOTROM_SIZE		},	9,			DIS},	/* BOOTROM */
 	{{DEVICE_BOOTCS_PHYS_BASE,	0,	DEVICE_BOOTCS_SIZE	},	10,			DIS},	/* DEV_BOOCS */
 	{{CRYPT_ENG_PHYS_BASE(0),	0,	CRYPT_ENG_SIZE		},	12,			EN},	/* CRYPT_ENG */
-	{{PP2_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 */
+	{{PP2_CPU0_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 */
+	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2 */
 	{{TBL_TERM,			TBL_TERM,	TBL_TERM	},	TBL_TERM,		TBL_TERM}
 };
 
diff --git a/arch/arm/plat-armada/linux_oss/mvOs.h b/arch/arm/plat-armada/linux_oss/mvOs.h
index 554b15d..69cd6ea 100644
--- a/arch/arm/plat-armada/linux_oss/mvOs.h
+++ b/arch/arm/plat-armada/linux_oss/mvOs.h
@@ -521,11 +521,29 @@ extern int reg_arry_index;
 	(MV_MEMIO32_READ((INTER_REGS_VIRT_BASE | (offset))))
 
 /* PPv2 specific reg read/write */
-#define MV_PP2_REG_READ(offset)             \
-	(MV_MEMIO_LE32_READ(PP2_VIRT_BASE | (offset)))
-#define MV_PP2_REG_WRITE(offset, val)    \
-	MV_MEMIO_LE32_WRITE((PP2_VIRT_BASE | (offset)), (val))
+#define MV_PP2_CPU0_REG_READ(offset)             \
+	(MV_MEMIO_LE32_READ(PP2_CPU0_VIRT_BASE | (offset & 0xffff)))
+#define MV_PP2_CPU0_REG_WRITE(offset, val)    \
+	MV_MEMIO_LE32_WRITE((PP2_CPU0_VIRT_BASE | (offset & 0xffff)), (val))
+
+#define MV_PP2_CPU1_REG_READ(offset)             \
+	(MV_MEMIO_LE32_READ(PP2_CPU1_VIRT_BASE | (offset & 0xffff)))
+#define MV_PP2_CPU1_REG_WRITE(offset, val)    \
+	MV_MEMIO_LE32_WRITE((PP2_CPU1_VIRT_BASE | (offset & 0xffff)), (val))
+
+#ifdef CONFIG_SMP
+#define MV_PP2_REG_READ(offset)	\
+	((smp_processor_id() == 0) ? MV_PP2_CPU0_REG_READ(offset) : MV_PP2_CPU1_REG_READ(offset))
+
+#define MV_PP2_REG_WRITE(offset, val)	\
+	((smp_processor_id() == 0) ? MV_PP2_CPU0_REG_WRITE(offset, val) : MV_PP2_CPU1_REG_WRITE(offset, val))
+#else
+#define MV_PP2_REG_READ(offset)	\
+	MV_PP2_CPU0_REG_READ(offset)
 
+#define MV_PP2_REG_WRITE(offset, val)	\
+	MV_PP2_CPU0_REG_WRITE(offset, val)
+#endif
 
 #define MV_REG_READ(offset)             \
 	(MV_MEMIO_LE32_READ(INTER_REGS_VIRT_BASE | (offset)))
diff --git a/arch/arm/plat-armada/mv_hal/pp2/common/mvPp2Common.c b/arch/arm/plat-armada/mv_hal/pp2/common/mvPp2Common.c
index f011594..61a7042 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/common/mvPp2Common.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/common/mvPp2Common.c
@@ -69,6 +69,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 int mvPp2WrReg(unsigned int offset, unsigned int  val)
 {
 	MV_PP2_REG_WRITE(offset, val);
+
 #if defined(PP2_REG_WRITE_TRACE)
 	mvOsPrintf("REG:0x%08X	W:0x%08X\n", offset, val);
 #endif
-- 
1.7.5.4

