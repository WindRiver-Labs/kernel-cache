From 83dc872b53b2f148bd3a4de95c45c1df03df10c5 Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Mon, 17 Jun 2013 14:46:59 +0300
Subject: [PATCH 0753/1825] alp:usb: Initial USB3 XHCI support

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 9a197aa89d5a6395b05dcc69b5cf6023470553e0

	This patch adds USB3 support via the standard XHCI platform
	driver. A function to register the XHCI driver was added which
	also opens an mbus windows for USB3 to access DRAM. The patch
	also adds an IO window to access the USB3 registers

Change-Id: Icd62aa4626919aaa85d9e209d4debd3f0acd3cb6
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/2259
Reviewed-by: Star_Automation <star@marvell.com>
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/configs/avanta_lp_defconfig               |    2 +-
 arch/arm/mach-avantalp/Kconfig                     |   10 ++
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h       |    1 +
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |   11 +-
 .../avanta_lp_family/ctrlEnv/sys/mvCpuIfRegs.h     |    5 +
 arch/arm/mach-avantalp/config/mvSysUsbConfig.h     |    1 +
 arch/arm/mach-avantalp/core.c                      |   11 ++
 arch/arm/mach-avantalp/core.h                      |    1 +
 arch/arm/mach-avantalp/include/mach/avantalp.h     |    5 +
 arch/arm/mach-avantalp/include/mach/irqs.h         |    4 +-
 arch/arm/mach-avantalp/sysmap.c                    |    3 +
 arch/arm/mach-avantalp/usb.c                       |  169 ++++++++++++++++----
 arch/arm/plat-armada/Kconfig                       |    1 +
 drivers/usb/host/Makefile                          |    4 +-
 14 files changed, 188 insertions(+), 40 deletions(-)

diff --git a/arch/arm/configs/avanta_lp_defconfig b/arch/arm/configs/avanta_lp_defconfig
index fce5604..89c4d47 100644
--- a/arch/arm/configs/avanta_lp_defconfig
+++ b/arch/arm/configs/avanta_lp_defconfig
@@ -18,7 +18,6 @@ CONFIG_ARCH_AVANTA_LP=y
 CONFIG_MV_ETH_TXQ=8
 # CONFIG_MV_ETH_TOOL is not set
 # CONFIG_NET_SKB_RECYCLE is not set
-# CONFIG_MV_INCLUDE_USB is not set
 # CONFIG_MV_INCLUDE_LEGACY_NAND is not set
 CONFIG_MTD_NAND_NFC_INIT_RESET=y
 CONFIG_MV_ETH_PP2=y
@@ -124,6 +123,7 @@ CONFIG_HID_SONY=y
 CONFIG_HID_SUNPLUS=y
 CONFIG_USB=y
 CONFIG_USB_DEVICEFS=y
+CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_EHCI_HCD=y
 CONFIG_USB_EHCI_ROOT_HUB_TT=y
 CONFIG_USB_PRINTER=y
diff --git a/arch/arm/mach-avantalp/Kconfig b/arch/arm/mach-avantalp/Kconfig
index 8d2941b..23e04d5 100644
--- a/arch/arm/mach-avantalp/Kconfig
+++ b/arch/arm/mach-avantalp/Kconfig
@@ -78,6 +78,16 @@ config AVANTA_LP_USE_IRQ_INTERRUPT_ACK
 	help
 	  No help currently.
 
+
+config AVANTA_LP_Z1_USB3_LFPS_FREQ_WA
+	bool "Enable the LFPS frequency workaround for USB3"
+	default y
+	help
+	  This flag enables a workaround for USB3 in avanta LP. It
+	  fixes the USB3 LFPS timing to fix some clock issues
+	  in the integration of USB3. This WA is needed only
+	  for Z1 devices
+
 endmenu
 
 endif
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
index af19681..272912c 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
@@ -314,6 +314,7 @@ typedef enum _mvTargetId {
 	DRAM_TARGET_ID   = 0,  /* Port 0  -> DRAM interface             */
 	DEV_TARGET_ID    = 1,  /* Port 1  -> Device bus, BootROM, SPI, UART,
 				*	     GPIO, MPP, and Miscellaneous */
+	USB3_TARGET_ID   = 5,  /* Port 5  -> USB3 Unit,			*/
 	PEX_TARGET_ID    = 4,  /* Port 4  -> PCI Express 0 and 1        */
 	CRYPT_TARGET_ID  = 9,  /* Port 9  -> Crypto Engine SRAM         */
 	PP2_TARGET_ID = 15,    /* Port 12 -> PP2 Unit                   */
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index 672476e..6fc50a9 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -91,6 +91,7 @@ extern "C" {
 #define MV_GPP_REGS_OFFSET(unit)                (0x18100 + ((unit) * 0x40))
 #define MV_MISC_REGS_OFFSET                     (0x18200)
 #define MV_COMMON_PHY_REGS_OFFSET               (0x18300)
+#define MV_IP_CONFIG_REGS_OFFSET		(0x18400)
 #define MV_CLK_CMPLX_REGS_OFFSET        	(0x18700)
 #define MV_ETH_COMPLEX_OFFSET			(0x18900)
 #define MV_MBUS_REGS_OFFSET                     (0x20000)
@@ -132,6 +133,7 @@ extern "C" {
 #define MV_PEX_IF_REGS_OFFSET(pexIf)            (pexIf < 8 ? (0x40000 + ((pexIf) / 4) * 0x40000 + ((pexIf) % 4) * 0x4000) \
 						 : (0x42000 + ((pexIf) % 8) * 0x40000))
 #define MV_USB_REGS_OFFSET(dev)                 (0x50000)
+#define MV_USB3_REGS_OFFSET(dev)                (0x5FF80)
 #define MV_XOR_REGS_OFFSET(unit)                (0x60800)
 #define MV_CESA_TDMA_REGS_OFFSET(chanNum)       (0x90000 + (chanNum * 0x2000))
 #define MV_CESA_REGS_OFFSET(chanNum)            (0x9D000 + (chanNum * 0x2000))
@@ -473,9 +475,10 @@ typedef enum _mvTarget {
 	SPI_CS7,	/* 21 SPI_CS7			*/
 	BOOT_ROM_CS,	/* 22 BOOT_ROM_CS		*/
 	DEV_BOOCS,	/* 23 DEV_BOOCS			*/
-	CRYPT0_ENG,	/* 24 Crypto0 Engine		*/
-	PP2_CPU0,	/* 25 PP2 - CPU 0		*/
-	PP2_CPU1,	/* 26 PP2 - CPU 1		*/
+	USB3,		/* 24 USB3			*/
+	CRYPT0_ENG,	/* 25 Crypto0 Engine		*/
+	PP2_CPU0,	/* 26 PP2 - CPU 0		*/
+	PP2_CPU1,	/* 27 PP2 - CPU 1		*/
 	MAX_TARGETS
 } MV_TARGET;
 
@@ -524,6 +527,7 @@ typedef enum _mvTarget {
 	{ 0xDF, DEV_TARGET_ID	},		/* SPI_CS7               */ \
 	{ MAIN_BOOT_ATTR, DEV_TARGET_ID	},	/* Main Boot device      */ \
 	{ SEC_BOOT_ATTR, DEV_TARGET_ID	},	/* Secondary Boot device */ \
+	{ 0x00, USB3_TARGET_ID },               /* USB3                  */ \
 	{ 0x01, CRYPT_TARGET_ID	},		/* CRYPT_ENG0            */ \
 	{ 0x00, PP2_TARGET_ID	},		/* PP2 - CPU 0           */ \
 	{ 0x01, PP2_TARGET_ID	},		/* PP2 - CPU 1           */ \
@@ -555,6 +559,7 @@ typedef enum _mvTarget {
 	"SPI_CS7",		/* SPI_CS7 */		\
 	"BOOT_ROM_CS",		/* BOOT_ROM_CS */	\
 	"DEV_BOOTCS",		/* DEV_BOOCS */		\
+	"USB3",                 /* USB3 */		\
 	"CRYPT1_ENG",		/* CRYPT1_ENG */	\
 	"PP2 - CPU 0",		/* PP2 - CPU 0 */	\
 	"PP2 - CPU 1"		/* PP2 - CPU 1 */	\
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/sys/mvCpuIfRegs.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/sys/mvCpuIfRegs.h
index 4a71a2d..1510514 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/sys/mvCpuIfRegs.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/sys/mvCpuIfRegs.h
@@ -73,6 +73,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 
 #define MV_CPUIF_REGS_BASE(cpu)			(MV_CPUIF_REGS_OFFSET(cpu))
 #define MV_MISC_REGS_BASE			(MV_MISC_REGS_OFFSET)
+#define MV_IP_CONFIG_REGS_BASE			(MV_IP_CONFIG_REGS_OFFSET)
 #define MV_CLK_CMPLX_REGS_BASE			(MV_CLK_CMPLX_REGS_OFFSET)
 #define MV_L2C_REGS_BASE			(MV_AURORA_L2_REGS_OFFSET)
 #define MV_CPUIF_SHARED_REGS_BASE		(MV_MBUS_REGS_OFFSET)
@@ -97,6 +98,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define SOC_COHERENCY_FABRIC_CFG_REG		(MV_COHERENCY_FABRIC_REGS_BASE + 0x4)
 #define SOC_CIB_CTRL_CFG_REG			(MV_COHERENCY_FABRIC_REGS_BASE + 0x80)
 
+
 #define Fabric_Units_Priority_Control_REG	(MV_MBUS_REGS_OFFSET + 0x424)
 #define Fabric_Units_Prefetch_Control_REG	(MV_MBUS_REGS_OFFSET + 0x42c)
 #define CPUs_Data_PFen (0xf << 8)
@@ -111,6 +113,9 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define PCIE0_QUADX1_EN				(1<<7)
 #define PCIE1_QUADX1_EN				(1<<8)
 
+/* IP Configuration registers */
+#define USB_CLUSTER_CONTROL			(MV_IP_CONFIG_REGS_BASE)
+
 /* ARM Configuration register */
 /* CPU_CONFIG_REG (CCR) */
 
diff --git a/arch/arm/mach-avantalp/config/mvSysUsbConfig.h b/arch/arm/mach-avantalp/config/mvSysUsbConfig.h
index 4600193..174f949 100644
--- a/arch/arm/mach-avantalp/config/mvSysUsbConfig.h
+++ b/arch/arm/mach-avantalp/config/mvSysUsbConfig.h
@@ -21,3 +21,4 @@ disclaimer.
 #include "mvSysHwConfig.h"
 
 #define MV_USB_REGS_BASE(unit)		MV_USB_REGS_OFFSET(unit)
+#define MV_USB3_REGS_BASE(unit)		MV_USB3_REGS_OFFSET(unit)
diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index 641b905..1dcd64a 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -499,6 +499,16 @@ void __init alp_sdio_init(void)
 	}
 #endif
 }
+/*******************************************************************************
+ * USB
+ */
+
+void __init alp_usb_init(void)
+{
+#ifdef CONFIG_MV_INCLUDE_USB
+	mv_usb_init(&alp_mbus_dram_info);
+#endif
+}
 
 /*******************************************************************************
  * GBE
@@ -1425,6 +1435,7 @@ static void __init alp_board_init(void)
 
 	alp_eth_init();
 	alp_spi_init();
+	alp_usb_init();
 
 #if 0
 	alp_gpio_init();
diff --git a/arch/arm/mach-avantalp/core.h b/arch/arm/mach-avantalp/core.h
index b0bc781..0b49b9f 100644
--- a/arch/arm/mach-avantalp/core.h
+++ b/arch/arm/mach-avantalp/core.h
@@ -5,3 +5,4 @@
  */
 
 void alp_irq_init(void);
+void __init mv_usb_init(struct mbus_dram_target_info *dram);
diff --git a/arch/arm/mach-avantalp/include/mach/avantalp.h b/arch/arm/mach-avantalp/include/mach/avantalp.h
index d422649..1c7473e 100644
--- a/arch/arm/mach-avantalp/include/mach/avantalp.h
+++ b/arch/arm/mach-avantalp/include/mach/avantalp.h
@@ -81,6 +81,9 @@
 
 #define IOCC_WA_WIN0_PHYS_BASE		0xFF000000
 
+#define USB3_REGS_PHYS_BASE		0xFF100000
+#define USB3_REGS_SIZE			_128K
+
 /*
  * Virtual address map
  */
@@ -92,6 +95,8 @@
 
 #define IOCC_WA_WIN0_VIRT_BASE		0xFBE00000
 
+#define USB3_REGS_VIRT_BASE		0xFBF00000
+
 #define UART_VIRT_BASE			0xFC600000
 
 #define DEVICE_BOOTCS_VIRT_BASE		0xFC700000
diff --git a/arch/arm/mach-avantalp/include/mach/irqs.h b/arch/arm/mach-avantalp/include/mach/irqs.h
index 9e675dd..e0e698e 100644
--- a/arch/arm/mach-avantalp/include/mach/irqs.h
+++ b/arch/arm/mach-avantalp/include/mach/irqs.h
@@ -40,8 +40,8 @@
 #define IRQ_GLOBAL_UART0		44
 #define IRQ_GLOBAL_UART1		45
 
-#define IRQ_GLOBAL_USB0			48
-#define IRQ_GLOBAL_USB1			49
+#define IRQ_GLOBAL_USB3_IP		48
+#define IRQ_GLOBAL_USB2_IP		49
 
 #define IRQ_GLOBAL_CESA0		51
 #define IRQ_GLOBAL_CESA1		52
diff --git a/arch/arm/mach-avantalp/sysmap.c b/arch/arm/mach-avantalp/sysmap.c
index 60cd217..000e443 100644
--- a/arch/arm/mach-avantalp/sysmap.c
+++ b/arch/arm/mach-avantalp/sysmap.c
@@ -58,6 +58,7 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6660[] = {
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* SPI_CS7 */
 	{{BOOTROM_PHYS_BASE,		0,	BOOTROM_SIZE		},	9,			DIS},	/* BOOTROM */
 	{{DEVICE_BOOTCS_PHYS_BASE,	0,	DEVICE_BOOTCS_SIZE	},	10,			DIS},	/* DEV_BOOCS */
+	{{USB3_REGS_PHYS_BASE,		0,	USB3_REGS_SIZE		},	11,			EN},	/* USB3 */
 	{{CRYPT_ENG_PHYS_BASE(0),	0,	CRYPT_ENG_SIZE		},	12,			EN},	/* CRYPT_ENG */
 	{{PP2_CPU0_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 */
 #ifdef CONFIG_SMP
@@ -94,6 +95,7 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6650[] = {
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* SPI_CS7 */
 	{{BOOTROM_PHYS_BASE,		0,	BOOTROM_SIZE		},	9,			DIS},	/* BOOTROM */
 	{{DEVICE_BOOTCS_PHYS_BASE,	0,	DEVICE_BOOTCS_SIZE	},	10,			DIS},	/* DEV_BOOCS */
+	{{TBL_UNUSED,			0,	TBL_UNUSED		},	TBL_UNUSED,		DIS},	/* USB3 */
 	{{CRYPT_ENG_PHYS_BASE(0),	0,	CRYPT_ENG_SIZE		},	12,			EN},	/* CRYPT_ENG */
 	{{PP2_CPU0_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 */
 #ifdef CONFIG_SMP
@@ -130,6 +132,7 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6610[] = {
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* SPI_CS7 */
 	{{BOOTROM_PHYS_BASE,		0,	BOOTROM_SIZE		},	9,			DIS},	/* BOOTROM */
 	{{DEVICE_BOOTCS_PHYS_BASE,	0,	DEVICE_BOOTCS_SIZE	},	10,			DIS},	/* DEV_BOOCS */
+	{{TBL_UNUSED,			0,	TBL_UNUSED		},	TBL_UNUSED,		DIS},	/* USB3 */
 	{{CRYPT_ENG_PHYS_BASE(0),	0,	CRYPT_ENG_SIZE		},	12,			EN},	/* CRYPT_ENG */
 	{{PP2_CPU0_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 */
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2 */
diff --git a/arch/arm/mach-avantalp/usb.c b/arch/arm/mach-avantalp/usb.c
index 8e48c60..2521cd3 100644
--- a/arch/arm/mach-avantalp/usb.c
+++ b/arch/arm/mach-avantalp/usb.c
@@ -35,6 +35,8 @@
 #include <linux/spinlock.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
+#include <linux/mbus.h>
+
 
 #include <asm/io.h>
 #include <asm/irq.h>
@@ -50,7 +52,7 @@
 u32 mvIsUsbHost = 0x03;
 
 #define MV_USB_DMA_MASK         0xffffffff
-#define MAX_USB_PORTS           3
+#define MAX_USB_PORTS           1
 
 static char usb_dev_name[]  = "mv_udc";
 static char usb_host_name[] = "ehci_marvell";
@@ -68,43 +70,19 @@ static void mv_usb_release(struct device *dev)
 	kfree(pdev);
 }
 
-int mv_usb_resume(int dev)
-{
-	int status, isHost;
-	char *name_ptr;
-
-	if (MV_FALSE == mvCtrlPwrClckGet(USB_UNIT_ID, dev)) {
-		printk(KERN_DEBUG "\nWarning Integrated USB %d is Powered Off\n", dev);
-		return -EINVAL;
-	}
-
-	/* Check if this USB is mapped to this AMP group - YY */
-	if (MV_FALSE == mvUnitMapIsMine(USB0 + dev))
-		return -EINVAL;
-
-	isHost = mvIsUsbHost & (1 << dev);
-	name_ptr = isHost ? usb_host_name : usb_dev_name;
-
-	printk(KERN_DEBUG "registered dev#%d as a %s\n", dev, name_ptr);
-	status = mvSysUsbInit(dev, isHost);
-
-	return status;
-}
-
-static int __init   mv_usb_init(void)
+static int __init mv_usb2_init(void)
 {
 	int status, dev, num, isHost;
 	char*                   name_ptr;
 	struct platform_device* mv_usb_dev_ptr;
-	int irq_num[3] = { IRQ_AURORA_USB0,
-			   IRQ_AURORA_USB1,
-			   IRQ_AURORA_USB2 };
+	int irq_num[1] = { IRQ_GLOBAL_USB2_IP };
 
-	num = mvCtrlUsbMaxGet();
+	num = 1;
+	/*num = mvCtrlUsbMaxGet();
 	if (num > MAX_USB_PORTS) {
 		printk("WARNING: Limited USB ports number to %d\n", MAX_USB_PORTS);
 		num = MAX_USB_PORTS;
-	}
+	}*/
 
 	for (dev = 0; dev < num; dev++) {
 		if (MV_FALSE == mvCtrlPwrClckGet(USB_UNIT_ID, dev)) {
@@ -177,4 +155,133 @@ static int __init   mv_usb_init(void)
 	return 0;
 }
 
-subsys_initcall(mv_usb_init);
+
+#define USB3_WIN_CTRL(w)	(0x0 + ((w) * 8))
+#define USB3_WIN_BASE(w)	(0x4 + ((w) * 8))
+#define USB3_MAX_WINDOWS	4
+#define USB3_XHCI_REGS_SIZE	_64K
+
+static u64 mv_usb3_dmamask = 0xffffffffUL;
+static struct resource mv_usb3_resources[] = {
+	[0] = {
+		.start	= USB3_REGS_PHYS_BASE,
+		.end	= USB3_REGS_PHYS_BASE + USB3_XHCI_REGS_SIZE - 1,
+		.flags	= IORESOURCE_MEM,
+	},
+
+	[1] = {
+		.start	= IRQ_GLOBAL_USB3_IP,
+		.end	= IRQ_GLOBAL_USB3_IP,
+		.flags	= IORESOURCE_IRQ,
+	},
+};
+
+
+static void __init mv_usb3_conf_mbus_windows(void __iomem *base,
+			const struct mbus_dram_target_info *dram)
+{
+	int win;
+
+	/* Clear all existing windows */
+	for (win = 0; win < USB3_MAX_WINDOWS; win++) {
+		writel(0, base + USB3_WIN_CTRL(win));
+		writel(0, base + USB3_WIN_BASE(win));
+	}
+
+	/* Program each DRAM CS in a seperate window */
+	for (win = 0; win < dram->num_cs; win++) {
+		const struct mbus_dram_window *cs = dram->cs + win;
+
+		writel(((cs->size - 1) & 0xffff0000) | (cs->mbus_attr << 8) |
+		       (dram->mbus_dram_target_id << 4) | 1,
+		       base + USB3_WIN_CTRL(win));
+
+		writel((cs->base & 0xffff0000), base + USB3_WIN_BASE(win));
+	}
+}
+
+void __init mv_usb3_init(struct mbus_dram_target_info *dram)
+{
+	int ret = -ENOMEM;
+	struct platform_device	*xhci;
+	u8 __iomem *usb_mac_regs;
+	int reg, mask;
+
+	if (MV_FALSE == mvCtrlPwrClckGet(USB_UNIT_ID, 0)) {
+		pr_warn("Warning: Integrated USB3 is Powered Off\n");
+		return;
+	}
+
+	if (MV_FALSE == mvUnitMapIsMine(USB0))
+		return;
+
+	/* Allocate an XHCI device */
+	xhci = platform_device_alloc("xhci-hcd", -1);
+	if (!xhci) {
+		pr_err("Couldn't allocate XHCI device\n");
+		goto err0;
+	}
+
+	/* Setup XHCI resources */
+	ret = platform_device_add_resources(xhci, mv_usb3_resources,
+			ARRAY_SIZE(mv_usb3_resources));
+	if (ret) {
+		pr_err("Couldn't add resources to XHCI device\n");
+		goto err1;
+	}
+
+	dma_set_coherent_mask(&xhci->dev, 0xffffffff);
+	xhci->dev.dma_mask = &mv_usb3_dmamask;
+
+	/* Map the DDR address space to the XHCI */
+	mv_usb3_conf_mbus_windows((void *)(INTER_REGS_VIRT_BASE +
+				MV_USB3_REGS_BASE(0)), dram);
+
+#ifdef CONFIG_AVANTA_LP_Z1_USB3_LFPS_FREQ_WA
+/*
+ * All defines below are used for a temporary workaround and therefore
+ * are placed inside the code and not in an include file
+ */
+#define USB3_MAC_REGS_BASE		(0x10000)
+#define USB3_MAC_REGS_SIZE		(0x500)
+#define USB3_CNTR_PULSE_WIDTH_OFFSET	(0x454)
+#define REF_CLK_100NS_OFFSET		(24)
+#define REF_CLK_100NS_MASK		(0xFF)
+
+	/* Modify the LFPS timing to fix clock issues on ALP-Z1 */
+	usb_mac_regs = (u8 *)ioremap_nocache(USB3_REGS_PHYS_BASE +
+			USB3_MAC_REGS_BASE, USB3_MAC_REGS_SIZE);
+	if (!usb_mac_regs) {
+		pr_err("Failed to map USB3 MAC registers\n");
+		goto err1;
+	}
+
+	reg = readl(usb_mac_regs + USB3_CNTR_PULSE_WIDTH_OFFSET);
+	mask = ~(REF_CLK_100NS_MASK << REF_CLK_100NS_OFFSET);
+	reg = (reg & mask) | (0x10 << REF_CLK_100NS_OFFSET);
+	writel(reg, usb_mac_regs + USB3_CNTR_PULSE_WIDTH_OFFSET);
+#endif
+
+	/* Register the device */
+	ret = platform_device_add(xhci);
+	if (ret) {
+		pr_err("Failed to register xHCI device\n");
+		goto err1;
+	}
+
+	pr_info("USB3 XHCI Device registered successfully\n");
+	return;
+
+err1:
+	platform_device_put(xhci);
+err0:
+	return;
+}
+
+void __init mv_usb_init(struct mbus_dram_target_info *dram)
+{
+	/* Select the new USB3 IP */
+	writel(1, INTER_REGS_VIRT_BASE + USB_CLUSTER_CONTROL);
+
+	mv_usb3_init(dram);
+}
diff --git a/arch/arm/plat-armada/Kconfig b/arch/arm/plat-armada/Kconfig
index 8578fbb..89d8a87 100644
--- a/arch/arm/plat-armada/Kconfig
+++ b/arch/arm/plat-armada/Kconfig
@@ -76,6 +76,7 @@ config MV_INCLUDE_USB
 	bool "USB Support"
 	depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP || ARMADA_370 || AVANTA_LP
 	default y
+	select USB_XHCI_PLATFORM if AVANTA_LP
         help
         Please don't change this configs unless you know what you are doing.
 
diff --git a/drivers/usb/host/Makefile b/drivers/usb/host/Makefile
index 0982bcc..7e023b5 100644
--- a/drivers/usb/host/Makefile
+++ b/drivers/usb/host/Makefile
@@ -15,9 +15,7 @@ xhci-hcd-y := xhci.o xhci-mem.o
 xhci-hcd-y += xhci-ring.o xhci-hub.o xhci-dbg.o
 xhci-hcd-$(CONFIG_PCI)	+= xhci-pci.o
 
-ifneq ($(CONFIG_USB_XHCI_PLATFORM), )
-	xhci-hcd-y		+= xhci-plat.o
-endif
+xhci-hcd-$(CONFIG_USB_XHCI_PLATFORM) += xhci-plat.o
 
 obj-$(CONFIG_USB_WHCI_HCD)	+= whci/
 
-- 
1.7.5.4

