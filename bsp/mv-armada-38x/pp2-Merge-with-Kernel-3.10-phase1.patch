From 627e6abde08120875eb31e08732d647fda165b5f Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Tue, 17 Dec 2013 16:11:01 -0500
Subject: [PATCH 1231/1825] pp2: Merge with Kernel 3.10 - phase1

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 9845da09b9604939015c3060ac66b03230fa5597

	- Includes and Makefile changes
	- Address decoding initialization changes

Change-Id: Iab4254e6cbf4f0bf42408e081866694c56be1ad2
Signed-off-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4760
Reviewed-by: Yelena Krivosheev <yelena@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Tested-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/mv_hal_if/mvSysEthPhy.c     |    2 +-
 .../arm/plat-armada/mv_drivers_lsp/mv_mux/Makefile |   14 +++-
 .../mv_drivers_lsp/mv_mux/mv_mux_netdev.c          |   28 ++++--
 .../mv_drivers_lsp/mv_mux/mv_mux_sysfs.c           |    2 +-
 .../mv_drivers_lsp/mv_mux/mv_mux_tool.h            |    6 +-
 .../arm/plat-armada/mv_drivers_lsp/mv_pp2/Makefile |   50 ++++++++---
 .../mv_drivers_lsp/mv_pp2/cls/cls2_sysfs.c         |    3 +-
 .../mv_drivers_lsp/mv_pp2/cls/cls3_sysfs.c         |    3 +-
 .../mv_drivers_lsp/mv_pp2/cls/cls4_sysfs.c         |    3 +-
 .../mv_drivers_lsp/mv_pp2/cls/cls_mc_sysfs.c       |    3 +-
 .../mv_drivers_lsp/mv_pp2/cls/cls_sysfs.c          |    3 +-
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c    |   63 ++++++--------
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c    |    9 +--
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |   92 +++++++++++++------
 .../mv_drivers_lsp/mv_pp2/prs/prs_high_sysfs.c     |    5 +-
 .../mv_drivers_lsp/mv_pp2/prs/prs_low_sysfs.c      |    5 +-
 .../mv_drivers_lsp/mv_switch/mv_switch.c           |    2 +-
 arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.c          |    1 -
 arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.h          |    2 +-
 arch/arm/plat-armada/mv_hal/pp2/bm/mvBmRegs.h      |    1 -
 .../plat-armada/mv_hal/pp2/common/mvPp2Common.h    |    6 ++
 arch/arm/plat-armada/mv_hal/pp2/dpi/mvPp2DpiHw.c   |    4 +-
 arch/arm/plat-armada/mv_hal/pp2/dpi/mvPp2DpiHw.h   |    4 +-
 arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c     |    4 +-
 arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h     |   10 +-
 .../arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c |    2 +-
 arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h |    5 +-
 .../arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c |    2 +-
 .../plat-armada/mv_hal/pp2/gmac/mvEthGmacRegs.h    |    5 +-
 arch/arm/plat-armada/mv_hal/pp2/plcr/mvPp2PlcrHw.c |    4 +-
 arch/arm/plat-armada/mv_hal/pp2/prs/mvPp2Prs.c     |    3 +-
 arch/arm/plat-armada/mv_hal/pp2/wol/mvPp2Wol.c     |    4 +-
 arch/arm/plat-armada/mv_hal/pp2/wol/mvPp2Wol.h     |    2 +-
 33 files changed, 212 insertions(+), 140 deletions(-)

diff --git a/arch/arm/mach-avantalp/mv_hal_if/mvSysEthPhy.c b/arch/arm/mach-avantalp/mv_hal_if/mvSysEthPhy.c
index 3899830..2d360ed 100644
--- a/arch/arm/mach-avantalp/mv_hal_if/mvSysEthPhy.c
+++ b/arch/arm/mach-avantalp/mv_hal_if/mvSysEthPhy.c
@@ -68,7 +68,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "ctrlEnv/mvCtrlEnvSpec.h"
 #include "boardEnv/mvBoardEnvLib.h"
 #include "eth-phy/mvEthPhy.h"
-#include "pp2/gbe/mvPp2GbeRegs.h"
+#include "pp2/gmac/mvEthGmacRegs.h"
 
 /*******************************************************************************
 * mvSysEthPhyInit - Initialize the EthPhy subsystem
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/Makefile
index 4423f1e..d6e38b4 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/Makefile
@@ -1,8 +1,20 @@
 #
-# Makefile for the Marvell Key
+# Makefile for the Marvell Virtual Netwrok interfaces library
 #
+
+
+ifeq ($(CONFIG_ARCH_MVEBU),y)
+
+ccflags-y       += $(MVEBU_NET_FLAGS)
+ccflags-y       += $(INCLUDE_DIRS)
+
+else
+
 ifneq ($(MACHINE),)
 include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
+endif # CONFIG_ARCH_MVEBU
+
+
 obj-y	+= mv_mux_netdev.o mv_mux_sysfs.o mv_mux_tool.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_netdev.c
index 7fd585f..25c74d1 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_netdev.c
@@ -26,11 +26,19 @@ disclaimer.
 *******************************************************************************/
 
 #include "mvCommon.h"
-#include "mvDebug.h"
-#include "mv_mux_netdev.h"
-#include "mv_switch/mv_switch.h"
 #include <linux/platform_device.h>
 #include <linux/module.h>
+
+#ifdef CONFIG_ARCH_MVEBU
+#include "mvNetConfig.h"
+#else
+#include "ctrlEnv/mvCtrlEnvSpec.h"
+#endif
+
+#include "mvDebug.h"
+#include "mv_switch.h"
+
+#include "mv_mux_netdev.h"
 #include "mv_mux_tool.h"
 
 static struct notifier_block mux_notifier_block __read_mostly;
@@ -289,7 +297,8 @@ int mv_mux_rx(struct sk_buff *skb, int port, struct napi_struct *napi)
 #ifdef CONFIG_MV_ETH_DEBUG_CODE
 	if (mux_eth_shadow[port].flags & MV_MUX_F_DBG_RX) {
 		struct mux_netdev *pmux_priv = MV_MUX_PRIV(mux_dev);
-		printk(KERN_ERR "\n%s - %s: port=%d, cpu=%d\n", mux_dev->name, __func__, pmux_priv->port, smp_processor_id());
+		pr_err("\n%s - %s: port=%d, cpu=%d\n",
+			mux_dev->name, __func__, pmux_priv->port, smp_processor_id());
 		/* mv_eth_skb_print(skb); */
 		mvDebugMemDump(skb->data, 64, 1);
 	}
@@ -340,8 +349,9 @@ static int mv_mux_xmit(struct sk_buff *skb, struct net_device *dev)
 
 #ifdef CONFIG_MV_ETH_DEBUG_CODE
 	if (mux_eth_shadow[pmux_priv->port].flags & MV_MUX_F_DBG_TX) {
-		printk(KERN_ERR "\n%s - %s_%lu: port=%d, cpu=%d, in_intr=0x%lx\n",
-			dev->name, __func__, dev->stats.tx_packets, pmux_priv->port, smp_processor_id(), in_interrupt());
+		pr_err("\n%s - %s_%lu: port=%d, cpu=%d, in_intr=0x%lx\n",
+			dev->name, __func__, dev->stats.tx_packets, pmux_priv->port,
+			smp_processor_id(), in_interrupt());
 		/* mv_eth_skb_print(skb); */
 		mvDebugMemDump(skb->data, 64, 1);
 	}
@@ -1372,12 +1382,14 @@ void mv_mux_netdev_print(struct net_device *mux_dev)
 
 	case MV_TAG_TYPE_VLAN:
 		printk(KERN_ERR "%s: port=%d, pdev=%p, tx_vlan=0x%08x, rx_vlan=0x%08x, rx_mask=0x%08x\n",
-			mux_dev->name, pdev->port, pdev, pdev->tx_tag.vlan, pdev->rx_tag_ptrn.vlan, pdev->rx_tag_mask.vlan);
+			mux_dev->name, pdev->port, pdev, pdev->tx_tag.vlan,
+			pdev->rx_tag_ptrn.vlan, pdev->rx_tag_mask.vlan);
 		break;
 
 	case MV_TAG_TYPE_DSA:
 		printk(KERN_ERR "%s: port=%d, pdev=%p: tx_dsa=0x%08x, rx_dsa=0x%08x, rx_mask=0x%08x\n",
-			mux_dev->name, pdev->port, pdev, pdev->tx_tag.dsa, pdev->rx_tag_ptrn.dsa, pdev->rx_tag_mask.dsa);
+			mux_dev->name, pdev->port, pdev, pdev->tx_tag.dsa,
+			pdev->rx_tag_ptrn.dsa, pdev->rx_tag_mask.dsa);
 		break;
 
 	case MV_TAG_TYPE_MH:
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_sysfs.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_sysfs.c
index 716683d..b204196 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_sysfs.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_sysfs.c
@@ -231,7 +231,7 @@ static struct attribute_group mv_mux_group = {
 	.attrs = mv_mux_attrs,
 };
 
-int __devinit mv_mux_sysfs_init(void)
+int __init mv_mux_sysfs_init(void)
 {
 	int err;
 	struct device *pd;
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_tool.h b/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_tool.h
index c278949..35f5dad 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_tool.h
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_tool.h
@@ -29,10 +29,12 @@ disclaimer.
 
 #include <linux/version.h>
 #include <linux/ethtool.h>
-#include "mv_mux_netdev.h"
-#include "mv_switch/mv_switch.h"
 #include <linux/netdevice.h>
 
+#include "mv_switch.h"
+
+#include "mv_mux_netdev.h"
+
 extern struct  mv_mux_eth_port mux_eth_shadow[];
 
 #endif
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/Makefile
index 894b133..c3d4907 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/Makefile
@@ -2,25 +2,26 @@
 # Makefile for the Marvell Gigabit Ethernet driver
 #
 
-ifneq ($(MACHINE),)
-include $(srctree)/$(MACHINE)/config/mvRules.mk
+ifeq ($(CONFIG_ARCH_MVEBU),y)
+PP2_HAL_DIR = hal
+else
+PP2_HAL_DIR = ../../mv_hal/pp2
 endif
 
-PP2_DIR       = ../../mv_hal/pp2
-PP2_GMAC_DIR  = ../../mv_hal/pp2/gmac
-PP2_GBE_DIR   = ../../mv_hal/pp2/gbe
-PP2_BM_DIR    = ../../mv_hal/pp2/bm
-PP2_PRS_DIR   = ../../mv_hal/pp2/prs
-PP2_CLS_DIR   = ../../mv_hal/pp2/cls
-PP2_PME_DIR   = ../../mv_hal/pp2/pme
-PP2_PLCR_DIR  = ../../mv_hal/pp2/plcr
-PP2_WOL_DIR   = ../../mv_hal/pp2/wol
-PP2_DPI_DIR   = ../../mv_hal/pp2/dpi
-PP2_COMMON_DIR= ../../mv_hal/pp2/common
+PP2_GMAC_DIR  = $(PP2_HAL_DIR)/gmac
+PP2_GBE_DIR   = $(PP2_HAL_DIR)/gbe
+PP2_BM_DIR    = $(PP2_HAL_DIR)/bm
+PP2_PRS_DIR   = $(PP2_HAL_DIR)/prs
+PP2_CLS_DIR   = $(PP2_HAL_DIR)/cls
+PP2_PME_DIR   = $(PP2_HAL_DIR)/pme
+PP2_PLCR_DIR  = $(PP2_HAL_DIR)/plcr
+PP2_WOL_DIR   = $(PP2_HAL_DIR)/wol
+PP2_DPI_DIR   = $(PP2_HAL_DIR)/dpi
+PP2_COMMON_DIR= $(PP2_HAL_DIR)/common
 
 mv_pp2-objs +=	$(PP2_GMAC_DIR)/mvEthGmacApi.o
-mv_pp2-objs +=	$(PP2_GBE_DIR)/mvPp2Gbe.o $(PP2_GBE_DIR)/mvPp2GbeDebug.o \
-		$(PP2_GBE_DIR)/mvPp2AddrDec.o
+mv_pp2-objs +=	$(PP2_GBE_DIR)/mvPp2Gbe.o $(PP2_GBE_DIR)/mvPp2GbeDebug.o
+#mv_pp2-objs +=  $(PP2_GBE_DIR)/mvPp2AddrDec.o
 mv_pp2-objs +=	$(PP2_BM_DIR)/mvBm.o
 mv_pp2-objs += 	$(PP2_PRS_DIR)/mvPp2PrsHw.o $(PP2_PRS_DIR)/mvPp2Prs.o
 mv_pp2-objs += 	$(PP2_CLS_DIR)/mvPp2ClsHw.o $(PP2_CLS_DIR)/mvPp2Cls2Hw.o \
@@ -53,7 +54,26 @@ ifeq ($(CONFIG_MV_ETH_L2FW),y)
 mv_pp2-objs += l2fw/l2fw_sysfs.o l2fw/mv_eth_l2fw.o
 endif
 
+ifeq ($(CONFIG_ARCH_MVEBU),y)
+
+ccflags-y       += $(MVEBU_NET_FLAGS)
+
+ccflags-y	+= $(INCLUDE_DIRS)
+
+ccflags-y       += -I$(PLAT_DIR)/pp2
+ccflags-y       += -I$(PLAT_DIR)/pp2/hal
+
+else
+
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
+endif
+
 ccflags-y       += -I$(PLAT_PATH_I)/$(HAL_PP2_DIR)
+ccflags-y       += -I$(PLAT_PATH_I)/$(HAL_ETHPHY_DIR)
+ccflags-y       += -I$(PLAT_PATH_I)/$(LSP_MUX_DIR)
+endif
+
 ifeq ($(NETMAP),y)
 ccflags-y       += -DCONFIG_NETMAP -I$(NETMAP_DIR) -I$(NETMAP_DIR)/../sys
 endif
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls2_sysfs.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls2_sysfs.c
index 8e89a53..92dd447 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls2_sysfs.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls2_sysfs.c
@@ -33,8 +33,7 @@ disclaimer.
 #include <linux/platform_device.h>
 #include "mvOs.h"
 #include "mvCommon.h"
-#include "ctrlEnv/mvCtrlEnvLib.h"
-#include "../../../mv_hal/pp2/cls/mvPp2Cls2Hw.h"
+#include "cls/mvPp2Cls2Hw.h"
 
 
 static MV_PP2_CLS_C2_QOS_ENTRY		qos_entry;
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls3_sysfs.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls3_sysfs.c
index 1a4a9be..7bd7f4c 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls3_sysfs.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls3_sysfs.c
@@ -33,8 +33,7 @@ disclaimer.
 #include <linux/platform_device.h>
 #include "mvOs.h"
 #include "mvCommon.h"
-#include "ctrlEnv/mvCtrlEnvLib.h"
-#include "../../../mv_hal/pp2/cls/mvPp2Cls3Hw.h"
+#include "cls/mvPp2Cls3Hw.h"
 
 static MV_PP2_CLS_C3_ENTRY		c3;
 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls4_sysfs.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls4_sysfs.c
index c8c424a..6dfdabc 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls4_sysfs.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls4_sysfs.c
@@ -33,8 +33,7 @@ disclaimer.
 #include <linux/platform_device.h>
 #include "mvOs.h"
 #include "mvCommon.h"
-#include "ctrlEnv/mvCtrlEnvLib.h"
-#include "../../../mv_hal/pp2/cls/mvPp2Cls4Hw.h"
+#include "cls/mvPp2Cls4Hw.h"
 
 
 static MV_PP2_CLS_C4_ENTRY		C4;
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls_mc_sysfs.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls_mc_sysfs.c
index 822db04..dac0334 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls_mc_sysfs.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls_mc_sysfs.c
@@ -33,8 +33,7 @@ disclaimer.
 #include <linux/platform_device.h>
 #include "mvOs.h"
 #include "mvCommon.h"
-#include "ctrlEnv/mvCtrlEnvLib.h"
-#include "../../../mv_hal/pp2/cls/mvPp2ClsMcHw.h"
+#include "cls/mvPp2ClsMcHw.h"
 
 
 static MV_PP2_MC_ENTRY		mc;
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls_sysfs.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls_sysfs.c
index 8df0801..f674dcd 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls_sysfs.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cls/cls_sysfs.c
@@ -33,8 +33,7 @@ disclaimer.
 #include <linux/platform_device.h>
 #include "mvOs.h"
 #include "mvCommon.h"
-#include "ctrlEnv/mvCtrlEnvLib.h"
-#include "../../../mv_hal/pp2/cls/mvPp2ClsHw.h"
+#include "cls/mvPp2ClsHw.h"
 
 static MV_PP2_CLS_LKP_ENTRY	lkp_entry;
 static MV_PP2_CLS_FLOW_ENTRY	flow_entry;
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c
index c228bea..0828c3e 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c
@@ -38,12 +38,7 @@ disclaimer.
 
 #include "mvOs.h"
 #include "mvDebug.h"
-#include "dbg-trace.h"
-#include "mvSysHwConfig.h"
-#include "boardEnv/mvBoardEnvLib.h"
-#include "ctrlEnv/mvCtrlEnvLib.h"
-#include "eth-phy/mvEthPhy.h"
-#include "mvSysEthPhyApi.h"
+#include "mvEthPhy.h"
 #include "gmac/mvEthGmacApi.h"
 
 #include "gbe/mvPp2Gbe.h"
@@ -51,8 +46,6 @@ disclaimer.
 
 #include "mv_netdev.h"
 
-#include "mvOs.h"
-#include "mvSysHwConfig.h"
 #include "prs/mvPp2Prs.h"
 
 #define MV_ETH_TOOL_AN_TIMEOUT	5000
@@ -73,7 +66,7 @@ int mv_eth_tool_get_settings(struct net_device *netdev, struct ethtool_cmd *cmd)
 {
 	struct eth_port 	*priv = MV_ETH_PRIV(netdev);
 	u16			lp_ad, stat1000;
-	MV_U32			mv_phy_addr;
+	MV_U32			phy_addr;
 	MV_ETH_PORT_SPEED 	speed;
 	MV_ETH_PORT_DUPLEX 	duplex;
 	MV_ETH_PORT_STATUS      status;
@@ -87,7 +80,7 @@ int mv_eth_tool_get_settings(struct net_device *netdev, struct ethtool_cmd *cmd)
 			| SUPPORTED_100baseT_Full | SUPPORTED_Autoneg | SUPPORTED_TP | SUPPORTED_MII
 			| SUPPORTED_1000baseT_Full);
 
-	mv_phy_addr = mvBoardPhyAddrGet(priv->port);
+	phy_addr = priv->plat_data->phy_addr;
 
 	mvGmacLinkStatus(priv->port, &status);
 
@@ -116,16 +109,16 @@ int mv_eth_tool_get_settings(struct net_device *netdev, struct ethtool_cmd *cmd)
 	}
 
 	cmd->port = PORT_MII;
-	cmd->phy_address = mv_phy_addr;
+	cmd->phy_address = phy_addr;
 	cmd->transceiver = XCVR_INTERNAL;
 	/* check if speed and duplex are AN */
 	mvGmacSpeedDuplexGet(priv->port, &speed, &duplex);
 	if (speed == MV_ETH_SPEED_AN && duplex == MV_ETH_DUPLEX_AN) {
 		cmd->lp_advertising = cmd->advertising = 0;
 		cmd->autoneg = AUTONEG_ENABLE;
-		mvEthPhyAdvertiseGet(mv_phy_addr, (MV_U16 *)&(cmd->advertising));
+		mvEthPhyAdvertiseGet(phy_addr, (MV_U16 *)&(cmd->advertising));
 
-		mvEthPhyRegRead(mv_phy_addr, MII_LPA, &lp_ad);
+		mvEthPhyRegRead(phy_addr, MII_LPA, &lp_ad);
 		if (lp_ad & LPA_LPACK)
 			cmd->lp_advertising |= ADVERTISED_Autoneg;
 		if (lp_ad & ADVERTISE_10HALF)
@@ -137,7 +130,7 @@ int mv_eth_tool_get_settings(struct net_device *netdev, struct ethtool_cmd *cmd)
 		if (lp_ad & ADVERTISE_100FULL)
 			cmd->lp_advertising |= ADVERTISED_100baseT_Full;
 
-		mvEthPhyRegRead(mv_phy_addr, MII_STAT1000, &stat1000);
+		mvEthPhyRegRead(phy_addr, MII_STAT1000, &stat1000);
 		if (stat1000 & LPA_1000HALF)
 			cmd->lp_advertising |= ADVERTISED_1000baseT_Half;
 		if (stat1000 & LPA_1000FULL)
@@ -164,10 +157,10 @@ int mv_eth_tool_get_settings(struct net_device *netdev, struct ethtool_cmd *cmd)
 int mv_eth_tool_restore_settings(struct net_device *netdev)
 {
 	struct eth_port 	*priv = MV_ETH_PRIV(netdev);
-	int 				mv_phy_speed, mv_phy_duplex;
-	MV_U32			    mv_phy_addr = mvBoardPhyAddrGet(priv->port);
-	MV_ETH_PORT_SPEED	mv_mac_speed;
-	MV_ETH_PORT_DUPLEX	mv_mac_duplex;
+	int			phy_speed, phy_duplex;
+	MV_U32			phy_addr = priv->plat_data->phy_addr;
+	MV_ETH_PORT_SPEED	mac_speed;
+	MV_ETH_PORT_DUPLEX	mac_duplex;
 	int			err = -EINVAL;
 
 	 if (priv == NULL)
@@ -175,16 +168,16 @@ int mv_eth_tool_restore_settings(struct net_device *netdev)
 
 	switch (priv->speed_cfg) {
 	case SPEED_10:
-		mv_phy_speed  = 0;
-		mv_mac_speed = MV_ETH_SPEED_10;
+		phy_speed  = 0;
+		mac_speed = MV_ETH_SPEED_10;
 		break;
 	case SPEED_100:
-		mv_phy_speed  = 1;
-		mv_mac_speed = MV_ETH_SPEED_100;
+		phy_speed  = 1;
+		mac_speed = MV_ETH_SPEED_100;
 		break;
 	case SPEED_1000:
-		mv_phy_speed  = 2;
-		mv_mac_speed = MV_ETH_SPEED_1000;
+		phy_speed  = 2;
+		mac_speed = MV_ETH_SPEED_1000;
 		break;
 	default:
 		return -EINVAL;
@@ -192,12 +185,12 @@ int mv_eth_tool_restore_settings(struct net_device *netdev)
 
 	switch (priv->duplex_cfg) {
 	case DUPLEX_HALF:
-		mv_phy_duplex = 0;
-		mv_mac_duplex = MV_ETH_DUPLEX_HALF;
+		phy_duplex = 0;
+		mac_duplex = MV_ETH_DUPLEX_HALF;
 		break;
 	case DUPLEX_FULL:
-		mv_phy_duplex = 1;
-		mv_mac_duplex = MV_ETH_DUPLEX_FULL;
+		phy_duplex = 1;
+		mac_duplex = MV_ETH_DUPLEX_FULL;
 		break;
 	default:
 		return -EINVAL;
@@ -206,10 +199,10 @@ int mv_eth_tool_restore_settings(struct net_device *netdev)
 	if (priv->autoneg_cfg == AUTONEG_ENABLE) {
 		err = mvGmacSpeedDuplexSet(priv->port, MV_ETH_SPEED_AN, MV_ETH_DUPLEX_AN);
 		if (!err)
-			err = mvEthPhyAdvertiseSet(mv_phy_addr, priv->advertise_cfg);
+			err = mvEthPhyAdvertiseSet(phy_addr, priv->advertise_cfg);
 		/* Restart AN on PHY enables it */
 		if (!err) {
-			err = mvEthPhyRestartAN(mv_phy_addr, MV_ETH_TOOL_AN_TIMEOUT);
+			err = mvEthPhyRestartAN(phy_addr, MV_ETH_TOOL_AN_TIMEOUT);
 			if (err == MV_TIMEOUT) {
 				MV_ETH_PORT_STATUS ps;
 
@@ -220,9 +213,9 @@ int mv_eth_tool_restore_settings(struct net_device *netdev)
 			}
 		}
 	} else if (priv->autoneg_cfg == AUTONEG_DISABLE) {
-		err = mvEthPhyDisableAN(mv_phy_addr, mv_phy_speed, mv_phy_duplex);
+		err = mvEthPhyDisableAN(phy_addr, phy_speed, phy_duplex);
 		if (!err)
-			err = mvGmacSpeedDuplexSet(priv->port, mv_mac_speed, mv_mac_duplex);
+			err = mvGmacSpeedDuplexSet(priv->port, mac_speed, mac_duplex);
 	} else {
 		err = -EINVAL;
 	}
@@ -352,7 +345,7 @@ void mv_eth_tool_get_regs(struct net_device *netdev,
 
 	memset(p, 0, MV_ETH_TOOL_REGS_LEN * sizeof(uint32_t));
 
-	regs->version = mvCtrlModelRevGet();
+	regs->version = priv->plat_data->ctrl_rev;
 
 	/* ETH port registers */
 	/* TODO read ETH registers into p - reference at NETA */
@@ -382,7 +375,7 @@ int mv_eth_tool_nway_reset(struct net_device *netdev)
 		return -EOPNOTSUPP;
 	}
 
-	phy_addr = mvBoardPhyAddrGet(priv->port);
+	phy_addr = priv->plat_data->phy_addr;
 	if (mvEthPhyRestartAN(phy_addr, MV_ETH_TOOL_AN_TIMEOUT) != MV_OK)
 		return -EINVAL;
 
@@ -693,7 +686,7 @@ int mv_eth_tool_set_pauseparam(struct net_device *netdev,
 	}
 	/* Only symmetric change for RX and TX flow control is allowed */
 	if (status == MV_OK) {
-		phy_addr = mvBoardPhyAddrGet(priv->port);
+		phy_addr = priv->plat_data->phy_addr;
 		status = mvEthPhyRestartAN(phy_addr, MV_ETH_TOOL_AN_TIMEOUT);
 	}
 	if (status != MV_OK)
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c
index 24a8ce0..8b2efbd 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c
@@ -35,11 +35,8 @@ disclaimer.
 #include <linux/interrupt.h>
 
 #include "mvOs.h"
-#include "dbg-trace.h"
-#include "mvSysHwConfig.h"
-#include "boardEnv/mvBoardEnvLib.h"
 
-#include "eth-phy/mvEthPhy.h"
+#include "mvEthPhy.h"
 #include "gbe/mvPp2Gbe.h"
 #include "prs/mvPp2Prs.h"
 #include "cls/mvPp2ClsHw.h"
@@ -89,7 +86,7 @@ int mv_eth_start(struct net_device *dev)
 
 	if (priv->flags & MV_ETH_F_CONNECT_LINUX) {
 		/* connect to port interrupt line */
-		if (request_irq(dev->irq, mv_eth_isr, (IRQF_DISABLED|IRQF_SAMPLE_RANDOM), "mv_eth", priv)) {
+		if (request_irq(dev->irq, mv_eth_isr, (IRQF_DISABLED), "mv_eth", priv)) {
 			printk(KERN_ERR "cannot request irq %d for %s port %d\n", dev->irq, dev->name, priv->port);
 			for (group = 0; group < MV_ETH_MAX_RXQ; group++)
 				if (priv->napi_group[group] && priv->napi_group[group]->napi)
@@ -98,7 +95,7 @@ int mv_eth_start(struct net_device *dev)
 		}
 
 		/* unmask interrupts */
-		on_each_cpu(mv_eth_interrupts_unmask, priv, 1);
+		on_each_cpu(mv_eth_interrupts_unmask, (void *)priv, 1);
 
 		/* Enable interrupts for all CPUs */
 		mvPp2GbeCpuInterruptsEnable(priv->port, priv->cpuMask);
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index c92267a..ba5f759 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -33,6 +33,7 @@ disclaimer.
 #include <linux/platform_device.h>
 #include <linux/skbuff.h>
 #include <linux/module.h>
+#include <linux/mbus.h>
 #include <linux/inetdevice.h>
 #include <linux/interrupt.h>
 #include <linux/mv_pp2.h>
@@ -42,17 +43,14 @@ disclaimer.
 
 #include "mvOs.h"
 #include "mvDebug.h"
-#include "dbg-trace.h"
-#include "mvSysHwConfig.h"
-#include "ctrlEnv/mvCtrlEnvLib.h"
-#include "eth-phy/mvEthPhy.h"
+#include "mvEthPhy.h"
 
 #include "gbe/mvPp2Gbe.h"
 #include "prs/mvPp2Prs.h"
 #include "prs/mvPp2PrsHw.h"
 #include "cls/mvPp2Classifier.h"
 
-#include "mv_mux/mv_mux_netdev.h"
+#include "mv_mux_netdev.h"
 #include "mv_netdev.h"
 #include "mv_eth_tool.h"
 #include "mv_eth_sysfs.h"
@@ -2482,7 +2480,7 @@ static void mv_eth_rxq_drop_pkts(struct eth_port *pp, int rxq)
 
 static int mv_eth_txq_done_force(struct eth_port *pp, struct tx_queue *txq_ctrl)
 {
-	int cpu, tx_done;
+	int cpu, tx_done = 0;
 	struct txq_cpu_ctrl *txq_cpu_ptr;
 
 	for_each_possible_cpu(cpu) {
@@ -2504,7 +2502,6 @@ inline u32 mv_eth_tx_done_pon(struct eth_port *pp, int *tx_todo)
 	int txp, txq;
 	struct tx_queue *txq_ctrl;
 	struct txq_cpu_ctrl *txq_cpu_ptr;
-
 	u32 tx_done = 0;
 
 	*tx_todo = 0;
@@ -3495,40 +3492,77 @@ void    mv_eth_hal_shared_init(struct mv_pp2_pdata *plat_data)
  * mv_eth_win_init --                                      *
  *   Win initilization                                     *
  ***********************************************************/
-void	mv_eth_win_init(void)
+void mv_eth_win_init(void)
 {
-	MV_UNIT_WIN_INFO *addrWinMap;
-	MV_STATUS status;
+	const struct mbus_dram_target_info *dram;
 	int i;
+	u32 enable;
 
-	addrWinMap = kmalloc(sizeof(MV_UNIT_WIN_INFO) * (MAX_TARGETS + 1), GFP_KERNEL);
-	if (addrWinMap == NULL)
-		return;
+	/* First disable all address decode windows */
+	enable = 0;
+	mvPp2WrReg(ETH_BASE_ADDR_ENABLE_REG, enable);
 
-	memset(addrWinMap, 0, sizeof(MV_UNIT_WIN_INFO) * (MAX_TARGETS + 1));
-	status = mvCtrlAddrWinMapBuild(addrWinMap, MAX_TARGETS + 1);
-	if (status != MV_OK) {
-		kfree(addrWinMap);
+	dram = mv_mbus_dram_info();
+	if (!dram) {
+		pr_err("%s: No DRAM information\n", __func__);
 		return;
 	}
-	for (i = 0; i < MAX_TARGETS; i++) {
-		if (addrWinMap[i].enable == MV_FALSE)
-			continue;
+	for (i = 0; i < dram->num_cs; i++) {
+		const struct mbus_dram_window *cs = dram->cs + i;
+		u32 baseReg, base = cs->base;
+		u32 sizeReg, size = cs->size;
+		u32 alignment;
+		u8 attr = cs->mbus_attr;
+		u8 target = dram->mbus_dram_target_id;
+
+		/* check if address is aligned to the size */
+		if (MV_IS_NOT_ALIGN(base, size)) {
+			pr_err("%s: Error setting window for cs #%d.\n"
+			   "Address 0x%08x is not aligned to size 0x%x.\n",
+			   __func__, i, base, size);
+			return;
+		}
+
+		if (!MV_IS_POWER_OF_2(size)) {
+			pr_err("%s: Error setting window for cs #%d.\n"
+				"Window size %u is not a power to 2.\n",
+				__func__, i, size);
+			return;
+		}
 
 #ifdef CONFIG_MV_SUPPORT_L2_DEPOSIT
 		/* Setting DRAM windows attribute to :
-		   0x3 - Shared transaction + L2 write allocate (L2 Deposit) */
-		if (MV_TARGET_IS_DRAM(i)) {
-			addrWinMap[i].attrib &= ~(0x30);
-			addrWinMap[i].attrib |= 0x30;
-		}
+			0x3 - Shared transaction + L2 write allocate (L2 Deposit) */
+		attr &= ~(0x30);
+		attr |= 0x30;
 #endif
+
+		baseReg = (base & ETH_WIN_BASE_MASK);
+		sizeReg = mvPp2RdReg(ETH_WIN_SIZE_REG(i));
+
+		/* set size */
+		alignment = 1 << ETH_WIN_SIZE_OFFS;
+		sizeReg &= ~ETH_WIN_SIZE_MASK;
+		sizeReg |= (((size / alignment) - 1) << ETH_WIN_SIZE_OFFS);
+
+		/* set attributes */
+		baseReg &= ~ETH_WIN_ATTR_MASK;
+		baseReg |= attr << ETH_WIN_ATTR_OFFS;
+
+		/* set target ID */
+		baseReg &= ~ETH_WIN_TARGET_MASK;
+		baseReg |= target << ETH_WIN_TARGET_OFFS;
+
+		mvPp2WrReg(ETH_WIN_BASE_REG(i), baseReg);
+		mvPp2WrReg(ETH_WIN_SIZE_REG(i), sizeReg);
+
+		enable |= (1 << i);
 	}
-	mvPp2WinInit(0, addrWinMap);
-	kfree(addrWinMap);
-	return;
+	/* Enable window */
+	mvPp2WrReg(ETH_BASE_ADDR_ENABLE_REG, enable);
 }
 
+
 /***********************************************************
  * mv_eth_port_suspend                                     *
  *   main driver initialization. loading the interfaces.   *
@@ -3671,7 +3705,7 @@ static int	mv_eth_shared_probe(struct mv_pp2_pdata *plat_data)
 	tasklet_init(&link_tasklet, mv_eth_link_tasklet, 0);
 
 	/* request IRQ for link interrupts from GOP */
-	if (request_irq(IRQ_GLOBAL_GOP, mv_eth_link_isr, (IRQF_DISABLED|IRQF_SAMPLE_RANDOM), "mv_eth_link", NULL))
+	if (request_irq(IRQ_GLOBAL_GOP, mv_eth_link_isr, (IRQF_DISABLED), "mv_eth_link", NULL))
 		printk(KERN_ERR "%s: Could not request IRQ for GOP interrupts\n", __func__);
 
 	mvGmacIsrSummaryUnmask();
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/prs/prs_high_sysfs.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/prs/prs_high_sysfs.c
index 1a45b74..c75e4b9 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/prs/prs_high_sysfs.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/prs/prs_high_sysfs.c
@@ -33,9 +33,8 @@ disclaimer.
 #include <linux/platform_device.h>
 #include "mvOs.h"
 #include "mvCommon.h"
-#include "ctrlEnv/mvCtrlEnvLib.h"
-#include "pp2/prs/mvPp2PrsHw.h"
-#include "pp2/prs/mvPp2Prs.h"
+#include "prs/mvPp2PrsHw.h"
+#include "prs/mvPp2Prs.h"
 
 
 static ssize_t mv_prs_high_help(char *b)
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/prs/prs_low_sysfs.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/prs/prs_low_sysfs.c
index 9ea2845..d1412c7 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/prs/prs_low_sysfs.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/prs/prs_low_sysfs.c
@@ -33,9 +33,8 @@ disclaimer.
 #include <linux/platform_device.h>
 #include "mvOs.h"
 #include "mvCommon.h"
-#include "ctrlEnv/mvCtrlEnvLib.h"
-#include "pp2/prs/mvPp2PrsHw.h"
-#include "pp2/prs/mvPp2Prs.h"
+#include "prs/mvPp2PrsHw.h"
+#include "prs/mvPp2Prs.h"
 
 
 static  MV_PP2_PRS_ENTRY pe;
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/mv_switch.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/mv_switch.c
index ebe674b..7031a21 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/mv_switch.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/mv_switch.c
@@ -648,7 +648,7 @@ int mv_switch_load(struct mv_switch_pdata *plat_data)
 	qd_cfg.BSPFunctions.semDelete = NULL;
 	qd_cfg.BSPFunctions.semTake = NULL;
 	qd_cfg.BSPFunctions.semGive = NULL;
-	qd_cfg.initPorts = GT_TRUE;
+	qd_cfg.initPorts = GT_FALSE;
 	qd_cfg.cpuPortNum = plat_data->switch_cpu_port;
 	if (plat_data->smi_scan_mode == 1) {
 		qd_cfg.mode.baseAddr = 0;
diff --git a/arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.c b/arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.c
index 7e3a187..e9b3073 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.c
@@ -68,7 +68,6 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "mvDebug.h"
 #include "mvCommon.h"
 #include "mvOs.h"
-#include "mvSysEthConfig.h"
 
 #include "mvBm.h"
 
diff --git a/arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.h b/arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.h
index ab6782c..7ccf7d2 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.h
@@ -71,7 +71,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "mvStack.h"
 #include "mvList.h"
 #include "mv802_3.h"
-#include "pp2/common/mvPp2Common.h"
+#include "common/mvPp2Common.h"
 #include "mvBmRegs.h"
 
 typedef struct {
diff --git a/arch/arm/plat-armada/mv_hal/pp2/bm/mvBmRegs.h b/arch/arm/plat-armada/mv_hal/pp2/bm/mvBmRegs.h
index c4f614d..2dc53f3 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/bm/mvBmRegs.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/bm/mvBmRegs.h
@@ -66,7 +66,6 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #ifndef __mvBmRegs_h__
 #define __mvBmRegs_h__
 
-#include "pp2/gbe/mvPp2GbeRegs.h"
 
 #ifdef __cplusplus
 extern "C" {
diff --git a/arch/arm/plat-armada/mv_hal/pp2/common/mvPp2Common.h b/arch/arm/plat-armada/mv_hal/pp2/common/mvPp2Common.h
index fd4a204..cad7f62 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/common/mvPp2Common.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/common/mvPp2Common.h
@@ -68,6 +68,12 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "mvCommon.h"
 #include "mvOs.h"
 
+#ifdef CONFIG_ARCH_MVEBU
+#include "mvNetConfig.h"
+#else
+#include "mvSysEthConfig.h"
+#endif
+
 /*--------------------------------------------------------------------*/
 /*			PP2 COMMON MACROS			      */
 /*--------------------------------------------------------------------*/
diff --git a/arch/arm/plat-armada/mv_hal/pp2/dpi/mvPp2DpiHw.c b/arch/arm/plat-armada/mv_hal/pp2/dpi/mvPp2DpiHw.c
index 8c65cc8..a227429 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/dpi/mvPp2DpiHw.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/dpi/mvPp2DpiHw.c
@@ -67,8 +67,8 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "mvDebug.h"
 #include "mvOs.h"
 
-#include "pp2/common/mvPp2Common.h"
-#include "pp2/gbe/mvPp2Gbe.h"
+#include "common/mvPp2Common.h"
+#include "gbe/mvPp2Gbe.h"
 #include "mvPp2DpiHw.h"
 
 MV_PP2_QUEUE_CTRL *mvPp2DpiReqQ;
diff --git a/arch/arm/plat-armada/mv_hal/pp2/dpi/mvPp2DpiHw.h b/arch/arm/plat-armada/mv_hal/pp2/dpi/mvPp2DpiHw.h
index b7e079f..279e769 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/dpi/mvPp2DpiHw.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/dpi/mvPp2DpiHw.h
@@ -73,8 +73,8 @@ extern "C" {
 #include "mvCommon.h"
 #include "mvOs.h"
 
-#include "pp2/common/mvPp2Common.h"
-#include "pp2/gbe/mvPp2Gbe.h"
+#include "common/mvPp2Common.h"
+#include "gbe/mvPp2Gbe.h"
 
 #define MV_PP2_DPI_CNTRS		16
 #define MV_PP2_DPI_MAX_PKT_SIZE		1024
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c
index 279907d..bcb57e9 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c
@@ -69,8 +69,8 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "mvOs.h"
 
 #include "mvPp2Gbe.h"
-#include "pp2/prs/mvPp2Prs.h"
-#include "pp2/bm/mvBm.h"
+#include "prs/mvPp2Prs.h"
+#include "bm/mvBm.h"
 
 #define MV_PP2_RXQ_FREE 	-1
 
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h
index 4706444..6bba4be 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h
@@ -69,12 +69,12 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "mvCommon.h"
 #include "mv802_3.h"
 #include "mvOs.h"
-#include "mvSysEthConfig.h"
+
 #include "mvPp2GbeRegs.h"
-#include "pp2/bm/mvBm.h"
-#include "pp2/gmac/mvEthGmacApi.h"
-#include "pp2/common/mvPp2Common.h"
-#include "pp2/prs/mvPp2PrsHw.h"
+#include "bm/mvBm.h"
+#include "gmac/mvEthGmacApi.h"
+#include "common/mvPp2Common.h"
+#include "prs/mvPp2PrsHw.h"
 
 #define PP2_CPU_CODE_IS_RX_SPECIAL(cpu_code)		((cpu_code) & RI_CPU_CODE_RX_SPEC_VAL)
 
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c
index 548eeed..8fe62ec 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c
@@ -69,7 +69,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "mvOs.h"
 
 #include "mvPp2Gbe.h"
-#include "pp2/bm/mvBm.h"
+#include "bm/mvBm.h"
 
 #include "mvPp2GbeRegs.h"
 
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h
index e3e2c75..da5c00b 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h
@@ -65,8 +65,11 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #ifndef __MV_PP2_GBE_REGS_H__
 #define __MV_PP2_GBE_REGS_H__
 
+#ifdef CONFIG_ARCH_MVEBU
+#include "mvNetConfig.h"
+#else
 #include "mvSysEthConfig.h"
-#include "pp2/gmac/mvEthGmacApi.h"
+#endif
 
 /************************** PPv2 HW Configuration ***********************/
 
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
index 2f6bae3..d60b5ace 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
@@ -62,7 +62,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 
 *******************************************************************************/
 #include "mvEthGmacApi.h"
-#include "pp2/gbe/mvPp2Gbe.h"
+#include "gbe/mvPp2Gbe.h"
 
 void mvGmacPortEnable(int port)
 {
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacRegs.h b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacRegs.h
index 42177c1..1fc18ee 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacRegs.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacRegs.h
@@ -65,8 +65,11 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #ifndef __mvEthGmacRegs_h__
 #define __mvEthGmacRegs_h__
 
+#ifdef CONFIG_ARCH_MVEBU
+#include "mvNetConfig.h"
+#else
 #include "mvSysEthConfig.h"
-#include "ctrlEnv/mvCtrlEnvLib.h"
+#endif
 
 #define ETH_MNG_EXTENDED_GLOBAL_CTRL_REG   (GOP_MNG_REG_BASE + 0x5c)
 
diff --git a/arch/arm/plat-armada/mv_hal/pp2/plcr/mvPp2PlcrHw.c b/arch/arm/plat-armada/mv_hal/pp2/plcr/mvPp2PlcrHw.c
index 0b2a3e3..9ff31f8 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/plcr/mvPp2PlcrHw.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/plcr/mvPp2PlcrHw.c
@@ -67,8 +67,8 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "mvDebug.h"
 #include "mvOs.h"
 
-#include "pp2/common/mvPp2Common.h"
-#include "pp2/gbe/mvPp2Gbe.h"
+#include "common/mvPp2Common.h"
+#include "gbe/mvPp2Gbe.h"
 #include "mvPp2PlcrHw.h"
 
 
diff --git a/arch/arm/plat-armada/mv_hal/pp2/prs/mvPp2Prs.c b/arch/arm/plat-armada/mv_hal/pp2/prs/mvPp2Prs.c
index e4ef63d..51f01b2 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/prs/mvPp2Prs.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/prs/mvPp2Prs.c
@@ -64,9 +64,8 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "mvOs.h"
 #include "mvCommon.h"
 #include "mv802_3.h"
-#include "ctrlEnv/mvCtrlEnvLib.h"
 #include "mvPp2Prs.h"
-#include "pp2/gbe/mvPp2Gbe.h"
+#include "gbe/mvPp2Gbe.h"
 #include "mvPp2PrsHw.h"
 
 #define PRS_DBG(X...)
diff --git a/arch/arm/plat-armada/mv_hal/pp2/wol/mvPp2Wol.c b/arch/arm/plat-armada/mv_hal/pp2/wol/mvPp2Wol.c
index 2eb3cfe..b3302bd 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/wol/mvPp2Wol.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/wol/mvPp2Wol.c
@@ -67,8 +67,8 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "mvDebug.h"
 #include "mvOs.h"
 
-#include "pp2/common/mvPp2Common.h"
-#include "pp2/gbe/mvPp2Gbe.h"
+#include "common/mvPp2Common.h"
+#include "gbe/mvPp2Gbe.h"
 #include "mvPp2Wol.h"
 
 
diff --git a/arch/arm/plat-armada/mv_hal/pp2/wol/mvPp2Wol.h b/arch/arm/plat-armada/mv_hal/pp2/wol/mvPp2Wol.h
index a82315b..6f439aa 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/wol/mvPp2Wol.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/wol/mvPp2Wol.h
@@ -69,7 +69,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 extern "C" {
 #endif /* __cplusplus */
 
-#include "pp2/gbe/mvPp2Gbe.h"
+#include "gbe/mvPp2Gbe.h"
 
 /*********************************** RX Policer Registers *******************/
 
-- 
1.7.5.4

