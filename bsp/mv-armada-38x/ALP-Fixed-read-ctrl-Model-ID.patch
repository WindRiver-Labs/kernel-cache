From 5cdd018f33611434d26c04abd01839b6fbe0c1d2 Mon Sep 17 00:00:00 2001
From: Eli Nidam <elini@marvell.com>
Date: Tue, 21 May 2013 18:51:06 +0300
Subject: [PATCH 0667/1825] ALP: Fixed read ctrl Model ID

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 7e88f49ec66cc7cd8063f7a9cc426acc90bb6eda

Change-Id: I8207ee484e601af5fca9c1d9263aac5454a34d0c
Signed-off-by: Eli Nidam <elini@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/1916
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   23 ++++++++-----------
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h       |    3 ++
 2 files changed, 13 insertions(+), 13 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index fa4012d..a357ab6 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -1051,25 +1051,22 @@ MV_U32 mvCtrlTdmUnitIrqGet(MV_VOID)
 *******************************************************************************/
 MV_U16 mvCtrlModelGet(MV_VOID)
 {
-	MV_U32 ctrlId;
-
 #ifdef CONFIG_MACH_AVANTA_LP_FPGA
-	ctrlId = MV_88F66X0;
+	return MV_88F66X0;
 #else
+	MV_U32 ctrlId, satr0;
+
 	ctrlId = MV_REG_READ(DEV_ID_REG);
 	ctrlId = (ctrlId & (DEVICE_ID_MASK)) >> DEVICE_ID_OFFS;
-#endif
-	switch (ctrlId) {
-	case 0x6660:
+	if (ctrlId == 0x6660)
 		return MV_6660_DEV_ID;
-	case 0x6650:
+
+	satr0 = MV_REG_READ(MPP_SAMPLE_AT_RESET(0));
+	satr0 &= SATR_DEVICE_ID_2_0_MASK;
+	if (satr0 == 0)
 		return MV_6650_DEV_ID;
-	case 0x6610:
-		return MV_6610_DEV_ID;
-	default:
-		mvOsOutput("mvCtrlModelGet: error read ctrl mode (0x%x)\n",ctrlId);
-		return 0;
-	}
+	return MV_6610_DEV_ID;
+#endif
 }
 
 /*******************************************************************************
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
index 6cc8d90..791c837 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
@@ -125,6 +125,9 @@ extern "C" {
 
 /* Sample at Reset */
 #define MPP_SAMPLE_AT_RESET(id)		(0xE8200 + ( id * 0x4 ))
+#define SATR_DEVICE_ID_2_0_OFFS		21
+#define SATR_DEVICE_ID_2_0_MASK		(3 << SATR_DEVICE_ID_2_0_OFFS)
+
 #define DEV_ID_REG			0x18238
 #define VENDOR_ID_OFFS			0
 #define VENDOR_ID_MASK			0xFFFF
-- 
1.7.5.4

