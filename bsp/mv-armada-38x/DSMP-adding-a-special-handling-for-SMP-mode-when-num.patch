From 0752f0c0b8b473cc4ce90f1cf105c791d618db34 Mon Sep 17 00:00:00 2001
From: Tawfik Bayouk <tawfik@marvell.com>
Date: Tue, 21 Aug 2012 17:33:39 +0300
Subject: [PATCH 0063/1825] DSMP adding a special handling for SMP mode when
 number of cores is set not to be 4 at sample of
 reser

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 72045c72435ce9b9f143f18930274e83be84267e

Change-Id: I25751ccc2436888366b3b3b46cfe1f322bae0e42
Signed-off-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-armadaxp/platsmp.c |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-armadaxp/platsmp.c b/arch/arm/mach-armadaxp/platsmp.c
index 3774e4f..1e431e4 100644
--- a/arch/arm/mach-armadaxp/platsmp.c
+++ b/arch/arm/mach-armadaxp/platsmp.c
@@ -47,6 +47,13 @@ static inline void axp_smp_cross_call(const struct cpumask *mask, unsigned int i
         return;
 }
 
+
+static inline unsigned int get_sample_at_reset_core_count(void)
+{
+	/* Read the number of availabe CPUs in the SoC */
+	return ((MV_REG_READ(SOC_COHERENCY_FABRIC_CFG_REG) & 0xF) + 1);
+}
+
 /*
  * control for which core is the next to come out of the secondary
  * boot "holding pen"
@@ -342,6 +349,9 @@ void __init platform_smp_prepare_cpus(unsigned int max_cpus)
 		ncores = (NR_CPUS - master_cpu_id);
 	}
 
+	if(ncores > get_sample_at_reset_core_count())
+		ncores=get_sample_at_reset_core_count();
+
 	/* Adjust core count in case fixing was done */
 	set_core_count(ncores);
 
-- 
1.7.5.4

