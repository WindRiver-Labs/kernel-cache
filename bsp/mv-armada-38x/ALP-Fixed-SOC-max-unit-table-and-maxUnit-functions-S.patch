From d768b7d8fc54df9d6d872654247c9e31c0c830ac Mon Sep 17 00:00:00 2001
From: Eli Nidam <elini@marvell.com>
Date: Sun, 19 May 2013 14:20:22 +0300
Subject: [PATCH 0662/1825] ALP: Fixed SOC max unit table and maxUnit
 functions (SATA USB ...)

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit f3f1f295ab69b9ff2846ae62b4a47a74ee3ecb43

Change-Id: Ia4869e52d864ee5f50bf7729f1cabc8119520b71
Signed-off-by: Eli Nidam <elini@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/1854
Reviewed-by: Star_Automation <star@marvell.com>
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   97 +++++++++++++++++---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |    2 +-
 2 files changed, 86 insertions(+), 13 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 99bf51b..abf4c5c 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -193,9 +193,9 @@ MV_UNIT_ID mvCtrlSocUnitNums[MAX_UNITS_ID][MV_66xx_INDEX_MAX] = {
 /* ETH_GIG_UNIT_ID      */ { 2,                 2,              2, },
 /* USB_UNIT_ID          */ { 1,                 1,              0, },
 /* IDMA_UNIT_ID         */ { 0,                 0,              0, },
-/* XOR_UNIT_ID          */ { 2,                 2,              0, },
+/* XOR_UNIT_ID          */ { 2,                 0,              0, },
 /* SATA_UNIT_ID         */ { 2,                 0,              0, },
-/* TDM_32CH_UNIT_ID     */ { 1,                 1,              1, },
+/* TDM_UNIT_ID		*/ { 1,                 1,              1, },
 /* UART_UNIT_ID         */ { 2,                 2,              2, },
 /* CESA_UNIT_ID         */ { 1,                 0,              0, },
 /* SPI_UNIT_ID          */ { 2,                 2,              2, },
@@ -834,7 +834,7 @@ MV_U8 mvCtrlEthMaxCPUsGet(MV_VOID)
 *******************************************************************************/
 MV_U32 mvCtrlSataMaxPortGet(MV_VOID)
 {
-	return 0;
+	return mvCtrlSocUnitInfoNumGet(SATA_UNIT_ID);
 }
 
 #endif
@@ -858,7 +858,7 @@ MV_U32 mvCtrlSataMaxPortGet(MV_VOID)
 *******************************************************************************/
 MV_U32 mvCtrlXorMaxChanGet(MV_VOID)
 {
-	return 0;
+	return mvCtrlSocUnitInfoNumGet(XOR_UNIT_ID);
 }
 
 /*******************************************************************************
@@ -879,7 +879,7 @@ MV_U32 mvCtrlXorMaxChanGet(MV_VOID)
 *******************************************************************************/
 MV_U32 mvCtrlXorMaxUnitGet(MV_VOID)
 {
-	return 0;
+	return mvCtrlSocUnitInfoNumGet(XOR_UNIT_ID);
 }
 
 #endif
@@ -902,7 +902,7 @@ MV_U32 mvCtrlXorMaxUnitGet(MV_VOID)
 *******************************************************************************/
 MV_U32 mvCtrlUsbMaxGet(void)
 {
-	return 0;
+	return mvCtrlSocUnitInfoNumGet(USB_UNIT_ID);
 }
 
 #endif
@@ -925,7 +925,7 @@ MV_U32 mvCtrlUsbMaxGet(void)
 *******************************************************************************/
 MV_U32 mvCtrlSdioSupport(MV_VOID)
 {
-	return 0; /* kostaz: what's that ??? */
+	return mvCtrlSocUnitInfoNumGet(SDIO_UNIT_ID) ? MV_TRUE : MV_FALSE;
 }
 
 #endif
@@ -947,7 +947,7 @@ MV_U32 mvCtrlSdioSupport(MV_VOID)
 *******************************************************************************/
 MV_U32 mvCtrlTdmSupport(MV_VOID)
 {
-	return 0; /* kostaz: what's that ??? */
+	return mvCtrlSocUnitInfoNumGet(TDM_UNIT_ID) ? MV_TRUE : MV_FALSE;
 }
 
 /*******************************************************************************
@@ -967,7 +967,7 @@ MV_U32 mvCtrlTdmSupport(MV_VOID)
 *******************************************************************************/
 MV_U32 mvCtrlTdmMaxGet(MV_VOID)
 {
-	return 0; /* kostaz: what's that ??? */
+	return mvCtrlSocUnitInfoNumGet(TDM_UNIT_ID);
 }
 
 /*******************************************************************************
@@ -1192,7 +1192,80 @@ const MV_8 *mvCtrlTargetNameGet(MV_TARGET target)
 #if defined(MV_INCLUDE_PEX)
 static MV_VOID mvCtrlPexAddrDecShow(MV_VOID)
 {
-	/* TBD */
+	MV_PEX_BAR pexBar;
+	MV_PEX_DEC_WIN win;
+	MV_U32 pexIf;
+	MV_U32 bar, winNum;
+	MV_BOARD_PEX_INFO *boardPexInfo = mvBoardPexInfoGet();
+	MV_U32 pexHWInf = 0;
+
+	for (pexIf = 0; pexIf < boardPexInfo->boardPexIfNum; pexIf++) {
+		pexHWInf = pexIf;
+
+
+		if (MV_FALSE == mvCtrlPwrClckGet(PEX_UNIT_ID, pexHWInf))
+			continue;
+		mvOsOutput("\n");
+		mvOsOutput("PEX%d:\n", pexHWInf);
+		mvOsOutput("-----\n");
+
+		mvOsOutput("\nPex Bars\n\n");
+
+		for (bar = 0; bar < PEX_MAX_BARS; bar++) {
+			memset(&pexBar, 0, sizeof(MV_PEX_BAR));
+
+			mvOsOutput("%s ", pexBarNameGet(bar));
+
+			if (mvPexBarGet(pexHWInf, bar, &pexBar) == MV_OK) {
+				if (pexBar.enable) {
+					mvOsOutput("base %08x, ", pexBar.addrWin.baseLow);
+					if (pexBar.addrWin.size == 0)
+						mvOsOutput("size %3dGB ", 4);
+					else
+						mvSizePrint(pexBar.addrWin.size);
+					mvOsOutput("\n");
+				} else
+					mvOsOutput("disable\n");
+			}
+		}
+		mvOsOutput("\nPex Decode Windows\n\n");
+
+		for (winNum = 0; winNum < PEX_MAX_TARGET_WIN - 2; winNum++) {
+			memset(&win, 0, sizeof(MV_PEX_DEC_WIN));
+
+			mvOsOutput("win%d - ", winNum);
+
+			if (mvPexTargetWinRead(pexHWInf, winNum, &win) == MV_OK) {
+				if (win.winInfo.enable) {
+					mvOsOutput("%s base %08x, ",
+						   mvCtrlTargetNameGet(mvCtrlTargetByWinInfoGet(&win.winInfo)),
+						   win.winInfo.addrWin.baseLow);
+					mvOsOutput("....");
+					mvSizePrint(win.winInfo.addrWin.size);
+
+					mvOsOutput("\n");
+				} else
+					mvOsOutput("disable\n");
+			}
+		}
+
+		memset(&win, 0, sizeof(MV_PEX_DEC_WIN));
+
+		mvOsOutput("default win - ");
+
+		if (mvPexTargetWinRead(pexHWInf, MV_PEX_WIN_DEFAULT, &win) == MV_OK) {
+			mvOsOutput("%s ", mvCtrlTargetNameGet(win.target));
+			mvOsOutput("\n");
+		}
+		memset(&win, 0, sizeof(MV_PEX_DEC_WIN));
+
+		mvOsOutput("Expansion ROM - ");
+
+		if (mvPexTargetWinRead(pexHWInf, MV_PEX_WIN_EXP_ROM, &win) == MV_OK) {
+			mvOsOutput("%s ", mvCtrlTargetNameGet(win.target));
+			mvOsOutput("\n");
+		}
+	}
 }
 
 #endif
@@ -1581,7 +1654,7 @@ MV_VOID mvCtrlPwrClckSet(MV_UNIT_ID unitId, MV_U32 index, MV_BOOL enable)
 
 		break;
 #endif
-	case TDM_32CH_UNIT_ID:
+	case TDM_UNIT_ID:
 		if (enable == MV_FALSE)
 			MV_REG_BIT_RESET(POWER_MNG_CTRL_REG, PMC_TDM_STOP_CLK_MASK);
 		else
@@ -1646,7 +1719,7 @@ MV_BOOL mvCtrlPwrClckGet(MV_UNIT_ID unitId, MV_U32 index)
 		break;
 #endif
 #if defined(MV_INCLUDE_TDM)
-	case TDM_32CH_UNIT_ID:
+	case TDM_UNIT_ID:
 		if ((reg & PMC_TDM_STOP_CLK_MASK) == PMC_TDM_STOP_CLK_STOP)
 			state = MV_FALSE;
 		else
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index fc05271..e7041c8 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -407,7 +407,7 @@ typedef enum _mvUnitId {
 	IDMA_UNIT_ID,
 	XOR_UNIT_ID,
 	SATA_UNIT_ID,
-	TDM_32CH_UNIT_ID,
+	TDM_UNIT_ID,
 	UART_UNIT_ID,
 	CESA_UNIT_ID,
 	SPI_UNIT_ID,
-- 
1.7.5.4

