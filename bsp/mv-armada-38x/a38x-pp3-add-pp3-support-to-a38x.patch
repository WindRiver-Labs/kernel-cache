From 1644b24aedcc98e46d83d499fb10fe28a099c4c4 Mon Sep 17 00:00:00 2001
From: Uri Eliyahu <uriel@marvell.com>
Date: Wed, 26 Feb 2014 21:04:29 +0200
Subject: [PATCH 1403/1825] a38x: pp3: add pp3 support to a38x

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 37009319f3606834abd1f6520e331c101717857b

	- relevant for NSS fpga rampup

Change-Id: Ibabe4b5fbc2f8e2777716a29d8ad3fa75b66799e
Signed-off-by: Uri Eliyahu <uriel@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5969
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yelena Krivosheev <yelena@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-armada38x/core.c                     |   68 +++++++++++++++++++-
 drivers/net/ethernet/marvell/pp3/common/mv_hw_if.h |    2 +-
 .../net/ethernet/marvell/pp3/net_dev/mv_netdev.c   |   15 +++--
 3 files changed, 77 insertions(+), 8 deletions(-)

diff --git a/arch/arm/mach-armada38x/core.c b/arch/arm/mach-armada38x/core.c
index 2e51986..5babc91 100644
--- a/arch/arm/mach-armada38x/core.c
+++ b/arch/arm/mach-armada38x/core.c
@@ -72,6 +72,11 @@
 #include <linux/mv_neta.h>
 #endif
 
+
+#if defined(CONFIG_MV_PP3) || defined(CONFIG_MV_PP3_MODULE)
+#include <linux/mv_pp3.h>
+#endif
+
 #if defined(CONFIG_MV_INCLUDE_CESA)
 #include "cesa/mvCesa.h"
 #endif
@@ -510,10 +515,66 @@ void __init a38x_usb_init(void)
 #endif
 }
 
+/*******************************************************************************
+ * PPv3 - support NSS FPGA
+ */
+
+#if defined(CONFIG_MV_PP3) || defined(CONFIG_MV_PP3_MODULE)
+
+static struct resource mv_pp3_ge0_resources[] = {
+	{
+		.start          = 128,
+		.end            = 151,
+		.flags          = IORESOURCE_IRQ,
+	},
+};
+
+
+static struct mv_pp3_port_data mv_pp3_ge0_port_data = {
+	.cpu_mask	= 0x3,
+	.mtu		= 1500,
+	.phy_addr	= 0,
+	.flags		= 0,
+	.group_rx_queue_count = 10,
+	.group_tx_queue_count = 10,
+	.rx_queue_size = 1024,
+	.tx_queue_size = 1024
+
+};
+
+static struct platform_device mv_pp3_ge0_plat = {
+	.name			= MV_PP3_PORT_NAME,
+	.id			= 0,
+	.num_resources		= ARRAY_SIZE(mv_pp3_ge0_resources),
+	.resource		= mv_pp3_ge0_resources,
+	.dev			= {
+		.platform_data	= &mv_pp3_ge0_port_data,
+	},
+};
+
+static struct mv_pp3_plat_data mv_pp3_ge0_shared_data = {
+	.max_port	= 4
+};
+
+static struct platform_device mv_pp3_shared_plat = {
+	.name			= MV_PP3_SHARED_NAME,
+	.dev			= {
+		.platform_data	= &mv_pp3_ge0_shared_data,
+	},
+
+};
+
+static void __init pp3_init(void)
+{
+	platform_device_register(&mv_pp3_shared_plat);
+	platform_device_register(&mv_pp3_ge0_plat);
+}
+#endif
+
 
 /*******************************************************************************
  * GBE
- */
+ *******************************************************************************/
 #ifdef CONFIG_MV_ETHERNET
 #if defined(CONFIG_MV_ETH_LEGACY)
 static struct platform_device mv88fx_eth = {
@@ -663,8 +724,13 @@ void __init a38x_init_eth(void)
 {
 #ifdef CONFIG_MV_ETHERNET
 	mvSysEthPhyInit();
+#ifdef CONFIG_MV_ETH_NETA
 	eth_init();
 #endif
+#ifdef CONFIG_MV_PP3
+	pp3_init();
+#endif
+#endif
 }
 
 /*******************************************************************************
diff --git a/drivers/net/ethernet/marvell/pp3/common/mv_hw_if.h b/drivers/net/ethernet/marvell/pp3/common/mv_hw_if.h
index 28e20cc..7395b5f 100644
--- a/drivers/net/ethernet/marvell/pp3/common/mv_hw_if.h
+++ b/drivers/net/ethernet/marvell/pp3/common/mv_hw_if.h
@@ -127,7 +127,7 @@ static INLINE void mv_pp3_hw_reg_write(u32 access_addr, u32 data)
 
 static INLINE u32 mv_hw_silicon_base_addr_get(void)
 {
-	return 0xb0000000;
+	return 0xe0000000;
 }
 
 #endif /* __mvHwIf_h__ */
diff --git a/drivers/net/ethernet/marvell/pp3/net_dev/mv_netdev.c b/drivers/net/ethernet/marvell/pp3/net_dev/mv_netdev.c
index a447747..308502b 100644
--- a/drivers/net/ethernet/marvell/pp3/net_dev/mv_netdev.c
+++ b/drivers/net/ethernet/marvell/pp3/net_dev/mv_netdev.c
@@ -464,12 +464,13 @@ static const struct net_device_ops mv_pp3_netdev_ops = {
 /*---------------------------------------------------------------------------*/
 struct net_device *mv_pp3_netdev_init(struct platform_device *pdev)
 {
-	struct mv_pp3_port_data *plat_data = (struct mv_pp3_port_data *)pdev->dev.platform_data;
+	struct mv_pp3_port_data *port_data = (struct mv_pp3_port_data *)pdev->dev.platform_data;
 	struct pp3_dev_priv *dev_priv;
 	struct net_device *dev;
 	struct resource *res;
-	int rxqs_num = plat_data->group_rx_queue_count * nr_cpu_ids;
-	int txqs_num = plat_data->group_tx_queue_count * nr_cpu_ids;
+
+	int rxqs_num = port_data->group_rx_queue_count * nr_cpu_ids;
+	int txqs_num = port_data->group_tx_queue_count * nr_cpu_ids;
 
 	/* tx_queue_count from core.c */
 	dev = alloc_etherdev_mqs(sizeof(struct pp3_dev_priv), txqs_num, rxqs_num);
@@ -481,10 +482,10 @@ struct net_device *mv_pp3_netdev_init(struct platform_device *pdev)
 	BUG_ON(!res);
 	dev->irq = res->start;
 
-	dev->mtu = plat_data->mtu;
-	memcpy(dev->dev_addr, plat_data->mac_addr, MV_MAC_ADDR_SIZE);
+	dev->mtu = port_data->mtu;
+	memcpy(dev->dev_addr, port_data->mac_addr, MV_MAC_ADDR_SIZE);
 
-	dev->tx_queue_len = plat_data->tx_queue_size;
+	dev->tx_queue_len = port_data->tx_queue_size;
 	dev->watchdog_timeo = 5 * HZ;
 
 	SET_NETDEV_DEV(dev, &pdev->dev);
@@ -845,6 +846,8 @@ static int mv_pp3_sw_shared_probe(struct platform_device *pdev)
 
 	struct mv_pp3_plat_data *plat_data = (struct mv_pp3_plat_data *)pdev->dev.platform_data;
 
+	pr_info("o pp3: init shared structures\n");
+
 	pp3_ports_num = plat_data->max_port;
 
 	pp3_sysfs_init();
-- 
1.7.5.4

