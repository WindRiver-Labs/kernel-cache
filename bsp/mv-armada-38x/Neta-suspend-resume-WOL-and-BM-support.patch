From 1e3b04a563dbdbc7393bb3c8a5935143f09b9d5d Mon Sep 17 00:00:00 2001
From: Uri Eliyahu <uriel@marvell.com>
Date: Wed, 16 Jan 2013 18:59:34 +0200
Subject: [PATCH 0463/1825] Neta suspend resume WOL and BM support

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 2a63946521436693c650ee748957f3b053c57c7b

Change-Id: Ic4e0270d00dbebbf838b4a648f16bd80476de1b1
Signed-off-by: Uri Eliyahu <uriel@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/mv_hal/neta/bm/mvBm.c |   19 ++++++++++++++-----
 arch/arm/plat-armada/mv_hal/neta/bm/mvBm.h |    1 +
 2 files changed, 15 insertions(+), 5 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/neta/bm/mvBm.c b/arch/arm/plat-armada/mv_hal/neta/bm/mvBm.c
index d7168bf..07bf3c0 100755
--- a/arch/arm/plat-armada/mv_hal/neta/bm/mvBm.c
+++ b/arch/arm/plat-armada/mv_hal/neta/bm/mvBm.c
@@ -78,10 +78,20 @@ static MV_BM_POOL	mvBmPools[MV_BM_POOLS];
 /* Initialize Hardware Buffer management unit */
 MV_STATUS mvBmInit(MV_U8 *virtBase)
 {
-	MV_U32 regVal;
 
 	mvBmVirtBase = virtBase;
 
+	mvBmRegsInit();
+
+	memset(mvBmPools, 0, sizeof(mvBmPools));
+
+	return MV_OK;
+}
+
+void mvBmRegsInit(void)
+{
+	MV_U32 regVal;
+
 	/* Mask BM all interrupts */
 	MV_REG_WRITE(MV_BM_INTR_MASK_REG, 0);
 
@@ -96,9 +106,7 @@ MV_STATUS mvBmInit(MV_U8 *virtBase)
 	regVal |= MV_BM_MAX_IN_BURST_SIZE_16BP;
 	MV_REG_WRITE(MV_BM_CONFIG_REG, regVal);
 
-	memset(mvBmPools, 0, sizeof(mvBmPools));
-
-	return MV_OK;
+	return;
 }
 
 MV_STATUS mvBmControl(MV_COMMAND cmd)
@@ -260,7 +268,8 @@ MV_STATUS mvBmPoolInit(int pool, void *virtPoolBase, MV_ULONG physPoolBase, int
 	pBmPool = &mvBmPools[pool];
 	if (pBmPool->pVirt != NULL) {
 		mvOsPrintf("bmPool = %d is already busy\n", pool);
-		return MV_BUSY;
+		/* necessary for power managemaent resume process*/
+		/*return MV_BUSY;*/
 	}
 
 	pBmPool->pool = pool;
diff --git a/arch/arm/plat-armada/mv_hal/neta/bm/mvBm.h b/arch/arm/plat-armada/mv_hal/neta/bm/mvBm.h
index fddc413..caf48da 100755
--- a/arch/arm/plat-armada/mv_hal/neta/bm/mvBm.h
+++ b/arch/arm/plat-armada/mv_hal/neta/bm/mvBm.h
@@ -112,6 +112,7 @@ static INLINE MV_ULONG mvBmPoolGet(int poolId)
 
 /* prototypes */
 MV_STATUS mvBmInit(MV_U8 *virtBase);
+void      mvBmRegsInit(void);
 void      mvBmConfigSet(MV_U32 mask);
 void      mvBmConfigClear(MV_U32 mask);
 MV_STATUS mvBmControl(MV_COMMAND cmd);
-- 
1.7.5.4

