From 8e8df0cc2cba68723922ec7a049682a06a1b4349 Mon Sep 17 00:00:00 2001
From: Uri Eliyahu <uriel@marvell.com>
Date: Thu, 26 Dec 2013 13:51:07 +0200
Subject: [PATCH 1266/1825] pp2: cls engines - add big endian support

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 28d6820b17f82e0c509e26bbdbdae16d4a628c70

	- swap bytes in C2 tcam, C3 heks
	- update C4 enty structure, remove unused bytes array

Change-Id: I6bef479ad5f2912129d79d56ca25eb586e0557a9
Signed-off-by: Uri Eliyahu <uriel@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4878
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls2Hw.c  |   12 +++++-----
 arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls2Hw.h  |    2 -
 arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls3Hw.c  |    2 +-
 arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls4Hw.h  |    1 -
 .../plat-armada/mv_hal/pp2/common/mvPp2Common.h    |   18 +++++++++++++++++
 arch/arm/plat-armada/mv_hal/pp2/prs/mvPp2PrsHw.h   |   21 ++++---------------
 6 files changed, 30 insertions(+), 26 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls2Hw.c b/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls2Hw.c
index e5e732d..0191460 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls2Hw.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls2Hw.c
@@ -477,7 +477,7 @@ int mvPp2ClsC2SwWordsDump(MV_PP2_CLS_C2_ENTRY *c2)
 	i = MV_PP2_CLS_C2_TCAM_WORDS - 1 ;
 
 	while (i >= 0)
-		mvOsPrintf("%4.4x ", (MV_32BIT_LE_FAST(c2->tcam.words[i--])) & 0xFFFF);
+		mvOsPrintf("%4.4x ", (c2->tcam.words[i--]) & 0xFFFF);
 
 	mvOsPrintf("| ");
 
@@ -491,7 +491,7 @@ int mvPp2ClsC2SwWordsDump(MV_PP2_CLS_C2_ENTRY *c2)
 	i = MV_PP2_CLS_C2_TCAM_WORDS - 1;
 
 	while (i >= 0)
-		mvOsPrintf("%4.4x ", ((MV_32BIT_LE_FAST(c2->tcam.words[i--]) >> 16)  & 0xFFFF));
+		mvOsPrintf("%4.4x ", ((c2->tcam.words[i--] >> 16)  & 0xFFFF));
 
 	mvOsPrintf("\n");
 
@@ -715,8 +715,8 @@ int mvPp2ClsC2TcamByteSet(MV_PP2_CLS_C2_ENTRY *c2, unsigned int offs, unsigned c
 
 	POS_RANGE_VALIDATE(offs, MV_PP2_CLS_C2_TCAM_DATA_BYTES);
 
-	c2->tcam.bytes[TCAM_DATA_BYTE_OFFS(offs)] = byte;
-	c2->tcam.bytes[TCAM_DATA_MASK_OFFS(offs)] = enable;
+	c2->tcam.bytes[TCAM_DATA_BYTE(offs)] = byte;
+	c2->tcam.bytes[TCAM_DATA_MASK(offs)] = enable;
 
 	return MV_OK;
 }
@@ -730,8 +730,8 @@ int mvPp2ClsC2TcamByteGet(MV_PP2_CLS_C2_ENTRY *c2, unsigned int offs, unsigned c
 
 	POS_RANGE_VALIDATE(offs, 8);
 
-	*byte = c2->tcam.bytes[TCAM_DATA_BYTE_OFFS(offs)];
-	*enable = c2->tcam.bytes[TCAM_DATA_MASK_OFFS(offs)];
+	*byte = c2->tcam.bytes[TCAM_DATA_BYTE(offs)];
+	*enable = c2->tcam.bytes[TCAM_DATA_MASK(offs)];
 	return MV_OK;
 }
 /*-------------------------------------------------------------------------------*/
diff --git a/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls2Hw.h b/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls2Hw.h
index 3e9bee4..7de7f52 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls2Hw.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls2Hw.h
@@ -84,8 +84,6 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define MV_PP2_CLS2_TCAM_INV_INVALID			31
 #define MV_PP2_CLS2_TCAM_INV_INVALID_MASK		(1 << MV_PP2_CLS2_TCAM_INV_INVALID)
 
-#define TCAM_DATA_BYTE_OFFS(_offs_)			(((_offs_) - ((_offs_) % 2)) * 2 + ((_offs_) % 2))
-#define TCAM_DATA_MASK_OFFS(_offs_)			(((_offs_) * 2) - ((_offs_) % 2)  + 2)
 /*-------------------------------------------------------------------------------*/
 
 #define MV_PP2_CLS2_ACT_DATA_REG			(MV_PP2_REG_BASE + 0x1B30)
diff --git a/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls3Hw.c b/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls3Hw.c
index d3f4c87..d44343a 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls3Hw.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls3Hw.c
@@ -1018,7 +1018,7 @@ int mvPp2ClsC3SwHekByteSet(MV_PP2_CLS_C3_ENTRY *c3, unsigned int offs, unsigned
 	PTR_VALIDATE(c3);
 	POS_RANGE_VALIDATE(offs, ((MV_PP2_CLS_C3_EXT_HEK_WORDS*4) - 1));
 
-	c3->key.hek.bytes[offs] = byte;
+	c3->key.hek.bytes[HW_BYTE_OFFS(offs)] = byte;
 
 	return MV_OK;
 }
diff --git a/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls4Hw.h b/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls4Hw.h
index 53dfa58..2b791514 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls4Hw.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/cls/mvPp2Cls4Hw.h
@@ -194,7 +194,6 @@ typedef struct mvPp2ClsC4RuleEntry {
 	unsigned int setIndex;
 	union {
 		MV_U32	words[MV_PP2_CLS_C4_TBL_WORDS];
-		MV_U8	bytes[MV_PP2_CLS_C4_TBL_WORDS * 4];
 		struct {
 			MV_U32 attr[MV_PP2_CLS4_FATTR_REG_NUM];
 			MV_U32 fdataArr[MV_PP2_CLS_C4_TBL_DATA_WORDS];
diff --git a/arch/arm/plat-armada/mv_hal/pp2/common/mvPp2Common.h b/arch/arm/plat-armada/mv_hal/pp2/common/mvPp2Common.h
index cad7f62..5fc4e54 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/common/mvPp2Common.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/common/mvPp2Common.h
@@ -137,4 +137,22 @@ void mvPp2RegPrintNonZero2(MV_U32 reg_addr, char *reg_name, MV_U32 index);
 #define UNI_MAX						7
 #define ETH_PORTS_NUM					7
 
+/*--------------------------------------------------------------------*/
+/*			PNC COMMON DEFINETIONS			      */
+/*--------------------------------------------------------------------*/
+
+#if defined(MV_CPU_LE)
+	#define HW_BYTE_OFFS(_offs_)		(_offs_)
+#else
+	#define HW_BYTE_OFFS(_offs_)		((3 - ((_offs_) % 4)) + (((_offs_) / 4) * 4))
+#endif
+
+#define TCAM_DATA_BYTE_OFFS_LE(_offs_)		(((_offs_) - ((_offs_) % 2)) * 2 + ((_offs_) % 2))
+#define TCAM_DATA_MASK_OFFS_LE(_offs_)		(((_offs_) * 2) - ((_offs_) % 2)  + 2)
+#define TCAM_DATA_BYTE(_offs_)			(HW_BYTE_OFFS(TCAM_DATA_BYTE_OFFS_LE(_offs_)))
+#define TCAM_DATA_MASK(_offs_)			(HW_BYTE_OFFS(TCAM_DATA_MASK_OFFS_LE(_offs_)))
+
+
+
+
 #endif /* __MV_PP2_ERR_CODE_H__ */
diff --git a/arch/arm/plat-armada/mv_hal/pp2/prs/mvPp2PrsHw.h b/arch/arm/plat-armada/mv_hal/pp2/prs/mvPp2PrsHw.h
index c285d35..38d8971 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/prs/mvPp2PrsHw.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/prs/mvPp2PrsHw.h
@@ -186,25 +186,14 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 /* TODO: share endians support defenitions between parser and cls2  */
 
 #if defined(MV_CPU_LE)
-	#define PRS_HW_BYTE_OFFS(_offs_)	(_offs_)
 	#define TCAM_MASK_OFFS(_offs_)		((_offs_) + 2)
 #else
-	#define PRS_HW_BYTE_OFFS(_offs_)	((3 - ((_offs_) % 4)) + (((_offs_) / 4) * 4))
 	#define TCAM_MASK_OFFS(_offs_)		((_offs_) - 2)
-
 #endif
 
 /************************* TCAM structure **********************/
-/*little endian */
-#define TCAM_DATA_BYTE_OFFS_LE(_offs_)		(((_offs_) - ((_offs_) % 2)) * 2 + ((_offs_) % 2))
-#define TCAM_DATA_MASK_OFFS_LE(_offs_)		(((_offs_) * 2) - ((_offs_) % 2)  + 2)
-
-#define TCAM_BYTE_OFFS(_offs_)			PRS_HW_BYTE_OFFS(_offs_)
-#define TCAM_DATA_BYTE(_offs_)			(PRS_HW_BYTE_OFFS(TCAM_DATA_BYTE_OFFS_LE(_offs_)))
-#define TCAM_DATA_MASK(_offs_)			(PRS_HW_BYTE_OFFS(TCAM_DATA_MASK_OFFS_LE(_offs_)))
-
 /*
-______________________________________________
+ ____________________________________________
 |  LKP ID  | PORT ID |    AI  | HEADER DATA  |
 | 4 bits   | 1 byte  | 1 byte |   8 byte     |
 ----------------------------------------------
@@ -215,11 +204,11 @@ reg 5 --> reg 0
 #define TCAM_DATA_SIZE				8 /*bytes*/
 #define TCAM_DATA_MAX				(TCAM_DATA_SIZE - 1) /*bytes*/
 #define TCAM_DATA_WORD_MAX			((TCAM_DATA_SIZE / 4) - 1) /*words*/
-#define TCAM_AI_BYTE				TCAM_BYTE_OFFS(16)
+#define TCAM_AI_BYTE				HW_BYTE_OFFS(16)
 
-#define TCAM_PORT_BYTE				TCAM_BYTE_OFFS(17)
+#define TCAM_PORT_BYTE				HW_BYTE_OFFS(17)
 
-#define TCAM_LU_BYTE				TCAM_BYTE_OFFS(20)
+#define TCAM_LU_BYTE				HW_BYTE_OFFS(20)
 
 /* Special bit in the TCAM register */
 #define TCAM_INV_BIT				31
@@ -231,7 +220,7 @@ reg 5 --> reg 0
 
 /************************* SRAM structure **********************/
 /* convert bit offset to byte offset */
-#define SRAM_BIT_TO_BYTE(_bit_)			PRS_HW_BYTE_OFFS((_bit_) / 8)
+#define SRAM_BIT_TO_BYTE(_bit_)			HW_BYTE_OFFS((_bit_) / 8)
 
 
 #define SRAM_RI_OFFS  					0
-- 
1.7.5.4

