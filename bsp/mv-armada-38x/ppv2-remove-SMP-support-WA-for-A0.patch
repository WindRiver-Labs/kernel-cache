From 83759e614bfa3a413013b0c4ee5c125124a1ccde Mon Sep 17 00:00:00 2001
From: Uri Eliyahu <uriel@marvell.com>
Date: Tue, 11 Mar 2014 13:37:18 +0200
Subject: [PATCH 1454/1825] ppv2: remove SMP support WA for A0

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 4a455162ac4f091dababef53cebe4f7f89a345a0

	- use internal registers virt base for ppv2.1 regs access

Change-Id: Ib66667f47c4ecf067b7e3d97e91571c7eee6e5b1
Signed-off-by: Uri Eliyahu <uriel@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/6308
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Tested-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/sysmap.c       |   31 +++++++++++++++++++------------
 arch/arm/plat-armada/linux_oss/mvOs.h |   13 ++++++++++++-
 2 files changed, 31 insertions(+), 13 deletions(-)

diff --git a/arch/arm/mach-avantalp/sysmap.c b/arch/arm/mach-avantalp/sysmap.c
index 8db7026..c69cbf4 100644
--- a/arch/arm/mach-avantalp/sysmap.c
+++ b/arch/arm/mach-avantalp/sysmap.c
@@ -29,10 +29,12 @@ struct map_desc MEM_TABLE[] = {
 	{ PEX1_MEM_VIRT_BASE,		__phys_to_pfn(PEX1_MEM_PHYS_BASE),	SZ_16M,		MT_MEMORY_SO },
 
 	{ INTER_REGS_VIRT_BASE,		__phys_to_pfn(INTER_REGS_PHYS_BASE),	SZ_1M,		MT_DEVICE },
+#ifndef CONFIG_MV_ETH_PP2_1
 	{ PP2_CPU0_VIRT_BASE,		__phys_to_pfn(PP2_CPU0_PHYS_BASE),	PP2_SIZE,	MT_DEVICE },
 #ifdef CONFIG_SMP
 	{ PP2_CPU1_VIRT_BASE,		__phys_to_pfn(PP2_CPU1_PHYS_BASE),	PP2_SIZE,	MT_DEVICE },
 #endif
+#endif /* !CONFIG_MV_ETH_PP2_1 */
 	{ CRYPT_ENG_VIRT_BASE(0),	__phys_to_pfn(CRYPT_ENG_PHYS_BASE(0)),	CRYPT_ENG_SIZE,	MT_DEVICE },
 	{ IOCC_WA_WIN0_VIRT_BASE,	__phys_to_pfn(IOCC_WA_WIN0_PHYS_BASE),	SZ_64K,		MT_DEVICE },
 	{ DFEV_VIRT_BASE,		__phys_to_pfn(DFEV_PHYS_BASE),		SZ_1M,		MT_DEVICE },
@@ -66,11 +68,11 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6660_Z[] = {
 	{{DEVICE_BOOTCS_PHYS_BASE,	0,	DEVICE_BOOTCS_SIZE	},	10,			DIS},	/* DEV_BOOCS */
 	{{USB3_REGS_PHYS_BASE_Z,    0,  USB3_REGS_SIZE      },  11,         EN},    /* USB3 */
 	{{CRYPT_ENG_PHYS_BASE(0),	0,	CRYPT_ENG_SIZE		},	12,			EN},	/* CRYPT_ENG */
-	{{PP2_CPU0_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 */
+	{{PP2_CPU0_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 - Zx */
 #ifdef CONFIG_SMP
-	{{PP2_CPU1_PHYS_BASE,		0,	PP2_SIZE		},	15,			EN},	/* PP2 */
+	{{PP2_CPU1_PHYS_BASE,		0,	PP2_SIZE		},	15,			EN},	/* PP2 - Zx */
 #else
-	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2 */
+	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2 - Zx */
 #endif
 	{{DFEV_PHYS_BASE,		0,	DFEV_SIZE,		},	7,			EN},	/* VOICE */
 	{{TBL_TERM,			TBL_TERM,	TBL_TERM	},	TBL_TERM,		TBL_TERM}
@@ -103,12 +105,8 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6660[] = {
 		{{BOOTROM_PHYS_BASE,       0, BOOTROM_SIZE },       9,          DIS}, /* BOOTROM */
 		{{DEVICE_BOOTCS_PHYS_BASE, 0, DEVICE_BOOTCS_SIZE }, 10,         DIS}, /* DEV_BOOCS */
 		{{CRYPT_ENG_PHYS_BASE(0),  0, CRYPT_ENG_SIZE },     12,         EN},  /* CRYPT_ENG */
-		{{PP2_CPU0_PHYS_BASE,      0, PP2_SIZE },           13,         EN},  /* PP2 */
-#ifdef CONFIG_SMP
-		{{PP2_CPU1_PHYS_BASE,      0, PP2_SIZE },           15,         EN},  /* PP2 */
-#else
-		{{TBL_UNUSED,              0, TBL_UNUSED, },        TBL_UNUSED, DIS}, /* PP2 */
-#endif
+		{{TBL_UNUSED,              0, TBL_UNUSED, },        TBL_UNUSED, DIS}, /* PP2.1 - A0 */
+		{{TBL_UNUSED,              0, TBL_UNUSED, },        TBL_UNUSED, DIS}, /* PP2.1 - A0 */
 		{{DFEV_PHYS_BASE,          0, DFEV_SIZE, },         7,          EN},  /* VOICE */
 		{{TBL_TERM, TBL_TERM, TBL_TERM }, TBL_TERM, TBL_TERM}
 };
@@ -141,12 +139,17 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6650[] = {
 	{{DEVICE_BOOTCS_PHYS_BASE,	0,	DEVICE_BOOTCS_SIZE	},	10,			DIS},	/* DEV_BOOCS */
 	{{TBL_UNUSED,			0,	TBL_UNUSED		},	TBL_UNUSED,		DIS},	/* USB3 */
 	{{CRYPT_ENG_PHYS_BASE(0),	0,	CRYPT_ENG_SIZE		},	12,			EN},	/* CRYPT_ENG */
-	{{PP2_CPU0_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 */
+#ifdef CONFIG_MV_ETH_PP2_1
+	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2.1 - A0 */
+	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2.1 - A0 */
+#else
+	{{PP2_CPU0_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 - Zx */
 #ifdef CONFIG_SMP
-	{{PP2_CPU1_PHYS_BASE,		0,	PP2_SIZE		},	15,			EN},	/* PP2 */
+	{{PP2_CPU1_PHYS_BASE,		0,	PP2_SIZE		},	15,			EN},	/* PP2 - Zx */
 #else
-	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2 */
+	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2 - Zx */
 #endif
+#endif /*CONFIG_MV_ETH_PP2_1*/
 	{{TBL_TERM,			TBL_TERM,	TBL_TERM	},	TBL_TERM,		TBL_TERM}
 };
 
@@ -178,7 +181,11 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6610[] = {
 	{{DEVICE_BOOTCS_PHYS_BASE,	0,	DEVICE_BOOTCS_SIZE	},	10,			DIS},	/* DEV_BOOCS */
 	{{TBL_UNUSED,			0,	TBL_UNUSED		},	TBL_UNUSED,		DIS},	/* USB3 */
 	{{CRYPT_ENG_PHYS_BASE(0),	0,	CRYPT_ENG_SIZE		},	12,			EN},	/* CRYPT_ENG */
+#ifdef CONFIG_MV_ETH_PP2_1
+	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2 */
+#else
 	{{PP2_CPU0_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 */
+#endif
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2 */
 	{{TBL_TERM,			TBL_TERM,	TBL_TERM	},	TBL_TERM,		TBL_TERM}
 };
diff --git a/arch/arm/plat-armada/linux_oss/mvOs.h b/arch/arm/plat-armada/linux_oss/mvOs.h
index ef03e79..0a2307a 100644
--- a/arch/arm/plat-armada/linux_oss/mvOs.h
+++ b/arch/arm/plat-armada/linux_oss/mvOs.h
@@ -521,7 +521,16 @@ extern int reg_arry_index;
 #define MV_REG_VALUE(offset)          \
 	(MV_MEMIO32_READ((INTER_REGS_VIRT_BASE | (offset))))
 
-/* PPv2 specific reg read/write */
+#ifdef CONFIG_MV_ETH_PP2_1
+
+#define MV_PP2_REG_READ(offset)	\
+	MV_REG_READ(offset)
+
+#define MV_PP2_REG_WRITE(offset, val)	\
+	MV_REG_WRITE(offset, val)
+#else
+
+/* PPv2.0 specific reg read/write - bug WA */
 #define MV_PP2_CPU0_REG_READ(offset)             \
 	(MV_MEMIO_LE32_READ(PP2_CPU0_VIRT_BASE | (offset & 0xffff)))
 #define MV_PP2_CPU0_REG_WRITE(offset, val)    \
@@ -546,6 +555,8 @@ extern int reg_arry_index;
 	MV_PP2_CPU0_REG_WRITE(offset, val)
 #endif
 
+#endif /*CONFIG_MV_ETH_PP2_1*/
+
 #define MV_REG_READ(offset)             \
 	(MV_MEMIO_LE32_READ(INTER_REGS_VIRT_BASE | (offset)))
 
-- 
1.7.5.4

