From f8aaa8add9e135901e8fde30bd0401e0203f8f60 Mon Sep 17 00:00:00 2001
From: Joe Zhou <shjzhou@marvell.com>
Date: Mon, 7 Jul 2014 11:16:03 +0800
Subject: [PATCH 1778/1825] fix: sflash: fix writebufsize setting for SPI
 flash

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit a34bc3d6c792a46dcbbe0ec355f9e42791e7b1f0

	If the writebufsize is not initialized, the below error will be
	prompted when attaching mtd partitions to ubi,

	UBI error: io_init: bad write buffer size 0 for 1 min. I/O unit

	Below is the explanation of writebufsize from mtd.h

	/*
	* Size of the write buffer used by the MTD. MTD devices having a write
	* buffer can write multiple writesize chunks at a time. E.g. while
    * writing 4 * writesize bytes to a device with 2 * writesize bytes
    * buffer the MTD driver can (but doesn't have to) do 2 writesize
    * operations, but not 4. Currently, all NANDs have writebufsize
	* equivalent to writesize (NAND page size). Some NOR flashes do have
	* writebufsize greater than writesize.
	*/

Change-Id: Ibddfcffba3fdbabe5310803c42bf4b4db55ff097
Signed-off-by: Joe Zhou <shjzhou@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/9006
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Tested-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../arm/plat-armada/mv_drivers_lsp/mv_mtd/sflash.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/sflash.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/sflash.c
index 5b9a0a9..6629059 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/sflash.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/sflash.c
@@ -158,6 +158,7 @@ static struct mtd_info *sflash_probe(struct map_info *map)
 	mtd->flags = (MTD_WRITEABLE | MTD_BIT_WRITEABLE); /* just like MTD_CAP_NORFLASH */
 	mtd->name = map->name;
 	mtd->writesize = 1;
+	mtd->writebufsize = mtd->writesize;
 	mtd->ecc_strength = 1;
 
 	map->fldrv = &sflash_chipdrv;
-- 
1.7.5.4

