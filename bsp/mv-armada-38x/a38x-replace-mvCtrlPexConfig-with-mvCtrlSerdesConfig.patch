From c3d5027eb97eda7397c025726cff5cc28e383287 Mon Sep 17 00:00:00 2001
From: Eli Nidam <elini@marvell.com>
Date: Wed, 23 Oct 2013 11:13:09 +0200
Subject: [PATCH 1120/1825] a38x: replace mvCtrlPexConfig with
 mvCtrlSerdesConfig

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 5438d2b7f72e4ae839d8532d6213d492ecc9b801

	The new  subroutine is read the SERDES configuration and update
	the interface configuration for all interfaces (PEX, SGMII, USB, SATA)
	(The old mvCtrlPexConfig update only the PEX interface)

Change-Id: Icc6b938414130b8f2d54894a499fc0a268bb34c0
Signed-off-by: Eli Nidam <elini@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3827
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.c       |   43 +++++++++++++++-----
 1 files changed, 33 insertions(+), 10 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
index 64cbd7c..4878761 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
@@ -188,15 +188,19 @@ static MV_U32 mvCtrlDevIdIndexGet(void)
 	return MV_6820_INDEX;
 }
 
-static MV_VOID mvCtrlPexConfig(MV_VOID)
+static MV_VOID mvCtrlSerdesConfig(MV_VOID)
 {
 	MV_U32 pexIf, commPhyConfigReg, comPhyCfg, serdesNum, serdesCongigField, maxSerdesLane;
+	MV_U32 ethIfCount = 0;
+	MV_U32 sataIfCount = 0;
+	MV_U32 usbIfCount = 0;
+	MV_U32 usbHIfCount = 0;
 
 	MV_BOARD_PEX_INFO *boardPexInfo = mvBoardPexInfoGet();
 
 	switch (mvCtrlModelGet()) {
 	case MV_6810_DEV_ID:
-		maxSerdesLane = 5;
+		maxSerdesLane = MV_SERDES_MAX_LANES_6810;
 		break;
 	default:
 	case MV_6820_DEV_ID:
@@ -210,17 +214,36 @@ static MV_VOID mvCtrlPexConfig(MV_VOID)
 		comPhyCfg = serdesCfg[serdesNum][serdesCongigField];
 		DB(printf("%s:   serdesCongigField = 0x%x, comPhyCfg = 0x%x\n",
 			  serdesCongigField, comPhyCfg));
-		if ((comPhyCfg & 0xF0) != SERDES_UNIT_PEX)
-			continue;
-		pexIf = comPhyCfg & 0x0f;
-		if ((pexIf == PEX0_IF) && (commPhyConfigReg & PCIE0_X4_EN_MASK))
-			boardPexInfo->pexUnitCfg[pexIf] = PEX_BUS_MODE_X4;
-		else
-			boardPexInfo->pexUnitCfg[pexIf] = PEX_BUS_MODE_X1;
+		switch (comPhyCfg & 0xF0) {
+		case SERDES_UNIT_PEX:
+			pexIf = comPhyCfg & 0x0f;
+			if ((pexIf == PEX0_IF) && (commPhyConfigReg & PCIE0_X4_EN_MASK))
+				boardPexInfo->pexUnitCfg[pexIf] = PEX_BUS_MODE_X4;
+			else
+				boardPexInfo->pexUnitCfg[pexIf] = PEX_BUS_MODE_X1;
 			boardPexInfo->pexMapping[boardPexInfo->boardPexIfNum] = pexIf;
 			boardPexInfo->boardPexIfNum++;
+			break;
+		case SERDES_UNIT_SATA:
+			sataIfCount++;
+			break;
+		case SERDES_UNIT_GBE:
+			ethIfCount++;
+			break;
+		case SERDES_UNIT_USB_H:
+			usbHIfCount++;
+			break;
+		case SERDES_UNIT_USB:
+			usbIfCount++;
+			break;
+		}
 	}
 	mvCtrlSocUnitInfoNumSet(PEX_UNIT_ID, boardPexInfo->boardPexIfNum);
+	mvCtrlSocUnitInfoNumSet(SATA_UNIT_ID , sataIfCount);
+	mvCtrlSocUnitInfoNumSet(USB_UNIT_ID , usbIfCount);
+	mvCtrlSocUnitInfoNumSet(USB3_UNIT_ID, usbHIfCount);
+	if (ethIfCount) /* if serdes configuration found SGMII ports replace the existing RGMII gonfiguration*/
+		mvCtrlSocUnitInfoNumSet(ETH_GIG_UNIT_ID, ethIfCount);
 }
 
 
@@ -306,7 +329,7 @@ MV_STATUS mvCtrlEnvInit(MV_VOID)
 		mvBoardInfoUpdate();
 	}
 
-	mvCtrlPexConfig();
+	mvCtrlSerdesConfig();
 
 	/* write MPP's config and Board general config */
 	mvBoardConfigWrite();
-- 
1.7.5.4

