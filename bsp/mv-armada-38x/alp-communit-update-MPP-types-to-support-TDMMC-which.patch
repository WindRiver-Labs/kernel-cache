From 53aa9088f4600f6d95f813010e1ccffa47a06795 Mon Sep 17 00:00:00 2001
From: Victor Gu <xigu@marvell.com>
Date: Tue, 8 Jul 2014 17:58:22 +0800
Subject: [PATCH 1781/1825] alp: communit: update MPP types to support TDMMC
 which needs 4 chip selection and 4 interrupts

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 32621e6d0cf8c01a58f1f938ec9df8cd7a17c197

	Need to set following MPPs for TDMMC:
	MPP42: 0x5, MPP45: 0x6, MPP54: 0x5, MPP55: 0x5.
	The MPP54 and MPP55 are conflict with RGMII0, if TDMMC is enabled, it will occupy the MPPs,
	and the RGMII0 will not work.

Signed-off-by: Victor Gu <xigu@marvell.com>
Change-Id: I0b8a8f3c84128ad0d847ca49365f01f035538d11
Reviewed-on: http://vgitil04.il.marvell.com:8080/9056
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   22 +++++++++++++++++--
 .../avanta_lp_family/boardEnv/mvBoardEnvSpec.h     |    4 +-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |   18 ++++++++++-----
 3 files changed, 33 insertions(+), 11 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index d3c49ba..65eed57 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -987,6 +987,19 @@ MV_VOID mvBoardInfoUpdate(MV_VOID)
 		mvOsPrintf("%s: Error: board configuration conflict between MAC1 to RGMII-1, " \
 				"and External TDM - using RGMII-1 (disabled External TDM)\n\n", __func__);
 
+	if (slicDev == SLIC_TDMMC_ID) {
+		if (ethComplex & MV_ETHCOMP_GE_MAC0_2_RGMII0)
+			mvOsPrintf("%s: Error: board configuration conflict between MAC0 to RGMII-0, " \
+					"and External TDM - using External TDM (disabled RGMII-0)\n\n", __func__);
+
+		if (ethComplex & MV_ETHCOMP_SW_P4_2_RGMII0)
+			mvOsPrintf("%s: Error: board configuration conflict between SW P4 to RGMII-0, " \
+					"and External TDM - using External TDM (disabled RGMII-0)\n\n", __func__);
+
+		if (ethComplex & MV_ETHCOMP_GE_MAC1_2_RGMII0)
+			mvOsPrintf("%s: Error: board configuration conflict between MAC1 to RGMII-0, " \
+					"and External TDM - using External TDM (disabled RGMII-0)\n\n", __func__);
+	}
 	mvBoardSlicUnitTypeSet(slicDev);
 
 	/* Update MPP group types and values according to board configuration */
@@ -1082,6 +1095,7 @@ MV_VOID mvBoardMppIdUpdate(MV_VOID)
 	MV_SLIC_UNIT_TYPE slicDev;
 	MV_U32 ethComplexOptions = mvBoardEthComplexConfigGet();
 	MV_BOOL singleCpu, tdmLqUnit;
+	MV_U32 tdmmcType;
 
 	/* MPP Groups initialization : */
 	/* Set Group 0-1 - Boot device (else if booting from SPI1: Set Groups 3-4) */
@@ -1108,17 +1122,19 @@ MV_VOID mvBoardMppIdUpdate(MV_VOID)
 
 	/* Groups 5-6-7 Set GE0, GE1_RGMII0, or Switch port 4 */
 	singleCpu = (mvCtrlGetCpuNum() == 0); /* if using Dual CPU ,set UART1 */
+	/* If TDMMC is enabled, set proper MPP for chip selection and interrupt */
+	tdmmcType = (mvBoardSlicUnitTypeGet() == SLIC_TDMMC_ID);
 	if (ethComplexOptions & MV_ETHCOMP_GE_MAC0_2_RGMII0) {
 		mvBoardMppTypeSet(5, GE0_UNIT_PON_TX_FAULT);
-		mvBoardMppTypeSet(6, GE0_UNIT);
+		mvBoardMppTypeSet(6, tdmmcType ? GE0_UNIT_TDMMC : GE0_UNIT);
 		mvBoardMppTypeSet(7, (singleCpu ? GE0_UNIT_LED_MATRIX : GE0_UNIT_UA1_PTP));
 	} else if (ethComplexOptions & MV_ETHCOMP_SW_P4_2_RGMII0) {
 		mvBoardMppTypeSet(5, SWITCH_P4_PON_TX_FAULT);
-		mvBoardMppTypeSet(6, SWITCH_P4);
+		mvBoardMppTypeSet(6, tdmmcType ? SWITCH_P4_TDMMC : SWITCH_P4);
 		mvBoardMppTypeSet(7, (singleCpu ? SWITCH_P4_LED_MATRIX : SWITCH_P4_UA1_PTP));
 	} else if (ethComplexOptions & MV_ETHCOMP_GE_MAC1_2_RGMII0) {
 		mvBoardMppTypeSet(5, GE1_RGMII0_UNIT_PON_TX_FAULT);
-		mvBoardMppTypeSet(6, GE1_RGMII0_UNIT);
+		mvBoardMppTypeSet(6, tdmmcType ? GE1_RGMII0_UNIT_TDMMC : GE1_RGMII0_UNIT);
 		mvBoardMppTypeSet(7, (singleCpu ? GE1_RGMII0_UNIT_LED_MATRIX : GE1_RGMII0_UNIT_UA1_PTP));
 	}
 }
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
index 40b5828..c0a6d64 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
@@ -147,8 +147,8 @@
 #define DB_88F6660_MPP16_23             0x00000022
 #define DB_88F6660_MPP24_31             0x22222222  /* RGMII-1*/
 #define DB_88F6660_MPP32_39             0x04422222  /* GE_SMI ,GE1, PON */
-#define DB_88F6660_MPP40_47             0x22100020  /* PON , GE0 */
-#define DB_88F6660_MPP48_55             0x22222222  /* GE0*/
+#define DB_88F6660_MPP40_47             0x22600520  /* PON , GE0 */
+#define DB_88F6660_MPP48_55             0x55222222  /* GE0*/
 #define DB_88F6660_MPP56_63             0x44224422  /* UART1, GE0 , LED */
 #define DB_88F6660_MPP64_67             0x004
 
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index 3fa195a..e4ee0e1 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -325,12 +325,12 @@ typedef enum {
 } MV_GROUP_4_TYPE;
 
 #define MPP_GROUP_5_TYPE { \
-	0x22122220,	/* GE0,		PON_TX_FAULT	*/ \
-	0x22122222,	/* GE0,		PON_CLK_OUT	*/ \
-	0x33122220,	/* GE1_RGMII0,	PON_TX_FAULT	*/ \
-	0x33122222,	/* GE1_RGMII0,	PON_CLK_OUT	*/ \
-	0x44122220,	/* SWITCH_P4,	PON_TX_FAULT	*/ \
-	0x44122222,	/* SWITCH_P4,	PON_CLK_OUT	*/ \
+	0x22622520,	/* GE0,		PON_TX_FAULT	*/ \
+	0x22622522,	/* GE0,		PON_CLK_OUT	*/ \
+	0x33622520,	/* GE1_RGMII0,	PON_TX_FAULT	*/ \
+	0x33622522,	/* GE1_RGMII0,	PON_CLK_OUT	*/ \
+	0x44622520,	/* SWITCH_P4,	PON_TX_FAULT	*/ \
+	0x44622522,	/* SWITCH_P4,	PON_CLK_OUT	*/ \
 }
 typedef enum {
 	GE0_UNIT_PON_TX_FAULT,
@@ -345,12 +345,18 @@ typedef enum {
 	0x22222222,     /* GE0		*/ \
 	0x33333333,     /* GE1_RGMII0	*/ \
 	0x44444444,     /* SWITCH_P4	*/ \
+	0x55222222,     /* GE0, TDMMC		*/ \
+	0x55333333,     /* GE1_RGMII0, TDMMC	*/ \
+	0x55444444,     /* SWITCH_P4, TDMMC	*/ \
 }
 
 typedef enum {
 	GE0_UNIT,
 	GE1_RGMII0_UNIT,
 	SWITCH_P4,
+	GE0_UNIT_TDMMC,
+	GE1_RGMII0_UNIT_TDMMC,
+	SWITCH_P4_TDMMC,
 } MV_GROUP_6_TYPE;
 
 #define MPP_GROUP_7_TYPE { \
-- 
1.7.5.4

