From d9194bd3e4ad941d9a197842f320bbabd4cc9561 Mon Sep 17 00:00:00 2001
From: Tawfik Bayouk <tawfik@marvell.com>
Date: Tue, 21 Aug 2012 17:34:15 +0300
Subject: [PATCH 0100/1825] NAND fixes for Rd nad - submitted by Shadi A.

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit af16d76b594a43218517e458377fdfd02b1434cf

Change-Id: I8b5c3fdf6dd5ae2f283400ccc299926828a657f1
Signed-off-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c   |    5 +++++
 arch/arm/plat-armada/mv_hal/nfc/mvNfc.c            |    4 ++--
 arch/arm/plat-armada/mv_hal/nfc/mvNfc.h            |    1 +
 3 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c
index c886baf..8606d8f 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c
@@ -1125,6 +1125,7 @@ static void orion_nfc_cmdfunc(struct mtd_info *mtd, unsigned command,
 
 		break;
 	case NAND_CMD_RESET:
+#if 0
 		info->column = 0;
 		info->page_addr = 0;
 		info->cmd = MV_NFC_CMD_RESET;
@@ -1151,6 +1152,10 @@ static void orion_nfc_cmdfunc(struct mtd_info *mtd, unsigned command,
 			ndcr = MV_REG_READ(NFC_CONTROL_REG);
 			MV_REG_WRITE(NFC_CONTROL_REG, ndcr & ~NFC_CTRL_ND_RUN_MASK);
 		}
+#else
+		if (mvNfcReset() != MV_OK)
+			printk(KERN_ERR "Device reset failed.\n");
+#endif
 		break;
 	default:
 		printk(KERN_ERR "non-supported command.\n");
diff --git a/arch/arm/plat-armada/mv_hal/nfc/mvNfc.c b/arch/arm/plat-armada/mv_hal/nfc/mvNfc.c
index 89a6a9a..4979573 100644
--- a/arch/arm/plat-armada/mv_hal/nfc/mvNfc.c
+++ b/arch/arm/plat-armada/mv_hal/nfc/mvNfc.c
@@ -532,7 +532,7 @@ static MV_STATUS mvNfcReadIdNative(MV_NFC_CHIP_SEL cs, MV_U16 *id);
 static MV_STATUS mvNfcTimingSet(MV_U32 tclk, MV_NFC_FLASH_INFO *flInfo);
 static MV_U32 mvNfcColBits(MV_U32 pg_size);
 /* #ifdef CONFIG_MTD_NAND_NFC_INIT_RESET */
-static MV_STATUS mvNfcReset(void);
+/*static MV_STATUS mvNfcReset(void);*/
 /* #endif */
 static MV_STATUS mvNfcDeviceFeatureSet(MV_NFC_CTRL *nfcCtrl, MV_U8 cmd, MV_U8 addr, MV_U32 data0, MV_U32 data1);
 static MV_STATUS mvNfcDeviceFeatureGet(MV_NFC_CTRL *nfcCtrl, MV_U8 cmd, MV_U8 addr, MV_U32 *data0, MV_U32 *data1);
@@ -2466,7 +2466,7 @@ static MV_STATUS mvNfcDeviceModeSet(MV_NFC_CTRL *nfcCtrl, MV_NFC_ONFI_MODE mode)
 
 
 /* #ifdef CONFIG_MTD_NAND_NFC_INIT_RESET */
-static MV_STATUS mvNfcReset(void)
+MV_STATUS mvNfcReset(void)
 {
 	MV_U32 reg;
 	MV_U32 errCode = MV_OK;
diff --git a/arch/arm/plat-armada/mv_hal/nfc/mvNfc.h b/arch/arm/plat-armada/mv_hal/nfc/mvNfc.h
index 7579ee6..5d7e9e5 100644
--- a/arch/arm/plat-armada/mv_hal/nfc/mvNfc.h
+++ b/arch/arm/plat-armada/mv_hal/nfc/mvNfc.h
@@ -416,6 +416,7 @@ MV_STATUS mvNfcFlashIdGet(MV_NFC_CTRL *nfcCtrl, MV_U32 *flashId);
 MV_STATUS mvNfcUnitStateStore(MV_U32 *stateData, MV_U32 *len);
 MV_NFC_ECC_MODE mvNfcEccModeSet(MV_NFC_CTRL *nfcCtrl, MV_NFC_ECC_MODE eccMode);
 MV_U32 	  mvNfcBadBlockPageNumber(MV_NFC_CTRL *nfcCtrl);
+MV_STATUS mvNfcReset(void);
 
 #ifdef __cplusplus
 }
-- 
1.7.5.4

