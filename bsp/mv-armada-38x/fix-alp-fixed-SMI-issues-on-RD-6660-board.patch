From 3fa3a63597e010b143021bebfba35d8881e1b257 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Wed, 13 Nov 2013 15:36:24 +0200
Subject: [PATCH 1084/1825] fix: alp: fixed SMI issues on RD-6660 board

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit ec1dbc1005fb876a61c43655065350c08c9e1c25

	- Update SMI address for MAC0 to -1(false config caused PHY initialized try which failed)
	- Added new MPP type (NO_SMI) for group 4, to indicate No SMI ctrl is used (instead of Switch/CPU)
	- Disabled SMI CPU controll for all boards without external PHY/GMII

Change-Id: Ie51a09611c80d3717970482eebfe9ff54d534370
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4314
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    2 +-
 .../avanta_lp_family/boardEnv/mvBoardEnvSpec.c     |    2 +-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   25 +++++++++----------
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h        |    1 +
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |    2 +
 5 files changed, 17 insertions(+), 15 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index c494226..258cc53 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -82,7 +82,7 @@ extern "C" {
 #define BOARD_ETH_SWITCH_SMI_SCAN_MODE	1	/* Use manual scanning mode */
 #define MV_BOARD_MAX_MPP                9       /* number of MPP conf registers */
 #define MV_BOARD_MAX_MPP_GROUPS         9
-#define MV_BOARD_MPP_GROUPS_MAX_TYPES   8
+#define MV_BOARD_MPP_GROUPS_MAX_TYPES   9
 #define MV_BOARD_NAME_LEN               0x20
 
 typedef enum _devBoardSlicType {
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
index 8218c27..4bfe3bf 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
@@ -419,7 +419,7 @@ MV_BOARD_TWSI_INFO rd88f6660InfoBoardTwsiDev[] = {
  * The 'boardEthSmiAddr' variable is used only for PHY init. */
 MV_BOARD_MAC_INFO rd88f6660InfoBoardMacInfo[] = {
 	/* {{MV_BOARD_MAC_SPEED boardMacSpeed, MV_8 boardEthSmiAddr}} */
-	{ BOARD_MAC_SPEED_2000M, 0x1},
+	{ BOARD_MAC_SPEED_2000M, -1},
 	{ BOARD_MAC_SPEED_AUTO,  0x1},
 	{ BOARD_MAC_SPEED_1000M, -1},
 	{ BOARD_MAC_SPEED_1000M, -1},
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 7ad5ca9..8b51249 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -478,22 +478,21 @@ MV_VOID mvCtrlSmiMasterSet(MV_SMI_CTRL smiCtrl)
 	else
 		isSPI1Enabled = MV_FALSE;
 
-	if (!((smiCtrl == SWITCH_SMI_CTRL) || (smiCtrl == CPU_SMI_CTRL))) {
-		mvOsPrintf("mvCtrlSMISet: SMI ctrl initialize failed\n");
-		return;
-	}
+	if (smiCtrl == NO_SMI_CTRL)
+		groupTypeSelect = NO_SW_SMI_CTRL_REF_CLK_OUT;
+	else {
+		/* MPP settings :
+		* Test board configuration relevant to MPP group 4, and derive the correct group type */
 
-	/* MPP settings :
-	 * Test board configuration relevant to MPP group 4, and derive the correct group type */
+		if (isRefClkOut)	/* add first REF_CLK_OUT group type */
+			groupTypeSelect += GE1_CPU_SMI_CTRL_REF_CLK_OUT;
 
-	if (isRefClkOut)	/* add first REF_CLK_OUT group type */
-		groupTypeSelect += GE1_CPU_SMI_CTRL_REF_CLK_OUT;
+		if (smiCtrl == SWITCH_SMI_CTRL)	/* add first SW_SMI group type */
+			groupTypeSelect += GE1_SW_SMI_CTRL_TDM_LQ_UNIT;
 
-	if (smiCtrl == SWITCH_SMI_CTRL)	/* add first SW_SMI group type */
-		groupTypeSelect += GE1_SW_SMI_CTRL_TDM_LQ_UNIT;
-
-	if (isSPI1Enabled)	/* add first SPI1 group type */
-		groupTypeSelect += SPI1_CPU_SMI_CTRL_TDM_LQ_UNIT;
+		if (isSPI1Enabled)	/* add first SPI1 group type */
+			groupTypeSelect += SPI1_CPU_SMI_CTRL_TDM_LQ_UNIT;
+	}
 
 	mvBoardMppTypeSet(4, groupTypeSelect);	/* Set MPP value according to group type */
 	MV_REG_WRITE(mvCtrlMppRegGet(4), mvBoardMppGet(4));
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
index 11550bd..5dd4dad 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
@@ -127,6 +127,7 @@ typedef enum _mvConfigTypeID {
 typedef enum _mvSMIctrl {
 	CPU_SMI_CTRL,
 	SWITCH_SMI_CTRL,
+	NO_SMI_CTRL,
 } MV_SMI_CTRL;
 
 /* typedefs */
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index eccde38..1d57aff 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -321,6 +321,7 @@ typedef enum {
 	0x44423330,     /* SPI1, CPU SMI CONTROL,    REF_CLK_OUT */ \
 	0x05523330,     /* SPI1, SWITCH SMI CONTROL, TDM_LQ_UNIT */ \
 	0x45523330,     /* SPI1, SWITCH SMI CONTROL, REF_CLK_OUT */ \
+	0x00023330,	/* SPI1, NO SMI CONTROL, SD_Stat (GPIO_input) */\
 }
 
 typedef enum {
@@ -332,6 +333,7 @@ typedef enum {
 	SPI1_CPU_SMI_CTRL_REF_CLK_OUT,
 	SPI1_SW_SMI_CTRL_TDM_LQ_UNIT,
 	SPI1_SW_SMI_CTRL_REF_CLK_OUT,
+	NO_SW_SMI_CTRL_REF_CLK_OUT,
 } MV_GROUP_4_TYPE;
 
 #define MPP_GROUP_5_TYPE { \
-- 
1.7.5.4

