From 68eabec575b1492cc22e5ae3f1ec16812f796843 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Mon, 16 Sep 2013 16:33:09 +0200
Subject: [PATCH 1005/1825] usb: alp: config: Enable xHCI support for Avanta
 LP

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit c5ff092c2963cd3a0efb3220f4fb658995a09a6a

	This enables support for xHCI host controller on Avanta LP,
	and further disables EHCI support, to make sure only one
	host controller is enabled at a time.
	(xHCI stack overrides eHCI API's, so currently both can't be used simultaneously)

	- Added USB3.0 Physical address CPU window decoding       (mvSysHwConfig.h)
	- Added routine to set USB3.0 SuperSpeed mode, which enables 900 Mah output

Change-Id: Id14a0d019e2277b52ae24af3e4257418e514b976
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3510
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   35 +++++++++++++++++++-
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    1 +
 2 files changed, 35 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index 93ce0e9..23cf9e0 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -946,10 +946,14 @@ MV_VOID mvBoardInfoUpdate(MV_VOID)
 	/* Update MPP group types and values according to board configuration */
 	mvBoardMppIdUpdate();
 
-	/* according to board config, only DB-6660 utilize 3 SerDes lanes, and SFP0 */
+	/* specific initializations required only for DB-6660 */
 	if (mvBoardIdGet() == DB_6660_ID) {
 		/* Verify board config vs. SerDes actual setup (Common phy Selector) */
 		mvBoardVerifySerdesCofig();
+
+		/* Enable Super-Speed mode on Avanta DB boards (900Mah output) */
+		mvBoardUsbSsEnSet(MV_TRUE);
+
 		/* If needed, enable SFP0 TX for SGMII, for DB-6660 */
 		if (ethComplex & MV_ETHCOMP_GE_MAC0_2_COMPHY_2)
 			mvBoardSgmiiSfp0TxSet(MV_TRUE);
@@ -2401,6 +2405,35 @@ MV_STATUS mvBoardSgmiiSfp0TxSet(MV_BOOL enable)
 }
 
 /*******************************************************************************
+* mvBoardUsbSsEnSet - enable/disable USB_SS_EN status
+*
+* DESCRIPTION:
+*	This function enables/disables USB_SS_EN status.
+*	USB_SS_EN = 1 --> Enable USB 3.0 900mA current limit
+*
+* INPUT:
+*	enable - Boolean to indicate requested status
+*
+* OUTPUT:
+*	None.
+*
+* RETURN:
+*	None.
+*
+*******************************************************************************/
+MV_STATUS mvBoardUsbSsEnSet(MV_BOOL enable)
+{
+	MV_BOARD_IO_EXPANDER_TYPE_INFO ioInfo;
+
+	if (mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_USB_SUPER_SPEED, &ioInfo) != MV_OK) {
+		mvOsPrintf("%s: Error: Write to IO expander failed (USB_SS_EN)\n", __func__);
+		return MV_ERROR;
+	}
+
+	return mvBoardIoExpValSet(&ioInfo, (enable ? 0x1 : 0x0));
+}
+
+/*******************************************************************************
 * mvBoardIdSet - Set Board model
 *
 * DESCRIPTION:
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index d87ac9c..4aa191a 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -476,6 +476,7 @@ MV_STATUS mvBoardConfigTypeGet(MV_CONFIG_TYPE_ID configClass, MV_BOARD_CONFIG_TY
 MV_STATUS mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_TYPE_ID ioClass, MV_BOARD_IO_EXPANDER_TYPE_INFO *ioInfo);
 MV_STATUS mvBoardExtPhyBufferSelect(MV_BOOL enable);
 MV_STATUS mvBoardSgmiiSfp0TxSet(MV_BOOL enable);
+MV_STATUS mvBoardUsbSsEnSet(MV_BOOL enable);
 MV_U32 mvBoardTclkGet(MV_VOID);
 MV_U32 mvBoardL2ClkGetRaw(MV_VOID);
 MV_U32 mvBoardSysClkGet(MV_VOID);
-- 
1.7.5.4

