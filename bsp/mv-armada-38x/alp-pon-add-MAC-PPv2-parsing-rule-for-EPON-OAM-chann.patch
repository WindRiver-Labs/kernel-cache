From 2d105b5544dbaac2b3d3f1af4c72f3b53b12d170 Mon Sep 17 00:00:00 2001
From: Victor Gu <xigu@marvell.com>
Date: Thu, 8 May 2014 17:00:47 +0800
Subject: [PATCH 1637/1825] alp: pon: add MAC PPv2 parsing rule for EPON OAM
 channel

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 6d11fd436aadd44ebaf398c58b5cf5ecac92a46c

Signed-off-by: Victor Gu <xigu@marvell.com>

Change-Id: I71edcd5df4f58370446ec689ce24e14b5c366b24
Reviewed-on: http://vgitil04.il.marvell.com:8080/7885
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pon/core/epon/eponOnuMngr.c  |   17 ++++++++++++++++-
 1 files changed, 16 insertions(+), 1 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuMngr.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuMngr.c
index 15178a6..2fc4d41 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuMngr.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuMngr.c
@@ -110,6 +110,7 @@ extern MV_U8 fixMacAddrs[8][6];
 
 /* Local Variables
    ------------------------------------------------------------------------------*/
+static MV_U8 oam_dmac[6] = {0x01, 0x80, 0xC2, 0x00, 0x00, 0x01};
 
 /* SW DBA params */
 MV_U32 llidDbaRprtCount = 0;
@@ -2991,7 +2992,14 @@ MV_STATUS onuEponEoamChannelAdd(MV_U8 rxCpuQueue)
 		return MV_ERROR;
 	}
 
-	/* Set EPON OAM parsing rule in PP parser */
+	/* Set EPON OAM MAC parsing rule in PP parser */
+	rcode = mvPrsMacDaAccept(MV_PP2_PON_PORT_BM | MV_PP2_GMAC0_PORT_BM | MV_PP2_GMAC1_PORT_BM, oam_dmac, 1);
+	if (rcode) {
+		printk(KERN_ERR "Failed to add EOAM MAC parser rule\n");
+		return MV_ERROR;
+	}
+
+	/* Set EPON OAM ETH parsing rule in PP parser */
 	rcode = mvPrsEthTypeSet(MV_PP2_PON_PORT_BM | MV_PP2_GMAC0_PORT_BM | MV_PP2_GMAC1_PORT_BM,
 				MV_PP2_EOAM_ETH_TYPE,
 				MV_PP2_CPU_CODE_SPECIAL_PKT | MV_PP2_UDF3_SPECIAL_PKT,
@@ -3085,6 +3093,13 @@ MV_STATUS onuEponEoamChannelDel(void)
 		return MV_OK;
 	}
 
+	/* Delete EPON OAM MAC parsing rule in PP parser */
+	rcode = mvPrsMacDaAccept(MV_PP2_PON_PORT_BM | MV_PP2_GMAC0_PORT_BM | MV_PP2_GMAC1_PORT_BM, oam_dmac, 0);
+	if (rcode) {
+		printk(KERN_ERR "Failed to delete EOAM MAC parser rule\n");
+		return MV_ERROR;
+	}
+
 	/* Delete parser ETH type EPON OAM rule */
 	rcode = mvPrsEthTypeDel(MV_PP2_PON_PORT_BM | MV_PP2_GMAC0_PORT_BM | MV_PP2_GMAC1_PORT_BM,
 				MV_PP2_EOAM_ETH_TYPE);
-- 
1.7.5.4

