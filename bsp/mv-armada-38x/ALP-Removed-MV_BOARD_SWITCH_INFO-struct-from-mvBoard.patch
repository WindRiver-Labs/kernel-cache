From 8eb9a18757d037d478c3d657162241443757229f Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Sun, 19 May 2013 18:40:58 +0300
Subject: [PATCH 0665/1825] ALP: Removed MV_BOARD_SWITCH_INFO struct from
 mvBoardEnvSpec.c

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 49b8732f5a2a2d388dd6fd25a79a8e954e6444ec

	- Removed mvBoardSwitchInfoUpdate, mvBoardInternalQuadPhyAddrGet, mvBoardSwitchIrqGet
	- Updated relevant get functions:
		mvBoardSwitchConnectedPortGet, mvBoardSwitchPortForceLinkGet
		mvBoardSwitchPortMap, mvBoardSmiScanModeGet

Change-Id: I65dc299bc689d4b727054b3eeb788c8f4393be0a
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/1861
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |  170 +++----------------
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |   16 +--
 .../avanta_lp_family/boardEnv/mvBoardEnvSpec.c     |   30 +----
 3 files changed, 30 insertions(+), 186 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index b2b1770..c610215 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -818,7 +818,6 @@ MV_VOID mvBoardInfoUpdate(MV_VOID)
 
 	mvBoardEthComplexInfoUpdate();
 	mvBoardMppIdUpdate();
-	mvBoardSwitchInfoUpdate();
 	slicDev = mvCtrlSysConfigGet(MV_CONFIG_SLIC_TDM_DEVICE);
 	mvBoardSlicUnitTypeSet(slicDev);
 }
@@ -939,82 +938,6 @@ MV_STATUS mvBoardEthComplexInfoUpdate(MV_VOID)
 	mvBoardEthComplexConfigSet(ethComplexOptions);
 	return MV_OK;
 }
-/*******************************************************************************
-* mvBoardSwitchInfoUpdate
-*
-* DESCRIPTION:
-*	Update board switch information structure,
-*	according to modules detection (S@R & board configuration)
-*
-** INPUT:
-*	None.
-*
-* OUTPUT:
-*	None.
-*
-* RETURN:
-*	MV_OK - on success,
-*	MV_ERROR - On failure.
-*
-*******************************************************************************/
-MV_STATUS mvBoardSwitchInfoUpdate(MV_VOID)
-{
-	MV_U32 i, ethComplexOptions = mvBoardEthComplexConfigGet();
-
-	/* Update board switch information according to Ethernet Complex init */
-	if (mvBoardIsInternalSwitchConnected() == MV_FALSE) {
-		board->switchInfoNum = 0;
-		return MV_OK;
-	}
-
-	/* Update the cpuPort & connectedPort fields */
-	board->pSwitchInfo[0].cpuPort = -1;
-	for (i = 0; i < MV_ETH_MAX_PORTS; i++)
-		board->pSwitchInfo[0].connectedPort[i] = -1;
-
-	/* Check if Switch port 6 is connected to MAC0 */
-	if (ethComplexOptions & MV_ETHCOMP_GE_MAC0_2_SW_P6) {
-		board->pSwitchInfo[0].cpuPort = 6;	/* if connected, Switch port 6 is the default cpu port */
-		board->pSwitchInfo[0].connectedPort[0] = 6;
-	}
-
-	/* Check if Switch port 4 is connected to MAC1 */
-	if (ethComplexOptions & MV_ETHCOMP_GE_MAC1_2_SW_P4) {
-		board->pSwitchInfo[0].connectedPort[1] = 4;
-		if (board->pSwitchInfo[0].cpuPort != -1)
-			board->pSwitchInfo[0].cpuPort = 4;	/*  If Switch port 6 is not connected, set Sw port 4 to cpu port */
-	}
-
-	/* Set all switch ports to -1 and clean connected ports mask*/
-	board->pSwitchInfo[0].connectedPortMask = 0;
-	for (i=0 ; i < BOARD_ETH_SWITCH_PORT_NUM; i++)
-		board->pSwitchInfo[0].switchPort[i] = -1;
-
-	/* Set Switch port 0 */
-	if (ethComplexOptions & MV_ETHCOMP_SW_P0_2_GE_PHY_P0) {
-		board->pSwitchInfo[0].switchPort[0] = 0;
-		board->pSwitchInfo[0].connectedPortMask |= BIT0;
-	}
-	/* Set Switch port 1-2 */
-	board->pSwitchInfo[0].switchPort[1] = 1;
-	board->pSwitchInfo[0].switchPort[2] = 2;
-	board->pSwitchInfo[0].connectedPortMask |= ( BIT1 | BIT2 );
-	/* Switch port 3 */
-	if (ethComplexOptions & MV_ETHCOMP_SW_P3_2_GE_PHY_P3) {
-		board->pSwitchInfo[0].switchPort[3] = 0;
-		board->pSwitchInfo[0].connectedPortMask |= BIT3;
-	}
-	/* Set Switch port 4 */
-	if (ethComplexOptions & MV_ETHCOMP_SW_P4_2_RGMII0) {
-		board->pSwitchInfo[0].switchPort[4] = 4;
-		board->pSwitchInfo[0].connectedPortMask |= BIT4;
-	}
-	/* Set Switch port 6 */
-	if (ethComplexOptions & MV_ETHCOMP_GE_MAC0_2_SW_P6)
-		board->pSwitchInfo[0].connectedPortMask |= BIT6;
-
-	return MV_OK;
-}
 
 /*******************************************************************************
 * mvBoardBootDeviceGroupSet - test board Boot configuration and set MPP groups
@@ -1305,14 +1228,25 @@ MV_STATUS mvBoardIsInternalSwitchConnected(void)
 *       None.
 *
 * RETURN:
+*	switch port connected to the ethPort
 *
 *******************************************************************************/
 MV_32 mvBoardSwitchConnectedPortGet(MV_U32 ethPort)
 {
-	if (board->switchInfoNum == 0)
+	MV_U32 ethComplex = mvBoardEthComplexConfigGet();
+
+	if (ethPort >= board->numBoardMacInfo) {
+		mvOsPrintf("%s: Error: Illegal port number(%u)\n", __func__, ethPort);
+		return MV_FALSE;
+	}
+
+	if ((ethPort == 0) && (ethComplex & MV_ETHCOMP_GE_MAC0_2_SW_P6))
+		return 6;
+	else if ((ethPort == 1) && (ethComplex & MV_ETHCOMP_GE_MAC1_2_SW_P4))
+		return 4;
+	else
 		return -1;
 
-	return board->pSwitchInfo[0].connectedPort[ethPort];
 }
 
 /*******************************************************************************
@@ -1351,30 +1285,6 @@ MV_U32 mvBoardSwitchPortsMaskGet(MV_U32 switchIdx)
 }
 
 /*******************************************************************************
-* mvBoardInternalQuadPhyAddrGet - Get QUAD phy SMI address.
-*
-* DESCRIPTION:
-*       This routine returns the external QUAD phy address.
-*
-* INPUT:
-*       switchIdx - index of the switch. Only 0 is supported.
-*
-* OUTPUT:
-*       None.
-*
-* RETURN:
-*       The QUAD phy start address or -1 if error.
-*
-*******************************************************************************/
-MV_32 mvBoardInternalQuadPhyAddrGet(MV_U32 switchIdx)
-{
-	if ((board->switchInfoNum == 0) || (switchIdx >= board->switchInfoNum))
-		return -1;
-
-	return board->pSwitchInfo[switchIdx].internalQuadPhyAddr;
-}
-
-/*******************************************************************************
 * mvBoardSwitchPortForceLinkGet
 *
 * DESCRIPTION:
@@ -1392,10 +1302,7 @@ MV_32 mvBoardInternalQuadPhyAddrGet(MV_U32 switchIdx)
 *******************************************************************************/
 MV_U32 mvBoardSwitchPortForceLinkGet(MV_U32 switchIdx)
 {
-	if (board->switchInfoNum == 0 || switchIdx >= board->switchInfoNum)
-		return (MV_U32)MV_ERROR;
-
-	return board->pSwitchInfo[switchIdx].forceLinkMask;
+	return board->switchforceLinkMask;
 }
 
 /*******************************************************************************
@@ -2560,9 +2467,6 @@ MV_STATUS mvBoardTwsiReadByteThruMux(MV_U8 muxChNum, MV_U8 chNum,
 *******************************************************************************/
 MV_32 mvBoardSmiScanModeGet(MV_U32 switchIdx)
 {
-	if ((board->switchInfoNum == 0) || (switchIdx >= board->switchInfoNum))
-		return -1;
-
 	return BOARD_ETH_SWITCH_SMI_SCAN_MODE;
 }
 
@@ -2598,32 +2502,6 @@ MV_U32 mvBoardSwitchCpuPortGet(MV_U32 switchIdx)
 }
 
 /*******************************************************************************
-* mvBoardSwitchIrqGet - Get the IRQ number for the link status indication
-*
-* DESCRIPTION:
-*       This routine returns the IRQ number for the link status indication.
-*
-* INPUT:
-*       ethPortNum - Ethernet port number.
-*
-* OUTPUT:
-*       None.
-*
-* RETURN:
-*	the number of the IRQ for the link status indication, -1 if the port
-*	number is wrong or if not relevant.
-*
-*******************************************************************************/
-MV_32 mvBoardSwitchIrqGet(MV_VOID)
-{
-
-	if (board->switchInfoNum == 0)
-		return -1;
-
-	return board->pSwitchInfo[0].switchIrq;
-}
-
-/*******************************************************************************
 * mvBoardIsQsgmiiModuleConnected
 *
 * DESCRIPTION:
@@ -2712,16 +2590,22 @@ MV_32 mvBoardRgmiiASwitchPortGet(MV_VOID)
 *******************************************************************************/
 MV_32 mvBoardSwitchPortMap(MV_U32 switchIdx, MV_U32 switchPortNum)
 {
-	int i;
-	if (board->switchInfoNum == 0 || switchIdx >= board->switchInfoNum) {
-		mvOsPrintf("%s: Error: wrong switch index (%d)\n", __func__, switchIdx);
+	MV_U32 ethComplex = mvBoardEthComplexConfigGet();
+	if (switchPortNum >= BOARD_ETH_SWITCH_PORT_NUM) {
+		mvOsPrintf("%s: Error: wrong switch port number (%d)\n", __func__, switchPortNum);
 		return -1;
 	}
 
-	for (i = 0; i < BOARD_ETH_SWITCH_PORT_NUM; i++) {
-		if (board->pSwitchInfo[switchIdx].switchPort[i] == switchPortNum)
-			return i;
-	}
+	if ((switchPortNum == 0) && (ethComplex & MV_ETHCOMP_SW_P0_2_GE_PHY_P0))
+		return 0;
+	else if ((switchPortNum == 1) && (ethComplex & MV_ETHCOMP_SW_P1_2_GE_PHY_P1))
+		return 1;
+	else if ((switchPortNum == 2) && (ethComplex & MV_ETHCOMP_SW_P2_2_GE_PHY_P2))
+		return 2;
+	else if ((switchPortNum == 3) && (ethComplex & MV_ETHCOMP_SW_P3_2_GE_PHY_P3))
+		return 3;
+	else if ((switchPortNum == 4) && (ethComplex & MV_ETHCOMP_SW_P4_2_RGMII0))
+		return 4;
 
 	mvOsPrintf("%s: Error: switch port map not found\n", __func__);
 	return -1;
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index 6124728..4e566c1 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -177,17 +177,6 @@ typedef struct _devCsInfo {
 	MV_U8 busWidth;
 } MV_DEV_CS_INFO;
 
-typedef struct _boardSwitchInfo {
-	MV_32 switchIrq;
-	MV_32 switchPort[BOARD_ETH_SWITCH_PORT_NUM];
-	MV_32 cpuPort;
-	MV_32 connectedPort[MV_ETH_MAX_PORTS];
-	MV_32 smiScanMode;
-	MV_8 connectedPortMask;
-	MV_32 internalQuadPhyAddr;
-	MV_U32 forceLinkMask; /* Bitmask of switch ports to have force link (1Gbps) */
-} MV_BOARD_SWITCH_INFO;
-
 typedef struct _boardLedInfo {
 	MV_U8 activeLedsNumber;
 	MV_U8 ledsPolarity;     /* '0' or '1' to turn on led */
@@ -318,8 +307,7 @@ typedef struct _boardInfo {
 	MV_U32 gppPolarityValHigh;
 
 	/* External Switch Configuration */
-	MV_BOARD_SWITCH_INFO *pSwitchInfo;
-	MV_U32 switchInfoNum;
+	MV_U32 switchforceLinkMask;
 
 	/* PON configuration. */
 	MV_BOARD_PON_CONFIG ponConfigValue;
@@ -438,7 +426,6 @@ MV_U32 mvBoardSledCpuNumGet(MV_VOID);
 MV_VOID mvBoardInfoUpdate(MV_VOID);
 MV_VOID mvBoardMppIdUpdate(MV_VOID);
 MV_STATUS mvBoardEthComplexInfoUpdate(MV_VOID);
-MV_STATUS mvBoardSwitchInfoUpdate(MV_VOID);
 MV_VOID mvBoardConfigWrite(MV_VOID);
 MV_ETH_COMPLEX_TOPOLOGY mvBoardMac0ConfigGet(MV_VOID);
 MV_ETH_COMPLEX_TOPOLOGY mvBoardMac1ConfigGet(MV_VOID);
@@ -465,7 +452,6 @@ MV_BOOL mvBoardIsGMIIModuleConnected(void);
 MV_STATUS mvBoardTwsiMuxChannelSet(MV_U8 muxChNum);
 MV_STATUS mvBoardTwsiReadByteThruMux(MV_U8 muxChNum, MV_U8 chNum, MV_TWSI_SLAVE *pTwsiSlave, MV_U8 *data);
 MV_32 mvBoardSmiScanModeGet(MV_U32 switchIdx);
-MV_32 mvBoardSwitchIrqGet(void);
 MV_BOOL mvBoardIsQsgmiiModuleConnected(void);
 MV_32 mvBoardGePhySwitchPortGet(void);
 MV_32 mvBoardRgmiiASwitchPortGet(void);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
index ffea8e9..705050b 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
@@ -209,18 +209,6 @@ MV_BOARD_MPP_INFO db88f6660InfoBoardMppConfigValue[] = {
 	 } }
 };
 
-MV_BOARD_SWITCH_INFO db88f6660InfoBoardSwitchValue[] = {
-	{
-	 .switchIrq = 29,	/* set to -1 for timer operation */
-	 .switchPort = {0, 1, 2, 3, 4, -1, -1},
-	 .cpuPort = 6,
-	 .connectedPort = {6, -1},
-	 .internalQuadPhyAddr = 0,
-	 .connectedPortMask= ( BIT0| BIT1| BIT2| BIT3| BIT4| BIT6),
-	 .forceLinkMask = 0x0
-	 }
-};
-
 MV_BOARD_INFO db88f6660_board_info = {
 	.boardName			= "DB-88F6660",
 	.numBoardMppTypeValue		= ARRSZ(db88f6660InfoBoardModTypeInfo),
@@ -259,8 +247,7 @@ MV_BOARD_INFO db88f6660_board_info = {
 	.gppPolarityValHigh		= DB_88F6660_GPP_POL_HIGH,
 
 	/* External Switch Configuration */
-	.pSwitchInfo = db88f6660InfoBoardSwitchValue,
-	.switchInfoNum = ARRSZ(db88f6660InfoBoardSwitchValue),
+	.switchforceLinkMask		= 0x0,
 
 	/* TDM */
 	.numBoardTdmInfo		= {},
@@ -334,18 +321,6 @@ MV_BOARD_MPP_INFO db88f6650InfoBoardMppConfigValue[] = {
 	 } }
 };
 
-MV_BOARD_SWITCH_INFO db88f6650InfoBoardSwitchValue[] = {
-	{
-		.switchIrq = 29,	/* set to -1 for timer operation */
-		.switchPort = {0, 1, 2, 3, 4, -1, -1},
-		.cpuPort = 6,
-		.connectedPort = {6, -1},
-		.internalQuadPhyAddr = 0,
-		 .connectedPortMask = (BIT0 | BIT1 | BIT2 | BIT3 | BIT6),
-		.forceLinkMask = 0x0
-	}
-};
-
 MV_BOARD_INFO db88f6650_board_info = {
 	.boardName			= "DB-88F6650",
 	.numBoardMppTypeValue		= ARRSZ(db88f6650InfoBoardModTypeInfo),
@@ -384,8 +359,7 @@ MV_BOARD_INFO db88f6650_board_info = {
 	.gppPolarityValHigh		= DB_88F6650_GPP_POL_HIGH,
 
 	/* External Switch Configuration */
-	.pSwitchInfo = db88f6650InfoBoardSwitchValue,
-	.switchInfoNum = ARRSZ(db88f6650InfoBoardSwitchValue),
+	.switchforceLinkMask		= 0x0,
 
 	/* TDM */
 	.numBoardTdmInfo		= {},
-- 
1.7.5.4

