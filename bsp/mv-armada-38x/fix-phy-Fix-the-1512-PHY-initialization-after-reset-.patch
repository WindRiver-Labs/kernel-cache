From 498c8fc6af39e25c14254f593fe8af55be4747fd Mon Sep 17 00:00:00 2001
From: kostap <kostap@marvell.com>
Date: Tue, 8 Jul 2014 08:33:03 +0300
Subject: [PATCH 1771/1825] fix: phy: Fix the 1512 PHY initialization after
 reset issue

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 3f1dc84767b5a6234649ae93194dfbf23edf0d71

    - Remove 1512 PHY initialization bypass for A375 platform
    - Add AN enable configuration at the end of 1512 PHY basic
      initialization
    - Fixes Jira bug SYSTEMSW-737

Change-Id: I6702f116ab4fc5154e83d67fa7768fae8495ecdc
Signed-off-by: kostap <kostap@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/9045
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.c |   17 ++++++-----------
 1 files changed, 6 insertions(+), 11 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.c b/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.c
index 1339c8e..9209566 100644
--- a/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.c
+++ b/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.c
@@ -2062,17 +2062,7 @@ MV_VOID mvEth1340PhyBasicInit(void)
 *******************************************************************************/
 MV_VOID mvEthE1512PhyBasicInit(MV_U32 ethPortNum)
 {
-#if defined(MV88F672X)
-	/*
-	 * In 88F6720 DB board, phy might loose the link after reset.
-	 * This related to second time initialization as the PHY does not
-	 * receive a reset signal.
-	 * The default PHY configurations are sufficient.
-	 */
-
-	return;
-#endif
-
+	MV_U16 reg;
 /*
 	mvEthPhyRegWrite(ethphyHalData.phyAddr[ethPortNum], 0x16, 0x12);
 	mvEthPhyRegWrite(ethphyHalData.phyAddr[ethPortNum], 0x14, 0x201);
@@ -2105,6 +2095,11 @@ MV_VOID mvEthE1512PhyBasicInit(MV_U32 ethPortNum)
 		mvEthPhyRegWrite(ethphyHalData.phyAddr[ethPortNum], 0x14, 0x8001);
 	}
 	mvEthPhyRegWrite(ethphyHalData.phyAddr[ethPortNum], 0x16, 0x0000);
+
+	/* Workaround for AN remained disabled after board reset */
+	mvEthPhyRegRead(ethphyHalData.phyAddr[ethPortNum], ETH_PHY_CTRL_REG, &reg);
+	reg |= ETH_PHY_CTRL_AN_ENABLE_MASK;
+	mvEthPhyRegWrite(ethphyHalData.phyAddr[ethPortNum], ETH_PHY_CTRL_REG, reg);
 }
 
 MV_U32 mvEthPhyAddGet(MV_U32 ethPortNum)
-- 
1.7.5.4

