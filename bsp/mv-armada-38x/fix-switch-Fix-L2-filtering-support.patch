From 97d2278ecb6f9925ad53b7ab2a3b737b22fbde53 Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Thu, 8 May 2014 19:06:35 -0400
Subject: [PATCH 1650/1825] fix: switch: Fix L2 filtering support

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit c4df84dc7b2e4b449160417551cb52de740fee4b

	- Fix bug in function mv_switch_all_multicasts_del() function
	Wrong processing of unicast MAC addresses with MSB !=0x0
	- Export function mv_switch_all_multicasts_del by
	.all_mcast_del callback for MUX usage.

Change-Id: I912d3da57c4afebd5fa454c22abb42214623ef4d
Signed-off-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/7905
Reviewed-by: Uri Eliyahu <uriel@marvell.com>
Tested-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_switch/mv_switch.c           |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/mv_switch.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/mv_switch.c
index 042786c..9367cef 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/mv_switch.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/mv_switch.c
@@ -1568,6 +1568,10 @@ int mv_switch_all_multicasts_del(int db_num)
 
 	while ((status = gfdbGetAtuEntryNext(qd_dev, &atu_entry)) == GT_OK) {
 
+		/* Delete only Mcast addresses */
+		if (!is_multicast_ether_addr(atu_entry.macAddr.arEther))
+			continue;
+
 		/* we don't want to delete the broadcast entry which is the last one */
 		if (memcmp(atu_entry.macAddr.arEther, &bc_mac, 6) == 0)
 			break;
@@ -5033,6 +5037,7 @@ static const struct mv_mux_switch_ops switch_ops =  {
 	.group_disable = mv_switch_group_disable,
 	.group_enable = mv_switch_group_enable,
 	.link_status_get = mv_switch_link_status_get,
+	.all_mcast_del = mv_switch_all_multicasts_del,
 	.mac_addr_set = mv_switch_mac_addr_set,
 	.group_cookie_set = mv_switch_group_cookie_set,
 	.tag_get = mv_switch_tag_get,
-- 
1.7.5.4

