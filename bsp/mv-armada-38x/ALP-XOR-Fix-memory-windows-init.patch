From 9f753153781f5795d90943a6d7c555635348734c Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Wed, 1 May 2013 02:50:00 +0300
Subject: [PATCH 0613/1825] ALP: XOR: Fix memory windows init

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit a4557e622e3c155f50f86e7db8d505fa3d0f4004

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: Id5c1a24c7eb0737bc7e94a006f79e31af4fa63a3
Reviewed-on: http://vgitil04.il.marvell.com:8080/1705
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/dma/mv_xor.c |   13 ++++++-------
 1 files changed, 6 insertions(+), 7 deletions(-)

diff --git a/drivers/dma/mv_xor.c b/drivers/dma/mv_xor.c
index fe11ac2..42370a0 100644
--- a/drivers/dma/mv_xor.c
+++ b/drivers/dma/mv_xor.c
@@ -788,15 +788,15 @@ static enum dma_status mv_xor_status(struct dma_chan *chan,
 	struct mv_xor_chan *mv_chan = to_mv_xor_chan(chan);
 	enum dma_status ret;
 
-	/* spin_lock_bh(&mv_chan->lock); kostaz */
+	/* spin_lock_bh(&mv_chan->lock); */
 	ret = dma_cookie_status(chan, cookie, txstate);
 	if (ret == DMA_SUCCESS) {
 		mv_xor_clean_completed_slots(mv_chan);
-		/* spin_unlock_bh(&mv_chan->lock); kostaz */
+		/* spin_unlock_bh(&mv_chan->lock); */
 		return ret;
 	}
 	mv_xor_slot_cleanup(mv_chan);
-	/* spin_unlock_bh(&mv_chan->lock); kostaz */
+	/* spin_unlock_bh(&mv_chan->lock); */
 
 	return dma_cookie_status(chan, cookie, txstate);
 }
@@ -1292,7 +1292,7 @@ static struct platform_driver mv_xor_driver = {
 
 static int mv_xor_shared_probe(struct platform_device *pdev)
 {
-	const struct mbus_dram_target_info *dram;
+	struct mv_xor_platform_shared_data *msd = pdev->dev.platform_data;
 	struct mv_xor_shared_private *msp;
 	struct resource *res;
 
@@ -1325,9 +1325,8 @@ static int mv_xor_shared_probe(struct platform_device *pdev)
 	/*
 	 * (Re-)program MBUS remapping windows if we are asked to.
 	 */
-	dram = mv_mbus_dram_info();
-	if (dram)
-		mv_xor_conf_mbus_windows(msp, dram);
+	if (msd != NULL && msd->dram != NULL)
+		mv_xor_conf_mbus_windows(msp, msd->dram);
 
 	return 0;
 }
-- 
1.7.5.4

