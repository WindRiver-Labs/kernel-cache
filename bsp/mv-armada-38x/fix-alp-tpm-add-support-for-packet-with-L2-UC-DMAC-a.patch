From 1c419b58e48c7122053d05ca4c5dac9528c9d893 Mon Sep 17 00:00:00 2001
From: Jing Hua <jinghua@marvell.com>
Date: Mon, 30 Jun 2014 17:19:50 +0800
Subject: [PATCH 1753/1825] fix: alp: tpm: add support for packet with L2 UC
 DMAC and L3 MC DIP

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 2b4842b567735d7c003700337f3f3d1f3ffa6d52

	currently packet with L2 UC DMAC and L3 MC DIP does not belong to any lu_id,
	and will be assigned with default lu_id in parser, and goes to CPU. In ZTE's
	test, there is case for this kind of packet. So we add support and assign it
	to UNICAST packet type.
	SYSTEMSW-793 - <packet with unicast DMAC and multicast DIP will always be trapped to CPU>

Change-Id: Ia26456d83645ca5ee1ebcbf6b50e3914eb3aa1a0
Signed-off-by: Jing Hua <jinghua@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8808
Reviewed-by: Evan Wang <xswang@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_tpm/inc/tpm_internal_types.h |    6 ++
 .../mv_drivers_lsp/mv_tpm/src/core/tpm_parser.c    |   92 +++++++++++++++++++-
 .../mv_tpm/src/sysfs/tpm_sysfs_prs.c               |    6 ++
 3 files changed, 103 insertions(+), 1 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/inc/tpm_internal_types.h b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/inc/tpm_internal_types.h
index a2ec7e0..9610e85 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/inc/tpm_internal_types.h
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/inc/tpm_internal_types.h
@@ -210,11 +210,17 @@ enum tpm_traffic_type_t {
 	IPV6_MC_L2_TAG,
 	IPV6_MC_L2_DTAG,
 	IPV4_L2_MC_BRG_NF_UNTAG,/* L2 MC packet, which is taken as BRG packet */
+	IPV4_L2_UC_L3_MC_BRG_NF_UNTAG,/* L2 UC L3 MC packet, which is taken as BRG packet */
 	IPV4_L2_MC_BRG_NF_STAG,/* L2 MC packet, which is taken as BRG packet */
+	IPV4_L2_UC_L3_MC_BRG_NF_STAG,/* L2 UC L3 MC packet, which is taken as BRG packet */
 	IPV4_L2_MC_BRG_NF_DTAG,/* L2 MC packet, which is taken as BRG packet */
+	IPV4_L2_UC_L3_MC_BRG_NF_DTAG,/* L2 UC L3 MC packet, which is taken as BRG packet */
 	IPV6_L2_MC_BRG_NF_UNTAG,/* L2 MC packet, which is taken as BRG packet */
+	IPV6_L2_UC_L3_MC_BRG_NF_UNTAG,/* L2 UC L3 MC packet, which is taken as BRG packet */
 	IPV6_L2_MC_BRG_NF_STAG,/* L2 MC packet, which is taken as BRG packet */
+	IPV6_L2_UC_L3_MC_BRG_NF_STAG,/* L2 UC L3 MC packet, which is taken as BRG packet */
 	IPV6_L2_MC_BRG_NF_DTAG,/* L2 MC packet, which is taken as BRG packet */
+	IPV6_L2_UC_L3_MC_BRG_NF_DTAG,/* L2 UC L3 MC packet, which is taken as BRG packet */
 	IPV4_UC_BRG_NF_UNTAG,
 	IPV4_BC_L2_NF_UNTAG,
 	IPV4_BC_L3_NF_UNTAG,
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_parser.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_parser.c
index 9ac09b9..f27fde9 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_parser.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_parser.c
@@ -527,6 +527,22 @@ static struct tpm_db_prs_t tpm_prs_preconfig = {
 										 TPM_PRS_L3_CAST_MASK|
 										 TPM_PRS_FRAG_MASK|
 										 TPM_PRS_UDF3_PON_CHANNEL_MASK},		TPM_PRS_INV_TCAM_IDX,	IPV4_UC_BRG_NF_UNTAG_ID},
+		{TPM_PRS_LU_ID_ENTRY_VALID, IPV4_L2_UC_L3_MC_BRG_NF_UNTAG,	{TPM_PRS_MAC2ME_FALSE|
+										 TPM_PRS_VLAN_NONE|
+										 TPM_PRS_L2_UC|
+										 TPM_PRS_PPPOE_FALSE|
+										 TPM_PRS_L3_IPV4_IHL_E5|
+										 TPM_PRS_L3_MC|
+										 TPM_PRS_FRAG_FALSE|
+										 TPM_PRS_UDF3_PON_CHANNEL_NONE,
+										 TPM_PRS_MAC2ME_MASK|
+										 TPM_PRS_VLAN_MASK|
+										 TPM_PRS_L2_CAST_MASK|
+										 TPM_PRS_PPPOE_MASK|
+										 TPM_PRS_L3_INFO_MASK|
+										 TPM_PRS_L3_CAST_MASK|
+										 TPM_PRS_FRAG_MASK|
+				TPM_PRS_UDF3_PON_CHANNEL_MASK},	TPM_PRS_INV_TCAM_IDX,	IPV4_UC_BRG_NF_UNTAG_ID},
 		{TPM_PRS_LU_ID_ENTRY_VALID,	IPV4_L2_MC_BRG_NF_STAG,		{TPM_PRS_MAC2ME_FALSE|
 										 TPM_PRS_VLAN_SINGLE|
 										 TPM_PRS_L2_MC|
@@ -543,6 +559,22 @@ static struct tpm_db_prs_t tpm_prs_preconfig = {
 										 TPM_PRS_L3_CAST_MASK|
 										 TPM_PRS_FRAG_MASK|
 										 TPM_PRS_UDF3_PON_CHANNEL_MASK},		TPM_PRS_INV_TCAM_IDX,	IPV4_UC_BRG_NF_STAG_ID},
+		{TPM_PRS_LU_ID_ENTRY_VALID,	IPV4_L2_UC_L3_MC_BRG_NF_STAG,	{TPM_PRS_MAC2ME_FALSE|
+										 TPM_PRS_VLAN_SINGLE|
+										 TPM_PRS_L2_UC|
+										 TPM_PRS_PPPOE_FALSE|
+										 TPM_PRS_L3_IPV4_IHL_E5|
+										 TPM_PRS_L3_MC|
+										 TPM_PRS_FRAG_FALSE|
+										 TPM_PRS_UDF3_PON_CHANNEL_NONE,
+										 TPM_PRS_MAC2ME_MASK|
+										 TPM_PRS_VLAN_MASK|
+										 TPM_PRS_L2_CAST_MASK|
+										 TPM_PRS_PPPOE_MASK|
+										 TPM_PRS_L3_INFO_MASK|
+										 TPM_PRS_L3_CAST_MASK|
+										 TPM_PRS_FRAG_MASK|
+				TPM_PRS_UDF3_PON_CHANNEL_MASK},	TPM_PRS_INV_TCAM_IDX,	IPV4_UC_BRG_NF_STAG_ID},
 		{TPM_PRS_LU_ID_ENTRY_VALID,	IPV4_L2_MC_BRG_NF_DTAG,		{TPM_PRS_MAC2ME_FALSE|
 										 TPM_PRS_VLAN_DOUBLE|
 										 TPM_PRS_L2_MC|
@@ -559,6 +591,22 @@ static struct tpm_db_prs_t tpm_prs_preconfig = {
 										 TPM_PRS_L3_CAST_MASK|
 										 TPM_PRS_FRAG_MASK|
 										 TPM_PRS_UDF3_PON_CHANNEL_MASK},		TPM_PRS_INV_TCAM_IDX,	IPV4_UC_BRG_NF_DTAG_ID},
+		{TPM_PRS_LU_ID_ENTRY_VALID, IPV4_L2_UC_L3_MC_BRG_NF_DTAG,	{TPM_PRS_MAC2ME_FALSE|
+										 TPM_PRS_VLAN_DOUBLE|
+										 TPM_PRS_L2_UC|
+										 TPM_PRS_PPPOE_FALSE|
+										 TPM_PRS_L3_IPV4_IHL_E5|
+										 TPM_PRS_L3_MC|
+										 TPM_PRS_FRAG_FALSE|
+										 TPM_PRS_UDF3_PON_CHANNEL_NONE,
+										 TPM_PRS_MAC2ME_MASK|
+										 TPM_PRS_VLAN_MASK|
+										 TPM_PRS_L2_CAST_MASK|
+										 TPM_PRS_PPPOE_MASK|
+										 TPM_PRS_L3_INFO_MASK|
+										 TPM_PRS_L3_CAST_MASK|
+										 TPM_PRS_FRAG_MASK|
+				TPM_PRS_UDF3_PON_CHANNEL_MASK},	TPM_PRS_INV_TCAM_IDX,	IPV4_UC_BRG_NF_DTAG_ID},
 		{TPM_PRS_LU_ID_ENTRY_VALID,	IPV6_L2_MC_BRG_NF_UNTAG,	{TPM_PRS_MAC2ME_FALSE|
 										 TPM_PRS_VLAN_NONE|
 										 TPM_PRS_L2_MC|
@@ -573,6 +621,20 @@ static struct tpm_db_prs_t tpm_prs_preconfig = {
 										 TPM_PRS_L3_INFO_MASK|
 										 TPM_PRS_L3_CAST_MASK|
 										 TPM_PRS_UDF3_PON_CHANNEL_MASK},		TPM_PRS_INV_TCAM_IDX,	IPV6_UC_BRG_NF_UNTAG_ID},
+		{TPM_PRS_LU_ID_ENTRY_VALID, IPV6_L2_UC_L3_MC_BRG_NF_UNTAG,	{TPM_PRS_MAC2ME_FALSE|
+										 TPM_PRS_VLAN_NONE|
+										 TPM_PRS_L2_UC|
+										 TPM_PRS_PPPOE_FALSE|
+										 TPM_PRS_L3_IPV6_NO_EXT|
+										 TPM_PRS_L3_MC|
+										 TPM_PRS_UDF3_PON_CHANNEL_NONE,
+										 TPM_PRS_MAC2ME_MASK|
+										 TPM_PRS_VLAN_MASK|
+										 TPM_PRS_L2_CAST_MASK|
+										 TPM_PRS_PPPOE_MASK|
+										 TPM_PRS_L3_INFO_MASK|
+										 TPM_PRS_L3_CAST_MASK|
+				TPM_PRS_UDF3_PON_CHANNEL_MASK},	TPM_PRS_INV_TCAM_IDX,	IPV6_UC_BRG_NF_UNTAG_ID},
 		{TPM_PRS_LU_ID_ENTRY_VALID,	IPV6_L2_MC_BRG_NF_STAG,		{TPM_PRS_MAC2ME_FALSE|
 										 TPM_PRS_VLAN_SINGLE|
 										 TPM_PRS_L2_MC|
@@ -586,7 +648,21 @@ static struct tpm_db_prs_t tpm_prs_preconfig = {
 										 TPM_PRS_PPPOE_MASK|
 										 TPM_PRS_L3_INFO_MASK|
 										 TPM_PRS_L3_CAST_MASK|
-										 TPM_PRS_UDF3_PON_CHANNEL_MASK},		TPM_PRS_INV_TCAM_IDX,	IPV6_UC_BRG_NF_STAG_ID},
+				TPM_PRS_UDF3_PON_CHANNEL_MASK},	TPM_PRS_INV_TCAM_IDX,	IPV6_UC_BRG_NF_STAG_ID},
+		{TPM_PRS_LU_ID_ENTRY_VALID, IPV6_L2_UC_L3_MC_BRG_NF_STAG,	{TPM_PRS_MAC2ME_FALSE|
+										 TPM_PRS_VLAN_SINGLE|
+										 TPM_PRS_L2_UC|
+										 TPM_PRS_PPPOE_FALSE|
+										 TPM_PRS_L3_IPV6_NO_EXT|
+										 TPM_PRS_L3_MC|
+										 TPM_PRS_UDF3_PON_CHANNEL_NONE,
+										 TPM_PRS_MAC2ME_MASK|
+										 TPM_PRS_VLAN_MASK|
+										 TPM_PRS_L2_CAST_MASK|
+										 TPM_PRS_PPPOE_MASK|
+										 TPM_PRS_L3_INFO_MASK|
+										 TPM_PRS_L3_CAST_MASK|
+				TPM_PRS_UDF3_PON_CHANNEL_MASK},	TPM_PRS_INV_TCAM_IDX,	IPV6_UC_BRG_NF_STAG_ID},
 		{TPM_PRS_LU_ID_ENTRY_VALID,	IPV6_L2_MC_BRG_NF_DTAG,		{TPM_PRS_MAC2ME_FALSE|
 										 TPM_PRS_VLAN_DOUBLE|
 										 TPM_PRS_L2_MC|
@@ -601,6 +677,20 @@ static struct tpm_db_prs_t tpm_prs_preconfig = {
 										 TPM_PRS_L3_INFO_MASK|
 										 TPM_PRS_L3_CAST_MASK|
 										 TPM_PRS_UDF3_PON_CHANNEL_MASK},		TPM_PRS_INV_TCAM_IDX,	IPV6_UC_BRG_NF_DTAG_ID},
+		{TPM_PRS_LU_ID_ENTRY_VALID,	IPV6_L2_UC_L3_MC_BRG_NF_DTAG,	{TPM_PRS_MAC2ME_FALSE|
+										 TPM_PRS_VLAN_DOUBLE|
+										 TPM_PRS_L2_UC|
+										 TPM_PRS_PPPOE_FALSE|
+										 TPM_PRS_L3_IPV6_NO_EXT|
+										 TPM_PRS_L3_MC|
+										 TPM_PRS_UDF3_PON_CHANNEL_NONE,
+										 TPM_PRS_MAC2ME_MASK|
+										 TPM_PRS_VLAN_MASK|
+										 TPM_PRS_L2_CAST_MASK|
+										 TPM_PRS_PPPOE_MASK|
+										 TPM_PRS_L3_INFO_MASK|
+										 TPM_PRS_L3_CAST_MASK|
+				TPM_PRS_UDF3_PON_CHANNEL_MASK},	TPM_PRS_INV_TCAM_IDX,	IPV6_UC_BRG_NF_DTAG_ID},
 		{TPM_PRS_LU_ID_ENTRY_VALID,	IPV4_UC_BRG_NF_UNTAG,		{TPM_PRS_MAC2ME_FALSE|
 										 TPM_PRS_VLAN_NONE|
 										 TPM_PRS_L2_UC|
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/sysfs/tpm_sysfs_prs.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/sysfs/tpm_sysfs_prs.c
index fd815da..8a79a1d 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/sysfs/tpm_sysfs_prs.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/sysfs/tpm_sysfs_prs.c
@@ -82,11 +82,17 @@ static char *tpm_traffic_type_str_tbl[TPM_TRAFFIC_TYPE_MAX] = {
 	"IPV6_MC_L2_TAG",
 	"IPV6_MC_L2_DTAG",
 	"IPV4_L2_MC_BRG_NF_UNTAG",
+	"IPV4_L2_UC_L3_MC_BRG_NF_UNTAG",
 	"IPV4_L2_MC_BRG_NF_STAG",
+	"IPV4_L2_UC_L3_MC_BRG_NF_STAG",
 	"IPV4_L2_MC_BRG_NF_DTAG",
+	"IPV4_L2_UC_L3_MC_BRG_NF_DTAG",
 	"IPV6_L2_MC_BRG_NF_UNTAG",
+	"IPV6_L2_UC_L3_MC_BRG_NF_UNTAG",
 	"IPV6_L2_MC_BRG_NF_STAG",
+	"IPV6_L2_UC_L3_MC_BRG_NF_STAG",
 	"IPV6_L2_MC_BRG_NF_DTAG",
+	"IPV6_L2_UC_L3_MC_BRG_NF_DTAG",
 	"IPV4_UC_BRG_NF_UNTAG",
 	"IPV4_BC_L2_NF_UNTAG",
 	"IPV4_BC_L3_NF_UNTAG",
-- 
1.7.5.4

