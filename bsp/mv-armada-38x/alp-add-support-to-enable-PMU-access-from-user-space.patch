From 132d4d12fc7592430d47bf364b1a12396facd7e2 Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Wed, 10 Jul 2013 17:19:07 +0300
Subject: [PATCH 0861/1825] alp: add support to enable PMU access from user
 space

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit e4129608e3ff2bcfd8b54e832df11a6927a00e73

	To run benchmarks user access to PMU should
	be enabled for the below benchmarks:
		- Dhrystone (DMIPS)
		- CoreMark
		- Whetstone
		- cLinpack

	For more details, see the below section in ARMv7 User Manual:
	B4.1.125 PMUSERENR, Performance Monitors User Enable Register, VMSA

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: Idb623dc1437edd32becbb8c72755f63ad648708a
Reviewed-on: http://vgitil04.il.marvell.com:8080/2760
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Igor Patrik <igorp@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mm/Kconfig   |   12 ++++++++++++
 arch/arm/mm/proc-v7.S |    6 ++++++
 2 files changed, 18 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mm/Kconfig b/arch/arm/mm/Kconfig
index 5e837f9..445ea72 100644
--- a/arch/arm/mm/Kconfig
+++ b/arch/arm/mm/Kconfig
@@ -1197,6 +1197,16 @@ config ALP_IOCC_SYNC_BARRIER_WA
 	  This WA enables driver to keep in sync with memory
 	  updated by IO engine.
 
+config CPU_PMC_ACCESS_IN_USERMODE
+	bool "Enabled User mode access for PMC"
+	depends on CPU_V7
+	default n
+	help
+	  Say Y if you allow user mode application to access Performance
+	  Monitor Counter of CPU in user mode.
+	  For more details, see the below section in ARMv7 User Manual:
+	  B4.1.125 PMUSERENR, Performance Monitors User Enable Register, VMSA
+
 config CPU_SHEEVA_PJ4B_PMC_ACCESS_IN_USERMODE
 	bool "Enabled User mode access for PMC"
 	depends on CPU_SHEEVA_PJ4B_V6 || CPU_SHEEVA_PJ4B_V7
@@ -1204,6 +1214,8 @@ config CPU_SHEEVA_PJ4B_PMC_ACCESS_IN_USERMODE
 	help
 	  Say Y if you allow user mode application to access Performance
 	  Monitor Counter of PJ4 in user mode
+	  For more details, see the below section in ARMv7 User Manual:
+	  B4.1.125 PMUSERENR, Performance Monitors User Enable Register, VMSA
 
 config MV_SUPPORT_L2_DEPOSIT
 	bool "Support L2 Deposit"
diff --git a/arch/arm/mm/proc-v7.S b/arch/arm/mm/proc-v7.S
index 2aaf59a..64dbf5b 100644
--- a/arch/arm/mm/proc-v7.S
+++ b/arch/arm/mm/proc-v7.S
@@ -155,6 +155,12 @@ ENDPROC(cpu_v7_do_resume)
  */
 __v7_ca5mp_setup:
 __v7_ca9mp_setup:
+#ifdef CONFIG_CPU_PMC_ACCESS_IN_USERMODE
+	@ Enable performance counters user access
+	mrc     p15, 0, r0, c9, c14, 0
+	orr     r0, r0, #0x1
+	mcr     p15, 0, r0, c9, c14, 0
+#endif
 	mov	r10, #(1 << 0)			@ TLB ops broadcasting
 	b	1f
 __v7_ca7mp_setup:
-- 
1.7.5.4

