From 12f0cdba561b60cdb6200651cb6bada7536129d2 Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Wed, 4 Dec 2013 11:00:01 -0500
Subject: [PATCH 1187/1825] fix: neta: SKB recycle fix

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit cbdf6ea771fcd0e0ca78374f71cf139a3ae89e52

	WA for Linux network stack issue that prevent skb recycle.
	If dev_kfree_skb_any called from interrupt context or interrupts disabled context
	skb->users will be zero when skb_recycle callback function is called.
	In such case skb_recycle_check function returns error because skb->users != 1.

Change-Id: I529bc8c3e93f27e0c7bdfc1961eec912da8cabc8
Signed-off-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4596
Reviewed-by: Yelena Krivosheev <yelena@marvell.com>
Reviewed-by: Uri Eliyahu <uriel@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Igor Patrik <igorp@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c     |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
index b29cd81..e7d8121 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
@@ -1324,6 +1324,14 @@ int mv_eth_skb_recycle(struct sk_buff *skb)
 		STAT_DBG(pool->stats.skb_hw_cookie_err++);
 		goto err;
 	}
+	/*
+	WA for Linux network stack issue that prevent skb recycle.
+	If dev_kfree_skb_any called from interrupt context or interrupts disabled context
+	skb->users will be zero when skb_recycle callback function is called.
+	In such case skb_recycle_check function returns error because skb->users != 1.
+	*/
+	if (atomic_read(&skb->users) == 0)
+		atomic_set(&skb->users, 1);
 
 	if (skb_recycle_check(skb, pool->pkt_size)) {
 #ifdef CONFIG_MV_ETH_DEBUG_CODE
-- 
1.7.5.4

