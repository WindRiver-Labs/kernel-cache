From 9acd7c5f8cade80e2d49665f3bf13f81c174626e Mon Sep 17 00:00:00 2001
From: Ofer Heifetz <oferh@marvell.com>
Date: Thu, 6 Feb 2014 13:23:01 +0200
Subject: [PATCH 1345/1825] msys: nfc: Enable NFC support

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 5cf1f5ba68d20e851e017d2bd0642614eed60e1c

	add nfc (nand) support to msys
	add nfc to msys defconfig

Change-Id: I6a94c496b3e0a15131f1b53c4b9c1bcf3fc65275
Signed-off-by: Ofer Heifetz <oferh@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5483
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/configs/msys_defconfig            |    1 -
 arch/arm/mach-msys/Makefile                |    2 +
 arch/arm/mach-msys/config/mvSysNfcConfig.h |   36 ++++++++++
 arch/arm/mach-msys/core.c                  |  105 ++++++++++++++++++++++++++++
 arch/arm/mach-msys/mv_hal_if/mvSysNfc.c    |   93 ++++++++++++++++++++++++
 arch/arm/mach-msys/mv_hal_if/mvSysNfcApi.h |   71 +++++++++++++++++++
 6 files changed, 307 insertions(+), 1 deletions(-)
 create mode 100644 arch/arm/mach-msys/config/mvSysNfcConfig.h
 create mode 100644 arch/arm/mach-msys/mv_hal_if/mvSysNfc.c
 create mode 100644 arch/arm/mach-msys/mv_hal_if/mvSysNfcApi.h

diff --git a/arch/arm/configs/msys_defconfig b/arch/arm/configs/msys_defconfig
index c09b670..81a3f1f 100644
--- a/arch/arm/configs/msys_defconfig
+++ b/arch/arm/configs/msys_defconfig
@@ -19,7 +19,6 @@ CONFIG_PARTITION_ADVANCED=y
 CONFIG_EFI_PARTITION=y
 CONFIG_ARCH_MSYS=y
 CONFIG_MV_HAL_RULES_PATH="arch/arm/mach-armadaxp/mv_hal_support/mvRules.mk"
-# CONFIG_MV_INCLUDE_NFC is not set
 CONFIG_MV_PMU_PROC=y
 CONFIG_MV_ETH_GROUP0_CPU=0x3
 # CONFIG_SWP_EMULATE is not set
diff --git a/arch/arm/mach-msys/Makefile b/arch/arm/mach-msys/Makefile
index a38abaf..4a76f1c 100644
--- a/arch/arm/mach-msys/Makefile
+++ b/arch/arm/mach-msys/Makefile
@@ -39,6 +39,8 @@ msys-objs  			:=$(LSP_OBJS) $(COMMON_OBJS) $(OSSERVICES_OBJS) $(HAL_OBJS) 	\
 
 msys-$(CONFIG_MV_INCLUDE_SDIO)	+= $(HAL_SDMMC_DIR)/mvSdmmcAddrDec.o
 
+msys-$(CONFIG_MV_INCLUDE_NFC)	+= $(HAL_NFC_DIR)/mvNfc.o $(HAL_IF_DIR)/mvSysNfc.o
+
 msys-$(CONFIG_MV_INCLUDE_PEX) 	+= $(HAL_PEX_DIR)/mvPex.o					\
 					$(HAL_IF_DIR)/mvSysPex.o $(HAL_PEX_DIR)/mvPexAddrDec.o
 
diff --git a/arch/arm/mach-msys/config/mvSysNfcConfig.h b/arch/arm/mach-msys/config/mvSysNfcConfig.h
new file mode 100644
index 0000000..a8365b64
--- /dev/null
+++ b/arch/arm/mach-msys/config/mvSysNfcConfig.h
@@ -0,0 +1,36 @@
+/*******************************************************************************
+Copyright (C) Marvell International Ltd. and its affiliates
+
+********************************************************************************
+Marvell GPL License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File in accordance with the terms and conditions of the General
+Public License Version 2, June 1991 (the "GPL License"), a copy of which is
+available along with the File in the license.txt file or by writing to the Free
+Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 or
+on the worldwide web at http://www.gnu.org/licenses/gpl.txt.
+
+THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE IMPLIED
+WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY
+DISCLAIMED.  The GPL License provides additional details about this warranty
+disclaimer.
+
+*******************************************************************************/
+/*******************************************************************************
+* mvSysSpiConfig.h - Marvell SPI unit specific configurations
+*
+* DESCRIPTION:
+*       None.
+*
+* DEPENDENCIES:
+*       None.
+*
+*******************************************************************************/
+
+#include "mvSysHwConfig.h"
+
+/*
+** Base address for SPI registers.
+*/
+#define MV_NFC_REGS_BASE		(MV_NFC_REGS_OFFSET)
diff --git a/arch/arm/mach-msys/core.c b/arch/arm/mach-msys/core.c
index d676b91..940ac95 100644
--- a/arch/arm/mach-msys/core.c
+++ b/arch/arm/mach-msys/core.c
@@ -104,6 +104,11 @@ disclaimer.
 #include <plat/mvsdio.h>
 #endif
 
+/* NAND */
+#ifdef CONFIG_MTD_NAND_NFC
+#include "mv_mtd/nand_nfc.h"
+#endif
+
 /* for debug putstr */
 static char arr[256];
 
@@ -198,6 +203,14 @@ static int __init parse_tag_mv_uboot(const struct tag *tag)
 	printk(KERN_INFO "Using UBoot passing parameters structure\n");
 	mvUbootVer = read_tag(tag->u.mv_uboot.uboot_version);
 
+#ifdef CONFIG_MV_NAND
+	/* get NAND ECC type(1-bit or 4-bit) */
+	if ((mvUbootVer >> 8) >= 0x3040c)
+		mv_nand_ecc = read_tag(tag->u.mv_uboot.nand_ecc);
+	else
+		mv_nand_ecc = 1; /* fallback to 1-bit ECC */
+#endif
+
 	return 0;
 }
 
@@ -236,6 +249,14 @@ static int __init spec_prefesth_setup(char *__unused)
 
 __setup("sp_enable", spec_prefesth_setup);
 
+char *nfcConfig;
+static int __init nfcConfig_setup(char *s)
+{
+	nfcConfig = s;
+	return 1;
+}
+__setup("nfcConfig=", nfcConfig_setup);
+
 	MV_U32 support_wait_for_interrupt = 0x1;
 
 void __init msys_setup_cpu_mbus(void)
@@ -435,6 +456,85 @@ static void __init mv_gpio_init(void)
 	platform_device_register(&mv_gpio);
 }
 
+#ifdef CONFIG_MTD_NAND_NFC
+/*****************************************************************************
+ * NAND controller
+ ****************************************************************************/
+static struct resource msys_nfc_resources[] = {
+	{
+		.start  = INTER_REGS_BASE + MV_NFC_REGS_OFFSET,
+		.end    = INTER_REGS_BASE + MV_NFC_REGS_OFFSET + 0x400 - 1,
+		.flags  = IORESOURCE_MEM,
+	}
+};
+
+
+static struct mtd_partition nand_parts_info[] = {
+	{
+		.name		= "UBoot",
+		.offset		= 0,
+		.size		= 1 * SZ_1M
+	},
+	{
+		.name		= "UImage",
+		.offset	= MTDPART_OFS_APPEND,
+		.size		= 4 * SZ_1M },
+	{
+		.name		= "Root",
+		.offset	= MTDPART_OFS_APPEND,
+		.size         = MTDPART_SIZ_FULL
+	},
+};
+
+
+static struct nfc_platform_data msys_nfc_data = {
+	.nfc_width	= 8,
+	.num_devs	= 1,
+	.num_cs		= 1,
+	.use_dma	= 0,
+	.ecc_type	= MV_NFC_ECC_BCH_2K,
+	.parts		= nand_parts_info,
+	.nr_parts	= ARRAY_SIZE(nand_parts_info),
+};
+
+static struct platform_device msys_nfc = {
+	.name           = "armada-nand",
+	.id             = 0,
+	.dev            = {
+				.platform_data = &msys_nfc_data,
+			},
+	.num_resources  = ARRAY_SIZE(msys_nfc_resources),
+	.resource       = msys_nfc_resources,
+
+};
+
+static void __init msys_db_nfc_init(void)
+{
+	if (mvUnitMapIsMine(NAND) != MV_TRUE)
+		return;
+
+	/* Check for ganaged mode */
+	if (nfcConfig) {
+		if (strncmp(nfcConfig, "ganged", 6) == 0) {
+			msys_nfc_data.nfc_width = 16;
+			msys_nfc_data.num_devs = 2;
+			nfcConfig += 7;
+		}
+
+		/* Check for ECC type directive */
+		if (strcmp(nfcConfig, "8bitecc") == 0)
+			msys_nfc_data.ecc_type = MV_NFC_ECC_BCH_1K;
+		else if (strcmp(nfcConfig, "12bitecc") == 0)
+			msys_nfc_data.ecc_type = MV_NFC_ECC_BCH_704B;
+		else if (strcmp(nfcConfig, "16bitecc") == 0)
+			msys_nfc_data.ecc_type = MV_NFC_ECC_BCH_512B;
+	}
+
+	msys_nfc_data.tclk = mvBoardTclkGet();
+
+	platform_device_register(&msys_nfc);
+}
+#endif
 
 /*********************************************************************************/
 /**************                      Helper Routines                **************/
@@ -793,6 +893,11 @@ static void __init msys_bc2_rd_init(void)
 	msys_sdio_init();
 #endif
 
+	/* NAND */
+#ifdef CONFIG_MTD_NAND_NFC
+	msys_db_nfc_init();
+#endif
+
 	return;
 }
 
diff --git a/arch/arm/mach-msys/mv_hal_if/mvSysNfc.c b/arch/arm/mach-msys/mv_hal_if/mvSysNfc.c
new file mode 100644
index 0000000..f806820
--- /dev/null
+++ b/arch/arm/mach-msys/mv_hal_if/mvSysNfc.c
@@ -0,0 +1,93 @@
+/*******************************************************************************
+Copyright (C) Marvell International Ltd. and its affiliates
+
+This software file (the "File") is owned and distributed by Marvell
+International Ltd. and/or its affiliates ("Marvell") under the following
+alternative licensing terms.  Once you have made an election to distribute the
+File under one of the following license alternatives, please (i) delete this
+introductory statement regarding license alternatives, (ii) delete the two
+license alternatives that you have not elected to use and (iii) preserve the
+Marvell copyright notice above.
+
+********************************************************************************
+Marvell Commercial License Option
+
+If you received this File from Marvell and you have entered into a commercial
+license agreement (a "Commercial License") with Marvell, the File is licensed
+to you under the terms of the applicable Commercial License.
+
+********************************************************************************
+Marvell GPL License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File in accordance with the terms and conditions of the General
+Public License Version 2, June 1991 (the "GPL License"), a copy of which is
+available along with the File in the license.txt file or by writing to the Free
+Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 or
+on the worldwide web at http://www.gnu.org/licenses/gpl.txt.
+
+THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE IMPLIED
+WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY
+DISCLAIMED.  The GPL License provides additional details about this warranty
+disclaimer.
+********************************************************************************
+Marvell BSD License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File under the following licensing terms.
+Redistribution and use in source and binary forms, with or without modification,
+are permitted provided that the following conditions are met:
+
+    *   Redistributions of source code must retain the above copyright notice,
+	this list of conditions and the following disclaimer.
+
+    *   Redistributions in binary form must reproduce the above copyright
+	notice, this list of conditions and the following disclaimer in the
+	documentation and/or other materials provided with the distribution.
+
+    *   Neither the name of Marvell nor the names of its contributors may be
+	used to endorse or promote products derived from this software without
+	specific prior written permission.
+
+THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
+ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
+ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
+ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+
+*******************************************************************************/
+
+#include "mvCommon.h"
+#include "mvOs.h"
+#include "ctrlEnv/mvCtrlEnvLib.h"
+#include "nfc/mvNfc.h"
+
+
+/*******************************************************************************
+* mvSysNetaInit - Initialize the Eth subsystem
+*
+* DESCRIPTION:
+*
+* INPUT:
+*       None
+* OUTPUT:
+*		None
+* RETURN:
+*       None
+*
+*******************************************************************************/
+MV_STATUS mvSysNfcInit(MV_NFC_INFO *nfcInfo, MV_NFC_CTRL *nfcCtrl)
+{
+	struct MV_NFC_HAL_DATA halData;
+
+	memset(&halData, 0, sizeof(halData));
+
+	halData.mvCtrlNandClkSetFunction = mvCtrlNandClkSet;
+
+	return mvNfcInit(nfcInfo, nfcCtrl, &halData);
+}
diff --git a/arch/arm/mach-msys/mv_hal_if/mvSysNfcApi.h b/arch/arm/mach-msys/mv_hal_if/mvSysNfcApi.h
new file mode 100644
index 0000000..e7a13c7
--- /dev/null
+++ b/arch/arm/mach-msys/mv_hal_if/mvSysNfcApi.h
@@ -0,0 +1,71 @@
+/*******************************************************************************
+Copyright (C) Marvell International Ltd. and its affiliates
+
+This software file (the "File") is owned and distributed by Marvell
+International Ltd. and/or its affiliates ("Marvell") under the following
+alternative licensing terms.  Once you have made an election to distribute the
+File under one of the following license alternatives, please (i) delete this
+introductory statement regarding license alternatives, (ii) delete the two
+license alternatives that you have not elected to use and (iii) preserve the
+Marvell copyright notice above.
+
+********************************************************************************
+Marvell Commercial License Option
+
+If you received this File from Marvell and you have entered into a commercial
+license agreement (a "Commercial License") with Marvell, the File is licensed
+to you under the terms of the applicable Commercial License.
+
+********************************************************************************
+Marvell GPL License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File in accordance with the terms and conditions of the General
+Public License Version 2, June 1991 (the "GPL License"), a copy of which is
+available along with the File in the license.txt file or by writing to the Free
+Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 or
+on the worldwide web at http://www.gnu.org/licenses/gpl.txt.
+
+THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE IMPLIED
+WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY
+DISCLAIMED.  The GPL License provides additional details about this warranty
+disclaimer.
+********************************************************************************
+Marvell BSD License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File under the following licensing terms.
+Redistribution and use in source and binary forms, with or without modification,
+are permitted provided that the following conditions are met:
+
+    *   Redistributions of source code must retain the above copyright notice,
+	    this list of conditions and the following disclaimer.
+
+    *   Redistributions in binary form must reproduce the above copyright
+	notice, this list of conditions and the following disclaimer in the
+	documentation and/or other materials provided with the distribution.
+
+    *   Neither the name of Marvell nor the names of its contributors may be
+	used to endorse or promote products derived from this software without
+	specific prior written permission.
+
+THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
+ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
+ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
+ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+
+*******************************************************************************/
+
+#ifndef __MV_SYS_NFC_API_H__
+#define __MV_SYS_NFC_API_H__
+#include "nfc/mvNfc.h"
+
+MV_STATUS mvSysNfcInit(MV_NFC_INFO *nfcInfo, MV_NFC_CTRL *nfcCtrl);
+
+#endif  /* __MV_SYS_NFC_API_H__  */
-- 
1.7.5.4

