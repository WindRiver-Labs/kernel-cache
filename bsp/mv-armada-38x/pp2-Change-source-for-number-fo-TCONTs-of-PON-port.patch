From 38dbfa238561169088c11efb0752f85b66a5f8f6 Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Mon, 29 Jul 2013 15:20:11 -0400
Subject: [PATCH 0903/1825] pp2: Change source for number fo TCONTs of PON
 port

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit a7172de91bd06b378811bf995959bd0e1794b01c

	- Pass number of TCONTs for PON port as HalInit structure
	- Don't use CONFIG_MV_PON_TCONTS define

Change-Id: Ie9f0956ad3978b96b61d85a360fd5a26bf31873d
Signed-off-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/2867
Reviewed-by: Jonatan Farhadian <yonif@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Tested-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |    2 +-
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h      |    4 ++++
 arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c     |    2 +-
 .../arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c |    2 +-
 4 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index 8e7d327..31331a2 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -3175,7 +3175,7 @@ void    mv_eth_hal_shared_init(struct mv_pp2_pdata *plat_data)
 	halData.aggrTxqSize = CONFIG_MV_ETH_AGGR_TXQ_SIZE;
 
 #ifdef CONFIG_MV_INCLUDE_PON
-	halData.maxTcont = MV_ETH_MAX_TCONT;
+	halData.maxTcont = CONFIG_MV_PON_TCONTS;
 #endif
 
 	mvPp2HalInit(&halData);
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h
index bad4eb1..58a6670 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h
@@ -42,6 +42,10 @@ disclaimer.
 #include "bm/mvBmRegs.h"
 #include "bm/mvBm.h"
 
+#ifndef CONFIG_MV_PON_TCONTS
+# define CONFIG_MV_PON_TCONTS 1
+#endif
+
 /******************************************************
  * driver statistics control --                       *
  ******************************************************/
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c
index 90bbf8d..be7503f 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c
@@ -922,7 +922,7 @@ void *mvPp2PortInit(int port, int firstRxq, int numRxqs, void *osHandle)
 
 	/* associate TXQs to this port */
 #ifdef CONFIG_MV_INCLUDE_PON
-	pCtrl->txpNum = MV_PON_PORT(port) ? CONFIG_MV_PON_TCONTS : 1;
+	pCtrl->txpNum = MV_PON_PORT(port) ? mvPp2HalData.maxTcont : 1;
 #else
 	pCtrl->txpNum = 1;
 #endif
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c
index 9f976f5..8fcc47e 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c
@@ -514,7 +514,7 @@ void mvPp2DropCntrs(int port)
 
 	if (MV_PON_PORT(port)) {
 #ifdef CONFIG_MV_INCLUDE_PON
-		for (i = 0; i < CONFIG_MV_PON_TCONTS; i++) {
+		for (i = 0; i < mvPp2HalData.maxTcont; i++) {
 			mvPp2RegPrint2(MV_PP2_TX_EARLY_DROP_REG(i), "MV_PP2_TX_EARLY_DROP_REG", i);
 			mvPp2RegPrint2(MV_PP2_TX_DESC_DROP_REG(i), "MV_PP2_TX_DESC_DROP_REG", i);
 		}
-- 
1.7.5.4

