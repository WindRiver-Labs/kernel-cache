From 8e68e9a640426b0342ccf55d5fd690c57e275574 Mon Sep 17 00:00:00 2001
From: Nadav Haklai <nadavh@marvell.com>
Date: Mon, 17 Feb 2014 19:53:03 +0200
Subject: [PATCH 1395/1825] a38x: cesa: add cesa support for a385

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit b42730a889ec6ad8c0fc7da94778d083b795e7ab

Change-Id: I1b5493dabae71afacaad987d669fea7782cbc9d2
Signed-off-by: Marcin Wojtas <mw@semihalf.com>
Signed-off-by: Grzegorz Jaszczyk <jaz@semihalf.com>
Signed-off-by: Nadav Haklai <nadavh@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5746
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.c       |    2 +-
 .../armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h      |    5 ++++-
 arch/arm/plat-armada/mv_hal/cesa/mvCesa.c          |    4 ++++
 3 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
index d98c58c..e2266ea 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
@@ -130,7 +130,7 @@ MV_UNIT_ID mvCtrlSocUnitNums[MAX_UNITS_ID][MV_68xx_INDEX_MAX] = {
 /* SATA_UNIT_ID         */ { MV_SATA_MAX_CHAN,		MV_SATA_MAX_CHAN},
 /* TDM_32CH_UNIT_ID     */ { 1,				1},
 /* UART_UNIT_ID         */ { MV_UART_MAX_CHAN,		MV_UART_MAX_CHAN},
-/* CESA_UNIT_ID         */ { 1,				1},
+/* CESA_UNIT_ID         */ { 2,				2},
 /* SPI_UNIT_ID          */ { 1,				1},
 /* AUDIO_UNIT_ID        */ { 1,				1},
 /* SDIO_UNIT_ID         */ { 1,				1},
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
index df4c7a9..5be126a 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -340,7 +340,8 @@ typedef enum _mvTarget {
 	BOOT_ROM_CS,	/* 26 BOOT_ROM_CS		*/
 	DEV_BOOCS,	/* 27 DEV_BOOCS			*/
 	CRYPT0_ENG,	/* 28 Crypto0 Engine		*/
-	PNC_BM,		/* 29 PNC + BM			*/
+	CRYPT1_ENG,	/* 29 Crypto1 Engine		*/
+	PNC_BM,		/* 30 PNC + BM			*/
 	MAX_TARGETS
 } MV_TARGET;
 
@@ -389,6 +390,7 @@ typedef enum _mvTarget {
 	{ MAIN_BOOT_ATTR, DEV_TARGET_ID },	/* Main Boot device      */ \
 	{ SEC_BOOT_ATTR, DEV_TARGET_ID  },	/* Secondary Boot device */ \
 	{ 0x01, CRYPT_TARGET_ID	},		/* CRYPT_ENG0            */ \
+	{ 0x05, CRYPT_TARGET_ID	},		/* CRYPT_ENG1            */ \
 	{0x00, PNC_BM_TARGET_ID },		/* PNC_BM		 */ \
 }
 
@@ -423,6 +425,7 @@ typedef enum _mvTarget {
 	"BOOT_ROM_CS",		/* BOOT_ROM_CS */	\
 	"DEV_BOOTCS",		/* DEV_BOOCS */		\
 	"CRYPT1_ENG",		/* CRYPT1_ENG */	\
+	"CRYPT2_ENG",		/* CRYPT2_ENG */	\
 	"PNC_BM"		/* PNC_BM */		\
 }
 
diff --git a/arch/arm/plat-armada/mv_hal/cesa/mvCesa.c b/arch/arm/plat-armada/mv_hal/cesa/mvCesa.c
index 05f983b..2724576 100644
--- a/arch/arm/plat-armada/mv_hal/cesa/mvCesa.c
+++ b/arch/arm/plat-armada/mv_hal/cesa/mvCesa.c
@@ -394,6 +394,10 @@ MV_STATUS mvCesaHalInit(int numOfSession, int queueDepth, void *osHandle, MV_CES
 			/* Support maximum of 4 outstanding read transactions */
 			MV_REG_BIT_SET(MV_CESA_TDMA_CTRL_REG(chan), MV_CESA_TDMA_OUTSTAND_NEW_MODE_BIT);
 			break;
+		case 0x6800: /* A38x */
+			MV_REG_BIT_SET(MV_CESA_TDMA_CTRL_REG(chan), MV_CESA_TDMA_OUTSTAND_OUT_OF_ORDER_3TRANS_BIT);
+			sha2CmdVal = BIT31;
+			break;
 		case 0x7800: /* AXP */
 			if (ctrlRev < 1) { /* Z1 step */
 #ifdef AURORA_IO_CACHE_COHERENCY
-- 
1.7.5.4

