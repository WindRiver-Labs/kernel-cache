From 98be1e4139d6727339d9ef2413a93359c1373732 Mon Sep 17 00:00:00 2001
From: Hanna Hawa <hannah@marvell.com>
Date: Sun, 25 May 2014 20:03:23 +0300
Subject: [PATCH 1675/1825] fix: alp: eth complex: enabled Auto-Negotiation
 sequence for MAC1->PonSerdes[SFP]

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 7eab8fa5f48a1aeab7a8735f40ce8ab10fdcb23a

	enabled Auto-Negotiation sequence for MAC1->PonSerdes[SFP]
	when connect MAC1 to PonSerdes via SFP transmitter

Change-Id: I53ccaddc5c593eda76809beb7e64ebe2fff1a69a
Signed-off-by: Hanna Hawa <hannah@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8192
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |    3 ++-
 .../avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c    |    6 ++++--
 2 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index 9730de0..81eb0f6 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -975,7 +975,8 @@ MV_VOID mvBoardInfoUpdate(MV_VOID)
 		smiAddress = 0x5;
 	else {
 		smiAddress = -1; /* no SMI address if connected to switch */
-		macSpeed = BOARD_MAC_SPEED_1000M;
+		if (!(ethComplex & MV_ETHCOMP_GE_MAC1_2_PON_ETH_SERDES_SFP))
+			macSpeed = BOARD_MAC_SPEED_1000M;
 	}
 	mvBoardPhyAddrSet(1, smiAddress);
 	mvBoardMacSpeedSet(1, macSpeed);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
index bf37386..d3964cc 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
@@ -439,8 +439,10 @@ static void mvEthComplexMacToComPhy(MV_U32 port, MV_U32 comPhy, MV_U32 ethComple
 		mvEthComplexPortDpClkSrcSet(port, 0x1);
 }
 
-static void mvEthComplexMac1ToPonSerdes(MV_U32 port)
+static void mvEthComplexMac1ToPonSerdes(MV_U32 port, MV_U32 ethComplexOptions)
 {
+	if (ethComplexOptions & MV_ETHCOMP_GE_MAC1_2_PON_ETH_SERDES_SFP)
+		mvEthComplexPortInBandAnEnable(port, MV_TRUE);
 	/* 0x1 = Mac#1 is source for GponPhy */
 	mvEthComplexGponPhySrcSet(0x1);
 }
@@ -501,7 +503,7 @@ MV_STATUS mvEthComplexInit(MV_U32 ethCompConfig)
 		mvEthComplexMacToRgmii(1);
 
 	if (c & (MV_ETHCOMP_GE_MAC1_2_PON_ETH_SERDES | MV_ETHCOMP_GE_MAC1_2_PON_ETH_SERDES_SFP))
-		mvEthComplexMac1ToPonSerdes(1);
+		mvEthComplexMac1ToPonSerdes(1, c);
 
 	if (c & MV_ETHCOMP_SW_P0_2_GE_PHY_P0)
 		mvEthComplexSwPortToGbePhy(0, 0);
-- 
1.7.5.4

