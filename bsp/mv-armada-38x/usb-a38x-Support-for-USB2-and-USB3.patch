From e54eca19b5ac7e062efe779f6639849829df0287 Mon Sep 17 00:00:00 2001
From: Eli Nidam <elini@marvell.com>
Date: Tue, 28 Jan 2014 18:35:33 +0200
Subject: [PATCH 1325/1825] usb: a38x: Support for USB2 and USB3

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 69af99350921ef4d6f9dc2803741695b73510e6e

	This introduces USB2/3 support for Armada 38x:
	- Added isUsb3 Boolean to mvSysUsbInit to indicate if USB3/2 is initialized
	- Disabled mvUsbPllInit from USB 2 init sequence for A38x (not relevant for A38x)
	- Added delay WA for armada 38x xHCI timing issue
	- Added usbActive support to xHCI initialization sequence
	- Added getUsbActive generic routine for both xHCI/eHCI usage
	- Aligned a375/alp USB3 definitions

	** currently eHCI (USB2) is selected (pre-compilation) **
	- To compile USB3 support: define MV_USB3, and undefine MV_USB2 (include/configs/armada_38x.h)

	** A38x DB board: USB2 port 0 is supported, and USB3 port 0 (USB3 port 1 not supported yet)
	** A38x RD board: USB3 port 0 is supported for both eHCI/xHCI usage (USB2 port not supported yet)

Change-Id: I5fb9eca779c7c135aea16f3aea3d1a8f4f32773c
Signed-off-by: Eli Nidam <elini@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5357
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.c       |    2 +-
 .../armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h      |    3 +++
 .../armada_38x_family/ctrlEnv/sys/mvCpuIfRegs.h    |    2 +-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |    2 ++
 4 files changed, 7 insertions(+), 2 deletions(-)
 mode change 100755 => 100644 arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h

diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
index 01608b1..ed69dd6 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
@@ -311,7 +311,6 @@ MV_VOID mvCtrlSerdesConfigDetect(MV_VOID)
 	}
 	mvCtrlSocUnitInfoNumSet(PEX_UNIT_ID, boardPexInfo->boardPexIfNum);
 	mvCtrlSocUnitInfoNumSet(SATA_UNIT_ID , sataIfCount);
-	mvCtrlSocUnitInfoNumSet(USB_UNIT_ID , usbIfCount);
 	mvCtrlSocUnitInfoNumSet(USB3_UNIT_ID, usbHIfCount);
 	if (ethIfCount) /* if serdes configuration found SGMII ports replace the existing RGMII gonfiguration*/
 		mvCtrlSocUnitInfoNumSet(ETH_GIG_UNIT_ID, ethIfCount);
@@ -322,6 +321,7 @@ MV_VOID mvCtrlSerdesConfigDetect(MV_VOID)
 	DB(printf("mvCtrlSocUnitGet[SATA]= %d,\n", mvCtrlSocUnitInfoNumGet(SATA_UNIT_ID)));
 	DB(printf("mvCtrlSocUnitGet[USBH]= %d,\n", mvCtrlSocUnitInfoNumGet(USB_UNIT_ID)));
 	DB(printf("mvCtrlSocUnitGet[USB3]= %d,\n", mvCtrlSocUnitInfoNumGet(USB3_UNIT_ID)));
+	DB(printf("mvCtrlSocUnitGet[USB2]= %d,\n", mvCtrlSocUnitInfoNumGet(USB_UNIT_ID)));
 }
 
 /*******************************************************************************
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
index 7604ddd..df4c7a9 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -134,6 +134,9 @@ extern "C" {
 #define SATA3_MAX_PORTS_PER_UNIT		2
 #define MV_ETH_SMI_PORT   0
 
+/* USB3 registers */
+#define USB3_REGS_PHYS_BASE(dev)		(INTER_REGS_BASE + MV_USB3_REGS_BASE(dev))
+
 /*
  * Miscellanuous Controller Configurations
  */
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/sys/mvCpuIfRegs.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/sys/mvCpuIfRegs.h
index 03e2fb7..1f5da59 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/sys/mvCpuIfRegs.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/sys/mvCpuIfRegs.h
@@ -113,7 +113,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define PCIE1_QUADX1_EN				(1<<8)
 
 /* USB Configuration registers */
-#define USB_CONFIG_REG				(MV_IP_CONFIG_REGS_BASE + 0x20)
+#define USB_CLUSTER_CONTROL                    (MV_IP_CONFIG_REGS_BASE)
 
 /* ARM Configuration register */
 /* CPU_CONFIG_REG (CCR) */
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
old mode 100755
new mode 100644
index a355e65..70b8e88
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -143,6 +143,8 @@ extern "C" {
 
 #define MV_ETH_SMI_PORT   0
 
+#define MV_USB3_WIN_BASE(unitId)		MV_USB3_REGS_OFFSET(unitId)
+
 /*
  * Miscellanuous Controller Configurations
  */
-- 
1.7.5.4

