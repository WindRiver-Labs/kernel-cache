From 254be9816beb57dd3b3e9bb373018dafb76f9348 Mon Sep 17 00:00:00 2001
From: Hanna Hawa <hannah@marvell.com>
Date: Thu, 2 Jan 2014 17:47:15 +0200
Subject: [PATCH 1263/1825] fix: alp: add check conflicts between Audio
 modules and NAND

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 54713e5dfe22cbd5fde1919736ff8191a569936c

	- Create function that print error if founded conflicts between
	  Audio modules and NAND

Change-Id: I6310c2bc74a391a1b126385299e85dcd525342fd
Signed-off-by: Hanna Hawa <hannah@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5019
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   30 ++++++++++++++++++++
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    1 +
 2 files changed, 31 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index 452adaf..f8200dee9 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -1184,6 +1184,9 @@ MV_BOARD_BOOT_SRC mvBoardBootDeviceGroupSet()
 	MV_U32 groupType;
 	MV_BOARD_BOOT_SRC bootSrc = mvBoardBootDeviceGet();
 
+	/* Check conflicts between device bus module and NAND */
+	mvBoardAudioModuleConfigCheck();
+
 	switch (bootSrc) {
 	case MSAR_0_BOOT_NAND_NEW:
 		mvBoardMppTypeSet(0, NAND_BOOT_V2);
@@ -1778,6 +1781,30 @@ MV_U8 mvBoardTdmSpiIdGet(MV_VOID)
 }
 
 /*******************************************************************************
+* mvBoardAudioModuleConfigCheck
+*
+* DESCRIPTION:
+*	Check if used audio modules when booting from NAND
+*
+* INPUT:
+*	None.
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*	None.
+*
+*******************************************************************************/
+MV_VOID mvBoardAudioModuleConfigCheck(MV_VOID)
+{
+	if ((mvBoardBootDeviceGet() == MSAR_0_BOOT_NAND_NEW) &&
+		((mvCtrlSysConfigGet(MV_CONFIG_DEVICE_BUS_MODULE) == 0x2) ||		/* 0x2=I2S_AUDIO   */
+		(mvCtrlSysConfigGet(MV_CONFIG_DEVICE_BUS_MODULE) == 0x3)))		/* 0x3=SPDIF_AUDIO */
+			mvOsPrintf("Error: Audio modules not supported when booting from NAND\n");
+}
+
+/*******************************************************************************
 * mvBoardConfigurationPrint
 *
 * DESCRIPTION:
@@ -2782,6 +2809,9 @@ MV_STATUS mvBoardEepromWrite(MV_CONFIG_TYPE_ID configType, MV_U8 value)
 	/* run conflict verification sequence on MAC and SerDes configuration */
 	mvBoardEthComplexMacConfigCheck();
 
+	/* Check conflicts between device bus module and NAND */
+	mvBoardAudioModuleConfigCheck();
+
 	return MV_OK;
 }
 
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index 2d7e679..c397da4 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -530,6 +530,7 @@ MV_32 mvBoardTdmSpiModeGet(MV_VOID);
 MV_U8 mvBoardTdmDevicesCountGet(void);
 MV_U8 mvBoardTdmSpiCsGet(MV_U8 devId);
 MV_U8 mvBoardTdmSpiIdGet(MV_VOID);
+MV_VOID mvBoardAudioModuleConfigCheck(MV_VOID);
 MV_VOID mvBoardConfigurationPrint(MV_VOID);
 MV_BOOL mvBoardIsGbEPortConnected(MV_U32 ethPortNum);
 MV_32 mvBoardGetDevicesNumber(MV_BOARD_DEV_CLASS devClass);
-- 
1.7.5.4

