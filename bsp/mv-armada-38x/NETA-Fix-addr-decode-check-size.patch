From 5d319e86253fe3b4e7d69c405571ab87f85d5090 Mon Sep 17 00:00:00 2001
From: Tawfik Bayouk <tawfik@marvell.com>
Date: Tue, 21 Aug 2012 17:34:30 +0300
Subject: [PATCH 0118/1825] NETA: Fix addr decode check size

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit c739d094b485a5852fbfa5865cabf67e859a8345

Change-Id: I0485a8d075e1c63582f05d95f92fb2d39ec0145b
Signed-off-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../plat-armada/mv_hal/neta/gbe/mvNetaAddrDec.c    |   28 ++++++++++----------
 1 files changed, 14 insertions(+), 14 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/neta/gbe/mvNetaAddrDec.c b/arch/arm/plat-armada/mv_hal/neta/gbe/mvNetaAddrDec.c
index 03edf46..8421d75 100644
--- a/arch/arm/plat-armada/mv_hal/neta/gbe/mvNetaAddrDec.c
+++ b/arch/arm/plat-armada/mv_hal/neta/gbe/mvNetaAddrDec.c
@@ -170,19 +170,28 @@ MV_STATUS mvNetaWinWrite(MV_U32 port, MV_U32 winNum, MV_UNIT_WIN_INFO *pAddrDecW
 	MV_U32 size, alignment;
 	MV_U32 baseReg, sizeReg;
 
-	if (!MV_IS_POWER_OF_2(pAddrDecWin->addrWin.size)) {
-		/* try to get a good size */
-		pAddrDecWin->addrWin.size = 1 << (mvLog2(pAddrDecWin->addrWin.size) + 1);
-	}
 	/* Parameter checking   */
 	if (winNum >= ETH_MAX_DECODE_WIN) {
 		mvOsPrintf("mvNetaWinSet: ERR. Invalid win num %d\n", winNum);
 		return MV_BAD_PARAM;
 	}
 
+	size = pAddrDecWin->addrWin.size;
+	if (size == 0) {
+		mvOsPrintf("%s: ERR. Invalid window size %d\n",	__func__, size);
+		return MV_BAD_PARAM;
+	}
+	if (!MV_IS_POWER_OF_2(size)) {
+		/* try to get a good size */
+		pAddrDecWin->addrWin.size = 1 << (mvLog2(size) + 1);
+		mvOsPrintf("%s: WARN. Wrong window size %d, rounding to %d\n",
+			__func__, size, pAddrDecWin->addrWin.size);
+		size = pAddrDecWin->addrWin.size;
+	}
+
 	/* Check if the requested window overlapps with current windows     */
 	if (MV_TRUE == ethWinOverlapDetect(port, winNum, &pAddrDecWin->addrWin)) {
-		mvOsPrintf("mvNetaWinWrite: ERR. Window %d overlap\n", winNum);
+		mvOsPrintf("%s: ERR. Window %d overlap\n", __func__, winNum);
 		return MV_ERROR;
 	}
 
@@ -194,15 +203,6 @@ MV_STATUS mvNetaWinWrite(MV_U32 port, MV_U32 winNum, MV_UNIT_WIN_INFO *pAddrDecW
 		return MV_ERROR;
 	}
 
-	if (pAddrDecWin->addrWin.size != 0) {
-		size = pAddrDecWin->addrWin.size;
-		if (!MV_IS_POWER_OF_2(size)) {
-			mvOsPrintf("mvNetaWinWrite: Error setting AUDIO window %d. "
-				"Window size is not a power to 2.", winNum);
-			return MV_BAD_PARAM;
-		}
-	}
-
 	baseReg = (pAddrDecWin->addrWin.baseLow & ETH_WIN_BASE_MASK);
 	sizeReg = MV_REG_READ(ETH_WIN_SIZE_REG(port, winNum));
 
-- 
1.7.5.4

