From a409514e11cf2c4cf68738c87236c3465ed97419 Mon Sep 17 00:00:00 2001
From: Tawfik Bayouk <tawfik@marvell.com>
Date: Tue, 21 Aug 2012 17:35:27 +0300
Subject: [PATCH 0179/1825] DSMP: adding CONFIG_SHEEVA_ERRATA_ARM_CPU_6409
 wrapper to an already implemented errata

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit dd38377d0293aae938b3cb2216906765c885fadb

Change-Id: I2515625f963b82a1e03644554cce12d021be96ef
Signed-off-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mm/Kconfig              |   14 ++++++++++++++
 arch/arm/mm/proc-sheeva_pj4bv7.S |    2 ++
 2 files changed, 16 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mm/Kconfig b/arch/arm/mm/Kconfig
index 29e2b77..9ba6abb 100644
--- a/arch/arm/mm/Kconfig
+++ b/arch/arm/mm/Kconfig
@@ -967,7 +967,21 @@ config SHEEVA_ERRATA_ARM_CPU_4948
 	  line boundary (i.e., unaligned access). If it does occur, L0 data
 	  cache can be disabled
 
+config SHEEVA_ERRATA_ARM_CPU_6409
 
+        bool "Sheeva Errata 6409: Processor may execute incorrect instructions when two ARM-mode conditional branches are back-toback and double-word-aligned"
+        depends on  CPU_SHEEVA_PJ4B_V7 && ARMADA_XP_REV_A0
+        default y
+        help
+	In a certain rare case the processor will evaluate a branch incorrectly leading to incorrect execution of instructions.
+	The bug occurs when the static predictor is incorrectly applied to a branch instruction when a dynamic predictor
+	predicts that a branch should not be taken
+	Workaround:
+		To avoid this bug with minimal performance impact, the static branch predictor can be disabled by writing a "0" to bit[2]
+		of the Auxiliary Debug Modes Control Register as follows:
+		mrc p15, 1, r0, c15, c1, 1
+		bic r0, r0, 0x4; disable static prediction
+		mcr p15, 1, r0, c15, c1, 1
 
 config SHEEVA_ERRATA_ARM_CPU_5980
 
diff --git a/arch/arm/mm/proc-sheeva_pj4bv7.S b/arch/arm/mm/proc-sheeva_pj4bv7.S
index ec52d8f..1673b55 100644
--- a/arch/arm/mm/proc-sheeva_pj4bv7.S
+++ b/arch/arm/mm/proc-sheeva_pj4bv7.S
@@ -393,7 +393,9 @@ defined(CONFIG_SMP)
 	mrc        p15, 1, r0, c15, c1, 1                         /* Read */
 	orr        r0, r0, #0x00020                                /* BIT5 STREX backoff_disable--> '1' enable the back off of STREX instr */
 	orr	   r0, r0, #0x00100                                /* BIT8 Internal Parity Handling Disable--> '1' Disable Internal Parity Handling */
+#ifdef CONFIG_SHEEVA_ERRATA_ARM_CPU_6409
 	bic        r0, r0, #0x4                                 /* Disable Static BP */
+#endif
 	mcr        p15, 1, r0, c15, c1, 1                         /* Write */
 /* Auxiliary Functional Modes Control Register 0 */
 	mrc        p15, 1, r0, c15, c2, 0                         /* Read */
-- 
1.7.5.4

