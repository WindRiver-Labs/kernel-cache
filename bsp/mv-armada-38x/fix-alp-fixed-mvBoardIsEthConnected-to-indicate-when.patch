From 5dfd7ac1f1f6aac6d12cdae092117cb9ddb6a2ca Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Thu, 28 Nov 2013 10:48:40 +0200
Subject: [PATCH 1173/1825] fix: alp: fixed mvBoardIsEthConnected to indicate
 when a port is connected (and not only active)

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit ec0633008f1b89f65b931839e5703ff4b08c66fa

	- Before change, a MAC was was considered as connected when connected to switch,
	  only if it was the CPU Port.
	- Changed this routine to indicate a port as connected if defined in ethernet
	  complex board configration (no required to be CPU port if connected to switch)
	- Added mvBoardIsEthActive routine (same as mvBoardIsEthConnected before change)
	  for U-Boot usage: pp2 u-boot driver, and for active_units command

Change-Id: Id9573a625f7c1b8a83a46873f46a280220d2f58c
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4520
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/boardEnv/mvBoardEnvLib.c     |   23 ++++++
 .../armada_38x_family/boardEnv/mvBoardEnvLib.h     |    1 +
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   73 +++++++++++++++----
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    1 +
 4 files changed, 82 insertions(+), 16 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
index 8d4a862..0db30d5 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
@@ -2015,6 +2015,29 @@ MV_BOOL mvBoardIsEthConnected(MV_U32 ethNum)
 }
 
 /*******************************************************************************
+* mvBoardIsEthActive - this routine indicate which ports can be used by U-Boot
+*
+* DESCRIPTION:
+*	This routine returns true if a certain Ethernet port is
+*	Active and usable as a regular eth interface
+*
+* INPUT:
+*	ethNum - index of the ethernet port requested
+*
+* OUTPUT:
+*	None.
+*
+* RETURN:
+*	MV_TRUE if the requested ethernet port is Active and usable.
+*
+*******************************************************************************/
+MV_BOOL mvBoardIsEthActive(MV_U32 ethNum)
+{
+	/* for A375, all connected ports are Active and usabe */
+	return mvBoardIsEthConnected(ethNum);
+}
+
+/*******************************************************************************
 * mvBoardIsQsgmiiModuleConnected
 *
 * DESCRIPTION:
diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
index b855e8f..d6a9e2c 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
@@ -483,6 +483,7 @@ MV_VOID mvBoardMacSpeedSet(MV_U32 ethPortNum, MV_BOARD_MAC_SPEED macSpeed);
 MV_U32 mvBoardSwitchCpuPortGet(MV_U32 switchIdx);
 MV_U32 mvBoardMacCpuPortGet(MV_VOID);
 MV_BOOL mvBoardIsEthConnected(MV_U32 ethNum);
+MV_BOOL mvBoardIsEthActive(MV_U32 ethNum);
 MV_32 mvBoardSwitchIrqGet(MV_VOID);
 MV_U32 mvBoardSwitchPortsMaskGet(MV_U32 switchIdx);
 MV_BOOL mvBoardConfigAutoDetectEnabled(void);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index 2a6e980..9affb4d 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -2993,10 +2993,10 @@ MV_U32 mvBoardSwitchCpuPortGet(MV_U32 switchIdx)
 }
 
 /*******************************************************************************
-* mvBoardIsEthConnected - detect if a certain Ethernet port is active
+* mvBoardIsEthConnected - detect if a certain Ethernet port is connected
 *
 * DESCRIPTION:
-*	This routine returns true if a certain Ethernet port is active and usable
+*	This routine returns true if a certain Ethernet port is connected
 *
 * INPUT:
 *	ethNum - index of the ethernet port requested
@@ -3005,7 +3005,7 @@ MV_U32 mvBoardSwitchCpuPortGet(MV_U32 switchIdx)
 *	None.
 *
 * RETURN:
-*	MV_TRUE if the requested ethernet port is connected and usable.
+*	MV_TRUE if the requested ethernet port is connected.
 *
 *******************************************************************************/
 MV_BOOL mvBoardIsEthConnected(MV_U32 ethNum)
@@ -3018,32 +3018,73 @@ MV_BOOL mvBoardIsEthConnected(MV_U32 ethNum)
 		return MV_FALSE;
 	}
 
-	/*
-	 * Determine if port is both active and usable:
-	 * 1. active : if MAC is set as active in Ethernet complex board configuration
-	 * 2. usable : - MAC always usable when connected to RGMII, COMPHY, or GE-PHY
-	 *             - if connected to switch ,a MAC is usable only as the CPU Port
-	 *               (if a 2nd MAC is connected to switch, it used for Loopback)
-	 */
-
-	if ((ethNum == 0) && ((c & MV_ETHCOMP_GE_MAC0_2_GE_PHY_P0) ||
+	/* Determine if port is connected:
+	 * If set as active in Ethernet complex board configuration */
+	if (ethNum == 0 && ((c & MV_ETHCOMP_GE_MAC0_2_GE_PHY_P0) ||
 			(c & MV_ETHCOMP_GE_MAC0_2_RGMII0) ||
 			(c & MV_ETHCOMP_GE_MAC0_2_COMPHY_2) ||
-			((c & MV_ETHCOMP_GE_MAC0_2_SW_P6) && mvBoardMacCpuPortGet() == 0)))
+			(c & MV_ETHCOMP_GE_MAC0_2_SW_P6)))
 			isConnected = MV_TRUE;
 
-	if ((ethNum == 1) && ((c & MV_ETHCOMP_GE_MAC1_2_GE_PHY_P3) ||
+	if (ethNum == 1 && ((c & MV_ETHCOMP_GE_MAC1_2_GE_PHY_P3) ||
 			(c & MV_ETHCOMP_GE_MAC1_2_RGMII1) ||
-			((c & MV_ETHCOMP_GE_MAC1_2_SW_P4) && mvBoardMacCpuPortGet() == 1)))
+			(c & MV_ETHCOMP_GE_MAC1_2_SW_P4)))
 			isConnected = MV_TRUE;
 
-	if ((ethNum == 2) && mvBoardIsPortLoopback(ethNum))
+	if (ethNum == 2 && mvBoardIsPortLoopback(ethNum))
 			isConnected = MV_TRUE;
 
 	return isConnected;
 }
 
 /*******************************************************************************
+* mvBoardIsEthActive - detect if a certain Ethernet port is Active and usable
+*
+* DESCRIPTION:
+*	This routine returns true if a certain Ethernet port is
+*	Active and usable as a regular eth interface
+*
+* INPUT:
+*	ethNum - index of the ethernet port requested
+*
+* OUTPUT:
+*	None.
+*
+* RETURN:
+*	MV_TRUE if the requested ethernet port is Active and usable.
+*
+*******************************************************************************/
+MV_BOOL mvBoardIsEthActive(MV_U32 ethNum)
+{
+	MV_U32 c = mvBoardEthComplexConfigGet();
+	MV_BOOL isActive = MV_FALSE;
+
+	if (ethNum >= board->numBoardMacInfo) {
+		mvOsPrintf("%s: Error: Illegal port number(%u)\n", __func__, ethNum);
+		return MV_FALSE;
+	}
+
+	/*
+	 * Determine if port is active - both connected and usable:
+	 * 1. connected : if MAC is set as connected in Ethernet complex board configuration
+	 * 2. usable    : - MAC always usable when connected to RGMII, COMPHY, or GE-PHY
+	 *                - if connected to switch ,a MAC is usable only as the CPU Port
+	 *                  (if another MAC is connected to switch, it's used for Loopback)
+	 */
+	if (ethNum == 0 && ((c & MV_ETHCOMP_GE_MAC0_2_GE_PHY_P0) ||
+			(c & MV_ETHCOMP_GE_MAC0_2_RGMII0) ||
+			(c & MV_ETHCOMP_GE_MAC0_2_COMPHY_2) ||
+			((c & MV_ETHCOMP_GE_MAC0_2_SW_P6) && mvBoardMacCpuPortGet() == 0)))
+			isActive = MV_TRUE;
+
+	if (ethNum == 1 && ((c & MV_ETHCOMP_GE_MAC1_2_GE_PHY_P3) ||
+			(c & MV_ETHCOMP_GE_MAC1_2_RGMII1) ||
+			((c & MV_ETHCOMP_GE_MAC1_2_SW_P4) && mvBoardMacCpuPortGet() == 1)))
+			isActive = MV_TRUE;
+
+	return isActive;
+}
+/*******************************************************************************
 * mvBoardMacCpuPortGet - returns the MAC CPU port connected to switch
 *
 * DESCRIPTION:
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index 258cc53..2d7e679 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -573,6 +573,7 @@ MV_VOID mvBoardMacSpeedSet(MV_U32 ethPortNum, MV_BOARD_MAC_SPEED macSpeed);
 MV_U32 mvBoardSwitchCpuPortGet(MV_U32 switchIdx);
 MV_U32 mvBoardMacCpuPortGet(MV_VOID);
 MV_BOOL mvBoardIsEthConnected(MV_U32 ethNum);
+MV_BOOL mvBoardIsEthActive(MV_U32 ethNum);
 MV_32 mvBoardSwitchIrqGet(MV_VOID);
 MV_32 mvBoardSwitchConnectedPortGet(MV_U32 ethPort);
 MV_U32 mvBoardSwitchPortsMaskGet(MV_U32 switchIdx);
-- 
1.7.5.4

