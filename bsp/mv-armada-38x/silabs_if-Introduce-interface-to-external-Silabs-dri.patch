From d471cfe34664f813b0e38b53eb61f4e925a8c2e9 Mon Sep 17 00:00:00 2001
From: Eran Ben-Avi <benavi@marvell.com>
Date: Thu, 11 Jul 2013 17:49:17 +0300
Subject: [PATCH 0794/1825] silabs_if: Introduce interface to external Silabs
 driver.

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 23566829a105d4cc56d4785f9060c763cfe5a1de

	The Silabs Interface connects external Silabs drivers
	with Marvell HAL TDM component.

Change-Id: I7ab04a4cef0cd3c45dc5bf824848648a286e20cc
Signed-off-by: Piotr Ziecik <kosmo@semihalf.com>
Signed-off-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-feroceon/include/plat/silabs_if.h    |   85 +++++++++++++
 .../plat-feroceon/mv_drivers_lsp/mv_phone/Kconfig  |    6 +-
 .../plat-feroceon/mv_drivers_lsp/mv_phone/Makefile |    6 +
 .../mv_drivers_lsp/mv_phone/slic/silabs_if.c       |  126 ++++++++++++++++++++
 4 files changed, 222 insertions(+), 1 deletions(-)
 create mode 100644 arch/arm/plat-feroceon/include/plat/silabs_if.h
 create mode 100644 arch/arm/plat-feroceon/mv_drivers_lsp/mv_phone/slic/silabs_if.c

diff --git a/arch/arm/plat-feroceon/include/plat/silabs_if.h b/arch/arm/plat-feroceon/include/plat/silabs_if.h
new file mode 100644
index 0000000..76d8352
--- /dev/null
+++ b/arch/arm/plat-feroceon/include/plat/silabs_if.h
@@ -0,0 +1,85 @@
+/*******************************************************************************
+Copyright (C) Marvell International Ltd. and its affiliates
+
+This software file (the "File") is owned and distributed by Marvell
+International Ltd. and/or its affiliates ("Marvell") under the following
+alternative licensing terms.  Once you have made an election to distribute the
+File under one of the following license alternatives, please (i) delete this
+introductory statement regarding license alternatives, (ii) delete the two
+license alternatives that you have not elected to use and (iii) preserve the
+Marvell copyright notice above.
+
+********************************************************************************
+Marvell Commercial License Option
+
+If you received this File from Marvell and you have entered into a commercial
+license agreement (a "Commercial License") with Marvell, the File is licensed
+to you under the terms of the applicable Commercial License.
+
+********************************************************************************
+Marvell GPL License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File in accordance with the terms and conditions of the General
+Public License Version 2, June 1991 (the "GPL License"), a copy of which is
+available along with the File in the license.txt file or by writing to the Free
+Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 or
+on the worldwide web at http://www.gnu.org/licenses/gpl.txt.
+
+THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE IMPLIED
+WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY
+DISCLAIMED.  The GPL License provides additional details about this warranty
+disclaimer.
+********************************************************************************
+Marvell BSD License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File under the following licensing terms.
+Redistribution and use in source and binary forms, with or without modification,
+are permitted provided that the following conditions are met:
+
+    *   Redistributions of source code must retain the above copyright notice,
+	this list of conditions and the following disclaimer.
+
+    *   Redistributions in binary form must reproduce the above copyright
+	notice, this list of conditions and the following disclaimer in the
+	documentation and/or other materials provided with the distribution.
+
+    *   Neither the name of Marvell nor the names of its contributors may be
+	used to endorse or promote products derived from this software without
+	specific prior written permission.
+
+THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
+ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
+ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
+ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+
+******************************************************************************/
+
+#ifndef __PLAT_SILABS_IF_H
+#define __PLAT_SILABS_IF_H
+
+#include <linux/kernel.h>
+#include <linux/module.h>
+#include <linux/interrupt.h>
+
+/* Interface to Silabs SLIC driver */
+extern void silabs_if_enable_irq(unsigned int device);
+extern void silabs_if_disable_irq(unsigned int device);
+
+unsigned int silabs_spi_get_line(void);
+extern void silabs_if_spi_init(unsigned int line);
+extern void silabs_if_spi_read(unsigned int line,
+		unsigned char *cmd, unsigned char cmd_size,
+		unsigned char *data, unsigned char data_size);
+extern void silabs_if_spi_write(unsigned int line,
+		unsigned char *cmd, unsigned char cmd_size,
+		unsigned char *data, unsigned char data_size);
+
+#endif
diff --git a/arch/arm/plat-feroceon/mv_drivers_lsp/mv_phone/Kconfig b/arch/arm/plat-feroceon/mv_drivers_lsp/mv_phone/Kconfig
index dcd3ee9..716b3c3 100644
--- a/arch/arm/plat-feroceon/mv_drivers_lsp/mv_phone/Kconfig
+++ b/arch/arm/plat-feroceon/mv_drivers_lsp/mv_phone/Kconfig
@@ -61,6 +61,9 @@ config SILAB_SLIC_SI3226x
 config SILAB_SLIC_SI3217x
 	bool "Support Silicon Labs 3217x device"
 
+config SILAB_SLIC_EXTERNAL_DRIVER
+	bool "Support Silicon Labs SLIC external driver modules"
+
 endchoice
 
 choice
@@ -135,7 +138,8 @@ endchoice
 
 config MV_PHONE_USE_SLIC_LIBS
 	bool "Use binary SLIC drivers"
-	depends on MV_PHONE && !LANTIQ_SLIC_SUPPORT && !ZARLINK_SLIC_EXTERNAL_DRIVER
+	depends on MV_PHONE && !LANTIQ_SLIC_SUPPORT && \
+		   !ZARLINK_SLIC_EXTERNAL_DRIVER && !SILAB_SLIC_EXTERNAL_DRIVER
 	default y
 	---help---
 	Unselect this option only if you have source code of SLIC drivers.
diff --git a/arch/arm/plat-feroceon/mv_drivers_lsp/mv_phone/Makefile b/arch/arm/plat-feroceon/mv_drivers_lsp/mv_phone/Makefile
index 7da4cb9..c1c66c4 100644
--- a/arch/arm/plat-feroceon/mv_drivers_lsp/mv_phone/Makefile
+++ b/arch/arm/plat-feroceon/mv_drivers_lsp/mv_phone/Makefile
@@ -70,7 +70,13 @@ ifeq ($(CONFIG_SILAB_SLIC_SI3217x),y)
 	SLIC_LIB_NAME=silabs_3217x.lib
 endif
 
+ifeq ($(CONFIG_SILAB_SLIC_EXTERNAL_DRIVER),y)
+SILABS_OBJS =
+SILABS_CUSTOM_OBJS =
+PHONE_OBJS += $(LSP_SLIC_PATH)/silabs_if.o
+else
 PHONE_OBJS += $(LSP_SLIC_PATH)/silabs_dev.o
+endif
 
 endif
 
diff --git a/arch/arm/plat-feroceon/mv_drivers_lsp/mv_phone/slic/silabs_if.c b/arch/arm/plat-feroceon/mv_drivers_lsp/mv_phone/slic/silabs_if.c
new file mode 100644
index 0000000..cebe699
--- /dev/null
+++ b/arch/arm/plat-feroceon/mv_drivers_lsp/mv_phone/slic/silabs_if.c
@@ -0,0 +1,126 @@
+/*******************************************************************************
+Copyright (C) Marvell International Ltd. and its affiliates
+
+This software file (the "File") is owned and distributed by Marvell
+International Ltd. and/or its affiliates ("Marvell") under the following
+alternative licensing terms.  Once you have made an election to distribute the
+File under one of the following license alternatives, please (i) delete this
+introductory statement regarding license alternatives, (ii) delete the two
+license alternatives that you have not elected to use and (iii) preserve the
+Marvell copyright notice above.
+
+********************************************************************************
+Marvell Commercial License Option
+
+If you received this File from Marvell and you have entered into a commercial
+license agreement (a "Commercial License") with Marvell, the File is licensed
+to you under the terms of the applicable Commercial License.
+
+********************************************************************************
+Marvell GPL License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File in accordance with the terms and conditions of the General
+Public License Version 2, June 1991 (the "GPL License"), a copy of which is
+available along with the File in the license.txt file or by writing to the Free
+Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 or
+on the worldwide web at http://www.gnu.org/licenses/gpl.txt.
+
+THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE IMPLIED
+WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY
+DISCLAIMED.  The GPL License provides additional details about this warranty
+disclaimer.
+********************************************************************************
+Marvell BSD License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File under the following licensing terms.
+Redistribution and use in source and binary forms, with or without modification,
+are permitted provided that the following conditions are met:
+
+    *   Redistributions of source code must retain the above copyright notice,
+	this list of conditions and the following disclaimer.
+
+    *   Redistributions in binary form must reproduce the above copyright
+	notice, this list of conditions and the following disclaimer in the
+	documentation and/or other materials provided with the distribution.
+
+    *   Neither the name of Marvell nor the names of its contributors may be
+        used to endorse or promote products derived from this software without
+        specific prior written permission.
+
+THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
+ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
+ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
+ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+
+******************************************************************************/
+
+#include <linux/kernel.h>
+#include <linux/module.h>
+#include <linux/interrupt.h>
+#include <plat/silabs_if.h>
+
+#include "boardEnv/mvBoardEnvLib.h"
+#include "voiceband/mvSysTdmSpi.h"
+#include "spi/mvSpi.h"
+
+void silabs_if_enable_irq(unsigned int device)
+{
+	mvSysTdmIntEnable(device);
+}
+EXPORT_SYMBOL(silabs_if_enable_irq);
+
+void silabs_if_disable_irq(unsigned int device)
+{
+	mvSysTdmIntDisable(device);
+}
+EXPORT_SYMBOL(silabs_if_disable_irq);
+
+unsigned int silabs_spi_get_line(void)
+{
+	return mvBoardTdmSpiIdGet();
+}
+EXPORT_SYMBOL(silabs_spi_get_line);
+
+void silabs_if_spi_init(unsigned int line)
+{
+	MV_SPI_IF_PARAMS ifParams;
+	MV_SPI_TIMING_PARAMS tmngParams;
+
+	ifParams.clockPolLow = 1;
+	ifParams.clockPhase = SPI_CLK_BEGIN_CYC;
+	ifParams.txMsbFirst = 0;
+	ifParams.rxMsbFirst = 0;
+
+	tmngParams.tcsh = 0x3F;
+	tmngParams.tmisoSample = 0;
+	tmngParams.tcsSetup = 0x4;
+	tmngParams.tcsHold = 0x4;
+
+	mvSpiIfConfigSet(line, &ifParams);
+	mvSpiTimingParamsSet(line, &tmngParams);
+}
+EXPORT_SYMBOL(silabs_if_spi_init);
+
+void silabs_if_spi_read(unsigned int line,
+	unsigned char *cmd, unsigned char cmd_size,
+	unsigned char *data, unsigned char data_size)
+{
+	mvSysTdmSpiRead(line, cmd, cmd_size, data, data_size);
+}
+EXPORT_SYMBOL(silabs_if_spi_read);
+
+void silabs_if_spi_write(unsigned int line,
+	unsigned char *cmd, unsigned char cmd_size,
+	unsigned char *data, unsigned char data_size)
+{
+	mvSysTdmSpiWrite(line, cmd, cmd_size, data, data_size);
+}
+EXPORT_SYMBOL(silabs_if_spi_write);
-- 
1.7.5.4

