From 36d9607e732cb2a125bba16ee003447277bd6fe4 Mon Sep 17 00:00:00 2001
From: Yoni Farhadian <yonif@marvell.com>
Date: Wed, 17 Jul 2013 11:24:13 +0300
Subject: [PATCH 0837/1825] PPv2: sync between ALP, A375 and PPv2 component

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit dfd07aeac3c590a8adcab5a1d858091f1fa6430d

        Sync ALP, A375 and PPv2 files
        PPv2: use netdev_features_t only when kernel version is higher or equal than 3.4.25
        A375: edit Makefile, mvRules, etc to support latset changes in PPv2

Change-Id: I6ff371110927e74268a81d86fce3887884690e31
Signed-off-by: Yoni Farhadian <yonif@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/2699
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Tested-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |   18 ++++++++++++++++++
 1 files changed, 18 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index 5a60687..890f228 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -117,7 +117,11 @@ static int  mv_eth_hal_init(struct eth_port *pp);
 struct net_device *mv_eth_netdev_init(int mtu, u8 *mac, struct platform_device *pdev);
 static int mv_eth_netdev_connect(struct eth_port *pp);
 static void mv_eth_netdev_init_features(struct net_device *dev);
+#if LINUX_VERSION_CODE < KERNEL_VERSION(3, 4, 25)
+static u32 mv_eth_netdev_fix_features(struct net_device *dev, u32 features);
+#else
 static netdev_features_t mv_eth_netdev_fix_features(struct net_device *dev, netdev_features_t features);
+#endif
 
 static MV_STATUS mv_eth_pool_create(int pool, int capacity);
 static int mv_eth_pool_add(int pool, int buf_num);
@@ -3764,6 +3768,19 @@ void mv_eth_netdev_init_features(struct net_device *dev)
 #endif
 }
 
+#if LINUX_VERSION_CODE < KERNEL_VERSION(3, 4, 25)
+static u32 mv_eth_netdev_fix_features(struct net_device *dev, u32 features)
+{
+	if (dev->mtu > MV_ETH_TX_CSUM_MAX_SIZE)
+		if (features & (NETIF_F_IP_CSUM | NETIF_F_TSO)) {
+			features &= ~(NETIF_F_IP_CSUM | NETIF_F_TSO);
+			printk(KERN_ERR "%s: NETIF_F_IP_CSUM and NETIF_F_TSO not supported for mtu larger %d bytes\n",
+				dev->name, MV_ETH_TX_CSUM_MAX_SIZE);
+		}
+
+	return features;
+}
+#else
 static netdev_features_t mv_eth_netdev_fix_features(struct net_device *dev, netdev_features_t features)
 {
 	if (dev->mtu > MV_ETH_TX_CSUM_MAX_SIZE)
@@ -3775,6 +3792,7 @@ static netdev_features_t mv_eth_netdev_fix_features(struct net_device *dev, netd
 
 	return features;
 }
+#endif
 
 void mv_eth_priv_cleanup(struct eth_port *pp)
 {
-- 
1.7.5.4

