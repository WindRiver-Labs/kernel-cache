From 3fdb789cc5d5be47fdf99f73a70d8b2499ca5981 Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Thu, 20 Jun 2013 19:28:47 -0400
Subject: [PATCH 0727/1825] a370: NETA: fix: Put debug messages for under
 compilation flag CONFIG_MV_ETH_DEBUG_CODE

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit e930dd41fe277a147f581339f1e26de48144745e

	- Reported by QA for add/delete Multicast MAC addresses on KW40
	- Relevant only for Legacy parser (no PnC)
	- Fix dump of multicast MAC addresses
	- please apply this patch to all stable releases

Change-Id: Idea4fe08e1f9b68fda937664e0351d7c4e984d4a
Reviewed-on: http://vgitil04.il.marvell.com:8080/2316
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Tested-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.c      |    6 +++---
 arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.h      |    7 +++++++
 arch/arm/plat-armada/mv_hal/neta/gbe/mvNetaDebug.c |   19 ++++++++++++++-----
 3 files changed, 24 insertions(+), 8 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.c b/arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.c
index 6fb88b7..6139bfa 100644
--- a/arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.c
+++ b/arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.c
@@ -1710,15 +1710,15 @@ MV_STATUS mvNetaMcastAddrSet(int port, MV_U8 *pAddr, int queue)
 
 			pPortCtrl->mcastCount[crcResult]--;
 			if (pPortCtrl->mcastCount[crcResult] != 0) {
-				mvOsPrintf("ethPort #%d: After delete there are %d valid Mcast for crc8=0x%02x\n",
+				mvNetaDebugPrintf("ethPort #%d: Left %d valid Mcast for crc8=0x%02x\n",
 					   pPortCtrl->portNo, pPortCtrl->mcastCount[crcResult], (unsigned)crcResult);
 				return MV_NO_CHANGE;
 			}
 		} else {
 			pPortCtrl->mcastCount[crcResult]++;
 			if (pPortCtrl->mcastCount[crcResult] > 1) {
-				mvOsPrintf("ethPort #%d: Valid Mcast for crc8=0x%02x already exists\n",
-					   port, (unsigned)crcResult);
+				mvNetaDebugPrintf("ethPort #%d: Exist %d valid Mcast for crc8=0x%02x\n",
+					   port, pPortCtrl->mcastCount[crcResult], (unsigned)crcResult);
 				return MV_NO_CHANGE;
 			}
 		}
diff --git a/arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.h b/arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.h
index 03ca62f..2870781 100644
--- a/arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.h
+++ b/arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.h
@@ -80,6 +80,13 @@ extern "C" {
 # include "pnc/mvPnc.h"
 #endif /* CONFIG_MV_ETH_PNC */
 
+#ifdef CONFIG_MV_ETH_DEBUG_CODE
+# define mvNetaDebugPrintf      mvOsPrintf
+#else
+# define mvNetaDebugPrintf(msg, ...)
+#endif /* CONFIG_MV_ETH_DEBUG_CODE */
+
+
 #ifdef CONFIG_MV_ETH_NFP
 
 #ifdef CONFIG_MV_ETH_NFP_EXT
diff --git a/arch/arm/plat-armada/mv_hal/neta/gbe/mvNetaDebug.c b/arch/arm/plat-armada/mv_hal/neta/gbe/mvNetaDebug.c
index 5a6cb4a..6b5ff60 100644
--- a/arch/arm/plat-armada/mv_hal/neta/gbe/mvNetaDebug.c
+++ b/arch/arm/plat-armada/mv_hal/neta/gbe/mvNetaDebug.c
@@ -647,7 +647,7 @@ void mvEthPortUcastShow(int port)
 	macL = MV_REG_READ(ETH_MAC_ADDR_LOW_REG(port));
 	macH = MV_REG_READ(ETH_MAC_ADDR_HIGH_REG(port));
 
-	mvOsPrintf("Unicast MAC Table: port=%d %02x:%02x:%02x:%02x:%02x:%02x\n",
+	mvOsPrintf("\nUnicast MAC Table: port=%d %02x:%02x:%02x:%02x:%02x:%02x\n",
 		   port, ((macH >> 24) & 0xff), ((macH >> 16) & 0xff),
 		   ((macH >> 8) & 0xff), (macH & 0xff), ((macL >> 8) & 0xff), (macL & 0xff));
 
@@ -665,8 +665,16 @@ void mvEthPortMcastShow(int port)
 {
 	int tblIdx, regIdx;
 	MV_U32 regVal;
+	MV_NETA_PORT_CTRL *pPortCtrl;
 
-	mvOsPrintf("Special (IP) Multicast Table port=%d: 01:00:5E:00:00:XX\n", port);
+	if (mvNetaPortCheck(port))
+		return;
+
+	pPortCtrl = mvNetaPortHndlGet(port);
+	if (!pPortCtrl)
+		return;
+
+	mvOsPrintf("\nSpecial (IP) Multicast Table port=%d: 01:00:5E:00:00:XX\n", port);
 
 	for (tblIdx = 0; tblIdx < (256 / 4); tblIdx++) {
 		regVal = MV_REG_READ((ETH_DA_FILTER_SPEC_MCAST_BASE(port) + tblIdx * 4));
@@ -678,13 +686,14 @@ void mvEthPortMcastShow(int port)
 		}
 	}
 
-	mvOsPrintf("Other Multicast Table: port=%d\n", port);
+	mvOsPrintf("\nOther Multicast Table: port=%d\n", port);
 	for (tblIdx = 0; tblIdx < (256 / 4); tblIdx++) {
 		regVal = MV_REG_READ((ETH_DA_FILTER_OTH_MCAST_BASE(port) + tblIdx * 4));
 		for (regIdx = 0; regIdx < 4; regIdx++) {
 			if ((regVal & (0x01 << (regIdx * 8))) != 0) {
-				mvOsPrintf("crc8=0x%02X: accepted, rxq = %d\n",
-					   tblIdx * 4 + regIdx, ((regVal >> (regIdx * 8 + 1)) & 0x07));
+				mvOsPrintf("crc8=0x%02X: accepted, rxq = %d, ref=%d\n",
+					   tblIdx * 4 + regIdx, ((regVal >> (regIdx * 8 + 1)) & 0x07),
+					   pPortCtrl->mcastCount[tblIdx * 4 + regIdx]);
 			}
 		}
 	}
-- 
1.7.5.4

