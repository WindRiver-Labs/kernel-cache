From a4de1338ef07106a43ae1605064683d7eda4a080 Mon Sep 17 00:00:00 2001
From: Eli Nidam <elini@marvell.com>
Date: Wed, 1 Jan 2014 10:58:47 +0200
Subject: [PATCH 1265/1825] fix: phy: Change phy speed advertisement for MII
 port (speed 100Mbps).

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 49c97b0259903645885e0f9b5c0daeeba5b32f40

	The phy advertisement is updated for MII port
	(This fixed The MII module that works with MAC speed 100Mbps)

Change-Id: Idc533cb6db14a37cecdd8a97dab3fae9cd717a1d
Signed-off-by: Eli Nidam <elini@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4990
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/boardEnv/mvBoardEnvLib.c     |   31 ++++++++++++++++++-
 .../armada_38x_family/boardEnv/mvBoardEnvLib.h     |    1 +
 arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.h     |    7 ++++
 3 files changed, 37 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
index 037f1d2..0e45ad7 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
@@ -297,8 +297,32 @@ MV_BOOL mvBoardIsPortInSgmii(MV_U32 ethPortNum)
 *******************************************************************************/
 MV_BOOL mvBoardIsPortInGmii(MV_U32 ethPortNum)
 {
-	/* On DB board currently when SGMII connected the SGMII module activet port 1 and port 2
-	   and port 0 is disabled */
+	/* If module MII connected return port MII as GMII for NETA init configuration */
+	if (mvBoardIsPortInMii(ethPortNum))
+		return MV_TRUE;
+	return MV_FALSE;
+}
+/*******************************************************************************
+* mvBoardIsPortInMii
+*
+* DESCRIPTION:
+*	This routine returns MV_TRUE for port number works in MII or MV_FALSE
+*	For all other options.
+*
+* INPUT:
+*       ethPortNum - Ethernet port number.
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*       MV_TRUE - port in MII.
+*       MV_FALSE - other.
+*
+*******************************************************************************/
+MV_BOOL mvBoardIsPortInMii(MV_U32 ethPortNum)
+{
+	/* On DB board if MII module detected then port 0 is MII */
 	if ((mvBoardIsModuleConnected(MV_CONFIG_MII)) && (ethPortNum == 0))
 		return MV_TRUE;
 	return MV_FALSE;
@@ -898,6 +922,9 @@ MV_VOID mvBoardInfoUpdate(MV_VOID)
 {
 	MV_U32	reg;
 
+	if ((mvBoardIsModuleConnected(MV_CONFIG_MII)))	/* if Module MII connected change SMI address for port 0 */
+		mvBoardPhyAddrSet(0, 8);	/*set SMI address 8 for port 0*/
+
 	/* Update MPP group types and values according to board configuration */
 	mvBoardMppIdUpdate();
 	mvBoardEthComplexInfoUpdate();
diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
index 67cc91c..cce7cf5 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
@@ -446,6 +446,7 @@ MV_STATUS mvBoardNameGet(char *pNameBuff, MV_U32 size);
 MV_BOARD_SPEC_INIT *mvBoardSpecInitGet(MV_VOID);
 MV_BOOL mvBoardIsPortInSgmii(MV_U32 ethPortNum);
 MV_BOOL mvBoardIsPortInGmii(MV_U32 ethPortNum);
+MV_BOOL mvBoardIsPortInMii(MV_U32 ethPortNum);
 MV_BOOL mvBoardIsPortInRgmii(MV_U32 ethPortNum);
 MV_BOOL mvBoardIsPortLoopback(MV_U32 ethPortNum);
 MV_VOID mvBoardModuleConfigSet(MV_U32 newCfg);
diff --git a/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.h b/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.h
index 6661f3e..a09686f 100644
--- a/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.h
+++ b/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.h
@@ -117,6 +117,13 @@ typedef struct {
 	MV_U32		ctrlFamily;
 } MV_ETHPHY_HAL_DATA;
 
+#define MV_PHY_ADVERTISE_10_HALF        0x1
+#define MV_PHY_ADVERTISE_10_FULL        0x2
+#define MV_PHY_ADVERTISE_100_HALF       0x4
+#define MV_PHY_ADVERTISE_100_FULL       0x8
+#define MV_PHY_ADVERTISE_1000_HALF      0x10
+#define MV_PHY_ADVERTISE_1000_FULL      0x20
+
 MV_STATUS 	mvEthPhyHalInit(MV_ETHPHY_HAL_DATA *halData);
 MV_STATUS	mvEthPhyInit(MV_U32 ethPortNum, MV_BOOL eeeEnable);
 MV_STATUS	mvEthPhyRegRead(MV_U32 phyAddr, MV_U32 regOffs, MV_U16 *data);
-- 
1.7.5.4

