From 91dd6e9a9d4ec9b22e549bf8cfea2f3b0f7310af Mon Sep 17 00:00:00 2001
From: Yelena <yelena@marvell.com>
Date: Wed, 9 Apr 2014 15:49:16 +0300
Subject: [PATCH 1554/1825] pp3: add send_msg command to messenger sysfs

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 158024d720705b36b71de5870d31edc73f9ad743

Change-Id: I80b7292ec974c7b1193972f04298d9bce0d35f9e
Signed-off-by: Yelena <yelena@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/7043
Reviewed-by: Uri Eliyahu <uriel@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Tested-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/net/ethernet/marvell/pp3/Makefile          |    2 +-
 .../net/ethernet/marvell/pp3/fw/mv_channel_sysfs.c |    9 ++++++++-
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/marvell/pp3/Makefile b/drivers/net/ethernet/marvell/pp3/Makefile
index da0dcc4..ad23583 100644
--- a/drivers/net/ethernet/marvell/pp3/Makefile
+++ b/drivers/net/ethernet/marvell/pp3/Makefile
@@ -8,7 +8,7 @@ ccflags-y       += -Idrivers/net/ethernet/marvell/pp3
 
 mv_pp3-objs := net_dev/mv_netdev.o hmac/mv_hmac.o emac/mv_emac.o
 mv_pp3-objs += emac/mv_emac_sysfs.o hmac/mv_hmac_sysfs.o net_dev/mv_dev_sysfs.o
-mv_pp3-objs += gmac/mv_gmac.o fw/mv_channel_if.o common/mv_stack.o
+mv_pp3-objs += gmac/mv_gmac.o fw/mv_channel_if.o fw/mv_channel_sysfs.o common/mv_stack.o
 mv_pp3-objs += fw/mv_fw.o fw/mv_fw_sysfs.o
 mv_pp3-objs += bm/mv_bm.o bm/mv_bm_sysfs.o bm/mv_bm_regs.o
 mv_pp3-objs += qm/mv_qm.o qm/mv_qm_regs.o qm/mv_qm_sysfs.o
diff --git a/drivers/net/ethernet/marvell/pp3/fw/mv_channel_sysfs.c b/drivers/net/ethernet/marvell/pp3/fw/mv_channel_sysfs.c
index 1446f1d..feaf69a 100644
--- a/drivers/net/ethernet/marvell/pp3/fw/mv_channel_sysfs.c
+++ b/drivers/net/ethernet/marvell/pp3/fw/mv_channel_sysfs.c
@@ -71,8 +71,10 @@ static ssize_t mv_channel_help(char *b)
 
 	o += scnprintf(b+o, PAGE_SIZE-o, "\n");
 	o += scnprintf(b+o, PAGE_SIZE-o, "echo [c]         > chan_show    - Show message channel status\n");
+	o += scnprintf(b+o, PAGE_SIZE-o, "echo [c] [s]     > send_msg     - Send message [s] to channel [c]\n");
 	o += scnprintf(b+o, PAGE_SIZE-o, "\n");
 	o += scnprintf(b+o, PAGE_SIZE-o, "parameters: [c] channel number\n");
+	o += scnprintf(b+o, PAGE_SIZE-o, "parameters: [s] string\n");
 
 	return o;
 }
@@ -97,16 +99,19 @@ static ssize_t mv_channel_store(struct device *dev,
 	int             err;
 	unsigned int    c;
 	unsigned long   flags;
+	char msg[32];
 
 	if (!capable(CAP_NET_ADMIN))
 		return -EPERM;
 
 	/* Read first 3 parameters */
 	err = c = 0;
-	sscanf(buf, "%x", &c);
+	sscanf(buf, "%x %s", &c, msg);
 
 	if (!strcmp(name, "chan_show"))
 		mv_pp3_channel_show(c);
+	else if (!strcmp(name, "send_msg"))
+		mv_pp3_msg_send(c, msg, strlen(msg), 0);
 	else {
 		err = 1;
 		pr_err("%s: illegal operation <%s>\n", __func__, attr->attr.name);
@@ -117,11 +122,13 @@ static ssize_t mv_channel_store(struct device *dev,
 
 static DEVICE_ATTR(help, S_IRUSR, mv_channel_show, NULL);
 static DEVICE_ATTR(chan_show, S_IWUSR, NULL, mv_channel_store);
+static DEVICE_ATTR(send_msg, S_IWUSR, NULL, mv_channel_store);
 
 
 static struct attribute *mv_attrs[] = {
 	&dev_attr_help.attr,
 	&dev_attr_chan_show.attr,
+	&dev_attr_send_msg.attr,
 	NULL
 };
 
-- 
1.7.5.4

