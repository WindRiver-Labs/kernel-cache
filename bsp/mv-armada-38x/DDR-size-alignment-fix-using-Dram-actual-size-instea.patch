From dc93d919cc57da1002caf38c74148f38b02c2144 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Mon, 15 Oct 2012 17:28:17 +0200
Subject: [PATCH 0282/1825] - DDR size alignment fix (using Dram actual size,
 instead of Dram end offset)

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 6d9b7dd68e63515f603a3e92848d276eb0677758

Change-Id: I027c79828aca600a10cd7ad9e66215c666558dca

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIf.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)
 mode change 100644 => 100755 arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIf.c

diff --git a/arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIf.c b/arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIf.c
old mode 100644
new mode 100755
index c13458b..44974a9
--- a/arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIf.c
+++ b/arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIf.c
@@ -138,7 +138,7 @@ MV_U32 mvDramIfSizeGet(MV_VOID)
 MV_U32 mvDramIfHwSizeGet(MV_VOID)
 {
 	MV_U32 base = 0;
-	MV_U32 size, cs, totalSize = 0;
+	MV_U32 size, cs, totalSize = 0, sizeRegVal;
 
 	for (cs = 0; cs < SDRAM_MAX_CS; cs++) {
 		size = MV_REG_READ(SDRAM_SIZE_REG(cs)) & SDRAM_ADDR_MASK;
@@ -153,6 +153,10 @@ MV_U32 mvDramIfHwSizeGet(MV_VOID)
 			totalSize += size;
 		}
 	}
+	/* Dram size alignment fix */
+	sizeRegVal = (totalSize & SDRAMWCR_SIZE_MASK) >> SDRAMWCR_SIZE_OFFS;   // sizeregVal = ( amount of 16mb chunks -1 )
+	totalSize = (sizeRegVal + 1) * SDRAMWCR_SIZE_ALLIGNMENT;    	     // size = alined size (num of 16mb chunks * 16mb)
+	/* Dram size alignment fix*/
 	return totalSize;
 }
 MV_U32 mvDramIfHwCsSizeGet(MV_U32 cs)
-- 
1.7.5.4

