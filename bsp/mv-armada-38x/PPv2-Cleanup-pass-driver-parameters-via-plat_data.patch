From e4bb791fe92486211741fbe3c1f13ee4264ac9f9 Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Thu, 27 Jun 2013 13:45:24 -0400
Subject: [PATCH 0742/1825] PPv2: Cleanup, pass driver parameters via
 plat_data

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit d402fd102f3f35392a72d72de303b9e67271a825

Change-Id: I8fce6d4c017126f09937c77a576afc618763061e
Reviewed-on: http://vgitil04.il.marvell.com:8080/2365
Reviewed-by: Igor Patrik <igorp@marvell.com>
Tested-by: Igor Patrik <igorp@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/Makefile                    |    2 +-
 arch/arm/mach-avantalp/core.c                      |    4 +
 arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c        |  134 --------------------
 arch/arm/mach-avantalp/mv_hal_if/mvSysPp2Api.h     |   71 -----------
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |   38 +++++-
 include/linux/mv_pp2.h                             |   11 ++-
 6 files changed, 47 insertions(+), 213 deletions(-)
 delete mode 100644 arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c
 delete mode 100644 arch/arm/mach-avantalp/mv_hal_if/mvSysPp2Api.h

diff --git a/arch/arm/mach-avantalp/Makefile b/arch/arm/mach-avantalp/Makefile
index 08fc480..ea83d71 100644
--- a/arch/arm/mach-avantalp/Makefile
+++ b/arch/arm/mach-avantalp/Makefile
@@ -71,7 +71,7 @@ avantalp-$(CONFIG_MV_INCLUDE_ETH_PHY)	+= $(HAL_ETHPHY_DIR)/mvEthPhy.o $(HAL_IF_D
 ifeq ($(CONFIG_MV_ETH_PP2),y)
 avantalp-$(CONFIG_MV_ETH_PP2)		+= $(HAL_ETH_GMAC_DIR)/mvEthGmacApi.o
 avantalp-$(CONFIG_MV_ETH_PP2)		+= $(HAL_ETH_GBE_DIR)/mvPp2Gbe.o $(HAL_ETH_GBE_DIR)/mvPp2GbeDebug.o \
-					   $(HAL_ETH_GBE_DIR)/mvPp2AddrDec.o $(HAL_IF_DIR)/mvSysPp2.o
+					   $(HAL_ETH_GBE_DIR)/mvPp2AddrDec.o
 avantalp-$(CONFIG_MV_ETH_PP2)		+= $(HAL_ETH_BM_DIR)/mvBm.o
 avantalp-$(CONFIG_MV_ETH_PP2)		+= $(HAL_ETH_PRS_DIR)/mvPp2PrsHw.o $(HAL_ETH_PRS_DIR)/mvPp2Prs.o
 avantalp-$(CONFIG_MV_ETH_PP2)		+= $(HAL_ETH_CLS_DIR)/mvPp2ClsHw.o $(HAL_ETH_CLS_DIR)/mvPp2Cls2Hw.o \
diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index da0d634..a9f93f0 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -509,6 +509,10 @@ static void mv_pp2_giga_pdev_register(struct platform_device *pdev)
 	struct mv_pp2_pdata *plat_data = (struct mv_pp2_pdata*)pdev->dev.platform_data;
 	int speed, port = pdev->id;
 
+	plat_data->max_port = mvCtrlEthMaxPortGet();
+	plat_data->tclk = mvBoardTclkGet();
+	plat_data->ctrl_model = mvCtrlModelGet();
+	plat_data->ctrl_rev = mvCtrlRevGet();
 	plat_data->cpu_mask  = group_cpu_mask;
 	plat_data->phy_addr = mvBoardPhyAddrGet(port);
 	plat_data->lb_enable = mvBoardIsPortLoopback(port);
diff --git a/arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c b/arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c
deleted file mode 100644
index 40f4361..0000000
--- a/arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c
+++ /dev/null
@@ -1,134 +0,0 @@
-/*******************************************************************************
-Copyright (C) Marvell International Ltd. and its affiliates
-
-This software file (the "File") is owned and distributed by Marvell
-International Ltd. and/or its affiliates ("Marvell") under the following
-alternative licensing terms.  Once you have made an election to distribute the
-File under one of the following license alternatives, please (i) delete this
-introductory statement regarding license alternatives, (ii) delete the two
-license alternatives that you have not elected to use and (iii) preserve the
-Marvell copyright notice above.
-
-********************************************************************************
-Marvell Commercial License Option
-
-If you received this File from Marvell and you have entered into a commercial
-license agreement (a "Commercial License") with Marvell, the File is licensed
-to you under the terms of the applicable Commercial License.
-
-********************************************************************************
-Marvell GPL License Option
-
-If you received this File from Marvell, you may opt to use, redistribute and/or
-modify this File in accordance with the terms and conditions of the General
-Public License Version 2, June 1991 (the "GPL License"), a copy of which is
-available along with the File in the license.txt file or by writing to the Free
-Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 or
-on the worldwide web at http://www.gnu.org/licenses/gpl.txt.
-
-THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE IMPLIED
-WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY
-DISCLAIMED.  The GPL License provides additional details about this warranty
-disclaimer.
-********************************************************************************
-Marvell BSD License Option
-
-If you received this File from Marvell, you may opt to use, redistribute and/or
-modify this File under the following licensing terms.
-Redistribution and use in source and binary forms, with or without modification,
-are permitted provided that the following conditions are met:
-
-    *   Redistributions of source code must retain the above copyright notice,
-	this list of conditions and the following disclaimer.
-
-    *   Redistributions in binary form must reproduce the above copyright
-	notice, this list of conditions and the following disclaimer in the
-	documentation and/or other materials provided with the distribution.
-
-    *   Neither the name of Marvell nor the names of its contributors may be
-	used to endorse or promote products derived from this software without
-	specific prior written permission.
-
-THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
-ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
-WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
-DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
-ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
-(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
-LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
-ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
-(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
-SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-
-*******************************************************************************/
-
-#include "mvCommon.h"
-#include "mvOs.h"
-#include "ctrlEnv/mvCtrlEnvLib.h"
-#include "boardEnv/mvBoardEnvLib.h"
-#include "cpu/mvCpu.h"
-#include "gbe/mvPp2Gbe.h"
-#include "gmac/mvEthGmacApi.h"
-
-
-/*******************************************************************************
-* mvSysPp2Init - Initialize the Eth subsystem
-*
-* DESCRIPTION:
-*
-* INPUT:
-*       None
-* OUTPUT:
-*		None
-* RETURN:
-*       None
-*
-*******************************************************************************/
-void 	mvSysPp2Init(void)
-{
-	MV_PP2_HAL_DATA halData;
-	MV_UNIT_WIN_INFO *addrWinMap;
-	MV_STATUS status;
-	int i;
-
-	addrWinMap = mvOsMalloc((MAX_TARGETS + 1) * sizeof(MV_UNIT_WIN_INFO));
-	if (!addrWinMap)
-		return;
-
-	memset(&halData, 0, sizeof(halData));
-	status = mvCtrlAddrWinMapBuild(addrWinMap, MAX_TARGETS + 1);
-	if (status != MV_OK)
-		return;
-
-	for (i = 0; i < MAX_TARGETS; i++) {
-		if (addrWinMap[i].enable == MV_FALSE)
-			continue;
-
-#ifdef CONFIG_MV_SUPPORT_L2_DEPOSIT
-		/* Setting DRAM windows attribute to :
-		   0x3 - Shared transaction + L2 write allocate (L2 Deposit) */
-		if (MV_TARGET_IS_DRAM(i)) {
-			addrWinMap[i].attrib &= ~(0x30);
-			addrWinMap[i].attrib |= 0x30;
-		}
-#endif
-		mvOsPrintf("%d - Base 0x%08x , Size = 0x%08x. , Target = 0x%08x\n", i,
-				addrWinMap[i].addrWin.baseLow,
-				(unsigned int)addrWinMap[i].addrWin.size, addrWinMap[i].targetId);
-	}
-	halData.maxPort = mvCtrlEthMaxPortGet();
-	halData.maxTcont = MV_ETH_MAX_TCONT;
-
-	halData.pClk = mvCpuPclkGet();
-	halData.tClk = mvBoardTclkGet();
-	halData.maxCPUs = CONFIG_NR_CPUS;
-	halData.iocc = arch_is_coherent();
-	halData.ctrlModel = mvCtrlModelGet();
-	halData.ctrlRev = mvCtrlRevGet();
-	halData.aggrTxqSize = CONFIG_MV_ETH_AGGR_TXQ_SIZE;
-
-	mvPp2WinInit(0, addrWinMap);
-	mvPp2HalInit(&halData);
-
-	return;
-}
diff --git a/arch/arm/mach-avantalp/mv_hal_if/mvSysPp2Api.h b/arch/arm/mach-avantalp/mv_hal_if/mvSysPp2Api.h
deleted file mode 100644
index 1946cdb..0000000
--- a/arch/arm/mach-avantalp/mv_hal_if/mvSysPp2Api.h
+++ /dev/null
@@ -1,71 +0,0 @@
-/*******************************************************************************
-Copyright (C) Marvell International Ltd. and its affiliates
-
-This software file (the "File") is owned and distributed by Marvell
-International Ltd. and/or its affiliates ("Marvell") under the following
-alternative licensing terms.  Once you have made an election to distribute the
-File under one of the following license alternatives, please (i) delete this
-introductory statement regarding license alternatives, (ii) delete the two
-license alternatives that you have not elected to use and (iii) preserve the
-Marvell copyright notice above.
-
-********************************************************************************
-Marvell Commercial License Option
-
-If you received this File from Marvell and you have entered into a commercial
-license agreement (a "Commercial License") with Marvell, the File is licensed
-to you under the terms of the applicable Commercial License.
-
-********************************************************************************
-Marvell GPL License Option
-
-If you received this File from Marvell, you may opt to use, redistribute and/or
-modify this File in accordance with the terms and conditions of the General
-Public License Version 2, June 1991 (the "GPL License"), a copy of which is
-available along with the File in the license.txt file or by writing to the Free
-Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 or
-on the worldwide web at http://www.gnu.org/licenses/gpl.txt.
-
-THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE IMPLIED
-WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY
-DISCLAIMED.  The GPL License provides additional details about this warranty
-disclaimer.
-********************************************************************************
-Marvell BSD License Option
-
-If you received this File from Marvell, you may opt to use, redistribute and/or
-modify this File under the following licensing terms.
-Redistribution and use in source and binary forms, with or without modification,
-are permitted provided that the following conditions are met:
-
-    *   Redistributions of source code must retain the above copyright notice,
-	    this list of conditions and the following disclaimer.
-
-    *   Redistributions in binary form must reproduce the above copyright
-	notice, this list of conditions and the following disclaimer in the
-	documentation and/or other materials provided with the distribution.
-
-    *   Neither the name of Marvell nor the names of its contributors may be
-	used to endorse or promote products derived from this software without
-	specific prior written permission.
-
-THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
-ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
-WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
-DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
-ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
-(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
-LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
-ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
-(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
-SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-
-*******************************************************************************/
-
-#ifndef __MV_SYS_PP2_API_H__
-#define __MV_SYS_PP2_API_H__
-
-
-void 	mvSysPp2Init(void);
-
-#endif /* __MV_SYS_PP2_API_H__ */
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index 4c9cf5b..b24ff84 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -46,8 +46,6 @@ disclaimer.
 #include "mvSysHwConfig.h"
 #include "ctrlEnv/mvCtrlEnvLib.h"
 #include "eth-phy/mvEthPhy.h"
-#include "mvSysEthPhyApi.h"
-#include "mvSysPp2Api.h"
 
 #include "gbe/mvPp2Gbe.h"
 #include "prs/mvPp2Prs.h"
@@ -2938,6 +2936,30 @@ int mv_eth_port_resume(int port)
 	return 0;
 }
 
+void    mv_eth_hal_shared_init(struct mv_pp2_pdata *plat_data)
+{
+	MV_PP2_HAL_DATA halData;
+
+	memset(&halData, 0, sizeof(halData));
+
+	halData.maxPort = plat_data->max_port;
+/*        halData.pClk = mvCpuPclkGet();*/
+	halData.tClk = plat_data->tclk;
+	halData.maxCPUs = nr_cpu_ids;
+	halData.iocc = arch_is_coherent();
+	halData.ctrlModel = plat_data->ctrl_model;
+	halData.ctrlRev = plat_data->ctrl_rev;
+	halData.aggrTxqSize = CONFIG_MV_ETH_AGGR_TXQ_SIZE;
+
+#ifdef CONFIG_MV_PON
+	halData.maxTcont = MV_ETH_MAX_TCONT;
+#endif /* CONFIG_MV_PON */
+
+	mvPp2HalInit(&halData);
+
+	return;
+}
+
 /***********************************************************
  * mv_eth_win_init --                                      *
  *   Win initilization                                     *
@@ -3045,14 +3067,18 @@ static int mv_eth_sysfs_init(void)
 
 	return 0;
 }
-static int	mv_eth_shared_probe(void)
+static int	mv_eth_shared_probe(struct mv_pp2_pdata *plat_data)
 {
 	int size, cpu;
 
 	mv_eth_sysfs_init();
 
 	/* init MAC Unit */
-	mvSysPp2Init();
+	mv_eth_win_init();
+
+	/* init MAC Unit */
+	mv_eth_hal_shared_init(plat_data);
+
 	mv_eth_config_show();
 
 	size = mv_eth_ports_num * sizeof(struct eth_port *);
@@ -3128,9 +3154,9 @@ static int mv_eth_probe(struct platform_device *pdev)
 
 	if (!mv_eth_initialized) {
 
-		mv_eth_ports_num = mvCtrlEthMaxPortGet();
+		mv_eth_ports_num = plat_data->max_port;
 
-		if (mv_eth_shared_probe())
+		if (mv_eth_shared_probe(plat_data))
 			return -ENODEV;
 	}
 
diff --git a/include/linux/mv_pp2.h b/include/linux/mv_pp2.h
index 151273f..b62fe59 100644
--- a/include/linux/mv_pp2.h
+++ b/include/linux/mv_pp2.h
@@ -69,10 +69,19 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define MV_PP2_PORT_NAME	"mv_pp2_port"
 
 struct mv_pp2_pdata {
+
+	/* Global parameters common for all ports */
+	unsigned int  tclk;
+	int           max_port;
+
+	/* Controller Model (Device ID) and Revision */
+	unsigned int  ctrl_model;
+	unsigned int  ctrl_rev;
+
+	/* Per port parameters */
 	unsigned int  cpu_mask;
 	int           mtu;
 
-
 	/* Whether a PHY is present, and if yes, at which address. */
 	int      phy_addr;
 
-- 
1.7.5.4

