From 29cdb14f4b0e5a36c55765df82c8755a92f1d927 Mon Sep 17 00:00:00 2001
From: Hanna Hawa <hannah@marvell.com>
Date: Wed, 23 Apr 2014 21:46:23 +0300
Subject: [PATCH 1580/1825] a38x: update temperature read, and init sequence

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 6e61422a5f655a86c86ca268023f7dab9b9280dc

	- Init the hardware reset bit once before reading the temperature
	- Check if the readout field is valid
	- Update the name of the used bits

Change-Id: I79517e1749e938b15e0bc8d09ea636d59e085300
Signed-off-by: Hanna Hawa <hannah@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/7176
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.c       |   25 ++++++++------------
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.h       |    5 +++-
 2 files changed, 14 insertions(+), 16 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
index fdb1b51..2da8d77 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
@@ -410,8 +410,6 @@ MV_STATUS mvCtrlEnvInit(MV_VOID)
 		mvGppPolaritySet(i, gppMask, (MV_GPP_IN_INVERT & gppMask));
 	}
 
-	MV_REG_BIT_SET(TSEN_CONF_REG, BIT8); /* init Tsen */
-
 	/* change default because Egiga0 is not alive by default */
 	MV_REG_WRITE(GENERAL_PURPOSE_RESERVED1_REG, GENERAL_PURPOSE_RESERVED1_DEFAULT_VALUE);
 
@@ -1682,25 +1680,22 @@ MV_BOOL mvCtrlDDRECCPUP3(MV_VOID)
 *******************************************************************************/
 MV_U32 mvCtrlGetJuncTemp(MV_VOID)
 {
-	/*Used Hard Coded values, TODO sync with Spec*/
-	MV_32 reg = 0, temp, i;
+	MV_32 reg = 0;
 
-	/* init the TSEN sensor once */
-	for (i = 0 ; i < 20; i++) {
-		reg = MV_REG_READ(TSEN_STATUS_REG);
-		if (reg & BIT10)
-			break;
-		mvOsDelay(10);
-	}
-	if ((reg & BIT10) == 0) {
+	/* Initiates TSEN hardware reset once */
+	if ((MV_REG_READ(TSEN_CONF_REG) & TSEN_CONF_RST_MASK) == 0)
+		MV_REG_BIT_SET(TSEN_CONF_REG, TSEN_CONF_RST_MASK);
+	mvOsDelay(10);
+
+	/* Check if the readout field is valid */
+	if ((MV_REG_READ(TSEN_STATUS_REG) & TSEN_STATUS_READOUT_VALID_MASK) == 0) {
 		mvOsPrintf("%s: TSEN not ready\n", __func__);
 		return 0;
 	}
-
+	reg = MV_REG_READ(TSEN_STATUS_REG);
 	reg = (reg & TSEN_STATUS_TEMP_OUT_MASK) >> TSEN_STATUS_TEMP_OUT_OFFSET;
-	temp = (((((10000 * reg) / 21445) * 1000) - 272674) / 1000);
 
-	return temp;
+	return ((((10000 * reg) / 21445) * 1000) - 272674) / 1000;
 }
 /*******************************************************************************
 * mvCtrlNandClkSet
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
index 9d36abe..1dca8b7 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
@@ -172,9 +172,12 @@ typedef enum {
 #define TSEN_STATE_MASK						(0x1 << TSEN_STATE_OFFSET)
 
 #define TSEN_CONF_REG						0xE4074
-#define TSEN_CONF_OTF_CALIB_MASK				(0x1 << 8)
+#define TSEN_CONF_RST_OFFSET					8
+#define TSEN_CONF_RST_MASK					(0x1 << TSEN_CONF_RST_OFFSET)
 
 #define TSEN_STATUS_REG						0xE4078
+#define TSEN_STATUS_READOUT_VALID_OFFSET			10
+#define TSEN_STATUS_READOUT_VALID_MASK				(0x1 << TSEN_STATUS_READOUT_VALID_OFFSET)
 #define TSEN_STATUS_TEMP_OUT_OFFSET				0
 #define TSEN_STATUS_TEMP_OUT_MASK				(0x3FF << TSEN_STATUS_TEMP_OUT_OFFSET)
 
-- 
1.7.5.4

