From 825ecf702ef43c817891f80f3a557847cfcf74b8 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Thu, 29 May 2014 13:46:11 +0300
Subject: [PATCH 1729/1825] msys_ac3: update msys_family with correct
 interface unit num for AC3

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit e753afb3caa90a114e3dbd089e1492f6451239b7

	- Expanded mvCtrlSocUnitNums API's to support AC3 and BC2 SoCs
	- Updated mvCtrlSocUnitNums table with correct unit num information for AC3
	- Updated relevant interface routines to use mvCtrlSocUnitNums API (mvCtrlSocUnitInfoNumGet):
	  EthMaxPortGet, PexMaxIfGet, PexActiveUnitNumGet, UsbMaxGet, XorMaxChanGet, SdioSupport
	- Updated mvBoardTclkGet to read core clock from S@R for AC3
	- Enabled error message in case of error in mvCtrlDevFamilyIdGet()

Change-Id: I1051d126c2ef8862a298fe662e86a64b7c4936a9
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8295
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Kostya Porotchkin <kostap@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8581
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mach-msys/msys_family/boardEnv/mvBoardEnvLib.c |   12 ++-
 .../mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.c   |   99 ++++++++++++++++----
 .../mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.h   |    5 +-
 .../mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h  |    3 +-
 4 files changed, 96 insertions(+), 23 deletions(-)

diff --git a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
index a78d3d7..53fc416 100644
--- a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
@@ -269,7 +269,7 @@ MV_STATUS mvBoardNameGet(char *pNameBuff)
 *******************************************************************************/
 MV_BOOL mvBoardIsEthConnected(MV_U32 ethNum)
 {
-	if (ethNum == 0)
+	if (ethNum <= mvCtrlEthMaxPortGet())
 		return MV_TRUE;
 
 	return MV_FALSE;
@@ -412,7 +412,7 @@ MV_32 mvBoardPhyAddrGet(MV_U32 ethPortNum)
 
 MV_BOOL mvBoardIsPortInRgmii(MV_U32 ethPortNum)
 {
-	return !mvBoardIsPortInGmii(ethPortNum);
+	return !mvBoardIsPortInGmii(ethPortNum) && !mvBoardIsPortInSgmii(ethPortNum);
 }
 
 /*******************************************************************************
@@ -457,7 +457,13 @@ MV_BOARD_MAC_SPEED mvBoardMacSpeedGet(MV_U32 ethPortNum)
 *******************************************************************************/
 MV_U32 mvBoardTclkGet(MV_VOID)
 {
-	/* Tclock is constant at 200MHz (not sampled @ reset)  */
+	MV_U16 family = mvCtrlDevFamilyIdGet(0);
+	MV_U8 tclkValue;
+
+	if (family == MV_ALLEYCAT3_DEV_ID && mvBoardCoreFreqGet(&tclkValue) == MV_OK)
+		return tclkValue;
+
+	/* BC2 use constant Tclock@200MHz (not sampled @ reset)  */
 	return 200000000;
 }
 
diff --git a/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.c
index 19183d3..ebe4c85 100644
--- a/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.c
@@ -95,18 +95,42 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define DB(x)
 #endif
 
-
-MV_UNIT_ID mvCtrlSocUnitNums[MAX_UNITS_ID][1] = {
-/* DRAM_UNIT_ID         */ { 1, },
-/* PEX_UNIT_ID          */ { 1, },
-/* ETH_GIG_UNIT_ID      */ { 2, },
-/* XOR_UNIT_ID          */ { 1, },
-/* UART_UNIT_ID         */ { 2, },
-/* SPI_UNIT_ID          */ { 2, },
-/* SDIO_UNIT_ID         */ { 1, },
-/* I2C_UNIT_ID          */ { 2, },
+/* MSYS family linear id */
+#define MV_MSYS_BC2_INDEX		0
+#define MV_MSYS_AC3_INDEX		1
+#define MV_MSYS_INDEX_MAX		2
+
+MV_UNIT_ID mvCtrlSocUnitNums[MAX_UNITS_ID][MV_MSYS_INDEX_MAX] = {
+/*			    BC2		AC3 */
+/* DRAM_UNIT_ID         */ { 1,		1, },
+/* PEX_UNIT_ID          */ { 1,		2, },
+/* ETH_GIG_UNIT_ID      */ { 2,		1, },
+/* XOR_UNIT_ID          */ { 1,		1, },
+/* UART_UNIT_ID         */ { 2,		2, },
+/* SPI_UNIT_ID          */ { 2,		1, },
+/* SDIO_UNIT_ID         */ { 1,		1, },
+/* I2C_UNIT_ID          */ { 2,		2, },
+/* USB_UNIT_ID          */ { 0,		1, },
 };
 
+static MV_U32 mvCtrlDevIdIndexGet(MV_U32 devId)
+{
+	MV_U32 index;
+
+	switch (devId) {
+	case MV_BOBCAT2_DEV_ID:
+		index = MV_MSYS_BC2_INDEX;
+		break;
+	case MV_ALLEYCAT3_DEV_ID:
+		index = MV_MSYS_AC3_INDEX;
+		break;
+	default:
+		index = MV_MSYS_AC3_INDEX;
+	}
+
+	return index;
+}
+
 MV_U32 mvCtrlSocUnitInfoNumGet(MV_UNIT_ID unit)
 {
 	MV_U32 devIdIndex;
@@ -116,7 +140,7 @@ MV_U32 mvCtrlSocUnitInfoNumGet(MV_UNIT_ID unit)
 		return 0;
 	}
 
-	devIdIndex = 0;
+	devIdIndex = mvCtrlDevIdIndexGet(mvCtrlModelGet());
 	return mvCtrlSocUnitNums[unit][devIdIndex];
 }
 
@@ -315,7 +339,28 @@ MV_U32 mvCtrlMppRegGet(MV_U32 mppGroup)
 *******************************************************************************/
 MV_U32 mvCtrlPexMaxIfGet(MV_VOID)
 {
-	return MV_PEX_MAX_IF;
+	return mvCtrlSocUnitInfoNumGet(PEX_UNIT_ID);
+}
+
+/*******************************************************************************
+* mvCtrlPexActiveUnitNumGet
+*
+* DESCRIPTION:
+*       This function returns Marvell controller number of PEX units.
+*
+* INPUT:
+*       None.
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*       Marvell controller number of PEX units.
+*
+*******************************************************************************/
+MV_U32 mvCtrlPexActiveUnitNumGet(MV_VOID)
+{
+	return mvCtrlSocUnitInfoNumGet(PEX_UNIT_ID);
 }
 #endif
 
@@ -362,7 +407,7 @@ MV_U32 mvCtrlPciMaxIfGet(MV_VOID)
 *******************************************************************************/
 MV_U32 mvCtrlEthMaxPortGet(MV_VOID)
 {
-	return MV_ETH_MAX_PORTS;
+	return mvCtrlSocUnitInfoNumGet(ETH_GIG_UNIT_ID);
 }
 
 /*******************************************************************************
@@ -386,6 +431,26 @@ MV_U8 mvCtrlEthMaxCPUsGet(MV_VOID)
 	return 2;
 }
 
+/*******************************************************************************
+* mvCtrlUsbMaxGet - Get number of Marvell USB controllers
+*
+* DESCRIPTION:
+*
+* INPUT:
+*       None.
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*       returns number of Marvell USB controllers.
+*
+*******************************************************************************/
+MV_U32 mvCtrlUsbMaxGet(void)
+{
+	return mvCtrlSocUnitInfoNumGet(USB_UNIT_ID);
+}
+
 #if defined(MV_INCLUDE_XOR)
 /*******************************************************************************
 * mvCtrlXorMaxChanGet - Get Marvell controller number of XOR channels.
@@ -405,7 +470,7 @@ MV_U8 mvCtrlEthMaxCPUsGet(MV_VOID)
 *******************************************************************************/
 MV_U32 mvCtrlXorMaxChanGet(MV_VOID)
 {
-	return MV_XOR_MAX_CHAN;
+	return mvCtrlSocUnitInfoNumGet(XOR_UNIT_ID);
 }
 
 /*******************************************************************************
@@ -426,7 +491,7 @@ MV_U32 mvCtrlXorMaxChanGet(MV_VOID)
 *******************************************************************************/
 MV_U32 mvCtrlXorMaxUnitGet(MV_VOID)
 {
-	return MV_XOR_MAX_UNIT;
+	return mvCtrlSocUnitInfoNumGet(XOR_UNIT_ID);
 }
 
 #endif
@@ -449,7 +514,7 @@ MV_U32 mvCtrlXorMaxUnitGet(MV_VOID)
 *******************************************************************************/
 MV_U32 mvCtrlSdioSupport(MV_VOID)
 {
-	return BC2_SDIO;
+	return mvCtrlSocUnitInfoNumGet(SDIO_UNIT_ID);
 }
 #endif
 
@@ -606,7 +671,7 @@ MV_U32 mvCtrlDevFamilyIdGet(MV_U16 ctrlModel)
 	else if ((boardId >= AC3_CUSTOMER_BOARD_ID_BASE) && (boardId < AC3_MARVELL_MAX_BOARD_ID))
 		return MV_ALLEYCAT3_DEV_ID;
 	else {
-		DB(mvOsPrintf("%s: ERR. Invalid Board ID (%d) ,Using BC2 as default family\n", __func__, boardId));
+		mvOsPrintf("%s: ERR. Invalid Board ID (%d) ,Using BC2 as default family\n", __func__, boardId);
 		return MV_BOBCAT2_DEV_ID;
 	}
 }
diff --git a/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.h
index 5a64d11..e2bfa91 100644
--- a/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.h
@@ -149,7 +149,7 @@ MV_U32    mvCtrlMppRegGet(MV_U32 mppGroup);
 
 #if defined(MV_INCLUDE_PEX)
 MV_U32	mvCtrlPexMaxIfGet(MV_VOID);
-MV_U32	mvCtrlPexMaxUnitGet(MV_VOID);
+MV_U32 mvCtrlPexActiveUnitNumGet(MV_VOID);
 #else
 #define mvCtrlPexMaxIfGet()	(0)
 #endif
@@ -162,6 +162,9 @@ MV_U32	mvCtrlPciMaxIfGet(MV_VOID);
 
 MV_U32	  mvCtrlEthMaxPortGet(MV_VOID);
 MV_U8	  mvCtrlEthMaxCPUsGet(MV_VOID);
+#if defined(MV_INCLUDE_USB)
+MV_U32 mvCtrlUsbMaxGet(MV_VOID);
+#endif
 #if defined(MV_INCLUDE_XOR)
 MV_U32 mvCtrlXorMaxChanGet(MV_VOID);
 MV_U32 mvCtrlXorMaxUnitGet(MV_VOID);
diff --git a/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h
index 993859b..c0a60e1 100644
--- a/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -182,8 +182,6 @@ extern "C" {
 #define PCI_IO(pciIf)				(PEX0_IO + 2 * (pciIf))
 #define PCI_MEM(pciIf, memNum)			(PEX0_MEM0 + 2 * (pciIf))
 /* This define describes the maximum number of supported PCI Interfaces 	*/
-#define BC2_NAND				1
-#define BC2_SDIO				1
 #define MV_DEVICE_MAX_CS      			4
 
 
@@ -233,6 +231,7 @@ typedef enum _mvUnitId {
 	SPI_UNIT_ID,
 	SDIO_UNIT_ID,
 	I2C_UNIT_ID,
+	USB_UNIT_ID,
 	MAX_UNITS_ID
 } MV_UNIT_ID;
 
-- 
1.7.5.4

