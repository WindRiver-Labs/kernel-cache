From 2ba07ad8f0d2747c76b27dd0cc668ccc9c61eb79 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Sun, 2 Mar 2014 13:57:59 +0200
Subject: [PATCH 1416/1825] msys: add initial support for RD-MISL board

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 2f7b335e85ec8a4b9ebafbd221c76b651fa84a02

	- Added new compilation sequence for MSYS rd-misl board, controlled by bobcat2_rd
	- Updated board ID defines in tools/marvell/src_phy_msys
	- Updated mvBoardIdGet routine to distinct between DB and RD (pre-compiled distintion)
	  (in tools/bin_hdr/src_phy_msys & in msys_family/boardenv/)
	- Added gBoardId init to Kernel (from U-Boot tags), and a static init for DB board (before mvBoardEnvInit)
	- Cleaned mv_set_power_scheme from AXP legacy code

Change-Id: I78526d0c72a31d62e126392cfb14b00329680846
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/6023
Reviewed-by: Ofer Heifetz <oferh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-msys/core.c                          |    5 ++
 .../mach-msys/msys_family/boardEnv/mvBoardEnvLib.c |   29 +++-----
 .../msys_family/boardEnv/mvBoardEnvSpec.c          |   75 +++++++++----------
 .../msys_family/boardEnv/mvBoardEnvSpec.h          |    2 +-
 4 files changed, 51 insertions(+), 60 deletions(-)

diff --git a/arch/arm/mach-msys/core.c b/arch/arm/mach-msys/core.c
index 940ac95..eaf53b4 100644
--- a/arch/arm/mach-msys/core.c
+++ b/arch/arm/mach-msys/core.c
@@ -196,12 +196,14 @@ EXPORT_SYMBOL(mv_early_printk);
 #define read_mtu(a)	a
 #endif
 
+extern MV_U32 gBoardId;
 static int __init parse_tag_mv_uboot(const struct tag *tag)
 {
 	unsigned int mvUbootVer = 0;
 
 	printk(KERN_INFO "Using UBoot passing parameters structure\n");
 	mvUbootVer = read_tag(tag->u.mv_uboot.uboot_version);
+	gBoardId =  (mvUbootVer & 0xff);
 
 #ifdef CONFIG_MV_NAND
 	/* get NAND ECC type(1-bit or 4-bit) */
@@ -841,6 +843,9 @@ static void __init msys_bc2_rd_init(void)
 	/* Call Aurora/cpu special configurations */
 	cpu_fabric_common_init();
 
+	/* Select appropriate Board ID for Machine */
+	gBoardId = DB_98DX4251_BP_ID;
+
 	/* init the Board environment */
 	mvBoardEnvInit();
 
diff --git a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
index 5352b71..912c0d7 100644
--- a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
@@ -1214,30 +1214,19 @@ MV_U32 gBoardId = -1;
 *******************************************************************************/
 MV_U32 mvBoardIdGet(MV_VOID)
 {
-	MV_U8 boardId;
-
 	if (gBoardId == -1) {
-		/* Set temp board ID, so board structures can be accessed - to get I2C TWSI addresses */
+#if defined(DB_BOBCAT2)
 		gBoardId = DB_98DX4251_BP_ID;
-		if (MV_ERROR == mvBoardTwsiRead(BOARD_DEV_TWSI_SATR, 0, 0, &boardId)) {
-			mvOsWarning();
-			return INVALID_BAORD_ID;
-		}
-
-		switch (boardId) {
-		case 0:
-			gBoardId = DB_98DX4251_BP_ID;
-			break;
-		case 1:
-			gBoardId = RD_98DX4051_ID;
-			break;
-		default:
-			gBoardId = -1; /* reset gBoardId , in case of TWSI read failure */
-			mvOsPrintf("%s: Error: read un-expected board ID (%d)\n", __func__, boardId);
-			return INVALID_BAORD_ID;
-		}
+#elif defined(RD_BOBCAT2)
+		gBoardId = RD_98DX4051_ID;
+#else
+		mvOsPrintf("mvBoardIdSet: Board ID must be defined!\n");
+		while (1)
+			continue;
+#endif
 	}
 	return gBoardId;
+
 }
 /*******************************************************************************
 * mvBoardTwsiRead -
diff --git a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.c b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.c
index 3163dcd..4beac42 100644
--- a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.c
+++ b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.c
@@ -169,7 +169,6 @@ MV_BOARD_INFO db98DX4251Info = {
 	.pSwitchInfo = NULL,
 	.switchInfoNum = 0,
 
-
 	/* NAND init params */
 	.nandFlashReadParams		= DB_98DX4251_BOARD_NAND_READ_PARAMS,
 	.nandFlashWriteParams		= DB_98DX4251_BOARD_NAND_WRITE_PARAMS,
@@ -215,51 +214,49 @@ MV_BOARD_MPP_INFO rd98DX4051InfoBoardMppConfigValue[] = {
 		RD_98DX4051_MPP32_39,
 	} }
 };
-MV_U8	rd98DX4051InfoBoardDebugLedIf[] = {17, 18, 19};
 
 MV_BOARD_INFO rd98DX4051Info = {
- .boardName				= "RD-98DX4051-SERVER",
- .numBoardMppTypeValue			= ARRSZ(rd98DX4051InfoBoardModTypeInfo),
- .pBoardModTypeValue			= rd98DX4051InfoBoardModTypeInfo,
- .numBoardMppConfigValue		= ARRSZ(rd98DX4051InfoBoardMppConfigValue),
- .pBoardMppConfigValue			= rd98DX4051InfoBoardMppConfigValue,
- .intsGppMaskLow			= 0,
- .intsGppMaskMid			= 0,
- .intsGppMaskHigh			= 0,
- .numBoardDeviceIf			= ARRSZ(rd98DX4051InfoBoardDeCsInfo),
- .pDevCsInfo				= rd98DX4051InfoBoardDeCsInfo,
- .numBoardTwsiDev			= 0,
- .pBoardTwsiDev				= NULL,
- .numBoardMacInfo			= ARRSZ(rd98DX4051InfoBoardMacInfo),
- .pBoardMacInfo				= rd98DX4051InfoBoardMacInfo,
- .numBoardGppInfo			= 0,
- .pBoardGppInfo				= NULL,
-	.activeLedsNumber		= ARRSZ(rd98DX4051InfoBoardDebugLedIf),
- .pLedGppPin				= rd98DX4051InfoBoardDebugLedIf,
- .ledsPolarity				= 0,
-
- /* GPP values */
- .gppOutEnValLow			= RD_98DX4051_GPP_OUT_ENA_LOW,
- .gppOutEnValMid			= RD_98DX4051_GPP_OUT_ENA_MID,
- .gppOutEnValHigh			= 0,
- .gppOutValLow				= RD_98DX4051_GPP_OUT_VAL_LOW,
- .gppOutValMid				= RD_98DX4051_GPP_OUT_VAL_MID,
- .gppOutValHigh				= 0,
- .gppPolarityValLow			= RD_98DX4051_GPP_POL_LOW,
- .gppPolarityValMid			= RD_98DX4051_GPP_POL_MID,
- .gppPolarityValHigh			= 0,
+	.boardName			= "RD-98DX4051-SERVER",
+	.numBoardMppTypeValue		= ARRSZ(rd98DX4051InfoBoardModTypeInfo),
+	.pBoardModTypeValue		= rd98DX4051InfoBoardModTypeInfo,
+	.numBoardMppConfigValue		= ARRSZ(rd98DX4051InfoBoardMppConfigValue),
+	.pBoardMppConfigValue		= rd98DX4051InfoBoardMppConfigValue,
+	.intsGppMaskLow			= 0,
+	.intsGppMaskMid			= 0,
+	.intsGppMaskHigh		= 0,
+	.numBoardDeviceIf		= ARRSZ(rd98DX4051InfoBoardDeCsInfo),
+	.pDevCsInfo			= rd98DX4051InfoBoardDeCsInfo,
+	.numBoardTwsiDev		= 0,
+	.pBoardTwsiDev			= NULL,
+	.numBoardMacInfo		= ARRSZ(rd98DX4051InfoBoardMacInfo),
+	.pBoardMacInfo			= rd98DX4051InfoBoardMacInfo,
+	.numBoardGppInfo		= 0,
+	.pBoardGppInfo			= NULL,
+	.activeLedsNumber		= 0,
+	.pLedGppPin			= NULL,
+	.ledsPolarity			= 0,
+
+	/* GPP values */
+	.gppOutEnValLow			= RD_98DX4051_GPP_OUT_ENA_LOW,
+	.gppOutEnValMid			= RD_98DX4051_GPP_OUT_ENA_MID,
+	.gppOutEnValHigh		= 0,
+	.gppOutValLow			= RD_98DX4051_GPP_OUT_VAL_LOW,
+	.gppOutValMid			= RD_98DX4051_GPP_OUT_VAL_MID,
+	.gppOutValHigh			= 0,
+	.gppPolarityValLow		= RD_98DX4051_GPP_POL_LOW,
+	.gppPolarityValMid		= RD_98DX4051_GPP_POL_MID,
+	.gppPolarityValHigh		= 0,
 
 	/* External Switch Configuration */
-	.pSwitchInfo = NULL,
-	.switchInfoNum = 0,
+	.pSwitchInfo			= NULL,
+	.switchInfoNum			= 0,
 
- /* NAND init params */
- .nandFlashReadParams			= RD_98DX4051_BOARD_NAND_READ_PARAMS,
- .nandFlashWriteParams			= RD_98DX4051_BOARD_NAND_WRITE_PARAMS,
- .nandFlashControl			= RD_98DX4051_BOARD_NAND_CONTROL
+	 /* NAND init params */
+	.nandFlashReadParams		= RD_98DX4051_BOARD_NAND_READ_PARAMS,
+	.nandFlashWriteParams		= RD_98DX4051_BOARD_NAND_WRITE_PARAMS,
+	.nandFlashControl		= RD_98DX4051_BOARD_NAND_CONTROL
 };
 
-
 /*********************************************************************************/
 
 MV_BOARD_INFO *boardInfoTbl[] = {
diff --git a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.h b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.h
index 1f1f4e2..c193d91 100644
--- a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.h
+++ b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.h
@@ -79,7 +79,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define DB_98DX4251_BP_ID			(BOARD_ID_BASE)
 #define RD_98DX4051_ID				(DB_98DX4251_BP_ID + 1)
 
-#define MV_MAX_BOARD_ID				(DB_98DX4251_BP_ID + 1)
+#define MV_MAX_BOARD_ID				(RD_98DX4051_ID + 1)
 #define INVALID_BAORD_ID			0xFFFF
 
 /******************/
-- 
1.7.5.4

