From 06587ebedb0736a46b4e6d1c5f45c9e71dd321b1 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Sun, 26 Jan 2014 11:09:36 +0200
Subject: [PATCH 1308/1825] fix: bc2: fix board ID - set temp board ID, to
 read I2C information from board structure

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 61dd27b4e5ca5324a09aaa773678e88ca47efeae

	- Before board ID read from I2C,a board structure must be set (to get I2C information)
	- Added a temp board ID configuration, before read real board ID from I2C (set DB_98DX4251_BP_ID)
	- In case of I2C failure, reset board ID to -1

Change-Id: I5f13410c67b49d50e57f9b71a1bce78b28eef48b
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5299
Reviewed-by: Kostya Porotchkin <kostap@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mach-msys/msys_family/boardEnv/mvBoardEnvLib.c |   20 +++++++++++---------
 1 files changed, 11 insertions(+), 9 deletions(-)

diff --git a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
index 9fe88c4..ddf1e54 100644
--- a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
@@ -1201,25 +1201,27 @@ MV_U32 gBoardId = -1;
 *       32bit board ID number, '-1' if board is undefined.
 *
 *******************************************************************************/
-int count = -1;
 MV_U32 mvBoardIdGet(MV_VOID)
 {
 	MV_U8 boardId;
 
-	if (count++ < 0)
-		printf("%s: TODO fix read from TWSI of boardID (using hard-coded value DB_98DX4251_BP_ID)\n", __func__);
-
-	return DB_98DX4251_BP_ID;
-
 	if (gBoardId == -1) {
-		if (MV_ERROR == mvBoardTwsiRead(BOARD_DEV_TWSI_PLD, 1, 0, &boardId)) {
+		/* Set temp board ID, so board structures can be accessed - to get I2C TWSI addresses */
+		gBoardId = DB_98DX4251_BP_ID;
+		if (MV_ERROR == mvBoardTwsiRead(BOARD_DEV_TWSI_SATR, 0, 0, &boardId)) {
 			mvOsWarning();
 			return INVALID_BAORD_ID;
 		}
+
 		switch (boardId) {
-		case 0: gBoardId = RD_98DX4051_ID; break;
-		case 1: gBoardId = DB_98DX4251_BP_ID; break;
+		case 0:
+			gBoardId = DB_98DX4251_BP_ID;
+			break;
+		case 1:
+			gBoardId = RD_98DX4051_ID;
+			break;
 		default:
+			gBoardId = -1; /* reset gBoardId , in case of TWSI read failure */
 			mvOsPrintf("%s: Error: read un-expected board ID (%d)\n", __func__, boardId);
 			return INVALID_BAORD_ID;
 		}
-- 
1.7.5.4

