From 9040bed32815479e7491984a96ffb4925ceb97c1 Mon Sep 17 00:00:00 2001
From: omri itach <omrii@marvell.com>
Date: Thu, 28 Feb 2013 18:31:52 +0200
Subject: [PATCH 0478/1825] implemented S@R write sequence

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 4d9af21679ee94faca103f88d98d55ee1bd56372

Change-Id: Id2a647d8ba2a200d054bdb7e8fa86fdd5ed4e740
Reviewed-on: http://vgitil04.il.marvell.com:8080/1199
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   63 +-------------------
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    2 +-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   43 +++++++++----
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h        |    5 +-
 4 files changed, 37 insertions(+), 76 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index 5fb8ec3..82d123c 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -1692,7 +1692,7 @@ MV_U8 mvBoardTwsiGet(MV_BOARD_TWSI_CLASS twsiClass, MV_U8 devNum, MV_U8 regNum)
 *	reg value
 *
 *******************************************************************************/
-MV_STATUS mvBoardTwsiSatRSet(MV_U8 devNum, MV_U8 regNum, MV_U8 regVal)
+MV_STATUS mvBoardTwsiSet(MV_BOARD_TWSI_CLASS twsiClass, MV_U8 devNum, MV_U8 regNum, MV_U8 regVal)
 {
 	MV_TWSI_SLAVE twsiSlave;
 	MV_TWSI_ADDR slave;
@@ -1703,8 +1703,8 @@ MV_STATUS mvBoardTwsiSatRSet(MV_U8 devNum, MV_U8 regNum, MV_U8 regVal)
 	mvTwsiInit(0, TWSI_SPEED, mvBoardTclkGet(), &slave, 0);
 
 	/* Read MPP module ID */
-	twsiSlave.slaveAddr.address = mvBoardTwsiAddrGet(BOARD_DEV_TWSI_SATR, devNum);
-	twsiSlave.slaveAddr.type = mvBoardTwsiAddrTypeGet(BOARD_DEV_TWSI_SATR, devNum);
+	twsiSlave.slaveAddr.address = mvBoardTwsiAddrGet(twsiClass, devNum);
+	twsiSlave.slaveAddr.type = mvBoardTwsiAddrTypeGet(twsiClass, devNum);
 	twsiSlave.validOffset = MV_TRUE;
 	DB(mvOsPrintf("Board: Write S@R device addr %x, type %x, data %x\n",
 		      twsiSlave.slaveAddr.address, twsiSlave.slaveAddr.type, regVal));
@@ -1723,63 +1723,6 @@ MV_STATUS mvBoardTwsiSatRSet(MV_U8 devNum, MV_U8 regNum, MV_U8 regVal)
 /*******************************************************************************
  * SatR Configuration functions
  */
-# if 0
-MV_U8 mvBoardCpuFreqGet(MV_VOID)
-{
-	MV_U8 sar;
-	MV_U8 sarMsb;
-
-	sar = mvBoardTwsiSatRGet(1, 0);
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
-
-	sarMsb = mvBoardTwsiSatRGet(2, 0);
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
-
-	return ((sarMsb & 0x1) << 3) | ((sar & 0x1C) >> 2);
-}
-
-MV_STATUS mvBoardCpuFreqSet(MV_U8 freqVal)
-{
-	MV_U8 sar;
-
-	sar = mvBoardTwsiSatRGet(1, 0);
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
-
-	sar &= ~(0x7 << 2);
-	sar |= (freqVal & 0x7) << 2;
-	if (MV_OK != mvBoardTwsiSatRSet(1, 0, sar)) {
-		DB(mvOsPrintf("Board: Write CpuFreq S@R fail\n"));
-		return MV_ERROR;
-	}
-	sar = mvBoardTwsiSatRGet(2, 0);
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
-	sar &= ~(0x1);
-	sar |= ( (freqVal >> 3) & 0x1);
-	if (MV_OK != mvBoardTwsiSatRSet(2, 0, sar)) {
-		DB(mvOsPrintf("Board: Write CpuFreq S@R fail\n"));
-		return MV_ERROR;
-	}
-
-	sar = mvBoardTwsiSatRGet(2, 0);
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
-
-	sar &= ~(0x1);
-	sar |= ( (freqVal >> 3) & 0x1);
-	if (MV_OK != mvBoardTwsiSatRSet(2, 0, sar)) {
-		DB(mvOsPrintf("Board: Write CpuFreq S@R fail\n"));
-		return MV_ERROR;
-	}
-
-	DB(mvOsPrintf("Board: Write CpuFreq S@R succeeded\n"));
-	return MV_OK;
-}
-
-#endif
 
 MV_U8 mvBoardCpuCoresNumGet(MV_VOID)
 {
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index 72a0616..28b3ab6 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -593,7 +593,7 @@ MV_ETH_COMPLEX_TOPOLOGY mvBoardMac1ConfigGet(MV_VOID);
 MV_ETH_COMPLEX_TOPOLOGY mvBoardLaneSGMIIGet(MV_VOID);
 MV_BOARD_BOOT_SRC mvBoardBootDeviceGroupSet(MV_U32 sarBootDevice);
 MV_U8 mvBoardTwsiGet(MV_BOARD_TWSI_CLASS twsiClass, MV_U8 devNum, MV_U8 regNum);
-MV_STATUS mvBoardTwsiSatRSet(MV_U8 devNum, MV_U8 regNum, MV_U8 regVal);
+MV_STATUS mvBoardTwsiSet(MV_BOARD_TWSI_CLASS twsiClass, MV_U8 devNum, MV_U8 regNum, MV_U8 regVal);
 
 MV_U8 mvBoardCpuFreqGet(MV_VOID);
 MV_STATUS mvBoardCpuFreqSet(MV_U8 freqVal);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 303b1de..2893e97 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -230,20 +230,37 @@ MV_STATUS mvCtrlEnvInit(MV_VOID)
 *       else if write failed - returns MV_ERROR
 *
 *******************************************************************************/
-MV_U32 mvCtrlSatRWrite(MV_SATR_TYPE_ID satrField, MV_U8 val)
+MV_STATUS mvCtrlSatRWrite(MV_SATR_TYPE_ID satrWriteField,MV_SATR_TYPE_ID satrReadField, MV_U8 val)
 {
-	if (satrField < MV_SATR_READ_MAX_OPTION) {
-		//TwsiSATRWrite (satrField , val);
-		satrOptionsConfig[satrField] = val;      /* simulate dummy write instead of TWSI - will be removed */
-		//if ( val==TwsiSATRRead (satrField) )
-
-		if (satrOptionsConfig[satrField] == val)        /* omriii - replace ifs with if(TWSIRead==val) */
-			return satrOptionsConfig[satrField] = val;
-		else
-			return MV_ERROR;
-	}else
-		return MV_ERROR;
-
+	MV_BOARD_SAR_INFO sInfo;
+	MV_U32 readVal, tmpVal;
+	if ((satrReadField < MV_SATR_READ_MAX_OPTION) && (satrWriteField < MV_SATR_WRITE_MAX_OPTION)) {
+		if ( MV_OK == mvBoardConfigTypeGet(satrWriteField, &sInfo))
+		{
+			/* read */
+			readVal = mvBoardTwsiGet(BOARD_DEV_TWSI_SATR, sInfo.regNum , 0);
+			if ((MV_U8)readVal == (MV_U8)MV_ERROR)
+				return MV_ERROR;
+
+			/* modify */
+			readVal &= !(sInfo.mask);  		/* clean old value */
+			readVal &= (val <<  sInfo.offset);	/* save new value */
+
+			/* write */
+			tmpVal = mvBoardTwsiSet(BOARD_DEV_TWSI_SATR, sInfo.regNum, 0,readVal);
+			if ((MV_U8)tmpVal == (MV_U8)MV_ERROR)
+				return MV_ERROR;
+
+			/* verify */
+			tmpVal = mvBoardTwsiGet(BOARD_DEV_TWSI_SATR, sInfo.regNum , 0);
+			if (tmpVal!=readVal)
+				return MV_ERROR;
+
+			/*else save written value in global array */
+			satrOptionsConfig[satrReadField] = readVal;
+			return MV_OK;
+		}
+	}
 }
 
 /*******************************************************************************
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
index ab82afa..2460133 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
@@ -102,7 +102,8 @@ typedef enum _mvSatRTypeID {
 	MV_SATR_WRITE_CPU_FREQ,
 	MV_SATR_WRITE_CORE_CLK_SELECT,
 	MV_SATR_WRITE_CPU1_ENABLE,
-	MV_SATR_WRITE_SSCG_DISABLE
+	MV_SATR_WRITE_SSCG_DISABLE,
+	MV_SATR_WRITE_MAX_OPTION
 } MV_SATR_TYPE_ID;
 
 typedef enum _mvConfigTypeID {
@@ -229,7 +230,7 @@ typedef struct _boardSerdesConf {
 #define SAR_CPU_FAB_GET(cpu, fab)       (((cpu & 0x7) << 21) | ((fab & 0xF) << 24))
 
 /* mcspLib.h API list */
-MV_U32 mvCtrlSatRWrite(MV_SATR_TYPE_ID satrField, MV_U8 val);
+MV_STATUS mvCtrlSatRWrite(MV_SATR_TYPE_ID satrWriteField,MV_SATR_TYPE_ID satrReadField, MV_U8 val);
 MV_U32 mvCtrlSatRRead(MV_SATR_TYPE_ID satrField);
 void mvCtrlSatrInit(MV_VOID);
 MV_U32 mvCtrlConfigGet(MV_CONFIG_TYPE_ID configField);
-- 
1.7.5.4

