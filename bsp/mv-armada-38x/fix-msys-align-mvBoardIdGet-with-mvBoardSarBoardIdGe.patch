From b0c02b8b5a12b4b1d89f073f4159da7243755740 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Thu, 10 Jul 2014 16:41:00 +0300
Subject: [PATCH 1792/1825] fix: msys: align mvBoardIdGet with
 mvBoardSarBoardIdGet usage

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 8c08f5299d766581c953330b400e152573a4bcc3

Change-Id: Ic4fa5569bea3b8444da34cb9428bbf23d4f0d610
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/9173
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mach-msys/msys_family/boardEnv/mvBoardEnvLib.c |   70 +++++++++++++-------
 1 files changed, 47 insertions(+), 23 deletions(-)

diff --git a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
index 32e6c4d..6fba3fe 100644
--- a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
@@ -1134,35 +1134,59 @@ MV_U32 mvBoardIdGet(MV_VOID)
 	if (gBoardId != -1)
 		return gBoardId;
 
-#ifdef CONFIG_CUSTOMER_BOARD_SUPPORT
-	#ifdef CONFIG_BOBCAT2
+#if defined CONFIG_ALLEYCAT3
+
+	#ifdef CONFIG_CUSTOMER_BOARD_SUPPORT
 		#ifdef CONFIG_CUSTOMER_BOARD_0
-			gBoardId = BC2_CUSTOMER_BOARD_ID0;
+			gBoardId = AC3_CUSTOMER_BOARD_ID0;
 		#elif CONFIG_CUSTOMER_BOARD_1
-			gBoardId = BC2_CUSTOMER_BOARD_ID1;
+			gBoardId = AC3_CUSTOMER_BOARD_ID1;
 		#endif
-	#elif defined CONFIG_ALLEYCAT3
+	#else	/* !CONFIG_CUSTOMER_BOARD_SUPPORT */
+
+	/* For Marvell Boards: Temporarily set generic board struct pointer to
+	   use S@R TWSI address, and read board ID */
+	board = marvellAC3BoardInfoTbl[mvBoardIdIndexGet(DB_AC3_ID)];
+	gBoardId = DB_AC3_ID; /* Terporary for usage by mvCtrlDevFamilyIdGet */
+	MV_U8 readValue;
+
+	if (mvBoardSarBoardIdGet(&readValue) != MV_OK) {
+		mvOsPrintf("%s: Error obtaining Board ID\n", __func__);
+		mvOsPrintf("%s: Set default board ID to DB-DXAC3-MM\n", __func__);
+		readValue = DB_AC3_ID;
+	}
+
+	if (readValue < AC3_MARVELL_BOARD_NUM)
+		gBoardId = AC3_MARVELL_BOARD_ID_BASE + readValue;
+	else {
+		mvOsPrintf("%s: Error: read wrong Board ID (%d)\n", __func__, readValue);
+		return INVALID_BOARD_ID;
+	}
+
+	#endif	/* CONFIG_CUSTOMER_BOARD_SUPPORT */
+
+#else /* CONFIG_BOBCAT2 */
+
+	#ifdef CONFIG_CUSTOMER_BOARD_SUPPORT
 		#ifdef CONFIG_CUSTOMER_BOARD_0
-			gBoardId = AC3_CUSTOMER_BOARD_ID0;
+			gBoardId = BC2_CUSTOMER_BOARD_ID0;
 		#elif CONFIG_CUSTOMER_BOARD_1
-			gBoardId = AC3_CUSTOMER_BOARD_ID1;
+			gBoardId = BC2_CUSTOMER_BOARD_ID1;
 		#endif
-	#endif
-#else	/* !CONFIG_CUSTOMER_BOARD_SUPPORT */
-	#if defined(DB_BOBCAT2)
-		gBoardId = DB_DX_BC2_ID;
-	#elif defined(RD_BOBCAT2)
-		gBoardId = RD_DX_BC2_ID;
-	#elif defined(RD_MTL_BOBCAT2)
-		gBoardId = RD_MTL_BC2;
-	/* AlleyCat3 Board ID's */
-	#elif defined(DB_AC3)
-		gBoardId = DB_AC3_ID;
-	#else
-		mvOsPrintf("%s: Board ID must be defined!\n", __func__);
-		while (1)
-			continue;
-	#endif
+	#else	/* !CONFIG_CUSTOMER_BOARD_SUPPORT */
+		#if defined(DB_BOBCAT2)
+			gBoardId = DB_DX_BC2_ID;
+		#elif defined(RD_BOBCAT2)
+			gBoardId = RD_DX_BC2_ID;
+		#elif defined(RD_MTL_BOBCAT2)
+			gBoardId = RD_MTL_BC2;
+		#else
+			mvOsPrintf("%s: Board ID must be defined!\n", __func__);
+			while (1)
+				continue;
+		#endif
+	#endif /* CONFIG_CUSTOMER_BOARD_SUPPORT */
+
 #endif
 
 	return gBoardId;
-- 
1.7.5.4

