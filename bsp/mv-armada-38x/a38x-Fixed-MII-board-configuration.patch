From f2f81f7cd6ddbdb3b8d87250fb1353185ffe0362 Mon Sep 17 00:00:00 2001
From: Eli Nidam <elini@marvell.com>
Date: Tue, 31 Dec 2013 16:52:40 +0200
Subject: [PATCH 1270/1825] a38x: Fixed MII board configuration

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 96440c2aef42c7ec7f575264b0a8c4adbb35a65a

	1. Disabled MII configuration if SGMII module detect
	2. Set phy address 8 for MII module
	3. Added mvBoardMacSpeedSet for change ETH speed to 100Mhz.
	4. Update MPP for MII module

Change-Id: I4165dfdff3672c62b90307794474edf2af56b96c
Signed-off-by: Eli Nidam <elini@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4975
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/boardEnv/mvBoardEnvLib.c     |   37 ++++++++++++++++++++
 .../armada_38x_family/boardEnv/mvBoardEnvLib.h     |    3 +-
 2 files changed, 39 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
index 0e45ad7..020b1a4 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
@@ -387,6 +387,18 @@ MV_32 mvBoardModuleConfigGet(MV_VOID)
 *******************************************************************************/
 MV_VOID mvBoardModuleConfigSet(MV_U32 newCfg)
 {
+	/* The MII module cannot work together with the SGMII module */
+	/* Ignore MII module if SGMII module is detected */
+	if ((newCfg == MV_CONFIG_MII) && (MV_CONFIG_SGMII & board->boardOptionsConfig)) {
+		mvOsPrintf("%s: Warning: Conflict in module detect, (SGMII & MII module), MII module is ignored\n",
+			    __func__);
+		return;
+	}
+	if ((newCfg == MV_CONFIG_SGMII) && (MV_CONFIG_MII & board->boardOptionsConfig)) {
+		mvOsPrintf("%s: Warning: Conflict in module detect, (SGMII & MII module), MII module is ignored\n",
+			   __func__);
+		board->boardOptionsConfig &= ~MV_CONFIG_MII;
+	}
 	board->boardOptionsConfig |= newCfg;
 }
 
@@ -491,6 +503,31 @@ MV_BOARD_MAC_SPEED mvBoardMacSpeedGet(MV_U32 ethPortNum)
 
 	return board->pBoardMacInfo[ethPortNum].boardMacSpeed;
 }
+/*******************************************************************************
+* mvBoardMacSpeedSet - Set the Mac speed
+*
+* DESCRIPTION:
+*       This routine SET the Mac speed for a given ethernet port.
+*
+* INPUT:
+*       ethPortNum - Ethernet port number.
+*       ethSpeed. - 10/100/1000 eth speed
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*       None.
+*
+*******************************************************************************/
+MV_VOID mvBoardMacSpeedSet(MV_U32 ethPortNum, MV_BOARD_MAC_SPEED ethSpeed)
+{
+	if (ethPortNum >= board->numBoardMacInfo) {
+		mvOsPrintf("%s: Error: wrong eth port (%d)\n", __func__, ethPortNum);
+		return;
+	}
+	board->pBoardMacInfo[ethPortNum].boardMacSpeed = ethSpeed;
+}
 
 /*******************************************************************************
 * mvBoardIsPortLoopback -
diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
index cce7cf5..5f08429 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
@@ -401,7 +401,7 @@ struct _mvBoardMppModule {
 };
 
 
-#define MPP_MII_MODULE		{ {0, 0x12111111}, {1, 0x11111111}, {2, 0x11266011} }
+#define MPP_MII_MODULE		{ {0, 0x10111111}, {1, 0x11111111}, {2, 0x11211111} }
 #define MPP_TDM_MODULE		{ {6, 0x45333333}, {7, 0x00004444} }
 #define MPP_I2S_MODULE		{6, 0x55544554}
 #define MPP_SPDIF_MODULE	{6, 0x55444444}
@@ -510,6 +510,7 @@ MV_U32 mvBoardSwitchPortForceLinkGet(MV_U32 switchIdx);
 MV_U32 mvBoardFreqModesNumGet(void);
 MV_32 mvBoardSmiScanModeGet(MV_U32 switchIdx);
 MV_BOARD_MAC_SPEED mvBoardMacSpeedGet(MV_U32 ethPortNum);
+MV_VOID mvBoardMacSpeedSet(MV_U32 ethPortNum, MV_BOARD_MAC_SPEED speed);
 MV_VOID mvBoardMacSpeedSet(MV_U32 ethPortNum, MV_BOARD_MAC_SPEED macSpeed);
 MV_U32 mvBoardSwitchCpuPortGet(MV_U32 switchIdx);
 MV_U32 mvBoardMacCpuPortGet(MV_VOID);
-- 
1.7.5.4

