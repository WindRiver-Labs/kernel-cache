From cff02ac0499fe73a2d4baaa44165ecdafcfea6a8 Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Wed, 4 Dec 2013 11:00:01 -0500
Subject: [PATCH 1213/1825] fix: pp2: SKB recycle fix

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit e13160c8403ec2e6bbf5bb2fcd0d31de0f44142b

	WA for Linux network stack issue that prevent skb recycle.
	If dev_kfree_skb_any called from interrupt context or interrupts disabled context
	skb->users will be zero when skb_recycle callback function is called.
	In such case skb_recycle_check function returns error because skb->users != 1.

Change-Id: I529bc8c3e93f27e0c7bdfc1961eec912da8cabc8
Signed-off-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4584
Reviewed-by: Yelena Krivosheev <yelena@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Tested-by: Nadav Haklai <nadavh@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4646
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index 2545844..c92267a 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -1446,6 +1446,15 @@ int mv_eth_skb_recycle(struct sk_buff *skb)
 
 	ppool = &mv_eth_pool[pool];
 
+	/*
+	WA for Linux network stack issue that prevent skb recycle.
+	If dev_kfree_skb_any called from interrupt context or interrupts disabled context
+	skb->users will be zero when skb_recycle callback function is called.
+	In such case skb_recycle_check function returns error because skb->users != 1.
+	*/
+	if (atomic_read(&skb->users) == 0)
+		atomic_set(&skb->users, 1);
+
 	if (bm & MV_ETH_BM_COOKIE_F_INVALID) {
 		/* hw_cookie is not valid for recycle */
 		STAT_DBG(ppool->stats.bm_cookie_err++);
-- 
1.7.5.4

