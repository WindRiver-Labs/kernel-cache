From 5b31043f79203519279780c7c57c399d7e950b96 Mon Sep 17 00:00:00 2001
From: Victor Gu <xigu@marvell.com>
Date: Tue, 6 May 2014 17:48:46 +0800
Subject: [PATCH 1616/1825] fix: alp: pon: Additional T-CONT also send out
 data

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 466b34eba9ca33810a364edd724ec36263a18bac

    forbiden associate alloc ID with additional T-CONT when GPON high
priority TX is enabled.
Signed-off-by: Victor Gu <xigu@marvell.com>

Change-Id: I859ea77d5d8aa40812f615a6637db38ce6dad62b
Reviewed-on: http://vgitil04.il.marvell.com:8080/7846
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pon/core/gpon/gponOnuApi.c   |    6 +++
 .../mv_drivers_lsp/mv_pon/core/gpon/gponOnuDb.c    |   37 ++++++++++++++++++++
 .../mv_drivers_lsp/mv_pon/core/gpon/gponOnuDb.h    |    1 +
 3 files changed, 44 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuApi.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuApi.c
index 4123e1d..b8c08a4 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuApi.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuApi.c
@@ -347,6 +347,7 @@ MV_STATUS onuGponApiDisableNotifyRegister(DISABLENOTIFYFUNC notifyCallBack)
 *******************************************************************************/
 MV_STATUS onuGponApiTcontConfig(MV_U32 allocId, MV_U32 tcontId)
 {
+	MV_BOOL state;
 	MV_STATUS rcode;
 
 #ifdef MV_GPON_DEBUG_PRINT
@@ -355,6 +356,11 @@ MV_STATUS onuGponApiTcontConfig(MV_U32 allocId, MV_U32 tcontId)
 		   __FILE_DESC__, __LINE__, allocId, tcontId);
 #endif  /* MV_GPON_DEBUG_PRINT */
 
+	/* do not set additional T-CONT */
+	state = onuGponDbHighPriTxAddTcontCheck(tcontId);
+	if (state == MV_TRUE)
+		return MV_OK;
+
 	rcode = onuGponAllocIdTcontSet(allocId, tcontId);
 	if (rcode != MV_OK) {
 		mvPonPrint(PON_PRINT_ERROR, PON_API_MODULE,
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuDb.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuDb.c
index 4d9c9c7..5477a7f 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuDb.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuDb.c
@@ -3830,6 +3830,43 @@ MV_STATUS onuGponDbHighPriTxMapGet(S_OnuTcontMap *tcontMap)
 
 /*******************************************************************************
 **
+**  onuGponDbHighPriTxAddTcontCheck
+**  ____________________________________________________________________________
+**
+**  DESCRIPTION: The function check if the input T-CONT is addtional T-CONT
+**
+**  PARAMETERS:  MV_U32 addTcont
+**
+**  OUTPUTS:     None
+**
+**  RETURNS:     MV_TRUE or MV_FAULSE
+**
+*******************************************************************************/
+MV_BOOL onuGponDbHighPriTxAddTcontCheck(MV_U32 addTcont)
+{
+	MV_U32 idx;
+	S_OnuTcontMap *map;
+
+	/* check state */
+	if (MV_FALSE == onuGponDb_s.onuGponGenTbl_s.onuHighPriTx.state)
+		return MV_FALSE;
+
+	/* check whether it is addtional T-CONT */
+	for (idx = 0; idx < ONU_GPON_MAX_NUM_OF_T_CONTS; idx++) {
+		map = &onuGponDb_s.onuGponGenTbl_s.onuHighPriTx.tcontMap[idx];
+
+		if (map->valid == MV_FALSE)
+			continue;
+
+		if (map->addTcont == addTcont)
+			return MV_TRUE;
+	}
+
+	return MV_FALSE;
+}
+
+/*******************************************************************************
+**
 **  onuGponDbHighPriTxMapDel
 **  ____________________________________________________________________________
 **
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuDb.h b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuDb.h
index b60c44c..7070f9d 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuDb.h
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuDb.h
@@ -325,6 +325,7 @@ MV_BOOL   onuGponDbHighPriTxStateGet(void);
 MV_STATUS onuGponDbHighPriTxMapCheck(S_OnuTcontMap *tcontMap);
 MV_STATUS onuGponDbHighPriTxMapSet(S_OnuTcontMap *tcontMap);
 MV_STATUS onuGponDbHighPriTxMapGet(S_OnuTcontMap *tcontMap);
+MV_BOOL   onuGponDbHighPriTxAddTcontCheck(MV_U32 addTcont);
 MV_STATUS onuGponDbHighPriTxMapDel(MV_U32 hostTcont);
 MV_STATUS onuGponDbHighPriTxGet(S_OnuHighPriTx *highPriTx);
 
-- 
1.7.5.4

