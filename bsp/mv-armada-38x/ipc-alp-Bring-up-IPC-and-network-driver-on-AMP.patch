From 0457ee03ee7c7a58ea6cb0b8b7cfdb43885f9704 Mon Sep 17 00:00:00 2001
From: Igor Patrik <igorp@marvell.com>
Date: Tue, 15 Oct 2013 10:50:24 +0200
Subject: [PATCH 1028/1825] ipc: alp: Bring up IPC and network driver on AMP

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 0608f0b8bb7a163147d5e839fdde5e2c6811fb95

	Added requered pacthes in Makefile and mvRules.mk
	Fixed shared memory address for ALP.
	Added defconfig avanta_lp_amp_defconfig.

Signed-off-by: Igor Patrik <igorp@marvell.com>

Change-Id: Ib4807df840f8bf0f7e2f24d2d3a510384b290288
Reviewed-on: http://vgitil04.il.marvell.com:8080/3704
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Igor Patrik <igorp@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/configs/avanta_lp_amp_defconfig           |  183 ++++++++++++++++++++
 arch/arm/mach-avantalp/Makefile                    |    3 +-
 arch/arm/mach-avantalp/config/mvRules.mk           |    3 +-
 .../mv_drivers_lsp/mv_ipc/linux_amp/mv_ipc_node.h  |   16 ++-
 4 files changed, 198 insertions(+), 7 deletions(-)
 create mode 100644 arch/arm/configs/avanta_lp_amp_defconfig

diff --git a/arch/arm/configs/avanta_lp_amp_defconfig b/arch/arm/configs/avanta_lp_amp_defconfig
new file mode 100644
index 0000000..b0d219b
--- /dev/null
+++ b/arch/arm/configs/avanta_lp_amp_defconfig
@@ -0,0 +1,183 @@
+# CONFIG_ARM_PATCH_PHYS_VIRT is not set
+CONFIG_EXPERIMENTAL=y
+CONFIG_SYSVIPC=y
+CONFIG_CC_OPTIMIZE_FOR_SIZE=y
+CONFIG_SYSCTL_SYSCALL=y
+CONFIG_EMBEDDED=y
+CONFIG_SLAB=y
+CONFIG_PROFILING=y
+CONFIG_OPROFILE=y
+CONFIG_KPROBES=y
+CONFIG_MODULES=y
+CONFIG_MODULE_UNLOAD=y
+# CONFIG_BLK_DEV_BSG is not set
+CONFIG_PARTITION_ADVANCED=y
+CONFIG_ARCH_AVANTA_LP=y
+# CONFIG_MV_INCLUDE_CESA is not set
+CONFIG_MV_ETH_TXQ=8
+# CONFIG_NET_SKB_RECYCLE is not set
+# CONFIG_MV_INCLUDE_LEGACY_NAND is not set
+CONFIG_MV_AMP_ENABLE=y
+CONFIG_MTD_NAND_NFC_INIT_RESET=y
+CONFIG_MV_ETH_DEBUG_CODE=y
+CONFIG_MV_ETH_STAT_DBG=y
+# CONFIG_SWP_EMULATE is not set
+# CONFIG_CACHE_L2X0 is not set
+CONFIG_PCI_DEBUG=y
+CONFIG_SMP=y
+CONFIG_SCHED_MC=y
+CONFIG_SCHED_SMT=y
+CONFIG_NR_CPUS=2
+CONFIG_AEABI=y
+CONFIG_UACCESS_WITH_MEMCPY=y
+CONFIG_ZBOOT_ROM_TEXT=0x0
+CONFIG_ZBOOT_ROM_BSS=0x0
+CONFIG_VFP=y
+CONFIG_NEON=y
+# CONFIG_CORE_DUMP_DEFAULT_ELF_HEADERS is not set
+# CONFIG_SUSPEND is not set
+CONFIG_NET=y
+CONFIG_PACKET=y
+CONFIG_UNIX=y
+CONFIG_INET=y
+CONFIG_IP_MULTICAST=y
+CONFIG_IP_PNP=y
+CONFIG_IP_PNP_DHCP=y
+CONFIG_IP_PNP_BOOTP=y
+CONFIG_IPV6=y
+CONFIG_BRIDGE=y
+CONFIG_NET_PKTGEN=m
+CONFIG_UEVENT_HELPER_PATH="/sbin/hotplug"
+CONFIG_DEVTMPFS=y
+CONFIG_DEVTMPFS_MOUNT=y
+CONFIG_MTD=y
+CONFIG_MTD_CMDLINE_PARTS=y
+CONFIG_MTD_CHAR=y
+CONFIG_MTD_BLOCK=y
+CONFIG_MTD_CFI=y
+CONFIG_MTD_JEDECPROBE=y
+CONFIG_MTD_CFI_ADV_OPTIONS=y
+CONFIG_MTD_CFI_GEOMETRY=y
+# CONFIG_MTD_MAP_BANK_WIDTH_4 is not set
+CONFIG_MTD_CFI_INTELEXT=y
+CONFIG_MTD_CFI_STAA=y
+CONFIG_MTD_PHYSMAP=y
+CONFIG_MTD_M25P80=y
+CONFIG_MTD_NAND=y
+CONFIG_MTD_NAND_VERIFY_WRITE=y
+CONFIG_MTD_UBI=y
+CONFIG_BLK_DEV_LOOP=y
+# CONFIG_SCSI_PROC_FS is not set
+CONFIG_BLK_DEV_SD=y
+CONFIG_BLK_DEV_SR=m
+CONFIG_CHR_DEV_SG=m
+CONFIG_ATA=y
+CONFIG_SATA_AHCI=y
+CONFIG_SATA_MV=y
+CONFIG_MD=y
+CONFIG_BLK_DEV_MD=y
+CONFIG_MD_LINEAR=y
+CONFIG_MD_RAID0=y
+CONFIG_MD_RAID1=y
+CONFIG_MD_RAID10=y
+CONFIG_MD_RAID456=y
+CONFIG_NETDEVICES=y
+# CONFIG_NET_VENDOR_3COM is not set
+CONFIG_E100=y
+CONFIG_E1000E=y
+CONFIG_SKY2=y
+CONFIG_PHYLIB=y
+# CONFIG_INPUT_KEYBOARD is not set
+# CONFIG_INPUT_MOUSE is not set
+# CONFIG_SERIO is not set
+# CONFIG_VT is not set
+CONFIG_LEGACY_PTY_COUNT=16
+# CONFIG_DEVKMEM is not set
+CONFIG_SERIAL_8250=y
+CONFIG_SERIAL_8250_CONSOLE=y
+# CONFIG_SERIAL_8250_PCI is not set
+CONFIG_SERIAL_8250_RUNTIME_UARTS=2
+CONFIG_SERIAL_8250_DW=y
+# CONFIG_HW_RANDOM is not set
+CONFIG_I2C=y
+CONFIG_I2C_CHARDEV=y
+CONFIG_I2C_MV64XXX=y
+CONFIG_SPI=y
+CONFIG_GPIO_SYSFS=y
+# CONFIG_HWMON is not set
+CONFIG_HID_A4TECH=y
+CONFIG_HID_APPLE=y
+CONFIG_HID_BELKIN=y
+CONFIG_HID_CHERRY=y
+CONFIG_HID_CHICONY=y
+CONFIG_HID_CYPRESS=y
+CONFIG_HID_EZKEY=y
+CONFIG_HID_GYRATION=y
+CONFIG_HID_LOGITECH=y
+CONFIG_HID_MICROSOFT=y
+CONFIG_HID_MONTEREY=y
+CONFIG_HID_PANTHERLORD=y
+CONFIG_HID_PETALYNX=y
+CONFIG_HID_SAMSUNG=y
+CONFIG_HID_SONY=y
+CONFIG_HID_SUNPLUS=y
+CONFIG_USB=y
+CONFIG_USB_DEVICEFS=y
+CONFIG_USB_XHCI_HCD=y
+CONFIG_USB_EHCI_HCD=y
+CONFIG_USB_EHCI_ROOT_HUB_TT=y
+CONFIG_USB_PRINTER=y
+CONFIG_USB_STORAGE=y
+CONFIG_USB_STORAGE_DATAFAB=y
+CONFIG_USB_STORAGE_FREECOM=y
+CONFIG_USB_STORAGE_SDDR09=y
+CONFIG_USB_STORAGE_SDDR55=y
+CONFIG_USB_STORAGE_JUMPSHOT=y
+CONFIG_NEW_LEDS=y
+CONFIG_RTC_CLASS=y
+CONFIG_DMADEVICES=y
+CONFIG_MV_XOR=y
+CONFIG_DMATEST=m
+CONFIG_STAGING=y
+CONFIG_PHONE=y
+CONFIG_EXT2_FS=y
+CONFIG_EXT3_FS=y
+# CONFIG_EXT3_DEFAULTS_TO_ORDERED is not set
+# CONFIG_EXT3_FS_XATTR is not set
+CONFIG_XFS_FS=y
+CONFIG_ISO9660_FS=y
+CONFIG_JOLIET=y
+CONFIG_UDF_FS=m
+CONFIG_MSDOS_FS=y
+CONFIG_VFAT_FS=y
+CONFIG_TMPFS=y
+CONFIG_JFFS2_FS=y
+CONFIG_NFS_FS=y
+CONFIG_NFS_V3=y
+CONFIG_ROOT_NFS=y
+CONFIG_NLS_CODEPAGE_437=y
+CONFIG_NLS_CODEPAGE_850=y
+CONFIG_NLS_ISO8859_1=y
+CONFIG_NLS_ISO8859_2=y
+CONFIG_NLS_UTF8=y
+CONFIG_MAGIC_SYSRQ=y
+CONFIG_DEBUG_FS=y
+CONFIG_DEBUG_SHIRQ=y
+CONFIG_DETECT_HUNG_TASK=y
+# CONFIG_SCHED_DEBUG is not set
+# CONFIG_DEBUG_BUGVERBOSE is not set
+CONFIG_DEBUG_INFO=y
+# CONFIG_FTRACE is not set
+# CONFIG_ARM_UNWIND is not set
+CONFIG_DEBUG_USER=y
+CONFIG_DEBUG_LL=y
+CONFIG_EARLY_PRINTK=y
+CONFIG_CRYPTO_CBC=m
+CONFIG_CRYPTO_ECB=m
+CONFIG_CRYPTO_PCBC=m
+CONFIG_CRYPTO_DEFLATE=y
+CONFIG_CRYPTO_LZO=y
+# CONFIG_CRYPTO_ANSI_CPRNG is not set
+CONFIG_CRC_CCITT=y
+CONFIG_CRC16=y
+CONFIG_LIBCRC32C=y
diff --git a/arch/arm/mach-avantalp/Makefile b/arch/arm/mach-avantalp/Makefile
index fd2fb49..469ef46 100644
--- a/arch/arm/mach-avantalp/Makefile
+++ b/arch/arm/mach-avantalp/Makefile
@@ -100,7 +100,8 @@ obj-$(CONFIG_MV_INCLUDE_GIG_ETH)	+= $(LSP_PHY_DIR)/phy_sysfs.o
 
 obj-$(CONFIG_MV_USE_XOR_ENGINE) 	+= $(PLAT_DRIVERS)/mv_xor/
 obj-$(CONFIG_MV_CESA) 			+= $(PLAT_DRIVERS)/mv_cesa/
-obj-$(CONFIG_MV_IPC_DRIVER)		+= $(PLAT_DRIVERS)/mv_ipc/
+obj-$(CONFIG_MV_IPC_LINUX_AMP_DRIVER)	+= $(COMMON_DIR)/mvIpc.o $(PLAT_DRIVERS)/mv_ipc/
+obj-$(CONFIG_MV_IPC_FREERTOS_DRIVER)	+= $(COMMON_DIR)/mvIpc.o $(PLAT_DRIVERS)/mv_ipc/
 obj-$(CONFIG_MV_IPC_NET)		+= $(PLAT_DRIVERS)/mv_ipc_net/
 #obj-y					+= $(PLAT_DRIVERS)/mv_btns/
 obj-y					+= $(PLAT_DRIVERS)/mv_gpio/
diff --git a/arch/arm/mach-avantalp/config/mvRules.mk b/arch/arm/mach-avantalp/config/mvRules.mk
index a24509f..d6361cc 100644
--- a/arch/arm/mach-avantalp/config/mvRules.mk
+++ b/arch/arm/mach-avantalp/config/mvRules.mk
@@ -80,6 +80,7 @@ LSP_TRACE_DIR     = $(PLAT_DRIVERS)/mv_trace
 LSP_SWITCH_DIR    = $(PLAT_DRIVERS)/mv_switch
 LSP_PHY_DIR       = $(PLAT_DRIVERS)/mv_phy
 LSP_MUX_DIR       = $(PLAT_DRIVERS)/mv_mux
+LSP_IPC_DIR       = $(PLAT_DRIVERS)/mv_ipc/linux_amp
 
 # Environment components
 ALP_FAM_DIR	= avanta_lp_family
@@ -109,7 +110,7 @@ LSP_PATH        = -I$(LSP_PATH_I)
 CONFIG_PATH     = -I$(LSP_PATH_I)/$(CONFIG_DIR)
 HAL_IF_PATH	= -I$(LSP_PATH_I)/$(HAL_IF) -I$(LSP_PATH_I)/$(HAL_PP2_DIR)
 DRIVERS_LSP_PATH = -I$(PLAT_PATH_I)/$(PLAT_DRIVERS) -I$(PLAT_PATH_I)/$(LSP_PP2_DIR) -I$(PLAT_PATH_I)/$(LSP_SWITCH_DIR) \
-		 -I$(PLAT_PATH_I)/$(LSP_TRACE_DIR)
+		 -I$(PLAT_PATH_I)/$(LSP_TRACE_DIR) -I$(PLAT_PATH_I)/$(LSP_IPC_DIR)
 
 EXTRA_INCLUDE  	= $(OSSERV_PATH) $(COMMON_PATH) $(HAL_PATH)  $(ALP_FAM_PATH) \
                   $(LSP_PATH) $(CONFIG_PATH) $(DRIVERS_LSP_PATH) $(HAL_IF_PATH)
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_ipc/linux_amp/mv_ipc_node.h b/arch/arm/plat-armada/mv_drivers_lsp/mv_ipc/linux_amp/mv_ipc_node.h
index 3d6a4b9..6b9d760 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_ipc/linux_amp/mv_ipc_node.h
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_ipc/linux_amp/mv_ipc_node.h
@@ -54,8 +54,8 @@
 }
 
 /*Set HW Layer mode*/
-/*#define MV_IPC_HW_LAYER_ACTUAL        MV_IPC_HW_LAYER_POLLING_ACTIVE*/
-#define MV_IPC_HW_LAYER_ACTUAL  MV_IPC_HW_LAYER_INTERRUPT_ISR
+#define MV_IPC_HW_LAYER_ACTUAL        MV_IPC_HW_LAYER_POLLING_ACTIVE
+/*#define MV_IPC_HW_LAYER_ACTUAL  MV_IPC_HW_LAYER_INTERRUPT_ISR*/
 
 #define MV_IPC_HW_LAYERS_NUM    2
 /*HW layers function, send trigger is TX done signal,
@@ -67,10 +67,16 @@
 
 /*Link info array, set number of channels,
    master/slave. shmem phys adrress and size*/
-/*numOfChn		isMaster, shmemAddr,		shmemSize*/
+#ifdef CONFIG_ARCH_AVANTA_LP
+#define MV_IPC_SHARED_MEM_REGION_BASE 0x10000000
+#endif
+#ifdef CONFIG_ARCH_ARMADA_XP
+#define MV_IPC_SHARED_MEM_REGION_BASE 0x60000000
+#endif
+/*numOfChn		isMaster, shmemVirtAddr,shmemAddr,		shmemSize*/
 #define MV_IPC_LINK_INFO_TABLE { \
-		{ 4,             MV_TRUE,        NULL,           0x60000000,             0x100000 }, \
-		{ 8,             MV_TRUE,        NULL,           0x60100000,             0x100000 }, \
+		{ 4,	MV_TRUE,	NULL,	MV_IPC_SHARED_MEM_REGION_BASE,			0x100000 }, \
+		{ 8,	MV_TRUE,	NULL,	MV_IPC_SHARED_MEM_REGION_BASE+0x100000,	0x100000 }, \
 }
 
 /*Division of free malloc area between master and slave*/
-- 
1.7.5.4

