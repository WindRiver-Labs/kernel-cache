From 7f11edb4a894c4c222d3e63bf9148bcb256cd2cb Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Wed, 22 May 2013 20:43:13 +0300
Subject: [PATCH 0684/1825] ALP: IOCC: Serialize access to IO sync code

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 309b8bad3b35862eb164670c8d9e03800030692c

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: I29910cdeb95bc6a240f4f2cc50f651f65d3df806
Reviewed-on: http://vgitil04.il.marvell.com:8080/1937
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/core.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index 76c316e..be478a3 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -1183,14 +1183,18 @@ extern MV_TARGET_ATTRIB mvTargetDefaultsArray[];
 
 #ifdef CONFIG_ALP_IOCC_SYNC_BARRIER_WA
 
+static DEFINE_SPINLOCK(alp_io_sync_barrier_lock);
 void *io_sync_virt_addr_for_write;
 
 void dma_io_sync(void)
 {
+	unsigned long flags;
 	u32 val = 0;
 	u32 *virt_uncached = (u32 *)(SZ_1K + CRYPT_ENG_VIRT_BASE(0));
 	u32 *virt_cached   = (u32 *)(SZ_1K + io_sync_virt_addr_for_write);
 
+	spin_lock_irqsave(&alp_io_sync_barrier_lock, flags);
+
 	/*
 	 * Write 0 through straight-forward path
 	 */
@@ -1209,6 +1213,8 @@ void dma_io_sync(void)
 	do {
 		val = readl(virt_uncached);
 	} while (val != 1);
+
+	spin_unlock_irqrestore(&alp_io_sync_barrier_lock, flags);
 }
 
 static void alp_iocc_wa_setup_punit_win(ulong phys0, ulong phys1, MV_TARGET target)
-- 
1.7.5.4

