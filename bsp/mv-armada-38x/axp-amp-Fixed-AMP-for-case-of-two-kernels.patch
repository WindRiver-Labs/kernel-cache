From ba444b218a186f59b1bab52faa72638af2419549 Mon Sep 17 00:00:00 2001
From: Igor Patrik <igorp@marvell.com>
Date: Tue, 30 Jul 2013 14:11:11 +0200
Subject: [PATCH 0912/1825] axp:amp: Fixed AMP for case of two kernels.

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 2e9bb49be4ab96c2d2f908882739e7b9f08af561

	Ported from 3.2 relevant changes related to AMP

Change-Id: I79dd79c100978c1ab2d8ce5fc121035c420e863b
Signed-off-by: Igor Patrik <igorp@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/2884
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/boot/compressed/head.S |   20 +++++++++++---------
 tools/amp/amp_make.pl           |   19 ++++++-------------
 2 files changed, 17 insertions(+), 22 deletions(-)

diff --git a/arch/arm/boot/compressed/head.S b/arch/arm/boot/compressed/head.S
index d573d87..8d392bc 100644
--- a/arch/arm/boot/compressed/head.S
+++ b/arch/arm/boot/compressed/head.S
@@ -141,15 +141,17 @@ start:
  THUMB(		.thumb			)
 1:
 #if !defined(CONFIG_ARCH_FEROCEON)
-#if defined(CONFIG_ARCH_ARMADA_XP) && !defined(CONFIG_MV_AMP_ENABLE)
-
-/* Disable in AMP since in AMP mode the internal register base must match
- * U-BOOTs base. Two operating systems cannot modify the base during boot
- * as is done with a single image */
-
-		/* Update Internal Regs offset in case UBoot is configured
-		** to use a different base address.
-		*/
+#if defined(CONFIG_ARCH_ARMADA_XP) && defined(CONFIG_MV_AMP_ENABLE)
+/* Update Internal Regs offset in case UBoot is configured
+** to use a different base address.
+*/
+		mrc p15, 0, r0, c5, c0, 0	@ Get the internal registers indication
+		tst r0, #(1 << 11)		@ Check 0xF1000000 indication - bit 11
+		beq 1f				@ If bit 11 is not set (equal):
+						@ AXP - Need to check original Internal regs offset CP15 register
+						@ A370 - U-Boot was using 0xD0000000
+		b 2f				@ Else, bit 11 is set - U-Boot was using 0xF1000000 - Nothing to do
+1:
 		mrc p15, 4, r0, c15, c0, 0	@ Get the internal registers base address
 		lsl r0, r0, #13			@ the address is R-shifted, need to recover it
 		ldr r5, =0x20080
diff --git a/tools/amp/amp_make.pl b/tools/amp/amp_make.pl
index 98e4432..7f13ce2 100644
--- a/tools/amp/amp_make.pl
+++ b/tools/amp/amp_make.pl
@@ -38,9 +38,9 @@ while( $line = <cfg_file>)
 }
 while( $line = <boot_file>)
 {
-	if($line =~ m/zreladdr-y	:= (\S*)/){$load_addr = $1;}
-	if($line =~ m/params_phys-y	:= (\S*)/){$pars_addr = $1;}
-	if($line =~ m/initrd_phys-y	:= (\S*)/){$ramd_addr = $1;}
+	if($line =~ m/zreladdr-y\s:= (0x[0-9a-fA-F]*)$/){$load_addr = $1;}
+	if($line =~ m/params_phys-y\s:= (0x[0-9a-fA-F]*)$/){$pars_addr = $1;}
+	if($line =~ m/initrd_phys-y\s:= (0x[0-9a-fA-F]*)$/){$ramd_addr = $1;}
 }
 
 
@@ -97,11 +97,9 @@ for (; ($g_id < 2) and ($g_id >= 0); $g_id += $add)
 	# Modify .config
 	system("perl -p -i -e \"s/CONFIG_MV_DRAM_BASE=.*/CONFIG_MV_DRAM_BASE=$base[$g_id]/\" .config");
 	system("perl -p -i -e \"s/CONFIG_MV_UART_PORT=.*/CONFIG_MV_UART_PORT=$port[$g_id]/\" .config");
-
-	# Modify Makefile.boot
-	system("perl -p -i -e \"s/zreladdr-y	:= .*/zreladdr-y	:= $new_load/\" arch/arm/mach-armadaxp/Makefile.boot");
-	system("perl -p -i -e \"s/params_phys-y	:= .*/params_phys-y	:= $new_pars/\" arch/arm/mach-armadaxp/Makefile.boot");
-	system("perl -p -i -e \"s/initrd_phys-y	:= .*/initrd_phys-y	:= $new_ramd/\" arch/arm/mach-armadaxp/Makefile.boot");
+	system("perl -p -i -e \"s/CONFIG_MV_ZREL_ADDR=.*/CONFIG_MV_ZREL_ADDR=$new_load/\" .config");
+	system("perl -p -i -e \"s/CONFIG_MV_PARAM_PHYS=.*/CONFIG_MV_PARAM_PHYS=$new_pars/\" .config");
+	system("perl -p -i -e \"s/CONFIG_MV_INITRD_PHYS=.*/CONFIG_MV_INITRD_PHYS=$new_ramd/\" .config");
 
 	#Compile
 	$fail = system("make uImage -j4");
@@ -116,12 +114,7 @@ for (; ($g_id < 2) and ($g_id >= 0); $g_id += $add)
 	print "\nAMP: Image $g_id ready at $out_dir/uImage_g$g_id\n";
 }
 
-
 END:
 
-system("perl -p -i -e \"s/zreladdr-y	:= .*/zreladdr-y	:= $load_addr/\" arch/arm/mach-armadaxp/Makefile.boot");
-system("perl -p -i -e \"s/params_phys-y	:= .*/params_phys-y	:= $pars_addr/\" arch/arm/mach-armadaxp/Makefile.boot");
-system("perl -p -i -e \"s/initrd_phys-y	:= .*/initrd_phys-y	:= $ramd_addr/\" arch/arm/mach-armadaxp/Makefile.boot");
-
 close cfg_file;
 close boot_file;
-- 
1.7.5.4

