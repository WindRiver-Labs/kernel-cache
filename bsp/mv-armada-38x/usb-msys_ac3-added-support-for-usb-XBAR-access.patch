From c02cc7fd4b5a1ed58c7bd9ddffe9d6fbce21d274 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Mon, 16 Jun 2014 11:16:22 +0300
Subject: [PATCH 1734/1825] usb: msys_ac3: added support for usb XBAR access

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 8d53f1c230e940ca2c2845949219a030eae28fc8

	- Enabled XBAR window #2 for USB port#5
	- Added new diffrentiation between XBAR and internal register access

Change-Id: I254b10944eb2ac64957503855dd9ebbdd5170913
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8542
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Kostya Porotchkin <kostap@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8636
Reviewed-by: Tawfik Bayouk <tawfik@marvell.com>
Tested-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h      |    1 +
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |    2 +-
 .../mach-msys/msys_family/ctrlEnv/mvCtrlEnvRegs.h  |    1 +
 .../mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h  |   14 +++++++++-----
 4 files changed, 12 insertions(+), 6 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
index 5be126a..d368664 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -136,6 +136,7 @@ extern "C" {
 
 /* USB3 registers */
 #define USB3_REGS_PHYS_BASE(dev)		(INTER_REGS_BASE + MV_USB3_REGS_BASE(dev))
+#define MV_USB2_CAPLENGTH_OFFSET(index)		(INTER_REGS_BASE + MV_USB_REGS_OFFSET(index) + 0x100)
 
 /*
  * Miscellanuous Controller Configurations
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index c60a5a2..ec6c0ce 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -145,7 +145,7 @@ extern "C" {
 #define MV_ETH_SMI_PORT   0
 
 #define MV_USB3_WIN_BASE(unitId)		MV_USB3_REGS_OFFSET(unitId)
-
+#define MV_USB2_CAPLENGTH_OFFSET(index)		(INTER_REGS_BASE + MV_USB_REGS_OFFSET(index) + 0x100)
 /*
  * Miscellanuous Controller Configurations
  */
diff --git a/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvRegs.h b/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvRegs.h
index 0f230d4..4e29b4a 100644
--- a/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvRegs.h
+++ b/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvRegs.h
@@ -286,6 +286,7 @@ typedef enum _mvTargetId {
 	DEV_TARGET_ID    = 1,	/* Port 1 -> Device port, BootROM, SPI	*/
 	SWITCH_TARGET_ID = 3,	/* Port 3 -> Switching Core Adapter/units */
 	PEX0_TARGET_ID   = 4,	/* Port 4 -> PCI Express 0		*/
+	USB_TARGET_ID    = 5,	/* Port 5 -> USB unit			*/
 	DFX_TARGET_ID    = 8,	/* Port 8 -> DFX Server			*/
 	CRYPT_TARGET_ID  = 9,	/* Port 9 --> Crypto Engine SRAM	*/
 	PNC_BM_TARGET_ID = 12,	/* Port 12 -> PNC + BM Unit		*/
diff --git a/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h
index 137ab86..54eb34a 100644
--- a/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -112,7 +112,7 @@ extern "C" {
 #define MV_PEX_IF_REGS_OFFSET(pexIf)\
 			(pexIf < 8 ? (0x40000 + ((pexIf) / 4) * 0x40000 + ((pexIf) % 4) * 0x4000)\
 	: (0X42000 + ((pexIf) % 8) * 0x40000))
-#define MV_USB_REGS_OFFSET(dev)			(0x50000 + (dev * 0x1000))
+#define MV_USB_REGS_OFFSET(dev)			(USB_XBAR_REG_BASE + 0x50000) /* USB registers through XBAR port 5 */
 #define MV_XOR_REGS_OFFSET(unit)		(0xF0800)
 #if defined(MV_INCLUDE_IDMA)
 #define MV_IDMA_REGS_OFFSET			(0x60800)
@@ -124,6 +124,7 @@ extern "C" {
 #define MV_PNC_REGS_OFFSET			(0xC8000)
 #define MV_SDMMC_REGS_OFFSET			(0xD4000)
 
+#define MV_USB2_CAPLENGTH_OFFSET(index)		(MV_USB_REGS_OFFSET(index) + 0x100)
 
 #define MV_ETH_SMI_PORT   0
 /*
@@ -284,6 +285,7 @@ typedef enum _mvTarget {
 	SPI_CS7,	/* 21 SPI_CS7			*/
 	BOOT_ROM_CS,	/* 22 BOOT_ROM_CS		*/
 	DEV_BOOCS,	/* 23 DEV_BOOCS			*/
+	USB_REGS,	/* 24 USB Internal registers	*/
 	MAX_TARGETS
 } MV_TARGET;
 
@@ -324,6 +326,7 @@ typedef enum _mvTarget {
 	{0xDF, DEV_TARGET_ID	},		/* 21 SPI_CS7 */	\
 	{0x1D, DEV_TARGET_ID	},		/* 22 BOOT_ROM_CS (Main Boot device )*/	\
 	{0x2F, DEV_TARGET_ID	},		/* 23 DEV_BOOT_CS (Secondary Boot device,)*/	\
+	{0x00, USB_TARGET_ID	},		/* 24 USB_TARGET_REGS */\
 }
 
 #define TARGETS_NAME_ARRAY	{			\
@@ -338,7 +341,7 @@ typedef enum _mvTarget {
 	"PEX0_MEM",		/*  8 PEX0_MEM */	\
 	"PEX0_IO",		/*  9 PEX0_IO */	\
 	"INTER_REGS",		/* 10 INTER_REGS */	\
-	"DFX_INTER_REGS",	/* 11 INTER_REGS */	\
+	"DFX_INTER_REGS",	/* 11 DFX_REGS */	\
 	"SWITCH_REGS",		/* 12 SWITCH_REGS */	\
 	"DMA_UART",		/* 13 DMA_UART */	\
 	"SPI_CS0",		/* 14 SPI_CS0 */	\
@@ -348,9 +351,10 @@ typedef enum _mvTarget {
 	"SPI_CS4",		/* 18 SPI_CS4 */	\
 	"SPI_CS5",		/* 19 SPI_CS5 */	\
 	"SPI_CS6",		/* 20 SPI_CS6 */	\
-	"SPI_CS7",		/* 22 SPI_CS7 */	\
-	"BOOT_ROM_CS",		/* 23 BOOT_ROM_CS */	\
-	"DEV_BOOTCS",		/* 24 DEV_BOOCS */	\
+	"SPI_CS7",		/* 21 SPI_CS7 */	\
+	"BOOT_ROM_CS",		/* 22 BOOT_ROM_CS */	\
+	"DEV_BOOTCS",		/* 23 DEV_BOOCS */	\
+	"USB_REGS",		/* 24 USB_REGS */	\
 }
 
 
-- 
1.7.5.4

