From c509d74a9ceaa449223663bd3c8afef9bd8ec2e5 Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Thu, 15 Nov 2012 10:20:35 +0200
Subject: [PATCH 0339/1825] Added suspend resume support to XOR engine

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 027f6434200ec5d82003dd0016370a32983621f3

Change-Id: Ie41afb4572ca84f57a3014bc80a9b6e70ac87e1c
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/dma/mv_xor.c |   60 ++++++++++++++++++++++++++++++++++++++++++++++++++
 drivers/dma/mv_xor.h |    6 +++++
 2 files changed, 66 insertions(+), 0 deletions(-)

diff --git a/drivers/dma/mv_xor.c b/drivers/dma/mv_xor.c
index 8a643a4..83e4a36 100644
--- a/drivers/dma/mv_xor.c
+++ b/drivers/dma/mv_xor.c
@@ -35,6 +35,7 @@ static void mv_xor_issue_pending(struct dma_chan *chan);
 unsigned int dummy1[MV_XOR_MIN_BYTE_COUNT];
 unsigned int dummy2[MV_XOR_MIN_BYTE_COUNT];
 dma_addr_t dummy1_addr, dummy2_addr;
+static struct mv_xor_save_regs saved_regs;
 
 #define to_mv_xor_chan(chan)		\
 	container_of(chan, struct mv_xor_chan, common)
@@ -1238,9 +1239,49 @@ mv_xor_conf_mbus_windows(struct mv_xor_shared_private *msp,
 	writel(win_enable, base + WINDOW_BAR_ENABLE(1));
 }
 
+#ifdef CONFIG_PM
+static int mv_xor_suspend(struct platform_device *dev, pm_message_t state)
+{
+	struct mv_xor_device *device = platform_get_drvdata(dev);
+	struct dma_chan *dma_chan;
+	struct mv_xor_chan *mv_chan;
+
+	/* Practicly this list holds always one channel */
+	dma_chan = container_of(device->common.channels.next, struct dma_chan,
+				device_node);
+
+	mv_chan = to_mv_xor_chan(dma_chan);
+	saved_regs.xor_config 	  = __raw_readl(XOR_CONFIG(mv_chan));
+	saved_regs.interrupt_mask = __raw_readl(XOR_INTR_MASK(mv_chan));
+
+	return 0;
+}
+
+static int mv_xor_resume(struct platform_device *dev)
+{
+	struct mv_xor_device *device = platform_get_drvdata(dev);
+	struct dma_chan *dma_chan;
+	struct mv_xor_chan *mv_chan;
+
+	/* Practicly this list holds always one channel */
+	dma_chan = container_of(device->common.channels.next, struct dma_chan,
+				device_node);
+
+	mv_chan = to_mv_xor_chan(dma_chan);
+	__raw_writel(saved_regs.xor_config, XOR_CONFIG(mv_chan));
+	__raw_writel(saved_regs.interrupt_mask, XOR_INTR_MASK(mv_chan));
+
+	return 0;
+}
+#endif /* CONFIG_PM*/
+
 static struct platform_driver mv_xor_driver = {
 	.probe		= mv_xor_probe,
 	.remove		= __devexit_p(mv_xor_remove),
+#ifdef CONFIG_PM
+	.suspend	= mv_xor_suspend,
+	.resume		= mv_xor_resume,
+#endif
 	.driver		= {
 		.owner	= THIS_MODULE,
 		.name	= MV_XOR_NAME,
@@ -1294,9 +1335,28 @@ static int mv_xor_shared_remove(struct platform_device *pdev)
 	return 0;
 }
 
+#ifdef CONFIG_PM
+static int mv_xor_shared_resume(struct platform_device *dev)
+{
+	struct mv_xor_platform_shared_data *msd = dev->dev.platform_data;
+	struct mv_xor_shared_private *msp;
+
+	msp = (struct mv_xor_shared_private *)platform_get_drvdata(dev);
+
+	/* Restore address decode windows */
+	if (msd != NULL && msd->dram != NULL)
+		mv_xor_conf_mbus_windows(msp, msd->dram);
+
+	return 0;
+}
+#endif
+
 static struct platform_driver mv_xor_shared_driver = {
 	.probe		= mv_xor_shared_probe,
 	.remove		= mv_xor_shared_remove,
+#ifdef CONFIG_PM
+	.resume		= mv_xor_shared_resume,
+#endif
 	.driver		= {
 		.owner	= THIS_MODULE,
 		.name	= MV_XOR_SHARED_NAME,
diff --git a/drivers/dma/mv_xor.h b/drivers/dma/mv_xor.h
index a1b101f..85e2559 100644
--- a/drivers/dma/mv_xor.h
+++ b/drivers/dma/mv_xor.h
@@ -162,6 +162,12 @@ struct mv_xor_desc {
 	u32 reserved1;
 };
 
+/* Stores certain registers during suspend to RAM */
+struct mv_xor_save_regs {
+	int xor_config;
+	int interrupt_mask;
+};
+
 #define to_mv_sw_desc(addr_hw_desc)		\
 	container_of(addr_hw_desc, struct mv_xor_desc_slot, hw_desc)
 
-- 
1.7.5.4

