From 625764f80ef4172a89b9e02dfc49900b14be995e Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Mon, 18 Nov 2013 13:34:02 +0200
Subject: [PATCH 1148/1825] spi: alp: enabled SPI-1 MPP settings when RGMII-1
 is disabled

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit db14eb3d1d718eb5565978ff8ee2ab2bffeba631

	RGMII-1 and SPI-1 are sharing MPP's.
	Before, SPI-1 was enabled only only when configured to use TDM external SLIC.
	Changed SPI-1 settings to be enabled when:
	1. Boot source is SPI1
	2. RGMII-1 is disabled
	- Set MPP31 - should be set to 0x3 as well (SPI1_MOSI(out))

Signed-off-by: Omri Itach <omrii@marvell.com>

Change-Id: Ie516022e16a52807397115c046355a6e70c9f3b7
Reviewed-on: http://vgitil04.il.marvell.com:8080/4343
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Kosta Zertsekel <konszert@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |    8 +++++---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |   12 ++++++------
 2 files changed, 11 insertions(+), 9 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 90733cd..0c91481 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -474,9 +474,11 @@ MV_VOID mvCtrlSmiMasterSet(MV_SMI_CTRL smiCtrl)
 	/* if not using Lantiq TDM, define REF_CLK_OUT (both utilize the same gpio) */
 	isRefClkOut   = !(slicDev == SLIC_LANTIQ_ID);
 
-	/*SPI1 in use: if enabled external SLI and disabled RGMII-1, or boot from SPI1*/
-	if ((slicDev == SLIC_EXTERNAL_ID && !(ethComplex & MV_ETHCOMP_GE_MAC1_2_RGMII1))
-			|| mvBoardBootDeviceGet() == MSAR_0_BOOT_SPI1_FLASH)
+	/*SPI1 is in use when:
+	 * 1. Boot source is SPI1
+	 * 2. RGMII-1 is disabled (SPI-1 MPP's are shared with RGMII-1 MPP's) */
+	if (mvBoardBootDeviceGet() == MSAR_0_BOOT_SPI1_FLASH ||
+		(!(ethComplex & MV_ETHCOMP_GE_MAC1_2_RGMII1)))
 		isSPI1Enabled = MV_TRUE;
 	else
 		isSPI1Enabled = MV_FALSE;
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index 1d57aff..0a478f1 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -301,8 +301,8 @@ typedef enum {
 #define MPP_GROUP_3_TYPE { \
 	0x22222222,     /* GE1  */ \
 	0x00333333,     /* SDIO	*/ \
-	0x33000000,     /* SPI1_BOOT	*/ \
-	0x33333333,     /* SDIO & SPI1	*/ \
+	0x33000000,     /* SPI1_BOOT (SPI1_[CSn(0),MOSI])	*/ \
+	0x33333333,     /* SDIO & SPI1 */ \
 }
 
 typedef enum {
@@ -317,10 +317,10 @@ typedef enum {
 	0x44422222,     /* GE1,  CPU SMI CONTROL,    REF_CLK_OUT */ \
 	0x05522222,     /* GE1,  SWITCH SMI CONTROL, TDM_LQ_UNIT */ \
 	0x45522222,     /* GE1,  SWITCH SMI CONTROL, REF_CLK_OUT */ \
-	0x04423330,     /* SPI1, CPU SMI CONTROL,    TDM_LQ_UNIT */ \
-	0x44423330,     /* SPI1, CPU SMI CONTROL,    REF_CLK_OUT */ \
-	0x05523330,     /* SPI1, SWITCH SMI CONTROL, TDM_LQ_UNIT */ \
-	0x45523330,     /* SPI1, SWITCH SMI CONTROL, REF_CLK_OUT */ \
+	0x04423333,     /* SPI1, CPU SMI CONTROL,    TDM_LQ_UNIT */ \
+	0x44423333,     /* SPI1, CPU SMI CONTROL,    REF_CLK_OUT */ \
+	0x05523333,     /* SPI1, SWITCH SMI CONTROL, TDM_LQ_UNIT */ \
+	0x45523333,     /* SPI1, SWITCH SMI CONTROL, REF_CLK_OUT */ \
 	0x00023330,	/* SPI1, NO SMI CONTROL, SD_Stat (GPIO_input) */\
 }
 
-- 
1.7.5.4

