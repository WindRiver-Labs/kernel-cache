From f30cd5458e9f66b256a566ef29754beaf4e92709 Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Mon, 11 Nov 2013 13:51:28 -0500
Subject: [PATCH 1072/1825] fix: pp2: Fix TX prefetch buffer initialization

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit f6f05e06bdebed07030db028780c9298509f3de4

	- 16 descriptors resereved for each existing TXQ
	- Correct prefetch buffer pointer mask 12 bits instead of 16 bits

Change-Id: I954a3a4e4c0aae4c73df9079eea56136d0d49bd5
Signed-off-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4281
Reviewed-by: Uri Eliyahu <uriel@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Tested-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c     |   16 +++++++++++++---
 arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h |    2 +-
 2 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c
index 1d737f0..a1b3b91 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c
@@ -638,7 +638,7 @@ MV_PP2_PHYS_TXQ_CTRL *mvPp2TxqInit(int port, int txp, int txq, int descNum, int
 {
 	MV_STATUS status;
 	MV_U32 regVal;
-	int ptxq = MV_PPV2_TXQ_PHYS(port, txp, txq);
+	int desc, descPerTxq, ptxq = MV_PPV2_TXQ_PHYS(port, txp, txq);
 	MV_PP2_PHYS_TXQ_CTRL *pTxq = &mvPp2PhysTxqs[ptxq];
 	MV_PP2_QUEUE_CTRL *qCtrl = &pTxq->queueCtrl;
 
@@ -669,8 +669,18 @@ MV_PP2_PHYS_TXQ_CTRL *mvPp2TxqInit(int port, int txp, int txq, int descNum, int
 		mvOsPrintf("port=%d, txp=%d txq=%d, ptxq=%d, sent=0x%08x - Sent packets\n",
 			port, txp, txq, ptxq, regVal);
 	}
-	mvPp2WrReg(MV_PP2_TXQ_PREF_BUF_REG, MV_PP2_PREF_BUF_PTR(ptxq * 16) | MV_PP2_PREF_BUF_SIZE_16 |
-				MV_PP2_PREF_BUF_THRESH(8));
+
+	/* Calculate base address in prefetch buffer. We reserve 16 descriptors for each existing TXQ */
+	/* TCONTS for PON port must be continious from 0 to mvPp2HalData.maxTcont */
+	/* GBE ports assumed to be continious from 0 to (mvPp2HalData.maxPort - 1) */
+	descPerTxq = 16;
+	if (MV_PON_PORT(port))
+		desc = ptxq * descPerTxq;
+	else
+		desc = (mvPp2HalData.maxTcont * MV_ETH_MAX_TXQ * descPerTxq) + (port * MV_ETH_MAX_TXQ * descPerTxq);
+
+	mvPp2WrReg(MV_PP2_TXQ_PREF_BUF_REG, MV_PP2_PREF_BUF_PTR(desc) | MV_PP2_PREF_BUF_SIZE_16 |
+				MV_PP2_PREF_BUF_THRESH(descPerTxq/2));
 
 	mvPp2TxqMaxRateSet(port, txp, txq);
 
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h
index 7cdb37d..e6fd578 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h
@@ -233,7 +233,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define MV_PP2_TXQ_PREF_BUF_REG			(MV_PP2_REG_BASE + 0x209c)
 
 #define MV_PP2_PREF_BUF_PTR_OFFSET		0
-#define MV_PP2_PREF_BUF_PTR_MASK		(0xFFFF << MV_PP2_PREF_BUF_PTR_OFFSET)
+#define MV_PP2_PREF_BUF_PTR_MASK		(0xFFF << MV_PP2_PREF_BUF_PTR_OFFSET)
 #define MV_PP2_PREF_BUF_PTR(desc)		((desc) << MV_PP2_PREF_BUF_PTR_OFFSET)
 
 #define MV_PP2_PREF_BUF_SIZE_OFFSET		12
-- 
1.7.5.4

