From f8d851d38956811d15958517c69c691600f352c1 Mon Sep 17 00:00:00 2001
From: Dovrat <dovrat@marvell.com>
Date: Wed, 23 Apr 2014 22:16:03 +0300
Subject: [PATCH 1584/1825] pp3:bm: seperate debug dir, additional
 verifications

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 3592148f31df50089cb2708269ed16b4261ad0f8

Change-Id: I707f3a21bb579812ca2efe0d2de5342d130d10f1
Signed-off-by: Dovrat <dovrat@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/7178
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Uri Eliyahu <uriel@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Tested-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/net/ethernet/marvell/pp3/bm/mv_bm_sysfs.c |  433 ++++++++++++---------
 1 files changed, 255 insertions(+), 178 deletions(-)

diff --git a/drivers/net/ethernet/marvell/pp3/bm/mv_bm_sysfs.c b/drivers/net/ethernet/marvell/pp3/bm/mv_bm_sysfs.c
index b763a25..90344ea 100644
--- a/drivers/net/ethernet/marvell/pp3/bm/mv_bm_sysfs.c
+++ b/drivers/net/ethernet/marvell/pp3/bm/mv_bm_sysfs.c
@@ -101,13 +101,7 @@ static ssize_t mv_bm_help(char *b)
 	o += scnprintf(b+o, s-o, "echo      > enable_status_get            - Get BM enable status\n");
 	o += scnprintf(b+o, s-o, "echo      > enable                       - enable BM\n");
 	o += scnprintf(b+o, s-o, "echo      > disable                      - disable BM\n");
-	o += scnprintf(b+o, s-o, "echo      > global_registers_dump        - Print global registers\n");
-	o += scnprintf(b+o, s-o, "echo      > pool_registers_dump pool     - Print all BM pool registers\n");
-	o += scnprintf(b+o, s-o, "echo      > bank_registers_dump bank     - Print all BM bank registers\n");
-	o += scnprintf(b+o, s-o, "echo      > cache_memory_dump bank       - Print 512 cache lines per in bank\n");
 	o += scnprintf(b+o, s-o, "echo      > idle_status_get              - Read BM idle status\n");
-	o += scnprintf(b+o, s-o, "echo      > idle_debug                   - Print busy indication registers\n");
-	o += scnprintf(b+o, s-o, "echo      > error_dump                   - Print busy reason registers\n");
 	o += scnprintf(b+o, s-o, "echo nb   > qm_gpm_pools_def_quick_init  - Initiates GPM pools\n");
 	o += scnprintf(b+o, s-o, "echo nb   > qm_dram_pools_def_quick_init - Initiates DRAM pools\n");
 	o += scnprintf(b+o, s-o, "echo p    > pool_quick_init_status_get   - Get pool quick init status\n");
@@ -124,8 +118,6 @@ static ssize_t mv_bm_help(char *b)
 	o += scnprintf(b+o, s-o, "echo p nb ps qi    > pool_fill_level_set    - Conf Fill level of pool in DRAM\n");
 	o += scnprintf(b+o, s-o, "echo p pn dpe dpf  > pool_status_get        - not empty almost full/empty\n");
 	o += scnprintf(b+o, s-o, "echo p nb ps et ft > pool_dram_set          - Conf Fill level of pool in DRAM\n");
-	o += scnprintf(b+o, s-o, "echo ba, ofs, wN, dP      > register_read   - Read register from BM units\n");
-	o += scnprintf(b+o, s-o, "echo ba, ofs, wN, dP      > register_write  - Write register in BM units\n");
 	o += scnprintf(b+o, s-o, "echo rD wD rC wC rQ wQ    > attr_qm_pool_set                     - rw att QM\n");
 	o += scnprintf(b+o, s-o, "echo rD wD rC wC rQ wQ    > attr_gp_pool_set                     - rw att GP\n");
 	o += scnprintf(b+o, s-o, "echo p cid ca cot cit cnb > pool_cache_set                       - Conf cache\n");
@@ -205,31 +197,40 @@ static ssize_t mv_bm_config(struct device *dev,
 			PR_ERR_CODE(rc)
 	} else if (!strcmp(name, "test")) {
 		u32 qm_num_of_buffers;
-		struct mv_a40 qece_base_address, pl_base_address;
+		struct mv_a40 qece_base_address, pl_base_address, base_address;
 		u32 pool, gp_num_of_buffers, partition_model, pool_pair;
-		struct mv_a40 base_address;
-		u32 completed, fill_level;
-		u32 status = 0;
-		u32 pool_nempty, dpool_ae, dpool_af;
-		pr_info("uni-test is called\n");
-		qm_num_of_buffers = qece_base_address.dma_msb = qece_base_address.virt_msb = pl_base_address.dma_msb = pl_base_address.virt_msb = 0;
-		gp_num_of_buffers = base_address.dma_msb = base_address.virt_msb = 0;
-		pool = partition_model = pool_pair = 0xFFFFFFFF;
+		u32 completed, fill_level, status = 0, temp, *temp_ptr, enabled, quick_init;
+		u32 ne, ae, af, rd_ptr, wr_ptr, i, pool_index;
+		struct bm_c_mng_stat_data cache;
+
 		sscanf(buf, "%d %d %d %d %d", &qm_num_of_buffers, &pool, &gp_num_of_buffers, &partition_model, &pool_pair);
 		if ((qm_num_of_buffers == 0) || (gp_num_of_buffers == 0)) {
 			pr_err("wrong number of buffers. should be larger than 0\n");
 			return -1;
 		}
+		/* Open BM session */
 		rc = bm_open();
 		if (rc != OK) {
 			pr_err("bm open failed\n");
 			return -1;
 		}
+		/* Set all default attributes */
 		rc = bm_attr_all_pools_def_set();
 		if (rc != OK) {
 			pr_err("set all attributes failed\n");
 			return -1;
 		}
+		bm_register_read(bm.dram_domain_conf, 0, 1, &temp);
+		pr_info("domain (%x) %x\n", bm.dram_domain_conf, temp);
+		if (temp != 0) {
+			pr_err("register dram_domain_conf hold wrong values %x\n", temp);
+			return -1;
+		}
+		bm_register_read(bm.dram_cache_conf, 0, 1, &temp);
+		pr_info("cache  (%x) %x\n", bm.dram_cache_conf, temp);
+		bm_register_read(bm.dram_qos_conf, 0, 1, &temp);
+		pr_info("qos    (%x) %x\n", bm.dram_qos_conf, temp);
+		/* Init QM GPM pools */
 		qece_base_address.virt_lsb = (u32)dma_alloc_coherent(NULL, qm_num_of_buffers*4, &qece_base_address.dma_lsb, GFP_KERNEL);
 		pl_base_address.virt_lsb   = (u32)dma_alloc_coherent(NULL, qm_num_of_buffers*4, &pl_base_address.dma_lsb, GFP_KERNEL);
 		rc = bm_qm_gpm_pools_def_quick_init(qm_num_of_buffers, &qece_base_address, &pl_base_address);
@@ -237,28 +238,38 @@ static ssize_t mv_bm_config(struct device *dev,
 			pr_err("qm gpm pool quick init failed\n");
 			return -1;
 		}
-		completed = fill_level = 0xFFFFFFFF;
-		rc = bm_pool_quick_init_status_get(0, &completed);
-		rc = bm_pool_fill_level_get(0, &fill_level);
-
-		pr_info("0 - (%x) = %d\n", qece_base_address.virt_lsb, *(u32 *)(qece_base_address.virt_lsb));
-		pr_info("1 - (%x) = %d\n", qece_base_address.virt_lsb+1*sizeof(u32), *(u32 *)(qece_base_address.virt_lsb));
-		pr_info("100 - (%x) = %d\n", qece_base_address.virt_lsb+100*sizeof(u32), *(u32 *)(qece_base_address.virt_lsb+100*sizeof(u32)));
-		pr_info("200 - (%x) = %d\n", qece_base_address.virt_lsb+200*sizeof(u32), *(u32 *)(qece_base_address.virt_lsb+200*sizeof(u32)));
-		pr_info("5000 - (%x) = %d\n", qece_base_address.virt_lsb+5000*sizeof(u32), *(u32 *)(qece_base_address.virt_lsb+5000*sizeof(u32)));
-		pr_info("5103 - (%x) = %d\n", qece_base_address.virt_lsb+5103*sizeof(u32), *(u32 *)(qece_base_address.virt_lsb+5103*sizeof(u32)));
-		pr_info("5104 - (%x) = %d\n", qece_base_address.virt_lsb+5104*sizeof(u32), *(u32 *)(qece_base_address.virt_lsb+5104*sizeof(u32)));
-
-		if (qm_num_of_buffers * 4 != fill_level)
-			pr_info("pool 0 fill level is different than number of buffers\n");
-		pr_info("\t pool 0 completed quick init= %d fill level %d Bytes\n", completed, fill_level);
-		completed = fill_level = 0xFFFFFFFF;
-		rc = bm_pool_quick_init_status_get(1, &completed);
-		rc = bm_pool_fill_level_get(1, &fill_level);
-		if (qm_num_of_buffers * 4 != fill_level)
-			pr_info("pool 0 fill level is different than configured value\n");
-		pr_info("\t pool 1 completed quick init= %d fill level %d Bytes\n", completed, fill_level);
-
+		for (pool_index = 0; pool_index <= 1; pool_index++) {
+			completed = fill_level = 0xFFFFFFFF;
+			rc = bm_pool_quick_init_status_get(pool_index, &completed);
+			if (completed != BM_POOL_INIT_COMPLETED) {
+				pr_err("qm gpm pool %d didn't complete quick init\n", pool_index);
+				return -1;
+			}
+			if (pool_index == 0)
+				temp_ptr = (u32 *)pl_base_address.virt_lsb;
+			else
+				temp_ptr = (u32 *)qece_base_address.virt_lsb;
+			for (i = 0; i < qm_num_of_buffers; i++)	{
+				if (*temp_ptr != i+1) {
+					pr_err("wrong value in pool item %d addr %x value is %d\n", i, (u32)temp_ptr, *temp_ptr);
+					return -1;
+				}
+				temp_ptr++;
+			}
+
+			bm_pool_enabled_get(pool_index, &enabled, &quick_init);
+			pr_info("pool %d pool is enabled %d quick init mode %d\n", pool_index, enabled, quick_init);
+			bm_pool_status_get(pool_index, &ne, &ae, &af);
+			pr_info("pool %d cache nempty %d dram ae %d dram af %d\n", pool_index, ne, ae, af);
+			bm_pool_pointer_get(pool_index, &rd_ptr, &wr_ptr);
+			pr_info("pool %d read pointer %d write pointer %d\n", pool_index, rd_ptr, wr_ptr);
+			rc = bm_register_read(bm.dpr_c_mng_stat[0], bm_reg_offset.dpr_c_mng_stat[0] * pool_index, bm_reg_size.dpr_c_mng_stat[0], (u32 *)&cache);
+			pr_info("pool %d cache start %d end %d Bytes %d\n", pool_index, cache.cache_start, cache.cache_end,
+				((cache.cache_end - cache.cache_start + 1) * 64));
+			rc = bm_pool_fill_level_get(pool_index, &fill_level);
+			pr_info("\t pool %d completed quick init = %d fill level %d Bytes\n", pool_index, completed, fill_level);
+		}
+		/* Enable BM unit */
 		rc = bm_enable();
 		if (rc != OK) {
 			pr_err("bm unit enable failed\n");
@@ -267,6 +278,7 @@ static ssize_t mv_bm_config(struct device *dev,
 		bm_enable_status_get(&status);
 		pr_info("bm unit status is %d\n", status);
 		base_address.virt_lsb = (u32)dma_alloc_coherent(NULL, gp_num_of_buffers*4, &base_address.dma_lsb, GFP_KERNEL);
+		/* Init GP pool */
 		rc = bm_gp_pool_def_basic_init(pool, gp_num_of_buffers, &base_address, partition_model, pool_pair);
 		if (rc != OK) {
 			pr_err("bm gp pool %d basic init failed\n", pool);
@@ -274,16 +286,20 @@ static ssize_t mv_bm_config(struct device *dev,
 		}
 		rc = bm_pool_quick_init_status_get(pool, &completed);
 		rc = bm_pool_fill_level_get(pool, &fill_level);
-		pr_info("\t pool %d completed quick init= %d fill level %d Bytes\n", pool, completed, fill_level);
+		pr_info("\t pool %d fill level %d Bytes\n", completed, fill_level);
 
 		bm_idle_status_get(&status);
 		pr_info("bm unit idle status is %s\n", ((status == BM_STATUS_IS_IDLE) ? "IDLE" : "BUSY"));
-		bm_pool_status_get(pool, &pool_nempty, &dpool_ae, &dpool_af);
-		pr_info("pool %d cache nempty %d dram ae %d dram af %d\n", pool, pool_nempty, dpool_ae, dpool_af);
-		bm_pool_status_get(0, &pool_nempty, &dpool_ae, &dpool_af);
-		pr_info("pool %d cache nempty %d dram ae %d dram af %d\n", 0, pool_nempty, dpool_ae, dpool_af);
-		bm_pool_status_get(1, &pool_nempty, &dpool_ae, &dpool_af);
-		pr_info("pool %d cache nempty %d dram ae %d dram af %d\n", 1, pool_nempty, dpool_ae, dpool_af);
+		bm_pool_status_get(pool, &ne, &ae, &af);
+		pr_info("pool %d cache nempty %d dram ae %d dram af %d\n", pool, ne, ae, af);
+		bm_pool_pointer_get(pool, &rd_ptr, &wr_ptr);
+		pr_info("pool %d read pointer %d write pointer %d\n", pool, rd_ptr, wr_ptr);
+
+		bm_bank_inter_get(0, &ne, &ae, &af);
+		pr_info("bank 0 ne %x ae %x af %x\n", ne, ae, af);
+
+		bm_bank_inter_get(1, &ne, &ae, &af);
+		pr_info("bank 1 ne %x ae %x af %x\n", ne, ae, af);
 
 	} else if (!strcmp(name, "attr_all_pools_def_set")) {
 		PR_INFO_CALLED
@@ -500,41 +516,6 @@ static ssize_t mv_bm_config(struct device *dev,
 		rc = bm_gp_pool_quick_init(pool, num_of_buffers, fill_level, &base_address, pe_size, pool_pair, ae_thr, af_thr, cache_vmid, cache_attr, cache_so_thr, cache_si_thr, cache_num_of_buffers);
 		if (rc != OK)
 			PR_ERR_CODE(rc)
-	} else if (!strcmp(name, "global_registers_dump")) {
-		PR_INFO_CALLED
-		rc = bm_global_registers_dump();
-		if (rc != OK)
-			PR_ERR_CODE(rc)
-	} else if (!strcmp(name, "pool_registers_dump")) {
-		u32 pool;
-
-		/* Read input values */
-		PR_INFO_CALLED
-		pool = 0xFFFFFFFF;
-		sscanf(buf, "%d", &pool);
-		rc = bm_pool_registers_dump(pool);
-		if (rc != OK)
-			PR_ERR_CODE(rc)
-	} else if (!strcmp(name, "bank_registers_dump")) {
-		u32 bank;
-
-		/* Read input values */
-		PR_INFO_CALLED
-		bank = 0xFFFFFFFF;
-		sscanf(buf, "%d", &bank);
-		rc = bm_bank_registers_dump(bank);
-		if (rc != OK)
-			PR_ERR_CODE(rc)
-	} else if (!strcmp(name, "cache_memory_dump")) {
-		u32 bank;
-
-		/* Read input values */
-		PR_INFO_CALLED
-		bank = 0xFFFFFFFF;
-		sscanf(buf, "%d", &bank);
-		rc = bm_cache_memory_dump(bank);
-		if (rc != OK)
-			pr_err("%s: illegal operation in function <%s>, error code = 0x%08X\n", __func__, attr->attr.name, rc);
 	} else if (!strcmp(name, "idle_status_get")) {
 		u32 status;
 
@@ -557,16 +538,6 @@ static ssize_t mv_bm_config(struct device *dev,
 			PR_ERR_CODE(rc)
 		else
 			pr_info("pool %d nempty %d ae %d af %d\n", pool, pool_nempty, dpool_ae, dpool_af);
-	} else if (!strcmp(name, "idle_debug")) {
-		PR_INFO_CALLED
-		rc = bm_idle_debug();
-		if (rc != OK)
-			PR_ERR_CODE(rc)
-	} else if (!strcmp(name, "error_dump")) {
-		PR_INFO_CALLED
-		rc = bm_error_dump();
-		if (rc != OK)
-			PR_ERR_CODE(rc)
 	} else if (!strcmp(name, "pool_memory_fill")) {
 		u32 pool,  num_of_buffers;
 		struct mv_a40 base_address;
@@ -693,8 +664,8 @@ static ssize_t mv_bm_config(struct device *dev,
 	return err ? -EINVAL : len;
 }
 
-static DEVICE_ATTR(help,                            S_IRUSR, mv_bm_show, NULL);
-static DEVICE_ATTR(status,                          S_IRUSR, mv_bm_show, NULL);
+static DEVICE_ATTR(help,                         S_IRUSR, mv_bm_show, NULL);
+static DEVICE_ATTR(status,                       S_IRUSR, mv_bm_show, NULL);
 static DEVICE_ATTR(open,                         S_IWUSR, NULL,       mv_bm_config);
 static DEVICE_ATTR(test,                         S_IWUSR, NULL,       mv_bm_config);
 static DEVICE_ATTR(attr_all_pools_def_set,       S_IWUSR, NULL,       mv_bm_config);
@@ -714,14 +685,8 @@ static DEVICE_ATTR(pool_fill_level_get,          S_IWUSR, NULL,       mv_bm_conf
 static DEVICE_ATTR(vmid_set,                     S_IWUSR, NULL,       mv_bm_config);
 static DEVICE_ATTR(gp_pool_def_quick_init,       S_IWUSR, NULL,       mv_bm_config);
 static DEVICE_ATTR(gp_pool_quick_init,           S_IWUSR, NULL,       mv_bm_config);
-static DEVICE_ATTR(global_registers_dump,        S_IWUSR, NULL,       mv_bm_config);
-static DEVICE_ATTR(pool_registers_dump,          S_IWUSR, NULL,       mv_bm_config);
-static DEVICE_ATTR(bank_registers_dump,          S_IWUSR, NULL,       mv_bm_config);
-static DEVICE_ATTR(cache_memory_dump,            S_IWUSR, NULL,       mv_bm_config);
 static DEVICE_ATTR(idle_status_get,              S_IWUSR, NULL,       mv_bm_config);
 static DEVICE_ATTR(pool_status_get,              S_IWUSR, NULL,       mv_bm_config);
-static DEVICE_ATTR(idle_debug,                   S_IWUSR, NULL,       mv_bm_config);
-static DEVICE_ATTR(error_dump,                   S_IWUSR, NULL,       mv_bm_config);
 static DEVICE_ATTR(pool_memory_fill,             S_IWUSR, NULL,       mv_bm_config);
 static DEVICE_ATTR(pool_dram_set,                S_IWUSR, NULL,       mv_bm_config);
 static DEVICE_ATTR(pool_fill_level_set,          S_IWUSR, NULL,       mv_bm_config);
@@ -730,12 +695,7 @@ static DEVICE_ATTR(gp_pool_pe_size_set,          S_IWUSR, NULL,       mv_bm_conf
 static DEVICE_ATTR(gp_pool_pair_set,             S_IWUSR, NULL,       mv_bm_config);
 static DEVICE_ATTR(pool_cache_set,               S_IWUSR, NULL,       mv_bm_config);
 static DEVICE_ATTR(pool_disable,                 S_IWUSR, NULL,       mv_bm_config);
-/*
-static DEVICE_ATTR(qm_gpm_init,                     S_IWUSR, NULL,       mv_bm_config);
-static DEVICE_ATTR(qm_dram_init,                    S_IWUSR, NULL,       mv_bm_config);
-*/
-static DEVICE_ATTR(bm_register_read,                S_IWUSR, NULL,       mv_bm_config);
-static DEVICE_ATTR(bm_register_write,               S_IWUSR, NULL,       mv_bm_config);
+
 
 
 static struct attribute *mv_bm_attrs[] = {
@@ -760,14 +720,8 @@ static struct attribute *mv_bm_attrs[] = {
 	&dev_attr_vmid_set.attr,
 	&dev_attr_gp_pool_def_quick_init.attr,
 	&dev_attr_gp_pool_quick_init.attr,
-	&dev_attr_global_registers_dump.attr,
-	&dev_attr_pool_registers_dump.attr,
-	&dev_attr_bank_registers_dump.attr,
-	&dev_attr_cache_memory_dump.attr,
 	&dev_attr_idle_status_get.attr,
 	&dev_attr_pool_status_get.attr,
-	&dev_attr_idle_debug.attr,
-	&dev_attr_error_dump.attr,
 	&dev_attr_pool_memory_fill.attr,
 	&dev_attr_pool_dram_set.attr,
 	&dev_attr_pool_fill_level_set.attr,
@@ -776,31 +730,212 @@ static struct attribute *mv_bm_attrs[] = {
 	&dev_attr_gp_pool_pair_set.attr,
 	&dev_attr_pool_cache_set.attr,
 	&dev_attr_pool_disable.attr,
-/*
-	&dev_attr_qm_gpm_init.attr,
-	&dev_attr_qm_dram_init.attr,
-*/
-	&dev_attr_bm_register_read.attr,
-	&dev_attr_bm_register_write.attr,
+
 	NULL
 };
 
-
 static struct attribute_group mv_bm_group = {
-	.name = "bm",
 	.attrs = mv_bm_attrs,
 };
 
+static ssize_t mv_bm_debug_help(char *b)
+{
+	int o = 0; /* buffer offset */
+	int s = PAGE_SIZE; /* buffer size */
+
+
+	o += scnprintf(b+o, s-o, "echo      > global_registers_dump        - Print global registers\n");
+	o += scnprintf(b+o, s-o, "echo  p   > pool_registers_dump          - Print all BM pool registers\n");
+	o += scnprintf(b+o, s-o, "echo  b   > bank_registers_dump          - Print all BM bank registers\n");
+	o += scnprintf(b+o, s-o, "echo  b   > cache_memory_dump            - Print 512 cache lines per in bank\n");
+	o += scnprintf(b+o, s-o, "echo      > idle_debug                   - Print busy indication registers\n");
+	o += scnprintf(b+o, s-o, "echo      > error_dump                   - Print busy reason registers\n");
+	o += scnprintf(b+o, s-o, "echo ba, ofs, wN > register_read   - Read register from BM units\n");
+	o += scnprintf(b+o, s-o, "echo ba, ofs, d  > register_write  - Write one word in BM units\n");
+
+
+	o += scnprintf(b+o, s-o, "parameters: [p]    pool\n");
+	o += scnprintf(b+o, s-o, "            [b]    bank\n");
+	o += scnprintf(b+o, s-o, "            [ba]   base address\n");
+	o += scnprintf(b+o, s-o, "            [ofs]  offset\n");
+	o += scnprintf(b+o, s-o, "            [wN]   word number\n");
+	o += scnprintf(b+o, s-o, "            [d]    data\n");
+	o += scnprintf(b+o, s-o, "\n");
+
+	return o;
+}
+
+static ssize_t mv_bm_debug_show(struct device *dev,
+				  struct device_attribute *attr, char *buf)
+{
+	const char      *name = attr->attr.name;
+	int             off = 0;
+
+	if (!capable(CAP_NET_ADMIN))
+		return -EPERM;
+
+	if (!strcmp(name, "help_debug")) {
+		off = mv_bm_debug_help(buf);
+	} else if (!strcmp(name, "help")) {
+		off = mv_bm_debug_help(buf);
+	} else {
+		off = 1;
+		pr_err("%s: illegal operation <%s>\n", __func__, attr->attr.name);
+	}
+
+	return off;
+}
+
+static ssize_t mv_bm_debug_config(struct device *dev,
+				   struct device_attribute *attr, const char *buf, size_t len)
+{
+	const char      *name = attr->attr.name;
+	int rc = -BM_INPUT_NOT_IN_RANGE;
+	int             err = 0;
+/*
+	u32 flags;
+*/
+	unsigned long flags;
+
+	if (!capable(CAP_NET_ADMIN))
+		return -EPERM;
+
+	local_irq_save(flags);
+
+	if (!strcmp(name, "global_registers_dump")) {
+		PR_INFO_CALLED
+		rc = bm_global_registers_dump();
+		if (rc != OK)
+			PR_ERR_CODE(rc)
+	} else if (!strcmp(name, "pool_registers_dump")) {
+		u32 pool;
+
+		/* Read input values */
+		PR_INFO_CALLED
+		pool = 0xFFFFFFFF;
+		sscanf(buf, "%d", &pool);
+		rc = bm_pool_registers_dump(pool);
+		if (rc != OK)
+			PR_ERR_CODE(rc)
+	} else if (!strcmp(name, "bank_registers_dump")) {
+		u32 bank;
+
+		/* Read input values */
+		PR_INFO_CALLED
+		bank = 0xFFFFFFFF;
+		sscanf(buf, "%d", &bank);
+		rc = bm_bank_registers_dump(bank);
+		if (rc != OK)
+			PR_ERR_CODE(rc)
+	} else if (!strcmp(name, "cache_memory_dump")) {
+		u32 bank;
+
+		/* Read input values */
+		PR_INFO_CALLED
+		bank = 0xFFFFFFFF;
+		sscanf(buf, "%d", &bank);
+		rc = bm_cache_memory_dump(bank);
+		if (rc != OK)
+			pr_err("%s: illegal operation in function <%s>, error code = 0x%08X\n", __func__, attr->attr.name, rc);
+	} else if (!strcmp(name, "idle_debug")) {
+		PR_INFO_CALLED
+		rc = bm_idle_debug();
+		if (rc != OK)
+			PR_ERR_CODE(rc)
+	} else if (!strcmp(name, "error_dump")) {
+		PR_INFO_CALLED
+		rc = bm_error_dump();
+		if (rc != OK)
+			PR_ERR_CODE(rc)
+/*not used*/
+	} else if (!strcmp(name, "register_read")) {
+		u32 base_address, offset, wordsNumber, dataPtr, i;
+		u32 sili_base = mv_hw_silicon_base_addr_get();
+
+		PR_INFO_CALLED
+		base_address = offset = wordsNumber = dataPtr = 0xFFFFFFFF;
+		/* Read input values */
+		sscanf(buf, "%x %x %x", &base_address, &offset, &wordsNumber);
+		for (i = 0; i < wordsNumber; i++) {
+			rc = bm_register_read(sili_base+base_address+i*sizeof(u32), offset, wordsNumber, &dataPtr);
+			if (rc != OK)
+				PR_ERR_CODE(rc)
+			pr_info("%x %x", sili_base+base_address+i*sizeof(u32), dataPtr);
+		}
+	} else if (!strcmp(name, "register_write")) {
+		u32 base_address, offset, dataPtr;
+		u32 sili_base = mv_hw_silicon_base_addr_get();
+
+		PR_INFO_CALLED
+		base_address = offset = dataPtr = 0xFFFFFFFF;
+		/* Read input values */
+		sscanf(buf, "%x %x %x", &base_address, &offset, &dataPtr);
+		rc = bm_register_write(sili_base+base_address, offset, 1, &dataPtr);
+		if (rc != OK)
+			PR_ERR_CODE(rc)
+	} else {
+		err = 1;
+		pr_err("%s: wrong name of BM function <%s>\n", __func__, attr->attr.name);
+	}
+
+	local_irq_restore(flags);
+
+	return err ? -EINVAL : len;
+}
+
+static DEVICE_ATTR(help_debug,                   S_IRUSR, mv_bm_debug_show, NULL);
+static DEVICE_ATTR(global_registers_dump,        S_IWUSR, NULL,       mv_bm_debug_config);
+static DEVICE_ATTR(pool_registers_dump,          S_IWUSR, NULL,       mv_bm_config);
+static DEVICE_ATTR(bank_registers_dump,          S_IWUSR, NULL,       mv_bm_config);
+static DEVICE_ATTR(cache_memory_dump,            S_IWUSR, NULL,       mv_bm_config);
+static DEVICE_ATTR(idle_debug,                   S_IWUSR, NULL,       mv_bm_config);
+static DEVICE_ATTR(error_dump,                   S_IWUSR, NULL,       mv_bm_config);
+static DEVICE_ATTR(register_read,                S_IWUSR, NULL,       mv_bm_config);
+static DEVICE_ATTR(register_write,               S_IWUSR, NULL,       mv_bm_config);
+
+
+static struct attribute *mv_bm_debug_attrs[] = {
+	&dev_attr_help_debug.attr,
+	&dev_attr_global_registers_dump.attr,
+	&dev_attr_pool_registers_dump.attr,
+	&dev_attr_bank_registers_dump.attr,
+	&dev_attr_cache_memory_dump.attr,
+	&dev_attr_idle_debug.attr,
+	&dev_attr_error_dump.attr,
+	&dev_attr_register_read.attr,
+	&dev_attr_register_write.attr,
+	NULL
+};
+
+static struct attribute_group mv_bm_debug_group = {
+	.name = "debug",
+	.attrs = mv_bm_debug_attrs,
+};
+
 int mv_pp3_bm_sysfs_init(struct kobject *neta_kobj)
 {
 	int err;
+	struct kobject *bm_kobj;
+
+
+	bm_kobj = kobject_create_and_add("bm", neta_kobj);
+	if (!bm_kobj) {
+		printk(KERN_ERR"%s: cannot create bm kobject\n", __func__);
+		return -ENOMEM;
+	}
 
-	err = sysfs_create_group(neta_kobj, &mv_bm_group);
+	err = sysfs_create_group(bm_kobj, &mv_bm_group);
 	if (err) {
 		pr_err(KERN_INFO "sysfs group failed for bm%d\n", err);
 		return err;
 	}
 
+	err = sysfs_create_group(bm_kobj, &mv_bm_debug_group);
+	if (err) {
+		pr_err(KERN_INFO "sysfs group failed for bm debug%d\n", err);
+		return err;
+	}
+
 	return err;
 }
 
@@ -811,61 +946,3 @@ int mv_pp3_bm_sysfs_exit(struct kobject *emac_kobj)
 }
 
 
-/*
-Examples for running the functions above.
-
-1.	Set BM attributes
-		bm_attr_all_pools_def_set();
-2.	Init QM GPM pools (function ýbm_qm_gpm_pools_def_quick_init)
-		bm_qm_gpm_pools_def_quick_init( num_of_buffers,
-				qece_base_address_hi, qece_base_address_lo,
-					pl_base_address_hi, pl_base_address_lo);
-3.	Optional: Init QM DRAM pools (function )
-		bm_qm_dram_pools_def_quick_init(num_of_buffers,
-				qece_base_address_hi, qece_base_address_lo,
-					pl_base_address_hi, pl_base_address_lo);
-4.	Init GP purpose pool  - at least one (function bm_gp_pool_def_basic_init  or ýbm_gp_pool_def_quick_init )
-		bm_gp_pool_def_basic_init(pool, num_of_buffers, base_address_hi, base_address_lo, partition_model);
-		bm_gp_pool_def_quick_init(pool, num_of_buffers, fill_level, base_address_hi, base_address_lo, partition_model);
-5.	Enable BM (function bm_enable)
-		bm_enable();
-
-++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-echo > bm_open
-echo > bm_attr_all_pools_def_set
-echo > bm_attr_qm_pool_set 2 1 11 14 2 1
-echo > bm_attr_gp_pool_set 2 1 11 14 2 1
-echo > bm_enable_status_get
-echo > bm_qm_gpm_pools_def_quick_init  266
-echo > bm_qm_dram_pools_def_quick_init  416
-echo > bm_qm_gpm_pools_quick_init 416 16 32 30 59 16 15 16
-echo > bm_qm_dram_pools_quick_init 416 16 32 30 59 16 15 16
-echo > bm_pool_quick_init_status_get 0
-echo > bm_gp_pool_def_basic_init 10 416 1
-echo > bm_gp_pool_basic_init 10 16 1 1 0 16
-echo > bm_enable
-echo > bm_disable
-echo > bm_pool_fill_level_get 3
-echo > bm_vmid_set 11
-echo > bm_gp_pool_def_quick_init 10 416 256 1
-echo > bm_gp_pool_quick_init 10 416 256 1 1
-echo > bm_global_registers_dump
-echo > bm_pool_registers_dump 10
-echo > bm_bank_registers_dump 3
-echo > bm_cache_memory_dump 3
-echo > bm_idle_status_get
-echo > bm_pool_status_get 0 1 2 3
-echo > bm_idle_debug
-echo > bm_error_dump
-echo > bm_pool_memory_fill 0 16
-echo > bm_pool_dram_set 0 16 0 16
-echo > bm_pool_fill_level_set 0 16 1 1
-echo > bm_pool_enable 0 1
-echo > bm_gp_pool_pe_size_set 20 1
-echo > bm_gp_pool_pair_set 30 1
-echo > bm_pool_cache_set 0 10 16777216 16777316 50 16
-echo > bm_pool_disable 0
-
-
-
-*/
-- 
1.7.5.4

