From 2ea2efd204cb196aa177ac16d1525b4ad6a3e624 Mon Sep 17 00:00:00 2001
From: Eli Nidam <elini@marvell.com>
Date: Wed, 8 Jan 2014 16:14:12 +0200
Subject: [PATCH 1277/1825] fix: pci-e: a38x: Fixed pci-e configuration for RD
 and DB module

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 2533dc24a8736f9906e6cf57fccfeab3d36eef2d

	1. Update SERDES configuration for pci-e 1/2/3 interfaces
	2. Add macro for target pci-e interfaces 2,3
	3. Fix pci-e windows attribute for interface 2,3.
	4. Fixed mvCpuIfPexRemap valid target for pci-e 2 & 3 interface

Change-Id: I8eed65673764e12d3b99abb565bf9a65f5942bb4
Signed-off-by: Eli Nidam <elini@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5055
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.h       |    6 +++---
 .../armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h      |    4 ++++
 .../armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h      |    8 ++++----
 .../armada_38x_family/ctrlEnv/sys/mvCpuIf.c        |   15 ++++-----------
 4 files changed, 15 insertions(+), 18 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
index 5f0acc2..d6f7414 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
@@ -158,11 +158,11 @@ typedef enum {
 #define SERDES_CFG {	\
 /* Lane 0 */ {SERDES_UNIT_NA,		SERDES_UNIT_PEX | PEX0_IF, SERDES_UNIT_SATA | 0,	SERDES_UNIT_GBE  | 0,\
 	      SERDES_UNIT_NA,		SERDES_UNIT_NA,		    SERDES_UNIT_NA,		SERDES_UNIT_NA},     \
-/* Lane 1 */ {SERDES_UNIT_NA,		SERDES_UNIT_PEX | PEX0_IF, SERDES_UNIT_NA,		SERDES_UNIT_SATA | 0,\
+/* Lane 1 */ {SERDES_UNIT_NA,		SERDES_UNIT_PEX | PEX0_IF, SERDES_UNIT_PEX | PEX1_IF,	SERDES_UNIT_SATA | 0,\
 	      SERDES_UNIT_GBE | 0,	SERDES_UNIT_GBE | 1,	    SERDES_UNIT_NA,		SERDES_UNIT_NA},     \
-/* Lane 2 */ {SERDES_UNIT_NA,		SERDES_UNIT_PEX | PEX1_IF, SERDES_UNIT_NA,		SERDES_UNIT_SATA | 1,\
+/* Lane 2 */ {SERDES_UNIT_NA,		SERDES_UNIT_PEX | PEX1_IF, SERDES_UNIT_PEX | PEX2_IF,	SERDES_UNIT_SATA | 1,\
 	      SERDES_UNIT_GBE | 1,	SERDES_UNIT_NA,		    SERDES_UNIT_NA,		SERDES_UNIT_NA},     \
-/* Lane 3 */ {SERDES_UNIT_NA,		SERDES_UNIT_PEX | PEX3_IF, SERDES_UNIT_NA,		SERDES_UNIT_SATA | 3,\
+/* Lane 3 */ {SERDES_UNIT_NA,		SERDES_UNIT_PEX | PEX3_IF, SERDES_UNIT_PEX | PEX3_IF,	SERDES_UNIT_SATA | 3,\
 	      SERDES_UNIT_GBE | 2,	SERDES_UNIT_USB_H | 1,	    SERDES_UNIT_USB,		SERDES_UNIT_NA},     \
 /* Lane 4 */ {SERDES_UNIT_NA,		SERDES_UNIT_PEX | PEX1_IF, SERDES_UNIT_SATA | 1,	SERDES_UNIT_GBE  | 1,\
 	      SERDES_UNIT_USB_H | 0,	SERDES_UNIT_USB,	    SERDES_UNIT_NA,		SERDES_UNIT_NA},     \
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
index ccb8a0d..f1d8aad 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
@@ -352,6 +352,10 @@ typedef struct {
 	((target >= PEX0_MEM) && (target <= PEX0_IO))
 #define MV_TARGET_IS_PEX1(target)   \
 	((target >= PEX1_MEM) && (target <= PEX1_IO))
+#define MV_TARGET_IS_PEX2(target)   \
+		((target >= PEX2_MEM) && (target <= PEX2_IO))
+#define MV_TARGET_IS_PEX3(target)   \
+		((target >= PEX3_MEM) && (target <= PEX3_IO))
 
 #define MV_TARGET_IS_PEX(target)        ((target >= PEX0_MEM) && (target <= PEX1_IO))
 
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
index 6b0a935..a769729 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -368,10 +368,10 @@ typedef enum _mvTarget {
 	{ 0xE0, PEX_TARGET_ID_0	},		/* PEX0_IO               */ \
 	{ 0xE8, PEX_TARGET_ID_123 },		/* PEX1_MEM              */ \
 	{ 0xE0, PEX_TARGET_ID_123 },		/* PEX1_IO               */ \
-	{ 0xB8, PEX_TARGET_ID_123 },		/* PEX2_MEM              */ \
-	{ 0xB0, PEX_TARGET_ID_123 },		/* PEX2_IO               */ \
-	{ 0x78, PEX_TARGET_ID_123 },		/* PEX3_MEM              */ \
-	{ 0x70, PEX_TARGET_ID_123 },		/* PEX3_IO               */ \
+	{ 0xD8, PEX_TARGET_ID_123 },		/* PEX2_MEM              */ \
+	{ 0xD0, PEX_TARGET_ID_123 },		/* PEX2_IO               */ \
+	{ 0xB8, PEX_TARGET_ID_123 },		/* PEX3_MEM              */ \
+	{ 0xB0, PEX_TARGET_ID_123 },		/* PEX3_IO               */ \
 	{ 0xFF, 0xFF		},		/* INTER_REGS            */ \
 	{ 0x01, DEV_TARGET_ID	},		/* DMA_UART              */ \
 	{ 0x1E, DEV_TARGET_ID	},		/* SPI0_CS0              */ \
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/sys/mvCpuIf.c b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/sys/mvCpuIf.c
index 3898bc4..8afee2b 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/sys/mvCpuIf.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/sys/mvCpuIf.c
@@ -725,17 +725,10 @@ MV_U32 mvCpuIfPexRemap(MV_TARGET pexTarget, MV_ADDR_WIN *pAddrDecWin)
 	MV_U32 winNum;
 
 	/* Check parameters */
-	if (mvCtrlPexMaxIfGet() > 1) {
-		if ((!MV_TARGET_IS_PEX0(pexTarget)) &&
-			(!MV_TARGET_IS_PEX1(pexTarget))) {
-			mvOsPrintf("mvCpuIfPexRemap: target %d is illegal\n", pexTarget);
-			return 0xffffffff;
-		}
-	} else {
-		if (!MV_TARGET_IS_PEX0(pexTarget)) {
-			mvOsPrintf("mvCpuIfPexRemap: target %d is illegal\n", pexTarget);
-			return 0xffffffff;
-		}
+	if ((!MV_TARGET_IS_PEX0(pexTarget)) && (!MV_TARGET_IS_PEX1(pexTarget)) &&
+	    (!MV_TARGET_IS_PEX2(pexTarget)) && (!MV_TARGET_IS_PEX3(pexTarget))) {
+		mvOsPrintf("mvCpuIfPexRemap: target %d is illegal\n", pexTarget);
+		return 0xffffffff;
 	}
 
 	/* get the Window number associated with this target */
-- 
1.7.5.4

