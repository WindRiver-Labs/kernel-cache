From 971c9ab20b978e092e21a49beac92a320ded8b54 Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Mon, 15 Jul 2013 10:42:59 +0300
Subject: [PATCH 0834/1825] alp: xor: enable 2 XOR engine (4 channels in
 total)

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 1b1ff8786d8ce70eefc35c44de4fdabb9bd0c11c

	Also enable dmatest utility to be compiled as kernel module.
	Set DMA_MEMCPY capability for all XOR channels.

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: I7e9f5a4ebfb00cc3a19c4e3132ca278858485feb
Reviewed-on: http://vgitil04.il.marvell.com:8080/2650
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Igor Patrik <igorp@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/configs/avanta_lp_defconfig           |    1 +
 arch/arm/mach-avantalp/core.c                  |    7 +++----
 arch/arm/mach-avantalp/include/mach/avantalp.h |    4 ++--
 3 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/arch/arm/configs/avanta_lp_defconfig b/arch/arm/configs/avanta_lp_defconfig
index e7861669..5222add 100644
--- a/arch/arm/configs/avanta_lp_defconfig
+++ b/arch/arm/configs/avanta_lp_defconfig
@@ -134,6 +134,7 @@ CONFIG_NEW_LEDS=y
 CONFIG_RTC_CLASS=y
 CONFIG_DMADEVICES=y
 CONFIG_MV_XOR=y
+CONFIG_DMATEST=m
 CONFIG_EXT2_FS=y
 CONFIG_EXT3_FS=y
 # CONFIG_EXT3_DEFAULTS_TO_ORDERED is not set
diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index bd474ea..5cb8930 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -1140,7 +1140,6 @@ static struct platform_device alp_xor11_channel = {
 	},
 };
 
-#if 0
 static void __init alp_xor1_init(void)
 {
 	if (mvUnitMapIsMine(XOR1) != MV_TRUE)
@@ -1153,6 +1152,7 @@ static void __init alp_xor1_init(void)
 	 * satisfied by removing memset support from one of the engines.
 	 */
 	dma_cap_set(DMA_XOR, alp_xor10_data.cap_mask);
+	dma_cap_set(DMA_MEMCPY, alp_xor10_data.cap_mask);
 	platform_device_register(&alp_xor10_channel);
 
 	dma_cap_set(DMA_MEMCPY, alp_xor11_data.cap_mask);
@@ -1160,13 +1160,12 @@ static void __init alp_xor1_init(void)
 	platform_device_register(&alp_xor11_channel);
 }
 #endif
-#endif
 
 static void __init alp_xor_init(void)
 {
 #ifdef CONFIG_MV_INCLUDE_XOR
 	alp_xor0_init();
-	/* alp_xor1_init(); */
+	alp_xor1_init();
 #endif
 }
 
@@ -1440,6 +1439,7 @@ static void __init alp_board_init(void)
 	alp_eth_init();
 	alp_spi_init();
 	alp_usb_init();
+	alp_xor_init();
 
 #if 0
 	alp_gpio_init();
@@ -1447,7 +1447,6 @@ static void __init alp_board_init(void)
 	alp_sata_init();
 	alp_nand_nfc_init();
 	alp_hwmon_init();
-	alp_xor_init();
 	alp_i2c_init();
 	alp_sdio_init();
 #endif
diff --git a/arch/arm/mach-avantalp/include/mach/avantalp.h b/arch/arm/mach-avantalp/include/mach/avantalp.h
index 1c7473e..37802cd 100644
--- a/arch/arm/mach-avantalp/include/mach/avantalp.h
+++ b/arch/arm/mach-avantalp/include/mach/avantalp.h
@@ -63,9 +63,9 @@
 #define CRYPT_ENG_SIZE			_64K
 
 #define XOR0_PHYS_BASE			(INTER_REGS_PHYS_BASE | 0x60800)
-#define XOR1_PHYS_BASE			(INTER_REGS_PHYS_BASE | 0xF0900)
+#define XOR1_PHYS_BASE			(INTER_REGS_PHYS_BASE | 0x60900)
 #define XOR0_HIGH_PHYS_BASE		(INTER_REGS_PHYS_BASE | 0x60A00)
-#define XOR1_HIGH_PHYS_BASE		(INTER_REGS_PHYS_BASE | 0xF0B00)
+#define XOR1_HIGH_PHYS_BASE		(INTER_REGS_PHYS_BASE | 0x60B00)
 
 #define PP2_CPU0_PHYS_BASE		0xF4500000
 #define PP2_CPU1_PHYS_BASE		0xF4510000
-- 
1.7.5.4

