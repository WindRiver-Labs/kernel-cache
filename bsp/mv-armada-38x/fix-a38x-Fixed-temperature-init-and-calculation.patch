From 3c4542affb06fc891cc88e5bb4bbaba10a62cf58 Mon Sep 17 00:00:00 2001
From: Eli Nidam <elini@marvell.com>
Date: Mon, 11 Nov 2013 17:25:19 +0200
Subject: [PATCH 1129/1825] fix: a38x: Fixed temperature init and calculation

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 23efe01d4047fee9282a7b938036b58c9984c93b

Change-Id: I36fac1f17dd6de77e70ee47172e0dd1ff6df17a2
Signed-off-by: Eli Nidam <elini@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4290
Reviewed-by: Tawfik Bayouk <tawfik@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.c       |   23 ++++++++-----------
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.h       |    2 +-
 2 files changed, 11 insertions(+), 14 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
index f650cc9..b7f3fa6 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
@@ -379,8 +379,7 @@ MV_STATUS mvCtrlEnvInit(MV_VOID)
 		mvGppPolaritySet(i, gppMask, (MV_GPP_IN_INVERT & gppMask));
 	}
 
-	/*Disabled for kernel compilation*/
-	/*mvEthComplexInit(mvBoardEthComplexConfigGet());*/
+	MV_REG_BIT_SET(TSEN_CONF_REG, BIT8); /* init Tsen */
 
 	/*
 	 * Enable NAND Flash PUP (Pack-Unpack)
@@ -1596,22 +1595,20 @@ MV_BOOL mvCtrlDDRECC(MV_VOID)
 MV_U32 mvCtrlGetJuncTemp(MV_VOID)
 {
 	/*Used Hard Coded values, TODO sync with Spec*/
-	MV_32 reg = 0, temp;
+	MV_32 reg = 0, temp, i;
 
 	/* init the TSEN sensor once */
-	if ((MV_REG_READ(TSEN_STATE_REG) & TSEN_STATE_MASK) == 0) {
-		MV_REG_BIT_RESET(TSEN_STATE_REG, TSEN_STATE_MASK);
-
-		MV_REG_WRITE(TSEN_STATE_REG, 0x8011E214);
-
-		reg = MV_REG_READ(TSEN_CONF_REG);
-
-		reg = 0x00a80909;
-		MV_REG_WRITE(TSEN_CONF_REG, reg);
+	for (i = 0 ; i < 20; i++) {
+		reg = MV_REG_READ(TSEN_STATUS_REG);
+		if (reg & BIT10)
+			break;
 		mvOsDelay(10);
 	}
+	if ((reg & BIT10) == 0) {
+		mvOsPrintf("%s: TSEN not ready\n", __func__);
+		return 0;
+	}
 
-	reg = MV_REG_READ(TSEN_STATUS_REG);
 	reg = (reg & TSEN_STATUS_TEMP_OUT_MASK) >> TSEN_STATUS_TEMP_OUT_OFFSET;
 	temp = (((((10000 * reg) / 21445) * 1000) - 272674) / 1000);
 
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
index 0a82065..ff7c49d 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
@@ -198,7 +198,7 @@ typedef enum {
 
 #define TSEN_STATUS_REG						0xE4078
 #define TSEN_STATUS_TEMP_OUT_OFFSET				0
-#define TSEN_STATUS_TEMP_OUT_MASK				(0x1FF << TSEN_STATUS_TEMP_OUT_OFFSET)
+#define TSEN_STATUS_TEMP_OUT_MASK				(0x3FF << TSEN_STATUS_TEMP_OUT_OFFSET)
 
 
 /* BIOS Modes related defines */
-- 
1.7.5.4

