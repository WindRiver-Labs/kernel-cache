From 31e5f37d207ed16a9e50505d036dc0f1439f8e75 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Tue, 19 Mar 2013 15:02:35 +0200
Subject: [PATCH 0520/1825] Added mvBoardALPEgigaPhyInit - Avanta LP specific
 Phy & Switch init

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit a61b79dfd85ae3eb8018d51d162fdce500603e21

- Added mvEthALPSwitchBasicInit, mvBoardIsInternalSwitchConnected,
	mvBoardSwitchPortForceLinkGet ,mvBoardEthComplexConfigSet/Get

Change-Id: I50cdc47aef294223dfa07f8395cb53600551d81e
Reviewed-on: http://vgitil04.il.marvell.com:8080/1333
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |  107 +++++++++++++++++++-
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    4 +
 2 files changed, 110 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index f554af5..140ebbd 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -786,7 +786,7 @@ MV_VOID mvBoardConfigInit(void)
 	if (mvCtrlConfigGet(MV_CONFIG_PON_SERDES) == 0x0)  /* 0 - PON SerDes connected to PON MAC */
 		ethSataComplexOptions |= MV_ETH_COMPLEX_P2P_MAC_PON_ETH_SERDES;
 
-	board->pBoardModTypeValue->ethSataComplexOpt = ethSataComplexOptions;
+	mvBoardEthComplexConfigSet(ethSataComplexOptions);
 
 	/* MPP Groups initialization : */
 	/* Group 0-1 - Boot device (or if SPI1 boot : Groups 3-4) */
@@ -1060,6 +1060,65 @@ MV_ETH_COMPLEX_TOPOLOGY mvBoardLaneSGMIIGet()
 }
 
 /*******************************************************************************
+* mvBoardIsInternalSwitchConnected
+*
+* DESCRIPTION:
+*       This routine returns port's connection status
+*
+* INPUT:
+*       ethPortNum - Ethernet port number.
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*       1 - if ethPortNum is connected to switch, 0 otherwise
+*
+*******************************************************************************/
+MV_STATUS mvBoardIsInternalSwitchConnected(MV_U32 ethPortNum)
+{
+	MV_U32 ethComplex = mvBoardEthComplexConfigGet();
+
+	if (ethPortNum >= board->numBoardMacInfo) {
+		mvOsPrintf("%s: Error: Illegal port number(%u)\n", __func__, ethPortNum);
+		return MV_FALSE;
+	}
+
+	/* Check if internal switch is connected */
+	if ((ethPortNum == 0) && (ethComplex & MV_ETH_COMPLEX_GE_MAC0_SW_P6))
+		return MV_TRUE;
+	else if ((ethPortNum == 1) && (ethComplex & MV_ETH_COMPLEX_GE_MAC1_SW_P4))
+		return MV_TRUE;
+	else
+		return MV_FALSE;
+}
+
+/*******************************************************************************
+* mvBoardSwitchPortForceLinkGet
+*
+* DESCRIPTION:
+*       Return the switch ports force link bitmask.
+*
+* INPUT:
+*       switchIdx - index of the switch. Only 0 is supported.
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*       the ports bitmask, -1 if the switch is not connected.
+*
+*******************************************************************************/
+MV_U32 mvBoardSwitchPortForceLinkGet(MV_U32 switchIdx)
+{
+
+	if ( board->switchInfoNum == 0 || switchIdx >= board->switchInfoNum )
+		return (MV_U32)MV_ERROR;
+
+	return board->pSwitchInfo[switchIdx].forceLinkMask;
+}
+
+/*******************************************************************************
 * mvBoardConfigWrite - write MPP's config and Board general environment configuration
 *
 * DESCRIPTION:
@@ -1578,6 +1637,52 @@ MV_U8 mvBoardTwsiAddrGet(MV_BOARD_TWSI_CLASS twsiClass, MV_U32 index)
 }
 
 /*******************************************************************************
+* mvBoardEthComplexConfigGet - Return ethernet complex board configuration.
+*
+* DESCRIPTION:
+*	Returns the ethernet / Sata complex configuration from the board spec
+*	structure.
+*
+* INPUT:
+*       None.
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*       32bit value describing the ethernet complex config.
+*
+*******************************************************************************/
+MV_U32 mvBoardEthComplexConfigGet(MV_VOID)
+{
+	return board->pBoardModTypeValue->ethSataComplexOpt;
+}
+
+/*******************************************************************************
+* mvBoardEthComplexConfigSet - Set ethernet complex board configuration.
+*
+* DESCRIPTION:
+*	Sets the ethernet / Sata complex configuration in the board spec
+*	structure.
+*
+* INPUT:
+*       ethConfig - 32bit value describing the ethernet complex config.
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*	None.
+*
+*******************************************************************************/
+MV_VOID mvBoardEthComplexConfigSet(MV_U32 ethConfig)
+{
+	/* Set ethernet complex configuration. */
+	board->pBoardModTypeValue->ethSataComplexOpt = ethConfig;
+	return;
+}
+
+/*******************************************************************************
 * mvBoardSarInfoGet
 *
 * DESCRIPTION:
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index 95b2e71..93c5284 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -447,6 +447,8 @@ MV_U32 boardGetDevCSNum(MV_32 devNum, MV_BOARD_DEV_CLASS devClass);
 MV_U8 mvBoardTwsiAddrTypeGet(MV_BOARD_TWSI_CLASS twsiClass, MV_U32 index);
 MV_U8 mvBoardTwsiAddrGet(MV_BOARD_TWSI_CLASS twsiClass, MV_U32 index);
 MV_32 mvBoardNandWidthGet(void);
+MV_U32 mvBoardEthComplexConfigGet(MV_VOID);
+MV_VOID mvBoardEthComplexConfigSet(MV_U32 ethConfig);
 MV_U32 mvBoardIdGet(MV_VOID);
 MV_U32 mvBoardSledCpuNumGet(MV_VOID);
 MV_VOID mvBoardConfigInit(MV_VOID);
@@ -471,6 +473,8 @@ MV_STATUS mvBoardOtherModulesScan(void);
 MV_BOOL mvBoardIsPexModuleConnected(void);
 MV_BOOL mvBoardIsSetmModuleConnected(void);
 MV_BOOL mvBoardIsSwitchModuleConnected(void);
+MV_STATUS mvBoardIsInternalSwitchConnected(MV_U32 ethPortNum);
+MV_U32 mvBoardSwitchPortForceLinkGet(MV_U32 switchIdx);
 MV_BOOL mvBoardIsLvdsModuleConnected(void);
 MV_BOOL mvBoardIsLcdDviModuleConnected(void);
 MV_BOOL mvBoardIsGMIIModuleConnected(void);
-- 
1.7.5.4

