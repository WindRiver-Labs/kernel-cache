From 81c477b296ff8a9c29ce995dc09c7c3755d8eff6 Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Mon, 11 Mar 2013 16:46:08 +0200
Subject: [PATCH 0482/1825] PPv2: add support for PPv2 network driver

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 1f75854e9e5259de2409120dabe25ea09428339d

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: I1c6cff841bebad7c43610635988d5472d7b4bd73
Reviewed-on: http://vgitil04.il.marvell.com:8080/1251
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   18 +++++++-----------
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    2 +-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   19 +++++++------------
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h        |    3 +--
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |   10 +++-------
 arch/arm/plat-armada/common/mv802_3.h              |    3 +++
 6 files changed, 22 insertions(+), 33 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index d4ce76c..31171a1 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -252,7 +252,7 @@ MV_STATUS mvBoardNameGet(char *pNameBuff)
 MV_BOOL mvBoardIsPortInSgmii(MV_U32 ethPortNum)
 {
 #if defined(CONFIG_MACH_AVANTA_LP_FPGA)
-	return (ethPortNum == 2);
+	return ethPortNum == 2;
 #endif
 
 	return MV_FALSE;
@@ -404,8 +404,10 @@ MV_32 mvBoardPhyLinkCryptPortAddrGet(MV_U32 ethPortNum)
 *******************************************************************************/
 MV_BOARD_MAC_SPEED mvBoardMacSpeedGet(MV_U32 ethPortNum)
 {
-	if (ethPortNum >= board->numBoardMacInfo)
-		return MV_ERROR;
+	if (ethPortNum >= board->numBoardMacInfo) {
+		mvOsPrintf("%s: Error: wrong eth port (%d)\n", __func__, ethPortNum);
+		return BOARD_MAC_SPEED_100M;
+	}
 
 #if defined(CONFIG_MACH_AVANTA_LP_FPGA)
 	return (ethPortNum == 2) ? BOARD_MAC_SPEED_1000M : BOARD_MAC_SPEED_100M;
@@ -415,7 +417,7 @@ MV_BOARD_MAC_SPEED mvBoardMacSpeedGet(MV_U32 ethPortNum)
 }
 
 /*******************************************************************************
-* mvBoardIsPortLb -
+* mvBoardIsPortLoopback -
 *
 * DESCRIPTION:
 *       This routine returns MV_TRUE for loopback port number or MV_FALSE
@@ -432,7 +434,7 @@ MV_BOARD_MAC_SPEED mvBoardMacSpeedGet(MV_U32 ethPortNum)
 *       MV_FALSE - other.
 *
 *******************************************************************************/
-MV_BOOL mvBoardIsPortLb(MV_U32 ethPortNum)
+MV_BOOL mvBoardIsPortLoopback(MV_U32 ethPortNum)
 {
 #if defined(CONFIG_MACH_AVANTA_LP_FPGA)
 	return (ethPortNum == 2);
@@ -2171,9 +2173,3 @@ MV_BOOL mvBoardModuleAutoDetectEnabled(void)
 {
 	return board->moduleAutoDetect;
 }
-
-void setOtherBoardSimulation(MV_U32 ID_of_board)
-{
-	board = boardInfoTbl[ID_of_board];
-	printf("\nSimulationg Board enviroment according to : %s \n", board->boardName);
-}
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index 2c36a3a..d33506c 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -586,7 +586,7 @@ MV_STATUS mvBoardNameGet(char *pNameBuff);
 MV_BOARD_SPEC_INIT *mvBoardSpecInitGet(MV_VOID);
 MV_BOOL mvBoardIsPortInSgmii(MV_U32 ethPortNum);
 MV_BOOL mvBoardIsPortInGmii(MV_U32 ethPortNum);
-MV_BOOL mvBoardIsPortLb(MV_U32 ethPortNum);
+MV_BOOL mvBoardIsPortLoopback(MV_U32 ethPortNum);
 MV_32 mvBoardPhyAddrGet(MV_U32 ethPortNum);
 MV_32 mvBoardPhyLinkCryptPortAddrGet(MV_U32 ethPortNum);
 
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 4dd35d5..6925054 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -62,7 +62,6 @@
 
 *******************************************************************************/
 
-/* includes */
 #include "mvCommon.h"
 #include "mvCtrlEnvLib.h"
 #include "boardEnv/mvBoardEnvLib.h"
@@ -486,15 +485,11 @@ MV_U32 mvCtrlPciMaxIfGet(MV_VOID)
 *******************************************************************************/
 MV_U32 mvCtrlEthMaxPortGet(MV_VOID)
 {
-	MV_U32 devId;
-
-	devId = mvCtrlModelGet();
-	switch (devId) {
-	case MV_FPGA_DEV_ID:
-		return MV_FPGA_ETH_MAX_PORT;
-	default:
-		return 0;
-	}
+#ifdef CONFIG_MACH_AVANTA_LP_FPGA
+	return MV_FPGA_ETH_MAX_PORT;
+#else
+#error "ETH_MAX_PORT should be defined!"
+#endif
 }
 
 /*******************************************************************************
@@ -1051,8 +1046,8 @@ MV_VOID mvCtrlAddrDecShow(MV_VOID)
  	mvUnitAddrDecShow(mvCtrlEthMaxPortGet(), ETH_GIG_UNIT_ID, "ETH", mvNetaWinRead);
 #else
 	mvUnitAddrDecShow(mvCtrlEthMaxPortGet(), ETH_GIG_UNIT_ID, "ETH", mvPp2WinRead);
-#endif /* MV_ETH_LEGACY  or NETA pr PP2 */
-#endif /* MV_INCLUDE_GIG_ETH */
+#endif
+#endif
 
 #if defined(MV_INCLUDE_XOR)
 	mvUnitAddrDecShow(mvCtrlXorMaxChanGet(), XOR_UNIT_ID, "XOR", mvXorTargetWinRead);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
index 557bd93..8886a8e 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
@@ -65,7 +65,6 @@
 #ifndef __INCmvCtrlEnvLibh
 #define __INCmvCtrlEnvLibh
 
-/* includes */
 #include "mvSysHwConfig.h"
 #include "mvCommon.h"
 #include "mvTypes.h"
@@ -220,7 +219,7 @@ typedef struct _boardSerdesConf {
 #define TSEN_STATUS_TEMP_OUT_OFFSET             1
 #define TSEN_STATUS_TEMP_OUT_MASK               (0x1FF << TSEN_STATUS_TEMP_OUT_OFFSET)
 
-#define TSEN_CONF_REG                                   0x184D0
+#define TSEN_CONF_REG                           0x184D0
 #define TSEN_CONF_OTF_CALIB_MASK                (0x1 << 30)
 #define TSEN_CONF_REF_CAL_MASK                  (0x1FF << 11)
 #define TSEN_CONF_SOFT_RESET_MASK               (0x1 << 1)
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index 1bec98b..d5f8fd9 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -67,10 +67,8 @@
 
 #include "mvDeviceId.h"
 #include "mvSysHwConfig.h"
-
 #include "ctrlEnv/sys/mvCpuIfRegs.h"
 
-
 #ifdef __cplusplus
 extern "C" {
 #endif /* __cplusplus */
@@ -92,7 +90,7 @@ extern "C" {
 #define MV_MPP_REGS_OFFSET			(0x18000)
 #define MV_GPP_REGS_OFFSET(unit)		(0x18100 + ((unit) * 0x40))
 #define MV_MISC_REGS_OFFSET			(0x18200)
-#define MV_CLK_CMPLX_REGS_OFFSET	(0x18700)
+#define MV_CLK_CMPLX_REGS_OFFSET		(0x18700)
 #define MV_MBUS_REGS_OFFSET			(0x20000)
 #define CPU_GLOBAL_BASE				(MV_MBUS_REGS_OFFSET)
 #define MV_COHERENCY_FABRIC_OFFSET		(0x20200)
@@ -104,8 +102,7 @@ extern "C" {
 #define MV_CPU_PMU_UNIT_SERV_OFFSET(cpu)	(0x22100 + (cpu) * 0x100)
 #define MV_CPU_HW_SEM_OFFSET			(0x20500)
 
-#if defined(MV_ETH_PP2)
-
+#if defined(CONFIG_MV_ETH_PP2)
 #define MV_PP2_REG_BASE				(0x80000)
 #define MV_ETH_BASE_ADDR			(0x50000)
 #define LMS_REG_BASE				(MV_ETH_BASE_ADDR)
@@ -256,8 +253,7 @@ extern "C" {
 #define MV_ETH_MAX_TXQ              		8
 #define MV_ETH_TX_CSUM_MAX_SIZE 		9800
 #define MV_PNC_TCAM_LINES			1024	/* TCAM num of entries */
-
-#endif /* CONFIG_MV_ETH_PP2 */
+#endif
 
 #if defined(MV88F78X60) && !defined(MV88F78X60_Z1)
 /* New GMAC module is used */
diff --git a/arch/arm/plat-armada/common/mv802_3.h b/arch/arm/plat-armada/common/mv802_3.h
index f01ce44..1019660 100644
--- a/arch/arm/plat-armada/common/mv802_3.h
+++ b/arch/arm/plat-armada/common/mv802_3.h
@@ -70,6 +70,8 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 
 /* Defines */
 #define MV_MAX_ETH_DATA     1500
+#define MV_ETH_MH_SIZE      2
+#define MV_ETH_CRC_SIZE     4
 
 /* 802.3 types */
 #define MV_IP_TYPE                  0x0800
@@ -79,6 +81,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define MV_NOVELL_IPX_TYPE          0x8137
 #define MV_EAPOL_TYPE				0x888e
 #define MV_VLAN_TYPE				0x8100
+#define MV_VLAN_1_TYPE				0x88A8
 #define MV_PPPOE_TYPE				0x8864
 
 /* PPPoE protocol type */
-- 
1.7.5.4

