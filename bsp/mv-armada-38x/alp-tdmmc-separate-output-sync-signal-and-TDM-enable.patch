From 050fb795607c61e7a85e9d07cb92190f09783240 Mon Sep 17 00:00:00 2001
From: Victor Gu <xigu@marvell.com>
Date: Wed, 9 Jul 2014 17:45:22 +0800
Subject: [PATCH 1780/1825] alp: tdmmc: separate output sync signal and TDM
 enable register

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 149f00b9f03478a8bc04f62bc66a9c046f090de6

    ASIC has fixed the issue that output sync signal depends on TDM enable
bit(TEN), so remove the software workaround, to enable/disable TEN when
start or stop PCM.
Signed-off-by: Victor Gu <xigu@marvell.com>

Change-Id: I029f35cbe1907937ea5d90622d8ba1f188cb4448
Reviewed-on: http://vgitil04.il.marvell.com:8080/9092
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_hal/voiceband/commUnit/mvCommUnit.c         |   14 ++++++++++++++
 1 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnit.c b/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnit.c
index 9626711..76babe4 100644
--- a/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnit.c
+++ b/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnit.c
@@ -429,8 +429,11 @@ MV_STATUS mvCommUnitHalInit(MV_TDM_PARAMS *tdmParams, MV_TDM_HAL_DATA *halData)
 	/* Restore old periodic interrupt mechanism WA */
 	/* MV_REG_BIT_SET(TDM_DATA_DELAY_AND_CLK_CTRL_REG, OLD_INT_WA_BIT); */
 
+	/* Keep the software workaround to enable TEN while set Fsync for none-ALP chips */
+#ifndef CONFIG_AVANTA_LP
 	/* Enable TDM */
 	MV_REG_BIT_SET(FLEX_TDM_CONFIG_REG, TDM_TEN_MASK);
+#endif
 
 #if 0
 	/* Poll for Enter Hunt Execution Status */
@@ -473,8 +476,10 @@ MV_VOID mvCommUnitRelease(MV_VOID)
 		mvOsUDelay(10);
 		MV_REG_BIT_RESET(MCSC_GLOBAL_CONFIG_REG, MCSC_GLOBAL_CONFIG_MAI_MASK);
 
+#ifndef CONFIG_AVANTA_LP
 		/* Disable TDM */
 		MV_REG_BIT_RESET(FLEX_TDM_CONFIG_REG, TDM_TEN_MASK);
+#endif
 
 		/* Disable PCLK */
 		MV_REG_BIT_RESET(TDM_DATA_DELAY_AND_CLK_CTRL_REG, (TX_CLK_OUT_ENABLE_MASK | RX_CLK_OUT_ENABLE_MASK));
@@ -599,6 +604,11 @@ MV_VOID mvCommUnitPcmStart(MV_VOID)
 		maskReg = MV_REG_READ(TDM_MASK_REG);
 		MV_REG_WRITE(TDM_MASK_REG, (maskReg | CONFIG_TDM_CAUSE));
 		MV_REG_WRITE(COMM_UNIT_TOP_MASK_REG, CONFIG_COMM_UNIT_TOP_MASK);
+
+#ifdef CONFIG_AVANTA_LP
+		/* Enable TDM */
+		MV_REG_BIT_SET(FLEX_TDM_CONFIG_REG, TDM_TEN_MASK);
+#endif
 	}
 
 	MV_TRC_REC("<-%s\n", __func__);
@@ -800,6 +810,10 @@ MV_VOID mvCommUnitPcmStop(MV_VOID)
 			mvOsCacheFlushInv(NULL, txBuffVirt[index], buffSize);
 		}
 
+#ifdef CONFIG_AVANTA_LP
+		/* Disable TDM */
+		MV_REG_BIT_RESET(FLEX_TDM_CONFIG_REG, TDM_TEN_MASK);
+#endif
 	}
 
 	MV_TRC_REC("<-%s\n", __func__);
-- 
1.7.5.4

