From d2545de224dafaec07686e7e5034f0aba2ec5f32 Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <zertsekel@gmail.com>
Date: Fri, 18 Jan 2013 18:46:07 +0200
Subject: [PATCH 0458/1825] ALP: Fix sched_clock to Linux 3.4 kernel API

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 79ea20b29b8dee76e780c90aa8dc4144df1eedd4

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: I1c94fe6cd2b1864c6655101665c88456b5fc58b3
Reviewed-on: http://vgitil04.il.marvell.com:8080/1234
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/time.c |   33 ++++++++++-----------------------
 1 files changed, 10 insertions(+), 23 deletions(-)

diff --git a/arch/arm/mach-avantalp/time.c b/arch/arm/mach-avantalp/time.c
index 31c5a6b..6368e46 100644
--- a/arch/arm/mach-avantalp/time.c
+++ b/arch/arm/mach-avantalp/time.c
@@ -54,23 +54,15 @@
 static u32 ticks_per_jiffy;
 static unsigned int soc_timer_id;
 
-static DEFINE_CLOCK_DATA(cd);
-
-unsigned long long notrace sched_clock(void)
-{
-	u32 cyc = ~MV_REG_READ(TIMER_VAL(soc_timer_id));
-	return cyc_to_sched_clock(&cd, cyc, (u32)~0);
-}
-
-static void notrace alp_update_sched_clock(void)
+static u32 notrace alp_clksrc_read32(void)
 {
 	u32 cyc = ~MV_REG_READ(TIMER_VAL(soc_timer_id));
-	update_sched_clock(&cd, cyc, (u32)~0);
+	return cyc;
 }
 
-static void __init setup_sched_clock(unsigned long tclk)
+static void __init alp_setup_sched_clock(unsigned long tclk)
 {
-	init_sched_clock(&cd, alp_update_sched_clock, 32, tclk);
+	setup_sched_clock(alp_clksrc_read32, 32, tclk);
 }
 
 /*
@@ -116,14 +108,13 @@ void alp_timer_resume(void)
 void __init alp_time_init(unsigned int fabric_clk)
 {
 	u32 u;
-
 	soc_timer_id = 0;
 
-	printk("Initializing Avantalp SOC Timer %d\n", soc_timer_id);
+	printk("Initializing AvantaLP SOC Timer %d\n", soc_timer_id);
 
 	ticks_per_jiffy = (fabric_clk + HZ/2) / HZ;
-	
-	setup_sched_clock(fabric_clk);
+
+	alp_setup_sched_clock(fabric_clk);
 
 	/* Setup free-running clocksource timer (interrupts disabled) */
 	MV_REG_WRITE(TIMER_VAL(soc_timer_id), 0xffffffff);
@@ -140,17 +131,13 @@ void __init alp_time_init(unsigned int fabric_clk)
 	MV_REG_WRITE(TIMER_CTRL, u);
 	alp_clksrc.mult = clocksource_hz2mult(fabric_clk, alp_clksrc.shift);
 	clocksource_register(&alp_clksrc);
-#if 0
+
 #ifdef CONFIG_SMP
-	{
-		percpu_timer_setup();
-	        return;
-	}
-#endif
+	percpu_timer_setup();
 #endif
 }
 
-static void alp_timer_init(void)
+static void __init alp_timer_init(void)
 {
 #if defined (CONFIG_MACH_AVANTA_LP_FPGA)
 	/* FPGA is hardcoded to 25Mhx and DSMP-A0 ref clock for the timers is 25MHz */
-- 
1.7.5.4

