From f7b5f975bb43b5c02d2e350b942e6a1a213de65a Mon Sep 17 00:00:00 2001
From: Yoni Farhadian <yonif@marvell.com>
Date: Tue, 23 Jul 2013 12:52:30 +0300
Subject: [PATCH 0889/1825] alp: PPv2: support 2G between GBE and switch's CPU
 port

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit dd2226c22e0ea90ef799e6ff43b07c31ae2d6423

	Speed between GBE MAC and switch's CPU port is passed via platform data
	Speed is determined by mvBoardMacSpeedGet
	Fix QD-3 API to support changing speed to 2G

Change-Id: Ia088e532b5b57213024efa6503ab7deb8238e42f
Signed-off-by: Yoni Farhadian <yonif@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/2799
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-by: Igor Patrik <igorp@marvell.com>
Tested-by: Igor Patrik <igorp@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/core.c                      |    4 ++++
 .../mv_drivers_lsp/mv_switch/mv_switch.c           |    3 +++
 .../mv_hal/qd-dsdt-3.3/src/msapi/gtPortCtrl.c      |    4 ++--
 include/linux/mv_switch.h                          |    1 +
 4 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index 920e456..ca4a017 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -724,6 +724,9 @@ static void mv_switch_pdev_register(struct platform_device *pdev)
 	plat_data->connected_port_mask = mvBoardSwitchPortsMaskGet(0);
 	plat_data->switch_irq = IRQ_GLOBAL_ETH_COMPLEX;
 
+	if (mvBoardMacSpeedGet(plat_data->gbe_port) == BOARD_MAC_SPEED_2000M)
+		plat_data->is_speed_2000 = 1;
+
 	/* parse switch command line parametes (preset and tag mode) */
 	mv_switch_parse_cmd_line(mv_switch_str, &plat_data->preset, &plat_data->tag_mode);
 
@@ -750,6 +753,7 @@ static struct mv_switch_pdata mv_switch0_plat_data = {
 	.port_mask = 0x7f,
 	.connected_port_mask = 0x4f,
 	.mtu = 1500,
+	.is_speed_2000 = 0,
 };
 
 static struct platform_device mv_switch0_plat_dev = {
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/mv_switch.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/mv_switch.c
index 5d1e068..44abeba 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/mv_switch.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/mv_switch.c
@@ -841,6 +841,9 @@ int mv_switch_init(struct mv_switch_pdata *plat_data)
 		break;
 	}
 
+	/* Configure speed between GBE port and CPU port */
+	gprtSet200Base(qd_dev, qd_cpu_port, plat_data->is_speed_2000);
+
 	switch_ports_mask = plat_data->connected_port_mask;
 	tag_mode = plat_data->tag_mode;
 	preset = plat_data->preset;
diff --git a/arch/arm/plat-armada/mv_hal/qd-dsdt-3.3/src/msapi/gtPortCtrl.c b/arch/arm/plat-armada/mv_hal/qd-dsdt-3.3/src/msapi/gtPortCtrl.c
index f7e152b..664364d 100644
--- a/arch/arm/plat-armada/mv_hal/qd-dsdt-3.3/src/msapi/gtPortCtrl.c
+++ b/arch/arm/plat-armada/mv_hal/qd-dsdt-3.3/src/msapi/gtPortCtrl.c
@@ -6414,8 +6414,8 @@ GT_STATUS gprtSet200Base
         return GT_BAD_PARAM;
     }
 
-    /* Get the high error rate bit.  */
-    retVal = hwSetPortRegField(dev,hwPort, QD_REG_PORT_STATUS,6,1,(GT_U16)mode&0x1);
+	/* Get the high error rate bit.  */
+	retVal = hwSetPortRegField(dev, hwPort, QD_REG_PCS_CONTROL, 12, 1, (GT_U16)mode & 0x1);
 
     if(retVal != GT_OK)
     {
diff --git a/include/linux/mv_switch.h b/include/linux/mv_switch.h
index f0c9a84..aa0d360 100644
--- a/include/linux/mv_switch.h
+++ b/include/linux/mv_switch.h
@@ -87,6 +87,7 @@ struct mv_switch_pdata {
 	int gephy_on_port;
 	int rgmiia_on_port;
 	int switch_irq;
+	int is_speed_2000;
 };
 
 
-- 
1.7.5.4

