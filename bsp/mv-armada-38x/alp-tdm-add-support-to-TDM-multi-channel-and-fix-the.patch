From 869f0d24f67daa17d2124223b9523924df63347c Mon Sep 17 00:00:00 2001
From: Victor Gu <xigu@marvell.com>
Date: Sun, 27 Apr 2014 00:17:58 +0800
Subject: [PATCH 1634/1825] alp: tdm: add support to TDM multi channel and fix
 the SLIC MPP definition

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 97a088f16d5d0164361a9b94a7bdc7ed352b368c

    added new option, to support TDM multi channel
    added new value 'TDMMC' to board config 'TDM module'
    updated SoC configuration accordingly
    corrected SLIC MPP definition

Signed-off-by: Victor Gu <xigu@marvell.com>

Change-Id: Ib0e31bb1cac6576d387525d7e02574de04e4c02e
Reviewed-on: http://vgitil04.il.marvell.com:8080/7737
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |    8 ++++----
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    3 ++-
 .../avanta_lp_family/boardEnv/mvBoardEnvSpec.c     |    6 +++---
 .../avanta_lp_family/boardEnv/mvBoardEnvSpec.h     |    4 ++--
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   18 ++++++++++--------
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |   17 ++++++++++-------
 6 files changed, 31 insertions(+), 25 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index 63df724..01c9f3a 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -979,7 +979,7 @@ MV_VOID mvBoardInfoUpdate(MV_VOID)
 
 	/* Update SLIC device configuration */
 	slicDev = mvCtrlSysConfigGet(MV_CONFIG_SLIC_TDM_DEVICE);
-	if (slicDev == SLIC_EXTERNAL_ID && (ethComplex & MV_ETHCOMP_GE_MAC1_2_RGMII1))
+	if ((slicDev == SLIC_TDM2C_ID || slicDev == SLIC_TDMMC_ID) && (ethComplex & MV_ETHCOMP_GE_MAC1_2_RGMII1))
 		mvOsPrintf("%s: Error: board configuration conflict between MAC1 to RGMII-1, " \
 				"and External TDM - using RGMII-1 (disabled External TDM)\n\n", __func__);
 
@@ -1908,7 +1908,7 @@ MV_VOID mvBoardDDRBusWidthCheck(MV_VOID)
 MV_VOID mvBoardConfigurationPrint(MV_VOID)
 {
 	char *lane1[] = {"PCIe1", "SGMII-0", "SATA-1", "Unconnected" };
-	char *tdmSlic[] = {"None", "SSI", "ISI", "ZSI", "TDM"};
+	char *tdmSlic[] = {"None", "SSI", "ISI", "ZSI", "TDM2C", "TDMMC"};
 	MV_U32 slicDevice, ethConfig = mvBoardEthComplexConfigGet();
 	MV_U16 modelID = mvCtrlModelGet();
 
@@ -1969,9 +1969,9 @@ MV_VOID mvBoardConfigurationPrint(MV_VOID)
 	}
 
 	if (ethConfig & MV_ETHCOMP_GE_MAC1_2_PON_ETH_SERDES)
-		mvOsOutput("       PON ETH SERDES on MAC1\n");
+		mvOsOutput("\tPON ETH SERDES on MAC1\n");
 	if (ethConfig & MV_ETHCOMP_P2P_MAC_2_PON_ETH_SERDES)
-		mvOsOutput("       ETH SERDES on P2P MAC\n");
+		mvOsOutput("\tETH SERDES on P2P MAC\n");
 
 	/* TDM / Slic configuration */
 	slicDevice = mvBoardSlicUnitTypeGet();
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index 56bba3d..2b9f20ce 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -90,7 +90,8 @@ typedef enum _devBoardSlicType {
 	MV_BOARD_SLIC_SSI_ID, /* Lantiq Integrated SLIC */
 	MV_BOARD_SLIC_ISI_ID, /* Silicon Labs ISI Bus */
 	MV_BOARD_SLIC_ZSI_ID, /* Zarlink ZSI Bus */
-	MV_BOARD_SLIC_EXTERNAL_ID, /* Cross vendor external SLIC */
+	MV_BOARD_SLIC_TDM2C_ID, /* Cross vendor external SLIC for TDM2C */
+	MV_BOARD_SLIC_TDMMC_ID, /* Cross vendor external SLIC for TDMMC */
 	MV_BOARD_SLIC_MAX_OPTION
 } MV_BOARD_SLIC_TYPE;
 
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
index 4a5b7f0..3656dc5 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
@@ -88,7 +88,7 @@ MV_BOARD_MAC_INFO avanta_lp_customer_board_0_InfoBoardMacInfo[] = {
 };
 MV_BOARD_MPP_TYPE_INFO avanta_lp_customer_board_0_InfoBoardModTypeInfo[] = {
 	{
-		.boardMppSlic = MV_BOARD_SLIC_EXTERNAL_ID,
+		.boardMppSlic = MV_BOARD_SLIC_TDMMC_ID,
 		.ethSataComplexOpt = MV_ETHCOMP_SW_P0_2_GE_PHY_P0 |
 				     MV_ETHCOMP_SW_P1_2_GE_PHY_P1 |
 				     MV_ETHCOMP_SW_P2_2_GE_PHY_P2 |
@@ -443,7 +443,7 @@ MV_BOARD_MAC_INFO rd88f6650InfoBoardMacInfo[] = {
 };
 MV_BOARD_MPP_TYPE_INFO rd88f6650InfoBoardModTypeInfo[] = {
 	{
-		.boardMppSlic = MV_BOARD_SLIC_EXTERNAL_ID,
+		.boardMppSlic = MV_BOARD_SLIC_TDM2C_ID,
 		.ethSataComplexOpt = MV_ETHCOMP_SW_P0_2_GE_PHY_P0 |
 				     MV_ETHCOMP_SW_P1_2_GE_PHY_P1 |
 				     MV_ETHCOMP_SW_P2_2_GE_PHY_P2 |
@@ -551,7 +551,7 @@ MV_BOARD_MAC_INFO rd88f6660InfoBoardMacInfo[] = {
 };
 MV_BOARD_MPP_TYPE_INFO rd88f6660InfoBoardModTypeInfo[] = {
 	{
-		.boardMppSlic = MV_BOARD_SLIC_EXTERNAL_ID,
+		.boardMppSlic = MV_BOARD_SLIC_TDMMC_ID,
 		.ethSataComplexOpt = MV_ETHCOMP_SW_P0_2_GE_PHY_P0 |
 				     MV_ETHCOMP_SW_P1_2_GE_PHY_P1 |
 				     MV_ETHCOMP_SW_P2_2_GE_PHY_P2 |
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
index c0a03a3..40b5828 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
@@ -102,7 +102,7 @@
 *******************************************************************************/
 #define AVANTA_LP_CUSTOMER_MPP0_7               0x55555555  /* NAND */
 #define AVANTA_LP_CUSTOMER_MPP8_15              0x22555555  /* NAND , I2C */
-#define AVANTA_LP_CUSTOMER_MPP16_23             0x22222222  /* UA0, TDM */
+#define AVANTA_LP_CUSTOMER_MPP16_23             0x55555522  /* UA0, TDMMC */
 #define AVANTA_LP_CUSTOMER_MPP24_31             0x33333333  /* SDIO, SPI1 */
 #define AVANTA_LP_CUSTOMER_MPP32_39             0x00023330  /* SD_Stat (GPIO_input), SPI1,PON BEN, 3xGPIOs  */
 #define AVANTA_LP_CUSTOMER_MPP40_47             0x44100020  /* Switch P4, PON_[XVR,TX_SD]*/
@@ -190,7 +190,7 @@
 *******************************************************************************/
 #define RD_88F6660_MPP0_7               0x55555555  /* NAND */
 #define RD_88F6660_MPP8_15              0x22555555  /* NAND , I2C */
-#define RD_88F6660_MPP16_23             0x22222222  /* UA0, TDM */
+#define RD_88F6660_MPP16_23             0x55555522  /* UA0, TDMMC */
 #define RD_88F6660_MPP24_31             0x33333333  /* SDIO, SPI1 */
 #define RD_88F6660_MPP32_39             0x00023330  /* SD_Stat (GPIO_input), SPI1,PON BEN, 3xGPIOs  */
 #define RD_88F6660_MPP40_47             0x44100020  /* Switch P4, PON_[XVR,TX_SD]*/
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index c1a2ad3..4a1123c 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -1210,20 +1210,22 @@ static MV_VOID mvCtrlTdmCtrlRegSet(MV_VOID)
 	case MV_BOARD_SLIC_ZSI_ID:
 		tdmCtrl = ZSI_MODE;
 		break;
-	case MV_BOARD_SLIC_EXTERNAL_ID:
+	case MV_BOARD_SLIC_TDM2C_ID:
 		tdmCtrl = TDM_MODE;
+		/* TDM VUNIT new field supported from A0 only */
+		if (mvCtrlRevGet() > MV_88F66X0_Z3_ID)
+			tdmCtrl |= TDM_TYPE_VUNIT;
+		break;
+	case MV_BOARD_SLIC_TDMMC_ID:
+		tdmCtrl = TDM_MODE;
+		/* TDM Multi Channel supported from A0 only */
+		if (mvCtrlRevGet() > MV_88F66X0_Z3_ID)
+			tdmCtrl |= TDM_TYPE_COMMUNIT;
 		break;
 	default:
 		mvOsPrintf("%s: Error: wrong SLIC type\n", __func__);
 		return;
 	}
-/* This configuration needs to be modified only by Kernel -
-** 2/multi channel is decided on kernel compilation time */
-#if defined(MV_COMM_UNIT_SUPPORT)
-	/* TDM Multi Channel supported from A0 only */
-	if (mvCtrlRevGet() > MV_88F66X0_Z3_ID)
-		tdmCtrl |= TDM_TYPE_COMMUNIT;
-#endif
 
 	/* Reset TDM Control register field/s */
 	MV_REG_WRITE(MV_TDM_CTRL_REG, (MV_REG_READ(MV_TDM_CTRL_REG) & ~TDM_MODE_MASK));
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index aa2b149..c60a5a2 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -289,11 +289,12 @@ typedef enum {
 #define MV_GROUP_1_TYPE         MV_GROUP_0_TYPE
 
 #define MPP_GROUP_2_TYPE { \
-	0x00002222,     /* SLIC_DISABLED  */ \
-	0x11112222,     /* SLIC_SSI_DEV  */ \
-	0x33030222,     /* SLIC_ISI_DEV  */ \
-	0x44442222,     /* SLIC_ZSI_DEV  */ \
-	0x22222222,     /* SLIC_EXTERNAL_DEV	*/ \
+	0x00000022,     /* SLIC_DISABLED  */ \
+	0x11110022,     /* SLIC_SSI_DEV  */ \
+	0x33030022,     /* SLIC_ISI_DEV  */ \
+	0x44440022,     /* SLIC_ZSI_DEV  */ \
+	0x22222222,     /* SLIC_TDM2C_DEV  */ \
+	0x55555522,     /* SLIC_TDMMC_DEV  */ \
 }
 
 typedef enum {
@@ -301,7 +302,8 @@ typedef enum {
 	SLIC_SSI_DEV,
 	SLIC_ISI_DEV,
 	SLIC_ZSI_DEV,
-	SLIC_EXTERNAL_DEV
+	SLIC_TDM2C_DEV,
+	SLIC_TDMMC_DEV
 } MV_GROUP_2_TYPE;
 
 #define MPP_GROUP_3_TYPE { \
@@ -415,7 +417,8 @@ typedef enum {
 	SLIC_LANTIQ_ID,
 	SLIC_SILABS_ID,
 	SLIC_ZARLINK_ID,
-	SLIC_EXTERNAL_ID
+	SLIC_TDM2C_ID,
+	SLIC_TDMMC_ID
 } MV_SLIC_UNIT_TYPE;
 
 typedef enum {
-- 
1.7.5.4

