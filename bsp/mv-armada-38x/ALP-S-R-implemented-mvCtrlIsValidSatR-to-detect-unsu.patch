From 09970ddd7c97597d2bf405bf87519ab6c124a3c2 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Mon, 10 Jun 2013 14:56:33 +0300
Subject: [PATCH 0714/1825] ALP: S@R: implemented mvCtrlIsValidSatR to detect
 unsupported frequency modes

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 0ddbc2cc4bc71ba8d688fec39b4b771cf62f32a3

- Added mvBoardFreqModesNumGet to return frequency modes number for each board
- Added mvCtrlIsValidSatR for each "SatR write cpufreq" usage
- Added mvCtrlIsValidSatR detection for each U-Boot startup (in prompt)

Change-Id: Ia9116ba240d78ffda5005794a67babb00171f47f
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/2203
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   33 ++++++++++++++++++++
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    1 +
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   23 ++++++++++++++
 3 files changed, 57 insertions(+), 0 deletions(-)
 mode change 100755 => 100644 arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
 mode change 100755 => 100644 arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
old mode 100755
new mode 100644
index 1fba5a5..39f02f2
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -1378,6 +1378,39 @@ MV_U32 mvBoardSwitchPortForceLinkGet(MV_U32 switchIdx)
 }
 
 /*******************************************************************************
+* mvBoardFreqModesNumGet
+*
+* DESCRIPTION:
+*      Return the number of supported frequency modes for this board
+*
+*
+* INPUT:
+*      None.
+*
+* OUTPUT:
+*      None.
+*
+* RETURN:
+*      Number of supported frequency modes
+*
+*******************************************************************************/
+MV_U32 mvBoardFreqModesNumGet()
+{
+	MV_U16 ctrlModel = mvCtrlModelGet();
+
+	if (ctrlModel == MV_6610_DEV_ID)
+		return FREQ_MODES_NUM_6610;
+	else if (ctrlModel == MV_6650_DEV_ID)
+		return FREQ_MODES_NUM_6650;
+	else if (ctrlModel == MV_6660_DEV_ID)
+		return FREQ_MODES_NUM_6660;
+
+	mvOsPrintf("%s: Error: Illegal ctrl Model (%x)\n", __func__, ctrlModel);
+	return MV_ERROR;
+}
+
+
+/*******************************************************************************
 * mvBoardConfigWrite - write MPP's config and Board general environment configuration
 *
 * DESCRIPTION:
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index 6ef5949..270aed7 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -445,6 +445,7 @@ MV_BOOL mvBoardIsSetmModuleConnected(void);
 MV_STATUS mvBoardIsInternalSwitchConnectedToPort(MV_U32 ethPortNum);
 MV_STATUS mvBoardIsInternalSwitchConnected(void);
 MV_U32 mvBoardSwitchPortForceLinkGet(MV_U32 switchIdx);
+MV_U32 mvBoardFreqModesNumGet(void);
 MV_BOOL mvBoardIsLvdsModuleConnected(void);
 MV_BOOL mvBoardIsLcdDviModuleConnected(void);
 MV_STATUS mvBoardTwsiMuxChannelSet(MV_U8 muxChNum);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
old mode 100755
new mode 100644
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 1872612..1549af2 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -138,8 +138,31 @@ MV_U32 mvCtrlGetCpuNum(MV_VOID)
 		return cpu1Enabled;
 }
 
+/*******************************************************************************
+* mvCtrlIsValidSatR
+*
+* DESCRIPTION: check frequency modes table and verify current mode is supported
+*
+* INPUT: None
+*
+* OUTPUT: None
+*
+* RETURN:
+*        MV_TRUE - if current cpu/ddr/l2 frequency mode is supported for board
+*
+*******************************************************************************/
 MV_BOOL mvCtrlIsValidSatR(MV_VOID)
 {
+	MV_U32 i, cpuFreqMode, maxFreqModes = mvBoardFreqModesNumGet();
+	MV_FREQ_MODE pFreqModes[] = MV_USER_SAR_FREQ_MODES;
+
+	cpuFreqMode =  mvCtrlSatRRead(MV_SATR_CPU_DDR_L2_FREQ);
+
+	for (i = 0; i < maxFreqModes; i++) {
+		if (cpuFreqMode == pFreqModes[i].id)
+			return MV_TRUE;
+	}
+
 	return MV_FALSE;
 }
 
-- 
1.7.5.4

