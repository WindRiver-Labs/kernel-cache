From f340d6d2d9d6d903f57eb9ce458a22ef93cb7bd7 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Tue, 13 Aug 2013 17:38:03 +0300
Subject: [PATCH 0957/1825] PCIe: alp,a375: update PCIe configuration process

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit c1063d352e37609ddc255202229d89cdd82ff817

	originally, PCIe initialized interfaces according to PCIe struct which were initializied in board information
	- removed PCIe field from board information struct, and the routine which fills the PCIe struct

Change-Id: Ie8815630024078abda223bd85c394673d58fcdb0
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3027
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   17 ----------------
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    2 -
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   21 +------------------
 arch/arm/mach-avantalp/pex.c                       |    2 +-
 4 files changed, 3 insertions(+), 39 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index 0cd13cd..a48ba63 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -2934,23 +2934,6 @@ MV_32 mvBoardSwitchPortMap(MV_U32 switchIdx, MV_U32 switchPortNum)
 }
 
 /*******************************************************************************
-* mvBoardPexInfoGet - Get board PEX Info
-*
-* DESCRIPTION:
-*
-* INPUT:
-*
-* OUTPUT:
-*       None.
-*
-* RETURN:
-*******************************************************************************/
-MV_BOARD_PEX_INFO *mvBoardPexInfoGet(void)
-{
-	return &board->boardPexInfo;
-}
-
-/*******************************************************************************
 * mvBoardConfigAutoDetectEnabled
 *
 * DESCRIPTION:
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index 9ef5ed0..9bf6eeb 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -360,7 +360,6 @@ typedef struct _boardInfo {
 	MV_U32 nandFlashWriteParams;
 	MV_U32 nandFlashControl;
 	MV_BOARD_TDM_SPI_INFO *pBoardTdmSpiInfo;
-	MV_BOARD_PEX_INFO boardPexInfo;         /* filled in runtime */
 	MV_U32 norFlashReadParams;
 	MV_U32 norFlashWriteParams;
 
@@ -555,7 +554,6 @@ MV_32 mvBoardSwitchConnectedPortGet(MV_U32 ethPort);
 MV_U32 mvBoardSwitchPortsMaskGet(MV_U32 switchIdx);
 MV_BOOL mvBoardConfigAutoDetectEnabled(void);
 MV_32 mvBoardSmiScanModeGet(MV_U32 switchIdx);
-MV_BOARD_PEX_INFO *mvBoardPexInfoGet(void);
 MV_STATUS mvBoardConfIdSet(MV_U16 conf);
 MV_U16 mvBoardPexModeGet(MV_VOID);
 MV_STATUS mvBoardPexModeSet(MV_U16 conf);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 6f9ef45..6c15c5a 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -216,21 +216,6 @@ static MV_U32 mvCtrlDevIdIndexGet(MV_U32 devId)
 	return index;
 }
 
-static MV_VOID mvCtrlPexConfig(MV_VOID)
-{
-	MV_U8 pexUnit;
-	MV_U32 pexIfNum = mvCtrlSocUnitInfoNumGet(PEX_UNIT_ID);
-
-	MV_BOARD_PEX_INFO *boardPexInfo = mvBoardPexInfoGet();
-
-	memset(boardPexInfo, 0, sizeof(MV_BOARD_PEX_INFO));
-
-	for (pexUnit = 0; pexUnit < pexIfNum; pexUnit++)
-		boardPexInfo->pexUnitCfg[pexUnit] = PEX_BUS_MODE_X1;
-
-	boardPexInfo->boardPexIfNum = pexIfNum;
-}
-
 MV_UNIT_ID mvCtrlSocUnitNums[MAX_UNITS_ID][MV_66xx_INDEX_MAX] = {
 /*                           6660               6650            6610 */
 /* DRAM_UNIT_ID         */ { 1,                 1,              1, },
@@ -303,8 +288,6 @@ MV_STATUS mvCtrlEnvInit(MV_VOID)
 		mvBoardInfoUpdate();
 	}
 
-	mvCtrlPexConfig();
-
 	/* write MPP's config and Board general config */
 	mvBoardConfigWrite();
 
@@ -1452,10 +1435,10 @@ static MV_VOID mvCtrlPexAddrDecShow(MV_VOID)
 	MV_PEX_DEC_WIN win;
 	MV_U32 pexIf;
 	MV_U32 bar, winNum;
-	MV_BOARD_PEX_INFO *boardPexInfo = mvBoardPexInfoGet();
+	MV_U32 boardPexIfNum = mvCtrlSocUnitInfoNumGet(PEX_UNIT_ID);
 	MV_U32 pexHWInf = 0;
 
-	for (pexIf = 0; pexIf < boardPexInfo->boardPexIfNum; pexIf++) {
+	for (pexIf = 0; pexIf < boardPexIfNum; pexIf++) {
 		pexHWInf = pexIf;
 
 
diff --git a/arch/arm/mach-avantalp/pex.c b/arch/arm/mach-avantalp/pex.c
index 6fa4ad1..4f01f25 100644
--- a/arch/arm/mach-avantalp/pex.c
+++ b/arch/arm/mach-avantalp/pex.c
@@ -306,7 +306,7 @@ static struct platform_driver mv_pex_driver = {
 
 static int __init mv_pex_init_module(void)
 {
-	mv_pci.nr_controllers = mvBoardPexInfoGet()->boardPexIfNum;
+	mv_pci.nr_controllers = mvCtrlSocUnitInfoNumGet(PEX_UNIT_ID);
 	mv_pci.swizzle        = pci_std_swizzle;
 	mv_pci.map_irq        = mv_map_irq_0;
 	mv_pci.setup          = mv_pex_setup;
-- 
1.7.5.4

