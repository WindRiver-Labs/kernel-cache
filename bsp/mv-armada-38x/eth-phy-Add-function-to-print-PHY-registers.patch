From f4f479db0cc2e54722d706bbfb2529d19a37f56d Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Sun, 24 Nov 2013 13:23:25 -0500
Subject: [PATCH 1166/1825] eth-phy: Add function to print PHY registers

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 040e1a40b3fba84ccb990e8ba81fcced4955c9db

Change-Id: Iae529abacd76fea1bdf57f2a0942009aa4c2e79a
Signed-off-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4427
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yelena Krivosheev <yelena@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.c     |   25 ++++++++++++++++---
 arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.h     |    1 +
 arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhyRegs.h |    7 ++++-
 3 files changed, 27 insertions(+), 6 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.c b/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.c
index 4758ef1..1339c8e 100644
--- a/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.c
+++ b/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.c
@@ -305,14 +305,29 @@ MV_STATUS mvEthPhyRegPrint(MV_U32 phyAddr, MV_U32 regOffs)
 	MV_STATUS   status;
 
 	status = mvEthPhyRegRead(phyAddr, regOffs, &data);
-	if (status == MV_OK)
-		mvOsPrintf("phy=0x%x, reg=0x%x: 0x%04x\n", phyAddr, regOffs, data);
-	else
-		mvOsPrintf("Read failed\n");
+	if (status != MV_OK)
+		mvOsPrintf("Read failed - status = %d\n", status);
+
+	mvOsPrintf("phy=0x%x, reg=0x%x: 0x%04x\n", phyAddr, regOffs, data);
 
 	return status;
 }
 
+void mvEthPhyRegs(int phyAddr)
+{
+	mvOsPrintf("[ETH-PHY #%d registers]\n\n", phyAddr);
+
+	mvEthPhyRegPrint(phyAddr, ETH_PHY_CTRL_REG);
+	mvEthPhyRegPrint(phyAddr, ETH_PHY_STATUS_REG);
+	mvEthPhyRegPrint(phyAddr, ETH_PHY_AUTONEGO_AD_REG);
+	mvEthPhyRegPrint(phyAddr, ETH_PHY_LINK_PARTNER_CAP_REG);
+	mvEthPhyRegPrint(phyAddr, ETH_PHY_1000BASE_T_CTRL_REG);
+	mvEthPhyRegPrint(phyAddr, ETH_PHY_1000BASE_T_STATUS_REG);
+	mvEthPhyRegPrint(phyAddr, ETH_PHY_EXTENDED_STATUS_REG);
+	mvEthPhyRegPrint(phyAddr, ETH_PHY_SPEC_CTRL_REG);
+	mvEthPhyRegPrint(phyAddr, ETH_PHY_SPEC_STATUS_REG);
+}
+
 /*******************************************************************************
 * mvEthPhyRegWrite - Write to ethernet phy register.
 *
@@ -524,6 +539,7 @@ MV_STATUS mvEthPhyDisableAN(MV_U32 phyAddr, int speed, int duplex)
 
 	default:
 			mvOsOutput("Unexpected duplex = %d\n", duplex);
+			return MV_FAIL;
 	}
 	/* Clear bit 12 to Disable autonegotiation of the PHY */
 	phyRegData &= ~ETH_PHY_CTRL_AN_ENABLE_MASK;
@@ -691,6 +707,7 @@ MV_STATUS	mvEthPhyPrintStatus(MV_U32 phyAddr)
 			break;
 	case ETH_PHY_SPEC_STATUS_SPEED_10MBPS:
 			mvOsOutput("Speed: 10 Mbps\n");
+			break;
 	default:
 			mvOsOutput("Speed: Uknown\n");
 			break;
diff --git a/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.h b/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.h
index 363f708..6661f3e 100644
--- a/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.h
+++ b/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhy.h
@@ -121,6 +121,7 @@ MV_STATUS 	mvEthPhyHalInit(MV_ETHPHY_HAL_DATA *halData);
 MV_STATUS	mvEthPhyInit(MV_U32 ethPortNum, MV_BOOL eeeEnable);
 MV_STATUS	mvEthPhyRegRead(MV_U32 phyAddr, MV_U32 regOffs, MV_U16 *data);
 MV_STATUS	mvEthPhyRegPrint(MV_U32 phyAddr, MV_U32 regOffs);
+void            mvEthPhyRegs(int phyAddr);
 MV_STATUS 	mvEthPhyRegWrite(MV_U32 phyAddr, MV_U32 regOffs, MV_U16 data);
 MV_U32 		mvEthPhyAddGet(MV_U32 ethPortNum);
 MV_STATUS 	mvEthPhyReset(MV_U32 phyAddr, int timeout);
diff --git a/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhyRegs.h b/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhyRegs.h
index 7b5576e..a3c2c30 100644
--- a/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhyRegs.h
+++ b/arch/arm/plat-armada/mv_hal/eth-phy/mvEthPhyRegs.h
@@ -101,8 +101,11 @@ extern "C" {
 /* PHY registers and bits */
 #define ETH_PHY_CTRL_REG                0
 #define ETH_PHY_STATUS_REG              1
-#define ETH_PHY_AUTONEGO_AD_REG		    4
-#define ETH_PHY_1000BASE_T_CTRL_REG	    9
+#define ETH_PHY_AUTONEGO_AD_REG		4
+#define ETH_PHY_LINK_PARTNER_CAP_REG	5
+#define ETH_PHY_1000BASE_T_CTRL_REG	9
+#define ETH_PHY_1000BASE_T_STATUS_REG	10
+#define ETH_PHY_EXTENDED_STATUS_REG	15
 #define ETH_PHY_SPEC_CTRL_REG           16
 #define ETH_PHY_SPEC_STATUS_REG         17
 
-- 
1.7.5.4

