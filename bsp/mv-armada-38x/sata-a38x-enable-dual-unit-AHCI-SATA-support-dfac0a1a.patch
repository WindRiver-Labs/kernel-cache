From ff40e39f0583a932f98e60fbba71693570e1c126 Mon Sep 17 00:00:00 2001
From: Shadi Ammouri <shadi@marvell.com>
Date: Tue, 10 Dec 2013 10:41:36 +0200
Subject: [PATCH 1199/1825] sata: a38x: enable dual-unit AHCI SATA support

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 61bd57b92576549dcf624605d3715e87b142befb

	- enable both units use ahci_mv platform driver
	- mbus dram information is passed to the driver
	  as a platform data in order to enable AHCI windows
	  register configuration

Signed-off-by: Marcin Wojtas <mw@semihalf.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4536
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Lior Amsalem <alior@marvell.com>

Conflicts:

	arch/arm/configs/armada_385_v7smp_defconfig
	arch/arm/plat-armada/Kconfig

Change-Id: I4c3a482dbe7aac54f871ef5fbab25a760b8b081b
Signed-off-by: Shadi Ammouri <shadi@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4692
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/configs/armada_380_v7up_defconfig       |    1 -
 arch/arm/mach-armada38x/Makefile                 |    2 -
 arch/arm/mach-armada38x/config/mvRules.mk        |    4 +-
 arch/arm/mach-armada38x/config/mvSysHwConfig.h   |    1 -
 arch/arm/mach-armada38x/config/mvSysSataConfig.h |    4 +-
 arch/arm/mach-armada38x/core.c                   |   83 +++++++++++++++------
 arch/arm/mach-armada38x/export.c                 |    8 --
 arch/arm/mach-armada38x/include/mach/irqs.h      |    5 +-
 arch/arm/plat-armada/Kconfig                     |    3 +-
 9 files changed, 68 insertions(+), 43 deletions(-)

diff --git a/arch/arm/configs/armada_380_v7up_defconfig b/arch/arm/configs/armada_380_v7up_defconfig
index de17235..c7a16d4 100644
--- a/arch/arm/configs/armada_380_v7up_defconfig
+++ b/arch/arm/configs/armada_380_v7up_defconfig
@@ -18,7 +18,6 @@ CONFIG_MV_ETH_PORTS_NUM=2
 CONFIG_MV_ETH_TXQ=8
 # CONFIG_NET_SKB_RECYCLE is not set
 # CONFIG_MV_INCLUDE_USB is not set
-# CONFIG_MV_INCLUDE_INTEG_SATA is not set
 # CONFIG_MV_INCLUDE_SDIO is not set
 CONFIG_MV_ETH_TXQ_DESC=1024
 CONFIG_MV_ETH_DEBUG_CODE=y
diff --git a/arch/arm/mach-armada38x/Makefile b/arch/arm/mach-armada38x/Makefile
index 86722a6..e390c83 100644
--- a/arch/arm/mach-armada38x/Makefile
+++ b/arch/arm/mach-armada38x/Makefile
@@ -80,8 +80,6 @@ armada38x-$(CONFIG_MV_INCLUDE_CESA)	+= $(HAL_CESA_DIR)/mvCesa.o					\
 					   $(HAL_CESA_AES_DIR)/mvAesAlg.o $(HAL_CESA_AES_DIR)/mvAesApi.o\
 					   $(HAL_IF_DIR)/mvSysCesa.o
 
-armada38x-$(CONFIG_MV_INCLUDE_INTEG_SATA)+= $(HAL_IF_DIR)/mvSysSata.o $(HAL_SATA_DIR)/mvSataSoc.o	\
-					   $(HAL_SATA_DIR)/mvSataAddrDec.o
 armada38x-$(CONFIG_MV_INCLUDE_SPI)	+= $(HAL_SPI_DIR)/mvSpi.o $(HAL_SPI_DIR)/mvSpiCmnd.o		\
 					   $(HAL_SFLASH_DIR)/mvSFlash.o $(HAL_IF_DIR)/mvSysSFlash.o	\
 					   $(HAL_IF_DIR)/mvSysSpi.o
diff --git a/arch/arm/mach-armada38x/config/mvRules.mk b/arch/arm/mach-armada38x/config/mvRules.mk
index b4de39f..8051fdb 100644
--- a/arch/arm/mach-armada38x/config/mvRules.mk
+++ b/arch/arm/mach-armada38x/config/mvRules.mk
@@ -31,7 +31,6 @@ HAL_RTC_DIR	  = $(HAL_DIR)/rtc/integ_rtc
 HAL_VOICEBAND	  = $(HAL_DIR)/voiceband
 HAL_SLIC_DIR	  = $(HAL_VOICEBAND)/slic
 HAL_DAA_DIR	  = $(HAL_VOICEBAND)/daa
-HAL_SATA_DIR	  = $(HAL_DIR)/sata/CoreDriver/
 HAL_QD_DIR	  = $(HAL_DIR)/qd-dsdt-3.3
 HAL_SFLASH_DIR	  = $(HAL_DIR)/sflash
 HAL_CNTMR_DIR	  = $(HAL_DIR)/cntmr
@@ -118,8 +117,7 @@ HAL_IF_DIR	= mv_hal_if
 LSP_PATH_I	= $(srctree)/arch/arm/mach-armada38x
 PLAT_PATH_I	= $(srctree)/arch/arm/plat-armada
 
-HAL_PATH	= -I$(PLAT_PATH_I)/$(HAL_DIR) -I$(PLAT_PATH_I)/$(HAL_SATA_DIR) \
-		  -I$(PLAT_PATH_I)/$(HAL_NETA_DIR)
+HAL_PATH	= -I$(PLAT_PATH_I)/$(HAL_DIR) -I$(PLAT_PATH_I)/$(HAL_NETA_DIR)
 A38X_FAM_PATH	= -I$(LSP_PATH_I)/$(A38X_FAM_DIR)
 QD_PATH		= -I$(PLAT_PATH_I)/$(HAL_QD_DIR)/Include  -I$(PLAT_PATH_I)/$(HAL_QD_DIR)/Include/h/msApi	\
 		  -I$(PLAT_PATH_I)/$(HAL_QD_DIR)/Include/h/driver -I$(PLAT_PATH_I)/$(HAL_QD_DIR)/Include/h/platform
diff --git a/arch/arm/mach-armada38x/config/mvSysHwConfig.h b/arch/arm/mach-armada38x/config/mvSysHwConfig.h
index 5d3c91f..62044b2 100644
--- a/arch/arm/mach-armada38x/config/mvSysHwConfig.h
+++ b/arch/arm/mach-armada38x/config/mvSysHwConfig.h
@@ -92,7 +92,6 @@ disclaimer.
 #endif
 #ifdef CONFIG_MV_INCLUDE_INTEG_SATA
 #define MV_INCLUDE_INTEG_SATA
-#define MV_INCLUDE_SATA
 #endif
 #ifdef CONFIG_MV_INCLUDE_USB
 #define MV_INCLUDE_USB
diff --git a/arch/arm/mach-armada38x/config/mvSysSataConfig.h b/arch/arm/mach-armada38x/config/mvSysSataConfig.h
index b9df314..a14ef50 100644
--- a/arch/arm/mach-armada38x/config/mvSysSataConfig.h
+++ b/arch/arm/mach-armada38x/config/mvSysSataConfig.h
@@ -31,6 +31,6 @@ disclaimer.
 #include "mvSysHwConfig.h"
 
 /*
-** Base address for SPI registers.
+** Base address for SATA registers.
 */
-#define MV_SATA_REGS_BASE		(MV_SATA_REGS_OFFSET)
+#define MV_SATA_UNIT_REGS_BASE(u)	MV_SATA3_REGS_OFFSET(u)
diff --git a/arch/arm/mach-armada38x/core.c b/arch/arm/mach-armada38x/core.c
index 2a8d2fa..1ef5fce 100644
--- a/arch/arm/mach-armada38x/core.c
+++ b/arch/arm/mach-armada38x/core.c
@@ -49,6 +49,11 @@
 #include "boardEnv/mvBoardEnvLib.h"
 #include "mvSysHwConfig.h"
 
+#if defined(CONFIG_SATA_AHCI_MV)
+#include "mvSysSataConfig.h"
+#include <linux/ahci_platform.h>
+#endif
+
 #ifdef CONFIG_MTD_NAND_NFC
 #include "mv_mtd/nand_nfc.h"
 #endif
@@ -712,48 +717,78 @@ static void __init a38x_rtc_init(void)
 /*******************************************************************************
  * SATA
  */
-#ifdef CONFIG_SATA_MV
-#define SATA_PHYS_BASE (INTER_REGS_PHYS_BASE | 0xA0000)
+#ifdef CONFIG_SATA_AHCI_MV
+#define SATA_UNIT0_PHYS_BASE (INTER_REGS_PHYS_BASE | MV_SATA_UNIT_REGS_BASE(0))
+#define SATA_UNIT1_PHYS_BASE (INTER_REGS_PHYS_BASE | MV_SATA_UNIT_REGS_BASE(1))
+
+static u64 a38x_sata_dmamask = DMA_BIT_MASK(32);
 
-static struct mv_sata_platform_data a38x_sata_data = {
-	.n_ports = 1,
+static struct mv_sata_platform_data a38x_sata_pdata = {
+	.dram = &a38x_mbus_dram_info,
 };
 
-static struct resource a38x_sata_resources[] = {
+static struct resource a38x_sata_unit0_resources[] = {
 	{
-	 .name = "sata base",
-	 .start = SATA_PHYS_BASE,
-	 .end = SATA_PHYS_BASE + 0x5000 - 1,
+	 .name = "sata unit0 base",
+	 .start = SATA_UNIT0_PHYS_BASE,
+	 .end = SATA_UNIT0_PHYS_BASE + 0x1fff,
 	 .flags = IORESOURCE_MEM,
 	 }, {
-	     .name = "sata irq",
-	     .start = IRQ_GLOBAL_SATA0,
-	     .end = IRQ_GLOBAL_SATA0,
+	     .name = "sata unit0 irq",
+	     .start = IRQ_GLOBAL_SATA_UNIT0,
+	     .end = IRQ_GLOBAL_SATA_UNIT0,
 	     .flags = IORESOURCE_IRQ,
 	     },
 };
 
-static struct platform_device a38x_sata = {
-	.name = "sata_mv",
+static struct platform_device a38x_sata_unit0 = {
+	.name = "ahci_mv",
 	.id = 0,
 	.dev = {
-		.coherent_dma_mask = 0xffffffff,
+		.platform_data = &a38x_sata_pdata,
+		.dma_mask = &a38x_sata_dmamask,
+		.coherent_dma_mask = DMA_BIT_MASK(32),
 		},
-	.num_resources = ARRAY_SIZE(a38x_sata_resources),
-	.resource = a38x_sata_resources,
+	.num_resources = ARRAY_SIZE(a38x_sata_unit0_resources),
+	.resource = a38x_sata_unit0_resources,
 };
-#endif
 
-static void __init a38x_sata_init(struct mv_sata_platform_data *sata_data)
+static struct resource a38x_sata_unit1_resources[] = {
+	{
+	 .name = "sata unit1 base",
+	 .start = SATA_UNIT1_PHYS_BASE,
+	 .end = SATA_UNIT1_PHYS_BASE + 0x1fff,
+	 .flags = IORESOURCE_MEM,
+	 }, {
+	     .name = "sata unit1 irq",
+	     .start = IRQ_GLOBAL_SATA_UNIT1,
+	     .end = IRQ_GLOBAL_SATA_UNIT1,
+	     .flags = IORESOURCE_IRQ,
+	     },
+};
+
+static struct platform_device a38x_sata_unit1 = {
+	.name = "ahci_mv",
+	.id = 1,
+	.dev = {
+		.platform_data = &a38x_sata_pdata,
+		.dma_mask = &a38x_sata_dmamask,
+		.coherent_dma_mask = DMA_BIT_MASK(32),
+		},
+	.num_resources = ARRAY_SIZE(a38x_sata_unit1_resources),
+	.resource = a38x_sata_unit1_resources,
+};
+#endif /* CONFIG_SATA_AHCI_MV */
+
+static void __init a38x_sata_init(void)
 {
-#ifdef CONFIG_SATA_MV
+#ifdef CONFIG_SATA_AHCI_MV
 	if (mvUnitMapIsMine(SATA) != MV_TRUE)
 		return;
 
-	a38x_sata.dev.platform_data = sata_data;
-	sata_data->dram = &a38x_mbus_dram_info;
-	platform_device_register(&a38x_sata);
-#endif
+	platform_device_register(&a38x_sata_unit0);
+	platform_device_register(&a38x_sata_unit1);
+#endif /* CONFIG_SATA_AHCI_MV */
 }
 
 /*******************************************************************************
@@ -1223,11 +1258,11 @@ static void __init a38x_board_init(void)
 	a38x_init_eth();
 	a38x_xor_init();
 	a38x_usb_init();
+	a38x_sata_init();
 
 #if 0
 	a38x_rtc_init();
 	a38x_i2c_init();
-	a38x_sata_init(&a38x_sata_data);
 	a38x_spi_init();
 	a38x_sdio_init();
 	a38x_nand_nfc_init();
diff --git a/arch/arm/mach-armada38x/export.c b/arch/arm/mach-armada38x/export.c
index 0a9b105..0f5ec3b 100644
--- a/arch/arm/mach-armada38x/export.c
+++ b/arch/arm/mach-armada38x/export.c
@@ -171,14 +171,6 @@ EXPORT_SYMBOL(mvSFlashModelGet);
 #endif
 
 /*************************************************************************************************************
- * SATA
- *************************************************************************************************************/
-#ifdef CONFIG_MV_INCLUDE_INTEG_SATA
-#include <sata/CoreDriver/mvSata.h>
-EXPORT_SYMBOL(mvSataWinInit);
-#endif
-
-/*************************************************************************************************************
  * DMA/XOR
  *************************************************************************************************************/
 #if defined(CONFIG_MV_XOR_MEMCOPY) || defined(CONFIG_MV_IDMA_MEMCOPY)
diff --git a/arch/arm/mach-armada38x/include/mach/irqs.h b/arch/arm/mach-armada38x/include/mach/irqs.h
index 7535280..ee72c31 100644
--- a/arch/arm/mach-armada38x/include/mach/irqs.h
+++ b/arch/arm/mach-armada38x/include/mach/irqs.h
@@ -55,7 +55,10 @@
 #define IRQ_GLOBAL_XOR0_CHAN1		55
 
 #define IRQ_GLOBAL_SDIO			57
-#define IRQ_GLOBAL_SATA0		58
+
+#define IRQ_GLOBAL_SATA_UNIT0		58
+#define IRQ_GLOBAL_SATA_UNIT1		60
+
 #define IRQ_GLOBAL_TDM			59
 
 #define IRQ_GLOBAL_PCIE0		61
diff --git a/arch/arm/plat-armada/Kconfig b/arch/arm/plat-armada/Kconfig
index 1a8107f..b79a7fb 100644
--- a/arch/arm/plat-armada/Kconfig
+++ b/arch/arm/plat-armada/Kconfig
@@ -115,7 +115,8 @@ config MV_INCLUDE_INTEG_SATA
 	depends on MV88F6500 || MV88F6281 || MV78XX0 || \
 		   ARMADA_XP || ARMADA_370 || AVANTA_LP || ARMADA_38X
 	default y
-        help
+	select SATA_AHCI_MV if ARMADA_38X
+        ---help---
         Please don't change this configs unless you know what you are doing.
 
 config MV_INCLUDE_TDM
-- 
1.7.5.4

