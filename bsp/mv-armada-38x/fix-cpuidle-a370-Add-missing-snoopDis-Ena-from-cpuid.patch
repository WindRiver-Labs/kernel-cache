From f030dca3d6deb9758773f0c5aa098cb404da7868 Mon Sep 17 00:00:00 2001
From: Shadi Ammouri <shadi@marvell.com>
Date: Tue, 10 Dec 2013 10:48:33 +0200
Subject: [PATCH 1203/1825] fix: cpuidle: a370: Add missing snoopDis/Ena from
 cpuidle flow

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit bcae651b368fcab3f9405aeeae18c78a16b05b20

        In Armada370, the PMU doesn't disable the snoop bit so we have to do it in SW

	Bug fix: SYSTEMSW-139 - Deep Idle does not work

Signed-off-by: Nadav Haklai <nadavh@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4590

Conflicts:

	arch/arm/plat-armada/cpuidle.c

Change-Id: Ic158c9ed83ee8816893a945b9ff5f0c3ea748662
Signed-off-by: Shadi Ammouri <shadi@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4696
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/cpuidle.c |   13 +++++++++++++
 1 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/cpuidle.c b/arch/arm/plat-armada/cpuidle.c
index 69fbf93..488663d 100644
--- a/arch/arm/plat-armada/cpuidle.c
+++ b/arch/arm/plat-armada/cpuidle.c
@@ -183,6 +183,13 @@ void armadaxp_fabric_prepare_deepIdle(void)
 	reg = MV_REG_READ(MV_CPU_PMU_UNIT_SERV_OFFSET(processor_id) + 0x8);
 	reg |= 0x1;
 	MV_REG_WRITE(MV_CPU_PMU_UNIT_SERV_OFFSET(processor_id) + 0x8, reg);
+#endif
+#ifdef CONFIG_ARCH_ARMADA370
+	/* Disable delivery of snoop requests to the CPU core by setting */
+	reg = MV_REG_READ(MV_COHERENCY_FABRIC_CTRL_REG);
+	reg &= ~(1 << 24);
+	MV_REG_WRITE(MV_COHERENCY_FABRIC_CTRL_REG, reg);
+#endif
 }
 
 void armadaxp_fabric_restore_deepIdle(void)
@@ -196,6 +203,12 @@ void armadaxp_fabric_restore_deepIdle(void)
 	reg &= ~PM_CONTROL_AND_CONFIG_L2_PWDDN;
 	MV_REG_WRITE(PM_CONTROL_AND_CONFIG_REG(processor_id), reg);
 #endif
+#ifdef CONFIG_ARCH_ARMADA370
+	/* Enable delivery of snoop requests to the CPU core by setting */
+	reg = MV_REG_READ(MV_COHERENCY_FABRIC_CTRL_REG);
+	reg |= (1 << 24);
+	MV_REG_WRITE(MV_COHERENCY_FABRIC_CTRL_REG, reg);
+#endif
 	/* cancel Disable delivering of other CPU core cache maintenance instruction,
 	 * TLB, and Instruction synchronization to the CPU core 
 	 */
-- 
1.7.5.4

