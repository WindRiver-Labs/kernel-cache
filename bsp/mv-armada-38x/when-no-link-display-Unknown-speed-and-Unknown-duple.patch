From 7627646b3d83a6228c99dc1ac9d5eb466f5d0b85 Mon Sep 17 00:00:00 2001
From: Tawfik Bayouk <tawfik@marvell.com>
Date: Tue, 21 Aug 2012 17:35:41 +0300
Subject: [PATCH 0197/1825] when no link, display Unknown speed and Unknown
 duplex with ethtool

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 786487910784cb786ac3fad03885a4b2fb2b97b5

Change-Id: Ifdc661dbdb8be88e42e4655b63927dbd64f2630a
Signed-off-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_neta/net_dev/mv_eth_tool.c   |   39 +++++++++++---------
 1 files changed, 22 insertions(+), 17 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_eth_tool.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_eth_tool.c
index 2dc9973..857c782 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_eth_tool.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_eth_tool.c
@@ -188,25 +188,30 @@ int mv_eth_tool_get_settings(struct net_device *netdev, struct ethtool_cmd *cmd)
 
 	mvNetaLinkStatus(priv->port, &status);
 
-	switch (status.speed) {
-	case MV_ETH_SPEED_1000:
-		cmd->speed = SPEED_1000;
-		break;
-	case MV_ETH_SPEED_100:
-		cmd->speed = SPEED_100;
-		break;
-	case MV_ETH_SPEED_10:
-		cmd->speed = SPEED_10;
-		break;
-	default:
-		return -EINVAL;
+	if (status.linkup != MV_TRUE) {
+		/* set to Unknown */
+		cmd->speed  = -1;
+		cmd->duplex = -1;
+	} else {
+		switch (status.speed) {
+		case MV_ETH_SPEED_1000:
+			cmd->speed = SPEED_1000;
+			break;
+		case MV_ETH_SPEED_100:
+			cmd->speed = SPEED_100;
+			break;
+		case MV_ETH_SPEED_10:
+			cmd->speed = SPEED_10;
+			break;
+		default:
+			return -EINVAL;
+		}
+		if (status.duplex == MV_ETH_DUPLEX_FULL)
+			cmd->duplex = 1;
+		else
+			cmd->duplex = 0;
 	}
 
-	if (status.duplex == MV_ETH_DUPLEX_FULL)
-		cmd->duplex = 1;
-	else
-		cmd->duplex = 0;
-
 	cmd->port = PORT_MII;
 	cmd->phy_address = mv_phy_addr;
 	cmd->transceiver = XCVR_INTERNAL;
-- 
1.7.5.4

