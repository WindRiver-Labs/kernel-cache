From 90efc23d36219999e9b76c200e0f431abd0ef0bc Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Sun, 5 May 2013 16:37:48 +0300
Subject: [PATCH 0643/1825] ALP: U-Boot General code cleanup

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 23b5b844316b2e28fa1a0aed372d25fc0ac063e7

- Placed late_print_cpuinfo after mvCtrlEnvInit
  (after mvCtrlSatrInit is done, and all board info is initialized)
  - Moved mvBoardIdSet to mvBoardEnvInit
  - Updated mvCtrlCpuDdrL2FreqGet to use SatR Array instead of direct read
  - Redefined missing MV_INCLUDE_SDRAM_CS1
  - moved mvCtrlSmiMasterSet from mv_main to mvBoardEgigaPhyInit

Change-Id: I48433a71e2f659e43c0914a102785d46aa80e0ae
Reviewed-on: http://vgitil04.il.marvell.com:8080/1780
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |    6 +++---
 .../avanta_lp_family/boardEnv/mvBoardEnvSpec.h     |    8 ++++----
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   10 ++++------
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |    2 +-
 4 files changed, 12 insertions(+), 14 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index 8df0dfe..68dfbfa 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -118,9 +118,9 @@ static MV_BOARD_INFO *board = NULL;
 *******************************************************************************/
 MV_VOID mvBoardEnvInit(MV_VOID)
 {
-	/*
-	 * FPGA board doesn't use MPP neither GPIO.
-	 */
+	mvBoardIdSet(mvBoardIdGet());
+
+	/*  FPGA board doesn't use MPP neither GPIO */
 #if !defined(CONFIG_MACH_AVANTA_LP_FPGA)
 	MV_U32 nandDev;
 	MV_U32 norDev;
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
index 8c85659..3ac0f79 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
@@ -83,9 +83,9 @@
 #define BOARD_ID_BASE                   0x0
 
 #define RD_6650_ID                      (BOARD_ID_BASE)
-#define RD_6660_ID                      (RD_6650_ID + 1)
-#define DB_6650_ID                      (RD_6660_ID + 1)
-#define DB_6660_ID                      (DB_6650_ID + 1)
+#define DB_6650_ID                      (RD_6650_ID + 1)
+#define RD_6660_ID                      (DB_6650_ID + 1)
+#define DB_6660_ID                      (RD_6660_ID + 1)
 #define MV_BOARD_ID_AVANTA_LP_FPGA      (DB_6660_ID + 1)
 #define MV_MAX_BOARD_ID                 (MV_BOARD_ID_AVANTA_LP_FPGA + 1)
 #define MV_INVALID_BOARD_ID             0xFFFFFFFF
@@ -108,7 +108,7 @@
    46-57			Port 0 connected to: Switch		(2)
    58-64			LED_MATRIX				(4)
  */
-
+#define GROUP1_DEFAULT_MPP_SPI_I2C         0x22000022  /* SPI , I2C */
 /*******************************************************************************
 * Avanata LP DB-6660 board
 *******************************************************************************/
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 421c627..4f86492 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -248,7 +248,7 @@ MV_STATUS mvCtrlEnvInit(MV_VOID)
 	MV_U32 i, gppMask;
 
 	/* Set I2C MPP's(MPP Group 1), before reading board configuration, using TWSI read */
-	MV_REG_WRITE(mvCtrlMppRegGet(1), mvBoardMppGet(1));
+	MV_REG_WRITE(mvCtrlMppRegGet(1), GROUP1_DEFAULT_MPP_SPI_I2C);
 
 	mvCtrlSatrInit();
 
@@ -423,9 +423,7 @@ MV_VOID mvCtrlSmiMasterSet(MV_SMI_CTRL smiCtrl)
 MV_STATUS mvCtrlCpuDdrL2FreqGet(MV_FREQ_MODE *freqMode)
 {
 	MV_FREQ_MODE freqTable[] = MV_SAR_FREQ_MODES;
-	MV_U32 freqModeSatRValue = MV_REG_READ(MPP_SAMPLE_AT_RESET(1));
-
-	freqModeSatRValue = ((freqModeSatRValue & 0x003E0000) >> 17);
+	MV_U32 freqModeSatRValue = mvCtrlSatRRead(MV_SATR_CPU_DDR_L2_FREQ);
 
 	if (MV_ERROR != freqModeSatRValue) {
 		*freqMode = freqTable[freqModeSatRValue];
@@ -614,8 +612,8 @@ MV_BOOL mvCtrlIsEepromEnabled()
 	if (mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_JUMPER2_EEPROM_ENABLED, &ioInfo) == MV_OK)
 	{
 		value = mvBoardIoExpValGet(&ioInfo);
-		if (value != 0xFF)
-			return (value == 0x1);
+		if (value == 0x1)
+			return MV_TRUE;
 	}
 	mvOsPrintf("%s: Error: Read from IO expander failed (EEPROM enabled jumper)\n", __func__);
 	return MV_FALSE;
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index 4675053..7438e30 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -244,7 +244,7 @@ extern "C" {
 #define MV_SPI_VERSION                          2
 
 #define MV_INCLUDE_SDRAM_CS0
-#undef  MV_INCLUDE_SDRAM_CS1
+#define  MV_INCLUDE_SDRAM_CS1
 #undef  MV_INCLUDE_SDRAM_CS2
 #undef  MV_INCLUDE_SDRAM_CS3
 
-- 
1.7.5.4

