From 8251a269b49f35a1e6045f08b6ea715a651da0a4 Mon Sep 17 00:00:00 2001
From: Tawfik Bayouk <tawfik@marvell.com>
Date: Tue, 21 Aug 2012 17:32:43 +0300
Subject: [PATCH 0017/1825] L2 deposit support for NAS bencharks sit support
 for NAS bencharks

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit c11593409c205f46431db0c46cbdbe155dd1ef04

Change-Id: I16f2ca9d54aa48594366fbd63879a0f6b363eaf5
Signed-off-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-armadaxp/mv_hal_if/mvSysNeta.c |    9 +++++++++
 arch/arm/mm/Kconfig                          |    7 +++++++
 arch/arm/mm/cache-aurora-l2.c                |    4 ++++
 3 files changed, 20 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-armadaxp/mv_hal_if/mvSysNeta.c b/arch/arm/mach-armadaxp/mv_hal_if/mvSysNeta.c
index 4d053bc..47f40dc 100644
--- a/arch/arm/mach-armadaxp/mv_hal_if/mvSysNeta.c
+++ b/arch/arm/mach-armadaxp/mv_hal_if/mvSysNeta.c
@@ -100,6 +100,15 @@ void 	mvSysNetaInit(void)
 		if(addrWinMap[i].enable == MV_FALSE)
 			continue;
 
+#ifdef CONFIG_MV_SUPPORT_L2_DEPOSIT
+		/* Setting DRAM windows attribute to :
+		   0x3 - Shared transaction + L2 write allocate (L2 Deposit) */
+		if (MV_TARGET_IS_DRAM(i)) {
+			addrWinMap[i].attrib &= ~(0x30);
+			addrWinMap[i].attrib |= 0x30;
+		}
+#endif
+
 		printk("%d - Base 0x%08x , Size = 0x%08x.\n", i,
 				addrWinMap[i].addrWin.baseLow,
 				addrWinMap[i].addrWin.size);
diff --git a/arch/arm/mm/Kconfig b/arch/arm/mm/Kconfig
index a42e1eb..aa1723a 100644
--- a/arch/arm/mm/Kconfig
+++ b/arch/arm/mm/Kconfig
@@ -1066,6 +1066,13 @@ config MV_SUPPORT_64KB_PAGE_SIZE
 	help
 	  This option enables 64KB pages.
 
+config MV_SUPPORT_L2_DEPOSIT
+	bool "Support L2 Deposit"
+	depends on ARCH_ARMADA_XP
+	default n
+	help
+	  This option enables L2 deposit.
+
 config MIGHT_HAVE_CACHE_L2X0
 	bool
 	help
diff --git a/arch/arm/mm/cache-aurora-l2.c b/arch/arm/mm/cache-aurora-l2.c
index e38ba82..68959bd 100644
--- a/arch/arm/mm/cache-aurora-l2.c
+++ b/arch/arm/mm/cache-aurora-l2.c
@@ -665,6 +665,10 @@ int __init aurora_l2_init(void __iomem *base)
 	aux = readl(auroraL2_base + L2_AUX_CTRL_REG);
 	aux &= ~L2ACR_REPLACEMENT_MASK;
 	aux |= l2rep;
+#ifdef CONFIG_MV_SUPPORT_L2_DEPOSIT
+	aux &= ~L2ACR_FORCE_WRITE_POLICY_MASK;
+	aux |= L2ACR_FORCE_WRITE_BACK_POLICY;
+#endif
 	writel(aux, auroraL2_base + L2_AUX_CTRL_REG); 	    	
 
 	l2_wt_override = ((aux & (0x3)) == 0x2 ? 1:0);
-- 
1.7.5.4

