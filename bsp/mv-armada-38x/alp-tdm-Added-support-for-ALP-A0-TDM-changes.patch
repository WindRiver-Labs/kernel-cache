From d8dc5a729becd5b884fa5ee5ca09e7f7c96893f7 Mon Sep 17 00:00:00 2001
From: Hanna Hawa <hannah@marvell.com>
Date: Mon, 17 Feb 2014 13:15:55 +0200
Subject: [PATCH 1400/1825] alp: tdm: Added support for ALP-A0 TDM changes

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 55a73377948e29691e361afe6add6291169de406

	Update TDM active unit fields due to A0 registers changes, moved bit 0 to bits 26:27
	Added initial support TDM-CommUnit - Multi-Channel (wrapped by MV_COMM_UNIT_SUPPORT)

Change-Id: I61cc69211a05067fe54433200b68d39794fc2ad4
Signed-off-by: Hanna Hawa <hannah@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5679
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   12 +++++++++++-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h       |   12 +++++++++---
 2 files changed, 20 insertions(+), 4 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 64b94a3..d6d83a0 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -1173,7 +1173,10 @@ static MV_VOID mvCtrlTdmCtrlRegSet(MV_VOID)
 	case MV_BOARD_SLIC_DISABLED:
 		return;
 	case MV_BOARD_SLIC_SSI_ID:
-		tdmCtrl = TDM_TYPE_SSI_LANTIQ;
+		if (mvCtrlRevGet() <= MV_88F66X0_Z3_ID)
+			tdmCtrl = TDM_TYPE_SSI_LANTIQ_Z_REV;
+		else
+			tdmCtrl = TDM_TYPE_SSI_LANTIQ;
 		break;
 	case MV_BOARD_SLIC_ISI_ID:
 		tdmCtrl = (ISI_MODE | ISI_MODE_CS_DEASSERT_BIT_COUNT_VAL | SPI_B_MODE_ISI_ENABLE_MASK);
@@ -1188,6 +1191,13 @@ static MV_VOID mvCtrlTdmCtrlRegSet(MV_VOID)
 		mvOsPrintf("%s: Error: wrong SLIC type\n", __func__);
 		return;
 	}
+/* This configuration needs to be modified only by Kernel -
+** 2/multi channel is decided on kernel compilation time */
+#if defined(MV_COMM_UNIT_SUPPORT)
+	/* TDM Multi Channel supported from A0 only */
+	if (mvCtrlRevGet() > MV_88F66X0_Z3_ID)
+		tdmCtrl |= TDM_TYPE_COMMUNIT;
+#endif
 
 	/* Reset TDM Control register field/s */
 	MV_REG_WRITE(MV_TDM_CTRL_REG, (MV_REG_READ(MV_TDM_CTRL_REG) & ~TDM_MODE_MASK));
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
index 49ecc87..2cf15e1 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
@@ -105,10 +105,16 @@ extern "C" {
 #define SPI_B_MODE_ISI_ENABLE_OFFS		14
 #define SPI_B_MODE_ISI_ENABLE_MASK		(1 << SPI_B_MODE_ISI_ENABLE_OFFS)
 
-#define TDM_TYPE_OFFS				0
-#define TDM_TYPE_MASK				(1 << TDM_TYPE_OFFS)
-#define TDM_TYPE_TDM_VUNIT			(0 << TDM_TYPE_OFFS)
+#define TDM_TYPE_OFFS_Z_REV			0
+#define TDM_TYPE_MASK_Z_REV			(1 << TDM_TYPE_OFFS_Z_REV)
+#define TDM_TYPE_TDM_VUNIT_Z_REV		(0 << TDM_TYPE_OFFS_Z_REV)
+#define TDM_TYPE_SSI_LANTIQ_Z_REV		(1 << TDM_TYPE_OFFS_Z_REV)
+
+#define TDM_TYPE_OFFS				26
+#define TDM_TYPE_MASK				(3 << TDM_TYPE_OFFS)
+#define TDM_TYPE_VUNIT				(0 << TDM_TYPE_OFFS)
 #define TDM_TYPE_SSI_LANTIQ			(1 << TDM_TYPE_OFFS)
+#define TDM_TYPE_COMMUNIT			(2 << TDM_TYPE_OFFS)
 
 /*
  * SoC Device Multiplex Register
-- 
1.7.5.4

