From de91df17dc0b3d11fbab9ccc31898ef0ea515855 Mon Sep 17 00:00:00 2001
From: Uri Eliyahu <uriel@marvell.com>
Date: Wed, 9 Apr 2014 14:41:53 +0300
Subject: [PATCH 1551/1825] fix: mux: promisc mode overrwrite bug fix

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 84669201bfbd4977ee5302a4a5fcd692a47631ab

	- promiscuous is overrwiten by eth port
	- remove unneccessary functions from mux, pp2 and neta functionality

Change-Id: I3def3734d7d3907690685c9cd20adeda9c317ae7
Signed-off-by: Uri Eliyahu <uriel@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_mux/mv_mux_netdev.c          |    3 +--
 .../mv_drivers_lsp/mv_mux/mv_mux_netdev.h          |    1 -
 .../mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c     |    1 -
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |    9 ---------
 4 files changed, 1 insertions(+), 13 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_netdev.c
index 25c74d1..c2ef6a9 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_netdev.c
@@ -134,8 +134,7 @@ static int mv_mux_mgr_probe(int gbe_port)
 	mv_mux_mgr_init(preset, vid, tag_mode, gbe_port);
 
 	if (tag_mode != MV_TAG_TYPE_NONE)
-		if (eth_ops && eth_ops->promisc_set)
-			eth_ops->promisc_set(gbe_port);
+		dev_set_promiscuity(mux_eth_shadow[gbe_port].root, 1);
 
 	if (switch_ops && switch_ops->interrupt_unmask)
 		switch_ops->interrupt_unmask();
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_netdev.h b/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_netdev.h
index 8b1ccea..660084a 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_netdev.h
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_mux/mv_mux_netdev.h
@@ -102,7 +102,6 @@ struct mv_mux_switch_ops {
 
 struct mv_mux_eth_ops {
 	int	(*set_tag_type)(int port, int tag_type);
-	void	(*promisc_set)(int port);
 };
 
 int mv_mux_update_link(void *cookie, int link_up);
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
index dfd5e86..7a9a859 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
@@ -3329,7 +3329,6 @@ static int mv_eth_load_network_interfaces(struct platform_device *pdev)
 	handle_group_affinity(port);
 
 	mux_eth_ops.set_tag_type = mv_eth_tag_type_set;
-	mux_eth_ops.promisc_set = mv_eth_port_promisc_set;
 	mv_mux_eth_attach(pp->port, pp->dev, &mux_eth_ops);
 
 #ifdef CONFIG_NETMAP
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index 9c47e6f..0c2f8ef9 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -3230,14 +3230,6 @@ int mv_eth_poll(struct napi_struct *napi, int budget)
 	return rx_done;
 }
 
-void mv_eth_port_promisc_set(int port)
-{
-	if (mv_eth_pnc_ctrl_en)
-		mvPrsMacPromiscousSet(port, 1);
-	else
-		printk(KERN_ERR "%s: PARSER and CLASSIFIER control is disabled\n", __func__);
-}
-
 void mv_eth_port_filtering_cleanup(int port)
 {
 	static bool is_first = true;
@@ -3509,7 +3501,6 @@ static int mv_eth_load_network_interfaces(struct platform_device *pdev)
 		mv_eth_open(pp->dev);
 
 	mux_eth_ops.set_tag_type = mv_eth_tag_type_set;
-	mux_eth_ops.promisc_set = mv_eth_port_promisc_set;
 	mv_mux_eth_attach(pp->port, pp->dev, &mux_eth_ops);
 
 	pr_info("\n");
-- 
1.7.5.4

