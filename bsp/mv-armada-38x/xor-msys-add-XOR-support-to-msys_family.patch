From 389c3c5a2d26298d62c79fddab075b71a770686b Mon Sep 17 00:00:00 2001
From: Ofer Heifetz <oferh@marvell.com>
Date: Mon, 3 Feb 2014 15:27:41 +0200
Subject: [PATCH 1338/1825] xor: msys: add XOR support to msys_family

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit b4bc3d3c3796d1c45f66c927f480c0109b735a20

	Added XOR support to MSYS defconfig.
	Used dmatest.ko to test the new feature support + irq count verification.
	NET_DMA was not verified during UT phase.

Change-Id: Id3f27619e95d06f83e36a7b07b3bff8bf4025ac9
Signed-off-by: Ofer Heifetz <oferh@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5429
Reviewed-by: Shadi Ammouri <shadi@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/configs/msys_defconfig                    |    3 +-
 arch/arm/mach-msys/Makefile                        |    4 +-
 arch/arm/mach-msys/core.c                          |  119 +++++++++++++++++++-
 arch/arm/mach-msys/include/mach/msys.h             |    6 +-
 .../mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.c   |    2 +-
 .../mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h  |    2 +-
 6 files changed, 125 insertions(+), 11 deletions(-)

diff --git a/arch/arm/configs/msys_defconfig b/arch/arm/configs/msys_defconfig
index 02d7bd8..9dba538 100644
--- a/arch/arm/configs/msys_defconfig
+++ b/arch/arm/configs/msys_defconfig
@@ -19,7 +19,6 @@ CONFIG_PARTITION_ADVANCED=y
 CONFIG_EFI_PARTITION=y
 CONFIG_ARCH_MSYS=y
 CONFIG_MV_HAL_RULES_PATH="arch/arm/mach-armadaxp/mv_hal_support/mvRules.mk"
-# CONFIG_MV_INCLUDE_XOR is not set
 # CONFIG_MV_INCLUDE_NFC is not set
 # CONFIG_MV_INCLUDE_SDIO is not set
 CONFIG_MV_PMU_PROC=y
@@ -103,6 +102,8 @@ CONFIG_SENSORS_JC42=y
 CONFIG_MMC=y
 CONFIG_MMC_MVSDIO=y
 CONFIG_NEW_LEDS=y
+CONFIG_DMADEVICES=y
+CONFIG_MV_XOR=y
 CONFIG_EXT2_FS=y
 CONFIG_EXT3_FS=y
 # CONFIG_EXT3_DEFAULTS_TO_ORDERED is not set
diff --git a/arch/arm/mach-msys/Makefile b/arch/arm/mach-msys/Makefile
index b1534ff..a4c044f 100644
--- a/arch/arm/mach-msys/Makefile
+++ b/arch/arm/mach-msys/Makefile
@@ -39,9 +39,10 @@ msys-objs  			:=$(LSP_OBJS) $(COMMON_OBJS) $(OSSERVICES_OBJS) $(HAL_OBJS) 	\
 
 msys-$(CONFIG_MV_INCLUDE_PEX) 	+= $(HAL_PEX_DIR)/mvPex.o					\
 					$(HAL_IF_DIR)/mvSysPex.o $(HAL_PEX_DIR)/mvPexAddrDec.o
+
 msys-y				+= $(HAL_ETHPHY_DIR)/mvEthPhy.o $(HAL_IF_DIR)/mvSysEthPhy.o
 msys-$(CONFIG_MV_INCLUDE_PCI) 	+= $(HAL_PCI_DIR)/mvPci.o $(HAL_IF_DIR)/mvSysPci.o
-
+msys-$(CONFIG_MV_INCLUDE_XOR) 	+= $(HAL_XOR_DIR)/mvXor.o $(HAL_XOR_DIR)/mvXorAddrDec.o
 msys-$(CONFIG_MV_INCLUDE_SPI) 	+= $(HAL_SPI_DIR)/mvSpi.o $(HAL_SPI_DIR)/mvSpiCmnd.o 			\
 					   $(HAL_SFLASH_DIR)/mvSFlash.o $(HAL_IF_DIR)/mvSysSFlash.o	\
 					   $(HAL_IF_DIR)/mvSysSpi.o
@@ -51,6 +52,7 @@ obj-$(CONFIG_MV_ETH_NETA)		+= $(LSP_NETA_DIR)/
 
 # drivers part
 obj-$(CONFIG_MV_INCLUDE_GIG_ETH)	+= $(LSP_PHY_DIR)/phy_sysfs.o
+obj-$(CONFIG_MV_USE_XOR_ENGINE) 	+= $(PLAT_DRIVERS)/mv_xor/
 obj-$(CONFIG_ERROR_HANDLING)		+= $(LSP_ERR_DIR)/mv_error.o
 obj-y					+= $(PLAT_DRIVERS)/mv_gpio/
 obj-$(CONFIG_MV_DBG_TRACE)              += $(PLAT_DRIVERS)/mv_trace/
diff --git a/arch/arm/mach-msys/core.c b/arch/arm/mach-msys/core.c
index d3bcca1..c22d57f 100644
--- a/arch/arm/mach-msys/core.c
+++ b/arch/arm/mach-msys/core.c
@@ -82,6 +82,10 @@ disclaimer.
 
 #include <linux/mv_neta.h>
 
+#ifdef CONFIG_MV_INCLUDE_XOR
+#include <plat/mv_xor.h>
+#endif
+
 /* I2C */
 #include <linux/i2c.h>
 #include <linux/mv643xx_i2c.h>
@@ -111,7 +115,7 @@ static struct sys_timer msys_timer = {
 #define TARGET_DDR		0
 #define COHERENCY_STATUS_SHARED_NO_L2_ALLOC	0x1
 
-struct mbus_dram_target_info msys_mbus_dram_info;
+static struct mbus_dram_target_info msys_mbus_dram_info;
 
 const struct mbus_dram_target_info *mv_mbus_dram_info(void)
 {
@@ -427,8 +431,6 @@ static void __init mv_gpio_init(void)
 }
 
 
-
-
 /*********************************************************************************/
 /**************                      Helper Routines                **************/
 /*********************************************************************************/
@@ -513,6 +515,113 @@ static void check_cpu_mode(void)
 }
 #endif
 
+#ifdef CONFIG_MV_INCLUDE_XOR
+/*****************************************************************************
+ * XOR
+ ****************************************************************************/
+static struct mv_xor_platform_shared_data msys_xor_shared_data = {
+	.dram		= &msys_mbus_dram_info,
+};
+
+static u64 msys_xor_dmamask = DMA_BIT_MASK(32);
+
+/*****************************************************************************
+ * XOR0
+ ****************************************************************************/
+static struct resource msys_xor0_shared_resources[] = {
+	{
+		.name	= "xor 0 low",
+		.start	= XOR0_PHYS_BASE,
+		.end	= XOR0_PHYS_BASE + 0xff,
+		.flags	= IORESOURCE_MEM,
+	}, {
+		.name	= "xor 0 high",
+		.start	= XOR0_HIGH_PHYS_BASE,
+		.end	= XOR0_HIGH_PHYS_BASE + 0xff,
+		.flags	= IORESOURCE_MEM,
+	},
+};
+
+static struct platform_device msys_xor0_shared = {
+	.name		= MV_XOR_SHARED_NAME,
+	.id		= 0,
+	.dev		= {
+		.platform_data = &msys_xor_shared_data,
+	},
+	.num_resources	= ARRAY_SIZE(msys_xor0_shared_resources),
+	.resource	= msys_xor0_shared_resources,
+};
+
+static struct resource msys_xor00_resources[] = {
+	[0] = {
+		.start	= IRQ_AURORA_XOR00,
+		.end	= IRQ_AURORA_XOR00,
+		.flags	= IORESOURCE_IRQ,
+	},
+};
+
+static struct mv_xor_platform_data msys_xor00_data = {
+	.shared		= &msys_xor0_shared,
+	.hw_id		= 0,
+	.pool_size	= PAGE_SIZE,
+};
+
+static struct platform_device msys_xor00_channel = {
+	.name		= MV_XOR_NAME,
+	.id		= 0,
+	.num_resources	= ARRAY_SIZE(msys_xor00_resources),
+	.resource	= msys_xor00_resources,
+	.dev		= {
+		.dma_mask		= &msys_xor_dmamask,
+		.coherent_dma_mask	= DMA_BIT_MASK(32),
+		.platform_data		= &msys_xor00_data,
+	},
+};
+
+static struct resource msys_xor01_resources[] = {
+	[0] = {
+		.start	= IRQ_AURORA_XOR01,
+		.end	= IRQ_AURORA_XOR01,
+		.flags	= IORESOURCE_IRQ,
+	},
+};
+
+static struct mv_xor_platform_data msys_xor01_data = {
+	.shared		= &msys_xor0_shared,
+	.hw_id		= 1,
+	.pool_size	= PAGE_SIZE,
+};
+
+static struct platform_device msys_xor01_channel = {
+	.name		= MV_XOR_NAME,
+	.id		= 1,
+	.num_resources	= ARRAY_SIZE(msys_xor01_resources),
+	.resource	= msys_xor01_resources,
+	.dev		= {
+		.dma_mask		= &msys_xor_dmamask,
+		.coherent_dma_mask	= DMA_BIT_MASK(32),
+		.platform_data		= &msys_xor01_data,
+	},
+};
+
+static void __init msys_xor0_init(void)
+{
+	platform_device_register(&msys_xor0_shared);
+
+	/*
+	 * two engines can't do memset simultaneously, this limitation
+	 * satisfied by removing memset support from one of the engines.
+	 */
+	dma_cap_set(DMA_MEMCPY, msys_xor00_data.cap_mask);
+	dma_cap_set(DMA_XOR, msys_xor00_data.cap_mask);
+	platform_device_register(&msys_xor00_channel);
+
+	dma_cap_set(DMA_MEMCPY, msys_xor01_data.cap_mask);
+	dma_cap_set(DMA_MEMSET, msys_xor01_data.cap_mask);
+	dma_cap_set(DMA_XOR, msys_xor01_data.cap_mask);
+	platform_device_register(&msys_xor01_channel);
+}
+#endif /* CONFIG_MV_INCLUDE_XOR */
 
 static void cpu_fabric_common_init(void)
 {
@@ -591,6 +700,10 @@ static void __init msys_bc2_rd_init(void)
 	serial_initialize(CONFIG_MV_UART_PORT);
 #endif
 
+#ifdef CONFIG_MV_INCLUDE_XOR
+	msys_xor0_init();
+#endif
+
 	/* At this point, the CPU windows are configured according to default definitions in mvSysHwConfig.h */
 	/* and cpuAddrWinMap table in mvCpuIf.c. Now it's time to change defaults for each platform.         */
 	mvCpuIfAddDecShow();
diff --git a/arch/arm/mach-msys/include/mach/msys.h b/arch/arm/mach-msys/include/mach/msys.h
index bcbc884..f624f77 100644
--- a/arch/arm/mach-msys/include/mach/msys.h
+++ b/arch/arm/mach-msys/include/mach/msys.h
@@ -185,10 +185,8 @@ disclaimer.
 /*
  * Linux native definitiotns
  */
-#define XOR0_PHYS_BASE				(INTER_REGS_PHYS_BASE | 0x60900)
-#define XOR1_PHYS_BASE				(INTER_REGS_PHYS_BASE | 0xF0900)
-#define XOR0_HIGH_PHYS_BASE			(INTER_REGS_PHYS_BASE | 0x60B00)
-#define XOR1_HIGH_PHYS_BASE			(INTER_REGS_PHYS_BASE | 0xF0B00)
+#define XOR0_PHYS_BASE				(INTER_REGS_PHYS_BASE | 0xF0800)
+#define XOR0_HIGH_PHYS_BASE			(INTER_REGS_PHYS_BASE | 0xF0A00)
 
 #define MSYS_NFC_PHYS_BASE			(INTER_REGS_PHYS_BASE | 0xD0000)
 
diff --git a/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.c
index 120766d..ce9b42c 100644
--- a/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvLib.c
@@ -100,7 +100,7 @@ MV_UNIT_ID mvCtrlSocUnitNums[MAX_UNITS_ID][1] = {
 /* DRAM_UNIT_ID         */ { 1, },
 /* PEX_UNIT_ID          */ { 1, },
 /* ETH_GIG_UNIT_ID      */ { 2, },
-/* XOR_UNIT_ID          */ { 2, },
+/* XOR_UNIT_ID          */ { 1, },
 /* UART_UNIT_ID         */ { 2, },
 /* SPI_UNIT_ID          */ { 2, },
 /* SDIO_UNIT_ID         */ { 1, },
diff --git a/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h
index 5e91cfa..f78d5a5 100644
--- a/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-msys/msys_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -110,7 +110,7 @@ extern "C" {
 			(pexIf < 8 ? (0x40000 + ((pexIf) / 4) * 0x40000 + ((pexIf) % 4) * 0x4000)\
 	: (0X42000 + ((pexIf) % 8) * 0x40000))
 #define MV_USB_REGS_OFFSET(dev)			(0x50000 + (dev * 0x1000))
-#define MV_XOR_REGS_OFFSET(unit)		(0xF0000)
+#define MV_XOR_REGS_OFFSET(unit)		(0xF0800)
 #if defined(MV_INCLUDE_IDMA)
 #define MV_IDMA_REGS_OFFSET			(0x60800)
 #endif
-- 
1.7.5.4

