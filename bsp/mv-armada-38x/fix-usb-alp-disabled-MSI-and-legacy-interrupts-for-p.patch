From c421d1524a0f345ebbb7d56b8cf9522a083a0aca Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Tue, 22 Oct 2013 17:44:49 +0200
Subject: [PATCH 1054/1825] fix: usb: alp: disabled MSI and legacy interrupts
 for platform device

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit ba08e491c5301bcf1d44d2ed98792af92ec2869a

	As a part of the kernel rebase to 3.4.59, MSI interrupts were enabled,
	and when MSI intertups are not availabale, a fall back to legacy interrupts was added.
	(commit d581bb3819c5cda33531a0a67c02dbdb7d61f307 - USB: xhci: correctly enable interrupts)

	Since USB3.0 IP is internal platform device, it doesn't support external MSI interrupts.
	the current patch fixes the above changes and doesn't try to enable MSI PCI interrupts,
	or to fallback to legacy in case of failure

Signed-off-by: Omri Itach <omrii@marvell.com>

Change-Id: I039e6afab4d0c02618617fce8b7eca9c8cda682c
Reviewed-on: http://vgitil04.il.marvell.com:8080/3824
Reviewed-by: Igor Patrik <igorp@marvell.com>
Tested-by: Igor Patrik <igorp@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/usb/host/xhci.c |    9 +++++----
 1 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/drivers/usb/host/xhci.c b/drivers/usb/host/xhci.c
index 7299a06..f802bb7 100644
--- a/drivers/usb/host/xhci.c
+++ b/drivers/usb/host/xhci.c
@@ -354,11 +354,13 @@ static int xhci_try_enable_msi(struct usb_hcd *hcd)
 
 	pdev = to_pci_dev(xhci_to_hcd(xhci)->self.controller);
 	/*
-	 * Some Fresco Logic host controllers advertise MSI, but fail to
-	 * generate interrupts.  Don't even try to enable MSI.
+	 * - Some Fresco Logic host controllers advertise MSI, but fail to
+	 *   generate interrupts.  Don't even try to enable MSI.
+	 * - With internal platform device, there is no need to try to enable MSI interrupts
+	 *   and no need to fallback to legacy irq instead, when XHCI_BROKEN_MSI is set.
 	 */
 	if (xhci->quirks & XHCI_BROKEN_MSI)
-		goto legacy_irq;
+		return 0;
 
 	/* unregister the legacy interrupt */
 	if (hcd->irq)
@@ -379,7 +381,6 @@ static int xhci_try_enable_msi(struct usb_hcd *hcd)
 		return -EINVAL;
 	}
 
- legacy_irq:
 	/* fall back to legacy interrupt*/
 	ret = request_irq(pdev->irq, &usb_hcd_irq, IRQF_SHARED,
 			hcd->irq_descr, hcd);
-- 
1.7.5.4

