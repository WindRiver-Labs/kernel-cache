From 34889542e5f3d6fbef4363838c993c2b0bc2aa4b Mon Sep 17 00:00:00 2001
From: Yoni Farhadian <yonif@marvell.com>
Date: Wed, 24 Jul 2013 09:52:30 +0300
Subject: [PATCH 0888/1825] PPv2: support GRO

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit ecc5dace6ce189c19dd139ec36f4ce390f54ce8c

	- Add GRO support
	- Can be changed via Ethtool

Change-Id: Ib8994b9759e63640fcae3f4326a80a53fdb71f06
Signed-off-by: Yoni Farhadian <yonif@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/2819
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |   10 +++++++++-
 1 files changed, 9 insertions(+), 1 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index 97cf94d..eac014f 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -1800,6 +1800,14 @@ static inline int mv_eth_rx(struct eth_port *pp, int rx_todo, int rxq, struct na
 			skb->protocol = eth_type_trans(skb, dev);
 		}
 
+		if (skb && (dev->features & NETIF_F_GRO)) {
+			STAT_DBG(pp->stats.rx_gro++);
+			STAT_DBG(pp->stats.rx_gro_bytes += skb->len);
+
+			rx_status = napi_gro_receive(napi, skb);
+			skb = NULL;
+		}
+
 		if (skb) {
 			STAT_DBG(pp->stats.rx_netif++);
 			rx_status = netif_receive_skb(skb);
@@ -3844,7 +3852,7 @@ void mv_eth_config_show(void)
 void mv_eth_netdev_init_features(struct net_device *dev)
 {
 	dev->features = NETIF_F_RXCSUM | NETIF_F_IP_CSUM | NETIF_F_SG | NETIF_F_LLTX;
-	dev->hw_features = NETIF_F_RXCSUM | NETIF_F_IP_CSUM | NETIF_F_SG;
+	dev->hw_features = NETIF_F_GRO | NETIF_F_RXCSUM | NETIF_F_IP_CSUM | NETIF_F_SG;
 
 #ifdef CONFIG_MV_ETH_TSO
 	dev->features |= NETIF_F_TSO;
-- 
1.7.5.4

