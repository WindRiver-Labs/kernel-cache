From 999db49f0153516c9b717262ee9709ec8b417929 Mon Sep 17 00:00:00 2001
From: Eli Nidam <elini@marvell.com>
Date: Mon, 25 Nov 2013 10:57:33 +0200
Subject: [PATCH 1154/1825] a38x: support S@R test mode bit

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 14c74138cd68c7f77aae39564136c5a9ff0f47c6

	Reset MPP19 when S@R test mode bit is set.

Change-Id: Ifa0867723333d60d7c83b34a8473295b861cff4b
Signed-off-by: Eli Nidam <elini@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4449
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Tawfik Bayouk <tawfik@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/boardEnv/mvBoardEnvLib.c     |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
index d95ca14..3db0ac2 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
@@ -819,6 +819,7 @@ MV_VOID mvBoardInfoUpdate(MV_VOID)
 	MV_BOARD_CONFIG_TYPE_INFO configInfo;
 	int i;
 	MV_BOARD_BOOT_SRC bootSrc;
+	MV_U32	reg;
 
 
 	/*Read all TWSI board module if exsist : */
@@ -843,6 +844,14 @@ MV_VOID mvBoardInfoUpdate(MV_VOID)
 	/* Update MPP group types and values according to board configuration */
 	mvBoardMppIdUpdate();
 	mvBoardEthComplexInfoUpdate();
+	/* board on test mode  */
+	reg = MV_REG_READ(MPP_SAMPLE_AT_RESET) & BIT20;
+	if (reg) {
+		/* if board on test mode reset MPP19 */
+		reg = mvBoardMppGet(2);
+		reg &= 0xffff0fff;
+		mvBoardMppSet(2, reg);
+	}
 }
 /*******************************************************************************
 * mvBoardIsModuleConnected
-- 
1.7.5.4

