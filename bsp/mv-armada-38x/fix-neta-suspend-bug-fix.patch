From 43d9521d15812e3553c827060e4dbcc455b5955c Mon Sep 17 00:00:00 2001
From: Uri Eliyahu <uriel@marvell.com>
Date: Sun, 20 Oct 2013 13:23:11 +0200
Subject: [PATCH 1030/1825] fix: neta: suspend bug fix

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit ab921e2e355e630c7203d71543e7e8e5bd95f5a5

	- Bug fix: try to suspend each port more than once
	  suspend/ resume called for each platform device
	  ports loop in suspend/resume functions was unnecessary

Change-Id: I4a1df0a9e3b948d23650223de09ce385df378765
Signed-off-by: Uri Eliyahu <uriel@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c     |   78 +++++++++-----------
 1 files changed, 35 insertions(+), 43 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
index 8f4bdfd..a7741d0 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
@@ -6146,40 +6146,38 @@ MV_BOOL mv_pon_link_status(void)
 int mv_eth_suspend(struct platform_device *pdev, pm_message_t state)
 {
 	struct eth_port *pp;
-	int port;
+	int port = pdev->id;
 
 	pm_flag = 0;
 
-	for (port = 0 ; port < CONFIG_MV_ETH_PORTS_NUM ; port++) {
-		pp = mv_eth_port_by_id(port);
-		if (!pp)
-			continue;
-		if (pp->wol_mode == 0) {
-			if (mv_eth_port_suspend(port)) {
-				printk(KERN_ERR "%s: port #%d suspend failed.\n", __func__, port);
-				return MV_ERROR;
-			}
+	pp = mv_eth_port_by_id(port);
+	if (!pp)
+		return 0;
 
-			/* BUG WA - if port 0 clock is down, we cant interrupt by magic packet */
-			if ((port != 0) || (wol_ports_bmp == 0))
-				/* Set Port Power State to 0 */
-				mvCtrlPwrClckSet(ETH_GIG_UNIT_ID, port, 0);
+	if (pp->wol_mode == 0) {
+		if (mv_eth_port_suspend(port)) {
+			printk(KERN_ERR "%s: port #%d suspend failed.\n", __func__, port);
+			return MV_ERROR;
 		}
 
-		else {
+		/* BUG WA - if port 0 clock is down, we can't interrupt by magic packet */
+		if ((port != 0) || (wol_ports_bmp == 0))
+			/* Set Port Power State to 0 */
+			mvCtrlPwrClckSet(ETH_GIG_UNIT_ID, port, 0);
+	} else {
 
 #ifdef CONFIG_MV_ETH_PNC_WOL
-			if (pp->flags & MV_ETH_F_STARTED)
-				if (mv_eth_wol_sleep(port)) {
-					printk(KERN_ERR "%s: port #%d  WOL failed.\n", __func__, port);
-					return MV_ERROR;
-				}
+		if (pp->flags & MV_ETH_F_STARTED)
+			if (mv_eth_wol_sleep(port)) {
+				printk(KERN_ERR "%s: port #%d  WOL failed.\n", __func__, port);
+				return MV_ERROR;
+			}
 #else
-			printk(KERN_INFO "%s:WARNING port #%d in WOL mode but PNC WOL is not defined.\n", __func__, port);
+		printk(KERN_INFO "%s:WARNING port #%d in WOL mode but PNC WOL is not defined.\n", __func__, port);
 
 #endif /*CONFIG_MV_ETH_PNC_WOL*/
-		}
 	}
+
 	return MV_OK;
 }
 
@@ -6187,35 +6185,29 @@ int mv_eth_suspend(struct platform_device *pdev, pm_message_t state)
 int mv_eth_resume(struct platform_device *pdev)
 {
 	struct eth_port *pp;
-	int port;
+	int port = pdev->id;
 
 	pm_flag = 0;
 
-	for (port = 0 ; port < CONFIG_MV_ETH_PORTS_NUM ; port++) {
-		pp = mv_eth_port_by_id(port);
-		if (!pp)
-			continue;
+	pp = mv_eth_port_by_id(port);
+	if (!pp)
+		return 0;
 
-		if (pp->wol_mode == 0) {
-			/* Set Port Power State to 1 */
-			mvCtrlPwrClckSet(ETH_GIG_UNIT_ID, port, 1);
-			mdelay(10);
-			if (mv_eth_port_resume(port)) {
-				printk(KERN_ERR "%s: port #%d resume failed.\n", __func__, port);
-				return MV_ERROR;
-			}
-		} else
+	if (pp->wol_mode == 0) {
+		/* Set Port Power State to 1 */
+		mvCtrlPwrClckSet(ETH_GIG_UNIT_ID, port, 1);
+		mdelay(10);
+		if (mv_eth_port_resume(port)) {
+			printk(KERN_ERR "%s: port #%d resume failed.\n", __func__, port);
+			return MV_ERROR;
+		}
+	} else
 #ifdef CONFIG_MV_ETH_PNC_WOL
-			mv_eth_wol_wakeup(port);
+		mv_eth_wol_wakeup(port);
 #else
-			printk(KERN_ERR "%s:WARNING port #%d in WOL mode but PNC WOL is not defined.\n", __func__, port);
+		printk(KERN_ERR "%s:WARNING port #%d in WOL mode but PNC WOL is not defined.\n", __func__, port);
 #endif /*CONFIG_MV_ETH_PNC_WOL*/
 
-	}
-
-	if (pp->tagged)
-		mv_mux_eth_detach(pp->port);
-
 	return MV_OK;
 }
 
-- 
1.7.5.4

