From b2e910713e1e33bc9fd9a3dcc7b4c109c370897e Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Thu, 5 Dec 2013 10:24:07 -0500
Subject: [PATCH 1192/1825] fix: pp2: Use correct function to mask/unmask
 interrupts

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 0a53a271234585c7aa942bf5c209f9078a760fcb

	- function smp_call_function_many() can be called only
	when preemption disabled.
	- Correct function to use is on_each_cpu()

Signed-off-by: Dmitri Epshtein <dima@marvell.com>

Change-Id: I73136ac73f56d6ad1ab57914adae678c38327eaa
Reviewed-on: http://vgitil04.il.marvell.com:8080/4599
Reviewed-by: Yelena Krivosheev <yelena@marvell.com>
Reviewed-by: Uri Eliyahu <uriel@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Igor Patrik <igorp@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4644
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c    |    6 ++----
 1 files changed, 2 insertions(+), 4 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c
index b0f2b8a..24a8ce0 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c
@@ -98,8 +98,7 @@ int mv_eth_start(struct net_device *dev)
 		}
 
 		/* unmask interrupts */
-		mv_eth_interrupts_unmask(priv);
-		smp_call_function_many(cpu_online_mask, (smp_call_func_t)mv_eth_interrupts_unmask, (void *)priv, 1);
+		on_each_cpu(mv_eth_interrupts_unmask, priv, 1);
 
 		/* Enable interrupts for all CPUs */
 		mvPp2GbeCpuInterruptsEnable(priv->port, priv->cpuMask);
@@ -142,8 +141,7 @@ int mv_eth_stop(struct net_device *dev)
 	/* Disable interrupts for all CPUs */
 	mvPp2GbeCpuInterruptsDisable(priv->port, priv->cpuMask);
 
-	mv_eth_interrupts_mask(priv);
-	smp_call_function_many(cpu_online_mask, (smp_call_func_t)mv_eth_interrupts_mask, (void *)priv, 1);
+	on_each_cpu(mv_eth_interrupts_mask, priv, 1);
 
 	/* make sure that the port finished its Rx polling */
 	for (group = 0; group < MV_ETH_MAX_RXQ; group++)
-- 
1.7.5.4

