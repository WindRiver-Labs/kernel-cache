From 4e3aa155b3a4dfa00fce5048ffe24e7ffd8d35ec Mon Sep 17 00:00:00 2001
From: Shadi Ammouri <shadi@marvell.com>
Date: Mon, 2 Dec 2013 13:19:24 +0200
Subject: [PATCH 1176/1825] a38x: timer: Fix twd base timer

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 336c44f3c91265ab96df619f6d9ef797b386c022

	Set correct value for twd timer, as L2 clock and not
	25MHz fixed clock.

Change-Id: I08c5db95c44089a939824c0e62ae98d9a20f5a3f
Signed-off-by: Shadi Ammouri <shadi@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4549
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Igor Patrik <igorp@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-armada38x/time.c |    8 ++------
 1 files changed, 2 insertions(+), 6 deletions(-)

diff --git a/arch/arm/mach-armada38x/time.c b/arch/arm/mach-armada38x/time.c
index 8e7ebd7..277b989 100644
--- a/arch/arm/mach-armada38x/time.c
+++ b/arch/arm/mach-armada38x/time.c
@@ -51,9 +51,6 @@ static int source_timer_id;
 /*
  * Timer rate/frequency for ARM CA9 timers and Marvell SoC timers.
  */
-static u32 ca9_twd_rate; /* CA9 internal timer */
-static u32 mv_twd_rate;  /* Marvell SoC timer  */
-
 static u32 ticks_per_jiffy;
 
 
@@ -202,7 +199,6 @@ static void __init a38x_twd_init(void)
 	if (err)
 		pr_err("twd_local_timer_register failed %d\n", err);
 
-	clk_twd_lookup.clk->rate = ca9_twd_rate;
 	clkdev_add(&clk_twd_lookup);
 }
 #else
@@ -263,8 +259,8 @@ static void __init a38x_timer_init(void)
 {
 	u32 rate;
 
-	ca9_twd_rate = A38X_TIMER_RATE;
-	rate = ca9_twd_rate / 2;
+	clk_twd_lookup.clk->rate = mvCpuL2ClkGet();
+	rate = A38X_TIMER_RATE;
 
 	printk(KERN_INFO "Initializing Armada-38x SoC Timers\n");
 	ticks_per_jiffy = (rate + HZ / 2) / HZ;
-- 
1.7.5.4

