From 8954b0efe11147784c006d5d0cd3980dbf7c52d2 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Tue, 16 Jul 2013 11:20:07 +0300
Subject: [PATCH 0854/1825] alp: Added support for SLIC/TDM & SPI1 with
 DIP-Switch board configuration

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 78dd4b0ce297b130766e3d41745af09db7760ed3

	- Added SPI1 MPP's settings for external TDM usage
	- Added error handling for invalid TDM configuration (RGMII-1 overrides external TDM)
	- re-ordered MPP update routine, to be called after reading SLIC/TDM configuration
	- Added TDM/SLIC mode print, to indicate selected configuration
	- updated mvCtrlSmiMasterSet to set SMI MPP's according to SPI1 detection
	- Fixed MPP's false values for SPI1

Change-Id: Ibe73da3db332947222825614f6a79db6e95e1baf
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/2669
Reviewed-by: Kosta Zertsekel <konszert@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   65 ++++++++++++++------
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    5 +-
 .../avanta_lp_family/boardEnv/mvBoardEnvSpec.c     |    8 +-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   27 ++++++---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |   17 +++--
 5 files changed, 81 insertions(+), 41 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index a8a5222..ca0ad2a 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -767,6 +767,12 @@ MV_U32 mvBoardSlicUnitTypeGet(MV_VOID)
 *******************************************************************************/
 MV_VOID mvBoardSlicUnitTypeSet(MV_U32 slicType)
 {
+	if (slicType >= MV_BOARD_SLIC_MAX_OPTION) {
+		mvOsPrintf("%s: Error: Unsupported SLIC/TDM configuration selected (%x)\n",
+				__func__, slicType);
+		slicType = MV_BOARD_SLIC_DISABLED;
+	}
+
 	board->pBoardModTypeValue->boardMppSlic = slicType;
 }
 /*******************************************************************************
@@ -893,11 +899,16 @@ MV_VOID mvBoardInfoUpdate(MV_VOID)
 	mvBoardPhyAddrSet(1, smiAddress);
 	mvBoardMacSpeedSet(1, macSpeed);
 
-	/* Update MPP group types and values according to board configuration */
-	mvBoardMppIdUpdate();
-
+	/* Update SLIC device configuration */
 	slicDev = mvCtrlSysConfigGet(MV_CONFIG_SLIC_TDM_DEVICE);
+	if (slicDev == SLIC_EXTERNAL_ID && (ethComplex & MV_ETHCOMP_GE_MAC1_2_RGMII1))
+		mvOsPrintf("%s: Error: board configuration conflict between MAC1 to RGMII-1, " \
+				"and External TDM - using RGMII-1 (disabled External TDM)\n\n", __func__);
+
 	mvBoardSlicUnitTypeSet(slicDev);
+
+	/* Update MPP group types and values according to board configuration */
+	mvBoardMppIdUpdate();
 }
 
 /*******************************************************************************
@@ -934,15 +945,19 @@ MV_VOID mvBoardMppIdUpdate(MV_VOID)
 
 	/* Groups 3-4  - (only if not Booting from SPI1)*/
 	if (bootDev != MSAR_0_BOOT_SPI1_FLASH) {
-		if (ethComplexOptions & MV_ETHCOMP_GE_MAC1_2_RGMII1)
+		if (ethComplexOptions & MV_ETHCOMP_GE_MAC1_2_RGMII1) {
 			mvBoardMppTypeSet(3, GE1_UNIT);
-		else
-			mvBoardMppTypeSet(3, SDIO_UNIT);
-
-		if (slicDev == SLIC_LANTIQ_ID)
-			mvBoardMppTypeSet(4, GE1_CPU_SMI_CTRL_TDM_LQ_UNIT);
-		else /* REF_CLK_OUT */
-			mvBoardMppTypeSet(4, GE1_CPU_SMI_CTRL_REF_CLK_OUT);
+			if (slicDev == SLIC_LANTIQ_ID)
+				mvBoardMppTypeSet(4, GE1_CPU_SMI_CTRL_TDM_LQ_UNIT);
+			else /* REF_CLK_OUT */
+				mvBoardMppTypeSet(4, GE1_CPU_SMI_CTRL_REF_CLK_OUT);
+		} else { /* if RGMII-1 isn't used, set SPI1 MPP's */
+			mvBoardMppTypeSet(3, SDIO_SPI1_UNIT);
+			if (slicDev == SLIC_LANTIQ_ID)
+				mvBoardMppTypeSet(4, SPI1_CPU_SMI_CTRL_TDM_LQ_UNIT);
+			else /* REF_CLK_OUT */
+				mvBoardMppTypeSet(4, SPI1_CPU_SMI_CTRL_REF_CLK_OUT);
+		}
 	}
 
 	/* Groups 5-6-7 Set GE0 or Switch port 4 */
@@ -1642,13 +1657,12 @@ MV_U8 mvBoardTdmSpiCsGet(MV_U8 devId)
 *******************************************************************************/
 MV_VOID mvBoardConfigurationPrint(MV_VOID)
 {
-	MV_U32 ethConfig = mvBoardEthComplexConfigGet();
 	char *lane1[] = {"PCIe1", "SGMII-0", "SATA-1", "Invalid Configuration" };
-	mvOsOutput("Board configuration:\n");
+	char *tdmSlic[] = {"None", "SSI", "ISI", "ZSI", "TDM"};
+	MV_U32 boardID, slicDevice, ethConfig = mvBoardEthComplexConfigGet();
 
-	/* TDM */
-	if (mvBoardTdmDevicesCountGet() > 0)
-		mvOsOutput("       TDM module.\n");
+	boardID = mvBoardIdGet();
+	mvOsOutput("\nBoard configuration:\n");
 
 	/* LCD DVI Module */
 	if (mvBoardIsLcdDviModuleConnected())
@@ -1703,16 +1717,27 @@ MV_VOID mvBoardConfigurationPrint(MV_VOID)
 			mvOsOutput("       GE-PHY-3 Module on Switch port #3\n");
 	}
 
+	/* TDM / Slic configuration */
+	slicDevice = mvBoardSlicUnitTypeGet();
+	if (slicDevice < MV_BOARD_SLIC_MAX_OPTION) /* 4 supported configurations */
+		mvOsOutput("       TDM/SLIC: %s\n", tdmSlic[slicDevice]);
+	else
+		mvOsOutput("       TDM/SLIC: Unsupported configuration\n");
+
+	/* SERDES lanes configuration is relevant only to DB board */
+	if (boardID != DB_6660_ID && boardID != DB_6650_ID)
+		return;
+
 	/* SERDES Lanes*/
-	mvOsOutput("SERDES configuration:\n");
+	mvOsOutput("\nSERDES configuration:\n");
 	mvOsOutput("       Lane #0: PCIe0\n");
 
-	/* rest of SERDES lanes are relevant only to DB-6660 board */
-	if (mvBoardIdGet() != DB_6660_ID)
+	/* SERDES lanes #1,#2,#3 are relevant only to DB-6660 board */
+	if (boardID != DB_6660_ID)
 		return;
 
 	mvOsOutput("       Lane #1: %s\n", lane1[mvCtrlSysConfigGet(MV_CONFIG_LANE1)]);
-	mvOsOutput("       Lane #2: %s\n", mvCtrlSysConfigGet(MV_CONFIG_LANE2) ? "SATA-0" : "SGMII-0");
+	mvOsOutput("       Lane #2: %s\n", mvCtrlSysConfigGet(MV_CONFIG_LANE2) ? "SGMII-0" : "SATA-0");
 	mvOsOutput("       Lane #3: %s\n", mvCtrlSysConfigGet(MV_CONFIG_LANE3) ? "SGMII-0" : "USB3");
 
 }
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index 26cb1c9..21ad4aa 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -85,11 +85,12 @@ extern "C" {
 #define MV_BOARD_NAME_LEN               0x20
 
 typedef enum _devBoardSlicType {
-	MV_BOARD_AUTO,
+	MV_BOARD_SLIC_DISABLED,
 	MV_BOARD_SLIC_SSI_ID, /* Lantiq Integrated SLIC */
 	MV_BOARD_SLIC_ISI_ID, /* Silicon Labs ISI Bus */
 	MV_BOARD_SLIC_ZSI_ID, /* Zarlink ZSI Bus */
-	MV_BOARD_SLIC_EXTERNAL_ID /* Cross vendor external SLIC */
+	MV_BOARD_SLIC_EXTERNAL_ID, /* Cross vendor external SLIC */
+	MV_BOARD_SLIC_MAX_OPTION
 } MV_BOARD_SLIC_TYPE;
 
 typedef enum _devBoardOtherTypeClass {
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
index 461c30d..a08899d 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
@@ -182,7 +182,7 @@ MV_BOARD_MAC_INFO db88f6660InfoBoardMacInfo[] = {
 };
 MV_BOARD_MPP_TYPE_INFO db88f6660InfoBoardModTypeInfo[] = {
 	{
-		.boardMppSlic = MV_BOARD_AUTO,
+		.boardMppSlic = MV_BOARD_SLIC_DISABLED,
 		.ethSataComplexOpt = MV_ETHCOMP_SW_P0_2_GE_PHY_P0 |
 				     MV_ETHCOMP_SW_P1_2_GE_PHY_P1 |
 				     MV_ETHCOMP_SW_P2_2_GE_PHY_P2 |
@@ -294,7 +294,7 @@ MV_BOARD_MAC_INFO db88f6650InfoBoardMacInfo[] = {
 
 MV_BOARD_MPP_TYPE_INFO db88f6650InfoBoardModTypeInfo[] = {
 	{
-		.boardMppSlic = MV_BOARD_AUTO,
+		.boardMppSlic = MV_BOARD_SLIC_DISABLED,
 		.ethSataComplexOpt = MV_ETHCOMP_SW_P0_2_GE_PHY_P0 |
 				     MV_ETHCOMP_SW_P1_2_GE_PHY_P1 |
 				     MV_ETHCOMP_SW_P2_2_GE_PHY_P2 |
@@ -401,7 +401,7 @@ MV_BOARD_MAC_INFO rd88f6650InfoBoardMacInfo[] = {
 };
 MV_BOARD_MPP_TYPE_INFO rd88f6650InfoBoardModTypeInfo[] = {
 	{
-		.boardMppSlic = MV_BOARD_AUTO,
+		.boardMppSlic = MV_BOARD_SLIC_EXTERNAL_ID,
 		.ethSataComplexOpt = MV_ETHCOMP_SW_P0_2_GE_PHY_P0 |
 				     MV_ETHCOMP_SW_P1_2_GE_PHY_P1 |
 				     MV_ETHCOMP_SW_P2_2_GE_PHY_P2 |
@@ -567,7 +567,7 @@ MV_BOARD_MAC_INFO avanta_lp_customerInfoBoardMacInfo[] = {
 
 MV_BOARD_MPP_TYPE_INFO avanta_lp_customerInfoBoardModTypeInfo[] = {
 	{
-		.boardMppSlic = MV_BOARD_AUTO,
+		.boardMppSlic = MV_BOARD_SLIC_DISABLED,
 		.ethSataComplexOpt = 0x0,
 		.ethPortsMode = 0x0
 	}
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 913d24b..8498642 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -438,13 +438,24 @@ MV_U32 mvCtrlSatRRead(MV_SATR_TYPE_ID satrField)
 *******************************************************************************/
 MV_VOID mvCtrlSmiMasterSet(MV_SMI_CTRL smiCtrl)
 {
-	MV_BOOL isSwSMICtrl   = (smiCtrl == SWITCH_SMI_CTRL ? MV_TRUE : MV_FALSE);
-	MV_BOOL isBootDevSPI1 = (MSAR_0_BOOT_SPI1_FLASH == mvBoardBootDeviceGet());
-	MV_BOOL isRefClkOut   = !( mvBoardSlicUnitTypeGet() == SLIC_LANTIQ_ID ); 	/* if not using Lantiq TDM, define REF_CLK_OUT */
-	MV_U8 groupTypeSelect = 0;
+	MV_BOOL isSPI1Enabled, isRefClkOut;
+	MV_U32 slicDev, ethComplex, groupTypeSelect = 0;
 
-	if (! ((smiCtrl == SWITCH_SMI_CTRL) || (smiCtrl == CPU_SMI_CTRL)) ) {
-		DB(mvOsPrintf("mvCtrlSMISet: SMI ctrl initialize failed\n"));
+	ethComplex = mvBoardEthComplexConfigGet();
+	slicDev = mvBoardSlicUnitTypeGet();
+
+	/* if not using Lantiq TDM, define REF_CLK_OUT (both utilize the same gpio) */
+	isRefClkOut   = !(slicDev == SLIC_LANTIQ_ID);
+
+	/*SPI1 in use: if enabled external SLI and disabled RGMII-1, or boot from SPI1*/
+	if ((slicDev == SLIC_EXTERNAL_ID && !(ethComplex & MV_ETHCOMP_GE_MAC1_2_RGMII1))
+			|| mvBoardBootDeviceGet() == MSAR_0_BOOT_SPI1_FLASH)
+		isSPI1Enabled = MV_TRUE;
+	else
+		isSPI1Enabled = MV_FALSE;
+
+	if (!((smiCtrl == SWITCH_SMI_CTRL) || (smiCtrl == CPU_SMI_CTRL))) {
+		mvOsPrintf("mvCtrlSMISet: SMI ctrl initialize failed\n");
 		return;
 	}
 
@@ -454,10 +465,10 @@ MV_VOID mvCtrlSmiMasterSet(MV_SMI_CTRL smiCtrl)
 	if (isRefClkOut)	/* add first REF_CLK_OUT group type */
 		groupTypeSelect += GE1_CPU_SMI_CTRL_REF_CLK_OUT;
 
-	if (isSwSMICtrl)	/* add first SW_SMI group type */
+	if (smiCtrl == SWITCH_SMI_CTRL)	/* add first SW_SMI group type */
 		groupTypeSelect += GE1_SW_SMI_CTRL_TDM_LQ_UNIT;
 
-	if (isBootDevSPI1)	/* add first SPI1 group type */
+	if (isSPI1Enabled)	/* add first SPI1 group type */
 		groupTypeSelect += SPI1_CPU_SMI_CTRL_TDM_LQ_UNIT;
 
 	mvBoardMppTypeSet(4, groupTypeSelect);	/* Set MPP value according to group type */
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index 6fc50a9..7f39c68 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -286,6 +286,7 @@ typedef enum {
 #define MV_GROUP_1_TYPE         MV_GROUP_0_TYPE
 
 #define MPP_GROUP_2_TYPE { \
+	0x00000022,     /* SLIC_DISABLED  */ \
 	0x33030022,     /* SLIC_SSI_DEV  */ \
 	0x11110022,     /* SLIC_ISI_DEV  */ \
 	0x44440022,     /* SLIC_ZSI_DEV  */ \
@@ -293,6 +294,7 @@ typedef enum {
 }
 
 typedef enum {
+	SLIC_DISABLED,
 	SLIC_SSI_DEV,
 	SLIC_ISI_DEV,
 	SLIC_ZSI_DEV,
@@ -318,10 +320,10 @@ typedef enum {
 	0x44422222,     /* GE1,  CPU SMI CONTROL,    REF_CLK_OUT */ \
 	0x05522222,     /* GE1,  SWITCH SMI CONTROL, TDM_LQ_UNIT */ \
 	0x45522222,     /* GE1,  SWITCH SMI CONTROL, REF_CLK_OUT */ \
-	0x04423333,     /* SPI1, CPU SMI CONTROL,    TDM_LQ_UNIT */ \
-	0x44423333,     /* SPI1, CPU SMI CONTROL,    REF_CLK_OUT */ \
-	0x05523333,     /* SPI1, SWITCH SMI CONTROL, TDM_LQ_UNIT */ \
-	0x45523333,     /* SPI1, SWITCH SMI CONTROL, REF_CLK_OUT */ \
+	0x04423330,     /* SPI1, CPU SMI CONTROL,    TDM_LQ_UNIT */ \
+	0x44423330,     /* SPI1, CPU SMI CONTROL,    REF_CLK_OUT */ \
+	0x05523330,     /* SPI1, SWITCH SMI CONTROL, TDM_LQ_UNIT */ \
+	0x45523330,     /* SPI1, SWITCH SMI CONTROL, REF_CLK_OUT */ \
 }
 
 typedef enum {
@@ -394,10 +396,11 @@ typedef enum {
 
 /* This enumerator defines the Marvell Units ID      */
 typedef enum {
-	SLIC_EXTERNAL_ID,
-	SLIC_ZARLINK_ID,
+	SLIC_NONE_ID,
+	SLIC_LANTIQ_ID,
 	SLIC_SILABS_ID,
-	SLIC_LANTIQ_ID
+	SLIC_ZARLINK_ID,
+	SLIC_EXTERNAL_ID
 } MV_SLIC_UNIT_TYPE;
 
 typedef enum {
-- 
1.7.5.4

