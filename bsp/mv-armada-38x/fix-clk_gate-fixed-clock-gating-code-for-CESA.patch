From 1cf3126ea6fcf2d426e9ecb789331a0f2ec82ee4 Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Thu, 1 May 2014 13:26:40 +0300
Subject: [PATCH 1605/1825] fix: clk_gate: fixed clock gating code for CESA

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 78ef5bd328f6ed6fa436460c9ba82c4c5ef42419

	The original code performed AND operation with zero then
	compared it to 0 which is always true, causing the CESA to be
	always off. The fix performs AND with the mask and compares it
	to the mask since CESA has 2 clock gating bits

Change-Id: I957567788f26480609d3e8e5c3df905653e43018
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/7783
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |    8 +++++---
 1 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 0a2459d..c1a2ad3 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -2189,10 +2189,12 @@ MV_BOOL mvCtrlPwrClckGet(MV_UNIT_ID unitId, MV_U32 index)
 						__func__, mvCtrlRevGet(), mvCtrlCesaMaxChanGet());
 			break;
 		}
-		if ((reg & PMC_CESA_STOP_CLK_STOP(index)) == PMC_CESA_STOP_CLK_STOP(index))
-			state = MV_FALSE;
-		else
+
+		/* Check if both CESA clocks are enabled -> Compare to mask*/
+		if ((reg & PMC_CESA_STOP_CLK_MASK(index)) == PMC_CESA_STOP_CLK_MASK(index))
 			state = MV_TRUE;
+		else
+			state = MV_FALSE;
 		break;
 #endif
 	default:
-- 
1.7.5.4

