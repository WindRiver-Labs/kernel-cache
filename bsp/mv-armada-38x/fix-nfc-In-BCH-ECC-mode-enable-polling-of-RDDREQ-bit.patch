From ebc5d1e9df6d27c3bf453149ab22e4906cf3a787 Mon Sep 17 00:00:00 2001
From: Nadav Haklai <nadavh@marvell.com>
Date: Sun, 8 Dec 2013 10:53:26 +0200
Subject: [PATCH 1207/1825] fix: nfc: In BCH ECC mode enable polling of RDDREQ
 bit during read operations

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 1b0fe5ad834fcbbfecd46b2da95ef90320d19738

	According to FS in BCH ECC mode the processor must check if the RDDREQ
	bit is set after each 32 bytes read from NDDB.

	Fix for SYSTEMSW-58 "BCH + ECC chunk read does not poll NDSR.RDDREQ"

Change-Id: I9363ae92a61c3c44d65847afa482630813f011b3
Signed-off-by: Marcin Wojtas <mw@semihalf.com>
Signed-off-by: Nadav Haklai <nadavh@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4628
Reviewed-by: Tawfik Bayouk <tawfik@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4703
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/mv_hal/nfc/mvNfc.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/nfc/mvNfc.c b/arch/arm/plat-armada/mv_hal/nfc/mvNfc.c
index 4451305..272a9f7 100644
--- a/arch/arm/plat-armada/mv_hal/nfc/mvNfc.c
+++ b/arch/arm/plat-armada/mv_hal/nfc/mvNfc.c
@@ -2025,6 +2025,15 @@ MV_VOID mvNfcReadWritePio(MV_NFC_CTRL *nfcCtrl, MV_U32 *buff, MV_U32 data_len, M
 		for (i = 0; i < data_len; i += 4) {
 			*buff = MV_LE32_TO_CPU(MV_REG_READ(NFC_DATA_BUFF_REG));
 			buff++;
+			/* For BCH ECC check if RDDREQ bit is set every 32 bytes */
+			if (((nfcCtrl->eccMode == MV_NFC_ECC_BCH_2K) ||
+			     (nfcCtrl->eccMode == MV_NFC_ECC_BCH_1K) ||
+			     (nfcCtrl->eccMode == MV_NFC_ECC_BCH_704B) ||
+			     (nfcCtrl->eccMode == MV_NFC_ECC_BCH_512B)) &&
+			     ((i & 0x1f) == 0) && (i > 0)) {
+				if (mvDfcWait4Complete(NFC_SR_RDDREQ_MASK, 10) != MV_OK)
+					break;
+			}
 		}
 		break;
 
-- 
1.7.5.4

