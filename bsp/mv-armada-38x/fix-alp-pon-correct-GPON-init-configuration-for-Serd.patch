From d6c03a5e185ec4e12e89a6c1359510667a217ac8 Mon Sep 17 00:00:00 2001
From: Victor Gu <xigu@marvell.com>
Date: Thu, 10 Jul 2014 12:11:33 +0800
Subject: [PATCH 1776/1825] fix: alp: pon: correct GPON init configuration for
 Serdes.

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 574bdaf1b37bfe668f46f7db2700be6f5f40417d

    According to below setting:
GPON Mode:
after writing 0xfc00 to 0xf1032004:
Set value 0x14 to reg. 0x4D (0xf1032134;
Set 0x10 (rxdigck_div) to bits [7:6] at reg.0x55(0xf1032154);
Set the correct amplitude: value 0xc90c to reg.0xd(0xf1032034)
Signed-off-by: Victor Gu <xigu@marvell.com>

Change-Id: Id39950bf863fa209ff6d0ea551cb449cd71f39cf
Reviewed-on: http://vgitil04.il.marvell.com:8080/9111
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Tested-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pon/plat/gpon/gponOnuBoard.c |   29 +++++++++++++++++---
 arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.c     |    9 ++++--
 arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.h     |   15 ++++++----
 3 files changed, 40 insertions(+), 13 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/plat/gpon/gponOnuBoard.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/plat/gpon/gponOnuBoard.c
index 9a5bd3c..c6d3b73 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/plat/gpon/gponOnuBoard.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/plat/gpon/gponOnuBoard.c
@@ -537,16 +537,37 @@ MV_STATUS onuGponSerdesInit(void)
 
 	/* Internal Regs */
 	/* ============= */
-	/* Set power_reg0	    (0xd0032004 set 0xfc00);recheck bits 7,2,3 */
-	/* Set register	    (0xd0032178 set 0xd543);		       */
-	/* Set register	    (0xd0032148 set 0xf008);		       */
-	/* Loop timing	    (0xd003208c set 0x1400;		       */
+	/* Set power_reg0   (0x00032004 set 0xfc00);recheck bits 7,2,3  */
+	/* Set register     (0x00032134 set 0x14);                      */
+	/* Set register     (0x00032154 set 0x2 to bit[7:6]);           */
+	/* Set register     (0x00032034 set 0xc90c);correct amplitude   */
+	/* Set register     (0x00032178 set 0xd543);                    */
+	/* Set register     (0x00032148 set 0xf008);                    */
+	/* Loop timing      (0x0003208c set 0x1400;                     */
 	status  = asicOntMiscRegWrite(mvAsicReg_PON_SERDES_INTERNAL_POWER_REG_0, 0xFC00, 0);
 	if (status != MV_OK)
 		return status;
 
 	mvOsDelay(20);
 
+	status  = asicOntMiscRegWrite(mvAsicReg_PON_SERDES_INTERNAL_REG_4D, 0x14, 0);
+	if (status != MV_OK)
+		return status;
+
+	mvOsDelay(20);
+
+	status  = asicOntMiscRegWrite(mvAsicReg_PON_SERDES_INTERNAL_REG_55_BIT6_7, 0x2, 0);
+	if (status != MV_OK)
+		return status;
+
+	mvOsDelay(20);
+
+	status  = asicOntMiscRegWrite(mvAsicReg_PON_SERDES_INTERNAL_REG_D, 0xc90c, 0);
+	if (status != MV_OK)
+		return status;
+
+	mvOsDelay(20);
+
 	status  = asicOntMiscRegWrite(mvAsicReg_PON_SERDES_INTERNAL_REG_OFFSET_178, 0xd543, 0);
 	if (status != MV_OK)
 		return status;
diff --git a/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.c b/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.c
index 115a8c5..71c9c8f 100755
--- a/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.c
+++ b/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.c
@@ -711,11 +711,14 @@ S_asicGlobalRegDb asicGlbDb[] =
 	[mvAsicReg_PON_MAC_SW_RESET_CTRL]                 =  { mvAsicReg_PON_MAC_SW_RESET_CTRL,                 0x18258,                         0x18258,  asicRW,     0x00000001,     3,      0,     0,      0,     "Gpon MAC Software Reset Control"},
 
 	[mvAsicReg_PON_SERDES_INTERNAL_POWER_REG_0]       =  { mvAsicReg_PON_SERDES_INTERNAL_POWER_REG_0,       0x32004,                         0x32004,  asicRW,     0x0000FFFF,     0,      0,     0,      0,     "Gpon Serded Internal - Power reg 0"},
-	[mvAsicReg_PON_SERDES_INTERNAL_REG_51]            =  { mvAsicReg_PON_SERDES_INTERNAL_REG_51,            0x32144,                         0x32144,  asicRW,     0x0000FFFF,     0,      0,     0,      0,     "Gpon Serded Internal - Reg 0x51"},
+	[mvAsicReg_PON_SERDES_INTERNAL_REG_D]             =  { mvAsicReg_PON_SERDES_INTERNAL_REG_D,             0x32034,                         0x32034,  asicRW,     0x0000FFFF,     0,      0,     0,      0,     "Gpon Serded Internal - Reg 0xD"},
+	[mvAsicReg_PON_SERDES_INTERNAL_REG_23_LOOP_TIMING] = { mvAsicReg_PON_SERDES_INTERNAL_REG_23_LOOP_TIMING, 0x3208c,                        0x3208c,  asicRW,     0x0000FFFF,     0,      0,     0,      0,     "Gpon Serded Internal - Loop Timing"},
+	[mvAsicReg_PON_SERDES_INTERNAL_REG_26_TX_DRV_IDLE] = { mvAsicReg_PON_SERDES_INTERNAL_REG_26_TX_DRV_IDLE, 0x32098,                        0x32098,  asicRW,     0x0000FFFF,     0,      0,     0,      0,     "Gpon Serded Internal - Tx Driver Idle"},
 	[mvAsicReg_PON_SERDES_INTERNAL_REG_3D]            =  { mvAsicReg_PON_SERDES_INTERNAL_REG_3D,            0x320f4,                         0x320f4,  asicRW,     0x0000FFFF,     0,      0,     0,      0,     "Gpon Serded Internal - Reg 0x3D"},
-	[mvAsicReg_PON_SERDES_INTERNAL_REG_23_LOOP_TIMING] = { mvAsicReg_PON_SERDES_INTERNAL_REG_23_LOOP_TIMING, 0x3208c,                         0x3208c,  asicRW,     0x0000FFFF,     0,      0,     0,      0,     "Gpon Serded Internal - Loop Timing"},
-	[mvAsicReg_PON_SERDES_INTERNAL_REG_26_TX_DRV_IDLE] = { mvAsicReg_PON_SERDES_INTERNAL_REG_26_TX_DRV_IDLE, 0x32098,                         0x32098,  asicRW,     0x0000FFFF,     0,      0,     0,      0,     "Gpon Serded Internal - Tx Driver Idle"},
+	[mvAsicReg_PON_SERDES_INTERNAL_REG_4D]            =  { mvAsicReg_PON_SERDES_INTERNAL_REG_4D,            0x32134,                         0x32134,  asicRW,     0x0000FFFF,     0,      0,     0,      0,     "Gpon Serded Internal - Reg 0x4D"},
+	[mvAsicReg_PON_SERDES_INTERNAL_REG_51]            =  { mvAsicReg_PON_SERDES_INTERNAL_REG_51,            0x32144,                         0x32144,  asicRW,     0x0000FFFF,     0,      0,     0,      0,     "Gpon Serded Internal - Reg 0x51"},
 	[mvAsicReg_PON_SERDES_INTERNAL_REG_OFFSET_148]    =  { mvAsicReg_PON_SERDES_INTERNAL_REG_OFFSET_148,    0x32148,                         0x32148,  asicRW,     0x0000FFFF,     0,      0,     0,      0,     "Gpon Serded Internal - Offse 0x32148"},
+	[mvAsicReg_PON_SERDES_INTERNAL_REG_55_BIT6_7]     =  { mvAsicReg_PON_SERDES_INTERNAL_REG_55_BIT6_7,     0x32154,                         0x32154,  asicRW,     0x00000003,     6,      0,     0,      0,     "Gpon Serded Internal - Reg 0x54 bit6 and bit7"},
 	[mvAsicReg_PON_SERDES_INTERNAL_REG_OFFSET_178]    =  { mvAsicReg_PON_SERDES_INTERNAL_REG_OFFSET_178,    0x32178,                         0x32178,  asicRW,     0x0000FFFF,     0,      0,     0,      0,     "Gpon Serded Internal - Offse 0x32178"},
 
 	[mvAsicReg_PON_XVR_TX_DATA_OUT_17]                =  { mvAsicReg_PON_XVR_TX_DATA_OUT_17,                0x18104,                         0x18104,  asicRW,     0x00000001,    17,      0,     0,      0,     "GPIO 17 data out transmit"},
diff --git a/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.h b/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.h
index d8b19bb..5e55a8c 100755
--- a/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.h
+++ b/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.h
@@ -587,12 +587,15 @@ typedef enum {
 	mvAsicReg_PON_MAC_SW_RESET_CTRL                    = 534,
 
 	mvAsicReg_PON_SERDES_INTERNAL_POWER_REG_0          = 535,
-	mvAsicReg_PON_SERDES_INTERNAL_REG_51               = 536,
-	mvAsicReg_PON_SERDES_INTERNAL_REG_3D               = 537,
-	mvAsicReg_PON_SERDES_INTERNAL_REG_23_LOOP_TIMING   = 538,
-	mvAsicReg_PON_SERDES_INTERNAL_REG_26_TX_DRV_IDLE   = 539,
-	mvAsicReg_PON_SERDES_INTERNAL_REG_OFFSET_148       = 540,
-	mvAsicReg_PON_SERDES_INTERNAL_REG_OFFSET_178       = 541,
+	mvAsicReg_PON_SERDES_INTERNAL_REG_D                = 536,
+	mvAsicReg_PON_SERDES_INTERNAL_REG_23_LOOP_TIMING   = 537,
+	mvAsicReg_PON_SERDES_INTERNAL_REG_26_TX_DRV_IDLE   = 538,
+	mvAsicReg_PON_SERDES_INTERNAL_REG_3D               = 539,
+	mvAsicReg_PON_SERDES_INTERNAL_REG_4D               = 540,
+	mvAsicReg_PON_SERDES_INTERNAL_REG_51               = 541,
+	mvAsicReg_PON_SERDES_INTERNAL_REG_OFFSET_148       = 542,
+	mvAsicReg_PON_SERDES_INTERNAL_REG_55_BIT6_7        = 543,
+	mvAsicReg_PON_SERDES_INTERNAL_REG_OFFSET_178       = 544,
 
 	mvAsicReg_PON_XVR_TX_DATA_OUT_17                   = 550,
 	mvAsicReg_PON_XVR_TX_DATA_OUT_36                   = 551,
-- 
1.7.5.4

