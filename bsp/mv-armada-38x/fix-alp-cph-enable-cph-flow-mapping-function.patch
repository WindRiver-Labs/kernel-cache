From 976edd1643f6a0719c7b0f322bd89209aed54600 Mon Sep 17 00:00:00 2001
From: Ken Ma <make@marvell.com>
Date: Wed, 28 May 2014 15:23:37 +0800
Subject: [PATCH 1692/1825] fix: alp: cph: enable cph flow mapping function

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit e3e16567b44f8ad052e57f5e63d6a070c8ece94e

	- correct the state judgement in cph_data_flow_tx()
	- correct the judgement handling in cph_rx_func()
	SYSTEMSW-576 - <CPH Module does not work even if configured CPH rules>

Signed-off-by: Ken Ma <make@marvell.com>

Change-Id: Ic716fcf82a4cf30e0660145c8537b25d6df0443a
Signed-off-by: Ken Ma <make@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8265
Reviewed-by: Hua Jing <jinghua@marvell.com>
Tested-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/cph/mv_cph_netdev.c      |   11 +++++++----
 1 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cph/mv_cph_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cph/mv_cph_netdev.c
index 0cfc04e..884bd88 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cph/mv_cph_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/cph/mv_cph_netdev.c
@@ -462,7 +462,7 @@ int cph_data_flow_tx(int port, struct net_device *dev, struct sk_buff *skb,
 
 	cph_db_get_param(CPH_DB_PARAM_FLOW_SUPPORT, &state);
 
-	if (state == TRUE)
+	if (state != TRUE)
 		return 0;
 
 	/* Decide whether need to handle Marvell header */
@@ -743,12 +743,14 @@ void cph_rx_func(int port, int rxq, struct net_device *dev,
 	if (mvPp2IsRxSpecial(rx_desc->parserInfo)) {
 		/* Receive application packets */
 		if (cph_app_packet_rx(port, dev, skb, rx_desc))
-			MV_CPH_PRINT(CPH_DEBUG_LEVEL, "Failed to receive application packet\n");
+			return;
+		MV_CPH_PRINT(CPH_DEBUG_LEVEL, "Failed to receive application packet\n");
 
 		/* Handle the broadcast packet in case it is enabled */
 #ifdef CONFIG_MV_CPH_BC_HANDLE
 		if (cph_app_rx_bc(port, dev, skb, rx_desc))
-			MV_CPH_PRINT(CPH_DEBUG_LEVEL, "BC packet failure\n");
+			return;
+		MV_CPH_PRINT(CPH_DEBUG_LEVEL, "BC packet failure\n");
 #endif
 		/* deliver to upper layer */
 		MV_CPH_PRINT(CPH_DEBUG_LEVEL, "Deliver to upper layer\n");
@@ -756,9 +758,10 @@ void cph_rx_func(int port, int rxq, struct net_device *dev,
 #ifdef CONFIG_MV_CPH_FLOW_MAP_HANDLE
 		if (cph_data_flow_rx(port, dev, skb, rx_desc))
 			MV_CPH_PRINT(CPH_DEBUG_LEVEL, "Flow mapping\n");
-
 #endif
 	}
+
+	return;
 }
 
 /******************************************************************************
-- 
1.7.5.4

