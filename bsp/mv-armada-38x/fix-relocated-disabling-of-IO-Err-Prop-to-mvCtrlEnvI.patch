From b3a5ba859fe0ea12fb4912dbff6f762c92e7c5d8 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Thu, 12 Dec 2013 18:39:54 +0200
Subject: [PATCH 1214/1825] fix: relocated disabling of IO Err Prop to
 mvCtrlEnvInit (earlier)

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit d9868980c68eaa1eb91389470c4e93da2f6878c5

	- Before fix IO Err Prop was disabled in mv_cpu_init (after the pci scan sequence)
	- During the pci scan sequence, a slave error was encountered,
	  And since CPU didn't mask this data abort - this caused an exception
	  this exception is not handled in u-boot (no interrupts)
	- After fix, we disable the IO Err prop in an earlier state (mvCtrlEnvInit)
	- Fixed for Avanta-LP, Armada-375 and Armada 38x

Change-Id: Ie761a455ba23b98329ad18431c8c474580e69eaf
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4733
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Kosta Zertsekel <konszert@marvell.com>
Reviewed-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.c       |    3 +++
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |    3 +++
 2 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
index 19f6bf8..dadfd26 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
@@ -401,6 +401,9 @@ MV_STATUS mvCtrlEnvInit(MV_VOID)
 	/* Enable arbitration between device and NAND */
 	MV_REG_BIT_SET(SOC_DEV_MUX_REG, BIT27);
 
+	/* Disable MBUS Err Prop - inorder to avoid data aborts */
+	MV_REG_BIT_RESET(SOC_COHERENCY_FABRIC_CTRL_REG, BIT8);
+
 	return MV_OK;
 }
 
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 4214026..c0b5bd7 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -363,6 +363,9 @@ MV_STATUS mvCtrlEnvInit(MV_VOID)
 	mvCtrlTdmClkCtrlConfig();
 #endif
 
+	/* Disable MBUS Err Prop - inorder to avoid data aborts */
+	MV_REG_BIT_RESET(SOC_COHERENCY_FABRIC_CTRL_REG, BIT8);
+
 	return MV_OK;
 }
 
-- 
1.7.5.4

