From 62c93d5f5ddd3ce4e70fe2453a26026b8ff8fc51 Mon Sep 17 00:00:00 2001
From: Yosi Tayar <tyosi@marvell.com>
Date: Sun, 22 Jun 2014 15:40:33 +0300
Subject: [PATCH 1736/1825] fix: alp: update unit num of USB3, SATA, PCIe
 units according to SerDes setup

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit b95758695a315a66f9043333a780508ab813ead0

	This fixes issues with wrong number of units returned for USB3, SATA & PCIe.
	The above max unit number are now detected according to run-time SerDes
	configurations.
	The fix was done according to the fix of bug SYSTEMSW-482
	Bug #SYSTEMSW-500

Change-Id: I5b3e39fd75b1a401a688f057255edc6652bbf06e
Signed-off-by: Yosi Tayar <tyosi@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8677
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   28 +++++++---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   61 ++++++++++++++++++-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h        |    1 +
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |    3 +
 4 files changed, 81 insertions(+), 12 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index 41fbab9..d3c49ba 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -1916,10 +1916,10 @@ MV_VOID mvBoardDDRBusWidthCheck(MV_VOID)
 *******************************************************************************/
 MV_VOID mvBoardConfigurationPrint(MV_VOID)
 {
-	char *lane1[] = {"PCIe1", "SGMII-0", "SATA-1", "Unconnected" };
 	char *tdmSlic[] = {"None", "SSI", "ISI", "ZSI", "TDM2C", "TDMMC"};
 	MV_U32 slicDevice, ethConfig = mvBoardEthComplexConfigGet();
 	MV_U16 modelID = mvCtrlModelGet();
+	MV_U32 i = 0;
 
 	mvOsOutput("\nBoard configuration:\n");
 
@@ -1998,13 +1998,25 @@ MV_VOID mvBoardConfigurationPrint(MV_VOID)
 	/* Dynamic config for SerDes lanes is relevant only to MV88F6660/65/58 */
 	if (modelID != MV_6660_DEV_ID && modelID != MV_6665_DEV_ID && modelID != MV_6658_DEV_ID)
 		return;
-	/* Read Common Phy selectors to determine SerDes configuration */
-	mvOsOutput("\tLane #1: %s\n", lane1[mvBoardLaneSelectorGet(1)]);
-	/* SERDES lanes #2,#3 are relevant only to MV88F6660/65 SoC */
-	if (modelID != MV_6660_DEV_ID && modelID != MV_6665_DEV_ID)
-		return;
-	mvOsOutput("\tLane #2: %s\n", (mvBoardLaneSelectorGet(2) ? "SATA-0" : "SGMII-0"));
-	mvOsOutput("\tLane #3: %s\n", (mvBoardLaneSelectorGet(3) ? "SGMII-0" : "USB3"));
+
+	for (i = 1; i < MV_SERDES_MAX_LANES; i++) {
+		switch (mvCtrlLaneSelectorGet(i)) {
+		case PEX_UNIT_ID:
+			mvOsOutput("\tLane #%d: PCIe%d\n", i, i);
+			break;
+		case USB3_UNIT_ID:
+			mvOsOutput("\tLane #%d: USB3\n", i);
+			break;
+		case SATA_UNIT_ID:
+			mvOsOutput("\tLane #%d: SATA%d\n", i, (i == 1 ? 1 : 0));
+			break;
+		case SGMII_UNIT_ID:
+			mvOsOutput("\tLane #%d: SGMII\n", i);
+			break;
+		default:
+			break;
+		}
+	}
 }
 
 /*******************************************************************************
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 15d91c6..6aae136 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -872,6 +872,38 @@ MV_U32 mvCtrlMppRegGet(MV_U32 mppGroup)
 	return ret;
 }
 
+/*******************************************************************************
+* mvCtrlLaneSelectorGet
+*
+* DESCRIPTION:
+*	Get Lane Selector.
+*
+* INPUT:
+*       Lane Number.
+*
+* OUTPUT:
+*
+* RETURN:
+*       Lane Selector Unit ENUM.
+*
+*******************************************************************************/
+MV_U32 mvCtrlLaneSelectorGet(MV_U32 laneNum)
+{
+	MV_U32 laneUnits[4][4] = {{ PEX_UNIT_ID },
+				  { PEX_UNIT_ID, SGMII_UNIT_ID, SATA_UNIT_ID },
+				  { SGMII_UNIT_ID, SATA_UNIT_ID },
+				  { USB3_UNIT_ID, SGMII_UNIT_ID } };
+
+	/* lane#0 is pre-defined to be PCIe0 , no selector value */
+	MV_U32  selector = (laneNum == 0 ? 0 : MV_REG_READ(MV_COMMON_PHY_REGS_OFFSET));
+
+	if (laneNum >= MV_SERDES_MAX_LANES)
+		return MV_ERROR;
+
+	selector = (selector & SERDES_LANE_MASK(laneNum)) >> SERDES_LANE_OFFS(laneNum);
+	return laneUnits[laneNum][selector];
+}
+
 #if defined(MV_INCLUDE_PEX)
 /*******************************************************************************
 * mvCtrlPexMaxIfGet
@@ -892,7 +924,13 @@ MV_U32 mvCtrlMppRegGet(MV_U32 mppGroup)
 *******************************************************************************/
 MV_U32 mvCtrlPexMaxIfGet(MV_VOID)
 {
-	return mvCtrlSocUnitInfoNumGet(PEX_UNIT_ID);
+	MV_U32 pexMaxIfNum = mvCtrlSocUnitInfoNumGet(PEX_UNIT_ID);
+
+	/* Detect if SerDes lane #1 is set to PCIe1 */
+	if (mvCtrlRevGet() >= MV_88F66XX_A0_ID && mvCtrlLaneSelectorGet(1) != PEX_UNIT_ID)
+		pexMaxIfNum--;
+
+	return pexMaxIfNum;
 }
 
 #endif
@@ -1024,8 +1062,17 @@ MV_U32 mvCtrlSataMaxPortGet(MV_VOID)
 	/* Z1, Z2, Z3 support 1 SATA port */
 	if (revID <= MV_88F66X0_Z3_ID && mvCtrlModelGet() == MV_6660_DEV_ID)
 		return sata_ports - 1;
-	else
-		return sata_ports;
+	else {
+		/* Detect if SerDes lane #1 is set to SATA1 */
+		if (mvCtrlLaneSelectorGet(1) != SATA_UNIT_ID)
+			sata_ports--;
+
+		/* Detect if SerDes lane #2 is set to SATA0 */
+		if (mvCtrlLaneSelectorGet(2) != SATA_UNIT_ID)
+			sata_ports--;
+	}
+
+	return sata_ports;
 }
 
 #endif
@@ -1144,7 +1191,13 @@ MV_U32 mvCtrlUsbMaxGet(void)
 *******************************************************************************/
 MV_U32 mvCtrlUsb3MaxGet(void)
 {
-	return mvCtrlSocUnitInfoNumGet(USB3_UNIT_ID);
+	MV_U32 usb3MaxNum = mvCtrlSocUnitInfoNumGet(USB3_UNIT_ID);
+
+	/* Detect if SerDes lane #3 is set to USB3 */
+	if (mvCtrlRevGet() >= MV_88F66XX_A0_ID && mvCtrlLaneSelectorGet(3) != USB3_UNIT_ID)
+		usb3MaxNum--;
+
+	return usb3MaxNum;
 }
 
 /*******************************************************************************
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
index 956d2f4..53575ba 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
@@ -280,6 +280,7 @@ MV_STATUS mvCtrlEnvInit(MV_VOID);
 MV_U32    mvCtrlMppRegGet(MV_U32 mppGroup);
 MV_U32 mvCtrlGetJuncTemp(MV_VOID);
 void mvCtrlNandClkSet(int nClock);
+MV_U32 mvCtrlLaneSelectorGet(MV_U32 laneNum);
 
 #if defined(MV_INCLUDE_PEX)
 MV_U32 mvCtrlPexMaxIfGet(MV_VOID);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index ec6c0ce..8e1f78f 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -152,6 +152,8 @@ extern "C" {
 
 #define INTER_REGS_SIZE                         _1M
 
+#define MV_SERDES_MAX_LANES			4
+
 /* This define describes the TWSI interrupt bit and location */
 #define TWSI_CPU_MAIN_INT_CAUSE_REG(cpu)        CPU_MAIN_INT_CAUSE_REG(1, (cpu))
 #define TWSI0_CPU_MAIN_INT_BIT(ch)              ((ch) + 3)
@@ -446,6 +448,7 @@ typedef enum _mvUnitId {
 	BM_UNIT_ID,
 	PNC_UNIT_ID,
 	I2C_UNIT_ID,
+	SGMII_UNIT_ID,
 	MAX_UNITS_ID
 } MV_UNIT_ID;
 
-- 
1.7.5.4

