From d2cc6bd85fec5590289be06b3232440884d18a11 Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Mon, 11 Mar 2013 11:44:12 +0200
Subject: [PATCH 0484/1825] ALP: Set board id using correct API

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit f5e8ad2e65ace3b158c1679db75cd343b85787ad

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: I6f3c2df7b160d2c9d59199b6a40bfea19e2ac1b1
Reviewed-on: http://vgitil04.il.marvell.com:8080/1221
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   53 +++++++++++++++----
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    3 +-
 2 files changed, 44 insertions(+), 12 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index 31171a1..7722416 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -1651,12 +1651,10 @@ MV_32 mvBoardNandWidthGet(void)
 }
 
 /*******************************************************************************
-* mvBoardIdSet - Set Board model
+* mvBoardIdReadFromSatR
 *
 * DESCRIPTION:
-*       This function sets the board ID.
-*       Board ID is 32bit word constructed of board model (16bit) and
-*       board revision (16bit) in the following way: 0xMMMMRRRR.
+*	Function name is self describing.
 *
 * INPUT:
 *       None.
@@ -1668,19 +1666,52 @@ MV_32 mvBoardNandWidthGet(void)
 *       void
 *
 *******************************************************************************/
-MV_VOID mvBoardIdSet(MV_VOID)
+MV_U32 mvBoardIdReadFromSatR(void)
 {
+	MV_U32 boardId;
+
 #ifdef CONFIG_MACH_AVANTA_LP_FPGA
-	gBoardId = MV_BOARD_ID_AVANTA_LP_FPGA;
+	boardId = MV_BOARD_ID_AVANTA_LP_FPGA;
 #else
-	gBoardId = (MV_REG_READ(MPP_SAMPLE_AT_RESET(1)) & SAR1_BOARD_ID_MASK) >> SAR1_BOARD_ID_OFFSET;
+	boardId = MV_REG_READ(MPP_SAMPLE_AT_RESET(1);
+	boardId &= (boardId & SAR1_BOARD_ID_MASK) >> SAR1_BOARD_ID_OFFSET;
 #endif
 
-	if (!((gBoardId >= BOARD_ID_BASE) && (gBoardId < MV_MAX_BOARD_ID))) {
-		mvOsPrintf("mvBoardIdSet: Board ID must be defined!\n");
-		while (1)
-			continue;
+	if (boardId >= MV_MAX_BOARD_ID) {
+		mvOsPrintf("%s: Error: read wrong board (%d)\n", __func__, boardId);
+		return MV_INVALID_BOARD_ID;
 	}
+
+	return boardId;
+}
+
+/*******************************************************************************
+* mvBoardIdSet - Set Board model
+*
+* DESCRIPTION:
+*       This function sets the board ID.
+*       Board ID is 32bit word constructed of board model (16bit) and
+*       board revision (16bit) in the following way: 0xMMMMRRRR.
+*
+* INPUT:
+*       None.
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*       void
+*
+*******************************************************************************/
+MV_BOOL mvBoardIdSet(MV_U32 boardId)
+{
+	if (boardId >= MV_MAX_BOARD_ID) {
+		mvOsPrintf("%s: Error: wrong boardId (%d)\n", __func__, boardId);
+		return MV_FALSE;
+	}
+
+	gBoardId = boardId;
+
 	board = boardInfoTbl[gBoardId];
 }
 
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index d33506c..0fb2ca7 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -625,7 +625,8 @@ MV_U8 mvBoardTwsiAddrTypeGet(MV_BOARD_TWSI_CLASS twsiClass, MV_U32 index);
 MV_U8 mvBoardTwsiAddrGet(MV_BOARD_TWSI_CLASS twsiClass, MV_U32 index);
 MV_32 mvBoardNandWidthGet(void);
 MV_U32 mvBoardIdGet(MV_VOID);
-MV_VOID mvBoardIdSet(MV_VOID);
+MV_U32 mvBoardIdReadFromSatR(void);
+MV_BOOL mvBoardIdSet(MV_U32 boardId);
 MV_U32 mvBoardSledCpuNumGet(MV_VOID);
 MV_VOID mvBoardConfigInit(MV_VOID);
 void mvBoardConfigWrite(MV_VOID);
-- 
1.7.5.4

