From 5d78bbd6e49f3d29735a5059dbf3ede6f02cff20 Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Mon, 30 Dec 2013 09:31:37 +0200
Subject: [PATCH 1244/1825] fix: rtc: avanta: Enable RTC using mainline driver

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit cad7ac21285c708716a52625d7d0a6de1f3c0b91

Change-Id: I68812b91bf5ad8713be2b39f07c1b5eb6aad1365
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4931
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/configs/avanta_gw_defconfig |    2 ++
 arch/arm/mach-feroceon-kw2/core.c    |   26 ++++++++++++++++++++++++++
 drivers/rtc/Kconfig                  |    3 ++-
 3 files changed, 30 insertions(+), 1 deletions(-)

diff --git a/arch/arm/configs/avanta_gw_defconfig b/arch/arm/configs/avanta_gw_defconfig
index a909e32..e4d78e3 100644
--- a/arch/arm/configs/avanta_gw_defconfig
+++ b/arch/arm/configs/avanta_gw_defconfig
@@ -183,6 +183,8 @@ CONFIG_USB_SERIAL_CP210X=y
 CONFIG_MMC=y
 CONFIG_MMC_SDHCI=y
 CONFIG_MMC_MVSDIO=y
+CONFIG_RTC_CLASS=y
+CONFIG_RTC_DRV_MV=y
 CONFIG_DMADEVICES=y
 CONFIG_MV_XOR=y
 CONFIG_STAGING=y
diff --git a/arch/arm/mach-feroceon-kw2/core.c b/arch/arm/mach-feroceon-kw2/core.c
index e3665c3..d1e6edf 100644
--- a/arch/arm/mach-feroceon-kw2/core.c
+++ b/arch/arm/mach-feroceon-kw2/core.c
@@ -716,6 +716,29 @@ static struct platform_device mv_sdio_plat = {
 
 #endif /* #if defined(CONFIG_MV_INCLUDE_SDIO) */
 
+/*******************************************************************************
+ * RTC
+ */
+#ifdef CONFIG_RTC_DRV_MV
+static struct resource rtc_resource[] = {
+	{
+		.start  = INTER_REGS_BASE + MV_RTC_REGS_OFFSET,
+		.end    = INTER_REGS_BASE + MV_RTC_REGS_OFFSET + 32 - 1,
+		.flags  = IORESOURCE_MEM,
+	}, {
+		.start  = RTC_IRQ_NUM,
+		.flags  = IORESOURCE_IRQ,
+	}
+};
+#endif
+
+static void __init kw2_rtc_init(void)
+{
+#ifdef CONFIG_RTC_DRV_MV
+	platform_device_register_simple("rtc-mv", -1, rtc_resource, 2);
+#endif
+}
+
 #ifdef CONFIG_MV_ETHERNET
 /*****************************************************************************
  * Ethernet
@@ -907,6 +930,9 @@ static void __init mv_init(void)
 	platform_device_register(&kw2_nfc);
 #endif
 
+	/* Real Time Clock (RTC) */
+	kw2_rtc_init();
+
 	/* Watchdog */
 	mv_wdt_init();
 
diff --git a/drivers/rtc/Kconfig b/drivers/rtc/Kconfig
index 01ac1cf..2136efd 100644
--- a/drivers/rtc/Kconfig
+++ b/drivers/rtc/Kconfig
@@ -980,7 +980,8 @@ config RTC_DRV_TX4939
 config RTC_DRV_MV
 	tristate "Marvell SoC RTC"
 	depends on ARCH_KIRKWOOD || ARCH_DOVE || \
-		   ARCH_ARMADA_XP || ARCH_ARMADA370 || ARCH_AVANTA_LP || ARCH_ARMADA38X
+		   ARCH_ARMADA_XP || ARCH_ARMADA370 || \
+			ARCH_AVANTA_LP || ARCH_ARMADA38X || ARCH_FEROCEON
 	help
 	  If you say yes here you will get support for the in-chip RTC
 	  that can be found in some of Marvell's SoC devices, such as
-- 
1.7.5.4

