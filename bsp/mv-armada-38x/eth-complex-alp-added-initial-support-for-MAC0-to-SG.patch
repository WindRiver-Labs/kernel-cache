From 9a4671085564597e9e5fd2efd1a158070646e0bb Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Mon, 12 Aug 2013 11:11:12 +0300
Subject: [PATCH 0958/1825] eth complex: alp: added initial support for MAC0
 to SGMII0 configuration

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 6c9b38206a5aff920ac2422e1c04e2776c4ccdd2

	- Added routine to enable the sfp0_tx field, according to eth_complex board config
	  (using IO expander output configuration, only for DB-6660 board)
	- Feature is still not working (missing ethernet complex config according to cook book)

Change-Id: I5c74a22da279e65cfb9a0db8fd7d509327df1fc1
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3003
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Tested-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   43 ++++++++++++++++++--
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    1 +
 2 files changed, 40 insertions(+), 4 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index a48ba63..88721eb 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -945,6 +945,12 @@ MV_VOID mvBoardInfoUpdate(MV_VOID)
 
 	/* Update MPP group types and values according to board configuration */
 	mvBoardMppIdUpdate();
+
+	/* If needed, enable SFP0 TX for SGMII, for DB-6660 */
+	if (mvBoardIdGet() == DB_6660_ID) {
+		if (ethComplex & MV_ETHCOMP_GE_MAC0_2_COMPHY_2)
+			mvBoardSgmiiSfp0TxSet(MV_TRUE);
+	}
 }
 
 /*******************************************************************************
@@ -2418,11 +2424,40 @@ MV_STATUS mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_TYPE_ID ioClass,
 MV_STATUS mvBoardExtPhyBufferSelect(MV_BOOL enable)
 {
 	MV_BOARD_IO_EXPANDER_TYPE_INFO ioInfo;
-	if (mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_EXT_PHY_SMI_EN, &ioInfo) == MV_OK)
-		return mvBoardIoExpValSet(&ioInfo, (enable ? 0x0 : 0x1));
+	if (mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_EXT_PHY_SMI_EN, &ioInfo) != MV_OK) {
+		mvOsPrintf("%s: Error: Write to IO expander failed (External Phy SMI Buffer select)\n", __func__);
+		return MV_ERROR;
+	}
 
-	mvOsPrintf("%s: Error: Write to IO expander failed (External Phy Buffer select)\n", __func__);
-	return MV_FALSE;
+	return mvBoardIoExpValSet(&ioInfo, (enable ? 0x0 : 0x1));
+}
+
+/*******************************************************************************
+* mvBoardSgmiiSfp0TxSet - enable/disable SGMII_SFP0_TX_DISABLE status
+*
+* DESCRIPTION:
+*	This function enables/disables the field status.
+*
+* INPUT:
+*	enable - Boolean to indicate requested status
+*
+* OUTPUT:
+*	None.
+*
+* RETURN:
+*	None.
+*
+*******************************************************************************/
+MV_STATUS mvBoardSgmiiSfp0TxSet(MV_BOOL enable)
+{
+	MV_BOARD_IO_EXPANDER_TYPE_INFO ioInfo;
+
+	if (mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_SFP0_TX_DIS, &ioInfo) != MV_OK) {
+		mvOsPrintf("%s: Error: Write to IO expander failed (SFP0_TX_DIS)\n", __func__);
+		return MV_ERROR;
+	}
+
+	return mvBoardIoExpValSet(&ioInfo, (enable ? 0x0 : 0x1));
 }
 
 /*******************************************************************************
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index 9bf6eeb..d2032fe 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -476,6 +476,7 @@ MV_STATUS mvBoardSatrInfoConfig(MV_SATR_TYPE_ID satrClass, MV_BOARD_SATR_INFO *s
 MV_STATUS mvBoardConfigTypeGet(MV_CONFIG_TYPE_ID configClass, MV_BOARD_CONFIG_TYPE_INFO *configInfo);
 MV_STATUS mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_TYPE_ID ioClass, MV_BOARD_IO_EXPANDER_TYPE_INFO *ioInfo);
 MV_STATUS mvBoardExtPhyBufferSelect(MV_BOOL enable);
+MV_STATUS mvBoardSgmiiSfp0TxSet(MV_BOOL enable);
 MV_U32 mvBoardTclkGet(MV_VOID);
 MV_U32 mvBoardL2ClkGetRaw(MV_VOID);
 MV_U32 mvBoardSysClkGet(MV_VOID);
-- 
1.7.5.4

