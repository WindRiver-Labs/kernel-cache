From de15b962b58f71f5470711cf69b8e41943bd9a92 Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Wed, 11 Dec 2013 15:45:29 +0200
Subject: [PATCH 1209/1825] a38x: Enabled winbond W25Q32 SPI flash for DB

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 911a0b40f930f64969aea99960cee5d27e7b31e8

Change-Id: I04fcbed05944907ee4373b70e14957cc1806a48b
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4706
Reviewed-by: Shadi Ammouri <shadi@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/configs/armada_385_v7smp_defconfig       |    2 -
 arch/arm/mach-armada38x/core.c                    |    3 +-
 arch/arm/plat-armada/mv_hal/sflash/mvSFlash.c     |   29 +++++++++++++-
 arch/arm/plat-armada/mv_hal/sflash/mvSFlashSpec.h |   43 +++++++++++++++++++++
 4 files changed, 72 insertions(+), 5 deletions(-)

diff --git a/arch/arm/configs/armada_385_v7smp_defconfig b/arch/arm/configs/armada_385_v7smp_defconfig
index a4908b2..36c3e9c 100644
--- a/arch/arm/configs/armada_385_v7smp_defconfig
+++ b/arch/arm/configs/armada_385_v7smp_defconfig
@@ -15,11 +15,9 @@ CONFIG_PARTITION_ADVANCED=y
 CONFIG_ARCH_ARMADA38X=y
 # CONFIG_MV_INCLUDE_CESA is not set
 # CONFIG_MV_INCLUDE_TDM is not set
-# CONFIG_MV_INCLUDE_SPI is not set
 CONFIG_MV_ETH_PORTS_NUM=2
 CONFIG_MV_ETH_TXQ=8
 # CONFIG_NET_SKB_RECYCLE is not set
-# CONFIG_MV_INCLUDE_USB is not set
 # CONFIG_MV_INCLUDE_NFC is not set
 # CONFIG_MV_INCLUDE_LEGACY_NAND is not set
 # CONFIG_MV_INCLUDE_INTEG_SATA is not set
diff --git a/arch/arm/mach-armada38x/core.c b/arch/arm/mach-armada38x/core.c
index 79880ff..7ace613 100644
--- a/arch/arm/mach-armada38x/core.c
+++ b/arch/arm/mach-armada38x/core.c
@@ -1254,11 +1254,10 @@ static void __init a38x_board_init(void)
 	a38x_xor_init();
 	a38x_usb_init();
 	a38x_sata_init();
-
+	a38x_spi_init();
 #if 0
 	a38x_rtc_init();
 	a38x_i2c_init();
-	a38x_spi_init();
 	a38x_sdio_init();
 	a38x_nand_nfc_init();
 	a38x_gpio_init();
diff --git a/arch/arm/plat-armada/mv_hal/sflash/mvSFlash.c b/arch/arm/plat-armada/mv_hal/sflash/mvSFlash.c
index d1be5a2..389275f 100755
--- a/arch/arm/plat-armada/mv_hal/sflash/mvSFlash.c
+++ b/arch/arm/plat-armada/mv_hal/sflash/mvSFlash.c
@@ -329,7 +329,32 @@ static MV_SFLASH_DEVICE_PARAMS sflash[] = {
 	    MV_MX25L257_MAX_FAST_SPI_FREQ,
 	    MV_MX25L257_FAST_READ_DUMMY_BYTES,
 	    MV_MX25L257_ADDR_CYC_CNT
-    }
+	},
+	/* Winbond W25Q32 SPI Flash, 4MB  */
+	{
+	    MV_WB25Q_WREN_CMND_OPCD,
+	    MV_WB25Q_WRDI_CMND_OPCD,
+	    MV_WB25Q_RDID_CMND_OPCD,
+	    MV_WB25Q_RDSR_CMND_OPCD,
+	    MV_WB25Q_WRSR_CMND_OPCD,
+	    MV_WB25Q_READ_CMND_OPCD,
+	    MV_WB25Q_FAST_RD_CMND_OPCD,
+	    MV_WB25Q_PP_CMND_OPCD,
+	    MV_WB25Q_SE_CMND_OPCD,
+	    MV_WB25Q_BE_CMND_OPCD,
+	    MV_WB25Q_RES_CMND_OPCD,
+	    MV_WB25Q_DP_CMND_OPCD,
+	    MV_WB25Q32_SECTOR_SIZE,
+	    MV_WB25Q32_SECTOR_NUMBER,
+	    MV_WB25Q_PAGE_SIZE,
+	    "WINBOND WB25Q32",
+	    MV_WINBOND_MANF_ID,
+	    MV_WB25Q32_DEVICE_ID,
+	    MV_WB25Q32_MAX_SPI_FREQ,
+	    MV_WB25Q32_MAX_FAST_SPI_FREQ,
+	    MV_WB25Q32_FAST_READ_DUMMY_BYTES,
+	    MV_WB25Q32_ADDR_CYC_CNT
+	}
 };
 
 /* Static Functions */
@@ -632,6 +657,8 @@ MV_STATUS mvSFlashInit(MV_SFLASH_INFO *pFlinfo)
 
     if (!detectFlag) {
 	mvOsPrintf("%s ERROR: Unknown SPI flash device!\n", __func__);
+	mvOsPrintf("%s ERROR: Manufacturer = %d Device = %d\n", __func__,
+			manf, dev);
 	return MV_FAIL;
     }
 
diff --git a/arch/arm/plat-armada/mv_hal/sflash/mvSFlashSpec.h b/arch/arm/plat-armada/mv_hal/sflash/mvSFlashSpec.h
index aef8a9c..5b48792 100755
--- a/arch/arm/plat-armada/mv_hal/sflash/mvSFlashSpec.h
+++ b/arch/arm/plat-armada/mv_hal/sflash/mvSFlashSpec.h
@@ -276,6 +276,49 @@ extern "C" {
 #define     	MV_S25FL_STATUS_BP_1_OF_2           	(0x07 << MV_SFLASH_STATUS_REG_WP_OFFSET)
 #define     	MV_S25FL_STATUS_BP_ALL              	(0x0F << MV_SFLASH_STATUS_REG_WP_OFFSET)
 
+
+/************************************/
+/*  WINBOND W25Q32 Device Specific  */
+/************************************/
+
+/* Manufacturer IDs and Device IDs for SFLASHs supported by the driver */
+#define	MV_WINBOND_MANF_ID			0xEF
+#define	MV_WB25Q32_DEVICE_ID			0x4016
+#define	MV_WB25Q32_MAX_SPI_FREQ			50000000	/* 50MHz */
+#define	MV_WB25Q32_MAX_FAST_SPI_FREQ		104000000	/* 104MHz */
+#define	MV_WB25Q32_FAST_READ_DUMMY_BYTES	1
+#define	MV_WB25Q32_ADDR_CYC_CNT			3
+
+/* Sector Sizes and population per device model*/
+#define	MV_WB25Q32_SECTOR_SIZE			0x1000	/* 4K */
+#define	MV_WB25Q32_SECTOR_NUMBER		1024
+#define	MV_WB25Q_PAGE_SIZE			0x100	/* 256 byte */
+
+#define	MV_WB25Q_WREN_CMND_OPCD			0x06	/* Write Enable */
+#define	MV_WB25Q_WRDI_CMND_OPCD			0x04	/* Write Disable */
+#define	MV_WB25Q_RDID_CMND_OPCD			0x9F	/* Read ID */
+#define	MV_WB25Q_RDSR_CMND_OPCD			0x05	/* Read Status Register */
+#define	MV_WB25Q_WRSR_CMND_OPCD			0x01	/* Write Status Register */
+#define	MV_WB25Q_READ_CMND_OPCD			0x03	/* Sequential Read */
+#define	MV_WB25Q_FAST_RD_CMND_OPCD		0x0B	/* Fast Read */
+#define	MV_WB25Q_PP_CMND_OPCD			0x02	/* Page Program */
+#define	MV_WB25Q_SE_CMND_OPCD			0xD8	/* Sector Erase */
+#define	MV_WB25Q_BE_CMND_OPCD			0xC7	/* Bulk Erase */
+#define	MV_WB25Q_DP_CMND_OPCD			0xB9	/* Deep Power Down */
+#define	MV_WB25Q_RES_CMND_OPCD			0xAB	/* Read Electronic Signature */
+
+/* Status Register Write Protect Bit Masks - 4bits */
+#define	MV_WB25Q_STATUS_REG_WP_MASK		(0x0F << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define	MV_WB25Q_STATUS_BP_NONE			(0x00 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define	MV_WB25Q_STATUS_BP_1_OF_128		(0x01 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define	MV_WB25Q_STATUS_BP_1_OF_64		(0x02 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define	MV_WB25Q_STATUS_BP_1_OF_32		(0x03 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define	MV_WB25Q_STATUS_BP_1_OF_16		(0x04 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define	MV_WB25Q_STATUS_BP_1_OF_8		(0x05 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define	MV_WB25Q_STATUS_BP_1_OF_4		(0x06 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define	MV_WB25Q_STATUS_BP_1_OF_2		(0x07 << MV_SFLASH_STATUS_REG_WP_OFFSET)
+#define	MV_WB25Q_STATUS_BP_ALL			(0x0F << MV_SFLASH_STATUS_REG_WP_OFFSET)
+
 #ifdef __cplusplus
 }
 #endif
-- 
1.7.5.4

