From 4f88444f21b8f1bd3b59639c0fc62750cd960c20 Mon Sep 17 00:00:00 2001
From: Eran Ben-Avi <benavi@marvell.com>
Date: Thu, 10 Oct 2013 19:31:12 +0300
Subject: [PATCH 1013/1825] alp: amp: align amp_make script to match both alp
 and axp

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 0a191714781c02b7d394d1c7dd9eb237017b8546

	update amp_make script for both alp and amp projects
	and also fix minor compilation bug related to amp support.

Change-Id: I6f93d99faba393853d4a5dd951da08bff966662c
Signed-off-by: Eran Ben-Avi <benavi@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3680
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/core.c |    2 +-
 tools/amp/amp_make.pl         |   15 ++++++++++++++-
 2 files changed, 15 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index d111b7c..d05d8a9 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -242,7 +242,7 @@ static int __init mv_shared_mem_setup(char *s)
 __setup("mv_sh_mem=", mv_shared_mem_setup);
 #endif /* CONFIG_MV_AMP_ENABLE */
 
-#ifdef CONFIG_MV_IPC_DRIVER
+#if (defined CONFIG_MV_IPC_LINUX_AMP_DRIVER) || (defined CONFIG_MV_IPC_FREERTOS_DRIVER)
 unsigned long ipc_target_cpu;
 static int __init mv_ipc_setup(char *s)
 {
diff --git a/tools/amp/amp_make.pl b/tools/amp/amp_make.pl
index 5614462..766f2ff 100644
--- a/tools/amp/amp_make.pl
+++ b/tools/amp/amp_make.pl
@@ -2,7 +2,19 @@
 
 # Save original .config
 open cfg_file, ".config" or die "\n AMP Error: Can't open .config file. Aborting\n";
-open boot_file, "arch/arm/mach-armadaxp/Makefile.boot" or die "\n AMP Error: Can't open arch/arm/mach-armadaxp/Makefile.boot file. Aborting\n";
+
+our $boot_file;
+while( $line = <cfg_file>)
+{
+	if( $line =~ m/CONFIG_ARCH_AVANTA_LP=(\S*)/) {
+		open boot_file, "arch/arm/mach-avantalp/Makefile.boot"
+			or die "\n AMP Error: Can't open arch/arm/mach-avantalp/Makefile.boot file. Aborting\n";
+	} elsif( $line =~ m/CONFIG_ARCH_ARMADA_XP=(\S*)/) {
+		open boot_file, "arch/arm/mach-armadaxp/Makefile.boot"
+			or die "\n AMP Error: Can't open arch/arm/mach-armadaxp/Makefile.boot file. Aborting\n";
+	}
+}
+seek cfg_file, 0, 0;
 
 $curr_base = $base[0] = $base[1] = $curr_port = $port[0] =  $port[1] = -1;
 $load_addr = $pars_addr = $ramd_addr = -1;
@@ -112,6 +124,7 @@ for (; ($g_id < 2) and ($g_id >= 0); $g_id += $add)
 
 	system("cp ./arch/arm/boot/uImage $out_dir/uImage_g$g_id");
 	system("cp .config .config_g$g_id");
+	system("cp ./vmlinux ./vmlinux_g$g_id");
 	print "\nAMP: Image $g_id ready at $out_dir/uImage_g$g_id\n";
 }
 
-- 
1.7.5.4

