From 218657ddd2efbc19b6ad4f7176399a81058f02d1 Mon Sep 17 00:00:00 2001
From: Yoni Farhadian <yonif@marvell.com>
Date: Wed, 31 Jul 2013 14:48:25 +0300
Subject: [PATCH 0906/1825] fix: pp2: setting link parameters via ethtool when
 link is down

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 40c00d04d098c956cd0b4871b77f7a08ab6c0a33

	When link is down, get_settings will return the configured speed and duplex,
	instead of "unkown".
	This is done because ethtool pass *ALL* parameters to set_settings
		- speed
		- duplex
		- AN on/off
	So if one of the params are missing in command line, then ethtool take the value from get_settings
	Thus in case of link down, ethtool passes "Unkown" value to set_settings

Change-Id: Ibc9a9096e54411cf2e27824f1b82f9eba9eb0ce6
Signed-off-by: Yoni Farhadian <yonif@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/2901
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c    |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c
index 7a6ce20..26140bd 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c
@@ -93,8 +93,8 @@ int mv_eth_tool_get_settings(struct net_device *netdev, struct ethtool_cmd *cmd)
 
 	if (status.linkup != MV_TRUE) {
 		/* set to Unknown */
-		cmd->speed  = -1;
-		cmd->duplex = -1;
+		cmd->speed  = priv->speed_cfg;
+		cmd->duplex = priv->duplex_cfg;
 	} else {
 		switch (status.speed) {
 		case MV_ETH_SPEED_1000:
@@ -209,7 +209,6 @@ int mv_eth_tool_restore_settings(struct net_device *netdev)
 			err = mvEthPhyAdvertiseSet(mv_phy_addr, priv->advertise_cfg);
 		/* Restart AN on PHY enables it */
 		if (!err) {
-
 			err = mvEthPhyRestartAN(mv_phy_addr, MV_ETH_TOOL_AN_TIMEOUT);
 			if (err == MV_TIMEOUT) {
 				MV_ETH_PORT_STATUS ps;
@@ -227,6 +226,7 @@ int mv_eth_tool_restore_settings(struct net_device *netdev)
 	} else {
 		err = -EINVAL;
 	}
+
 	return err;
 }
 
-- 
1.7.5.4

