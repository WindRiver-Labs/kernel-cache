From 1d6efe6e7ed5ee980a2b537f9e9631810e85f374 Mon Sep 17 00:00:00 2001
From: Nadav Haklai <nadavh@marvell.com>
Date: Wed, 24 Oct 2012 11:09:53 +0200
Subject: [PATCH 0289/1825] Armada370: Align arm/plat-armada.

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 4efeb9a8c3e33e86ebf18e432bffaba771b177cf

Change-Id: I1b1f7d552faf367bf07f337d46b13a38c9e43400

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/Kconfig                       |   48 ++-
 arch/arm/plat-armada/Makefile                      |   15 +-
 arch/arm/plat-armada/armadaxp_suspend.S            |  370 --------------------
 arch/arm/plat-armada/common/mvDeviceId.h           |   26 ++
 arch/arm/plat-armada/common/mvDeviceId.h.orig      |  355 -------------------
 .../plat-armada/mv_drivers_lsp/mv_audio/Makefile   |    8 +-
 .../mv_drivers_lsp/mv_audio_soc/Makefile           |    8 +-
 .../plat-armada/mv_drivers_lsp/mv_btns/Makefile    |    8 +-
 .../plat-armada/mv_drivers_lsp/mv_cesa/Makefile    |    5 +-
 .../arm/plat-armada/mv_drivers_lsp/mv_dma/Makefile |    8 +-
 .../plat-armada/mv_drivers_lsp/mv_gpio/Makefile    |    8 +-
 .../arm/plat-armada/mv_drivers_lsp/mv_ipc/Makefile |    5 +-
 .../plat-armada/mv_drivers_lsp/mv_ipc_net/Makefile |    5 +-
 .../arm/plat-armada/mv_drivers_lsp/mv_mtd/Makefile |    9 +-
 .../plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c   |    3 +-
 .../mv_drivers_lsp/mv_neta/net_dev/Makefile        |   12 +-
 .../mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c     |    2 +
 .../mv_drivers_lsp/mv_network/mv_ethernet/Makefile |    8 +-
 .../plat-armada/mv_drivers_lsp/mv_phone/Makefile   |    9 +-
 .../mv_drivers_lsp/mv_phone/test/Makefile          |    7 +-
 .../plat-armada/mv_drivers_lsp/mv_sata/Makefile    |    8 +-
 .../plat-armada/mv_drivers_lsp/mv_sdio/Makefile    |    8 +-
 .../plat-armada/mv_drivers_lsp/mv_switch/Makefile  |    8 +-
 .../plat-armada/mv_drivers_lsp/mv_trace/Makefile   |    8 +-
 .../arm/plat-armada/mv_drivers_lsp/mv_tsu/Makefile |    4 +-
 .../arm/plat-armada/mv_drivers_lsp/mv_udc/Makefile |    8 +-
 .../arm/plat-armada/mv_drivers_lsp/mv_xor/Makefile |    8 +-
 arch/arm/plat-armada/mv_hal/cntmr/mvCntmr.c        |    9 +-
 arch/arm/plat-armada/mv_hal/cntmr/mvCntmrRegs.h    |    6 +
 arch/arm/plat-armada/mv_hal/twsi/mvSysTwsi.h       |  119 +++++++
 arch/arm/plat-armada/mv_hal/twsi/mvTwsi.c          |    1 +
 arch/arm/plat-armada/mv_hal/xor/mvXorAddrDec.c     |   16 +-
 32 files changed, 252 insertions(+), 870 deletions(-)
 delete mode 100644 arch/arm/plat-armada/armadaxp_suspend.S
 delete mode 100644 arch/arm/plat-armada/common/mvDeviceId.h.orig
 create mode 100644 arch/arm/plat-armada/mv_hal/twsi/mvSysTwsi.h

diff --git a/arch/arm/plat-armada/Kconfig b/arch/arm/plat-armada/Kconfig
index 8877dad..1c44d5a 100644
--- a/arch/arm/plat-armada/Kconfig
+++ b/arch/arm/plat-armada/Kconfig
@@ -21,6 +21,9 @@ menu "Armada SoC options"
 #source "arch/arm/mach-feroceon-mv78xx0/Kconfig"
 #endif
 
+if ARCH_ARMADA370
+source "arch/arm/mach-armada370/Kconfig"
+endif
 
 config JTAG_DEBUG
         bool "Enable JTAG by disable \"wait for interrupt\"."
@@ -32,6 +35,7 @@ config JTAG_DEBUG
 
 menu "Armada SoC Included Features"
 
+if ARMADA_XP
 config MV_INCLUDE_PEX
 	bool "PCI Express Support"
 	depends on PCI && (MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP)
@@ -72,71 +76,81 @@ config MV_PEX_2_1X4
 config MV_PEX_3_1X4
 	bool "PEX-3 in 1x4 Mode"
 	depends on MV_INCLUDE_PEX
+endif
+
+if ARMADA_370
+config MV_INCLUDE_PEX
+	bool "PCI Express Support"
+    depends on PCI && (MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_370)
+    default y
+        ---help---
+        Please don't change this configs unless you know what you are doing.
+endif
 
 config MV_INCLUDE_PCI
 	bool "PCI Support"
-	depends on PCI && (MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP)
+	depends on PCI && (MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP || ARMADA_370)
 	default n
         ---help---
         Please don't change this configs unless you know what you are doing.
 
 config MV_INCLUDE_USB
 	bool "USB Support"
-	depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP
+	depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP || ARMADA_370
 	default y
         ---help---
         Please don't change this configs unless you know what you are doing.
 
 config MV_INCLUDE_XOR
 	bool "XOR Support"
-	depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP
+	depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP || ARMADA_370
 	default y
         ---help---
         Please don't change this configs unless you know what you are doing.
 
 config MV_INCLUDE_CESA
 	bool "CESA Support"
-	depends on MV88F6500 || MV88F6082 || MV88F6183 || MV88F6281 || MV78XX0 || ARMADA_XP
+	depends on MV88F6500 || MV88F6082 || MV88F6183 || MV88F6281 || MV78XX0 || ARMADA_XP || ARMADA_370
 	default y
         ---help---
         Please don't change this configs unless you know what you are doing.
 
 config MV_INCLUDE_NFC
 	bool "Nand Flash Controller Support"
-	depends on MV88F6500 || ARMADA_XP
+	depends on MV88F6500 || ARMADA_XP || ARMADA_370
 	default y
         ---help---
         Please don't change this configs unless you know what you are doing.
 
 config MV_INCLUDE_LEGACY_NAND
 	bool "Legacy NAND Support"
-	depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP
+	depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP || ARMADA_370
 	default y
         ---help---
         Please don't change this configs unless you know what you are doing.
 
 config MV_INCLUDE_INTEG_SATA
 	bool "Integrated SATA Support"
-	depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP
+	depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP || ARMADA_370
 	default y
         ---help---
         Please don't change this configs unless you know what you are doing.
 
 config MV_INCLUDE_TDM
 	bool "Integrated TDM Support"
-	depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP
+	depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP || ARMADA_370
 	default y
         ---help---
         Please don't change this configs unless you know what you are doing.
 
 config MV_INCLUDE_GIG_ETH
 	bool "Giga Ethernet Support"
-	depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP
+	depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP || ARMADA_370
 	default y
 
 config MV_INCLUDE_SPI
 	bool "SPI Support"
-	depends on MV88F6500 || MV88F6281 || (MV78XX0 && !MV78XX0_Z0) || ARMADA_XP
+	depends on MV88F6500 || MV88F6281 || (MV78XX0 && !MV78XX0_Z0) || ARMADA_XP || ARMADA_370
 	default y
         ---help---
         Please don't change this configs unless you know what you are doing.
@@ -151,7 +165,7 @@ config MV_INCLUDE_NOR
 
 config MV_INCLUDE_SDIO
 	bool "SDIO Support"
-	depends on MV88F6500 || MV88F6281 || ARMADA_XP
+	depends on MV88F6500 || MV88F6281 || ARMADA_XP || ARMADA_370
 	default y
         ---help---
         Please don't change this configs unless you know what you are doing.
@@ -172,7 +186,7 @@ config MV_INCLUDE_PON
 
 config MV_INCLUDE_SWITCH
         bool "Ethernet Switch Support"
-        depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP
+        depends on MV88F6500 || MV88F6281 || MV78XX0 || ARMADA_XP || ARMADA_370
         default y
 
 endmenu
@@ -250,16 +264,16 @@ config MV_GPP_MAX_PINS
 	default 64 if MV88F6281
 	default 70 if MV88F6500
 	default 67 if ARMADA_XP
-
+	default 67 if ARMADA_370
 	
 config MV_DCACHE_SIZE
 	hex
-	default 0x8000 if MV78XX0 || ARMADA_XP
+	default 0x8000 if MV78XX0 || ARMADA_XP || ARMADA_370
 	default 0x4000 if MV88F6500 || MV88F6281
 
 config MV_ICACHE_SIZE
 	hex
-	default 0x8000 if MV78XX0 || ARMDAD_XP
+	default 0x8000 if MV78XX0 || ARMDAD_XP || ARMADA_370
 	default 0x4000 if MV88F6500 || MV88F6281
 	          
 menu "Armada SoC MTD support"
@@ -282,7 +296,7 @@ config MV_SPI_BOOT
 	Choose this option if SPI MTD is the system boot device.
 	This option controls the various flash types support in the board
 	device chip-select information structure under mvBoardEnvSpec.c
-                    
+
 config MV_INCLUDE_MFLASH_MTD
     bool "Marvell support for MTD Marvell flash device"
     select MV_FLASH_CTRL
@@ -482,7 +496,7 @@ config MV_ETH_LEGACY
 
 config MV_ETH_NETA
         bool "Acceleration mode "
-	depends on ARCH_FEROCEON_KW2 || ARCH_ARMADA_XP
+	depends on ARCH_FEROCEON_KW2 || ARCH_ARMADA_XP || ARCH_ARMADA370
         ---help---
 
 endchoice
diff --git a/arch/arm/plat-armada/Makefile b/arch/arm/plat-armada/Makefile
index 19b86f5..e67f3d6 100644
--- a/arch/arm/plat-armada/Makefile
+++ b/arch/arm/plat-armada/Makefile
@@ -1,17 +1,12 @@
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 # This will never compile, because DUMMY will never by defined.
 obj-$(DUMMY)   				:= dummy.o
-
 obj-$(CONFIG_SHEEVA_DEEP_IDLE)		+= cpuidle.o armadaxp_suspend.o suspend.o
-obj-$(CONFIG_HOTPLUG_CPU)               += hotplug.o
-obj-$(CONFIG_ARCH_ARMADA_XP)		+= pmu.o
+obj-$(CONFIG_HOTPLUG_CPU)		+= hotplug.o
+obj-$(CONFIG_PLAT_ARMADA)		+= pmu.o
 obj-$(CONFIG_PCI_MSI)			+= msi.o
 obj-$(CONFIG_ERROR_HANDLING)		+=error_handling.o
-obj-$(CONFIG_CPU_FREQ_ARMADA_XP)	+= cpufreq.o
\ No newline at end of file
+obj-$(CONFIG_CPU_FREQ_ARMADA_XP)	+= cpufreq.o
diff --git a/arch/arm/plat-armada/armadaxp_suspend.S b/arch/arm/plat-armada/armadaxp_suspend.S
deleted file mode 100644
index 3aa91d2..0000000
--- a/arch/arm/plat-armada/armadaxp_suspend.S
+++ /dev/null
@@ -1,370 +0,0 @@
-/*
- * arch/arm/plat-armada/armadaxp_suspend.S
- *
- * CPU idle low level implementation for Marvell ARMADA-XP SoCs
- *
- * This file is licensed under the terms of the GNU General Public
- * License version 2.  This program is licensed "as is" without any
- * warranty of any kind, whether express or implied.
- *
- */
-#include <linux/linkage.h>
-#include <asm/assembler.h>
-#include <mach/armadaxp.h>
-
-#define GPIO_64_66_VALUE_REG			(INTER_REGS_BASE + 0x18180)
-#define GPIO_64_66_CTRL_REG			(INTER_REGS_BASE + 0x18184)
-#define MPP_CTRL_64_66_REG			(INTER_REGS_BASE + 0x18020)
-
-ENTRY(armadaxp_powerdown)
-	/* Save ARM registers */
-	stmfd	sp!, {r4-r12, lr}		@ save registers on stack
-
-	/*
-	* Save the CP15 context
-	*/
-	mrc     p15, 0, r2, c1, c0, 0           @ save CP15 - CR
-	mrc     p15, 0, r3, c3, c0, 0           @ save CP15 - DACR
-	mrc     p15, 0, r4, c13, c0, 0          @ save CP15 - FCSE
-	mrc     p15, 0, r5, c2, c0, 0           @ save CP15 - TTBR0
-	mrc     p15, 0, r6, c13, c0, 1          @ save CP15 - context ID
-	mrc     p15, 1, r7, c15, c1, 0          @ save CP15 - extra features
-	mrc     p15, 0, r8, c1, c0, 1           @ save CP15 - Aux CR
-	mov     r9, r13                         @ save resume SP
-	stmfd   sp!, {r2-r9}
-
-	mrc     p15, 0, r2, c2, c0, 1   @ save CP15 - TTBR1
-	mrc	p15, 1, r3, c15, c2, 0	@ save CP15 - Aux Func Modes Ctrl 0
-	mrc	p15, 1, r4, c15, c1, 2	@ save CP15 - Aux Debug Modes Ctrl 2
-	mrc     p15, 1, r5, c15, c1, 1  @ save CP15 - Aux Debug Modes Ctrl 1
-	mrc     p15, 0, r6, c9, c14, 0  @ save CP15 - PMC
-	mrc     p15, 0, r7, c10, c2, 0  @ save CP15 - PRRR
-	mrc     p15, 0, r8, c10, c2, 1  @ save CP15 - NMRR
-	stmfd   sp!, {r2-r8}
-
-	/*
-	* Save the physical address of the resume SP
-	*/
-	mov     r0, sp
-	bl      suspend_phys_addr
-	ldr     r1, =suspend_saved_sp
-#ifdef CONFIG_SMP
-	mrc     p15, 0, r2, c0, c0, 5
-	and     r2, r2, #15
-	str     r0, [r1, r2, lsl #2]
-#else
-	str     r0, [r1]
-#endif
-
-	/*
-	* Flush L1 DCache
-	*/
-	bl v7_flush_kern_cache_all
-
-	/*
-	* Issue a Data Synchronization Barrier instruction to ensure that all
-	* state saving has been	completed.
-	*/
-	dsb
-
-	/* Flush the DLB and wait ~7 usec*/
-	ldr r2, =SDRAM_DLB_EVICT_REG
-	ldr	r0, [r2]
-	bic     r0, #0x000000FF
-	str     r0, [r2]
-
-	ldr r1, = 6000  /* WC freq =  1.6 Ghz, 2 cycles per loop */
-1:	subs r1,r1,#1
-	bne 1b
-
-	/* Set DDR in battery backup mode
-	 * It will exit self-refresh only on reset */
-	ldr 	r2, =SDRAM_CONFIG_REG
-	ldr	r0, [r2]
-	bic     r0, #0x01000000
-	str     r0, [r2]
-
-	/* Prepare register for DDR Self refresh */
-	ldr	r2, =(SDRAM_OPERATION_REG - INTER_REGS_BASE)
-	ldr	r0, =INTER_REGS_BASE
-	orr	r2, r2, r0
-	ldr	r0, [r2]
-#ifdef CONFIG_CPU_BIG_ENDIAN
-	ldr	r3, =0x07000000
-#else
-	ldr	r3, =0x00000007
-#endif
-	orr	r0, r0, r3
-
-	/*
-	 * Write 0x1 then 0x7 through MPP 64-67 to PIC that controls power
-	 * 0x1 - Power off all voltages;  0x7 - Acknowledge command
-	 */
-	ldr r3, =(MPP_CTRL_64_66_REG)
-	ldr r4, =0x2000
-	str r4, [r3]
-
-	ldr r3, =(GPIO_64_66_VALUE_REG)
-	ldr r4, =(GPIO_64_66_CTRL_REG)
-
-	ldr r5, =0x1
-	ldr r6, =0x0
-
-	str r5, [r3]
-	str r6, [r4]
-
-	ldr r1, =200000000
-	ldr r5, =0x7
-
-	/*
-	 * Wait between cmd (0x1) and cmd ack (0x7)
-	 * TODO - Need to reduce this delay
-	 */
-1:	subs r1,r1,#1
-	bne 1b
-
-	/*
-	 * Put Dram into self refresh. From here on we can perform
-	 * 8 instructions to ensure executiion from I-Cache
-	 */
-	.align 5
-	str	r0, [r2]
-
-	/* Wait 100 cycles for DDR to enter self refresh */
-	ldr r1, = 50
-1:	subs r1,r1,#1
-	bne 1b
-
-	/* Issue the cmd ack. This will turn of the board */
-	str r5, [r3]
-
-	/* trap the processor */
-	b .
-
-ENDPROC(armadaxp_powerdown)
-
-/*
-* armadaxp_cpu_suspend: enter cpu deepIdle state
-* input:
-*/
-ENTRY(armadaxp_cpu_suspend)
-/* Save ARM registers */
-	stmfd	sp!, {r4-r12, lr}				@ save registers on stack
-
-/*
-* Save the CP15 context
-*/
-	mrc     p15, 0, r2, c1, c0, 0			@ save CP15 - CR
-	mrc     p15, 0, r3, c3, c0, 0			@ save CP15 - DACR
-	mrc     p15, 0, r4, c13, c0, 0			@ save CP15 - FCSE
-        mrc     p15, 0, r5, c2, c0, 0           @ save CP15 - TTBR0
-	mrc     p15, 0, r6, c13, c0, 1			@ save CP15 - context ID
-	mrc     p15, 1, r7, c15, c1, 0			@ save CP15 - extra features
-	mrc     p15, 0, r8, c1, c0, 1			@ save CP15 - Aux CR
-	mov     r9, r13							@ save resume SP
-	stmfd   sp!, {r2-r9}
-	mrc     p15, 0, r2, c2, c0, 1           @ save CP15 - TTBR1
-	mrc	p15, 1, r3, c15, c2, 0				@ save CP15 - Aux Func Modes Ctrl 0
-	mrc	p15, 1, r4, c15, c1, 2				@ save CP15 - Aux Debug Modes Ctrl 2
-	mrc     p15, 1, r5, c15, c1, 1			@ save CP15 - Aux Debug Modes Ctrl 1
-	mrc     p15, 0, r6, c9, c14, 0			@ save CP15 - PMC
-	mrc     p15, 0, r7, c10, c2, 0			@ save CP15 - PRRR
-	mrc     p15, 0, r8, c10, c2, 1			@ save CP15 - NMRR
-	
-        stmfd   sp!, {r2-r8}
-
-/*
-* TODO: Save Debug Registers
-*/
-
-/*
-* Save the physical address of the resume SP
-*/
-        mov     r0, sp
-        bl      suspend_phys_addr
-        ldr     r1, =suspend_saved_sp
-#ifdef CONFIG_SMP
-        mrc     p15, 0, r2, c0, c0, 5
-        and     r2, r2, #15
-        str     r0, [r1, r2, lsl #2]
-#else
-        str     r0, [r1]
-#endif
-
-/*
-* Flush L1 DCache
-*/
-
-#ifdef CONFIG_CPU_V6
-	bl v6_flush_kern_cache_all
-#elif CONFIG_CPU_V7
-	bl v7_flush_kern_cache_all
-#else
-#error "CPU Arch version not defined!\n"
-#endif
-
-/* Prepare Deep Idle Function - Set PMU Configurations*/
-	bl armadaxp_fabric_prepare_deepIdle
-
-/*
-* Issue a Data Synchronization Barrier instruction to ensure that all
-* state saving has been	completed.
-*/
-#ifdef CONFIG_CPU_V6
-	mcr     p15, 0, r0, c7, c10, 4	@ Data Synchronization Barrier
-#elif defined (CONFIG_CPU_V7)
-	dsb				@ Data Synchronization Barrier
-#endif
-
-/* Lock Semaphore */
-	mrc	15, 0, r1, cr0, cr0, 5
-	and	r1, r1, #15
-	ldr	r4, =0xFBB20500
-1:
-	ldr	r2, [r4]
-	and	r2, r2, #0xF
-	cmp	r1, r2
-	bne	1b
-
-/* Disable SnoopEna */
-	mrc	15, 0, r1, cr0, cr0, 5
-	and	r1, r1, #15
-	mov	r6, #1
-	add	r7, r1, #24
-	ldr	r2, =0xFBB20200
-	ldr	r3, [r2]
-	bic	r3, r3, r6, lsl r7
-	str	r3, [r2]
-
-/* Release Semaphore */
-	ldr	r2, =0xFBB20500
-	ldr 	r0, =0xff
-	strb	r0, [r2]
-
-dowfi:
-/* WFI */
-#ifdef CONFIG_CPU_V6
-	mcr     p15, 0, r1, c7, c0, 4	@ wait for interrupt
-#elif defined (CONFIG_CPU_V7)
-	wfi				@ wait for interrupt
-#endif
-
-	/* After disabling the SnoopEna by SW regret is not allowed!! */
-	b dowfi
-
-#if 0
-	/* if we reach this point then deepIdle returned from regret mode and cpu
-	* state retained
-	*/
-	mov	r0, #1
-	ldmfd   sp!, {r3-r8}
-	ldmfd   sp!, {r2-r9}
-	
-	ldmfd   sp!, {r4-r12, pc}
-#endif
-ENDPROC(armadaxp_cpu_suspend)
-
-/*
-* armadaxp_cpu_resume: resume from cpu deepIdle state
-* input:
-*/
-ENTRY(armadaxp_cpu_resume)
-
-#ifdef CONFIG_CPU_ENDIAN_BE32
-	/* convert CPU to big endian */
-	.word 0x100f11ee /* mrc p15, 0, r0, c1, c0 */
-	.word 0x800080e3 /* orr r0, r0, #0x80 */
-	.word 0x100f01ee /* mcr p15, 0, r0, c1, c0 */
-#endif
-#ifdef CONFIG_CPU_ENDIAN_BE8
-	setend  be
-#endif
-
-/* Lock Semaphore */
-	mrc	15, 0, r1, cr0, cr0, 5
-	and	r1, r1, #15
-	ldr	r4, =0xD0020500
-1:
-	ldr	r2, [r4]
-	and	r2, r2, #0xF
-	cmp	r1, r2
-	bne	1b
-
-/* Enable SnoopEna */
-	mrc	15, 0, r1, cr0, cr0, 5
-	and	r1, r1, #15
-	mov	r6, #1
-	add	r7, r1, #24
-	ldr	r2, =0xD0020200
-	ldr	r3, [r2]
-	orr	r3, r3, r6, lsl r7
-	str	r3, [r2]
-
-/* Release Semaphore */
-	ldr	r2, =0xD0020500
-	ldr 	r0, =0xff
-	strb	r0, [r2]
-
-#ifdef CONFIG_SMP
-	adr     r0, suspend_saved_sp
-	mrc     p15, 0, r1, c0, c0, 5
-	and     r1, r1, #15
-	ldr     r0, [r0, r1, lsl #2]    @ stack phys addr
-#else
-	ldr     r0, suspend_saved_sp            @ stack phys addr
-#endif
-
-	ldmfd   r0!, {r2-r8}
-	mcr     p15, 0, r2, c2, c0, 1           @ restore CP15 - TTBR1
-	mcr     p15, 1, r3, c15, c2, 0          @ restore CP15 - Aux Func Modes Ctrl 0
-	mcr     p15, 1, r4, c15, c1, 2          @ restore CP15 - Aux Debug Modes Ctrl 2
-	mcr     p15, 1, r5, c15, c1, 1          @ restore CP15 - Aux Debug Modes Ctrl 1
-	mcr     p15, 0, r6, c9, c14, 0          @ restore CP15 - PMC
-	mcr     p15, 0, r7, c10, c2, 0          @ restore CP15 - PRRR
-	mcr     p15, 0, r8, c10, c2, 1          @ restore CP15 - NMRR
-	ldmfd   r0!, {r2-r9}
-	mcr	p15, 0, r8, c1, c0, 1		@ restore CP15 - Aux CR
-	mcr	p15, 1, r7, c15, c1, 0		@ restore CP15 - extra features
-	mcr	p15, 0, r4, c13, c0, 0		@ restore CP15 - FCSE
-	mcr	p15, 0, r3, c3, c0, 0		@ restore CP15 - DACR
-
-	/* load identity page table */
-	ldr	r3, identity_page_table_phys
-	mcr	p15, 0, r3, c2, c0, 0		@ set CP15 - TTBR
-	mov	r3, #0
-	mcr	p15, 0, r3, c13, c0, 1          @ set 0 in CP15 - context ID
-	mcr	p15, 0, r2, c1, c0, 0		@ restore CP15 - CR  @enable mmu
-	mrc     p15, 0, r3, c0, c0, 0           @ read id reg
-
-	ldr	r3, resume2
-	mov	pc, r3
-ENDPROC(armadaxp_cpu_resume)
-
-	/* stage 2 of the resume function that runs from PAGE_OFFSET virtual space */
-ENTRY(armadaxp_cpu_resume2)	
-	/* restore original page table*/
-
-	mcr	p15, 0, r5, c2, c0, 0		@ restore CP15 - TTBR
-	mcr	p15, 0, r6, c13, c0, 1          @ restore CP15 - context ID
-	mcr     p15, 0, r0, c8, c7, 0           @ TLB invalidate
-	mov	sp, r9				@ restore virtual sp
-	mov	r0, #0
-
-	ldmfd   sp!, {r4-r12, pc}               @ restore SVC registers
-
-ENDPROC(armadaxp_cpu_resume2)
-	
-resume2:
-	.long	armadaxp_cpu_resume2
-
-suspend_saved_sp:
-#ifdef CONFIG_SMP
-	.rept	CONFIG_NR_CPUS
-#endif
-	.long	0	@ physical SP saved here
-#ifdef CONFIG_SMP
-	.endr
-#endif
-	.global identity_page_table_phys
-identity_page_table_phys:
-	.long	0
diff --git a/arch/arm/plat-armada/common/mvDeviceId.h b/arch/arm/plat-armada/common/mvDeviceId.h
index 56a5b47..651461f 100644
--- a/arch/arm/plat-armada/common/mvDeviceId.h
+++ b/arch/arm/plat-armada/common/mvDeviceId.h
@@ -258,6 +258,32 @@ extern "C" {
 #define MV_6710_Z1_REV		0x0
 #define MV_6710_Z1_ID		((MV_6710_DEV_ID << 16) | MV_6710_Z1_REV)
 #define MV_6710_Z1_NAME		"MV6710 Z1"
+#define MV_6710_A0_REV          0x0
+#define MV_6710_A0_ID           ((MV_6710_DEV_ID << 16) | MV_6710_A0_REV)
+#define MV_6710_A0_NAME         "MV6710 A0"
+
+#define MV_6710_A1_REV          0x1
+#define MV_6710_A1_ID           ((MV_6710_DEV_ID << 16) | MV_6710_A1_REV)
+#define MV_6710_A1_NAME         "MV6710 A1"
+
+#define MV_6W11_DEV_ID          0x6711
+#define MV_6W11_A0_REV          0x0
+#define MV_6W11_A0_ID           ((MV_6W11_DEV_ID << 16) | MV_6W11_A0_REV)
+#define MV_6W11_A0_NAME         "MV6W11 A0"
+
+#define MV_6W11_A1_REV          0x1
+#define MV_6W11_A1_ID           ((MV_6W11_DEV_ID << 16) | MV_6W11_A1_REV)
+#define MV_6W11_A1_NAME         "MV6W11 A1"
+
+#define MV_6707_DEV_ID          0x6707
+#define MV_6707_A0_REV          0x0
+#define MV_6707_A0_ID           ((MV_6707_DEV_ID << 16) | MV_6707_A0_REV)
+#define MV_6707_A0_NAME         "MV6707 A0"
+
+#define MV_6707_A1_REV          0x1
+#define MV_6707_A1_ID           ((MV_6707_DEV_ID << 16) | MV_6707_A1_REV)
+#define MV_6707_A1_NAME         "MV6707 A1"
+
 
 #define MV_6710_A0_REV		0x0
 #define MV_6710_A0_ID		((MV_6710_DEV_ID << 16) | MV_6710_A0_REV)
diff --git a/arch/arm/plat-armada/common/mvDeviceId.h.orig b/arch/arm/plat-armada/common/mvDeviceId.h.orig
deleted file mode 100644
index 56a5b47..0000000
--- a/arch/arm/plat-armada/common/mvDeviceId.h.orig
+++ /dev/null
@@ -1,355 +0,0 @@
-/*******************************************************************************
-Copyright (C) Marvell International Ltd. and its affiliates
-
-This software file (the "File") is owned and distributed by Marvell
-International Ltd. and/or its affiliates ("Marvell") under the following
-alternative licensing terms.  Once you have made an election to distribute the
-File under one of the following license alternatives, please (i) delete this
-introductory statement regarding license alternatives, (ii) delete the two
-license alternatives that you have not elected to use and (iii) preserve the
-Marvell copyright notice above.
-
-********************************************************************************
-Marvell Commercial License Option
-
-If you received this File from Marvell and you have entered into a commercial
-license agreement (a "Commercial License") with Marvell, the File is licensed
-to you under the terms of the applicable Commercial License.
-
-********************************************************************************
-Marvell GPL License Option
-
-If you received this File from Marvell, you may opt to use, redistribute and/or
-modify this File in accordance with the terms and conditions of the General
-Public License Version 2, June 1991 (the "GPL License"), a copy of which is
-available along with the File in the license.txt file or by writing to the Free
-Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 or
-on the worldwide web at http://www.gnu.org/licenses/gpl.txt.
-
-THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE IMPLIED
-WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY
-DISCLAIMED.  The GPL License provides additional details about this warranty
-disclaimer.
-********************************************************************************
-Marvell BSD License Option
-
-If you received this File from Marvell, you may opt to use, redistribute and/or
-modify this File under the following licensing terms.
-Redistribution and use in source and binary forms, with or without modification,
-are permitted provided that the following conditions are met:
-
-    *   Redistributions of source code must retain the above copyright notice,
-	this list of conditions and the following disclaimer.
-
-    *   Redistributions in binary form must reproduce the above copyright
-	notice, this list of conditions and the following disclaimer in the
-	documentation and/or other materials provided with the distribution.
-
-    *   Neither the name of Marvell nor the names of its contributors may be
-	used to endorse or promote products derived from this software without
-	specific prior written permission.
-
-THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
-ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
-WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
-DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
-ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
-(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
-LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
-ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
-(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
-SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-
-*******************************************************************************/
-
-#ifndef __INCmvDeviceIdh
-#define __INCmvDeviceIdh
-
-#ifdef __cplusplus
-extern "C" {
-#endif	/* __cplusplus */
-
-/* defines  */
-#define MARVELL_VEN_ID		    0x11ab
-
-/* Disco-3 */
-#define MV64460_DEV_ID          	0x6480
-#define MV64460B_DEV_ID         	0x6485
-#define MV64430_DEV_ID          	0x6420
-
-/* Disco-5 */
-#define MV64560_DEV_ID          	0x6450
-
-/* Disco-6 */
-#define MV64660_DEV_ID          	0x6460
-
-/* Orion */
-#define MV_1181_DEV_ID          	0x1181
-#define MV_5181_DEV_ID          	0x5181
-#define MV_5281_DEV_ID          	0x5281
-#define MV_5182_DEV_ID          	0x5182
-#define MV_8660_DEV_ID          	0x8660
-#define MV_5180_DEV_ID          	0x5180
-#define MV_5082_DEV_ID          	0x5082
-#define MV_1281_DEV_ID          	0x1281
-#define MV_6082_DEV_ID          	0x6082
-#define MV_6183_DEV_ID          	0x6183
-#define MV_6183L_DEV_ID          	0x6083
-
-#define MV_5281_D0_REV          	0x4
-#define MV_5281_D0_ID           	((MV_5281_DEV_ID << 16) | MV_5281_D0_REV)
-#define MV_5281_D0_NAME         "88F5281 D0"
-
-#define MV_5281_D1_REV          	0x5
-#define MV_5281_D1_ID           	((MV_5281_DEV_ID << 16) | MV_5281_D1_REV)
-#define MV_5281_D1_NAME         "88F5281 D1"
-
-#define MV_5281_D2_REV          	0x6
-#define MV_5281_D2_ID           	((MV_5281_DEV_ID << 16) | MV_5281_D2_REV)
-#define MV_5281_D2_NAME         "88F5281 D2"
-
-#define MV_5181L_A0_REV         	0x8	/* need for PCIE Er */
-#define MV_5181_A1_REV          	0x1	/* for USB Er .. */
-#define MV_5181_B0_REV          	0x2
-#define MV_5181_B1_REV          	0x3
-#define MV_5182_A1_REV          	0x1
-#define MV_5180N_B1_REV         	0x3
-#define MV_5181L_A0_ID          	((MV_5181_DEV_ID << 16) | MV_5181L_A0_REV)
-
-/* kw */
-#define MV_6281_DEV_ID          	0x6281
-#define MV_6282_DEV_ID          	0x1155
-#define MV_6192_DEV_ID          	0x6192
-#define MV_6190_DEV_ID          	0x6190
-#define MV_6180_DEV_ID          	0x6180
-#define MV_6280_DEV_ID          	0x6280
-
-#define MV_6281_A0_REV         		0x2
-#define MV_6281_A0_ID          		((MV_6281_DEV_ID << 16) | MV_6281_A0_REV)
-#define MV_6281_A0_NAME         	"88F6281 A0"
-
-#define MV_6192_A0_REV         		0x2
-#define MV_6192_A0_ID          		((MV_6192_DEV_ID << 16) | MV_6192_A0_REV)
-#define MV_6192_A0_NAME         	"88F6192 A0"
-
-#define MV_6190_A0_REV         		0x2
-#define MV_6190_A0_ID          		((MV_6190_DEV_ID << 16) | MV_6190_A0_REV)
-#define MV_6190_A0_NAME         	"88F6190 A0"
-
-#define MV_6180_A0_REV         		0x2
-#define MV_6180_A0_ID          		((MV_6180_DEV_ID << 16) | MV_6180_A0_REV)
-#define MV_6180_A0_NAME         	"88F6180 A0"
-
-#define MV_6281_A1_REV              0x3
-#define MV_6281_A1_ID               ((MV_6281_DEV_ID << 16) | MV_6281_A1_REV)
-#define MV_6281_A1_NAME             "88F6281 A1"
-
-#define MV_6282_A1_REV              0x3
-#define MV_6282_A1_ID               ((MV_6282_DEV_ID << 16) | MV_6282_A1_REV)
-#define MV_6282_A1_NAME             "88F6282 A1"
-
-#define MV_6280_A1_REV         		0x3
-#define MV_6280_A1_ID          		((MV_6280_DEV_ID << 16) | MV_6280_A0_REV)
-#define MV_6280_A1_NAME         	"88F6280 A1"
-
-#define MV_6192_A1_REV              0x3
-#define MV_6192_A1_ID               ((MV_6192_DEV_ID << 16) | MV_6192_A1_REV)
-#define MV_6192_A1_NAME             "88F6192 A1"
-
-#define MV_6190_A1_REV              0x3
-#define MV_6190_A1_ID               ((MV_6190_DEV_ID << 16) | MV_6190_A1_REV)
-#define MV_6190_A1_NAME             "88F6190 A1"
-
-#define MV_6180_A1_REV              0x3
-#define MV_6180_A1_ID               ((MV_6180_DEV_ID << 16) | MV_6180_A1_REV)
-#define MV_6180_A1_NAME             "88F6180 A1"
-
-#define MV_88F6XXX_A0_REV         	0x2
-#define MV_88F6XXX_A1_REV         	0x3
-/* Disco-Duo */
-#define MV_78XX0_ZY_DEV_ID       0x6381
-#define MV_78XX0_ZY_NAME         "MV78X00"
-
-#define MV_78XX0_Z0_REV         0x1
-#define MV_78XX0_Z0_ID          ((MV_78XX0_ZY_DEV_ID << 16) | MV_78XX0_Z0_REV)
-#define MV_78XX0_Z0_NAME        "78X00 Z0"
-
-#define MV_78XX0_Y0_REV         0x2
-#define MV_78XX0_Y0_ID          ((MV_78XX0_ZY_DEV_ID << 16) | MV_78XX0_Y0_REV)
-#define MV_78XX0_Y0_NAME        "78X00 Y0"
-
-#define MV_78XX0_DEV_ID       	0x7800
-#define MV_78XX0_NAME         	"MV78X00"
-
-#define MV_76100_DEV_ID      	0x7610
-#define MV_78200_DEV_ID      	0x7820
-#define MV_78100_DEV_ID      	0x7810
-#define MV_78XX0_A0_REV		0x1
-#define MV_78XX0_A1_REV		0x2
-
-#define MV_76100_NAME		"MV76100"
-#define MV_78100_NAME		"MV78100"
-#define MV_78200_NAME		"MV78200"
-
-#define MV_76100_A0_ID		((MV_76100_DEV_ID << 16) | MV_78XX0_A0_REV)
-#define MV_78100_A0_ID		((MV_78100_DEV_ID << 16) | MV_78XX0_A0_REV)
-#define MV_78200_A0_ID		((MV_78200_DEV_ID << 16) | MV_78XX0_A0_REV)
-
-#define MV_76100_A1_ID		((MV_76100_DEV_ID << 16) | MV_78XX0_A1_REV)
-#define MV_78100_A1_ID		((MV_78100_DEV_ID << 16) | MV_78XX0_A1_REV)
-#define MV_78200_A1_ID		((MV_78200_DEV_ID << 16) | MV_78XX0_A1_REV)
-
-#define MV_76100_A0_NAME	"MV76100 A0"
-#define MV_78100_A0_NAME	"MV78100 A0"
-#define MV_78200_A0_NAME	"MV78200 A0"
-#define MV_78XX0_A0_NAME	"MV78XX0 A0"
-
-#define MV_76100_A1_NAME	"MV76100 A1"
-#define MV_78100_A1_NAME	"MV78100 A1"
-#define MV_78200_A1_NAME	"MV78200 A1"
-#define MV_78XX0_A1_NAME	"MV78XX0 A1"
-
-/*MV88F632X family*/
-#define MV_6321_DEV_ID      	0x6321
-#define MV_6322_DEV_ID      	0x6322
-#define MV_6323_DEV_ID      	0x6323
-
-#define MV_6321_NAME		"88F6321"
-#define MV_6322_NAME		"88F6322"
-#define MV_6323_NAME		"88F6323"
-
-#define MV_632X_A1_REV		0x2
-
-#define MV_6321_A1_ID		((MV_6321_DEV_ID << 16) | MV_632X_A1_REV)
-#define MV_6322_A1_ID		((MV_6322_DEV_ID << 16) | MV_632X_A1_REV)
-#define MV_6323_A1_ID		((MV_6323_DEV_ID << 16) | MV_632X_A1_REV)
-
-#define MV_6321_A1_NAME		"88F6321 A1"
-#define MV_6322_A1_NAME		"88F6322 A1"
-#define MV_6323_A1_NAME		"88F6323 A1"
-
-/*MV88F6500 family*/
-#define MV_65XX_DEV_ID		0x6500
-#define MV_6510_DEV_ID		0x6510
-#define MV_6530_DEV_ID		0x6530
-#define MV_6550_DEV_ID		0x6550
-#define MV_6560_DEV_ID		0x6560
-
-#define MV_6510_Z0_REV         		0x1
-#define MV_6510_Z0_ID          		((MV_6510_DEV_ID << 16) | MV_6510_Z0_REV)
-#define MV_6510_Z0_NAME         	"88F6510 Z0"
-
-#define MV_6530_Z0_REV         		0x1
-#define MV_6530_Z0_ID          		((MV_6530_DEV_ID << 16) | MV_6530_Z0_REV)
-#define MV_6530_Z0_NAME         	"88F6530 Z0"
-
-#define MV_6550_Z0_REV         		0x1
-#define MV_6550_Z0_ID          		((MV_6550_DEV_ID << 16) | MV_6550_Z0_REV)
-#define MV_6550_Z0_NAME         	"88F6550 Z0"
-
-#define MV_6560_Z0_REV         		0x1
-#define MV_6560_Z0_ID          		((MV_6560_DEV_ID << 16) | MV_6560_Z0_REV)
-#define MV_6560_Z0_NAME         	"88F6560 Z0"
-
-
-/* KW40 */
-#define MV_6710_DEV_ID		0x6710
-
-#define MV_6710_Z1_REV		0x0
-#define MV_6710_Z1_ID		((MV_6710_DEV_ID << 16) | MV_6710_Z1_REV)
-#define MV_6710_Z1_NAME		"MV6710 Z1"
-
-#define MV_6710_A0_REV		0x0
-#define MV_6710_A0_ID		((MV_6710_DEV_ID << 16) | MV_6710_A0_REV)
-#define MV_6710_A0_NAME		"MV6710 A0"
-
-#define MV_6710_A1_REV		0x1
-#define MV_6710_A1_ID		((MV_6710_DEV_ID << 16) | MV_6710_A1_REV)
-#define MV_6710_A1_NAME		"MV6710 A1"
-
-#define MV_6W11_DEV_ID		0x6711
-
-#define MV_6W11_A0_REV		0x0
-#define MV_6W11_A0_ID		((MV_6W11_DEV_ID << 16) | MV_6W11_A0_REV)
-#define MV_6W11_A0_NAME		"MV6W11 A0"
-
-#define MV_6W11_A1_REV		0x1
-#define MV_6W11_A1_ID		((MV_6W11_DEV_ID << 16) | MV_6W11_A1_REV)
-#define MV_6W11_A1_NAME		"MV6W11 A1"
-
-#define MV_6707_DEV_ID		0x6707
-
-#define MV_6707_A0_REV		0x0
-#define MV_6707_A0_ID		((MV_6707_DEV_ID << 16) | MV_6707_A0_REV)
-#define MV_6707_A0_NAME		"MV6707 A0"
-
-#define MV_6707_A1_REV		0x1
-#define MV_6707_A1_ID		((MV_6707_DEV_ID << 16) | MV_6707_A1_REV)
-#define MV_6707_A1_NAME		"MV6707 A1"
-
-/* Armada XP Family */
-#define MV_78130_DEV_ID		0x7813
-#define MV_78160_DEV_ID		0x7816
-#define MV_78230_DEV_ID		0x7823
-#define MV_78260_DEV_ID		0x7826
-#define MV_78460_DEV_ID		0x7846
-#define MV_78000_DEV_ID		0x7888
-
-#define MV_FPGA_DEV_ID		0x2107
-
-#define MV_78XX0_Z1_REV		0x0
-
-#define MV_78130_Z1_ID		((MV_78130_DEV_ID << 16) | MV_78XX0_Z1_REV)
-#define MV_78130_Z1_NAME	"MV78130 Z1"
-
-#define MV_78160_Z1_ID		((MV_78160_DEV_ID << 16) | MV_78XX0_Z1_REV)
-#define MV_78160_Z1_NAME	"MV78160 Z1"
-
-#define MV_78230_Z1_ID		((MV_78230_DEV_ID << 16) | MV_78XX0_Z1_REV)
-#define MV_78230_Z1_NAME	"MV78230 Z1"
-
-#define MV_78260_Z1_ID		((MV_78260_DEV_ID << 16) | MV_78XX0_Z1_REV)
-#define MV_78260_Z1_NAME	"MV78260 Z1"
-
-#define MV_78460_Z1_ID		((MV_78460_DEV_ID << 16) | MV_78XX0_Z1_REV)
-#define MV_78460_Z1_NAME	"MV78460 Z1"
-
-#define MV_78XX0_A0_REV		0x1
-
-#define MV_78130_A0_ID         ((MV_78130_DEV_ID << 16) | MV_78XX0_A0_REV)
-#define MV_78130_A0_NAME       "MV78130 A0"
-
-#define MV_78160_A0_ID         ((MV_78160_DEV_ID << 16) | MV_78XX0_A0_REV)
-#define MV_78160_A0_NAME       "MV78160 A0"
-
-#define MV_78230_A0_ID         ((MV_78230_DEV_ID << 16) | MV_78XX0_A0_REV)
-#define MV_78230_A0_NAME       "MV78230 A0"
-
-#define MV_78260_A0_ID         ((MV_78260_DEV_ID << 16) | MV_78XX0_A0_REV)
-#define MV_78260_A0_NAME       "MV78260 A0"
-
-#define MV_78460_A0_ID         ((MV_78460_DEV_ID << 16) | MV_78XX0_A0_REV)
-#define MV_78460_A0_NAME       "MV78460 A0"
-
-#define MV_78XX0_B0_REV		0x2
-
-#define MV_78130_B0_ID         ((MV_78130_DEV_ID << 16) | MV_78XX0_B0_REV)
-#define MV_78130_B0_NAME       "MV78130 B0"
-
-#define MV_78160_B0_ID         ((MV_78160_DEV_ID << 16) | MV_78XX0_B0_REV)
-#define MV_78160_B0_NAME       "MV78160 B0"
-
-#define MV_78230_B0_ID         ((MV_78230_DEV_ID << 16) | MV_78XX0_B0_REV)
-#define MV_78230_B0_NAME       "MV78230 B0"
-
-#define MV_78260_B0_ID         ((MV_78260_DEV_ID << 16) | MV_78XX0_B0_REV)
-#define MV_78260_B0_NAME       "MV78260 B0"
-
-#define MV_78460_B0_ID         ((MV_78460_DEV_ID << 16) | MV_78XX0_B0_REV)
-#define MV_78460_B0_NAME       "MV78460 B0"
-
-#ifdef __cplusplus
-}
-#endif	/* __cplusplus */
-
-#endif				/* __INCmvDeviceIdh */
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_audio/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_audio/Makefile
index 6d3cf80..26fd67e 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_audio/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_audio/Makefile
@@ -1,12 +1,8 @@
 #
 # Makefile for the Marvell Audio ALSA Device Driver
 #
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 obj-$(CONFIG_SND_MRVL_AUDIO) += snd-mv88fx.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_audio_soc/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_audio_soc/Makefile
index 821ff91..7d6a9e6 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_audio_soc/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_audio_soc/Makefile
@@ -1,12 +1,8 @@
 #
 # Makefile for the Marvell Audio ALSA Device Driver
 #
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 obj-$(CONFIG_SND_MRVL_AUDIO) += snd-mv88fx-soc.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_btns/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_btns/Makefile
index afc2800..5926f8d 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_btns/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_btns/Makefile
@@ -1,12 +1,8 @@
 #
 # Makefile for the Marvell btns Driver
 #
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 obj-y += btns_driver.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/Makefile
index efc58b6..04f37af 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/Makefile
@@ -1,10 +1,9 @@
 #
 # Makefile for the Marvell CESA driver
 #
-ifeq ($(CONFIG_PLAT_ARMADA),y)
-	#include $(srctree)/$(MACHINE)/config/mvRules.mk
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
 
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 ifeq ($(CONFIG_MV_CESA_OCF),y)
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_dma/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_dma/Makefile
index 8cae7c9..c251c4d 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_dma/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_dma/Makefile
@@ -1,12 +1,8 @@
 #
 # Makefile for the Marvell DMA Driver
 #
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 obj-$(CONFIG_MV_USE_IDMA_ENGINE) += mv_dma.o 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_gpio/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_gpio/Makefile
index 773cf5b..f7cf581 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_gpio/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_gpio/Makefile
@@ -1,12 +1,8 @@
 #
 # Makefile for the Marvell GPIO Driver
 #
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 obj-y += mv_gpio.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_ipc/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_ipc/Makefile
index 9fd5e4d..89f41c9 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_ipc/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_ipc/Makefile
@@ -1,7 +1,8 @@
 #
 # Makefile for the Marvell IPC Pseudo Network driver
 #
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
+
 obj-$(CONFIG_MV_IPC_NET) += mv_ipc.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_ipc_net/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_ipc_net/Makefile
index 029e7ab..80d5b9e 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_ipc_net/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_ipc_net/Makefile
@@ -1,7 +1,8 @@
 #
 # Makefile for the Marvell Gigabit Ethernet driver
 #
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
+
 obj-$(CONFIG_MV_IPC_NET) += ipc_net.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/Makefile
index e295c01..03edfcd 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/Makefile
@@ -1,12 +1,7 @@
-
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
-endif
- 
 obj-$(CONFIG_MV_INCLUDE_SFLASH_MTD) 	+= sflash.o
 obj-$(CONFIG_MV_INCLUDE_MFLASH_MTD) 	+= mflash.o
 obj-$(CONFIG_MTD_NAND_LNC)		+= nand_lnc.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c
index d8def8a..d34e237 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c
@@ -993,7 +993,6 @@ static void orion_nfc_cmdfunc(struct mtd_info *mtd, unsigned command,
 				int column, int page_addr)
 {
 	struct orion_nfc_info *info = (struct orion_nfc_info *)((struct nand_chip *)mtd->priv)->priv;
-	int ret = 0;
 
 	info->data_size = 0;
 	info->state = STATE_READY;
@@ -1126,6 +1125,8 @@ static void orion_nfc_cmdfunc(struct mtd_info *mtd, unsigned command,
 		break;
 	case NAND_CMD_RESET:
 #if 0
+		int ret = 0;
+
 		info->column = 0;
 		info->page_addr = 0;
 		info->cmd = MV_NFC_CMD_RESET;
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/Makefile
index 866029a..4b9d12d 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/Makefile
@@ -2,16 +2,8 @@
 # Makefile for the Marvell Gigabit Ethernet driver
 #
 
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA370),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 ifeq ($(CONFIG_MV_ETH_NFP_LIB),y)
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
index 2b96780..d7d92be 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
@@ -3121,7 +3121,9 @@ int mv_eth_port_resume(int port)
 		printk(KERN_ERR "%s: port %d is not suspend.\n", __func__, port);
 		return -1;
 	}
+#if !defined(CONFIG_ARCH_ARMADA370)
 	mvNetaPortPowerUp(port, mvBoardIsPortInSgmii(port), !mvBoardIsPortInGmii(port));
+#endif
 
 	mv_eth_win_init(port);
 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_network/mv_ethernet/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_network/mv_ethernet/Makefile
index bb198d5..b8b3078 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_network/mv_ethernet/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_network/mv_ethernet/Makefile
@@ -1,12 +1,8 @@
 #
 # Makefile for the Marvell Gigabit Ethernet driver
 #
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 obj-$(CONFIG_MV_ETHERNET) += mv_netdev.o mv_ethernet.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_phone/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_phone/Makefile
index e268c90..b8015aa 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_phone/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_phone/Makefile
@@ -1,13 +1,8 @@
 #
 # Makefile for the Marvell Phone Device Driver
 #
-
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 VB_SRC_PATH = ../../mv_hal/voiceband
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_phone/test/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_phone/test/Makefile
index 0e30359..7382c2a 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_phone/test/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_phone/test/Makefile
@@ -1,12 +1,9 @@
-
-
 #
 # Makefile for the Marvell Phone Device Driver Test Module
 #
 #
-
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 obj-$(CONFIG_TDM_DEV_TEST_SUPPORT) += tdm_dev.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_sata/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_sata/Makefile
index 287f3be..bb83d5a 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_sata/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_sata/Makefile
@@ -1,9 +1,5 @@
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 IAL_OBJS        := mvLinuxIalLib.o mvLinuxIalHt.o mvLinuxIalOs.o mvIALCommon.o mvIALCommonUtils.o mvLinuxIalSmart.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_sdio/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_sdio/Makefile
index e77618a..129b4c0 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_sdio/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_sdio/Makefile
@@ -1,12 +1,8 @@
 #
 # Makefile for the Marvell Audio ALSA Device Driver
 #
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 obj-$(CONFIG_MMC_MVSDMMC)	+= mvsdmmc.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/Makefile
index 77cd9a1..d8937ea 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_switch/Makefile
@@ -1,12 +1,8 @@
 #
 # Makefile for the Marvell Key
 #
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
-endif
- 
 obj-$(CONFIG_MV_INCLUDE_SWITCH)	+= mv_switch.o mv_switch_sysfs.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_trace/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_trace/Makefile
index 0264247..d6df242 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_trace/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_trace/Makefile
@@ -1,12 +1,8 @@
 #
 # Makefile for the Marvell XOR/DMA Driver
 #
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 obj-$(CONFIG_MV_DBG_TRACE) += dbg-trace.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_tsu/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_tsu/Makefile
index 811d010..ea0e867 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_tsu/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_tsu/Makefile
@@ -1,8 +1,8 @@
 #
 # Makefile for the Marvell Transport Stream Unit driver
 #
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 obj-$(CONFIG_MV_TSU)	+= mv_tsu.o
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_udc/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_udc/Makefile
index a333829..18b966d 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_udc/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_udc/Makefile
@@ -1,12 +1,8 @@
 #
 # Makefile for the Marvell USB device controller
 #
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 USB_DIR := ../mv_hal/usb/
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_xor/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_xor/Makefile
index 5a94a9b..d32f30a 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_xor/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_xor/Makefile
@@ -1,12 +1,8 @@
 #
 # Makefile for the Marvell XOR/DMA Driver
 #
-ifeq ($(CONFIG_ARCH_FEROCEON),y)
-	include $(srctree)/$(MACHINE)/config/mvRules.mk
-endif
-
-ifeq ($(CONFIG_ARCH_ARMADA_XP),y)
-	include $(srctree)/arch/arm/mach-armadaxp/config/mvRules.mk
+ifneq ($(MACHINE),)
+include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
 obj-$(CONFIG_MV_USE_XOR_ENGINE) += mv_netdma.o
diff --git a/arch/arm/plat-armada/mv_hal/cntmr/mvCntmr.c b/arch/arm/plat-armada/mv_hal/cntmr/mvCntmr.c
index ac16df7..bcaac2cbd8 100644
--- a/arch/arm/plat-armada/mv_hal/cntmr/mvCntmr.c
+++ b/arch/arm/plat-armada/mv_hal/cntmr/mvCntmr.c
@@ -67,7 +67,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "ctrlEnv/mvCtrlEnvSpec.h"
 #include "mvSysCntmrConfig.h"
 #include "mvCntmrRegs.h"
-#include "cntmr/mvCntmr.h"
+#include "mvCntmr.h"
 #include "cpu/mvCpu.h"
 
 /* defines  */
@@ -79,7 +79,11 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 
 #define CNTMR_EVENTS_STATUS_REG_GLOBAL	(MV_CNTMR_REGS_OFFSET + 4)
 
+#if defined(CONFIG_ARCH_ARMADA370)
+#define TIMER_GLOBAL_BIT(timer)		(1 << (timer * 8 - ((timer == MAX_GLOBAL_TIMER) ? 1 : 0)))
+#else
 #define TIMER_GLOBAL_BIT(timer)		((timer == MAX_GLOBAL_TIMER) ? (1<<31) : (1 << (timer * 8)))
+#endif
 
 #if defined(MV88F78X60_Z1)
 #define CNTMR_EVENTS_STATUS_REG_PRIVATE(t)	(MV_CPUIF_REGS_OFFSET(TIMER_TO_CPU(t) + 0x68))
@@ -87,6 +91,9 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #elif defined(MV88F78X60) && !defined(MV88F78X60_Z1)
 #define CNTMR_EVENTS_STATUS_REG_PRIVATE		(MV_CPUIF_LOCAL_REGS_OFFSET + 0x68)
 #define TIMER_PRIVATE_BIT(timer)	(1 << ((timer - FIRST_PRIVATE_TIMER) * 8))
+#elif defined(CONFIG_ARCH_ARMADA370)
+#define CNTMR_EVENTS_STATUS_REG_PRIVATE (MV_CPUIF_REGS_OFFSET(0) + 0x68)
+#define TIMER_PRIVATE_BIT(timer)        (1 << ((timer - FIRST_PRIVATE_TIMER) * 8 + ((timer == TIMER7) ? 8 : 0)))
 #else
 #error "No device is defined!"
 #endif
diff --git a/arch/arm/plat-armada/mv_hal/cntmr/mvCntmrRegs.h b/arch/arm/plat-armada/mv_hal/cntmr/mvCntmrRegs.h
index 256dceb..0d3f2f3 100644
--- a/arch/arm/plat-armada/mv_hal/cntmr/mvCntmrRegs.h
+++ b/arch/arm/plat-armada/mv_hal/cntmr/mvCntmrRegs.h
@@ -151,8 +151,14 @@ extern "C" {
 #define CTCR_ARM_TIMER_EN(cntr)		(1 << CTCR_ARM_TIMER_EN_OFFS(cntr))
 #define CTCR_ARM_TIMER_DIS(cntr)	(0 << CTCR_ARM_TIMER_EN_OFFS(cntr))
 
+#if defined (CONFIG_ARCH_ARMADA370)
+#define CTCR_ARM_TIMER_AUTO_OFFS(timer) ((timer <= MAX_GLOBAL_TIMER) ? (1 + (timer * 2)) : \
+										(1 + (timer-FIRST_PRIVATE_TIMER) * 2))
+#else
 #define CTCR_ARM_TIMER_AUTO_OFFS(timer)	((timer <= MAX_GLOBAL_TIMER) ? (1 + (timer * 2)) : \
 										(1 + ((CPU_TIMER(timer))) * 2))
+#endif
+
 #define CTCR_ARM_TIMER_AUTO_MASK(cntr)	(1 << CTCR_ARM_TIMER_EN_OFFS(cntr))
 #define CTCR_ARM_TIMER_AUTO_EN(cntr)	(1 << CTCR_ARM_TIMER_AUTO_OFFS(cntr))
 #define CTCR_ARM_TIMER_AUTO_DIS(cntr)	(0 << CTCR_ARM_TIMER_AUTO_OFFS(cntr))
diff --git a/arch/arm/plat-armada/mv_hal/twsi/mvSysTwsi.h b/arch/arm/plat-armada/mv_hal/twsi/mvSysTwsi.h
new file mode 100644
index 0000000..2de87b8
--- /dev/null
+++ b/arch/arm/plat-armada/mv_hal/twsi/mvSysTwsi.h
@@ -0,0 +1,119 @@
+/*******************************************************************************
+Copyright (C) Marvell International Ltd. and its affiliates
+
+This software file (the "File") is owned and distributed by Marvell
+International Ltd. and/or its affiliates ("Marvell") under the following
+alternative licensing terms.  Once you have made an election to distribute the
+File under one of the following license alternatives, please (i) delete this
+introductory statement regarding license alternatives, (ii) delete the two
+license alternatives that you have not elected to use and (iii) preserve the
+Marvell copyright notice above.
+
+********************************************************************************
+Marvell Commercial License Option
+
+If you received this File from Marvell and you have entered into a commercial
+license agreement (a "Commercial License") with Marvell, the File is licensed
+to you under the terms of the applicable Commercial License.
+
+********************************************************************************
+Marvell GPL License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File in accordance with the terms and conditions of the General
+Public License Version 2, June 1991 (the "GPL License"), a copy of which is
+available along with the File in the license.txt file or by writing to the Free
+Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 or
+on the worldwide web at http://www.gnu.org/licenses/gpl.txt.
+
+THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE IMPLIED
+WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY
+DISCLAIMED.  The GPL License provides additional details about this warranty
+disclaimer.
+********************************************************************************
+Marvell BSD License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File under the following licensing terms.
+Redistribution and use in source and binary forms, with or without modification,
+are permitted provided that the following conditions are met:
+
+    *   Redistributions of source code must retain the above copyright notice,
+	this list of conditions and the following disclaimer.
+
+    *   Redistributions in binary form must reproduce the above copyright
+	notice, this list of conditions and the following disclaimer in the
+	documentation and/or other materials provided with the distribution.
+
+    *   Neither the name of Marvell nor the names of its contributors may be
+	used to endorse or promote products derived from this software without
+	specific prior written permission.
+
+THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
+ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
+ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
+ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
+SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+
+*******************************************************************************/
+
+#ifndef __INCmvSysTwsiH
+#define __INCmvSysTwsiH
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+
+/*******************************************************************************
+* mvSysTwsiInterruptEnable
+*
+* DESCRIPTION:
+*	Mask or unmask TWSI main interrupt cause bit.
+*
+* INPUT:
+*	chanNum	- TWSI channel number.
+*	enable	- MV_TRUE to enable the interrupt,
+*		  MV_FALSE to disable the interrupt.
+*
+* OUTPUT:
+*	None.
+*
+* RETURN:
+*	MV_OK on success,
+*	MV_ERROR otherwise.
+*
+*******************************************************************************/
+MV_STATUS mvSysTwsiInterruptEnable(MV_U32 chanNum, MV_BOOL enable);
+
+
+/*******************************************************************************
+* mvSysTwsiMainCauseIsSet
+*
+* DESCRIPTION:
+*	Check if the TWSI interrupt was triggered in the main interrupt cause
+*	register.
+*
+* INPUT:
+*	chanNum	- TWSI channel number.
+*
+* OUTPUT:
+*	None.
+*
+* RETURN:
+*	MV_TRUE if interrupt was triggered.
+*	MV_FALSE otherwise.
+*
+*******************************************************************************/
+MV_BOOL mvSysTwsiMainCauseIsSet(MV_U32 chanNum);
+
+#ifdef __cplusplus
+}
+#endif
+
+#endif
diff --git a/arch/arm/plat-armada/mv_hal/twsi/mvTwsi.c b/arch/arm/plat-armada/mv_hal/twsi/mvTwsi.c
index 932293e..80af82a 100644
--- a/arch/arm/plat-armada/mv_hal/twsi/mvTwsi.c
+++ b/arch/arm/plat-armada/mv_hal/twsi/mvTwsi.c
@@ -65,6 +65,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "mvCommon.h"
 #include "mvOs.h"
 #include "ctrlEnv/mvCtrlEnvSpec.h"
+#include "ctrlEnv/sys/mvCpuIfRegs.h"
 #include "cpu/mvCpu.h"
 #include "mvTwsi.h"
 #include "mvTwsiSpec.h"
diff --git a/arch/arm/plat-armada/mv_hal/xor/mvXorAddrDec.c b/arch/arm/plat-armada/mv_hal/xor/mvXorAddrDec.c
index da7ed88..d30a7b0 100644
--- a/arch/arm/plat-armada/mv_hal/xor/mvXorAddrDec.c
+++ b/arch/arm/plat-armada/mv_hal/xor/mvXorAddrDec.c
@@ -79,22 +79,22 @@ static MV_STATUS xorWinOverlapDetect(MV_U32 unit, MV_U32 winNum,
 
 MV_TARGET xorAddrDecPrioTap[] = {
 #if defined(MV_INCLUDE_PEX)
-#if PEX0_MEM_SIZE
+#if defined(PEX0_MEM_SIZE)
 	PEX0_MEM,
 #endif
-#if PEX1_MEM_SIZE
+#if defined(PEX1_MEM_SIZE)
 	PEX1_MEM,
 #endif
-#if PEX2_MEM_SIZE
+#if defined(PEX2_MEM_SIZE)
 	PEX2_MEM,
 #endif
-#if PEX3_MEM_SIZE
+#if defined(PEX3_MEM_SIZE)
 	PEX3_MEM,
 #endif
-#if PEX8_MEM_BASE
+#if defined(PEX8_MEM_BASE)
 	PEX8_MEM,
 #endif
-#if PEX9_MEM_BASE
+#if defined(PEX9_MEM_BASE)
 	PEX9_MEM,
 #endif
 #endif
@@ -117,8 +117,12 @@ MV_TARGET xorAddrDecPrioTap[] = {
 	DEV_CS1,
 #endif
 #if defined(MV_INCLUDE_CESA)
+#if defined(CONFIG_ARCH_ARMADA370)
+	CRYPT0_ENG,
+#else
 	CRYPT1_ENG,
 #endif
+#endif
 	TBL_TERM
 };
 
-- 
1.7.5.4

