From 0cf1955c49c59c7680874c020eecd0d340d17819 Mon Sep 17 00:00:00 2001
From: Evan <xswang@marvell.com>
Date: Mon, 26 May 2014 14:16:11 +0800
Subject: [PATCH 1682/1825] fix:alp:tpm: wrong inner pbit value when perform
 ext_tag_mod_ins vlan modification

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 250616540e0466d39f84e719cdeac97d879cce98

	bug reason: the current vlan subroutine template is not correct.
	This patch solve the issue of vlan subroutine with ext_tag_mod_ins.
	SYSTEMSW-660 : wrong inner pbit value when perform ext_tag_mod_ins vlan.

Signed-off-by: Evan <xswang@marvell.com>

Change-Id: Ife969800bb00a2a115228c9d63b86f50c5e6bf3b
Reviewed-on: http://vgitil04.il.marvell.com:8080/8197
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_tpm/src/core/tpm_pme.c       |    8 ++++++--
 1 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_pme.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_pme.c
index 8ea660d3..7c50d1b 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_pme.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_pme.c
@@ -990,8 +990,12 @@ static int tpm_pme_vlan_permu_parse(enum tpm_pme_vlan_oper_t vlan_op,
 	}
 
 	/* Set inner VLAN_CFG */
-	if (vlan_op == VLANOP_EXT_TAG_MOD_INS ||
-	    vlan_op == VLANOP_INS_2TAG) {
+	if (vlan_op == VLANOP_EXT_TAG_MOD_INS) {
+		pme_sw_entry[2].data = (TPM_VLAN_ETY_VLAN1 << TPM_PME_ETY_OFFS) |/* inner tpid keep*/
+				       tpm_pme_vid_permu[TPM_VLAN_VID_LOG_NEW] |
+				       (TPM_VLAN_PBIT_VLAN1 << TPM_PME_PBIT_OFFS);
+	}
+	if (vlan_op == VLANOP_INS_2TAG) {
 		pme_sw_entry[2].data = tpm_pme_tpid_permu[TPM_VLAN_ETY_LOG_REG1] |
 				       tpm_pme_vid_permu[TPM_VLAN_VID_LOG_NEW] |
 				       tpm_pme_pbit_permu[TPM_VLAN_PBIT_LOG_NEW];
-- 
1.7.5.4

