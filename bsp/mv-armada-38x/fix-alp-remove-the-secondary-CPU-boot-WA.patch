From cbe7ea973ce42c9a432e55ee1b5659ad3b84bfe9 Mon Sep 17 00:00:00 2001
From: Joe Zhou <shjzhou@marvell.com>
Date: Tue, 4 Mar 2014 13:27:57 +0800
Subject: [PATCH 1418/1825] fix: alp: remove the secondary CPU boot WA

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 8c82239bfe85cfa66f975f72910cd80a44a7a365

	CONFIG_ALP_CPU1_ENABLE_WA was defined for this WA. It is used by
	arch/arm/mach-avantalp/headsmp.S
	arch/arm/mach-avantalp/ca9x2.h
	arch/arm/mach-avantalp/core.c
	So this config cannot be simply removed and replaced by revision
	check in runtime.
	Revision check is added when calling alp_smp_cpu1_enable_wa, for A0, this
	function will not be called.

Change-Id: Ifa871bc86332c18d5e63adbeaa784fdad3b85dac
Signed-off-by: Joe Zhou <shjzhou@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/6105
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Tested-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/platsmp.c |   11 +++++++++--
 1 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-avantalp/platsmp.c b/arch/arm/mach-avantalp/platsmp.c
index 28c61d8..48c2af1 100644
--- a/arch/arm/mach-avantalp/platsmp.c
+++ b/arch/arm/mach-avantalp/platsmp.c
@@ -21,6 +21,7 @@
 #include "ctrlEnv/sys/mvCpuIfRegs.h"
 #include "ctrlEnv/mvSemaphore.h"
 #include "include/mach/smp.h"
+#include "boardEnv/mvBoardEnvLib.h"
 
 #include "core.h"
 
@@ -68,8 +69,14 @@ void __init platform_smp_prepare_cpus(unsigned int max_cpus)
 	 */
 	scu_enable(scu_base);
 
-	alp_smp_cpu1_enable_wa();
-
+	/*******************************************************************************
+	 * SMP WA to enable CPU1
+	 * Note: This function is called before PUnit IO windows are configured.
+	 */
+#if defined(CONFIG_SMP) && defined(CONFIG_ALP_CPU1_ENABLE_WA)
+	if (mvCtrlRevGet() <= MV_88F66X0_Z3_ID)
+		alp_smp_cpu1_enable_wa();
+#endif
 	/*
 	 * Write the address of secondary startup into the
 	 * system-wide flags register. The boot monitor waits
-- 
1.7.5.4

