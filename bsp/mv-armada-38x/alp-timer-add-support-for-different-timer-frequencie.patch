From 00061eec677adbf49b5d6bff884bce309e0f1d8e Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Wed, 17 Jul 2013 10:26:39 +0300
Subject: [PATCH 0841/1825] alp: timer: add support for different timer
 frequencies

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 6aac9d543bc8f005e0d74703d326eb1a67f9b338

	Marvell SoC global timer is ticked by half the L2 Cache clock.
	ARM Cortex-A9 private timer is ticked by the L2 Cache clock.
	This patch add support for all the support frequencies of
	Marvell SoC timer and ARM CA9 timer.

	See below (as example) the list of supported SoC frequencies for
	AvantaLP DB-6660:

	Marvell>> SatR list cpufreq
	cpufreq options - Determines the frequency of CPU/DDR/L2:

	| ID  | CPU Freq (Mhz) | DDR Freq (Mhz) | L2 Freq (Mhz) |
	---------------------------------------------------------
	|   6 |       400      |      400       |      200      |
	|  14 |       600      |      400       |      300      |
	|  21 |       800      |      534       |      400      |
	|  25 |      1000      |      500       |      500      |
	---------------------------------------------------------

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: Id45c789a3a10d6dc1327c3ecaa73d839465666d0
Reviewed-on: http://vgitil04.il.marvell.com:8080/2693
Reviewed-by: Igor Patrik <igorp@marvell.com>
Tested-by: Igor Patrik <igorp@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/core.c |    5 -----
 arch/arm/mach-avantalp/time.c |   17 +++++++++++++----
 2 files changed, 13 insertions(+), 9 deletions(-)

diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index 863c960..920e456 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -1406,11 +1406,6 @@ static void __init alp_l2x0_cache_init(void)
 
 static void __init alp_board_init(void)
 {
-	mvBoardEnvInit();
-	if (mvCtrlEnvInit()) {
-		pr_err("%s: Error: ctrlEnv init failed.\n", __func__);
-	}
-
 #ifdef CONFIG_MACH_AVANTA_LP_FPGA
 	/* Replace PCI-0 Attribute for FPGA 0xE => 0xD */
 	mvTargetDefaultsArray[PEX0_MEM].attrib = 0xD8;
diff --git a/arch/arm/mach-avantalp/time.c b/arch/arm/mach-avantalp/time.c
index 78190dc..7f9d9ac 100644
--- a/arch/arm/mach-avantalp/time.c
+++ b/arch/arm/mach-avantalp/time.c
@@ -159,9 +159,7 @@ struct clk {
 	unsigned int rate;
 };
 
-static struct clk twd_clk = {
-	.rate = 400000000,
-};
+static struct clk twd_clk;
 
 unsigned long clk_get_rate(struct clk *clk)
 {
@@ -194,6 +192,7 @@ static void __init alp_twd_init(void)
 	if (err)
 		pr_err("twd_local_timer_register failed %d\n", err);
 
+	clk_twd_lookup.clk->rate = mvCpuL2ClkGet();
 	clkdev_add(&clk_twd_lookup);
 }
 #else
@@ -253,10 +252,20 @@ static void __init alp_timer_init(void)
 {
 	u32 rate;
 
+	/*
+	 * Perform basic SoC HAL init, before accessing
+	 * HAL functions, e.g. mvCpuL2ClkGet().
+	 */
+	mvBoardEnvInit();
+	if (mvCtrlEnvInit()) {
+		pr_err("%s: Error: ctrlEnv init failed.\n", __func__);
+		return;
+	}
+
 #ifdef CONFIG_MACH_AVANTA_LP_FPGA
 	rate = 12500000;
 #else
-	rate = 200000000;
+	rate = mvCpuL2ClkGet() / 2;
 #endif
 
 	printk("Initializing AvantaLP SoC Timers\n");
-- 
1.7.5.4

