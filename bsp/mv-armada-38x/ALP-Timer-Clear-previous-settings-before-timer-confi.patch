From ccd7acadfc911697b3dbfb227a759ca42fd5fc54 Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Sun, 5 May 2013 08:48:31 +0300
Subject: [PATCH 0636/1825] ALP: Timer: Clear previous settings before timer
 config

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit ca6f27c812b4404e792cbedb19305da0906e092d

Change-Id: I048da2aa50b63c8ac9b622023fd6d8d8ebe1bca9
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/1749
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/time.c |   13 +++++++++----
 1 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/arch/arm/mach-avantalp/time.c b/arch/arm/mach-avantalp/time.c
index 7101a97..9629460 100644
--- a/arch/arm/mach-avantalp/time.c
+++ b/arch/arm/mach-avantalp/time.c
@@ -100,8 +100,7 @@ static void alp_clkevt_mode(enum clock_event_mode mode, struct clock_event_devic
 
 		/* Enable timer */
 		u = MV_REG_READ(TIMER_CTRL);
-		/* u |= TIMER_EN(t) | TIMER_RELOAD_EN(t); */
-		u |= (TIMER_EN(t) | TIMER_RELOAD_EN(t) | TIMER_TURN_25MHZ(t));
+		u |= TIMER_EN(t) | TIMER_RELOAD_EN(t) | TIMER_TURN_25MHZ(t);
 		MV_REG_WRITE(TIMER_CTRL, u);
 	} else {
 		/* Disable timer */
@@ -202,7 +201,6 @@ static void alp_setup_clocksource(int timer, long rate)
 	MV_REG_WRITE(TIMER_VAL(i), 0xffffffff);
 	MV_REG_WRITE(TIMER_RELOAD(i), 0xffffffff);
 
-
 	/* Config clock source for timer */
 	u = MV_REG_READ(TIMER_CTRL);
 #if !defined(CONFIG_MACH_AVANTA_LP_FPGA)
@@ -241,6 +239,12 @@ static void alp_setup_clockevent(int irq, long rate)
 	clockevents_config_and_register(evt, rate, 0x1, 0xffffffff);
 }
 
+static void alp_clear_timer_config(void)
+{
+	MV_REG_WRITE(TIMER_CTRL, 0);
+	MV_REG_WRITE(TIMER_CAUSE, 0);
+}
+
 static void __init alp_timer_init(void)
 {
 	u32 rate;
@@ -248,13 +252,14 @@ static void __init alp_timer_init(void)
 #ifdef CONFIG_MACH_AVANTA_LP_FPGA
 	rate = 12500000;
 #else
-	/* rate = 6250000; */ /* mvCpuL2ClkGet(); */
 	rate = 12500000;
 #endif
 
 	printk("Initializing AvantaLP SoC Timers\n");
 	ticks_per_jiffy = (rate + HZ/2) / HZ;
 
+	alp_clear_timer_config();
+
 	/* Global timer 0 - for clock source */
 	alp_setup_clocksource(0, rate);
 
-- 
1.7.5.4

