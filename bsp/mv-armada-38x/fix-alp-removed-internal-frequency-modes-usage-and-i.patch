From 61ce0d3a7e3fa321881cc2068185e45f06bb7346 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Wed, 27 Nov 2013 14:38:51 +0200
Subject: [PATCH 1163/1825] fix: alp: removed internal frequency modes usage
 and its existance from code

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 57882a48c78367612c1843e7bb1e9badd5e2374e

	- Disabled the ability to switch to an internal frequency mode
	- Removed all traces off internal frequencies from code

Change-Id: Ia815f093165785d16d8e5b37cce3a1c35289dff7
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4499
Reviewed-by: Kosta Zertsekel <konszert@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |    6 ++-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   43 +++++++++++++++----
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h        |    1 +
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h       |   33 ---------------
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |    1 -
 5 files changed, 39 insertions(+), 45 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index 861a702..2a6e980 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -500,13 +500,15 @@ MV_U32 mvBoardL2ClkGet(MV_VOID)
 	return MV_FPGA_L2_CLK;
 #else
 	MV_U32 clkSelect;
-	MV_FREQ_MODE freq[] = MV_SAR_FREQ_MODES;
+	MV_FREQ_MODE freqMode;
 
 	clkSelect = MV_REG_READ(MPP_SAMPLE_AT_RESET(1));
 	clkSelect = clkSelect & (0x1f << 17);
 	clkSelect >>= 17;
 
-	return 1000000 * freq[clkSelect].l2Freq;
+	mvCtrlFreqModeGet(clkSelect, &freqMode);
+
+	return 1000000 * freqMode.l2Freq;
 #endif
 }
 
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 0c91481..4214026 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -174,20 +174,47 @@ MV_BOOL mvCtrlIsSscgEnabled(MV_VOID)
 *******************************************************************************/
 MV_BOOL mvCtrlIsValidSatR(MV_VOID)
 {
-	MV_U32 i, cpuFreqMode, maxFreqModes = mvBoardFreqModesNumGet();
-	MV_FREQ_MODE pFreqModes[] = MV_USER_SAR_FREQ_MODES;
+	MV_U32 cpuFreqSatRMode;
+	MV_FREQ_MODE cpuFreqMode;
 
-	if (mvCtrlSatRRead(MV_SATR_CPU_DDR_L2_FREQ, &cpuFreqMode) != MV_OK) {
+	if (mvCtrlSatRRead(MV_SATR_CPU_DDR_L2_FREQ, &cpuFreqSatRMode) != MV_OK) {
 		mvOsPrintf("%s: Error: failed to read Frequency status\n", __func__);
 		return MV_FALSE;
 	}
 
+	/* Verify SatR Mode exists in user frequency modes table */
+	if (mvCtrlFreqModeGet(cpuFreqSatRMode, &cpuFreqMode) == MV_OK)
+		return MV_TRUE;
+	else
+		return MV_FALSE;
+}
+
+/*******************************************************************************
+* mvCtrlFreqModeGet
+*
+* DESCRIPTION: scan frequency modes table (CPU/L2/DDR) and return requested mode
+*
+* INPUT: freqModeSatRValue - Sample at reset value (represent a frequency mode)
+*
+* OUTPUT: MV_FREQ_MODE which describes the frequency mode (CPU/L2/DDR)
+*
+* RETURN:
+*        MV_OK if frequency mode is supported , else MV_ERROR
+*
+*******************************************************************************/
+MV_STATUS mvCtrlFreqModeGet(MV_U32 freqModeSatRValue, MV_FREQ_MODE *freqMode)
+{
+	MV_FREQ_MODE freqTable[] = MV_USER_SAR_FREQ_MODES;
+	MV_U32 i, maxFreqModes = mvBoardFreqModesNumGet();
+
 	for (i = 0; i < maxFreqModes; i++) {
-		if (cpuFreqMode == pFreqModes[i].id)
-			return MV_TRUE;
+		if (freqModeSatRValue == freqTable[i].id) {
+			*freqMode = freqTable[i];
+			return MV_OK;
+		}
 	}
 
-	return MV_FALSE;
+	return MV_ERROR;
 }
 
 #ifdef MV_INCLUDE_PEX
@@ -522,7 +549,6 @@ MV_VOID mvCtrlSmiMasterSet(MV_SMI_CTRL smiCtrl)
 *******************************************************************************/
 MV_STATUS mvCtrlCpuDdrL2FreqGet(MV_FREQ_MODE *freqMode)
 {
-	MV_FREQ_MODE freqTable[] = MV_SAR_FREQ_MODES;
 	MV_U32 freqModeSatRValue;
 
 	if (freqMode == NULL) {
@@ -535,8 +561,7 @@ MV_STATUS mvCtrlCpuDdrL2FreqGet(MV_FREQ_MODE *freqMode)
 		return MV_ERROR;
 	}
 
-	*freqMode = freqTable[freqModeSatRValue];
-	return MV_OK;
+	return mvCtrlFreqModeGet(freqModeSatRValue, freqMode);
 }
 
 /*******************************************************************************
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
index 5dd4dad..cb96765 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
@@ -258,6 +258,7 @@ MV_BOOL mvCtrlIsSscgEnabled(MV_VOID);
 MV_U32 mvCtrlGetQuadNum(MV_VOID);
 MV_STATUS mvCtrlUpdatePexId(MV_VOID);
 MV_BOOL mvCtrlIsValidSatR(MV_VOID);
+MV_STATUS mvCtrlFreqModeGet(MV_U32 freqModeSatRValue, MV_FREQ_MODE *freqMode);
 MV_STATUS mvCtrlBoardConfigGet(MV_U8 *tempVal);
 MV_U32 mvCtrlSocUnitInfoNumGet(MV_UNIT_ID unit);
 MV_STATUS mvCtrlEnvInit(MV_VOID);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
index d5dc452..2290193 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
@@ -320,39 +320,6 @@ typedef struct {
 	MV_U32 l2Freq;
 } MV_FREQ_MODE;
 
-#define MV_SAR_FREQ_MODES { \
-		{ 0,  266,  266, 133 }, \
-		{ 1,  333,  167, 167 }, \
-		{ 2,  333,  222, 167 }, \
-		{ 3,  333,  333, 167 }, \
-		{ 4,  400,  200, 200 }, \
-		{ 5,  400,  267, 200 }, \
-		{ 6,  400,  400, 200 }, \
-		{ 7,  500,  250, 250 }, \
-		{ 8,  500,  334, 250 }, \
-		{ 9,  500,  400, 250 }, \
-		{ 10, 533,  267, 267 }, \
-		{ 11, 533,  356, 267 }, \
-		{ 12, 533,  533, 267 }, \
-		{ 13, 600,  300, 300 }, \
-		{ 14, 600,  400, 300 }, \
-		{ 15, 600,  600, 300 }, \
-		{ 16, 666,  333, 333 }, \
-		{ 17, 666,  444, 333 }, \
-		{ 18, 666,  666, 333 }, \
-		{ 19, 800,  267, 400 }, \
-		{ 20, 800,  400, 400 }, \
-		{ 21, 800,  534, 400 }, \
-		{ 22, 900,  300, 450 }, \
-		{ 23, 900,  450, 450 }, \
-		{ 24, 900,  600, 450 }, \
-		{ 25, 1000, 500, 500 }, \
-		{ 26, 1000, 667, 500 }, \
-		{ 27, 1000, 500, 333 }, \
-		{ 28, 400,  400, 400 }, \
-		{ 29, 1100, 550, 550 } \
-};
-
 #define MV_USER_SAR_FREQ_MODES { \
 		{ 6,  400,  400, 200 }, \
 		{ 14, 600,  400, 300 }, \
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index 0a478f1..b522096 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -256,7 +256,6 @@ extern "C" {
 #ifndef MV_ASMLANGUAGE
 
 #define TBL_UNUSED      0       /* Used to mark unused entry */
-#define FREQ_MODES_NUM		29
 #define FREQ_MODES_NUM_6610	0
 #define FREQ_MODES_NUM_6650	4
 #define FREQ_MODES_NUM_6660	5
-- 
1.7.5.4

