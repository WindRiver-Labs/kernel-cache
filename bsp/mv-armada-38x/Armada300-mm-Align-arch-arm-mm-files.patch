From 04081df30438dcb7e2f51193625b6ca4a29313c5 Mon Sep 17 00:00:00 2001
From: Tawfik Bayouk <tawfik@marvell.com>
Date: Thu, 13 Dec 2012 19:43:46 +0200
Subject: [PATCH 0392/1825] Armada300,mm: Align arch/arm/mm files.

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 7018c1681c02aa3b35894c92f31382c09fa42e92

Change-Id: I38e79e3654cb694a85bea01ba02c682ae603577d
Signed-off-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mm/Kconfig             |    9 +++++++++
 arch/arm/mm/cache-feroceon-l2.c |    4 ++--
 arch/arm/mm/proc-feroceon.S     |   16 ++++++++++++++++
 3 files changed, 27 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mm/Kconfig b/arch/arm/mm/Kconfig
index 3ccaf71..a051dcf 100644
--- a/arch/arm/mm/Kconfig
+++ b/arch/arm/mm/Kconfig
@@ -1282,3 +1282,12 @@ config ARCH_HAS_BARRIERS
 	help
 	  This option allows the use of custom mandatory barriers
 	  included via the mach/barriers.h file.
+
+config ARM_ARMV5_L2_CACHE_COHERENCY_FIX
+	bool "Enable L2 coherency problem fix on ARMv5"
+	depends on OUTER_CACHE && CPU_CACHE_VIVT
+	default y
+	help
+	Fixes coherency problems on ARM systems that have
+	a non-disableable VIVT L1 cache and a PIPT L2 one.
+
diff --git a/arch/arm/mm/cache-feroceon-l2.c b/arch/arm/mm/cache-feroceon-l2.c
index 48bc3c0..b4e2ebb 100644
--- a/arch/arm/mm/cache-feroceon-l2.c
+++ b/arch/arm/mm/cache-feroceon-l2.c
@@ -130,11 +130,11 @@ static inline void l2_inv_all(void)
  * inclusive start and end addresses.
  */
 #define CACHE_LINE_SIZE		32
-#define MAX_RANGE_SIZE		1024
+#define MAX_RANGE_SIZE		PAGE_SIZE
 
 static int l2_wt_override;
 
-static unsigned long calc_range_end(unsigned long start, unsigned long end)
+static inline unsigned long calc_range_end(unsigned long start, unsigned long end)
 {
 	unsigned long range_end;
 
diff --git a/arch/arm/mm/proc-feroceon.S b/arch/arm/mm/proc-feroceon.S
index ba3c500..12996f2 100644
--- a/arch/arm/mm/proc-feroceon.S
+++ b/arch/arm/mm/proc-feroceon.S
@@ -119,11 +119,27 @@ ENDPROC(cpu_feroceon_reset)
  *
  * Called with IRQs disabled
  */
+#ifdef CONFIG_JTAG_DEBUG
+support_wait_for_interrupt_address:
+        .word   support_wait_for_interrupt
+#endif
+
 	.align	5
 ENTRY(cpu_feroceon_do_idle)
+#ifdef CONFIG_JTAG_DEBUG
+        ldr     r0, support_wait_for_interrupt_address
+        ldr     r0, [r0]
+        cmp     r0, #1    /* check if the device doesn't support wait for interrupt */
+        bne     1f        /* if yes, then go out */
+#endif
 	mov	r0, #0
+	mrc	p15, 0, r1, c1, c0, 0		@ Read control register
 	mcr	p15, 0, r0, c7, c10, 4		@ Drain write buffer
+	bic	r2, r1, #1 << 12
+	mcr	p15, 0, r2, c1, c0, 0		@ Disable I cache
 	mcr	p15, 0, r0, c7, c0, 4		@ Wait for interrupt
+	mcr	p15, 0, r1, c1, c0, 0		@ Restore ICache enable
+1:
 	mov	pc, lr
 
 /*
-- 
1.7.5.4

