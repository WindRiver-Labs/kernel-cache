From 37f193f629055d28ba6c4fe4d19ebae1a3be5ced Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Thu, 28 Mar 2013 18:33:16 +0200
Subject: [PATCH 0528/1825] ALP : TDM : Aligned TDM init sequence with board
 config scan

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 452313e2cadc383e6f13bb64d5e8329aa10ce895

- Updated mvCtrlTdmUnitTypeGet:
	If auto detect enabled, read TDM type from board configuration
	else use pre-defined type.
- Added mvBoardTdmMppModeGet:
	get TDM detection mode (Auto detect / Pre-defined)
- Updated mvBoardConfigInit with correct TDM MPP init
- Removed mvCtrlIsLantiqTDM, mvCtrlIsZarlinkTDM,
	  mvCtrlIsSiliconLabsTDM, mvCtrlIsExternalTDM

Change-Id: Iadba2419d82424ef173aefd141d0417f2b948ba7
Reviewed-on: http://vgitil04.il.marvell.com:8080/1392
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   49 ++++---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |   16 +--
 .../avanta_lp_family/boardEnv/mvBoardEnvSpec.c     |    4 +-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |  140 ++++++--------------
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h        |    7 +-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |   11 +-
 6 files changed, 89 insertions(+), 138 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index a506965..7573488 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -717,6 +717,28 @@ MV_U32 mvBoardGpioIntMaskGet(MV_U32 gppGrp)
 }
 
 /*******************************************************************************
+* mvBoardSlicMppModeGet - Get board MPP Group type for SLIC unit (pre-defined)
+*
+* DESCRIPTION:
+*	if not using auto detection mudules according to board configuration settings,
+*	use pre-defined SLIC type from board information
+*
+* INPUT:
+*       None.
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*       32bit value describing MPP control register value.
+*
+*******************************************************************************/
+MV_U32 mvBoardSlicMppModeGet(MV_VOID)
+{
+	return board->pBoardModTypeValue->boardMppSlic;
+}
+
+/*******************************************************************************
 * mvBoardMppGet - Get board dependent MPP register value
 *
 * DESCRIPTION:
@@ -772,7 +794,7 @@ MV_VOID mvBoardConfigInit(void)
 	MV_U32 ethSataComplexOptions = 0x0;
 	MV_ETH_COMPLEX_TOPOLOGY mac0con, mac1con;
 	MV_BOARD_BOOT_SRC bootDev;
-	MV_TDM_UNIT_TYPE tdmDev;
+	MV_SLIC_UNIT_TYPE slicDev;
 
 	/* Ethernet Complex initialization : */
 	if ( (mac0con = mvBoardMac0ConfigGet()) != MV_ERROR)
@@ -795,22 +817,9 @@ MV_VOID mvBoardConfigInit(void)
 	/* Group 0-1 - Boot device (or if SPI1 boot : Groups 3-4) */
 	bootDev = mvBoardBootDeviceGroupSet();
 
-	/* Group 2 - TDM unit */
-	tdmDev = mvCtrlTdmUnitTypeGet();
-	switch (tdmDev) {
-	case SLIC_LANTIQ_ID:
-		mvBoardMppTypeSet(2, SLIC_LANTIQ_UNIT);
-		break;
-	case SLIC_SILABS_ID:
-		mvBoardMppTypeSet(2, SLIC_SILABS_UNIT);
-		break;
-	case SLIC_ZARLINK_ID:
-		mvBoardMppTypeSet(2, SLIC_ZARLINK_UNIT);
-		break;
-	case SLIC_EXTERNAL_ID:
-		mvBoardMppTypeSet(2, SLIC_EXTERNAL_UNIT);
-		break;
-	}
+	/* Group 2 - SLIC Tdm unit */
+	slicDev = mvCtrlSlicUnitTypeGet();
+	mvBoardMppTypeSet(2, slicDev);
 
 	/* Groups 3-4  - (only if not Booting from SPI1)*/
 	if (bootDev != MSAR_0_BOOT_SPI1_FLASH) {
@@ -819,7 +828,7 @@ MV_VOID mvBoardConfigInit(void)
 		else
 			mvBoardMppTypeSet(3, SDIO_UNIT);
 
-		if (mvCtrlIsLantiqTDM())
+		if (slicDev == SLIC_LANTIQ_ID)
 			mvBoardMppTypeSet(4, GE1_CPU_SMI_CTRL_TDM_LQ_UNIT);
 		else    /*REF_CLK_OUT*/
 			mvBoardMppTypeSet(4, GE1_CPU_SMI_CTRL_REF_CLK_OUT);
@@ -871,7 +880,7 @@ MV_BOARD_BOOT_SRC mvBoardBootDeviceGroupSet()
 		mvBoardMppTypeSet(1, groupType);
 	case MSAR_0_BOOT_SPI1_FLASH:    /* MSAR_0_SPI1 - update Groups 3-4 */
 		mvBoardMppTypeSet(3, SDIO_SPI1_UNIT);
-		if (mvCtrlIsLantiqTDM())
+		if ( mvCtrlSlicUnitTypeGet() == SLIC_LANTIQ_ID)
 			mvBoardMppTypeSet(4, SPI1_CPU_SMI_CTRL_TDM_LQ_UNIT);
 		else    /*REF_CLK_OUT*/
 			mvBoardMppTypeSet(4, SPI1_CPU_SMI_CTRL_REF_CLK_OUT);
@@ -2294,7 +2303,7 @@ MV_BOARD_PEX_INFO *mvBoardPexInfoGet(void)
 *	MV_FALSE otherwise.
 *
 *******************************************************************************/
-MV_BOOL mvBoardModuleAutoDetectEnabled(void)
+MV_BOOL mvBoardModuleAutoDetectEnabled()
 {
 	return board->moduleAutoDetect;
 }
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index ca9fc33..22a251a 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -85,12 +85,10 @@ extern "C" {
 
 typedef enum _devBoardMppTypeClass {
 	MV_BOARD_AUTO,
-	MV_BOARD_TDM_2CH,
-	MV_BOARD_TDM_32CH,
-	MV_BOARD_RGMII0,
-	MV_BOARD_RGMII1,
-	MV_BOARD_SW_P4,
-	MV_BOARD_OTHER
+	MV_BOARD_SLIC_LANTIQ_ID,
+	MV_BOARD_SLIC_SILABS_ID,
+	MV_BOARD_SLIC_ZARLINK_ID,
+	MV_BOARD_SLIC_EXTERNAL_ID
 } MV_BOARD_MPP_TYPE_CLASS;
 
 typedef enum _devBoardOtherTypeClass {
@@ -102,8 +100,6 @@ typedef enum _devBoardOtherTypeClass {
 	MV_BOARD_UNKNOWN = 0x80000000
 } MV_BOARD_OTHER_TYPE_CLASS;
 
-#define MV_BOARD_TDM    MV_BOARD_TDM_32CH
-
 typedef struct _boardModuleTypeInfo {
 	MV_BOARD_MPP_TYPE_CLASS boardMppMod;
 	MV_BOARD_OTHER_TYPE_CLASS boardOtherMod;
@@ -111,7 +107,7 @@ typedef struct _boardModuleTypeInfo {
 
 /* omriii:  decide between MODULE_TYPE or MPP_TYPE */
 typedef struct _boardMppTypeInfo {
-	MV_BOARD_MPP_TYPE_CLASS boardMppTdm;
+	MV_BOARD_MPP_TYPE_CLASS boardMppSlic;
 
 	/* Ethernet / Sata complex                      */
 	/* A bitmask of MV_ETH_SATA_COMPLEX_OPTIONS     */
@@ -437,6 +433,7 @@ MV_32 mvBoardUSBVbusGpioPinGet(MV_32 devId);
 MV_32 mvBoardUSBVbusEnGpioPinGet(MV_32 devId);
 MV_BOOL mvBoardIsOurPciSlot(MV_U32 busNum, MV_U32 slotNum);
 MV_U32 mvBoardGpioIntMaskGet(MV_U32 gppGrp);
+MV_U32 mvBoardSlicMppModeGet(MV_VOID);
 MV_32 mvBoardMppGet(MV_U32 mppGroupNum);
 MV_32 mvBoardMppTypeGet(MV_U32 mppGroupNum);
 MV_VOID mvBoardMppTypeSet(MV_U32 mppGroupNum, MV_U32 groupType);
@@ -491,6 +488,7 @@ MV_STATUS mvBoardTwsiMuxChannelSet(MV_U8 muxChNum);
 MV_STATUS mvBoardTwsiReadByteThruMux(MV_U8 muxChNum, MV_U8 chNum, MV_TWSI_SLAVE *pTwsiSlave, MV_U8 *data);
 MV_BOARD_MAC_SPEED mvBoardMacSpeedGet(MV_U32 ethPortNum);
 MV_32 mvBoardSwitchCpuPortGet(MV_U32 switchIdx);
+MV_BOOL mvBoardModuleAutoDetectEnabled(void);
 MV_32 mvBoardSmiScanModeGet(MV_U32 switchIdx);
 MV_BOARD_PEX_INFO *mvBoardPexInfoGet(void);
 MV_STATUS mvBoardConfIdSet(MV_U16 conf);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
index 0d797c9..5105989 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
@@ -233,7 +233,7 @@ MV_BOARD_MAC_INFO db88f6660InfoBoardMacInfo[] = {
 };
 MV_BOARD_MPP_TYPE_INFO db88f6660InfoBoardModTypeInfo[] = {
 	{
-		.boardMppTdm = MV_BOARD_AUTO,
+		.boardMppSlic = MV_BOARD_AUTO,
 		.ethSataComplexOpt = DB_88F6660_ETH_DEFAULT,
 		.ethPortsMode = 0x0
 	}
@@ -333,7 +333,7 @@ MV_BOARD_MAC_INFO avanta_lp_customerInfoBoardMacInfo[] = {
 
 MV_BOARD_MPP_TYPE_INFO avanta_lp_customerInfoBoardModTypeInfo[] = {
 	{
-		.boardMppTdm = MV_BOARD_AUTO,
+		.boardMppSlic = MV_BOARD_AUTO,
 		.ethSataComplexOpt = 0x0,
 		.ethPortsMode = 0x0
 	}
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index d6477fd..624a05f 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -173,8 +173,9 @@ MV_STATUS mvCtrlEnvInit(MV_VOID)
 {
 	MV_U32 i, gppMask;
 
-	/* Use S@R and board config info, to Build Eth-Complex config & MPP group types */
-	mvBoardConfigInit();
+	/* If set to Auto Detect modules, read S@R and board config info, to build Eth-Complex config & MPP group types */
+	if (mvBoardModuleAutoDetectEnabled())
+		mvBoardConfigInit();
 
 	/* write MPP's config and Board general config */
 	mvBoardConfigWrite();
@@ -291,7 +292,7 @@ MV_VOID mvCtrlSMISet(MV_SMI_CTRL smiCtrl)
 {
 	MV_BOOL isSwSMICtrl   = (smiCtrl == SWITCH_SMI_CTRL ? MV_TRUE : MV_FALSE);
 	MV_BOOL isBootDevSPI1 = (MSAR_0_BOOT_SPI1_FLASH == mvBoardBootDeviceGet());
-	MV_BOOL isRefClkOut   = !mvCtrlIsLantiqTDM(); /* if not using Lantiq TDM, define REF_CLK_OUT */
+	MV_BOOL isRefClkOut   = !( mvCtrlSlicUnitTypeGet() == SLIC_LANTIQ_ID ); 	/* if not using Lantiq TDM, define REF_CLK_OUT */
 	MV_U8 groupTypeSelect = 0;
 
 	if (! ((smiCtrl == SWITCH_SMI_CTRL) || (smiCtrl == CPU_SMI_CTRL)) ) {
@@ -381,7 +382,7 @@ MV_U32 mvCtrlConfigGet(MV_CONFIG_TYPE_ID configField)
 * RETURN: NONE
 *
 *******************************************************************************/
-void mvCtrlSatrInit(void)
+MV_VOID mvCtrlSatrInit(void)
 {
 	MV_U8 tempVal[MV_IO_EXP_MAX_REGS];
 	MV_U32 tempRegNum;
@@ -389,6 +390,10 @@ void mvCtrlSatrInit(void)
 	MV_BOARD_CONFIG_TYPE_INFO confInfo;
 	int i = 0;
 
+	/* Verify that board support Auto detection from S@R & board configuration */
+	if (!mvBoardModuleAutoDetectEnabled())
+		return;
+
 	/* initialize all S@R & Board configuration fields to -1 (MV_ERROR) */
 	memset(&satrOptionsConfig, 0xff, sizeof(MV_U32) * MV_SATR_READ_MAX_OPTION );
 	memset(&boardOptionsConfig, 0xff, sizeof(MV_U32) * MV_CONFIG_TYPE_MAX_OPTION );
@@ -812,10 +817,37 @@ MV_U32 mvCtrlTdmMaxGet(MV_VOID)
 }
 
 /*******************************************************************************
-* mvCtrlTdmUnitTypeGet
+* mvCtrlSlicUnitTypeGet - return the TDM unit type being used
 *
 * DESCRIPTION:
-*	Scan all relevant TDM units, and return the TDM unit type being used (if any)
+*	if auto detection enabled, read TDM unit from board configuration
+*	else , read pre-defined TDM unit from board information struct.
+*
+* INPUT:
+*       None.
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*	The TDM unit type.
+*
+*******************************************************************************/
+MV_SLIC_UNIT_TYPE mvCtrlSlicUnitTypeGet(MV_VOID)
+{
+
+	if (mvBoardModuleAutoDetectEnabled())
+		return boardOptionsConfig[MV_CONFIG_SLIC_TDM_DEVICE];
+	else
+		return mvBoardSlicMppModeGet();
+}
+
+/*******************************************************************************
+* mvCtrlTdmUnitTypeGet - return the TDM unit type being used
+*
+* DESCRIPTION:
+*	if auto detection enabled, read TDM unit from board configuration
+*	else , read pre-defined TDM unit from board information struct.
 *
 * INPUT:
 *       None.
@@ -829,17 +861,11 @@ MV_U32 mvCtrlTdmMaxGet(MV_VOID)
 *******************************************************************************/
 MV_TDM_UNIT_TYPE mvCtrlTdmUnitTypeGet(MV_VOID)
 {
-	if (mvCtrlIsLantiqTDM())
-		return SLIC_LANTIQ_ID;  /* omriii: FIXME */
-	else if (mvCtrlIsZarlinkTDM())
-		return SLIC_ZARLINK_ID;
-	else if (mvCtrlIsSiliconLabsTDM())
-		return SLIC_SILABS_ID;
-	else if (mvCtrlIsExternalTDM())
-		return SLIC_EXTERNAL_ID;
-	else return MV_ERROR;
+
+	return TDM_UNIT_2CH;
 }
 
+
 /*******************************************************************************
  * mvCtrlTdmUnitIrqGet
  *
@@ -1328,90 +1354,6 @@ MV_U32 ctrlSizeRegRoundUp(MV_U32 size, MV_U32 alignment) /* kostaz: FIXME: remov
 }
 
 /*******************************************************************************
-* mvCtrlIsLantiqTDM
-*
-* DESCRIPTION:
-*       Check if device being uesd is lantiq TDM
-*
-* INPUT:
-*	None.
-*
-* OUTPUT:
-*       None.
-*
-* RETURN:
-*       MV_TRUE if device boot from SPI.
-*******************************************************************************/
-MV_BOOL mvCtrlIsLantiqTDM(MV_VOID)
-{
-	/* implement Scan process */
-	return MV_FALSE;
-}
-
-/*******************************************************************************
-* mvCtrlIsZarlinkTDM
-*
-* DESCRIPTION:
-*       Check if device being used is Zarlink TDM
-*
-* INPUT:
-*	None.
-*
-* OUTPUT:
-*       None.
-*
-* RETURN:
-*       MV_TRUE if device boot from SPI.
-*******************************************************************************/
-MV_BOOL mvCtrlIsZarlinkTDM(MV_VOID)
-{
-	/* implement Scan process */
-	return MV_FALSE;
-}
-
-/*******************************************************************************
-* mvCtrlIsSiliconLabsTDM
-*
-* DESCRIPTION:
-*       Check if device being used is Silicon Labs TDM
-*
-* INPUT:
-*	None.
-*
-* OUTPUT:
-*       None.
-*
-* RETURN:
-*       MV_TRUE if device boot from SPI.
-*******************************************************************************/
-MV_BOOL mvCtrlIsSiliconLabsTDM(MV_VOID)
-{
-	/* implement Scan process */
-	return MV_FALSE;
-}
-
-/*******************************************************************************
-* mvCtrlIsExternalTDM
-*
-* DESCRIPTION:
-*       Check if device being used is the External TDM Unit
-*
-* INPUT:
-*	None.
-*
-* OUTPUT:
-*       None.
-*
-* RETURN:
-*       MV_TRUE if device boot from SPI.
-*******************************************************************************/
-MV_BOOL mvCtrlIsExternalTDM(MV_VOID)
-{
-	/* implement Scan process */
-	return MV_FALSE;
-}
-
-/*******************************************************************************
 * mvCtrlIsBootFromNOR
 *
 * DESCRIPTION:
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
index 72c7929..68c83b3 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
@@ -263,7 +263,7 @@ typedef struct _boardSerdesConf {
 MV_STATUS mvCtrlSatRWrite(MV_SATR_TYPE_ID satrWriteField, MV_SATR_TYPE_ID satrReadField, MV_U8 val);
 MV_U32 mvCtrlSatRRead(MV_SATR_TYPE_ID satrField);
 MV_STATUS mvCtrlCpuDdrL2FreqGet(MV_FREQ_MODE *freqMode);
-void mvCtrlSatrInit(MV_VOID);
+MV_VOID mvCtrlSatrInit(MV_VOID);
 MV_U32 mvCtrlConfigGet(MV_CONFIG_TYPE_ID configField);
 MV_U32 mvCtrlGetCpuNum(MV_VOID);
 MV_U32 mvCtrlGetQuadNum(MV_VOID);
@@ -301,11 +301,8 @@ MV_U32 mvCtrlSdioSupport(MV_VOID);
 #endif
 MV_U32 mvCtrlTdmSupport(MV_VOID);
 MV_U32 mvCtrlTdmMaxGet(MV_VOID);
+MV_SLIC_UNIT_TYPE mvCtrlSlicUnitTypeGet(MV_VOID);
 MV_TDM_UNIT_TYPE mvCtrlTdmUnitTypeGet(MV_VOID);
-MV_BOOL mvCtrlIsLantiqTDM(MV_VOID);
-MV_BOOL mvCtrlIsZarlinkTDM(MV_VOID);
-MV_BOOL mvCtrlIsExternalTDM(MV_VOID);
-MV_BOOL mvCtrlIsSiliconLabsTDM(MV_VOID);
 MV_U32 mvCtrlTdmUnitIrqGet(MV_VOID);
 MV_U32 mvCtrlDevFamilyIdGet(MV_U16 ctrlModel);
 MV_U16 mvCtrlModelGet(MV_VOID);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index aca6751..77c4d0b 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -402,10 +402,15 @@ typedef enum {
 
 /* This enumerator defines the Marvell Units ID      */
 typedef enum {
-	SLIC_LANTIQ_ID,
-	SLIC_SILABS_ID,
+	SLIC_EXTERNAL_ID,
 	SLIC_ZARLINK_ID,
-	SLIC_EXTERNAL_ID
+	SLIC_SILABS_ID,
+	SLIC_LANTIQ_ID
+} MV_SLIC_UNIT_TYPE;
+
+typedef enum {
+	TDM_UNIT_2CH,
+	TDM_UNIT_8CH
 } MV_TDM_UNIT_TYPE;
 
 typedef enum _mvUnitId {
-- 
1.7.5.4

