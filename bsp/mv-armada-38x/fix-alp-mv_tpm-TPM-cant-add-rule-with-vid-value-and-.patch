From 38c07712b54c9500092c3c79219c9147d28ab037 Mon Sep 17 00:00:00 2001
From: Jing Hua <jinghua@marvell.com>
Date: Mon, 26 May 2014 15:32:53 +0800
Subject: [PATCH 1681/1825] fix: alp: mv_tpm: TPM cant add rule with vid value
 and vlan num

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 4f0d42adf10916890d0ef0e4e2336a7a18690616

	- tpm_mng_vlan_num_get, to match single tag and out VID value, inn VID value should be 0.
	- tpm_mng_cap_entry_add, key out VID value even for single tag rule.
	SYSTEMSW-658 - <TPM cant support vid value and vlan num in the same hardware forward rule>

Signed-off-by: Jing Hua <jinghua@marvell.com>

Change-Id: I2c7fad7ebc8665391101def0c38ab9ae65ba353c
Reviewed-on: http://vgitil04.il.marvell.com:8080/8198
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Evan Wang <xswang@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_tpm/src/conf/tpm_mng.c       |   15 ++++++++++++++-
 1 files changed, 14 insertions(+), 1 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/conf/tpm_mng.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/conf/tpm_mng.c
index 4523e64..d8c6751 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/conf/tpm_mng.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/conf/tpm_mng.c
@@ -730,6 +730,12 @@ int tpm_mng_vlan_num_get(
 	else if ((pkt_key->field_match_bm & TPM_MATCH_VID_INNER)
 		&& (pkt_key->inn_vid == TPM_ALL_VID))
 		*vlan_num = TPM_DOUBLE_VLAN;
+	else if (((pkt_key->field_match_bm & TPM_MATCH_VID_INNER) && (pkt_key->field_match_bm & TPM_MATCH_VID_OUTER))
+		&& ((pkt_key->inn_vid == TPM_NO_VID) && (pkt_key->out_vid & TPM_SPEC_VID)))
+		*vlan_num = TPM_SINGLE_VLAN;
+	else if (((pkt_key->field_match_bm & TPM_MATCH_VID_INNER) && (pkt_key->field_match_bm & TPM_MATCH_PBITS_OUTER))
+		&& (pkt_key->inn_vid == TPM_NO_VID))
+		*vlan_num = TPM_SINGLE_VLAN;
 	else if ((pkt_key->field_match_bm & TPM_MATCH_VID_INNER)
 		&& (pkt_key->inn_vid == TPM_NO_VID))
 		*vlan_num = TPM_NOT_DOUBLE_VLAN;
@@ -4595,7 +4601,14 @@ int tpm_mng_cap_entry_add(
 		/* Handle case that check out VID for double or triple Tag packet */
 		if ((vlan_num == TPM_DOUBLE_VLAN || vlan_num == TPM_TRIPLE_VLAN) &&
 		    (field_match_bm & TPM_MATCH_VID_OUTER) &&
-		    (match_key->pkt_key->out_vid & TPM_SPEC_VID))
+		    (vlan_out & TPM_SPEC_VID))
+			match_key->pkt_key->field_match_bm |= TPM_MATCH_VID_OUTER;
+
+		if ((vlan_num == TPM_SINGLE_VLAN) &&
+		    (field_match_bm & TPM_MATCH_VID_INNER) &&
+		    (match_key->pkt_key->inn_vid == TPM_NO_VID) &&
+		    (field_match_bm & TPM_MATCH_VID_OUTER) &&
+		    (vlan_out & TPM_SPEC_VID))
 			match_key->pkt_key->field_match_bm |= TPM_MATCH_VID_OUTER;
 
 		if (vlan_num == TPM_TRIPLE_VLAN &&
-- 
1.7.5.4

