From ca04539152a3493bb7bbad4199b2638399e767f1 Mon Sep 17 00:00:00 2001
From: Victor Gu <xigu@marvell.com>
Date: Thu, 27 Feb 2014 15:10:12 +0800
Subject: [PATCH 1420/1825] fix: alp: pon: Run script to configure WRR with
 ifconfig pon0 port down/up action cause ONT mode
 from GPON to EPON

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit a4ce2eb22e5f280a5c92c1ba78033da5ea5c6bd8

    SYSTEMSW-368
Signed-off-by: Victor Gu <xigu@marvell.com>

Change-Id: Id6103e79631711edbc2bf32519b982a35b6aef51
Reviewed-on: http://vgitil04.il.marvell.com:8080/5978
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pon/core/epon/eponOnuApi.c   |    6 ------
 .../mv_drivers_lsp/mv_pon/core/epon/eponOnuIsr.c   |    4 ++++
 .../mv_drivers_lsp/mv_pon/core/epon/eponOnuMngr.c  |    9 +++++++++
 .../mv_drivers_lsp/mv_pon/core/gpon/gponOnuAlrm.c  |    3 +++
 .../mv_drivers_lsp/mv_pon/core/gpon/gponOnuApi.c   |    6 ------
 .../mv_pon/core/gpon/gponOnuMngrStateMachine.c     |    6 ++++++
 6 files changed, 22 insertions(+), 12 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuApi.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuApi.c
index d153f19..45df9c2 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuApi.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuApi.c
@@ -893,9 +893,6 @@ MV_STATUS mvEponApiAdminUpSet(int port_id)
 		return MV_ERROR;
 	}
 
-	/* set onu to port state up */
-	onuEponDbOnuEponPortStateSet(ONU_PON_PORT_UP);
-
 	return MV_OK;
 }
 
@@ -917,9 +914,6 @@ MV_STATUS mvEponApiAdminDownSet(int port_id)
 {
 	MV_STATUS status;
 
-	/* set onu to port state down */
-	onuEponDbOnuEponPortStateSet(ONU_PON_PORT_DOWN);
-
 	/* Enable MAC RX */
 	status = mvOnuEponMacOnuRxEnableSet(ONU_RX_DIS);
 	if (status != MV_OK) {
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuIsr.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuIsr.c
index d27b8a5..bc3d6f5 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuIsr.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuIsr.c
@@ -210,6 +210,8 @@ void onuEponIsrRoutine(MV_U32 event, MV_U32 status)
 					mvPonPrint(PON_PRINT_DEBUG, PON_ISR_INT_MODULE,
 						   "DEBUG: (%s:%d) Notify link is UP\n", __FILE_DESC__, __LINE__);
 				}
+				/* set onu to port state up */
+				onuEponDbOnuEponPortStateSet(ONU_PON_PORT_UP);
 			}
 		} else if (state == MV_TRUE) { /* alarm is ON */
 			if (onuEponDbP2PForceModeGet())
@@ -1071,6 +1073,8 @@ MV_STATUS mvP2PStart(void)
 		mvPonPrint(PON_PRINT_DEBUG, PON_ISR_INT_MODULE,
 			   "DEBUG: (%s:%d) Notify link is UP\n", __FILE_DESC__, __LINE__);
 	}
+	/* set onu to port state up */
+	onuEponDbOnuEponPortStateSet(ONU_PON_PORT_UP);
 #endif  /* PON_Z1 */
 
 	return MV_OK;
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuMngr.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuMngr.c
index d5e9424..de790c3 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuMngr.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuMngr.c
@@ -510,6 +510,9 @@ void onuEponPonMngAlarmHandlerExecute(MV_U32 macId)
 			mvPonPrint(PON_PRINT_INFO, PON_MNG_MODULE, "===================\n");
 			mvPonPrint(PON_PRINT_INFO, PON_MNG_MODULE, "== MPCP Sync Off ==\n");
 			mvPonPrint(PON_PRINT_INFO, PON_MNG_MODULE, "===================\n");
+
+			/* set onu to port state down */
+			onuEponDbOnuEponPortStateSet(ONU_PON_PORT_DOWN);
 		}
 	}
 
@@ -1796,6 +1799,9 @@ MV_STATUS onuEponPonMngRegMsgFlagAck(S_OnuEponRegMpcFrame *mpcFrame)
 		mvPonPrint(PON_PRINT_INFO, PON_MNG_MODULE, "==================\n");
 	}
 
+	/* set onu to port state up */
+	onuEponDbOnuEponPortStateSet(ONU_PON_PORT_UP);
+
 	/* Call link status callback function */
 	linkStatusCallback = onuEponDbLinkStatusCallbackGet();
 	if (linkStatusCallback != NULL) {
@@ -2068,6 +2074,9 @@ MV_STATUS onuEponPonMngRegMsgFlagDeReg(S_OnuEponRegMpcFrame *mpcFrame)
 	} else
 		onuEponPonMngAlarmHandlerExecute(macId);
 
+	/* set onu to port state down */
+	onuEponDbOnuEponPortStateSet(ONU_PON_PORT_DOWN);
+
 	return MV_OK;
 }
 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuAlrm.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuAlrm.c
index f8e6f40..9320393 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuAlrm.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuAlrm.c
@@ -330,6 +330,9 @@ void onuGponAlarmProcess(void)
 				if (linkStatusCallback != NULL)
 					linkStatusCallback(MV_PON_LOGIC_PORT_GET(), MV_FALSE);
 
+				/* set onu to port state down */
+				onuGponDbOnuGponPortStateSet(ONU_PON_PORT_DOWN);
+
 				/* onuPonTxPowerOn(MV_FALSE); */
 				onuPonTxPowerTimerStateSet(MV_TRUE);
 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuApi.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuApi.c
index cd897c7..c8e7c59e 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuApi.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuApi.c
@@ -2087,9 +2087,6 @@ MV_STATUS onuGponApiAdminUpSet(int port_id)
 		return MV_ERROR;
 	}
 
-	/* set onu to port state up */
-	onuGponDbOnuGponPortStateSet(ONU_PON_PORT_UP);
-
 	return MV_OK;
 }
 
@@ -2111,9 +2108,6 @@ MV_STATUS onuGponApiAdminDownSet(int port_id)
 {
 	MV_STATUS status;
 
-	/* set onu to port state down */
-	onuGponDbOnuGponPortStateSet(ONU_PON_PORT_DOWN);
-
 	/* Disable MAC RX */
 	status = mvOnuGponMacRxConfigSet(MV_FALSE);
 	if (status != MV_OK) {
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuMngrStateMachine.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuMngrStateMachine.c
index a006fb8c4..4fe59e0 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuMngrStateMachine.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuMngrStateMachine.c
@@ -1115,6 +1115,9 @@ void onuGponPonMngRangeTimeMsg(MV_U8 onuId, MV_U8 msgId, MV_U8 *msgData)
 		linkStatusCallback = onuGponDbLinkStatusCallbackGet();
 		if (linkStatusCallback != NULL)
 			linkStatusCallback(MV_PON_LOGIC_PORT_GET(), MV_TRUE);
+
+		/* set onu to port state up */
+		onuGponDbOnuGponPortStateSet(ONU_PON_PORT_UP);
 	} else { /* operational state */
 		/* get current delay */
 		currentDelay = onuGponDbEqualizationDelayGet();
@@ -1332,6 +1335,9 @@ void onuGponPonMngDactOnuIdMsg(MV_U8 onuId, MV_U8 msgId, MV_U8 *msgData)
 		linkStatusCallback = onuGponDbLinkStatusCallbackGet();
 		if (linkStatusCallback != NULL)
 			linkStatusCallback(MV_PON_LOGIC_PORT_GET(), MV_FALSE);
+
+		/* set onu to port state down */
+		onuGponDbOnuGponPortStateSet(ONU_PON_PORT_DOWN);
 	}
 
 #ifdef MV_GPON_PERFORMANCE_CHECK
-- 
1.7.5.4

