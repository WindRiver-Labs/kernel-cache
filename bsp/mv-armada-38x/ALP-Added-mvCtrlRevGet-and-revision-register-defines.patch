From 965ef07eadd6b4c695ab148377e7dd155a8a2437 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Wed, 17 Apr 2013 20:18:49 +0300
Subject: [PATCH 0595/1825] ALP: Added mvCtrlRevGet and revision register
 defines

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 08d3635ae276db9b49855348ff30bd76197f1c38

- fixed mvBoardTclkGet to use direct TWSI read

Change-Id: Id8062feb2738c9aadd2279b6f9d959b38e7ef626
Reviewed-on: http://vgitil04.il.marvell.com:8080/1607
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |    4 ++-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   33 +++----------------
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h       |    3 ++
 3 files changed, 12 insertions(+), 28 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index dfbb880..5b8a2a4 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -408,11 +408,13 @@ MV_BOOL mvBoardIsPortLoopback(MV_U32 ethPortNum)
 *******************************************************************************/
 MV_U32 mvBoardTclkGet(MV_VOID)
 {
+	MV_U32 value;
 #ifdef CONFIG_MACH_AVANTA_LP_FPGA
 	/* FPGA is limited to 25Mhz */
 	return MV_FPGA_CORE_CLK;
 #else
-	switch (mvCtrlSatRRead(MV_SATR_CORE_CLK_SELECT)) {
+	value = ((MV_REG_READ(MPP_SAMPLE_AT_RESET(1)) & (0x400000)) >> 22);
+	switch (value) {
 	case 0:
 		return _166MHz;
 	case 1:
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 71f2ff4..f1d4a2a 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -622,7 +622,7 @@ MV_STATUS mvCtrlEepromEnable(MV_BOOL enable)
 		return 	(mvBoardIoExpValSet(ioInfo, (enable? 0x1 : 0x0)));
 	}
 	mvOsPrintf("%s: Error: Read from IO expander failed (EEPROM enabled jumper)\n", __func__);
-	return MV_FALSE;
+	return MV_ERROR;
 }
 
 /*******************************************************************************
@@ -998,7 +998,7 @@ MV_U32 mvCtrlTdmUnitIrqGet(MV_VOID)
 *
 * DESCRIPTION:
 *       This function returns 16bit describing the device model (ID) as defined
-*       in PCI Device and Vendor ID configuration register offset 0x0.
+*       in Vendor ID configuration register
 *
 * INPUT:
 *       None.
@@ -1035,7 +1035,7 @@ MV_U16 mvCtrlModelGet(MV_VOID)
 *
 * DESCRIPTION:
 *       This function returns 8bit describing the device revision as defined
-*       in PCI Express Class Code and Revision ID Register.
+*       Revision ID Register.
 *
 * INPUT:
 *       None.
@@ -1049,31 +1049,10 @@ MV_U16 mvCtrlModelGet(MV_VOID)
 *******************************************************************************/
 MV_U8 mvCtrlRevGet(MV_VOID)
 {
-	CTRL_ENV_INFO *ci = &ctrlEnvInfo;
-	MV_U8 revNum;
-
-	if (ci->ctrlRev != MV_INVALID_CTRL_REV)
-		return ci->ctrlRev;
-
-#if defined(MV_INCLUDE_CLK_PWR_CNTRL)
-	/* Check pex power state */
-	MV_U32 pexPower;
-	pexPower = mvCtrlPwrClckGet(PEX_UNIT_ID, 0);
-	if (pexPower == MV_FALSE)
-		mvCtrlPwrClckSet(PEX_UNIT_ID, 0, MV_TRUE);
-#endif
-
-	revNum = (MV_U8)MV_REG_READ(PEX_CFG_DIRECT_ACCESS(
-					    0, PCI_CLASS_CODE_AND_REVISION_ID));
-
-#if defined(MV_INCLUDE_CLK_PWR_CNTRL)
-	/* Return to power off state */
-	if (pexPower == MV_FALSE)
-		mvCtrlPwrClckSet(PEX_UNIT_ID, 0, MV_FALSE);
-#endif
+	MV_U8 value;
 
-	ci->ctrlRev = ((revNum & PCCRIR_REVID_MASK) >> PCCRIR_REVID_OFFS);
-	return ci->ctrlRev;
+	value = MV_REG_READ(DEVICE_VERSION_ID_REG);
+	return  ((value & (DEVICE_VERSION_ID_REG_REV_ID_MASK) ) >> DEVICE_VERSION_ID_REG_REV_ID_OFFS);
 }
 
 /*******************************************************************************
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
index d6ec910..e7759d4 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvRegs.h
@@ -130,6 +130,9 @@ extern "C" {
 #define DEVICE_ID_REG_VEND_ID_MASK               0xFFFF
 #define DEVICE_ID_REG_DEV_ID_OFFS                16
 #define DEVICE_ID_REG_DEV_ID_MASK                0xFFFF0000
+#define DEVICE_VERSION_ID_REG                    0x1823C
+#define DEVICE_VERSION_ID_REG_REV_ID_OFFS        8
+#define DEVICE_VERSION_ID_REG_REV_ID_MASK        0xF00
 
 /* SYSRSTn Length Counter */
 #define SYSRST_LENGTH_COUNTER_REG               0x18250
-- 
1.7.5.4

