From 5185aa395f4a4d78eeb29acd5aab7f8d38699a93 Mon Sep 17 00:00:00 2001
From: Joe Zhou <shjzhou@marvell.com>
Date: Fri, 21 Feb 2014 11:28:06 +0800
Subject: [PATCH 1498/1825] alp: cesa: add cesa support for ALP-A0

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit b11003ccd72a04e6a8fc7452fce870b46d736662

Signed-off-by: Joe Zhou <shjzhou@marvell.com>

Change-Id: I32e7ecff233255cdad517e87d9c095c56b4eda0c
Reviewed-on: http://vgitil04.il.marvell.com:8080/5869
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Tested-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |   13 ++++++++-----
 arch/arm/mach-avantalp/config/mvSysCesaConfig.h    |    9 +++++++++
 arch/arm/mach-avantalp/sysmap.c                    |   17 +++++++++++++----
 .../arm/plat-armada/mv_drivers_lsp/mv_cesa/Kconfig |    8 ++++----
 arch/arm/plat-armada/mv_hal/cesa/mvCesa.c          |    7 +++++++
 5 files changed, 41 insertions(+), 13 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index aa70576..661d778 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -495,10 +495,11 @@ typedef enum _mvTarget {
 	DEV_BOOCS,	/* 23 DEV_BOOCS			*/
 	USB3,		/* 24 USB3			*/
 	CRYPT0_ENG,	/* 25 Crypto0 Engine		*/
-	PP2_CPU0,	/* 26 PP2 - CPU 0		*/
-	PP2_CPU1,	/* 27 PP2 - CPU 1		*/
-	DFEV,		/* 28 DFEV Unit			*/
-	DRAGONITE,	/* 29 Dragonite co-processor	*/
+	CRYPT1_ENG,	/* 26 Crypto1 Engine		*/
+	PP2_CPU0,	/* 27 PP2 - CPU 0		*/
+	PP2_CPU1,	/* 28 PP2 - CPU 1		*/
+	DFEV,		/* 29 DFEV Unit			*/
+	DRAGONITE,	/* 30 Dragonite co-processor	*/
 	MAX_TARGETS
 } MV_TARGET;
 
@@ -548,7 +549,8 @@ typedef enum _mvTarget {
 	{ MAIN_BOOT_ATTR, DEV_TARGET_ID	},	/* Main Boot device      */ \
 	{ SEC_BOOT_ATTR, DEV_TARGET_ID	},	/* Secondary Boot device */ \
 	{ 0x00, USB3_TARGET_ID },               /* USB3                  */ \
-	{ 0x01, CRYPT_TARGET_ID	},		/* CRYPT_ENG0            */ \
+	{ 0x09, CRYPT_TARGET_ID	},		/* CRYPT_ENG0            */ \
+	{ 0x05, CRYPT_TARGET_ID	},		/* CRYPT_ENG1            */ \
 	{ 0x00, PP2_TARGET_ID	},		/* PP2 - CPU 0           */ \
 	{ 0x01, PP2_TARGET_ID	},		/* PP2 - CPU 1           */ \
 	{ 0x00, DFEV_TARGET_ID },		/* DFEV			 */ \
@@ -582,6 +584,7 @@ typedef enum _mvTarget {
 	"BOOT_ROM_CS",		/* BOOT_ROM_CS */	\
 	"DEV_BOOTCS",		/* DEV_BOOCS */		\
 	"USB3",                 /* USB3 */		\
+	"CRYPT0_ENG",		/* CRYPT0_ENG */	\
 	"CRYPT1_ENG",		/* CRYPT1_ENG */	\
 	"PP2 - CPU 0",		/* PP2 - CPU 0 */	\
 	"PP2 - CPU 1",		/* PP2 - CPU 1 */	\
diff --git a/arch/arm/mach-avantalp/config/mvSysCesaConfig.h b/arch/arm/mach-avantalp/config/mvSysCesaConfig.h
index 141e9a4..4735ff8 100644
--- a/arch/arm/mach-avantalp/config/mvSysCesaConfig.h
+++ b/arch/arm/mach-avantalp/config/mvSysCesaConfig.h
@@ -43,3 +43,12 @@ disclaimer.
 #ifdef CONFIG_MV_CESA_CHAIN_MODE
 	#define MV_CESA_CHAIN_MODE
 #endif
+#ifdef CONFIG_MV_CESA_INT_COALESCING_SUPPORT
+	#define MV_CESA_INT_COALESCING_SUPPORT
+	#define MV_CESA_INT_COAL_THRESHOLD (CONFIG_MV_CESA_INT_COAL_THRESHOLD)
+	#define MV_CESA_INT_COAL_TIME_THRESHOLD (CONFIG_MV_CESA_INT_COAL_TIME_THRESHOLD)
+#endif
+
+#ifdef CONFIG_MV_CESA_INT_PER_PACKET
+	#define MV_CESA_INT_PER_PACKET
+#endif
diff --git a/arch/arm/mach-avantalp/sysmap.c b/arch/arm/mach-avantalp/sysmap.c
index 3140bbf..6ad3843 100644
--- a/arch/arm/mach-avantalp/sysmap.c
+++ b/arch/arm/mach-avantalp/sysmap.c
@@ -36,6 +36,11 @@ struct map_desc MEM_TABLE[] = {
 #endif
 #endif /* !CONFIG_MV_ETH_PP2_1 */
 	{ CRYPT_ENG_VIRT_BASE(0),	__phys_to_pfn(CRYPT_ENG_PHYS_BASE(0)),	CRYPT_ENG_SIZE,	MT_DEVICE },
+#ifdef CONFIG_MV_CESA
+#if (CONFIG_MV_CESA_CHANNELS > 1)
+	{ CRYPT_ENG_VIRT_BASE(1),	__phys_to_pfn(CRYPT_ENG_PHYS_BASE(1)),	CRYPT_ENG_SIZE, MT_DEVICE},
+#endif
+#endif
 	{ IOCC_WA_WIN0_VIRT_BASE,	__phys_to_pfn(IOCC_WA_WIN0_PHYS_BASE),	SZ_64K,		MT_DEVICE },
 	{ DFEV_VIRT_BASE,		__phys_to_pfn(DFEV_PHYS_BASE),		SZ_1M,		MT_DEVICE },
 };
@@ -67,7 +72,8 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6660_Z[] = {
 	{{BOOTROM_PHYS_BASE,		0,	BOOTROM_SIZE		},	9,			DIS},	/* BOOTROM */
 	{{DEVICE_BOOTCS_PHYS_BASE,	0,	DEVICE_BOOTCS_SIZE	},	10,			DIS},	/* DEV_BOOCS */
 	{{USB3_REGS_PHYS_BASE_Z,    0,  USB3_REGS_SIZE      },  11,         EN},    /* USB3 */
-	{{CRYPT_ENG_PHYS_BASE(0),	0,	CRYPT_ENG_SIZE		},	12,			EN},	/* CRYPT_ENG */
+	{{TBL_UNUSED,           0,  TBL_UNUSED      },  TBL_UNUSED,     DIS},   /* CRYPT_ENG0 */
+	{{TBL_UNUSED,           0,  TBL_UNUSED      },  TBL_UNUSED,     DIS},   /* CRYPT_ENG1 */
 	{{PP2_CPU0_PHYS_BASE,		0,	PP2_SIZE		},	13,			EN},	/* PP2 - Zx */
 #ifdef CONFIG_SMP
 	{{PP2_CPU1_PHYS_BASE,		0,	PP2_SIZE		},	15,			EN},	/* PP2 - Zx */
@@ -106,7 +112,8 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6660[] = {
 		{{BOOTROM_PHYS_BASE,       0, BOOTROM_SIZE },       9,          DIS}, /* BOOTROM */
 		{{DEVICE_BOOTCS_PHYS_BASE, 0, DEVICE_BOOTCS_SIZE }, 10,         DIS}, /* DEV_BOOCS */
 		{{TBL_UNUSED,              0, TBL_UNUSED, },        TBL_UNUSED, DIS}, /* USB3 */
-		{{CRYPT_ENG_PHYS_BASE(0),  0, CRYPT_ENG_SIZE },     12,         EN},  /* CRYPT_ENG */
+		{{CRYPT_ENG_PHYS_BASE(0),  0, CRYPT_ENG_SIZE },     12,         EN},  /* CRYPT_ENG0 */
+		{{CRYPT_ENG_PHYS_BASE(1),  0, CRYPT_ENG_SIZE },     4,          EN},  /* CRYPT_ENG1 */
 		{{TBL_UNUSED,              0, TBL_UNUSED, },        TBL_UNUSED, DIS}, /* PP2.1 - A0 */
 		{{TBL_UNUSED,              0, TBL_UNUSED, },        TBL_UNUSED, DIS}, /* PP2.1 - A0 */
 		{{DFEV_PHYS_BASE,          0, DFEV_SIZE, },         7,          EN},  /* VOICE */
@@ -141,7 +148,8 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6650[] = {
 	{{BOOTROM_PHYS_BASE,		0,	BOOTROM_SIZE		},	9,			DIS},	/* BOOTROM */
 	{{DEVICE_BOOTCS_PHYS_BASE,	0,	DEVICE_BOOTCS_SIZE	},	10,			DIS},	/* DEV_BOOCS */
 	{{TBL_UNUSED,			0,	TBL_UNUSED		},	TBL_UNUSED,		DIS},	/* USB3 */
-	{{CRYPT_ENG_PHYS_BASE(0),	0,	CRYPT_ENG_SIZE		},	12,			EN},	/* CRYPT_ENG */
+	{{TBL_UNUSED,           0,  TBL_UNUSED      },  TBL_UNUSED,     DIS},   /* CRYPT_ENG0 */
+	{{TBL_UNUSED,           0,  TBL_UNUSED      },  TBL_UNUSED,     DIS},   /* CRYPT_ENG1 */
 #ifdef CONFIG_MV_ETH_PP2_1
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2.1 - A0 */
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2.1 - A0 */
@@ -183,7 +191,8 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6610[] = {
 	{{BOOTROM_PHYS_BASE,		0,	BOOTROM_SIZE		},	9,			DIS},	/* BOOTROM */
 	{{DEVICE_BOOTCS_PHYS_BASE,	0,	DEVICE_BOOTCS_SIZE	},	10,			DIS},	/* DEV_BOOCS */
 	{{TBL_UNUSED,			0,	TBL_UNUSED		},	TBL_UNUSED,		DIS},	/* USB3 */
-	{{CRYPT_ENG_PHYS_BASE(0),	0,	CRYPT_ENG_SIZE		},	12,			EN},	/* CRYPT_ENG */
+	{{TBL_UNUSED,           0,  TBL_UNUSED      },  TBL_UNUSED,     DIS},   /* CRYPT_ENG0 */
+	{{TBL_UNUSED,           0,  TBL_UNUSED      },  TBL_UNUSED,     DIS},   /* CRYPT_ENG1 */
 #ifdef CONFIG_MV_ETH_PP2_1
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* PP2 */
 #else
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/Kconfig b/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/Kconfig
index b7b204b..441c18f 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/Kconfig
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/Kconfig
@@ -15,9 +15,9 @@ config  MV_CESA_TOOL_ARMADA
 config MV_CESA_CHANNELS
 	int "Total CESA HW channels supported"
 	depends on MV_CESA
-	range 1 2 if ARCH_ARMADA_XP
+	range 1 2 if ARCH_ARMADA_XP || ARCH_AVANTA_LP
 	range 1 1 if ARCH_ARMADA370
-	default "2" if ARCH_ARMADA_XP
+	default "2" if ARCH_ARMADA_XP || ARCH_AVANTA_LP
 	default "1" if ARCH_ARMADA370
 	---help---
 	Select the number of CESA channels to be used for crypto operations acceleration.
@@ -26,7 +26,7 @@ choice
 	prompt "CESA Features"
 	depends on MV_CESA
 	default MV_CESA_CHAIN_MODE if (ARCH_ARMADA370 || ARMADA_XP_REV_Z1)
-	default MV_CESA_INT_COALESCING_SUPPORT if (ARMADA_XP_REV_A0 || ARMADA_XP_REV_B0)
+	default MV_CESA_INT_COALESCING_SUPPORT if (ARMADA_XP_REV_A0 || ARMADA_XP_REV_B0 || ARCH_AVANTA_LP)
 
 config MV_CESA_CHAIN_MODE
 	bool "Support CESA chain-mode"
@@ -36,7 +36,7 @@ config MV_CESA_CHAIN_MODE
 
 config MV_CESA_INT_COALESCING_SUPPORT
 	bool "Support Interrupt Coalescing"
-	depends on MV_CESA && (ARMADA_XP_REV_A0 || ARMADA_XP_REV_B0)
+	depends on MV_CESA && (ARMADA_XP_REV_A0 || ARMADA_XP_REV_B0 || ARCH_AVANTA_LP)
 	---help---
 	Choosing this option will enable CESA interrupt coalescing support.
 
diff --git a/arch/arm/plat-armada/mv_hal/cesa/mvCesa.c b/arch/arm/plat-armada/mv_hal/cesa/mvCesa.c
index 6da7e43..38d8e5e 100644
--- a/arch/arm/plat-armada/mv_hal/cesa/mvCesa.c
+++ b/arch/arm/plat-armada/mv_hal/cesa/mvCesa.c
@@ -392,6 +392,13 @@ MV_STATUS mvCesaHalInit(int numOfSession, int queueDepth, void *osHandle, MV_CES
 				sha2CmdVal = BIT31;
 			}
 			break;
+		case 0x6600: /* Avanta-LP */
+			if (ctrlRev > 2) {
+				MV_REG_BIT_SET(MV_CESA_TDMA_CTRL_REG(chan),
+						       MV_CESA_TDMA_OUTSTAND_OUT_OF_ORDER_3TRANS_BIT);
+				sha2CmdVal = BIT31;
+			}
+			break;
 		case 0x6700: /* A370 */
 			/* Support maximum of 4 outstanding read transactions */
 			MV_REG_BIT_SET(MV_CESA_TDMA_CTRL_REG(chan), MV_CESA_TDMA_OUTSTAND_NEW_MODE_BIT);
-- 
1.7.5.4

