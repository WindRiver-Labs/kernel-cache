From 7d98d8dcb9342998556dc12675b9790b9da59456 Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Wed, 1 May 2013 03:07:41 +0300
Subject: [PATCH 0615/1825] ALP: Fix PCIe scan and memory mapping

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit fcee3d9529c34c03f6c647250b4b12971c376e19

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: Ic79da012c50858130c71f87d7101a92a14e2e3d3
Reviewed-on: http://vgitil04.il.marvell.com:8080/1707
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/pex.c |   21 +--------------------
 1 files changed, 1 insertions(+), 20 deletions(-)

diff --git a/arch/arm/mach-avantalp/pex.c b/arch/arm/mach-avantalp/pex.c
index 191e64a..0f0be0e 100644
--- a/arch/arm/mach-avantalp/pex.c
+++ b/arch/arm/mach-avantalp/pex.c
@@ -349,27 +349,8 @@ int __init mv_pex_setup(int nr, struct pci_sys_data *sys)
 struct pci_bus *mv_pex_scan_bus(int nr, struct pci_sys_data *sys)
 {
 	struct pci_ops *ops = &mv_pci_ops;
-	struct pci_bus *bus;
-	MV_BOARD_PEX_INFO* boardPexInfo = mvBoardPexInfoGet();
-	MV_U32 pexNextHWInf, ifnum;
-
-	bus = pci_scan_bus(sys->busnr, ops, sys);
-
-	/* Set the bus number in the following controller */
-	for (ifnum = (nr+1); ifnum < boardPexInfo->boardPexIfNum; ifnum++) {
-
-		pexNextHWInf = 0;
-
-		if (MV_FALSE == mvUnitMapIsPexMine(pexNextHWInf))
-			continue;
-
-		if (MV_TRUE == mvCtrlPwrClckGet(PEX_UNIT_ID, pexNextHWInf)) {
-			mvPexLocalBusNumSet(pexNextHWInf, (bus->subordinate + 1));
-			break;
-		}
-	}
 
-	return bus;
+	return pci_scan_root_bus(NULL, sys->busnr, ops, sys, &sys->resources);
 }
 
 static int __init mv_map_irq_0(struct pci_dev *dev, u8 slot, u8 pin)
-- 
1.7.5.4

