From a9120a0e48a2765cf0c58e8d4166068101959fdd Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Thu, 15 Nov 2012 11:17:24 +0200
Subject: [PATCH 0356/1825] Fixed NAND functionality on KW40

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 87b4eb7b8e806bedc33470d1ebec29cbab69fee5

	1. Added MTD_NAND and NFC_INIT_RESET defconfigs
	2. Fixed bad #ifdef's in NAND code
	3. Added usefull debug prints

Change-Id: I0b24e8cce2d6e74466fa94ba0d4265c9b292f08c
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/configs/armada_370_defconfig              |    2 ++
 .../plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c   |   17 +++++++++--------
 .../plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.h   |    2 +-
 3 files changed, 12 insertions(+), 9 deletions(-)

diff --git a/arch/arm/configs/armada_370_defconfig b/arch/arm/configs/armada_370_defconfig
index 00ecdb9..610b7c0 100644
--- a/arch/arm/configs/armada_370_defconfig
+++ b/arch/arm/configs/armada_370_defconfig
@@ -18,6 +18,7 @@ CONFIG_ARCH_ARMADA370=y
 CONFIG_ARMADA370=y
 # CONFIG_MV_INCLUDE_LEGACY_NAND is not set
 # CONFIG_MV_INCLUDE_SWITCH is not set
+CONFIG_MTD_NAND_NFC_INIT_RESET=y
 CONFIG_MV_PMU_PROC=y
 CONFIG_MV_ETH_NETA=y
 CONFIG_MV_ETH_PORTS_NUM=2
@@ -112,6 +113,7 @@ CONFIG_MTD_CFI_INTELEXT=y
 CONFIG_MTD_CFI_STAA=y
 CONFIG_MTD_PHYSMAP=y
 CONFIG_MTD_M25P80=y
+CONFIG_MTD_NAND=y
 CONFIG_MTD_UBI=y
 CONFIG_BLK_DEV_LOOP=y
 # CONFIG_SCSI_PROC_FS is not set
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c
index d34e237..f810600 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.c
@@ -16,9 +16,6 @@
 #include <linux/platform_device.h>
 #include <linux/dma-mapping.h>
 #include <linux/delay.h>
-#if 0
-#include <linux/clk.h>
-#endif
 #include <linux/mtd/mtd.h>
 #include <linux/mtd/nand.h>
 #include <linux/mtd/partitions.h>
@@ -30,7 +27,7 @@
 #include "mvCommon.h"
 #include "mvOs.h"
 
-#ifdef MV_INCLUDE_PDMA
+#ifdef CONFIG_MV_INCLUDE_PDMA
 #include <asm/hardware/pxa-dma.h>
 #include "pdma/mvPdma.h"
 #include "pdma/mvPdmaRegs.h"
@@ -953,8 +950,8 @@ static int orion_nfc_do_cmd_pio(struct orion_nfc_info *info)
 		/* Fallback - in case the NFC did not reach the idle state */
 		ndcr = MV_REG_READ(NFC_CONTROL_REG);
 		if (ndcr & NFC_CTRL_ND_RUN_MASK) {
-			printk(KERN_DEBUG "WRONG NFC STAUS: command %d, NDCR=0x%08x, NDSR=0x%08x, NDECCCTRL=0x%08x)\n", 
-		       	info->cmd, MV_REG_READ(NFC_CONTROL_REG), MV_REG_READ(NFC_STATUS_REG), MV_REG_READ(NFC_ECC_CONTROL_REG));
+			NFC_DPRINT((PRINT_LVL "WRONG NFC STAUS: command %d, NDCR=0x%08x, NDSR=0x%08x, NDECCCTRL=0x%08x)\n",
+			info->cmd, MV_REG_READ(NFC_CONTROL_REG), MV_REG_READ(NFC_STATUS_REG), MV_REG_READ(NFC_ECC_CONTROL_REG)));
 			MV_REG_WRITE(NFC_CONTROL_REG, (ndcr & ~NFC_CTRL_ND_RUN_MASK));
 		}
 	}
@@ -1457,6 +1454,7 @@ static int orion_nfc_probe(struct platform_device *pdev)
 	char * stat[2] = {"Disabled", "Enabled"};
 	char * ecc_stat[] = {"Hamming", "BCH 4bit", "BCH 8bit", "BCH 12bit", "BCH 16bit", "No"};
 	MV_NFC_INFO nfcInfo;
+	MV_STATUS status;
 
 	pdata = dev_get_platdata(&pdev->dev);
 
@@ -1567,8 +1565,11 @@ static int orion_nfc_probe(struct platform_device *pdev)
 	nfcInfo.dataPdmaIntMask = MV_PDMA_END_OF_RX_INTR_EN | MV_PDMA_END_INTR_EN;
 	nfcInfo.cmdPdmaIntMask = 0x0;
 #endif
-	if (mvNfcInit(&nfcInfo, &info->nfcCtrl) != MV_OK) {
-		dev_err(&pdev->dev, "mvNfcInit() failed.\n");
+
+	status = mvNfcInit(&nfcInfo, &info->nfcCtrl);
+	if (status != MV_OK) {
+		dev_err(&pdev->dev, "mvNfcInit() failed. Returned %d\n",
+				status);
 		goto fail_put_clk;
 	}
 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.h b/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.h
index df1cdb1..1038c60 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.h
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_mtd/nand_nfc.h
@@ -5,7 +5,7 @@
 #include <linux/mtd/partitions.h>
 #include "mvCommon.h"
 #include "mvOs.h"
-#ifdef MV_INCLUDE_PDMA
+#ifdef CONFIG_MV_INCLUDE_PDMA
 #include "pdma/mvPdma.h"
 #endif
 #include "nfc/mvNfc.h"
-- 
1.7.5.4

