From 56501e0ec21214c1dc4d33f1a0c79ce76dca8b90 Mon Sep 17 00:00:00 2001
From: Victor Gu <xigu@marvell.com>
Date: Wed, 9 Jul 2014 14:09:46 +0800
Subject: [PATCH 1784/1825] alp: pon: add sysfs cmd to configure EPON overhead

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 3697445cc1e6df1e2d4d43760ee4ec99137edd3d

    In EPON SW DBA mode, the overhead will be set automatically, however
in HW DBA mode, need to configure the overhead field by this field
manually
Signed-off-by: Victor Gu <xigu@marvell.com>

Change-Id: I7936a68b949da9db90802e0a3b28e736fe5c14a0
Reviewed-on: http://vgitil04.il.marvell.com:8080/9080
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Tested-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_pon/perf/epon/eponOnuLnxKsUI.c              |   25 ++++++++++++++++++++
 1 files changed, 25 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/perf/epon/eponOnuLnxKsUI.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/perf/epon/eponOnuLnxKsUI.c
index ee87d29..185cdcd 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/perf/epon/eponOnuLnxKsUI.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/perf/epon/eponOnuLnxKsUI.c
@@ -901,6 +901,7 @@ int onuEponUiCfgHelpShow(char *buf)
 		off += mvOsSPrintf(buf + off, " echo [Ind][BM][QS][Mode] > rpmReportCfg  - Configure RPM Report settings\n");
 		off += mvOsSPrintf(buf + off, " echo [BM][valid(0|1)] > utmActTxBitmap   - Configure General UTM Active TX Bitmap\n");
 		off += mvOsSPrintf(buf + off, " echo [0|1]            > legacyMode       - Config legacyMode ON/OFF\n");
+		off += mvOsSPrintf(buf + off, " echo [llid][queue][val] > overhead	 - Config overhead in unit of 64 bytes\n");
 	}
 	off += mvOsSPrintf(buf + off, "============================================================================\n");
 	off += mvOsSPrintf(buf + off, "Display Commands: cat <file>\n");
@@ -1959,6 +1960,26 @@ void onuEponUiCfgDbaSwForceModeConfig(MV_U32 legacyMode)
 
 /*******************************************************************************
 **
+**  onuEponUiCfgDbaOverhead
+**  ____________________________________________________________________________
+**
+**  DESCRIPTION: The function sets overhead value
+**
+**  PARAMETERS:  MV_U32 llid MV_U32 queue MV_U32 overhead
+**
+**  OUTPUTS:     None
+**
+**  RETURNS:     None
+**
+*******************************************************************************/
+void onuEponUiCfgDbaOverhead(MV_U32 llid, MV_U32 queue, MV_U32 overhead)
+{
+	mvOnuEponMacPPv2DbaLlidAndQueueIndirectAccess(llid, queue);
+	mvOnuEponMacPPv2DbaQueueOverheadSet(overhead);
+}
+
+/*******************************************************************************
+**
 **  onuEponUiOmciChannelAdd
 **  ____________________________________________________________________________
 **
@@ -2714,6 +2735,8 @@ static ssize_t cfg_store(struct device *dev,
 			onuEponUiCfgSetUtmActTxBitmap((MV_U32)param1, (MV_U32)param2);
 		else if (!strcmp(name, "dbaSwForceMode"))       /* legacy mode */
 			onuEponUiCfgDbaSwForceModeConfig((MV_U32)param1);
+		else if (!strcmp(name, "overhead"))       /* overhead */
+			onuEponUiCfgDbaOverhead((MV_U32)param1, (MV_U32)param2, (MV_U32)param3);
 		else
 			printk(KERN_ERR "%s: illegal operation <%s>\n", __func__, attr->attr.name);
 	} else
@@ -2766,6 +2789,7 @@ static DEVICE_ATTR(highPriTxStateSet,       S_IWUSR, cfg_show, cfg_store);
 static DEVICE_ATTR(highPriTxMapSet,         S_IWUSR, cfg_show, cfg_store);
 static DEVICE_ATTR(highPriTxShow,           S_IRUSR, cfg_show, cfg_store);
 static DEVICE_ATTR(helpCfg,                 S_IRUSR, cfg_show, cfg_store);
+static DEVICE_ATTR(overhead,                S_IWUSR | S_IRUSR, cfg_show, cfg_store);
 
 static struct attribute *cfg_attrs[] = {
 	&dev_attr_rxEn.attr,
@@ -2807,6 +2831,7 @@ static struct attribute *cfg_attrs[] = {
 	&dev_attr_highPriTxMapSet.attr,
 	&dev_attr_highPriTxShow.attr,
 	&dev_attr_helpCfg.attr,
+	&dev_attr_overhead.attr,
 	NULL
 };
 
-- 
1.7.5.4

