From 44094592377aa680650360b30bacd9084862abe8 Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Mon, 21 Oct 2013 09:58:52 +0200
Subject: [PATCH 1057/1825] fix: sata: alp: Make SATA use correct DRAM info

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit b463d0d09df242bf69855cdc3dad81a7589602f1

	Add mv_mbus_dram_info() to all supported platforms,
	because mainline drivers (SATA, SDIO, etc.) call this
	function in order to get DRAM configuration.

Change-Id: I8ed14df61dd39c278c2bae64e0f6fafef1490927
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3830
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Reviewed-by: Igor Patrik <igorp@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-armadaxp/core.c     |    5 +++++
 arch/arm/mach-avantalp/core.c     |    6 +++++-
 arch/arm/mach-feroceon-kw2/core.c |   28 ++++++++++++++++++----------
 drivers/ata/sata_mv.c             |   14 ++++++++------
 include/linux/mbus.h              |   11 -----------
 5 files changed, 36 insertions(+), 28 deletions(-)

diff --git a/arch/arm/mach-armadaxp/core.c b/arch/arm/mach-armadaxp/core.c
index 57d0964..0362c8f 100644
--- a/arch/arm/mach-armadaxp/core.c
+++ b/arch/arm/mach-armadaxp/core.c
@@ -142,6 +142,11 @@ MV_U16 mvMtu[MV_UBOOT_ETH_PORTS] = {0};
 
 struct mbus_dram_target_info armadaxp_mbus_dram_info;
 
+const struct mbus_dram_target_info *mv_mbus_dram_info(void)
+{
+	return &armadaxp_mbus_dram_info;
+}
+
 /* XOR0 is disabled in Z1 Silicone */
 #ifdef CONFIG_ARMADA_XP_REV_Z1
  /* XOR0 is disabled in Z1 Silicone */
diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index dab91c9..a4403ad 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -114,6 +114,11 @@ MV_U16 mvMtu[MV_UBOOT_ETH_PORTS] = { 0 };
 
 struct mbus_dram_target_info alp_mbus_dram_info;
 
+const struct mbus_dram_target_info *mv_mbus_dram_info(void)
+{
+	return &alp_mbus_dram_info;
+}
+
 /*******************************************************************************
  * Early Printk Support
  */
@@ -983,7 +988,6 @@ static void __init alp_sata_init(void)
 		return;
 
 	alp_sata.dev.platform_data = &alp_sata_data;
-	alp_sata_data.dram = &alp_mbus_dram_info;
 	platform_device_register(&alp_sata);
 #endif
 }
diff --git a/arch/arm/mach-feroceon-kw2/core.c b/arch/arm/mach-feroceon-kw2/core.c
index 75412f6..247fc59 100644
--- a/arch/arm/mach-feroceon-kw2/core.c
+++ b/arch/arm/mach-feroceon-kw2/core.c
@@ -105,7 +105,6 @@ void mv_early_printk(char *fmt,...)
 }
 #endif
 
-
 extern void __init mv_map_io(void);
 extern void __init mv_init_irq(void);
 extern struct sys_timer mv_timer;
@@ -143,7 +142,6 @@ static int __init noL2_setup(char *__unused)
 }
 __setup("noL2", noL2_setup);
 
-
 static int __init parse_tag_mv_uboot(const struct tag *tag)
 {
 	unsigned int mvUbootVer = 0;
@@ -201,23 +199,33 @@ unsigned char*  mv_sram_usage_get(int* sram_size_ptr)
 void print_board_info(void)
 {
 	char name_buff[50];
-	printk("\n  Marvell Development Board (LSP Version %s_%s)", LSP_VERSION, UPON_SDK_VERSION);
+	pr_info("\n  Marvell Development Board (LSP Version %s_%s)",
+		LSP_VERSION, UPON_SDK_VERSION);
 
 	mvBoardNameGet(name_buff);
-	printk("-- %s ",name_buff);
+	pr_info("-- %s ", name_buff);
 
 	mvCtrlModelRevNameGet(name_buff);
-	printk(" Soc: %s",  name_buff);
+	pr_info(" Soc: %s", name_buff);
 #if defined(MV_CPU_LE)
-	printk(" LE");
+	pr_info(" LE");
 #else
-	printk(" BE");
+	pr_info(" BE");
 #endif
-	printk("\n\n");
-	printk(" Detected Tclk %d and SysClk %d \n",mvTclk, mvSysclk);
+	pr_info("\n\n");
+	pr_info(" Detected Tclk %d and SysClk %d\n", mvTclk, mvSysclk);
 }
 
-/*****************************************************************************
+/*******************************************************************************
+ * DRAM
+ ******************************************************************************/
+const struct mbus_dram_target_info *mv_mbus_dram_info(void)
+{
+	return NULL; /* dummy */
+}
+EXPORT_SYMBOL_GPL(mv_mbus_dram_info);
+
+/***********************************************
  * I2C(TWSI)
  ****************************************************************************/
 
diff --git a/drivers/ata/sata_mv.c b/drivers/ata/sata_mv.c
index 6998cdd..a64fcfb 100644
--- a/drivers/ata/sata_mv.c
+++ b/drivers/ata/sata_mv.c
@@ -4096,8 +4096,9 @@ static int mv_platform_probe(struct platform_device *pdev)
 	/*
 	 * (Re-)program MBUS remapping windows if we are asked to.
 	 */
-	if (mv_platform_data->dram)
-		mv_conf_mbus_windows(hpriv, mv_platform_data->dram);
+	dram = mv_mbus_dram_info();
+	if (dram)
+		mv_conf_mbus_windows(hpriv, dram);
 
 	rc = mv_create_dma_pools(hpriv, &pdev->dev);
 	if (rc)
@@ -4169,14 +4170,15 @@ static int mv_platform_resume(struct platform_device *pdev)
 
 	if (host) {
 		struct mv_host_priv *hpriv = host->private_data;
-		const struct mv_sata_platform_data *mv_platform_data = \
-			pdev->dev.platform_data;
+		const struct mbus_dram_target_info *dram;
+
 
 		/*
 		 * (Re-)program MBUS remapping windows if we are asked to.
 		 */
-		if (mv_platform_data->dram)
-			mv_conf_mbus_windows(hpriv, mv_platform_data->dram);
+		dram = mv_mbus_dram_info();
+		if (dram)
+			mv_conf_mbus_windows(hpriv, dram);
 
 		/* initialize adapter */
 		ret = mv_init_host(host);
diff --git a/include/linux/mbus.h b/include/linux/mbus.h
index efa1a6d..85a7605 100644
--- a/include/linux/mbus.h
+++ b/include/linux/mbus.h
@@ -32,16 +32,5 @@ struct mbus_dram_target_info
 	} cs[4];
 };
 
-/*
- * The Marvell mbus is to be found only on SOCs from the Orion family
- * at the moment.  Provide a dummy stub for other architectures.
- */
-#ifdef CONFIG_PLAT_ORION
 extern const struct mbus_dram_target_info *mv_mbus_dram_info(void);
-#else
-static inline const struct mbus_dram_target_info *mv_mbus_dram_info(void)
-{
-	return NULL;
-}
-#endif
 #endif
-- 
1.7.5.4

