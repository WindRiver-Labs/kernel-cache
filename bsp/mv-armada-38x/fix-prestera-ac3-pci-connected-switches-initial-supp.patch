From d7ed40f61c32ac248ab014544b012dffcb4b58bf Mon Sep 17 00:00:00 2001
From: Grzegorz Jaszczyk <jaz@semihalf.com>
Date: Sun, 8 Jun 2014 16:21:56 +0300
Subject: [PATCH 1698/1825] fix: prestera: ac3: pci connected switches initial
 support

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 5c73bab55d997e071c02ebed5dc79c3cc8044a3e

Change-Id: I0361b57a230e00a752e7ad4180d56358085a8716
Signed-off-by: Grzegorz Jaszczyk <jaz@semihalf.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8415
Reviewed-by: Ofer Heifetz <oferh@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Tawfik Bayouk <tawfik@marvell.com>
Tested-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/common/mvDeviceId.h           |    3 +++
 .../mv_drivers_lsp/mv_prestera/mv_prestera.c       |    7 ++++++-
 .../mv_drivers_lsp/mv_prestera/mv_prestera_pci.c   |    7 +++++++
 3 files changed, 16 insertions(+), 1 deletions(-)

diff --git a/arch/arm/plat-armada/common/mvDeviceId.h b/arch/arm/plat-armada/common/mvDeviceId.h
index 0a6f638..cd5df1e 100644
--- a/arch/arm/plat-armada/common/mvDeviceId.h
+++ b/arch/arm/plat-armada/common/mvDeviceId.h
@@ -402,6 +402,9 @@ extern "C" {
 /* BobCat2  Family */
 #define MV_BOBCAT2_DEV_ID		0xFC00
 
+/* AlleyCat3  Family */
+#define MV_ALLEYCAT3_DEV_ID		0xF400
+
 
 #ifdef __cplusplus
 }
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_prestera/mv_prestera.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_prestera/mv_prestera.c
index 7591857..263511f 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_prestera/mv_prestera.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_prestera/mv_prestera.c
@@ -1137,10 +1137,13 @@ static void prestera_cleanup(void)
 static uint32_t *get_instance(unsigned short vendorId, unsigned short devId)
 {
 	static uint32_t bobcat2_instance;
+	static uint32_t ac3_instance;
 
 	switch (devId) {
 	case MV_BOBCAT2_DEV_ID:
 		return &bobcat2_instance;
+	case MV_ALLEYCAT3_DEV_ID:
+		return &ac3_instance;
 	default:
 		return NULL;
 	}
@@ -1159,8 +1162,10 @@ int ppdev_conf_set(struct pp_dev *ppdev)
 	DB(mvOsPrintf("%s\n", __func__));
 
 	instance = get_instance(ppdev->vendorId, ppdev->devId);
-	if (!(instance))
+	if (!(instance)) {
+		mvOsPrintf(KERN_ERR "%s: instance get failed\n", __func__);
 		return -ENODEV;
+	}
 
 	ppdev->instance = *instance++;
 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_prestera/mv_prestera_pci.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_prestera/mv_prestera_pci.c
index 0da04bd..51f0308 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_prestera/mv_prestera_pci.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_prestera/mv_prestera_pci.c
@@ -111,6 +111,8 @@
 #define DFX_TARGET_ID			0x8
 #endif
 
+#define DFX_JTAG_DEVID_STAT		0xF8244
+
 static const char prestera_drv_name[] = "mvPP_PCI";
 static void __iomem *inter_regs;
 
@@ -227,6 +229,7 @@ static void mv_enable_switch_irq(struct pci_dev *pdev)
 
 	switch (pdev->device) {
 	case MV_BOBCAT2_DEV_ID:
+	case MV_ALLEYCAT3_DEV_ID:
 		switching_core_nr = 0x3;
 		break;
 	default:
@@ -453,6 +456,9 @@ static int prestera_pci_probe(struct pci_dev *pdev, const struct pci_device_id *
 
 	mv_pci_dma_switch_init((unsigned long)switch_reg, pdev);
 
+	dprintk("DFX test %x and should be ..357\n",
+		readl(iomap[MV_PCI_BAR_2] + DFX_JTAG_DEVID_STAT));
+
 	dev_info(&pdev->dev, "%s init completed\n", prestera_drv_name);
 	return 0;
 }
@@ -465,6 +471,7 @@ static void prestera_pci_remove(struct pci_dev *pdev)
 static DEFINE_PCI_DEVICE_TABLE(prestera_pci_tbl) = {
 	/* Marvell */
 	{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, MV_BOBCAT2_DEV_ID)},
+	{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, MV_ALLEYCAT3_DEV_ID)},
 	{}
 };
 
-- 
1.7.5.4

