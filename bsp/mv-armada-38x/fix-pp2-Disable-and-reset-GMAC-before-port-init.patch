From 2a3c2c2ad7ac3dace6d73018b000fec83adac9aa Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Thu, 24 Oct 2013 18:07:56 -0400
Subject: [PATCH 1050/1825] fix: pp2: Disable and reset GMAC before port init

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit b004604c85af64a1d4016147e04d2151b0a434ef

Change-Id: I550899842455fa3d1f3628bf16b179e3e77bf7f5
Signed-off-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3851
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Uri Eliyahu <uriel@marvell.com>
Reviewed-by: Jonatan Farhadian <yonif@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index f5ca1fb..f5c4b31 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -1402,6 +1402,7 @@ inline int mv_eth_refill(struct bm_pool *ppool, __u32 bm, int is_recycle)
 		return 1;
 	}
 	STAT_DBG(ppool->stats.no_recycle++);
+
 	mv_eth_pool_refill(ppool, bm, phys_addr, (unsigned long) skb);
 	atomic_dec(&ppool->in_use);
 
@@ -3424,6 +3425,9 @@ static int mv_eth_probe(struct platform_device *pdev)
 	}
 
 	if (!MV_PON_PORT(port)) {
+		/* First: Disable and reset Gmac */
+		mvEthPortPowerDown(port);
+
 		/* Set the board information regarding PHY address */
 		phyAddr = plat_data->phy_addr;
 		if (phyAddr != -1)
-- 
1.7.5.4

