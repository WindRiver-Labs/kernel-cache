From dac9e1dcdaef0fde09d67ca2b26e56203b4e2473 Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Wed, 1 May 2013 03:21:32 +0300
Subject: [PATCH 0616/1825] ALP: Fix dram memory windows reading

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 248b511a87215ca1973d907347056b837c7e8d5e

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: I5f4834a391d7b8aaea9c34225cfea14e79712165
Reviewed-on: http://vgitil04.il.marvell.com:8080/1709
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/core.c |   24 ++++++++++++------------
 1 files changed, 12 insertions(+), 12 deletions(-)

diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index 6407efe..a1e3306 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -102,8 +102,6 @@ MV_U8 mvMacAddr[MV_UBOOT_ETH_PORTS][6];
 MV_U16 mvMtu[MV_UBOOT_ETH_PORTS] = { 0 };
 #endif
 
-struct mbus_dram_target_info alp_mbus_dram_info;
-
 /*
  * Helpers to get DDR bank info
  */
@@ -112,7 +110,7 @@ struct mbus_dram_target_info alp_mbus_dram_info;
 #define TARGET_DDR              0
 #define COHERENCY_STATUS_SHARED_NO_L2_ALLOC     0x1
 
-struct mbus_dram_target_info mbus_dram_info;
+struct mbus_dram_target_info alp_mbus_dram_info;
 
 /*******************************************************************************
  * Early Printk Support
@@ -233,7 +231,7 @@ static void __init alp_init_cpu_mbus(void)
 	/*
 	 * Setup MBUS dram target info.
 	 */
-	mbus_dram_info.mbus_dram_target_id = TARGET_DDR;
+	alp_mbus_dram_info.mbus_dram_target_id = TARGET_DDR;
 	addr = (void __iomem*)BRIDGE_VIRT_BASE;
 
 	for (i = 0, cs = 0; i < 4; i++) {
@@ -248,7 +246,7 @@ static void __init alp_init_cpu_mbus(void)
 			if (base & 0xf)
 				/* BaseExtension is used (> 4GB).*/
 				continue;
-			w = &mbus_dram_info.cs[cs++];
+			w = &alp_mbus_dram_info.cs[cs++];
 			w->cs_index = i;
 			w->mbus_attr = 0xf & ~(1 << i);
 			w->mbus_attr |= coherency_status << 4;
@@ -256,7 +254,7 @@ static void __init alp_init_cpu_mbus(void)
 			w->size = (size | 0x00ffffff) + 1;
 		}
 	}
-	mbus_dram_info.num_cs = cs;
+	alp_mbus_dram_info.num_cs = cs;
 }
 
 #if defined(CONFIG_MV_INCLUDE_CESA)
@@ -1210,16 +1208,18 @@ static void __init alp_init_l2x0_cache(void)
 #endif
 }
 
-static void __init board_init(void)
+static void __init alp_board_init(void)
 {
 	mvBoardEnvInit();
 	if (mvCtrlEnvInit()) {
-		printk("Controller env initialization failed.\n");
-		return;
+		printk(KERN_ERR "%s: Error: ctrlEnv initi failed.\n", __func__);
+		/* return; */
 	}
 
+#ifdef CONFIG_MACH_AVANTA_LP_FPGA
 	/* Replace PCI-0 Attribute for FPGA 0xE => 0xD */
 	mvTargetDefaultsArray[PEX0_MEM].attrib = 0xD8;
+#endif
 
 	alp_init_cpu_mbus();
 	alp_init_iocc();
@@ -1227,8 +1227,8 @@ static void __init board_init(void)
 
 	/* Init the CPU windows setting and the access protection windows. */
 	if (mvCpuIfInit(mv_sys_map())) {
-		printk("Cpu Interface initialization failed.\n");
-		return;
+		printk(KERN_ERR "%s: Error: cpu memory windows init failed.\n", __func__);
+		/* return; */
 	}
 
 	elf_hwcap &= ~HWCAP_JAVA;
@@ -1265,6 +1265,6 @@ MACHINE_START(AVANTA_LP, "Marvell AvantaLP 88f66xx Board")
 	.init_irq       = alp_init_irq,
 	.timer          = &alp_timer,
 	.handle_irq     = gic_handle_irq,
-	.init_machine   = board_init,
+	.init_machine   = alp_board_init,
 	.restart        = board_restart,
 MACHINE_END
-- 
1.7.5.4

