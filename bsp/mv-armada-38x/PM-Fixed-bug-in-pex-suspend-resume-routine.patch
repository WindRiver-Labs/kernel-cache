From 867f282c56a56f6873d15c89361c6f896af1c2ff Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Thu, 15 Nov 2012 10:20:40 +0200
Subject: [PATCH 0348/1825] PM: Fixed bug in pex suspend/resume routine

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 5aad68f0b06bdbd8a14a871fbe7313898bc2c6e6

Change-Id: I5422e57213813296639d1085349a4f9452f20723
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-armadaxp/pex.c |   12 ++++++++++++
 1 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-armadaxp/pex.c b/arch/arm/mach-armadaxp/pex.c
index ff84320..70ebe9e 100644
--- a/arch/arm/mach-armadaxp/pex.c
+++ b/arch/arm/mach-armadaxp/pex.c
@@ -467,6 +467,12 @@ static int mv_pex_suspend(struct platform_device *dev, pm_message_t state)
 	/* Save PCI Express status Register */
 	for (pciIf = 0; pciIf < pex_ifnum; pciIf++) {
 		pexHWInf = boardPexInfo->pexMapping[pciIf];
+
+		if (MV_FALSE == mvUnitMapIsPexMine(pexHWInf))
+			continue;
+		if (MV_FALSE == mvCtrlPwrClckGet(PEX_UNIT_ID, pexHWInf))
+			continue;
+
 		pex_status[pexHWInf] = MV_REG_READ(PEX_STATUS_REG(pexHWInf));
 	}
 
@@ -484,6 +490,12 @@ static int mv_pex_resume(struct platform_device *dev)
 	/* Restore PCI Express status Register */
 	for (pciIf = 0; pciIf < pex_ifnum; pciIf++) {
 		pexHWInf = boardPexInfo->pexMapping[pciIf];
+
+		if (MV_FALSE == mvUnitMapIsPexMine(pexHWInf))
+			continue;
+		if (MV_FALSE == mvCtrlPwrClckGet(PEX_UNIT_ID, pexHWInf))
+			continue;
+
 		MV_REG_WRITE(PEX_STATUS_REG(pexHWInf), pex_status[pexHWInf]);
 	}
 
-- 
1.7.5.4

