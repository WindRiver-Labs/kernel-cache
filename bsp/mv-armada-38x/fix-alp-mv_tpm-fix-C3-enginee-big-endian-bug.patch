From eb462d07211aada1fa4a5d82ae8aa161d032b00c Mon Sep 17 00:00:00 2001
From: Ken Ma <make@marvell.com>
Date: Fri, 18 Apr 2014 07:11:46 +0800
Subject: [PATCH 1596/1825] fix: alp: mv_tpm: fix C3 enginee big endian bug

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit c188e089c743090ac4c7b0edd4929620bc64b875

	C3 enginee key's hek bytes only work for litte endian but not for
	big endian, now add the adapter to let it support both little and
	big endian.

Signed-off-by: Ken Ma <make@marvell.com>

Change-Id: I4a8193fafce9618844d408b974228ba56dceeae6
Reviewed-on: http://vgitil04.il.marvell.com:8080/7140
Reviewed-by: Hua Jing <jinghua@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Uri Eliyahu <uriel@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_tpm/src/core/tpm_c3.c        |   10 +++++++++-
 1 files changed, 9 insertions(+), 1 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_c3.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_c3.c
index 6292bae..3b12951 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_c3.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_c3.c
@@ -449,6 +449,8 @@ int tpm_c3_rule_convert(struct tpm_c3_add_entry_t *mng_entry, MV_PP2_CLS_C3_ENTR
 {
 	enum tpm_l4_type_t l4_type;
 	unsigned int hek_bytes;
+	int hek_offs;
+	unsigned char hek[TPM_C3_MAX_HASH_KEY_SIZE];
 	int rc = TPM_OK;
 
 	/* NULL validation */
@@ -480,8 +482,14 @@ int tpm_c3_rule_convert(struct tpm_c3_add_entry_t *mng_entry, MV_PP2_CLS_C3_ENTR
 	IF_ERROR_STR(TPM_C3_MOD, rc, "failed to call mvPp2ClsC3SwPortIDSet\n");
 
 	/* set HEK */
-	rc = tpm_c3_hek_generate(mng_entry, &hek_bytes, hw_entry->key.hek.bytes);
+	rc = tpm_c3_hek_generate(mng_entry, &hek_bytes, hek);
 	IF_ERROR_STR(TPM_C3_MOD, rc, "failed to call tpm_c3_hek_generate\n");
+
+	for (hek_offs = TPM_C3_MAX_HASH_KEY_SIZE - 1; hek_offs >= 0; hek_offs--) {
+		rc = mvPp2ClsC3SwHekByteSet(hw_entry, hek_offs, hek[hek_offs]);
+		IF_ERROR(TPM_C3_MOD, rc);
+	}
+
 	rc = mvPp2ClsC3SwHekSizeSet(hw_entry, hek_bytes);
 	IF_ERROR_STR(TPM_C3_MOD, rc, "failed to call mvPp2ClsC3SwHekSizeSet\n");
 
-- 
1.7.5.4

