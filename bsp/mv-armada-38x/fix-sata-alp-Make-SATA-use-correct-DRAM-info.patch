From bdce3eb919c15f508484dfdd2edddad3cde51c93 Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Thu, 10 Oct 2013 13:56:08 +0200
Subject: [PATCH 1017/1825] fix: sata: alp: Make SATA use correct DRAM info

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 865e84214ea6b262cb9a5ab7252c37cc519b0149

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: I0f65065fc496b4c583ff7c93f9a43ce6690028a9
Reviewed-on: http://vgitil04.il.marvell.com:8080/3671
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/core.c |    1 +
 drivers/ata/sata_mv.c         |   13 ++++++-------
 include/linux/ata_platform.h  |    1 +
 3 files changed, 8 insertions(+), 7 deletions(-)

diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index d05d8a9..32a75d3 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -977,6 +977,7 @@ static void __init alp_sata_init(void)
 		return;
 
 	alp_sata.dev.platform_data = &alp_sata_data;
+	alp_sata_data.dram = &alp_mbus_dram_info;
 	platform_device_register(&alp_sata);
 #endif
 }
diff --git a/drivers/ata/sata_mv.c b/drivers/ata/sata_mv.c
index 58a7f2e..6998cdd 100644
--- a/drivers/ata/sata_mv.c
+++ b/drivers/ata/sata_mv.c
@@ -4096,9 +4096,8 @@ static int mv_platform_probe(struct platform_device *pdev)
 	/*
 	 * (Re-)program MBUS remapping windows if we are asked to.
 	 */
-	dram = mv_mbus_dram_info();
-	if (dram)
-		mv_conf_mbus_windows(hpriv, dram);
+	if (mv_platform_data->dram)
+		mv_conf_mbus_windows(hpriv, mv_platform_data->dram);
 
 	rc = mv_create_dma_pools(hpriv, &pdev->dev);
 	if (rc)
@@ -4166,18 +4165,18 @@ static int mv_platform_suspend(struct platform_device *pdev, pm_message_t state)
 static int mv_platform_resume(struct platform_device *pdev)
 {
 	struct ata_host *host = platform_get_drvdata(pdev);
-	const struct mbus_dram_target_info *dram;
 	int ret;
 
 	if (host) {
 		struct mv_host_priv *hpriv = host->private_data;
+		const struct mv_sata_platform_data *mv_platform_data = \
+			pdev->dev.platform_data;
 
 		/*
 		 * (Re-)program MBUS remapping windows if we are asked to.
 		 */
-		dram = mv_mbus_dram_info();
-		if (dram)
-			mv_conf_mbus_windows(hpriv, dram);
+		if (mv_platform_data->dram)
+			mv_conf_mbus_windows(hpriv, mv_platform_data->dram);
 
 		/* initialize adapter */
 		ret = mv_init_host(host);
diff --git a/include/linux/ata_platform.h b/include/linux/ata_platform.h
index b856a2a..dc0b099 100644
--- a/include/linux/ata_platform.h
+++ b/include/linux/ata_platform.h
@@ -28,6 +28,7 @@ extern int __devexit __pata_platform_remove(struct device *dev);
  * Marvell SATA private data
  */
 struct mv_sata_platform_data {
+	struct mbus_dram_target_info *dram;
 	int	n_ports; /* number of sata ports */
 };
 
-- 
1.7.5.4

