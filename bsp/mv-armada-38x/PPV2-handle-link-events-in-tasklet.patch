From 9b23315e3662167a18f1e1f12baff682df22aab5 Mon Sep 17 00:00:00 2001
From: Yoni Farhadian <yonif@marvell.com>
Date: Mon, 27 May 2013 11:50:55 +0300
Subject: [PATCH 0691/1825] PPV2: handle link events in tasklet

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 90f385c78aa89f724f9b4d5f3669db66e63e30b7

Change-Id: I8bd8cbfa9d63f43f51f44274d7ddb055f1413659
Signed-off-by: Yoni Farhadian <yonif@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/1988
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Tested-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |   18 ++++++++++++++----
 1 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index 0c87786..91e55c1 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -98,6 +98,8 @@ static int mv_eth_ports_num = 0;
 
 static int mv_eth_initialized = 0;
 
+static struct tasklet_struct link_tasklet;
+
 /*
  * Local functions
  */
@@ -2499,6 +2501,15 @@ irqreturn_t mv_eth_isr(int irq, void *dev_id)
 
 irqreturn_t mv_eth_link_isr(int irq, void *dev_id)
 {
+	mvEthIsrSummaryMask();
+
+	tasklet_schedule(&link_tasklet);
+
+	return IRQ_HANDLED;
+}
+
+void mv_eth_link_tasklet(unsigned long data)
+{
 	int port;
 	MV_U32 regVal, regVal1;
 	struct eth_port *pp;
@@ -2507,8 +2518,6 @@ irqreturn_t mv_eth_link_isr(int irq, void *dev_id)
 	/* check only relevant interrupts - ports0 and 1 */
 	regVal &= (ETH_ISR_SUM_PORT0_MASK | ETH_ISR_SUM_PORT1_MASK);
 
-	mvEthIsrSummaryMask();
-
 	for (port = 0; port < mv_eth_ports_num; port++) {
 		/* check if interrupt was caused by this port */
 		if (!(ETH_ISR_SUM_PORT_MASK(port) & regVal))
@@ -2528,8 +2537,6 @@ irqreturn_t mv_eth_link_isr(int irq, void *dev_id)
 	}
 
 	mvEthIsrSummaryUnmask();
-
-	return IRQ_HANDLED;
 }
 
 static bool mv_eth_link_status(struct eth_port *pp)
@@ -3039,6 +3046,9 @@ static int	mv_eth_shared_probe(void)
 			printk(KERN_ERR "%s: Warning Classifier defauld init failed\n", __func__);
 	}
 
+	/* Initialize tasklet for handlink link events */
+	tasklet_init(&link_tasklet, mv_eth_link_tasklet, 0);
+
 	/* request IRQ for link interrupts from GOP */
 	if (request_irq(IRQ_GLOBAL_GOP, mv_eth_link_isr, (IRQF_DISABLED|IRQF_SAMPLE_RANDOM), "mv_eth_link", NULL))
 		printk(KERN_ERR "%s: Could not request IRQ for GOP interrupts\n", __func__);
-- 
1.7.5.4

