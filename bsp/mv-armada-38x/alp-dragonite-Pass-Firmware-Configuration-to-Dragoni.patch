From 88f4a1cb6243d4e8976dc89a194372371cdbf29c Mon Sep 17 00:00:00 2001
From: Piotr Ziecik <kosmo@semihalf.com>
Date: Mon, 5 May 2014 19:37:25 +0200
Subject: [PATCH 1620/1825] alp: dragonite: Pass Firmware Configuration to
 Dragonite.

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 582723dc26a2135ba70da92ed8a5b43e783ff02a

	The Firmware Configuration structure contains IPC shared memory
	information necessary to establish communication between Dragonite
	firmware and Linux.

Change-Id: Ibe74c12014410e608792598fbe13ecbae53c7fd0
Signed-off-by: Piotr Ziecik <kosmo@semihalf.com>
Signed-off-by: Victor Gu <xigu@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/7860
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_dragonite/dragonite.c        |   23 ++++++++++++++++---
 .../mv_drivers_lsp/mv_dragonite/dragonite.h        |    8 +++++++
 2 files changed, 27 insertions(+), 4 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_dragonite/dragonite.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_dragonite/dragonite.c
index fe1777c..a7c5aa4 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_dragonite/dragonite.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_dragonite/dragonite.c
@@ -16,6 +16,8 @@
 #include <linux/platform_device.h>
 #include <linux/io.h>
 #include <linux/firmware.h>
+
+#include "mv_ipc_common.h"
 #include "dragonite.h"
 
 #define DRAGONITE_SOFT_RST			(1 << 23)
@@ -39,6 +41,8 @@
 #define DRAGONITE_DFEV_BASE	0x10000000
 #define DRAGONITE_DRAM_BASE	0x40000000
 
+#define DRAGONITE_IPC_LINK	0
+
 /* Dragonite Decoding Windows configuration */
 struct dragonite_win_cfg {
 	unsigned char	target;
@@ -49,8 +53,8 @@ struct dragonite_win_cfg {
 };
 
 static struct dragonite_win_cfg dragonite_win_cfg[] = {
-	{ 0x00, 0x0E, 0, SZ_512M, DRAGONITE_DRAM_BASE},	/* DDR */
-	{ 0x0B, 0x00, 0, SZ_1M,   DRAGONITE_DFEV_BASE},	/* Lantiq */
+	{ 0x00, 0x0E, 0, SZ_16M,  DRAGONITE_DRAM_BASE}, /* DDR (first 16MB only) */
+	{ 0x0B, 0x00, 0, SZ_1M,   DRAGONITE_DFEV_BASE},	 /* Lantiq */
 	{ 0x01,	0x00, 1, SZ_1M,   DRAGONITE_RUNIT_BASE}, /* R-Unit */
 };
 
@@ -100,7 +104,8 @@ static int dragonite_enable(struct dragonite_info *info)
 }
 
 /* Load firmware to Instruction TCM (ITCM) */
-static int dragonite_load_firmware(struct device *dev, struct dragonite_info *info)
+static int dragonite_load_firmware(struct device *dev, struct dragonite_info *info,
+						       struct dragonite_fw_config *fwcfg)
 {
 	const struct firmware *fw = NULL;
 
@@ -118,6 +123,10 @@ static int dragonite_load_firmware(struct device *dev, struct dragonite_info *in
 	memcpy_toio(info->itcm_base, fw->data, fw->size);
 	release_firmware(fw);
 
+	/* Write firmware configuration block at the end of the DTCM memory */
+	if (fwcfg)
+		memcpy_toio(info->dtcm_base + info->dtcm_size - sizeof(*fwcfg), fwcfg, sizeof(*fwcfg));
+
 	return 0;
 }
 
@@ -139,6 +148,7 @@ int dragonite_run(struct dragonite_info *info)
 static int dragonite_probe(struct platform_device *pdev)
 {
 	struct dragonite_info *info = dev_get_platdata(&pdev->dev);
+	struct dragonite_fw_config fwcfg;
 	struct resource *itcm;
 	struct resource *dtcm;
 	int ret = 0;
@@ -198,8 +208,13 @@ static int dragonite_probe(struct platform_device *pdev)
 		goto fail;
 	}
 
+	/* Prepare firmware configuration */
+	fwcfg.magic = DRAGONITE_FW_CONFIG_MAGIC;
+	fwcfg.ipc_shm_base = mvIpcGetShmemBaseAddr(DRAGONITE_IPC_LINK);
+	fwcfg.ipc_shm_size = mvIpcGetShmemSize(DRAGONITE_IPC_LINK);
+
 	/* Load firmware to TCM */
-	ret = dragonite_load_firmware(&pdev->dev, info);
+	ret = dragonite_load_firmware(&pdev->dev, info, &fwcfg);
 	if (ret) {
 		dev_err(&pdev->dev, "Failed to load firmware\n");
 		goto fail;
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_dragonite/dragonite.h b/arch/arm/plat-armada/mv_drivers_lsp/mv_dragonite/dragonite.h
index 2514189..bb72e8d 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_dragonite/dragonite.h
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_dragonite/dragonite.h
@@ -1,6 +1,14 @@
 #ifndef _DRAGONITE_H
 #define _DRAGONITE_H
 
+#define DRAGONITE_FW_CONFIG_MAGIC	0x46574346 /* 'FWCF' */
+
+struct dragonite_fw_config {
+	unsigned int	magic;
+	unsigned int	ipc_shm_base;
+	unsigned int	ipc_shm_size;
+};
+
 struct dragonite_info {
 	struct platform_device	*pdev;
 	void __iomem    *ctrl_reg;
-- 
1.7.5.4

