From 0c0b7b2fa35e807f80716c3d0c2d812b9cc9d58d Mon Sep 17 00:00:00 2001
From: Hanna Hawa <hannah@marvell.com>
Date: Wed, 18 Jun 2014 18:43:50 +0300
Subject: [PATCH 1737/1825] fix: alp: eth complex: fixed no traffic issue
 (MAC1-RGMII-1 & MAC0-PHY#0)

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 9463d2325ca9f6ef33d90ab55b7f5b8306d37efb

	When connect MAC1->RGMII1 and MAC0->GPHY#0, there's no traffic using MAC1.

	This issue arises because the external PHY (RGMII-1) and internal PHY (GE-PHY#1) shares the same SMI address.
	Shutdown GE-PHY#1 sequence:
	1. RGMII-1 enabled & GE-PHY#1 disabled (both use same SMI address = 0x1)
		- set NO external SMI (to avoid mismatch when accessing SMI address 0x1)
		- shutdown GE-PHY#1 (CPU SMI access)
		- set GE-PHY#1 smi source as switch (to avoid future conflicts when cpu access the RGMII with SMI address 0x1)
		- restore external SMI to CPU control
	2. RGMII-1/GE-PHY#1/PON serdes is not connected
		- shutdown GE-PHY#1 (CPU SMI access)

	JIRA: SYSTEMSW-742
	JIRA: SYSTEMSW-743

Change-Id: I830910b080e53e3b3ef932b751d9527c8fcb2659
Signed-off-by: Hanna Hawa <hannah@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8578
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c    |    2 +-
 .../avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h    |    1 +
 2 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
index d3964cc..a6a30b6 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
@@ -107,7 +107,7 @@ static void mvEthComplexGponPhySrcSet(MV_U32 src)
 	MV_REG_WRITE(MV_GPON_PHY_CTRL1_REG, reg);
 }
 
-static void mvEthComplexGphyPortSmiSrcSet(MV_U32 phy, MV_U32 src)
+void mvEthComplexGphyPortSmiSrcSet(MV_U32 phy, MV_U32 src)
 {
 	MV_U32 reg;
 	/* In A0 added Phy Smi source configuration for ports 0 and 3.
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h
index 95622f9..0cce74e 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h
@@ -193,6 +193,7 @@ enum mvSwPortSrc {
 
 #ifdef CONFIG_MV_ETH_PP2
 MV_STATUS mvEthComplexInit(MV_U32 ethCompConfig);
+void mvEthComplexGphyPortSmiSrcSet(MV_U32 phy, MV_U32 src);
 #else
 MV_STATUS mvEthComplexInit(MV_U32 ethCompConfig) { /* empty */ }
 #endif
-- 
1.7.5.4

