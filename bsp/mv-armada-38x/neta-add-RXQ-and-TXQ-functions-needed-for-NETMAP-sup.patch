From a02c05310640dc2de30b2d1b5e0560d95809a354 Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Wed, 14 Aug 2013 18:42:50 -0400
Subject: [PATCH 0953/1825] neta: add RXQ and TXQ functions needed for NETMAP
 support

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 733ac50f27d69690dcdf32c7c15e22dba96cef2d

Change-Id: I08d5381404556a8472c3c44703918236b2f33bde
Signed-off-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3033
Reviewed-by: Uri Eliyahu <uriel@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.h |   20 +++++++++++++++++++-
 1 files changed, 19 insertions(+), 1 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.h b/arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.h
index 0bba6d3..01166c3 100644
--- a/arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.h
+++ b/arch/arm/plat-armada/mv_hal/neta/gbe/mvNeta.h
@@ -491,6 +491,20 @@ static INLINE void mvNetaRxqNonOccupDescAdd(int port, int rxq, int rx_desc)
 	MV_REG_WRITE(NETA_RXQ_STATUS_UPDATE_REG(port, rxq), regVal);
 }
 
+/* Decrement number of processed descriptors */
+static INLINE void mvNetaRxqOccupDescDec(int port, int rxq, int rx_desc)
+{
+	MV_U32	regVal;
+
+	/* Only 255 descriptors can be updated at once */
+	while (rx_desc > 0xFF) {
+		regVal = (0xFF << NETA_RXQ_DEC_OCCUPIED_OFFS);
+		MV_REG_WRITE(NETA_RXQ_STATUS_UPDATE_REG(port, rxq), regVal);
+		rx_desc = rx_desc - 0xFF;
+	}
+	regVal = (rx_desc << NETA_RXQ_DEC_OCCUPIED_OFFS);
+	MV_REG_WRITE(NETA_RXQ_STATUS_UPDATE_REG(port, rxq), regVal);
+}
 
 /* Decrement sent descriptors counter */
 static INLINE void mvNetaTxqSentDescDec(int port, int txp, int txq, int sent_desc)
@@ -535,7 +549,11 @@ static INLINE void mvNetaTxqPendDescAdd(int port, int txp, int txq, int pend_des
 	MV_U32 regVal;
 
 	/* Only 255 descriptors can be added at once - we don't check it for performance */
-	/* Assume caller process TX desriptors in quanta less than 256 */
+	while (pend_desc > 0xFF) {
+		regVal = (0xFF << NETA_TXQ_ADD_PENDING_OFFS);
+		MV_REG_WRITE(NETA_TXQ_UPDATE_REG(port, txp, txq), regVal);
+		pend_desc = pend_desc - 0xFF;
+	}
 	regVal = (pend_desc << NETA_TXQ_ADD_PENDING_OFFS);
 	MV_REG_WRITE(NETA_TXQ_UPDATE_REG(port, txp, txq), regVal);
 }
-- 
1.7.5.4

