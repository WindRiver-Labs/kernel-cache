From b529e6281900eba0091f184d8ad3cfb07e94a5b4 Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Tue, 27 May 2014 10:45:47 -0400
Subject: [PATCH 1691/1825] fix: neta: Fix MAC filtering on VLAN interfaces

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit fe5d745b3192fba83ab8cd5308750ab25643486d

	- JIRA bug: SYSTEMSW-639:
	Mac-to-me unicast packets will be dropped by HW via eth0.3001 on RD_A370
	- Improve mv_eth_netdev_print() function.

Change-Id: I8da3bd23a0e2bf32463b38ae5ced8af821b20cd3
Signed-off-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8246
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yelena Krivosheev <yelena@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c     |   34 +++++++++++--------
 1 files changed, 20 insertions(+), 14 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
index 55b1b61..fda7013 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
@@ -4146,6 +4146,9 @@ static int mv_eth_probe(struct platform_device *pdev)
 	/* init SMI register */
 	mvEthPhySmiAddrSet(ETH_SMI_REG(port));
 #endif
+
+	pr_info("port #%d: is_sgmii=%d, is_rgmii=%d, phy_addr=%d\n",
+		port, plat_data->is_sgmii, plat_data->is_rgmii, plat_data->phy_addr);
 	mvNetaPortPowerUp(port, plat_data->is_sgmii, plat_data->is_rgmii);
 
 	mv_eth_win_init(port);
@@ -4264,10 +4267,6 @@ struct net_device *mv_eth_netdev_init(int mtu, u8 *mac,
 
 	SET_NETDEV_DEV(dev, &pdev->dev);
 
-#if LINUX_VERSION_CODE > KERNEL_VERSION(3, 1, 10)
-	dev->priv_flags |= IFF_UNICAST_FLT;
-#endif
-
 	if (pp->flags & MV_ETH_F_CONNECT_LINUX) {
 		mv_eth_netdev_init_features(dev);
 		if (register_netdev(dev)) {
@@ -5865,27 +5864,34 @@ void mv_eth_ext_pool_print(struct eth_port *pp)
  ***********************************************************************************/
 void mv_eth_netdev_print(struct net_device *dev)
 {
-	printk(KERN_ERR "%s net_device status: dev=%p\n\n", dev->name, dev);
-	printk(KERN_ERR "ifIdx=%d, mtu=%u, pkt_size=%d, buf_size=%d, MAC=" MV_MACQUAD_FMT "\n",
+	pr_info("%s net_device status:\n\n", dev->name);
+	pr_info("ifIdx=%d, mtu=%u, pkt_size=%d, buf_size=%d, MAC=" MV_MACQUAD_FMT "\n",
 	       dev->ifindex, dev->mtu, RX_PKT_SIZE(dev->mtu),
 		RX_BUF_SIZE(RX_PKT_SIZE(dev->mtu)), MV_MACQUAD(dev->dev_addr));
 
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(2, 6, 39)
-	printk(KERN_ERR "features=0x%x, hw_features=0x%x, wanted_features=0x%x, vlan_features=0x%x\n",
+	pr_info("features=0x%x, hw_features=0x%x, wanted_features=0x%x, vlan_features=0x%x\n",
 			(unsigned int)(dev->features), (unsigned int)(dev->hw_features),
 			(unsigned int)(dev->wanted_features), (unsigned int)(dev->vlan_features));
 #else
-	printk(KERN_ERR "features=0x%x, vlan_features=0x%x\n",
+	pr_info("features=0x%x, vlan_features=0x%x\n",
 		 (unsigned int)(dev->features), (unsigned int)(dev->vlan_features));
 #endif
 
-	printk(KERN_ERR "flags=0x%x, gflags=0x%x: running=%d, oper_up=%d\n",
-			(unsigned int)(dev->flags), (unsigned int)(dev->gflags),
-			netif_running(dev), netif_oper_up(dev));
+	pr_info("flags=0x%x, gflags=0x%x, priv_flags=0x%x: running=%d, oper_up=%d\n",
+		(unsigned int)(dev->flags), (unsigned int)(dev->gflags), (unsigned int)(dev->priv_flags),
+		netif_running(dev), netif_oper_up(dev));
+	pr_info("uc_promisc=%d, promiscuity=%d, allmulti=%d\n", dev->uc_promisc, dev->promiscuity, dev->allmulti);
 
-	if (!mv_eth_netdev_find(dev->ifindex))
-		/* mux net device */
-		mv_mux_netdev_print(dev);
+	if (mv_eth_netdev_find(dev->ifindex)) {
+		struct eth_port *pp = MV_ETH_PRIV(dev);
+		if (pp->tagged)
+			mv_mux_netdev_print_all(pp->port);
+	} else {
+		/* Check if this is mux netdevice */
+		if (mv_mux_netdev_find(dev->ifindex) != -1)
+			mv_mux_netdev_print(dev);
+	}
 }
 
 void mv_eth_status_print(void)
-- 
1.7.5.4

