From 27d340cc481986f87666c89647f212057bc5e7f5 Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Tue, 28 May 2013 19:41:57 +0300
Subject: [PATCH 0708/1825] ALP: Fix SPI Flash support

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit bfe7fdbea105b9f24d6618299e82f347ece492c4

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: Ieb73860dcfca4922f69e6d80c2b427ee977dd36e
Reviewed-on: http://vgitil04.il.marvell.com:8080/2002
Reviewed-by: Star_Automation <star@marvell.com>
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/core.c               |   24 +++++++++++-------------
 arch/arm/mach-avantalp/core.h               |   23 +++++++----------------
 arch/arm/mach-avantalp/irq.c                |    2 +-
 arch/arm/mach-avantalp/mv_hal_if/mvSysSpi.c |    6 ++----
 arch/arm/mach-avantalp/sysmap.c             |    6 +++---
 5 files changed, 24 insertions(+), 37 deletions(-)

diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index dd0bd4c..e895b28 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -78,6 +78,7 @@
 #include <asm/hardware/cache-l2x0.h>
 #include <asm/hardware/gic.h>
 #include "ca9x2.h"
+#include "core.h"
 
 MV_STATUS mvSysSpiInit(MV_U8 spiId, MV_U32 serialBaudRate);
 
@@ -85,9 +86,6 @@ extern void __init alp_map_io(void);
 extern struct sys_timer alp_timer;
 extern MV_CPU_DEC_WIN* mv_sys_map(void);
 
-extern void alp_init_irq(void);
-extern void __init set_core_count(unsigned int cpu_count);
-
 #ifdef CONFIG_SMP
 extern unsigned int group_cpu_mask;
 #else
@@ -217,7 +215,7 @@ static int __init nfcConfig_setup(char *s)
 }
 __setup("nfcConfig=", nfcConfig_setup);
 
-static void __init alp_init_cpu_mbus(void)
+static void __init alp_cpu_mbus_init(void)
 {
 	void __iomem *addr;
 	int i;
@@ -774,7 +772,7 @@ static void __init switch_init(void)
 }
 #endif /* CONFIG_MV_INCLUDE_SWITCH */
 
-static void alp_init_eth(void)
+static void alp_eth_init(void)
 {
 #ifdef CONFIG_MV_ETHERNET
 	mvSysEthPhyInit();
@@ -1333,7 +1331,7 @@ void dma_io_sync(void)
  *     SMP + HWCC
  *     SMP + SWCC
  */
-static void __init alp_init_iocc(void)
+static void __init alp_iocc_init(void)
 {
 #if !defined(CONFIG_SMP) && defined(CONFIG_AURORA_IO_CACHE_COHERENCY)
 	void __iomem *scu_base =
@@ -1344,7 +1342,7 @@ static void __init alp_init_iocc(void)
 	alp_iocc_wa_init();
 }
 
-static void __init alp_init_l2x0_cache(void)
+static void __init alp_l2x0_cache_init(void)
 {
 #ifdef CONFIG_CACHE_L2X0
 	void __iomem *l2x0_base =
@@ -1365,8 +1363,8 @@ static void __init alp_board_init(void)
 	mvTargetDefaultsArray[PEX0_MEM].attrib = 0xD8;
 #endif
 
-	alp_init_cpu_mbus();
-	alp_init_l2x0_cache();
+	alp_cpu_mbus_init();
+	alp_l2x0_cache_init();
 
 	/* Init the CPU windows setting and the access protection windows. */
 	if (mvCpuIfInit(mv_sys_map())) {
@@ -1377,7 +1375,7 @@ static void __init alp_board_init(void)
 	 * Changes PUnit windows for IOCC WA, hence, should be
 	 * placed after PUnit windows config.
 	 */
-	alp_init_iocc();
+	alp_iocc_init();
 
 	elf_hwcap &= ~HWCAP_JAVA;
 
@@ -1386,12 +1384,12 @@ static void __init alp_board_init(void)
 	mvCpuIfAddDecShow();
 	print_board_info();
 
-	alp_init_eth();
+	alp_eth_init();
+	alp_spi_init();
 
 #if 0
 	alp_gpio_init();
 	alp_rtc_init();
-	alp_spi_init();
 	alp_sata_init();
 	alp_nand_nfc_init();
 	alp_hwmon_init();
@@ -1413,7 +1411,7 @@ static void board_restart(char mode, const char *cmd)
 MACHINE_START(AVANTA_LP, "Marvell AvantaLP 88f66xx Board")
 	.atag_offset    = BOOT_PARAMS_OFFSET,
 	.map_io         = alp_map_io,
-	.init_irq       = alp_init_irq,
+	.init_irq       = alp_irq_init,
 	.timer          = &alp_timer,
 	.handle_irq     = gic_handle_irq,
 	.init_machine   = alp_board_init,
diff --git a/arch/arm/mach-avantalp/core.h b/arch/arm/mach-avantalp/core.h
index 110ced6..b0bc781 100644
--- a/arch/arm/mach-avantalp/core.h
+++ b/arch/arm/mach-avantalp/core.h
@@ -1,16 +1,7 @@
-#define AMBA_DEVICE(name,busid,base,plat)	\
-struct amba_device name##_device = {		\
-	.dev		= {			\
-		.coherent_dma_mask = ~0UL,	\
-		.init_name = busid,		\
-		.platform_data = plat,		\
-	},					\
-	.res		= {			\
-		.start	= base,			\
-		.end	= base + SZ_4K - 1,	\
-		.flags	= IORESOURCE_MEM,	\
-	},					\
-	.dma_mask	= ~0UL,			\
-	.irq		= IRQ_##base,		\
-	/* .dma		= DMA_##base,*/		\
-}
+/*
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ */
+
+void alp_irq_init(void);
diff --git a/arch/arm/mach-avantalp/irq.c b/arch/arm/mach-avantalp/irq.c
index 207af8e..bfd3a32 100644
--- a/arch/arm/mach-avantalp/irq.c
+++ b/arch/arm/mach-avantalp/irq.c
@@ -251,7 +251,7 @@ static void __init alp_cascade_irq_errors(void)
  * Init GIC and MPIC and setup cascade irq
  * handling for GPIO, MSI and Error interrupts.
  */
-void __init alp_init_irq(void)
+void __init alp_irq_init(void)
 {
 	gic_init(0, 29, (void __iomem*)(INTER_REGS_VIRT_BASE + A9_MPCORE_GIC_DIST),
 			(void __iomem*)(INTER_REGS_VIRT_BASE + A9_MPCORE_GIC_CPU));
diff --git a/arch/arm/mach-avantalp/mv_hal_if/mvSysSpi.c b/arch/arm/mach-avantalp/mv_hal_if/mvSysSpi.c
index b407634..981c8f9 100644
--- a/arch/arm/mach-avantalp/mv_hal_if/mvSysSpi.c
+++ b/arch/arm/mach-avantalp/mv_hal_if/mvSysSpi.c
@@ -70,7 +70,6 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "spi/mvSysSpi.h"
 #include "ctrlEnv/mvCtrlEnvLib.h"
 
-
 /*******************************************************************************
 * mvSysSpiInit - Initialize the SPI subsystem
 *
@@ -79,12 +78,12 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * INPUT:
 *       None
 * OUTPUT:
-*		None
+*	None
 * RETURN:
 *       None
 *
 *******************************************************************************/
-MV_STATUS   mvSysSpiInit(MV_U8 spiId, MV_U32 serialBaudRate)
+MV_STATUS mvSysSpiInit(MV_U8 spiId, MV_U32 serialBaudRate)
 {
 	MV_SPI_HAL_DATA halData;
 
@@ -94,7 +93,6 @@ MV_STATUS   mvSysSpiInit(MV_U8 spiId, MV_U32 serialBaudRate)
 	return mvSpiInit(spiId, serialBaudRate, &halData);
 }
 
-
 /*******************************************************************************
 * mvSysSpiMppConfig
 *
diff --git a/arch/arm/mach-avantalp/sysmap.c b/arch/arm/mach-avantalp/sysmap.c
index b8eb80f..b53d284 100644
--- a/arch/arm/mach-avantalp/sysmap.c
+++ b/arch/arm/mach-avantalp/sysmap.c
@@ -45,7 +45,7 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6660[] = {
 	{{PEX1_IO_PHYS_BASE,		0,	PEX1_IO_SIZE		},	TBL_UNUSED,		DIS},	/* PEX1_IO */
 	{{INTER_REGS_PHYS_BASE,		0,	INTER_REGS_SIZE		},	MV_AHB_TO_MBUS_INTREG_WIN, EN},	/* INTER_REGS */
 	{{UART_REGS_BASE,		0,	UART_SIZE		},	TBL_UNUSED,		DIS},	/* DMA_UART */
-	{{SPI_CS0_PHYS_BASE,		0,	SPI_CS0_SIZE		},	14,			DIS},	/* SPI_CS0 */
+	{{SPI_CS0_PHYS_BASE,		0,	SPI_CS0_SIZE		},	14,			EN},	/* SPI_CS0 */
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* SPI_CS1 */
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* SPI_CS2 */
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* SPI_CS3 */
@@ -76,7 +76,7 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6650[] = {
 	{{TBL_UNUSED,			0,	TBL_UNUSED		},	TBL_UNUSED,		DIS},	/* PEX1_IO */
 	{{INTER_REGS_PHYS_BASE,		0,	INTER_REGS_SIZE		},	MV_AHB_TO_MBUS_INTREG_WIN, EN},	/* INTER_REGS */
 	{{UART_REGS_BASE,		0,	UART_SIZE		},	TBL_UNUSED,		DIS},	/* DMA_UART */
-	{{SPI_CS0_PHYS_BASE,		0,	SPI_CS0_SIZE		},	14,			DIS},	/* SPI_CS0 */
+	{{SPI_CS0_PHYS_BASE,		0,	SPI_CS0_SIZE		},	14,			EN},	/* SPI_CS0 */
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* SPI_CS1 */
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* SPI_CS2 */
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* SPI_CS3 */
@@ -107,7 +107,7 @@ MV_CPU_DEC_WIN SYSMAP_ALP_6610[] = {
 	{{TBL_UNUSED,			0,	TBL_UNUSED		},	TBL_UNUSED,		DIS},	/* PEX1_IO */
 	{{INTER_REGS_PHYS_BASE,		0,	INTER_REGS_SIZE		},	MV_AHB_TO_MBUS_INTREG_WIN, EN},	/* INTER_REGS */
 	{{UART_REGS_BASE,		0,	UART_SIZE		},	TBL_UNUSED,		DIS},	/* DMA_UART */
-	{{SPI_CS0_PHYS_BASE,		0,	SPI_CS0_SIZE		},	14,			DIS},	/* SPI_CS0 */
+	{{SPI_CS0_PHYS_BASE,		0,	SPI_CS0_SIZE		},	14,			EN},	/* SPI_CS0 */
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* SPI_CS1 */
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* SPI_CS2 */
 	{{TBL_UNUSED,			0,	TBL_UNUSED,		},	TBL_UNUSED,		DIS},	/* SPI_CS3 */
-- 
1.7.5.4

