From a2b03e0c2c4ac44c4eb5dd51728ce3c3c1de8015 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Thu, 10 Oct 2013 16:47:28 +0200
Subject: [PATCH 1037/1825] ppv2: alp: Added support for Switch port 4 to
 RGMII-0 configuration

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 5cf29ddaa62c6468a82ccb6df9e59a74bb051544

	Added :
	- Eth.Complex connectivity configuration (mvEthComplexSwPortToRgmii)
	- MV_ETHCOMP_SW_P4_2_RGMII0 to RD-6650 configuration
	- PHY initialization sequence according the new config
	- Added swith port 4 to force link mask (link works only forced to 1G)
	- updated missing MPP and GPIO settings

	The Avanta-LP RD-6650 board was used to test Switch Port 4 to RGMII-0 connectivity,
	because this board has on-board Ethernet PHY connected to RGMII-0.
	The Avanta-LP RD-6660 board will be tested by other team using TDM module.

Change-Id: I7e6b7b040d06e4fde0cf34ce887761f6bf7b75d5
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3732
Reviewed-by: Kosta Zertsekel <konszert@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   10 +++++++-
 .../avanta_lp_family/boardEnv/mvBoardEnvSpec.c     |   21 +++++++++++++------
 .../avanta_lp_family/boardEnv/mvBoardEnvSpec.h     |   14 ++++++------
 .../avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c    |    5 +++-
 4 files changed, 33 insertions(+), 17 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index c23ab4f..f6cb7b4 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -1544,7 +1544,13 @@ MV_U32 mvBoardSwitchPortForceLinkGet(MV_U32 switchIdx)
 	if (c & MV_ETHCOMP_GE_MAC0_2_SW_P6)
 		mask |= BIT6;
 
+	/* If switch port 4 is connected to RGMII-0, the PHY SMI is controlled by CPU MAC,
+	 * To avoid address conflict between internal PHY (0x1), SMI is not handled by switch.
+	 * Auto-negotiation can not be applied with this configuration - so we use force link */
+	if (c & MV_ETHCOMP_SW_P4_2_RGMII0)
+		mask |= BIT4;
 	return mask;
+
 }
 
 /*******************************************************************************
@@ -1763,7 +1769,7 @@ MV_VOID mvBoardConfigurationPrint(MV_VOID)
 	/* Switch configuration */
 	if (ethConfig & MV_ETHCOMP_GE_MAC0_2_SW_P6)
 		mvOsOutput("       Ethernet Switch port 6 on MAC0, %s Speed [Default]\n"
-				, mvBoardMacSpeedGet(0) == BOARD_MAC_SPEED_2000M ? "2G" : "1G");
+				, (ethConfig & MV_ETHCOMP_P2P_MAC0_2_SW_SPEED_2G) ? "2G" : "1G");
 	else if ((ethConfig & MV_ETHCOMP_GE_MAC1_2_SW_P4) &&
 		!(ethConfig & MV_ETHCOMP_GE_MAC0_2_SW_P6))
 		mvOsOutput("       Ethernet Switch port 4 on MAC1, 1G Speed [Default]\n");
@@ -1778,7 +1784,7 @@ MV_VOID mvBoardConfigurationPrint(MV_VOID)
 	if (ethConfig & MV_ETHCOMP_GE_MAC1_2_RGMII1)
 		mvOsOutput("       RGMII1 on MAC1\n");
 	if (ethConfig & MV_ETHCOMP_SW_P4_2_RGMII0)
-		mvOsOutput("       RGMII0 Module on Switch port #4\n");
+		mvOsOutput("       RGMII0 Module on Switch port #4, 1G speed\n");
 
 	/* Internal GE Quad Phy */
 	if (ethConfig & MV_ETHCOMP_GE_MAC0_2_GE_PHY_P0)
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
index 277a582..923115f 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
@@ -305,10 +305,14 @@ MV_BOARD_TWSI_INFO rd88f6650InfoBoardTwsiDev[] = {
 	{ BOARD_DEV_TWSI_SATR,		0,	0x4C,	   ADDR7_BIT	},
 	{ BOARD_DEV_TWSI_SATR,		1,	0x4E,	   ADDR7_BIT	},
 };
+
+/* When Switch Port 4 is connected to external PHY through RGMII-0,
+ * this external PHY is managed through MAC-0 SMI lines.
+ * The 'boardEthSmiAddr' variable is used only for PHY init. */
 MV_BOARD_MAC_INFO rd88f6650InfoBoardMacInfo[] = {
 	/* {{MV_BOARD_MAC_SPEED boardMacSpeed, MV_8 boardEthSmiAddr}} */
-	{ BOARD_MAC_SPEED_2000M, -1},
-	{ BOARD_MAC_SPEED_AUTO, 0x1},
+	{ BOARD_MAC_SPEED_2000M, 0x1},
+	{ BOARD_MAC_SPEED_AUTO,  0x1},
 	{ BOARD_MAC_SPEED_1000M, -1},
 	{ BOARD_MAC_SPEED_1000M, -1},
 };
@@ -320,12 +324,13 @@ MV_BOARD_MPP_TYPE_INFO rd88f6650InfoBoardModTypeInfo[] = {
 				     MV_ETHCOMP_SW_P2_2_GE_PHY_P2 |
 				     MV_ETHCOMP_SW_P3_2_GE_PHY_P3 |
 				     MV_ETHCOMP_P2P_MAC0_2_SW_SPEED_2G |
-				     MV_ETHCOMP_GE_MAC1_2_SW_P4   |
+				     MV_ETHCOMP_SW_P4_2_RGMII0   |
 				     MV_ETHCOMP_GE_MAC0_2_SW_P6,
 		.ethPortsMode = 0x0
 	}
 };
 
+
 MV_DEV_CS_INFO rd88f6650InfoBoardDeCsInfo[] = {
 	/*{deviceCS, params, devType, devWidth, busWidth }*/
 #if defined(MV_INCLUDE_SPI)
@@ -403,11 +408,13 @@ MV_BOARD_INFO rd88f6650_board_info = {
 /*******************************************************************************
  * AvantaLP RD-88F6660 board */
 /*******************************************************************************/
-
+/* When Switch Port 4 is connected to external PHY through RGMII-0,
+ * this external PHY is managed through MAC-0 SMI lines.
+ * The 'boardEthSmiAddr' variable is used only for PHY init. */
 MV_BOARD_MAC_INFO rd88f6660InfoBoardMacInfo[] = {
 	/* {{MV_BOARD_MAC_SPEED boardMacSpeed, MV_8 boardEthSmiAddr}} */
-	{ BOARD_MAC_SPEED_2000M, -1},
-	{ BOARD_MAC_SPEED_AUTO, 0x1},
+	{ BOARD_MAC_SPEED_2000M, 0x1},
+	{ BOARD_MAC_SPEED_AUTO,  0x1},
 	{ BOARD_MAC_SPEED_1000M, -1},
 	{ BOARD_MAC_SPEED_1000M, -1},
 };
@@ -419,7 +426,7 @@ MV_BOARD_MPP_TYPE_INFO rd88f6660InfoBoardModTypeInfo[] = {
 				     MV_ETHCOMP_SW_P2_2_GE_PHY_P2 |
 				     MV_ETHCOMP_SW_P3_2_GE_PHY_P3 |
 				     MV_ETHCOMP_P2P_MAC0_2_SW_SPEED_2G |
-				     MV_ETHCOMP_GE_MAC1_2_SW_P4   |
+				     MV_ETHCOMP_SW_P4_2_RGMII0   |
 				     MV_ETHCOMP_GE_MAC0_2_SW_P6,
 		.ethPortsMode = 0x0
 	}
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
index 19b37f0..4f773b8 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
@@ -164,9 +164,9 @@
 #define RD_88F6660_MPP16_23             0x22222222  /* UA0, TDM */
 #define RD_88F6660_MPP24_31             0x33333333  /* SDIO, SPI1 */
 #define RD_88F6660_MPP32_39             0x00023330  /* SD_Stat (GPIO_input), SPI1,PON BEN, 3xGPIOs  */
-#define RD_88F6660_MPP40_47             0x22122220  /* GPIO, Dying, SATA_PRESENT,PON_TX_[PD,SD], GE0*/
-#define RD_88F6660_MPP48_55             0x22222222  /* GE0 */
-#define RD_88F6660_MPP56_63             0x44444422  /* GE0 , C0_LED */
+#define RD_88F6660_MPP40_47             0x44120020  /* Switch P4, PON_[XVR,TX_PD,TX_SD]*/
+#define RD_88F6660_MPP48_55             0x44444444  /* Switch P4 */
+#define RD_88F6660_MPP56_63             0x44004444  /* GE0 , LED, GPIO's */
 #define RD_88F6660_MPP64_67             0x004	    /* GPIO's */
 
 #define RD_88F6660_GPP_OUT_ENA_LOW      0xFFFFFFFF
@@ -187,15 +187,15 @@
 #define RD_88F6650_MPP16_23             0x11110022  /* UA0, SSI, GPIO's */
 #define RD_88F6650_MPP24_31             0x04606001  /* P0,C0_Leds & DYING GASP*/
 #define RD_88F6650_MPP32_39             0x04420000  /* GE_SMI, PON & GPIO's */
-#define RD_88F6650_MPP40_47             0x22120020  /* GE0, PON_[XVR,TX_PD,TX_SD]*/
-#define RD_88F6650_MPP48_55             0x22222222  /* GE0*/
-#define RD_88F6650_MPP56_63             0x44004422  /* GE0 , LED, GPIO's */
+#define RD_88F6650_MPP40_47             0x44120020  /* Switch P4, PON_[XVR,TX_PD,TX_SD]*/
+#define RD_88F6650_MPP48_55             0x44444444  /* Switch P4 */
+#define RD_88F6650_MPP56_63             0x44004444  /* GE0 , LED, GPIO's */
 #define RD_88F6650_MPP64_67             0x004	    /* GPIO's */
 
 #define RD_88F6650_GPP_OUT_ENA_LOW      (~(BIT19 | BIT25 | BIT29))
 #define RD_88F6650_GPP_OUT_ENA_MID      0xFFFFFFFF
 #define RD_88F6650_GPP_OUT_ENA_HIGH     0xFFFFFFFF
-#define RD_88F6650_GPP_OUT_VAL_LOW      (BIT29)
+#define RD_88F6650_GPP_OUT_VAL_LOW      (BIT29 | BIT25) /* BIT 25 - External PHY reset */
 #define RD_88F6650_GPP_OUT_VAL_MID      0x0
 #define RD_88F6650_GPP_OUT_VAL_HIGH     0x0
 #define RD_88F6650_GPP_POL_LOW          0x0
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
index e53f9b0..2dba355 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
@@ -326,7 +326,10 @@ static void mvEthComplexMacToSwPort(MV_U32 port, MV_U32 swPort,
 
 static void mvEthComplexSwPortToRgmii(MV_U32 swPort, MV_U32 port)
 {
-	/* Not implemented */
+	MV_U32 src;
+
+	src = mvEthComplexSwPortSrcCalc(swPort, ETHC_SW_PORT_SRC_MPP);
+	mvEthComplexSwPortSrcSet(swPort, src);
 }
 
 static void mvEthComplexXponMacToPonSerdes(void)
-- 
1.7.5.4

