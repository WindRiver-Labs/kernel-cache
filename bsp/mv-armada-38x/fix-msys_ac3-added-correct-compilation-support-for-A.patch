From 21812310627b1dca214e84a77f22f579a8820997 Mon Sep 17 00:00:00 2001
From: Grzegorz Jaszczyk <jaz@semihalf.com>
Date: Sun, 22 Jun 2014 23:11:50 +0300
Subject: [PATCH 1725/1825] fix: msys_ac3: added correct compilation support
 for AlleyCat3

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 92ca3e7751aae1017ccdfb7c45705d7f44eb9b19

 - set correct family defines in boards.cfg (CONFIG_BOBCAT2/CONFIG_ALLEYCAT3)
 - Added AC3 defines for Marvell and Customer board IDs (mvBoardEnvSpec.h)
    0x0  - 0x10: BC2 Customer boards
    0x10 - 0x20: BC2 Marvell boards
    0x20 - 0x30: AC3 Customer boards
    0x30 - 0x40: AC3 Marvell boards
 - Added AC3 board structures for Marvell and Customer boards(mvBoardEnvSpec.c)
 - Added support for mvBoardSet(boardId) to set AC3 boards, according to boardId

Change-Id: Ieb15f49d02d900242c345a2b5201cc63e85e7295
Reviewed-on: http://vgitil04.il.marvell.com:8080/8684
Reviewed-by: Tawfik Bayouk <tawfik@marvell.com>
Tested-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mach-msys/msys_family/boardEnv/mvBoardEnvLib.c |   73 ++++++++++++++------
 .../msys_family/boardEnv/mvBoardEnvSpec.c          |   13 +++-
 .../msys_family/boardEnv/mvBoardEnvSpec.h          |   45 ++++++++----
 3 files changed, 92 insertions(+), 39 deletions(-)

diff --git a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
index 009524f..7428501 100644
--- a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
@@ -90,8 +90,10 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define DB1(x)
 #endif
 
-extern MV_BOARD_INFO *marvellBoardInfoTbl[];
-extern MV_BOARD_INFO *customerBoardInfoTbl[];
+extern MV_BOARD_INFO *marvellBC2BoardInfoTbl[];
+extern MV_BOARD_INFO *customerBC2BoardInfoTbl[];
+extern MV_BOARD_INFO *marvellAC3BoardInfoTbl[];
+extern MV_BOARD_INFO *customerAC3BoardInfoTbl[];
 static MV_BOARD_INFO *board;
 
 /* Locals */
@@ -116,7 +118,7 @@ static MV_DEV_CS_INFO *boardGetDevEntry(MV_32 devNum, MV_BOARD_DEV_CLASS devClas
 MV_U32 mvBoardIdIndexGet(MV_U32 boardId)
 {
 /* Marvell Boards use 0x10 as base for Board ID: mask MSB to receive index for board ID*/
-	return boardId & (MARVELL_BOARD_ID_BASE - 1);
+	return boardId & (BOARD_ID_INDEX_MASK - 1);
 }
 
 /*******************************************************************************
@@ -1063,35 +1065,51 @@ MV_32 mvBoardNandWidthGet(void)
 * mvBoardSet - Set Board model
 *
 * DESCRIPTION:
-*       This function sets the board ID.
-*       Board ID is 32bit word constructed of board model (16bit) and
-*       board revision (16bit) in the following way: 0xMMMMRRRR.
+*	Sets the global board structures and global board ID, according to boardId value
+*	1. Detect correct MSYS family(Bobcat2/Alleycat3)
+*	2. Detect Marvell/Customer board
 *
 * INPUT:
-*       None.
+*	boardId :
+*	- U-Boot : set boardID via mvBoardIdGet() - according to pre-compilation flag.
+*	- Kernel : set boardID via tags received from U-Boot .
 *
 * OUTPUT:
-*       None.
+*	None.
 *
 * RETURN:
-*       void
+*	void
 *
 *******************************************************************************/
 static MV_U32 gBoardId = -1;
 MV_VOID mvBoardSet(MV_U32 boardId)
 {
-	/* board ID's >0x10 are for Marvell Boards */
-	if (boardId >= MARVELL_BOARD_ID_BASE && boardId < MV_MAX_MARVELL_BOARD_ID) { /* Marvell Board */
-		board = marvellBoardInfoTbl[mvBoardIdIndexGet(boardId)];
+	/* Marvell Bobcat2 Boards */
+	if (boardId >= BC2_MARVELL_BOARD_ID_BASE && boardId < BC2_MARVELL_MAX_BOARD_ID) { /* Marvell Board */
+		board = marvellBC2BoardInfoTbl[mvBoardIdIndexGet(boardId)];
 		gBoardId = boardId;
-	} else if (boardId >= CUTOMER_BOARD_ID_BASE && boardId < MV_MAX_CUSTOMER_BOARD_ID) { /* Customer Board */
-		board = customerBoardInfoTbl[mvBoardIdIndexGet(boardId)];
+	/* Marvell AlleyCat3 Boards */
+	} else if (boardId >= AC3_MARVELL_BOARD_ID_BASE && boardId < AC3_MARVELL_MAX_BOARD_ID) { /* Marvell Board */
+		board = marvellAC3BoardInfoTbl[mvBoardIdIndexGet(boardId)];
+		gBoardId = boardId;
+	/* Customer Bobcat2 Boards */
+	} else if (boardId >= BC2_CUTOMER_BOARD_ID_BASE && boardId < BC2_CUSTOMER_MAX_BOARD_ID) { /* Customer Board */
+		board = customerBC2BoardInfoTbl[mvBoardIdIndexGet(boardId)];
+		gBoardId = boardId;
+	/* Customer AlleyCat3 Boards */
+	} else if (boardId >= AC3_CUTOMER_BOARD_ID_BASE && boardId < AC3_CUSTOMER_MAX_BOARD_ID) { /* Customer Board */
+		board = customerAC3BoardInfoTbl[mvBoardIdIndexGet(boardId)];
 		gBoardId = boardId;
 	} else {
 		mvOsPrintf("%s: Error: wrong board Id (%d)\n", __func__, boardId);
-		gBoardId = 0;
-		board = customerBoardInfoTbl[gBoardId];
-		mvOsPrintf("Applying default board ID (%d: %s)\n", gBoardId, board->boardName);
+#ifdef CONFIG_ALLEYCAT3
+		gBoardId = AC3_CUSTOMER_BOARD_ID0;
+		board = customerAC3BoardInfoTbl[gBoardId];
+#else
+		gBoardId = BC2_CUSTOMER_BOARD_ID0;
+		board = customerBC2BoardInfoTbl[gBoardId];
+#endif
+		mvOsPrintf("Applying default Customer board ID (%d: %s)\n", gBoardId, board->boardName);
 	}
 }
 
@@ -1119,18 +1137,29 @@ MV_U32 mvBoardIdGet(MV_VOID)
 		return gBoardId;
 
 #ifdef CONFIG_CUSTOMER_BOARD_SUPPORT
-	#ifdef CONFIG_CUSTOMER_BOARD_0
-		gBoardId = BOBCAT2_CUSTOMER_BOARD_ID0;
-	#elif CONFIG_CUSTOMER_BOARD_1
-		gBoardId = BOBCAT2_CUSTOMER_BOARD_ID1;
+	#ifdef CONFIG_BOBCAT2
+		#ifdef CONFIG_CUSTOMER_BOARD_0
+			gBoardId = BC2_CUSTOMER_BOARD_ID0;
+		#elif CONFIG_CUSTOMER_BOARD_1
+			gBoardId = BC2_CUSTOMER_BOARD_ID1;
+		#endif
+	#elif defined CONFIG_ALLEYCAT3
+		#ifdef CONFIG_CUSTOMER_BOARD_0
+			gBoardId = AC3_CUSTOMER_BOARD_ID0;
+		#elif CONFIG_CUSTOMER_BOARD_1
+			gBoardId = AC3_CUSTOMER_BOARD_ID1;
+		#endif
 	#endif
-#else
+#else	/* !CONFIG_CUSTOMER_BOARD_SUPPORT */
 	#if defined(DB_BOBCAT2)
 		gBoardId = DB_DX_BC2_ID;
 	#elif defined(RD_BOBCAT2)
 		gBoardId = RD_DX_BC2_ID;
 	#elif defined(RD_MTL_BOBCAT2)
 		gBoardId = RD_MTL_BC2;
+	/* AlleyCat3 Board ID's */
+	#elif defined(DB_AC3)
+		gBoardId = DB_AC3_ID;
 	#else
 		mvOsPrintf("%s: Board ID must be defined!\n", __func__);
 		while (1)
diff --git a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.c b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.c
index 99e9638..def2857 100644
--- a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.c
+++ b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.c
@@ -173,11 +173,16 @@ MV_BOARD_INFO bobcat2_customer_board_0_Info = {
 	.norFlashWriteParams		= BOBCAT2_CUSTOMER_0_BOARD_NOR_WRITE_PARAMS
 };
 
-MV_BOARD_INFO *customerBoardInfoTbl[] = {
+MV_BOARD_INFO *customerBC2BoardInfoTbl[] = {
 	&bobcat2_customer_board_0_Info,
 	&bobcat2_customer_board_0_Info,
 };
 
+MV_BOARD_INFO *customerAC3BoardInfoTbl[] = {
+	&bobcat2_customer_board_0_Info,		/* Place holder for AC3 board, must be replaced */
+	&bobcat2_customer_board_0_Info,		/* Place holder for AC3 board, must be replaced */
+};
+
 /***************************************** Marvell Boards *****************************************/
 /***********************/
 /* BOBCAT2-DB-DX BOARD */
@@ -447,8 +452,12 @@ MV_BOARD_INFO bc2_rd_mtlInfo = {
 
 /*********************************************************************************/
 
-MV_BOARD_INFO *marvellBoardInfoTbl[] = {
+MV_BOARD_INFO *marvellBC2BoardInfoTbl[] = {
 	&db_dx_bc2Info,
 	&rd_dx_bc2Info,
 	&bc2_rd_mtlInfo
 };
+
+MV_BOARD_INFO *marvellAC3BoardInfoTbl[] = {
+	&db_dx_bc2Info		/* Place holder for AC3 boards, must be replaced */
+};
diff --git a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.h b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.h
index 38c6ded..8eb60bf 100644
--- a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.h
+++ b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvSpec.h
@@ -71,24 +71,39 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 
 /* Board specific configuration */
 /* ============================ */
-
-/* Customer boards */
-#define CUTOMER_BOARD_ID_BASE		0x0
-#define BOBCAT2_CUSTOMER_BOARD_ID0	(CUTOMER_BOARD_ID_BASE + 0)
-#define BOBCAT2_CUSTOMER_BOARD_ID1	(CUTOMER_BOARD_ID_BASE + 1)
-#define MV_MAX_CUSTOMER_BOARD_ID	(CUTOMER_BOARD_ID_BASE + 2)
-#define MV_CUSTOMER_BOARD_NUM		(MV_MAX_CUSTOMER_BOARD_ID - CUTOMER_BOARD_ID_BASE)
-
-/* Marvell boards */
-#define MARVELL_BOARD_ID_BASE		0x10
-#define DB_DX_BC2_ID			(MARVELL_BOARD_ID_BASE + 0)
-#define RD_DX_BC2_ID			(MARVELL_BOARD_ID_BASE + 1)
-#define RD_MTL_BC2			(MARVELL_BOARD_ID_BASE + 2)
-#define MV_MAX_MARVELL_BOARD_ID		(MARVELL_BOARD_ID_BASE + 3)
-#define MV_MARVELL_BOARD_NUM		(MV_MAX_MARVELL_BOARD_ID - MARVELL_BOARD_ID_BASE)
+/* Bobcat2 Customer Boards */
+#define BC2_CUTOMER_BOARD_ID_BASE	0x0
+#define BC2_CUSTOMER_BOARD_ID0		(BC2_CUTOMER_BOARD_ID_BASE + 0)
+#define BC2_CUSTOMER_BOARD_ID1		(BC2_CUTOMER_BOARD_ID_BASE + 1)
+#define BC2_CUSTOMER_MAX_BOARD_ID	(BC2_CUTOMER_BOARD_ID_BASE + 2)
+#define BC2_CUSTOMER_BOARD_NUM		(BC2_CUSTOMER_MAX_BOARD_ID - BC2_CUTOMER_BOARD_ID_BASE)
+
+/* Bobcat2 Marvell boards */
+#define BC2_MARVELL_BOARD_ID_BASE	0x10
+#define DB_DX_BC2_ID			(BC2_MARVELL_BOARD_ID_BASE + 0)
+#define RD_DX_BC2_ID			(BC2_MARVELL_BOARD_ID_BASE + 1)
+#define RD_MTL_BC2			(BC2_MARVELL_BOARD_ID_BASE + 2)
+#define BC2_MARVELL_MAX_BOARD_ID	(BC2_MARVELL_BOARD_ID_BASE + 3)
+#define BC2_MARVELL_BOARD_NUM		(BC2_MARVELL_MAX_BOARD_ID - BC2_MARVELL_BOARD_ID_BASE)
+
+
+/* AlleyCat3 Customer Boards */
+#define AC3_CUTOMER_BOARD_ID_BASE	0x20
+#define AC3_CUSTOMER_BOARD_ID0		(AC3_CUTOMER_BOARD_ID_BASE + 0)
+#define AC3_CUSTOMER_BOARD_ID1		(AC3_CUTOMER_BOARD_ID_BASE + 1)
+#define AC3_CUSTOMER_MAX_BOARD_ID	(AC3_CUTOMER_BOARD_ID_BASE + 2)
+#define AC3_CUSTOMER_BOARD_NUM		(AC3_CUSTOMER_MAX_BOARD_ID - AC3_CUTOMER_BOARD_ID_BASE)
+
+/* AlleyCat3 Marvell boards */
+#define AC3_MARVELL_BOARD_ID_BASE	0x30
+#define DB_AC3_ID			(AC3_MARVELL_BOARD_ID_BASE + 0)
+#define AC3_MARVELL_MAX_BOARD_ID	(AC3_MARVELL_BOARD_ID_BASE + 1)
+#define AC3_MARVELL_BOARD_NUM		(AC3_MARVELL_MAX_BOARD_ID - AC3_MARVELL_BOARD_ID_BASE)
 
 #define INVALID_BAORD_ID		0xFFFF
 
+#define BOARD_ID_INDEX_MASK		0x10	/* Mask used to return board index via board Id */
+
 /*******************************************************************************
 * Bobcat2 Customer board - Based on DB_DX_BC2
 *******************************************************************************/
-- 
1.7.5.4

