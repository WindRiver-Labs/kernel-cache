From d35e39935d4b98fb83f3add7403864f5829dafda Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Sun, 9 Mar 2014 13:36:13 +0200
Subject: [PATCH 1528/1825] a38x: cesa: add cesa support for a385

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit def388486ca50f87e8ece0e0c1be7317687fa52d

Change-Id: I26382635b34620797b8e4c8b74a14c206f4cffc3
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/6254
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/configs/armada_385_v7smp_defconfig        |    3 +-
 arch/arm/mach-armada38x/config/mvSysCesaConfig.h   |   12 ++++++++
 arch/arm/mach-armada38x/sysmap.c                   |    8 ++++-
 .../arm/plat-armada/mv_drivers_lsp/mv_cesa/Kconfig |   30 +++++++++++++++++--
 4 files changed, 47 insertions(+), 6 deletions(-)

diff --git a/arch/arm/configs/armada_385_v7smp_defconfig b/arch/arm/configs/armada_385_v7smp_defconfig
index 27bb610..8b6b7f3 100644
--- a/arch/arm/configs/armada_385_v7smp_defconfig
+++ b/arch/arm/configs/armada_385_v7smp_defconfig
@@ -13,7 +13,6 @@ CONFIG_MODULE_UNLOAD=y
 # CONFIG_BLK_DEV_BSG is not set
 CONFIG_PARTITION_ADVANCED=y
 CONFIG_ARCH_ARMADA38X=y
-# CONFIG_MV_INCLUDE_CESA is not set
 # CONFIG_MV_INCLUDE_TDM is not set
 CONFIG_MV_ETH_PORTS_NUM=2
 CONFIG_MV_ETH_TXQ=8
@@ -179,5 +178,7 @@ CONFIG_CRYPTO_CBC=m
 CONFIG_CRYPTO_ECB=m
 CONFIG_CRYPTO_PCBC=m
 # CONFIG_CRYPTO_ANSI_CPRNG is not set
+CONFIG_OCF_OCF=y
+CONFIG_OCF_CRYPTODEV=y
 CONFIG_CRC_CCITT=y
 CONFIG_LIBCRC32C=y
diff --git a/arch/arm/mach-armada38x/config/mvSysCesaConfig.h b/arch/arm/mach-armada38x/config/mvSysCesaConfig.h
index cd0f132..cc17a57 100644
--- a/arch/arm/mach-armada38x/config/mvSysCesaConfig.h
+++ b/arch/arm/mach-armada38x/config/mvSysCesaConfig.h
@@ -43,3 +43,15 @@ disclaimer.
 #ifdef CONFIG_MV_CESA_CHAIN_MODE
 	#define MV_CESA_CHAIN_MODE
 #endif
+
+#ifdef CONFIG_MV_CESA_INT_COALESCING_SUPPORT
+	#define MV_CESA_INT_COALESCING_SUPPORT
+	#define MV_CESA_INT_COAL_THRESHOLD		\
+				(CONFIG_MV_CESA_INT_COAL_THRESHOLD)
+	#define MV_CESA_INT_COAL_TIME_THRESHOLD		\
+				(CONFIG_MV_CESA_INT_COAL_TIME_THRESHOLD)
+#endif
+
+#ifdef CONFIG_MV_CESA_INT_PER_PACKET
+	#define MV_CESA_INT_PER_PACKET
+#endif
diff --git a/arch/arm/mach-armada38x/sysmap.c b/arch/arm/mach-armada38x/sysmap.c
index aca3c42..8953ce5 100644
--- a/arch/arm/mach-armada38x/sysmap.c
+++ b/arch/arm/mach-armada38x/sysmap.c
@@ -33,6 +33,11 @@ struct map_desc MEM_TABLE[] = {
 	{ PEX2_MEM_VIRT_BASE,		__phys_to_pfn(PEX2_MEM_PHYS_BASE),	PEX2_MEM_SIZE,	MT_MEMORY_SO},
 	{ PEX3_MEM_VIRT_BASE,		__phys_to_pfn(PEX3_MEM_PHYS_BASE),	PEX3_MEM_SIZE,	MT_MEMORY_SO},
 	{ CRYPT_ENG_VIRT_BASE(0),	__phys_to_pfn(CRYPT_ENG_PHYS_BASE(0)),	CRYPT_ENG_SIZE,	MT_DEVICE},
+#ifdef CONFIG_MV_CESA
+#if (CONFIG_MV_CESA_CHANNELS > 1)
+	{ CRYPT_ENG_VIRT_BASE(1),	__phys_to_pfn(CRYPT_ENG_PHYS_BASE(1)),	CRYPT_ENG_SIZE,	MT_DEVICE},
+#endif
+#endif
 	{ IOCC_WA_WIN0_VIRT_BASE,	__phys_to_pfn(IOCC_WA_WIN0_PHYS_BASE),	SZ_64K,		MT_DEVICE},
 };
 
@@ -67,7 +72,8 @@ MV_CPU_DEC_WIN SYSMAP_A38X_68XX[] = {
 	{{BOOTROM_PHYS_BASE,		0,	BOOTROM_SIZE		},	9,		EN}, /* BOOTROM */
 	{{DEVICE_BOOTCS_PHYS_BASE,	0,	DEVICE_BOOTCS_SIZE	},	10,		 EN}, /* DEV_BOOCS */
 	{{CRYPT_ENG_PHYS_BASE(0),	0,	CRYPT_ENG_SIZE		},	12,		 EN}, /* CRYPT_ENG */
-	{{ETH_BM_PHYS_BASE,		0,	ETH_BM_SIZE		},	13,		 EN}, /* ETH_BM */
+	{{CRYPT_ENG_PHYS_BASE(1),	0,	CRYPT_ENG_SIZE		},	13,		 EN}, /* CRYPT_ENG */
+	{{ETH_BM_PHYS_BASE,		0,	ETH_BM_SIZE		},	14,		 EN}, /* ETH_BM */
 	{{TBL_TERM,		 TBL_TERM,	TBL_TERM		},	TBL_TERM,  TBL_TERM}
 };
 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/Kconfig b/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/Kconfig
index 441c18f..62e50fd 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/Kconfig
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/Kconfig
@@ -15,9 +15,9 @@ config  MV_CESA_TOOL_ARMADA
 config MV_CESA_CHANNELS
 	int "Total CESA HW channels supported"
 	depends on MV_CESA
-	range 1 2 if ARCH_ARMADA_XP || ARCH_AVANTA_LP
+	range 1 2 if ARCH_ARMADA_XP || ARCH_AVANTA_LP || ARCH_ARMADA38X
 	range 1 1 if ARCH_ARMADA370
-	default "2" if ARCH_ARMADA_XP || ARCH_AVANTA_LP
+	default "2" if ARCH_ARMADA_XP || ARCH_AVANTA_LP || ARCH_ARMADA38X
 	default "1" if ARCH_ARMADA370
 	---help---
 	Select the number of CESA channels to be used for crypto operations acceleration.
@@ -26,7 +26,7 @@ choice
 	prompt "CESA Features"
 	depends on MV_CESA
 	default MV_CESA_CHAIN_MODE if (ARCH_ARMADA370 || ARMADA_XP_REV_Z1)
-	default MV_CESA_INT_COALESCING_SUPPORT if (ARMADA_XP_REV_A0 || ARMADA_XP_REV_B0 || ARCH_AVANTA_LP)
+	default MV_CESA_INT_COALESCING_SUPPORT if (ARMADA_XP_REV_A0 || ARMADA_XP_REV_B0 || ARCH_AVANTA_LP || ARCH_ARMADA38X)
 
 config MV_CESA_CHAIN_MODE
 	bool "Support CESA chain-mode"
@@ -36,7 +36,7 @@ config MV_CESA_CHAIN_MODE
 
 config MV_CESA_INT_COALESCING_SUPPORT
 	bool "Support Interrupt Coalescing"
-	depends on MV_CESA && (ARMADA_XP_REV_A0 || ARMADA_XP_REV_B0 || ARCH_AVANTA_LP)
+	depends on MV_CESA && (ARMADA_XP_REV_A0 || ARMADA_XP_REV_B0 || ARCH_AVANTA_LP || ARCH_ARMADA38X)
 	---help---
 	Choosing this option will enable CESA interrupt coalescing support.
 
@@ -48,6 +48,28 @@ config MV_CESA_INT_PER_PACKET
 
 endchoice
 
+config	MV_CESA_INT_COAL_THRESHOLD
+	hex "Cryptographic Interrupt Coalescing Threshold"
+	depends on MV_CESA_INT_COALESCING_SUPPORT
+	range 0x0 0xff
+	default 0x2
+	---help---
+	This field provides a way to minimize the number of interrupts to off
+	load the CPU. It defines the number of <AccAndTDMAInt_CM> indications
+	before asserting the <EopCoalInt> bit in the Cryptographic interrupt
+	Cause Register.
+
+config	MV_CESA_INT_COAL_TIME_THRESHOLD
+	hex "Cryptographic Interrupt Coalescing Time Threshold"
+	depends on MV_CESA_INT_COALESCING_SUPPORT
+	range 0x0 0xffffff
+	default 0xfffff
+	---help---
+	This field provides a way to ensure maximum delay between <AccAndTDMAInt_CM>
+	assertion and assertion bit <EopCoalInt> in Cryptographic Interrupt Cause
+	Register (even if the number of <AccAndTDMAInt_CM> indications did not
+	reach the <EopCoalPacketTh> value).
+
 choice 
         prompt "CESA Mode"
         depends on MV_CESA
-- 
1.7.5.4

