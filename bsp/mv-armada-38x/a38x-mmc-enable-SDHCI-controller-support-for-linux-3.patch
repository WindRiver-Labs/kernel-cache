From 13b2314996497b560c965d78a60197e9c7692705 Mon Sep 17 00:00:00 2001
From: Nadav Haklai <nadavh@marvell.com>
Date: Wed, 22 Jan 2014 13:12:52 +0200
Subject: [PATCH 1306/1825] a38x: mmc: enable SDHCI controller support for
 linux-3.4

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 3945e615dd4dab9d56f5fe561e87ee59cad4dcfd

	- use extended sdhci_pxa_platdata structure
	- use separate memory resources for SDHCI driver registers and windows
	  configuration registers
	- update A385/A380 defconfigs

Change-Id: I680f2cf89f201a30aaff532eb02f97a246b2b617
Signed-off-by: Marcin Wojtas <mw@semihalf.com>
Signed-off-by: Nadav Haklai <nadavh@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5242
Tested-by: Star_Automation <star@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5306
Reviewed-by: Igor Patrik <igorp@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/configs/armada_380_v7up_defconfig  |    2 +-
 arch/arm/configs/armada_385_v7smp_defconfig |    2 +-
 arch/arm/mach-armada38x/Makefile            |    1 -
 arch/arm/mach-armada38x/config/mvRules.mk   |    1 -
 arch/arm/mach-armada38x/core.c              |   60 +++++++++++---------------
 arch/arm/mach-armada38x/time.c              |   15 +++++++
 6 files changed, 42 insertions(+), 39 deletions(-)

diff --git a/arch/arm/configs/armada_380_v7up_defconfig b/arch/arm/configs/armada_380_v7up_defconfig
index c7a16d4..72b99cb 100644
--- a/arch/arm/configs/armada_380_v7up_defconfig
+++ b/arch/arm/configs/armada_380_v7up_defconfig
@@ -18,7 +18,6 @@ CONFIG_MV_ETH_PORTS_NUM=2
 CONFIG_MV_ETH_TXQ=8
 # CONFIG_NET_SKB_RECYCLE is not set
 # CONFIG_MV_INCLUDE_USB is not set
-# CONFIG_MV_INCLUDE_SDIO is not set
 CONFIG_MV_ETH_TXQ_DESC=1024
 CONFIG_MV_ETH_DEBUG_CODE=y
 CONFIG_MV_ETH_STAT_DBG=y
@@ -129,6 +128,7 @@ CONFIG_USB_STORAGE_SDDR09=y
 CONFIG_USB_STORAGE_SDDR55=y
 CONFIG_USB_STORAGE_JUMPSHOT=y
 CONFIG_MMC=y
+CONFIG_MMC_SDHCI_PXAV3=y
 CONFIG_NEW_LEDS=y
 CONFIG_RTC_CLASS=y
 CONFIG_RTC_DRV_MV=y
diff --git a/arch/arm/configs/armada_385_v7smp_defconfig b/arch/arm/configs/armada_385_v7smp_defconfig
index 36c3e9c..8b417fd 100644
--- a/arch/arm/configs/armada_385_v7smp_defconfig
+++ b/arch/arm/configs/armada_385_v7smp_defconfig
@@ -22,7 +22,6 @@ CONFIG_MV_ETH_TXQ=8
 # CONFIG_MV_INCLUDE_LEGACY_NAND is not set
 # CONFIG_MV_INCLUDE_INTEG_SATA is not set
 # CONFIG_MV_INCLUDE_NOR is not set
-# CONFIG_MV_INCLUDE_SDIO is not set
 CONFIG_MV_ETH_TXQ_DESC=1024
 CONFIG_MV_ETH_DEBUG_CODE=y
 CONFIG_MV_ETH_STAT_DBG=y
@@ -135,6 +134,7 @@ CONFIG_USB_STORAGE_SDDR09=y
 CONFIG_USB_STORAGE_SDDR55=y
 CONFIG_USB_STORAGE_JUMPSHOT=y
 CONFIG_MMC=y
+CONFIG_MMC_SDHCI_PXAV3=y
 CONFIG_NEW_LEDS=y
 CONFIG_RTC_CLASS=y
 CONFIG_RTC_DRV_MV=y
diff --git a/arch/arm/mach-armada38x/Makefile b/arch/arm/mach-armada38x/Makefile
index e390c83..7c83893 100644
--- a/arch/arm/mach-armada38x/Makefile
+++ b/arch/arm/mach-armada38x/Makefile
@@ -59,7 +59,6 @@ obj-y					:= armada38x.o
 armada38x-objs				:= $(LSP_OBJS) $(COMMON_OBJS) $(OSSERVICES_OBJS) $(HAL_OBJS)	\
 					   $(KW_FAM_OBJS)
 
-armada38x-$(CONFIG_MV_INCLUDE_SDIO)	+= $(HAL_SDMMC_DIR)/mvSdmmcAddrDec.o
 armada38x-$(CONFIG_MV_INCLUDE_XOR)	+= $(HAL_XOR_DIR)/mvXor.o $(HAL_XOR_DIR)/mvXorAddrDec.o		\
 					   $(HAL_IF_DIR)/mvSysXor.o
 armada38x-$(CONFIG_MV_INCLUDE_PEX)	+= $(HAL_PEX_DIR)/mvPex.o					\
diff --git a/arch/arm/mach-armada38x/config/mvRules.mk b/arch/arm/mach-armada38x/config/mvRules.mk
index 8051fdb..6ef29b0 100644
--- a/arch/arm/mach-armada38x/config/mvRules.mk
+++ b/arch/arm/mach-armada38x/config/mvRules.mk
@@ -66,7 +66,6 @@ LSP_NET_DEV_DIR   = $(LSP_NETWORK_DIR)/mv_etherent
 LSP_NFP_MGR_DIR   = $(LSP_NETWORK_DIR)/nfp_mgr
 
 HAL_CPU_DIR	  = $(HAL_DIR)/cpu
-HAL_SDMMC_DIR	  = $(HAL_DIR)/sdmmc
 ifeq ($(CONFIG_MV_INCLUDE_PCI),y)
 HAL_PCI_DIR	  = $(HAL_DIR)/pci
 endif
diff --git a/arch/arm/mach-armada38x/core.c b/arch/arm/mach-armada38x/core.c
index 8e67ca5..18124e4 100644
--- a/arch/arm/mach-armada38x/core.c
+++ b/arch/arm/mach-armada38x/core.c
@@ -59,8 +59,9 @@
 #endif
 
 #if defined(CONFIG_MV_INCLUDE_SDIO)
-#include "sdmmc/mvSdmmc.h"
-#include <plat/mvsdio.h>
+#include <linux/platform_data/pxa_sdhci.h>
+#include <linux/mmc/sdhci.h>
+#include <linux/mmc/host.h>
 #endif
 
 #ifdef CONFIG_MV_INCLUDE_XOR
@@ -446,13 +447,18 @@ void __init serial_initialize(int port)
  * SDIO
  */
 #if defined(CONFIG_MV_INCLUDE_SDIO)
-static struct resource mvsdio_resources[] = {
+static struct resource mv_sdhci_resources[] = {
 	[0] = {
 	       .start = INTER_REGS_PHYS_BASE + MV_SDMMC_REGS_OFFSET,
 	       .end = INTER_REGS_PHYS_BASE + MV_SDMMC_REGS_OFFSET + SZ_1K - 1,
 	       .flags = IORESOURCE_MEM,
 	       },
 	[1] = {
+	       .start = INTER_REGS_PHYS_BASE + MV_SDMMC_WINDOWS_REGS_OFFSET,
+	       .end = INTER_REGS_PHYS_BASE + MV_SDMMC_WINDOWS_REGS_OFFSET + 0xff,
+	       .flags = IORESOURCE_MEM,
+	       },
+	[2] = {
 	       .start = IRQ_GLOBAL_SDIO,
 	       .end = IRQ_GLOBAL_SDIO,
 	       .flags = IORESOURCE_IRQ,
@@ -460,51 +466,35 @@ static struct resource mvsdio_resources[] = {
 
 };
 
-static u64 mvsdio_dmamask = 0xffffffffUL;
+static u64 mv_sdhci_dmamask = 0xffffffffUL;
 
-static struct mvsdio_platform_data mvsdio_data = {
-	.gpio_write_protect = 0,
-	.gpio_card_detect = 0,
-	.dram = NULL,
+static struct sdhci_pxa_platdata mv_sdhci_data = {
+	.clk_delay_cycles = 0x1f,
+	.quirks = SDHCI_QUIRK_INVERTED_WRITE_PROTECT
+		| SDHCI_QUIRK_BROKEN_CARD_DETECTION,
+	.host_caps = MMC_CAP_8_BIT_DATA,
+	.dram = &a38x_mbus_dram_info,
 };
 
-static struct platform_device mv_sdio_plat = {
-	.name = "mvsdio",
+static struct platform_device mv_sdhci_plat = {
+	.name = "sdhci-pxav3",
 	.id = -1,
 	.dev = {
-		.dma_mask = &mvsdio_dmamask,
+		.dma_mask = &mv_sdhci_dmamask,
 		.coherent_dma_mask = 0xffffffff,
-		.platform_data = &mvsdio_data,
+		.platform_data = &mv_sdhci_data,
 		},
-	.num_resources = ARRAY_SIZE(mvsdio_resources),
-	.resource = mvsdio_resources,
+	.num_resources = ARRAY_SIZE(mv_sdhci_resources),
+	.resource = mv_sdhci_resources,
 };
 #endif
 
-void __init a38x_sdio_init(void)
+void __init a38x_sdhci_init(void)
 {
 #ifdef CONFIG_MV_INCLUDE_SDIO
 	if (mvUnitMapIsMine(SDIO) != MV_TRUE)
 		return;
-
-	if (MV_TRUE == mvCtrlPwrClckGet(SDIO_UNIT_ID, 0)) {
-		int irq_detect = mvBoardSDIOGpioPinGet(BOARD_GPP_SDIO_DETECT);
-		static MV_UNIT_WIN_INFO addrWinMap[MAX_TARGETS + 1];
-
-		if (irq_detect != MV_ERROR) {
-			mvsdio_data.gpio_card_detect =
-			    mvBoardSDIOGpioPinGet(BOARD_GPP_SDIO_DETECT);
-		}
-
-		if (mvBoardSDIOGpioPinGet(BOARD_GPP_SDIO_WP) != MV_ERROR)
-			mvsdio_data.gpio_write_protect =
-			    mvBoardSDIOGpioPinGet(BOARD_GPP_SDIO_WP);
-
-		if (MV_OK == mvCtrlAddrWinMapBuild(addrWinMap, MAX_TARGETS + 1))
-			if (MV_OK == mvSdmmcWinInit(addrWinMap))
-				mvsdio_data.clock = mvBoardTclkGet();
-		platform_device_register(&mv_sdio_plat);
-	}
+	platform_device_register(&mv_sdhci_plat);
 #endif
 }
 
@@ -1257,9 +1247,9 @@ static void __init a38x_board_init(void)
 	a38x_sata_init();
 	a38x_spi_init();
 	a38x_i2c_init();
+	a38x_sdhci_init();
 #if 0
 	a38x_rtc_init();
-	a38x_sdio_init();
 	a38x_nand_nfc_init();
 	a38x_gpio_init();
 	a38x_hwmon_init();
diff --git a/arch/arm/mach-armada38x/time.c b/arch/arm/mach-armada38x/time.c
index 277b989..32ab8eab 100644
--- a/arch/arm/mach-armada38x/time.c
+++ b/arch/arm/mach-armada38x/time.c
@@ -205,6 +205,20 @@ static void __init a38x_twd_init(void)
 #define a38x_twd_init()	do { } while (0)
 #endif
 
+#ifdef CONFIG_MV_INCLUDE_SDIO
+static struct clk_lookup clk_sdhci_lookup = {
+	.dev_id = "sdhci-pxav3",
+	.con_id = "PXA-SDHCLK",
+};
+#endif
+
+static void __init a38x_sdhci_clk_init(void)
+{
+#ifdef CONFIG_MV_INCLUDE_SDIO
+	clkdev_add(&clk_sdhci_lookup);
+#endif
+}
+
 /* Setup free-running clocksource timer */
 static void a38x_setup_clocksource(int timer, long rate)
 {
@@ -275,6 +289,7 @@ static void __init a38x_timer_init(void)
 	a38x_setup_clockevent(IRQ_GLOBAL_TIMER(event_timer_id), rate);
 
 	a38x_twd_init();
+	a38x_sdhci_clk_init();
 }
 
 struct sys_timer a38x_timer = {
-- 
1.7.5.4

