From 27475c48d91ea4ffcca790ae3651aa9fb09d1c19 Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Thu, 15 Nov 2012 10:20:36 +0200
Subject: [PATCH 0341/1825] PM, usb: Add support to USB suspend/resume on
 ArmadaXP-B0.

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit eeaa868d34b8fb1b6c06c7409fac366409db27b0

Change-Id: Ibffdd17994d90c24975ea7801d0e236350979fed
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-armadaxp/core.c   |    8 ++++++++
 arch/arm/mach-armadaxp/usb.c    |   22 ++++++++++++++++++++++
 drivers/usb/host/ehci_marvell.c |   16 +++++++++++++++-
 3 files changed, 45 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-armadaxp/core.c b/arch/arm/mach-armadaxp/core.c
index 213dfa0..e4d0a3b 100644
--- a/arch/arm/mach-armadaxp/core.c
+++ b/arch/arm/mach-armadaxp/core.c
@@ -95,6 +95,11 @@
 #include "mv_mtd/nand_nfc.h"
 #endif
 
+/* USB */
+#ifdef CONFIG_MV_INCLUDE_USB
+#include "usb/mvUsb.h"
+#endif
+
 #define MV_COHERENCY_FABRIC_CTRL_REG		(MV_COHERENCY_FABRIC_OFFSET + 0x0)
 #define MV_COHERENCY_FABRIC_CFG_REG		(MV_COHERENCY_FABRIC_OFFSET + 0x4)
 
@@ -1470,6 +1475,9 @@ void axp_db_restore(void)
 		return;
 	}
 
+#ifdef CONFIG_MV_INCLUDE_USB
+	mvUsbPllInit();
+#endif
 	mvSysEthPhyInit();
 #ifdef CONFIG_MV_INCLUDE_PEX
 	/* Reinitialize PEX root complex */
diff --git a/arch/arm/mach-armadaxp/usb.c b/arch/arm/mach-armadaxp/usb.c
index 80d8763..8e74eaf 100644
--- a/arch/arm/mach-armadaxp/usb.c
+++ b/arch/arm/mach-armadaxp/usb.c
@@ -70,6 +70,28 @@ static void mv_usb_release(struct device *dev)
     kfree(pdev);
 } 
 
+int mv_usb_resume(int dev)
+{
+	int status, isHost;
+	char *name_ptr;
+
+	if (MV_FALSE == mvCtrlPwrClckGet(USB_UNIT_ID, dev)) {
+		printk(KERN_DEBUG "\nWarning Integrated USB %d is Powered Off\n", dev);
+		return -EINVAL;
+	}
+
+	/* Check if this USB is mapped to this AMP group - YY */
+	if(MV_FALSE == mvUnitMapIsMine(USB0 + dev))
+		return -EINVAL;
+
+	isHost = mvIsUsbHost & (1 << dev);
+	name_ptr = isHost ? usb_host_name : usb_dev_name;
+
+	printk(KERN_DEBUG "registered dev#%d as a %s\n", dev, name_ptr);
+	status = mvSysUsbInit(dev, isHost);
+
+	return status;
+}
 
 static int __init   mv_usb_init(void)
 {
diff --git a/drivers/usb/host/ehci_marvell.c b/drivers/usb/host/ehci_marvell.c
index bad4a76..889d488 100644
--- a/drivers/usb/host/ehci_marvell.c
+++ b/drivers/usb/host/ehci_marvell.c
@@ -201,12 +201,26 @@ static int ehci_marvell_remove(struct platform_device *pdev)
    return 0;
 } 
  
- 
+#if defined(CONFIG_ARCH_ARMADA_XP)
+extern int mv_usb_resume(int dev);
+
+static int ehci_marvell_resume(struct platform_device *pdev)
+{
+	int status = mv_usb_resume(pdev->id);
+
+	return status;
+}
+#endif
+
+
 static struct platform_driver ehci_marvell_driver =  
 { 
     .driver.name = "ehci_marvell", 
     .probe = ehci_marvell_probe, 
     .remove = ehci_marvell_remove,
+#if defined(CONFIG_ARCH_ARMADA_XP)
+    .resume = ehci_marvell_resume,
+#endif
     .shutdown = usb_hcd_platform_shutdown, 
 };  
 
-- 
1.7.5.4

