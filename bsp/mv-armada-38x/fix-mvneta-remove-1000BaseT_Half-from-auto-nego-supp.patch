From b3243445cdb18c5cc847d83459c47049278a132c Mon Sep 17 00:00:00 2001
From: Liu Haitao <haitao.liu@windriver.com>
Date: Thu, 27 Jul 2017 13:19:15 +0800
Subject: [PATCH 3/5] fix: mvneta: remove 1000BaseT_Half from auto-nego
 supported mode

Issue: LIN8-7049

- It fix issue SYSTEMSW-2644 that Neta SoCs should not support
1000Base Half mode, such as A38x, A3700, A370 and AXP
- This patch add valdation on advertising mode to prevent from
the misconfigurations.

The patch was imported from the Marvell git hub :
(https://github.com/MarvellEmbeddedProcessors/linux-marvell/commit/40d06b6680bafe6895c60e61eb04804de5c8a786)
as of commit id 40d06b6680bafe6895c60e61eb04804de5c8a786

Change-Id: Ic8039e16992d05a62284927a65ce214f6d1dc327
Signed-off-by: Evan Wang <xswang@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/32149
Reviewed-by: Wilson Ding <dingwei@marvell.com>
Tested-by: Star_Automation <star@marvell.com>

Signed-off-by: Liu Haitao <haitao.liu@windriver.com>
---
 drivers/net/ethernet/marvell/mvneta.c |   27 +++++++++++++++++++++++++++
 1 files changed, 27 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/marvell/mvneta.c b/drivers/net/ethernet/marvell/mvneta.c
index 1cc0b95..a5a176b 100644
--- a/drivers/net/ethernet/marvell/mvneta.c
+++ b/drivers/net/ethernet/marvell/mvneta.c
@@ -2842,6 +2842,8 @@ static int mvneta_mdio_probe(struct mvneta_port *pp)
 	}
 
 	phy_dev->supported &= PHY_GBIT_FEATURES;
+	/*Neta does not support 1000baseT_Half*/
+	phy_dev->supported &= (PHY_GBIT_FEATURES & (~ SUPPORTED_1000baseT_Half));
 	phy_dev->advertising = phy_dev->supported;
 
 	pp->phy_dev = phy_dev;
@@ -3099,6 +3101,28 @@ static int mvneta_ioctl(struct net_device *dev, struct ifreq *ifr, int cmd)
 
 /* Ethtool methods */
 
+/* Check speed and duplex when set auto-nego with ethtool */
+static int mvneta_spd_dplx_valid(struct mvneta_port *pp,
+						 struct ethtool_cmd *cmd)
+{
+	int ret = 0;
+	u32 speed = ethtool_cmd_speed(cmd);
+
+	if ((speed + cmd->duplex) == (SPEED_1000 + DUPLEX_HALF)) {
+		/* When auto-nego disabled, 1000Base-Half is illegal.
+		 * When auto-nego enabled, 1000Base-Half is invalid,
+		 * but no error return for this,
+		 * ethtool will show results.
+		 * 		 		 		 */
+		if (cmd->autoneg == AUTONEG_DISABLE) {
+			netdev_err(pp->dev, "Unsupported Speed/Duplex configuration\n");
+			ret = -EINVAL;
+		}
+	}
+	return ret;
+}
+
+
 /* Get settings (phy address, speed) for ethtools */
 int mvneta_ethtool_get_settings(struct net_device *dev, struct ethtool_cmd *cmd)
 {
@@ -3107,6 +3131,9 @@ int mvneta_ethtool_get_settings(struct net_device *dev, struct ethtool_cmd *cmd)
 	if (!pp->phy_dev)
 		return -ENODEV;
 
+	if(mvneta_spd_dplx_valid(pp,cmd))
+		return -EINVAL;
+
 	return phy_ethtool_gset(pp->phy_dev, cmd);
 }
 
-- 
1.7.5.4

