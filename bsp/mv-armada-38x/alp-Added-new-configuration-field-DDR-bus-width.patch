From 10c6aaf507153039f04edd1707de58128d3de22d Mon Sep 17 00:00:00 2001
From: Hanna Hawa <hannah@marvell.com>
Date: Tue, 7 Jan 2014 19:09:25 +0200
Subject: [PATCH 1274/1825] alp: Added new configuration field - DDR bus-width

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 4804d922e2cdc825266a635b2b7cf92670c07371

	DDR Bus-width modification is relevant only for board DB-660
	- Added support to change DDR bus-width with setting in
	DIP-switch/EEPROM
	- Added field 'ddr_buswidth' to boardconfig u-boot command (for EEPROM)
	- Allocate bit 3 in DIP-switch (SW-7) to this configuration field

Change-Id: I98e70f28503dab2ef0a423adb6b1f1d802a590f0
Signed-off-by: Hanna Hawa <hannah@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5039
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   42 ++++++++++++++++++-
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    2 +
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h        |    1 +
 3 files changed, 42 insertions(+), 3 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index c463345..1cf4a1a 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -965,6 +965,12 @@ MV_VOID mvBoardInfoUpdate(MV_VOID)
 		/* If needed, enable SFP0 TX for SGMII, for DB-6660 */
 		if (ethComplex & MV_ETHCOMP_GE_MAC0_2_COMPHY_2)
 			mvBoardSgmiiSfp0TxSet(MV_TRUE);
+
+		/* Check conflicts between device bus module and NAND */
+		mvBoardAudioModuleConfigCheck();
+
+		/* Check DDR buswidth configuration */
+		mvBoardDDRBusWidthCheck();
 	}
 }
 
@@ -1184,9 +1190,6 @@ MV_BOARD_BOOT_SRC mvBoardBootDeviceGroupSet()
 	MV_U32 groupType;
 	MV_BOARD_BOOT_SRC bootSrc = mvBoardBootDeviceGet();
 
-	/* Check conflicts between device bus module and NAND */
-	mvBoardAudioModuleConfigCheck();
-
 	switch (bootSrc) {
 	case MSAR_0_BOOT_NAND_NEW:
 		mvBoardMppTypeSet(0, NAND_BOOT_V2);
@@ -1806,6 +1809,39 @@ MV_VOID mvBoardAudioModuleConfigCheck(MV_VOID)
 }
 
 /*******************************************************************************
+* mvBoardDDRBusWidthCheck
+*
+* DESCRIPTION:
+*	Check if DDR buswidth is different from the board configuration
+*
+* INPUT:
+*	None.
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*	None.
+*
+*******************************************************************************/
+MV_VOID mvBoardDDRBusWidthCheck(MV_VOID)
+{
+	MV_U32 configVar, ddrVar;
+
+	/* DDR buswidth field control relevant for MV88F6660 SoC */
+	if (mvBoardIdGet() != DB_6660_ID)
+		return;
+
+	configVar = (mvCtrlSysConfigGet(MV_CONFIG_DDR_BUSWIDTH) == 0x0) ? 32 : 16;
+	ddrVar = mvCtrlDDRBudWidth();
+
+	if (configVar != ddrVar)
+		mvOsPrintf("Error: Mismatch between DDR buswidth - %d, and board configuration DDR buswidth - %d\n",\
+				ddrVar, configVar);
+}
+
+
+/*******************************************************************************
 * mvBoardConfigurationPrint
 *
 * DESCRIPTION:
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index c397da4..20db55d 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -393,6 +393,7 @@ typedef struct _boardInfo {
 { MV_CONFIG_LANE3,	       0X40,	6,	 0,		1,	{ 0, 0, 0, 1 } }, \
 { MV_CONFIG_MAC0_SW_SPEED,     0X80,	7,	 0,		1,	{ 0, 1, 0, 1 } }, \
 { MV_CONFIG_DEVICE_BUS_MODULE, 0x3,	0,	 1,		0,	{ 0, 0, 0, 1 } }, \
+{ MV_CONFIG_DDR_BUSWIDTH,      0x4,	2,	 1,		0,	{ 0, 0, 0, 1 } }, \
 };
 
 /* MV_CONFIG_TYPE_ID ConfigID,      MV_U32 Offset,	 expanderNum,  regNum,   }} */
@@ -531,6 +532,7 @@ MV_U8 mvBoardTdmDevicesCountGet(void);
 MV_U8 mvBoardTdmSpiCsGet(MV_U8 devId);
 MV_U8 mvBoardTdmSpiIdGet(MV_VOID);
 MV_VOID mvBoardAudioModuleConfigCheck(MV_VOID);
+MV_VOID mvBoardDDRBusWidthCheck(MV_VOID);
 MV_VOID mvBoardConfigurationPrint(MV_VOID);
 MV_BOOL mvBoardIsGbEPortConnected(MV_U32 ethPortNum);
 MV_32 mvBoardGetDevicesNumber(MV_BOARD_DEV_CLASS devClass);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
index cb96765..b119b56 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
@@ -118,6 +118,7 @@ typedef enum _mvConfigTypeID {
 	MV_CONFIG_MAC0_SW_SPEED,
 	MV_CONFIG_DEVICE_BUS_MODULE,
 	MV_CONFIG_SLIC_TDM_DEVICE,
+	MV_CONFIG_DDR_BUSWIDTH,
 	MV_CONFIG_TYPE_MAX_OPTION,
 	MV_CONFIG_TYPE_CMD_DUMP_ALL,
 	MV_CONFIG_TYPE_CMD_SET_DEFAULT
-- 
1.7.5.4

