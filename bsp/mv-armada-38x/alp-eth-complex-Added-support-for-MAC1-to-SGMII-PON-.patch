From 5fb44b335445e04c9cca5a583e8c5380fcf4100f Mon Sep 17 00:00:00 2001
From: Hanna Hawa <hannah@marvell.com>
Date: Tue, 18 Mar 2014 18:44:00 +0200
Subject: [PATCH 1488/1825] alp: eth complex: Added support for MAC1 to SGMII
 (PON serdes)

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 56b532bd549fd97b30486fdfcbd2c180dfc6fad1

	Added Support for MAC1 to SGMII (PON serdes)
	- Added function in Ethernet complex code that set the
	Gpon Phy source
	- Added defines for GPON control
	- To use this configuration, set board config: ponserdes = MAC1
	Added initial support for eth complex configuration for
	  Xpon2PonSerDes - not tested

Change-Id: Ibba93e3a869c483c30bdd9247881ca83c6509680
Signed-off-by: Hanna Hawa <hannah@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/6511
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   12 +++++++++-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |    2 +-
 .../avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c    |   21 ++++++++++++++++++-
 .../avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h    |    8 +++++++
 4 files changed, 38 insertions(+), 5 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index 933df69..1f1801f 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -945,7 +945,8 @@ MV_VOID mvBoardInfoUpdate(MV_VOID)
 	macSpeed = BOARD_MAC_SPEED_AUTO; /*if Mac is not connected to switch, auto-negotiate speed*/
 	if (ethComplex & MV_ETHCOMP_GE_MAC1_2_GE_PHY_P3)
 		smiAddress = 0x3;
-	else if (ethComplex & MV_ETHCOMP_GE_MAC1_2_RGMII1)
+	/* MAC1 to RGMII, or MAC1 to SGMII: both configs use the same SMI address (0x1) */
+	else if (ethComplex & MV_ETHCOMP_GE_MAC1_2_RGMII1 || ethComplex & MV_ETHCOMP_GE_MAC1_2_PON_ETH_SERDES)
 		smiAddress = 0x1;
 	else {
 		smiAddress = -1; /* no SMI address if connected to switch */
@@ -1063,7 +1064,8 @@ MV_VOID mvBoardMppIdUpdate(MV_VOID)
 
 	/* Groups 3-4  - (only if not Booting from SPI1)*/
 	if (bootDev != MSAR_0_BOOT_SPI1_FLASH) {
-		if (ethComplexOptions & MV_ETHCOMP_GE_MAC1_2_RGMII1) {
+		if (ethComplexOptions & MV_ETHCOMP_GE_MAC1_2_RGMII1 ||
+				ethComplexOptions & MV_ETHCOMP_GE_MAC1_2_PON_ETH_SERDES) {
 			mvBoardMppTypeSet(3, GE1_UNIT);
 			if (slicDev == SLIC_LANTIQ_ID)
 				mvBoardMppTypeSet(4, GE1_CPU_SMI_CTRL_TDM_LQ_UNIT);
@@ -3209,6 +3211,7 @@ MV_BOOL mvBoardIsEthActive(MV_U32 ethNum)
 
 	if (ethNum == 1 && ((c & MV_ETHCOMP_GE_MAC1_2_GE_PHY_P3) ||
 			(c & MV_ETHCOMP_GE_MAC1_2_RGMII1) ||
+			(c & MV_ETHCOMP_GE_MAC1_2_PON_ETH_SERDES) ||
 			((c & MV_ETHCOMP_GE_MAC1_2_SW_P4) && mvBoardMacCpuPortGet() == 1)))
 			isActive = MV_TRUE;
 
@@ -3290,12 +3293,17 @@ MV_BOOL mvBoardConfigAutoDetectEnabled()
 *******************************************************************************/
 MV_STATUS mvBoardConfigVerify(MV_CONFIG_TYPE_ID field, MV_U8 writeVal)
 {
+	MV_U32 c = mvBoardEthComplexConfigGet();
 	/* 0x2 = SATA1, 0x3 = Unconnected are supported only for A0 */
 	if ((field == MV_CONFIG_LANE1 && (writeVal == 0x2 || writeVal == 0x3)) \
 			&& (mvCtrlRevGet() <= MV_88F66X0_Z3_ID)) {
 		mvOsPrintf("Error: this option is not supported in Z stepping revision\n");
 		return MV_ERROR;
 	}
+	if (field == MV_CONFIG_MAC1 && (c & MV_ETHCOMP_GE_MAC1_2_PON_ETH_SERDES)) {
+		mvOsPrintf("Warning: MAC1 is connected to PON Serdes\n");
+		return MV_ERROR;
+	}
 	return MV_OK;
 
 }
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 748d95c..a5e0b5a 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -518,7 +518,7 @@ MV_VOID mvCtrlSmiMasterSet(MV_SMI_CTRL smiCtrl)
 	 * 1. Boot source is SPI1
 	 * 2. RGMII-1 is disabled (SPI-1 MPP's are shared with RGMII-1 MPP's) */
 	if (mvBoardBootDeviceGet() == MSAR_0_BOOT_SPI1_FLASH ||
-		(!(ethComplex & MV_ETHCOMP_GE_MAC1_2_RGMII1)))
+		(!(ethComplex & MV_ETHCOMP_GE_MAC1_2_RGMII1) && !(ethComplex & MV_ETHCOMP_GE_MAC1_2_PON_ETH_SERDES)))
 		isSPI1Enabled = MV_TRUE;
 	else
 		isSPI1Enabled = MV_FALSE;
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
index ab5699e..773e452 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
@@ -71,6 +71,20 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "pp2/gmac/mvEthGmacRegs.h"
 #include "pp2/gbe/mvPp2Gbe.h"
 
+static void mvEthComplexGponPhySrcSet(MV_U32 src)
+{
+	MV_U32 reg;
+
+	reg = MV_REG_READ(MV_GPON_PHY_CTRL1_REG);
+	reg &= ~GPON_PHY_CTRL1_MASK;
+
+	src <<= GPON_PHY_CTRL1_OFFSET;
+	src &= GPON_PHY_CTRL1_MASK;
+
+	reg |= src;
+
+	MV_REG_WRITE(MV_GPON_PHY_CTRL1_REG, reg);
+}
 static void mvEthComplexGphyPortSmiSrcSet(MV_U32 phy, MV_U32 src)
 {
 	MV_U32 reg;
@@ -90,6 +104,7 @@ static void mvEthComplexGphyPortSmiSrcSet(MV_U32 phy, MV_U32 src)
 
 	MV_REG_WRITE(MV_ETHCOMP_CTRL_REG, reg);
 }
+
 static void mvEthComplexGbeClockControlSet(void)
 {
 	MV_U32 reg;
@@ -370,7 +385,8 @@ static void mvEthComplexSwPortToRgmii(MV_U32 swPort, MV_U32 port)
 
 static void mvEthComplexXponMacToPonSerdes(void)
 {
-	/* Not implemented */
+	/* 0x0 = XPON Mac is source for GponPhy */
+	mvEthComplexGponPhySrcSet(0);
 }
 
 static void mvEthComplexMacToGbePhy(MV_U32 port, MV_U32 phy, MV_U32 phyAddr)
@@ -401,7 +417,8 @@ static void mvEthComplexMacToComPhy(MV_U32 port, MV_U32 comPhy, MV_U32 ethComple
 
 static void mvEthComplexMac1ToPonSerdes(MV_U32 port)
 {
-	/* Not implemented */
+	/* 0x1 = Mac#1 is source for GponPhy */
+	mvEthComplexGponPhySrcSet(0x1);
 }
 
 static void mvEthComplexMacToRgmii(MV_U32 port, MV_U32 phy)
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h
index 0638429..fe72ea6 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h
@@ -168,6 +168,14 @@ enum mvSwPortSrc {
 #define     ETHQPCS_DPLL_RESET_OFFSET			4
 #define     ETHQPCS_DPLL_RESET_MASK			(0x1 << ETHQPCS_DPLL_RESET_OFFSET)
 
+/*******************************************************************************
+ * GPON PHY Contol 1
+ */
+#define MV_GPON_PHY_CTRL1_REG				(MV_IP_CONFIG_REGS_OFFSET + 0xF8)
+
+#define GPON_PHY_CTRL1_OFFSET				0
+#define GPON_PHY_CTRL1_MASK				(0x1 << GPON_PHY_CTRL1_OFFSET)
+
 #ifdef CONFIG_MV_ETH_PP2
 MV_STATUS mvEthComplexInit(MV_U32 ethCompConfig);
 #else
-- 
1.7.5.4

