From 49e6b84d893f7a5bf8916770e352efc50f2b8aa1 Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Mon, 11 Nov 2013 16:18:03 -0500
Subject: [PATCH 1073/1825] fix: pp2: Fix MIB counters read and clean

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 9432723ae40c149cc553760b3c1663dca54d6356

	- All counters must be read.
	- Last counter offset 0x7c must be read last.

Change-Id: Ib9ed8650aaeac8263de50a631834365fcb571a69
Signed-off-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4289
Reviewed-by: Yelena Krivosheev <yelena@marvell.com>
Reviewed-by: Uri Eliyahu <uriel@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Tested-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c |   30 ++++++++++----------
 1 files changed, 15 insertions(+), 15 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
index e32c9a4..29f9aab 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
@@ -288,19 +288,15 @@ char *mvEthSpeedStrGet(MV_ETH_PORT_SPEED speed)
 *******************************************************************************/
 void mvEthMaxRxSizeSet(int port, int maxRxSize)
 {
-    MV_U32		regVal;
-
-	if (!MV_PON_PORT(port)) {
-
-		regVal =  MV_REG_READ(ETH_GMAC_CTRL_0_REG(port));
-		regVal &= ~ETH_GMAC_MAX_RX_SIZE_MASK;
-		regVal |= (((maxRxSize - MV_ETH_MH_SIZE) / 2) << ETH_GMAC_MAX_RX_SIZE_OFFS);
-		MV_REG_WRITE(ETH_GMAC_CTRL_0_REG(port), regVal);
-/*
-		mvOsPrintf("%s: port=%d, maxRxSize=%d, regAddr=0x%x, regVal=0x%x\n",
-			__func__, port, maxRxSize, ETH_GMAC_CTRL_0_REG(port), regVal);
-*/
-	}
+	MV_U32		regVal;
+
+	if (MV_PON_PORT(port))
+		return;
+
+	regVal =  MV_REG_READ(ETH_GMAC_CTRL_0_REG(port));
+	regVal &= ~ETH_GMAC_MAX_RX_SIZE_MASK;
+	regVal |= (((maxRxSize - MV_ETH_MH_SIZE) / 2) << ETH_GMAC_MAX_RX_SIZE_OFFS);
+	MV_REG_WRITE(ETH_GMAC_CTRL_0_REG(port), regVal);
 }
 
 /*******************************************************************************
@@ -718,11 +714,15 @@ MV_U32 mvEthMibCounterRead(int port, unsigned int mibOffset, MV_U32 *pHigh32)
 *******************************************************************************/
 void mvEthMibCountersClear(int port)
 {
+	int i;
+
 	if (MV_PON_PORT(port))
 		return;
 
-	/* Perform dummy reads from last counter in the MIB */
-	mvEthMibCounterRead(port, ETH_MIB_LATE_COLLISION, NULL);
+	/* Perform dummy reads from MIB counters */
+	/* Read of last counter clear all counter were read before */
+	for (i = ETH_MIB_GOOD_OCTETS_RECEIVED_LOW; i <= ETH_MIB_LATE_COLLISION; i += 4)
+		MV_REG_READ((ETH_MIB_COUNTERS_BASE(port) + i));
 }
 
 static void mvEthMibPrint(int port, MV_U32 offset, char *mib_name)
-- 
1.7.5.4

