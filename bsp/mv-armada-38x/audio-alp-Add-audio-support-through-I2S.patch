From 2e435540cb2c5362c2bb3d4b9b2fd587c67e7f3e Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Fri, 22 Nov 2013 14:30:03 +0200
Subject: [PATCH 1221/1825] audio: alp: Add audio support through I2S

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit b1c6bce0e6702c8a6bda6d5b6c1f55e22322f714

	The audio support (through I2S only) is based on mainline code
	in sound/soc/kirkwood/ directory, because this is the same
	audio controller in Kirkwood, Armada and Avanta.

	Changed files (where explanation is needed):
	--------------------------------------------

	- arch/arm/mach-avantalp/Makefile
		- No need to compile HAL files, because audio support
		  is based on mainline code, not HAL code.
	- sound/soc/kirkwood/armada370.c
		- Clean-up: A370 is not supported in Linux 3.4.
		  If the need to support A370 will arise, it should
		  use sound/soc/kirkwood/mvebu.c code.

Change-Id: I2bee1c301eebcb7e79383f6e270d6a036f0bbb9c
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4603
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/configs/avanta_lp_defconfig               |    5 +
 arch/arm/configs/avanta_lp_nat_defconfig           |    5 +
 arch/arm/mach-avantalp/Makefile                    |    2 -
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |    2 +
 arch/arm/mach-avantalp/config/mvSysAudioConfig.h   |   32 +++++
 arch/arm/mach-avantalp/core.c                      |   70 ++++++++++-
 arch/arm/mach-avantalp/export.c                    |   18 ---
 arch/arm/plat-armada/Kconfig                       |    7 +
 arch/arm/plat-armada/include/plat/i2s-orion.h      |    1 -
 sound/soc/kirkwood/Kconfig                         |   18 ++--
 sound/soc/kirkwood/Makefile                        |    4 +-
 sound/soc/kirkwood/armada370.c                     |  119 ------------------
 sound/soc/kirkwood/mvebu.c                         |  131 ++++++++++++++++++++
 13 files changed, 262 insertions(+), 152 deletions(-)
 create mode 100644 arch/arm/mach-avantalp/config/mvSysAudioConfig.h
 delete mode 100644 sound/soc/kirkwood/armada370.c
 create mode 100644 sound/soc/kirkwood/mvebu.c

diff --git a/arch/arm/configs/avanta_lp_defconfig b/arch/arm/configs/avanta_lp_defconfig
index 4c5a681..999c440 100644
--- a/arch/arm/configs/avanta_lp_defconfig
+++ b/arch/arm/configs/avanta_lp_defconfig
@@ -109,6 +109,11 @@ CONFIG_I2C_MV64XXX=y
 CONFIG_SPI=y
 CONFIG_GPIO_SYSFS=y
 # CONFIG_HWMON is not set
+CONFIG_SOUND=y
+CONFIG_SND=y
+CONFIG_SND_SOC=y
+CONFIG_SND_KIRKWOOD_SOC=y
+CONFIG_SND_MVEBU_SOC=y
 CONFIG_HID_A4TECH=y
 CONFIG_HID_APPLE=y
 CONFIG_HID_BELKIN=y
diff --git a/arch/arm/configs/avanta_lp_nat_defconfig b/arch/arm/configs/avanta_lp_nat_defconfig
index 64fb003..fc4b1eb 100644
--- a/arch/arm/configs/avanta_lp_nat_defconfig
+++ b/arch/arm/configs/avanta_lp_nat_defconfig
@@ -122,6 +122,11 @@ CONFIG_I2C_MV64XXX=y
 CONFIG_SPI=y
 CONFIG_GPIO_SYSFS=y
 # CONFIG_HWMON is not set
+CONFIG_SOUND=y
+CONFIG_SND=y
+CONFIG_SND_SOC=y
+CONFIG_SND_KIRKWOOD_SOC=y
+CONFIG_SND_MVEBU_SOC=y
 CONFIG_HID_A4TECH=y
 CONFIG_HID_APPLE=y
 CONFIG_HID_BELKIN=y
diff --git a/arch/arm/mach-avantalp/Makefile b/arch/arm/mach-avantalp/Makefile
index 469ef46..adeffe5 100644
--- a/arch/arm/mach-avantalp/Makefile
+++ b/arch/arm/mach-avantalp/Makefile
@@ -84,8 +84,6 @@ avantalp-$(CONFIG_MV_INCLUDE_SPI) 	+= $(HAL_SPI_DIR)/mvSpi.o $(HAL_SPI_DIR)/mvSp
                          		   $(HAL_SFLASH_DIR)/mvSFlash.o $(HAL_IF_DIR)/mvSysSFlash.o	\
 					   $(HAL_IF_DIR)/mvSysSpi.o
 avantalp-$(CONFIG_MV_INCLUDE_NFC)	+= $(HAL_NFC_DIR)/mvNfc.o $(HAL_IF_DIR)/mvSysNfc.o
-avantalp-$(CONFIG_MV_INCLUDE_AUDIO) 	+= $(HAL_AUDIO_DIR)/mvAudio.o $(HAL_IF_DIR)/mvSysAudio.o	\
-					   $(HAL_AUDIO_DIR)/mvAudioAddrDec.o
 avantalp-$(CONFIG_MV_CPU_PERF_CNTRS)    += $(HAL_CPU_DIR)/mvCpuCntrs.o $(HAL_CPU_DIR)/pj4/mvPJ4Cntrs.o
 avantalp-$(CONFIG_PCIE_VIRTUAL_BRIDGE_SUPPORT) += $(HAL_PEX_DIR)/mvVrtBrgPex.o
 avantalp-$(CONFIG_MV_CPU_L2_PERF_CNTRS) += $(HAL_CPU_DIR)/mvCpuL2Cntrs.o
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index b522096..e6aae9a 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -108,7 +108,9 @@ extern "C" {
  */
 #define MV_CPUIF_LOCAL_REGS_OFFSET              (0x21000)
 #define MV_CPUIF_REGS_OFFSET(cpu)               (0x21800 + (cpu) * 0x100)
+
 #define MV_CPU_HW_SEM_OFFSET                    (0x20500)
+#define MV_AUDIO_REGS_OFFSET(unit)		(0xE0000)
 
 /* Network units */
 #define MV_PP2_REG_BASE                         (0xF0000)
diff --git a/arch/arm/mach-avantalp/config/mvSysAudioConfig.h b/arch/arm/mach-avantalp/config/mvSysAudioConfig.h
new file mode 100644
index 0000000..67dcca5
--- /dev/null
+++ b/arch/arm/mach-avantalp/config/mvSysAudioConfig.h
@@ -0,0 +1,32 @@
+/*******************************************************************************
+Copyright (C) Marvell International Ltd. and its affiliates
+
+********************************************************************************
+Marvell GPL License Option
+
+If you received this File from Marvell, you may opt to use, redistribute and/or
+modify this File in accordance with the terms and conditions of the General
+Public License Version 2, June 1991 (the "GPL License"), a copy of which is
+available along with the File in the license.txt file or by writing to the Free
+Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 or
+on the worldwide web at http://www.gnu.org/licenses/gpl.txt.
+
+THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE IMPLIED
+WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY
+DISCLAIMED.  The GPL License provides additional details about this warranty
+disclaimer.
+
+*******************************************************************************/
+
+#include "mvSysHwConfig.h"
+
+/*
+ * Base address for audio registers.
+ */
+#define MV_AUDIO_REGS_BASE(unit)	(MV_AUDIO_REGS_OFFSET(unit))
+
+/*
+ * Don't perform decoding / playback address decoding fix in the HAL, as it
+ * will be done in the Audio driver.
+ */
+#define MV_AUDIO_SKIP_WIN_DECODING
diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index 43ea78c..27da929 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -39,9 +39,14 @@
 #include <linux/serial_8250.h>
 #include <linux/serial_reg.h>
 #include <asm/serial.h>
-
 #include <mach/serial.h>
 
+#if defined(CONFIG_MV_INCLUDE_AUDIO)
+#include <plat/audio.h>
+#include <linux/i2c.h>
+#include <plat/i2s-orion.h>
+#endif
+
 #include "ctrlEnv/mvCtrlEnvLib.h"
 #include "ctrlEnv/sys/mvCpuIf.h"
 #include "ctrlEnv/mvUnitMap.h"
@@ -533,6 +538,67 @@ static void __init alp_init_serial(int port)
 }
 
 /*******************************************************************************
+ * I2S/SPDIF
+ */
+#ifdef CONFIG_MV_INCLUDE_AUDIO
+static struct resource alp_i2s_resources[] = {
+	[0] = {
+		.start	= INTER_REGS_PHYS_BASE + MV_AUDIO_REGS_OFFSET(0),
+		.end	= INTER_REGS_PHYS_BASE + MV_AUDIO_REGS_OFFSET(0) + SZ_16K - 1,
+		.flags	= IORESOURCE_MEM,
+	},
+	[1] = {
+		.start	= IRQ_GLOBAL_AUDIO,
+		.end	= IRQ_GLOBAL_AUDIO,
+		.flags	= IORESOURCE_IRQ,
+	},
+};
+
+static struct kirkwood_asoc_platform_data alp_i2s_data = {
+	.burst       = 128,
+};
+
+static struct platform_device alp_i2s_device = {
+	.name		= "kirkwood-i2s",
+	.id		= -1,
+	.num_resources	= ARRAY_SIZE(alp_i2s_resources),
+	.resource	= alp_i2s_resources,
+	.dev		= {
+		.platform_data	= &alp_i2s_data,
+	},
+};
+
+static struct platform_device alp_pcm_device = {
+	.name		= "kirkwood-pcm-audio",
+	.id		= -1,
+};
+
+static struct i2c_board_info __initdata alp_i2c_board_info = {
+	I2C_BOARD_INFO("cs42l51", 0x4a),
+};
+
+static struct platform_device alp_client_audio_device = {
+	.name		= "mvebu-client-audio",
+	.id		= -1,
+};
+#endif /* CONFIG_MV_INCLUDE_AUDIO */
+
+static void __init alp_audio_init(void)
+{
+#ifdef CONFIG_MV_INCLUDE_AUDIO
+	if (mvCtrlPwrClckGet(AUDIO_UNIT_ID, 0) == MV_FALSE) {
+		pr_warn("Audio clock is turned off.\n");
+		return;
+	}
+
+	platform_device_register(&alp_client_audio_device);
+	i2c_register_board_info(0, &alp_i2c_board_info, 1);
+	platform_device_register(&alp_i2s_device);
+	platform_device_register(&alp_pcm_device);
+#endif
+}
+
+/*******************************************************************************
  * SDIO
  */
 #if defined(CONFIG_MV_INCLUDE_SDIO)
@@ -1671,6 +1737,8 @@ static void __init alp_board_init(void)
 	alp_rtc_init();
 	alp_sdio_init();
 	alp_i2c_init();
+	alp_audio_init();
+
 #if 0
 	alp_gpio_init();
 	alp_hwmon_init();
diff --git a/arch/arm/mach-avantalp/export.c b/arch/arm/mach-avantalp/export.c
index 0f7fce8..dea6ed6 100644
--- a/arch/arm/mach-avantalp/export.c
+++ b/arch/arm/mach-avantalp/export.c
@@ -77,24 +77,6 @@ EXPORT_SYMBOL(mvCtrlTdmUnitTypeGet);
 #endif
 
 /*************************************************************************************************************
- * Audio
- *************************************************************************************************************/
-#ifdef CONFIG_MV_INCLUDE_AUDIO
-#include "audio/mvAudio.h"
-#include "mvSysAudioApi.h"
-EXPORT_SYMBOL(mvSPDIFRecordTclockSet);
-EXPORT_SYMBOL(mvSPDIFPlaybackCtrlSet);
-EXPORT_SYMBOL(mvI2SPlaybackCtrlSet);
-EXPORT_SYMBOL(mvAudioPlaybackControlSet);
-EXPORT_SYMBOL(mvAudioDCOCtrlSet);
-EXPORT_SYMBOL(mvI2SRecordCntrlSet);
-EXPORT_SYMBOL(mvAudioRecordControlSet);
-EXPORT_SYMBOL(mvSysAudioInit);
-EXPORT_SYMBOL(mvBoardA2DTwsiAddrGet);
-EXPORT_SYMBOL(mvBoardA2DTwsiAddrTypeGet);
-#endif
-
-/*************************************************************************************************************
  * USB
  *************************************************************************************************************/
 #ifdef CONFIG_MV_INCLUDE_USB
diff --git a/arch/arm/plat-armada/Kconfig b/arch/arm/plat-armada/Kconfig
index b79a7fb..64ae3c9 100644
--- a/arch/arm/plat-armada/Kconfig
+++ b/arch/arm/plat-armada/Kconfig
@@ -156,6 +156,13 @@ config MV_INCLUDE_SDIO
         help
         Please don't change this configs unless you know what you are doing.
 
+config MV_INCLUDE_AUDIO
+	bool "Audio Support"
+	depends on MV88F6183 || MV88F6281 || ARMADA_370 || AVANTA_LP
+	default y
+        ---help---
+        Please don't change this configs unless you know what you are doing.
+
 config MV_INCLUDE_TS
 	bool "TSU Support"
 	depends on MV88F6500 || MV88F6281
diff --git a/arch/arm/plat-armada/include/plat/i2s-orion.h b/arch/arm/plat-armada/include/plat/i2s-orion.h
index 4ae4edf..283bc7b 100644
--- a/arch/arm/plat-armada/include/plat/i2s-orion.h
+++ b/arch/arm/plat-armada/include/plat/i2s-orion.h
@@ -19,5 +19,4 @@ struct orion_i2s_platform_data {
 	int	i2s_play;
 };
 
-
 #endif
diff --git a/sound/soc/kirkwood/Kconfig b/sound/soc/kirkwood/Kconfig
index 6541d80..2566dcf 100644
--- a/sound/soc/kirkwood/Kconfig
+++ b/sound/soc/kirkwood/Kconfig
@@ -1,6 +1,6 @@
 config SND_KIRKWOOD_SOC
 	tristate "SoC Audio for the Marvell Kirkwood chip"
-	depends on ARCH_KIRKWOOD || ARCH_ARMADA370
+	depends on ARCH_KIRKWOOD || ARCH_ARMADA370 || ARCH_AVANTA_LP
 	help
 	  Say Y or M if you want to add support for codecs attached to
 	  the Kirkwood I2S interface. You will also need to select the
@@ -38,11 +38,11 @@ config SND_KIRKWOOD_SOC_T5325
 	  Say Y if you want to add support for SoC audio on
 	  the HP t5325 thin client.
 
-config SND_ARMADA370_SOC
-        tristate "SoC Audio support for Armada-370 boards"
-        depends on SND_KIRKWOOD_SOC && ARCH_ARMADA370
-        select SND_KIRKWOOD_SOC_I2S
-        select SND_SOC_CS42L51
-        help
-          Say Y if you want to add support for SoC audio on
-          Armada370 DB.
+config SND_MVEBU_SOC
+	tristate "SoC Audio support for mvebu boards"
+	depends on SND_KIRKWOOD_SOC && ARCH_AVANTA_LP
+	select SND_KIRKWOOD_SOC_I2S
+	select SND_SOC_CS42L51
+	help
+	  Say Y if you want to add support for SoC audio on
+	  Marvell MVEBU boards.
diff --git a/sound/soc/kirkwood/Makefile b/sound/soc/kirkwood/Makefile
index 527fb3a..87c5eee 100644
--- a/sound/soc/kirkwood/Makefile
+++ b/sound/soc/kirkwood/Makefile
@@ -1,6 +1,6 @@
 snd-soc-kirkwood-objs := kirkwood-dma.o
 snd-soc-kirkwood-i2s-objs := kirkwood-i2s.o
-snd-soc-a370-objs := armada370.o
+snd-soc-mvebu-objs := mvebu.o
 
 obj-$(CONFIG_SND_KIRKWOOD_SOC) += snd-soc-kirkwood.o
 obj-$(CONFIG_SND_KIRKWOOD_SOC_I2S) += snd-soc-kirkwood-i2s.o
@@ -12,4 +12,4 @@ snd-soc-t5325-objs := kirkwood-t5325.o
 obj-$(CONFIG_SND_KIRKWOOD_SOC_OPENRD) += snd-soc-openrd.o
 obj-$(CONFIG_SND_KIRKWOOD_SOC_DB88F6281_BP) += snd-soc-db88f6281-bp.o
 obj-$(CONFIG_SND_KIRKWOOD_SOC_T5325) += snd-soc-t5325.o
-obj-$(CONFIG_SND_ARMADA370_SOC) += snd-soc-a370.o
+obj-$(CONFIG_SND_MVEBU_SOC) += snd-soc-mvebu.o
diff --git a/sound/soc/kirkwood/armada370.c b/sound/soc/kirkwood/armada370.c
deleted file mode 100644
index 1346bd9..0000000
--- a/sound/soc/kirkwood/armada370.c
+++ /dev/null
@@ -1,119 +0,0 @@
-/*
- * armada370-db.c
- *
- * (c) 2010 Arnaud Patard <apatard@mandriva.com>
- * (c) 2010 Arnaud Patard <arnaud.patard@rtp-net.org>
- *
- *  This program is free software; you can redistribute  it and/or modify it
- *  under  the terms of  the GNU General  Public License as published by the
- *  Free Software Foundation;  either version 2 of the  License, or (at your
- *  option) any later version.
- */
-
-#include <linux/module.h>
-#include <linux/moduleparam.h>
-#include <linux/interrupt.h>
-#include <linux/platform_device.h>
-#include <linux/slab.h>
-#include <sound/soc.h>
-#include <plat/audio.h>
-#include <asm/mach-types.h>
-#include "../codecs/cs42l51.h"
-
-static int a370_client_hw_params(struct snd_pcm_substream *substream,
-		struct snd_pcm_hw_params *params)
-{
-	struct snd_soc_pcm_runtime *rtd = substream->private_data;
-	struct snd_soc_dai *codec_dai = rtd->codec_dai;
-	struct snd_soc_dai *cpu_dai = rtd->cpu_dai;
-	int ret;
-	unsigned int freq, fmt;
-
-	fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_CBS_CFS;
-	ret = snd_soc_dai_set_fmt(cpu_dai, fmt);
-	if (ret < 0)
-		return ret;
-
-	ret = snd_soc_dai_set_fmt(codec_dai, fmt);
-	if (ret < 0)
-		return ret;
-
-	switch (params_rate(params)) {
-	default:
-	case 44100:
-		freq = 11289600;
-		break;
-	case 48000:
-		freq = 12288000;
-		break;
-	case 96000:
-		freq = 24576000;
-		break;
-	}
-
-	return snd_soc_dai_set_sysclk(codec_dai, 0, freq, SND_SOC_CLOCK_IN);
-
-}
-
-static struct snd_soc_ops a370_client_ops = {
-	.hw_params = a370_client_hw_params,
-};
-
-
-static struct snd_soc_dai_link a370_client_dai[] = {
-{
-	.name = "CS42L51",
-	.stream_name = "CS42L51 HiFi",
-	.cpu_dai_name = "kirkwood-i2s",
-	.platform_name = "kirkwood-pcm-audio",
-	.codec_dai_name = "cs42l51-hifi",
-	.codec_name = "cs42l51-codec.0-004a",
-	.ops = &a370_client_ops,
-},
-};
-
-
-static struct snd_soc_card a370_client = {
-	.name = "Armada-370",
-	.dai_link = a370_client_dai,
-	.num_links = ARRAY_SIZE(a370_client_dai),
-};
-
-static struct platform_device *a370_client_snd_device;
-
-static int __init a370_client_init(void)
-{
-	int ret;
-
-	if (!machine_is_armada_370())
-		return 0;
-
-	a370_client_snd_device = platform_device_alloc("soc-audio", -1);
-	if (!a370_client_snd_device)
-		return -ENOMEM;
-
-	platform_set_drvdata(a370_client_snd_device,
-			&a370_client);
-
-	ret = platform_device_add(a370_client_snd_device);
-	if (ret) {
-		printk(KERN_ERR "%s: platform_device_add failed\n", __func__);
-		platform_device_put(a370_client_snd_device);
-	}
-
-	return ret;
-}
-
-static void __exit a370_client_exit(void)
-{
-	platform_device_unregister(a370_client_snd_device);
-}
-
-module_init(a370_client_init);
-module_exit(a370_client_exit);
-
-/* Module information */
-MODULE_AUTHOR("Eran Ben-Avi <benavi@marvell.com>");
-MODULE_DESCRIPTION("ALSA SoC for Armada-370");
-MODULE_LICENSE("GPL");
-MODULE_ALIAS("platform:soc-audio");
diff --git a/sound/soc/kirkwood/mvebu.c b/sound/soc/kirkwood/mvebu.c
new file mode 100644
index 0000000..9918e32
--- /dev/null
+++ b/sound/soc/kirkwood/mvebu.c
@@ -0,0 +1,131 @@
+/*
+ * (c) 2010 Arnaud Patard <apatard@mandriva.com>
+ * (c) 2010 Arnaud Patard <arnaud.patard@rtp-net.org>
+ *
+ *  This program is free software; you can redistribute  it and/or modify it
+ *  under  the terms of  the GNU General  Public License as published by the
+ *  Free Software Foundation;  either version 2 of the  License, or (at your
+ *  option) any later version.
+ */
+
+#include <linux/io.h>
+#include <linux/module.h>
+#include <linux/moduleparam.h>
+#include <linux/interrupt.h>
+#include <linux/platform_device.h>
+#include <linux/slab.h>
+#include <sound/soc.h>
+#include <plat/audio.h>
+#include <asm/mach-types.h>
+#include "../codecs/cs42l51.h"
+
+static int mvebu_client_hw_params(struct snd_pcm_substream *substream,
+		struct snd_pcm_hw_params *params)
+{
+	struct snd_soc_pcm_runtime *rtd = substream->private_data;
+	struct snd_soc_dai *codec_dai = rtd->codec_dai;
+	struct snd_soc_dai *cpu_dai = rtd->cpu_dai;
+	int ret;
+	unsigned int freq, fmt;
+
+	fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_CBS_CFS;
+	ret = snd_soc_dai_set_fmt(cpu_dai, fmt);
+	if (ret < 0) {
+		pr_err("%s: snd_soc_dai_set_fmt(cpu_dai) failed\n", __func__);
+		return ret;
+	}
+
+	ret = snd_soc_dai_set_fmt(codec_dai, fmt);
+	if (ret < 0) {
+		pr_err("%s: snd_soc_dai_set_fmt(codec_dai) failed\n", __func__);
+		return ret;
+	}
+
+	switch (params_rate(params)) {
+	default:
+	case 44100:
+		freq = 11289600;
+		break;
+	case 48000:
+		freq = 12288000;
+		break;
+	case 96000:
+		freq = 24576000;
+		break;
+	}
+
+	return snd_soc_dai_set_sysclk(codec_dai, 0, freq, SND_SOC_CLOCK_IN);
+}
+
+static struct snd_soc_ops mvebu_client_ops = {
+	.hw_params = mvebu_client_hw_params,
+};
+
+static struct snd_soc_dai_link mvebu_client_dai[] = {
+{
+	.name = "CS42L51",
+	.stream_name = "CS42L51 HiFi",
+	.cpu_dai_name = "kirkwood-i2s",
+	.platform_name = "kirkwood-pcm-audio",
+	.codec_dai_name = "cs42l51-hifi",
+	.codec_name = "cs42l51-codec.0-004a",
+	.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_CBS_CFS,
+	.ops = &mvebu_client_ops,
+},
+};
+
+static struct snd_soc_card mvebu_client = {
+	.name = "Avanta-LP",
+	.owner = THIS_MODULE,
+	.dai_link = mvebu_client_dai,
+	.num_links = ARRAY_SIZE(mvebu_client_dai),
+};
+
+static struct platform_device *mvebu_client_snd_dev;
+
+static int __init mvebu_client_init(struct platform_device *pdev)
+{
+	struct snd_soc_card *card = &mvebu_client;
+	int ret;
+	void __iomem *soc_ctrl_base;
+	u32 soc_ctrl;
+
+	/*
+	 * Configure Audio MUX in SoC Control Register.
+	 * Note: beware of jumper settings on the specific board.
+	 */
+	soc_ctrl_base = ioremap(0xf1018204, 4);
+	soc_ctrl = readl(soc_ctrl_base);
+	soc_ctrl &= ~(1 << 20);
+	writel(soc_ctrl, soc_ctrl_base);
+
+	card->dev = &pdev->dev;
+	ret = snd_soc_register_card(card);
+	if (ret)
+		dev_err(&pdev->dev, "snd_soc_register_card() failed: %d\n", ret);
+
+	return ret;
+}
+
+static int __devexit mvebu_client_exit(struct platform_device *pdev)
+{
+	platform_device_unregister(mvebu_client_snd_dev);
+	return 0;
+}
+
+static struct platform_driver mvebu_audio_driver = {
+	.driver		= {
+		.name	= "mvebu-client-audio",
+		.owner	= THIS_MODULE,
+	},
+	.probe		= mvebu_client_init,
+	.remove		= __devexit_p(mvebu_client_exit),
+};
+
+module_platform_driver(mvebu_audio_driver);
+
+/* Module information */
+MODULE_AUTHOR("Eran Ben-Avi <benavi@marvell.com>");
+MODULE_DESCRIPTION("ALSA SoC for MVEBU");
+MODULE_LICENSE("GPL");
+MODULE_ALIAS("platform:soc-audio");
-- 
1.7.5.4

