From daf7c0e06d7361552fe7a69ea9283cd7159c18da Mon Sep 17 00:00:00 2001
From: Yoni Farhadian <yonif@marvell.com>
Date: Wed, 21 Aug 2013 11:14:22 +0300
Subject: [PATCH 0959/1825] fix: pp2: sync port's MTU with classifier

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 685b5e11614d30d1a78f950f6081c88ebf31663c

	- When changing MTU, update classifier as well
	- Fix packet size of classifier MTU

Change-Id: If33fe471c8e1d4e4b9d17102975edae18159e395
Signed-off-by: Yoni Farhadian <yonif@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3060
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index 9fe10f1..90df3dd 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -3112,7 +3112,7 @@ static int mv_eth_load_network_interfaces(struct platform_device *pdev)
 	if (mv_eth_pnc_ctrl_en) {
 		/* Init classifer MTU */
 		for (txp = 0; txp < pp->txp_num; txp++)
-			mvPp2ClsHwMtuSet(MV_PPV2_PORT_PHYS(pp->port), txp, mtu/*TODO fix size*/);
+			mvPp2ClsHwMtuSet(MV_PPV2_PORT_PHYS(pp->port), txp, RX_PKT_SIZE(mtu));
 
 		mvPp2ClsHwOversizeRxqSet(MV_PPV2_PORT_PHYS(pp->port), pp->first_rxq);
 
@@ -4111,7 +4111,7 @@ int mv_eth_change_mtu_internals(struct net_device *dev, int mtu)
 {
 	struct bm_pool *port_pool;
 	struct eth_port *pp = MV_ETH_PRIV(dev);
-	int pkt_size = RX_PKT_SIZE(mtu), pkts_num;
+	int txp, pkt_size = RX_PKT_SIZE(mtu), pkts_num;
 	unsigned long flags = 0;
 
 	if (test_bit(MV_ETH_F_STARTED_BIT, &(pp->flags))) {
@@ -4174,6 +4174,8 @@ int mv_eth_change_mtu_internals(struct net_device *dev, int mtu)
 	else
 		mv_pon_mtu_config(pkt_size);
 #endif
+	for (txp = 0; txp < pp->txp_num; txp++)
+		mvPp2ClsHwMtuSet(MV_PPV2_PORT_PHYS(pp->port), txp, pkt_size);
 
 mtu_out:
 	dev->mtu = mtu;
-- 
1.7.5.4

