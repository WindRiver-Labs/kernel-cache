From 6446439138066b64e8cd4cc70c6ee74885d84dc9 Mon Sep 17 00:00:00 2001
From: Victor Gu <xigu@marvell.com>
Date: Mon, 7 Jul 2014 22:29:47 +0800
Subject: [PATCH 1768/1825] fix: alp: communit: add TX Fsync bit counter

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 2d6f8af4e44160dfa1ed70759c1e609cc38d3287

    set reserved bit in FS counter registers for TX interrupt.
Signed-off-by: Victor Gu <xigu@marvell.com>

Change-Id: Ie9b7266286fba1b62b7018e4af7bf02aa6d33e92
Reviewed-on: http://vgitil04.il.marvell.com:8080/9026
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/mv_hal_if/mvSysTdm.c        |    7 ++++---
 .../mv_hal/voiceband/commUnit/mvCommUnit.c         |   18 ++++++++++++------
 .../mv_hal/voiceband/commUnit/mvCommUnit.h         |    1 -
 .../mv_hal/voiceband/commUnit/mvCommUnitRegs.h     |    6 ++++--
 4 files changed, 20 insertions(+), 12 deletions(-)

diff --git a/arch/arm/mach-avantalp/mv_hal_if/mvSysTdm.c b/arch/arm/mach-avantalp/mv_hal_if/mvSysTdm.c
index 2015606..13e31e2 100644
--- a/arch/arm/mach-avantalp/mv_hal_if/mvSysTdm.c
+++ b/arch/arm/mach-avantalp/mv_hal_if/mvSysTdm.c
@@ -133,9 +133,6 @@ MV_STATUS mvSysTdmInit(MV_TDM_PARAMS* tdmParams)
 
 		/* Issue SLIC reset */
 		status = mvCommUnitResetSlic();
-
-		/* Set FS, will be 8M/8K = 1024 */
-		status = mvCommUnitSyncBitCountSet(1024);
 #endif
 	}
 
@@ -171,6 +168,10 @@ MV_VOID mvSysTdmSpiRead(MV_U16 lineId, MV_U8* cmdBuff, MV_U8 cmdSize, MV_U8* dat
 	spiType = SPI_TYPE_SLIC_ISI;
 #endif
 
+#ifdef MV_TDM_DEBUG
+	mvOsPrintf(KERN_ERR "%s():line(%d) SpiId=%d lineId=%d SpiCs=%d spiType=%d\n",
+		   __func__, __LINE__, mvBoardTdmSpiIdGet(), lineId, mvBoardTdmSpiCsGet(lineId), spiType);
+#endif
 	/* Set SPI parameters(lineId = devId) */
 	mvSpiParamsSet(mvBoardTdmSpiIdGet(), mvBoardTdmSpiCsGet(lineId), spiType);
 	if (MV_BOARD_SLIC_ZSI_ID == mvBoardSlicUnitTypeGet()) {
diff --git a/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnit.c b/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnit.c
index 3c8c758..db8ddc8 100644
--- a/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnit.c
+++ b/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnit.c
@@ -108,6 +108,7 @@ MV_STATUS mvCommUnitHalInit(MV_TDM_PARAMS *tdmParams, MV_TDM_HAL_DATA *halData)
 	MV_U32 totalRxDescSize, totalTxDescSize;
 	MV_U32 maxPoll, clkSyncCtrlReg;
 	MV_U32 chMask;
+	MV_U32 count;
 	MV_TDM_DPRAM_ENTRY actDpramEntry, *pActDpramEntry;
 
 	MV_TRC_REC("->%s\n", __func__);
@@ -396,6 +397,17 @@ MV_STATUS mvCommUnitHalInit(MV_TDM_PARAMS *tdmParams, MV_TDM_HAL_DATA *halData)
 	MV_REG_WRITE(MCSC_GLOBAL_INT_CAUSE_REG, MCSC_GLOBAL_INT_CAUSE_INIT_DONE_MASK);
 	MV_REG_WRITE(MCSC_EXTENDED_INT_CAUSE_REG, 0);
 
+	/* Set output sync counter bits for FS */
+#if defined(MV_TDM_PCM_CLK_8MHZ)
+	count = MV_FRAME_128TS * 8;
+#elif defined(MV_TDM_PCM_CLK_4MHZ)
+	count = MV_FRAME_64TS * 8;
+#else /* MV_TDM_PCM_CLK_2MHZ */
+	count = MV_FRAME_32TS * 8;
+#endif
+	MV_REG_WRITE(TDM_OUTPUT_SYNC_BIT_COUNT_REG,
+		((count << TDM_SYNC_BIT_RX_OFFS) & TDM_SYNC_BIT_RX_MASK) | (count & TDM_SYNC_BIT_TX_MASK));
+
 #ifdef MV_COMM_UNIT_DEBUG
 	mvCommUnitShow();
 #endif
@@ -1017,12 +1029,6 @@ MV_VOID mvCommUnitShow(MV_VOID)
 	}
 }
 
-MV_STATUS mvCommUnitSyncBitCountSet(MV_32 count)
-{
-	MV_REG_WRITE(TDM_OUTPUT_SYNC_BIT_COUNT_REG, (count << TDM_SYNC_BIT_OFFS) & TDM_SYNC_BIT_MASK);
-	return MV_OK;
-}
-
 MV_STATUS mvCommUnitResetSlic(MV_VOID)
 {
 	/* Enable SLIC reset */
diff --git a/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnit.h b/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnit.h
index 68bfaa7..0e96c78 100644
--- a/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnit.h
+++ b/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnit.h
@@ -197,7 +197,6 @@ extern "C" {
 	MV_VOID mvCommUnitRelease(MV_VOID);
 	MV_VOID mvCommUnitIntEnable(MV_U8 deviceId);
 	MV_VOID mvCommUnitIntDisable(MV_U8 deviceId);
-	MV_STATUS mvCommUnitSyncBitCountSet(MV_32 count);
 	MV_STATUS mvCommUnitResetSlic(MV_VOID);
 
 #ifdef __cplusplus
diff --git a/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnitRegs.h b/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnitRegs.h
index dfe6c2d..d1ea576 100644
--- a/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnitRegs.h
+++ b/arch/arm/plat-armada/mv_hal/voiceband/commUnit/mvCommUnitRegs.h
@@ -350,8 +350,10 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define TDM_TEN_MASK				(1 << TDM_TEN_OFFS)
 
 /* TDM_OUTPUT_SYNC_BIT_COUNT_REG bits */
-#define TDM_SYNC_BIT_OFFS			16
-#define TDM_SYNC_BIT_MASK			(0xffff << TDM_SYNC_BIT_OFFS)
+#define TDM_SYNC_BIT_TX_OFFS			0
+#define TDM_SYNC_BIT_TX_MASK			(0xffff << TDM_SYNC_BIT_TX_OFFS)
+#define TDM_SYNC_BIT_RX_OFFS			16
+#define TDM_SYNC_BIT_RX_MASK			(0xffff << TDM_SYNC_BIT_RX_OFFS)
 
 /* TDM_DATA_DELAY_AND_CLK_CTRL_REG bits */
 #define TX_CLK_OUT_ENABLE_OFFS			0
-- 
1.7.5.4

