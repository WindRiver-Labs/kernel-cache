From af09815991d400681eec877fb194f4c83f1cc36f Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Thu, 6 Feb 2014 10:02:16 +0200
Subject: [PATCH 1336/1825] fix: sata: a38x: enabling regret option to avoid
 deadlock

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 0c8b830a4fe5cfdae0cd58b7b16e0bbc7afcb4b3

	Deadlock obsorved when xbar and SATA unit open transaction request
	together. Setting the regret option enables the SATA unit to regret
	a request that didn't receive an acknowlegde and avoid a deadlock.

Change-Id: I68ecb94e99f5551ee15e39437b36f8851616bfce
Signed-off-by: Lior Amsalem <alior@marvell.com>
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5472
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/ata/ahci_mv.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/drivers/ata/ahci_mv.c b/drivers/ata/ahci_mv.c
index 97fefa0..5407ce1 100644
--- a/drivers/ata/ahci_mv.c
+++ b/drivers/ata/ahci_mv.c
@@ -38,6 +38,9 @@
 #define AHCI_WINDOW_BASE(win)	(0x64 + ((win)<<4))
 #define AHCI_WINDOW_SIZE(win)	(0x68 + ((win)<<4))
 
+#define VENDOR_SPECIFIC_0_ADDR  0xa0
+#define VENDOR_SPECIFIC_0_DATA  0xa4
+
 static void ahci_mv_windows_config(struct ahci_host_priv *hpriv,
 				 struct mbus_dram_target_info *dram)
 {
@@ -173,6 +176,12 @@ static int ahci_mv_probe(struct platform_device *pdev)
 			ap->ops = &ata_dummy_port_ops;
 	}
 
+	/* Enabling regret bit to enables the SATA unit to regret
+	a request that didn't receive an acknowlegde and avoid a deadlock */
+
+	writel(0x4, hpriv->mmio + VENDOR_SPECIFIC_0_ADDR);
+	writel(0x80, hpriv->mmio + VENDOR_SPECIFIC_0_DATA);
+
 	rc = ahci_reset_controller(host);
 	if (rc)
 		goto err0;
-- 
1.7.5.4

