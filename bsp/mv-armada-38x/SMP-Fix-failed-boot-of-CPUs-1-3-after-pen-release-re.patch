From c78a18a17d8502129fd0f37fa4a40722bcf80489 Mon Sep 17 00:00:00 2001
From: Nadav Haklai <nadavh@marvell.com>
Date: Thu, 13 Dec 2012 18:28:30 +0200
Subject: [PATCH 0380/1825] SMP: Fix failed boot of CPUs 1-3 after pen release
 removal

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 99e10257dfb4f95326e27eb20a5bfc267c9b7ce7

Change-Id: I0b623e0a0e2f6f5f70765bf6b6f06fd2dc047613

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-armadaxp/headsmp.S |    5 +++--
 arch/arm/mach-armadaxp/platsmp.c |    3 +++
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-armadaxp/headsmp.S b/arch/arm/mach-armadaxp/headsmp.S
index fc65e70..36d4576 100644
--- a/arch/arm/mach-armadaxp/headsmp.S
+++ b/arch/arm/mach-armadaxp/headsmp.S
@@ -8,10 +8,11 @@
 #include <linux/linkage.h>
 #include <linux/init.h>
 #include <asm/memory.h>
+#include <mach/hardware.h>
 
 
-#define AXP_COHERENCY_FABRIC_CTL_REG 0xD0020200
-#define AXP_COHERENCY_FABRIC_CFG_REG 0xD0020204
+#define AXP_COHERENCY_FABRIC_CTL_REG (INTER_REGS_PHYS_BASE + 0x20200)
+#define AXP_COHERENCY_FABRIC_CFG_REG (INTER_REGS_PHYS_BASE + 0x20204)
 
 /*
  * specific entry point for secondary CPUs.  This provides
diff --git a/arch/arm/mach-armadaxp/platsmp.c b/arch/arm/mach-armadaxp/platsmp.c
index 2a8926d..41a40a4 100644
--- a/arch/arm/mach-armadaxp/platsmp.c
+++ b/arch/arm/mach-armadaxp/platsmp.c
@@ -112,6 +112,9 @@ int  boot_secondary(unsigned int cpu, struct task_struct *idle)
 
 	printk("SMP: CPU %d Waking up CPU %d\n", master_cpu_id, cpu);
 
+	/* send ipi to wake cpu in case it is in offline state */
+	axp_smp_cross_call(cpumask_of(cpu), 0);
+
 	/* Set resume control and address */
 	MV_REG_WRITE(AXP_CPU_RESUME_CTRL_REG, 0x0);
 	MV_REG_WRITE(AXP_CPU_RESUME_ADDR_REG(cpu),
-- 
1.7.5.4

