From 10fe6c6fabebaf99468a4fee91340b9ccb605f5a Mon Sep 17 00:00:00 2001
From: kostap <kostap@marvell.com>
Date: Mon, 24 Mar 2014 11:46:30 +0200
Subject: [PATCH 1523/1825] fix: sample at reset: a38x: Convert DDR settings
 from DIP switch to SW defined

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 2cec51775b61598eb4948c4ac7f64597be629be1

	Disable HW-configurable DDR bus width and DDR ECC settings
	Add SW-configurable DDR bus width, ECC en/dis and DDR ECC PUP selection
	Byte 0 of device address 50 on i2c bus:
	bit[2:0] - Board ID
	bit[3] - DDR width (0 - 16bit, 1 - 32bit)
	bit[4] - DDR ECC (0 - disabled, 1- enabled)
	bit[5] - 16bit ECC PUP selection (0 - PUP 3, 1 - PUP 4)
	Added ECC mode (DDR 32bit) and PUP selection (DDR 16bit) to boot-up screen
	Added definition of DRAM pin multiplexing register 0x19D4.
	The bit[8] of register 0x19D4 is set when PUP3 is used and reset otherwise.

Change-Id: Idff118a962413cd356bf0982f689736c48a78da4
Signed-off-by: kostap <kostap@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/6629
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/6695
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/boardEnv/mvBoardEnvLib.h     |    6 ++++--
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.c       |    8 ++++++++
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.h       |    1 +
 arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIfRegs.h  |    4 ++++
 4 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
index b7b2be0..0b215ec 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
@@ -165,6 +165,7 @@ typedef enum _mvSatRTypeID {
 	MV_SATR_DDR4_SELECT,
 	MV_SATR_DDR_BUS_WIDTH,
 	MV_SATR_DDR_ECC_ENABLE,
+	MV_SATR_DDR_ECC_PUP_SEL,
 	MV_SATR_BOOT_DEVICE,
 	MV_SATR_BOOT2_DEVICE,
 	MV_SATR_BOARD_ID,
@@ -549,8 +550,9 @@ int mvBoardNorFlashConnect(void);
 { "cpusnum",	MV_SATR_CPU1_ENABLE,		0x01,	0,	2,	0,	{0, 1, 1, 0}, 0},\
 { "sscg",	MV_SATR_SSCG_DISABLE,		0x08,	3,	3,	0,	{0, 1, 0, 0}, 0},\
 { "ddr4select",	MV_SATR_DDR4_SELECT,		0x20,	5,	4,	1,	{0, 1, 0, 0}, BOARD_SATR_READ_ONLY},\
-{ "ddrbuswidth",  MV_SATR_DDR_BUS_WIDTH,	0x02,	1,	4,	0,	{0, 1, 0, 0}, BOARD_SATR_READ_ONLY},\
-{ "ddreccenable", MV_SATR_DDR_ECC_ENABLE,	0x04,	2,	4,	0,	{0, 1, 0, 0}, BOARD_SATR_READ_ONLY},\
+{ "ddrbuswidth",     MV_SATR_DDR_BUS_WIDTH,	0x08,	3,	0,	0,	{0, 1, 0, 0}, 0},\
+{ "ddreccenable",    MV_SATR_DDR_ECC_ENABLE,	0x10,	4,	0,	0,	{0, 1, 0, 0}, 0},\
+{ "ddreccpupselect", MV_SATR_DDR_ECC_PUP_SEL,	0x20,	5,	0,	0,	{0, 1, 0, 0}, 0},\
 { "bootsrc",	MV_SATR_BOOT_DEVICE,		0x3,	0,	3,	0,	{0, 1, 0, 0}, BOARD_SATR_SWAP_BIT},\
 { "boarsrc2",	MV_SATR_BOOT2_DEVICE,		0x1E,	1,	2,	0,	{0, 1, 0, 0}, BOARD_SATR_SWAP_BIT},\
 { "boardid",	MV_SATR_BOARD_ID,		0x7,	0,	0,	0,	{1, 1, 1, 0}, 0},\
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
index 41f5a2c..fdb1b51 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
@@ -1656,6 +1656,14 @@ MV_BOOL mvCtrlDDRECC(MV_VOID)
 	return (reg & (0x1 << REG_SDRAM_CONFIG_ECC_OFFS)) ? MV_TRUE : MV_FALSE;
 }
 
+MV_BOOL mvCtrlDDRECCPUP3(MV_VOID)
+{
+	MV_U32 reg;
+
+	reg = MV_REG_READ(REG_DRAM_PIN_MUXING_ADDR);
+
+	return (reg & DRAM_PIN_MUXING_PUP3_EN) ? MV_TRUE : MV_FALSE;
+}
 
 /*******************************************************************************
 * mvCtrlGetJuncTemp
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
index c385e59..9d36abe 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
@@ -255,5 +255,6 @@ MV_BOOL mvCtrlIsDLBEnabled(MV_VOID);
 MV_U32 mvCtrlDDRBudWidth(MV_VOID);
 MV_BOOL mvCtrlDDRThruXbar(MV_VOID);
 MV_BOOL mvCtrlDDRECC(MV_VOID);
+MV_BOOL mvCtrlDDRECCPUP3(MV_VOID);
 
 #endif /* __INCmvCtrlEnvLibh */
diff --git a/arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIfRegs.h b/arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIfRegs.h
index 6ee003e..fee74c1 100644
--- a/arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIfRegs.h
+++ b/arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIfRegs.h
@@ -180,6 +180,10 @@ extern "C" {
 #define EvictBlockWinLow ( 0x1f << 10)
 #define EvictBlockWinLow_MASK ( 0x1F << 10)
 
+#define REG_DRAM_PIN_MUXING_ADDR				0x19D4
+#define DRAM_PIN_MUXING_PUP3_EN					(1 << 8)
+
+
 #ifdef __cplusplus
 }
 #endif /* __cplusplus */
-- 
1.7.5.4

