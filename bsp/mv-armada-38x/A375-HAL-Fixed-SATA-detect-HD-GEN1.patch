From 04ef51dbabd204bcc1b6f9c1dee18ddccb4618f2 Mon Sep 17 00:00:00 2001
From: Igor Patrik <igorp@marvell.com>
Date: Mon, 10 Jun 2013 10:24:56 +0200
Subject: [PATCH 0715/1825] A375: HAL: Fixed SATA detect HD GEN1

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 0caae907c5e574b6d6b50de15d41f5916d7c2c89

Change-Id: I4f0abc4ef4322935ae747c89e8821c8bdb18a8c2
Reviewed-on: http://vgitil04.il.marvell.com:8080/2198
Reviewed-by: Star_Automation <star@marvell.com>
Reviewed-by: Eli Nidam <elini@marvell.com>
Tested-by: Igor Patrik <igorp@marvell.com>
Reviewed-by: Igor Patrik <igorp@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../plat-armada/mv_hal/sata/CoreDriver/mvSata.c    |   26 ++++++++++++++++----
 .../plat-armada/mv_hal/sata/CoreDriver/mvSata.h    |    2 +
 2 files changed, 23 insertions(+), 5 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/sata/CoreDriver/mvSata.c b/arch/arm/plat-armada/mv_hal/sata/CoreDriver/mvSata.c
index ef63cb6..4ea7b49 100755
--- a/arch/arm/plat-armada/mv_hal/sata/CoreDriver/mvSata.c
+++ b/arch/arm/plat-armada/mv_hal/sata/CoreDriver/mvSata.c
@@ -2713,6 +2713,7 @@ static void _fixPhyParams(MV_SATA_ADAPTER *pAdapter, MV_U8 channelIndex)
 	if ((pAdapter->sataAdapterGeneration >= MV_SATA_GEN_II) &&
 	    (pAdapter->chipIs62X1Z0 == MV_FALSE) &&
 	    (pAdapter->chipIs66XXX0 == MV_FALSE) &&
+	    (pAdapter->chipIs672XX0 == MV_FALSE) &&
 	    (pAdapter->chipIs65XXZ0 == MV_FALSE)) {
 		MV_U32 phyMode2Offset = getEdmaRegOffset(channelIndex) + MV_SATA_II_PHY_MODE_2_REG_OFFSET;
 		if ((pAdapter->chipIs60X1B2 == MV_TRUE) || (pAdapter->chipIs60X1C0 == MV_TRUE)) {
@@ -2815,8 +2816,9 @@ static void _fixPhyParams(MV_SATA_ADAPTER *pAdapter, MV_U8 channelIndex)
 			 pAdapter->adapterId, channelIndex,
 			 MV_REG_READ_DWORD(pAdapter->adapterIoBaseAddress, phyMode2Offset));
 	}
-	if ((pAdapter->chipIs62X1Z0 == MV_TRUE) || (pAdapter->chipIs66XXX0 == MV_TRUE))  {
-
+	if ((pAdapter->chipIs62X1Z0 == MV_TRUE) ||
+		(pAdapter->chipIs66XXX0 == MV_TRUE) ||
+		(pAdapter->chipIs672XX0 == MV_TRUE)) {
 		regVal = MV_REG_READ_DWORD(pAdapter->adapterIoBaseAddress,
 					   getEdmaRegOffset(channelIndex) + MV_SATA_II_PHY_MODE_3_REG_OFFSET);
 
@@ -4479,6 +4481,7 @@ MV_BOOLEAN mvSataInitAdapter(MV_SATA_ADAPTER *pAdapter)
 	pAdapter->chipIs62X1Z0 = MV_FALSE;
 	pAdapter->chipIs65XXZ0 = MV_FALSE;
 	pAdapter->chipIs66XXX0 = MV_FALSE;
+	pAdapter->chipIs672XX0 = MV_FALSE;
 	pAdapter->numberOfChannels = MV_SATA_CHANNELS_NUM;
 	pAdapter->numberOfUnits = MV_SATA_UNITS_NUM;
 	pAdapter->portsPerUnit = MV_SATA_PORT_PER_UNIT;
@@ -4796,6 +4799,16 @@ MV_BOOLEAN mvSataInitAdapter(MV_SATA_ADAPTER *pAdapter)
 		pAdapter->mainCauseOffset = 0x20020;
 		pAdapter->chipIs66XXX0 = MV_TRUE;
 		break;
+	case MV_SATA_DEVICE_ID_6720:
+		pAdapter->numberOfChannels = 2;
+		pAdapter->numberOfUnits = 1;
+		pAdapter->portsPerUnit = 2;
+		pAdapter->sataAdapterGeneration = MV_SATA_GEN_IIE;
+		pAdapter->hostInterface = MV_HOST_IF_INTEGRATED;
+		pAdapter->mainMaskOffset = 0x20024;
+		pAdapter->mainCauseOffset = 0x20020;
+		pAdapter->chipIs672XX0 = MV_TRUE;
+		break;
 
 	default:
 		mvLogMsg(MV_CORE_DRIVER_LOG_ID, MV_DEBUG_ERROR, " %d : Bad device ID"
@@ -5270,9 +5283,11 @@ MV_BOOLEAN mvSataIsStorageDeviceConnected(MV_SATA_ADAPTER *pAdapter, MV_U8 chann
 			break;
 		}
 	case MV_PHY_DET_STATE_DEVICE_AND_PHY_COM:
-	if (pAdapter->chipIs66XXX0 == MV_TRUE) { /*for Avanta LP 6660 check HD type GEN1 or GEN2*/
-		det = (MV_REG_READ_DWORD(pAdapter->adapterIoBaseAddress, SStatusOffset) & 0xf0)>>4;
-		if ((det == 1) && (pAdapter->sataAdapterGeneration >= MV_SATA_GEN_II)) {
+		if ((pAdapter->chipIs66XXX0 == MV_TRUE) ||
+			(pAdapter->chipIs672XX0 == MV_TRUE)) {
+			/* for Avanta LP 6660 check HD GEN1 or GEN2 */
+			det = (MV_REG_READ_DWORD(pAdapter->adapterIoBaseAddress, SStatusOffset) & 0xf0)>>4;
+			if ((det == 1) && (pAdapter->sataAdapterGeneration >= MV_SATA_GEN_II)) {
 				/* HD deteced to GEN1 set SATA speed configuration from GEN2 to GEN1 */
 				MV_U32 regVal;
 				mvOsSemTake(&pAdapter->semaphore);
@@ -6026,6 +6041,7 @@ MV_BOOLEAN mvSataSetChannelPhyParams(MV_SATA_ADAPTER *pAdapter, MV_U8 channelInd
 
 	if ((pAdapter->chipIs62X1Z0 == MV_TRUE) ||
 	    (pAdapter->chipIs66XXX0 == MV_TRUE) ||
+	    (pAdapter->chipIs672XX0 == MV_TRUE) ||
 	    (pAdapter->chipIs65XXZ0 == MV_TRUE)) {
 		mvLogMsg(MV_CORE_DRIVER_LOG_ID, MV_DEBUG_FATAL_ERROR, "%d  : mvSataSetChannelPhyPara\
 m" "s Failed, This function not supported for this adapter\n", pAdapter->adapterId);
diff --git a/arch/arm/plat-armada/mv_hal/sata/CoreDriver/mvSata.h b/arch/arm/plat-armada/mv_hal/sata/CoreDriver/mvSata.h
index 35fc6d4..6f8eead 100755
--- a/arch/arm/plat-armada/mv_hal/sata/CoreDriver/mvSata.h
+++ b/arch/arm/plat-armada/mv_hal/sata/CoreDriver/mvSata.h
@@ -119,6 +119,7 @@ extern "C" {
 #define MV_SATA_DEVICE_ID_7823			0x7823 /* DSMP */
 #define MV_SATA_DEVICE_ID_7888			0x7888 /* DSMP */
 #define MV_SATA_DEVICE_ID_6660			0x6660 /* AvantaLP */
+#define MV_SATA_DEVICE_ID_6720			0x6720 /* Armada375 */
 #define MV_SATA_CHANNELS_NUM                    8
 #define MV_SATA_UNITS_NUM                       2
 #define MV_SATA_5082_PORT_NUM                   1
@@ -552,6 +553,7 @@ typedef struct mvSataAdapter {
 	MV_BOOLEAN chipIs62X1Z0;
 	MV_BOOLEAN chipIs65XXZ0;
 	MV_BOOLEAN chipIs66XXX0;
+	MV_BOOLEAN chipIs672XX0;
 	MV_U8 signalAmps[MV_SATA_CHANNELS_NUM];
 	MV_U8 pre[MV_SATA_CHANNELS_NUM];
 	struct mvQueuedCommandEntry adapterCommands[_MV_SATA_COMMANDS_PER_ADAPTER];
-- 
1.7.5.4

