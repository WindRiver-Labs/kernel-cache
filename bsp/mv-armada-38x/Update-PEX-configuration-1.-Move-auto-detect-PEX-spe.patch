From d5c4d849852bf373eb51c02e6772d244a84727ed Mon Sep 17 00:00:00 2001
From: Eli Nidam <elini@marvell.com>
Date: Thu, 29 Nov 2012 13:31:58 +0200
Subject: [PATCH 0412/1825] Update PEX configuration 1. Move auto detect PEX
 speed GEN1/2 to bin header 2. Move auto detect
 PEX width X1/X4 to bin header 3. Remove duplicate
 code of SERDES configuraton in u-boot (replace it
 with new code read relevant configuration from
 SERDES registers)

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit d5c77ee4a3b61d9be7912f58f4002ce9b5b5723b

Change-Id: I20ad8414cd285d1a2127c0a3a564cac286ba30b8

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/mv_hal/pex/mvPex.c     |    5 ++++-
 arch/arm/plat-armada/mv_hal/pex/mvPexRegs.h |    1 +
 2 files changed, 5 insertions(+), 1 deletions(-)
 mode change 100644 => 100755 arch/arm/plat-armada/mv_hal/pex/mvPexRegs.h

diff --git a/arch/arm/plat-armada/mv_hal/pex/mvPex.c b/arch/arm/plat-armada/mv_hal/pex/mvPex.c
index e90e0d4..63e419f 100755
--- a/arch/arm/plat-armada/mv_hal/pex/mvPex.c
+++ b/arch/arm/plat-armada/mv_hal/pex/mvPex.c
@@ -200,7 +200,10 @@ MV_U32 mvPexModeGet(MV_U32 pexIf, MV_PEX_MODE *pexMode)
 	}
 
 	/* Check if we have link */
-	if (MV_REG_READ(PEX_STATUS_REG(pexIf)) & PXSR_DL_DOWN) {
+/*	if (MV_REG_READ(PEX_STATUS_REG(pexIf)) & PXSR_DL_DOWN) { */
+
+	if ((MV_REG_READ(PEX_DBG_STATUS_REG(pexIf)) & 0x7f) != 0x7E) {
+
 		pexMode->pexLinkUp = MV_FALSE;
 
 		/* If there is no link, the auto negotiation data is worthless */
diff --git a/arch/arm/plat-armada/mv_hal/pex/mvPexRegs.h b/arch/arm/plat-armada/mv_hal/pex/mvPexRegs.h
old mode 100644
new mode 100755
index 869bdbd..040c9dd
--- a/arch/arm/plat-armada/mv_hal/pex/mvPexRegs.h
+++ b/arch/arm/plat-armada/mv_hal/pex/mvPexRegs.h
@@ -185,6 +185,7 @@ extern "C" {
 #define PEX_TL_CTRL_REG(pexIf)				(MV_PEX_IF_REGS_BASE(pexIf) - (pexIf)*0x10000)
 #define PEX_RAM_PARITY_CTRL_REG(pexIf) 			((MV_PEX_IF_REGS_BASE(pexIf)) + 0x1A50)
 #define PEX_DBG_CTRL_REG(pexIf) 			((MV_PEX_IF_REGS_BASE(pexIf)) + 0x1A60)
+#define PEX_DBG_STATUS_REG(pexIf)           ((MV_PEX_IF_REGS_BASE(pexIf)) + 0x1A64)
 
 #define PEX_LINK_CTRL_STATUS_REG(pexIf) 		((MV_PEX_IF_REGS_BASE(pexIf)) + 0x70)
 
-- 
1.7.5.4

