From 2d212bf778e15b63ffd7f81f76d3be01d7861c37 Mon Sep 17 00:00:00 2001
From: Evan <xswang@marvell.com>
Date: Mon, 19 May 2014 10:06:51 +0800
Subject: [PATCH 1674/1825] fix:alp:BM: Qset can be deleted when it is still
 in use

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 3eca0319342e12e2b3d574f8f272a5739a17b409

Change-Id: I2d1be120a4a767c1f9bfc14dcb66df0ec97ed066
Signed-off-by: Evan <xswang@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8099
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Tested-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.c |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.c b/arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.c
index e9b3073..83f3f32 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/bm/mvBm.c
@@ -506,7 +506,7 @@ MV_STATUS mvBmRxqToQsetShortSet(int queue, int qset)
 				__func__, queue, mvBmQsets[oldQset].pool, qset, mvBmQsets[qset].pool);
 			return MV_FAIL;
 		}
-		mvBmQsets[qset].refCount--;
+		mvBmQsets[oldQset].refCount--;
 	}
 
 	mvPp2WrReg(MV_BM_PRIO_IDX_REG, queue);
@@ -554,7 +554,7 @@ MV_STATUS mvBmTxqToQsetLongSet(int queue, int qset)
 				__func__, queue, mvBmQsets[oldQset].pool, qset, mvBmQsets[qset].pool);
 			return MV_FAIL;
 		}
-		mvBmQsets[qset].refCount--;
+		mvBmQsets[oldQset].refCount--;
 	}
 
 	mvPp2WrReg(MV_BM_PRIO_IDX_REG, queue);
@@ -602,7 +602,7 @@ MV_STATUS mvBmTxqToQsetShortSet(int queue, int qset)
 				__func__, queue, mvBmQsets[oldQset].pool, qset, mvBmQsets[qset].pool);
 			return MV_FAIL;
 		}
-		mvBmQsets[qset].refCount--;
+		mvBmQsets[oldQset].refCount--;
 	}
 
 	mvPp2WrReg(MV_BM_PRIO_IDX_REG, queue);
-- 
1.7.5.4

