From e2a3fba40f92f4cbd1b3b7f92f3ab29b193371a8 Mon Sep 17 00:00:00 2001
From: Neta Zur <neta@marvell.com>
Date: Mon, 22 Jul 2013 11:00:22 +0300
Subject: [PATCH 0858/1825] fix: axp: update IO Sync Barrier register

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit f5a89a2f8cfc18223818d0cb0e50410a3c82391d

	Update function dma_io_sync - instead of using IO Sync Barrier register of CPU 0,
	use the currently used CPU register. Please integrate to stable branch

Change-Id: I390ac1999d9a6e77cbe491c5b845b3b6bb995ec4
Signed-off-by: Neta Zur <neta@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/2745
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Igor Patrik <igorp@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-armadaxp/include/mach/armadaxp.h |    1 +
 arch/arm/mach-armadaxp/include/mach/io.h       |    5 +++--
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-armadaxp/include/mach/armadaxp.h b/arch/arm/mach-armadaxp/include/mach/armadaxp.h
index 5cb020e..0f57583 100755
--- a/arch/arm/mach-armadaxp/include/mach/armadaxp.h
+++ b/arch/arm/mach-armadaxp/include/mach/armadaxp.h
@@ -282,6 +282,7 @@
 #define AXP_IN_DOORBELL_CAUSE		0x78
 #define AXP_IN_DRBEL_CAUSE		(AXP_PER_CPU_BASE | 0x78)
 #define AXP_IN_DRBEL_MSK		(AXP_PER_CPU_BASE | 0x7c)
+#define AXP_CPU_IO_SYNC_BARRIER_CTRL_REG	(AXP_PER_CPU_BASE | 0x10)
 
 #ifdef CONFIG_MACH_ARMADA_XP_FPGA
 #define AXP_CPU_RESUME_ADDR_REG(cpu)	(AXP_BRIDGE_VIRT_BASE | 0x984)
diff --git a/arch/arm/mach-armadaxp/include/mach/io.h b/arch/arm/mach-armadaxp/include/mach/io.h
index 0d8a34a..3c35aa8 100644
--- a/arch/arm/mach-armadaxp/include/mach/io.h
+++ b/arch/arm/mach-armadaxp/include/mach/io.h
@@ -23,8 +23,9 @@
 
 #ifdef CONFIG_AURORA_IO_CACHE_COHERENCY
 #define dma_io_sync()	do {				\
-	writel(0x1, INTER_REGS_BASE + 0x21810);		\
-	while (readl(INTER_REGS_BASE + 0x21810) & 0x1);	\
+	writel(0x1, AXP_CPU_IO_SYNC_BARRIER_CTRL_REG);		\
+	while (readl(AXP_CPU_IO_SYNC_BARRIER_CTRL_REG) & 0x1)	\
+		;					\
 } while (0)
 #else
 #define dma_io_sync()	do { } while (0)
-- 
1.7.5.4

