From 1d55178b0f09d1d5ed803038ed0b52bf84e0e01d Mon Sep 17 00:00:00 2001
From: Nadav Haklai <nadavh@marvell.com>
Date: Wed, 24 Oct 2012 10:40:43 +0200
Subject: [PATCH 0265/1825] Check CPU validity on TRC_OUTPUT function

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 18194c23fac0a9150bf29c947a65ae5ddbf53dfc

Change-Id: I775932c5b260573a805de906c6a2acf1626970b5
Signed-off-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_trace/dbg-trace.c            |   13 ++++++++++---
 1 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_trace/dbg-trace.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_trace/dbg-trace.c
index b0dc2ba..3d9e415 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_trace/dbg-trace.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_trace/dbg-trace.c
@@ -137,6 +137,7 @@ void TRC_OUTPUT(int cpu_mask, int time_mode)
 	int i, last, next, cpu, active;
 	struct trace *p;
 	struct timeval *tv_base;
+	bool   cpu_found = false;
 
 	active = trc_active;
 	trc_active = 0;
@@ -144,10 +145,16 @@ void TRC_OUTPUT(int cpu_mask, int time_mode)
 		cpu = smp_processor_id();
 	else {
 		for_each_possible_cpu(cpu) {
-			if (MV_BIT_CHECK(cpu_mask, cpu))
+			if (MV_BIT_CHECK(cpu_mask, cpu)) {
+				cpu_found = true;
 				break;
+			}
 		}
 	}
+	if (cpu_found == false) {
+		printk(KERN_ERR "%s: Wrong cpu_mask=0x%x\n", __func__, cpu_mask);
+		return;
+	}
 
 	next = trc_index[cpu];
 	last = mv_trace_prev_idx(next);
@@ -203,8 +210,8 @@ void TRC_RELEASE(void)
 
 	for_each_possible_cpu(cpu) {
 
-		kfree(trc_arr[smp_processor_id()]);
-		trc_index[smp_processor_id()] = 0;
+		kfree(trc_arr[cpu]);
+		trc_index[cpu] = 0;
 	}
 }
 
-- 
1.7.5.4

