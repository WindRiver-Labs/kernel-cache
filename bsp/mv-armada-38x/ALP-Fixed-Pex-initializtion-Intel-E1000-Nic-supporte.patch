From dae127bc0fc9012aaf434d2b41ed1273bbe0b51c Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Mon, 29 Apr 2013 17:44:11 +0300
Subject: [PATCH 0627/1825] ALP: Fixed Pex initializtion (Intel E1000 Nic
 supported & tested)

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 013496a1932092541df1958c671b56eb52dee6b4

- Updated mv_pex.c (with mv_pci.c code from armada xp)
- Added PEX information struct & init function

Change-Id: I738df57a787da65d4ec506698323358f70c894fb
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/1685
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    8 +------
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   21 ++++++++++++++++++-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |    4 +-
 3 files changed, 22 insertions(+), 11 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index 7e00768..233d081 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -257,14 +257,8 @@ typedef struct {
 	MV_U8 spiCs;
 } MV_BOARD_TDM_INFO;
 
-typedef struct _boardPexUnitCfg {
-	MV_PEX_UNIT_CFG pexCfg;
-	MV_U8 pexLaneStat[4];                   /* 1: enabled, 2: disabled */
-} MV_BOARD_PEX_UNIT_CFG;
-
 typedef struct _boardPexInfo {
-	MV_PEXIF_INDX pexMapping[MV_PEX_MAX_IF];
-	MV_BOARD_PEX_UNIT_CFG pexUnitCfg[MV_PEX_MAX_UNIT];
+	MV_PEX_UNIT_CFG pexUnitCfg[MV_PEX_MAX_UNIT];
 	MV_U32 boardPexIfNum;
 } MV_BOARD_PEX_INFO;
 
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index e8e39e6..5dfcf89 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -171,6 +171,21 @@ static MV_U32 mvCtrlDevIdIndexGet(MV_U32 devId)
 	return index;
 }
 
+static MV_VOID mvCtrlPexConfig(MV_VOID)
+{
+	MV_U8 pexUnit;
+	MV_U32 pexIfNum = mvCtrlSocUnitInfoNumGet(PEX_UNIT_ID);
+
+	MV_BOARD_PEX_INFO *boardPexInfo = mvBoardPexInfoGet();
+
+	memset(boardPexInfo, 0, sizeof(MV_BOARD_PEX_INFO));
+
+	for (pexUnit = 0; pexUnit < pexIfNum; pexUnit++)
+		boardPexInfo->pexUnitCfg[pexUnit] = PEX_BUS_MODE_X1;
+
+	boardPexInfo->boardPexIfNum = pexIfNum;
+}
+
 MV_UNIT_ID mvCtrlSocUnitNums[MAX_UNITS_ID][MV_66xx_INDEX_MAX] = {
 /*                           6660               6650            6610 */
 /* DRAM_UNIT_ID         */ { 1,                 1,              1, },
@@ -243,6 +258,8 @@ MV_STATUS mvCtrlEnvInit(MV_VOID)
 		mvBoardInfoUpdate();
 	}
 
+	mvCtrlPexConfig();
+
 	/* write MPP's config and Board general config */
 	mvBoardConfigWrite();
 
@@ -700,7 +717,7 @@ MV_U32 mvCtrlMppRegGet(MV_U32 mppGroup)
 *******************************************************************************/
 MV_U32 mvCtrlPexMaxIfGet(MV_VOID)
 {
-	return 1;
+	return mvCtrlSocUnitInfoNumGet(PEX_UNIT_ID);
 }
 
 #endif
@@ -724,7 +741,7 @@ MV_U32 mvCtrlPexMaxIfGet(MV_VOID)
 *******************************************************************************/
 MV_U32 mvCtrlPexMaxUnitGet(MV_VOID)
 {
-	return 1;
+	return mvCtrlSocUnitInfoNumGet(PEX_UNIT_ID);
 }
 
 #if defined(MV_INCLUDE_PCI)
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index b836453..dd4c1eb 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -181,8 +181,8 @@ extern "C" {
 #endif
 
 /* This define describes the maximum number of supported PEX Interfaces */
-#define MV_PEX_MAX_IF                           10
-#define MV_PEX_MAX_UNIT                         4
+#define MV_PEX_MAX_IF                           2
+#define MV_PEX_MAX_UNIT                         2
 #ifdef MV_INCLUDE_PEX
 #define MV_INCLUDE_PEX0
 #define MV_DISABLE_PEX_DEVICE_BAR
-- 
1.7.5.4

