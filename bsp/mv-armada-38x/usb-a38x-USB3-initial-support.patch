From befaf3032515e90225d34b5f0b6afc9d5cee74b7 Mon Sep 17 00:00:00 2001
From: Nadav Haklai <nadavh@marvell.com>
Date: Tue, 12 Nov 2013 14:35:04 +0200
Subject: [PATCH 1147/1825] usb: a38x: USB3 initial support

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 39728d230c1eb15baea5a14a7824bc074f1603b7

	- Fix wrong USB3 register offests
	- Add MV_USB3_WIN_BASE definition
	- Add preliminary init sequence for the UTMI phy
	- Add support for more than one USB phy
	- Cleanup of unrequired USB3 X-BAR windows

Change-Id: I2eebee79eadee325ceda8ed851dc205e9c7c8019
Signed-off-by: Nadav Haklai <nadavh@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4300
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.c       |    4 ++--
 .../armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h      |    4 +++-
 .../armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h      |    7 ++-----
 .../armada_38x_family/ctrlEnv/sys/mvCpuIfRegs.h    |    4 ++--
 arch/arm/plat-armada/mv_hal/usb/mvUsb.c            |   18 ++++++++++++++++++
 5 files changed, 27 insertions(+), 10 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
index 78414c3..6a51d55 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
@@ -124,8 +124,8 @@ MV_UNIT_ID mvCtrlSocUnitNums[MAX_UNITS_ID][MV_68xx_INDEX_MAX] = {
 /*                          6820 */
 /* DRAM_UNIT_ID         */ { 1, 1},
 /* PEX_UNIT_ID          */ { MV_PEX_MAX_UNIT,		MV_PEX_MAX_UNIT_6810},
-/* ETH_GIG_UNIT_ID      */ { MV_ETH_MAX_PORTS,	MV_ETH_MAX_PORTS_6810},
-/* USB_UNIT_ID          */ { MV_USB_MAX_PORTS,		MV_USB3_MAX_PORTS_6810},
+/* ETH_GIG_UNIT_ID      */ { MV_ETH_MAX_PORTS,		MV_ETH_MAX_PORTS_6810},
+/* USB_UNIT_ID          */ { MV_USB_MAX_PORTS,		MV_USB_MAX_PORTS},
 /* USB3_UNIT_ID         */ { MV_USB3_MAX_PORTS,		MV_USB3_MAX_PORTS_6810},
 /* IDMA_UNIT_ID         */ { MV_IDMA_MAX_CHAN,		MV_IDMA_MAX_CHAN},
 /* XOR_UNIT_ID          */ { MV_XOR_MAX_UNIT,		MV_XOR_MAX_UNIT},
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
index 29d3fa2..d292f2a 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
@@ -196,6 +196,9 @@ extern "C" {
 #define GENERAL_PURPOSE_RESERVED1_REG		0x182E4
 #define GENERAL_PURPOSE_RESERVED1_DEFAULT_VALUE	(~BIT17)
 
+/* USB3 registers */
+#define MV_USB3_WIN_BASE(dev)		(MV_USB3_REGS_BASE(dev) + 0x4000)
+
 /* Extract CPU, L2, DDR clocks SAR value from
 ** SAR bits 24-27
 */
@@ -366,7 +369,6 @@ typedef enum _mvTargetId {
 	DRAM_TARGET_ID   = 0,  /* Port 0  -> DRAM interface             */
 	DEV_TARGET_ID    = 1,  /* Port 1  -> Device bus, BootROM, SPI, UART,
 				*	     GPIO, MPP, and Miscellaneous */
-	USB3_TARGET_ID   = 5,  /* Port 5  -> USB3 Unit,                 */
 	PEX_TARGET_ID_123  = 4,  /* Port 4  -> PCI Express 0 and 1        */
 	PEX_TARGET_ID_0   = 8,  /* Port 4  -> PCI Express 0 and 1        */
 	CRYPT_TARGET_ID  = 9,  /* Port 9  -> Crypto Engine SRAM         */
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
index a654b8d..4fdd394 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -117,8 +117,8 @@ extern "C" {
 #define MV_ETH_SGMII_PHY_REGS_OFFSET(p)		(MV_ETH_REGS_OFFSET(p)+0x2000)
 
 #define MV_PEX_IF_REGS_OFFSET(pexIf)            (((pexIf) == 0) ? 0x80000 : (0x40000 + ((pexIf-1) * 0x4000)))
-#define MV_USB_REGS_OFFSET(dev)                 (0x58000 + ((dev) * 0x1000))
-#define MV_USB3_REGS_OFFSET(dev)                (0xF0000 + ((dev) * 0x1000))
+#define MV_USB_REGS_OFFSET(dev)                 (0x58000)
+#define MV_USB3_REGS_OFFSET(dev)                (0xF0000 + (dev * 0x8000))
 #define MV_XOR_REGS_OFFSET(unit)                (0x60800 + (unit)*0x100)
 #define MV_CESA_TDMA_REGS_OFFSET(chanNum)       (0x90000 + (chanNum * 0x2000))
 #define MV_CESA_REGS_OFFSET(chanNum)            (0x9D000 + (chanNum * 0x2000))
@@ -331,7 +331,6 @@ typedef enum _mvTarget {
 	SPI1_CS3,	/* 24 SPI1_CS3			*/
 	BOOT_ROM_CS,	/* 25 BOOT_ROM_CS		*/
 	DEV_BOOCS,	/* 26 DEV_BOOCS			*/
-	USB3,		/* 27 USB3                      */
 	CRYPT0_ENG,	/* 28 Crypto0 Engine		*/
 	PNC_BM,		/* 29 PNC + BM			*/
 	MAX_TARGETS
@@ -380,7 +379,6 @@ typedef enum _mvTarget {
 	{ 0xDA, DEV_TARGET_ID	},		/* SPI1_CS3               */ \
 	{ MAIN_BOOT_ATTR, DEV_TARGET_ID },	/* Main Boot device      */ \
 	{ SEC_BOOT_ATTR, DEV_TARGET_ID  },	/* Secondary Boot device */ \
-	{ 0x00, USB3_TARGET_ID },               /* USB3                  */ \
 	{ 0x01, CRYPT_TARGET_ID	},		/* CRYPT_ENG0            */ \
 	{0x00, PNC_BM_TARGET_ID },		/* PNC_BM		 */ \
 }
@@ -415,7 +413,6 @@ typedef enum _mvTarget {
 	"SPI_CS7",		/* SPI_CS7 */		\
 	"BOOT_ROM_CS",		/* BOOT_ROM_CS */	\
 	"DEV_BOOTCS",		/* DEV_BOOCS */		\
-	"USB3",                 /* USB3 */              \
 	"CRYPT1_ENG",		/* CRYPT1_ENG */	\
 	"PNC_BM"		/* PNC_BM */		\
 }
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/sys/mvCpuIfRegs.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/sys/mvCpuIfRegs.h
index fb6cf6d..03e2fb7 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/sys/mvCpuIfRegs.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/sys/mvCpuIfRegs.h
@@ -112,8 +112,8 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define PCIE0_QUADX1_EN				(1<<7)
 #define PCIE1_QUADX1_EN				(1<<8)
 
-/* IP Configuration registers */
-#define USB_CLUSTER_CONTROL                    (MV_IP_CONFIG_REGS_BASE)
+/* USB Configuration registers */
+#define USB_CONFIG_REG				(MV_IP_CONFIG_REGS_BASE + 0x20)
 
 /* ARM Configuration register */
 /* CPU_CONFIG_REG (CCR) */
diff --git a/arch/arm/plat-armada/mv_hal/usb/mvUsb.c b/arch/arm/plat-armada/mv_hal/usb/mvUsb.c
index adb6861..1418f43 100755
--- a/arch/arm/plat-armada/mv_hal/usb/mvUsb.c
+++ b/arch/arm/plat-armada/mv_hal/usb/mvUsb.c
@@ -183,7 +183,21 @@ int mvUsbBackVoltageUpdate(int dev, MV_U8 gppNo)
 }
 #endif /* MV_USB_VOLTAGE_FIX */
 
+/* USB Phy init specific for 28nm (88F68XX) */
+MV_STATUS mvUsbPhy28nmInit(int dev)
+{
+	MV_U32 regVal;
+
+	/* Temporary init sequence until final init sequence is stable */
+	MV_REG_WRITE(0x18440, 0x62);
+	MV_REG_WRITE(0xC0000, 0x40605205);
+	MV_REG_WRITE(0xC0004, 0x409);
+	MV_REG_WRITE(0xC000C, 0x1be7f6f);
+
+	mvOsPrintf("USB2 UTMI PHY initialized succesfully\n");
 
+	return MV_OK;
+}
 /* USB Phy init specific for 40nm LP (88F6660) */
 MV_STATUS mvUsbPhy40nmLpInit(int dev)
 {
@@ -821,6 +835,10 @@ MV_STATUS mvUsbUtmiPhyInit(int dev, MV_USB_HAL_DATA *usbHalData)
 		/*    (usbHalData->ctrlFamily == MV_88F67X0)) */
 		status = mvUsbPhy40nmLpInit(dev);
 
+	} else if (usbHalData->ctrlFamily == MV_88F68XX) {
+
+		status = mvUsbPhy28nmInit(dev);
+
 	} else
 		mvUsbPhyInit(dev);
 
-- 
1.7.5.4

