From 6bc632615e01f7c69fc2e2f43210e33a9af81be2 Mon Sep 17 00:00:00 2001
From: Jing Hua <jinghua@marvell.com>
Date: Sun, 30 Mar 2014 21:21:16 +0800
Subject: [PATCH 1520/1825] fix: mv_tpm: Solve the issue that PON could not
 register after TPM enabled.

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 23a772454fd2352685d3a72d88bdb62af0bb6a89

	 TPM sets the default RXQ of PON port to 2, which is for LPBK.

Change-Id: I9c126f0bee1015900ac2e767d514d711bd08604a
Signed-off-by: Jing Hua <jinghua@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/6771
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Tested-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_tpm/inc/tpm_cls.h            |    2 ++
 .../mv_drivers_lsp/mv_tpm/src/core/tpm_cls.c       |    4 ++++
 2 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/inc/tpm_cls.h b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/inc/tpm_cls.h
index 285ddfa..1ff5a49 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/inc/tpm_cls.h
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/inc/tpm_cls.h
@@ -51,6 +51,7 @@ disclaimer.
 #define TPM_CLS_FL_OFF_INV		(0xFFFF)			/* rule invalid offset		*/
 #define TPM_PORT_TYPE_INV		(0xFFFF)			/* invalid port type flag	*/
 #define TPM_PORT_BM_INV			(0xFFFF)			/* invalid port BM flag		*/
+#define TPM_CLS_DEF_MTU			(0xFFFF)			/* default MTU size		*/
 
 /******************************************************************************/
 /*                              ENUMERATIONS                                  */
@@ -79,6 +80,7 @@ enum tpm_cls_rx_qh_from_t {
 enum tpm_cls_rx_qh_t {
 	TPM_GMAC0_RX_QH = 0,
 	TPM_GMAC1_RX_QH,
+	TPM_LPBK_RX_QH,
 	TPM_PMAC_RX_QH,
 };
 #endif
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_cls.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_cls.c
index 821f121..4af9072 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_cls.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_cls.c
@@ -2101,6 +2101,10 @@ int tpm_cls_init(void)
 	rc = tpm_cls_pon_port_default_dcod_init();
 	IF_ERROR_STR(TPM_CLS_MOD, rc, "Create decode table entry for default luid of PON port failed\n");
 
+	/* set default MTU size */
+	rc = mvPp2V1ClsHwMtuSet(0, TPM_CLS_DEF_MTU);
+	IF_ERROR_STR(TPM_CLS_MOD, rc, "set default MTU size (0x%x) failed\n");
+
 	tpm_db_cls_init();
 
 	return TPM_OK;
-- 
1.7.5.4

