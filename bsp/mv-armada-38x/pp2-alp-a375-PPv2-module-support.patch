From 52d8bb6b816c89edf3d41016bd4986f486198b8f Mon Sep 17 00:00:00 2001
From: Yoni Farhadia <yonif@marvell.com>
Date: Tue, 15 Oct 2013 10:10:01 +0200
Subject: [PATCH 1023/1825] pp2: alp,a375: PPv2 module support

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 4cdeb57dd425d404862bb10a5c0cfb49e5c94f17

	- Support loading PPv2 driver as module

Change-Id: I76e20ba09cd8c61da78badb3d96d9dd9560f09a9
Signed-off-by: Yoni Farhadia <yonif@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3712
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Tested-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   16 ++--------------
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |    5 +----
 arch/arm/mach-avantalp/core.c                      |    8 ++++----
 arch/arm/mach-avantalp/export.c                    |   13 +++++++++++++
 arch/arm/mach-avantalp/mv_hal_if/mvSysEthPhy.c     |    7 -------
 arch/arm/plat-armada/Kconfig                       |    2 +-
 6 files changed, 21 insertions(+), 30 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index 231ca88..c959328 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -75,14 +75,8 @@
 #include "pex/mvPex.h"
 #include "pex/mvPexRegs.h"
 
-#if defined(MV_INCLUDE_GIG_ETH)
-#if defined(MV_ETH_LEGACY)
-#include "eth/mvEth.h"
-#elif defined(CONFIG_MV_ETH_NETA)
-#include "neta/gbe/mvNeta.h"
-#elif defined(CONFIG_MV_ETH_PP2)
+#if defined(CONFIG_MV_ETH_PP2)
 #include "pp2/gbe/mvPp2Gbe.h"
-#endif /* MV_ETH_LEGACY or MV_ETH_NETA  or PP2*/
 #endif
 
 #if defined(MV_INCLUDE_XOR)
@@ -1647,15 +1641,9 @@ MV_VOID mvCtrlAddrDecShow(MV_VOID)
 	mvUnitAddrDecShow(mvCtrlUsbMaxGet(), USB_UNIT_ID, "USB", mvUsbWinRead);
 #endif
 
-#if defined(MV_INCLUDE_GIG_ETH)
-#if defined(MV_ETH_LEGACY)
-	mvUnitAddrDecShow(mvCtrlEthMaxPortGet(), ETH_GIG_UNIT_ID, "ETH", mvEthWinRead);
-#elif defined(CONFIG_MV_ETH_NETA)
-	mvUnitAddrDecShow(mvCtrlEthMaxPortGet(), ETH_GIG_UNIT_ID, "ETH", mvNetaWinRead);
-#else
+#if defined(CONFIG_MV_ETH_PP2)
 	mvUnitAddrDecShow(mvCtrlEthMaxPortGet(), ETH_GIG_UNIT_ID, "ETH", mvPp2WinRead);
 #endif
-#endif
 
 #if defined(MV_INCLUDE_XOR)
 	mvUnitAddrDecShow(mvCtrlXorMaxChanGet(), XOR_UNIT_ID, "XOR", mvXorTargetWinRead);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index af1570b..dd51a5e 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -110,7 +110,7 @@ extern "C" {
 #define MV_CPUIF_REGS_OFFSET(cpu)               (0x21800 + (cpu) * 0x100)
 #define MV_CPU_HW_SEM_OFFSET                    (0x20500)
 
-#if defined(MV_ETH_PP2)
+/* Network units */
 #define MV_PP2_REG_BASE                         (0xF0000)
 #define MV_ETH_BASE_ADDR                        (0xC0000)
 #define LMS_REG_BASE                            (MV_ETH_BASE_ADDR)
@@ -124,9 +124,6 @@ extern "C" {
 #define MV_PON_PORT_ID                          7
 #define MV_ETH_RXQ_TOTAL_NUM                    32
 #define MV_VLAN_1_TYPE                          0x88A8
-#else
-#define MV_ETH_BASE_ADDR			(0x70000)
-#endif /*MV_ETH_PP2*/
 
 #define MV_ETH_REGS_OFFSET(port)                (MV_ETH_BASE_ADDR - ((port) / 2) * 0x40000 + ((port) % 2) * 0x4000)
 
diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index 32a75d3..19ca5da 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -67,7 +67,7 @@
 #include "xor/mvXorRegs.h"
 #endif
 
-#if defined(CONFIG_MV_ETH_PP2)
+#if defined(CONFIG_MV_ETH_PP2) || defined(CONFIG_MV_ETH_PP2_MODULE)
 #include <linux/mv_pp2.h>
 #endif
 
@@ -590,7 +590,7 @@ void __init alp_usb_init(void)
 /*******************************************************************************
  * GBE
  */
-#if defined(CONFIG_MV_ETH_PP2)
+#if defined(CONFIG_MV_ETH_PP2) || defined(CONFIG_MV_ETH_PP2_MODULE)
 static void mv_pp2_giga_pdev_register(struct platform_device *pdev)
 {
 	struct mv_pp2_pdata *plat_data = (struct mv_pp2_pdata*)pdev->dev.platform_data;
@@ -758,7 +758,6 @@ static void __init eth_init(void)
 		mv_pp2_giga_pdev_register(&mv_pp2_ge3_plat);
 #endif
 }
-#endif /* CONFIG_MV_ETH_PP2 */
 
 #ifdef CONFIG_MV_INCLUDE_SWITCH
 char *mv_switch_str;
@@ -868,6 +867,7 @@ static void __init switch_init(void)
 		mv_switch_pdev_register(&mv_switch0_plat_dev);
 }
 #endif /* CONFIG_MV_INCLUDE_SWITCH */
+#endif /* CONFIG_MV_ETH_PP2 */
 
 static void alp_eth_init(void)
 {
@@ -875,7 +875,7 @@ static void alp_eth_init(void)
 	mvSysEthPhyInit();
 #endif /* CONFIG_MV_INCLUDE_ETH_PHY */
 
-#ifdef CONFIG_MV_ETH_PP2
+#if defined(CONFIG_MV_ETH_PP2) || defined(CONFIG_MV_ETH_PP2_MODULE)
 	eth_init();
 #endif /* CONFIG_MV_ETH_PP2 */
 
diff --git a/arch/arm/mach-avantalp/export.c b/arch/arm/mach-avantalp/export.c
index 324080b..3557d95 100644
--- a/arch/arm/mach-avantalp/export.c
+++ b/arch/arm/mach-avantalp/export.c
@@ -204,3 +204,16 @@ EXPORT_SYMBOL(TRC_RELEASE);
 #include "mvList.h"
 EXPORT_SYMBOL(mvListCreate);
 EXPORT_SYMBOL(mvListDestroy);
+
+#include "mvStack.h"
+EXPORT_SYMBOL(mvStackCreate);
+EXPORT_SYMBOL(mvStackDelete);
+EXPORT_SYMBOL(mvStackStatus);
+
+#include "eth-phy/mvEthPhy.h"
+EXPORT_SYMBOL(mvEthPhyRestartAN);
+EXPORT_SYMBOL(mvEthPhyDisableAN);
+EXPORT_SYMBOL(mvEthPhyRegRead);
+EXPORT_SYMBOL(mvEthPhyRegWrite);
+EXPORT_SYMBOL(mvEthPhyAdvertiseSet);
+EXPORT_SYMBOL(mvEthPhyAdvertiseGet);
diff --git a/arch/arm/mach-avantalp/mv_hal_if/mvSysEthPhy.c b/arch/arm/mach-avantalp/mv_hal_if/mvSysEthPhy.c
index 8d41a81..3899830 100644
--- a/arch/arm/mach-avantalp/mv_hal_if/mvSysEthPhy.c
+++ b/arch/arm/mach-avantalp/mv_hal_if/mvSysEthPhy.c
@@ -68,14 +68,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "ctrlEnv/mvCtrlEnvSpec.h"
 #include "boardEnv/mvBoardEnvLib.h"
 #include "eth-phy/mvEthPhy.h"
-
-#if defined(CONFIG_MV_ETH_LEGACY)
-#include "eth/gbe/mvEthRegs.h"
-#elif defined(CONFIG_MV_ETH_NETA)
-#include "neta/gbe/mvEthRegs.h"
-#elif defined(CONFIG_MV_ETH_PP2)
 #include "pp2/gbe/mvPp2GbeRegs.h"
-#endif
 
 /*******************************************************************************
 * mvSysEthPhyInit - Initialize the EthPhy subsystem
diff --git a/arch/arm/plat-armada/Kconfig b/arch/arm/plat-armada/Kconfig
index c43b0a4..6304c62 100644
--- a/arch/arm/plat-armada/Kconfig
+++ b/arch/arm/plat-armada/Kconfig
@@ -490,7 +490,7 @@ source arch/arm/plat-armada/mv_drivers_lsp/mv_neta/Kconfig
 endif
 
 config MV_ETH_PP2
-	bool "PPv2 driver "
+	tristate "PPv2 driver "
 	depends on ARCH_AVANTA_LP || ARCH_ARMADA375
 	default y
 	select MV_ETH_PP2_CLS2
-- 
1.7.5.4

