From 24cbbccecbd96b05ad222ac07d644141028cd84a Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Sun, 26 May 2013 19:25:06 +0300
Subject: [PATCH 0686/1825] ALP: Fix PCIe1 support - check PCIe link before
 PCIe init

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 417f20dab1ad9a80437185ee4f9044361a9cba1e

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: I4c16bc0fd4504bb7e55e74e5cf4db2b2b120a387
Reviewed-on: http://vgitil04.il.marvell.com:8080/1982
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/config/mvSysHwConfig.h |    2 +-
 arch/arm/mach-avantalp/pex.c                  |   12 ++++++++++++
 2 files changed, 13 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-avantalp/config/mvSysHwConfig.h b/arch/arm/mach-avantalp/config/mvSysHwConfig.h
index a552763..b15794c 100755
--- a/arch/arm/mach-avantalp/config/mvSysHwConfig.h
+++ b/arch/arm/mach-avantalp/config/mvSysHwConfig.h
@@ -176,7 +176,7 @@ disclaimer.
 /****************************************************************/
 
 /* Enable Clock Power Control */
-#undef MV_INCLUDE_CLK_PWR_CNTRL
+#define MV_INCLUDE_CLK_PWR_CNTRL
 
 /* Disable the DEVICE BAR in the PEX */
 #define MV_DISABLE_PEX_DEVICE_BAR
diff --git a/arch/arm/mach-avantalp/pex.c b/arch/arm/mach-avantalp/pex.c
index eba006d..0c7421e 100644
--- a/arch/arm/mach-avantalp/pex.c
+++ b/arch/arm/mach-avantalp/pex.c
@@ -85,6 +85,12 @@ void __init mv_pex_preinit(void)
 			continue;
 		}
 
+		if ((MV_REG_READ(PEX_DBG_STATUS_REG(pci_if)) & 0x7f) != 0x7E) {
+			pr_info("no link, disabled\n");
+			mvCtrlPwrClckSet(PEX_UNIT_ID, pci_if, MV_FALSE);
+			continue;
+		}
+
 		if (mvSysPexInit(pci_if, MV_PEX_ROOT_COMPLEX) != MV_OK) {
 			pr_warn("%s: Error: mvSysPexInit(%d) failed\n", __func__, pci_if);
 			mvCtrlPwrClckSet(PEX_UNIT_ID, pci_if, MV_FALSE);
@@ -123,6 +129,12 @@ void mv_pex_reinit(void)
 		if (mvCtrlPwrClckGet(PEX_UNIT_ID, pci_if) == MV_FALSE)
 			continue;
 
+		if ((MV_REG_READ(PEX_DBG_STATUS_REG(pci_if)) & 0x7f) != 0x7E) {
+			pr_info("no link, disabled\n");
+			mvCtrlPwrClckSet(PEX_UNIT_ID, pci_if, MV_FALSE);
+			continue;
+		}
+
 		if (mvSysPexInit(pci_if, MV_PEX_ROOT_COMPLEX) != MV_OK) {
 			pr_warn("%s: Error: mvSysPexInit(%d) failed\n", __func__, pci_if);
 			mvCtrlPwrClckSet(PEX_UNIT_ID, pci_if, MV_FALSE);
-- 
1.7.5.4

