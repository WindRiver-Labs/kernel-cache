From 53250d883c30fbcf0c4180dcd8c1d4ad27ec0c9a Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Wed, 24 Jul 2013 11:16:28 -0400
Subject: [PATCH 0885/1825] pp2: Add sysfs command to enable/disable skb
 recycle

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit bc673fbf583b13ac049d031eb4bfbb26252dc835

Change-Id: I61f509860567a2f74b96a55ac8fc60a1f9c7902a
Reviewed-on: http://vgitil04.il.marvell.com:8080/2820
Reviewed-by: Jonatan Farhadian <yonif@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_eth_sysfs.c   |   58 +++++++++++---------
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c    |    2 -
 2 files changed, 32 insertions(+), 28 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_sysfs.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_sysfs.c
index 71cb76c..6d8f6fb 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_sysfs.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_sysfs.c
@@ -42,30 +42,32 @@ static ssize_t mv_eth_help(char *buf)
 {
 	int off = 0;
 
-	off += sprintf(buf+off, "cd                 bm            - move to BM sysfs directory\n");
-	off += sprintf(buf+off, "cd                 napi          - move to NAPI groups API sysfs directory\n");
-	off += sprintf(buf+off, "cd                 rx            - move to RX sysfs directory\n");
-	off += sprintf(buf+off, "cd                 tx            - move to TX sysfs directory\n");
-	off += sprintf(buf+off, "cd                 tx_sched      - move to TX Scheduler sysfs directory\n");
-	off += sprintf(buf+off, "cd                 pon           - move to PON sysfs directory\n");
-	off += sprintf(buf+off, "cd                 pme           - move to PME sysfs directory\n");
-	off += sprintf(buf+off, "cd                 qos           - move to QoS sysfs directory\n\n");
-
-	off += sprintf(buf+off, "cat                addrDec       - print address decode registers\n");
-	off += sprintf(buf+off, "echo p {0|1|2|3} > tag           - None[0], Marvell Header[1], DSA tag[2], EDSA tag[3]\n");
-	off += sprintf(buf+off, "echo p {0|1}     > etypeDsaMod   - Set DSA etherType mode: DSA[0], EDSA[1]\n");
-	off += sprintf(buf+off, "echo [hex]       > etypeDsa      - Set new DSA etherType value\n");
-	off += sprintf(buf+off, "echo {0|1}       > pnc           - enable / disable Parser and Classifier access\n");
-	off += sprintf(buf+off, "echo [p]         > port          - show port info\n");
-	off += sprintf(buf+off, "echo [if_name]   > netdev        - show <if_name> net_device status\n");
-	off += sprintf(buf+off, "echo [p]         > cntrs         - show port MIB counters\n");
+	off += sprintf(buf+off, "cd                 bm          - move to BM sysfs directory\n");
+	off += sprintf(buf+off, "cd                 napi        - move to NAPI groups API sysfs directory\n");
+	off += sprintf(buf+off, "cd                 rx          - move to RX sysfs directory\n");
+	off += sprintf(buf+off, "cd                 tx          - move to TX sysfs directory\n");
+	off += sprintf(buf+off, "cd                 tx_sched    - move to TX Scheduler sysfs directory\n");
+	off += sprintf(buf+off, "cd                 pon         - move to PON sysfs directory\n");
+	off += sprintf(buf+off, "cd                 pme         - move to PME sysfs directory\n");
+	off += sprintf(buf+off, "cd                 qos         - move to QoS sysfs directory\n\n");
+
+	off += sprintf(buf+off, "cat                addrDec     - show address decode registers\n");
+	off += sprintf(buf+off, "echo [p]         > port        - show port [p] status\n");
+	off += sprintf(buf+off, "echo [if_name]   > netdev      - show [if_name] net_device status\n");
+	off += sprintf(buf+off, "echo [p]         > cntrs       - show port [p] MIB counters\n");
+	off += sprintf(buf+off, "echo [p]         > stats       - show port [p] statistics\n");
+	off += sprintf(buf+off, "echo [p]         > isrRegs     - show ISR registers for port i[p]\n");
+	off += sprintf(buf+off, "echo [p]         > dropCntrs   - show drop counters for port [p]\n");
+
+	off += sprintf(buf+off, "echo p [0|1|2|3] > tag         - set TAG mode: None[0], MH[1], DSA[2], EDSA[3]\n");
+	off += sprintf(buf+off, "echo p [0|1]     > etypeDsaMod - set DSA etherType mode: DSA[0], EDSA[1]\n");
+	off += sprintf(buf+off, "echo [hex]       > etypeDsa    - set new DSA etherType value\n");
+	off += sprintf(buf+off, "echo [0|1]       > pnc         - enable / disable Parser and Classifier access\n");
+	off += sprintf(buf+off, "echo [0|1]       > skb         - enable / disable skb recycle\n");
+
 #ifdef CONFIG_MV_ETH_DEBUG_CODE
-	off += sprintf(buf+off, "echo [p] [hex]   > debug         - bit0:rx, bit1:tx, bit2:isr, bit3:poll, bit4:dump, bit5:buff_hdr\n");
+	off += sprintf(buf+off, "echo [p] [hex]   > debug       - b0:rx, b1:tx, b2:isr, b3:poll, b4:dump, b5:b_hdr\n");
 #endif
-	off += sprintf(buf+off, "echo [p]         > stats         - show port [p] statistics\n");
-	off += sprintf(buf+off, "echo [p]         > isrRegs       - show ISR registers for port <p> range [0..max]\n");
-	off += sprintf(buf+off, "echo [p]         > dropCntrs     - show drop counters for port <p> range [0..max]\n");
-
 	return off;
 }
 
@@ -121,6 +123,8 @@ static ssize_t mv_eth_port_store(struct device *dev,
 		mvPp2PrsTagModeSet(p, v);
 	} else if (!strcmp(name, "etypeDsaMod")) {
 		mvPp2PrsEtypeDsaModeSet(p, v);
+	} else if (!strcmp(name, "skb")) {
+		mv_eth_ctrl_recycle(p);
 	} else {
 		err = 1;
 		printk(KERN_ERR "%s: illegal operation <%s>\n", __func__, attr->attr.name);
@@ -244,6 +248,7 @@ static DEVICE_ATTR(isrRegs,	S_IWUSR, NULL, mv_eth_port_store);
 static DEVICE_ATTR(dropCntrs,	S_IWUSR, NULL, mv_eth_port_store);
 static DEVICE_ATTR(stats,       S_IWUSR, NULL, mv_eth_port_store);
 static DEVICE_ATTR(pnc,		S_IWUSR, NULL, mv_eth_port_store);
+static DEVICE_ATTR(skb,         S_IWUSR, NULL, mv_eth_port_store);
 static DEVICE_ATTR(tag,		S_IWUSR, NULL, mv_eth_port_store);
 
 static DEVICE_ATTR(etypeDsaMod,	S_IWUSR, NULL, mv_eth_port_store);
@@ -257,11 +262,8 @@ static DEVICE_ATTR(regRead,       S_IWUSR, NULL, mv_eth_reg_store);
 static DEVICE_ATTR(regWrite,      S_IWUSR, NULL, mv_eth_reg_store);
 
 static struct attribute *mv_eth_attrs[] = {
-	&dev_attr_addrDec.attr,
 	&dev_attr_help.attr,
-#ifdef CONFIG_MV_ETH_DEBUG_CODE
-	&dev_attr_debug.attr,
-#endif
+	&dev_attr_addrDec.attr,
 	&dev_attr_port.attr,
 	&dev_attr_cntrs.attr,
 	&dev_attr_netdev.attr,
@@ -269,11 +271,15 @@ static struct attribute *mv_eth_attrs[] = {
 	&dev_attr_dropCntrs.attr,
 	&dev_attr_stats.attr,
 	&dev_attr_pnc.attr,
+	&dev_attr_skb.attr,
 	&dev_attr_tag.attr,
 	&dev_attr_etypeDsaMod.attr,
 	&dev_attr_etypeDsa.attr,
 	&dev_attr_regRead.attr,
 	&dev_attr_regWrite.attr,
+#ifdef CONFIG_MV_ETH_DEBUG_CODE
+	&dev_attr_debug.attr,
+#endif
 	NULL
 };
 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c
index 2d8537b..376a4af 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c
@@ -66,7 +66,6 @@ static int mv_eth_start(struct net_device *dev)
 	netif_carrier_off(dev);
 	/* Stop the TX queue - it will be enabled upon PHY status change after link-up interrupt/timer */
 
-	printk(KERN_NOTICE "%s: mv_eth_start\n", dev->name);
 	netif_tx_stop_all_queues(dev);
 
 	/* fill rx buffers, start rx/tx activity, set coalescing */
@@ -144,7 +143,6 @@ int mv_eth_stop(struct net_device *dev)
 
 	/* stop upper layer */
 	netif_carrier_off(dev);
-	printk(KERN_NOTICE "%s: mv_eth_stop\n", dev->name);
 	netif_tx_stop_all_queues(dev);
 
 	/* stop tx/rx activity, mask all interrupts, relese skb in rings,*/
-- 
1.7.5.4

