From ab4ef495764b17d0f2475bf735f56ea817d4a51c Mon Sep 17 00:00:00 2001
From: Eran Ben-Avi <benavi@marvell.com>
Date: Thu, 11 Jul 2013 18:07:48 +0300
Subject: [PATCH 0806/1825] KW2: Add mv_sata driver to build-system and adjust
 SATA code to 3.4.25 kernel.

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 033c9701cc7fffaebd2ecff18bd1a8c0c71ac092

Change-Id: Ib1203eb23ca825490d7e61363508884495eb52eb
Signed-off-by: Grzegorz Jaszczyk <jaz@semihalf.com>
Signed-off-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_sata/mvLinuxIalHt.c          |    6 +++---
 .../mv_drivers_lsp/mv_sata/mvLinuxIalHt.h          |    7 +++++--
 drivers/scsi/Makefile                              |    1 +
 3 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/arch/arm/plat-feroceon/mv_drivers_lsp/mv_sata/mvLinuxIalHt.c b/arch/arm/plat-feroceon/mv_drivers_lsp/mv_sata/mvLinuxIalHt.c
index 237ac52..f9fc11d 100644
--- a/arch/arm/plat-feroceon/mv_drivers_lsp/mv_sata/mvLinuxIalHt.c
+++ b/arch/arm/plat-feroceon/mv_drivers_lsp/mv_sata/mvLinuxIalHt.c
@@ -1272,7 +1272,7 @@ int mv_ial_ht_ioctl(struct scsi_device *scsidev, int cmd, void __user *arg)
  *  Returns:        Status code.
  *
  ****************************************************************/
-int mv_ial_ht_queuecommand (struct scsi_cmnd * SCpnt, void (*done) (struct scsi_cmnd *))
+int mv_ial_ht_queuecommand_lck (struct scsi_cmnd * SCpnt, void (*done) (struct scsi_cmnd *))
 {
     IAL_ADAPTER_T   *pAdapter = MV_IAL_ADAPTER(SCpnt->device->host);
     MV_SATA_ADAPTER *pMvSataAdapter;
@@ -1982,7 +1982,7 @@ static int mv_ial_ht_slave_configure (struct scsi_device* pDevs)
             pDevice->use_10_for_ms = 1;
             scsi_adjust_queue_depth(pDevice, 0, 1);
 //                pHost->scsihost->max_cmd_len = 12;
-	    blk_queue_max_sectors(pDevice->request_queue, 256);
+	    blk_limits_max_hw_sectors(&pDevice->request_queue->limits, 256);
         }
         else
         {
@@ -2002,7 +2002,7 @@ static int mv_ial_ht_slave_configure (struct scsi_device* pDevs)
 #ifdef MV_SUPPORT_1MBYTE_IOS
             if(pHost->pAdapter->ataScsiAdapterExt->ataDriveData[pHost->channelIndex][pDevice->id].identifyInfo.LBA48Supported == MV_TRUE)
 	    {
-	        blk_queue_max_sectors(pDevice->request_queue, 2048);
+	        blk_limits_max_hw_sectors(&pDevice->request_queue->limits, 2048);
 	        mvLogMsg(MV_IAL_LOG_ID, MV_DEBUG_ERROR, "[%d %d %d]: set device max sectors to 2048 \n",
 	            pHost->pAdapter->mvSataAdapter.adapterId,
                     pHost->channelIndex, pDevice->id);
diff --git a/arch/arm/plat-feroceon/mv_drivers_lsp/mv_sata/mvLinuxIalHt.h b/arch/arm/plat-feroceon/mv_drivers_lsp/mv_sata/mvLinuxIalHt.h
index b387784..cee13bf 100644
--- a/arch/arm/plat-feroceon/mv_drivers_lsp/mv_sata/mvLinuxIalHt.h
+++ b/arch/arm/plat-feroceon/mv_drivers_lsp/mv_sata/mvLinuxIalHt.h
@@ -79,7 +79,7 @@ extern int mv_ial_ht_detect (Scsi_Host_Template *);
 typedef struct scsi_host_template Scsi_Host_Template;
 #endif
 extern int mv_ial_ht_release (struct Scsi_Host *);
-extern int mv_ial_ht_queuecommand (struct scsi_cmnd *, void (*done) (struct scsi_cmnd *));
+extern int mv_ial_ht_queuecommand_lck (struct scsi_cmnd * SCpnt, void (*done) (struct scsi_cmnd *));
 extern int mv_ial_ht_bus_reset (struct scsi_cmnd *);
 extern int mv_ial_ht_abort(struct scsi_cmnd *SCpnt);
 extern int mv_ial_ht_ioctl(struct scsi_device *, int, void __user *);
@@ -103,6 +103,10 @@ extern int mv_ial_ht_ioctl(struct scsi_device *, int, void __user *);
 #define MRVL_SATA_BOUNDARY_MASK (MRVL_SATA_BUFF_BOUNDARY - 1)
 
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,0)
+
+#define init_MUTEX(sem)		sema_init(sem, 1)
+static DEF_SCSI_QCMD(mv_ial_ht_queuecommand)
+
 #define mvSata                                                          \
 {                                                                           \
     module:     THIS_MODULE,\
@@ -124,7 +128,6 @@ extern int mv_ial_ht_ioctl(struct scsi_device *, int, void __user *);
     cmd_per_lun:        MV_SATA_SW_QUEUE_SIZE,           /*cmd_per_lun*/     \
     unchecked_isa_dma:  0,                              /*32-Bit Busmaster*/\
     emulated:           1,                      /* not real scsi adapter */ \
-    support_scattered_spinup:           1,                      /* support_scattered_spinup */ \
     use_clustering:     ENABLE_CLUSTERING               /*use_clustering*/  \
 }
 #else
diff --git a/drivers/scsi/Makefile b/drivers/scsi/Makefile
index 1aad08e..9429ef5 100644
--- a/drivers/scsi/Makefile
+++ b/drivers/scsi/Makefile
@@ -149,6 +149,7 @@ obj-$(CONFIG_HYPERV_STORAGE)	+= hv_storvsc.o
 
 obj-$(CONFIG_ARM)		+= arm/
 
+obj-$(CONFIG_SCSI_MVSATA)	+= ../../arch/arm/plat-feroceon/mv_drivers_lsp/mv_sata/
 obj-$(CONFIG_CHR_DEV_ST)	+= st.o
 obj-$(CONFIG_CHR_DEV_OSST)	+= osst.o
 obj-$(CONFIG_BLK_DEV_SD)	+= sd_mod.o
-- 
1.7.5.4

