From eec2c8afaba6bb2103a398331ee5fc89676b16b8 Mon Sep 17 00:00:00 2001
From: Hanna Hawa <hannah@marvell.com>
Date: Mon, 17 Feb 2014 22:48:38 +0200
Subject: [PATCH 1389/1825] alp: eth complex: added support to configure SMI
 source for Integ. PHYs (ALP-A0)

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 9f88d7e03e5d8b0befd28fd6a02e8369b17dc7d1

	Added support to configure SMI source for Gphy ports.
	This change relevant for ALP-A0 SoC's

Change-Id: I805e0bc5140362522c5aa540975dddad0dbbdb7a
Signed-off-by: Hanna Hawa <hannah@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5741
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c    |   24 ++++++++++++++++++++
 .../avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h    |    4 +++
 2 files changed, 28 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
index 22c7f9f..d76b73e 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.c
@@ -71,6 +71,25 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "pp2/gmac/mvEthGmacRegs.h"
 #include "pp2/gbe/mvPp2Gbe.h"
 
+static void mvEthComplexGphyPortSmiSrcSet(MV_U32 phy, MV_U32 src)
+{
+	MV_U32 reg;
+	/* In A0 added Phy Smi source configuration for ports 0 and 3.
+	** In Zx, only Phy Smi source for 1,2 are configurable, but no
+	** need to modify the default values. */
+	if (mvCtrlRevGet() <= MV_88F66X0_Z3_ID)
+		return;
+
+	reg = MV_REG_READ(MV_ETHCOMP_CTRL_REG);
+	reg &= ~ETHCC_GBE_PHY_PORT_SMI_SRC_MASK(phy);
+
+	src <<= ETHCC_GBE_PHY_PORT_SMI_SRC_OFFSET(phy);
+	src &= ETHCC_GBE_PHY_PORT_SMI_SRC_MASK(phy);
+
+	reg |= src;
+
+	MV_REG_WRITE(MV_ETHCOMP_CTRL_REG, reg);
+}
 static void mvEthComplexGbeClockControlSet(void)
 {
 	MV_U32 reg;
@@ -359,6 +378,9 @@ static void mvEthComplexMacToGbePhy(MV_U32 port, MV_U32 phy, MV_U32 phyAddr)
 	mvEthComplexGbePhySrcSet(phy, 0x0);
 	mvEthComplexGbePortSrcSet(port, 0x2);
 
+	/* Set SMI source for PHY: 0x0 = MAC is smi master, 0x1 = Switch is smi master */
+	mvEthComplexGphyPortSmiSrcSet(phy, 0x0);
+
 	if (port == 0)
 		mvEthComplexSwPortSrcSet(6, 0x0);
 
@@ -392,6 +414,8 @@ static void mvEthComplexSwPortToGbePhy(MV_U32 swPort, MV_U32 phy)
 		mvEthComplexSwPortSrcSet(swPort, 0x1);
 		mvEthComplexGbePhySrcSet(phy, 0x1);
 	}
+	/* Set SMI source for PHY: 0x0 = MAC is smi master, 0x1 = Switch is smi master */
+	mvEthComplexGphyPortSmiSrcSet(phy, 0x1);
 	mvEthComplexGbePhyResetSet(MV_FALSE);
 	mvEthComplexGbePhyPowerCycle(phy);
 }
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h
index 290003f..01199ca 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEthCompLib.h
@@ -106,6 +106,10 @@ enum mvSwPortSrc {
 #define     ETHCC_GBE_MAC_SRC_OFFSET(port)		(port == 0 ? 10 : (port == 1 ? 12 : 10))
 #define     ETHCC_GBE_MAC_SRC_MASK(port)		(0x3 << ETHCC_GBE_MAC_SRC_OFFSET(port))
 
+#define     ETHCC_GBE_PHY_PORT_SMI_SRC_OFFSET(port)	(port == 0 ? 20 : (port == 1 ? 15 : \
+							(port == 2 ? 16 : (port == 3 ? 21 : 4))))
+#define     ETHCC_GBE_PHY_PORT_SMI_SRC_MASK(port)	(0x1 << ETHCC_GBE_PHY_PORT_SMI_SRC_OFFSET(port))
+
 #define     ETHCC_GBE_PHY_PORT_SRC_OFFSET(phy)		((phy >= 0 && phy <= 3) ? 14 + phy : 14)
 #define     ETHCC_GBE_PHY_PORT_SRC_MASK(phy)		(0x1 << ETHCC_GBE_PHY_PORT_SRC_OFFSET(phy))
 
-- 
1.7.5.4

