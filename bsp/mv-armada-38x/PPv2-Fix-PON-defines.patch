From e9ab81ac3e4008cf070298f895f9bf4ef8a1ee94 Mon Sep 17 00:00:00 2001
From: Yoni Farhadian <yonif@marvell.com>
Date: Wed, 19 Jun 2013 15:31:22 +0300
Subject: [PATCH 0718/1825] PPv2: Fix PON defines

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 57cc5d6d9aca4071f9c6a8bec1e70c22f71a5a0e

Change-Id: I12e39d5703f28da780f1c58e84c3cb0df4181fcb
Signed-off-by: Yoni Farhadian <yonif@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/2290
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-by: Star_Automation <star@marvell.com>
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h       |    1 +
 arch/arm/mach-avantalp/core.c                      |    2 +
 arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c        |    3 --
 arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/Kconfig |   11 ++------
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c    |    4 +-
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c    |    2 +-
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |   26 ++++++++++----------
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h      |    4 +-
 arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c     |    2 +-
 arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h     |    4 +-
 .../arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c |    2 +-
 .../arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c |    2 -
 12 files changed, 28 insertions(+), 35 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
index 4a16ed0..45e5b1a 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -118,6 +118,7 @@ extern "C" {
 #define GOP_REG_BASE(port)                      (MV_ETH_BASE_ADDR + 0x4000 + ((port) / 2) * 0x3000 + ((port) % 2) * 0x1000)
 #define MV_PON_REGS_OFFSET                      (MV_ETH_BASE_ADDR + 0x8000)
 
+#define MV_PON_EXIST
 #define MV_ETH_MAX_TCONT                        16
 #define MV_PON_PORT_ID                          7
 #define MV_ETH_RXQ_TOTAL_NUM                    32
diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index e895b28..7cb2072 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -664,7 +664,9 @@ static void __init eth_init(void)
 	mv_pp2_giga_pdev_register(&mv_pp2_ge0_plat);
 	mv_pp2_giga_pdev_register(&mv_pp2_ge1_plat);
 	mv_pp2_giga_pdev_register(&mv_pp2_ge2_plat);
+#ifdef CONFIG_MV_INCLUDE_PON
 	mv_pp2_giga_pdev_register(&mv_pp2_ge3_plat);
+#endif
 }
 
 #endif /* CONFIG_MV_ETHERNET */
diff --git a/arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c b/arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c
index 1f4b40a..d17ccc1 100644
--- a/arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c
+++ b/arch/arm/mach-avantalp/mv_hal_if/mvSysPp2.c
@@ -117,10 +117,7 @@ void 	mvSysPp2Init(void)
 				(unsigned int)addrWinMap[i].addrWin.size, addrWinMap[i].targetId);
 	}
 	halData.maxPort = mvCtrlEthMaxPortGet();
-
-#ifdef CONFIG_MV_PON
 	halData.maxTcont = MV_ETH_MAX_TCONT;
-#endif /* CONFIG_MV_PON */
 
 	halData.pClk = mvCpuPclkGet();
 	halData.tClk = mvBoardTclkGet();
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/Kconfig b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/Kconfig
index 5002cd3..1bad5e9 100755
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/Kconfig
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/Kconfig
@@ -661,22 +661,17 @@ config MV_ETH_EXTRA_BUF_NUM
 endmenu
 
 menu "PON support for Network driver"
-
-config MV_PON
-        bool "PON support"
-        depends on MV_ETH_PP2 && MV_INCLUDE_PON
-        ---help---
-        Choose this option to support PON port in Marvell network driver
+	depends on MV_INCLUDE_PON
 
 config MV_PON_TXP_DEF
         int "Default T-CONT to send local generated packets"
-        depends on MV_PON
+        depends on MV_INCLUDE_PON
         default 0
         ---help---
 
 config MV_PON_TXQ_DEF
         int "Default TXQ to send local generated packets"
-        depends on MV_PON
+        depends on MV_INCLUDE_PON
         default 0
         ---help---
 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c
index 0372049..7860893 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_tool.c
@@ -411,10 +411,10 @@ u32 mv_eth_tool_get_link(struct net_device *netdev)
 		return -EOPNOTSUPP;
 	}
 
-#ifdef CONFIG_MV_PON
+#ifdef CONFIG_MV_INCLUDE_PON
 	if (MV_PON_PORT(pp->port))
 		return mv_pon_link_status();
-#endif /* CONFIG_MV_PON */
+#endif
 	return mvEthPortIsLinkUp(pp->port);
 }
 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c
index 61e247b..dfca0d0 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_ethernet.c
@@ -240,7 +240,7 @@ static int mv_eth_set_mac_addr_internals(struct net_device *dev, void *addr)
 	for (i = 0; i < 6; i++)
 		dev->dev_addr[i] = mac[i];
 
-#ifdef CONFIG_MV_PON
+#ifdef CONFIG_MV_INCLUDE_PON
 	/* Update PON module */
 	if (MV_PON_PORT(priv->port))
 		mv_pon_set_mac_addr(addr);
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index 5cc1bb0..7a4b237 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -953,10 +953,10 @@ void mv_eth_link_status_print(int port)
 	MV_ETH_PORT_STATUS link;
 
 	mvEthLinkStatus(port, &link);
-#ifdef CONFIG_MV_PON
+#ifdef CONFIG_MV_INCLUDE_PON
 	if (MV_PON_PORT(port))
 		link.linkup = mv_pon_link_status();
-#endif /* CONFIG_MV_PON */
+#endif
 
 	if (link.linkup) {
 		printk(KERN_CONT "link up");
@@ -2533,11 +2533,11 @@ void mv_eth_link_tasklet(unsigned long data)
 
 static bool mv_eth_link_status(struct eth_port *pp)
 {
-#ifdef CONFIG_MV_PON
+#ifdef CONFIG_MV_INCLUDE_PON
 	if (MV_PON_PORT(pp->port))
 		return mv_pon_link_status();
 	else
-#endif /* CONFIG_MV_PON */
+#endif
 		return mvEthPortIsLinkUp(pp->port);
 }
 
@@ -3280,7 +3280,7 @@ void mv_eth_config_show(void)
 {
 	printk(KERN_ERR "  o %d Giga ports supported\n", mv_eth_ports_num);
 
-#ifdef CONFIG_MV_PON
+#ifdef CONFIG_MV_INCLUDE_PON
 	printk(KERN_ERR "  o xPON port is #%d: - %d of %d TCONTs supported\n",
 		MV_PON_LOGIC_PORT_GET(), CONFIG_MV_PON_TCONTS, MV_ETH_MAX_TCONT);
 #endif
@@ -3552,7 +3552,7 @@ int mv_eth_start_internals(struct eth_port *pp, int mtu)
 
 	if (!MV_PON_PORT(pp->port))
 		mvEthMaxRxSizeSet(pp->port, RX_PKT_SIZE(mtu));
-#ifdef CONFIG_MV_PON
+#ifdef CONFIG_MV_INCLUDE_PON
 	else
 		mv_pon_mtu_config(RX_PKT_SIZE(mtu));
 #endif
@@ -3677,7 +3677,7 @@ int mv_eth_start_internals(struct eth_port *pp, int mtu)
 	clear_bit(MV_ETH_F_LINK_UP_BIT, &(pp->flags));
 	if (!MV_PON_PORT(pp->port))
 		status = mvPp2PortEnable(pp->port);
-#ifdef CONFIG_MV_PON
+#ifdef CONFIG_MV_INCLUDE_PON
 	else
 		status = mv_pon_enable();
 #endif
@@ -3743,7 +3743,7 @@ int mv_eth_stop_internals(struct eth_port *pp)
 		printk(KERN_ERR "GbE port %d: ethPortDisable failed\n", pp->port);
 		goto error;
 	}
-#ifdef CONFIG_MV_PON
+#ifdef CONFIG_MV_INCLUDE_PON
 	else if (mv_pon_disable() != MV_OK) {
 		printk(KERN_ERR "PON port %d: mv_pon_disable failed\n", pp->port);
 		goto error;
@@ -3851,7 +3851,7 @@ int mv_eth_change_mtu_internals(struct net_device *dev, int mtu)
 
 	if (!MV_PON_PORT(pp->port))
 		mvEthMaxRxSizeSet(pp->port, pkt_size);
-#ifdef CONFIG_MV_PON
+#ifdef CONFIG_MV_INCLUDE_PON
 	else
 		mv_pon_mtu_config(pkt_size);
 #endif
@@ -4167,7 +4167,7 @@ static int mv_eth_priv_init(struct eth_port *pp, int port)
 
 	mv_eth_port_config_parse(pp);
 
-#ifdef CONFIG_MV_PON
+#ifdef CONFIG_MV_INCLUDE_PON
 	if (MV_PON_PORT(port)) {
 		pp->tx_spec.flags |= MV_ETH_TX_F_MH;
 		pp->txp_num = CONFIG_MV_PON_TCONTS;
@@ -4175,7 +4175,7 @@ static int mv_eth_priv_init(struct eth_port *pp, int port)
 		for_each_possible_cpu(i)
 			pp->cpu_config[i]->txq = CONFIG_MV_PON_TXQ_DEF;
 	}
-#endif /* CONFIG_MV_PON */
+#endif
 
 	for_each_possible_cpu(cpu) {
 		cpuCtrl = pp->cpu_config[cpu];
@@ -4771,7 +4771,7 @@ int mv_eth_all_ports_cleanup(void)
 	return 0;
 }
 
-#ifdef CONFIG_MV_PON
+#ifdef CONFIG_MV_INCLUDE_PON
 /* Used by PON module */
 struct mv_netdev_notify_ops mv_netdev_callbacks;
 
@@ -4864,7 +4864,7 @@ MV_STATUS mv_pon_disable(void)
 
 	return MV_OK;
 }
-#endif /* CONFIG_MV_PON */
+#endif /* CONFIG_MV_INCLUDE_PON */
 
 /* Support for platform driver */
 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h
index 7f6241c..3c7b5dc 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h
@@ -812,13 +812,13 @@ struct mv_netdev_notify_ops {
 void mv_eth_ext_mac_ops_register(int port_id,
 		struct mv_eth_ext_mac_ops *extern_mac_ops, struct mv_netdev_notify_ops **netdev_ops);
 
-#ifdef CONFIG_MV_PON
+#ifdef CONFIG_MV_INCLUDE_PON
 MV_BOOL mv_pon_link_status(void);
 MV_STATUS mv_pon_mtu_config(MV_U32 maxEth);
 MV_STATUS mv_pon_set_mac_addr(void *addr);
 MV_STATUS mv_pon_enable(void);
 MV_STATUS mv_pon_disable(void);
-#endif /* CONFIG_MV_PON */
+#endif
 
 #ifdef CONFIG_MV_ETH_TX_SPECIAL
 void        mv_eth_tx_special_check_func(int port, int (*func)(int port, struct net_device *dev,
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c
index 4786e04..83dbc80 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.c
@@ -871,7 +871,7 @@ void *mvPp2PortInit(int port, int firstRxq, int numRxqs, void *osHandle)
 	pCtrl->osHandle = osHandle;
 
 	/* associate TXQs to this port */
-#ifdef CONFIG_MV_PON
+#ifdef CONFIG_MV_INCLUDE_PON
 	pCtrl->txpNum = MV_PON_PORT(port) ? CONFIG_MV_PON_TCONTS : 1;
 #else
 	pCtrl->txpNum = 1;
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h
index 10a2ca0..cac5152 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h
@@ -207,7 +207,7 @@ static INLINE int mvPp2LogicRxqToPhysRxq(int port, int rxq)
 
 
 /************************** TXQ: Physical - Logical Mapping ******************************/
-#ifdef CONFIG_MV_PON
+#ifdef MV_PON_EXIST
 
 #define MV_PON_LOGIC_PORT_GET()			(mvPp2HalData.maxPort - 1)
 #define MV_PON_PORT(p)				((p) == MV_PON_LOGIC_PORT_GET())
@@ -238,7 +238,7 @@ static INLINE int mvPp2LogicRxqToPhysRxq(int port, int rxq)
 #define MV_PPV2_TXQ_LOGICAL_PORT(physTxq)	(physTxq / MV_ETH_MAX_TXQ)
 #define MV_PPV2_TXQ_LOGICAL_TXP(physTxq)	0
 
-#endif /* CONFIG_MV_PON */
+#endif /* MV_PON_EXIST */
 
 #define MV_PPV2_TXQ_LOGICAL_TXQ(physTxq)	(physTxq % MV_ETH_MAX_TXQ)
 #define MV_PP2_TXQ_TOTAL_NUM			(MV_PP2_TOTAL_TXP_NUM * MV_ETH_MAX_TXQ)
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c
index 27d1c2b..c59ea77 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeDebug.c
@@ -501,7 +501,7 @@ void mvPp2DropCntrs(int port)
 	mvPp2PrintReg(MV_PP2_CLS_DROP_REG(MV_PPV2_PORT_PHYS(port)), "MV_PP2_CLS_DROP_REG");
 
 	if (MV_PON_PORT(port)) {
-#ifdef CONFIG_MV_PON
+#ifdef CONFIG_MV_INCLUDE_PON
 		for (i = 0; i < CONFIG_MV_PON_TCONTS; i++) {
 			mvPp2RegPrint2(MV_PP2_TX_EARLY_DROP_REG(i), "MV_PP2_TX_EARLY_DROP_REG", i);
 			mvPp2RegPrint2(MV_PP2_TX_DESC_DROP_REG(i), "MV_PP2_TX_DESC_DROP_REG", i);
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
index 149bde1..2667e85 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
@@ -635,10 +635,8 @@ void mvEthMibCountersClear(int port)
 {
 	int i;
 
-#if defined(CONFIG_MV_PON) && !defined(MV_PON_MIB_SUPPORT)
 	if (MV_PON_PORT(port))
 		return;
-#endif /* CONFIG_MV_PON && !MV_PON_MIB_SUPPORT */
 
 	/* Perform dummy reads from MIB counters */
 	for (i = ETH_MIB_GOOD_OCTETS_RECEIVED_LOW; i < ETH_MIB_LATE_COLLISION; i += 4)
-- 
1.7.5.4

