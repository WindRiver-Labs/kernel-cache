From 11e7d39de8e9801b7252b3793fed6250d060fed3 Mon Sep 17 00:00:00 2001
From: Uri Eliyahu <uriel@marvell.com>
Date: Wed, 12 Feb 2014 17:39:53 +0200
Subject: [PATCH 1353/1825] pp2: add rxWeight sysfs command to rx sysfs

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 65ca1e936cbf33f4fc509aa476731f141d512830

Change-Id: I0b61ddb14fbd29134303a9d06f2e4db4d84a1f62
Signed-off-by: Uri Eliyahu <uriel@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5627
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Tested-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_pp2/net_dev/mv_eth_rx_sysfs.c               |    5 +++++
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |    6 ++++++
 2 files changed, 11 insertions(+), 0 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_rx_sysfs.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_rx_sysfs.c
index da6aaa4..892bb93 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_rx_sysfs.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_eth_rx_sysfs.c
@@ -43,6 +43,7 @@ static ssize_t mv_eth_help(char *b)
 
 	o += sprintf(b+o, "cat                    rxDmaRegs   - show RX DMA registers\n");
 	o += sprintf(b+o, "echo [p]             > rxFifoRegs  - show RX FIFO registers for port <p>\n");
+	o += sprintf(b+o, "echo [p] v           > rxWeight    - set weight for poll function, <v> - weight [0..255]\n");
 	o += sprintf(b+o, "echo [rxq]           > gRxqRegs    - show RXQ registers for global <rxq>\n");
 #ifdef CONFIG_MV_ETH_PP2_1
 	o += sprintf(b+o, "echo [p] [rxq]       > rxqCounters - show RXQ counters for <p/rxq>.\n");
@@ -99,6 +100,8 @@ static ssize_t mv_eth_port_store(struct device *dev,
 		mvPp2PortRxqRegs(p, v);
 	} else if (!strcmp(name, "rxFifoRegs")) {
 		mvPp2RxFifoRegs(p);
+	} else if (!strcmp(name, "rxWeight")) {
+		mv_eth_ctrl_set_poll_rx_weight(p, v);
 	} else if (!strcmp(name, "rxqSize")) {
 		mv_eth_ctrl_rxq_size_set(p, v, a);
 	} else if (!strcmp(name, "rxqCounters")) {
@@ -158,6 +161,7 @@ static DEVICE_ATTR(rxqShow,     S_IWUSR, NULL, mv_eth_port_store);
 static DEVICE_ATTR(gRxqRegs,    S_IWUSR, NULL, mv_eth_port_store);
 static DEVICE_ATTR(pRxqRegs,    S_IWUSR, NULL, mv_eth_port_store);
 static DEVICE_ATTR(rxFifoRegs,  S_IWUSR, NULL, mv_eth_port_store);
+static DEVICE_ATTR(rxWeight,	S_IWUSR, NULL, mv_eth_port_store);
 static DEVICE_ATTR(rxqSize,   	S_IWUSR, NULL, mv_eth_port_store);
 static DEVICE_ATTR(mhRxSpec,	S_IWUSR, NULL, mv_eth_rx_hex_store);
 static DEVICE_ATTR(prefetch,	S_IWUSR, NULL, mv_eth_port_store);
@@ -170,6 +174,7 @@ static struct attribute *mv_eth_attrs[] = {
 	&dev_attr_gRxqRegs.attr,
 	&dev_attr_pRxqRegs.attr,
 	&dev_attr_rxFifoRegs.attr,
+	&dev_attr_rxWeight.attr,
 	&dev_attr_rxqSize.attr,
 	&dev_attr_mhRxSpec.attr,
 	&dev_attr_prefetch.attr,
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index 5dc3d07..233bb3d 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -4039,6 +4039,12 @@ oom:
 /* Show network driver configuration */
 void mv_eth_config_show(void)
 {
+#ifdef CONFIG_MV_ETH_PP2_1
+	pr_info("  o	PPv2.1 Giga driver\n");
+#else
+	pr_info("  o	PPv2.0 Giga driver\n");
+#endif
+
 	printk(KERN_ERR "  o %d Giga ports supported\n", mv_eth_ports_num);
 
 #ifdef CONFIG_MV_INCLUDE_PON
-- 
1.7.5.4

