From a5129d36cbede2971feb518631fc991535aecbd2 Mon Sep 17 00:00:00 2001
From: xigu <xigu@marvell.com>
Date: Wed, 19 Mar 2014 14:48:48 +0200
Subject: [PATCH 1508/1825] alp: pon: support internal PON dying gasp

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 376f7b9f469c5809ead987891a845d827efc53bc

Change-Id: Ieae74a82b7e56e2149e13870e848883adb3d67d4
Signed-off-by: xigu <xigu@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/6524
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Tested-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvSpec.h     |    2 +-
 .../mv_drivers_lsp/mv_pon/core/epon/eponOnuInit.c  |    8 +++++
 .../mv_drivers_lsp/mv_pon/core/gpon/gponOnuInit.c  |    8 +++++
 arch/arm/plat-armada/mv_hal/pon/mvPonOnuMac.c      |   34 ++++++++++++++++++++
 arch/arm/plat-armada/mv_hal/pon/mvPonOnuMac.h      |   10 +++++-
 arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.c     |    1 +
 arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.h     |   17 +++++-----
 7 files changed, 70 insertions(+), 10 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
index 89c398a..83bd3bb 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
@@ -118,7 +118,7 @@
 #define DB_88F6660_MPP16_23             0x00000022
 #define DB_88F6660_MPP24_31             0x22222222  /* RGMII-1*/
 #define DB_88F6660_MPP32_39             0x04422222  /* GE_SMI ,GE1, PON */
-#define DB_88F6660_MPP40_47             0x22100220  /* PON , GE0 */
+#define DB_88F6660_MPP40_47             0x22100020  /* PON , GE0 */
 #define DB_88F6660_MPP48_55             0x22222222  /* GE0*/
 #define DB_88F6660_MPP56_63             0x44224422  /* UART1, GE0 , LED */
 #define DB_88F6660_MPP64_67             0x004
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuInit.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuInit.c
index 57ed7ea..08a4400 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuInit.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/epon/eponOnuInit.c
@@ -860,6 +860,14 @@ MV_STATUS onuEponInit(S_EponIoctlInit *ioctlInit)
 			   "ERROR: (%s:%d) mvOnuPonMacDgInterruptEn\n", __FILE_DESC__, __LINE__);
 		return status;
 	}
+	/* enable onu dying gasp */
+	status = mvOnuEponMacInternalDyingGaspSet(DYINGASP_INTERNAL_ENABLE, DYINGASP_INTERNAL_ONDIE,
+		DYINGASP_INTERNAL_VOLTAGE_1V);
+	if (status != MV_OK) {
+		mvPonPrint(PON_PRINT_ERROR, PON_INIT_MODULE,
+			   "ERROR: (%s:%d) mvOnuEponMacInternalDyingGaspSet\n", __FILE_DESC__, __LINE__);
+		return status;
+	}
 #endif
 #endif  /* PON_FPGA */
 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuInit.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuInit.c
index ee7315c..06781c6 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuInit.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuInit.c
@@ -1293,6 +1293,14 @@ MV_STATUS onuGponStart(S_GponIoctlInfo *onuInit)
 			   "ERROR: (%s:%d) Enable Dying Gasp interrupt mask\n", __FILE_DESC__, __LINE__);
 		return rcode;
 	}
+	/* enable onu dying gasp */
+	rcode = mvOnuEponMacInternalDyingGaspSet(DYINGASP_INTERNAL_ENABLE, DYINGASP_INTERNAL_ONDIE,
+			DYINGASP_INTERNAL_VOLTAGE_1V);
+	if (rcode != MV_OK) {
+		mvPonPrint(PON_PRINT_ERROR, PON_INIT_MODULE,
+			   "ERROR: (%s:%d) Enable Dying Gasp\n", __FILE_DESC__, __LINE__);
+		return rcode;
+	}
 #endif
 #endif  /* PON_FPGA */
 
diff --git a/arch/arm/plat-armada/mv_hal/pon/mvPonOnuMac.c b/arch/arm/plat-armada/mv_hal/pon/mvPonOnuMac.c
index 6d35737..eab45f1 100755
--- a/arch/arm/plat-armada/mv_hal/pon/mvPonOnuMac.c
+++ b/arch/arm/plat-armada/mv_hal/pon/mvPonOnuMac.c
@@ -4535,6 +4535,40 @@ MV_STATUS mvOnuGponMacDyingGaspConfigSet(MV_U32 id,
 
 /*******************************************************************************
 **
+**  mvOnuEponMacInternalDyingGaspSet
+**  ____________________________________________________________________________
+**
+**  DESCRIPTION: The function set internal dying gasp
+**
+**  PARAMETERS:  MV_U32 enable
+**               MV_U32 onDie
+**               MV_U32 voltage
+**
+**  OUTPUTS:     None
+**
+**  RETURNS:     MV_OK or MV_ERROR
+**
+*******************************************************************************/
+MV_STATUS mvOnuEponMacInternalDyingGaspSet(MV_U32 enable, MV_U32 onDie, MV_U32 voltage)
+{
+	MV_STATUS status;
+	MV_U32 value;
+
+	status = asicOntMiscRegRead(mvAsicReg_PON_INTERNAL_DG, &value, 0);
+	if (status == MV_OK) {
+		value &= ~0x67;
+		value |= ((enable & 0x1) << 5);
+		value |= ((onDie & 0x1) << 6);
+		value |= ((voltage & 0x7) << 0);
+		return asicOntMiscRegWrite(mvAsicReg_PON_INTERNAL_DG, value, 0);
+	}
+
+	return status;
+}
+
+
+/*******************************************************************************
+**
 **  mvOnuGponMacXvrReset
 **  ____________________________________________________________________________
 **
diff --git a/arch/arm/plat-armada/mv_hal/pon/mvPonOnuMac.h b/arch/arm/plat-armada/mv_hal/pon/mvPonOnuMac.h
index 93ec25c..6deeca2 100755
--- a/arch/arm/plat-armada/mv_hal/pon/mvPonOnuMac.h
+++ b/arch/arm/plat-armada/mv_hal/pon/mvPonOnuMac.h
@@ -238,6 +238,13 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define GPON_TOD_INT_MODE_SFC_INTERRUPT     (1)
 #define GPON_TOD_INT_DEFAULT_WIDTH          (5)
 
+/* Internal dyinggasp option */
+#define DYINGASP_INTERNAL_ENABLE            (1)
+#define DYINGASP_INTERNAL_DISABLE           (0)
+#define DYINGASP_INTERNAL_ONDIE             (0)
+#define DYINGASP_INTERNAL_ONBOARD           (1)
+#define DYINGASP_INTERNAL_VOLTAGE_1V        (0x2)
+
 /* Typedefs
    ------------------------------------------------------------------------------*/
 typedef MV_STATUS (*MACTXPLOAMCTRFUNC)(MV_U8 msgId, MV_BOOL status);
@@ -481,6 +488,7 @@ MV_STATUS mvOnuGponMacIpgValidGet(MV_BOOL *enable);
 MV_STATUS mvOnuGponMacGemInit(void);
 MV_STATUS mvOnuGponMacPortIdValidSet(MV_U32 portId, MV_BOOL status);
 MV_BOOL   mvOnuGponMacPortIdValidGet(MV_U32 portId);
+MV_STATUS mvOnuEponMacInternalDyingGaspSet(MV_U32 enable, MV_U32 onDie, MV_U32 voltage);
 MV_STATUS mvOnuGponMacXvrReset(MV_U32 xvrType);
 MV_STATUS mvOnuGponMacXvrActivate(void);
 MV_STATUS mvOnuGponMacAsicVersionGet(MV_U32 *asicVer);
@@ -851,4 +859,4 @@ MV_STATUS mvOnuEponMacSerdesPuRxWrite(MV_U32 enable);
 MV_STATUS mvOnuPonMacDgInterruptEn(MV_U32 dgPol);
 MV_STATUS mvOnuPonMacDgInterruptDis(void);
 
-#endif /* _ONU_PON_MAC_H */
\ No newline at end of file
+#endif /* _ONU_PON_MAC_H */
diff --git a/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.c b/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.c
index 467cfe6..2842b6b 100755
--- a/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.c
+++ b/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.c
@@ -795,6 +795,7 @@ S_asicGlobalRegDb asicGlbDb[] =
 	[mvAsicReg_PON_DG_THRESHOLD]                      =  { mvAsicReg_PON_DG_THRESHOLD,                      0x18274,                         0x18274,  asicRW,     0x00000000,     0,      0,     0,      0,     "ONU Dying Gasp threshold"},
 #endif
 #endif
+	[mvAsicReg_PON_INTERNAL_DG]                       =  { mvAsicReg_PON_INTERNAL_DG,                       0x182E4,                         0x182E4,  asicRW,     0x0000007F,     0,      0,     0,      0,     "ONU internal Dying Gasp support"},
 	[mvAsicReg_PT_PATTERN_SELECT]                     =  { mvAsicReg_PT_PATTERN_SELECT,                     0xA2E54,                         0xA2E54,  asicRW,     0x00000007,     5,      0,     0,      0,     "PHY test pattern select"},
 	[mvAsicReg_PT_PATTERN_ENABLED]                    =  { mvAsicReg_PT_PATTERN_ENABLED,                    0xA2E54,                         0xA2E54,  asicRW,     0x00000001,     15,     0,     0,      0,     "PHY test pattern enabled"},
 	[mvAsicReg_PT_PATTERN_DATA]                       =  { mvAsicReg_PT_PATTERN_DATA,                       0xA2E6C,                         0xA2E6C,  asicRW,     0x000000FF,     0,      0,     0,      0,     "PHY test pattern data / user pattern [15:0]"},
diff --git a/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.h b/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.h
index 4a2791f..be68718 100755
--- a/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.h
+++ b/arch/arm/plat-armada/mv_hal/pon/mvPonOnuRegs.h
@@ -661,14 +661,15 @@ typedef enum {
 	mvAsicReg_PON_DG_CTRL_EN                           = 578,
 	mvAsicReg_PON_DG_CTRL_POLARITY                     = 579,
 	mvAsicReg_PON_DG_THRESHOLD                         = 580,
-	mvAsicReg_PT_PATTERN_SELECT                        = 581,
-	mvAsicReg_PT_PATTERN_ENABLED                       = 582,
-	mvAsicReg_PT_PATTERN_DATA                          = 583,
-	mvAsicReg_PT_PATTERN_USER_DATA_01                  = 584,
-	mvAsicReg_PT_PATTERN_USER_DATA_02                  = 585,
-	mvAsicReg_PT_PATTERN_USER_DATA_03                  = 586,
-	mvAsicReg_PT_PATTERN_USER_DATA_04                  = 587,
-	mvAsicReg_PT_PATTERN_USER_DATA_05                  = 588,
+	mvAsicReg_PON_INTERNAL_DG                          = 581,
+	mvAsicReg_PT_PATTERN_SELECT                        = 582,
+	mvAsicReg_PT_PATTERN_ENABLED                       = 583,
+	mvAsicReg_PT_PATTERN_DATA                          = 584,
+	mvAsicReg_PT_PATTERN_USER_DATA_01                  = 585,
+	mvAsicReg_PT_PATTERN_USER_DATA_02                  = 586,
+	mvAsicReg_PT_PATTERN_USER_DATA_03                  = 587,
+	mvAsicReg_PT_PATTERN_USER_DATA_04                  = 588,
+	mvAsicReg_PT_PATTERN_USER_DATA_05                  = 589,
 
 	mvAsicReg_GUNIT_TX_0_PKT_MOD_MAX_HEAD_SIZE_CFG     = 590,
 	mvAsicReg_GUNIT_TX_1_PKT_MOD_MAX_HEAD_SIZE_CFG     = 591,
-- 
1.7.5.4

