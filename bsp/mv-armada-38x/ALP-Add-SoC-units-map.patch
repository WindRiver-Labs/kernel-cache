From 7d7843400166e2cd0d7c5529cef54fc0a54eb04c Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Wed, 17 Apr 2013 11:11:25 +0300
Subject: [PATCH 0585/1825] ALP: Add SoC units map

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 345449bc2ab1fad51847e6a51bed0912043fc7e4

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: I65ba88643445b4badde33d5f7987e5e6c3c9e76b
Reviewed-on: http://vgitil04.il.marvell.com:8080/1583
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   63 ++++++++++++++++++++
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h        |    1 +
 arch/arm/mach-avantalp/core.c                      |    2 +-
 3 files changed, 65 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index e7432a6..d551951 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -149,6 +149,69 @@ MV_STATUS mvCtrlUpdatePexId(MV_VOID)
 
 #endif
 
+/* Avanta LP family linear id */
+#define MV_6660_INDEX		0
+#define MV_6650_INDEX		1
+#define MV_6610_INDEX		2
+#define MV_66xx_INDEX_MAX	3
+
+static MV_U32 mvCtrlDevIdIndexGet(MV_U32 devId)
+{
+	MV_U32 index;
+
+	switch (devId) {
+	case MV_6660_DEV_ID:
+		index = MV_6660_INDEX;
+		break;
+	case MV_6650_DEV_ID:
+		index = MV_6650_INDEX;
+		break;
+	case MV_6610_DEV_ID:
+		index = MV_6610_INDEX;
+		break;
+	default:
+		index = MV_6650_INDEX;
+	}
+
+	return index;
+}
+
+MV_UNIT_ID mvCtrlSocUnitNums[MAX_UNITS_ID][MV_66xx_INDEX_MAX] = {
+/*                           6660               6650            6610 */
+/* DRAM_UNIT_ID         */ { 1,                 1,              1, },
+/* PEX_UNIT_ID          */ { 2,                 1,              0, },
+/* ETH_GIG_UNIT_ID      */ { 2,                 2,              2, },
+/* USB_UNIT_ID          */ { 1,                 1,              0, },
+/* IDMA_UNIT_ID         */ { 0,                 0,              0, },
+/* XOR_UNIT_ID          */ { 2,                 2,              0, },
+/* SATA_UNIT_ID         */ { 2,                 0,              0, },
+/* TDM_32CH_UNIT_ID     */ { 1,                 1,              1, },
+/* UART_UNIT_ID         */ { 2,                 2,              2, },
+/* CESA_UNIT_ID         */ { 1,                 0,              0, },
+/* SPI_UNIT_ID          */ { 2,                 2,              2, },
+/* AUDIO_UNIT_ID        */ { 1,                 0,              0, },
+/* SDIO_UNIT_ID         */ { 1,                 0,              0, },
+/* TS_UNIT_ID           */ { 0,                 0,              0, },
+/* XPON_UNIT_ID         */ { 1,                 1,              1, },
+/* BM_UNIT_ID           */ { 1,                 1,              1, },
+/* PNC_UNIT_ID          */ { 1,                 1,              1, },
+/* I2C_UNIT_ID          */ { 2,                 1,              1, },
+};
+
+MV_U32 mvCtrlSocUnitInfoNumGet(MV_UNIT_ID unit)
+{
+	MV_U32 devId, devIdIndex;
+
+	if (unit >= MAX_UNITS_ID) {
+		mvOsPrintf("%s: Error: Wrong unit type (%u)\n", __func__, unit);
+		return 0;
+	}
+
+	devId = mvCtrlModelGet();
+	devIdIndex = mvCtrlDevIdIndexGet(devId);
+	return mvCtrlSocUnitNums[unit][devIdIndex];
+}
+
 /*******************************************************************************
 * mvCtrlEnvInit - Initialize Marvell controller environment.
 *
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
index 44eeca5..a429605 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
@@ -271,6 +271,7 @@ MV_STATUS mvCtrlUpdatePexId(MV_VOID);
 MV_BOOL mvCtrlIsValidSatR(MV_VOID);
 MV_BOOL mvCtrlIsEepromEnabled(MV_VOID);
 MV_STATUS mvCtrlBoardConfigGet(MV_U8 *tempVal);
+MV_U32 mvCtrlSocUnitInfoNumGet(MV_UNIT_ID unit);
 MV_STATUS mvCtrlEnvInit(MV_VOID);
 MV_U32    mvCtrlMppRegGet(MV_U32 mppGroup);
 
diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index 601182a..6857b7c 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -344,7 +344,7 @@ static void __init alp_init_i2c(void)
 	if (mvUnitMapIsMine(I2C0) == MV_TRUE)
 		platform_device_register(&alp_i2c0);
 
-	if (mvSocUnitInfoNumGet(I2C_UNIT_ID) >= 1 &&
+	if (mvCtrlSocUnitInfoNumGet(I2C_UNIT_ID) >= 1 &&
 	    mvUnitMapIsMine(I2C1) == MV_TRUE)
 		platform_device_register(&alp_i2c1);
 #endif
-- 
1.7.5.4

