From 93622e3f4751910a7734c60a4c3652b737549230 Mon Sep 17 00:00:00 2001
From: Shadi Ammouri <shadi@marvell.com>
Date: Wed, 20 Nov 2013 10:43:17 +0200
Subject: [PATCH 1158/1825] alp, uart: Port DW_APB UART patches from older
 LSPs

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 832b779420bae8b328b9cf6e2973f7d70cc3507e

	- Change ifdefs to cover all PLAT_ARMADA SoC's and
	  not only specific SoC's.
	- Fix ALP UART registeration code

Signed-off-by: Shadi Ammouri <shadi@marvell.com>

Change-Id: I9ea7414d835f4fda640d1ba2f8ee7910906a72a3
Reviewed-on: http://vgitil04.il.marvell.com:8080/4373
Reviewed-by: Igor Patrik <igorp@marvell.com>
Tested-by: Igor Patrik <igorp@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/core.c    |   22 ++++++++++++++++++----
 drivers/tty/serial/8250/8250.c   |    4 ++--
 drivers/tty/serial/serial_core.c |    4 ++--
 include/linux/serial_core.h      |    2 +-
 4 files changed, 23 insertions(+), 9 deletions(-)

diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index 81bb267..de52e77 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -435,9 +435,16 @@ static void __init alp_i2c_init(void)
  */
 static struct plat_serial8250_port uart0_data[] = {
 	{
-		.iotype         = UPIO_MEM32,
+		.mapbase	= (INTER_REGS_PHYS_BASE | MV_UART_REGS_OFFSET(0)),
+		.membase	= (char *)(INTER_REGS_BASE | MV_UART_REGS_OFFSET(0)),
+		.irq		= IRQ_GLOBAL_UART0,
+		.flags		= UPF_FIXED_TYPE | UPF_SKIP_TEST | UPF_BOOT_AUTOCONF,
+		.iotype		= UPIO_DWAPB,
+		.private_data	= (void *) (INTER_REGS_BASE | MV_UART_REGS_OFFSET(0) | 0x7C),
+		.type		= PORT_16550A,
 		.regshift       = 2,
 		.uartclk        = 0,
+	}, {
 	},
 };
 
@@ -454,7 +461,7 @@ static struct resource uart0_resources[] = {
 };
 
 static struct platform_device uart0 = {
-	.name			= "dw-apb-uart",
+	.name			= "serial8250",
 	.id			= 0,
 	.dev			= {
 		.platform_data	= uart0_data,
@@ -468,9 +475,16 @@ static struct platform_device uart0 = {
  */
 static struct plat_serial8250_port uart1_data[] = {
 	{
-		.iotype         = UPIO_MEM32,
+		.mapbase	= (INTER_REGS_PHYS_BASE | MV_UART_REGS_OFFSET(1)),
+		.membase	= (char *)(INTER_REGS_BASE | MV_UART_REGS_OFFSET(1)),
+		.irq		= IRQ_GLOBAL_UART1,
+		.flags		= UPF_FIXED_TYPE | UPF_SKIP_TEST | UPF_BOOT_AUTOCONF,
+		.iotype		= UPIO_DWAPB,
+		.private_data	= (void *) (INTER_REGS_BASE | MV_UART_REGS_OFFSET(1) | 0x7C),
+		.type		= PORT_16550A,
 		.regshift       = 2,
 		.uartclk        = 0,
+	}, {
 	},
 };
 
@@ -487,7 +501,7 @@ static struct resource uart1_resources[] = {
 };
 
 static struct platform_device uart1 = {
-	.name			= "dw-apb-uart",
+	.name			= "serial8250",
 	.id			= 0,
 	.dev			= {
 		.platform_data	= uart1_data,
diff --git a/drivers/tty/serial/8250/8250.c b/drivers/tty/serial/8250/8250.c
index dabb52d..a5238da 100644
--- a/drivers/tty/serial/8250/8250.c
+++ b/drivers/tty/serial/8250/8250.c
@@ -1538,13 +1538,13 @@ static irqreturn_t serial8250_interrupt(int irq, void *dev_id)
 		up = list_entry(l, struct uart_8250_port, list);
 		port = &up->port;
 
-#if !defined(CONFIG_ARCH_ARMADA370) && !defined(CONFIG_ARCH_ARMADA_XP)
+#if !defined(CONFIG_PLAT_ARMADA)
 		if (port->handle_irq(port)) {
 			handled = 1;
 			end = NULL;
 		}
 #endif
-#if defined(CONFIG_ARCH_ARMADA370) || defined(CONFIG_ARCH_ARMADA_XP)
+#if defined(CONFIG_PLAT_ARMADA)
 		iir = serial_in(up, UART_IIR);
 		if (!(iir & UART_IIR_NO_INT)) {
 			serial8250_handle_irq(port, iir);
diff --git a/drivers/tty/serial/serial_core.c b/drivers/tty/serial/serial_core.c
index 5c407cd..919fdb0 100644
--- a/drivers/tty/serial/serial_core.c
+++ b/drivers/tty/serial/serial_core.c
@@ -2042,7 +2042,7 @@ uart_report_port(struct uart_driver *drv, struct uart_port *port)
 	case UPIO_MEM32:
 	case UPIO_AU:
 	case UPIO_TSI:
-#if defined(CONFIG_ARCH_ARMADA370)
+#if defined(CONFIG_PLAT_ARMADA)
 	case UPIO_DWAPB:
 #endif
 		snprintf(address, sizeof(address),
@@ -2481,7 +2481,7 @@ int uart_match_port(struct uart_port *port1, struct uart_port *port2)
 	case UPIO_MEM32:
 	case UPIO_AU:
 	case UPIO_TSI:
-#if defined(CONFIG_ARCH_ARMADA370)
+#if defined(CONFIG_PLAT_ARMADA)
 	case UPIO_DWAPB:
 #endif
 		return (port1->mapbase == port2->mapbase);
diff --git a/include/linux/serial_core.h b/include/linux/serial_core.h
index 4b34e84..0af2ee3 100644
--- a/include/linux/serial_core.h
+++ b/include/linux/serial_core.h
@@ -327,7 +327,7 @@ struct uart_port {
 #define UPIO_AU			(4)			/* Au1x00 type IO */
 #define UPIO_TSI		(5)			/* Tsi108/109 type IO */
 
-#if defined(CONFIG_ARCH_ARMADA370) || defined(CONFIG_ARCH_ARMADA_XP)
+#if defined(CONFIG_PLAT_ARMADA)
 #define UPIO_DWAPB		(6)
 #define UPIO_DWAPB32		(7)
 #endif
-- 
1.7.5.4

