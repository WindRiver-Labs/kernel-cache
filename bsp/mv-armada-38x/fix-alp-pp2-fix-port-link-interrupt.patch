From 66e9e0afe6ee0f1f7eab6261ff60021b653170f1 Mon Sep 17 00:00:00 2001
From: Uri Eliyahu <uriel@marvell.com>
Date: Tue, 11 Mar 2014 17:29:30 +0200
Subject: [PATCH 1451/1825] fix: alp: pp2: fix port link interrupt

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 486bb050a446c14d46b55f364f8c756a80d76647

Change-Id: I65da13684020350afe04c2c2e133bd3467982117
Signed-off-by: Uri Eliyahu <uriel@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/6316
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |    2 ++
 .../arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c |    6 ++++++
 .../arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.h |   15 +++++++++++++++
 .../plat-armada/mv_hal/pp2/gmac/mvEthGmacRegs.h    |   18 ++++++++++++------
 4 files changed, 35 insertions(+), 6 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index cddac87..eefadff 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -3834,6 +3834,8 @@ static int mv_eth_probe(struct platform_device *pdev)
 			mvGmacPortLbSet(port, (plat_data->speed == SPEED_1000), is_sgmii);
 
 		mvGmacPortPowerUp(port, is_sgmii, is_rgmii);
+
+		mvGmacPortSumIsrUnmask(port);
 	}
 
 	if (mv_eth_load_network_interfaces(pdev))
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
index d60b5ace..035e6c2 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
@@ -656,6 +656,12 @@ void mvGmacPortRegs(int port)
 
 	mvGmacPrintReg(ETH_PORT_ISR_CAUSE_REG(port), "MV_GMAC_ISR_CAUSE_REG");
 	mvGmacPrintReg(ETH_PORT_ISR_MASK_REG(port), "MV_GMAC_ISR_MASK_REG");
+
+#ifdef CONFIG_MV_ETH_PP2_1
+	mvGmacPrintReg(ETH_PORT_ISR_SUM_CAUSE_REG(port), "MV_GMAC_ISR_SUM_CAUSE_REG");
+	mvGmacPrintReg(ETH_PORT_ISR_SUM_MASK_REG(port), "MV_GMAC_ISR_SUM_MASK_REG");
+#endif
+
 }
 
 
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.h b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.h
index f296e07..5bfe037 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.h
@@ -137,6 +137,21 @@ static INLINE MV_VOID mvGmacPortIsrUnmask(int port)
 	MV_REG_WRITE(ETH_PORT_ISR_MASK_REG(port), ETH_PORT_LINK_CHANGE_MASK);
 }
 
+static INLINE MV_VOID mvGmacPortSumIsrMask(int port)
+{
+#ifdef CONFIG_MV_ETH_PP2_1
+	MV_REG_WRITE(ETH_PORT_ISR_SUM_MASK_REG(port), 0);
+#endif
+}
+
+static INLINE MV_VOID mvGmacPortSumIsrUnmask(int port)
+{
+#ifdef CONFIG_MV_ETH_PP2_1
+	MV_REG_WRITE(ETH_PORT_ISR_SUM_MASK_REG(port), ETH_PORT_ISR_SUM_INTERN_MASK);
+#endif
+}
+
+
 void mvGmacDefaultsSet(int port);
 void mvGmacPortEnable(int port);
 void mvGmacPortDisable(int port);
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacRegs.h b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacRegs.h
index 1fc18ee..d9057ca 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacRegs.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacRegs.h
@@ -209,15 +209,21 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 /*-------------------------------------------------------------------------------*/
 
 /**** Port Interrupt Sub-Unit Registers ****/
-#define ETH_PORT_ISR_CAUSE_REG(p)	(ETH_REG_BASE(p) + 0x20)
+#define ETH_PORT_ISR_CAUSE_REG(p)		(ETH_REG_BASE(p) + 0x20)
 
-#define ETH_PORT_ISR_SUM_BIT		0
-#define ETH_PORT_ISR_SUM_MASK		(1 << ETH_PORT_ISR_SUM_BIT)
+#define ETH_PORT_ISR_SUM_BIT			0
+#define ETH_PORT_ISR_SUM_MASK			(1 << ETH_PORT_ISR_SUM_BIT)
 
-#define ETH_PORT_LINK_CHANGE_BIT	1
-#define ETH_PORT_LINK_CHANGE_MASK	(1 << ETH_PORT_LINK_CHANGE_BIT)
+#define ETH_PORT_LINK_CHANGE_BIT		1
+#define ETH_PORT_LINK_CHANGE_MASK		(1 << ETH_PORT_LINK_CHANGE_BIT)
 
-#define ETH_PORT_ISR_MASK_REG(p)	(ETH_REG_BASE(p) + 0x24)
+#define ETH_PORT_ISR_MASK_REG(p)		(ETH_REG_BASE(p) + 0x24)
+
+#define ETH_PORT_ISR_SUM_CAUSE_REG(p)		(ETH_REG_BASE(p) + 0xA0)
+#define ETH_PORT_ISR_SUM_MASK_REG(p)		(ETH_REG_BASE(p) + 0xA4)
+
+#define ETH_PORT_ISR_SUM_INTERN_BIT		0x1
+#define ETH_PORT_ISR_SUM_INTERN_MASK		(1 << ETH_PORT_ISR_SUM_INTERN_BIT)
 /*-------------------------------------------------------------------------------*/
 
 /****************************************/
-- 
1.7.5.4

