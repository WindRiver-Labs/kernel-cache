From 28d3aca424f66291c55b528004a6a8399dcc326d Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Sun, 10 Nov 2013 15:45:52 +0200
Subject: [PATCH 1076/1825] sata: alp : Added external Sata initialization for
 RD-6660

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit d81190edaadb0bed66ec4562e4b70ce638ba844f

	- Added IO expander configuration mapping for RD-6660
	- Added routine to enable HDD Power (mvBoardHDDPowerSet)
	- Added routine to select External/Internal HDD (mvBoardHDDSelecteExternal)

Change-Id: I689e829996b0cb00bed705fb36d46789dd2e4e5f
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4271
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   90 ++++++++++++++++++--
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |   31 +++++++
 .../avanta_lp_family/boardEnv/mvBoardEnvSpec.c     |    7 ++
 3 files changed, 121 insertions(+), 7 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index 90a06dc..df4e17f 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -118,7 +118,9 @@ static MV_BOARD_INFO *board = NULL;
 *******************************************************************************/
 MV_VOID mvBoardEnvInit(MV_VOID)
 {
-	mvBoardIdSet(mvBoardIdGet());
+	MV_U32 boardId = mvBoardIdGet();
+
+	mvBoardIdSet(boardId);
 
 	/*  FPGA board doesn't use MPP neither GPIO */
 #if !defined(CONFIG_MACH_AVANTA_LP_FPGA)
@@ -156,6 +158,12 @@ MV_VOID mvBoardEnvInit(MV_VOID)
 	mvGppTypeSet(0, 0xFFFFFFFF, board->gppOutEnValLow);
 	mvGppTypeSet(1, 0xFFFFFFFF, board->gppOutEnValMid);
 	mvGppTypeSet(2, 0xFFFFFFFF, board->gppOutEnValHigh);
+
+	/* specific External SATA initializations (required only for RD-6660) */
+	if (boardId == RD_6660_ID) {
+		mvBoardHDDPowerSet(MV_TRUE);
+		mvBoardHddExtSet(MV_TRUE);
+	}
 #endif
 }
 
@@ -2348,19 +2356,24 @@ MV_STATUS mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_TYPE_ID ioClass,
 {
 	MV_U32 i;
 
-	MV_BOARD_IO_EXPANDER_TYPE_INFO ioe6660[] = MV_BOARD_IO_EXP_DB6660_INFO;
-	MV_BOARD_IO_EXPANDER_TYPE_INFO ioe6650[] = MV_BOARD_IO_EXP_DB6650_INFO;
+	MV_BOARD_IO_EXPANDER_TYPE_INFO ioe_db6660[] = MV_BOARD_IO_EXP_DB6660_INFO;
+	MV_BOARD_IO_EXPANDER_TYPE_INFO ioe_db6650[] = MV_BOARD_IO_EXP_DB6650_INFO;
+	MV_BOARD_IO_EXPANDER_TYPE_INFO ioe_rd6660[] = MV_BOARD_IO_EXP_RD6660_INFO;
 	MV_BOARD_IO_EXPANDER_TYPE_INFO *ioe;
 	MV_U8 n = 0;
 
 	switch (mvBoardIdGet()) {
 	case DB_6650_ID:
-		ioe = ioe6650;
-		n = ARRSZ(ioe6650);
+		ioe = ioe_db6650;
+		n = ARRSZ(ioe_db6650);
 		break;
 	case DB_6660_ID:
-		ioe = ioe6660;
-		n = ARRSZ(ioe6660);
+		ioe = ioe_db6660;
+		n = ARRSZ(ioe_db6660);
+		break;
+	case RD_6660_ID:
+		ioe = ioe_rd6660;
+		n = ARRSZ(ioe_rd6660);
 		break;
 	default:
 		mvOsPrintf("%s: Error: IO Expander doesn't exists on board\n", __func__);
@@ -2436,6 +2449,69 @@ MV_STATUS mvBoardSgmiiSfp0TxSet(MV_BOOL enable)
 }
 
 /*******************************************************************************
+* mvBoardHDDSelecteExternal - Select External / Internal HDD
+*
+* DESCRIPTION:
+*	This function External / Internal HDD
+*	HDD_SELECT = 1 --> Routes SATA signals to External connector
+*	HDD_SELECT = 0 --> Routes SATA signals to Internal connector
+*
+* INPUT:
+*	enableInternal - Boolean to indicate requested status
+*	MV_TRUE --> set Internal HDD
+*	MV_FALSE --> set External HDD
+*
+* OUTPUT:
+*	None.
+*
+* RETURN:
+*	None.
+*
+*******************************************************************************/
+MV_STATUS mvBoardHddExtSet(MV_BOOL enableExternal)
+{
+	MV_BOARD_IO_EXPANDER_TYPE_INFO ioInfo;
+
+	if (mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_HDD_SELECT, &ioInfo) != MV_OK) {
+		mvOsPrintf("%s: Error: Write to IO expander failed (USB_SS_EN)\n", __func__);
+		return MV_ERROR;
+	}
+
+	return mvBoardIoExpValSet(&ioInfo, (enableExternal ? 0x1 : 0x0));
+}
+
+/*******************************************************************************
+* mvBoardHDDPowerSet - enable HDD Power status
+*
+* DESCRIPTION:
+*	This function enables/disables  HDD Power status.
+*	HDD_SELECT = 1 --> Enables SATA power
+*
+* INPUT:
+*	enable - Boolean to indicate requested status
+*	MV_TRUE -->  Enables SATA power
+*	MV_FALSE --> Disables SATA power
+*
+* OUTPUT:
+*	None.
+*
+* RETURN:
+*	None.
+*
+*******************************************************************************/
+MV_STATUS mvBoardHDDPowerSet(MV_BOOL enable)
+{
+	MV_BOARD_IO_EXPANDER_TYPE_INFO ioInfo;
+
+	if (mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_HDD_PWR_EN, &ioInfo) != MV_OK) {
+		mvOsPrintf("%s: Error: Write to IO expander failed (USB_SS_EN)\n", __func__);
+		return MV_ERROR;
+	}
+
+	return mvBoardIoExpValSet(&ioInfo, (enable ? 0x1 : 0x1));
+}
+
+/*******************************************************************************
 * mvBoardUsbSsEnSet - enable/disable USB_SS_EN status
 *
 * DESCRIPTION:
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index 1048d5e..fef8ff5 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -292,6 +292,17 @@ typedef enum _mvIoExpanderTypeID {
 	MV_IO_EXPANDER_SPI1_CS_MSB1,
 	MV_IO_EXPANDER_INTEG_PHY_PORTS_LED,
 	MV_IO_EXPANDER_USB_SUPER_SPEED,
+	MV_IO_EXPANDER_PCIE_WAKE_EN0,
+	MV_IO_EXPANDER_PCIE_WAKE_DIS0,
+	MV_IO_EXPANDER_PCIE_WAKE_EN1,
+	MV_IO_EXPANDER_PCIE_WAKE_DIS1,
+	MV_IO_EXPANDER_COEX1_1,
+	MV_IO_EXPANDER_COEX1_0,
+	MV_IO_EXPANDER_COEX2_1,
+	MV_IO_EXPANDER_COEX2_0,
+	MV_IO_EXPANDER_HDD_SELECT,
+	MV_IO_EXPANDER_HDD_PWR_EN,
+	MV_IO_EXPANDER_TX_FAULT_RST,
 	MV_IO_EXPANDER_MAX_OPTION
 } MV_IO_EXPANDER_TYPE_ID;
 
@@ -432,6 +443,24 @@ typedef struct _boardInfo {
 { MV_IO_EXPANDER_USB_SUPER_SPEED,	 7,		 2,	 1}, \
 };
 
+#define MV_BOARD_IO_EXP_RD6660_INFO { \
+	/* 1st IO Expander Register*/ \
+{ MV_IO_EXPANDER_PCIE_WAKE_EN0,		 0,		 0,	 0}, \
+{ MV_IO_EXPANDER_PCIE_WAKE_DIS0,	 1,		 0,	 0}, \
+{ MV_IO_EXPANDER_PCIE_WAKE_EN1,		 2,		 0,	 0}, \
+{ MV_IO_EXPANDER_PCIE_WAKE_DIS1,	 3,		 0,	 0}, \
+{ MV_IO_EXPANDER_COEX1_1,		 4,		 0,	 0}, \
+{ MV_IO_EXPANDER_COEX1_0,		 5,		 0,	 0}, \
+{ MV_IO_EXPANDER_COEX2_0,		 6,		 0,	 0}, \
+{ MV_IO_EXPANDER_COEX2_1,		 7,		 0,	 0}, \
+	/* 2nd IO Expander Register*/ \
+{ MV_IO_EXPANDER_USB_SUPER_SPEED,	 1,		 0,	 1}, \
+{ MV_IO_EXPANDER_SD_WRITE_PROTECT,	 2,		 0,	 1}, \
+{ MV_IO_EXPANDER_HDD_SELECT,		 3,		 0,	 1}, \
+{ MV_IO_EXPANDER_HDD_PWR_EN,		 4,		 0,	 1}, \
+{ MV_IO_EXPANDER_TX_FAULT_RST,		 7,		 0,	 1}, \
+};
+
 /* Boot device bus width */
 #define MSAR_0_BOOT_DEV_BUS_WIDTH_OFFS          3
 /* Bus width field meaning for NOR/NAND */
@@ -476,6 +505,8 @@ MV_STATUS mvBoardConfigTypeGet(MV_CONFIG_TYPE_ID configClass, MV_BOARD_CONFIG_TY
 MV_STATUS mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_TYPE_ID ioClass, MV_BOARD_IO_EXPANDER_TYPE_INFO *ioInfo);
 MV_STATUS mvBoardExtPhyBufferSelect(MV_BOOL enable);
 MV_STATUS mvBoardSgmiiSfp0TxSet(MV_BOOL enable);
+MV_STATUS mvBoardHddExtSet(MV_BOOL enable);
+MV_STATUS mvBoardHDDPowerSet(MV_BOOL enable);
 MV_STATUS mvBoardUsbSsEnSet(MV_BOOL enable);
 MV_U32 mvBoardTclkGet(MV_VOID);
 MV_U32 mvBoardL2ClkGet(MV_VOID);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
index 376bd30..8218c27 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.c
@@ -409,6 +409,11 @@ MV_BOARD_INFO rd88f6650_board_info = {
 /*******************************************************************************
  * AvantaLP RD-88F6660 board */
 /*******************************************************************************/
+MV_BOARD_TWSI_INFO rd88f6660InfoBoardTwsiDev[] = {
+	/* {{MV_BOARD_DEV_CLASS devClass, MV_U8 devClassId,  MV_U8 twsiDevAddr, MV_U8 twsiDevAddrType}} */
+	{ BOARD_DEV_TWSI_IO_EXPANDER,	0,	0x20,	ADDR7_BIT },
+};
+
 /* When Switch Port 4 is connected to external PHY through RGMII-0,
  * this external PHY is managed through MAC-0 SMI lines.
  * The 'boardEthSmiAddr' variable is used only for PHY init. */
@@ -468,6 +473,8 @@ MV_BOARD_INFO rd88f6660_board_info = {
 	.intsGppMaskHigh		= 0,
 	.numBoardDeviceIf		= ARRSZ(rd88f6660InfoBoardDeCsInfo),
 	.pDevCsInfo			= rd88f6660InfoBoardDeCsInfo,
+	.numBoardTwsiDev		= ARRSZ(rd88f6660InfoBoardTwsiDev),
+	.pBoardTwsiDev			= rd88f6660InfoBoardTwsiDev,
 	.numBoardMacInfo		= ARRSZ(rd88f6660InfoBoardMacInfo),
 	.pBoardMacInfo			= rd88f6660InfoBoardMacInfo,
 	.numBoardGppInfo		= 0,
-- 
1.7.5.4

