From ac1d747b394692c9f051a997913a5fcf87f1c3de Mon Sep 17 00:00:00 2001
From: Yelena <yelena@marvell.com>
Date: Thu, 9 Jan 2014 11:59:00 +0200
Subject: [PATCH 1326/1825] neta: add register access for kernel 3.10

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 23d5162e719fe1b456b1cca05a5ad966074b389d

	Support FDT systems with CONFIG_OF.

Change-Id: I242b6fd472cf97690a04d21cb64574d021aabd41
Signed-off-by: Yelena <yelena@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5164
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Tested-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/mv_hal/neta/gbe/mvEthRegs.h  |    6 ++++++
 arch/arm/plat-armada/mv_hal/neta/gbe/mvNetaRegs.h |   10 ++++++++--
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/neta/gbe/mvEthRegs.h b/arch/arm/plat-armada/mv_hal/neta/gbe/mvEthRegs.h
index acba134..23d1639 100644
--- a/arch/arm/plat-armada/mv_hal/neta/gbe/mvEthRegs.h
+++ b/arch/arm/plat-armada/mv_hal/neta/gbe/mvEthRegs.h
@@ -79,7 +79,13 @@ extern "C" {
 /****************************************/
 /*        Ethernet Unit Registers       */
 /****************************************/
+#ifdef CONFIG_OF
+extern int port_vbase[MV_ETH_MAX_PORTS];
+
+#define ETH_REG_BASE(port)                  port_vbase[port]
+#else /* CONFIG_OF */
 #define ETH_REG_BASE(port)                  MV_ETH_REGS_BASE(port)
+#endif /* CONFIG_OF */
 
 #define ETH_PHY_ADDR_REG(port)              (ETH_REG_BASE(port) + 0x2000)
 #define ETH_SMI_REG(port)                   (ETH_REG_BASE(port) + 0x2004)
diff --git a/arch/arm/plat-armada/mv_hal/neta/gbe/mvNetaRegs.h b/arch/arm/plat-armada/mv_hal/neta/gbe/mvNetaRegs.h
index 4855b37..967743d 100644
--- a/arch/arm/plat-armada/mv_hal/neta/gbe/mvNetaRegs.h
+++ b/arch/arm/plat-armada/mv_hal/neta/gbe/mvNetaRegs.h
@@ -76,8 +76,14 @@ extern "C" {
 #include "mvSysEthConfig.h"
 #endif
 
+#ifdef CONFIG_OF
+extern int port_vbase[MV_ETH_MAX_PORTS];
+#define NETA_REG_BASE(port)					port_vbase[port]
+/******* SERDES registers **************************************************/
+#define SGMII_SERDES_CFG_REG(p)				(NETA_REG_BASE(p) + 0x24A0)
+#else
 #define NETA_REG_BASE(port) 				MV_ETH_REGS_BASE(port)
-
+#endif /* CONFIG_OF */
 
 /************************** NETA TX Registers ******************************/
 
@@ -92,7 +98,7 @@ extern "C" {
 /************************** NETA RX Registers ******************************/
 
 /* PxRXyC: Port RX queues Configuration Register */
-#define NETA_RXQ_CONFIG_REG(p, q)        	(NETA_REG_BASE(p) + 0x1400 + ((q) << 2))
+#define NETA_RXQ_CONFIG_REG(p, q)           (NETA_REG_BASE(p) + 0x1400 + ((q) << 2))
 
 #define NETA_RXQ_HW_BUF_ALLOC_BIT           0
 #define NETA_RXQ_HW_BUF_ALLOC_MASK          (1 << NETA_RXQ_HW_BUF_ALLOC_BIT)
-- 
1.7.5.4

