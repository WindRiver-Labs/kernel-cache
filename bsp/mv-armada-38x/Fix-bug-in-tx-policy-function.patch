From 3c426d2c5d43689a674d3c0cd8cd3e96d73447c7 Mon Sep 17 00:00:00 2001
From: Tawfik Bayouk <tawfik@marvell.com>
Date: Tue, 21 Aug 2012 17:35:09 +0300
Subject: [PATCH 0158/1825] Fix bug in tx policy function

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit d4f5ca14cb353e8e49a9a4282a30e8a29723321d

Change-Id: I541ca4188e228e75d41c4b2c2b5ff1d9b83e6758
Signed-off-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c     |    9 ++++-----
 1 files changed, 4 insertions(+), 5 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
index 3ddfd6e..bdac8e5 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
@@ -132,7 +132,7 @@ static int mv_eth_initialized = 0;
  */
 static void mv_eth_txq_delete(struct eth_port *pp, struct tx_queue *txq_ctrl);
 static void mv_eth_tx_timeout(struct net_device *dev);
-static int mv_eth_tx(struct sk_buff *skb, struct net_device *dev);
+static int  mv_eth_tx(struct sk_buff *skb, struct net_device *dev);
 static void mv_eth_tx_frag_process(struct eth_port *pp, struct sk_buff *skb, struct tx_queue *txq_ctrl, u16 flags);
 
 static void mv_eth_config_show(void);
@@ -1137,11 +1137,10 @@ static inline int mv_eth_tx_policy(struct eth_port *pp, struct sk_buff *skb)
 {
 	int txq = pp->txq[smp_processor_id()];
 
-	if (ip_hdr(skb)) {
-		MV_U8 tos;
+	if (skb->protocol == htons(ETH_P_IP)) {
+		struct iphdr *iph = ip_hdr(skb);
 
-		tos = ip_hdr(skb)->tos;
-		txq = mv_eth_txq_tos_map_get(pp, tos);
+		txq = mv_eth_txq_tos_map_get(pp, iph->tos);
 	}
 	return txq;
 }
-- 
1.7.5.4

