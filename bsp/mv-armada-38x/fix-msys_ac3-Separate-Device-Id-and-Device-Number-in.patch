From b7b8782e89a8503caea0520d47da54745fbc9dd9 Mon Sep 17 00:00:00 2001
From: kostap <kostap@marvell.com>
Date: Mon, 30 Jun 2014 14:02:03 +0300
Subject: [PATCH 1751/1825] fix: msys_ac3: Separate Device Id and Device
 Number in SAR API

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 8124fab42f7d69c4c072999d90fef26c38bca4d8

    - Fix the SAR Device ID value - take it only from
      i2c device 0x4C bits[4:0]
    - Add SAR support for Device Number taken from
      i2c device 0x4D bits[1:0], new APIs are
      mvBoardDeviceNumSet/mvBoardDeviceNumGet

Change-Id: I669e913a4963f18dd8bf938e144e0a9672252679
Signed-off-by: kostap <kostap@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8819
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Tested-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mach-msys/msys_family/boardEnv/mvBoardEnvLib.c |   59 ++++++++++++++------
 .../mach-msys/msys_family/boardEnv/mvBoardEnvLib.h |    2 +
 2 files changed, 43 insertions(+), 18 deletions(-)

diff --git a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
index af0dfec..0791774 100644
--- a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.c
@@ -1550,14 +1550,6 @@ MV_STATUS mvBoardDeviceIdGet(MV_U8 *value)
 
 	*value = (sar & 0x1F);
 
-	if (family == MV_ALLEYCAT3_DEV_ID) {
-		/* AC3 - 2 additional bits in device ID */
-		if (MV_ERROR == mvBoardTwsiSatRGet(1, 0, &sar))
-			return MV_ERROR;
-
-		*value |= (sar & 0x3) << 4;
-	}
-
 	return MV_OK;
 }
 
@@ -1583,18 +1575,49 @@ MV_STATUS mvBoardDeviceIdSet(MV_U8 val)
 		return MV_ERROR;
 	}
 
-	if (family == MV_ALLEYCAT3_DEV_ID) {
-		/* AC3 - 2 additional bits in device ID */
-		if (MV_ERROR == mvBoardTwsiSatRGet(1, 0, &sar))
-			return MV_ERROR;
+	DB(mvOsPrintf("Board: Write deviceid S@R succeeded\n"));
+	return MV_OK;
+}
 
-		sar &= ~(0x3);
-		sar |= (val & (0x3 << 4)) >> 4;
+/*******************************************************************************/
+MV_STATUS mvBoardDeviceNumGet(MV_U8 *value)
+{
+	MV_U8		sar;
+	MV_U16		family = mvCtrlDevFamilyIdGet(0);
 
-		if (MV_OK != mvBoardTwsiSatRSet(1, 0, sar)) {
-			DB(mvOsPrintf("Board: Write device-id(MSB) S@R fail\n"));
-			return MV_ERROR;
-		}
+	if (family != MV_ALLEYCAT3_DEV_ID) {
+		DB(mvOsPrintf("%s: Controller family (0x%04x) is not supported\n", __func__, family));
+		return MV_ERROR;
+	}
+
+	if (MV_ERROR == mvBoardTwsiSatRGet(1, 0, &sar))
+		return MV_ERROR;
+
+	*value = (sar & 0x3);
+
+	return MV_OK;
+}
+
+/*******************************************************************************/
+MV_STATUS mvBoardDeviceNumSet(MV_U8 val)
+{
+	MV_U8		sar;
+	MV_U16		family = mvCtrlDevFamilyIdGet(0);
+
+	if (family != MV_ALLEYCAT3_DEV_ID) {
+		DB(mvOsPrintf("%s: Controller family (0x%04x) is not supported\n", __func__, family));
+		return MV_ERROR;
+	}
+
+	if (MV_ERROR == mvBoardTwsiSatRGet(1, 0, &sar))
+		return MV_ERROR;
+
+	sar &= ~(0x3);
+	sar |= (val & 0x3);
+
+	if (MV_OK != mvBoardTwsiSatRSet(1, 0, sar)) {
+		DB(mvOsPrintf("Board: Write device-id S@R fail\n"));
+		return MV_ERROR;
 	}
 
 	DB(mvOsPrintf("Board: Write deviceid S@R succeeded\n"));
diff --git a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.h
index 129618e..668dc6d 100644
--- a/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-msys/msys_family/boardEnv/mvBoardEnvLib.h
@@ -301,6 +301,8 @@ MV_STATUS mvBoardBootDevGet(MV_U8 *value);
 MV_STATUS mvBoardBootDevSet(MV_U8 val);
 MV_STATUS mvBoardDeviceIdGet(MV_U8 *value);
 MV_STATUS mvBoardDeviceIdSet(MV_U8 val);
+MV_STATUS mvBoardDeviceNumGet(MV_U8 *value);
+MV_STATUS mvBoardDeviceNumSet(MV_U8 val);
 MV_STATUS mvBoardPcieModeGet(MV_U8 *val);
 MV_STATUS mvBoardPcieModeSet(MV_U8 val);
 MV_STATUS mvBoardPcieClockGet(MV_U8 *val);
-- 
1.7.5.4

