From b0c2a2c4d02cb0aa40949e4fc451f007d2ea9732 Mon Sep 17 00:00:00 2001
From: Yoni Farhadia <yonif@marvell.com>
Date: Tue, 15 Oct 2013 09:23:18 +0200
Subject: [PATCH 1024/1825] fix: switch: alp,a370: fix switch's MTU at boot
 time

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 1c6a057f64fe2801e4b88bf9c6ecc37de2f24acb

	- Set switch's MTU according to GBE port connected to it

Change-Id: I7ae288ddb4f1393388515ad379597b4d8b26b0a5
Signed-off-by: Yoni Farhadia <yonif@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/3705
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Tested-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-armada370/core.c |    8 +++++---
 arch/arm/mach-avantalp/core.c  |    8 +++++++-
 2 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/arch/arm/mach-armada370/core.c b/arch/arm/mach-armada370/core.c
index 75d9452..4b3c89b 100644
--- a/arch/arm/mach-armada370/core.c
+++ b/arch/arm/mach-armada370/core.c
@@ -751,11 +751,13 @@ static void mv_switch_pdev_register(struct platform_device *pdev)
 	struct mv_switch_pdata *plat_data = (struct mv_switch_pdata *)pdev->dev.platform_data;
 
 	/* check if switch is connected to GBE port */
-	if (mvBoardSwitchConnectedPortGet(0) != -1)
+	if (mvBoardSwitchConnectedPortGet(0) != -1) {
 		plat_data->gbe_port = 0;
-	else if (mvBoardSwitchConnectedPortGet(1) != -1)
+		plat_data->mtu = mv_pp2_ge0_pdata.mtu;
+	} else if (mvBoardSwitchConnectedPortGet(1) != -1) {
 		plat_data->gbe_port = 1;
-	else
+		plat_data->mtu = mv_pp2_ge1_pdata.mtu;
+	} else
 		return;
 
 	/* get board configuration */
diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index 19ca5da..93f0946 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -808,7 +808,13 @@ static void mv_switch_pdev_register(struct platform_device *pdev)
 	struct mv_switch_pdata *plat_data = (struct mv_switch_pdata *)pdev->dev.platform_data;
 
 	/* check if switch is connected to GBE port */
-	if (mvBoardSwitchConnectedPortGet(plat_data->gbe_port) == -1)
+	if (mvBoardSwitchConnectedPortGet(0) != -1) {
+		plat_data->gbe_port = 0;
+		plat_data->mtu = mv_pp2_ge0_pdata.mtu;
+	} else if (mvBoardSwitchConnectedPortGet(1) != -1) {
+		plat_data->gbe_port = 1;
+		plat_data->mtu = mv_pp2_ge1_pdata.mtu;
+	} else
 		return;
 
 	/* get board configuration */
-- 
1.7.5.4

