From 9c69b17c7b9e797dc0d3289f42c97b910228bb4e Mon Sep 17 00:00:00 2001
From: xigu <xigu@marvell.com>
Date: Mon, 24 Mar 2014 21:24:21 +0200
Subject: [PATCH 1517/1825] alp: pon: support compilation PON as a loadable
 module

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 62898ead0d99f073bb5bf814f9a256298261085a

Change-Id: Idbf39f6ec699b7c0033cc70d122ba7e5b3d543ec
Signed-off-by: xigu <xigu@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/6636
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/Makefile                    |    1 -
 arch/arm/plat-armada/Kconfig                       |   25 ++++++++++++-------
 arch/arm/plat-armada/mv_drivers_lsp/mv_pon/Kconfig |    4 ---
 .../arm/plat-armada/mv_drivers_lsp/mv_pon/Makefile |    9 +++----
 4 files changed, 20 insertions(+), 19 deletions(-)

diff --git a/arch/arm/mach-avantalp/Makefile b/arch/arm/mach-avantalp/Makefile
index d7d0c60..71ee6ea 100644
--- a/arch/arm/mach-avantalp/Makefile
+++ b/arch/arm/mach-avantalp/Makefile
@@ -88,7 +88,6 @@ avantalp-$(CONFIG_MV_INCLUDE_NFC)	+= $(HAL_NFC_DIR)/mvNfc.o $(HAL_IF_DIR)/mvSysN
 avantalp-$(CONFIG_MV_CPU_PERF_CNTRS)    += $(HAL_CPU_DIR)/mvCpuCntrs.o $(HAL_CPU_DIR)/pj4/mvPJ4Cntrs.o
 avantalp-$(CONFIG_PCIE_VIRTUAL_BRIDGE_SUPPORT) += $(HAL_PEX_DIR)/mvVrtBrgPex.o
 avantalp-$(CONFIG_MV_CPU_L2_PERF_CNTRS) += $(HAL_CPU_DIR)/mvCpuL2Cntrs.o
-avantalp-$(CONFIG_MV_INCLUDE_PON)	+= $(HAL_PON_DIR)/mvPonOnuMac.o $(HAL_PON_DIR)/mvPonOnuRegs.o
 
 obj-$(CONFIG_MV_INCLUDE_SWITCH) 	+= $(QD_OBJS)
 
diff --git a/arch/arm/plat-armada/Kconfig b/arch/arm/plat-armada/Kconfig
index c3f2cd2..49b9c94 100644
--- a/arch/arm/plat-armada/Kconfig
+++ b/arch/arm/plat-armada/Kconfig
@@ -185,13 +185,6 @@ config MV_INCLUDE_TS
 	help
 	  Please don't change this configs unless you know what you are doing.
 
-config MV_INCLUDE_PON
-	bool "PON Support"
-	depends on MV88F6500 || MV_ETH_PP2
-	default y
-	help
-	  Please don't change this configs unless you know what you are doing.
-
 config MV_INCLUDE_SWITCH
 	bool "Ethernet Switch Support"
 	depends on MV88F6500 || MV88F6281 || MV78XX0 || \
@@ -614,6 +607,22 @@ config MV_INCLUDE_ETH_PHY
 
 endmenu # "SoC Networking support"
 
+menu "SoC PON support"
+depends on ARCH_AVANTA_LP
+
+config MV_INCLUDE_PON
+	tristate "PON Support"
+	depends on ARCH_AVANTA_LP
+	default y
+	help
+	  Please don't change this configs unless you know what you are doing.
+
+if MV_INCLUDE_PON
+source arch/arm/plat-armada/mv_drivers_lsp/mv_pon/Kconfig
+endif
+
+endmenu # "SoC PON support"
+
 source arch/arm/plat-armada/mv_drivers_lsp/mv_dragonite/Kconfig
 
 source arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/Kconfig
@@ -624,8 +633,6 @@ source arch/arm/plat-armada/mv_drivers_lsp/mv_phone/Kconfig
 
 source arch/arm/plat-armada/mv_drivers_lsp/mv_tsu/Kconfig
 
-source arch/arm/plat-armada/mv_drivers_lsp/mv_pon/Kconfig
-
 source arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/Kconfig
 
 config  SCSI_MVSATA
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/Kconfig b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/Kconfig
index 66fd9ed..7abf965 100755
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/Kconfig
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/Kconfig
@@ -1,6 +1,3 @@
-menu "SoC PON support"
-depends on MV_INCLUDE_PON
-
 config PON_Z1
 	bool "Support for PON Z1 Driver"
 	default n
@@ -120,4 +117,3 @@ config  MV_EPON_DBA_HIGH_RATE_VALUE
 	default 2000
 	---help---
       Default EPON DBA high rate const value in unit of bytes
-endmenu
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/Makefile b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/Makefile
index 0e14468..2f5ab1d 100755
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/Makefile
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/Makefile
@@ -5,12 +5,11 @@ ifneq ($(MACHINE),)
 include $(srctree)/$(MACHINE)/config/mvRules.mk
 endif
 
-###ifdef CONFIG_MV_HAL_RULES_PATH
-###include $(srctree)/include/config/auto.conf
-###include $(srctree)/$(subst ",,$(CONFIG_MV_HAL_RULES_PATH))
-###endif
+PON_HAL_DIR = ../../mv_hal/pon
 
-PON_OBJ += plat/ponOnuBoard.o \
+PON_OBJ += $(PON_HAL_DIR)/mvPonOnuRegs.o \
+	$(PON_HAL_DIR)/mvPonOnuMac.o \
+	plat/ponOnuBoard.o \
 	plat/ponOnuLnxKsOs.o \
 	perf/ponOnuLnxKsMI.o
 
-- 
1.7.5.4

