From 988d2c28486646cf5a1a6c4d56aea0bb3870e215 Mon Sep 17 00:00:00 2001
From: Tawfik Bayouk <tawfik@marvell.com>
Date: Mon, 3 Sep 2012 19:04:08 +0300
Subject: [PATCH 0249/1825] LPAE: Fix mvOs APIs to use dma_addr_t instead of
 U32 variables for phys-addr

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit d91a5ea68a8e7d61ea376115a0b86538c27fa4a6

Change-Id: I920ed4b042e703ef9cd6dc72dd1572972a6a16ff
Signed-off-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/linux_oss/mvOs.c |   15 ++++++++++-----
 1 files changed, 10 insertions(+), 5 deletions(-)

diff --git a/arch/arm/plat-armada/linux_oss/mvOs.c b/arch/arm/plat-armada/linux_oss/mvOs.c
index db7018e..824ccc3 100644
--- a/arch/arm/plat-armada/linux_oss/mvOs.c
+++ b/arch/arm/plat-armada/linux_oss/mvOs.c
@@ -68,20 +68,25 @@ static MV_U32 read_p15_c1 (void);
 void* mvOsIoCachedMalloc( void* osHandle, MV_U32 size, MV_ULONG* pPhyAddr,
 			  MV_U32 *memHandle)
 {
-    void *p = kmalloc( size, GFP_ATOMIC );
-    *pPhyAddr = pci_map_single( osHandle, p, 0, PCI_DMA_BIDIRECTIONAL );
-    return p;
+	void *p = kmalloc(size, GFP_ATOMIC);
+	dma_addr_t dma_addr;
+	dma_addr = pci_map_single(osHandle, p, 0, PCI_DMA_BIDIRECTIONAL);
+	*pPhyAddr = (MV_ULONG)(dma_addr & 0xFFFFFFFF);
+	return p;
 }
 void* mvOsIoUncachedMalloc( void* osHandle, MV_U32 size, MV_ULONG* pPhyAddr,
 			    MV_U32 *memHandle)
 {
-    return pci_alloc_consistent( osHandle, size, (dma_addr_t *)pPhyAddr );
+	dma_addr_t dma_addr;
+	void *ptr = pci_alloc_consistent(osHandle, size, &dma_addr);
+	*pPhyAddr = (MV_ULONG)(dma_addr & 0xFFFFFFFF);
+	return ptr;
 }
  
 void mvOsIoUncachedFree( void* osHandle, MV_U32 size, MV_ULONG phyAddr, void* pVirtAddr,
 			 MV_U32 memHandle)
 {
-    return pci_free_consistent( osHandle, size, pVirtAddr, (dma_addr_t)phyAddr );
+	pci_free_consistent(osHandle, size, pVirtAddr, (dma_addr_t)phyAddr);
 } 
                                                                                                                                                
 void mvOsIoCachedFree( void* osHandle, MV_U32 size, MV_ULONG phyAddr, void* pVirtAddr,
-- 
1.7.5.4

