From 26eae71a6cf30dca1a98946ec81b1308ebf3534b Mon Sep 17 00:00:00 2001
From: Joe Zhou <shjzhou@marvell.com>
Date: Tue, 4 Mar 2014 08:19:46 +0800
Subject: [PATCH 1429/1825] alp: Remove IOCC WA for ALP A0

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 3bd3924b4c87aab7898decd0d3d186c6ee0dbdbb

	The main change is dma_io_sync, for Z version, it will do the same
	as before, for A0 version, it will write 0x1 to register
	CPU_IO_SYNC_BARRIER_CTRL_REG.

Signed-off-by: Joe Zhou <shjzhou@marvell.com>

Change-Id: Ia16a0ad45013ba592d433a083eff2d168d047ad4
Reviewed-on: http://vgitil04.il.marvell.com:8080/6101
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Tested-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/core.c                  |   40 +++++++++++++----------
 arch/arm/mach-avantalp/include/mach/avantalp.h |    1 +
 2 files changed, 24 insertions(+), 17 deletions(-)

diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index 6ae2c24..2e4c509 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -1571,31 +1571,37 @@ static void *dma_io_sync_buff_virt[CONFIG_NR_CPUS];
 
 void dma_io_sync(void)
 {
-	/* XXX: temporary disabled for AMP */
+	if (mvCtrlRevGet() <= MV_88F66X0_Z3_ID) {
+		/* XXX: temporary disabled for AMP */
 #ifndef CONFIG_MV_AMP_ENABLE
-	u32 data;
-	volatile u32 *virt;
-	int cpu = smp_processor_id();
+		u32 data;
+		volatile u32 *virt;
+		int cpu = smp_processor_id();
 
-	virt = dma_io_sync_buff_virt[cpu];
+		virt = dma_io_sync_buff_virt[cpu];
 
-	/* Write '1' to the first word of the buffer */
-	*virt = 0x1;
+		/* Write '1' to the first word of the buffer */
+		*virt = 0x1;
 
-	/* Wait until the engine is idle */
-	while ((MV_REG_READ(XOR_ACTIVATION_REG(0, cpu)) >> 4) & 0x3)
-		;
+		/* Wait until the engine is idle */
+		while ((MV_REG_READ(XOR_ACTIVATION_REG(0, cpu)) >> 4) & 0x3)
+			;
 
-	dmb();
+		dmb();
 
-	/* Trigger channel */
-	MV_REG_WRITE((XOR_ACTIVATION_REG(0, cpu)), 0x1);
+		/* Trigger channel */
+		MV_REG_WRITE((XOR_ACTIVATION_REG(0, cpu)), 0x1);
 
-	/* Poll the data until it is cleared by the XOR engine */
-	do {
-		data = *virt;
-	} while (data);
+		/* Poll the data until it is cleared by the XOR engine */
+		do {
+			data = *virt;
+		} while (data);
 #endif
+	} else {
+		writel(0x1, CPU_IO_SYNC_BARRIER_CTRL_REG);
+		do {
+		} while (readl(CPU_IO_SYNC_BARRIER_CTRL_REG) & 0x1);
+	}
 }
 EXPORT_SYMBOL(dma_io_sync);
 
diff --git a/arch/arm/mach-avantalp/include/mach/avantalp.h b/arch/arm/mach-avantalp/include/mach/avantalp.h
index a950729..e028faa 100644
--- a/arch/arm/mach-avantalp/include/mach/avantalp.h
+++ b/arch/arm/mach-avantalp/include/mach/avantalp.h
@@ -147,6 +147,7 @@
 #define IN_DOORBELL_CAUSE		0x78
 #define IN_DRBEL_CAUSE			(PER_CPU_BASE | 0x78)
 #define IN_DRBEL_MSK			(PER_CPU_BASE | 0x7c)
+#define CPU_IO_SYNC_BARRIER_CTRL_REG	(PER_CPU_BASE | 0x10)
 
 #ifndef __ASSEMBLY__
 u32 alp_soc_timer_rate_get(void);
-- 
1.7.5.4

