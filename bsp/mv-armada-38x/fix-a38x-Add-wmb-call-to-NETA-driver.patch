From 504d434b2c3cc8ce0daa52dc4f830a027503c2a0 Mon Sep 17 00:00:00 2001
From: Dmitri Epshtein <dima@marvell.com>
Date: Wed, 20 Nov 2013 09:38:09 -0500
Subject: [PATCH 1149/1825] fix: a38x: Add wmb() call to NETA driver

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 23ccc7357f5359f85db9108eff4606a505340f02

	- Fix issue detected on NAS test
	- Needed for a38x and doesn't need on AXP and A370
	because PJ4B CPU

Change-Id: I9546dbee2e73920753a7235e7dd8ddde0e538118
Signed-off-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_neta/l2fw/mv_eth_l2fw.c      |    4 ++--
 .../mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c     |    8 ++++++--
 .../mv_drivers_lsp/mv_neta/net_dev/mv_netdev.h     |    5 +++++
 3 files changed, 13 insertions(+), 4 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/l2fw/mv_eth_l2fw.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/l2fw/mv_eth_l2fw.c
index c0d86c6..0d3ff1b 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/l2fw/mv_eth_l2fw.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/l2fw/mv_eth_l2fw.c
@@ -657,6 +657,7 @@ static inline MV_STATUS mv_eth_l2fw_tx(struct eth_pbuf *pkt, struct eth_port *pp
 			return MV_DROPPED;
 		}
 	}
+	mv_neta_wmb();
 	mvNetaTxqPendDescAdd(pp->port, pp->txp, txq, 1);
 
 	mv_eth_unlock(txq_ctrl, flags);
@@ -838,8 +839,7 @@ static inline int mv_eth_l2fw_rx(struct eth_port *pp, int rx_todo, int rxq)
 	} /* of while */
 
 	/* Update RxQ management counters */
-	mvOsCacheIoSync();
-
+	mv_neta_wmb();
 	mvNetaRxqDescNumUpdate(pp->port, rxq, rx_done, rx_filled);
 
 	return rx_done;
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
index 0d705fa..b29cd81 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
@@ -1863,7 +1863,7 @@ static inline int mv_eth_rx(struct eth_port *pp, int rx_todo, int rxq, struct na
 	}
 
 	/* Update RxQ management counters */
-	mvOsCacheIoSync();
+	mv_neta_wmb();
 	mvNetaRxqDescNumUpdate(pp->port, rxq, rx_done, rx_filled);
 
 	return rx_done;
@@ -2029,6 +2029,7 @@ static int mv_eth_tx(struct sk_buff *skb, struct net_device *dev)
 #endif /* CONFIG_MV_PON */
 
 	/* Enable transmit */
+	mv_neta_wmb();
 	mvNetaTxqPendDescAdd(pp->port, tx_spec.txp, tx_spec.txq, frags);
 
 	STAT_DBG(txq_ctrl->stats.txq_tx += frags);
@@ -2315,6 +2316,7 @@ int mv_eth_tx_tso(struct sk_buff *skb, struct net_device *dev,
 	STAT_DBG(priv->stats.tx_tso_bytes += totalBytes);
 	STAT_DBG(txq_ctrl->stats.txq_tx += totalDescNum);
 
+	mv_neta_wmb();
 	mvNetaTxqPendDescAdd(priv->port, txq_ctrl->txp, txq_ctrl->txq, totalDescNum);
 /*
 	printk(KERN_ERR "mv_eth_tx_tso EXIT: totalDescNum=%d\n", totalDescNum);
@@ -2364,7 +2366,7 @@ static void mv_eth_rxq_drop_pkts(struct eth_port *pp, int rxq)
 		mv_eth_rxq_refill(pp, rxq, pkt, pool, rx_desc);
 	}
 	if (rx_done) {
-		mvOsCacheIoSync();
+		mv_neta_wmb();
 		mvNetaRxqDescNumUpdate(pp->port, rxq, rx_done, rx_done);
 	}
 }
@@ -3003,6 +3005,8 @@ int mv_eth_poll(struct napi_struct *napi, int budget)
 
 		if (!(pp->flags & MV_ETH_F_IFCAP_NETMAP)) {
 			local_irq_save(flags);
+
+			mv_neta_wmb();
 			MV_REG_WRITE(NETA_INTR_NEW_MASK_REG(pp->port),
 			     (MV_ETH_MISC_SUM_INTR_MASK | MV_ETH_TXDONE_INTR_MASK | MV_ETH_RX_INTR_MASK));
 
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.h b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.h
index 17e6650..9ca226c 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.h
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.h
@@ -157,6 +157,11 @@ int mv_eth_skb_recycle(struct sk_buff *skb);
 		MV_ETH_LIGHT_UNLOCK(flags)		      \
 }
 
+#if defined(CONFIG_CPU_SHEEVA_PJ4B_V7) || defined(CONFIG_CPU_SHEEVA_PJ4B_V6)
+#  define mv_neta_wmb()
+#else
+#  define mv_neta_wmb() wmb()
+#endif
 
 /******************************************************
  * rx / tx queues --                                  *
-- 
1.7.5.4

