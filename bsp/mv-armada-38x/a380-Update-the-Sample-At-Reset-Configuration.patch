From a1bdc656439ac7d2cab38dc78bbf8b8a513c2f2c Mon Sep 17 00:00:00 2001
From: Tawfik Bayouk <tawfik@marvell.com>
Date: Mon, 28 Oct 2013 15:43:55 +0200
Subject: [PATCH 1126/1825] a380: Update the Sample At Reset Configuration

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit b844942842effff709b86f2e863ba3446011d0b2

	Update the SAR table and u-boot command to take the correct
	values according to the spec. Allowing only external options
	1066/533, 1333/667, 1600/800

Change-Id: I7501970c72597d271c84346d54a35ec35aacda00
Reviewed-on: http://vgitil04.il.marvell.com:8080/4176
Tested-by: Omri Itach <omrii@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/boardEnv/mvBoardEnvLib.c     |   36 ----------------
 .../armada_38x_family/boardEnv/mvBoardEnvLib.h     |    1 -
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.c       |   41 ++++--------------
 .../armada_38x_family/ctrlEnv/mvCtrlEnvLib.h       |    1 -
 .../armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h      |   44 +++----------------
 .../armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h      |    3 -
 6 files changed, 16 insertions(+), 110 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
index 4eaccac..fec605b 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
@@ -1130,42 +1130,6 @@ MV_U32 mvBoardSwitchPortForceLinkGet(MV_U32 switchIdx)
 }
 
 /*******************************************************************************
-* mvBoardFreqModesNumGet
-*
-* DESCRIPTION: Return the number of supported frequency modes for this SoC
-*
-*
-* INPUT:
-*      None.
-*
-* OUTPUT:
-*      None.
-*
-* RETURN:
-*      Number of supported frequency modes
-*
-*******************************************************************************/
-MV_U32 mvBoardFreqModesNumGet()
-{
-	MV_U32 freqNum;
-
-	switch (mvCtrlModelGet()) {
-	case MV_6810_DEV_ID:
-		freqNum = FREQ_MODES_NUM_6810;
-		break;
-	case MV_6820_DEV_ID:
-		freqNum = FREQ_MODES_NUM_6820;
-		break;
-	default:
-		mvOsPrintf("%s: Error: failed to read ctrlModel (SoC ID)\n", __func__);
-		return MV_ERROR;
-	}
-
-	return freqNum;
-}
-
-
-/*******************************************************************************
 * mvBoardConfigWrite - write MPP's config and Board general environment configuration
 *
 * DESCRIPTION:
diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
index e3f02e4..e37a9f9 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
@@ -485,7 +485,6 @@ MV_U8 mvBoardCpuFreqGet(MV_VOID);
 MV_STATUS mvBoardCpuFreqSet(MV_U8 freqVal);
 MV_STATUS mvBoardIsInternalSwitchConnected(void);
 MV_U32 mvBoardSwitchPortForceLinkGet(MV_U32 switchIdx);
-MV_U32 mvBoardFreqModesNumGet(void);
 MV_32 mvBoardSmiScanModeGet(MV_U32 switchIdx);
 MV_BOARD_MAC_SPEED mvBoardMacSpeedGet(MV_U32 ethPortNum);
 MV_VOID mvBoardMacSpeedSet(MV_U32 ethPortNum, MV_BOARD_MAC_SPEED macSpeed);
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
index c73f69f..394e930 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.c
@@ -139,34 +139,6 @@ MV_U32 mvCtrlGetCpuNum(MV_VOID)
 	return 0;
 }
 
-/*******************************************************************************
-* mvCtrlIsValidSatR
-*
-* DESCRIPTION: check frequency modes table and verify current mode is supported
-*
-* INPUT: None
-*
-* OUTPUT: None
-*
-* RETURN:
-*        MV_TRUE - if current cpu/ddr/l2 frequency mode is supported for board
-*
-*******************************************************************************/
-MV_BOOL mvCtrlIsValidSatR(MV_VOID)
-{
-	MV_U32 i, cpuFreqMode, maxFreqModes = mvBoardFreqModesNumGet();
-	MV_FREQ_MODE pFreqModes[] = MV_USER_SAR_FREQ_MODES;
-
-	cpuFreqMode =  mvBoardSatRRead(MV_SATR_CPU_DDR_L2_FREQ);
-
-	for (i = 0; i < maxFreqModes; i++) {
-		if (cpuFreqMode == pFreqModes[i].id)
-			return MV_TRUE;
-	}
-
-	return MV_FALSE;
-}
-
 #ifdef MV_INCLUDE_PEX
 MV_STATUS mvCtrlUpdatePexId(MV_VOID)
 {
@@ -390,14 +362,19 @@ MV_STATUS mvCtrlEnvInit(MV_VOID)
 MV_STATUS mvCtrlCpuDdrL2FreqGet(MV_FREQ_MODE *freqMode)
 {
 	MV_FREQ_MODE freqTable[] = MV_SAR_FREQ_MODES;
-	MV_U32 freqModeSatRValue, satrVal;
+	MV_U32 freqModeSatRValue, satrVal, i;
 
 	satrVal = MV_REG_READ(MPP_SAMPLE_AT_RESET);
 	freqModeSatRValue = (satrVal & SATR_CPU_FREQ_MASK) >> SATR_CPU_FREQ_OFFS;
 
-	if (freqModeSatRValue <= 29) {
-		*freqMode = freqTable[freqModeSatRValue];
-		return MV_OK;
+	for (i = 0; i <= MV_SAR_FREQ_MODES_EOT; i++) {
+		if (freqTable[i].id == MV_SAR_FREQ_MODES_EOT)
+			break;  /* reached end of table */
+
+		if (freqTable[i].id == freqModeSatRValue) {
+			*freqMode = freqTable[i];
+			return MV_OK;
+		}
 	}
 	DB(mvOsPrintf("%s: Error Read from S@R fail\n", __func__));
 	return MV_ERROR;
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
index da4b5a9..f804eae 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvLib.h
@@ -210,7 +210,6 @@ MV_U32 mvCtrlSysConfigGet(MV_CONFIG_TYPE_ID configField);
 MV_U32 mvCtrlGetCpuNum(MV_VOID);
 MV_U32 mvCtrlGetQuadNum(MV_VOID);
 MV_STATUS mvCtrlUpdatePexId(MV_VOID);
-MV_BOOL mvCtrlIsValidSatR(MV_VOID);
 MV_BOOL mvCtrlIsEepromEnabled(MV_VOID);
 MV_STATUS mvCtrlEepromEnable(MV_BOOL enable);
 MV_STATUS mvCtrlBoardConfigGet(MV_U8 *tempVal);
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
index 04732a8..d2c94fd 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvRegs.h
@@ -288,44 +288,14 @@ typedef struct {
 	MV_U32 l2Freq;
 } MV_FREQ_MODE;
 
-#define MV_SAR_FREQ_MODES { \
-		{ 0,  266,  266, 133 }, \
-		{ 1,  333,  167, 167 }, \
-		{ 2,  333,  222, 167 }, \
-		{ 3,  333,  333, 167 }, \
-		{ 4,  400,  200, 200 }, \
-		{ 5,  400,  267, 200 }, \
-		{ 6,  400,  400, 200 }, \
-		{ 7,  500,  250, 250 }, \
-		{ 8,  500,  334, 250 }, \
-		{ 9,  500,  400, 250 }, \
-		{ 10, 533,  267, 267 }, \
-		{ 11, 533,  356, 267 }, \
-		{ 12, 533,  533, 267 }, \
-		{ 13, 600,  300, 300 }, \
-		{ 14, 600,  400, 300 }, \
-		{ 15, 600,  600, 300 }, \
-		{ 16, 666,  333, 333 }, \
-		{ 17, 666,  444, 333 }, \
-		{ 18, 666,  666, 333 }, \
-		{ 19, 800,  267, 400 }, \
-		{ 20, 800,  400, 400 }, \
-		{ 21, 800,  534, 400 }, \
-		{ 22, 900,  300, 450 }, \
-		{ 23, 900,  450, 450 }, \
-		{ 24, 900,  600, 450 }, \
-		{ 25, 1000, 500, 500 }, \
-		{ 26, 1000, 667, 500 }, \
-		{ 27, 1000, 500, 333 }, \
-		{ 28, 400,  400, 400 }, \
-		{ 29, 1100, 550, 550 } \
-};
+/* End of Table indicator - Should be in the last line of the SAR Table */
+#define MV_SAR_FREQ_MODES_EOT		0xFF
 
-#define MV_USER_SAR_FREQ_MODES { \
-		{ 6,  400,  400, 200 }, \
-		{ 14, 600,  400, 300 }, \
-		{ 21, 800,  534, 400 }, \
-		{ 25, 1000, 500, 500 }, \
+#define MV_SAR_FREQ_MODES { \
+		{ 0x4,   1066, 533, 266 }, \
+		{ 0x8,   1332, 666, 333 }, \
+		{ 0xC,   1600, 800, 400 }, \
+		{ MV_SAR_FREQ_MODES_EOT,  0,    0,   0   } \
 };
 
 /* These macros help units to identify a target Mport Arbiter group */
diff --git a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
index ae9d761..b1e9e41 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/ctrlEnv/mvCtrlEnvSpec.h
@@ -242,9 +242,6 @@ extern "C" {
 #ifndef MV_ASMLANGUAGE
 
 #define TBL_UNUSED      0       /* Used to mark unused entry */
-#define FREQ_MODES_NUM		29
-#define FREQ_MODES_NUM_6810	3
-#define FREQ_MODES_NUM_6820	3
 
 
 /* This enumerator defines the Marvell Units ID      */
-- 
1.7.5.4

