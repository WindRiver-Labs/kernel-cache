From d5e40e04b716ff22531381a1e3480bf89eab8883 Mon Sep 17 00:00:00 2001
From: Eli Nidam <elini@marvell.com>
Date: Mon, 30 Dec 2013 13:42:50 +0200
Subject: [PATCH 1257/1825] a38x: update IO expander table depended on RD
 configuration

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit bdb1726656b835e06f30cb69bc4665b4449fa4e5

	Update RD board IO expander table depended on S@R configuration (SGMII or USB3)

Change-Id: I526024cefb70655527b17729d17b9388d95e2be2
Signed-off-by: Eli Nidam <elini@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4947
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Nadav Haklai <nadavh@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../armada_38x_family/boardEnv/mvBoardEnvLib.c     |   84 +++++++++++++++++++-
 .../armada_38x_family/boardEnv/mvBoardEnvLib.h     |    2 +
 2 files changed, 83 insertions(+), 3 deletions(-)

diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
index 34c5e0a..037f1d2 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.c
@@ -1055,9 +1055,19 @@ MV_STATUS mvBoardEthComplexInfoUpdate(MV_VOID)
 MV_STATUS mvBoardIoExpanderUpdate(MV_VOID)
 {
 	MV_U32 i = 0;
-
-	if ((board->pIoExp == NULL) || (0 == board->numIoExp))
-		return MV_OK;
+	MV_U8 ioValue;
+	MV_U32 tmp;
+
+	if (mvBoardIoExpanderGet(0, 2, &ioValue) == MV_ERROR)
+		return MV_OK; /* ignore for boards not supported IO expander */
+	tmp = mvBoardSatRRead(MV_SATR_RD_NAS_SERDES4_CFG);
+	if (tmp != MV_ERROR) { /* ignore for none RD_NAS board */
+		if (tmp == 0) /* 0 = USB3.  1 = SGMII. */
+			ioValue |= 1 ;	/* Setting USB3.0 interface: configure IO as output '1' */
+		else
+			ioValue &= ~1 ;	/* Setting SGMII interface:  configure IO as output '0' */
+		mvBoardIoExpanderSet(0, 2, ioValue);
+	}
 
 	for (i = 0; i < board->numIoExp; i++) {
 		if (MV_OK != mvBoardTwsiSet(BOARD_TWSI_IO_EXPANDER, board->pIoExp[i].addr,
@@ -2481,3 +2491,71 @@ int mvBoardNorFlashConnect(void)
 		return MV_TRUE;
 	return MV_FALSE;
 }
+/****************************************************************************************
+* mvBoardIoExpanderGet
+*
+* DESCRIPTION:
+*	Return the IO Expander value for a given address and offset.
+*
+* INPUT:
+*	addr - IO expander address.
+*	offs - IO expander offset
+*	pValue - pointer saved value
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*       if addr and offset are exist save the value in input pointer and returns  MV_OK
+*       else returns MV_ERROR
+*
+****************************************************************************************/
+MV_STATUS mvBoardIoExpanderGet(MV_U8 addr, MV_U8 offs, MV_U8 *pVal)
+{
+	int i;
+
+	if ((board->pIoExp == NULL) || (0 == board->numIoExp))
+		return MV_ERROR;
+
+	for (i = 0; i < board->numIoExp; i++) {
+		if ((board->pIoExp[i].addr == addr) &&
+		    (board->pIoExp[i].offset == offs)) {
+			*pVal = board->pIoExp[i].val;
+		    return MV_OK;
+		}
+	}
+	return MV_ERROR;
+}
+/*******************************************************************************
+* mvBoardIoExpanderSet
+*
+* DESCRIPTION:
+*	Save the IO Expander value for a given index.
+*
+* INPUT:
+*	index	  - The IO expander index
+*	val	  - The IO expander value to save
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*       if addr and offset are exist save the value and returns  MV_OK
+*       else returns MV_ERROR
+*******************************************************************************/
+MV_STATUS mvBoardIoExpanderSet(MV_U8 addr, MV_U8 offs, MV_U8 val)
+{
+	int i;
+
+	if ((board->pIoExp == NULL) || (0 == board->numIoExp))
+		return MV_ERROR;
+
+	for (i = 0; i < board->numIoExp; i++) {
+		if ((board->pIoExp[i].addr == addr) &&
+		    (board->pIoExp[i].offset == offs)) {
+			board->pIoExp[i].val = val;
+			return MV_OK;
+		}
+	}
+	return MV_ERROR;
+}
diff --git a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
index ff78281..67cc91c 100644
--- a/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-armada38x/armada_38x_family/boardEnv/mvBoardEnvLib.h
@@ -535,6 +535,8 @@ MV_STATUS mvBoardTwsiSatRGet(MV_U8 devNum, MV_U8 regNum, MV_U8 *pData);
 MV_STATUS mvBoardTwsiSatRSet(MV_U8 devNum, MV_U8 regNum, MV_U8 regVal);
 MV_U32 mvBoardSatRRead(MV_SATR_TYPE_ID satrField);
 MV_STATUS mvBoardSatRWrite(MV_SATR_TYPE_ID satrWriteField, MV_U8 val);
+MV_STATUS mvBoardIoExpanderGet(MV_U8 addr, MV_U8 offs, MV_U8 *pVal);
+MV_STATUS mvBoardIoExpanderSet(MV_U8 addr, MV_U8 offs, MV_U8 val);
 int mvBoardNorFlashConnect(void);
 
 /*						bit    TWSI           Reg	board	*/
-- 
1.7.5.4

