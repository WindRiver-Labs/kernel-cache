From b829e897adbe515744068d6e53a6a3d97c4c7781 Mon Sep 17 00:00:00 2001
From: Shadi Ammouri <shadi@marvell.com>
Date: Sun, 16 Dec 2012 13:47:32 +0200
Subject: [PATCH 0382/1825] Fix bug in internal registers address switching.

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit a9fdc089d0fea2916ac7b3a97d7104c3d5c55d87

Perform byte-swap before writing the registers in BE mode.

Bug Fix: This patch should be merged into stable branch.

Change-Id: I6fc6662c5d3ed8ad1d10fe653d83eaafc24f6de9

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/boot/compressed/head.S |   29 +++++++++++++++++------------
 1 files changed, 17 insertions(+), 12 deletions(-)

diff --git a/arch/arm/boot/compressed/head.S b/arch/arm/boot/compressed/head.S
index 6d87813..ce422e8 100644
--- a/arch/arm/boot/compressed/head.S
+++ b/arch/arm/boot/compressed/head.S
@@ -123,17 +123,6 @@
 		.align
 		.arm				@ Always enter in ARM state
 start:
-#ifdef CONFIG_ARCH_ARMADA_XP
-		/* Update Internal Regs offset in case UBoot is configured
-		** to use a different base address.
-		*/
-		mrc p15, 4, r0, c15, c0, 0	@ Get the internal registers base address
-		lsl r0, r0, #13			@ the address is R-shifted, need to recover it
-		ldr r5, =0x20080
-		add r0, r0, r5
-		ldr r6, =INTER_REGS_PHYS_BASE
-		str r6, [r0]
-#endif
 		.type	start,#function
 		.rept	7
 		mov	r0, r0
@@ -150,7 +139,23 @@ start:
 		.word	start			@ absolute load/run zImage address
 		.word	_edata			@ zImage end address
  THUMB(		.thumb			)
-1:		mov	r7, r1			@ save architecture ID
+1:
+#ifdef CONFIG_ARCH_ARMADA_XP
+		/* Update Internal Regs offset in case UBoot is configured
+		** to use a different base address.
+		*/
+		mrc p15, 4, r0, c15, c0, 0	@ Get the internal registers base address
+		lsl r0, r0, #13			@ the address is R-shifted, need to recover it
+		ldr r5, =0x20080
+		add r0, r0, r5
+		ldr r6, =INTER_REGS_PHYS_BASE
+#ifdef CONFIG_BE8_ON_LE
+		rev r6, r6
+#endif
+		str r6, [r0]
+#endif
+
+		mov	r7, r1			@ save architecture ID
 		mov	r8, r2			@ save atags pointer
 
 #ifndef __ARM_ARCH_2__
-- 
1.7.5.4

