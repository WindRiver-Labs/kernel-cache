From 6e909ac3de698b4eb023b83fd6e8f60fe57188e4 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Wed, 22 May 2013 11:34:57 +0300
Subject: [PATCH 0671/1825] ALP: fixed DDR bus width detection

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 993d7b8c52e9d2c70eccc4dd4a6635b7c61d6084

- Added DDR bus width offset define

Change-Id: I27849e321c485e49598d83a325b71b3f0e324b79
Signed-off-by: Omri Itach <omrii@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/1923
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |    4 ++--
 arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIfRegs.h  |    1 +
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index a357ab6..e72df09 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -1766,9 +1766,9 @@ MV_U32 mvCtrlDDRBudWidth(MV_VOID)
 {
 	MV_U32 reg;
 
-	reg = MV_REG_READ(0x1400);
+	reg = MV_REG_READ(REG_SDRAM_CONFIG_ADDR);
 
-	return (reg & 0x8000) ? 64 : 32;
+	return (reg & (0x1 << REG_SDRAM_CONFIG_DDR_BUS_OFFS)) ? 32 : 16;
 }
 
 MV_BOOL mvCtrlDDRThruXbar(MV_VOID)
diff --git a/arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIfRegs.h b/arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIfRegs.h
index f2380df..6ee003e 100644
--- a/arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIfRegs.h
+++ b/arch/arm/plat-armada/mv_hal/ddr2_3/mvDramIfRegs.h
@@ -159,6 +159,7 @@ extern "C" {
 #define ECC_SUPPORT
 #define REG_SDRAM_CONFIG_ADDR                                   0x1400
 #define REG_SDRAM_CONFIG_ECC_OFFS                               18
+#define REG_SDRAM_CONFIG_DDR_BUS_OFFS				15
 #define REG_SDRAM_CONFIG_IERR									19
 #define REG_STATIC_DRAM_DLB_CONTROL                             0x1700
 #define DLB_ENABLE 0x1
-- 
1.7.5.4

