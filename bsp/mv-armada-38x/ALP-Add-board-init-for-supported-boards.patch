From 9fe6c9f60b0e592d3bedfafee8dccbb6077b84ae Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Mon, 8 Apr 2013 11:29:58 +0300
Subject: [PATCH 0555/1825] ALP: Add board init for supported boards

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 197e3aac668700db1b520784ce49b2683851ddfd

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: If61c8c4ac0696b2600ffbbc4a36c0cc1e19fc2e6
Reviewed-on: http://vgitil04.il.marvell.com:8080/1502
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-avantalp/core.c |  122 +++++++++++++++++++++++++++--------------
 arch/arm/tools/mach-types     |    8 ++-
 2 files changed, 86 insertions(+), 44 deletions(-)

diff --git a/arch/arm/mach-avantalp/core.c b/arch/arm/mach-avantalp/core.c
index 15a6229..b87264e 100644
--- a/arch/arm/mach-avantalp/core.c
+++ b/arch/arm/mach-avantalp/core.c
@@ -617,79 +617,77 @@ extern void printascii(const char *);
  * FPGA BOARD: Main Initialization
  ****************************************************************************/
 extern MV_TARGET_ATTRIB mvTargetDefaultsArray[];
-static void __init alp_fpga_init(void)
-{
-#ifdef CONFIG_CACHE_L2X0
-	void __iomem *l2x0_base = INTER_REGS_VIRT_BASE + MV_CA9X2_L2CC_OFFSET;
-	l2x0_init(l2x0_base, 0x00400000, 0xfe0fffff);
-#endif
 
-#if 0
-	/* Select appropriate Board ID for Machine */
-	gBoardId = MV_BOARD_ID_AVANTA_LP_FPGA;
-	/* Bypass serdes reconfiguration since already done at bootloader */
-	mvBoardSerdesConfigurationEnableSet(MV_FALSE);
-
-	/* init the Board environment */
+static void __init board_common_init(void)
+{
 	mvBoardEnvInit();
-
-	/* init the controller environment */
-	if ( mvCtrlEnvInit() ) {
+	if (mvCtrlEnvInit()) {
 		printk("Controller env initialization failed.\n");
 		return;
 	}
 
 	/* Replace PCI-0 Attribute for FPGA 0xE => 0xD */
 	mvTargetDefaultsArray[PEX0_MEM].attrib = 0xD8;
-
-	/* Init the CPU windows setting and the access protection windows. */
-	/*if( mvCpuIfInit(mv_sys_map())) {
-	        printk( "Cpu Interface initialization failed.\n" );
-	        return;
-	   }*/
-
 	avantalp_setup_cpu_mbus();
 
+#ifdef CONFIG_CACHE_L2X0
+	void __iomem *l2x0_base = INTER_REGS_VIRT_BASE + MV_CA9X2_L2CC_OFFSET;
+	l2x0_init(l2x0_base, 0x00400000, 0xfe0fffff);
+#endif
+
 	/* Init the CPU windows setting and the access protection windows. */
-	if ( mvCpuIfInit(mv_sys_map())) {
+	if (mvCpuIfInit(mv_sys_map())) {
 		printk("Cpu Interface initialization failed.\n");
 		return;
 	}
 
-	/* Init Tclk & SysClk */
 	mvTclk = mvBoardTclkGet();
 	mvSysclk = mvBoardSysClkGet();
 
 	elf_hwcap &= ~HWCAP_JAVA;
 
-	//serial_initialize(0);
-
-	/* At this point, the CPU windows are configured according to default definitions in mvSysHwConfig.h */
-	/* and cpuAddrWinMap table in mvCpuIf.c. Now it's time to change defaults for each platform.         */
-	/*mvCpuIfAddDecShow();*/
+	serial_initialize(0);
 
+	mvCpuIfAddDecShow();
 	print_board_info();
 
 	mv_gpio_init();
-
-	/* RTC */
 	rtc_init();
 
 #ifdef CONFIG_MV_ETHERNET
 	mvSysEthPhyInit();
-
-	/* Ethernet */
 	eth_init();
 #endif
+}
 
-#endif
+static void __init board_fpga_init(void)
+{
+	gBoardId = MV_BOARD_ID_AVANTA_LP_FPGA;
+	board_common_init();
+}
 
-	serial_initialize(0);
+static void __init board_db88f6660_init(void)
+{
+	gBoardId = DB_6660_ID;
+	board_common_init();
+}
 
-	if ( mvCpuIfInit(mv_sys_map())) {
-		printk("Cpu Interface initialization failed.\n");
-		return;
-	}
+static void __init board_rd88f6660_init(void)
+{
+	gBoardId = RD_6660_ID;
+	board_common_init();
+}
+
+static void __init board_db88f6650_init(void)
+{
+	gBoardId = DB_6650_ID;
+	board_common_init();
+}
+
+static void __init board_rd88f6650_init(void)
+{
+	gBoardId = RD_6650_ID;
+	board_common_init();
 }
 
 static void alp_restart(char mode, const char *cmd)
@@ -703,12 +701,52 @@ static void alp_restart(char mode, const char *cmd)
 
 extern void __init alp_init_irq(void);
 
-MACHINE_START(AVANTA_LP_FPGA, "Marvell Avanta LP FPGA Board")
+MACHINE_START(ALP_FPGA, "Marvell AvantaLP DB-88F6660 Board")
+	.atag_offset    = BOOT_PARAMS_OFFSET,
+	.map_io         = alp_map_io,
+	.init_irq       = alp_init_irq,
+	.timer          = &alp_timer,
+	.handle_irq     = gic_handle_irq,
+	.init_machine   = board_db88f6660_init,
+	.restart        = alp_restart,
+MACHINE_END
+
+MACHINE_START(ALP_DB88F6660, "Marvell AvantaLP RD-88F6660 Board")
+	.atag_offset    = BOOT_PARAMS_OFFSET,
+	.map_io         = alp_map_io,
+	.init_irq       = alp_init_irq,
+	.timer          = &alp_timer,
+	.handle_irq     = gic_handle_irq,
+	.init_machine   = board_rd88f6660_init,
+	.restart        = alp_restart,
+MACHINE_END
+
+MACHINE_START(ALP_RD88F6660, "Marvell AvantaLP DB-88F6650 Board")
+	.atag_offset    = BOOT_PARAMS_OFFSET,
+	.map_io         = alp_map_io,
+	.init_irq       = alp_init_irq,
+	.timer          = &alp_timer,
+	.handle_irq     = gic_handle_irq,
+	.init_machine   = board_db88f6650_init,
+	.restart        = alp_restart,
+MACHINE_END
+
+MACHINE_START(ALP_DB88F6650, "Marvell AvantaLP RD-88F6650 Board")
+	.atag_offset    = BOOT_PARAMS_OFFSET,
+	.map_io         = alp_map_io,
+	.init_irq       = alp_init_irq,
+	.timer          = &alp_timer,
+	.handle_irq     = gic_handle_irq,
+	.init_machine   = board_rd88f6650_init,
+	.restart        = alp_restart,
+MACHINE_END
+
+MACHINE_START(ALP_RD88F6650, "Marvell Avanta LP FPGA Board")
 	.atag_offset    = BOOT_PARAMS_OFFSET,
 	.map_io         = alp_map_io,
 	.init_irq       = alp_init_irq,
 	.timer          = &alp_timer,
 	.handle_irq     = gic_handle_irq,
-	.init_machine   = alp_fpga_init,
+	.init_machine   = board_fpga_init,
 	.restart        = alp_restart,
 MACHINE_END
diff --git a/arch/arm/tools/mach-types b/arch/arm/tools/mach-types
index df2b31c..967426a 100644
--- a/arch/arm/tools/mach-types
+++ b/arch/arm/tools/mach-types
@@ -119,8 +119,12 @@ omap_osk		MACH_OMAP_OSK		OMAP_OSK		515
 tosa			MACH_TOSA		TOSA			520
 avila			MACH_AVILA		AVILA			526
 xcat98dx		MACH_XCAT98DX		XCAT98DX		527
-armada_xp_fpga          MACH_ARMADA_XP_FPGA     ARMADA_XP_FPGA          528
-avanta_lp_fpga          MACH_AVANTA_LP_FPGA     AVANTA_LP_FPGA          529
+armada_xp_fpga		MACH_ARMADA_XP_FPGA	ARMADA_XP_FPGA		528
+avanta_lp_fpga		MACH_ALP_FPGA		ALP_FPGA		529
+avanta_lp_db88f660	MACH_ALP_DB88F6660	ALP_DB88F6660		530
+avanta_lp_rd88f660	MACH_ALP_RD88F6660	ALP_RD88F6660		531
+avanta_lp_db88f650	MACH_ALP_DB88F6650	ALP_DB88F6650		532
+avanta_lp_rd88f650	MACH_ALP_RD88F6650	ALP_RD88F6650		533
 edb9302			MACH_EDB9302		EDB9302			538
 husky			MACH_HUSKY		HUSKY			543
 shepherd		MACH_SHEPHERD		SHEPHERD		545
-- 
1.7.5.4

