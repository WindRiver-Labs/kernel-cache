From c52e9665d58866826d254fa5956396b73d051014 Mon Sep 17 00:00:00 2001
From: xigu <xigu@marvell.com>
Date: Thu, 13 Mar 2014 11:26:33 +0200
Subject: [PATCH 1460/1825] fix: alp: pon: GPON register issue with A0 board

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 582154b757d85ef8ab7e2f44d7506f7d1ede8a15

Change-Id: Ib5aa661fc2fad72e65e1e223561675312b98b95d
Signed-off-by: xigu <xigu@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/6383
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pon/core/gpon/gponOnuInit.c  |   12 +++++-------
 .../mv_drivers_lsp/mv_pon/core/gpon/gponOnuSrvc.c  |    2 +-
 .../mv_drivers_lsp/mv_pon/plat/gpon/gponOnuBoard.c |    3 +--
 .../mv_drivers_lsp/mv_pon/plat/ponOnuLnxKsOs.c     |    2 +-
 arch/arm/plat-armada/mv_hal/pon/mvPonOnuDefines.h  |    1 +
 5 files changed, 9 insertions(+), 11 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuInit.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuInit.c
index de3c974..ee7315c 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuInit.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuInit.c
@@ -607,13 +607,11 @@ MV_STATUS onuGponAsicBoardInit(void)
 
 #ifndef PON_FPGA
 #ifdef DISABLE_SERDES_FOR_AVANTA_LP
-	if (mvBoardIdGet() == RD_6660_ID) {
-		status = onuGponMppInit();
-		if (status != MV_OK) {
-			mvPonPrint(PON_PRINT_ERROR, PON_INIT_MODULE,
-				   "ERROR: (%s:%d) onuGponMppInit\n", __FILE_DESC__, __LINE__);
-			return status;
-		}
+	status = onuGponMppInit();
+	if (status != MV_OK) {
+		mvPonPrint(PON_PRINT_ERROR, PON_INIT_MODULE,
+			"ERROR: (%s:%d) onuGponMppInit\n", __FILE_DESC__, __LINE__);
+		return status;
 	}
 #endif
 #endif  /* PON_FPGA */
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuSrvc.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuSrvc.c
index 93489fe..7077922 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuSrvc.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/core/gpon/gponOnuSrvc.c
@@ -1591,7 +1591,7 @@ MV_STATUS onuGponOmciChannelAdd(MV_U16 gemPort, MV_U8 rxCpuQueue)
 	}
 
 	/* Get first free parser entry,  go through the all entires from last to first */
-	tid = mvPp2PrsTcamFirstFree(MV_PP2_PRS_TCAM_SIZE - 1, 0);
+	tid = mvPp2PrsTcamFirstFree(PE_LAST_FREE_TID, 0);
 	if (tid > MV_PP2_PRS_TCAM_SIZE - 1) {
 		printk(KERN_INFO "No free TCAM entry for traffic\n");
 		return MV_ERROR;
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/plat/gpon/gponOnuBoard.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/plat/gpon/gponOnuBoard.c
index 352eeae..9a5bd3c 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/plat/gpon/gponOnuBoard.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/plat/gpon/gponOnuBoard.c
@@ -233,8 +233,7 @@ MV_STATUS onuGponSerdesInit(void)
 	MV_U32 txReady;
 	MV_U32 rxReady;
 	MV_U32 initDone;
-
-#ifdef PON_A0
+#ifdef PON_FPGA
 	/* Reset SERDES */
 	/* ============ */
 	/* GponPhyReset         (0x184F4 bit3 set 1);   PHY in reset                    */
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/plat/ponOnuLnxKsOs.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/plat/ponOnuLnxKsOs.c
index 8290364..046ec30 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/plat/ponOnuLnxKsOs.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pon/plat/ponOnuLnxKsOs.c
@@ -294,7 +294,7 @@ int onuPonTimerDisable(S_OnuPonTimer *timerId)
 *******************************************************************************/
 MV_STATUS onuPonIrqNumInit(void)
 {
-#ifdef PON_A0
+#ifdef PON_FPGA
 	onuPonResourceTbl_s.onuPonIrqId.onuPonIrqNum = 111;     /* GPON_MAC_IRQ_NUM */
 #else
 	onuPonResourceTbl_s.onuPonIrqId.onuPonIrqNum = 83;      /* GPON_MAC_IRQ_NUM */
diff --git a/arch/arm/plat-armada/mv_hal/pon/mvPonOnuDefines.h b/arch/arm/plat-armada/mv_hal/pon/mvPonOnuDefines.h
index e478e81..8f207e2 100755
--- a/arch/arm/plat-armada/mv_hal/pon/mvPonOnuDefines.h
+++ b/arch/arm/plat-armada/mv_hal/pon/mvPonOnuDefines.h
@@ -95,6 +95,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define DISABLE_ADMIN_FOR_AVANTA_LP
 #define DISABLE_PRBS_FOR_AVANTA_LP
 #define DISABLE_DG_FOR_AVANTA_LP /* enable PON dying gasp feature */
+#define BURST_CFG_FOR_AVANTA_LP
 
 #ifdef CONFIG_MV_GPON
 
-- 
1.7.5.4

