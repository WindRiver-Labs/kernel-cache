From eac025d8fc8d6111efa73f11af2c88158603f464 Mon Sep 17 00:00:00 2001
From: Tawfik Bayouk <tawfik@marvell.com>
Date: Tue, 21 Aug 2012 17:33:50 +0300
Subject: [PATCH 0077/1825] NFP: Fix FIB learning. Skip direct src/dst entries

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 43c578ea58abb6cc7489d6b19b9b3549853b8ba6

Change-Id: I4a4d9d83520ee84383b72243f570109ddb6c35cf
Signed-off-by: Tawfik Bayouk <tawfik@marvell.com>
Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 net/ipv4/route.c |   22 +++++++++++-----------
 1 files changed, 11 insertions(+), 11 deletions(-)

diff --git a/net/ipv4/route.c b/net/ipv4/route.c
index 373a0a4..6c3d5d7 100644
--- a/net/ipv4/route.c
+++ b/net/ipv4/route.c
@@ -835,13 +835,16 @@ void nfp_fib_sync(void)
 	for (h = 0; h <= rt_hash_mask; h++) {
 		if (!rt_hash_table[h].chain)
 			continue;
+
 		rcu_read_lock_bh();
-		for (rt = rcu_dereference_bh(rt_hash_table[h].chain) ; rt;
+		for (rt = rcu_dereference_bh(rt_hash_table[h].chain); rt;
 		    rt = rcu_dereference_bh(rt->dst.rt_next)) {
 			if (rt_is_expired(rt))
 				continue;
+
 			rt->nfp = false;
-			if (!(rt->rt_flags & (RTCF_MULTICAST | RTCF_BROADCAST | RTCF_LOCAL | RTCF_REJECT))) {
+			if (!(rt->rt_flags & (RTCF_DIRECTSRC | RTCF_DIRECTDST |
+						RTCF_MULTICAST | RTCF_BROADCAST | RTCF_LOCAL | RTCF_REJECT))) {
 				if (!nfp_hook_fib_rule_add(AF_INET, (u8 *)(&rt->rt_src), (u8 *)(&rt->rt_dst),
 					  (u8 *)(&rt->rt_gateway), rt->rt_iif, rt->dst.dev->ifindex))
 					rt->nfp = true;
@@ -2229,9 +2232,6 @@ static int __mkroute_input(struct sk_buff *skb,
 		err = -ENOBUFS;
 		goto cleanup;
 	}
-#if defined(CONFIG_MV_ETH_NFP_FIB_LEARN)
-	rth->nfp = false;
-#endif
 
 	rth->rt_key_dst	= daddr;
 	rth->rt_key_src	= saddr;
@@ -2256,12 +2256,12 @@ static int __mkroute_input(struct sk_buff *skb,
 
 	rt_set_nexthop(rth, NULL, res, res->fi, res->type, itag);
 
-
 #if defined(CONFIG_MV_ETH_NFP_FIB_LEARN)
 	rth->nfp = false;
-	if (!(rth->rt_flags & (RTCF_MULTICAST | RTCF_BROADCAST | RTCF_LOCAL | RTCF_REJECT))) {
-		if (!nfp_hook_fib_rule_add(AF_INET, (u8*)(&rth->rt_src), (u8*)(&rth->rt_dst),
-					(u8*)(&rth->rt_gateway), rth->rt_iif, rth->dst.dev->ifindex))
+	if (!(rth->rt_flags & (RTCF_DIRECTSRC | RTCF_DIRECTDST |
+				RTCF_MULTICAST | RTCF_BROADCAST | RTCF_LOCAL | RTCF_REJECT))) {
+		if (!nfp_hook_fib_rule_add(AF_INET, (u8 *)(&rth->rt_src), (u8 *)(&rth->rt_dst),
+					(u8 *)(&rth->rt_gateway), rth->rt_iif, rth->dst.dev->ifindex))
 			rth->nfp = true;
 	}
 #endif /* CONFIG_MV_ETH_NFP_FIB_LEARN */
@@ -2320,11 +2320,11 @@ static int ip_route_input_slow(struct sk_buff *skb, __be32 daddr, __be32 saddr,
 	struct flowi4	fl4;
 	unsigned	flags = 0;
 	u32		itag = 0;
-	struct rtable * rth;
+	struct rtable  *rth;
 	unsigned	hash;
 	__be32		spec_dst;
 	int		err = -EINVAL;
-	struct net    * net = dev_net(dev);
+	struct net     *net = dev_net(dev);
 
 	/* IP on this device is disabled. */
 
-- 
1.7.5.4

