From 3d45dd8973a74d16bd8f96c425e68f9347651e9b Mon Sep 17 00:00:00 2001
From: Uri Eliyahu <uriel@marvell.com>
Date: Thu, 28 Nov 2013 13:10:42 +0200
Subject: [PATCH 1167/1825] fix: pp2: A0 + Z1 merge bugs

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 682c650721f74feccbe8b4e45761d28715142528

	- fix for ppv2.1 (A0) and ppv2.0 (Z1)
	- TX desc buffer pointer mask fix

Change-Id: I765832bc9b4d03343a579556530cda2115dd1d51
Signed-off-by: Uri Eliyahu <uriel@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/4524
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h     |    4 ++--
 arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h |    2 +-
 .../arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c |    3 ---
 3 files changed, 3 insertions(+), 6 deletions(-)

diff --git a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h
index eab38bc..136b06f 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2Gbe.h
@@ -329,7 +329,7 @@ static INLINE int mvPp2RxqBusyDescNumGet(int port, int rxq)
 	int prxq = mvPp2LogicRxqToPhysRxq(port, rxq);
 
 	if (prxq < 0)
-		return prxq;
+		return 0;
 
 	regVal = mvPp2RdReg(MV_PP2_RXQ_STATUS_REG(prxq));
 
@@ -343,7 +343,7 @@ static INLINE int mvPp2RxqFreeDescNumGet(int port, int rxq)
 	int prxq = mvPp2LogicRxqToPhysRxq(port, rxq);
 
 	if (prxq < 0)
-		return prxq;
+		return 0;
 
 	regVal = mvPp2RdReg(MV_PP2_RXQ_STATUS_REG(prxq));
 
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h
index 83d7592..e3e2c75 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h
+++ b/arch/arm/plat-armada/mv_hal/pp2/gbe/mvPp2GbeRegs.h
@@ -296,7 +296,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #define MV_PP2_TXQ_PREF_BUF_REG			(MV_PP2_REG_BASE + 0x209c)
 
 #define MV_PP2_PREF_BUF_PTR_OFFS		0
-#define MV_PP2_PREF_BUF_PTR_MASK		(0xFFFF << MV_PP2_PREF_BUF_PTR_OFFS)
+#define MV_PP2_PREF_BUF_PTR_MASK		(0xFFF << MV_PP2_PREF_BUF_PTR_OFFS)
 #define MV_PP2_PREF_BUF_PTR(desc)		(((desc) << MV_PP2_PREF_BUF_PTR_OFFS) & MV_PP2_PREF_BUF_PTR_MASK)
 
 #define MV_PP2_PREF_BUF_SIZE_OFFS		12
diff --git a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
index 8157601..2f6bae3 100644
--- a/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
+++ b/arch/arm/plat-armada/mv_hal/pp2/gmac/mvEthGmacApi.c
@@ -185,12 +185,9 @@ void mvGmacDefaultsSet(int port)
 
 void mvGmacPortPowerDown(int port)
 {
-	return;
-/*
 	mvGmacPortDisable(port);
 	mvGmacMibCountersClear(port);
 	mvGmacPortResetSet(port, MV_TRUE);
-*/
 }
 
 MV_BOOL mvGmacPortIsLinkUp(int port)
-- 
1.7.5.4

