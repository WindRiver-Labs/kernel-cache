From 68955880507b12cdb77b933c5f4efbaea9933a7e Mon Sep 17 00:00:00 2001
From: Ofer Heifetz <oferh@marvell.com>
Date: Wed, 5 Feb 2014 16:53:22 +0200
Subject: [PATCH 1337/1825] fix: msys: fix reboot bug

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 71799ff94588e10dff0e3fa25125c8d573ce3928

	remove CONFIG_SUSPEND from defconfig and msys related code since
	msys does not have PMU and can not control per CPU power
	add HW restart routine and bind routine to MACHINE add
        CONFIG_SUSPEND proc-sheeva_pj4bv7.S to suspend/resume routines

Change-Id: Ia41d024e365a2c7f97cb3f878a29441447bfd523
Signed-off-by: Ofer Heifetz <oferh@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5465
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/configs/msys_defconfig          |    1 +
 arch/arm/mach-msys/core.c                |   42 ++++++++----------------------
 arch/arm/mach-msys/include/mach/system.h |   10 -------
 arch/arm/mm/proc-sheeva_pj4bv7.S         |    5 +++-
 4 files changed, 16 insertions(+), 42 deletions(-)

diff --git a/arch/arm/configs/msys_defconfig b/arch/arm/configs/msys_defconfig
index 5f5c0fa..02d7bd8 100644
--- a/arch/arm/configs/msys_defconfig
+++ b/arch/arm/configs/msys_defconfig
@@ -37,6 +37,7 @@ CONFIG_ZBOOT_ROM_TEXT=0x0
 CONFIG_ZBOOT_ROM_BSS=0x0
 CONFIG_VFP=y
 # CONFIG_CORE_DUMP_DEFAULT_ELF_HEADERS is not set
+# CONFIG_SUSPEND is not set
 CONFIG_NET=y
 CONFIG_PACKET=y
 CONFIG_UNIX=y
diff --git a/arch/arm/mach-msys/core.c b/arch/arm/mach-msys/core.c
index 4f42f1d..d3bcca1 100644
--- a/arch/arm/mach-msys/core.c
+++ b/arch/arm/mach-msys/core.c
@@ -553,34 +553,6 @@ static void cpu_fabric_common_init(void)
 #endif
 }
 
-#ifdef CONFIG_SUSPEND
-#define TRAINING_SPACE	(10*1024)
-
-void __init reserve_training_mem(void)
-{
-	int i;
-	MV_UNIT_WIN_INFO addr_win_map[MAX_TARGETS + 1];
-	phys_addr_t base;
-	phys_addr_t size = (phys_addr_t)(TRAINING_SPACE);
-
-	mvCtrlAddrWinMapBuild(addr_win_map, MAX_TARGETS + 1);
-	for (i = 0; i < MAX_TARGETS; i++) {
-		if (!MV_TARGET_IS_DRAM(i))
-			continue;
-
-		if (addr_win_map[i].enable == MV_FALSE)
-			continue;
-
-		base = 0;
-		base |=  addr_win_map[i].addrWin.baseLow;
-
-		pr_info("Reserving training memory: base=0x%p size=0x%x\n",
-				(void *)base, size);
-
-		memblock_reserve(base, size);
-	}
-}
-#endif
 
 /*****************************************************************************
  * BC2 BOARD
@@ -636,6 +608,15 @@ static void __init msys_bc2_rd_init(void)
 	return;
 }
 
+static void msys_board_restart(char mode, const char *cmd)
+{
+	pr_notice("Reseting...\n");
+	mvBoardReset();
+
+	/* This should never be reached */
+	while (1)
+		;
+}
 
 MACHINE_START(MSYS_BC2, "Marvell BC2 RD")
 	.atag_offset	= BOOT_PARAMS_OFFSET,
@@ -643,7 +624,6 @@ MACHINE_START(MSYS_BC2, "Marvell BC2 RD")
 	.init_irq	= msys_init_irq,
 	.timer		= &msys_timer,
 	.init_machine	= msys_bc2_rd_init,
-#ifdef CONFIG_SUSPEND
-	.reserve	= reserve_training_mem,
-#endif /* CONFIG_SUSPEND */
+	.restart	= msys_board_restart,
 MACHINE_END
+
diff --git a/arch/arm/mach-msys/include/mach/system.h b/arch/arm/mach-msys/include/mach/system.h
index e2cefa9..3af9a63 100644
--- a/arch/arm/mach-msys/include/mach/system.h
+++ b/arch/arm/mach-msys/include/mach/system.h
@@ -27,14 +27,4 @@ static inline void arch_idle(void)
 	cpu_do_idle();
 }
 
-static inline void arch_reset(char mode, const char *cmd)
-{
-	printk(KERN_INFO "Reseting...\n");
-	mvBoardReset();
-
-	/* This should never be reached */
-	while (1)
-		;
-}
-
 #endif
diff --git a/arch/arm/mm/proc-sheeva_pj4bv7.S b/arch/arm/mm/proc-sheeva_pj4bv7.S
index d073166..66fc916 100644
--- a/arch/arm/mm/proc-sheeva_pj4bv7.S
+++ b/arch/arm/mm/proc-sheeva_pj4bv7.S
@@ -632,14 +632,17 @@ ENTRY(v7_processor_functions)
 	.word	cpu_pj4bv7_switch_mm
 	.word	cpu_pj4bv7_set_pte_ext
 	.word	cpu_v7_suspend_size
+#ifdef CONFIG_ARM_CPU_SUSPEND
 	.word	cpu_v7_do_suspend
 	.word	cpu_v7_do_resume
-
+#endif
 	/*
 	this whole
 		.word	cpu_v7_suspend_size
+#ifdef CONFIG_ARM_CPU_SUSPEND
 	.word	cpu_v7_do_suspend
 	.word	cpu_v7_do_resume
+#endif
 	section above is a copy paste from proc-v7.s and need to be revisted
 	*/
 
-- 
1.7.5.4

