From 2a0af0ffa001191fc4572bffe22df846e76c91cd Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Wed, 1 May 2013 11:20:12 +0300
Subject: [PATCH 0618/1825] ALP: IOCC: Enable CP15 SMP support and shared bit
 in page tables

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 48c54945a3c98e1a633eaeb390f2a4ceb86f04cc

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Change-Id: Ibde6dd0e77e9cc565c230c1fff8fa4487531b28c
Reviewed-on: http://vgitil04.il.marvell.com:8080/1710
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mm/mmu.c     |    6 ++++--
 arch/arm/mm/proc-v7.S |    6 ++++++
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mm/mmu.c b/arch/arm/mm/mmu.c
index 6f9c620..c5d8cd0 100644
--- a/arch/arm/mm/mmu.c
+++ b/arch/arm/mm/mmu.c
@@ -460,8 +460,10 @@ static void __init build_mem_type_table(void)
 		mem_types[MT_CACHECLEAN].prot_sect |= PMD_SECT_APX|PMD_SECT_AP_WRITE;
 #endif
 
-		if (is_smp()) {
-#if defined(CONFIG_SMP) || defined (CONFIG_SHEEVA_ERRATA_ARM_CPU_5114)
+		/* if (is_smp()) */ {
+#if defined(CONFIG_SMP) || defined(CONFIG_SHEEVA_ERRATA_ARM_CPU_5114) || \
+		((defined(CONFIG_AURORA_IO_CACHE_COHERENCY) && \
+		 !defined(CONFIG_ARCH_ARMADA370)))
 			/*
 			 * Mark memory with the "shared" attribute
 			 * for SMP systems
diff --git a/arch/arm/mm/proc-v7.S b/arch/arm/mm/proc-v7.S
index fb489cc..2aaf59a 100644
--- a/arch/arm/mm/proc-v7.S
+++ b/arch/arm/mm/proc-v7.S
@@ -168,6 +168,12 @@ __v7_ca15mp_setup:
 	orreq	r0, r0, #(1 << 6)		@ Enable SMP/nAMP mode
 	orreq	r0, r0, r10			@ Enable CPU-specific SMP bits
 	mcreq	p15, 0, r0, c1, c0, 1
+#elif defined (CONFIG_AURORA_IO_CACHE_COHERENCY)
+	mrc	p15, 0, r0, c1, c0, 1
+	mov	r0, #(1 << 6)
+	mov	r10, #(1 << 0)
+	orr	r0, r0, r10
+	mcr	p15, 0, r0, c1, c0, 1
 #endif
 __v7_setup:
 	adr	r12, __v7_setup_stack		@ the local stack
-- 
1.7.5.4

