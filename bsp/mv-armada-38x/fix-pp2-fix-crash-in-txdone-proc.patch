From 10fad270c407a8d71bee28c748d3ac55d5283f9c Mon Sep 17 00:00:00 2001
From: Uri Eliyahu <uriel@marvell.com>
Date: Thu, 16 Jan 2014 20:49:38 +0200
Subject: [PATCH 1286/1825] fix: pp2: fix crash in txdone proc

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit c166739cde6969d2f33e0c8d1b1e6a9793d17ca1

	- if packet transmited by outer tx function
	  we should not try to pop from shadow

	- remove txpReset function form stop internals
	  it seems that txq and aggrTxq are out of sync
	  if we zeroed txq index

Change-Id: I59fd2b64ca95a29442c78d511809a19b2fc01a0d
Signed-off-by: Uri Eliyahu <uriel@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/5202
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c      |    7 +++++--
 1 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
index b4307fb..16071cd 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.c
@@ -1585,6 +1585,10 @@ inline u32 mv_eth_txq_done(struct eth_port *pp, struct tx_queue *txq_ctrl)
 	printk(KERN_ERR "tx_done: txq_count=%d, port=%d, txp=%d, txq=%d, tx_done=%d\n",
 			txq_ctrl->txq_count, pp->port, txq_ctrl->txp, txq_ctrl->txq, tx_done);
 */
+	/* packet sent by outer tx function */
+	if (txq_cpu_ptr->txq_count < tx_done)
+		return tx_done;
+
 	mv_eth_txq_bufs_free(pp, txq_cpu_ptr, tx_done);
 
 	txq_cpu_ptr->txq_count -= tx_done;
@@ -4228,6 +4232,7 @@ int mv_eth_txq_clean(int port, int txp, int txq)
 		mvPp2TxqDrainSet(port, txp, txq, MV_FALSE);
 
 		/* release all transmitted packets */
+
 		tx_done = mv_eth_txq_done(pp, txq_ctrl);
 		if (tx_done > 0)
 			mvOsPrintf(KERN_INFO "%s: port=%d, txp=%d txq=%d: Free %d transmitted descriptors\n",
@@ -4269,8 +4274,6 @@ int mv_eth_txp_clean(int port, int txp)
 
 	mvPp2TxPortFifoFlush(port, MV_FALSE);
 
-	mvPp2TxpReset(port, txp);
-
 	return 0;
 }
 
-- 
1.7.5.4

