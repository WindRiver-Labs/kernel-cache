From 2203e1b86614cd1b44d190e6b7a938bbf3424422 Mon Sep 17 00:00:00 2001
From: Kosta Zertsekel <konszert@marvell.com>
Date: Sun, 6 Jan 2013 09:51:25 +0200
Subject: [PATCH 0005/1825] AXP initial support: fix PMD entry flush and clean

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 69ac47a5bb9adc55641b2aa747a5a2a2afc7347f

Change-Id: Ief61b0f95be0432ef8263313388e980e2c5f51c2

Signed-off-by: Kosta Zertsekel <konszert@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/include/asm/tlbflush.h |   25 ++++++++++++++++++++++++-
 1 files changed, 24 insertions(+), 1 deletions(-)

diff --git a/arch/arm/include/asm/tlbflush.h b/arch/arm/include/asm/tlbflush.h
index f2a2906..cebd0d1 100644
--- a/arch/arm/include/asm/tlbflush.h
+++ b/arch/arm/include/asm/tlbflush.h
@@ -337,7 +337,22 @@ extern struct cpu_tlb_fns cpu_tlb;
 			    : "cc");					\
 	} while (0)
 
-#define tlb_op(f, regs, arg)	__tlb_op(f, "p15, 0, %0, " regs, arg)
+static inline void tlb_op(int op, const char *regs, int arg)
+{
+#ifdef CONFIG_SHEEVA_ERRATA_ARM_CPU_4611
+	if (op == TLB_DCLEAN && tlb_flag(op)) {
+		unsigned long flags;
+		raw_local_irq_save(flags);
+		dmb();
+		__tlb_op(op, regs, arg);
+		raw_local_irq_restore(flags);
+	}
+#else
+	__tlb_op(op, regs, arg);
+#endif
+
+}
+
 #define tlb_l2_op(f, regs, arg)	__tlb_op(f, "p15, 1, %0, " regs, arg)
 
 static inline void local_flush_tlb_all(void)
@@ -472,7 +487,11 @@ static inline void flush_pmd_entry(void *pmd)
 	const unsigned int __tlb_flag = __cpu_tlb_flags;
 
 	tlb_op(TLB_DCLEAN, "c7, c10, 1	@ flush_pmd", pmd);
+#ifdef CONFIG_CACHE_AURORA_L2
+	l2_clean_pa(__pa((unsigned long)pmd));
+#else
 	tlb_l2_op(TLB_L2CLEAN_FR, "c15, c9, 1  @ L2 flush_pmd", pmd);
+#endif
 
 	if (tlb_flag(TLB_WB))
 		dsb();
@@ -483,7 +502,11 @@ static inline void clean_pmd_entry(void *pmd)
 	const unsigned int __tlb_flag = __cpu_tlb_flags;
 
 	tlb_op(TLB_DCLEAN, "c7, c10, 1	@ flush_pmd", pmd);
+#ifdef CONFIG_CACHE_AURORA_L2
+	l2_clean_pa(__pa((unsigned long)pmd));
+#else
 	tlb_l2_op(TLB_L2CLEAN_FR, "c15, c9, 1  @ L2 flush_pmd", pmd);
+#endif
 }
 
 #undef tlb_op
-- 
1.7.5.4

