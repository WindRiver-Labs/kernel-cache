From 89933707835959d4a4bc7367d1e1c79bde492e64 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Wed, 17 Apr 2013 15:03:57 +0300
Subject: [PATCH 0594/1825] ALP: IO Expander : added functions to enable
 Eeprom usage, and to set external phy buffer

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 6434d0bf2a42c4105649e67da97b2dbae13a94fa

(added mvBoardExtPhyBufferSelect, mvCtrlEepromEnable, mvBoardIoExpValSet)

Change-Id: I522d06bda58d3a8ff346685b317ab6152a8314d0
Reviewed-on: http://vgitil04.il.marvell.com:8080/1595
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |   71 +++++++++++++++++++-
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.h      |    2 +
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   28 ++++++++
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h        |    1 +
 4 files changed, 101 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
index 5dc482d..dfbb880 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -1784,7 +1784,6 @@ MV_U32 boardGetDevCSNum(MV_32 devNum, MV_BOARD_DEV_CLASS devClass)
 *       This function returns specified value from IO Expanders
 *
 * INPUT:
-*       ioClass - Field identifier
 *       ioInfo  - relevant IO Expander information
 *
 * OUTPUT:
@@ -1811,6 +1810,47 @@ MV_U8 mvBoardIoExpValGet(MV_BOARD_IO_EXPANDER_TYPE_INFO *ioInfo)
 }
 
 /*******************************************************************************
+* mvBoardIoExpValSet - write a specified value to IO Expanders
+*
+* DESCRIPTION:
+*       This function writes specified value to IO Expanders
+*
+* INPUT:
+*       ioInfo  - relevant IO Expander information
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*       MV_U8  :return requested value , if TWSI read was succesfull, else 0xFF.
+*
+*******************************************************************************/
+MV_STATUS mvBoardIoExpValSet(MV_BOARD_IO_EXPANDER_TYPE_INFO *ioInfo, MV_U8 value)
+{
+	MV_U8 readVal;
+
+	if (ioInfo==NULL)
+		return (MV_U8)MV_ERROR;
+	/* Read */
+	readVal = mvBoardTwsiGet(BOARD_DEV_TWSI_IO_EXPANDER, ioInfo->expanderNum, ioInfo->regNum);
+	if ((MV_U8)MV_ERROR != readVal) {
+		/* Modify */
+		readVal &= !(1 << ioInfo->offset);	/* clean bit of old value  */
+		value = value << ioInfo->offset;	/* shift bit of new value to its location */
+		value &= readVal;
+
+		/* Write */
+		readVal = mvBoardTwsiSet(BOARD_DEV_TWSI_IO_EXPANDER, ioInfo->expanderNum, ioInfo->regNum, value);
+		if ((MV_U8)MV_ERROR != readVal)
+			return MV_OK;
+	}
+
+
+	mvOsPrintf("%s: Error: Write to IO Expander failed\n", __func__);
+	return (MV_U8)MV_ERROR;
+}
+
+/*******************************************************************************
 * mvBoardTwsiAddrTypeGet
 *
 * DESCRIPTION:
@@ -2024,6 +2064,35 @@ MV_STATUS mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_TYPE_ID ioClass, MV_BOARD_IO_E
 }
 
 /*******************************************************************************
+* mvBoardExtPhyBufferSelect - enable/disable buffer status
+*
+* DESCRIPTION:
+*       This function enables/disabke the buffer status - according to Boolean input
+*
+* INPUT:
+*       enable - Boolean to indicate requested status
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*       None.
+*
+*******************************************************************************/
+MV_STATUS mvBoardExtPhyBufferSelect(MV_BOOL enable)
+{
+	MV_BOARD_IO_EXPANDER_TYPE_INFO *ioInfo = NULL;
+
+	if(mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_EXT_PHY_SMI_EN ,ioInfo))
+	{
+		return 	(mvBoardIoExpValSet(ioInfo, (enable? 0x0 : 0x1)));
+	}
+	mvOsPrintf("%s: Error: Read from IO expander failed (External Phy Buffer select)\n", __func__);
+	return MV_FALSE;
+}
+
+
+/*******************************************************************************
 * mvBoardNandWidthGet -
 *
 * DESCRIPTION: Get the width of the first NAND device in bytes
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
index 0416c96..b397a23 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.h
@@ -398,9 +398,11 @@ MV_32 mvBoardSwitchPortMap(MV_U32 switchIdx, MV_U32 switchPortNum);
 MV_BOOL mvBoardIsPortLoopback(MV_U32 ethPortNum);
 MV_32 mvBoardPhyAddrGet(MV_U32 ethPortNum);
 MV_U8 mvBoardIoExpValGet(MV_BOARD_IO_EXPANDER_TYPE_INFO *ioInfo);
+MV_STATUS mvBoardIoExpValSet(MV_BOARD_IO_EXPANDER_TYPE_INFO *ioInfo, MV_U8 value);
 MV_STATUS mvBoardSatrInfoGet(MV_SATR_TYPE_ID satrClass, MV_BOARD_SATR_INFO *satrInfo);
 MV_STATUS mvBoardConfigTypeGet(MV_CONFIG_TYPE_ID configClass, MV_BOARD_CONFIG_TYPE_INFO *configInfo);
 MV_STATUS mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_TYPE_ID ioClass, MV_BOARD_IO_EXPANDER_TYPE_INFO *ioInfo);
+MV_STATUS mvBoardExtPhyBufferSelect(MV_BOOL enable);
 MV_U32 mvBoardTclkGet(MV_VOID);
 MV_U32 mvBoardSysClkGet(MV_VOID);
 MV_U32 mvBoardDebugLedNumGet(MV_U32 boardId);
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index f5dd2eb..71f2ff4 100755
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -598,6 +598,34 @@ MV_BOOL mvCtrlIsEepromEnabled()
 }
 
 /*******************************************************************************
+* mvCtrlEepromEnable
+*
+* DESCRIPTION:
+*       This function enable/disable the Eeprom usage
+*
+* INPUT:
+*       None.
+*
+* OUTPUT:
+*       None.
+*
+* RETURN:
+*       MV_BOOL :  MV_TRUE if EEPROM enabled, else return MV_FALSE.
+*
+*******************************************************************************/
+MV_STATUS mvCtrlEepromEnable(MV_BOOL enable)
+{
+	MV_BOARD_IO_EXPANDER_TYPE_INFO *ioInfo = NULL;
+
+	if(mvBoardIoExpanderTypeGet(MV_IO_EXPANDER_JUMPER1_EEPROM_ENABLED ,ioInfo))
+	{
+		return 	(mvBoardIoExpValSet(ioInfo, (enable? 0x1 : 0x0)));
+	}
+	mvOsPrintf("%s: Error: Read from IO expander failed (EEPROM enabled jumper)\n", __func__);
+	return MV_FALSE;
+}
+
+/*******************************************************************************
 * mvCtrlDevFamilyIdGet - Get Device ID
 *
 * DESCRIPTION:
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
index c921f49..bfc0be5 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
@@ -270,6 +270,7 @@ MV_U32 mvCtrlGetQuadNum(MV_VOID);
 MV_STATUS mvCtrlUpdatePexId(MV_VOID);
 MV_BOOL mvCtrlIsValidSatR(MV_VOID);
 MV_BOOL mvCtrlIsEepromEnabled(MV_VOID);
+MV_STATUS mvCtrlEepromEnable(MV_BOOL enable);
 MV_STATUS mvCtrlBoardConfigGet(MV_U8 *tempVal);
 MV_U32 mvCtrlSocUnitInfoNumGet(MV_UNIT_ID unit);
 MV_STATUS mvCtrlEnvInit(MV_VOID);
-- 
1.7.5.4

