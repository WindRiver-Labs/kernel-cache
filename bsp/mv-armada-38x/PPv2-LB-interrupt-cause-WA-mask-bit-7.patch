From bbcf8f2328f1c65a31383bab577a9de0be9debce Mon Sep 17 00:00:00 2001
From: Yoni Farhadian <yonif@marvell.com>
Date: Thu, 23 May 2013 09:13:51 +0300
Subject: [PATCH 0676/1825] PPv2: LB interrupt cause WA (mask bit 7)

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 4edb294a8eab057fe1a5a0ca98204a1142f29ec8

Change-Id: Ib5ed561d4294e8c3f79f3d80ab1b687f994beb9b
Signed-off-by: Yoni Farhadian <yonif@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/1947
Reviewed-by: Star_Automation <star@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h      |   11 ++++++++---
 1 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h
index fee856f..251c1a7 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_pp2/net_dev/mv_netdev.h
@@ -491,19 +491,24 @@ static inline void mv_eth_rx_csum(struct eth_port *pp, struct pp2_rx_desc *rx_de
 
 static inline void mv_eth_interrupts_unmask(struct eth_port *pp)
 {
-	int cpu = smp_processor_id(), group_id;
+	int cpu = smp_processor_id(), group_id, rxq_mask;
 	struct napi_group_ctrl *napi_group;
 
 	group_id = pp->cpu_config[cpu]->napi_group_id;
 	if (group_id < 0)
 		return;
+
 	napi_group = pp->napi_group[group_id];
+	rxq_mask = napi_group->rxq_mask;
+	/* ALP WA - mask bit[7] in LB 2 */
+	if (pp->port == 2)
+		rxq_mask &= ~0x80;
 
 	/* unmask interrupts - for RX unmask only RXQs that are in the same napi group */
 #ifdef CONFIG_MV_ETH_TXDONE_ISR
-	mvPp2GbeIsrRxTxUnmask(pp->port, napi_group->rxq_mask, 1 /* unmask TxDone interrupts */);
+	mvPp2GbeIsrRxTxUnmask(pp->port, rxq_mask, 1 /* unmask TxDone interrupts */);
 #else
-	mvPp2GbeIsrRxTxUnmask(pp->port, napi_group->rxq_mask, 0 /* mask TxDone interrupts */);
+	mvPp2GbeIsrRxTxUnmask(pp->port, rxq_mask, 0 /* mask TxDone interrupts */);
 #endif /* CONFIG_MV_ETH_TXDONE_ISR */
 }
 
-- 
1.7.5.4

