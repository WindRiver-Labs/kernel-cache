From c8c3e363902592dee369ee7662dee18647ceb8f1 Mon Sep 17 00:00:00 2001
From: Ofir <ofir@marvell.com>
Date: Wed, 9 Apr 2014 14:30:34 +0300
Subject: [PATCH 1570/1825] fix: neta: kernel 3.10 CPU_IDLE support

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 184084fcec6a7bf58dc23a414db10ec556e597c8

	fix JIRA 463: modified the clk gating function on
	suspend/resume function to use the clk library of
	LK3.10.

Change-Id: Ie41c43fac8fb133e86e06bc7ee1e9864c2156d9f
Signed-off-by: Ofir <ofir@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c     |   21 +++++++++++++++++++-
 1 files changed, 20 insertions(+), 1 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
index 7a9a859..a14b8fc 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_neta/net_dev/mv_netdev.c
@@ -6503,9 +6503,19 @@ int mv_eth_suspend(struct platform_device *pdev, pm_message_t state)
 		}
 
 		/* BUG WA - if port 0 clock is down, we can't interrupt by magic packet */
-		if ((port != 0) || (wol_ports_bmp == 0))
+		if ((port != 0) || (wol_ports_bmp == 0)) {
 			/* Set Port Power State to 0 */
+#ifdef CONFIG_ARCH_MVEBU
+			{
+				/* get the relevant clock from the clk lib */
+				struct clk *clk;
+				clk = devm_clk_get(&pdev->dev, NULL);
+				clk_disable(clk);
+			}
+#else
 			mvCtrlPwrClckSet(ETH_GIG_UNIT_ID, port, 0);
+#endif
+		}
 	} else {
 
 #ifdef CONFIG_MV_ETH_PNC_WOL
@@ -6535,7 +6545,16 @@ int mv_eth_resume(struct platform_device *pdev)
 
 	if (pp->wol_mode == 0) {
 		/* Set Port Power State to 1 */
+#ifdef CONFIG_ARCH_MVEBU
+		{
+			struct clk *clk;
+			clk = devm_clk_get(&pdev->dev, NULL);
+			clk_enable(clk);
+		}
+#else
 		mvCtrlPwrClckSet(ETH_GIG_UNIT_ID, port, 1);
+#endif
+
 		mdelay(10);
 		if (mv_eth_port_resume(port)) {
 			printk(KERN_ERR "%s: port #%d resume failed.\n", __func__, port);
-- 
1.7.5.4

