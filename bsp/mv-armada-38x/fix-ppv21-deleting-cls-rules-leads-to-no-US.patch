From 6bf1841f1bcfc437eb95400251fa1c81979568a6 Mon Sep 17 00:00:00 2001
From: Ken Ma <make@marvell.com>
Date: Mon, 26 May 2014 20:37:36 +0800
Subject: [PATCH 1685/1825] fix: ppv21: deleting cls rules leads to no US.

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 01141a43b6339210f9dbd2c99e41135a287041d5

	Correct PON cls flow port_bm and cls flow port_id.
	SYSTEMSW-627 - <Deleting more than 55 cls rules leads to no US>

Signed-off-by: Ken Ma <make@marvell.com>

Change-Id: Icf766a45134527ae7755538217cefeb09cccb3a8
Signed-off-by: Ken Ma <make@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8204
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
Reviewed-by: Hua Jing <jinghua@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_tpm/src/conf/tpm_mng.c       |   16 ----------------
 .../mv_drivers_lsp/mv_tpm/src/core/tpm_cls.c       |   20 +++++++++++++++-----
 2 files changed, 15 insertions(+), 21 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/conf/tpm_mng.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/conf/tpm_mng.c
index 8e90020..0832bdb 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/conf/tpm_mng.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/conf/tpm_mng.c
@@ -1295,7 +1295,6 @@ int tpm_mng_def_flow_entry_crt(
 			sizeof(fl_rule_entry));
 		cur_number++;
 	} else if (TPM_WAY_NON_PON == way) {
-#ifndef CONFIG_MV_ETH_PP2_1
 		if (src_port_cfg & TPM_CAP_PORT_G0) {
 			fl_rule_entry.port_bm = TPM_SRC_PORT_G0;
 			fl_rule_entry.port_type = TPM_SRC_PORT_TYPE_PHY;
@@ -1320,21 +1319,6 @@ int tpm_mng_def_flow_entry_crt(
 				sizeof(fl_rule_entry));
 			cur_number++;
 		}
-#else
-		fl_rule_entry.port_bm = 0;
-		if (src_port_cfg & TPM_CAP_PORT_G0)
-			fl_rule_entry.port_bm |= TPM_SRC_PORT_G0;
-		if (src_port_cfg & TPM_CAP_PORT_G1)
-			fl_rule_entry.port_bm |= TPM_SRC_PORT_G1;
-		if (src_port_cfg & TPM_CAP_PORT_LPBK)
-			fl_rule_entry.port_bm |= TPM_SRC_PORT_LPBK;
-
-		fl_rule_entry.port_type = TPM_SRC_PORT_TYPE_PHY;
-		memcpy(&flow_rules->fl[cur_number],
-			&fl_rule_entry,
-			sizeof(fl_rule_entry));
-		cur_number++;
-#endif
 	}
 
 	flow_rules->fl_len = cur_number;
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_cls.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_cls.c
index c648e58..851e3e1 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_cls.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_cls.c
@@ -2016,11 +2016,21 @@ int tpm_cls_fl_rule_disable(unsigned short		*rl_log_id,
 		}
 
 		/* update port_bm */
-		for (loop = 0; loop < TPM_MAX_NUM_GMACS; loop++) {
-			if ((1 << loop) & src_port->class_port) {
-				port_id = loop;
-				break;
-			}
+		switch (src_port->class_port) {
+		case TPM_PP_GMAC0:
+			port_id = TPM_ENUM_GMAC_0;
+			break;
+		case TPM_PP_GMAC1:
+			port_id = TPM_ENUM_GMAC_1;
+			break;
+		case TPM_PP_PMAC:
+			port_id = TPM_ENUM_PMAC;
+			break;
+		case TPM_PP_LPBK:
+			port_id = TPM_ENUM_GMAC_LPK;
+			break;
+		default:
+			IF_ERROR(TPM_NOT_SUPPORTED, rc)
 		}
 
 		if (ref_sum > 1 && rl_db.ref_cnt[port_id] == 1) {
-- 
1.7.5.4

