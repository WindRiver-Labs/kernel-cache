From 19c5b8fe61f96164916e66e09ca1095769ef1ef0 Mon Sep 17 00:00:00 2001
From: Omri Itach <omrii@marvell.com>
Date: Sun, 17 Feb 2013 18:59:01 +0200
Subject: [PATCH 0475/1825] new S@R detection mechanism , and a new 'SatR'
 U-Boot read/write command

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit eca5179577fad1a30120d08f66bbdac58daafef7

Change-Id: I6b9800541fdc2425951cb939fb6fc00bfbc526f0
Reviewed-on: http://vgitil04.il.marvell.com:8080/1143
Reviewed-by: Eran Ben-Avi <benavi@marvell.com>
Tested-by: Eran Ben-Avi <benavi@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../avanta_lp_family/boardEnv/mvBoardEnvLib.c      |  248 +-------------------
 .../avanta_lp_family/boardEnv/mvBoardEnvSpec.h     |    8 +-
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c        |   88 +++++++
 .../avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h        |   24 ++
 4 files changed, 119 insertions(+), 249 deletions(-)
 mode change 100644 => 100755 arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c

diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
old mode 100644
new mode 100755
index b4ae87b..a21924b
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvLib.c
@@ -1360,51 +1360,9 @@ MV_STATUS mvBoardTwsiSatRSet(MV_U8 devNum, MV_U8 regNum, MV_U8 regVal)
 /*******************************************************************************
  * SatR Configuration functions
  */
-MV_U8 mvBoardFabFreqGet(MV_VOID)
-{
-	MV_U8 sar0;
-	MV_U8 sar1;
-
-	sar0 = mvBoardTwsiSatRGet(2, 0);
-	if ((MV_8)MV_ERROR == (MV_8)sar0)
-		return MV_ERROR;
-
-	sar1 = mvBoardTwsiSatRGet(3, 0);
-	if ((MV_8)MV_ERROR == (MV_8)sar1)
-		return MV_ERROR;
-
-	return (((sar1 & 0x1) << 4) | ((sar0 & 0x1E) >> 1));
-}
-
-MV_STATUS mvBoardFabFreqSet(MV_U8 freqVal)
-{
-	MV_U8 sar0;
 
-	sar0 = mvBoardTwsiSatRGet(2, 0);
-	if ((MV_8)MV_ERROR == (MV_8)sar0)
-		return MV_ERROR;
 
-	sar0 &= ~(0xF << 1);
-	sar0 |= (freqVal & 0xF) << 1;
-	if (MV_OK != mvBoardTwsiSatRSet(2, 0, sar0)) {
-		DB(mvOsPrintf("Board: Write FreqOpt S@R fail\n"));
-		return MV_ERROR;
-	}
-
-	sar0 = mvBoardTwsiSatRGet(3, 0);
-	if ((MV_8)MV_ERROR == (MV_8)sar0)
-		return MV_ERROR;
 
-	sar0 &= ~(0x1);
-	sar0 |= ( (freqVal >> 4) & 0x1);
-	if (MV_OK != mvBoardTwsiSatRSet(3, 0, sar0)) {
-		DB(mvOsPrintf("Board: Write FreqOpt S@R fail\n"));
-		return MV_ERROR;
-	}
-
-	DB(mvOsPrintf("Board: Write FreqOpt S@R succeeded\n"));
-	return MV_OK;
-}
 
 MV_U8 mvBoardCpuFreqGet(MV_VOID)
 {
@@ -1461,248 +1419,44 @@ MV_STATUS mvBoardCpuFreqSet(MV_U8 freqVal)
 	return MV_OK;
 }
 
-MV_U8 mvBoardBootDevGet(MV_VOID)
-{
-	MV_U8 sar;
-
-	sar = mvBoardTwsiSatRGet(0, 0);
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
-
-	return (sar & 0x7);
-}
-
-MV_STATUS mvBoardBootDevSet(MV_U8 val)
-{
-	MV_U8 sar;
-
-	sar = mvBoardTwsiSatRGet(0, 0);
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
-
-	sar &= ~(0x7);
-	sar |= (val & 0x7);
-
-	if (mvBoardTwsiSatRSet(0, 0, sar) != MV_OK) {
-		DB(mvOsPrintf("Board: Write BootDev S@R fail\n"));
-		return MV_ERROR;
-	}
-
-	DB(mvOsPrintf("Board: Write BootDev S@R succeeded\n"));
-	return MV_OK;
-}
-
-MV_U8 mvBoardBootDevWidthGet(MV_VOID)
-{
-	MV_U8 sar = mvBoardTwsiSatRGet(0, 0);
 
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
-
-	return (sar & 0x18) >> 3;
-}
 
-MV_STATUS mvBoardBootDevWidthSet(MV_U8 val)
-{
-	MV_U8 sar = mvBoardTwsiSatRGet(0, 0);
 
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
 
-	sar &= ~(0x3 << 3);
-	sar |= ((val & 0x3) << 3);
 
-	if (mvBoardTwsiSatRSet(0, 0, sar) != MV_OK) {
-		DB(mvOsPrintf("Board: Write BootDevWidth S@R fail\n"));
-		return MV_ERROR;
-	}
 
-	DB(mvOsPrintf("Board: Write BootDevWidth S@R succeeded\n"));
-	return MV_OK;
-}
 
-MV_U8 mvBoardCpu0EndianessGet(MV_VOID)
-{
-	MV_U8 sar = mvBoardTwsiSatRGet(3, 0);
 
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
 
-	return (sar & 0x08) >> 3;
-}
 
-MV_STATUS mvBoardCpu0EndianessSet(MV_U8 val)
-{
-	MV_U8 sar = mvBoardTwsiSatRGet(3, 0);
 
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
-	sar &= ~(0x1 << 3);
-	sar |= ((val & 0x1) << 3);
 
-	if (mvBoardTwsiSatRSet(3, 0, sar) != MV_OK) {
-		DB(mvOsPrintf("Board: Write Cpu0CoreMode S@R fail\n"));
-		return MV_ERROR;
-	}
 
-	DB(mvOsPrintf("Board: Write Cpu0CoreMode S@R succeeded\n"));
-	return MV_OK;
-}
 
-MV_U8 mvBoardL2SizeGet(MV_VOID)
-{
-	MV_U8 sar = mvBoardTwsiSatRGet(1, 0);
 
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
 
-	return (sar & 0x3);
-}
 
-MV_STATUS mvBoardL2SizeSet(MV_U8 val)
-{
-	MV_U8 sar = mvBoardTwsiSatRGet(1, 0);
 
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
 
-	sar &= ~(0x3);
-	sar |= (val & 0x3);
-
-	if (mvBoardTwsiSatRSet(1, 0, sar) != MV_OK) {
-		DB(mvOsPrintf("Board: Write L2Size S@R fail\n"));
-		return MV_ERROR;
-	}
-
-	DB(mvOsPrintf("Board: Write L2Size S@R succeeded\n"));
-	return MV_OK;
-}
 
 MV_U8 mvBoardCpuCoresNumGet(MV_VOID)
 {
-	MV_U8 sar = mvBoardTwsiSatRGet(3, 0);
-
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
-
-	sar = (sar & 0x6) >> 1;
-	if (sar == 1)
-		sar = 2;
-	else if (sar == 2)
-		sar =1;
-	return sar;
+	return 1;
 }
 
-MV_STATUS mvBoardCpuCoresNumSet(MV_U8 val)
-{
-	MV_U8 sar = mvBoardTwsiSatRGet(3, 0);
-
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
 
-	/* MSB and LSB are swapped on DB board */
-	if (val == 1)
-		val = 2;
-	else if (val == 2)
-		val =1;
 
-	sar &= ~(0x3 << 1);
-	sar |= ((val & 0x3) << 1);
 
-	if (mvBoardTwsiSatRSet(3, 0, sar) != MV_OK) {
-		DB(mvOsPrintf("Board: Write CpuCoreNum S@R fail\n"));
-		return MV_ERROR;
-	}
 
-	DB(mvOsPrintf("Board: Write CpuCoreNum S@R succeeded\n"));
-	return MV_OK;
-}
-
-MV_STATUS mvBoardConfIdSet(MV_U16 conf)
-{
-	if (MV_OK != mvBoardTwsiSatRSet(0, 1, conf)) {
-		DB(mvOsPrintf("Board: Write confID S@R fail\n"));
-		return MV_ERROR;
-	}
 
-	DB(mvOsPrintf("Board: Write confID S@R succeeded\n"));
-	return MV_OK;
-}
 
-MV_U16 mvBoardConfIdGet(MV_VOID)
-{
-	MV_U8 sar;
 
-	sar = mvBoardTwsiSatRGet(0, 1);
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
 
-	return (sar & 0xFF);
-}
 
-MV_STATUS mvBoardPexCapabilitySet(MV_U16 conf)
-{
-	MV_U8 sar;
-	sar = mvBoardTwsiSatRGet(1, 1);
-	if ((MV_8)MV_ERROR == (MV_8)sar)
-		return MV_ERROR;
 
-	sar &= ~(0x1);
-	sar |= (conf & 0x1);
 
-	if (MV_OK != mvBoardTwsiSatRSet(1, 1, sar)) {
-		DB(mvOsPrintf("Board: Write confID S@R fail\n"));
-		return MV_ERROR;
-	}
 
-	DB(mvOsPrintf("Board: Write confID S@R succeeded\n"));
-	return MV_OK;
-}
 
-MV_U16 mvBoardPexCapabilityGet(MV_VOID)
-{
-	return 0;
-}
-
-MV_STATUS mvBoardPexModeSet(MV_U16 conf)
-{
-	return MV_ERROR;
-}
-
-MV_U16 mvBoardPexModeGet(MV_VOID)
-{
-	return 0;
-}
-
-MV_STATUS mvBoardDramEccSet(MV_U16 ecc)
-{
-	return MV_ERROR;
-}
-
-MV_U16 mvBoardDramEccGet(MV_VOID)
-{
-	return 0;
-}
-
-MV_STATUS mvBoardDramBusWidthSet(MV_U16 dramBusWidth)
-{
-	return MV_ERROR;
-}
-
-MV_U16 mvBoardDramBusWidthGet(MV_VOID)
-{
-	return 0;
-}
-
-MV_U8 mvBoardAltFabFreqGet(MV_VOID)
-{
-	return 0;
-}
-
-MV_STATUS mvBoardAltFabFreqSet(MV_U8 freqVal)
-{
-	return MV_ERROR;
-}
 /*******************************************************************************
 * End of SatR Configuration functions
 *******************************************************************************/
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
index 8c57cf3..0269109 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/boardEnv/mvBoardEnvSpec.h
@@ -102,8 +102,12 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 
 /* New board ID numbers */
 #define BOARD_ID_BASE				0x0
-#define MV_BOARD_ID_AVANTA_LP_FPGA		BOARD_ID_BASE
-#define MV_MAX_BOARD_ID				(MV_BOARD_ID_AVANTA_LP_FPGA+1)
+#define MV_BOARD_ID_AVANTA_LP_FPGA		(BOARD_ID_BASE)
+#define DB_6660_ID				(MV_BOARD_ID_AVANTA_LP_FPGA+1)
+#define RD_6660_ID				(DB_6660_ID+1)
+#define DB_6650_ID				(RD_6660_ID+1)
+#define RD_6650_ID 				(DB_6650_ID+1)
+#define MV_MAX_BOARD_ID				(RD_6650_ID+1)
 #define MV_INVALID_BOARD_ID			0xFFFFFFFF
 
 
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
index e50c7a8..7b7011b 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.c
@@ -123,6 +123,8 @@ typedef struct _ctrlEnvInfo {
 
 CTRL_ENV_INFO ctrlEnvInfo = {};
 
+MV_U32 satrOptionsConfig[MV_SATR_MAX_OPTION];
+
 MV_U32 mvCtrlGetCpuNum(MV_VOID)
 {
 	return 0; /* kostaz: fix from cider */
@@ -219,6 +221,92 @@ MV_STATUS mvCtrlEnvInit(MV_VOID)
 }
 
 /*******************************************************************************
+* mvCtrlSatRWrite
+*
+* DESCRIPTION: Write S@R configuration Field
+*
+* INPUT: satrField - Field description enum
+*  	 val       - value to write (if write action requested)
+*
+* OUTPUT: None
+*
+* RETURN:
+*       write action:
+*       if value is writen succesfully - returns the written value
+*       else if write failed - returns MV_ERROR
+*
+*******************************************************************************/
+MV_U32 mvCtrlSatRWrite(MV_SATR_TYPE_ID satrField ,MV_U8 val)
+{
+	if (satrField<MV_SATR_MAX_OPTION) {
+		//TwsiSATRWrite (satrField , val);
+		satrOptionsConfig[satrField]=val;      /* simulate dummy write instead of TWSI - will be removed */
+		//if ( val==TwsiSATRRead (satrField) )
+
+		if(satrOptionsConfig[satrField]==val)	 	/* omriii - replace ifs with if(TWSIRead==val) */
+			return (satrOptionsConfig[satrField]=val);
+		else
+			return MV_ERROR;
+	}
+
+}
+/*******************************************************************************
+* mvCtrlSatRRead
+*
+* DESCRIPTION: Read S@R configuration Field
+*
+* INPUT: satrField - Field description enum
+*
+* OUTPUT: None
+*
+* RETURN:
+*	if field is valid - returns requested S@R field value
+*       else if field is not relevant for running board, return 0xFFFFFFF.
+*
+*******************************************************************************/
+MV_U32 mvCtrlSatRRead(MV_SATR_TYPE_ID satrField)
+{
+	if (satrField<MV_SATR_MAX_OPTION)
+		return satrOptionsConfig[satrField];
+}
+/*******************************************************************************
+* mvCtrlSatrInit
+*
+* DESCRIPTION: Initialize S@R configuration
+* 		1. initialize all S@R fields with 0xFF
+* 		2. read boardID and according to ID, read relevant S@R fields(using TWSI/EEPROM)
+*	 	**from this point, all S@R reads will be done using mvCtrlSatRConfig function**
+*
+* INPUT:  None
+*
+* OUTPUT: None
+*
+* RETURN: NONE
+*
+*******************************************************************************/
+void mvCtrlSatrInit(void)
+{
+	int i=0;
+	/* initialize all S@R fields to -1 (MV_ERROR) */
+	for (i=0; i<MV_SATR_MAX_OPTION ; i++)
+		satrOptionsConfig[i]=MV_ERROR;
+
+	/* detect board ID to determine which S@R fields are relevant */
+	//boardIDget
+
+
+	/* read S@R register / TWSI read and save them in satrOptionsConfig */
+	// if boardID==X
+	// TWSIwrite(...
+
+	/* temp: simulate dummy twsi initalizations */
+	printf("\nmvCtrlSatrDetect : simulate Detecting S@R (1,2,3,...)\n");
+	for (i=0; i<MV_SATR_MAX_OPTION ; i++)
+		satrOptionsConfig[i]=i%3;
+	/* temp: simulate dummy initalizations */
+}
+
+/*******************************************************************************
 * mvCtrlMppRegGet - return reg address of mpp group
 *
 * DESCRIPTION:
diff --git a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
index b9493e0..1739183 100644
--- a/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
+++ b/arch/arm/mach-avantalp/avanta_lp_family/ctrlEnv/mvCtrlEnvLib.h
@@ -74,6 +74,27 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include "ctrlEnv/mvCtrlEnvRegs.h"
 #include "ctrlEnv/mvCtrlEnvAddrDec.h"
 
+typedef enum _mvSatRTypeID {
+	/* "Bios" Device */
+	MV_SATR_CPU_FREQ,
+	MV_SATR_CORE_CLK_SELECT,
+	MV_SATR_CPU_NUM,
+	MV_SATR_SSCG_DISABLE,
+	/* Jumpers  - change by removing Jumper. S@R will be changed by this option */
+	MV_SATR_I2C0_Serial_ROM,
+	MV_SATR_External_CPU_Reset,
+	MV_SATR_External_CORE_Reset,
+	/* DIP Switch - change by removing Switch. S@R will be changed by this option: */
+	MV_SATR_BOOT_DEVICE,
+	/* DPR's -modified by moving resistor with solderer. S@R will be changed by this */
+	MV_SATR_CPU_PLL_XTAL_BYPASS,
+	MV_SATR_CPU_CONFIG,
+	MV_SATR_PCI_EXPRESS,
+	MV_SATR_REF_CLOCK_ENABLE,
+	MV_SATR_TESTER_OPTIONS,
+	MV_SATR_MAX_OPTION
+} MV_SATR_TYPE_ID;
+
 /* 0 for Auto scan mode, 1 for manual. */
 #define MV_INTERNAL_SWITCH_SMI_SCAN_MODE	0
 
@@ -205,6 +226,9 @@ extern MV_BIOS_MODE bios_modes[];
 extern MV_BIOS_MODE bios_modes_b0[];
 
 /* mcspLib.h API list */
+MV_U32 mvCtrlSatRWrite(MV_SATR_TYPE_ID satrField ,MV_U8 val);
+MV_U32 mvCtrlSatRRead(MV_SATR_TYPE_ID satrField);
+MV_U32 mvCtrlSatRDetect(void);
 MV_U32 mvCtrlGetCpuNum(MV_VOID);
 MV_U32 mvCtrlGetQuadNum(MV_VOID);
 MV_STATUS mvCtrlUpdatePexId(MV_VOID);
-- 
1.7.5.4

