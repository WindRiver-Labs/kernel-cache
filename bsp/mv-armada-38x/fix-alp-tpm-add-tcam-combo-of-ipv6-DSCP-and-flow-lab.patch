From 98169a9be2436c503b1b197090fc0b07cdcc0254 Mon Sep 17 00:00:00 2001
From: Ken Ma <make@marvell.com>
Date: Thu, 5 Jun 2014 16:34:15 +0800
Subject: [PATCH 1702/1825] fix: alp: tpm: add tcam combo of ipv6 DSCP and
 flow label

https://github.com/MISL-EBU-System-SW/misl-windriver.git linux-3.4.69-14t2-read
commit 6773f626ec39a5ae0fa2818334079d2c7fbbd1db

	add tcam combo of ipv6 DSCP and flow label
	SYSTEMSW-676 - TPM IPv6 DSCP, flow lable (and NH) match failure
	(due to the extra byte 0x00 added)

Signed-off-by: Ken Ma <make@marvell.com>

Change-Id: Ifbe22e1f21a6f5366274be846b14a115f4511f3e
Signed-off-by: Ken Ma <make@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/8391
Reviewed-by: Hua Jing <jinghua@marvell.com>
Tested-by: Star_Automation <star@marvell.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../mv_drivers_lsp/mv_tpm/src/core/tpm_c2.c        |   10 +++-------
 .../mv_drivers_lsp/mv_tpm/src/core/tpm_c3.c        |   10 +++-------
 2 files changed, 6 insertions(+), 14 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_c2.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_c2.c
index ba73490..9929300 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_c2.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_c2.c
@@ -1698,7 +1698,6 @@ int tpm_c2_tcam_hek_get(unsigned int field_bm,
 	unsigned int pre_field_id = 0;
 	bool comb_flag = false;
 	unsigned char comb_offset = 0;
-	unsigned int field_id_array[4] = {0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF};
 
 	IF_NULL(TPM_C2_MOD, c2_entry);
 	IF_NULL(TPM_C2_MOD, hek);
@@ -1821,12 +1820,10 @@ int tpm_c2_tcam_hek_get(unsigned int field_bm,
 				comb_offset = 2;
 			}
 		case IPV6_FLOW_LBL_FIELD_ID:
-			if (field_id == IPV6_FLOW_LBL_FIELD_ID && pre_field_id == IPV6_ECN_FIELD_ID) {
+			if (field_id == IPV6_FLOW_LBL_FIELD_ID &&
+				(pre_field_id == IPV6_DSCP_FIELD_ID || pre_field_id == IPV6_ECN_FIELD_ID)) {
 				comb_flag = true;
-				if (field_id_array[0] == IP_VER_FIELD_ID && field_id_array[1] == IPV6_DSCP_FIELD_ID)
-					comb_offset = 4;
-				if (field_id_array[1] != IPV6_DSCP_FIELD_ID)
-					comb_offset = 6;
+				comb_offset = 4;
 			}
 
 			/* Get HEK data */
@@ -1950,7 +1947,6 @@ int tpm_c2_tcam_hek_get(unsigned int field_bm,
 		}
 		/* record previous id */
 		pre_field_id = field_id;
-		field_id_array[field_num] = field_id;
 
 		/* Increase filed number */
 		field_num++;
diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_c3.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_c3.c
index db8b55f..f55d632 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_c3.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_tpm/src/core/tpm_c3.c
@@ -240,7 +240,6 @@ static int tpm_c3_hek_generate(struct tpm_c3_add_entry_t *c3_entry,
 	unsigned int pre_field_id = 0;
 	bool comb_flag = false;
 	unsigned char comb_offset = 0;
-	unsigned int field_id_array[4] = {0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF};
 	int rc = TPM_OK;
 
 	IF_NULL(TPM_C3_MOD, c3_entry);
@@ -341,12 +340,10 @@ static int tpm_c3_hek_generate(struct tpm_c3_add_entry_t *c3_entry,
 			}
 		/* fallthru */
 		case IPV6_FLOW_LBL_FIELD_ID:
-			if (field_id == IPV6_FLOW_LBL_FIELD_ID && pre_field_id == IPV6_ECN_FIELD_ID) {
+			if (field_id == IPV6_FLOW_LBL_FIELD_ID &&
+				(pre_field_id == IPV6_DSCP_FIELD_ID || pre_field_id == IPV6_ECN_FIELD_ID)) {
 				comb_flag = true;
-				if (field_id_array[0] == IP_VER_FIELD_ID && field_id_array[1] == IPV6_DSCP_FIELD_ID)
-					comb_offset = 4;
-				if (field_id_array[1] != IPV6_DSCP_FIELD_ID)
-					comb_offset = 6;
+				comb_offset = 4;
 			}
 
 			/* Get HEK data */
@@ -423,7 +420,6 @@ static int tpm_c3_hek_generate(struct tpm_c3_add_entry_t *c3_entry,
 		}
 		/* record previous id */
 		pre_field_id = field_id;
-		field_id_array[field_num] = field_id;
 
 		/* increase field number */
 		field_num++;
-- 
1.7.5.4

