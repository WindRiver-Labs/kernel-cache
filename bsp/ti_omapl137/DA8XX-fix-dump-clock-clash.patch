From 6345b9900666063009b44da1e5e77ee511f95c78 Mon Sep 17 00:00:00 2001
From: Tony Liu <Bo.Liu@windriver.com>
Date: Tue, 27 Apr 2010 19:04:54 +0800
Subject: [PATCH] DA8XX: fix dump clock clash

Both the sequential methods clkdev_add() and clk_register() in davinci_clk_init()
add list node onto global list head clocks, so the interleaved registration overlapped
each other. Since the nodes added by clkdev_add() are used by other clock mechanism,
remove clk_register() list node registration, and fix handling in dump_clock() to
track the proper node.

Signed-off-by: Tonyliu <Bo.Liu@windriver.com>
---
 arch/arm/mach-davinci/clock.c |    8 +++++---
 1 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/arch/arm/mach-davinci/clock.c b/arch/arm/mach-davinci/clock.c
index bf901bc..e42823a 100644
--- a/arch/arm/mach-davinci/clock.c
+++ b/arch/arm/mach-davinci/clock.c
@@ -259,7 +259,6 @@ int clk_register(struct clk *clk)
 	INIT_LIST_HEAD(&clk->children);
 
 	mutex_lock(&clocks_mutex);
-	list_add_tail(&clk->node, &clocks);
 	if (clk->parent)
 		list_add_tail(&clk->childnode, &clk->parent->children);
 	mutex_unlock(&clocks_mutex);
@@ -599,12 +598,15 @@ dump_clock(struct seq_file *s, unsigned nest, struct clk *parent)
 
 static int davinci_ck_show(struct seq_file *m, void *v)
 {
+	struct clk_lookup *p;
 	/* Show clock tree; we know the main oscillator is first.
 	 * We trust nonzero usecounts equate to PSC enables...
 	 */
 	mutex_lock(&clocks_mutex);
-	if (!list_empty(&clocks))
-		dump_clock(m, 0, list_first_entry(&clocks, struct clk, node));
+	if (!list_empty(&clocks)) {
+		p = list_first_entry(&clocks, struct clk, node);
+		dump_clock(m, 0, p->clk);
+	}
 	mutex_unlock(&clocks_mutex);
 
 	return 0;
-- 
1.6.0.4

