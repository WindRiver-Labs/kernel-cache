From 0bb720ddb32947be56bdf2b0889e23df573f2314 Mon Sep 17 00:00:00 2001
From: Tonyliu <Bo.Liu@windriver.com>
Date: Thu, 22 Oct 2009 16:57:46 +0800
Subject: [PATCH 14/14] PM: add suspend/resume for DaVinci mcasp

Add suspend/resume methods for PM.

Signed-off-by: Tonyliu <Bo.Liu@windriver.com>
---
 sound/soc/davinci/davinci-mcasp.c |   54 +++++++++++++++++++++++++++++++++++++
 1 files changed, 54 insertions(+), 0 deletions(-)

diff --git a/sound/soc/davinci/davinci-mcasp.c b/sound/soc/davinci/davinci-mcasp.c
index 9ae7b91..3fcc73c 100644
--- a/sound/soc/davinci/davinci-mcasp.c
+++ b/sound/soc/davinci/davinci-mcasp.c
@@ -658,12 +658,66 @@ static int davinci_i2s_mcasp_trigger(struct snd_pcm_substream *substream,
 	return ret;
 }
 
+#ifdef CONFIG_PM
+static int davinci_i2s_mcasp_suspend(struct platform_device *pdev,
+		struct snd_soc_dai *dai)
+{
+	struct snd_soc_device *socdev = platform_get_drvdata(pdev);
+	struct snd_soc_card *card = socdev->card;
+	struct snd_soc_dai *cpu_dai = card->dai_link->cpu_dai;
+	struct davinci_audio_dev *dev_list = cpu_dai->private_data;
+	struct davinci_audio_dev *dev;
+	int i;
+
+	if (!dai->active)
+		return 0;
+
+	/* Since each cpu_dai channel has been disabled in
+	 * davinci_i2s_mcasp_trigger() 	 * by responding to
+	 * SNDRV_PCM_TRIGGER_SUSPEND, here we turn off clock to
+	 * reduce power comsuming.
+	 */
+	for (i = 0; i < card->num_links; i++) {
+		dev = &dev_list[i];
+		clk_disable(dev->clk);
+	}
+
+	return 0;
+}
+
+static int davinci_i2s_mcasp_resume(struct platform_device *pdev,
+		struct snd_soc_dai *dai)
+{
+	struct snd_soc_device *socdev = platform_get_drvdata(pdev);
+	struct snd_soc_card *card = socdev->card;
+	struct snd_soc_dai *cpu_dai = card->dai_link->cpu_dai;
+	struct davinci_audio_dev *dev_list = cpu_dai->private_data;
+	struct davinci_audio_dev *dev;
+	int i;
+
+	if (!dai->active)
+		return 0;
+
+	for (i = 0; i < card->num_links; i++) {
+		dev = &dev_list[i];
+		clk_enable(dev->clk);
+	}
+
+	return 0;
+}
+#else
+#define davinci_i2s_mcasp_suspend	NULL
+#define davinci_i2s_mcasp_resume	NULL
+#endif
+
 struct snd_soc_dai davinci_i2s_mcasp_dai[] = {
 	{
 		.name = "davinci-i2s",
 		.id = 0,
 		.probe = davinci_i2s_mcasp_probe,
 		.remove = davinci_i2s_mcasp_remove,
+		.suspend = davinci_i2s_mcasp_suspend,
+		.resume = davinci_i2s_mcasp_resume,
 		.playback = {
 			.channels_min = 1,
 			.channels_max = 384,
-- 
1.6.5.2

