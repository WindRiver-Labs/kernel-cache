From 561668acddd55bf78818662c8883bd8aba829b5d Mon Sep 17 00:00:00 2001
From: Wally Gleemer <Wally.Gleemer@windriver.com>
Date: Thu, 13 Mar 2008 20:19:13 -0700
Subject: [PATCH] cavium: Make ELF_CORE_COPY_REGS defineable early

Cavium has a use case where it needs to have ELF_CORE_COPY_REGS
defined ahead of the include of elf.h -- so only prototype it
here if we've not seen it before

Signed-off-by: Wally Gleemer <Wally.Gleemer@windriver.com>
---
 arch/mips/kernel/binfmt_elfo32.c |    6 ++++++
 include/asm-mips/elf.h           |    2 ++
 2 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/arch/mips/kernel/binfmt_elfo32.c b/arch/mips/kernel/binfmt_elfo32.c
index 08f4cd7..da2b6c0 100644
--- a/arch/mips/kernel/binfmt_elfo32.c
+++ b/arch/mips/kernel/binfmt_elfo32.c
@@ -53,6 +53,12 @@ typedef elf_fpreg_t elf_fpregset_t[ELF_NFPREG];
 #define ELF_ET_DYN_BASE         (TASK32_SIZE / 3 * 2)
 
 #include <asm/processor.h>
+#ifdef CONFIG_CPU_CAVIUM_OCTEON
+/* These MUST be defined before elf.h gets included */
+extern void elf32_core_copy_regs(elf_gregset_t grp, struct pt_regs *regs);
+#define ELF_CORE_COPY_REGS(_dest,_regs) elf32_core_copy_regs(_dest,_regs);
+#endif
+
 #include <linux/module.h>
 #include <linux/elfcore.h>
 #include <linux/compat.h>
diff --git a/include/asm-mips/elf.h b/include/asm-mips/elf.h
index f69f7ac..8969273 100644
--- a/include/asm-mips/elf.h
+++ b/include/asm-mips/elf.h
@@ -320,8 +320,10 @@ extern void elf_dump_regs(elf_greg_t *, struct pt_regs *regs);
 extern int dump_task_regs(struct task_struct *, elf_gregset_t *);
 extern int dump_task_fpu(struct task_struct *, elf_fpregset_t *);
 
+#ifndef ELF_CORE_COPY_REGS
 #define ELF_CORE_COPY_REGS(elf_regs, regs)			\
 	elf_dump_regs((elf_greg_t *)&(elf_regs), regs);
+#endif
 #define ELF_CORE_COPY_TASK_REGS(tsk, elf_regs) dump_task_regs(tsk, elf_regs)
 #define ELF_CORE_COPY_FPREGS(tsk, elf_fpregs)			\
 	dump_task_fpu(tsk, elf_fpregs)
-- 
1.5.5.1

