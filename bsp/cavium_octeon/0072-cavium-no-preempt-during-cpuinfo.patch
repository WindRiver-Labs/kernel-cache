From 006c840d7de3e18da15eb7dc154a52caef02b1f8 Mon Sep 17 00:00:00 2001
From: Wally Gleemer <Wally.Gleemer@windriver.com>
Date: Thu, 13 Mar 2008 21:43:30 -0700
Subject: [PATCH] cavium: no preempt during cpuinfo

Temporarily disable the preemption when going after the
current_cpu_data struct.

Signed-off-by: Wally Gleemer <Wally.Gleemer@windriver.com>
---
 arch/mips/kernel/proc.c |   12 ++++++++++--
 1 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/arch/mips/kernel/proc.c b/arch/mips/kernel/proc.c
index 36f0653..9bc4694 100644
--- a/arch/mips/kernel/proc.c
+++ b/arch/mips/kernel/proc.c
@@ -19,14 +19,21 @@ unsigned int vced_count, vcei_count;
 
 static int show_cpuinfo(struct seq_file *m, void *v)
 {
+	unsigned int version;
+	unsigned int fp_vers;
 	unsigned long n = (unsigned long) v - 1;
-	unsigned int version = cpu_data[n].processor_id;
-	unsigned int fp_vers = cpu_data[n].fpu_id;
 	char fmt [64];
 
+	preempt_disable();
+	version = current_cpu_data.processor_id;
+	fp_vers = current_cpu_data.fpu_id;
+
 #ifdef CONFIG_SMP
 	if (!cpu_isset(n, cpu_online_map))
+	{
+		preempt_enable();
 		return 0;
+	}
 #endif
 
 	/*
@@ -70,6 +77,7 @@ static int show_cpuinfo(struct seq_file *m, void *v)
 	seq_printf(m, fmt, 'I', vcei_count);
 	seq_printf(m, "\n");
 
+	preempt_enable();
 	return 0;
 }
 
-- 
1.5.5.1

