From 774ca91dd486fe406cdb77fd4ec5fec2cca75690 Mon Sep 17 00:00:00 2001
From: Wally Gleemer <Wally.Gleemer@windriver.com>
Date: Tue, 25 Mar 2008 16:21:39 -0700
Subject: [PATCH] cavium: Add in CAVIUM_RESERVE32_USE_WIRED_TLB

Add in the task size changes associated with the
CAVIUM_RESERVE32_USE_WIRED_TLB optimization.

Signed-off-by: Wally Gleemer <Wally.Gleemer@windriver.com>
---
 arch/mips/kernel/binfmt_elfn32.c |    4 ++++
 arch/mips/kernel/binfmt_elfo32.c |    4 ++++
 include/asm-mips/processor.h     |    4 ++++
 3 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/arch/mips/kernel/binfmt_elfn32.c b/arch/mips/kernel/binfmt_elfn32.c
index 77db347..b130ac5 100644
--- a/arch/mips/kernel/binfmt_elfn32.c
+++ b/arch/mips/kernel/binfmt_elfn32.c
@@ -46,7 +46,11 @@ typedef elf_fpreg_t elf_fpregset_t[ELF_NFPREG];
 	__res;								\
 })
 
+#ifdef CONFIG_CAVIUM_RESERVE32_USE_WIRED_TLB
+#define TASK32_SIZE		(0x7fff8000UL - (CONFIG_CAVIUM_RESERVE32<<20))
+#else
 #define TASK32_SIZE		0x7fff8000UL
+#endif
 #undef ELF_ET_DYN_BASE
 #define ELF_ET_DYN_BASE         (TASK32_SIZE / 3 * 2)
 
diff --git a/arch/mips/kernel/binfmt_elfo32.c b/arch/mips/kernel/binfmt_elfo32.c
index da2b6c0..2eacbca 100644
--- a/arch/mips/kernel/binfmt_elfo32.c
+++ b/arch/mips/kernel/binfmt_elfo32.c
@@ -48,7 +48,11 @@ typedef elf_fpreg_t elf_fpregset_t[ELF_NFPREG];
 	__res;								\
 })
 
+#ifdef CONFIG_CAVIUM_RESERVE32_USE_WIRED_TLB
+#define TASK32_SIZE		(0x7fff8000UL - (CONFIG_CAVIUM_RESERVE32<<20))
+#else
 #define TASK32_SIZE		0x7fff8000UL
+#endif
 #undef ELF_ET_DYN_BASE
 #define ELF_ET_DYN_BASE         (TASK32_SIZE / 3 * 2)
 
diff --git a/include/asm-mips/processor.h b/include/asm-mips/processor.h
index d70e226..d6589ec 100644
--- a/include/asm-mips/processor.h
+++ b/include/asm-mips/processor.h
@@ -56,7 +56,11 @@ extern unsigned int vced_count, vcei_count;
  * support 16TB; the architectural reserve for future expansion is
  * 8192EB ...
  */
+#ifdef CONFIG_CAVIUM_RESERVE32_USE_WIRED_TLB
+#define TASK_SIZE32	(0x7fff8000UL - (CONFIG_CAVIUM_RESERVE32<<20))
+#else
 #define TASK_SIZE32	0x7fff8000UL
+#endif
 #define TASK_SIZE	0x10000000000UL
 #define STACK_TOP	\
       (test_thread_flag(TIF_32BIT_ADDR) ? TASK_SIZE32 : TASK_SIZE)
-- 
1.5.5.1

