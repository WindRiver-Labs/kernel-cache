From aae302a0a0037905283e8dc6380ad8df9386a677 Mon Sep 17 00:00:00 2001
From: Wally Gleemer <Wally.Gleemer@windriver.com>
Date: Thu, 13 Mar 2008 12:38:51 -0700
Subject: [PATCH] cavium: syncw in write barrier

Add in a syncw to the fast_wmb(), fast_mb() and fast_iob()

Signed-off-by: Wally Gleemer <Wally.Gleemer@windriver.com>
---
 include/asm-mips/barrier.h |   29 +++++++++++++++++++++++++++++
 1 files changed, 29 insertions(+), 0 deletions(-)

diff --git a/include/asm-mips/barrier.h b/include/asm-mips/barrier.h
index 9d8cfbb..d0ab52e 100644
--- a/include/asm-mips/barrier.h
+++ b/include/asm-mips/barrier.h
@@ -78,6 +78,18 @@
 #define __sync()	do { } while(0)
 #endif
 
+
+#ifdef CONFIG_CPU_CAVIUM_OCTEON
+#define __syncw() 	__asm__ __volatile__(OCTEON_SYNCW_STR ::: "memory")
+#define __fast_iob()	do { } while(0)
+
+#define fast_wmb()	__syncw()
+#define fast_rmb()	do { } while(0)
+#define fast_mb()	__syncw()
+#define fast_iob()	do { } while(0)
+
+#else /* CONFIG_CPU_CAVIUM_OCTEON */
+
 #define __fast_iob()				\
 	__asm__ __volatile__(			\
 		".set	push\n\t"		\
@@ -97,6 +109,7 @@
 		__sync();			\
 		__fast_iob();			\
 	} while (0)
+#endif
 
 #ifdef CONFIG_CPU_HAS_WB
 
@@ -117,9 +130,21 @@
 #endif /* !CONFIG_CPU_HAS_WB */
 
 #if defined(CONFIG_WEAK_ORDERING) && defined(CONFIG_SMP)
+#ifdef CONFIG_CPU_CAVIUM_OCTEON
+/* We actually use two syncw instructions in a row when we need a write memory
+   barrier. This is because the CN3XXX series of Octeons have errata Core-401.
+   This can cause a single syncw to not enforce ordering under very rare
+   conditions. Even if it is rare, better safe than sorry */
+#define __WEAK_ORDERING_MB ".set push\n.set arch=octeon\nsyncw\nsyncw\n.set pop\n"
+
+#define OCTEON_SYNCW_STR __WEAK_ORDERING_MB
+#else /* CONFIG_CPU_CAVIUM_OCTEON */
 #define __WEAK_ORDERING_MB	"       sync	\n"
+#define OCTEON_SYNCW_STR
+#endif
 #else
 #define __WEAK_ORDERING_MB	"		\n"
+#define OCTEON_SYNCW_STR
 #endif
 #if defined(CONFIG_WEAK_REORDERING_BEYOND_LLSC) && defined(CONFIG_SMP)
 #define __WEAK_LLSC_MB		"       sync	\n"
@@ -128,7 +153,11 @@
 #endif
 
 #define smp_mb()	__asm__ __volatile__(__WEAK_ORDERING_MB : : :"memory")
+#ifdef CONFIG_CPU_CAVIUM_OCTEON
+#define smp_rmb()	barrier()
+#else
 #define smp_rmb()	__asm__ __volatile__(__WEAK_ORDERING_MB : : :"memory")
+#endif
 #define smp_wmb()	__asm__ __volatile__(__WEAK_ORDERING_MB : : :"memory")
 
 #define set_mb(var, value) \
-- 
1.5.5.1

