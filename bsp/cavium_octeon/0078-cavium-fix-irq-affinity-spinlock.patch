From a14d304f2ad19c94d05d464bc259702f8af42435 Mon Sep 17 00:00:00 2001
From: auto commit <unknown@unknown>
Date: Fri, 24 Oct 2008 12:22:58 -0700
Subject: [PATCH] cavium: fix irq affinity spinlock

Remove extra locking. Spinlock is now acquired outside the Octeon-specific set_affinity function, in irq_setup.

Signed-off-by: Tomaso Paoletti <tpaoletti@caviumnetworks.com>
---
 arch/mips/kernel/irq-octeon.c |    8 --------
 1 files changed, 0 insertions(+), 8 deletions(-)

diff --git a/arch/mips/kernel/irq-octeon.c b/arch/mips/kernel/irq-octeon.c
index 399c637..738f3c6 100644
--- a/arch/mips/kernel/irq-octeon.c
+++ b/arch/mips/kernel/irq-octeon.c
@@ -152,11 +152,8 @@ static void octeon_irq_ciu0_disable(unsigned int irq)
 static void octeon_irq_ciu0_set_affinity(unsigned int irq, cpumask_t dest)
 {
 	int cpu;
-	unsigned long flags;
-	irq_desc_t *desc = irq_desc + irq;
 	int bit = irq - OCTEON_IRQ_WORKQ0;	/* Bit 0-63 of EN0 */
 
-	spin_lock_irqsave(&desc->lock, flags);
 	write_lock(&octeon_irq_ciu0_rwlock);
 	for (cpu = 0; cpu < NR_CPUS; cpu++) {
 		if (cpu_present(cpu)) {
@@ -174,7 +171,6 @@ static void octeon_irq_ciu0_set_affinity(unsigned int irq, cpumask_t dest)
 	   are done */
 	cvmx_read_csr(CVMX_CIU_INTX_EN0(cvmx_get_core_num() * 2));
 	write_unlock(&octeon_irq_ciu0_rwlock);
-	spin_unlock_irqrestore(&desc->lock, flags);
 }
 #endif
 
@@ -263,11 +259,8 @@ static void octeon_irq_ciu1_disable(unsigned int irq)
 static void octeon_irq_ciu1_set_affinity(unsigned int irq, cpumask_t dest)
 {
 	int cpu;
-	unsigned long flags;
-	irq_desc_t *desc = irq_desc + irq;
 	int bit = irq - OCTEON_IRQ_WDOG0;	/* Bit 0-63 of EN1 */
 
-	spin_lock_irqsave(&desc->lock, flags);
 	write_lock(&octeon_irq_ciu1_rwlock);
 	for (cpu = 0; cpu < NR_CPUS; cpu++) {
 		if (cpu_present(cpu)) {
@@ -286,7 +279,6 @@ static void octeon_irq_ciu1_set_affinity(unsigned int irq, cpumask_t dest)
 	   are done */
 	cvmx_read_csr(CVMX_CIU_INTX_EN1(cvmx_get_core_num() * 2 + 1));
 	write_unlock(&octeon_irq_ciu1_rwlock);
-	spin_unlock_irqrestore(&desc->lock, flags);
 }
 #endif
 
-- 
1.5.5.1

