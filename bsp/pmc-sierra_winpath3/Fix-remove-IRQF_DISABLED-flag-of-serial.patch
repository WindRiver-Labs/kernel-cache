From 2f288de9bfda00bbf4c409712996f915e4515d73 Mon Sep 17 00:00:00 2001
From: Jiang, Bin <bin.jiang@windriver.com>
Date: Tue, 12 Apr 2011 17:20:22 +0800
Subject: [PATCH 10/13] Fix: remove IRQF_DISABLED flag of serial

Remove IRQF_DISABLED flag since other irqs should be allowed to interrupt
the serial driver.

After removed IRQF_DISABLED, serial didn't run well. When running ISR of
serial, many hard interrupts of serial still occurred.

Before running ISR of serial, mask_ack of winpath3_pic should be called to
ack and disable the irq of serial.
Now the mask_ack of winpath3_pic only includes ack function. So modify it
to support ack and disable functions.

Signed-off-by: Jiang Bin <bin.jiang@windriver.com>
---
 arch/mips/wintegra/wds3/wds3-int.c |    2 +-
 drivers/serial/8250.c              |    4 ----
 2 files changed, 1 insertions(+), 5 deletions(-)

diff --git a/arch/mips/wintegra/wds3/wds3-int.c b/arch/mips/wintegra/wds3/wds3-int.c
index 452f47f..9363fad 100644
--- a/arch/mips/wintegra/wds3/wds3-int.c
+++ b/arch/mips/wintegra/wds3/wds3-int.c
@@ -221,7 +221,7 @@ static struct irq_chip winpath3_pic = {
    .mask           = winpath3_pic_disable,
    .disable        = winpath3_pic_disable,
    .unmask         = winpath3_pic_enable,
-   .mask_ack       = winpath3_pic_ack,
+   .mask_ack       = winpath3_pic_disable,
 #ifdef CONFIG_MIPS_MT_SMTC_IRQAFF
    .set_affinity   = plat_set_irq_affinity,
 #endif /* CONFIG_MIPS_MT_SMTC_IRQAFF */
diff --git a/drivers/serial/8250.c b/drivers/serial/8250.c
index 4dd72c0..a8d5284 100644
--- a/drivers/serial/8250.c
+++ b/drivers/serial/8250.c
@@ -1929,11 +1929,7 @@ static int serial_link_irq_chain(struct uart_8250_port *up)
 		INIT_LIST_HEAD(&up->list);
 		i->head = &up->list;
 		spin_unlock_irq(&i->lock);
-#if defined(CONFIG_SERIAL_8250_WINPATH)
-		irq_flags |= IRQF_DISABLED;
-#else
 		irq_flags |= up->port.irqflags;
-#endif
 		ret = request_irq(up->port.irq, serial8250_interrupt,
 				  irq_flags, "serial", i);
 		if (ret < 0)
-- 
1.7.0.4

