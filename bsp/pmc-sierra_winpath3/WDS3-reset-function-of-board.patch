From 02442f9e207952a97bdc5230e16496a577cdffdf Mon Sep 17 00:00:00 2001
From: Jiang, Bin <bin.jiang@windriver.com>
Date: Sat, 2 Apr 2011 17:05:31 +0800
Subject: [PATCH 04/13] WDS3: reset function of board

Extracted from vendor drop(linux-mti-2.6.29.4-1 with modifications for WDS3).

Reset function for WDS3 board.

mips_machine_restart is an empty function, so WDS3 board failed to reset, after
running reboot command. Set "0xBF100002" with "0x01" in mips_machine_restart
function to enable reset function.

Signed-off-by: Jiang Bin <bin.jiang@windriver.com>
---
 arch/mips/wintegra/wds3/Makefile     |    2 +-
 arch/mips/wintegra/wds3/wds3-reset.c |   51 ++++++++++++++++++++++++++++++++++
 2 files changed, 52 insertions(+), 1 deletions(-)
 create mode 100644 arch/mips/wintegra/wds3/wds3-reset.c

diff --git a/arch/mips/wintegra/wds3/Makefile b/arch/mips/wintegra/wds3/Makefile
index 7a6c459..1ed4d81 100644
--- a/arch/mips/wintegra/wds3/Makefile
+++ b/arch/mips/wintegra/wds3/Makefile
@@ -6,6 +6,6 @@
 #   written by Ralf Baechle <ralf@linux-mips.org>
 #
 obj-y				:= wds3-init.o wds3-int.o \
-				   wds3-memory.o
+				   wds3-memory.o wds3-reset.o
 
 EXTRA_CFLAGS += -Werror
diff --git a/arch/mips/wintegra/wds3/wds3-reset.c b/arch/mips/wintegra/wds3/wds3-reset.c
new file mode 100644
index 0000000..da365f1
--- /dev/null
+++ b/arch/mips/wintegra/wds3/wds3-reset.c
@@ -0,0 +1,51 @@
+/*
+ * Copyright (C) 2000-2010 Wintegra Inc.  All rights reserved.
+ *
+ * ########################################################################
+ *
+ *  This program is free software; you can distribute it and/or modify it
+ *  under the terms of the GNU General Public License (Version 2) as
+ *  published by the Free Software Foundation.
+ *
+ *  This program is distributed in the hope it will be useful, but WITHOUT
+ *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+ *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
+ *  for more details.
+ *
+ *  You should have received a copy of the GNU General Public License along
+ *  with this program; if not, write to the Free Software Foundation, Inc.,
+ *  59 Temple Place - Suite 330, Boston MA 02111-1307, USA.
+ *
+ * ########################################################################
+ *
+ * Reset the MIPS boards.
+ *
+ */
+#include <linux/pm.h>
+
+#include <asm/io.h>
+#include <asm/reboot.h>
+#include <asm/wintegra/wds.h>
+
+static void mips_machine_restart(char *command);
+static void mips_machine_halt(void);
+
+#define WEB_FPGA_BASE_UNCACHED     0xBF100000
+#define WEB_FPGA_RESET_ALL         (WEB_FPGA_BASE_UNCACHED + 0x02)
+static void mips_machine_restart(char *command)
+{
+	__raw_writeb(0x01, (unsigned char *)WEB_FPGA_RESET_ALL);
+}
+
+static void mips_machine_halt(void)
+{
+  mips_machine_restart("");
+}
+
+
+void mips_reboot_setup(void)
+{
+	_machine_restart = mips_machine_restart;
+	_machine_halt = mips_machine_halt;
+	pm_power_off = mips_machine_halt;
+}
-- 
1.7.0.4

