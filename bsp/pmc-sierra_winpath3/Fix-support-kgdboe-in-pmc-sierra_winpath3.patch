From 6ec7c0fdeb17be503661a6c476071ffa185e9f9e Mon Sep 17 00:00:00 2001
From: Jiang, Bin <bin.jiang@windriver.com>
Date: Mon, 18 Apr 2011 12:09:44 +0800
Subject: [PATCH 12/13] Fix: support kgdboe in pmc-sierra_winpath3

Implement ndo_poll_controller function in ethernet driver to
support kgdboe.
When being at a break point, there are some waring message on
console. They are no useful, so remove the printk code.

Signed-off-by: Jiang Bin<bin.jiang@windriver.com>
---
 drivers/net/wintegra/winpath3/enet_host/enet_api.c |   11 +++++++++++
 .../net/wintegra/winpath3/enet_host/enet_host.c    |    3 +--
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/drivers/net/wintegra/winpath3/enet_host/enet_api.c b/drivers/net/wintegra/winpath3/enet_host/enet_api.c
index 909d5b9..5266f1a 100644
--- a/drivers/net/wintegra/winpath3/enet_host/enet_api.c
+++ b/drivers/net/wintegra/winpath3/enet_host/enet_api.c
@@ -235,6 +235,14 @@ static void enet_wp_set_multicast(struct net_device *dev)
 {
 }
 
+#ifdef CONFIG_NET_POLL_CONTROLLER
+static void enet_wp_poll_controller(struct net_device *netdev)
+{
+	disable_irq(netdev->irq);
+	enet_wp_irq_handler(netdev->irq, netdev);
+	enable_irq(netdev->irq);
+}
+#endif
 static const struct net_device_ops wp_netdev_ops = {
 	.ndo_open               = enet_wp_open,
 	.ndo_stop               = enet_wp_close,
@@ -242,6 +250,9 @@ static const struct net_device_ops wp_netdev_ops = {
 	.ndo_set_multicast_list = enet_wp_set_multicast,
 	.ndo_get_stats          = enet_wp_get_stats,
 	.ndo_tx_timeout         = enet_wp_tx_timeout,
+#ifdef CONFIG_NET_POLL_CONTROLLER
+	.ndo_poll_controller 	= enet_wp_poll_controller,
+#endif
 };
 
 
diff --git a/drivers/net/wintegra/winpath3/enet_host/enet_host.c b/drivers/net/wintegra/winpath3/enet_host/enet_host.c
index d490ddc..975de40 100644
--- a/drivers/net/wintegra/winpath3/enet_host/enet_host.c
+++ b/drivers/net/wintegra/winpath3/enet_host/enet_host.c
@@ -372,8 +372,7 @@ irqreturn_t winEth_interrupt(struct net_device *dev)
 	}
        gen_statistics_reg2 = read_register(ETH_GEN_STS2_REG);
      }
-   } else
-     printk("winEth_interrupt: NO packet received rx_int.reg 0x%08x\n", rx_int.reg);
+   }
 
    tx_int.reg = read_register(ETH_TX_INT_REG);
    tx_int.reg &= 0xe0000000;
-- 
1.7.0.4

