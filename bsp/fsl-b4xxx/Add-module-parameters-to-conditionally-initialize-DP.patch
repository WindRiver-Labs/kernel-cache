From 630d68cbbbbd160c4655cd0055409106a9c6b3c5 Mon Sep 17 00:00:00 2001
From: alexandru Badicioiu <Alexandru.Badicioiu@freescale.com>
Date: Thu, 22 Mar 2012 21:48:06 +0000
Subject: [PATCH 125/518] Add module parameters to conditionally initialize
 DPA IPsec in fsl_dpa_offload driver usecase.

Signed-off-by: Alexandru BADICIOIU <alexandru.badicioiu@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/usecases/main.c |   36 ++++++++++++++++-------
 1 files changed, 25 insertions(+), 11 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/usecases/main.c b/drivers/staging/fsl_dpa_offload/usecases/main.c
index d0250ab..a348218 100644
--- a/drivers/staging/fsl_dpa_offload/usecases/main.c
+++ b/drivers/staging/fsl_dpa_offload/usecases/main.c
@@ -79,6 +79,16 @@ static int bpids_argc = 3;
 module_param_array(bpids, int, &bpids_argc, 0);
 MODULE_PARM_DESC(bpids, "\tBuffer pools ids used by USDPAA app");
 
+/* Register for XFRM notifications */
+static int xfrm_km;
+module_param(xfrm_km, int, 0);
+MODULE_PARM_DESC(xfrm_km, "\tRegister for XFRM notifications");
+
+/* Initialize IPsec offloading */
+static int ipsec_offld;
+module_param(ipsec_offld, int, 0);
+MODULE_PARM_DESC(ipsec_offld, "\tInitialize IPsec offloading");
+
 /*******************************************************************/
 
 int __init usecase_init(void)
@@ -161,15 +171,18 @@ int __init usecase_init(void)
 	pr_info("Created UL TX QUEUE queue fqid %d\n",
 		qman_fq_fqid(&ul_tx_fq));
 
-
-	if (E_OK != DipInit()) {
-		pr_err("Cannot initialize DPA IPsec\n");
-		return 0;
+	if (ipsec_offld) {
+		ret = DipInit();
+		if (ret != E_OK) {
+			pr_err("Cannot initialize DPA IPsec\n");
+			return 0;
+		}
+		pr_info("Initialized DPA IPsec\n");
+	}
+	if (xfrm_km) {
+		xfrm_km_init();
+		pr_info("Registered for XFRM key notifications\n");
 	}
-	pr_info("Initialized DPA IPsec\n");
-
-	xfrm_km_init();
-	pr_info("Registered for XFRM key notifications\n");
 
 	return 0;
 }
@@ -178,10 +191,11 @@ int __init usecase_init(void)
 void __exit usecase_exit(void)
 {
 	int i;
+	if (xfrm_km)
+		xfrm_km_exit();
 
-	xfrm_km_exit();
-
-	DipCleanup();
+	if (ipsec_offld)
+		DipCleanup();
 
 	pr_info("Releasing USDPAA buffer pools ids : ");
 	for (i = 0; i < bpids_argc; i++) {
-- 
1.7.5.4

