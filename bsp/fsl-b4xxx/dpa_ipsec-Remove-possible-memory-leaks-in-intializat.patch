From b7b0c48d85444a6bccc714e2b3eb0ab4a5e50820 Mon Sep 17 00:00:00 2001
From: Mihai Serb <mihai.serb@freescale.com>
Date: Thu, 9 Aug 2012 14:06:44 +0000
Subject: [PATCH 273/518] dpa_ipsec: Remove possible memory leaks in
 intialization code

Because the instance control block was not saved in a global
variable right after allocation, there was a possibility that not all
memory would be freed if an error occured before the instance was
fully initialized.

Signed-off-by: Mihai Serb <mihai.serb@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index 7d3c9e8..e8a0169 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -2768,6 +2768,9 @@ int dpa_ipsec_init(const struct dpa_ipsec_params *params, int *dpa_ipsec_id)
 		return -ENOMEM;
 	}
 
+	/* store the control block so rollback can occur in case of error */
+	gbl_dpa_ipsec = dpa_ipsec;
+
 	/* Initialize DPA IPSec instance lock */
 	mutex_init(&dpa_ipsec->lock);
 
@@ -2796,8 +2799,6 @@ int dpa_ipsec_init(const struct dpa_ipsec_params *params, int *dpa_ipsec_id)
 	/* retrieve and store SEC ERA information */
 	get_sec_era_info(dpa_ipsec);
 
-	gbl_dpa_ipsec = dpa_ipsec;
-
 	return 0;
 }
 EXPORT_SYMBOL(dpa_ipsec_init);
-- 
1.7.5.4

