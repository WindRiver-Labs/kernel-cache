From e4cc21f362eaab7d351f9f4ffa05a588f22d2d79 Mon Sep 17 00:00:00 2001
From: Bulie Radu-Andrei-B37577 <radu.bulie@freescale.com>
Date: Mon, 5 Nov 2012 18:11:01 +0000
Subject: [PATCH 401/518] offload_use_case: Mark if an offloaded policy has
 the protocol field masked

Policies with protocol field "any" were not offloaded correctly.
This patch fixes this issue by marking if the protocol field is
masked.

Signed-off-by: Bulie Radu-Andrei-B37577 <radu.bulie@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/usecases/xfrm_km.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/usecases/xfrm_km.c b/drivers/staging/fsl_dpa_offload/usecases/xfrm_km.c
index aff60d2..332881a 100644
--- a/drivers/staging/fsl_dpa_offload/usecases/xfrm_km.c
+++ b/drivers/staging/fsl_dpa_offload/usecases/xfrm_km.c
@@ -614,6 +614,9 @@ static inline int offload_policy(struct dpa_ipsec_policy_params *pol_params,
 	pol_params->l4.dest_port = sel->dport;
 	pol_params->l4.dest_port_mask = sel->dport_mask;
 
+	if (sel->proto == IPPROTO_IP)
+		pol_params->masked_proto = true;
+
 	memset(&policy_action, 0, sizeof(policy_action));
 	if (dir == XFRM_POLICY_IN) {
 		policy_action.type = DPA_CLS_TBL_ACTION_ENQ;
-- 
1.7.5.4

