From 03505992ed1aa258e00c64070657165d847db42a Mon Sep 17 00:00:00 2001
From: Cristian Sovaiala <cristian.sovaiala@freescale.com>
Date: Fri, 22 Feb 2013 13:40:51 +0000
Subject: [PATCH 498/518] dpaa_eth: Add FQ taildrop threshold for mac-less
 devices

FQ taildrop threshold is set by each partition on its RX frame queues
which are the TX queues of the other partition.
It is safe to rely on one partition to set the FQ taildrop threshold
on behalf of the other partition because the ERN notifications will
be delivered to the portal enqueueing the frames.

Signed-off-by: Cristian Sovaiala <cristian.sovaiala@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_eth.c |   19 +++++++++++++++++++
 1 files changed, 19 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
index a7c6484..c1b15a1 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth.c
@@ -98,6 +98,9 @@
  */
 #define DPA_CS_THRESHOLD_1G	0x06000000
 
+/* Size in bytes of the FQ taildrop threshold */
+#define DPA_FQ_TD		0x200000
+
 /* S/G table requires at least 256 bytes */
 #define SGT_BUFFER_SIZE		DPA_BP_SIZE(256)
 
@@ -643,6 +646,22 @@ _dpa_fq_alloc(struct list_head *list, struct dpa_fq *dpa_fq)
 		}
 
 		/*
+		 * For MAC-less devices we only get here for RX frame queues
+		 * initialization, which are the TX queues of the other
+		 * partition.
+		 * It is safe to rely on one partition to set the FQ taildrop
+		 * threshold for the TX queues of the other partition
+		 * because the ERN notifications will be received by the
+		 * partition doing qman_enqueue.
+		 */
+		if (!priv->mac_dev) {
+			initfq.we_mask |= QM_INITFQ_WE_TDTHRESH;
+			qm_fqd_taildrop_set(&initfq.fqd.td,
+					DPA_FQ_TD, 1);
+			initfq.fqd.fq_ctrl = QM_FQCTRL_TDE;
+		}
+
+		/*
 		 * Configure the Tx confirmation queue, now that we know
 		 * which Tx queue it pairs with.
 		 */
-- 
1.7.5.4

