From 313c7dcc25eef04d8fffef8a9e1e55540b3f2742 Mon Sep 17 00:00:00 2001
From: Mihai Serb <mihai.serb@freescale.com>
Date: Fri, 23 Mar 2012 22:12:19 +0000
Subject: [PATCH 134/518] Fix possible memory leak in ioctl wrapper

Signed-off-by: Mihai Serb <mihai.serb@freescale.com>
Checkpatch status: pass
Check legal status: pass
Internal review status: acked-by Andrei Varvara <andrei.varvara@freescale.com>
Must be applied: no
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
index 29a1adc..fb81935 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
@@ -309,15 +309,17 @@ long wrp_dpa_ipsec_ioctl(struct file *filp, unsigned int cmd,
 						&num_pol);
 		if (err < 0) {
 			xx_pr_err("Store policy failed");
-			return err;
+			ret = err;
+			goto err_pol_cleanup;
 		}
 
 		if (copy_to_user(in_prm->policy_params,
 				prm.policy_params,
 				num_pol * sizeof(*prm.policy_params))) {
 			xx_pr_err("Could not copy parameters\n");
-			return -EINVAL;
+			ret = -EINVAL;
 		}
+err_pol_cleanup:
 		kfree(prm.policy_params);
 		break;
 	}
-- 
1.7.5.4

