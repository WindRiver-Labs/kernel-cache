From d4fa75a2aa15a1e788696df7930da92014025c4e Mon Sep 17 00:00:00 2001
From: Alexandru Badicioiu <alexandru.badicioiu@freescale.com>
Date: Fri, 7 Dec 2012 12:12:18 +0200
Subject: [PATCH 427/518] fsl_ipacc_uc : changes required to run use case on
 B4860QDS

Signed-off-by: Alexandru Badicioiu <alexandru.badicioiu@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/usecases/Kconfig   |    3 +++
 .../usecases/dts/b4860qds-usdpaa.dts               |   12 ++++++++++++
 .../staging/fsl_dpa_offload/usecases/fm_utils.c    |   15 ++++++++++++---
 .../staging/fsl_dpa_offload/usecases/ports_conf.h  |   10 +++++++---
 4 files changed, 34 insertions(+), 6 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/usecases/Kconfig b/drivers/staging/fsl_dpa_offload/usecases/Kconfig
index bfc961b..4217c2e 100644
--- a/drivers/staging/fsl_dpa_offload/usecases/Kconfig
+++ b/drivers/staging/fsl_dpa_offload/usecases/Kconfig
@@ -12,4 +12,7 @@ config P4080_BUILD
 config P5020_BUILD
 	bool "P5020DS"
 
+config B4860_BUILD
+	bool "B4860QDS"
+
 endchoice
diff --git a/drivers/staging/fsl_dpa_offload/usecases/dts/b4860qds-usdpaa.dts b/drivers/staging/fsl_dpa_offload/usecases/dts/b4860qds-usdpaa.dts
index 6ffc72a..91c4bcb 100644
--- a/drivers/staging/fsl_dpa_offload/usecases/dts/b4860qds-usdpaa.dts
+++ b/drivers/staging/fsl_dpa_offload/usecases/dts/b4860qds-usdpaa.dts
@@ -111,5 +111,17 @@
 			fsl,bman-buffer-pools = <&bp9>;
 			fsl,fman-oh-port = <&fman0_oh2>;
 		};
+                dpa_fman0_oh3: dpa-fman0-oh@3 {
+                        compatible = "fsl,dpa-oh";
+                        fsl,qman-frame-queues-oh = <0x68 1 0x69 1>;
+                        fsl,bman-buffer-pools = <&bp9>;
+                        fsl,fman-oh-port = <&fman0_oh3>;
+                };
+                dpa_fman0_oh4: dpa-fman0-oh@4 {
+                        compatible = "fsl,dpa-oh";
+                        fsl,qman-frame-queues-oh = <0x70 1 0x71 1>;
+                        fsl,bman-buffer-pools = <&bp9>;
+                        fsl,fman-oh-port = <&fman0_oh4>;
+                };
 	};
 };
diff --git a/drivers/staging/fsl_dpa_offload/usecases/fm_utils.c b/drivers/staging/fsl_dpa_offload/usecases/fm_utils.c
index 812c3e0..130f1f3 100644
--- a/drivers/staging/fsl_dpa_offload/usecases/fm_utils.c
+++ b/drivers/staging/fsl_dpa_offload/usecases/fm_utils.c
@@ -151,15 +151,24 @@ int config_loopback(int fm_id, int port_idx, int set)
 		       __func__, mac_phys_addr);
 		return -ENXIO;
 	}
-
+#if defined(CONFIG_P4080_BUILD) || defined(CONFIG_P5020_BUILD)
 	val = in_be32((u32 *) (addr + FM_1GMAC_CMD_CONF_CTRL_OFFSET));
-
+#else
+	val = in_be32((u32 *) (addr + 0x08));
+#endif
 	if (set)
+#if defined(CONFIG_P4080_BUILD) || defined(CONFIG_P5020_BUILD)
 		val |= MACCFG1_LOOPBACK;
+#else
+		val |= 0x400;
+#endif
 	else
 		val &= ~MACCFG1_LOOPBACK;
-
+#if defined(CONFIG_P4080_BUILD) || defined(CONFIG_P5020_BUILD)
 	out_be32((u32 *) (addr + FM_1GMAC_CMD_CONF_CTRL_OFFSET), val);
+#else
+	out_be32((u32 *) (addr + 0x08), val);
+#endif
 
 	iounmap((u32 *) (addr + FM_1GMAC_CMD_CONF_CTRL_OFFSET));
 
diff --git a/drivers/staging/fsl_dpa_offload/usecases/ports_conf.h b/drivers/staging/fsl_dpa_offload/usecases/ports_conf.h
index fd4d845..8c7726e 100644
--- a/drivers/staging/fsl_dpa_offload/usecases/ports_conf.h
+++ b/drivers/staging/fsl_dpa_offload/usecases/ports_conf.h
@@ -45,9 +45,13 @@
 #define FM			0
 #define DL_RX			3
 #define UL_RX			4
+#elif defined CONFIG_B4860_BUILD
+#define FM                      0
+#define DL_RX                   2
+#define UL_RX                   5
 #endif
-#define DL_POST_IPSEC_OH	1
-#define UL_PRE_IPSEC_OH	2
-#define UL_POST_IPSEC_OH	3
+#define DL_POST_IPSEC_OH	2
+#define UL_PRE_IPSEC_OH	3
+#define UL_POST_IPSEC_OH	4
 
 #endif
-- 
1.7.5.4

