From a6548e740506a69b05c712be5f8ef43a1c9e1a85 Mon Sep 17 00:00:00 2001
From: Alexandru Badicioiu <alexandru.badicioiu@freescale.com>
Date: Tue, 13 Nov 2012 15:01:34 +0200
Subject: [PATCH 415/518] dpa_offload : fix memory leaks

sa_out_iv is lost when copy_from_user/compat_copy_sa_out_iv fails
policy_params is lost when compat_pol_params allocation fails
compat_pol_params is not freed when do_sa_get_policies_ioctl returns

Signed-off-by: Alexandru Badicioiu <alexandru.badicioiu@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
index 24dae25..c879eed 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
@@ -476,6 +476,7 @@ static int do_copy_sa_params(struct dpa_ipsec_sa_params *prm)
 					err = -EINVAL;
 			if (err < 0) {
 				pr_err("Error - copy SA out IV struct");
+				kfree(sa_out_iv);
 				return err;
 			}
 			sa_out_prm->init_vector = sa_out_iv;
@@ -906,6 +907,7 @@ static int do_sa_get_policies_ioctl(void *args, bool compat)
 				    GFP_KERNEL);
 	if (!compat_pol_params) {
 		pr_err("Could not allocate memory for compat policy array!\n");
+		kfree(policy_params);
 		return -ENOMEM;
 	}
 
@@ -937,6 +939,9 @@ static int do_sa_get_policies_ioctl(void *args, bool compat)
 	 */
 
 err_pol_cleanup:
+#ifdef CONFIG_COMPAT
+	kfree(compat_pol_params);
+#endif
 	kfree(policy_params);
 
 	return err;
-- 
1.7.5.4

