From 2896678694a65f9950da0f26c277591dca3e4688 Mon Sep 17 00:00:00 2001
From: Anca-Jeanina Floarea <anca.floarea@freescale.com>
Date: Thu, 25 Oct 2012 23:15:43 +0000
Subject: [PATCH 339/518] dpa_stats: Added check for counter identifier in
 get_counters function

The counter identifier should be checked against an invalid value before the
it is marked as being used.

Signed-off-by: Anca Jeanina FLOAREA <anca.floarea@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_stats.c |   11 ++++++++++-
 drivers/staging/fsl_dpa_offload/dpa_stats.h |    3 ++-
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_stats.c b/drivers/staging/fsl_dpa_offload/dpa_stats.c
index 6a6e069..0c3a341 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_stats.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_stats.c
@@ -3001,13 +3001,22 @@ int dpa_stats_get_counters(struct dpa_stats_cnt_request_params params,
 
 	*cnts_len = 0;
 
+	for (i = 0; i < params.cnts_ids_len; i++) {
+		if ((params.cnts_ids[i] == DPA_OFFLD_INVALID_OBJECT_ID) ||
+		   (params.cnts_ids[i] > dpa_stats->config.max_counters)) {
+			pr_err("Invalid Counter id %d provided\n", cnt_id);
+			return -EINVAL;
+		}
+	}
+
 	block_sched_cnts(dpa_stats, params.cnts_ids, params.cnts_ids_len, 0);
 
 	/* Calculate number of bytes occupied by the counters */
 	for (i = 0; i < params.cnts_ids_len; i++) {
 		cnt_id = params.cnts_ids[i];
 
-		if (cnt_id == DPA_OFFLD_INVALID_OBJECT_ID) {
+		if ((cnt_id == DPA_OFFLD_INVALID_OBJECT_ID) ||
+				(cnt_id > dpa_stats->config.max_counters)) {
 			pr_err("Invalid Counter id %d provided\n", cnt_id);
 			return -EINVAL;
 		}
diff --git a/drivers/staging/fsl_dpa_offload/dpa_stats.h b/drivers/staging/fsl_dpa_offload/dpa_stats.h
index c03c27b..a0f0456 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_stats.h
+++ b/drivers/staging/fsl_dpa_offload/dpa_stats.h
@@ -43,10 +43,11 @@
 #include "dpa_compat.h"
 #include "cq.h"
 
-#define MAX_NUM_OF_STATS DPA_STATS_MAX_NUM_OF_COUNTERS
+#define MAX_NUM_OF_STATS 23
 #define NUM_OF_CNT_TYPES (DPA_STATS_CNT_TRAFFIC_MNG + 1)
 #define MAX_NUM_OF_MEMBERS DPA_STATS_MAX_NUM_OF_CLASS_MEMBERS
 
+
 /* DPA Stats - Control Block */
 struct dpa_stats {
 	struct dpa_stats_params config;	/* Configuration parameters as
-- 
1.7.5.4

