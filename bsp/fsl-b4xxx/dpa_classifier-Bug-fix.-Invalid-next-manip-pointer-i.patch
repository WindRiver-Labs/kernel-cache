From 381e839d6e2facb5c924670288670c47ad3f4f30 Mon Sep 17 00:00:00 2001
From: Marian Chereji <marian.chereji@freescale.com>
Date: Wed, 12 Sep 2012 16:08:24 +0000
Subject: [PATCH 318/518] dpa_classifier: Bug fix. Invalid next manip pointer
 in init_hm_chain

The function init_hm_chain was feeding a bad h_NextManip pointer for
the last header manipulation in a chain. Instead of providing NULL,
it was providing a pointer to the first header manipulation in the
chain.

Signed-off-by: Marian Chereji <marian.chereji@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_classifier.c |    9 ++++++---
 1 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_classifier.c b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
index d315c82..f0a27ad 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_classifier.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
@@ -2823,13 +2823,16 @@ static int init_hm_chain(void *fm_pcd, struct list_head *chain_head,
 		err = init_hm_chain(fm_pcd, chain_head, item->next);
 		if (err)
 			return err;
-	}
+		pnext = list_entry(item->next,
+				struct dpa_cls_hm_node,
+				list_node);
+	} else
+		pnext = NULL;
 
 	/* Initialize the current node: */
 	pcurrent = list_entry(item, struct dpa_cls_hm_node, list_node);
-	pnext = list_entry(item->next, struct dpa_cls_hm_node, list_node);
+	pcurrent->params.h_NextManip = (pnext) ? (t_Handle)pnext->node : NULL;
 
-	pcurrent->params.h_NextManip = (t_Handle)pnext->node;
 	if (!pcurrent->node) {
 		pcurrent->node = (void *) FM_PCD_ManipNodeSet(
 							(t_Handle) fm_pcd,
-- 
1.7.5.4

