From 2620c43465e509beabff456cd6b81954b4ea189c Mon Sep 17 00:00:00 2001
From: Marian Chereji <marian.chereji@freescale.com>
Date: Fri, 9 Nov 2012 19:05:33 +0000
Subject: [PATCH 379/518] dpa_classifier: Use constant buffer pointer for
 "custom header insert" parameters

Changed the buffer pointer used for "custom insert" header manipulation
to "const" to indicate that no modifications are to be performed on the
user provided data.

Signed-off-by: Marian Chereji <marian.chereji@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_classifier.c |   25 +++++++++++++++------
 include/linux/fsl_dpa_classifier.h               |    2 +-
 2 files changed, 19 insertions(+), 8 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_classifier.c b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
index ffddfd6..8ad0180 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_classifier.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
@@ -4956,14 +4956,25 @@ int dpa_classif_modify_insert_hm(int hmd,
 				new_insert_params->custom.offset;
 			update = true;
 		}
-		if (modify_flags & DPA_CLS_HM_INS_MOD_CUSTOM_SIZE) {
-			hm_node->params.u.hdr.insrtParams.u.generic.size =
-				new_insert_params->custom.size;
-			update = true;
-		}
 		if (modify_flags & DPA_CLS_HM_INS_MOD_CUSTOM_DATA) {
-			hm_node->params.u.hdr.insrtParams.u.generic.p_Data =
-				new_insert_params->custom.data;
+			if ((modify_flags & DPA_CLS_HM_INS_MOD_CUSTOM_SIZE) &&
+		(hm_node->params.u.hdr.insrtParams.u.generic.size <
+					new_insert_params->custom.size)) {
+				kfree(hm_node->params.u.hdr.insrtParams.u.
+								generic.p_Data);
+	hm_node->params.u.hdr.insrtParams.u.generic.p_Data =
+			kzalloc(new_insert_params->custom.size, GFP_KERNEL);
+	if (!hm_node->params.u.hdr.insrtParams.u.generic.p_Data) {
+		pr_err("ERROR: %s, %s (%d): Not enough memory for "
+			"insert HM.\n", __FILE__, __func__, __LINE__);
+		return -ENOMEM;
+	}
+	hm_node->params.u.hdr.insrtParams.u.generic.size =
+						new_insert_params->custom.size;
+			}
+	memcpy(hm_node->params.u.hdr.insrtParams.u.generic.p_Data,
+		pinsert_hm->insert_params.custom.data,
+		hm_node->params.u.hdr.insrtParams.u.generic.size);
 			update = true;
 		}
 		break;
diff --git a/include/linux/fsl_dpa_classifier.h b/include/linux/fsl_dpa_classifier.h
index 96127cf..0e50b69 100644
--- a/include/linux/fsl_dpa_classifier.h
+++ b/include/linux/fsl_dpa_classifier.h
@@ -811,7 +811,7 @@ struct dpa_cls_hm_custom_ins_params {
 	 * The data buffer containing the header to insert. This buffer must be
 	 * at least [size] bytes long
 	 */
-	uint8_t		*data;
+	const uint8_t	*data;
 };
 
 /* Egress insert header manipulation low level driver resources */
-- 
1.7.5.4

