From d2a6b0d31de45872c155aec91f4ceae0b7d4a2f7 Mon Sep 17 00:00:00 2001
From: Marian Chereji <marian.chereji@freescale.com>
Date: Mon, 29 Oct 2012 21:38:04 +0000
Subject: [PATCH 353/518] dpa_classifier: Bug fix: Copy IP fragmentation
 params for forwarding HM in compat mode

The compat-copy function "dpa_cls_hm_fwd_params_compatcpy" was missing
code which is copying the IP fragmentation operation params. This code
was added.

Signed-off-by: Marian Chereji <marian.chereji@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 .../staging/fsl_dpa_offload/wrp_dpa_classifier.c   |    9 +++++++--
 1 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_classifier.c b/drivers/staging/fsl_dpa_offload/wrp_dpa_classifier.c
index d6b99f8..f3bed15 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_classifier.c
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_classifier.c
@@ -2526,8 +2526,10 @@ int dpa_cls_hm_fwd_params_compatcpy(
 {
 	int type;
 
-	type = kparam->fwd_params.out_if_type;
 	kparam->fwd_params.out_if_type = uparam->fwd_params.out_if_type;
+	kparam->fwd_params.fm_pcd = compat_ptr(uparam->fwd_params.fm_pcd);
+
+	type = kparam->fwd_params.out_if_type;
 	switch (type) {
 	case DPA_CLS_HM_IF_TYPE_ETHERNET:
 		memcpy(&kparam->fwd_params.eth, &uparam->fwd_params.eth,
@@ -2545,7 +2547,10 @@ int dpa_cls_hm_fwd_params_compatcpy(
 		break;
 	}
 
-	kparam->fwd_params.fm_pcd = compat_ptr(uparam->fwd_params.fm_pcd);
+	memcpy(&kparam->fwd_params.ip_frag_params,
+		&uparam->fwd_params.ip_frag_params,
+		sizeof(struct dpa_cls_hm_ip_frag_params));
+
 	kparam->next_hmd	= uparam->next_hmd;
 	kparam->hmd		= uparam->hmd;
 
-- 
1.7.5.4

