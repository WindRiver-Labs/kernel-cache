From b6d928d79ae56f80f344025d312d0512bdaf6634 Mon Sep 17 00:00:00 2001
From: Marian Chereji <marian.chereji@freescale.com>
Date: Mon, 17 Sep 2012 21:20:16 +0000
Subject: [PATCH 327/518] dpa_classifier: Optimisation. Move check for space
 at insert_entry to the beginning of the function

In the function table_insert_entry_exact_match the check for
available space in the table was performed late. This check
was moved to the beginning of the function to save unnecessary
work in case there isn't any space left for that new entry
anyway.

Signed-off-by: Marian Chereji <marian.chereji@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_classifier.c |   18 +++++++++---------
 1 files changed, 9 insertions(+), 9 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_classifier.c b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
index 4e7b0ac..2fe4652 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_classifier.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
@@ -1678,6 +1678,15 @@ static int table_insert_entry_exact_match(struct dpa_cls_table	*cls_table,
 		return -EINVAL;
 	}
 
+	if (cls_table->int_cc_node[0].used >=
+		cls_table->int_cc_node[0].table_size) {
+		/* No more space to add a new entry */
+		pr_err("ERROR: %s, %s (%d): DPA Classifier exact match table "
+			"is full. Unable to add a new entry.\n",
+			__FILE__, __func__, __LINE__);
+		return -ENOSPC;
+	}
+
 	memset(&key_params, 0, sizeof(t_FmPcdCcKeyParams));
 
 	/*
@@ -1697,15 +1706,6 @@ static int table_insert_entry_exact_match(struct dpa_cls_table	*cls_table,
 	if (errno < 0)
 		return errno;
 
-	if (cls_table->int_cc_node[0].used >=
-		cls_table->int_cc_node[0].table_size) {
-		/* No more space to add a new entry */
-		pr_err("ERROR: %s, %s (%d): DPA Classifier exact match table "
-			"is full. Unable to add a new entry.\n",
-			__FILE__, __func__, __LINE__);
-		return -ENOSPC;
-	}
-
 	/* Find an empty index management entry */
 	for (k = 0; k < cls_table->entries_cnt; k++)
 		if (!cls_table->entry[k].valid)
-- 
1.7.5.4

