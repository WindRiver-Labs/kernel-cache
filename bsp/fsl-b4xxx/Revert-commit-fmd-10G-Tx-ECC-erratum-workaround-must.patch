From f6279486bcaa6eec543a2b141ee891c1d21d1c9b Mon Sep 17 00:00:00 2001
From: Hai-Ying Wang <Haiying.Wang@freescale.com>
Date: Tue, 18 Dec 2012 01:24:23 +0000
Subject: [PATCH 015/518] Revert commit "fmd: 10G Tx ECC erratum workaround
 must run after tgec_init()"

Commit 1b8fd10e6dc0e52748b129d5e1ac798c4a7fcea7
fmd: 10G Tx ECC erratum workaround must run after
 tgec_init()"

breaks the 10G TGEC on P4080DS board, none of the 10G ports on P4080DS can work.
After reverting this commit, both T4 and P4 10G ports work.

Signed-off-by: Haiying Wang <Haiying.Wang@freescale.com>
Signed-off-by: Andy Fleming <afleming@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 .../dpa/NetCommSw/Peripherals/FM/MAC/tgec.c        |   24 ++++++++++----------
 1 files changed, 12 insertions(+), 12 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/tgec.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/tgec.c
index 1f1fbec..6e4b5e3 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/tgec.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/MAC/tgec.c
@@ -785,6 +785,18 @@ static t_Error TgecInit(t_Handle h_Tgec)
     FM_GetRevision(p_Tgec->fmMacControllerDriver.h_Fm, &p_Tgec->fmMacControllerDriver.fmRevInfo);
     CHECK_INIT_PARAMETERS(p_Tgec, CheckInitParameters);
 
+#ifdef FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
+    if (p_Tgec->fmMacControllerDriver.fmRevInfo.majorRev <= 6 /*fixed for rev3 */)
+    {
+        if (!p_Tgec->p_TgecDriverParam->skip_fman11_workaround &&
+            ((err = TgecTxEccWorkaround(p_Tgec)) != E_OK))
+        {
+            FreeInitResources(p_Tgec);
+            RETURN_ERROR(MAJOR, err, ("TgecTxEccWorkaround FAILED"));
+        }
+    }
+#endif /* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
+
     p_TgecDriverParam = p_Tgec->p_TgecDriverParam;
 
     MAKE_ENET_ADDR_FROM_UINT64(p_Tgec->addr, ethAddr);
@@ -849,18 +861,6 @@ static t_Error TgecInit(t_Handle h_Tgec)
     else if (p_Tgec->mdioIrq == 0)
         REPORT_ERROR(MINOR, E_NOT_SUPPORTED, (NO_MSG));
 
-#ifdef FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
-    if (p_Tgec->fmMacControllerDriver.fmRevInfo.majorRev <= 6 /*fixed for rev3 */)
-    {
-        if (!p_Tgec->p_TgecDriverParam->skip_fman11_workaround &&
-            ((err = TgecTxEccWorkaround(p_Tgec)) != E_OK))
-        {
-            FreeInitResources(p_Tgec);
-            RETURN_ERROR(MAJOR, err, ("TgecTxEccWorkaround FAILED"));
-        }
-    }
-#endif /* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
-
     XX_Free(p_TgecDriverParam);
     p_Tgec->p_TgecDriverParam = NULL;
 
-- 
1.7.5.4

