From 2a7c66871f455581a9cb3921cc35184c4b6939f4 Mon Sep 17 00:00:00 2001
From: andrei varvara <andrei.varvara@freescale.com>
Date: Fri, 18 May 2012 20:53:49 +0000
Subject: [PATCH 174/518] Remove SA policies function is now SMP safe

lock SA structure return if lock is contended
illegal to remove SA policy if SA is either
an outbound parent or inbound child

Signed-off-by: Andrei Varvara <andrei.varvara@freescale.com>
Acked-by: Mihai Serb <mihai.serb@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c |   33 ++++++++++++++++++++++-----
 1 files changed, 27 insertions(+), 6 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index b57466b..dec7b6e 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -3416,7 +3416,7 @@ int dpa_ipsec_sa_remove_policy(int sa_id,
 {
 	struct dpa_ipsec_policy_entry *policy_entry;
 	struct dpa_ipsec_sa *sa;
-	int err = 0;
+	int ret = 0;
 
 	if (!policy_params) {
 		xx_pr_err("Invalid policy parameters handle\n");
@@ -3429,18 +3429,39 @@ int dpa_ipsec_sa_remove_policy(int sa_id,
 		return -EINVAL;
 	}
 
-	err = find_policy_in_sa_policy_list(sa, policy_params, &policy_entry);
-	if (err < 0) {
+	ret = mutex_trylock(&sa->lock);
+	if (ret == 0) {
+		xx_pr_err("Failed to acquire lock for SA %d\n", sa->id);
+		return -EBUSY;
+	}
+
+	if (sa_is_parent(sa) && sa->sa_dir == DPA_IPSEC_OUTBOUND) {
+		xx_pr_err("Illegal removing out policy parent SA %d\n", sa->id);
+		mutex_unlock(&sa->lock);
+		return -EPERM;
+	}
+
+	if (sa_is_child(sa) && sa->sa_dir == DPA_IPSEC_INBOUND) {
+		xx_pr_err("Illegal removing in policy, child SA %d\n", sa->id);
+		mutex_unlock(&sa->lock);
+		return -EPERM;
+	}
+
+	ret = find_policy_in_sa_policy_list(sa, policy_params, &policy_entry);
+	if (ret < 0) {
 		xx_pr_err("Could not find policy entry in SA policy list\n");
-		return err;
+		mutex_unlock(&sa->lock);
+		return ret;
 	}
 
 	/* found the policy entry in SA policy parameter list;
 	 * depending on the type of the SA remove the PCD entry for this policy
 	 * and afterwards remove the policy param from SA policy param list */
-	err = remove_policy(sa, policy_entry);
+	ret = remove_policy(sa, policy_entry);
 
-	return err;
+	mutex_unlock(&sa->lock);
+
+	return ret;
 }
 EXPORT_SYMBOL(dpa_ipsec_sa_remove_policy);
 
-- 
1.7.5.4

