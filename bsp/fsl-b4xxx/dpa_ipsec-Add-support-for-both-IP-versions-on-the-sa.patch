From d030451f05bd7474133959c6cd16177a5db41470 Mon Sep 17 00:00:00 2001
From: andrei varvara <andrei.varvara@freescale.com>
Date: Fri, 26 Oct 2012 18:56:47 +0000
Subject: [PATCH 364/518] dpa_ipsec: Add support for both IP versions on the
 same SA in encryption

added in DPA IPsec component support for variable IP version
tunnel IPv4 and IPv6 in IPv4
tunnel IPv4 and IPv6 in IPv6

Signed-off-by: Andrei Varvara <andrei.varvara@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c |   17 ++++++++++++-----
 1 files changed, 12 insertions(+), 5 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index 590b1cf..34f56ff 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -1217,7 +1217,8 @@ static int create_ipsec_manip(struct dpa_ipsec_sa *sa, int next_hmd,
 	BUG_ON(!sa);
 	BUG_ON(!hmd);
 
-	if (!sa->use_var_iphdr_len && !sa->dscp_copy && !sa->ecn_copy) {
+	if (!sa->use_var_iphdr_len && !sa->dscp_copy && !sa->ecn_copy &&
+	    !(sa->sa_dir == DPA_IPSEC_OUTBOUND && sa->enable_dpovrd)) {
 		/* no need to create a new manipulation objects chain */
 		*hmd = next_hmd;
 		return 0;
@@ -1227,15 +1228,21 @@ static int create_ipsec_manip(struct dpa_ipsec_sa *sa, int next_hmd,
 	pcd_manip_params.type = e_FM_PCD_MANIP_SPECIAL_OFFLOAD;
 	offld_params = &pcd_manip_params.u.specialOffload;
 	offld_params->type = e_FM_PCD_MANIP_SPECIAL_OFFLOAD_IPSEC;
-	if (sa->sa_dir == DPA_IPSEC_INBOUND)
+	if (sa->sa_dir == DPA_IPSEC_INBOUND) {
 		offld_params->u.ipsec.decryption = true;
-	offld_params->u.ipsec.variableIpHdrLen = sa->use_var_iphdr_len;
+		offld_params->u.ipsec.variableIpHdrLen = sa->use_var_iphdr_len;
+	} else {
+		offld_params->u.ipsec.variableIpVersion = true;
+		offld_params->u.ipsec.outerIPHdrLen =
+						sa->sec_desc->pdb_en.ip_hdr_len;
+	}
 	offld_params->u.ipsec.ecnCopy = sa->ecn_copy;
 	offld_params->u.ipsec.dscpCopy = sa->dscp_copy;
+
 	pcd_manip_params.h_NextManip =
-				dpa_classif_get_static_hm_handle(next_hmd);
+			dpa_classif_get_static_hm_handle(next_hmd);
 	hm = FM_PCD_ManipNodeSet(sa->dpa_ipsec->config.fm_pcd,
-				     &pcd_manip_params);
+				 &pcd_manip_params);
 	if (!hm) {
 		pr_err("%s: FM_PCD_ManipSetNode failed!\n", __func__);
 		return -EBUSY;
-- 
1.7.5.4

