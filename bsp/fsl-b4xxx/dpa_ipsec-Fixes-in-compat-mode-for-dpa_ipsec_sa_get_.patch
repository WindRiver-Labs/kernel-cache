From f48e3951a8290c4d99fd1ab7a18b435c6d68e93e Mon Sep 17 00:00:00 2001
From: Anca-Jeanina Floarea <anca.floarea@freescale.com>
Date: Thu, 6 Dec 2012 15:47:21 +0000
Subject: [PATCH 425/518] dpa_ipsec: Fixes in compat mode for
 dpa_ipsec_sa_get_policies function

The following fixes were made in dpa_ipsec_sa_get_policies implementation
in wrapper: the ioc_compat_dpa_ipsec_add_rem_policy needs to be memset
before filling it with information from kernel space, the priority field
has to be copied into compat structure and the dest_addr parameter was
wrongly copied from src_addr parameter.

Signed-off-by: Anca Jeanina FLOAREA <anca.floarea@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c |    8 +++++++-
 1 files changed, 7 insertions(+), 1 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
index c879eed..1f79719 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
@@ -298,12 +298,16 @@ static void compat_copy_dpa_ipsec_add_rem_policy(
 		}
 		prm->pol_params.dir_params.type =
 					 compat_prm->pol_params.dir_params.type;
+		prm->pol_params.priority =
+					 compat_prm->pol_params.priority;
 	} else {
+		memset(compat_prm, 0,
+			sizeof(struct ioc_compat_dpa_ipsec_add_rem_policy));
 		compat_prm->sa_id = prm->sa_id;
 		compat_prm->pol_params.src_addr = prm->pol_params.src_addr;
 		compat_prm->pol_params.src_prefix_len =
 						 prm->pol_params.src_prefix_len;
-		compat_prm->pol_params.dest_addr = prm->pol_params.src_addr;
+		compat_prm->pol_params.dest_addr = prm->pol_params.dest_addr;
 		compat_prm->pol_params.dest_prefix_len =
 						prm->pol_params.dest_prefix_len;
 		compat_prm->pol_params.protocol = prm->pol_params.protocol;
@@ -324,6 +328,8 @@ static void compat_copy_dpa_ipsec_add_rem_policy(
 		}
 		compat_prm->pol_params.dir_params.type =
 						prm->pol_params.dir_params.type;
+		compat_prm->pol_params.priority =
+						prm->pol_params.priority;
 	}
 
 }
-- 
1.7.5.4

