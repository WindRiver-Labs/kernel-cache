From ef3a6fff5d3e9e130711281b17e483f9485285d8 Mon Sep 17 00:00:00 2001
From: Andrei Varvara <andrei.varvara@freescale.com>
Date: Mon, 25 Feb 2013 18:28:01 +0200
Subject: [PATCH 488/518] dpa_ipsec: Bug fix. DMA unmap the extra commands for
 the extended descriptors

A DMA unmap is necessary for the pointer where the extra
shared descriptor resides.

Signed-off-by: Andrei Varvara <andrei.varvara@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c
index f26c178..37b7a8e 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c
@@ -1115,6 +1115,9 @@ int build_extended_encap_shared_descriptor(struct dpa_ipsec_sa *sa,
 	append_move(desc, MOVE_SRC_DESCBUF | MOVE_DEST_MATH0 |
 		    (stats_off_b << MOVE_OFFSET_SHIFT) | sizeof(uint64_t));
 
+	dma_unmap_single(sa->dpa_ipsec->jrdev, dma_extra_cmds,
+			 extra_cmds_len * sizeof(uint32_t), DMA_TO_DEVICE);
+
 	return 0;
 }
 
@@ -1388,6 +1391,9 @@ int build_extended_decap_shared_descriptor(struct dpa_ipsec_sa *sa,
 	data = 0x00ff0000;
 	append_math_and_imm_u64_ifb(desc, REG2, DPOVRD, IMM, data);
 
+	dma_unmap_single(sa->dpa_ipsec->jrdev, dma_extra_cmds,
+			 extra_cmds_len * sizeof(uint32_t), DMA_TO_DEVICE);
+
 	return 0;
 }
 
-- 
1.7.5.4

