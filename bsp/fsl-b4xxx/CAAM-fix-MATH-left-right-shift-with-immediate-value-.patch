From a5344792b7804a694beb3e5da5a11ad5d76c8d6f Mon Sep 17 00:00:00 2001
From: Andrei Varvara <andrei.varvara@freescale.com>
Date: Wed, 16 May 2012 19:33:31 +0000
Subject: [PATCH 076/518] CAAM: fix MATH left/right shift with immediate value
 command

For shift_l or shift_r operation a LEN value diffrent than
0x08 may yield unexpected results.

Set IFB to reduce the amount of words consumed by this command

Signed-off-by: Andrei Varvara <andrei.varvara@freescale.com>
Acked-by: Mihai Serb <mihai.serb@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/crypto/caam/desc_constr.h |   13 +++++++++++--
 1 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/drivers/crypto/caam/desc_constr.h b/drivers/crypto/caam/desc_constr.h
index 58416d8..92466be 100644
--- a/drivers/crypto/caam/desc_constr.h
+++ b/drivers/crypto/caam/desc_constr.h
@@ -355,6 +355,15 @@ do { \
 #define append_math_xor_imm_u32(desc, dest, src0, src1, data) \
 	APPEND_MATH_IMM_u32(XOR, desc, dest, src0, src1, data)
 #define append_math_lshift_imm_u32(desc, dest, src0, src1, data) \
-	APPEND_MATH_IMM_u32(LSHIFT, desc, dest, src0, src1, data)
+do { \
+	APPEND_MATH(LSHIFT, desc, dest, src0, src1, 2 * CAAM_CMD_SZ) \
+	*((u32 *)desc_end(desc) - 1) |= MATH_IFB; \
+	append_cmd(desc, data); \
+} while (0);
+
 #define append_math_rshift_imm_u32(desc, dest, src0, src1, data) \
-	APPEND_MATH_IMM_u32(RSHIFT, desc, dest, src0, src1, data)
+do { \
+	APPEND_MATH(RSHIFT, desc, dest, src0, src1, 2 * CAAM_CMD_SZ) \
+	*((u32 *)desc_end(desc) - 1) |= MATH_IFB; \
+	append_cmd(desc, data); \
+} while (0);
-- 
1.7.5.4

