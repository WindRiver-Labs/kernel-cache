From 2f730ec39f4dd4853dc5cb3d642a7b1ebe39bca8 Mon Sep 17 00:00:00 2001
From: Anca-Jeanina Floarea <anca.floarea@freescale.com>
Date: Tue, 11 Sep 2012 21:44:51 +0000
Subject: [PATCH 316/518] dpa_stats: Fix Classification Table counter for
 invalid keys

The storage area needs to be set to 0 for all statistics selection
of an invalid key.

Signed-off-by: Anca Jeanina FLOAREA <anca.floarea@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_stats.c |   16 ++++++++++------
 1 files changed, 10 insertions(+), 6 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_stats.c b/drivers/staging/fsl_dpa_offload/dpa_stats.c
index 9cfdd5a..ba8dbb0 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_stats.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_stats.c
@@ -2113,11 +2113,13 @@ static int get_cnt_cls_tbl_stats(struct dpa_stats_req_cb *req_cb,
 	for (i = 0; i < cnt_cb->tbl_cb.keys_num; i++) {
 		if (!cnt_cb->tbl_cb.keys[i].valid) {
 			/* Write the memory location */
-			*(uint32_t *)(req_cb->request_area) = 0;
+			memset(req_cb->request_area, 0,
+				cnt_cb->tbl_cb.info.stats_num *
+					STATS_VAL_SIZE);
 
 			/* Update the memory pointer */
-			req_cb->request_area += STATS_VAL_SIZE;
-
+			req_cb->request_area += STATS_VAL_SIZE *
+					cnt_cb->tbl_cb.info.stats_num;
 			continue;
 		}
 
@@ -2149,11 +2151,13 @@ static int get_cnt_cls_tbl_frag_stats(struct dpa_stats_req_cb *req_cb,
 	for (i = 0; i < cnt_cb->tbl_cb.keys_num; i++) {
 		if (!cnt_cb->tbl_cb.keys[i].valid) {
 			/* Write the memory location */
-			*(uint32_t *)(req_cb->request_area) = 0;
+			memset(req_cb->request_area, 0,
+				cnt_cb->tbl_cb.info.stats_num *
+					STATS_VAL_SIZE);
 
 			/* Update the memory pointer */
-			req_cb->request_area += STATS_VAL_SIZE;
-
+			req_cb->request_area += STATS_VAL_SIZE *
+					cnt_cb->tbl_cb.info.stats_num;
 			continue;
 		}
 
-- 
1.7.5.4

