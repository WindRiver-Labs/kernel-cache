From 7637051ffeb107ea7a87d68efa4a7602d7cac0f3 Mon Sep 17 00:00:00 2001
From: andrei varvara <andrei.varvara@freescale.com>
Date: Fri, 18 May 2012 20:55:02 +0000
Subject: [PATCH 179/518] Add validity check for the SA id to see if it's
 being used

Signed-off-by: Andrei Varvara <andrei.varvara@freescale.com>
Acked-by: Mihai Serb <mihai.serb@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index dba62c5..c7e2714 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -2506,6 +2506,12 @@ static struct dpa_ipsec_sa *get_sa_from_sa_id(int sa_id)
 	}
 	sa = &sa_mng->sa[sa_id];
 
+	/* Validity check for this SA */
+	if (sa->used_sa_index == -1) {
+		xx_pr_err("SA with id %d is not valid\n", sa_id);
+		return NULL;
+	}
+
 	return sa;
 }
 
-- 
1.7.5.4

