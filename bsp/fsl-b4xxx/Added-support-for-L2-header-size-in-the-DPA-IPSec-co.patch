From fd827fec0268ad1f810c86dfa493a79fc04e959c Mon Sep 17 00:00:00 2001
From: andrei varvara <andrei.varvara@freescale.com>
Date: Thu, 17 May 2012 22:42:39 +0000
Subject: [PATCH 159/518] Added support for L2 header size in the DPA IPSec
 code

Updated crete SA and rekeying SA to support L2 header size per SA

Signed-off-by: Andrei Varvara <andrei.varvara@freescale.com>
Acked-by: Mihai Serb <mihai.serb@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c      |    2 ++
 drivers/staging/fsl_dpa_offload/dpa_ipsec.h      |    2 ++
 drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c |    3 ++-
 3 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index a02fdfc..a044695 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -2047,6 +2047,7 @@ static int copy_sa_params_to_out_sa(struct dpa_ipsec_sa *sa,
 	/* Only IPv4 inner packets are currently supported */
 	sa->sec_desc->pdb_en.ip_nh = 0x04;
 
+	sa->l2_hdr_size = sa_params->l2_hdr_size;
 	sa->enable_stats = sa_params->enable_stats;
 #ifdef DEBUG_PARAM
 	/* Printing all the parameters */
@@ -2181,6 +2182,7 @@ static int copy_sa_params_to_in_sa(struct dpa_ipsec_sa *sa,
 	       sizeof(struct dpa_ipsec_ip_address));
 
 	sa->policy_miss_fqid = sa_params->sa_in_params.policy_miss_fqid;
+	sa->l2_hdr_size = sa_params->l2_hdr_size;
 	sa->enable_stats = sa_params->enable_stats;
 #ifdef DEBUG_PARAM
 	/* Printing all the parameters */
diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.h b/drivers/staging/fsl_dpa_offload/dpa_ipsec.h
index 69c6805..008b037 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.h
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.h
@@ -262,6 +262,8 @@ struct dpa_ipsec_sa {
 	int use_var_iphdr_len; /* Enable variable IP header length support    */
 	struct dpa_cls_tbl_header_manip *hm;	/* Header manipulation        */
 	dpa_ipsec_rekey_event_cb rekey_event_cb;
+	uint8_t l2_hdr_size; /* Size of the Ethernet header, including any
+			      * VLAN information.			      */
 };
 
 /* Parameters for inbound policy verification tables */
diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c
index 3869566..ef6709d 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c
@@ -326,7 +326,8 @@ int create_sec_descriptor(struct dpa_ipsec_sa *sa)
 	}
 
 	/* build the shared descriptor */
-	build_shared_descriptor(sa, auth_key_dma, crypto_key_dma, ETH_HLEN);
+	build_shared_descriptor(sa, auth_key_dma, crypto_key_dma,
+				sa->l2_hdr_size);
 
 	sec_desc = sa->sec_desc;
 	/* setup preheader */
-- 
1.7.5.4

