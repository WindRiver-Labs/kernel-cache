From 394df1660c975dbb6f2d0ed6d8575004579039f8 Mon Sep 17 00:00:00 2001
From: andrei varvara <andrei.varvara@freescale.com>
Date: Fri, 15 Feb 2013 22:14:56 +0000
Subject: [PATCH 482/518] dpa_ipsec: Bug fix. Packets are corrupted when anti
 replay size is set to 64

When setting the anti replay feature with 64 bytes window size
a bug appears from the second packet that was enqueued for
decription.

The shared descriptor is trying to run a invalid command positioned
at the anti_replay[1] pdb storage.

This patch starts the creation of the shared descriptor commands
after the anti_replay[1] from PDB.

Signed-off-by: Andrei Varvara <andrei.varvara@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c |    5 +----
 1 files changed, 1 insertions(+), 4 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c
index b53ffe6..1a6a959 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec_desc.c
@@ -543,10 +543,7 @@ int build_shared_descriptor(struct dpa_ipsec_sa *sa,
 		pdb_len += sizeof(struct ipsec_encap_pdb) + opthdrsz;
 		init_sh_desc_pdb(desc, HDR_SAVECTX | HDR_SHARE_SERIAL, pdb_len);
 	} else {
-		/* Since ipsec_decap_pdb has cbc which stores ESN
-		*into its second field and there is also seq_num_ext_hi we
-		*must subtract 1 word for ESN */
-		pdb_len += sizeof(struct ipsec_decap_pdb) - sizeof(u32);
+		pdb_len += sizeof(struct ipsec_decap_pdb);
 		init_sh_desc_pdb(desc, HDR_SAVECTX | HDR_SHARE_SERIAL, pdb_len);
 	}
 
-- 
1.7.5.4

