From d13022d5f511c9a09ad7bb42f9eda89d2092b6b3 Mon Sep 17 00:00:00 2001
From: Aurelian Zanoschi <aurelian.zanoschi@freescale.com>
Date: Thu, 6 Dec 2012 22:06:49 +0000
Subject: [PATCH 424/518] dpa_stats: Get policer counter at policer class
 counter init

- fixed the policer class counter mechanism from
  dpa_stats_create_class_counter function
- added check routine for policer handler in
  dpa_stats_create_class_counter to return error
  at counter creation time

Signed-off-by: Aurelian Zanoschi <aurelian.zanoschi@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_stats.c |   13 +++++++++++--
 1 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_stats.c b/drivers/staging/fsl_dpa_offload/dpa_stats.c
index 1bda3e1..b5d7894 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_stats.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_stats.c
@@ -1568,6 +1568,7 @@ static int set_cls_cnt_plcr_cb(struct dpa_stats_cnt_cb *cnt_cb,
 		const struct dpa_stats_cls_cnt_params *params)
 {
 	struct dpa_stats *dpa_stats = cnt_cb->dpa_stats;
+	struct stats_info *info = &cnt_cb->info;
 	uint32_t cnt_sel = params->plcr_params.cnt_sel, i;
 
 	if (!dpa_stats) {
@@ -1583,8 +1584,16 @@ static int set_cls_cnt_plcr_cb(struct dpa_stats_cnt_cb *cnt_cb,
 
 	cnt_cb->members_num = params->class_members;
 
-	for (i = 0; i < params->class_members; i++)
-		cnt_cb->gen_cb.objs[0] = params->plcr_params.plcr;
+	for (i = 0; i < params->class_members; i++) {
+		cnt_cb->gen_cb.objs[i] = params->plcr_params.plcr[i];
+		/* Check the user-provided policer handle */
+		FM_PCD_PlcrProfileGetCounter(cnt_cb->gen_cb.objs[i],
+				info->stats_off[0]);
+		/*
+		 * in case of bad counter the error will be displayed at
+		 * creation time
+		 */
+	}
 
 	if (cnt_sel == DPA_STATS_CNT_PLCR_ALL)
 		cnt_sel -= 1;
-- 
1.7.5.4

