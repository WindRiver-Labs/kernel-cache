From 01c740b5c63511dd3dad6f22831774d5fcb7092f Mon Sep 17 00:00:00 2001
From: Marian Chereji <marian.chereji@freescale.com>
Date: Fri, 9 Nov 2012 19:06:33 +0000
Subject: [PATCH 382/518] dpa_classifier: Replace boolean "created" indication
 for header manipulation node w/ flags

The data structure which is used to operate on a header manipulation node
(dpa_cls_hm_node) had a boolean attribute which was indicating whether
the header manip node was under the control of dpa_classifier or not. This
was replaced with an integer "flags" attribute which can hold more states or
properties (32 boolean states) of the header manip node for future use. The
INTERNAL/EXTERNAL node property is now indicated by a single bit from these
flags:

#define DPA_CLS_HM_NODE_INTERNAL 0x1

Signed-off-by: Marian Chereji <marian.chereji@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_classifier.c |    4 ++--
 drivers/staging/fsl_dpa_offload/dpa_classifier.h |   10 +++++++++-
 2 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_classifier.c b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
index 713a351..1bfa81d 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_classifier.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
@@ -3659,7 +3659,7 @@ static int init_hm_chain(void *fm_pcd, struct list_head *chain_head,
 			err = -EINVAL;
 		}
 
-		pcurrent->created = true;
+		pcurrent->flags |= DPA_CLS_HM_NODE_INTERNAL;
 	} else {
 		/* Need to sync with an existing node */
 		memcpy(&params, &pcurrent->params, sizeof(params));
@@ -3692,7 +3692,7 @@ int remove_hm_chain(struct list_head *chain_head, struct list_head *item)
 	/* Remove the current node: */
 	pcurrent = list_entry(item, struct dpa_cls_hm_node, list_node);
 
-	if ((pcurrent->created) && (pcurrent->node)) {
+	if ((pcurrent->flags & DPA_CLS_HM_NODE_INTERNAL) && (pcurrent->node)) {
 		error = FM_PCD_ManipNodeDelete((t_Handle) pcurrent->node);
 		if (error != E_OK) {
 			pr_warn("WARNING: Memory leak: failed to remove low "
diff --git a/drivers/staging/fsl_dpa_offload/dpa_classifier.h b/drivers/staging/fsl_dpa_offload/dpa_classifier.h
index d99c45d..78ad558 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_classifier.h
+++ b/drivers/staging/fsl_dpa_offload/dpa_classifier.h
@@ -59,6 +59,13 @@
 
 #define DPA_CLS_HM_MAX_NODES_PER_OP				3
 
+/* Available flags for a header manipulation node: */
+
+/* HM node is external (i.e. not created by DPA Classifier) */
+#define DPA_CLS_HM_NODE_EXTERNAL				0x0
+/* HM node is internal (i.e. created & managed by DPA Classifier) */
+#define DPA_CLS_HM_NODE_INTERNAL				0x1
+
 /* Available flags for an index management entry: */
 
 /* Indication that the entry is valid */
@@ -214,7 +221,8 @@ struct dpa_cls_descriptor_table {
 
 struct dpa_cls_hm_node {
 	void			*node;
-	bool			created;
+
+	unsigned		flags;
 	unsigned		ref;
 	t_FmPcdManipParams	params;
 	struct list_head	list_node;
-- 
1.7.5.4

