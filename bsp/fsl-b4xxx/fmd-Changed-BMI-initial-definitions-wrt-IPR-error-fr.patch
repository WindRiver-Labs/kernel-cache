From d7acbe56e6a88c2f41e969ec070166292dc4c84b Mon Sep 17 00:00:00 2001
From: Mandy Lavi <mandy.lavi@freescale.com>
Date: Tue, 12 Mar 2013 00:04:58 +0000
Subject: [PATCH 067/518] fmd: Changed BMI initial definitions wrt IPR error
 frames

Changed init definitions so that BMI drops all IPR error frames
and not enqueue into error queue.

Signed-off-by: Mandy Lavi <mandy.lavi@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 .../dpa/NetCommSw/Peripherals/FM/Port/fm_port.h    |    3 +++
 .../dpa/NetCommSw/src/wrapper/lnxwrp_fm_port.c     |    7 ++++++-
 2 files changed, 9 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Port/fm_port.h b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Port/fm_port.h
index 5c01851..7873595 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Port/fm_port.h
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/Peripherals/FM/Port/fm_port.h
@@ -499,10 +499,13 @@ typedef _Packed struct
                                                              FM_PORT_FRM_ERR_PRS_ILL_INSTRUCT       | \
                                                              FM_PORT_FRM_ERR_BLOCK_LIMIT_EXCEEDED   | \
                                                              FM_PORT_FRM_ERR_PRS_HDR_ERR            | \
+                                                             FM_PORT_FRM_ERR_IPRE                   | \
+                                                             FM_PORT_FRM_ERR_IPR_NCSP               | \
                                                              FM_PORT_FRM_ERR_KEYSIZE_OVERFLOW))
 
 #define BMI_STATUS_OP_MASK_UNUSED               (uint32_t)(BMI_STATUS_RX_MASK_UNUSED &                \
                                                            ~(FM_PORT_FRM_ERR_LENGTH                 | \
+                                                             FM_PORT_FRM_ERR_NON_FM                 | \
                                                              FM_PORT_FRM_ERR_UNSUPPORTED_FORMAT))
 
 #define BMI_RATE_LIMIT_EN                       0x80000000
diff --git a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_fm_port.c b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_fm_port.c
index b8b993c..f070701 100644
--- a/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_fm_port.c
+++ b/drivers/net/ethernet/freescale/dpa/NetCommSw/src/wrapper/lnxwrp_fm_port.c
@@ -788,10 +788,15 @@ static t_Error InitFmPortDev(t_LnxWrpFmPortDev *p_LnxWrpFmPortDev)
 #endif
 #endif
 
+    if (FM_PORT_ConfigErrorsToDiscard(p_LnxWrpFmPortDev->h_Dev, (FM_PORT_FRM_ERR_IPRE |
+                                                                 FM_PORT_FRM_ERR_IPR_NCSP |
+                                                                 FM_PORT_FRM_ERR_CLS_DISCARD)) !=E_OK)
+                RETURN_ERROR(MAJOR, E_INVALID_STATE, NO_MSG);
+
     if (CheckNConfigFmPortAdvArgs(p_LnxWrpFmPortDev) != E_OK)
 		RETURN_ERROR(MAJOR, E_INVALID_STATE, NO_MSG);
 
-	if (FM_PORT_Init(p_LnxWrpFmPortDev->h_Dev) != E_OK)
+    if (FM_PORT_Init(p_LnxWrpFmPortDev->h_Dev) != E_OK)
 		RETURN_ERROR(MAJOR, E_INVALID_STATE, NO_MSG);
 
     if (CheckNSetFmPortAdvArgs(p_LnxWrpFmPortDev) != E_OK)
-- 
1.7.5.4

