From 9822afbb7b3e75e2c6a0c837ab3fd51a37b1833e Mon Sep 17 00:00:00 2001
From: Anca-Jeanina Floarea <anca.floarea@freescale.com>
Date: Fri, 7 Sep 2012 20:18:46 +0000
Subject: [PATCH 311/518] dpa_stats: Fix dpa_stats_modify_class_counter for a
 pair of keys

Changed the function to take in account when the first key of
a pair of keys is NULL, in order to invalidate that key.

Signed-off-by: Anca Jeanina FLOAREA <anca.floarea@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_stats.c |   24 +++++++++++++++---------
 1 files changed, 15 insertions(+), 9 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_stats.c b/drivers/staging/fsl_dpa_offload/dpa_stats.c
index bfbafc4..5754259 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_stats.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_stats.c
@@ -1756,14 +1756,14 @@ int set_classif_tbl_member(const struct dpa_stats_cls_member_params *params,
 		tbl_cb->info.last_stats[member_index][i] = 0;
 	}
 
-	if (!params->key.byte) {
-		/* Mark the key as invalid */
-		tbl_cb->keys[member_index].valid = FALSE;
-
-	} else {
-		tbl_cb->keys[member_index].valid = TRUE;
+	if (params->type == DPA_STATS_CLS_MEMBER_SINGLE_KEY) {
+		if (!params->key.byte) {
+			/* Mark the key as invalid */
+			tbl_cb->keys[member_index].valid = FALSE;
+			return 0;
+		} else {
+			tbl_cb->keys[member_index].valid = TRUE;
 
-		if (params->type == DPA_STATS_CLS_MEMBER_SINGLE_KEY) {
 			/* Copy the key descriptor */
 			err = copy_key_descriptor(&params->key,
 					&tbl_cb->keys[member_index].key);
@@ -1771,13 +1771,19 @@ int set_classif_tbl_member(const struct dpa_stats_cls_member_params *params,
 				pr_err("Unable to copy key descriptor\n");
 				return -EINVAL;
 			}
-
+		}
+	} else {
+		if (!params->pair.first_key.byte) {
+			/* Mark the key as invalid */
+			tbl_cb->keys[member_index].valid = FALSE;
+			return 0;
 		} else {
+			tbl_cb->keys[member_index].valid = TRUE;
 			err = set_cls_cnt_classif_tbl_pair(tbl_cb->td,
 					&params->pair,
 					&tbl_cb->keys[member_index]);
 			if (err != 0) {
-				pr_err("Unable to copy key descriptor\n");
+				pr_err("Unable to configure the key pair\n");
 				return -EINVAL;
 			}
 		}
-- 
1.7.5.4

