From 03aba919425a199d36c701d37b87b94f40ad6e05 Mon Sep 17 00:00:00 2001
From: andrei varvara <andrei.varvara@freescale.com>
Date: Sat, 11 Feb 2012 02:38:26 +0000
Subject: [PATCH 096/518] DPA IPSec bug fixing

minor fix in free_sa_mng - should have deleted the cc node not tree
    minor fix in rekeying - should have copied also the old sa index entry id

Signed-off-by: Mihai Serb <mihai.serb@freescale.com>
Signed-off-by: Andrei Varvara <andrei.varvara@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index 31c492d..b292b11 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -678,7 +678,7 @@ static void free_sa_mng(struct dpa_ipsec *dpa_ipsec)
 		if (err < 0)
 			xx_pr_err(("Could not free policy check EM table\n"));
 		list_del(&pol_tbl->table_list);
-		fmd_err = FM_PCD_CcDeleteTree(dpa_ipsec->config.fm_pcd,
+		fmd_err = FM_PCD_CcDeleteNode(dpa_ipsec->config.fm_pcd,
 				pol_tbl->cc_node);
 		if (fmd_err != E_OK)
 			xx_pr_fmd_err(fmd_err, "FM_PCD_CcDeleteTree");
@@ -2655,6 +2655,9 @@ int dpa_ipsec_sa_rekeying(int sa_id,
 			goto rekey_sa_err;
 		}
 
+		if (dpa_ipsec->config.post_sec_in_params.do_pol_check)
+			new_sa->inbound_indx_entry = old_sa->inbound_indx_entry;
+
 		/* Add new SA into the sa_rekeying_headlist */
 		list_add(&new_sa->sa_rekeying_node,
 			 &sa_mng->sa_rekeying_headlist);
-- 
1.7.5.4

