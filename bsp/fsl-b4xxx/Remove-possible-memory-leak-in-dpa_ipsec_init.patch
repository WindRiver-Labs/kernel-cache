From e5e7d9d3c91ead0079ac8de88d3495a82dd259f3 Mon Sep 17 00:00:00 2001
From: Mihai Serb <mihai.serb@freescale.com>
Date: Tue, 27 Mar 2012 21:40:44 +0000
Subject: [PATCH 140/518] Remove possible memory leak in dpa_ipsec_init

In case of error initializing the SA manager it is possible
to leak the memory allocated for the DPA IPsec instance control block

Signed-off-by: Mihai Serb <mihai.serb@freescale.com>
Acked-by Andrei Varvara <andrei.varvara@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c |    3 +--
 1 files changed, 1 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index 0095144..8fb20aa 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -2551,6 +2551,7 @@ int dpa_ipsec_init(const struct dpa_ipsec_params *params, int *dpa_ipsec_id)
 		xx_pr_err("Could not allocate memory for control block.\n");
 		return -ENOMEM;
 	}
+	gbl_dpa_ipsec = dpa_ipsec;
 
 	/* store parameters */
 	store_ipsec_params(dpa_ipsec, params);
@@ -2574,8 +2575,6 @@ int dpa_ipsec_init(const struct dpa_ipsec_params *params, int *dpa_ipsec_id)
 	       max_num_sa * sizeof(uint32_t));
 	dpa_ipsec->num_used_sas = 0;
 
-	gbl_dpa_ipsec = dpa_ipsec;
-
 	return 0;
 }
 EXPORT_SYMBOL(dpa_ipsec_init);
-- 
1.7.5.4

