From c5de3255671ccede466afcec6d2999b1af34a6ac Mon Sep 17 00:00:00 2001
From: Anca Jeanina FLOAREA <anca.floarea@freescale.com>
Date: Fri, 14 Jun 2013 15:52:04 +0300
Subject: [PATCH 008/130] dpa_offload: Fix memory leak when plcr allocation
 failed

In function store_policy_param_to_sa_pol_list in case memory
allocation of plcr failed, then the memory occupied by
pol_entry needs to be released.

Signed-off-by: Anca Jeanina FLOAREA <anca.floarea@freescale.com>
Change-Id: I88fd3ba1403b6af4d41d06ebd179219db9b84420
Reviewed-on: http://git.am.freescale.net:8181/2970
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Chereji Marian-Cornel-R27762 <marian.chereji@freescale.com>
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Fetch from http://git.freescale.com/git/cgit.cgi/ppc/sdk/linux.git/,
 Tag: fsl-sdk-v1.4.5
 rebase on current context.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index 902a0fa..fb076f4 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -2706,6 +2706,7 @@ static int store_policy_param_to_sa_pol_list(struct dpa_ipsec_sa *sa,
 		plcr = kzalloc(sizeof(*plcr), GFP_KERNEL);
 		if (!plcr) {
 			pr_err("Could not allocate memory for policer\n");
+			kfree(pol_entry);
 			return -ENOMEM;
 		}
 		memcpy(plcr, dir->in_action.enq_params.policer_params,
-- 
1.7.5.4

