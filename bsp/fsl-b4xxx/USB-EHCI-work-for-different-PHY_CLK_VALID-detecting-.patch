From eab36d9f009f116cacf185abb6d29530cf602458 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Wed, 24 Apr 2013 12:51:18 +0800
Subject: [PATCH] USB/EHCI: work for different PHY_CLK_VALID detecting order

Due to different controller issue of PHY_CLK_VALID in ULPI mode,
in some cases, after set PHY_CLK_SEL, we should set
USB_CTRL_USB_EN before checking PHY_CLK_VALID, otherwise
PHY_CLK_VALID doesn't work.

But in other cases USB_CTRL_USB_EN is already set previously and
PHY_CLK_VALID is not valid once USB_CTRL_USB_EN is set. But
since PHY_CLK_VALID is w1c, we can force clear USB_CTRL_USB_EN
firstly after set PHY_CLK_SEL, then PHY_CLK_VALID status can
be kept even we re-set USB_CTRL_USB_EN.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/usb/host/ehci-fsl.c |   15 ++++++++++++---
 1 files changed, 12 insertions(+), 3 deletions(-)

diff --git a/drivers/usb/host/ehci-fsl.c b/drivers/usb/host/ehci-fsl.c
index c85c0c7..74cf0a5 100644
--- a/drivers/usb/host/ehci-fsl.c
+++ b/drivers/usb/host/ehci-fsl.c
@@ -235,11 +235,20 @@ static int ehci_fsl_setup_phy(struct usb_hcd *hcd,
 			/* controller version 1.6 or above */
 			setbits32(non_ehci + FSL_SOC_USB_CTRL,
 					ULPI_PHY_CLK_SEL);
+
 			/*
-			 * Due to controller issue of PHY_CLK_VALID in ULPI
-			 * mode, we set USB_CTRL_USB_EN before checking
-			 * PHY_CLK_VALID, otherwise PHY_CLK_VALID doesn't work.
+			 * Due to different controller issue of PHY_CLK_VALID
+			 * in ULPI mode, in some cases we should set
+			 * USB_CTRL_USB_EN before checking PHY_CLK_VALID,
+			 * otherwise PHY_CLK_VALID doesn't work.
+			 *
+			 * But in other cases USB_CTRL_USB_EN is already set
+			 * and PHY_CLK_VALID is not valid once USB_CTRL_USB_EN
+			 * is set. But since PHY_CLK_VALID is w1c, we can force
+			 * clear USB_CTRL_USB_EN firstly then PHY_CLK_VALID
+			 * status can be kept even we re-set USB_CTRL_USB_EN.
 			 */
+			clrbits32(non_ehci + FSL_SOC_USB_CTRL, USB_CTRL_USB_EN);
 			clrsetbits_be32(non_ehci + FSL_SOC_USB_CTRL,
 					UTMI_PHY_EN, USB_CTRL_USB_EN);
 		}
-- 
1.7.5.4

