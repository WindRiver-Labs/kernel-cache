From ff8fe17a16ad4346b3ce2e37ba35ac0712d84238 Mon Sep 17 00:00:00 2001
From: Marian Chereji <marian.chereji@freescale.com>
Date: Tue, 7 Aug 2012 19:51:59 +0000
Subject: [PATCH 269/518] dpa_classifier: Bug fix. Update header manipulation
 op release order

The FMan driver requires that header manipulation nodes are
removed in the reverse order they were created in. Hence, if they
are created from tail to head (of the HM chain), when removing
we need to go from head to tail. The dpa_classifier was removing
the header manip nodes the wrong way (i.e. from tail to head).

Signed-off-by: Marian Chereji <marian.chereji@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_classifier.c   |   22 ++++++++++++-------
 .../staging/fsl_dpa_offload/dpa_classifier_ioctl.h |   16 ++++++++------
 .../staging/fsl_dpa_offload/wrp_dpa_classifier.c   |    3 ++
 3 files changed, 26 insertions(+), 15 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_classifier.c b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
index ffb6019..0d5f365 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_classifier.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
@@ -2689,6 +2689,14 @@ int remove_hm_chain(struct list_head *chain_head, struct list_head *current)
 	int err = 0;
 	struct dpa_cls_hm_node *pcurrent;
 
+	/* Remove the current node: */
+	pcurrent = list_entry(current, struct dpa_cls_hm_node, list_node);
+
+	if (FM_PCD_ManipNodeDelete((t_Handle) pcurrent->node) != E_OK) {
+		pr_warn("WARNING: Failed to remove low level HM.\n");
+		pr_warn("WARNING: FMan driver call failed.\n");
+	}
+
 	if (current->next != chain_head) {
 		/* Remove the rest of the HM chain */
 		err = remove_hm_chain(chain_head, current->next);
@@ -2696,12 +2704,6 @@ int remove_hm_chain(struct list_head *chain_head, struct list_head *current)
 			return err;
 	}
 
-	/* Remove the current node: */
-	pcurrent = list_entry(current, struct dpa_cls_hm_node, list_node);
-
-	if (FM_PCD_ManipNodeDelete((t_Handle) pcurrent->node) != E_OK)
-		return -EBUSY;
-
 	list_del(current);
 
 	kfree(current);
@@ -2728,7 +2730,7 @@ static struct dpa_cls_hm_node
 		break;
 	default:
 		pr_err("ERROR: %s, %s (%d): Don't know how to search for nodes"
-			"compatible with type=%d.\n", __FILE__, __func__,
+			" compatible with type=%d.\n", __FILE__, __func__,
 			__LINE__, type);
 		return NULL;
 	}
@@ -3441,6 +3443,7 @@ static int init_insert_hm(struct dpa_cls_hm *pinsert_hm)
 		break;
 	default:
 		/* Will never get here */
+		kfree(hm_node);
 		return -EINVAL;
 	}
 
@@ -4277,6 +4280,9 @@ int dpa_classif_free_hm(int hmd)
 {
 	struct dpa_cls_hm *phm;
 
+	xx_sanity_check_return_value(((hmd >= 0) &&
+		(hmd < hm_array.num_descriptors)), "hmd", -EINVAL);
+
 	phm = (struct dpa_cls_hm *) hm_array.object[hmd];
 
 	if (!phm)
@@ -4293,7 +4299,7 @@ int dpa_classif_free_hm(int hmd)
 		 */
 		if (remove_hm_chain(phm->hm_chain, phm->hm_chain)
 			< 0)
-			pr_err("WARNING: Failed to remove HM nodes for chain "
+			pr_warn("WARNING: Failed to remove HM nodes for chain "
 				"hmd=%d.\n", hmd);
 	}
 
diff --git a/drivers/staging/fsl_dpa_offload/dpa_classifier_ioctl.h b/drivers/staging/fsl_dpa_offload/dpa_classifier_ioctl.h
index 8bb2630..0aaf464 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_classifier_ioctl.h
+++ b/drivers/staging/fsl_dpa_offload/dpa_classifier_ioctl.h
@@ -422,11 +422,11 @@ int dpa_lookup_key_params_compatcpy(
 	_IOWR(DPA_CLS_IOC_MAGIC, 15, struct ioc_dpa_cls_tbl_params)
 
 #ifdef CONFIG_COMPAT
-#define DPA_CLS_IOC_COMPAT_TBL_GET_PARAMS			\
+#define DPA_CLS_IOC_COMPAT_TBL_GET_PARAMS		\
 	_IOWR(DPA_CLS_IOC_MAGIC, 15, struct dpa_cls_compat_tbl_params)
 #endif /* CONFIG_COMPAT */
 
-#define DPA_CLS_IOC_SET_REMOVE_HM				\
+#define DPA_CLS_IOC_SET_REMOVE_HM			\
 	_IOWR(DPA_CLS_IOC_MAGIC, 16, struct ioc_dpa_cls_hm_remove_params)
 
 #ifdef CONFIG_COMPAT
@@ -435,7 +435,7 @@ int dpa_lookup_key_params_compatcpy(
 		struct compat_ioc_dpa_cls_hm_ingress_rm_params)
 #endif /* CONFIG_COMPAT */
 
-#define DPA_CLS_IOC_SET_INSERT_HM				\
+#define DPA_CLS_IOC_SET_INSERT_HM			\
 	_IOWR(DPA_CLS_IOC_MAGIC, 17, struct ioc_dpa_cls_hm_insert_params)
 
 #ifdef CONFIG_COMPAT
@@ -448,7 +448,7 @@ int dpa_lookup_key_params_compatcpy(
 	_IOWR(DPA_CLS_IOC_MAGIC, 18, struct ioc_dpa_cls_hm_vlan_params)
 
 #ifdef CONFIG_COMPAT
-#define DPA_CLS_IOC_COMPAT_SET_VLAN_HM		\
+#define DPA_CLS_IOC_COMPAT_SET_VLAN_HM			\
 	_IOWR(DPA_CLS_IOC_MAGIC, 18, struct compat_ioc_dpa_cls_hm_vlan_params)
 #endif /* CONFIG_COMPAT */
 
@@ -456,11 +456,11 @@ int dpa_lookup_key_params_compatcpy(
 	_IOWR(DPA_CLS_IOC_MAGIC, 19, struct ioc_dpa_cls_hm_nat_params)
 
 #ifdef CONFIG_COMPAT
-#define DPA_CLS_IOC_COMPAT_SET_NAT_HM		\
+#define DPA_CLS_IOC_COMPAT_SET_NAT_HM			\
 	_IOWR(DPA_CLS_IOC_MAGIC, 19, struct compat_ioc_dpa_cls_hm_nat_params)
 #endif /* CONFIG_COMPAT */
 
-#define DPA_CLS_IOC_SET_UPDATE_HM				\
+#define DPA_CLS_IOC_SET_UPDATE_HM			\
 	_IOWR(DPA_CLS_IOC_MAGIC, 20, struct ioc_dpa_cls_hm_update_params)
 
 #ifdef CONFIG_COMPAT
@@ -472,9 +472,11 @@ int dpa_lookup_key_params_compatcpy(
 	_IOWR(DPA_CLS_IOC_MAGIC, 21, struct ioc_dpa_cls_hm_fwd_params)
 
 #ifdef CONFIG_COMPAT
-#define DPA_CLS_IOC_COMPAT_SET_FWD_HM		\
+#define DPA_CLS_IOC_COMPAT_SET_FWD_HM			\
 	_IOWR(DPA_CLS_IOC_MAGIC, 21, struct compat_ioc_dpa_cls_hm_fwd_params)
 #endif /* CONFIG_COMPAT */
 
+#define DPA_CLS_IOC_FREE_HM				\
+	_IOR(DPA_CLS_IOC_MAGIC, 22, int)
 
 #endif /* __DPA_CLASSIFIER_IOCTL_H */
diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_classifier.c b/drivers/staging/fsl_dpa_offload/wrp_dpa_classifier.c
index d967887..a2ff12b 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_classifier.c
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_classifier.c
@@ -496,6 +496,9 @@ long wrp_dpa_classif_do_ioctl(
 	case DPA_CLS_IOC_SET_FWD_HM:
 		ret = do_ioctl_set_fwd_hm(args, compat_mode);
 		break;
+	case DPA_CLS_IOC_FREE_HM:
+		ret = dpa_classif_free_hm((int)args);
+		break;
 
 	default:
 		pr_err("ERROR: %s, %s (%d): DPA Classifier ioctl command "
-- 
1.7.5.4

