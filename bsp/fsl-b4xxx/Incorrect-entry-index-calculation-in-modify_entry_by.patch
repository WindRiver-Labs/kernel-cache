From d1c8e2de4baf3887fa5853a970295f1caa9cf753 Mon Sep 17 00:00:00 2001
From: Marian Chereji <marian.chereji@freescale.com>
Date: Sat, 11 Feb 2012 00:57:06 +0000
Subject: [PATCH 090/518] Incorrect entry index calculation in
 modify_entry_by_ref

Fixed an incorrect Cc node index calculation in the modify_entry_by_ref
function. Must be different between indexed tables and all the other
types of tables. The effect of this problem was a Linux kernel crash.

Signed-off-by: Jeanina Floarea <anca.floarea@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_classifier.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_classifier.c b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
index 536eeba..8e1ab3c 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_classifier.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_classifier.c
@@ -499,9 +499,12 @@ int dpa_classif_table_modify_entry_by_ref(int			td,
 	if (ptable->params.type == DPA_CLS_TBL_INDEXED) {
 		cc_node_index	= 0;
 		entry_index	= (uint8_t)entry_id;
+		index		= entry_index;
 	} else {
 		cc_node_index	= ENTRY_ID_GET_NODE(entry_id);
 		entry_index	= (uint8_t)ENTRY_ID_GET_INDEX(entry_id);
+		index		= ptable->int_cc_node[cc_node_index].
+					entry[entry_index].entry_index;
 	}
 
 	xx_sanity_check_return_value((cc_node_index <
@@ -515,8 +518,6 @@ int dpa_classif_table_modify_entry_by_ref(int			td,
 
 	fm_pcd	= (t_Handle)ptable->params.fm_pcd;
 	cc_node	= (t_Handle)ptable->int_cc_node[cc_node_index].cc_node;
-	index	= ptable->int_cc_node[cc_node_index].entry[entry_index].
-								entry_index;
 	switch (mod_params->type) {
 	case DPA_CLS_TBL_MODIFY_ACTION:
 		errno = action_to_next_engine_params(mod_params->action,
-- 
1.7.5.4

