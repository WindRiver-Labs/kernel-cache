From 2cfd849001cf9cb488d4a7590f51af7592c63098 Mon Sep 17 00:00:00 2001
From: Roy Pledge <roy.pledge@freescale.com>
Date: Wed, 6 Mar 2013 15:15:12 +0200
Subject: [PATCH 495/518] Add an API to query the usage levels of DMA memory

[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_qbman/fsl_usdpaa.c |   15 +++++++++++++++
 include/linux/fsl_usdpaa.h             |    8 ++++++++
 2 files changed, 23 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_qbman/fsl_usdpaa.c b/drivers/staging/fsl_qbman/fsl_usdpaa.c
index c1a4166..c4cbcc7 100644
--- a/drivers/staging/fsl_qbman/fsl_usdpaa.c
+++ b/drivers/staging/fsl_qbman/fsl_usdpaa.c
@@ -936,6 +936,19 @@ map_match:
 	return ret;
 }
 
+static long ioctl_dma_stats(struct ctx *ctx, void __user *arg) {
+	struct mem_fragment *frag;
+	struct usdpaa_ioctl_dma_used result;
+
+	result.free_bytes = 0;
+	result.total_bytes = phys_size;
+
+	list_for_each_entry(frag, &mem_list, list) {
+		result.free_bytes += frag->len;
+	}
+
+	return copy_to_user(arg, &result, sizeof(result)); }
+
 static int test_lock(struct mem_mapping *map)
 {
 	int ret = 0;
@@ -1169,6 +1182,8 @@ static long usdpaa_ioctl(struct file *fp, unsigned int cmd, unsigned long arg)
 		return ioctl_portal_map(fp, ctx, a);
 	case USDPAA_IOCTL_PORTAL_UNMAP:
 		return ioctl_portal_unmap(ctx, a);
+	case USDPAA_IOCTL_DMA_USED:
+		return ioctl_dma_stats(ctx, a);
 	}
 	return -EINVAL;
 }
diff --git a/include/linux/fsl_usdpaa.h b/include/linux/fsl_usdpaa.h
index 5bf9e3a..6b3c0d4 100644
--- a/include/linux/fsl_usdpaa.h
+++ b/include/linux/fsl_usdpaa.h
@@ -158,6 +158,14 @@ struct usdpaa_ioctl_portal_map {
 #define USDPAA_IOCTL_PORTAL_IRQ_MAP \
 	_IOW(USDPAA_IOCTL_MAGIC, 0x09, int)
 
+/* ioctl to query the amount of DMA memory used in the system */
+struct usdpaa_ioctl_dma_used {
+	uint64_t free_bytes;
+	uint64_t total_bytes;
+};
+#define USDPAA_IOCTL_DMA_USED \
+	_IOR(USDPAA_IOCTL_MAGIC, 0x0B, struct usdpaa_ioctl_dma_used)
+
 
 #ifdef __KERNEL__
 
-- 
1.7.5.4

