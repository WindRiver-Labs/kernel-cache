From e8a4bfd55bddec76cdc972acb93cafb29aa0dc67 Mon Sep 17 00:00:00 2001
From: Bulie Radu-Andrei-B37577 <radu.bulie@freescale.com>
Date: Tue, 13 Nov 2012 13:25:14 +0000
Subject: [PATCH 412/518] dpa_ipsec: Free header manip descriptor after the
 node removal

This patch is a fix for ipsec API regarding the problem that
appears when removing the special operations manipulation node
after the special operation descriptor removal from classifier API.

Signed-off-by: Bulie Radu-Andrei-B37577 <radu.bulie@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c |   14 +++++++-------
 1 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index 802460d..87c4c4b 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -1485,13 +1485,6 @@ static int destroy_recycle_manip(struct dpa_ipsec_sa *sa,
 	hm = dpa_classif_get_static_hm_handle(hmd);
 	BUG_ON(!hm);
 
-	/* Removed from classifier but not from memory. HM is still usable */
-	err = dpa_classif_free_hm(hmd);
-	if (err < 0) {
-		pr_err("%s: Failed to remove header manip!\n", __func__);
-		return err;
-	}
-
 	/* Destroy the DPA IPSec Special header manip or put it in the pool */
 	if (sa->dpa_ipsec->config.max_sa_manip_ops > 0) {
 		/* return to pool */
@@ -1512,6 +1505,13 @@ static int destroy_recycle_manip(struct dpa_ipsec_sa *sa,
 		}
 	}
 
+	/* Removed from classifier but not from memory. HM is still usable */
+	err = dpa_classif_free_hm(hmd);
+	if (err < 0) {
+		pr_err("%s: Failed to remove header manip!\n", __func__);
+		return err;
+	}
+
 	return 0;
 }
 
-- 
1.7.5.4

