From df77be02b6d4afcbb6239a2866c87fbd0b4fd189 Mon Sep 17 00:00:00 2001
From: Mihai Serb <mihai.serb@freescale.com>
Date: Fri, 23 Mar 2012 22:12:35 +0000
Subject: [PATCH 133/518] Fix possible bug in releasing the inbound flowID

If the SA creation code fails the rollback code will try to release
a flowID value back in the pool, although it never acquired one.

Signed-off-by: Mihai Serb <mihai.serb@freescale.com>
Checkpatch status: pass
Check legal status: pass
Internal review status: acked-by Andrei Varvara <andrei.varvara@freescale.com>
Must be applied: no
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c |    4 +++-
 drivers/staging/fsl_dpa_offload/dpa_ipsec.h |    2 ++
 2 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index 17d6c21..7aa6eb5 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -1956,6 +1956,7 @@ static int copy_sa_params_to_in_sa(struct dpa_ipsec_sa *sa,
 		err = get_inbound_flowid(dpa_ipsec, &sa->inbound_flowid);
 		if (err < 0) {
 			xx_pr_err("Can't get valid inbound flow id\n");
+			sa->inbound_flowid = INVALID_INB_FLOW_ID;
 			return -EINVAL;
 		}
 	}
@@ -2509,7 +2510,8 @@ static int rollback_create_sa(struct dpa_ipsec_sa *sa, uint32_t id)
 	}
 
 	/* Free the SA id and FlowID (for inbound SAs only).*/
-	if (sa->sa_dir == DPA_IPSEC_INBOUND && sa->inbound_flowid >= 0)
+	if (sa->sa_dir == DPA_IPSEC_INBOUND &&
+			sa->inbound_flowid != INVALID_INB_FLOW_ID)
 		put_inbound_flowid(dpa_ipsec, sa->inbound_flowid);
 	if (sa->used_sa_index != -1) {
 		sa->dpa_ipsec->used_sa_ids[sa->used_sa_index] =
diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.h b/drivers/staging/fsl_dpa_offload/dpa_ipsec.h
index d4292d0..c98cc1a 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.h
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.h
@@ -172,6 +172,8 @@
 #define WAIT4_FQ_EMPTY_TIMEOUT	10000 /* Time in microseconds */
 #define REKEY_SCHED_DELAY	100   /* Time in microseconds */
 
+#define INVALID_INB_FLOW_ID	0xFFFF
+
 /* DPA IPSec Encryption & authentication algorithm identifiers */
 struct ipsec_alg_suite {
 	uint16_t	enc_alg;
-- 
1.7.5.4

