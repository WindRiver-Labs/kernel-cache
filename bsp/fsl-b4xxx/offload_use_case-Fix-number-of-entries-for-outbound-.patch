From ffb97388c03639cabc8c5023a47d2e865f95e432 Mon Sep 17 00:00:00 2001
From: Radu-Andrei BULIE <radu.bulie@freescale.com>
Date: Wed, 12 Sep 2012 21:26:00 +0000
Subject: [PATCH 321/518] offload_use_case: Fix number of entries for outbound
 exact match tables

Number of entries in the outbound exact match ipsec tables must be equal
with the maximum number of policies.

Signed-off-by: Radu-Andrei BULIE <radu.bulie@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 .../staging/fsl_dpa_offload/usecases/ipsec_init.c  |   19 +++++++++++++++++--
 1 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/usecases/ipsec_init.c b/drivers/staging/fsl_dpa_offload/usecases/ipsec_init.c
index de80d9e..fb0f93c 100644
--- a/drivers/staging/fsl_dpa_offload/usecases/ipsec_init.c
+++ b/drivers/staging/fsl_dpa_offload/usecases/ipsec_init.c
@@ -46,6 +46,21 @@
 #define CCNODE_MAX_NUM_OF_WAYS  8
 #define IPSEC_START_IN_FLOW_ID  0
 #define CCNODE_OUT_PRE_ENC_NUM_PROTOS 2
+
+/* These values must be set according to xml pcd file */
+#define IPSEC_OUT_POL_CC_NODE_KEYS  {					   \
+		16, /* Number of keys for DPA_IPSEC_PROTO_TCP_IPV4 CC Node */  \
+		16, /* Number of keys for DPA_IPSEC_PROTO_TCP_IPV6 CC Node */  \
+		16, /* Number of keys for DPA_IPSEC_PROTO_UDP_IPV4 CC Node */  \
+		16, /* Number of keys for DPA_IPSEC_PROTO_UDP_IPV6 CC Node */  \
+		16, /* Number of keys for DPA_IPSEC_PROTO_ICMP_IPV4 CC Node */ \
+		16, /* Number of keys for DPA_IPSEC_PROTO_ICMP_IPV6 CC Node */ \
+		16, /* Number of keys for DPA_IPSEC_PROTO_SCTP_IPV4 CC Node */ \
+		16, /* Number of keys for DPA_IPSEC_PROTO_SCTP_IPV6 CC Node */ \
+		16, /* Number of keys for DPA_IPSEC_PROTO_ANY_IPV4 CC Node */  \
+		16  /* Number of keys for DPA_IPSEC_PROTO_ANY_IPV6 CC Node */  \
+};
+
 #define IPSEC_PRE_DEC_TBL_KEY_SIZE \
 	{ \
 		/* IPV4 SA */ \
@@ -89,7 +104,7 @@
 
 static int inb_key_size[] = IPSEC_PRE_DEC_TBL_KEY_SIZE;
 static int outb_key_size[] = IPSEC_OUT_PRE_ENC_TBL_KEY_SIZE;
-
+static int out_pol_cc_node_keys[] = IPSEC_OUT_POL_CC_NODE_KEYS;
 static struct dpa_ipsec_params ipsec_params;
 static int ipsec_initialized = 0;
 
@@ -184,7 +199,7 @@ int init_ipsec_offload(int *dpa_ipsec_id, struct ipsec_uparms *params)
 			cls_tbl_params.type = DPA_CLS_TBL_EXACT_MATCH;
 			cls_tbl_params.entry_mgmt = DPA_CLS_TBL_MANAGE_BY_REF;
 			cls_tbl_params.exact_match_params.entries_cnt =
-					ipsec_params.max_sa_pairs;
+					out_pol_cc_node_keys[i];
 			cls_tbl_params.exact_match_params.key_size =
 					outb_key_size[i];
 			ret = dpa_classif_table_create(&cls_tbl_params,
-- 
1.7.5.4

