From 588c124c0a95b6459e0019dd2653089293c3ad88 Mon Sep 17 00:00:00 2001
From: andrei varvara <andrei.varvara@freescale.com>
Date: Fri, 18 May 2012 20:51:25 +0000
Subject: [PATCH 168/518] Add rollback for dpa_ipsec_sa_rekeying

created similar rollback function as in dpa_ipsec_sa_create case.

Signed-off-by: Andrei Varvara <andrei.varvara@freescale.com>
Acked-by: Mihai Serb <mihai.serb@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c |   51 ++++++++++++++++++++++++---
 1 files changed, 46 insertions(+), 5 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index 5f6420d..f3ab773 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -2709,6 +2709,38 @@ static int rollback_create_sa(struct dpa_ipsec_sa *sa)
 	return err_rb;
 }
 
+static int rollback_rekeying_sa(struct dpa_ipsec_sa *sa)
+{
+	struct dpa_ipsec *dpa_ipsec;
+	struct dpa_ipsec_sa_mng *sa_mng;
+	int err_rb;
+
+	BUG_ON(!sa);
+	dpa_ipsec = sa->dpa_ipsec;
+	BUG_ON(!dpa_ipsec);
+
+	sa_mng = &dpa_ipsec->sa_mng;
+
+	if (sa->sa_dir == DPA_IPSEC_INBOUND && sa->inbound_hash_entry != -1) {
+		err_rb = update_pre_sec_inbound_table(sa, MNG_OP_REMOVE);
+		if (err_rb < 0) {
+			xx_pr_err("Couln't remove SA lookup table entry\n");
+			return err_rb;
+		}
+	}
+	sa->inbound_hash_entry = -1;
+
+	err_rb = remove_sa_fq_pair(sa);
+	if (err_rb < 0) {
+		xx_pr_err("Could not remove SA FQs.\n");
+		return err_rb;
+	}
+
+	err_rb = put_sa(sa);
+
+	return err_rb;
+}
+
 int dpa_ipsec_init(const struct dpa_ipsec_params *params, int *dpa_ipsec_id)
 {
 	struct dpa_ipsec *dpa_ipsec = NULL;
@@ -3180,7 +3212,7 @@ int dpa_ipsec_sa_rekeying(int sa_id,
 	struct timeval timeval;
 	unsigned long jiffies_to_wait;
 	uint32_t id;
-	int err = 0;
+	int err = 0, err_rb;
 
 	if (!gbl_dpa_ipsec) {
 		xx_pr_err("There is no dpa_ipsec instance initialized\n");
@@ -3340,11 +3372,20 @@ int dpa_ipsec_sa_rekeying(int sa_id,
 
 	return 0;
 
-/* Rekeying failed before updating/adding any table entry.
- * It is safe to remove new SA */
+/*
+ * Rekeying failed before updating/adding any table entry.
+ * It is safe to remove new SA
+ */
 rekey_sa_err:
-	remove_sa_fq_pair(new_sa);
-	put_sa(new_sa);
+	/*
+	 * If rollback was successful return an invalid ID for new SA,
+	 * otherwise return the acquired SA id so that upper layer could use it
+	 * in subsequent attempts of removing it by calling dpa_ipsec_remove_sa
+	 */
+
+	err_rb = rollback_rekeying_sa(new_sa);
+	if (err_rb < 0)
+		*new_sa_id = new_sa->id;
 
 	return err;
 }
-- 
1.7.5.4

