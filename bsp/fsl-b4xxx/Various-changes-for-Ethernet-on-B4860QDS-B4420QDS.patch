From 2fcb49e71dc0b8464d15415dc3f9dd6cd96f6d6b Mon Sep 17 00:00:00 2001
From: Suresh Gupta <suresh.gupta@freescale.com>
Date: Tue, 12 Feb 2013 14:53:11 +0000
Subject: [PATCH 01/36] Various changes for Ethernet on B4860QDS/B4420QDS

- Streamlined Ethernet interface numbering to fm_port in u-boot to
  direct mapping of Ethernet interface with port numbers.
- Add MDIO node for SGMII interface.
- Replace the fixed-link to proper phy-handle
- It is supposed that the u-boot device tree fixup code will update the phy-handle
  property of the Ethernet node to point to the right PHY as per Serdes protocol.

signed-off-by: Suresh Gupta <suresh.gupta@freescale.com>
Signed-off-by: Andy Fleming <afleming@freescale.com>
[Grabbed from the branch, LINUX_IR5.3.0_ALPHA, of
https://git.freescale.com/git-private/cgit.cgi/ppc/dpaa-offload/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/boot/dts/b4420qds.dts |   52 ++++++++++++++++++++++----------
 arch/powerpc/boot/dts/b4860qds.dts |   59 +++++++++++++++++++++++++++--------
 2 files changed, 81 insertions(+), 30 deletions(-)

diff --git a/arch/powerpc/boot/dts/b4420qds.dts b/arch/powerpc/boot/dts/b4420qds.dts
index 9407498..7208e62 100644
--- a/arch/powerpc/boot/dts/b4420qds.dts
+++ b/arch/powerpc/boot/dts/b4420qds.dts
@@ -42,10 +42,15 @@
 	interrupt-parent = <&mpic>;
 
 	aliases{
-		ethernet0 = &enet0;
-		ethernet1 = &enet1;
-		ethernet2 = &enet2;
-		ethernet3 = &enet3;
+		ethernet0 = &fm1mac1;
+		ethernet1 = &fm1mac2;
+		ethernet2 = &fm1mac3;
+		ethernet3 = &fm1mac4;
+
+		phy_sgmii_10 = &phy_sgmii_10;
+		phy_sgmii_11 = &phy_sgmii_11;
+		phy_sgmii_1c = &phy_sgmii_1c;
+		phy_sgmii_1d = &phy_sgmii_1d;
 	};
 
 	ifc: localbus@ffe124000 {
@@ -213,22 +218,37 @@
 		};
 
 		fman0: fman@400000 {
-			enet0: ethernet@e0000 {
-				fixed-link = <1 1 1000 0 0 >;
+			fm1mac1: ethernet@e0000 {
+				phy-handle = <&phy_sgmii_10>;
 				phy-connection-type = "sgmii";
 			};
-			enet1: ethernet@e2000 {
-				fixed-link = <2 1 1000 0 0 >;
+			fm1mac2: ethernet@e2000 {
+				phy-handle = <&phy_sgmii_11>;
 				phy-connection-type = "sgmii";
 			};
-			enet2: ethernet@e4000 {
-				fixed-link = <3 1 1000 0 0 >;
+			fm1mac3: ethernet@e4000 {
+				phy-handle = <&phy_sgmii_1c>;
 				phy-connection-type = "sgmii";
 			};
-			enet3: ethernet@e6000 {
-				fixed-link = <4 1 1000 0 0 >;
+			fm1mac4: ethernet@e6000 {
+				phy-handle = <&phy_sgmii_1d>;
 				phy-connection-type = "sgmii";
 			};
+
+			mdio0: mdio@fc000 {
+				phy_sgmii_10: ethernet-phy@10 {
+					reg = <0x10>;
+				};
+				phy_sgmii_11: ethernet-phy@11 {
+					reg = <0x11>;
+				};
+				phy_sgmii_1c: ethernet-phy@1c {
+					reg = <0x1c>;
+				};
+				phy_sgmii_1d: ethernet-phy@1d {
+					reg = <0x1d>;
+				};
+			};
 		};
 	};
 
@@ -251,19 +271,19 @@
 		compatible = "fsl,b4420-dpaa", "fsl,dpaa";
 		ethernet@0 {
 			compatible = "fsl,b4420-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet0>;
+			fsl,fman-mac = <&fm1mac1>;
 		};
 		ethernet@1 {
 			compatible = "fsl,b4420-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet1>;
+			fsl,fman-mac = <&fm1mac2>;
 		};
 		ethernet@2 {
 			compatible = "fsl,b4420-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet2>;
+			fsl,fman-mac = <&fm1mac3>;
 		};
 		ethernet@3 {
 			compatible = "fsl,b4420-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet3>;
+			fsl,fman-mac = <&fm1mac4>;
 		};
 	};
 };
diff --git a/arch/powerpc/boot/dts/b4860qds.dts b/arch/powerpc/boot/dts/b4860qds.dts
index 1cb592a..1e1685a 100644
--- a/arch/powerpc/boot/dts/b4860qds.dts
+++ b/arch/powerpc/boot/dts/b4860qds.dts
@@ -48,8 +48,18 @@
 		ethernet3 = &fm1mac4;
 		ethernet4 = &fm1mac5;
 		ethernet5 = &fm1mac6;
-		ethernet6 = &fm1mac9;
-		ethernet7 = &fm1mac10;
+		ethernet8 = &fm1mac9;
+		ethernet9 = &fm1mac10;
+
+		phy_sgmii_10 = &phy_sgmii_10;
+		phy_sgmii_11 = &phy_sgmii_11;
+		phy_sgmii_1c = &phy_sgmii_1c;
+		phy_sgmii_1d = &phy_sgmii_1d;
+		phy_sgmii_1e = &phy_sgmii_1e;
+		phy_sgmii_1f = &phy_sgmii_1f;
+
+		phy_xaui_slot1 = &phy_xaui_slot1;
+		phy_xaui_slot2 = &phy_xaui_slot2;
 	};
 
 	ifc: localbus@ffe124000 {
@@ -216,45 +226,66 @@
 
 		fman0: fman@400000 {
 			fm1mac1: ethernet@e0000 {
-				fixed-link = <1 1 1000 0 0 >;
+				phy-handle = <&phy_sgmii_10>;
 				phy-connection-type = "sgmii";
 			};
 			fm1mac2: ethernet@e2000 {
-				fixed-link = <2 1 1000 0 0 >;
+				phy-handle = <&phy_sgmii_11>;
 				phy-connection-type = "sgmii";
 			};
 			fm1mac3: ethernet@e4000 {
-				fixed-link = <3 1 1000 0 0 >;
+				phy-handle = <&phy_sgmii_1c>;
 				phy-connection-type = "sgmii";
 			};
 			fm1mac4: ethernet@e6000 {
-				fixed-link = <4 1 1000 0 0 >;
+				phy-handle = <&phy_sgmii_1d>;
 				phy-connection-type = "sgmii";
 			};
 			fm1mac5: ethernet@e8000 {
-				fixed-link = <5 1 1000 0 0 >;
+				phy-handle = <&phy_sgmii_1e>;
 				phy-connection-type = "sgmii";
 			};
 			fm1mac6: ethernet@ea000 {
-				fixed-link = <6 1 1000 0 0 >;
+				phy-handle = <&phy_sgmii_1f>;
 				phy-connection-type = "sgmii";
 			};
 			fm1mac9: ethernet@f0000 { /* FM1@TGEC2 */
-				phy-handle = <&b4860xmdio1>;
+				phy-handle = <&phy_xaui_slot1>;
 				phy-connection-type = "xgmii";
 			};
 			fm1mac10: ethernet@f2000 { /* FM1@TGEC1 */
-				phy-handle = <&b4860xmdio2>;
+				phy-handle = <&phy_xaui_slot2>;
 				phy-connection-type = "xgmii";
 			};
 
+			mdio0: mdio@fc000 {
+				phy_sgmii_10: ethernet-phy@10 {
+					reg = <0x10>;
+				};
+				phy_sgmii_11: ethernet-phy@11 {
+					reg = <0x11>;
+				};
+				phy_sgmii_1c: ethernet-phy@1c {
+					reg = <0x1c>;
+				};
+				phy_sgmii_1d: ethernet-phy@1d {
+					reg = <0x1d>;
+				};
+				phy_sgmii_1e: ethernet-phy@1e {
+					reg = <0x1e>;
+				};
+				phy_sgmii_1f: ethernet-phy@1f {
+					reg = <0x1f>;
+				};
+			};
+
 			xmdio0: mdio@fd000 {
 				/* For 10g interfaces */
-				b4860xmdio1: xaui-phy@slot1 {
+				phy_xaui_slot1: xaui-phy@slot1 {
 					compatible = "ethernet-phy-ieee802.3-c45";
 					reg = <0x7>; /* default switch setting on slot1 of AMC2PEX */
 				};
-				b4860xmdio2: xaui-phy@slot2 {
+				phy_xaui_slot2: xaui-phy@slot2 {
 					compatible = "ethernet-phy-ieee802.3-c45";
 					reg = <0x6>; /* default switch setting on slot1 of AMC2PEX */
 				};
@@ -314,11 +345,11 @@
 			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&fm1mac6>;
 		};
-		ethernet@6 {
+		ethernet@8 {
 			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&fm1mac9>;
 		};
-		ethernet@7 {
+		ethernet@9 {
 			compatible = "fsl,b4860-dpa-ethernet", "fsl,dpa-ethernet";
 			fsl,fman-mac = <&fm1mac10>;
 		};
-- 
1.7.5.4

