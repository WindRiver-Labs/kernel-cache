From 7777722588e94cfaddaab028597e522529e1aa8a Mon Sep 17 00:00:00 2001
From: Andrei Varvara <andrei.varvara@freescale.com>
Date: Thu, 3 Oct 2013 17:10:14 +0300
Subject: [PATCH 119/130] dpa_offload: Bug fix - inbound rekeying fails in
 case of manual old SA removing

The old inbound SA failed to be removed by dpa_ipsec_remove_sa in case
of rekeying with dpa_ipsec_sa_rekeying when the user selected manual SA remove
("auto_rmv_old_sa = FALSE" )

Signed-off-by: Andrei Varvara <andrei.varvara@freescale.com>
Change-Id: If13dff65467bfaa415a5269de68161bf4bcbfec7
Reviewed-on: http://git.am.freescale.net:8181/5173
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Marian-Cornel Chereji <marian.chereji@freescale.com>
Reviewed-by: Floarea Anca Jeanina-B12569 <anca.floarea@freescale.com>
Reviewed-by: Rivera Jose-B46482 <German.Rivera@freescale.com>
[Fetch from http://git.freescale.com/git/cgit.cgi/ppc/sdk/linux.git/,
 Tag: fsl-sdk-v1.4.5
 rebase on current context.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c |   23 +++++++++--------------
 1 files changed, 9 insertions(+), 14 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index e926cf24..99ebcd9 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -3576,7 +3576,9 @@ static int remove_inbound_sa(struct dpa_ipsec_sa *sa)
 		sa->child_sa = NULL;
 
 		/* Remove the child SA from rekeying list */
-		list_del(&child_sa->sa_rekeying_node);
+		if (child_sa->sa_rekeying_node.next != LIST_POISON1 &&
+		    child_sa->sa_rekeying_node.prev != LIST_POISON2)
+			list_del(&child_sa->sa_rekeying_node);
 
 		/* Invalidate the FROM SEC FQ of parent SA */
 		memset(sa->from_sec_fq, 0, sizeof(struct qman_fq));
@@ -4097,19 +4099,12 @@ int dpa_ipsec_sa_rekeying(int sa_id,
 	new_sa->ipsec_hmd = old_sa->ipsec_hmd;
 	new_sa->valid_flowid_entry = false;
 	new_sa->rekey_event_cb = rekey_event_cb;
-	if (auto_rmv_old_sa) {
-		new_sa->parent_sa = old_sa;
-		new_sa->child_sa  = NULL;
-			new_sa->sa_rekeying_node.next = LIST_POISON1;
-			new_sa->sa_rekeying_node.prev = LIST_POISON2;
-		old_sa->child_sa = new_sa;
-			old_sa->parent_sa = NULL;
-	} else {
-		new_sa->parent_sa = NULL;
-		new_sa->child_sa  = NULL;
-		old_sa->child_sa  = NULL;
-		old_sa->parent_sa = NULL;
-	}
+	new_sa->parent_sa = old_sa;
+	new_sa->child_sa  = NULL;
+	new_sa->sa_rekeying_node.next = LIST_POISON1;
+	new_sa->sa_rekeying_node.prev = LIST_POISON2;
+	old_sa->child_sa = new_sa;
+	old_sa->parent_sa = NULL;
 
 	/* Copy SA params into the internal SA structure */
 	if (sa_is_outbound(old_sa))
-- 
1.7.5.4

