From d55c8926477c69410a295d2263de243c6e68c1e1 Mon Sep 17 00:00:00 2001
From: Mandy Lavi <mandy.lavi@freescale.com>
Date: Mon, 18 Nov 2013 14:26:56 +0200
Subject: [PATCH 122/130] fmd: fix global/local mask update when modification
 of next engine occurs

Signed-off-by: Mandy Lavi <mandy.lavi@freescale.com>
[This is a patch delivered from Freescale against fsl-sdk-v1.4.5,
 rebase on current context.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 .../freescale/fman/Peripherals/FM/Pcd/fm_cc.c      |   23 +++++++++++++++++--
 1 files changed, 20 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fman/Peripherals/FM/Pcd/fm_cc.c b/drivers/net/ethernet/freescale/fman/Peripherals/FM/Pcd/fm_cc.c
index a8a52b2..89dd85b 100644
--- a/drivers/net/ethernet/freescale/fman/Peripherals/FM/Pcd/fm_cc.c
+++ b/drivers/net/ethernet/freescale/fman/Peripherals/FM/Pcd/fm_cc.c
@@ -2225,9 +2225,26 @@ static t_Error UpdateGblMask(t_FmPcdCcNode *p_CcNode,
         (keySize <= 4) &&
         !p_CcNode->lclMask)
     {
-        memcpy(p_CcNode->p_GlblMask, p_Mask, (sizeof(uint8_t))*keySize);
-        p_CcNode->glblMaskUpdated = TRUE;
-        p_CcNode->glblMaskSize = 4;
+            if (p_CcNode->parseCode &&
+                (p_CcNode->parseCode != CC_PC_FF_TCI1) &&
+                (p_CcNode->parseCode != CC_PC_FF_TCI2) &&
+                (p_CcNode->parseCode != CC_PC_FF_MPLS1) &&
+                (p_CcNode->parseCode != CC_PC_FF_MPLS_LAST) &&
+                (p_CcNode->parseCode != CC_PC_FF_IPV4IPTOS_TC1) &&
+                (p_CcNode->parseCode != CC_PC_FF_IPV4IPTOS_TC2) &&
+                (p_CcNode->parseCode != CC_PC_FF_IPTOS_IPV6TC1_IPV6FLOW1) &&
+                (p_CcNode->parseCode != CC_PC_FF_IPDSCP) &&
+                (p_CcNode->parseCode != CC_PC_FF_IPTOS_IPV6TC2_IPV6FLOW2) )
+            {
+                p_CcNode->glblMaskSize = 0;
+                p_CcNode->lclMask = TRUE;
+            }
+            else {
+                memcpy(p_CcNode->p_GlblMask, p_Mask, (sizeof(uint8_t))*keySize);
+                p_CcNode->glblMaskUpdated = TRUE;
+                p_CcNode->glblMaskSize = 4;
+
+            }
     }
     else if (p_Mask &&
              (keySize <= 4) &&
-- 
1.7.5.4

