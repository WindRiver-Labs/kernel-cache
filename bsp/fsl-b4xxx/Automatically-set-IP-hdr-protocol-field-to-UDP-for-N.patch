From 8a10ed3b86dcdcc121a4fd8c0ef626ce6060d445 Mon Sep 17 00:00:00 2001
From: Mihai Serb <mihai.serb@freescale.com>
Date: Thu, 17 May 2012 20:36:05 +0000
Subject: [PATCH 151/518] Automatically set IP hdr protocol field to UDP for
 NAT-T SAs

If the calling application does not provide an encapsulating IP header
with the protocol field set to UDP, the resulting ESP packet will be
invalid.
The changes in this patch ensure that value 0x11 is automatically set
in the IP header protocol field if NAT-T is activated for that SA.

Signed-off-by: Mihai Serb <mihai.serb@freescale.com>
Acked-by: Andrei Varvara <andrei.varvara@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
index fcef656..3f81b97 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec.c
@@ -2011,6 +2011,11 @@ static int copy_sa_params_to_out_sa(struct dpa_ipsec_sa *sa,
 		udp_hdr = (struct udphdr *) (tmp +
 				sa_params->sa_out_params.ip_hdr_size);
 		udp_hdr->check = 0x0000;
+
+		/* make sure next header type is UDP */
+		outer_ip_hdr = (struct iphdr *)
+						&sa->sec_desc->pdb_en.ip_hdr[0];
+		outer_ip_hdr->protocol = IPPROTO_UDP;
 	} else {
 		sa->sec_desc->pdb_en.ip_hdr_len =
 				sa_params->sa_out_params.ip_hdr_size;
-- 
1.7.5.4

