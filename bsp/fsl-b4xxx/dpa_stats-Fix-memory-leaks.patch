From 583fee309f7c08993c73f9b393d534b6aea5a80e Mon Sep 17 00:00:00 2001
From: Anca-Jeanina Floarea <anca.floarea@freescale.com>
Date: Wed, 8 Aug 2012 18:18:14 +0000
Subject: [PATCH 266/518] dpa_stats: Fix memory leaks

Fixed memory leaks from driver and wrapper

Signed-off-by: Anca Jeanina FLOAREA <anca.floarea@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_stats.c     |    1 +
 drivers/staging/fsl_dpa_offload/wrp_dpa_stats.c |    4 ++++
 2 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_stats.c b/drivers/staging/fsl_dpa_offload/dpa_stats.c
index 9902a34..02df48b 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_stats.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_stats.c
@@ -686,6 +686,7 @@ static int copy_key_descriptor(const struct dpa_offload_lookup_key *src,
 	dst->mask = kmalloc(src->size, GFP_KERNEL);
 	if (!dst->mask) {
 		pr_err("No more memory for key mask\n");
+		kfree(dst->byte);
 		return -ENOMEM;
 	}
 	memcpy(dst->mask, src->mask, src->size);
diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_stats.c b/drivers/staging/fsl_dpa_offload/wrp_dpa_stats.c
index ee1970c..7f5902d 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_stats.c
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_stats.c
@@ -690,6 +690,7 @@ static int copy_key_descriptor(struct dpa_offload_lookup_key *src,
 
 	if (copy_from_user(dst->byte, src->byte, src->size)) {
 		pr_err("Could not copy key byte");
+		kfree(dst->byte);
 		return -EBUSY;
 	}
 
@@ -697,11 +698,14 @@ static int copy_key_descriptor(struct dpa_offload_lookup_key *src,
 	dst->mask = kmalloc(src->size, GFP_KERNEL);
 	if (!dst->mask) {
 		pr_err("No more memory for mask pointer\n");
+		kfree(dst->byte);
 		return -ENOMEM;
 	}
 
 	if (copy_from_user(dst->mask, src->mask, src->size)) {
 		pr_err("Could not copy key mask");
+		kfree(dst->byte);
+		kfree(dst->mask);
 		return -EBUSY;
 	}
 
-- 
1.7.5.4

