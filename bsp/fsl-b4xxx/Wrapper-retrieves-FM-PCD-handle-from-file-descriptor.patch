From 5a734b2e03c1b9984232fee3fff2aa6f4b6826fe Mon Sep 17 00:00:00 2001
From: Mihai Serb <mihai.serb@freescale.com>
Date: Thu, 22 Mar 2012 15:36:11 +0000
Subject: [PATCH 128/518] Wrapper retrieves FM PCD handle from file descriptor

FM PCD handle is not accessible in userspace. Userspace applications
calling dpa_ipsec_init should provide the FM PCD file descriptor in
the fm_pcd field and the wrapper will automatically replace it with
the correct handle.

Signed-off-by: Mihai Serb <mihai.serb@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c |   19 +++++++++++++++++++
 1 files changed, 19 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
index 4db1ad1..89bc1eb 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
@@ -42,6 +42,10 @@
 #include "dpa_ipsec_ioctl.h"
 #include "wrp_dpa_ipsec.h"
 
+/* Other includes */
+#include <linux/fdtable.h>
+#include "lnxwrp_fm.h"
+
 static const struct file_operations dpa_ipsec_fops = {
 	.owner = THIS_MODULE,
 	.open = wrp_dpa_ipsec_open,
@@ -100,12 +104,27 @@ long wrp_dpa_ipsec_ioctl(struct file *filp, unsigned int cmd,
 	switch (cmd) {
 	case DPA_IPSEC_IOC_INIT: {
 			struct ioc_dpa_ipsec_params prm;
+			struct file *fm_pcd_file;
+			t_LnxWrpFmDev *fm_wrapper_dev;
 			if (copy_from_user(&prm,
 					   (struct ioc_dpa_ipsec_params *) args,
 					    sizeof(prm))) {
 				xx_pr_err("Could not copy parameters ");
 				return -EINVAL;
 			}
+
+			/* Translate FM_PCD file descriptor */
+			fm_pcd_file = fcheck((unsigned int)
+						prm.dpa_ipsec_params.fm_pcd);
+			if (!fm_pcd_file) {
+				xx_pr_err("Could not acquire PCD handle");
+				return -EINVAL;
+			}
+			fm_wrapper_dev =
+				((t_LnxWrpFmDev *)fm_pcd_file->private_data);
+			prm.dpa_ipsec_params.fm_pcd =
+					(void *)fm_wrapper_dev->h_PcdDev;
+
 			err = dpa_ipsec_init(&prm.dpa_ipsec_params,
 					     &prm.dpa_ipsec_id);
 			if (err < 0)
-- 
1.7.5.4

