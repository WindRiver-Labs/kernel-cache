From d18cad2c2f117d62af981ae0474d290081da5725 Mon Sep 17 00:00:00 2001
From: andrei varvara <andrei.varvara@freescale.com>
Date: Fri, 16 Mar 2012 15:39:00 +0000
Subject: [PATCH 121/518] Updated DPA IPSec wrapper according to latest DPA
 IPSec features

updated wrapper according to latest features in DPA IPSec component:
    Add support for asynchronous rekeying error reporting
    Moddify default behaviour of rekeying function for inbound SAs

Signed-off-by: Andrei Varvara <andrei.varvara@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h |    1 +
 drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c   |   17 +++++++++++++----
 drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.h   |    2 ++
 3 files changed, 16 insertions(+), 4 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h b/drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h
index 0feec0d..a2e6837 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h
+++ b/drivers/staging/fsl_dpa_offload/dpa_ipsec_ioctl.h
@@ -57,6 +57,7 @@ struct ioc_dpa_ipsec_add_rem_policy {
 
 struct ioc_dpa_ipsec_sa_rekeying_prm {
 	struct dpa_ipsec_sa_params sa_params;
+	int auto_rmv_old_sa;
 	int sa_id;		/* old sa id */
 	int new_sa_id;		/* newly created sa id */
 };
diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
index 51d8fad..4db1ad1 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
@@ -197,7 +197,7 @@ long wrp_dpa_ipsec_ioctl(struct file *filp, unsigned int cmd,
 
 	case DPA_IPSEC_IOC_SA_REKEYING: {
 			struct ioc_dpa_ipsec_sa_rekeying_prm prm;
-			int unused = 0;
+
 			if (copy_from_user(&prm,
 				  (struct ioc_dpa_ipsec_sa_rekeying_prm *) args,
 				   sizeof(prm))) {
@@ -205,9 +205,10 @@ long wrp_dpa_ipsec_ioctl(struct file *filp, unsigned int cmd,
 				return -EINVAL;
 			}
 
-			err = dpa_ipsec_sa_rekeying(prm.sa_id,
-						    &prm.sa_params, NULL,
-						    unused, &prm.new_sa_id);
+			err = dpa_ipsec_sa_rekeying(prm.sa_id, &prm.sa_params,
+						    default_rekey_event_cb,
+						    prm.auto_rmv_old_sa,
+						    &prm.new_sa_id);
 			if (err < 0)
 				return err;
 
@@ -306,3 +307,11 @@ long wrp_dpa_ipsec_ioctl(struct file *filp, unsigned int cmd,
 	}
 	return ret;
 }
+
+
+int default_rekey_event_cb(int dpa_ipsec_id, int sa_id, int error)
+{
+	xx_pr_info("DPA IPSec Instance %d || new sa_id %d || error %d\n",
+		dpa_ipsec_id, sa_id, error);
+	return 0;
+}
diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.h b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.h
index 2d2b4e8..6b04be3 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.h
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.h
@@ -50,4 +50,6 @@ int wrp_dpa_ipsec_release(struct inode *inode, struct file *filp);
 long wrp_dpa_ipsec_ioctl(struct file *filp, unsigned int cmd,
 			 unsigned long args);
 
+int default_rekey_event_cb(int dpa_ipsec_id, int sa_id, int error);
+
 #endif	/* WRP_DPA_IPSEC_H_ */
-- 
1.7.5.4

