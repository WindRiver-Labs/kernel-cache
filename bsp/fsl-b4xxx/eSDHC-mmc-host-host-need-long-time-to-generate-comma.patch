From cffcf16786cce1ad791cd88e7b1120bcbfc48869 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Tue, 16 Apr 2013 10:57:16 +0800
Subject: [PATCH 13/36] eSDHC: mmc:host host need long time to generate
 command complete interrupt

According to Spec 2.0, command complete interrupt will generate within
150 SD-CLK. But this was not enough on T4240 board. So give it sufficient
time to detect command timeout. 1000 * HZ will be enough, this value was
test on all T4 board, all worked well.

Signed-off-by: Jerry Huang <Chang-Ming.Huang@freescale.com>
Signed-off-by: Haijun Zhang <Haijun.Zhang@freescale.com>
[Grabbed from the branch, LINUX_IR5.3.0_ALPHA, of
https://git.freescale.com/git-private/cgit.cgi/ppc/dpaa-offload/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/mmc/host/sdhci-pltfm.c |    1 +
 drivers/mmc/host/sdhci.c       |    9 ++++++++-
 include/linux/mmc/sdhci.h      |    2 ++
 3 files changed, 11 insertions(+), 1 deletions(-)

diff --git a/drivers/mmc/host/sdhci-pltfm.c b/drivers/mmc/host/sdhci-pltfm.c
index 9778bd6..b9f2f89 100644
--- a/drivers/mmc/host/sdhci-pltfm.c
+++ b/drivers/mmc/host/sdhci-pltfm.c
@@ -89,6 +89,7 @@ void sdhci_get_of_property(struct platform_device *pdev)
 		if (of_device_is_compatible(np, "fsl,t4240-esdhc")) {
 			host->quirks |= SDHCI_QUIRK_BROKEN_ADMA;
 			host->quirks |= SDHCI_QUIRK_QORIQ_CIRCUIT_SUPPORT_VS33;
+			host->quirks |= SDHCI_QUIRK_LONG_TIME_CMD_COMPLETE_IRQ;
 		}
 
 		clk = of_get_property(np, "clock-frequency", &size);
diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.c
index 360763c..ed70177 100644
--- a/drivers/mmc/host/sdhci.c
+++ b/drivers/mmc/host/sdhci.c
@@ -979,6 +979,7 @@ static void sdhci_send_command(struct sdhci_host *host, struct mmc_command *cmd)
 	int flags;
 	u32 mask;
 	unsigned long timeout;
+	int timer = 10;
 
 	WARN_ON(host->cmd);
 
@@ -1007,7 +1008,13 @@ static void sdhci_send_command(struct sdhci_host *host, struct mmc_command *cmd)
 		mmc_delay(1);
 	}
 
-	mod_timer(&host->timer, jiffies + 10 * HZ);
+	/* In case some controller need long time to generate command
+	 * interrupt, 1000 * HZ will be enough.
+	 */
+	if (host->quirks & SDHCI_QUIRK_LONG_TIME_CMD_COMPLETE_IRQ)
+		timer = 1000;
+
+	mod_timer(&host->timer, jiffies + timer * HZ);
 
 	host->cmd = cmd;
 
diff --git a/include/linux/mmc/sdhci.h b/include/linux/mmc/sdhci.h
index 416db5a..fc4d2ca 100644
--- a/include/linux/mmc/sdhci.h
+++ b/include/linux/mmc/sdhci.h
@@ -97,6 +97,8 @@ struct sdhci_host {
  * circuit has capability to support 3.3V
  */
 #define SDHCI_QUIRK_QORIQ_CIRCUIT_SUPPORT_VS33		(0x400000000U)
+/* Controller need long time to generate command complete interrupt */
+#define SDHCI_QUIRK_LONG_TIME_CMD_COMPLETE_IRQ		(0x800000000U)
 
 	unsigned int quirks2;	/* More deviations from spec. */
 
-- 
1.7.5.4

