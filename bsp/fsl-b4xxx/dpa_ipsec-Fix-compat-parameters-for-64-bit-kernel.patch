From 975b6fab773385184cf73dfc0308b91fd2cd45d9 Mon Sep 17 00:00:00 2001
From: Radu-Andrei BULIE <radu.bulie@freescale.com>
Date: Mon, 29 Oct 2012 22:58:42 +0000
Subject: [PATCH 356/518] dpa_ipsec: Fix compat parameters for 64 bit kernel

Policy parameters that were sent back to the user inside ioctl,
were not configured correctly.

Signed-off-by: Radu-Andrei BULIE <radu.bulie@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c |   13 ++++++++++---
 1 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
index 7193a41..16ee8ed 100644
--- a/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
+++ b/drivers/staging/fsl_dpa_offload/wrp_dpa_ipsec.c
@@ -826,9 +826,11 @@ static int do_sa_get_policies_ioctl(void *args, bool compat)
 {
 	struct ioc_dpa_ipsec_get_policies prm;
 	struct dpa_ipsec_policy_params *policy_params = NULL;
+	struct ioc_dpa_ipsec_add_rem_policy kparam;
 #ifdef CONFIG_COMPAT
 	struct ioc_compat_dpa_ipsec_get_policies compat_prm;
 	struct ioc_compat_policy_params *compat_pol_params = NULL;
+	struct ioc_compat_dpa_ipsec_add_rem_policy compat_uparam;
 	int i;
 #endif
 	int sa_id, num_pol, err = 0;
@@ -906,10 +908,15 @@ static int do_sa_get_policies_ioctl(void *args, bool compat)
 		return -ENOMEM;
 	}
 
-	for (i = 0; i < num_pol; i++)
-		compat_copy_dpa_ipsec_add_rem_policy(&policy_params[i],
-						     &compat_pol_params[i],
+	for (i = 0; i < num_pol; i++) {
+		memcpy(&kparam.pol_params, &policy_params[i],
+			sizeof(kparam.pol_params));
+		compat_copy_dpa_ipsec_add_rem_policy(&kparam,
+						     &compat_uparam,
 						     COMPAT_K_TO_US);
+		memcpy(&compat_pol_params[i], &compat_uparam.pol_params,
+			sizeof(compat_uparam.pol_params));
+	}
 	if (copy_to_user(prm.policy_params, compat_pol_params,
 			 num_pol * sizeof(*compat_pol_params))) {
 		pr_err("Could not return policy parameters\n");
-- 
1.7.5.4

