From 55fd7712fd7cb437774e7de69a99fcd3bbc4310b Mon Sep 17 00:00:00 2001
From: Anca-Jeanina Floarea <anca.floarea@freescale.com>
Date: Thu, 25 Oct 2012 23:12:41 +0000
Subject: [PATCH 332/518] dpa_stats: Bug fix for thread safety support

The mutex for the DPA Stats instance remains
locked in certain error scenarios. Added call
to mutex_unlock for these scenarios.

Signed-off-by: Anca Jeanina FLOAREA <anca.floarea@freescale.com>
[Grabbed from the branch, LINUX_IR5.2.0, of
https://git.freescale.com/git-private/cgit.cgi/ppc/alu-b4860/linux.git.]
Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/staging/fsl_dpa_offload/dpa_stats.c |    8 ++++++--
 1 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/staging/fsl_dpa_offload/dpa_stats.c b/drivers/staging/fsl_dpa_offload/dpa_stats.c
index 8acb43c..6e67e88 100644
--- a/drivers/staging/fsl_dpa_offload/dpa_stats.c
+++ b/drivers/staging/fsl_dpa_offload/dpa_stats.c
@@ -96,6 +96,7 @@ static int get_new_cnt(struct dpa_stats *dpa_stats,
 	/* Get an id for new Counter */
 	if (cq_get_4bytes(dpa_stats->cnt_id_cq, &id) < 0) {
 		pr_err("No more unused counter ids\n");
+		mutex_unlock(&dpa_stats->lock);
 		return -EDOM;
 	}
 
@@ -108,6 +109,7 @@ static int get_new_cnt(struct dpa_stats *dpa_stats,
 	if (i == dpa_stats->config.max_counters) {
 		pr_err("All counters have been used");
 		cq_put_4bytes(dpa_stats->cnt_id_cq, id);
+		mutex_unlock(&dpa_stats->lock);
 		return -EDOM;
 	}
 
@@ -140,7 +142,8 @@ static int get_new_req(struct dpa_stats *dpa_stats,
 
 	/* Get an id for a new request */
 	if (cq_get_4bytes(dpa_stats->req_id_cq, &id) < 0) {
-		pr_err("No more unused counter ids\n");
+		pr_err("No more unused request ids\n");
+		mutex_unlock(&dpa_stats->lock);
 		return -EDOM;
 	}
 
@@ -153,6 +156,7 @@ static int get_new_req(struct dpa_stats *dpa_stats,
 	if (i == DPA_STATS_MAX_NUM_OF_REQUESTS) {
 		pr_err("All requests have been used");
 		cq_put_4bytes(dpa_stats->req_id_cq, id);
+		mutex_unlock(&dpa_stats->lock);
 		return -EDOM;
 	}
 
@@ -370,7 +374,7 @@ static int init_reqs_cb(struct dpa_stats *dpa_stats)
 	dpa_stats->used_req_ids = kmalloc(DPA_STATS_MAX_NUM_OF_REQUESTS *
 			sizeof(uint32_t), GFP_KERNEL);
 	if (!dpa_stats->used_req_ids) {
-		pr_err("No more memory for used counter ids array\n");
+		pr_err("No more memory for used req ids array\n");
 		return -ENOMEM;
 	}
 	memset(dpa_stats->used_req_ids, DPA_OFFLD_INVALID_OBJECT_ID,
-- 
1.7.5.4

