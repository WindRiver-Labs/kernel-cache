From 4d468d879587bbf959a4f1f163c2c60e36b70727 Mon Sep 17 00:00:00 2001
From: Tian Le <le.tian@windriver.com>
Date: Wed, 18 Aug 2010 16:21:42 +0800
Subject: [PATCH] Corrected virt_to_phys() for mips64 to resolve umount issue.

For mips64, when the argument is addr 0xffffffff8xxxxxxx rather than 0xa8xxxxxxxxxxxxxx,
the old function of virt_to_phys() is wrong.

Signed-off-by: Tian Le <le.tian@windriver.com>
---
 arch/mips/include/asm/io.h |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/arch/mips/include/asm/io.h b/arch/mips/include/asm/io.h
index c98bf51..7f88071 100644
--- a/arch/mips/include/asm/io.h
+++ b/arch/mips/include/asm/io.h
@@ -116,6 +116,10 @@ static inline void set_io_port_base(unsigned long base)
  */
 static inline unsigned long virt_to_phys(volatile const void *address)
 {
+#ifdef CONFIG_64BIT
+	if((unsigned long) address >= CKSEG0)
+		return (unsigned long)address - CKSEG0 + PHYS_OFFSET;
+#endif
 	return (unsigned long)address - PAGE_OFFSET + PHYS_OFFSET;
 }
 
-- 
1.6.5.2

