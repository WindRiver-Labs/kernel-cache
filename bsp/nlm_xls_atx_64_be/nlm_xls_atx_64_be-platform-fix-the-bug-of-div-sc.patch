From cb1e23daa2f2f31a9df94e0f83838bf14056045d Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Wed, 19 May 2010 23:57:28 +0800
Subject: [PATCH 18/38] nlm_xls_atx_64_be: platform fix the bug of div sc

Fix for div_sc. On 1GHz XLS div_sc returns zero if shift = 32.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/kernel/cevt-r4k.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/mips/kernel/cevt-r4k.c b/arch/mips/kernel/cevt-r4k.c
index 0b2450c..62336dd 100644
--- a/arch/mips/kernel/cevt-r4k.c
+++ b/arch/mips/kernel/cevt-r4k.c
@@ -189,8 +189,14 @@ int __cpuinit r4k_clockevent_init(void)
 	cd->features		= CLOCK_EVT_FEAT_ONESHOT;
 
 	/* Calculate the min / max delta */
+#ifdef CONFIG_RMI_PHOENIX
+	/* for 1GHz (and lesser), div_sc returns zero if shift = 32 */
+	cd->mult		= div_sc((unsigned long) mips_freq, NSEC_PER_SEC, 30);
+	cd->shift		= 30;
+#else
 	cd->mult	= div_sc((unsigned long) mips_freq, NSEC_PER_SEC, 32);
 	cd->shift		= 32;
+#endif
 	cd->max_delta_ns	= clockevent_delta2ns(0x7fffffff, cd);
 	cd->min_delta_ns	= clockevent_delta2ns(0x300, cd);
 
-- 
1.6.5.2

