From b94ac58b4800155d23fb0a0049c1786d1245653e Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Wed, 19 May 2010 23:57:28 +0800
Subject: [PATCH 12/38] nlm_xls_atx_64_be: platform arch kconfig and makefile support

The XLS's configuration and building system support.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/Kconfig  |   38 ++++++++++++++++++++++++++++++++++++++
 arch/mips/Makefile |   16 ++++++++++++++++
 2 files changed, 54 insertions(+), 0 deletions(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index 838a9e5..8a92b85 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -682,6 +682,30 @@ config CAVIUM_OCTEON_REFERENCE_BOARD
 		Hikari
 	  Say Y here for most Octeon reference boards.
 
+config RMI_PTR
+	bool "Support for RMI ATX board"
+	depends on EXPERIMENTAL
+	select SMP
+	select BOOT_ELF32
+	select RMI_PHOENIX
+	select SYS_HAS_CPU_PHOENIX
+	select SYS_SUPPORTS_SMP
+	select HW_HAS_PCI
+	select SWAP_IO_SPACE
+	select SYS_SUPPORTS_32BIT_KERNEL
+	select SYS_SUPPORTS_64BIT_KERNEL
+	select SYS_SUPPORTS_BIG_ENDIAN
+	select SYS_SUPPORTS_HIGHMEM
+	select DMA_COHERENT
+	select CEVT_R4K
+	select CSRC_R4K
+	select IRQ_CPU
+	select ZONE_DMA if 64BIT
+	select SYNC_R4K
+	help
+	  This board is based on RMI XLS processor. 
+	  Say Y here to support this machine type
+
 endchoice
 
 source "arch/mips/alchemy/Kconfig"
@@ -696,6 +720,7 @@ source "arch/mips/txx9/Kconfig"
 source "arch/mips/vr41xx/Kconfig"
 source "arch/mips/cavium-octeon/Kconfig"
 source "arch/mips/loongson/Kconfig"
+source "arch/mips/rmi/Kconfig"
 
 endmenu
 
@@ -1306,6 +1331,16 @@ config CPU_CAVIUM_OCTEON
 	  can have up to 16 Mips64v2 cores and 8 integrated gigabit ethernets.
 	  Full details can be found at http://www.caviumnetworks.com.
 
+config CPU_PHOENIX
+	bool "XLS"
+	depends on SYS_HAS_CPU_PHOENIX
+	select CPU_SUPPORTS_32BIT_KERNEL
+	select CPU_SUPPORTS_64BIT_KERNEL
+	select CPU_SUPPORTS_HIGHMEM
+	select CPU_HAS_LLSC
+	select WEAK_ORDERING
+	select WEAK_REORDERING_BEYOND_LLSC
+
 endchoice
 
 if CPU_LOONGSON2F
@@ -1424,6 +1459,9 @@ config SYS_HAS_CPU_SB1
 config SYS_HAS_CPU_CAVIUM_OCTEON
 	bool
 
+config SYS_HAS_CPU_PHOENIX
+	bool
+
 #
 # CPU may reorder R->R, R->W, W->R, W->W
 # Reordering beyond LL and SC is handled in WEAK_REORDERING_BEYOND_LLSC
diff --git a/arch/mips/Makefile b/arch/mips/Makefile
index 0b9c01a..afe1e2d 100644
--- a/arch/mips/Makefile
+++ b/arch/mips/Makefile
@@ -179,6 +179,8 @@ ifeq (,$(findstring march=octeon, $(cflags-$(CONFIG_CPU_CAVIUM_OCTEON))))
 cflags-$(CONFIG_CPU_CAVIUM_OCTEON) += -Wa,-march=octeon
 endif
 
+cflags-$(CONFIG_CPU_PHOENIX)    += $(call cc-option,-march=xlr) -Wa,--trap -DXLS -DRMI_BRIDGE_WKAROUND
+
 cflags-$(CONFIG_CPU_R4000_WORKAROUNDS)	+= $(call cc-option,-mfix-r4000,)
 cflags-$(CONFIG_CPU_R4400_WORKAROUNDS)	+= $(call cc-option,-mfix-r4400,)
 cflags-$(CONFIG_CPU_DADDI_WORKAROUNDS)	+= $(call cc-option,-mno-daddi,)
@@ -659,6 +661,16 @@ else
 load-$(CONFIG_CPU_CAVIUM_OCTEON) 	+= 0xffffffff81100000
 endif
 
+# RMI Phoenix SOC
+core-$(CONFIG_RMI_PHOENIX)      += arch/mips/rmi/phoenix/ 
+
+# RMI PTR board
+core-$(CONFIG_RMI_PTR)          += arch/mips/rmi/ptr/
+cflags-$(CONFIG_RMI_PTR)	+= -Iarch/mips/include/asm/mach-rmi
+cflags-$(CONFIG_CRYPTO_XLR)	+= -Idrivers/crypto/rmi/common
+# This address is now configured via kernel configuration file
+load-$(CONFIG_RMI_PTR)		+= $(CONFIG_RMI_PHOENIX_LOAD_ADDRESS)
+
 cflags-y			+= -I$(srctree)/arch/mips/include/asm/mach-generic
 drivers-$(CONFIG_PCI)		+= arch/mips/pci/
 
@@ -772,6 +784,10 @@ ifdef CONFIG_MIPS32_O32
 	@echo '  Checking missing-syscalls for O32'
 	$(Q)$(MAKE) $(build)=. missing-syscalls EXTRA_CFLAGS="-mabi=32"
 endif
+ifdef CONFIG_RMI_PHOENIX
+	@echo ' Building message ring configuration'
+	$(MAKE) -C  $(srctree)/arch/mips/rmi/phoenix msgring
+endif
 
 install:
 	$(Q)install -D -m 755 vmlinux $(INSTALL_PATH)/vmlinux-$(KERNELRELEASE)
-- 
1.6.5.2

