From 0b0ef84e6a1ece1b8a6a49232a151cc22f5710e3 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Thu, 9 Sep 2010 22:44:06 -0700
Subject: [PATCH 1/2] nlm_xls_atx_64_be: Allocate memory with kzalloc() instead of alloc_bootmem_low() if slab is available

The net driver phoenix_user_mac.c tries to allocate memory with
alloc_bootmem_low() when doing console_int(). at this time, the slab is
already available:

start_kernel:
    mm_init() --> kmem_cache_init() // slab is initialized here.
    ...
    console_init()

So we need to use it instead of the boot-time physical memory area
allocator.

If not use it, the kernel will print the following warning and then use it:

[snip]
RCU-based detection of stalled CPUs is enabled.
NR_IRQS:128
console [ttyS0] enabled
------------[ cut here ]------------
WARNING: at mm/bootmem.c:663 alloc_arch_preferred_bootmem+0x44/0x7c()
Modules linked in:
Call Trace:
[<ffffffff8340bb1c>] dump_stack+0x8/0x34
[<ffffffff83458410>] warn_slowpath_common+0x70/0x98
[<ffffffff83b300cc>] alloc_arch_preferred_bootmem+0x44/0x7c
[<ffffffff83b30968>] ___alloc_bootmem_nopanic+0x60/0x124
[<ffffffff83b30a40>] ___alloc_bootmem+0x14/0x44
[<ffffffff837dd410>] user_mac_mem+0x18/0x38
[<ffffffff83b3c194>] console_init+0x30/0x50
[<ffffffff83b23ac4>] start_kernel+0x300/0x4a0

---[ end trace f65be78721acb4e1 ]---
------------[ cut here ]------------
[snip]

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 drivers/net/phoenix_user_mac.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/net/phoenix_user_mac.c b/drivers/net/phoenix_user_mac.c
index dcea6b4..dbb8be6 100644
--- a/drivers/net/phoenix_user_mac.c
+++ b/drivers/net/phoenix_user_mac.c
@@ -1448,7 +1448,7 @@ static void user_mac_exit(void)
 
 static void user_mac_mem(void)
 {
-	phoenix_psb_shm = alloc_bootmem_low(PHNX_USER_MAC_SIZE);
+	phoenix_psb_shm = kzalloc(PHNX_USER_MAC_SIZE, GFP_NOWAIT);
 	phoenix_psb_shm_size = PHNX_USER_MAC_SIZE;
 }
 
-- 
1.6.5.2

