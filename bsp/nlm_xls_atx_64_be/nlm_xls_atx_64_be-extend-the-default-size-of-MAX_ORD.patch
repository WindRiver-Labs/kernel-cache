From d750f61cb9da6037889fdcf569c4647a37fa694c Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Thu, 5 May 2011 15:23:46 +0800
Subject: [PATCH] nlm_xls_atx_64_be: extend the default size of MAX_ORDER

The default value of MAX_ORDER is 11. So the largest free memory
block is 2^(11 - 1) pages. It's 4MB when we use 4KB page size.
It means that kernel only allow us to request a contiguous free
memory block less than 4MB when we use the default value.

The net driver phoenix_user_mac.c tries to request 4MB physically
contiguous memory block. So this is always failed and the kernel
print the following message:

[snip]
Modules linked in:
Call Trace:
[<ffffffff8340ab18>] dump_stack+0x8/0x34
[<ffffffff83458580>] warn_slowpath_common+0x70/0x98
[<ffffffff834f34d4>] __alloc_pages_nodemask+0x604/0x738
[<ffffffff834f3620>] __get_free_pages+0x18/0x68
[<ffffffff83953034>] user_mac_mem+0x34/0xf8
[<ffffffff83d13c58>] console_init+0x30/0x50
[<ffffffff83cfaa98>] start_kernel+0x308/0x520

---[ end trace 139ce121c98e96c9 ]---
Calibrating delay loop... 264.19 BogoMIPS (lpj=528384)
[snip]

We extend the value of MAX_ORDER to 12. It's only affect the permitted
size of the largest free memory block.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/rmi/Kconfig |   18 ++++++++++++++++++
 1 files changed, 18 insertions(+), 0 deletions(-)

diff --git a/arch/mips/rmi/Kconfig b/arch/mips/rmi/Kconfig
index 55ef265..bd1c2b7 100644
--- a/arch/mips/rmi/Kconfig
+++ b/arch/mips/rmi/Kconfig
@@ -139,3 +139,21 @@ config RMI_NAS
 	default n
 	help
 		This options enables some optimizations done for XLS NAS solutions
+
+config FORCE_MAX_ZONEORDER
+        int "Maximum zone order"
+	depends on RMI_PHOENIX
+        default "12"
+        help
+          The kernel memory allocator divides physically contiguous memory
+          blocks into "zones", where each zone is a power of two number of
+          pages.  This option selects the largest power of two that the kernel
+          keeps in the memory allocator.  If you need to allocate very large
+          blocks of physically contiguous memory, then you may need to
+          increase this value.
+
+          This config option is actually maximum order plus one. For example,
+          a value of 12 means that the largest free memory block is 2^11 pages.
+
+          The page size is not necessarily 4KB. Keep this in mind when
+          choosing a value for this option.
-- 
1.7.0.2

