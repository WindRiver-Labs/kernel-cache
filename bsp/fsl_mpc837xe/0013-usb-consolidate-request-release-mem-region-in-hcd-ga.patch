From 1ddb6f165071a6b23040c564afd0ee5207b2fa30 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 28 Aug 2009 16:36:17 +0800
Subject: [PATCH 13/38] usb: consolidate request/release mem region in hcd/gadget/otg driver

In otg mode we only request memory region in otg driver. So we should
not release the memory region in hcd and gadget driver release
function

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/usb/gadget/fsl_usb2_udc.c |   10 +++++-----
 drivers/usb/host/ehci-fsl.c       |    2 ++
 drivers/usb/otg/fsl_otg.c         |    9 +++++++--
 3 files changed, 14 insertions(+), 7 deletions(-)

diff --git a/drivers/usb/gadget/fsl_usb2_udc.c b/drivers/usb/gadget/fsl_usb2_udc.c
index bbf20e0..d5606cc 100644
--- a/drivers/usb/gadget/fsl_usb2_udc.c
+++ b/drivers/usb/gadget/fsl_usb2_udc.c
@@ -2462,8 +2462,6 @@ err1:
  */
 static int __exit fsl_udc_remove(struct platform_device *pdev)
 {
-	struct resource *res;
-
 	DECLARE_COMPLETION(done);
 
 	if (!udc_controller)
@@ -2484,11 +2482,13 @@ static int __exit fsl_udc_remove(struct platform_device *pdev)
 #if defined(CONFIG_FSL_USB_OTG) || defined(CONFIG_FSL_USB_OTG_MODULE)
 	cancel_work_sync(&udc_controller->resume_work);
 	module_put(udc_controller->transceiver->owner);
-	res = otg_get_resources();
 #else
-	res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
+	{
+		struct resource *res;
+		res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
+		release_mem_region(res->start, res->end - res->start + 1);
+	}
 #endif
-	release_mem_region(res->start, res->end - res->start + 1);
 
 	device_unregister(&udc_controller->gadget.dev);
 	/* free udc --wait for the release() finished */
diff --git a/drivers/usb/host/ehci-fsl.c b/drivers/usb/host/ehci-fsl.c
index d2dcd95..38dda36 100644
--- a/drivers/usb/host/ehci-fsl.c
+++ b/drivers/usb/host/ehci-fsl.c
@@ -283,7 +283,9 @@ void usb_hcd_fsl_remove(struct usb_hcd *hcd, struct platform_device *pdev)
 {
 	usb_remove_hcd(hcd);
 	iounmap(hcd->regs);
+#if !defined(CONFIG_FSL_USB_OTG) && !defined(CONFIG_FSL_USB_OTG_MODULE)
 	release_mem_region(hcd->rsrc_start, hcd->rsrc_len);
+#endif
 	usb_put_hcd(hcd);
 }
 
diff --git a/drivers/usb/otg/fsl_otg.c b/drivers/usb/otg/fsl_otg.c
index 03c8bb7..0ed2f81 100644
--- a/drivers/usb/otg/fsl_otg.c
+++ b/drivers/usb/otg/fsl_otg.c
@@ -819,8 +819,13 @@ int usb_otg_start(struct platform_device *pdev)
 	if (!res)
 		return -ENXIO;
 
-	/* We don't request_mem_region here to enable resource sharing
-	 * with host/device */
+	if (!request_mem_region(res->start, res->end - res->start +1,
+				driver_name)) {
+		dev_dbg(p_otg->otg.dev, "Can't request mem region for %s\n",
+			driver_name);
+		iounmap(p_otg->dr_mem_map);
+		kfree(p_otg);
+	}
 
 	usb_dr_regs = ioremap(res->start, sizeof(struct usb_dr_mmap));
 	p_otg->dr_mem_map = (struct usb_dr_mmap *)usb_dr_regs;
-- 
1.6.3.3

