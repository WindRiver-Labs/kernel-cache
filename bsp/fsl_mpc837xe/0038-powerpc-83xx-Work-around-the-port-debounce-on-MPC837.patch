From bc7c8955fd55f323a9249747ac7b31ec101c665d Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 11 Sep 2009 18:08:56 +0800
Subject: [PATCH 38/38] powerpc/83xx: Work around the port debounce on MPC8378EMDS

It's unnecessary to do the debounce when disconnect device
on the MPC837xEMDS so don't repeat the debounce here. And
it's safe to read that firstly before modifying the usb port
configuration register.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/usb/core/hub.c      |    5 +++++
 drivers/usb/host/ehci-fsl.c |    3 +--
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/usb/core/hub.c b/drivers/usb/core/hub.c
index 769f80f..300252c 100644
--- a/drivers/usb/core/hub.c
+++ b/drivers/usb/core/hub.c
@@ -2678,8 +2678,13 @@ static void hub_port_connect_change(struct usb_hub *hub, int port1,
 	}
 
 #ifdef	CONFIG_USB_OTG
+	/* It's unnecessary to do the debounce when disconnect device
+	 * on the MPC837xEMDS.
+	 */
+#ifndef CONFIG_MPC837x_MDS
 	/* during HNP, don't repeat the debounce */
 	if (hdev->bus->is_b_host)
+#endif
 		portchange &= ~(USB_PORT_STAT_C_CONNECTION |
 				USB_PORT_STAT_C_ENABLE);
 #endif
diff --git a/drivers/usb/host/ehci-fsl.c b/drivers/usb/host/ehci-fsl.c
index cb8d85b..05d668c 100644
--- a/drivers/usb/host/ehci-fsl.c
+++ b/drivers/usb/host/ehci-fsl.c
@@ -32,8 +32,7 @@ static void mpc83xx_setup_phy(struct usb_hcd *hcd)
 	struct ehci_hcd *ehci = hcd_to_ehci(hcd);
 	struct fsl_usb2_platform_data *pdata;
 	enum fsl_usb2_phy_modes phy_mode;
-	u32 portsc = 0;
-
+	u32 portsc = ehci_readl(ehci, &ehci->regs->port_status[0]);
 
 	pdata =
 	   (struct fsl_usb2_platform_data *)hcd->self.controller->platform_data;
-- 
1.6.3.3

