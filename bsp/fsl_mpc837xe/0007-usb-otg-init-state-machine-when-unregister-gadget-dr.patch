From 7ef4ffec937852faf03fbaa0382f4b70c5497159 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 28 Aug 2009 16:36:11 +0800
Subject: [PATCH 07/38] usb/otg: init state machine when unregister gadget driver in FSL USB2

Set the USB OTG state machine state to OTG_STATE_UNDEFINED each time the UDC
is registered to OTG. When the gadget driver is unregistered the state machine
is left in an improper state so we are able to correct that here by setting to
a default state.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/usb/otg/fsl_otg.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/otg/fsl_otg.c b/drivers/usb/otg/fsl_otg.c
index 06a1bf0..d9a111f 100644
--- a/drivers/usb/otg/fsl_otg.c
+++ b/drivers/usb/otg/fsl_otg.c
@@ -481,6 +481,7 @@ static int fsl_otg_set_peripheral(struct otg_transceiver *otg_p,
 		otg_dev->otg.gadget = 0;
 		otg_dev->fsm.b_bus_req = 0;
 		otg_statemachine(&otg_dev->fsm);
+		SET_OTG_STATE(otg_p, OTG_STATE_UNDEFINED);
 		return 0;
 	}
 
-- 
1.6.3.3

