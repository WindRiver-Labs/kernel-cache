From 982ba70893c27bc38c88fa16e38105428289b37c Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 11 Sep 2009 18:08:54 +0800
Subject: [PATCH 37/38] powerpc/83xx: support SD on the mpc8378emds

Add the sample clock-frequency value of SD on the dts file, then configure
necessary SD PIN and insert appropriate compatible id to use sdhci-of drive

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/boot/dts/mpc8378_mds.dts     |    1 +
 arch/powerpc/platforms/83xx/mpc837x_mds.c |   47 +++++++++++++++++++++++++++++
 drivers/mmc/host/sdhci-of.c               |    1 +
 3 files changed, 49 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/boot/dts/mpc8378_mds.dts b/arch/powerpc/boot/dts/mpc8378_mds.dts
index 91a5940..4cb6b95 100644
--- a/arch/powerpc/boot/dts/mpc8378_mds.dts
+++ b/arch/powerpc/boot/dts/mpc8378_mds.dts
@@ -305,6 +305,7 @@
 			reg = <0x2e000 0x1000>;
 			interrupts = <42 0x8>;
 			interrupt-parent = <&ipic>;
+			clock-frequency = <50000000>;
 		};
 
 		/* IPIC
diff --git a/arch/powerpc/platforms/83xx/mpc837x_mds.c b/arch/powerpc/platforms/83xx/mpc837x_mds.c
index aa302d8..74d7bad 100644
--- a/arch/powerpc/platforms/83xx/mpc837x_mds.c
+++ b/arch/powerpc/platforms/83xx/mpc837x_mds.c
@@ -20,9 +20,52 @@
 #include <asm/udbg.h>
 #include <asm/prom.h>
 #include <sysdev/fsl_pci.h>
+#include <sysdev/fsl_soc.h>
 
 #include "mpc83xx.h"
 
+#define BCSR12_INT_SD	0x40
+
+static int mpc837xmds_sd_cfg(void)
+{
+
+	struct device_node *np;
+	void __iomem *immap = NULL;
+	void __iomem *bcsr_regs = NULL;
+	u32 sicrl, sicrh;
+	u8 bcsr12;
+
+	/* Configure the multiplexing of pins */
+	immap = ioremap(get_immrbase(), 0x1000);
+	if (!immap)
+		return -ENOMEM;
+
+	sicrl = in_be32(immap + MPC83XX_SICRL_OFFS) & ~MPC837X_SICRL_USBB_MASK;
+	sicrh = in_be32(immap + MPC83XX_SICRH_OFFS) & ~MPC837X_SICRH_SPI_MASK;
+
+	out_be32(immap + MPC83XX_SICRL_OFFS, (sicrl | MPC837X_SICRL_SD));
+	out_be32(immap + MPC83XX_SICRH_OFFS, (sicrh | MPC837X_SICRH_SD));
+	udelay(100);
+	iounmap(immap);
+
+	/* Map BCSR area */
+	np = of_find_node_by_name(NULL, "bcsr");
+	if (np) {
+		struct resource res;
+		of_address_to_resource(np, 0, &res);
+		bcsr_regs = ioremap(res.start, res.end - res.start + 1);
+		of_node_put(np);
+	}
+	if (!bcsr_regs)
+		return -1;
+
+	bcsr12 = in_8(bcsr_regs + 12);
+	if (!(bcsr12 & BCSR12_INT_SD))
+		out_8(bcsr_regs + 12, (bcsr12 | BCSR12_INT_SD));
+	iounmap(bcsr_regs);
+	return 0;
+}
+
 #define BCSR12_USB_SER_MASK	0x8a
 #define BCSR12_USB_SER_PIN	0x80
 #define BCSR12_USB_SER_DEVICE	0x02
@@ -91,6 +134,10 @@ static void __init mpc837x_mds_setup_arch(void)
 		mpc83xx_add_bridge(np);
 #endif
 	mpc837xmds_usb_cfg();
+
+#ifdef CONFIG_MMC_SDHCI_OF
+	mpc837xmds_sd_cfg();
+#endif
 }
 
 static struct of_device_id mpc837x_ids[] = {
diff --git a/drivers/mmc/host/sdhci-of.c b/drivers/mmc/host/sdhci-of.c
index 97b2b16..da5647c 100644
--- a/drivers/mmc/host/sdhci-of.c
+++ b/drivers/mmc/host/sdhci-of.c
@@ -278,6 +278,7 @@ static int __devexit sdhci_of_remove(struct of_device *ofdev)
 static const struct of_device_id sdhci_of_match[] = {
 	{ .compatible = "fsl,mpc8379-esdhc", .data = &sdhci_esdhc, },
 	{ .compatible = "fsl,mpc8536-esdhc", .data = &sdhci_esdhc, },
+	{ .compatible = "fsl,esdhc", .data = &sdhci_esdhc, },
 	{ .compatible = "generic-sdhci", },
 	{},
 };
-- 
1.6.3.3

