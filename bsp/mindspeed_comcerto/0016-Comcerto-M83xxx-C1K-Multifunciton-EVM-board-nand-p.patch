From 582cde10e703f9a4a2d7fd668e3af5c528e0181b Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Fri, 22 Oct 2010 11:17:10 +0800
Subject: [PATCH 16/26] Comcerto: M83xxx: C1K Multifunciton EVM board nand platform data

Original codes came from Mindspeed's vendor drop sdk-comcerto-openwrt-6.0.
Little modification to apply to wrlinux-4.0.

Add nand platform data for C1K Multifunciton EVM board.

Signed-off-by: Stanley.Miao <stanley.miao@windriver.com>
---
 arch/arm/mach-comcerto/board-c1kmfcn_evm.c |   73 ++++++++++++++++++++++++++++
 arch/arm/mach-comcerto/include/mach/nand.h |   35 +++++++++++++
 2 files changed, 108 insertions(+), 0 deletions(-)
 create mode 100644 arch/arm/mach-comcerto/include/mach/nand.h

diff --git a/arch/arm/mach-comcerto/board-c1kmfcn_evm.c b/arch/arm/mach-comcerto/board-c1kmfcn_evm.c
index ab3f403..6f736cf 100644
--- a/arch/arm/mach-comcerto/board-c1kmfcn_evm.c
+++ b/arch/arm/mach-comcerto/board-c1kmfcn_evm.c
@@ -20,12 +20,83 @@
 #include <linux/sched.h>
 #include <linux/device.h>
 #include <linux/serial_8250.h>
+#include <linux/mtd/mtd.h>
+#include <linux/mtd/partitions.h>
 #include <asm/sizes.h>
 #include <asm/setup.h>
 #include <asm/mach-types.h>
 #include <asm/io.h>
 #include <asm/mach/arch.h>
 #include <mach/hardware.h>
+#include <mach/nand.h>
+#include <mach/gpio.h>
+
+static void __init board_gpio_init(void)
+{
+#if defined(CONFIG_MTD_NAND_COMCERTO) || defined(CONFIG_MTD_NAND_COMCERTO_MODULE)
+	writel(readl(COMCERTO_GPIO_PIN_SELECT_REG) & ~NAND_BUS, COMCERTO_GPIO_PIN_SELECT_REG);
+	writel(readl(COMCERTO_GPIO_PIN_SELECT_REG) | EXP_NAND_RDY, COMCERTO_GPIO_PIN_SELECT_REG);
+	comcerto_gpio_enable_output(COMCERTO_OUTPUT_GPIO);
+	writel((readl(COMCERTO_GPIO_BOOTSTRAP_OVERRIDE) | (0x3 << 12)), COMCERTO_GPIO_BOOTSTRAP_OVERRIDE);
+#else
+	writel(readl(COMCERTO_GPIO_PIN_SELECT_REG) | NAND_BUS, COMCERTO_GPIO_PIN_SELECT_REG);
+#endif
+}
+
+/* --------------------------------------------------------------------
+ *  NAND device
+ * -------------------------------------------------------------------- */
+struct mtd_partition c1kmfcn_evm_nandflash_partition[] = {
+	{
+		.name           = "u-boot",
+		.offset         = 0,
+		.size           = 2 * SZ_128K,
+		.mask_flags     = MTD_WRITEABLE,
+	},
+	{
+		.name           = "u-boot env",
+		.offset         = MTDPART_OFS_APPEND,
+		.size           = SZ_128K,
+		.mask_flags     = MTD_WRITEABLE,
+	},
+	{
+		.name           = "kernel",
+		.offset         = MTDPART_OFS_APPEND,
+		.size           = SZ_4M,
+		.mask_flags     = 0,
+	},
+	{
+		.name           = "filesystem",
+		.offset         = MTDPART_OFS_APPEND,
+		.size           = MTDPART_SIZ_FULL,
+		.mask_flags     = 0,
+	},
+};
+
+static struct comcerto_nand_pdata c1kmfcn_evm_nandflash_data = {
+	.parts          = c1kmfcn_evm_nandflash_partition,
+	.nr_parts       = ARRAY_SIZE(c1kmfcn_evm_nandflash_partition),
+	.options        = NAND_USE_FLASH_BBT,
+};
+
+
+static struct resource comcerto_nand_resources[] = {
+	{
+		.start	= COMCERTO_NAND_FIO_ADDR,
+		.end	= COMCERTO_NAND_FIO_ADDR + COMCERTO_NAND_IO_SZ - 1,
+		.flags	= IORESOURCE_MEM,
+	}
+};
+
+static struct platform_device comcerto_nand = {
+	.name		= "comcertonand",
+	.id		= -1,
+	.dev		= {
+		.platform_data	= &c1kmfcn_evm_nandflash_data,
+	},
+	.resource	= comcerto_nand_resources,
+	.num_resources	= ARRAY_SIZE(comcerto_nand_resources),
+};
 
 /* --------------------------------------------------------------------
  *  Serial interface
@@ -300,6 +371,7 @@ static struct platform_device comcerto_fbpoolB_device = {
 
 static struct platform_device *comcerto_devices[] __initdata = {
 	&comcerto_uart,
+	&comcerto_nand,
 	&comcerto_fbpoolA_device,
 	&comcerto_fbpoolB_device,
 	&comcerto_mdio0_device,
@@ -325,6 +397,7 @@ static void __init platform_irq_init(void)
 static void __init platform_init(void)
 {
 	device_init();
+	board_gpio_init();
 	platform_add_devices(comcerto_devices, ARRAY_SIZE(comcerto_devices));
 }
 
diff --git a/arch/arm/mach-comcerto/include/mach/nand.h b/arch/arm/mach-comcerto/include/mach/nand.h
new file mode 100644
index 0000000..42eee40
--- /dev/null
+++ b/arch/arm/mach-comcerto/include/mach/nand.h
@@ -0,0 +1,35 @@
+/*
+ * linux/arch/arm/mach-comcerto/include/mach/nand.h
+ *
+ * Copyright (c) 2010 Wind River Systems, Inc.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
+ * See the GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+ */
+
+#include <linux/mtd/nand.h>
+
+struct comcerto_nand_pdata {
+	struct mtd_partition    *parts;
+	unsigned                nr_parts;
+	unsigned                options;
+};
+
+#define COMCERTO_NAND_FIO_ADDR          COMCERTO_EXP_CS4_BASE
+#define COMCERTO_NAND_BR                GPIO_6
+#define COMCERTO_NAND_CE                GPIO_29
+#define COMCERTO_NAND_ALE               GPIO_30
+#define COMCERTO_NAND_CLE               GPIO_31
+#define COMCERTO_OUTPUT_GPIO            (COMCERTO_NAND_CE | COMCERTO_NAND_ALE | COMCERTO_NAND_CLE)
+#define COMCERTO_EXP_CS4_SEG_SZ         1
+#define COMCERTO_NAND_IO_SZ             ((COMCERTO_EXP_CS4_SEG_SZ << 12) + 0x1000)
-- 
1.5.4.3

