From 02e71351176a4ca015782ac83549ad8401612c61 Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Fri, 26 Nov 2010 13:00:52 +0800
Subject: [PATCH 2/3] mtd: comcerto: Add CONFIG_COMCERTO_NOR_WRITE_DELAY

Because some hardware issues, A short time delay is needed after the
write command on Comcerto NOR Flash. So CONFIG_COMCERTO_NOR_WRITE_DELAY
is added for the convenience of the adjusting the delay time.

Signed-off-by: Stanley.Miao <stanley.miao@windriver.com>
---
 drivers/mtd/maps/Kconfig        |    8 ++++++++
 drivers/mtd/maps/comcerto-nor.c |    2 +-
 2 files changed, 9 insertions(+), 1 deletions(-)

diff --git a/drivers/mtd/maps/Kconfig b/drivers/mtd/maps/Kconfig
index 33491ec..9332788 100644
--- a/drivers/mtd/maps/Kconfig
+++ b/drivers/mtd/maps/Kconfig
@@ -427,6 +427,14 @@ config MTD_COMCERTO_NOR
 	depends on MTD_CFI && ARCH_COMCERTO
 	help
 
+config COMCERTO_NOR_WRITE_DELAY
+	int "The delay time(us) after the write command on COMCERTO NOR Flash"
+	depends on MTD_COMCERTO_NOR
+	default "400"
+	help
+	  Because some unknown hardware issues, A short time delay is needed after
+	  the write command on Comcerto NOR Flash.
+
 # This needs CFI or JEDEC, depending on the cards found.
 config MTD_PCI
 	tristate "PCI MTD driver"
diff --git a/drivers/mtd/maps/comcerto-nor.c b/drivers/mtd/maps/comcerto-nor.c
index 91c6dea..dfe48d0 100644
--- a/drivers/mtd/maps/comcerto-nor.c
+++ b/drivers/mtd/maps/comcerto-nor.c
@@ -48,7 +48,7 @@ static void comcerto_map_inval_cache(struct map_info *map, unsigned long from,
 		asm volatile ("mcr p15, 0, %0, c7, c6, 1" : : "r" (start));
 		start += CACHELINESIZE;
 	}
-	udelay(100); /* To avoid software timeout issue when program flash */
+	udelay(CONFIG_COMCERTO_NOR_WRITE_DELAY); /* To avoid software timeout issue when program flash */
 }
 
 #ifdef CONFIG_MTD_PARTITIONS
-- 
1.5.4.3

