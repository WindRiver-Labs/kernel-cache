From d62b853e4837f590588b625882a1edb900a93036 Mon Sep 17 00:00:00 2001
From: Hui Wang <Hui.Wang@windriver.com>
Date: Fri, 28 Jan 2011 16:34:53 +0800
Subject: [PATCH 25/25] drm/i915/ringbuffer: set FORCE_WAKE bit before reading ring register

Refer to the upstream: cae5852d

Before reading ring register, set FORCE_WAKE bit to prevent GT core
power down to low power state, otherwise we may read stale values.

Signed-off-by: Zou Nan hai <nanhai.zou@intel.com>
[ickle: added a udelay which seemed to do the trick on my SNB]
Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>

[When we read ringbuffer head from register, we always get 0 on Sandy
Bridge Mbl platforms, the wrong ringbuffer head will result a wrong
ringbuffer space. Therefore some applications which will send
render commands to the ringbuffer will fail afer runing a while.

To solve this problem, picked i915_safe_read() content.]

Signed-off-by: Hui Wang <Hui.Wang@windriver.com>
---
 drivers/gpu/drm/i915/i915_dma.c |   21 ++++++++++++++++++++-
 drivers/gpu/drm/i915/i915_reg.h |    3 +++
 2 files changed, 23 insertions(+), 1 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_dma.c b/drivers/gpu/drm/i915/i915_dma.c
index ac6bceb..8be529d 100644
--- a/drivers/gpu/drm/i915/i915_dma.c
+++ b/drivers/gpu/drm/i915/i915_dma.c
@@ -60,7 +60,26 @@ int i915_wait_ring(struct drm_device * dev, int n, const char *caller)
 	trace_i915_ring_wait_begin (dev);
 
 	for (i = 0; i < 100000; i++) {
-		ring->head = I915_READ(PRB0_HEAD) & HEAD_ADDR;
+		if (!IS_GEN6(dev))
+			ring->head = I915_READ(PRB0_HEAD) & HEAD_ADDR;
+		else {
+				int count = 0;
+				while (count++ < 50 && I915_READ(FORCEWAKE_ACK) & 1)
+					udelay(10);
+
+				I915_WRITE(FORCEWAKE, 1);
+				POSTING_READ(FORCEWAKE);
+
+				count = 0;
+				while (count++ < 50 && (I915_READ(FORCEWAKE_ACK) & 1) == 0)
+					udelay(10);
+
+				ring->head = I915_READ(PRB0_HEAD) & HEAD_ADDR;
+
+				I915_WRITE(FORCEWAKE, 0);
+				POSTING_READ(FORCEWAKE);
+		}
+
 		acthd = I915_READ(acthd_reg);
 		ring->space = ring->head - (ring->tail + 8);
 		if (ring->space < 0)
diff --git a/drivers/gpu/drm/i915/i915_reg.h b/drivers/gpu/drm/i915/i915_reg.h
index db84f98..258306b 100644
--- a/drivers/gpu/drm/i915/i915_reg.h
+++ b/drivers/gpu/drm/i915/i915_reg.h
@@ -2863,6 +2863,9 @@
 #define  EDP_LINK_TRAIN_800MV_0DB_SNB_B		(0x38<<22)
 #define  EDP_LINK_TRAIN_VOL_EMP_MASK_SNB	(0x3f<<22)
 
+#define  FORCEWAKE				0xA18C
+#define  FORCEWAKE_ACK				0x130090
+
 /* ILK always use 400mV 0dB for voltage swing and pre-emphasis level.
    SNB has different settings. */
 /* SNB A-stepping */
-- 
1.6.5.2

