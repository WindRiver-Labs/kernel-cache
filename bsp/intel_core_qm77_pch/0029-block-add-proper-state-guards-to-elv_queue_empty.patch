From 8a7020577ede03f842036b089448598130e8bf66 Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Wed, 4 Jan 2012 12:44:20 +0800
Subject: [V2 PATCH 2/2] block: add proper state guards to elv_queue_empty()

Upstream: https://lkml.org/lkml/2011/6/3/33

Like in 0a58e077eb600d1efd7e54ad9926a75a39d7f8ae (backported to
stable 2.6.38 as 0a58e077eb600d1efd7e54ad9926a75a39d7f8ae) which
fixes this for __elv_next_request(), as reported by Atsushi Nemoto,
elv_queue_empty() also needs to check for dead queue condition
before touchin elevator.

elv_queue_empty() has been removed upstream so this is only applicable
for versions prior to 2.6.39, including 2.6.32-longterm.

Signed-Off-By: Michael Tokarev <mjt@tls.msk.ru>
Integrated-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 block/elevator.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/block/elevator.c b/block/elevator.c
index 76e3702..5be39e5 100644
--- a/block/elevator.c
+++ b/block/elevator.c
@@ -751,7 +751,8 @@ int elv_queue_empty(struct request_queue *q)
 	if (!list_empty(&q->queue_head))
 		return 0;
 
-	if (e->ops->elevator_queue_empty_fn)
+	if (!test_bit(QUEUE_FLAG_DEAD, &q->queue_flags) &&
+	    e->ops->elevator_queue_empty_fn)
 		return e->ops->elevator_queue_empty_fn(q);
 
 	return 1;
-- 
1.7.5.4

