From de8fd5685781786217ac858a138c0be75713a422 Mon Sep 17 00:00:00 2001
From: Tony Liu <Bo.Liu@windriver.com>
Date: Tue, 30 Mar 2010 15:50:19 +0800
Subject: [PATCH 12/13] app3300-msbg: board specific implementation

Merge APP3300 MSBG board specific implementation and definition from
vendor drop -- Agere APP Linux Version 2.6.1.5.pre10 05/07/2009.

Signed-off-by: Tonyliu <Bo.Liu@windriver.com>
---
 arch/arm/mach-app/Kconfig       |    7 ++
 arch/arm/mach-app/Makefile      |    2 +
 arch/arm/mach-app/Makefile.boot |    5 ++
 arch/arm/mach-app/mach-app3k.c  |  119 +++++++++++++++++++++++++++++++++++++++
 arch/arm/tools/mach-types       |    1 +
 5 files changed, 134 insertions(+), 0 deletions(-)
 create mode 100644 arch/arm/mach-app/Makefile.boot
 create mode 100644 arch/arm/mach-app/mach-app3k.c

diff --git a/arch/arm/mach-app/Kconfig b/arch/arm/mach-app/Kconfig
index f03b589..c958f73 100644
--- a/arch/arm/mach-app/Kconfig
+++ b/arch/arm/mach-app/Kconfig
@@ -20,6 +20,13 @@ config ARCH_APP3K
 	bool "APP3300 family support"
 	depends on ARCH_APPXK
 
+config MACH_APP33OO_MSBG
+	bool "APP3300 MSBG board"
+	depends on ARCH_APP3K
+	help
+	  Include support for app3300 MSBG platform. This includes specific
+	  configurations for the board and its peripherals.
+
 endmenu
 
 endif
diff --git a/arch/arm/mach-app/Makefile b/arch/arm/mach-app/Makefile
index 9f5afd9..11005fa 100644
--- a/arch/arm/mach-app/Makefile
+++ b/arch/arm/mach-app/Makefile
@@ -3,3 +3,5 @@
 #
 
 obj-y := clock.o irq.o mm.o pll.o timer.o ubootenv.o
+
+obj-$(CONFIG_MACH_APP33OO_MSBG) += mach-app3k.o clk-app3k.o
diff --git a/arch/arm/mach-app/Makefile.boot b/arch/arm/mach-app/Makefile.boot
new file mode 100644
index 0000000..be12f26
--- /dev/null
+++ b/arch/arm/mach-app/Makefile.boot
@@ -0,0 +1,5 @@
+ifdef CONFIG_ARCH_APP3K
+  zreladdr-y        := 0x00008000
+params_phys-y       := 0x00000100
+initrd_phys-y       := 0x00800000
+endif
diff --git a/arch/arm/mach-app/mach-app3k.c b/arch/arm/mach-app/mach-app3k.c
new file mode 100644
index 0000000..f13c31d
--- /dev/null
+++ b/arch/arm/mach-app/mach-app3k.c
@@ -0,0 +1,119 @@
+/*
+ * linux/arch/arm/mach-app/mach-app3k.c
+ *
+ * Copyright (C) 2004 Agere Systems Inc.
+ * Copyright (c) 2010 Wind River Systems, Inc.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
+
+#include <linux/init.h>
+#include <linux/kernel.h>
+#include <linux/mm.h>
+#include <linux/irq.h>
+#include <linux/mtd/physmap.h>
+#include <linux/platform_device.h>
+#include <linux/amba/bus.h>
+#include <linux/amba/serial.h>
+#include <linux/mtd/mtd.h>
+#include <linux/mtd/map.h>
+#include <linux/mtd/partitions.h>
+
+#include <asm/mach/flash.h>
+#include <asm/mach-types.h>
+#include <asm/mach/arch.h>
+#include <mach/hardware.h>
+#include <mach/irqs.h>
+#include <mach/common.h>
+
+static struct mtd_partition app3k_nor_partitions[] = {
+	{
+		.name	= "u-boot",
+		.size	= 0x80000,
+		.offset	= 0,
+		.mask_flags = MTD_WRITEABLE,
+	},
+	{
+		.name	= "u-boot-env-0",
+		.size	= 0x40000,
+		.offset	= 0x80000,
+		.mask_flags = MTD_WRITEABLE,
+	},
+	{
+		.name	= "u-boot-env-1",
+		.size	= 0x40000,
+		.offset	= 0xc0000,
+		.mask_flags = MTD_WRITEABLE,
+	},
+	{
+		.name	= "user partition",
+		.size	= MTDPART_SIZ_FULL,
+		.offset	= MTDPART_OFS_APPEND,
+	},
+};
+
+static struct flash_platform_data app3k_flash_data = {
+	.map_name = "cfi_probe",
+	.width = 1,
+	.parts = app3k_nor_partitions,
+	.nr_parts = ARRAY_SIZE(app3k_nor_partitions),
+};
+
+static struct resource app3k_flash_res = {
+	.start	= APP3K_PHYS_NOR_BASE,
+	.end	= APP3K_PHYS_NOR_BASE + APP_NOR_SIZE,
+	.flags	= IORESOURCE_MEM,
+};
+
+static struct platform_device app3k_flash_dev = {
+	.name = "app3k-flash-nor",
+	.dev = {
+		.platform_data = &app3k_flash_data,
+	},
+	.num_resources = 1,
+	.resource = &app3k_flash_res,
+};
+
+static struct amba_device uart0_device = {
+	.dev	= {
+		.init_name = "amba:uart0",
+	},
+	.res	= {
+		.start	= APP3K_PHYS_UART_BASE,
+		.end	= APP3K_PHYS_UART_BASE + 0xfff,
+		.flags	= IORESOURCE_MEM,
+	},
+	.irq		= {INT_SERIAL, NO_IRQ},
+	.periphid	= 0x00041011,
+};
+
+static void app3k_mach_init(void)
+{
+	/*register amba device*/
+	amba_device_register(&uart0_device, &iomem_resource);
+
+	/*register platform devices*/
+	platform_device_register(&app3k_flash_dev);
+}
+
+MACHINE_START(APP33OO_MSBG, "LSI APP3300 MSBG")
+	.phys_io     = APP_STARTUP_PHYS_IO,
+	.io_pg_offst = ((APP_STARTUP_IO) >> 18) & 0xfffc,
+	.boot_params = APP_PHYS_RAM_BASE + 0x100,
+	.map_io      = app_map_io,
+	.init_irq    = app_init_irq_gic,
+	.init_machine	= app3k_mach_init,
+	.timer       = &app_timer,
+MACHINE_END
diff --git a/arch/arm/tools/mach-types b/arch/arm/tools/mach-types
index 1536f17..9d4045d 100644
--- a/arch/arm/tools/mach-types
+++ b/arch/arm/tools/mach-types
@@ -471,6 +471,7 @@ eb67xdip		MACH_EB67XDIP		EB67XDIP		454
 webtxs			MACH_WEBTXS		WEBTXS			455
 hawk			MACH_HAWK		HAWK			456
 ccat91sbc001		MACH_CCAT91SBC001	CCAT91SBC001		457
+app3300_msbg	MACH_APP33OO_MSBG	APP33OO_MSBG	457
 expresso		MACH_EXPRESSO		EXPRESSO		458
 h4000			MACH_H4000		H4000			459
 dino			MACH_DINO		DINO			460
-- 
1.6.5.2

