From 191e7a0ccdafe3616615b288d3e5115dcd97cfe5 Mon Sep 17 00:00:00 2001
From: Tony Liu <Bo.Liu@windriver.com>
Date: Tue, 18 May 2010 12:56:28 +0800
Subject: [PATCH 4/7] lsi_app3k: SMP local timer

Each MP11 CPU has a local timer as clockevent device, the local timer can
be accessed at the same address for software coherency through all MP11 CPUs.
The SCU is responsible for redirecting MP11 CPU access to the correct local
timer depending on its ID.
Add local timer kernel config and standard setup routine to hook into ARM
mature TWD local timer framework.

Signed-off-by: Tony Liu <Bo.Liu@windriver.com>
---
 arch/arm/Kconfig                        |    5 +++--
 arch/arm/mach-app/include/mach/timers.h |    3 +++
 arch/arm/mach-app/localtimer.c          |   27 +++++++++++++++++++++++++++
 arch/arm/mach-app/timer.c               |    6 ++++++
 4 files changed, 39 insertions(+), 2 deletions(-)
 create mode 100644 arch/arm/mach-app/localtimer.c

diff --git a/arch/arm/Kconfig b/arch/arm/Kconfig
index fcc7cba..0509da7 100644
--- a/arch/arm/Kconfig
+++ b/arch/arm/Kconfig
@@ -1177,9 +1177,10 @@ config HOTPLUG_CPU
 config LOCAL_TIMERS
 	bool "Use local timer interrupts"
 	depends on SMP && (REALVIEW_EB_ARM11MP || MACH_REALVIEW_PB11MP || \
-		REALVIEW_EB_A9MP || MACH_REALVIEW_PBX || ARCH_OMAP4 || ARCH_U8500)
+		REALVIEW_EB_A9MP || MACH_REALVIEW_PBX || ARCH_OMAP4 || ARCH_U8500 ||\
+		ARCH_APP3K)
 	default y
-	select HAVE_ARM_TWD if (ARCH_REALVIEW || ARCH_OMAP4 || ARCH_U8500)
+	select HAVE_ARM_TWD if (ARCH_REALVIEW || ARCH_OMAP4 || ARCH_U8500 || ARCH_APP3K)
 	help
 	  Enable support for local timers on SMP platforms, rather then the
 	  legacy IPI broadcast method.  Local timers allows the system
diff --git a/arch/arm/mach-app/include/mach/timers.h b/arch/arm/mach-app/include/mach/timers.h
index 9c257ce..a1285ac 100644
--- a/arch/arm/mach-app/include/mach/timers.h
+++ b/arch/arm/mach-app/include/mach/timers.h
@@ -78,4 +78,7 @@
 /* -- Background Load -- */
 #define TIMER_n_BACKGROUND_LOAD 0x18
 
+#define TWD_OFFSET 0x600
+#define TWD_BASE (APP_PMR_BASE + TWD_OFFSET)
+
 #endif /*__ASM_ARCH_TIMERS_H*/
diff --git a/arch/arm/mach-app/localtimer.c b/arch/arm/mach-app/localtimer.c
new file mode 100644
index 0000000..99d97b9
--- /dev/null
+++ b/arch/arm/mach-app/localtimer.c
@@ -0,0 +1,27 @@
+/* arch/arm/mach-app/localtimer.c
+ *
+ * Copyright (c) 2010 Wind River Systems, Inc.
+ *
+ * This file is based on arm realview smp platform file.
+ * Copyright (C) 2002 ARM Ltd.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ */
+#include <linux/init.h>
+#include <linux/smp.h>
+#include <linux/clockchips.h>
+
+#include <asm/irq.h>
+#include <asm/smp_twd.h>
+#include <asm/localtimer.h>
+
+/*
+ * Setup the local clock events for a CPU.
+ */
+void __cpuinit local_timer_setup(struct clock_event_device *evt)
+{
+    evt->irq = INT_LOCALTIMER;
+    twd_timer_setup(evt);
+}
diff --git a/arch/arm/mach-app/timer.c b/arch/arm/mach-app/timer.c
index bdc8e91..b972b28 100644
--- a/arch/arm/mach-app/timer.c
+++ b/arch/arm/mach-app/timer.c
@@ -43,6 +43,8 @@
 #include <linux/cpumask.h>
 
 #include <asm/mach/time.h>
+#include <asm/smp_twd.h>
+
 #include <mach/hardware.h>
 #include <mach/common.h>
 #include <mach/timers.h>
@@ -171,6 +173,10 @@ static void __init app_clocksource_init(void)
 
 static inline void __cpuinit app_timer_init(void)
 {
+#ifdef CONFIG_LOCAL_TIMERS
+	/*local timer base address*/
+	twd_base = TWD_BASE;
+#endif
 	__raw_writel(0, (TIMER0_BASE + TIMER_n_CONTROL));
 
 	setup_irq(INT_CT, &app_timer_irq);
-- 
1.6.5.2

