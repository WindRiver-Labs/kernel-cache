From 7fbb21f0f3e2dc1585d19f55a2b09a60fa800d33 Mon Sep 17 00:00:00 2001
From: Tony Liu <Bo.Liu@windriver.com>
Date: Mon, 5 Jul 2010 13:10:15 +0800
Subject: [PATCH] arm11mp: enable oprofile for lsi_app3300

For ARM11MP SoC, there is additional PMU in SCU  besides classic PMUs
in each core's CP15. All the PMUs should raise interrupt by PMUIRQ[11:0]
to the core according to "ARM11 MPCore Processor Technical Reference Manual".

But in LSI app3300 implementation, PMUIRQ[11:0] are not connected to
anything, so the PMU interrupts will not be sensed by the MPCore or any
other interrupt block on the app3300.

Since there is no hardware PMU interrupt can be captured by the MPcore, the
oprofile timer mode has to be used.

The MPCore oprofile implementation is tightly coupled with ARM realview
platform, It has to be generalized to be applied to other ARM MPcore platform.

Although app3300 has no functional hardware PMU, all ARM MPcore oprofile
prerequisite elements has to be supported to build it successfully.

Signed-off-by: Tonyliu <Bo.Liu@windriver.com>
---
 arch/arm/mach-app/include/mach/app3k.h |    4 ++++
 arch/arm/mach-app/include/mach/irqs.h  |    8 ++++++++
 arch/arm/mach-app/irq.c                |    8 +++++++-
 arch/arm/oprofile/op_model_mpcore.c    |    3 +--
 4 files changed, 20 insertions(+), 3 deletions(-)

diff --git a/arch/arm/mach-app/include/mach/app3k.h b/arch/arm/mach-app/include/mach/app3k.h
index f564221..75175e2 100644
--- a/arch/arm/mach-app/include/mach/app3k.h
+++ b/arch/arm/mach-app/include/mach/app3k.h
@@ -215,6 +215,10 @@
 #define APP_PMR_SIZE	0x00002000
 #define APP_PMR_BASE	(IO_ADDRESS + APP_PMR_OFFSET)
 
+#ifdef CONFIG_OPROFILE_MPCORE
+#define ARM11MP_SCU_BASE APP_PMR_BASE
+#endif
+
 /*
  * NAND
  */
diff --git a/arch/arm/mach-app/include/mach/irqs.h b/arch/arm/mach-app/include/mach/irqs.h
index 901ef42..28d14e9 100644
--- a/arch/arm/mach-app/include/mach/irqs.h
+++ b/arch/arm/mach-app/include/mach/irqs.h
@@ -25,6 +25,14 @@
 /*
  * Interrupt numbers
  */
+#define IRQ_EB11MP_PMU_SCU0	17
+#define IRQ_EB11MP_PMU_SCU1	18
+#define IRQ_EB11MP_PMU_SCU2	19
+#define IRQ_EB11MP_PMU_SCU3	20
+#define IRQ_EB11MP_PMU_SCU4	21
+#define IRQ_EB11MP_PMU_SCU5	22
+#define IRQ_EB11MP_PMU_SCU6	23
+#define IRQ_EB11MP_PMU_SCU7	24
 #define INT_LOCALTIMER     29
 #define INT_LOCALWATCHDOG  30
 
diff --git a/arch/arm/mach-app/irq.c b/arch/arm/mach-app/irq.c
index a7f24e9..41b616c 100644
--- a/arch/arm/mach-app/irq.c
+++ b/arch/arm/mach-app/irq.c
@@ -22,13 +22,19 @@
 #include <asm/hardware/gic.h>
 #include <mach/hardware.h>
 #include <mach/common.h>
+#include <mach/irqs.h>
 
+#ifdef CONFIG_OPROFILE_MPCORE
+#define BASE_IRQ_NUM	IRQ_EB11MP_PMU_SCU0
+#else
+#define BASE_IRQ_NUM	INT_LOCALTIMER
+#endif
 /*duplicated GIC base address of CPU interface registers*/
 void __iomem *gic_cpu_base_addr;
 
 void __init app_init_irq_gic(void)
 {
-	gic_dist_init(0, (void __iomem *)(APP_PMR_BASE + 0x1000), 29);
+	gic_dist_init(0, (void __iomem *)(APP_PMR_BASE + 0x1000), BASE_IRQ_NUM);
 
 	gic_cpu_base_addr = (void __iomem *)(APP_PMR_BASE + 0x100);
 	gic_cpu_init(0, gic_cpu_base_addr);
diff --git a/arch/arm/oprofile/op_model_mpcore.c b/arch/arm/oprofile/op_model_mpcore.c
index f73ce87..64aeb49 100644
--- a/arch/arm/oprofile/op_model_mpcore.c
+++ b/arch/arm/oprofile/op_model_mpcore.c
@@ -42,7 +42,6 @@
 #include <asm/irq.h>
 #include <asm/mach/irq.h>
 #include <mach/hardware.h>
-#include <mach/board-eb.h>
 #include <asm/system.h>
 #include <asm/pmu.h>
 
@@ -54,7 +53,7 @@
 /*
  * MPCore SCU event monitor support
  */
-#define SCU_EVENTMONITORS_VA_BASE __io_address(REALVIEW_EB11MP_SCU_BASE + 0x10)
+#define SCU_EVENTMONITORS_VA_BASE (ARM11MP_SCU_BASE + 0x10)
 
 /*
  * Bitmask of used SCU counters
-- 
1.6.5.2

