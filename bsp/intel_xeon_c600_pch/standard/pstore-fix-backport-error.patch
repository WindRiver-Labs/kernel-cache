From bf1b9f5f284bc656f571784dca14f1ce1aea689e Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Wed, 28 Dec 2011 10:03:26 +0800
Subject: [PATCH 334/474] pstore: fix backport error

modify pstore drivers to make it work on kernel 2.6.34

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 fs/pstore/inode.c    |   14 ++++++--------
 fs/pstore/platform.c |    1 -
 2 files changed, 6 insertions(+), 9 deletions(-)

diff --git a/fs/pstore/inode.c b/fs/pstore/inode.c
index 379a02d..0e7246d 100644
--- a/fs/pstore/inode.c
+++ b/fs/pstore/inode.c
@@ -85,12 +85,11 @@ static int pstore_unlink(struct inode *dir, struct dentry *dentry)
 	return simple_unlink(dir, dentry);
 }
 
-static void pstore_evict_inode(struct inode *inode)
+static void pstore_clear_inode(struct inode *inode)
 {
 	struct pstore_private	*p = inode->i_private;
 	unsigned long		flags;
 
-	end_writeback(inode);
 	if (p) {
 		spin_lock_irqsave(&allpstore_lock, flags);
 		list_del(&p->list);
@@ -110,7 +109,6 @@ static struct inode *pstore_get_inode(struct super_block *sb,
 	struct inode *inode = new_inode(sb);
 
 	if (inode) {
-		inode->i_ino = get_next_ino();
 		inode->i_uid = inode->i_gid = 0;
 		inode->i_mode = mode;
 		inode->i_atime = inode->i_mtime = inode->i_ctime = CURRENT_TIME;
@@ -172,7 +170,7 @@ static int pstore_remount(struct super_block *sb, int *flags, char *data)
 static const struct super_operations pstore_ops = {
 	.statfs		= simple_statfs,
 	.drop_inode	= generic_delete_inode,
-	.evict_inode	= pstore_evict_inode,
+	.clear_inode	= pstore_clear_inode,
 	.remount_fs	= pstore_remount,
 	.show_options	= generic_show_options,
 };
@@ -317,10 +315,10 @@ fail:
 	return err;
 }
 
-static struct dentry *pstore_mount(struct file_system_type *fs_type,
-	int flags, const char *dev_name, void *data)
+static int pstore_get_sb(struct file_system_type *fs_type,
+	int flags, const char *dev_name, void *data, struct vfsmount *mnt)
 {
-	return mount_single(fs_type, flags, data, pstore_fill_super);
+	return get_sb_single(fs_type, flags, data, pstore_fill_super, mnt);
 }
 
 static void pstore_kill_sb(struct super_block *sb)
@@ -331,7 +329,7 @@ static void pstore_kill_sb(struct super_block *sb)
 
 static struct file_system_type pstore_fs_type = {
 	.name		= "pstore",
-	.mount		= pstore_mount,
+	.get_sb		= pstore_get_sb,
 	.kill_sb	= pstore_kill_sb,
 };
 
diff --git a/fs/pstore/platform.c b/fs/pstore/platform.c
index 57bbf90..acf7816 100644
--- a/fs/pstore/platform.c
+++ b/fs/pstore/platform.c
@@ -17,7 +17,6 @@
  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  */
 
-#include <linux/atomic.h>
 #include <linux/types.h>
 #include <linux/errno.h>
 #include <linux/init.h>
-- 
1.7.0

