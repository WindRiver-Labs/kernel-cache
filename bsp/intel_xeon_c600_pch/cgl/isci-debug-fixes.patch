From a68ead98774b79e59048c940735493c8f2280ca6 Mon Sep 17 00:00:00 2001
From: Dan Williams <dan.j.williams@intel.com>
Date: Fri, 18 Feb 2011 09:25:15 -0800
Subject: [PATCH 019/479] isci: debug fixes

upstream: 83f5eeef59581faed6f002432bafe24da8cbf401

Some of the chain walks to get back to our dev are invalid.

isci_remote_device_change_state: delete rather than adding conditional deref
chain walking
isci_request_change_state: fix, it was being called too early
isci_request_ssp_io_request_get_lun: fix compile breakage hidden by ifdef DEBUG

Signed-off-by: Maciej Trela <maciej.trela@intel.com>
Signed-off-by: Dan Williams <dan.j.williams@intel.com>

Integrated-by: Hui Wang <Hui.Wang@windriver.com>
---
 drivers/scsi/isci/remote_device.c |    6 ------
 drivers/scsi/isci/request.c       |    6 +++---
 2 files changed, 3 insertions(+), 9 deletions(-)

diff --git a/drivers/scsi/isci/remote_device.c b/drivers/scsi/isci/remote_device.c
index 936f229..dec9033 100644
--- a/drivers/scsi/isci/remote_device.c
+++ b/drivers/scsi/isci/remote_device.c
@@ -686,12 +686,6 @@ void isci_remote_device_change_state(
 {
 	unsigned long flags;
 
-	dev_dbg(&isci_device->isci_port->isci_host->pdev->dev,
-		"%s: isci_device = %p, state = 0x%x",
-		__func__,
-		isci_device,
-		status);
-
 	spin_lock_irqsave(&isci_device->state_lock, flags);
 	isci_device->status = status;
 	spin_unlock_irqrestore(&isci_device->state_lock, flags);
diff --git a/drivers/scsi/isci/request.c b/drivers/scsi/isci/request.c
index f7ba047..81a7733 100644
--- a/drivers/scsi/isci/request.c
+++ b/drivers/scsi/isci/request.c
@@ -285,7 +285,6 @@ static int isci_request_alloc_core(
 
 	/* initialize the request object.	*/
 	spin_lock_init(&request->state_lock);
-	isci_request_change_state(request, allocated);
 	request->sci_request_mem_ptr = ((u8 *)request) +
 				       sizeof(struct isci_request);
 	request->request_daddr = handle;
@@ -302,6 +301,7 @@ static int isci_request_alloc_core(
 	INIT_LIST_HEAD(&request->dev_node);
 
 	*isci_request = request;
+	isci_request_change_state(request, allocated);
 
 	return ret;
 }
@@ -1389,8 +1389,8 @@ u32 isci_request_ssp_io_request_get_lun(
 
 	for (i = 0; i < 8; i++)
 		dev_dbg(&request->isci_host->pdev->dev,
-			"%s: request->task->ssp_task.LUN[%d] = %x\n",
-			__func__, i, request->task->ssp_task.LUN[i]);
+			"%s: task->ssp_task.LUN[%d] = %x\n",
+			__func__, i, task->ssp_task.LUN[i]);
 
 #endif
 
-- 
1.7.0

