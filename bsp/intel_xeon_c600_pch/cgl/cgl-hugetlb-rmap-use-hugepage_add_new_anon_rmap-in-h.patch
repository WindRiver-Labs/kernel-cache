From 432c46e458bb0b3a253cbb99af1be8677bdd1bac Mon Sep 17 00:00:00 2001
From: Naoya Horiguchi <n-horiguchi@ah.jp.nec.com>
Date: Fri, 10 Sep 2010 13:23:04 +0900
Subject: [PATCH 437/479] cgl hugetlb, rmap: use hugepage_add_new_anon_rmap() in hugetlb_cow()

commit cd67f0d2a9a6b5b9f79f4343dc8805757d9ebae2 upstream

Obviously, setting anon_vma for COWed hugepage should be done
by hugepage_add_new_anon_rmap() to scan vmas faster.
This patch fixes it.

Signed-off-by: Naoya Horiguchi <n-horiguchi@ah.jp.nec.com>
Acked-by: Andrea Arcangeli <aarcange@redhat.com>
Reviewed-by: Rik van Riel <riel@redhat.com>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
[context adjustment]
Integrated-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 mm/hugetlb.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/mm/hugetlb.c b/mm/hugetlb.c
index eaaa1d8..386773d 100644
--- a/mm/hugetlb.c
+++ b/mm/hugetlb.c
@@ -2514,7 +2514,7 @@ retry_avoidcopy:
 		set_huge_pte_at(mm, address, ptep,
 				make_huge_pte(vma, new_page, 1));
 		page_remove_rmap(old_page);
-		hugepage_add_anon_rmap(new_page, vma, address);
+		hugepage_add_new_anon_rmap(new_page, vma, address);
 
 #ifdef CONFIG_PAX_SEGMEXEC
 		pax_mirror_huge_pte(vma, address, new_page);
-- 
1.7.0

