From f50863044dfb88a6d887d035be025e83d13cc60f Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Thu, 29 Mar 2012 11:17:13 +0800
Subject: [PATCH 462/479] rcu: fix build error when CONFIG_PROVE_RCU is enabled

error appears when CONFIG_PROVE_RCU is enabled:
arch/x86/kernel/cpu/mcheck/mce.c:161: error: implicit declaration of
function '__do_rcu_dereference_check'

Grab fix from upstream commit
2b3fc35f6919344e3cf722dde8308f47235c0b70

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 include/linux/rcupdate.h |   18 +++++++++++++-----
 1 files changed, 13 insertions(+), 5 deletions(-)

diff --git a/include/linux/rcupdate.h b/include/linux/rcupdate.h
index 5d6feec..aa90078 100644
--- a/include/linux/rcupdate.h
+++ b/include/linux/rcupdate.h
@@ -237,8 +237,7 @@ extern int rcu_my_thread_group_empty(void);
  */
 #define rcu_dereference_check(p, c) \
 	({ \
-		if (debug_lockdep_rcu_enabled() && !(c)) \
-			lockdep_rcu_dereference(__FILE__, __LINE__); \
+		__do_rcu_dereference_check(c); \
 		rcu_dereference_raw(p); \
 	})
 
@@ -255,8 +254,7 @@ extern int rcu_my_thread_group_empty(void);
  */
 #define rcu_dereference_protected(p, c) \
 	({ \
-		if (debug_lockdep_rcu_enabled() && !(c)) \
-			lockdep_rcu_dereference(__FILE__, __LINE__); \
+		__do_rcu_dereference_check(c); \
 		(p); \
 	})
 
@@ -584,7 +582,17 @@ static inline void debug_rcu_head_unqueue(struct rcu_head *head)
 }
 #endif	/* #else !CONFIG_DEBUG_OBJECTS_RCU_HEAD */
 
-#ifndef CONFIG_PROVE_RCU
+#ifdef CONFIG_PROVE_RCU
+#define __do_rcu_dereference_check(c)					\
+	do {								\
+		static bool __warned;					\
+		if (debug_lockdep_rcu_enabled() && !__warned && !(c)) {	\
+			__warned = true;				\
+			lockdep_rcu_dereference(__FILE__, __LINE__);	\
+		}							\
+	} while (0)
+
+#else
 #define __do_rcu_dereference_check(c) do { } while (0)
 #endif /* #ifdef CONFIG_PROVE_RCU */
 
-- 
1.7.0

