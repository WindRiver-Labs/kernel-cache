From adefaab37b8cce8c2a5ef2a53d70579d71d0fdd9 Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Thu, 3 May 2012 14:08:18 +0800
Subject: [PATCH 187/478] pm: disable device async suspend and resume in preempt_rt

suspend to ram always fails in preempt_rt when device is async
suspended and resumed, so turn it off manually as a workaround.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 kernel/power/main.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/kernel/power/main.c b/kernel/power/main.c
index b58800b..6bb4af7 100644
--- a/kernel/power/main.c
+++ b/kernel/power/main.c
@@ -45,6 +45,12 @@ int pm_notifier_call_chain(unsigned long val)
 }
 
 /* If set, devices may be suspended and resumed asynchronously. */
+#ifdef CONFIG_PREEMPT_RT
+/* devices can't be suspended and resumed asynchronously in preempt_rt
+ * kernel, just disable it here
+ */
+int pm_async_enabled = 0;
+#else
 int pm_async_enabled = 1;
 
 static ssize_t pm_async_show(struct kobject *kobj, struct kobj_attribute *attr,
@@ -69,6 +75,7 @@ static ssize_t pm_async_store(struct kobject *kobj, struct kobj_attribute *attr,
 }
 
 power_attr(pm_async);
+#endif
 
 #ifdef CONFIG_PM_DEBUG
 int pm_test_level = TEST_NONE;
@@ -235,7 +242,9 @@ static struct attribute * g[] = {
 	&pm_trace_attr.attr,
 #endif
 #ifdef CONFIG_PM_SLEEP
+#ifndef CONFIG_PREEMPT_RT
 	&pm_async_attr.attr,
+#endif
 #ifdef CONFIG_PM_DEBUG
 	&pm_test_attr.attr,
 #endif
-- 
1.7.0

