From fec2413875043c36272efbc4814e0416c8782fe4 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Wed, 22 Feb 2012 17:44:55 +0800
Subject: [PATCH 14/16] kbc_km2m806: fix pca95xx-irq thread can not run

Since the kernel thread is created by kthread_create function, the thread
do not use wake_up_process to wakeup it. kthread_run implement the same
effect with kthread_cread and wake_up_process.`

INFO: task pca95xx-irq:66 blocked for more than 120 seconds.
"echo 0 > /proc/sys/kernel/hung_task_timeout_secs" disables this message.
pca95xx-irq   D df3a9fac     0    66      2 0x00000000
 df3a9fbc 00000046 00000002 df3a9fac 00000001 df207560 00000000 df3a9f7c
 c1030dab fffedd00 c1027b70 0002fbdc c186d980 c1866000 c186d980 df2076f8
 df207560 c15e5885 df3a9fbc c102af99 00000000 00000001 df02fbcc c190b674
Call Trace:
 [<c1030dab>] ? default_wake_function+0xb/0x10
 [<c1027b70>] ? __wake_up_common+0x40/0x70
 [<c15e5885>] ? _raw_spin_unlock_irqrestore+0x25/0x30
 [<c102af99>] ? complete+0x49/0x60
 [<c12b02b0>] ? pca95xx_gpe_test_chips+0x0/0x120
 [<c1057606>] kthread+0x56/0x80
 [<c10575b0>] ? kthread+0x0/0x80
 [<c1003276>] kernel_thread_helper+0x6/0x30

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/gpio/pca953x.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/gpio/pca953x.c b/drivers/gpio/pca953x.c
index 67386d6..72c9a62 100644
--- a/drivers/gpio/pca953x.c
+++ b/drivers/gpio/pca953x.c
@@ -517,7 +517,7 @@ static int pca95xx_gpe_test_chips(void *data)
 
 static int pca95xx_irq_thread_setup(void)
 {
-	pca95xx_irq_thread = kthread_create(pca95xx_gpe_test_chips,
+	pca95xx_irq_thread = kthread_run(pca95xx_gpe_test_chips,
 		fri2_chips, "pca95xx-irq");
 	if (IS_ERR(pca95xx_irq_thread))
 		return PTR_ERR(pca95xx_irq_thread);
-- 
1.7.0

