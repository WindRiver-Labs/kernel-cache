From e3d071ac5e44dba6b4e8c014b349baddbd7b6737 Mon Sep 17 00:00:00 2001
From: Fei Wu <fei.wu@windriver.com>
Date: Fri, 21 May 2010 11:28:26 +0800
Subject: [PATCH 45/47] update i2c to 6.1.1

A small fix to bring the device out of i2c cmd busy lockup when enabling
the controller

Signed-off-by: Fei Wu <fei.wu@windriver.com>
---
 drivers/i2c/busses/i2c-bcm11xx-hw.c |   16 +++++++++++++++-
 1 files changed, 15 insertions(+), 1 deletions(-)

diff --git a/drivers/i2c/busses/i2c-bcm11xx-hw.c b/drivers/i2c/busses/i2c-bcm11xx-hw.c
index 4d284a8..d77345a 100644
--- a/drivers/i2c/busses/i2c-bcm11xx-hw.c
+++ b/drivers/i2c/busses/i2c-bcm11xx-hw.c
@@ -727,6 +727,19 @@ static void bcm11xx_i2c_enable_controller(struct bcm11xx_i2c *i2c)
 	I2CHw_Init();
 #endif
 
+	/* The following lines were added so that calling this function will bring
+	 * the device out of i2c cmd busy lockup.
+	 */
+	
+	/* Set the I2C host controller reset bit 19 to high to reset the I2C host. */
+#if defined( CONFIG_ARCH_BCMRING )   
+	chipcHw_softResetEnable(chipcHw_REG_SOFT_RESET_I2CH);
+	udelay(10);
+	/* Set the I2C host controller reset bit 19 to low to bring the the I2C host *
+	 * out of reset.                                                             */
+	chipcHw_softResetDisable(chipcHw_REG_SOFT_RESET_I2CH);
+#endif   
+
 	REG_I2C_CS = REG_I2C_CS_SDA | REG_I2C_CS_SCL;	/* reset controller (EN=0) */
 	REG_I2C_RCM = 0;				/* disable CRC */
 #if defined(CONFIG_ARCH_BCMRING)
@@ -762,7 +775,8 @@ static struct i2c_adapter bcm11xx_ops = {
 	.id = I2C_HW_B_BCM11XX,
 	.algo = &bcm11xx_algo,
 	.timeout = 1,
-	.retries = 1
+	.retries = 1,
+	.class = UINT_MAX,
 };
 
 /* Module initialization function */
-- 
1.7.0.4

