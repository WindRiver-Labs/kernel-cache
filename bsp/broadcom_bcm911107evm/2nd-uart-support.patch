From baf9291b8f15bc7bb35b1d9de6e96757179c3ca9 Mon Sep 17 00:00:00 2001
From: Fei Wu <fei.wu@windriver.com>
Date: Wed, 17 Mar 2010 19:39:37 +0800
Subject: [PATCH 40/47] 2nd uart support

As uart1 shares the gpio pins with other devices, set it to function
as uart at the start.

Original patch taken from broadcom SDK PhonexChange6.1

Signed-off-by: Fei Wu <fei.wu@windriver.com>
---
 arch/arm/mach-bcmring/core.c |   19 +++++++++++++++++++
 1 files changed, 19 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-bcmring/core.c b/arch/arm/mach-bcmring/core.c
index 0f0f033..b308a37 100644
--- a/arch/arm/mach-bcmring/core.c
+++ b/arch/arm/mach-bcmring/core.c
@@ -57,6 +57,7 @@
 #include <mach/csp/secHw_def.h>
 #include <mach/csp/chipcHw_inline.h>
 #include <mach/csp/tmrHw_reg.h>
+#include <mach/csp/gpiomux.h>
 
 #define AMBA_DEVICE(name, initname, base, plat, size)       \
 static struct amba_device name##_device = {     \
@@ -231,6 +232,24 @@ void __init bcmring_amba_init(void)
 
 	for (i = 0; i < ARRAY_SIZE(amba_devs); i++) {
 		struct amba_device *d = amba_devs[i];
+		if (strcmp(d->dev.init_name, "uartb") == 0) {
+			/* Need to request UART1's TX/RX gpio muxed pins */
+			gpiomux_rc_e status;
+			status = gpiomux_request(GPIO14_UART1_TXD,
+					chipcHw_GPIO_FUNCTION_UART,
+					"UART1 TXD");
+			if (status != gpiomux_rc_SUCCESS) {
+				printk(KERN_ERR "Failed to gpiomux_request for UART1_TXD\n");
+				continue;
+			}
+			status = gpiomux_request(GPIO15_UART1_RXD,
+					chipcHw_GPIO_FUNCTION_UART,
+					"UART1 RXD");
+			if (status != gpiomux_rc_SUCCESS) {
+				printk(KERN_ERR "Failed to gpiomux_request for UART1_RXD\n");
+				continue;
+			}
+		}
 		amba_device_register(d, &iomem_resource);
 	}
 
-- 
1.7.0.4

