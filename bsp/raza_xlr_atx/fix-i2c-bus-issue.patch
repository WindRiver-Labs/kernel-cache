From ef0ee8ace3c0fc1d384715d2488bc68b294c1a6c Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Thu, 17 Dec 2009 10:50:52 +0800
Subject: [PATCH] fix i2c bus issue

If the i2c read/write time is too short the rtc will fail.
So we increase the delay from 1ms to 16 for more reliable
operation.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 drivers/i2c/algos/i2c-algo-palm.c |   10 +++++-----
 1 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/drivers/i2c/algos/i2c-algo-palm.c b/drivers/i2c/algos/i2c-algo-palm.c
index a31d409..382c0d7 100644
--- a/drivers/i2c/algos/i2c-algo-palm.c
+++ b/drivers/i2c/algos/i2c-algo-palm.c
@@ -100,12 +100,12 @@ static int palm_tx(struct i2c_algo_palm_data *algo_data,  __u16 len,
 		palm_write(algo_data, I2C_PALM_DATAOUT, buf[ctr]);
 		palm_write(algo_data, I2C_PALM_STARTXFR, I2C_PALM_STARTXFR_WR );
 		spin_lock_irq(&palm_lock);
-		mdelay(0x1);
+		mdelay(16);
 		spin_unlock_irq(&palm_lock);
 		
 		regVal = palm_read(algo_data, I2C_PALM_STATUS);
 		spin_lock_irq(&palm_lock);
-		mdelay(0x01);
+		mdelay(16);
 		spin_unlock_irq(&palm_lock);
 		if (regVal & 0x0008) {
 			printk("palm_tx: ACKERR. Aborting...\n");
@@ -166,13 +166,13 @@ static int palm_rx(struct i2c_algo_palm_data *algo_data, __u16 len,
 	palm_write(algo_data, I2C_PALM_BYTECNT, len);
 	palm_write(algo_data, I2C_PALM_DEVADDR, addr); 
 	spin_lock_irq(&palm_lock);
-	mdelay(0x01);
+	mdelay(16);
 	spin_unlock_irq(&palm_lock);
 
 	for (numBytes=0x00; numBytes < len; numBytes++) {
 		palm_write(algo_data, I2C_PALM_ADDR,  offset+numBytes);	
 		spin_lock_irq(&palm_lock);
-		mdelay(0x01);
+		mdelay(16);
 		spin_unlock_irq(&palm_lock);
 		if (!ctr) {
 			/* Trigger a READ Transaction */
@@ -183,7 +183,7 @@ static int palm_rx(struct i2c_algo_palm_data *algo_data, __u16 len,
 		/* Error Conditions [Begin] */
 		regVal = palm_read(algo_data, I2C_PALM_STATUS);
 		spin_lock_irq(&palm_lock);
-		mdelay(0x01);
+		mdelay(16);
 		spin_unlock_irq(&palm_lock);
 		if (regVal & 0x0008) {
 			printk("palm_rx: ACKERR. Aborting...\n");
-- 
1.6.0.4

