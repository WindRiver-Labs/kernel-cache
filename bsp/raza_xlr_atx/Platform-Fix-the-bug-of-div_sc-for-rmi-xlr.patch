From 3031a0caa5bf5690d8e00bbfa3b9f83cf8bb0bc4 Mon Sep 17 00:00:00 2001
From: Liu Changhui <changhui.liu@windriver.com>
Date: Wed, 21 Apr 2010 09:39:39 +0800
Subject: [PATCH] Platform: Fix the bug of div_sc for rmi xlr

Add the fix for div_sc. For 1GHz (and lesser), div_sc returns zero if shift = 32.

source: from RMI SDK1.7

Signed-off-by: shuo.kang <shuo.kang@windriver.com>
---
 arch/mips/kernel/cevt-r4k.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/mips/kernel/cevt-r4k.c b/arch/mips/kernel/cevt-r4k.c
index 0de7a68..4368346 100644
--- a/arch/mips/kernel/cevt-r4k.c
+++ b/arch/mips/kernel/cevt-r4k.c
@@ -250,8 +250,14 @@ int __cpuinit mips_clockevent_init(void)
 	cd->features		= CLOCK_EVT_FEAT_ONESHOT;
 
 	/* Calculate the min / max delta */
+#ifdef CONFIG_RMI_PHOENIX
+	/* for 1GHz (and lesser), div_sc returns zero if shift = 32 */
+	cd->mult		= div_sc((unsigned long) mips_freq, NSEC_PER_SEC, 30);
+	cd->shift		= 30;
+#else
 	cd->mult	= div_sc((unsigned long) mips_freq, NSEC_PER_SEC, 32);
 	cd->shift		= 32;
+#endif
 	cd->max_delta_ns	= clockevent_delta2ns(0x7fffffff, cd);
 	cd->min_delta_ns	= clockevent_delta2ns(0x300, cd);
 
-- 
1.6.0.4

