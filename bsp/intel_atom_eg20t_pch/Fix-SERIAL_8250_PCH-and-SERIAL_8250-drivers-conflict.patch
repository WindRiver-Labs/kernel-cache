From d0c935412ad07a6cc0f562b56d05834f97091851 Mon Sep 17 00:00:00 2001
From: Jiang Bin <bin.jiang@windriver.com>
Date: Sat, 18 Jun 2011 09:56:22 +0800
Subject: [PATCH] Fix: SERIAL_8250_PCH and SERIAL_8250 drivers conflict

Some symbols in SERIAL_8250_PCH driver are exported with same names of
SERIAL_8250 driver. If enabling both drivers, kernel will fail to build.

When enabling both drivers, mask all conflicted symbols of SERIAL_8250_PCH
driver and use SERIAL_8250 driver for pch serial devices.

Signed-off-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/serial/8250_pch.c |    9 ++++++++-
 1 files changed, 8 insertions(+), 1 deletions(-)

diff --git a/drivers/serial/8250_pch.c b/drivers/serial/8250_pch.c
index db068a1..6cb1635 100644
--- a/drivers/serial/8250_pch.c
+++ b/drivers/serial/8250_pch.c
@@ -3586,6 +3586,7 @@ static int __init serial8250_console_init(void)
 }
 console_initcall(serial8250_console_init);
 
+#ifndef CONFIG_SERIAL_8250
 int serial8250_find_port(struct uart_port *p)
 {
 	int line;
@@ -3598,6 +3599,7 @@ int serial8250_find_port(struct uart_port *p)
 	}
 	return -ENODEV;
 }
+#endif
 
 #define SERIAL8250_CONSOLE	(&serial8250_console)
 #else
@@ -3613,6 +3615,7 @@ static struct uart_driver serial8250_reg = {
 	.cons			= SERIAL8250_CONSOLE,
 };
 
+#ifndef CONFIG_SERIAL_8250
 /*
  * early_serial_setup - early registration for 8250 ports
  *
@@ -3687,6 +3690,7 @@ void serial8250_resume_port(int line)
 	}
 	uart_resume_port(&serial8250_reg, &up->port);
 }
+#endif
 
 /*
  * Register a set of serial devices attached to a platform device.  The
@@ -3831,7 +3835,7 @@ static struct uart_8250_port *serial8250_find_match_or_unused(struct uart_port *
 
 	return NULL;
 }
-
+#ifndef CONFIG_SERIAL_8250
 /**
  *	serial8250_register_port - register a serial port
  *	@port: serial port template
@@ -3917,6 +3921,7 @@ void serial8250_unregister_port(int line)
 	mutex_unlock(&serial_mutex);
 }
 EXPORT_SYMBOL(serial8250_unregister_port);
+#endif
 
 static int __init serial8250_init(void)
 {
@@ -3989,11 +3994,13 @@ static void __exit serial8250_exit(void)
 #endif
 }
 
+#ifndef CONFIG_SERIAL_8250
 module_init(serial8250_init);
 module_exit(serial8250_exit);
 
 EXPORT_SYMBOL(serial8250_suspend_port);
 EXPORT_SYMBOL(serial8250_resume_port);
+#endif
 
 MODULE_LICENSE("GPL");
 MODULE_DESCRIPTION("Generic 8250/16x50 serial driver");
-- 
1.7.0.2

