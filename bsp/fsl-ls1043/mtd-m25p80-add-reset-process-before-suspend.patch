From f405581a2ef4fa83bb3785aa3adf796e0bf51974 Mon Sep 17 00:00:00 2001
From: Hou Zhiqiang <B48286@freescale.com>
Date: Thu, 21 May 2015 23:34:56 +0800
Subject: [PATCH 233/451] mtd: m25p80: add reset process before suspend

Make sure the SPI Flash into reset state.

Signed-off-by: Hou Zhiqiang <B48286@freescale.com>
Change-Id: I627606256571b80ba80a5a84a25b52685e799b0c
Reviewed-on: http://git.am.freescale.net:8181/36725
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Mingkai Hu <Mingkai.Hu@freescale.com>
Reviewed-by: Honghua Yin <Hong-Hua.Yin@freescale.com>
Signed-off-by: Mingkai Hu <Mingkai.Hu@freescale.com>
[Xulin: Original patch taken from
Linux-LS1043A-SDK-V0.4-SOURCE-20150826-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 drivers/mtd/devices/m25p80.c |   12 +++++++++---
 1 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/drivers/mtd/devices/m25p80.c b/drivers/mtd/devices/m25p80.c
index 7f81341..242c2ba 100644
--- a/drivers/mtd/devices/m25p80.c
+++ b/drivers/mtd/devices/m25p80.c
@@ -33,6 +33,8 @@
 
 #include <linux/spi/spi.h>
 #include <linux/spi/flash.h>
+#include <linux/mtd/spi-nor.h>
+#include <linux/delay.h>
 
 /* Flash opcodes. */
 #define	OPCODE_WREN		0x06	/* Write enable */
@@ -1359,9 +1361,13 @@ static int m25p_suspend(struct device *dev)
 	struct m25p *flash = dev_get_drvdata(dev);
 	struct spi_nor *nor = &flash->spi_nor;
 
-	/* Wait till previous write/erase is done. */
-	if (nor->wait_till_ready)
-		return nor->wait_till_ready(nor);
+	/*
+	 * A minimum de-selection time of 50ns must come between the
+	 * RESET ENABLE and RESET MEMORY commands
+	 */
+	m25p80_write_reg(nor, SPINOR_OP_RESET_EN, NULL, 0, 0);
+	ndelay(50);
+	m25p80_write_reg(nor, SPINOR_OP_RESET_MEM, NULL, 0, 0);
 
 	return 0;
 }
-- 
1.7.5.4

