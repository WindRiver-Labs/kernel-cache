From 900abedef577ff49a789814654cfe8f73808ed6f Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Thu, 1 Sep 2016 15:13:45 +0800
Subject: [PATCH 15/18] crypto: caam fix irq_disabled from the shared qman

WARNING: CPU: 0 PID: 1 at init/main.c:802 do_one_initcall+0x194/0x1b8()
initcall caam_driver_init+0x0/0x20 returned with disabled interrupts
Modules linked in:
CPU: 0 PID: 1 Comm: swapper/0 Tainted: G        W       4.1.21-rt13-WR8.0.0.0_preempt-rt #14
Hardware name: LS1043A RDB Board (DT)
Call trace:
[<ffff80000008a8f0>] dump_backtrace+0x0/0x138
[<ffff80000008aa48>] show_stack+0x20/0x28
[<ffff8000009d3ef0>] dump_stack+0xa4/0xe0
[<ffff8000000a2270>] warn_slowpath_common+0xb0/0xf4
[<ffff8000000a232c>] warn_slowpath_fmt+0x78/0x88
[<ffff8000000843f4>] do_one_initcall+0x194/0x1b8
[<ffff800000d08c14>] kernel_init_freeable+0x25c/0x32c
[<ffff8000009ce5e0>] kernel_init+0x20/0xe0

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/crypto/caam/ctrl.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/crypto/caam/ctrl.c b/drivers/crypto/caam/ctrl.c
index 3bbc225..dfa0d2c 100644
--- a/drivers/crypto/caam/ctrl.c
+++ b/drivers/crypto/caam/ctrl.c
@@ -742,6 +742,9 @@ static int caam_probe(struct platform_device *pdev)
 #endif
 	}
 
+#ifdef CONFIG_ARCH_LAYERSCAPE
+	local_irq_enable();
+#endif
 	/* If no QI and no rings specified, quit and go home */
 	if ((!ctrlpriv->qi_present) && (!ctrlpriv->total_jobrs)) {
 		dev_err(dev, "no queues configured, terminating\n");
-- 
2.7.4

