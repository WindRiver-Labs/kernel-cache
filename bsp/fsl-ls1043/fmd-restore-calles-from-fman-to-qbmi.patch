From 2e21a0c6cc67daacf6ae0c4ccfcba29d8909d4cb Mon Sep 17 00:00:00 2001
From: Mandy Lavi <mandy.lavi@freescale.com>
Date: Mon, 2 Feb 2015 16:21:07 +0200
Subject: [PATCH 144/451] fmd: restore calles from fman to qbmi

Signed-off-by: Mandy Lavi <mandy.lavi@freescale.com>
Change-Id: I7f0c2a6e332beb995160c4b4ee4484d2d9bd4263
Reviewed-on: http://git.am.freescale.net:8181/29888
Reviewed-by: Yang Li <LeoLi@freescale.com>
Tested-by: Yang Li <LeoLi@freescale.com>
[Xulin: Original patch taken from
Linux-LS1043A-SDK-V0.4-SOURCE-20150826-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 .../ethernet/freescale/fman/Peripherals/FM/fm.c    |    7 +-
 .../ethernet/freescale/fman/Peripherals/FM/fman.c  |    3 +-
 .../ethernet/freescale/fman/inc/cores/arm_ext.h    |   96 --------------------
 .../fman/inc/integrations/LS1043/part_ext.h        |    3 -
 .../net/ethernet/freescale/fman/ls1043_dflags.h    |    2 -
 .../freescale/fman/src/wrapper/lnxwrp_fm.c         |   22 +++---
 .../freescale/fman/src/wrapper/lnxwrp_fm_port.c    |   32 +++----
 7 files changed, 33 insertions(+), 132 deletions(-)

diff --git a/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c b/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c
index d5ddafb..888ddc4 100644
--- a/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c
+++ b/drivers/net/ethernet/freescale/fman/Peripherals/FM/fm.c
@@ -3306,7 +3306,8 @@ t_Handle FM_Config(t_FmParams *p_FmParam)
     p_Fm->f_Exception                           = p_FmParam->f_Exception;
     p_Fm->f_BusError                            = p_FmParam->f_BusError;
     p_Fm->p_FmFpmRegs = (struct fman_fpm_regs *)UINT_TO_PTR(baseAddr + FM_MM_FPM);
-printk("<><><><> FM_Config  base addr = 0x%x   FM_MM_FPM = 0x%x  \n", baseAddr, FM_MM_FPM);
+#warning remove below printk
+printk("<><><><> FM_Config  base addr = 0x%x   FM_MM_FPM = 0x%x\n", baseAddr, FM_MM_FPM);
 
     p_Fm->p_FmBmiRegs = (struct fman_bmi_regs *)UINT_TO_PTR(baseAddr + FM_MM_BMI);
     p_Fm->p_FmQmiRegs = (struct fman_qmi_regs *)UINT_TO_PTR(baseAddr + FM_MM_QMI);
@@ -3528,7 +3529,8 @@ t_Error FM_Init(t_Handle h_Fm)
 		CORE_MemoryBarrier();
 		XX_UDelay(100);
 //	}
-printk("IIIIII AMMMMMM HERE 13\n");
+#warning remove printk below
+printk("<><> Fman reset passed. Hack not required\n");
 
         if (fman_is_qmi_halt_not_busy_state(p_Fm->p_FmQmiRegs))
         {
@@ -3541,6 +3543,7 @@ printk("IIIIII AMMMMMM HERE 13\n");
     /* Load FMan-Controller code to IRAM */
     /*************************************/
 #warning skipping ucode load
+printk("<><> fmd: skipping ucode load\n");
 #if 0 /* skipping ucode load */
     if (ClearIRam(p_Fm) != E_OK)
         RETURN_ERROR(MAJOR, E_INVALID_STATE, NO_MSG);
diff --git a/drivers/net/ethernet/freescale/fman/Peripherals/FM/fman.c b/drivers/net/ethernet/freescale/fman/Peripherals/FM/fman.c
index 319d997..278752b 100755
--- a/drivers/net/ethernet/freescale/fman/Peripherals/FM/fman.c
+++ b/drivers/net/ethernet/freescale/fman/Peripherals/FM/fman.c
@@ -1292,7 +1292,8 @@ tmp = 0xa070603;
 	*major = (uint8_t)((tmp & FPM_REV1_MAJOR_MASK) >> FPM_REV1_MAJOR_SHIFT);
 	*minor = (uint8_t)((tmp & FPM_REV1_MINOR_MASK) >> FPM_REV1_MINOR_SHIFT);
 
-printk("++++++fman_get_version fm_ip_rev = 0x%x  major = 0x%x  minor = 0x%x \n",tmp,*major, *minor);
+printk("++fmd: fman_get_version fm_ip_rev=0x%x major=0x%x minor=0x%x\n",tmp,*major,*minor);
+printk("++fmd: fake version number need to retrive the original one\n");
 
 }
 
diff --git a/drivers/net/ethernet/freescale/fman/inc/cores/arm_ext.h b/drivers/net/ethernet/freescale/fman/inc/cores/arm_ext.h
index 6952920..e63444a 100644
--- a/drivers/net/ethernet/freescale/fman/inc/cores/arm_ext.h
+++ b/drivers/net/ethernet/freescale/fman/inc/cores/arm_ext.h
@@ -52,100 +52,4 @@ static __inline__ void CORE_MemoryBarrier(void)
 	mb();
 }
 
-
-
-#warning we may want to remove the section below
-#if 0
-
-#if defined(CORE_E300) || defined(CORE_E500V2)
-#define CORE_CACHELINE_SIZE     32
-#elif defined(CORE_E500MC) || defined(CORE_E5500) || defined(CORE_E6500)
-#define CORE_CACHELINE_SIZE     64
-#else
-#error "Core not defined!"
-#endif /* defined(CORE_E300) || ... */
-
-
-/**************************************************************************//**
- @Function      CORE_TestAndSet
-
- @Description   This routine tries to atomically test-and-set an integer
-                in memory to a non-zero value.
-
-                The memory will be set only if it is tested as zero, in which
-                case the routine returns the new non-zero value; otherwise the
-                routine returns zero.
-
- @Param[in]     p - pointer to a volatile int in memory, on which test-and-set
-                    operation should be made.
-
- @Retval        Zero        - Operation failed - memory was already set.
- @Retval        Non-zero    - Operation succeeded - memory has been set.
-*//***************************************************************************/
-int CORE_TestAndSet(volatile int *p);
-
-/**************************************************************************//**
- @Function      CORE_InstructionSync
-
- @Description   This routine will cause the core to wait for previous instructions
-                (including any interrupts they generate) to complete before the
-                synchronization command executes, which purges all instructions
-                from the processor's pipeline and refetches the next instruction.
-
- @Return        None.
-*//***************************************************************************/
-void CORE_InstructionSync(void);
-
-/**************************************************************************//**
- @Function      CORE_DCacheEnable
-
- @Description   Enables the data cache for memory pages that are
-                not cache inhibited.
-
- @Return        None.
-*//***************************************************************************/
-void CORE_DCacheEnable(void);
-
-/**************************************************************************//**
- @Function      CORE_ICacheEnable
-
- @Description   Enables the instruction cache for memory pages that are
-                not cache inhibited.
-
- @Return        None.
-*//***************************************************************************/
-void CORE_ICacheEnable(void);
-
-/**************************************************************************//**
- @Function      CORE_DCacheDisable
-
- @Description   Disables the data cache.
-
- @Return        None.
-*//***************************************************************************/
-void CORE_DCacheDisable(void);
-
-/**************************************************************************//**
- @Function      CORE_ICacheDisable
-
- @Description   Disables the instruction cache.
-
- @Return        None.
-*//***************************************************************************/
-void CORE_ICacheDisable(void);
-
-
-
-#if defined(CORE_E300)
-#include "e300_ext.h"
-#elif defined(CORE_E500V2) || defined(CORE_E500MC) || defined(CORE_E5500) || defined(CORE_E6500)
-#include "e500v2_ext.h"
-#if !defined(NCSW_LINUX)
-#include "e500v2_asm_ext.h"
-#endif
-#else
-#error "Core not defined!"
-#endif
-#endif /* 0 */
-
 #endif /* __PPC_EXT_H */
diff --git a/drivers/net/ethernet/freescale/fman/inc/integrations/LS1043/part_ext.h b/drivers/net/ethernet/freescale/fman/inc/integrations/LS1043/part_ext.h
index e1421ba..4787e19 100644
--- a/drivers/net/ethernet/freescale/fman/inc/integrations/LS1043/part_ext.h
+++ b/drivers/net/ethernet/freescale/fman/inc/integrations/LS1043/part_ext.h
@@ -43,9 +43,6 @@
 #include "std_ext.h"
 #include "part_integration_ext.h"
 
-#warning is it required
-//#include "part_integration_ext.h"
-
 #if !(defined(LS1043))
 #error "unable to proceed without chip-definition"
 #endif
diff --git a/drivers/net/ethernet/freescale/fman/ls1043_dflags.h b/drivers/net/ethernet/freescale/fman/ls1043_dflags.h
index c95f51e..c3a5a62 100644
--- a/drivers/net/ethernet/freescale/fman/ls1043_dflags.h
+++ b/drivers/net/ethernet/freescale/fman/ls1043_dflags.h
@@ -37,8 +37,6 @@
 #define NCSW_LINUX
 
 #define LS1043
-#warning check the line below if required
-//#define NCSW_PPC_CORE
 
 #define DEBUG_ERRORS        1
 
diff --git a/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm.c b/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm.c
index 46bc64e..eb35837 100755
--- a/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm.c
+++ b/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm.c
@@ -527,13 +527,13 @@ static t_LnxWrpFmDev * ReadFmDevTreeNode (struct platform_device *of_dev)
         REPORT_ERROR(MAJOR, E_INVALID_VALUE, ("of_irq_to_resource() = %d", NO_IRQ));
         return NULL;
     }
-
-printk(">>>>>>   p_LnxWrpFmDev->irq is %d \n", p_LnxWrpFmDev->irq);
+#warning remove printk
+printk(">>>>>> p_LnxWrpFmDev->irq is %d\n", p_LnxWrpFmDev->irq);
 
     /* Get the FM error interrupt */
     p_LnxWrpFmDev->err_irq = of_irq_to_resource(fm_node, 1, NULL);
-
-printk(">>>>>>   p_LnxWrpFmDev->err_irq is %d \n", p_LnxWrpFmDev->err_irq);
+#warning remove printk
+printk(">>>>>> p_LnxWrpFmDev->err_irq is %d\n", p_LnxWrpFmDev->err_irq);
 
     if (unlikely(p_LnxWrpFmDev->err_irq == /*NO_IRQ*/0)) {
         REPORT_ERROR(MAJOR, E_INVALID_VALUE, ("of_irq_to_resource() = %d", NO_IRQ));
@@ -698,11 +698,11 @@ printk(">>>>>>   p_LnxWrpFmDev->err_irq is %d \n", p_LnxWrpFmDev->err_irq);
     }
 
     of_node_put(fm_node);
-#warning: !Hard coded hcCh
-     p_LnxWrpFmDev->hcCh = 17;
-/*    p_LnxWrpFmDev->hcCh =
+#warning: Check retuned value for hcCh
+//     p_LnxWrpFmDev->hcCh = 17;
+    p_LnxWrpFmDev->hcCh =
         qman_affine_channel(cpumask_first(qman_affine_cpus()));
-*/
+
     p_LnxWrpFmDev->active = TRUE;
 
     return p_LnxWrpFmDev;
@@ -862,9 +862,9 @@ static t_Error ConfigureFmDev(t_LnxWrpFmDev  *p_LnxWrpFmDev)
 
     if (SYS_RegisterIoMap((uint64_t)p_LnxWrpFmDev->fmBaseAddr, (uint64_t)p_LnxWrpFmDev->fmPhysBaseAddr, p_LnxWrpFmDev->fmMemSize) != E_OK)
         RETURN_ERROR(MAJOR, E_INVALID_STATE, ("FM memory map"));
-
-printk("<<>><<< p_LnxWrpFmDev->fmPhysBaseAddr = 0x%llx \n",(u64)p_LnxWrpFmDev->fmPhysBaseAddr);
-printk("<<>><<< p_LnxWrpFmDev->fmBaseAddr = 0x%llx \n",(u64)p_LnxWrpFmDev->fmBaseAddr);
+#warning remove printk
+printk("<<>><<< p_LnxWrpFmDev->fmPhysBaseAddr = 0x%llx\n",(u64)p_LnxWrpFmDev->fmPhysBaseAddr);
+printk("<<>><<< p_LnxWrpFmDev->fmBaseAddr = 0x%llx\n",(u64)p_LnxWrpFmDev->fmBaseAddr);
 
     dev_res = __devm_request_region(p_LnxWrpFmDev->dev, p_LnxWrpFmDev->res, p_LnxWrpFmDev->fmMuramPhysBaseAddr, p_LnxWrpFmDev->fmMuramMemSize, "fman-muram");
     if (unlikely(dev_res == NULL))
diff --git a/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm_port.c b/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm_port.c
index c59ee66..67f3439 100644
--- a/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm_port.c
+++ b/drivers/net/ethernet/freescale/fman/src/wrapper/lnxwrp_fm_port.c
@@ -180,8 +180,8 @@ static struct qman_fq *FqAlloc(t_LnxWrpFmDev * p_LnxWrpFmDev,
 static void FqFree(struct qman_fq *fq)
 {
 	int _errno;
-#warning: Not used function FqFree
-#if 0
+#warning: need to verify availability of qman functions
+//#if 0
 	_errno = qman_retire_fq(fq, NULL);
 	if (unlikely(_errno < 0))
 		printk(KERN_WARNING "qman_retire_fq(%u) = %d\n", qman_fq_fqid(fq), _errno);
@@ -192,7 +192,7 @@ static void FqFree(struct qman_fq *fq)
 
 	qman_destroy_fq(fq, 0);
 	XX_Free((t_FmTestFq *) fq);
-#endif
+//#endif
 }
 
 static t_Error QmEnqueueCB(t_Handle h_Arg, void *p_Fd)
@@ -1127,8 +1127,8 @@ static t_Error InitFmPcdDev(t_LnxWrpFmDev *p_LnxWrpFmDev)
 
 #warning: hard coded qman params
 
-		p_LnxWrpFmDev->hc_tx_fq = NULL;
-#if 0
+//		p_LnxWrpFmDev->hc_tx_fq = NULL;
+//#if 0
 		FqAlloc(p_LnxWrpFmDev,
 				0,
 				QMAN_FQ_FLAG_TO_DCPORTAL,
@@ -1136,9 +1136,9 @@ static t_Error InitFmPcdDev(t_LnxWrpFmDev *p_LnxWrpFmDev)
 		if (!p_LnxWrpFmDev->hc_tx_fq)
 			RETURN_ERROR(MAJOR, E_NULL_POINTER,
 				     ("Frame queue allocation failed..."));
-#endif
+//#endif
 		p_LnxWrpFmDev->hc_tx_conf_fq = NULL;
-#if 0
+//#if 0
 			FqAlloc(p_LnxWrpFmDev,
 				0,
 				QMAN_FQ_FLAG_NO_ENQUEUE,
@@ -1146,9 +1146,9 @@ static t_Error InitFmPcdDev(t_LnxWrpFmDev *p_LnxWrpFmDev)
 		if (!p_LnxWrpFmDev->hc_tx_conf_fq)
 			RETURN_ERROR(MAJOR, E_NULL_POINTER,
 				     ("Frame queue allocation failed..."));
-#endif
+//#endif
 		p_LnxWrpFmDev->hc_tx_err_fq = NULL;
-#if 0
+//#if 0
 			FqAlloc(p_LnxWrpFmDev,
 				0,
 				QMAN_FQ_FLAG_NO_ENQUEUE,
@@ -1156,12 +1156,12 @@ static t_Error InitFmPcdDev(t_LnxWrpFmDev *p_LnxWrpFmDev)
 		if (!p_LnxWrpFmDev->hc_tx_err_fq)
 			RETURN_ERROR(MAJOR, E_NULL_POINTER,
 				     ("Frame queue allocation failed..."));
-#endif
+//#endif
 
 		fmPcdParams.hc.portBaseAddr = p_LnxWrpFmPortDev->baseAddr;
 		fmPcdParams.hc.portId =
 			p_LnxWrpFmPortDev->settings.param.portId;
-#if 0
+//#if 0
 		fmPcdParams.hc.qmChannel = p_LnxWrpFmPortDev->txCh;
 		fmPcdParams.hc.liodnBase =
 			p_LnxWrpFmPortDev->settings.param.liodnBase;
@@ -1172,15 +1172,14 @@ static t_Error InitFmPcdDev(t_LnxWrpFmDev *p_LnxWrpFmDev)
 			qman_fq_fqid(p_LnxWrpFmDev->hc_tx_conf_fq);
 		fmPcdParams.hc.f_QmEnqueue = QmEnqueueCB;
 		fmPcdParams.hc.h_QmArg = (t_Handle) p_LnxWrpFmDev;
-#endif
-fmPcdParams.hc.errFqid = 0x102;
-fmPcdParams.hc.confFqid = 0x101;
+//#endif
+#warning Hard code values
+//fmPcdParams.hc.errFqid = 0x102;
+//fmPcdParams.hc.confFqid = 0x101;
 
 
 		p_LnxWrpFmDev->h_PcdDev = FM_PCD_Config(&fmPcdParams);
 
-printk(">>ll11ll >> \n");
-
 		if (!p_LnxWrpFmDev->h_PcdDev)
 			RETURN_ERROR(MAJOR, E_INVALID_HANDLE, ("FM PCD!"));
 
@@ -1193,7 +1192,6 @@ printk(">>ll11ll >> \n");
 		err = FM_PCD_Init(p_LnxWrpFmDev->h_PcdDev);
 		if (err != E_OK)
 			RETURN_ERROR(MAJOR, err, NO_MSG);
-printk(">>ll22ll >> \n");
 
 		if (p_LnxWrpFmDev->err_irq == 0) {
 			FM_PCD_SetException(p_LnxWrpFmDev->h_PcdDev,
-- 
1.7.5.4

