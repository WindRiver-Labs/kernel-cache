From 3b3878db1fa4a5aeeb5a2c79bc37268be0fd181b Mon Sep 17 00:00:00 2001
From: Marian-Cristian Rotariu <marian.rotariu@freescale.com>
Date: Mon, 5 Jan 2015 16:43:21 +0200
Subject: [PATCH 148/451] dpaa_eth: guard the qman_query_cgr() call

This patch interrogates the QMan CGR API call for invalid values. If the low
level call fails a proper message should be displayed to the user.

This is particularly useful for the DPAA ETH drivers that run in simulator or
emulator where CGR information cannot be properly retrieved due to limitations.

Signed-off-by: Marian-Cristian Rotariu <marian.rotariu@freescale.com>
Change-Id: I067baabe64c014a614f9ca712ce0b7326e4b664b
Reviewed-on: http://git.am.freescale.net:8181/28636
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Madalin-Cristian Bucur <madalin.bucur@freescale.com>
Reviewed-by: Mingkai Hu <Mingkai.Hu@freescale.com>
Reviewed-by: Yang Li <LeoLi@freescale.com>
[Xulin: Original patch taken from
Linux-LS1043A-SDK-V0.4-SOURCE-20150826-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/dpaa_debugfs.c |   19 ++++++++++++-------
 1 files changed, 12 insertions(+), 7 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_debugfs.c b/drivers/net/ethernet/freescale/dpa/dpaa_debugfs.c
index a5665ac..5e9c863 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_debugfs.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_debugfs.c
@@ -135,13 +135,18 @@ static int dpa_debugfs_show(struct seq_file *file, void *offset)
 	seq_printf(file, "Device has been congested for %d ms.\n",
 		jiffies_to_msecs(priv->cgr_data.congested_jiffies));
 
-	qman_query_cgr(&priv->cgr_data.cgr, &query_cgr);
-	seq_printf(file, "CGR id %d avg count: %llu\n",
-		priv->cgr_data.cgr.cgrid, qm_mcr_querycgr_a_get64(&query_cgr));
-	seq_printf(file, "Device entered congestion %u times. ",
-			priv->cgr_data.cgr_congested_count);
-	seq_printf(file, "Current congestion state is: %s.\n",
-		query_cgr.cgr.cs ? "congested" : "not congested");
+	if (qman_query_cgr(&priv->cgr_data.cgr, &query_cgr)) {
+		seq_printf(file, "CGR id %d - failed to query values\n",
+			   priv->cgr_data.cgr.cgrid);
+	} else {
+		seq_printf(file, "CGR id %d avg count: %llu\n",
+			   priv->cgr_data.cgr.cgrid,
+			   qm_mcr_querycgr_a_get64(&query_cgr));
+		seq_printf(file, "Device entered congestion %u times. ",
+			   priv->cgr_data.cgr_congested_count);
+		seq_printf(file, "Current congestion state is: %s.\n",
+			   query_cgr.cgr.cs ? "congested" : "not congested");
+	}
 	/* Reset congestion stats (like QMan CGR API does) */
 	priv->cgr_data.congested_jiffies = 0;
 	priv->cgr_data.cgr_congested_count = 0;
-- 
1.7.5.4

