From a2900bc7cd150fa76008081f0ab521a7af2a0bb0 Mon Sep 17 00:00:00 2001
From: Roy Pledge <Roy.Pledge@freescale.com>
Date: Wed, 27 May 2015 16:29:03 -0400
Subject: [PATCH 160/451] fsl_qbman: Add support for QMan 3.2

The LS1043a processor has version 3.2 of the QMan IP block.  This
patch adds support for that revision.

Signed-off-by: Roy Pledge <Roy.Pledge@freescale.com>
[Xulin: Original patch taken from
Linux-LS1043A-SDK-V0.4-SOURCE-20150826-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 drivers/staging/fsl_qbman/qman_config.c  |    2 ++
 drivers/staging/fsl_qbman/qman_driver.c  |    4 ++++
 drivers/staging/fsl_qbman/qman_private.h |    1 +
 3 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/drivers/staging/fsl_qbman/qman_config.c b/drivers/staging/fsl_qbman/qman_config.c
index 34c12c4..048d0c9 100644
--- a/drivers/staging/fsl_qbman/qman_config.c
+++ b/drivers/staging/fsl_qbman/qman_config.c
@@ -531,6 +531,8 @@ static int __init fsl_qman_init(struct device_node *node)
 			qman_ip_rev = QMAN_REV30;
 		else if ((major == 3) && (minor == 1))
 			qman_ip_rev = QMAN_REV31;
+		else if ((major == 3) && (minor == 2))
+			qman_ip_rev = QMAN_REV32;
 		else {
 			pr_warn("unknown Qman version, default to rev1.1\n");
 			qman_ip_rev = QMAN_REV11;
diff --git a/drivers/staging/fsl_qbman/qman_driver.c b/drivers/staging/fsl_qbman/qman_driver.c
index 9239c3d..2007382 100644
--- a/drivers/staging/fsl_qbman/qman_driver.c
+++ b/drivers/staging/fsl_qbman/qman_driver.c
@@ -334,6 +334,10 @@ static void qman_get_ip_revision(struct device_node *dn)
 						"fsl,qman-portal-3.1.3")) {
 			ip_rev = QMAN_REV31;
 			qman_portal_max = 10;
+		} else if (of_device_is_compatible(dn,
+						"fsl,qman-portal-3.2.0")) {
+			ip_rev = QMAN_REV32;
+			qman_portal_max = 10;
 		} else {
 			pr_warn("unknown QMan version in portal node,"
 				"default to rev1.1\n");
diff --git a/drivers/staging/fsl_qbman/qman_private.h b/drivers/staging/fsl_qbman/qman_private.h
index 2734f7e..e719dfb 100644
--- a/drivers/staging/fsl_qbman/qman_private.h
+++ b/drivers/staging/fsl_qbman/qman_private.h
@@ -196,6 +196,7 @@ struct qm_portal_config {
 #define QMAN_REV20 0x0200
 #define QMAN_REV30 0x0300
 #define QMAN_REV31 0x0301
+#define QMAN_REV32 0x0302
 extern u16 qman_ip_rev; /* 0 if uninitialised, otherwise QMAN_REVx */
 extern u32 qman_clk;
 extern u16 qman_portal_max;
-- 
1.7.5.4

