From b53cac63e4b9bb783b9b5aed6de89a7cefb2d7dc Mon Sep 17 00:00:00 2001
From: Xulin Sun <xulin.sun@windriver.com>
Date: Tue, 1 Aug 2017 14:18:13 +0800
Subject: [PATCH 1/2] Revert "drivers/qbman: free qman_fq after destroying
 qman frame queue"

This reverts commit de04fa2296f08307ccd00b746f6b5a3dd224aa30.

To use the upstream patch [crypto: caam - free qman_fq after kill_fq].

Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 drivers/crypto/caam/qi.c              |    7 +++++--
 drivers/staging/fsl_qbman/qman_high.c |    1 -
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/drivers/crypto/caam/qi.c b/drivers/crypto/caam/qi.c
index bcb0079..e4e7465 100644
--- a/drivers/crypto/caam/qi.c
+++ b/drivers/crypto/caam/qi.c
@@ -194,8 +194,7 @@ static struct qman_fq *create_caam_req_fq(struct device *qidev,
 	ret = qman_create_fq(0, flags, req_fq);
 	if (ret) {
 		dev_err(qidev, "Failed to create session REQ FQ\n");
-		kfree(req_fq);
-		return ERR_PTR(ret);
+		goto create_req_fq_fail;
 	}
 
 	flags = fq_sched_flag;
@@ -225,6 +224,8 @@ static struct qman_fq *create_caam_req_fq(struct device *qidev,
 init_req_fq_fail:
 	qman_destroy_fq(req_fq, 0);
 
+create_req_fq_fail:
+	kfree(req_fq);
 	return ERR_PTR(ret);
 }
 
@@ -556,6 +557,8 @@ int caam_qi_shutdown(struct device *qidev)
 
 		if (kill_fq(qidev, per_cpu(pcpu_qipriv.rsp_fq, i)))
 			dev_err(qidev, "Rsp FQ kill failed, cpu: %d\n", i);
+
+		kfree(per_cpu(pcpu_qipriv.rsp_fq, i));
 	}
 
 	/*
diff --git a/drivers/staging/fsl_qbman/qman_high.c b/drivers/staging/fsl_qbman/qman_high.c
index 581027c..09064b4 100644
--- a/drivers/staging/fsl_qbman/qman_high.c
+++ b/drivers/staging/fsl_qbman/qman_high.c
@@ -1753,7 +1753,6 @@ void qman_destroy_fq(struct qman_fq *fq, u32 flags __maybe_unused)
 #ifdef CONFIG_FSL_QMAN_FQ_LOOKUP
 		clear_fq_table_entry(fq->key);
 #endif
-		kfree(fq);
 		return;
 	default:
 		break;
-- 
1.7.5.4

