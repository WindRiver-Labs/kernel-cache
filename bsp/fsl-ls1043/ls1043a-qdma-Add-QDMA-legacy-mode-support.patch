From 780bf7f90f49715f4ab03c2bf4c093694406c0eb Mon Sep 17 00:00:00 2001
From: Yuan Yao <yao.yuan@freescale.com>
Date: Fri, 19 Jun 2015 09:42:21 +0800
Subject: [PATCH 245/451] ls1043a/qdma: Add QDMA legacy mode support

qDMA in ls1043 is big endian. So add the big_endian property.

Signed-off-by: Yuan Yao <yao.yuan@freescale.com>
[Xulin: Original patch taken from
Linux-LS1043A-SDK-V0.4-SOURCE-20150826-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi |    1 +
 drivers/dma/fsl-qdma.c                         |   12 ++++++++++--
 2 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi b/arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi
index f58d2e1d..e092bb6 100644
--- a/arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi
+++ b/arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi
@@ -842,6 +842,7 @@
 			     <0 153 0x4>;
 		interrupt-names = "qdma-tx", "qdma-err";
 		channels = <1>;
+		big-endian;
 	};
 
 	pcie@3400000 {
diff --git a/drivers/dma/fsl-qdma.c b/drivers/dma/fsl-qdma.c
index 0844fa1..43d3e59 100644
--- a/drivers/dma/fsl-qdma.c
+++ b/drivers/dma/fsl-qdma.c
@@ -87,19 +87,26 @@ struct fsl_qdma_engine {
 	struct mutex            fsl_qdma_mutex;
 	int			controller_irq;
 	int			err_irq;
+	bool			big_endian;
 	struct fsl_qdma_chan	chans[];
 
 };
 
 static u32 qdma_readl(struct fsl_qdma_engine *qdma, void __iomem *addr)
 {
-	return ioread32(addr);
+	if (qdma->big_endian)
+		return ioread32be(addr);
+	else
+		return ioread32(addr);
 }
 
 static void qdma_writel(struct fsl_qdma_engine *qdma, u32 val,
 						void __iomem *addr)
 {
-	iowrite32(val, addr);
+	if (qdma->big_endian)
+		iowrite32be(val, addr);
+	else
+		iowrite32(val, addr);
 }
 
 static struct fsl_qdma_chan *to_fsl_qdma_chan(struct dma_chan *chan)
@@ -415,6 +422,7 @@ static int fsl_qdma_probe(struct platform_device *pdev)
 	if (ret)
 		return ret;
 
+	fsl_qdma->big_endian = of_property_read_bool(np, "big-endian");
 	INIT_LIST_HEAD(&fsl_qdma->dma_dev.channels);
 	for (i = 0; i < fsl_qdma->n_chans; i++) {
 		struct fsl_qdma_chan *fsl_chan = &fsl_qdma->chans[i];
-- 
1.7.5.4

