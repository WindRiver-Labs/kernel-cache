From fbafc26c3f8d23ab1d0664da5b1152cb047691ef Mon Sep 17 00:00:00 2001
From: Roy Pledge <Roy.Pledge@freescale.com>
Date: Mon, 20 Jul 2015 15:29:50 -0400
Subject: [PATCH 425/451] fsl_qbman: Enable EQCR CI Stashing for ARM

Enqueue Command Ring Consumer Index stashing was disabled during
ARM bringup. Renable the feature as it is working and gives a
measurable perfomance gain.

Signed-off-by: Roy Pledge <Roy.Pledge@freescale.com>
[Xulin: Original patch taken from
Linux-LS1043A-SDK-V0.4-SOURCE-20150826-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 drivers/staging/fsl_qbman/qman_config.c |    4 ++++
 drivers/staging/fsl_qbman/qman_high.c   |    4 ----
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/staging/fsl_qbman/qman_config.c b/drivers/staging/fsl_qbman/qman_config.c
index 048d0c9..8a6bc3f 100644
--- a/drivers/staging/fsl_qbman/qman_config.c
+++ b/drivers/staging/fsl_qbman/qman_config.c
@@ -766,6 +766,10 @@ int qman_set_sdest(u16 channel, unsigned int cpu_idx)
 
 	if (!qman_have_ccsr())
 		return -ENODEV;
+	if ((qman_ip_rev & 0xFF00) == QMAN_REV31) {
+		/* LS1043A - only one L2 cache */
+		cpu_idx = 0;
+	}
 
 	if ((qman_ip_rev & 0xFF00) >= QMAN_REV30) {
 		before = qm_in(REV3_QCSP_IO_CFG(idx));
diff --git a/drivers/staging/fsl_qbman/qman_high.c b/drivers/staging/fsl_qbman/qman_high.c
index 7963622..2baba08 100644
--- a/drivers/staging/fsl_qbman/qman_high.c
+++ b/drivers/staging/fsl_qbman/qman_high.c
@@ -518,12 +518,8 @@ struct qman_portal *qman_create_portal(
 
 	__p = &portal->p;
 
-#if defined(CONFIG_ARM64)
-	portal->use_eqcr_ci_stashing = 0;
-#else
 	portal->use_eqcr_ci_stashing = ((qman_ip_rev >= QMAN_REV30) ?
 								1 : 0);
-#endif
 
 	/* prep the low-level portal struct with the mapped addresses from the
 	 * config, everything that follows depends on it and "config" is more
-- 
1.7.5.4

