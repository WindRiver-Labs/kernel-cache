From 955695ec38d3ba2ccff387e4b805496bb88aae97 Mon Sep 17 00:00:00 2001
From: Mingkai Hu <Mingkai.Hu@freescale.com>
Date: Wed, 27 May 2015 19:41:14 +0800
Subject: [PATCH 159/451] pcie-layerscape: change PCIe compatible

Signed-off-by: Mingkai Hu <Mingkai.Hu@freescale.com>
[Xulin: Original patch taken from
Linux-LS1043A-SDK-V0.4-SOURCE-20150826-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi |   17 +++++++----------
 drivers/pci/host/pci-layerscape.c              |    6 +++++-
 2 files changed, 12 insertions(+), 11 deletions(-)

diff --git a/arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi b/arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi
index 48f4e4b..b966627 100644
--- a/arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi
+++ b/arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi
@@ -626,15 +626,14 @@
 	};
 
 	pcie@3400000 {
-		compatible = "fsl,ls1021a-pcie", "snps,dw-pcie";
-		reg = <0x00 0x03400000 0x0 0x00010000   /* controller registers */
+		compatible = "fsl,ls1043a-pcie", "snps,dw-pcie";
+		reg = <0x00 0x03400000 0x0 0x00100000   /* controller registers */
 		       0x40 0x00000000 0x0 0x00002000>; /* configuration space */
 		reg-names = "regs", "config";
 		interrupts = <0 118 0x4>, /* controller interrupt */
 			     <0 116 0x4>, /* MSI interrupt */
 			     <0 117 0x4>; /* PME interrupt */
 		interrupt-names = "intr", "msi", "pme";
-		fsl,pcie-scfg = <&scfg 0>;
 		num-atus = <6>;
 		#address-cells = <3>;
 		#size-cells = <2>;
@@ -652,15 +651,14 @@
 	};
 
 	pcie@3500000 {
-		compatible = "fsl,ls1021a-pcie", "snps,dw-pcie";
-		reg = <0x00 0x03500000 0x0 0x00010000   /* controller registers */
+		compatible = "fsl,ls1043a-pcie", "snps,dw-pcie";
+		reg = <0x00 0x03500000 0x0 0x00100000   /* controller registers */
 		       0x48 0x00000000 0x0 0x00002000>; /* configuration space */
 		reg-names = "regs", "config";
 		interrupts = <0 128 0x4>,
 			     <0 126 0x4>,
 			     <0 127 0x4>;
 		interrupt-names = "intr", "msi", "pme";
-		fsl,pcie-scfg = <&scfg 1>;
 		num-atus = <6>;
 		#address-cells = <3>;
 		#size-cells = <2>;
@@ -678,22 +676,21 @@
 	};
 
 	pcie@3600000 {
-		compatible = "fsl,ls1021a-pcie", "snps,dw-pcie";
-		reg = <0x00 0x03600000 0x0 0x00010000   /* controller registers */
+		compatible = "fsl,ls1043a-pcie", "snps,dw-pcie";
+		reg = <0x00 0x03600000 0x0 0x00100000   /* controller registers */
 		       0x50 0x00000000 0x0 0x00002000>; /* configuration space */
 		reg-names = "regs", "config";
 		interrupts = <0 162 0x4>,
 			     <0 160 0x4>,
 			     <0 161 0x4>;
 		interrupt-names = "intr", "msi", "pme";
-		fsl,pcie-scfg = <&scfg 1>;
 		num-atus = <6>;
 		#address-cells = <3>;
 		#size-cells = <2>;
 		device_type = "pci";
 		num-lanes = <2>;
 		bus-range = <0x0 0xff>;
-		ranges = <0x81000000 0x0 0x00000000 0x48 0x00010000 0x0 0x00010000   /* downstream I/O */
+		ranges = <0x81000000 0x0 0x00000000 0x50 0x00010000 0x0 0x00010000   /* downstream I/O */
 			  0x82000000 0x0 0x40000000 0x50 0x40000000 0x0 0x40000000>; /* non-prefetchable memory */
 		#interrupt-cells = <1>;
 		interrupt-map-mask = <0 0 0 7>;
diff --git a/drivers/pci/host/pci-layerscape.c b/drivers/pci/host/pci-layerscape.c
index 7048f8c..6818f45 100644
--- a/drivers/pci/host/pci-layerscape.c
+++ b/drivers/pci/host/pci-layerscape.c
@@ -191,7 +191,10 @@ static int __init ls_pcie_probe(struct platform_device *pdev)
 	if (IS_ERR(pcie->dbi))
 		return PTR_ERR(pcie->dbi);
 
-	pcie->lut = pcie->dbi + PCIE_LUT_BASE;
+	if (of_device_is_compatible(pcie->dev->of_node, "fsl,ls1043a-pcie"))
+		pcie->lut = pcie->dbi + 0x10000;
+	else
+		pcie->lut = pcie->dbi + PCIE_LUT_BASE;
 
 	if (!ls_pcie_is_bridge(pcie))
 		return 0;
@@ -225,6 +228,7 @@ static int __init ls_pcie_probe(struct platform_device *pdev)
 
 static const struct of_device_id ls_pcie_of_match[] = {
 	{ .compatible = "fsl,ls1021a-pcie" },
+	{ .compatible = "fsl,ls1043a-pcie" },
 	{ .compatible = "fsl,ls2085a-pcie" },
 	{ },
 };
-- 
1.7.5.4

