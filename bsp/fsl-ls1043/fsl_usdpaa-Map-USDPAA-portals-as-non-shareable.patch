From 34996df863fd84c26957defdd824a255c04af9ab Mon Sep 17 00:00:00 2001
From: Roy Pledge <Roy.Pledge@freescale.com>
Date: Mon, 10 Aug 2015 15:12:37 -0400
Subject: [PATCH 440/451] fsl_usdpaa: Map USDPAA portals as non shareable

QBMan portals should be mapped as non sharable for USDPAA.

Signed-off-by: Roy Pledge <Roy.Pledge@freescale.com>
[Xulin: Original patch taken from
Linux-LS1043A-SDK-V0.4-SOURCE-20150826-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 arch/arm64/include/asm/pgtable.h       |    2 ++
 drivers/staging/fsl_qbman/fsl_usdpaa.c |    2 +-
 2 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/arch/arm64/include/asm/pgtable.h b/arch/arm64/include/asm/pgtable.h
index 2cc257e..1722683b4 100644
--- a/arch/arm64/include/asm/pgtable.h
+++ b/arch/arm64/include/asm/pgtable.h
@@ -290,6 +290,8 @@ static inline int has_transparent_hugepage(void)
 
 #define __pgprot_modify(prot,mask,bits) \
 	__pgprot((pgprot_val(prot) & ~(mask)) | (bits))
+#define pgprot_cached_ns(prot) \
+	__pgprot(pgprot_val(pgprot_cached(prot)) ^ PTE_SHARED)
 
 /*
  * Mark the prot value as uncacheable and unbufferable.
diff --git a/drivers/staging/fsl_qbman/fsl_usdpaa.c b/drivers/staging/fsl_qbman/fsl_usdpaa.c
index 5c6acf9..4f88a04 100644
--- a/drivers/staging/fsl_qbman/fsl_usdpaa.c
+++ b/drivers/staging/fsl_qbman/fsl_usdpaa.c
@@ -705,7 +705,7 @@ static int check_mmap_portal(struct ctx *ctx, struct vm_area_struct *vma,
 					  match, pfn);
 		if (*match) {
 			vma->vm_page_prot =
-				pgprot_cached(vma->vm_page_prot);
+				pgprot_cached_ns(vma->vm_page_prot);
 			return ret;
 		}
 		ret = check_mmap_resource(&portal->phys[DPA_PORTAL_CI], vma,
-- 
1.7.5.4

