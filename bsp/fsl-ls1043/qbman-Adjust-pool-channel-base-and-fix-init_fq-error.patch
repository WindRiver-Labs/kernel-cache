From 984d837842175d84089313d6c2e25836cb1418d1 Mon Sep 17 00:00:00 2001
From: Roy Pledge <Roy.Pledge@freescale.com>
Date: Mon, 9 Feb 2015 16:26:25 -0500
Subject: [PATCH 138/451] qbman: Adjust pool channel base and fix init_fq
 error

The pool channel base for the QMan was incorrectly defaulting to
the P4080 value. Temporarly fix.

Also fixed an issue where options were not correctly copied during
init_fq

Signed-off-by: Roy Pledge <Roy.Pledge@freescale.com>
Change-Id: Ia8e3b975a001c2cd9e12e7dc321d8a8a916ea8f8
Reviewed-on: http://git.am.freescale.net:8181/30414
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Yang Li <LeoLi@freescale.com>
[Xulin: Original patch taken from
Linux-LS1043A-SDK-V0.4-SOURCE-20150826-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 .../boot/dts/freescale/qoriq-qman1-portals.dtsi    |    2 +-
 drivers/staging/fsl_qbman/qman_driver.c            |    4 +++-
 drivers/staging/fsl_qbman/qman_high.c              |    2 +-
 3 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/arch/arm64/boot/dts/freescale/qoriq-qman1-portals.dtsi b/arch/arm64/boot/dts/freescale/qoriq-qman1-portals.dtsi
index 7ff41a1..44a1238 100644
--- a/arch/arm64/boot/dts/freescale/qoriq-qman1-portals.dtsi
+++ b/arch/arm64/boot/dts/freescale/qoriq-qman1-portals.dtsi
@@ -126,7 +126,7 @@
         };
         qman-pools@0 {
                 compatible = "fsl,pool-channel-range";
-                fsl,pool-channel-range = <0x21 0xf>;
+                fsl,pool-channel-range = <0x401 0xf>;
         };
         qman-cgrids@0 {
                 compatible = "fsl,cgrid-range";
diff --git a/drivers/staging/fsl_qbman/qman_driver.c b/drivers/staging/fsl_qbman/qman_driver.c
index 0cba7e2..9239c3d 100644
--- a/drivers/staging/fsl_qbman/qman_driver.c
+++ b/drivers/staging/fsl_qbman/qman_driver.c
@@ -768,7 +768,9 @@ __init int qman_init(void)
 		qm_channel_caam = QMAN_CHANNEL_CAAM_REV3;
 		qm_channel_pme = QMAN_CHANNEL_PME_REV3;
 	}
-
+	/* TEMP for LS1043 until uboot fixup is complete */
+	qm_channel_pool1 = QMAN_CHANNEL_POOL1_REV3;
+	pr_info("QMan Pool Channel base 0x%x\n", qm_channel_pool1);
 	/*
 	 * Parse the ceetm node to get how many ceetm instances are supported
 	 * on the current silicon. num_ceetms must be confirmed before portals
diff --git a/drivers/staging/fsl_qbman/qman_high.c b/drivers/staging/fsl_qbman/qman_high.c
index 83e8ad8..7ba897a 100644
--- a/drivers/staging/fsl_qbman/qman_high.c
+++ b/drivers/staging/fsl_qbman/qman_high.c
@@ -1629,7 +1629,7 @@ int qman_init_fq(struct qman_fq *fq, u32 flags, struct qm_mcc_initfq *opts)
 		int i;
 		u8 *dest = (u8 *) &mcc->initfq;
 		u8 *src = (u8 *) opts;
-		for (i = 0; i < sizeof(opts); i++)
+		for (i = 0; i < sizeof(*opts); i++)
 			dest[i] = src[i];
 	}
 	mcc->initfq.fqid = cpu_to_be32(fq->fqid);
-- 
1.7.5.4

