From 2926126023da1522a82a762f3d3b4aaa74ff8aa3 Mon Sep 17 00:00:00 2001
From: Mandy Lavi <mandy.lavi@freescale.com>
Date: Mon, 10 Nov 2014 18:57:36 +0200
Subject: [PATCH 282/451] fmd: disable auto-neg if ports is SGMII2.5G

In order to do so it was also required to introduce
a new if type for SGMII2.5G

Change-Id: Iddbe223d8b716c3ed348c7a8a53bee0c037f04f4
Signed-off-by: Mandy Lavi <mandy.lavi@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/23474
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Shengzhou Liu <Shengzhou.Liu@freescale.com>
Reviewed-by: Honghua Yin <Hong-Hua.Yin@freescale.com>

Conflicts:
	drivers/net/ethernet/freescale/dpa/mac.c
	include/linux/phy.h
[Xulin: Original patch taken from
Linux-LS1043A-SDK-V0.4-SOURCE-20150826-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 drivers/net/ethernet/freescale/dpa/mac.c           |    4 ++--
 .../freescale/fman/Peripherals/FM/MAC/memac.c      |    2 ++
 drivers/net/ethernet/freescale/fman/inc/enet_ext.h |    2 ++
 .../ethernet/freescale/fman/inc/flib/fsl_enet.h    |    1 +
 include/linux/phy.h                                |    1 +
 5 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/mac.c b/drivers/net/ethernet/freescale/dpa/mac.c
index 19f163a..faf00a1 100644
--- a/drivers/net/ethernet/freescale/dpa/mac.c
+++ b/drivers/net/ethernet/freescale/dpa/mac.c
@@ -73,7 +73,7 @@ static const char phy_str[][11] = {
 	[PHY_INTERFACE_MODE_RGMII_TXID]	= "rgmii-txid",
 	[PHY_INTERFACE_MODE_RTBI]	= "rtbi",
 	[PHY_INTERFACE_MODE_XGMII]	= "xgmii",
-	[PHY_INTERFACE_MODE_SGMII_2500]	= "sgmii-2500"
+	[PHY_INTERFACE_MODE_SGMII_2500]	= "sgmii_2500"
 };
 
 static phy_interface_t __pure __attribute__((nonnull)) str2phy(const char *str)
@@ -339,7 +339,7 @@ static int __cold mac_probe(struct platform_device *_of_dev)
 		mac_dev->if_support &= ~(SUPPORTED_10baseT_Half |
 					SUPPORTED_100baseT_Half);
 
-	if (strstr(char_prop, "sgmii-2500"))
+	if (strstr(char_prop, "sgmii_2500"))
 		mac_dev->if_support &= ~(SUPPORTED_10baseT_Half |
 					SUPPORTED_100baseT_Half);
 
diff --git a/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/memac.c b/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/memac.c
index 45a2fd8..4ea5d85 100644
--- a/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/memac.c
+++ b/drivers/net/ethernet/freescale/fman/Peripherals/FM/MAC/memac.c
@@ -93,6 +93,8 @@ static void SetupSgmiiInternalPhy(t_Memac *p_Memac, uint8_t phyAddr)
 
     /* SGMII mode + AN enable */
     tmpReg16 = PHY_SGMII_IF_MODE_AN | PHY_SGMII_IF_MODE_SGMII;
+    if ((p_Memac->enetMode) == e_ENET_MODE_SGMII_2500)
+        tmpReg16 = PHY_SGMII_CR_PHY_RESET | PHY_SGMII_IF_MODE_SGMII;
     MEMAC_MII_WritePhyReg(p_Memac, phyAddr, 0x14, tmpReg16);
 
     /* Device ability according to SGMII specification */
diff --git a/drivers/net/ethernet/freescale/fman/inc/enet_ext.h b/drivers/net/ethernet/freescale/fman/inc/enet_ext.h
index c6b9071..ef3bee5 100644
--- a/drivers/net/ethernet/freescale/fman/inc/enet_ext.h
+++ b/drivers/net/ethernet/freescale/fman/inc/enet_ext.h
@@ -104,6 +104,7 @@ typedef enum e_EnetSpeed
     e_ENET_SPEED_10     = E_ENET_SPEED_10,       /**< 10 Mbps */
     e_ENET_SPEED_100    = E_ENET_SPEED_100,      /**< 100 Mbps */
     e_ENET_SPEED_1000   = E_ENET_SPEED_1000,     /**< 1000 Mbps = 1 Gbps */
+    e_ENET_SPEED_2500   = E_ENET_SPEED_2500,     /**< 2500 Mbps = 2.5 Gbps */
     e_ENET_SPEED_10000  = E_ENET_SPEED_10000     /**< 10000 Mbps = 10 Gbps */
 } e_EnetSpeed;
 
@@ -134,6 +135,7 @@ typedef enum e_EnetMode
     e_ENET_MODE_SGMII_1000        = (e_ENET_IF_SGMII | e_ENET_SPEED_1000),
                                         /**< 1000 Mbps SGMII with auto-negotiation between MAC and
                                              SGMII phy according to Cisco SGMII specification */
+    e_ENET_MODE_SGMII_2500        = (e_ENET_IF_SGMII | e_ENET_SPEED_2500),
     e_ENET_MODE_SGMII_BASEX_10    = (ENET_IF_SGMII_BASEX | e_ENET_IF_SGMII | e_ENET_SPEED_10),
                                         /**< 10 Mbps SGMII with 1000BaseX auto-negotiation between
                                              MAC and SGMII phy or backplane */
diff --git a/drivers/net/ethernet/freescale/fman/inc/flib/fsl_enet.h b/drivers/net/ethernet/freescale/fman/inc/flib/fsl_enet.h
index dde6a4e..caa87fc 100644
--- a/drivers/net/ethernet/freescale/fman/inc/flib/fsl_enet.h
+++ b/drivers/net/ethernet/freescale/fman/inc/flib/fsl_enet.h
@@ -58,6 +58,7 @@ enum enet_speed {
 	E_ENET_SPEED_10		= 10,	/**< 10 Mbps */
 	E_ENET_SPEED_100	= 100,	/**< 100 Mbps */
 	E_ENET_SPEED_1000	= 1000,	/**< 1000 Mbps = 1 Gbps */
+	E_ENET_SPEED_2500	= 2500,	/**< 2500 Mbps = 2.5 Gbps */
 	E_ENET_SPEED_10000	= 10000	/**< 10000 Mbps = 10 Gbps */
 };
 
diff --git a/include/linux/phy.h b/include/linux/phy.h
index ed39956..b95266d 100644
--- a/include/linux/phy.h
+++ b/include/linux/phy.h
@@ -77,6 +77,7 @@ typedef enum {
 	PHY_INTERFACE_MODE_MOCA,
 	PHY_INTERFACE_MODE_QSGMII,
 	PHY_INTERFACE_MODE_MAX,
+	PHY_INTERFACE_MODE_SGMII_2500,
 } phy_interface_t;
 
 /**
-- 
1.7.5.4

