From 6006ccb33244a4d7f15a4ee39e152d8637c98725 Mon Sep 17 00:00:00 2001
From: Cristian Sovaiala <cristian.sovaiala@freescale.com>
Date: Tue, 14 Jul 2015 15:25:04 +0300
Subject: [PATCH 308/451] dpaa_eth: Use S/G accessors in the Shared-Mac driver

Signed-off-by: Cristian Sovaiala <cristian.sovaiala@freescale.com>
Change-Id: I8cd380c142a6e5894cb6e96091ace63f6b297450
[Xulin: Original patch taken from
Linux-LS1043A-SDK-V0.4-SOURCE-20150826-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 .../net/ethernet/freescale/dpa/dpaa_eth_shared.c   |   30 +++++++++++--------
 1 files changed, 17 insertions(+), 13 deletions(-)

diff --git a/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c b/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
index 8a1ad44..ea4ff36 100644
--- a/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
+++ b/drivers/net/ethernet/freescale/dpa/dpaa_eth_shared.c
@@ -234,6 +234,9 @@ shared_rx_dqrr(struct qman_portal *portal, struct qman_fq *fq,
 	struct sk_buff *skb;
 	struct qm_sg_entry *sgt;
 	int i;
+	void *frag_addr;
+	u32 frag_length;
+	u32 offset;
 
 	net_dev = ((struct dpa_fq *)fq)->net_dev;
 	priv = netdev_priv(net_dev);
@@ -269,20 +272,21 @@ shared_rx_dqrr(struct qman_portal *portal, struct qman_fq *fq,
 
 	if (fd->format == qm_fd_sg) {
 		if (dpa_bp->vaddr) {
-			sgt = dpa_phys2virt(dpa_bp, qm_fd_addr(fd)) +
-				dpa_fd_offset(fd);
+			sgt = dpa_phys2virt(dpa_bp,
+					    qm_fd_addr(fd)) + dpa_fd_offset(fd);
 
 			for (i = 0; i < DPA_SGT_MAX_ENTRIES; i++) {
-				void *frag_addr = dpa_phys2virt(dpa_bp,
-						qm_sg_addr(&sgt[i]) +
-						be16_to_cpu(sgt[i].offset));
-				u32 frag_length = be32_to_cpu(sgt[i].length);
-				BUG_ON(sgt[i].extension);
+				offset = qm_sg_entry_get_offset(&sgt[i]);
+				frag_addr = dpa_phys2virt(dpa_bp,
+							  qm_sg_addr(&sgt[i]) +
+							  offset);
+				DPA_BUG_ON(qm_sg_entry_get_ext(&sgt[i]));
+				frag_length = qm_sg_entry_get_len(&sgt[i]);
 
 				/* copy from sgt[i] */
 				memcpy(skb_put(skb, frag_length), frag_addr,
-						frag_length);
-				if (sgt[i].final)
+				       frag_length);
+				if (qm_sg_entry_get_final(&sgt[i]))
 					break;
 			}
 		} else {
@@ -301,15 +305,15 @@ shared_rx_dqrr(struct qman_portal *portal, struct qman_fq *fq,
 							dpa_bp->size));
 
 			for (i = 0; i < DPA_SGT_MAX_ENTRIES; i++) {
-				u32 frag_length = be32_to_cpu(sgt[i].length);
-				BUG_ON(sgt[i].extension);
+				DPA_BUG_ON(qm_sg_entry_get_ext(&sgt[i]));
+				frag_length = qm_sg_entry_get_len(&sgt[i]);
 				copy_from_unmapped_area(
 						skb_put(skb, frag_length),
 						qm_sg_addr(&sgt[i]) +
-						be16_to_cpu(sgt[i].offset),
+						qm_sg_entry_get_offset(&sgt[i]),
 						frag_length);
 
-				if (sgt[i].final)
+				if (qm_sg_entry_get_final(&sgt[i]))
 					break;
 			}
 
-- 
1.7.5.4

