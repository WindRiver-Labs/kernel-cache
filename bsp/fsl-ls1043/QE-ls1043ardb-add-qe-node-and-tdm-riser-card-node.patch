From 761780711b46a7078524f3b9e42ab6d181b7eb0c Mon Sep 17 00:00:00 2001
From: Zhao Qiang <B45475@freescale.com>
Date: Tue, 30 Jun 2015 12:03:46 +0800
Subject: [PATCH 250/451] QE/ls1043ardb: add qe node and tdm riser card node

Add qe node and tdm riser card node to ls1043ardb.dts.
Update device bindings.

Signed-off-by: Zhao Qiang <B45475@freescale.com>
[Xulin: Original patch taken from
Linux-LS1043A-SDK-V0.4-SOURCE-20150826-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 .../devicetree/bindings/powerpc/fsl/cpm_qe/qe.txt  |   45 ++++++++++++++
 .../bindings/powerpc/fsl/cpm_qe/serial.txt         |    1 +
 .../devicetree/bindings/powerpc/fsl/cpm_qe/tdm.txt |   24 +++++++
 .../devicetree/bindings/tdm/maxim,ds26522.txt      |   13 ++++
 arch/arm64/boot/dts/freescale/fsl-ls1043a-rdb.dts  |   36 +++++++++++
 arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi     |   64 ++++++++++++++++++++
 drivers/tdm/line_ctrl/slic_maxim.c                 |    1 +
 7 files changed, 184 insertions(+), 0 deletions(-)
 create mode 100644 Documentation/devicetree/bindings/powerpc/fsl/cpm_qe/tdm.txt
 create mode 100644 Documentation/devicetree/bindings/tdm/maxim,ds26522.txt

diff --git a/Documentation/devicetree/bindings/powerpc/fsl/cpm_qe/qe.txt b/Documentation/devicetree/bindings/powerpc/fsl/cpm_qe/qe.txt
index 4f89302..0811024 100644
--- a/Documentation/devicetree/bindings/powerpc/fsl/cpm_qe/qe.txt
+++ b/Documentation/devicetree/bindings/powerpc/fsl/cpm_qe/qe.txt
@@ -46,6 +46,51 @@ Example:
 	bus-frequency = <179A7B00>;
      }
 
+* Interrupt Controller
+
+Required properties:
+- compatible : should be "fsl,qe-ic".
+- reg : offset and length of the device registers.
+- interrupts: high interrupt and low interrupt
+
+Example:
+	qeic: qeic@80 {
+		compatible = "fsl,qe-ic";
+		reg = <0x80 0x80>;
+		#address-cells = <0>;
+		interrupt-controller;
+		#interrupt-cells = <1>;
+		interrupts = <0 77 0x04 0 77 0x04>;
+	};
+
+* Serial Interface
+
+Required properties:
+- compatible : should be "fsl,qe-si".
+- reg : offset and length of the device registers.
+
+Example:
+	si1: si@700 {
+		#address-cells = <1>;
+		#size-cells = <0>;
+		compatible = "fsl,qe-si";
+		reg = <0x700 0x80>;
+	};
+
+* Serial Interface RAM
+
+Required properties:
+- compatible : should be "fsl,qe-siram".
+- reg : offset and length of the device registers.
+
+Example:
+	siram1: siram@1000 {
+		#address-cells = <1>;
+		#size-cells = <1>;
+		compatible = "fsl,qe-siram";
+		reg = <0x1000 0x800>;
+	};
+
 * Multi-User RAM (MURAM)
 
 Required properties:
diff --git a/Documentation/devicetree/bindings/powerpc/fsl/cpm_qe/serial.txt b/Documentation/devicetree/bindings/powerpc/fsl/cpm_qe/serial.txt
index 2ea76d9..c468593 100644
--- a/Documentation/devicetree/bindings/powerpc/fsl/cpm_qe/serial.txt
+++ b/Documentation/devicetree/bindings/powerpc/fsl/cpm_qe/serial.txt
@@ -6,6 +6,7 @@ Currently defined compatibles:
 - fsl,cpm1-scc-uart
 - fsl,cpm2-scc-uart
 - fsl,qe-uart
+- fsl,ucc_uart
 
 Modem control lines connected to GPIO controllers are listed in the gpios
 property as described in booting-without-of.txt, section IX.1 in the following
diff --git a/Documentation/devicetree/bindings/powerpc/fsl/cpm_qe/tdm.txt b/Documentation/devicetree/bindings/powerpc/fsl/cpm_qe/tdm.txt
new file mode 100644
index 0000000..fcfb14a
--- /dev/null
+++ b/Documentation/devicetree/bindings/powerpc/fsl/cpm_qe/tdm.txt
@@ -0,0 +1,24 @@
+* TDM
+
+Currently defined compatibles:
+- fsl,ucc-tdm
+
+Time Division Multiplex, pins:
+
+RXD, TXD, RQ, TSYNC, RSYNC, RX_CLK, TX_CLK.
+
+
+Example:
+	tdma: ucc@2000 {
+		compatible = "fsl,ucc-tdm";
+		rx-clock-name = "clk8";
+		tx-clock-name = "clk9";
+		fsl,rx-sync-clock = "rsync_pin";
+		fsl,tx-sync-clock = "tsync_pin";
+		fsl,tx-timeslot = <0xfffffffe>;
+		fsl,rx-timeslot = <0xfffffffe>;
+		fsl,tdm-framer-type = "e1";
+		fsl,tdm-mode = "normal";
+		fsl,tdm-id = <0>;
+		fsl,siram-entry-id = <0>;
+	};
diff --git a/Documentation/devicetree/bindings/tdm/maxim,ds26522.txt b/Documentation/devicetree/bindings/tdm/maxim,ds26522.txt
new file mode 100644
index 0000000..3548c51
--- /dev/null
+++ b/Documentation/devicetree/bindings/tdm/maxim,ds26522.txt
@@ -0,0 +1,13 @@
+* Maxim (Dallas) DS26522 Octal T1/E1/J1 Transceiver
+
+Required properties:
+- compatible: Should contain "maxim,ds26522".
+- reg: SPI CS
+- spi-max-frequency: SPI bus max frequency.
+
+Example:
+	slic@2 {
+		compatible = "maxim,ds26522";
+		reg = <2>;
+		spi-max-frequency = <2000000>;
+	};
diff --git a/arch/arm64/boot/dts/freescale/fsl-ls1043a-rdb.dts b/arch/arm64/boot/dts/freescale/fsl-ls1043a-rdb.dts
index 7aca3e4..14cf124 100644
--- a/arch/arm64/boot/dts/freescale/fsl-ls1043a-rdb.dts
+++ b/arch/arm64/boot/dts/freescale/fsl-ls1043a-rdb.dts
@@ -58,6 +58,18 @@
 			reg = <0x00700000 0x00900000>;
 		};
 	};
+
+	slic@2 {
+		compatible = "maxim,ds26522";
+		reg = <2>;
+		spi-max-frequency = <2000000>;
+	};
+
+	slic@3 {
+		compatible = "maxim,ds26522";
+		reg = <3>;
+		spi-max-frequency = <2000000>;
+	};
 };
 
 &i2c0 {
@@ -273,3 +285,27 @@
 		};
 	};
 };
+
+&uqe {
+	tdma: ucc@2000 {
+		compatible = "fsl,ucc-tdm";
+		rx-clock-name = "clk8";
+		tx-clock-name = "clk9";
+		fsl,rx-sync-clock = "rsync_pin";
+		fsl,tx-sync-clock = "tsync_pin";
+		fsl,tx-timeslot = <0xfffffffe>;
+		fsl,rx-timeslot = <0xfffffffe>;
+		fsl,tdm-framer-type = "e1";
+		fsl,tdm-mode = "normal";
+		fsl,tdm-id = <0>;
+		fsl,siram-entry-id = <0>;
+	};
+
+	serial: ucc@2200 {
+		device_type = "serial";
+		compatible = "ucc_uart";
+		port-number = <1>;
+		rx-clock-name = "brg2";
+		tx-clock-name = "brg2";
+	};
+};
diff --git a/arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi b/arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi
index e092bb6..5f27057 100644
--- a/arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi
+++ b/arch/arm64/boot/dts/freescale/fsl-ls1043a.dtsi
@@ -721,6 +721,70 @@
 		#interrupt-cells = <2>;
 	};
 
+	uqe: uqe@2400000 {
+		#address-cells = <1>;
+		#size-cells = <1>;
+		device_type = "qe";
+		compatible = "fsl,qe", "simple-bus";
+		ranges = <0x0 0x0 0x2400000 0x40000>;
+		reg = <0x0 0x2400000 0x0 0x480>;
+		brg-frequency = <100000000>;
+		bus-frequency = <200000000>;
+
+		fsl,qe-num-riscs = <1>;
+		fsl,qe-num-snums = <28>;
+
+		qeic: qeic@80 {
+			compatible = "fsl,qe-ic";
+			reg = <0x80 0x80>;
+			#address-cells = <0>;
+			interrupt-controller;
+			#interrupt-cells = <1>;
+			interrupts = <0 77 0x04 0 77 0x04>;
+		};
+
+		si1: si@700 {
+			#address-cells = <1>;
+			#size-cells = <0>;
+			compatible = "fsl,qe-si";
+			reg = <0x700 0x80>;
+		};
+
+		siram1: siram@1000 {
+			#address-cells = <1>;
+			#size-cells = <1>;
+			compatible = "fsl,qe-siram";
+			reg = <0x1000 0x800>;
+		};
+
+		ucc@2000 {
+			cell-index = <1>;
+			reg = <0x2000 0x200>;
+			interrupts = <32>;
+			interrupt-parent = <&qeic>;
+		};
+
+		ucc@2200 {
+			cell-index = <3>;
+			reg = <0x2200 0x200>;
+			interrupts = <34>;
+			interrupt-parent = <&qeic>;
+		};
+
+		muram@10000 {
+			#address-cells = <1>;
+			#size-cells = <1>;
+			compatible = "fsl,qe-muram", "fsl,cpm-muram";
+			ranges = <0x0 0x10000 0x6000>;
+
+			data-only@0 {
+				compatible = "fsl,qe-muram-data",
+				"fsl,cpm-muram-data";
+				reg = <0x0 0x6000>;
+			};
+		};
+	};
+
 	lpuart0: serial@2950000 {
 		compatible = "fsl,ls1021a-lpuart";
 		reg = <0x0 0x2950000 0x0 0x1000>;
diff --git a/drivers/tdm/line_ctrl/slic_maxim.c b/drivers/tdm/line_ctrl/slic_maxim.c
index 367b723..280c28e 100644
--- a/drivers/tdm/line_ctrl/slic_maxim.c
+++ b/drivers/tdm/line_ctrl/slic_maxim.c
@@ -37,6 +37,7 @@
 #include <linux/param.h>
 #include <linux/delay.h>
 #include <linux/of.h>
+#include <linux/of_address.h>
 #include <linux/io.h>
 #include "slic_maxim.h"
 
-- 
1.7.5.4

