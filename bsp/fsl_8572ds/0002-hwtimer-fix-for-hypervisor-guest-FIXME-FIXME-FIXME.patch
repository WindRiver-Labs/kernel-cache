From 72cc6090c81742df7e3c5df97a449bc21ed604c0 Mon Sep 17 00:00:00 2001
From: WRS Support <support@windriver.com>
Date: Fri, 2 Oct 2009 16:40:03 -0400
Subject: [PATCH 2/3] hwtimer: fix for hypervisor/guest (FIXME FIXME FIXME)

Force use of jiffy timer for the guest; don't try to go
directly at a hardware clock.

(FIXME: this should not be branch specific; push down into
 the standard queue of patches)

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 arch/powerpc/kernel/time.c |   24 ++++++++++++++++++++++++
 1 files changed, 24 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/time.c b/arch/powerpc/kernel/time.c
index b04b017..2aab922 100644
--- a/arch/powerpc/kernel/time.c
+++ b/arch/powerpc/kernel/time.c
@@ -75,6 +75,7 @@
 
 #ifdef CONFIG_WRHV
 #include <linux/wrhv.h>
+#define HWTIMER_USE_JIFFY 1
 #endif
 
 /* powerpc clocksource/clockevent code */
@@ -652,6 +653,18 @@ void timer_interrupt(struct pt_regs * regs)
 	trace_trap_entry(regs, regs->trap);
 
 	wrhv_timer_interrupt(0, NULL);
+
+#ifdef	HWTIMER_USE_JIFFY
+	if (atomic_dec_and_test(&hwtimer_cpu_trigger[smp_processor_id()])) {
+		atomic_set(&hwtimer_cpu_trigger[smp_processor_id()],
+			num_online_cpus());
+		spin_lock(powerpc_timer.lock);
+		if (powerpc_timer.hook != NULL)
+			(powerpc_timer.hook) (powerpc_timer.hook_data);
+		spin_unlock(powerpc_timer.lock);
+	}
+#endif /* HWTIMER_USE_JIFFY */
+
 #else /* CONFIG_WRHV */
 
 	/* Ensure a positive value is written to the decrementer, or else
@@ -1129,6 +1142,17 @@ void __init time_init(void)
 #ifndef CONFIG_WRHV
 	init_decrementer_clockevent();
 #else
+
+#ifdef HWTIMER_USE_JIFFY
+        if (smp_processor_id() == 0) {
+                unsigned int i;
+                for_each_possible_cpu(i)
+                        atomic_set(&hwtimer_cpu_trigger[i], i + 1);
+
+        register_hwtimer(&powerpc_timer);
+        }
+#endif  /* HWTIMER_USE_JIFFY */
+
 	wrhv_clockevent.cpumask = cpumask_of_cpu(0);
 	clockevents_register_device(&wrhv_clockevent);
 #endif  /* CONFIG_WRHV */
-- 
1.6.3.3

