From 7f6b77ee46f6969e720be5d98431c17b99bce42e Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Fri, 30 Aug 2013 09:46:44 +0800
Subject: [PATCH 1/3] serial: pxa: Correct spin_lock and irqsave usage in
 serial_pxa_console_write

When booting, the kernel will produce calltrace under RT kernel.

BUG: sleeping function called from invalid context at kernel/rtmutex.c:646
in_atomic(): 0, irqs_disabled(): 128, pid: 71, name: mmcqd/1
[<c0017754>] (unwind_backtrace+0x0/0x104) from [<c0670e34>] (dump_stack+0x20/0x24)
[<c0670e34>] (dump_stack+0x20/0x24) from [<c0066004>] (__might_sleep+0xf4/0x118)
[<c0066004>] (__might_sleep+0xf4/0x118) from [<c067a11c>] (rt_spin_lock+0x2c/0x38)
[<c067a11c>] (rt_spin_lock+0x2c/0x38) from [<c03c499c>] (serial_pxa_console_write+0x294/0x2d4)
[<c03c499c>] (serial_pxa_console_write+0x294/0x2d4) from [<c00333cc>] (__call_console_drivers+0xe0/0xf4)
[<c00333cc>] (__call_console_drivers+0xe0/0xf4) from [<c003359c>] (_call_console_drivers+0xb0/0x174)
[<c003359c>] (_call_console_drivers+0xb0/0x174) from [<c0034030>] (console_unlock+0x130/0x2c0)
[<c0034030>] (console_unlock+0x130/0x2c0) from [<c0034818>] (vprintk+0x4e8/0x758)
[<c0034818>] (vprintk+0x4e8/0x758) from [<c067131c>] (printk+0xf0/0xf8)
[<c067131c>] (printk+0xf0/0xf8) from [<c04df910>] (mmc_blk_err_check+0x38c/0x3c8)
[<c04df910>] (mmc_blk_err_check+0x38c/0x3c8) from [<c04d0c74>] (mmc_start_req+0x74/0x128)
[<c04d0c74>] (mmc_start_req+0x74/0x128) from [<c04de704>] (mmc_blk_issue_rw_rq+0x80/0x3b8)
[<c04de704>] (mmc_blk_issue_rw_rq+0x80/0x3b8) from [<c04dec14>] (mmc_blk_issue_rq+0x1d8/0x4bc)
[<c04dec14>] (mmc_blk_issue_rq+0x1d8/0x4bc) from [<c04dff80>] (mmc_queue_thread+0x70/0x130)
[<c04dff80>] (mmc_queue_thread+0x70/0x130) from [<c00574d8>] (kthread+0xa0/0xa4)
[<c00574d8>] (kthread+0xa0/0xa4) from [<c000fabc>] (kernel_thread_exit+0x0/0x8)
cfg80211: Calling CRDA to update world regulatory domain

In RT kernel, spin_lock can't be used in the irq disabled. Replace local_irq_*
functions with _nort versions to not disable interrupt.

Singed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/tty/serial/pxa.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/tty/serial/pxa.c b/drivers/tty/serial/pxa.c
index f55aba6..83a44d1 100644
--- a/drivers/tty/serial/pxa.c
+++ b/drivers/tty/serial/pxa.c
@@ -679,7 +679,7 @@ serial_pxa_console_write(struct console *co, const char *s, unsigned int count)
 
 	clk_prepare_enable(up->clk);
 
-	local_irq_save(flags);
+	local_irq_save_nort(flags);
 	if (up->port.sysrq)
 		locked = 0;
 	else if (oops_in_progress)
@@ -704,7 +704,7 @@ serial_pxa_console_write(struct console *co, const char *s, unsigned int count)
 
 	if (locked)
 		spin_unlock(&up->port.lock);
-	local_irq_restore(flags);
+	local_irq_restore_nort(flags);
 
 	clk_disable_unprepare(up->clk);
 }
-- 
1.7.11

