From 8c7607501dc421c93028cbec64e4f9f1a8674748 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Tue, 20 Aug 2013 17:14:58 +0800
Subject: [PATCH 2/3] rt: arm: mmp3: a spinlock fix for timer_lock

raw spin_lock will be used in the non-preempt context, otherwise
the following calltrace will be popped as expected:

BUG: sleeping function called from invalid context at kernel/rtmutex.c:658
in_atomic(): 1, irqs_disabled(): 128, pid: 0, name: swapper/0
[<c0017820>] (unwind_backtrace+0x0/0x104) from [<c063d2cc>] (dump_stack+0x20/0x24)
[<c063d2cc>] (dump_stack+0x20/0x24) from [<c0067c88>] (__might_sleep+0x12c/0x130)
[<c0067c88>] (__might_sleep+0x12c/0x130) from [<c0646ba4>] (rt_spin_lock+0x2c/0x38)
[<c0646ba4>] (rt_spin_lock+0x2c/0x38) from [<c0028af8>] (timer_set_next_event+0x2c/0x190)
[<c0028af8>] (timer_set_next_event+0x2c/0x190) from [<c00841ac>] (clockevents_program_event+0xd4/0x154)
[<c00841ac>] (clockevents_program_event+0xd4/0x154) from [<c0084f6c>] (tick_handle_periodic_broadcast+0x64/0x74)
[<c0084f6c>] (tick_handle_periodic_broadcast+0x64/0x74) from [<c00289a8>] (timer_interrupt+0x74/0x90)
[<c00289a8>] (timer_interrupt+0x74/0x90) from [<c00af2f8>] (handle_irq_event_percpu+0xf0/0x43c)
[<c00af2f8>] (handle_irq_event_percpu+0xf0/0x43c) from [<c00af6bc>] (handle_irq_event+0x78/0xa0)
[<c00af6bc>] (handle_irq_event+0x78/0xa0) from [<c00b291c>] (handle_fasteoi_irq+0xd4/0x18c)
[<c00b291c>] (handle_fasteoi_irq+0xd4/0x18c) from [<c00ae9b8>] (generic_handle_irq+0x40/0x50)
[<c00ae9b8>] (generic_handle_irq+0x40/0x50) from [<c000f824>] (handle_IRQ+0x68/0xbc)
[<c000f824>] (handle_IRQ+0x68/0xbc) from [<c00084b0>] (asm_do_IRQ+0x18/0x1c)
[<c00084b0>] (asm_do_IRQ+0x18/0x1c) from [<c06475b4>] (__irq_svc+0x34/0xb4)
Exception stack(0xc08edf30 to 0xc08edf78)
df20:                                     60400100 fe282818 00000000 c090ba10
df40: c08ec000 c0953b48 c0650c0c c0910544 c090aba0 562f5842 00000000 c08edf9c
df60: c08edf68 c08edf78 c002c16c c000ff84 60000013 ffffffff
[<c06475b4>] (__irq_svc+0x34/0xb4) from [<c000ff84>] (cpu_idle+0x110/0x12c)
[<c000ff84>] (cpu_idle+0x110/0x12c) from [<c0633480>] (rest_init+0x90/0x94)
[<c0633480>] (rest_init+0x90/0x94) from [<c08498b8>] (start_kernel+0x32c/0x338)
INIT: version 2.88 booting

Signed-off-by: Zumeng.Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-mmp/soc_time.c | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/arch/arm/mach-mmp/soc_time.c b/arch/arm/mach-mmp/soc_time.c
index 5f16e2d..6a95e2a 100644
--- a/arch/arm/mach-mmp/soc_time.c
+++ b/arch/arm/mach-mmp/soc_time.c
@@ -52,7 +52,7 @@
 #define US2CYC_SCALE_FACTOR	10
 static inline cycle_t timer_read(int counter);
 static unsigned long us2cyc_scale;
-static DEFINE_SPINLOCK(timer_lock);
+static DEFINE_RAW_SPINLOCK(timer_lock);
 
 static int irq_timer0, irq_timer1;
 
@@ -77,7 +77,7 @@ static int timer_set_next_event(unsigned long delta,
 	uint32_t cer, reg;
 	unsigned int timer, i;
 
-	spin_lock_irqsave(&timer_lock, flags);
+	raw_spin_lock_irqsave(&timer_lock, flags);
 
 	if (delta < MIN_DELTA)
 		delta = MIN_DELTA;
@@ -121,7 +121,7 @@ static int timer_set_next_event(unsigned long delta,
 	__raw_writel(0x1, TIMERS_VIRT_BASE + TMR_IER(timer));
 	__raw_writel(cer | (1<<timer), TIMERS_VIRT_BASE + TMR_CER);
 
-	spin_unlock_irqrestore(&timer_lock, flags);
+	raw_spin_unlock_irqrestore(&timer_lock, flags);
 	return 0;
 }
 
@@ -140,7 +140,7 @@ static void timer_set_mode(enum clock_event_mode mode,
 	else
 		timer = 2;
 
-	spin_lock_irqsave(&timer_lock, flags);
+	raw_spin_lock_irqsave(&timer_lock, flags);
 
 	switch (mode) {
 	case CLOCK_EVT_MODE_ONESHOT:
@@ -163,7 +163,7 @@ static void timer_set_mode(enum clock_event_mode mode,
 		break;
 	}
 
-	spin_unlock_irqrestore(&timer_lock, flags);
+	raw_spin_unlock_irqrestore(&timer_lock, flags);
 	return;
 }
 
-- 
1.7.11

