From e7b86fc8cd219216eb8bbd4aabf6b2a92e38d337 Mon Sep 17 00:00:00 2001
From: Jiang Bin <bin.jiang@windriver.com>
Date: Tue, 15 Nov 2011 11:45:47 +0800
Subject: [PATCH 73/92] hetmgr: add bootargs

Extracted from 913x_WUSDK_REL_0.9.tar.gz vendor drop.

Following arguments are taken from bootargs:
  * dsp_shared_size
  * dsp_private_addr
  * dsp_private_size
  * shared_ctrl_addr
  * shared_ctrl_size

Others like m2/m3 size and ccsr values are hardcoded as
they do not change for 9131, saving number of bootargs

Signed-off-by: Manish Jaggi <manish.jaggi@freescale.com>
Integrated-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/misc/fsl_psc913x_hetmgr.c |  132 ++++++++++++++++++++++++++-----------
 drivers/misc/fsl_types.h          |    3 +-
 2 files changed, 95 insertions(+), 40 deletions(-)

diff --git a/drivers/misc/fsl_psc913x_hetmgr.c b/drivers/misc/fsl_psc913x_hetmgr.c
index 89dbe1f..911def4 100644
--- a/drivers/misc/fsl_psc913x_hetmgr.c
+++ b/drivers/misc/fsl_psc913x_hetmgr.c
@@ -36,29 +36,78 @@
 #include <linux/cdev.h>
 #include <asm/uaccess.h>
 #include "psc913x_heterogeneous.h"
-/*
- *
- */
 
+#define	PA_CCSRBAR	0xff700000
+#define PA_CCSR_SZ	0x00100000
+#define DSP_CCSRBAR	0xff600000
+#define DSP_CCSR_SZ	0x00100000
+#define DSP_CORE0_M2	0xb0000000
+#define DSP_CORE0_M2_SZ	(512*1024)
 #define HW_SEM_OFFSET	0x17100
-
-int fslhet_devno;
-dev_t fslhet_dev;
-struct cdev fslhet_cdev;
-uint32_t het_mgr_major;
-uint32_t het_mgr_minor;
-sys_map_t sys_map;
-
-int shmid;
-volatile void	*sem;
-shared_area_t shared_area;
-phys_addr_t sh_ctrl_area_mark;
-volatile os_het_control_t	*ctrl;
-
+#define  SETUP_BOOTARG(A) 	\
+		static char *A; \
+		static long get_##A(void)\
+		{		\
+			unsigned long val;\
+			if (!A || \
+				(strict_strtoul(A, 0, &val) < 0))\
+				return -EINVAL;\
+			return val;\
+			\
+		}	\
+		\
+		static int __init get_from_cmdline_##A(char *str) \
+		{\
+			if (!str) \
+				return 0; \
+			A = str; \
+			return 1;  \
+		} \
+		\
+		__setup(#A"=", get_from_cmdline_##A);
+
+#define GETBA(A, B) do {	\
+			int rval = B;	\
+			if (rval == -EINVAL)	\
+				A = 0xffffffff;	\
+			else	\
+				A = rval;	\
+			} while (0);
+
+
+int 			fslhet_devno;
+dev_t 			fslhet_dev;
+struct cdev 		fslhet_cdev;
+uint32_t 		het_mgr_major;
+uint32_t 		het_mgr_minor;
+sys_map_t 		sys_map;
+
+int 			shmid;
+volatile void		*sem;
+shared_area_t 		shared_area;
+phys_addr_t 		sh_ctrl_area_mark;
+os_het_control_t	*ctrl;
+
+SETUP_BOOTARG(dsp_shared_size);
+SETUP_BOOTARG(dsp_private_addr);
+SETUP_BOOTARG(dsp_private_size);
+SETUP_BOOTARG(shared_ctrl_addr);
+SETUP_BOOTARG(shared_ctrl_size);
+#ifdef PSC9132
+SETUP_BOOTARG(dsp_core0_m2_addr);
+SETUP_BOOTARG(dsp_core0_m2_size);
+SETUP_BOOTARG(dsp_core1_m2_addr);
+SETUP_BOOTARG(dsp_core1_m2_size);
+SETUP_BOOTARG(dsp_m3_addr);
+SETUP_BOOTARG(dsp_m3_size);
+#endif
+/*
+SETUP_BOOTARG(pa_shared_size);
+*/
 static int het_mgr_open(struct inode *inode, struct file *filep);
 static int het_mgr_release(struct inode *inode, struct file *filep);
 static int het_mgr_ioctl(struct inode *inode, struct file *filp,
-		unsigned int cmd, unsigned long arg);
+unsigned int cmd, unsigned long arg);
 
 int init_sh_ctrl_area(void)
 {
@@ -69,8 +118,13 @@ int init_sh_ctrl_area(void)
 	pr_info("Shared Control area start address = %x\n",
 			sys_map.sh_ctrl_area.phys_addr);
 
-	ctrl = (volatile os_het_control_t *)ioremap(
+	ctrl = (os_het_control_t *)ioremap(
 		sys_map.sh_ctrl_area.phys_addr, sys_map.sh_ctrl_area.size);
+	if (!ctrl) {
+		printk(KERN_ERR"ioremap failed with addr=%x val=%x\n",
+		sys_map.sh_ctrl_area.phys_addr, sys_map.sh_ctrl_area.size);
+		return -1;
+	}
 	memset((void *)ctrl, 0, 0x4000);
 
 	/* zeroize the structure */
@@ -144,30 +198,34 @@ int hugev2p(range_t *r)
 
 	return 0;
 }
-/*
-Temp function:
-this would be removed when the same is provided from 9131plat file
-*/
+
 int get_het_sys_map(sys_map_t *sysmap)
 {
-	sysmap->pa_ccsrbar.phys_addr = 0xff700000;
-	sysmap->pa_ccsrbar.size = 0x100000;
+	/* GETBA(sysmap->pa_shared_size,get_pa_shared_size()); */
+	GETBA(sysmap->dsp_shared_size, get_dsp_shared_size());
 
-	sysmap->dsp_ccsrbar.phys_addr = 0xff600000;
-	sysmap->dsp_ccsrbar.size = 0x100000;
+	sysmap->pa_ccsrbar.phys_addr = PA_CCSRBAR;
+	sysmap->pa_ccsrbar.size = PA_CCSR_SZ;
 
-	sysmap->linux_priv_area.phys_addr = 0x0;
-	sysmap->linux_priv_area.size = 0x28000000;
+	sysmap->dsp_ccsrbar.phys_addr = DSP_CCSRBAR;
+	sysmap->dsp_ccsrbar.size = DSP_CCSR_SZ;
 
-	sysmap->smart_dsp_os_priv_area.phys_addr = 0x28000000;
-	sysmap->smart_dsp_os_priv_area.size = 0x10000000;
+	GETBA(sysmap->smart_dsp_os_priv_area.phys_addr,
+					 get_dsp_private_addr());
+	GETBA(sysmap->smart_dsp_os_priv_area.size, get_dsp_private_size());
 
-	sysmap->sh_ctrl_area.phys_addr = 0x38000000;
-	sysmap->sh_ctrl_area.size = 0x8000000;
+	GETBA(sysmap->sh_ctrl_area.phys_addr, get_shared_ctrl_addr());
+	GETBA(sysmap->sh_ctrl_area.size, get_shared_ctrl_size());
 
-	sysmap->dsp_core0_m2.phys_addr = 0xb0000000;
-	sysmap->dsp_core0_m2.size = 0x80000;
+	sysmap->dsp_core0_m2.phys_addr = DSP_CORE0_M2;
+	sysmap->dsp_core0_m2.size = DSP_CORE0_M2_SZ;
+#ifdef PSC9132
+	GETBA(sysmap->dsp_core1_m2.phys_addr, get_dsp_core1_m2_addr());
+	GETBA(sysmap->dsp_core1_m2.size, get_dsp_core1_m2_size());
 
+	GETBA(sysmap->dsp_m3.phys_addr, get_dsp_m3_addr());
+	GETBA(sysmap->dsp_m3.size, get_dsp_m3_size());
+#endif
 	return 0;
 }
 
@@ -241,7 +299,6 @@ static int het_mgr_ioctl(struct inode *inode, struct file *filp,
 		ctrl->pa_shared_mem.start_addr =
 			shared_area.pa_ipc_shared.phys_addr;
 		ctrl->pa_shared_mem.size = shared_area.pa_ipc_shared.size;
-
 		ctrl->sc_shared_mem.start_addr =
 			shared_area.dsp_ipc_shared.phys_addr;
 		ctrl->sc_shared_mem.size = shared_area.dsp_ipc_shared.size;
@@ -265,9 +322,6 @@ static int het_mgr_ioctl(struct inode *inode, struct file *filp,
 
 	case IOCTL_HW_SEM_GET_VALUE:
 		copy_from_user(&hwsem, (void *)arg, sizeof(hw_sem_t));
-		pr_info("\n Addr %x Val %x\n", (uint32_t)(sem +
-			hwsem.sem_no*0x8), *(uint32_t *)(sem +
-			hwsem.sem_no*0x8));
 		hwsem.value = *(uint32_t *)(sem + hwsem.sem_no*0x8) ;
 		copy_to_user((void *)arg, &hwsem, sizeof(hw_sem_t));
 		break;
diff --git a/drivers/misc/fsl_types.h b/drivers/misc/fsl_types.h
index 742e8aa..af67089 100644
--- a/drivers/misc/fsl_types.h
+++ b/drivers/misc/fsl_types.h
@@ -38,8 +38,9 @@ typedef struct {
 	uint32_t size;
 } range_t;
 
-
 typedef struct {
+	uint32_t	pa_shared_size;
+	uint32_t	dsp_shared_size;
 	mem_t		pa_ccsrbar;
 	mem_t		dsp_ccsrbar;
 	mem_t		linux_priv_area;
-- 
1.7.0

