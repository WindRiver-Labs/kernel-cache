From 0bf735129bc09c9f95afba3d0f02dfa7e42357f5 Mon Sep 17 00:00:00 2001
From: Jiang Bin <bin.jiang@windriver.com>
Date: Wed, 4 Jan 2012 15:12:02 +0800
Subject: [PATCH 91/92] usb: gadget - Add USB controller version detection

Extracted from 913x_WUSDK_REL_0.9.tar.gz vendor drop.

Add check for version info in peripheral driver.

[ Merge 0227-powerpc-85xx-UTMI-PHY-support-for-P101x-platforms.patch
  0472-fsl-usb-Add-USB-controller-version-detection.patch
  and 0228-powerpc-85xx-ULPI-PHY-support-for-P101x-platforms.patch ]

Signed-off-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/usb/gadget/fsl_udc_core.c |   16 +++++++++++++
 drivers/usb/gadget/fsl_usb2_udc.h |    3 ++
 drivers/usb/misc/fsl_usb.h        |   43 +++++++++++++++++++++++++++++++++++++
 3 files changed, 62 insertions(+), 0 deletions(-)
 create mode 100644 drivers/usb/misc/fsl_usb.h

diff --git a/drivers/usb/gadget/fsl_udc_core.c b/drivers/usb/gadget/fsl_udc_core.c
index f6c68f7..a9c3f22 100644
--- a/drivers/usb/gadget/fsl_udc_core.c
+++ b/drivers/usb/gadget/fsl_udc_core.c
@@ -48,6 +48,7 @@
 #include <asm/cacheflush.h>
 
 #include "fsl_usb2_udc.h"
+#include "../misc/fsl_usb.h"
 
 #define	DRIVER_DESC	"Freescale High-Speed USB SOC Device Controller driver"
 #define	DRIVER_AUTHOR	"Li Yang/Jiang Bo"
@@ -179,6 +180,7 @@ static void nuke(struct fsl_ep *ep, int status)
 static int dr_controller_setup(struct fsl_udc *udc)
 {
 	unsigned int tmp, portctrl;
+	int ver;
 #ifndef CONFIG_ARCH_MXC
 	unsigned int ctrl;
 #endif
@@ -188,14 +190,28 @@ static int dr_controller_setup(struct fsl_udc *udc)
 	/* Config PHY interface */
 	portctrl = fsl_readl(&dr_regs->portsc1);
 	portctrl &= ~(PORTSCX_PHY_TYPE_SEL | PORTSCX_PORT_WIDTH);
+	ver = usb_get_ver_info();
 	switch (udc->phy_mode) {
 	case FSL_USB2_PHY_ULPI:
+		if (ver) {
+			ctrl = __raw_readl(&usb_sys_regs->control);
+			ctrl &= ~USB_CTRL_UTMI_PHY_EN;
+			ctrl |= USB_CTRL_USB_EN;
+			__raw_writel(ctrl, &usb_sys_regs->control);
+		}
 		portctrl |= PORTSCX_PTS_ULPI;
 		break;
 	case FSL_USB2_PHY_UTMI_WIDE:
 		portctrl |= PORTSCX_PTW_16BIT;
 		/* fall through */
 	case FSL_USB2_PHY_UTMI:
+		if (ver) {
+			ctrl = __raw_readl(&usb_sys_regs->control);
+			ctrl |= (USB_CTRL_UTMI_PHY_EN | USB_CTRL_USB_EN);
+			__raw_writel(ctrl, &usb_sys_regs->control);
+			mdelay(10); /* Delay for UTMI PHY CLK to become
+					stable - 10ms*/
+		}
 		portctrl |= PORTSCX_PTS_UTMI;
 		break;
 	case FSL_USB2_PHY_SERIAL:
diff --git a/drivers/usb/gadget/fsl_usb2_udc.h b/drivers/usb/gadget/fsl_usb2_udc.h
index ce3bdc7..f3638ca 100644
--- a/drivers/usb/gadget/fsl_usb2_udc.h
+++ b/drivers/usb/gadget/fsl_usb2_udc.h
@@ -347,6 +347,9 @@ struct usb_sys_interface {
 /* control Register Bit Masks */
 #define  USB_CTRL_IOENB                       0x00000004
 #define  USB_CTRL_ULPI_INT0EN                 0x00000001
+#define USB_CTRL_UTMI_PHY_EN                  0x00000200
+#define USB_CTRL_USB_EN                       0x00000004
+#define USB_CTRL_ULPI_PHY_CLK_SEL             0x00000400
 
 /* Endpoint Queue Head data struct
  * Rem: all the variables of qh are LittleEndian Mode
diff --git a/drivers/usb/misc/fsl_usb.h b/drivers/usb/misc/fsl_usb.h
new file mode 100644
index 0000000..4f433d3
--- /dev/null
+++ b/drivers/usb/misc/fsl_usb.h
@@ -0,0 +1,43 @@
+/*
+ * Copyright 2011 Freescale Semiconductor, Inc.
+ *
+ * This program is free software; you can redistribute it and/or modify it
+ * under the terms of the GNU General Public License as published by the
+ * Free Software Foundation; either version 2 of the License, or (at your
+ * option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful, but
+ * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+ * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
+ * for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software Foundation,
+ * Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+ *
+ */
+
+#ifndef _FSL_USB_H
+#define _FSL_USB_H
+
+#include <linux/of.h>
+
+static inline int usb_get_ver_info(void)
+{
+	struct device_node *np;
+	int ver = 0;
+	/* Check for the USB controller verion info
+	 * 1.6 version maps to p1020, p1010, p3040, P5020
+	 * 2.2 version maps to psc9131, psc9132
+	 */
+	for_each_compatible_node(np, NULL, "fsl-usb2-dr") {
+		if (of_device_is_compatible(np, "fsl-usb2-dr-v1.6"))
+			ver = 1;
+		else if (of_device_is_compatible(np, "fsl-usb2-dr-v2.2"))
+			ver = 2;
+		else
+			ver = 0;
+	}
+	return ver;
+}
+#endif
-- 
1.7.0

