From 9317524f07fd32ef2d705648411e23731ca8bdd1 Mon Sep 17 00:00:00 2001
From: Jiang Bin <bin.jiang@windriver.com>
Date: Tue, 15 Nov 2011 12:17:40 +0800
Subject: [PATCH 77/92] ipc: Use IS_ERR for fsl_get_msg_unit

Extracted from 913x_WUSDK_REL_0.9.tar.gz vendor drop.

Signed-off-by: Manish Jaggi <manish.jaggi@freescale.com>
Integrated-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/misc/fsl_psc913x_ipc.c |   31 ++++++++++++++++++-------------
 1 files changed, 18 insertions(+), 13 deletions(-)

diff --git a/drivers/misc/fsl_psc913x_ipc.c b/drivers/misc/fsl_psc913x_ipc.c
index 8e7f4c3..84e292e 100644
--- a/drivers/misc/fsl_psc913x_ipc.c
+++ b/drivers/misc/fsl_psc913x_ipc.c
@@ -155,28 +155,31 @@ static irqreturn_t msg_intr(int irq, void *dev_id)
 	return IRQ_HANDLED;
 }
 
-void register_msg_intr(void)
+int register_msg_intr(void)
 {
 	int err, i;
 	struct fsl_msg_unit *msg;
 
 	for (i = 0; i < MAX_MSG_IRQ; i++) {
 		msg = fsl_get_msg_unit();
-		if (msg) {
-			pr_info("msg irq %x msg num %x\n", msg->irq,
-				msg->msg_num);
-			fsl_enable_msg(msg);
-			ipc_msg_intr[i] = msg;
+		if (IS_ERR(msg)) {
+			printk(KERN_ERR"Error in fsl_get_msg_uint\n");
+			return (int)msg;
+		}
+		pr_info("msg irq %x msg num %x\n", msg->irq,
+			msg->msg_num);
+		fsl_enable_msg(msg);
+		ipc_msg_intr[i] = msg;
 #if defined(CONFIG_PREEMPT_HARDIRQS)
-			err = request_irq(msg->irq, msg_intr, IRQF_NODELAY,
-				"IPC_MSG", NULL);
+		err = request_irq(msg->irq, msg_intr, IRQF_NODELAY,
+			"IPC_MSG", NULL);
 #else
-			err = request_irq(msg->irq, msg_intr, 0, "IPC_MSG",
-				 NULL);
+		err = request_irq(msg->irq, msg_intr, 0, "IPC_MSG",
+			 NULL);
 #endif
-			pr_info("request_irq err = %x\n", err);
-		}
+		pr_info("request_irq err = %x\n", err);
 	}
+	return 0;
 }
 /*
  * @fsl_913xipc_init
@@ -239,7 +242,9 @@ int fsl_913xipc_init(void)
 		memcpy(&ch[i].bd_base, &phys_addr1, sizeof(phys_addr_t));
 		phys_addr1 += sizeof(os_het_ipc_bd_t)*channel_depth;
 	}
-	register_msg_intr();
+	ret = register_msg_intr();
+	if (ret)
+		 goto end;
 	open_channel_zero();
 end:
 	return ret;
-- 
1.7.0

