From 6b00364e4ef4acf3c9b88e652a23c7fa278fb3f6 Mon Sep 17 00:00:00 2001
From: Jiang Bin <bin.jiang@windriver.com>
Date: Thu, 8 Dec 2011 17:30:21 +0800
Subject: [PATCH 32/92] ppc/gianfar: use fsl_get_sys_freq to get bus frequency

In Gianfar device driver '/soc' is always assumed as its direct parent device
node. Then we can get bus frequency by parsing 'soc' node. But this assumption
isn't compatible for all types of dts files.

So we use fsl_get_sys_freq() to get bus frequency since it's more generic and
can find the bus-frequency node of all FSL devices.

Signed-off-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/net/gianfar.c |    9 ++++-----
 1 files changed, 4 insertions(+), 5 deletions(-)

diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 2807a93..7930a01 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -771,7 +771,7 @@ static int gfar_of_init(struct of_device *ofdev, struct net_device **pdev)
 	const u32 *stash_idx;
 	unsigned int num_tx_qs, num_rx_qs;
 	u32 *tx_queues, *rx_queues;
-	u32 *busFreq;
+	u32 busFreq;
 	u32 etsec_clk;
 	u32 max_filer_rules;
 
@@ -808,11 +808,10 @@ static int gfar_of_init(struct of_device *ofdev, struct net_device **pdev)
 	priv->node = ofdev->node;
 	priv->ndev = dev;
 
-	busFreq = (u32 *)of_get_property
-			(of_get_parent(np), "bus-frequency", NULL);
-	if (busFreq) {
+	busFreq = fsl_get_sys_freq();
+	if (busFreq && (busFreq != -1)) {
 		/* etsec_clk is CCB/2 */
-		etsec_clk = *busFreq/2;
+		etsec_clk = busFreq/2;
 		/* Divide by 1000000 to get freq in MHz */
 		etsec_clk /= 1000000;
 		/*
-- 
1.7.0

