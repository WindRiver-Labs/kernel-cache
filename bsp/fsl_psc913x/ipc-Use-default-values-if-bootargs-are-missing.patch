From 489dd09a2db9d2b03138d6d6e5d3be0063bcd350 Mon Sep 17 00:00:00 2001
From: Jaggi Manish-B10520 <manish.jaggi@freescale.com>
Date: Thu, 20 Oct 2011 12:34:52 +0000
Subject: [PATCH 76/92] ipc: Use default values if bootargs are missing

Extracted from 913x_WUSDK_REL_0.9.tar.gz vendor drop.

If the bootargs are not specifed the default values are used
and the module prints a warning.

Signed-off-by: Manish Jaggi <manish.jaggi@freescale.com>
Integrated-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/misc/fsl_ipc_kmod.h    |    2 ++
 drivers/misc/fsl_psc913x_ipc.c |   14 ++++++++++++--
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/drivers/misc/fsl_ipc_kmod.h b/drivers/misc/fsl_ipc_kmod.h
index 3d17926..8f98683 100644
--- a/drivers/misc/fsl_ipc_kmod.h
+++ b/drivers/misc/fsl_ipc_kmod.h
@@ -23,6 +23,8 @@
 #include <linux/ioctl.h>
 
 #define MAX_SC_PA_CHANNELS	32
+#define MAX_IPC_CHANNELS	64
+#define DEFAULT_CHANNEL_DEPTH	16
 
 typedef struct {
 	uint32_t	max_channels;
diff --git a/drivers/misc/fsl_psc913x_ipc.c b/drivers/misc/fsl_psc913x_ipc.c
index 2ede896..8e7f4c3 100644
--- a/drivers/misc/fsl_psc913x_ipc.c
+++ b/drivers/misc/fsl_psc913x_ipc.c
@@ -52,7 +52,7 @@
 #include <asm/system.h>
 #include <asm/irq.h>
 #include <asm/io.h>
-#define MAX_IPC_CHANNELS 64
+
 #define MAX_MSG_IRQ	4
 
 /*
@@ -198,9 +198,19 @@ int fsl_913xipc_init(void)
 	ipc = r.vaddr;
 	pr_err("os_het_ipc_t phys=%x vaddr=%x \n", (uint32_t)r.phys_addr,
 			(uint32_t)r.vaddr);
-
 	num_channels = get_max_num_ipc_channels();
+	if (num_channels < 0 || num_channels > 64) {
+		num_channels = MAX_IPC_CHANNELS;
+		printk(KERN_ERR"warning: max_num_ipc_channels not set properly,\
+		setting default value = %d\n", num_channels);
+	}
+
 	channel_depth = get_max_channel_depth();
+	if (channel_depth < 0) {
+		channel_depth = DEFAULT_CHANNEL_DEPTH;
+		printk(KERN_ERR"warning: max_channel_depth not set\
+		setting default value = %d\n", channel_depth);
+	}
 
 	r1.size = sizeof(os_het_ipc_channel_t)*num_channels +
 		/* array to hold channel pointers */
-- 
1.7.0

