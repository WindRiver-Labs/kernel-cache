From 5ea313d88df5ae6ed64848f77c3b111e6fb069d4 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Tue, 29 Nov 2011 15:26:42 +0800
Subject: [PATCH 31/92] 1588/gianfar: Fix crash for 1588 proc interface

Extracted from 913x_WUSDK_REL_0.4.tar.gz vendor drop.

1588 functionality can be enabled/disabled via proc entry ie
/proc/ptp_1588.Fix crash which occur when we enable/disable 1588
functionality without having ptp_timer node in dts.

Signed-off-by: Bhaskar Upadhaya <bhaskar.upadhaya@freescale.com>
Signed-off-by: Li Yang <leoli@freescale.com>
Signed-off-by: Priyanka Jain <Priyanka.Jain@freescale.com>
Integrated-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/net/gianfar_1588.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/drivers/net/gianfar_1588.c b/drivers/net/gianfar_1588.c
index d5d4a58..c5cb5c1 100644
--- a/drivers/net/gianfar_1588.c
+++ b/drivers/net/gianfar_1588.c
@@ -744,6 +744,13 @@ static int gfar_1588_proc_write(struct file *file, const char *buffer,
 				(struct gfar_1588_data_t *)data;
 	struct gfar __iomem *regs;
 
+	np = of_find_compatible_node(NULL, NULL, "fsl,gianfar-ptp-timer");
+	if (np == NULL)	{
+		printk(KERN_ERR "1588: Cannot find ptp_timer node. Check"
+				" ptp_timer node in dts \r\n");
+		return -EINVAL;
+	}
+
 	if (count > GFAR_1588_PROCFS_MAX_SIZE)
 		count = GFAR_1588_PROCFS_MAX_SIZE;
 
-- 
1.7.0

