From eabec379efa8d2a1cf8686d8bb81695a6c3c4767 Mon Sep 17 00:00:00 2001
From: Cyril Chemparathy <cyril@ti.com>
Date: Mon, 10 Dec 2012 13:24:04 -0500
Subject: [PATCH 220/256] uio: add support for ioctls

This patch introduces an ioctl handler in uio_info, allowing for basic ioctl
plumbing to underlying drivers.

uio ioctl fix
(cherry picked from commit 75fcbc618c3b8c48ef1db3ae2ecfbb75e1f2a14b)

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/uio/uio.c          |   13 +++++++++++++
 include/linux/uio_driver.h |    2 ++
 2 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/drivers/uio/uio.c b/drivers/uio/uio.c
index a673e5b..f5db217 100644
--- a/drivers/uio/uio.c
+++ b/drivers/uio/uio.c
@@ -716,6 +716,18 @@ static int uio_mmap(struct file *filep, struct vm_area_struct *vma)
 	}
 }
 
+static long uio_ioctl(struct file *filep, unsigned int cmd, unsigned long arg)
+{
+	struct uio_listener *listener = filep->private_data;
+	struct uio_device *idev = listener->dev;
+	long ret = -ENOTSUPP;
+
+	if (idev->info->ioctl)
+		ret = idev->info->ioctl(idev->info, cmd, arg);
+
+	return ret;
+}
+
 static const struct file_operations uio_fops = {
 	.owner		= THIS_MODULE,
 	.open		= uio_open,
@@ -726,6 +738,7 @@ static const struct file_operations uio_fops = {
 	.poll		= uio_poll,
 	.fasync		= uio_fasync,
 	.llseek		= noop_llseek,
+	.unlocked_ioctl	= uio_ioctl,
 };
 
 static int uio_major_init(void)
diff --git a/include/linux/uio_driver.h b/include/linux/uio_driver.h
index 1ad4724..4a69032 100644
--- a/include/linux/uio_driver.h
+++ b/include/linux/uio_driver.h
@@ -80,6 +80,7 @@ struct uio_device;
  * @open:		open operation for this uio device
  * @release:		release operation for this uio device
  * @irqcontrol:		disable/enable irqs when 0/1 is written to /dev/uioX
+ * @ioctl:		ioctl operation for this uio device
  */
 struct uio_info {
 	struct uio_device	*uio_dev;
@@ -95,6 +96,7 @@ struct uio_info {
 	int (*open)(struct uio_info *info, struct inode *inode);
 	int (*release)(struct uio_info *info, struct inode *inode);
 	int (*irqcontrol)(struct uio_info *info, s32 irq_on);
+	long (*ioctl)(struct uio_info *info, unsigned cmd, unsigned long arg);
 };
 
 extern int __must_check
-- 
1.7.5.4

