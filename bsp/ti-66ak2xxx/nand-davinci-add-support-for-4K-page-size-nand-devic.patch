From 215aabe5d63e17e9344a4f01e7c1288300d9a5a2 Mon Sep 17 00:00:00 2001
From: Sandeep Paulraj <s-paulraj@ti.com>
Date: Mon, 3 Dec 2012 15:38:13 -0500
Subject: [PATCH 142/256] nand: davinci: add support for 4K page size nand
 devices

Signed-off-by: Sandeep Paulraj <s-paulraj@ti.com>

Conflicts:

	drivers/mtd/nand/davinci_nand.c
(cherry picked from commit 951453450bf77cb6adc689d808d37a5430310015)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/mtd/nand/davinci_nand.c |   30 ++++++++++++++++++++++++++++++
 1 files changed, 30 insertions(+), 0 deletions(-)

diff --git a/drivers/mtd/nand/davinci_nand.c b/drivers/mtd/nand/davinci_nand.c
index 0e46835..f592942 100644
--- a/drivers/mtd/nand/davinci_nand.c
+++ b/drivers/mtd/nand/davinci_nand.c
@@ -520,6 +520,31 @@ static struct nand_ecclayout hwecc4_2048 = {
 	},
 };
 
+/* An ECC layout for using 4-bit ECC with large-page (4096bytes) flash,
+ * storing ten ECC bytes plus the manufacturer's bad block marker byte,
+ * and not overlapping the default BBT markers.
+ */
+static struct nand_ecclayout hwecc4_4096 __initconst = {
+          .eccbytes = 80,
+          .eccpos = {
+                  /* at the end of spare sector */
+                  48, 49, 50, 51, 52, 53, 54, 55, 56, 57,
+                  58, 59, 60, 61, 62, 63, 64, 65, 66, 67,
+                  68, 69, 70, 71, 72, 73, 74, 75, 76, 77,
+                  78, 79, 80, 81, 82, 83, 84, 85, 86, 87,
+                  88, 89, 90, 91, 92, 93, 94, 95, 96, 97,
+                  98, 99, 100, 101, 102, 103, 104, 105, 106, 107,
+                  108, 109, 110, 111, 112, 113, 114, 115, 116, 117,
+                  118, 119, 120, 121, 122, 123, 124, 125, 126, 127,
+                  },
+          .oobfree = {
+                  /* 2 bytes at offset 0 hold manufacturer badblock markers */
+                  {.offset = 2, .length = 46, },
+                  /* 5 bytes at offset 8 hold BBT markers */
+                  /* 8 bytes at offset 16 hold JFFS2 clean markers */
+         },
+};
+
 #if defined(CONFIG_OF)
 static const struct of_device_id davinci_nand_of_match[] = {
 	{.compatible = "ti,davinci-nand", },
@@ -806,6 +831,11 @@ static int nand_davinci_probe(struct platform_device *pdev)
 			info->chip.ecc.mode = NAND_ECC_HW_OOB_FIRST;
 			goto syndrome_done;
 		}
+		if (chunks == 8) {
+			info->ecclayout = hwecc4_4096;
+			info->chip.ecc.mode = NAND_ECC_HW_OOB_FIRST;
+			goto syndrome_done;
+		}
 
 		/* 4KiB page chips are not yet supported. The eccpos from
 		 * nand_ecclayout cannot hold 80 bytes and change to eccpos[]
-- 
1.7.5.4

