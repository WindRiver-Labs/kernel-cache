From 68362cb576ed6da1dbcb569a85da1aa6f9fe641d Mon Sep 17 00:00:00 2001
From: "Reece R. Pollack" <x0183204@ti.com>
Date: Mon, 24 Jun 2013 18:47:49 -0400
Subject: [PATCH 051/256] dma: keystone: Forget the notifier callback on
 chan_stop

The keystone_pktdma driver didn't forget the notifier callback
information when a channel was stopped. If the same DMA channel
was later reopened, the old notifier callback function could be
called resulting in a crash or corruption.

This patch clears the notifier information on chan_stop.

Signed-off-by: Reece R. Pollack <x0183204@ti.com>
(cherry picked from commit c6fc7905b42b1214365a73909dffb6449847659a)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/dma/keystone-pktdma.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/dma/keystone-pktdma.c b/drivers/dma/keystone-pktdma.c
index 492c5b2..fae2932 100644
--- a/drivers/dma/keystone-pktdma.c
+++ b/drivers/dma/keystone-pktdma.c
@@ -1055,6 +1055,10 @@ static void chan_stop(struct keystone_dma_chan *chan)
 		schedule_timeout_interruptible(DMA_TIMEOUT / 10);
 	} while (time_after(end, jiffies));
 
+	/* Forget the notifier info */
+	chan->notify_info.fn     = NULL;
+	chan->notify_info.fn_arg = NULL;
+
 	/* then disconnect the completion side and hope for the best */
 	if (chan->reg_rx_flow) {
 		__raw_writel(0, &chan->reg_rx_flow->control);
-- 
1.7.5.4

