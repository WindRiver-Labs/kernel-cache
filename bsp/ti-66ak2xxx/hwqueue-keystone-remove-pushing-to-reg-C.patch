From d68990cdd9a58aa58ecdc4dfcf92e8a94c314867 Mon Sep 17 00:00:00 2001
From: Prabhu Kuttiyam <pkuttiyam@ti.com>
Date: Fri, 15 Feb 2013 13:58:17 -0500
Subject: [PATCH 088/256] hwqueue: keystone: remove pushing to reg C

This commit removes pushing to reg C from the hwqueue layer

Signed-off-by: Prabhu Kuttiyam <pkuttiyam@ti.com>

Conflicts:

	drivers/hwqueue/keystone_hwqueue.c
(cherry picked from commit 9b1080eebf0ef9fe27879a8eccc0809ccfbcc7c5)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/hwqueue/keystone_hwqueue.c |   12 ------------
 drivers/hwqueue/keystone_hwqueue.h |    4 ----
 2 files changed, 0 insertions(+), 16 deletions(-)

diff --git a/drivers/hwqueue/keystone_hwqueue.c b/drivers/hwqueue/keystone_hwqueue.c
index 167729a..e5c6eba 100644
--- a/drivers/hwqueue/keystone_hwqueue.c
+++ b/drivers/hwqueue/keystone_hwqueue.c
@@ -218,9 +218,7 @@ khwq_find_region_by_dma(struct khwq_device *kdev, struct khwq_instance *kq,
 static int khwq_push(struct hwqueue_instance *inst, dma_addr_t dma,
 		     unsigned size, unsigned flags)
 {
-	struct khwq_device *kdev = from_hdev(inst->hdev);
 	struct khwq_qmgr_info *qmgr;
-	unsigned long irq_flags;
 	unsigned id;
 	u32 val;
 
@@ -230,18 +228,10 @@ static int khwq_push(struct hwqueue_instance *inst, dma_addr_t dma,
 
 	id = hwqueue_inst_to_id(inst) - qmgr->start_queue;
 
-	spin_lock_irqsave(&kdev->lock, irq_flags);
-
-	if (flags & HWQUEUE_HAS_PACKET_SIZE)
-		__raw_writel((flags & BITS(17)),
-			     &qmgr->reg_push[id].packet_size);
-
 	val = (u32)dma | ((size / 16) - 1);
 
 	__raw_writel(val, &qmgr->reg_push[id].ptr_size_thresh);
 
-	spin_unlock_irqrestore(&kdev->lock, irq_flags);
-
 	return 0;
 }
 
@@ -249,7 +239,6 @@ static dma_addr_t khwq_pop(struct hwqueue_instance *inst, unsigned *size,
 			   unsigned flags)
 {
 	struct khwq_instance *kq = hwqueue_inst_to_priv(inst);
-	struct khwq_device *kdev = from_hdev(inst->hdev);
 	struct khwq_qmgr_info *qmgr;
 	u32 val, desc_size, idx;
 	dma_addr_t dma;
@@ -1159,7 +1148,6 @@ static int khwq_probe(struct platform_device *pdev)
 	INIT_LIST_HEAD(&kdev->pools);
 	INIT_LIST_HEAD(&kdev->regions);
 	INIT_LIST_HEAD(&kdev->pdsps);
-	spin_lock_init(&kdev->lock);
 
 	if (of_property_read_u32_array(node, "range", temp, 2)) {
 		dev_err(dev, "hardware queue range not specified\n");
diff --git a/drivers/hwqueue/keystone_hwqueue.h b/drivers/hwqueue/keystone_hwqueue.h
index c1dedaa..82d5314 100644
--- a/drivers/hwqueue/keystone_hwqueue.h
+++ b/drivers/hwqueue/keystone_hwqueue.h
@@ -21,8 +21,6 @@
 #define DESC_SIZE_MASK	0xful
 #define DESC_PTR_MASK	(~DESC_SIZE_MASK)
 
-#define HWQUEUE_HAS_PACKET_SIZE	BIT(31)
-
 #define BITS(x)		(BIT(x) - 1)
 
 #define THRESH_GTE	BIT(7)
@@ -231,8 +229,6 @@ struct khwq_device {
 	struct list_head		 pools;
 	struct list_head		 pdsps;
 	struct list_head		 qmgrs;
-
-	spinlock_t			 lock;
 };
 
 struct khwq_desc {
-- 
1.7.5.4

