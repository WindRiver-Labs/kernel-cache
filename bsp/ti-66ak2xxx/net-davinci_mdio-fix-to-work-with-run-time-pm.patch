From 16d173a54a63456476fdb995b873589b8abacc09 Mon Sep 17 00:00:00 2001
From: Murali Karicheri <m-karicheri2@ti.com>
Date: Fri, 21 Sep 2012 12:02:00 -0400
Subject: [PATCH 199/256] net: davinci_mdio - fix to work with run time pm

When run time PM is enable, the clk_enable() gets called via
pm_runtime_get_sync() -> pm_clk_resume(). At this point clk
is not prepared. So this fix make sure the clk is prepared
at before calling pm_runtime_get_sync().

Signed-off-by: Murali Karicheri <m-karicheri2@ti.com>
(cherry picked from commit 8621c13fdb71313d5399b77d01e0ed4a250ac810)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/ti/davinci_mdio.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/ti/davinci_mdio.c b/drivers/net/ethernet/ti/davinci_mdio.c
index 0cca9de..772d9d1 100644
--- a/drivers/net/ethernet/ti/davinci_mdio.c
+++ b/drivers/net/ethernet/ti/davinci_mdio.c
@@ -353,7 +353,6 @@ static int davinci_mdio_probe(struct platform_device *pdev)
 	pinctrl_pm_select_default_state(&pdev->dev);
 
 	pm_runtime_enable(&pdev->dev);
-	pm_runtime_get_sync(&pdev->dev);
 	data->clk = clk_get(&pdev->dev, "fck");
 	if (IS_ERR(data->clk)) {
 		dev_err(dev, "failed to get device clock\n");
@@ -362,6 +361,8 @@ static int davinci_mdio_probe(struct platform_device *pdev)
 		goto bail_out;
 	}
 
+	clk_prepare(data->clk);
+	pm_runtime_get_sync(&pdev->dev);
 	dev_set_drvdata(dev, data);
 	data->dev = dev;
 	spin_lock_init(&data->lock);
-- 
1.7.5.4

