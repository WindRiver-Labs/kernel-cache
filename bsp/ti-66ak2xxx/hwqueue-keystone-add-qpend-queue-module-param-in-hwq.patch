From 88a1630c1428d9e2f3463fcb0be40def12f8c3e8 Mon Sep 17 00:00:00 2001
From: WingMan Kwok <w-kwok2@ti.com>
Date: Thu, 10 Apr 2014 17:20:15 -0400
Subject: [PATCH 101/256] hwqueue: keystone: add qpend queue module param in
 hwqueue test

In the hwqueue_test module, a qpend queue is opened for push/pop
test.  But the qpend queue number is hard coded and may not be
applicable on every keystone platform.  This patch adds a module
parameter "qpend=N" to specify the qpend queue N to be used in
the test.

Signed-off-by: WingMan Kwok <w-kwok2@ti.com>
(cherry picked from commit 88f9f737ab3914d7322b290ad303fcf06fef60c3)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/hwqueue/hwqueue_test.c |   14 ++++++++++++--
 1 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/drivers/hwqueue/hwqueue_test.c b/drivers/hwqueue/hwqueue_test.c
index 06a4cb0..ab3400a 100644
--- a/drivers/hwqueue/hwqueue_test.c
+++ b/drivers/hwqueue/hwqueue_test.c
@@ -21,6 +21,9 @@
 #include <linux/module.h>
 #include <linux/types.h>
 
+static uint qpend = 655;
+module_param(qpend, uint, 0444);
+
 struct hwqueue_test_ctx {
 	struct hwqueue *qpool;
 	struct hwqueue *qgenwr;
@@ -110,10 +113,11 @@ static int __init hwqueue_test(void)
 		hwqueue_get_id(qgenrd), qgenrd);
 	ctx.qgenrd = qgenrd;
 
-	qirqwr = hwqueue_open("irq1", 655, O_LOWLATENCY | O_RDWR);
+	qirqwr = hwqueue_open("irq1", qpend, O_LOWLATENCY | O_RDWR);
 	if (IS_ERR_OR_NULL(qirqwr)) {
 		ret = PTR_ERR(qirqwr);
-		pr_err("failed to open write queue, errno=%d\n", ret);
+		pr_err("failed to open write queue: qpend=%u, errno=%d\n",
+			qpend, ret);
 		goto fail;
 	}
 	pr_info("opened qirqwr, id = %d qh = %p\n",
@@ -242,6 +246,7 @@ static int __init hwqueue_test(void)
 	}
 #endif
 
+	pr_info("done\n");
 fail:
 	if (ctx.desc)
 		hwqueue_push(ctx.qpool, ctx.desc, ctx.desc_size, 0);
@@ -263,5 +268,10 @@ fail:
 }
 module_init(hwqueue_test);
 
+static void __exit hwqueue_test_exit(void)
+{
+}
+module_exit(hwqueue_test_exit);
+
 MODULE_LICENSE("GPL");
 MODULE_DESCRIPTION("Hardware queue test driver");
-- 
1.7.5.4

