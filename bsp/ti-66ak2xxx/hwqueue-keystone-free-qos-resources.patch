From 09bd1b9cd626c2623cce3252687ca8694a7c04f1 Mon Sep 17 00:00:00 2001
From: Sandeep Paulraj <s-paulraj@ti.com>
Date: Tue, 13 Nov 2012 17:25:58 -0500
Subject: [PATCH 074/256] hwqueue: keystone: free qos resources

Signed-off-by: Sandeep Paulraj <s-paulraj@ti.com>
(cherry picked from commit 574c3b591b6e94556551b4c15719450fe869b677)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/hwqueue/keystone_hwqueue_qos.c |   38 ++++++++++++++++++++++++++++++++
 1 files changed, 38 insertions(+), 0 deletions(-)

diff --git a/drivers/hwqueue/keystone_hwqueue_qos.c b/drivers/hwqueue/keystone_hwqueue_qos.c
index 3eb0d1a..0f9b583 100644
--- a/drivers/hwqueue/keystone_hwqueue_qos.c
+++ b/drivers/hwqueue/keystone_hwqueue_qos.c
@@ -2524,6 +2524,44 @@ static int khwq_qos_close_queue(struct khwq_range_info *range,
 
 static int khwq_qos_free_range(struct khwq_range_info *range)
 {
+	struct khwq_qos_info *info;
+	struct khwq_qos_shadow *shadow;
+	struct khwq_device *kdev;
+	struct khwq_pdsp_info *pdsp;
+	int i, idx;
+
+	info = range->qos_info;
+	pdsp = info->pdsp;
+	kdev = info->kdev;
+
+	shadow = &info->shadows[QOS_SCHED_PORT_CFG];
+	for (i = shadow->start; i < (shadow->start + shadow->count); i++)
+		if (!test_bit(i, shadow->avail)) {
+			idx = khwq_qos_make_id(pdsp->id, i);
+			khwq_qos_free_sched_port(kdev, idx);
+		}
+
+	shadow = &info->shadows[QOS_DROP_OUT_PROF];
+	for (i = shadow->start; i < (shadow->start + shadow->count); i++)
+		if (!test_bit(i, shadow->avail)) {
+			idx = khwq_qos_make_id(pdsp->id, i);
+			khwq_qos_free_drop_out(kdev, idx);
+		}
+
+	shadow = &info->shadows[QOS_DROP_QUEUE_CFG];
+	for (i = shadow->start; i < (shadow->start + shadow->count); i++)
+		if (!test_bit(i, shadow->avail)) {
+			idx = khwq_qos_make_id(pdsp->id, i);
+			khwq_qos_free_drop_queue(kdev, idx);
+		}
+
+	shadow = &info->shadows[QOS_DROP_CFG_PROF];
+	for (i = shadow->start; i < (shadow->start + shadow->count); i++)
+		if (!test_bit(i, shadow->avail)) {
+			idx = khwq_qos_make_id(pdsp->id, i);
+			khwq_qos_free_drop_cfg(kdev, idx);
+		}
+
 	return 0;
 }
 
-- 
1.7.5.4

