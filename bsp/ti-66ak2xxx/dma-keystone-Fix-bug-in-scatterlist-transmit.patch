From c16129d167181c15ac0bd167539db4cb4d09cee1 Mon Sep 17 00:00:00 2001
From: Reece Pollack <x0183204@ti.com>
Date: Mon, 22 Oct 2012 17:57:10 -0400
Subject: [PATCH 040/256] dma: keystone: Fix bug in scatterlist transmit

When a scatterlist containing multiple data buffers is passed
to chan_prep_slave_sg(), it was not setting the Packet Length
field of the first descriptor properly. This field should be
set to the total length of the packet, but was being set to
the size of the first data buffer. This caused all remaining
buffers to be ignored.

This fix accumulates the total packet size while assembling
the descriptor chain, so that the first descriptor gets set
appropriately. Note that the second and following descriptors
will have their packet length fields set to bogus values, but
these are ignored.
(cherry picked from commit cfb2680ddebd8768127fe66871b9e3a2fc19a827)

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/dma/keystone-pktdma.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/dma/keystone-pktdma.c b/drivers/dma/keystone-pktdma.c
index ea736ae..efe7799 100644
--- a/drivers/dma/keystone-pktdma.c
+++ b/drivers/dma/keystone-pktdma.c
@@ -1484,6 +1484,7 @@ chan_prep_slave_sg(struct dma_chan *achan, struct scatterlist *_sg,
 	struct scatterlist *sg = _sg;
 	unsigned num_sg = _num_sg;
 	unsigned nsg;
+	unsigned packet_len;
 	u32 packet_info, psflags;
 	u32 next_desc;
 	unsigned q_num = (options >> DMA_QNUM_SHIFT) & DMA_QNUM_MASK;
@@ -1543,6 +1544,7 @@ chan_prep_slave_sg(struct dma_chan *achan, struct scatterlist *_sg,
 
 	/* Walk backwards through the scatterlist */
 	next_desc = 0;
+	packet_len = 0;
 	for (sg += num_sg - 1, nsg = num_sg; nsg > 0; --sg, --nsg) {
 		struct keystone_dma_desc *desc;
 		u32 buflen, orig_len;
@@ -1589,8 +1591,9 @@ chan_prep_slave_sg(struct dma_chan *achan, struct scatterlist *_sg,
 
 		buflen = sg_dma_len(sg) & BITS(22);
 		orig_len = (q_num << 28) | buflen;
+		packet_len += buflen;
 		desc_fill(chan, hwdesc,
-			  buflen,		/* desc_info	*/
+			  packet_len,		/* desc_info	*/
 			  chan->tag_info,	/* tag_info	*/
 			  packet_info,		/* packet_info	*/
 			  buflen,		/* buff_len	*/
-- 
1.7.5.4

