From 2375972f4d53b1374a91d4116b9cddd337dd022f Mon Sep 17 00:00:00 2001
From: Murali Karicheri <m-karicheri2@ti.com>
Date: Thu, 7 Feb 2013 15:31:10 -0500
Subject: [PATCH 224/256] rpmsg: PROTO: debug print optimization

Signed-off-by: Sam Nelson <sam.nelson@ti.com>
(cherry picked from commit ba0cc832bf6c6719eeda8308a565a3023c4654c7)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/rpmsg/virtio_rpmsg_bus.c |   24 ++++++++++++++++--------
 net/rpmsg/rpmsg_proto.c          |    8 --------
 2 files changed, 16 insertions(+), 16 deletions(-)

diff --git a/drivers/rpmsg/virtio_rpmsg_bus.c b/drivers/rpmsg/virtio_rpmsg_bus.c
index 6b228bc..b632d52 100644
--- a/drivers/rpmsg/virtio_rpmsg_bus.c
+++ b/drivers/rpmsg/virtio_rpmsg_bus.c
@@ -124,6 +124,15 @@ struct rpmsg_channel_info {
 /* Address 53 is reserved for advertising remote services */
 #define RPMSG_NS_ADDR			(53)
 
+#ifdef DEBUG_VERBOSE
+#define rpmsg_print_hex_dump(msg, a, b, c, d, e, f, g) \
+{ \
+	print_hex_dump(KERN_DEBUG, a, b, c, d, e, f, g); \
+}
+#else
+#define rpmsg_print_hex_dump(msg, a, b, c, d, e, f, g) {}
+#endif
+
 /* sysfs show configuration fields */
 #define rpmsg_show_attr(field, path, format_string)			\
 static ssize_t								\
@@ -767,8 +776,9 @@ int rpmsg_send_offchannel_raw(struct rpmsg_channel *rpdev, u32 src, u32 dst,
 	dev_dbg(dev, "TX From 0x%x, To 0x%x, Len %d, Flags %d, Reserved %d\n",
 					msg->src, msg->dst, msg->len,
 					msg->flags, msg->reserved);
-	print_hex_dump(KERN_DEBUG, "rpmsg_virtio TX: ", DUMP_PREFIX_NONE, 16, 1,
-					msg, sizeof(*msg) + msg->len, true);
+
+	rpmsg_print_hex_dump(KERN_DEBUG, "rpmsg_virtio TX: ", DUMP_PREFIX_NONE,
+				 16, 1, msg, sizeof(*msg) + msg->len, true);
 
 	sg_init_one(&sg, msg, sizeof(*msg) + len);
 
@@ -804,9 +814,9 @@ static int rpmsg_recv_single(struct virtproc_info *vrp, struct device *dev,
 	dev_dbg(dev, "From: 0x%x, To: 0x%x, Len: %d, Flags: %d, Reserved: %d\n",
 					msg->src, msg->dst, msg->len,
 					msg->flags, msg->reserved);
-	print_hex_dump(KERN_DEBUG, "rpmsg_virtio RX: ", DUMP_PREFIX_NONE, 16, 1,
-					msg, sizeof(*msg) + msg->len, true);
 
+	rpmsg_print_hex_dump(KERN_DEBUG, "rpmsg_virtio RX: ", DUMP_PREFIX_NONE,
+				 16, 1, msg, sizeof(*msg) + msg->len, true);
 	/*
 	 * We currently use fixed-sized buffers, so trivially sanitize
 	 * the reported payload length.
@@ -935,9 +945,8 @@ static void rpmsg_ns_cb(struct rpmsg_channel *rpdev, void *data, int len,
 	struct device *dev = &vrp->vdev->dev;
 	int ret;
 
-	print_hex_dump(KERN_DEBUG, "NS announcement: ",
-			DUMP_PREFIX_NONE, 16, 1,
-			data, len, true);
+	rpmsg_print_hex_dump(KERN_DEBUG, "NS announcement: ", DUMP_PREFIX_NONE,
+				 16, 1, data, len, true);
 
 	if (len != sizeof(*msg)) {
 		dev_err(dev, "malformed ns msg (%d)\n", len);
@@ -1058,7 +1067,6 @@ static int rpmsg_probe(struct virtio_device *vdev)
 
 	/* if supported by the remote processor, enable the name service */
 	if (virtio_has_feature(vdev, VIRTIO_RPMSG_F_NS)) {
-		dev_info(&vdev->dev, "Name service feature supported\n");
 		/* a dedicated endpoint handles the name service msgs */
 		vrp->ns_ept = __rpmsg_create_ept(vrp, NULL, rpmsg_ns_cb,
 						vrp, RPMSG_NS_ADDR);
diff --git a/net/rpmsg/rpmsg_proto.c b/net/rpmsg/rpmsg_proto.c
index 5d4bd09..e4836f0 100644
--- a/net/rpmsg/rpmsg_proto.c
+++ b/net/rpmsg/rpmsg_proto.c
@@ -15,8 +15,6 @@
  * GNU General Public License for more details.
  */
 
-#define DEBUG
-
 #define pr_fmt(fmt)    "%s: " fmt, __func__
 
 #include <linux/kernel.h>
@@ -505,15 +503,11 @@ static int rpmsg_proto_probe(struct rpmsg_channel *rpdev)
 	int ret, dst = rpdev->dst, src = rpdev->src, id;
 	struct radix_tree_root *vrp_channels;
 
-	pr_debug("Probe called %d\n", dst);
-	dump_stack();
 	if (dst == RPMSG_ADDR_ANY)
 		return 0;
 
 	id = get_virtproc_id(rpdev->vrp);
 
-	pr_debug("Probe called 1 %d\n", id);
-
 	mutex_lock(&rpmsg_channels_lock);
 
 	/* are we exposing channels for this remote processor yet ? */
@@ -613,8 +607,6 @@ int __init rpmsg_proto_init(void)
 		goto sock_unreg;
 	}
 
-	pr_info("registered rpmsg network protocol\n");
-
 	return 0;
 
 sock_unreg:
-- 
1.7.5.4

