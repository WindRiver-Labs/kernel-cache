From 6ace37096859a60b1f17dda689659d80e9e9d506 Mon Sep 17 00:00:00 2001
From: Sajesh Kumar Saran <sajesh@ti.com>
Date: Mon, 3 Jun 2013 16:25:15 -0400
Subject: [PATCH 226/256] rpmsg: keystone: wb/inv ipc messages when dma
 coherency is enabled

In K2 devices, if dma coherency is enabled, the
coherent_alloc buffers will be cached. In this case
ARM need to write back tx message buffers and
invalidate rx buffers for doing IPC with remote
devices.

Signed-off-by: Sajesh Kumar Saran <sajesh@ti.com>
(cherry picked from commit 461b9c4746c3d918dba757c7bfc31c3545b482c3)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/rpmsg/virtio_rpmsg_bus.c |   11 +++++++++++
 1 files changed, 11 insertions(+), 0 deletions(-)

diff --git a/drivers/rpmsg/virtio_rpmsg_bus.c b/drivers/rpmsg/virtio_rpmsg_bus.c
index b632d52..21a47cf 100644
--- a/drivers/rpmsg/virtio_rpmsg_bus.c
+++ b/drivers/rpmsg/virtio_rpmsg_bus.c
@@ -773,6 +773,11 @@ int rpmsg_send_offchannel_raw(struct rpmsg_channel *rpdev, u32 src, u32 dst,
 	msg->reserved = 0;
 	memcpy(msg->data, data, len);
 
+#ifdef CONFIG_KEYSTONE2_DMA_COHERENT
+	dma_sync_single_for_device(dev, virt_to_dma(dev, (void *)(msg)),
+					sizeof(struct rpmsg_hdr) + msg->len - 1,
+					DMA_TO_DEVICE);
+#endif
 	dev_dbg(dev, "TX From 0x%x, To 0x%x, Len %d, Flags %d, Reserved %d\n",
 					msg->src, msg->dst, msg->len,
 					msg->flags, msg->reserved);
@@ -811,6 +816,12 @@ static int rpmsg_recv_single(struct virtproc_info *vrp, struct device *dev,
 	struct scatterlist sg;
 	int err;
 
+#ifdef CONFIG_KEYSTONE2_DMA_COHERENT
+	dma_sync_single_for_cpu(dev, virt_to_dma(dev, (void *)(msg)),
+					sizeof(struct rpmsg_hdr) + msg->len - 1,
+					DMA_FROM_DEVICE);
+#endif
+
 	dev_dbg(dev, "From: 0x%x, To: 0x%x, Len: %d, Flags: %d, Reserved: %d\n",
 					msg->src, msg->dst, msg->len,
 					msg->flags, msg->reserved);
-- 
1.7.5.4

