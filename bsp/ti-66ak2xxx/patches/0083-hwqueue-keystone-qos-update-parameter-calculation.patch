From 95ab34191955337e6c016cbe489471eb84bf904b Mon Sep 17 00:00:00 2001
From: Sandeep Paulraj <s-paulraj@ti.com>
Date: Fri, 14 Dec 2012 13:51:56 -0500
Subject: [PATCH 083/257] hwqueue: keystone: qos: update parameter calculation

Signed-off-by: Sandeep Paulraj <s-paulraj@ti.com>
(cherry picked from commit a0a34862e9ae924ac42b0e6084354f2a8d307eae)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/hwqueue/keystone_hwqueue_qos.c | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/drivers/hwqueue/keystone_hwqueue_qos.c b/drivers/hwqueue/keystone_hwqueue_qos.c
index 934366b..2add223 100644
--- a/drivers/hwqueue/keystone_hwqueue_qos.c
+++ b/drivers/hwqueue/keystone_hwqueue_qos.c
@@ -369,7 +369,7 @@ static int khwq_program_drop_policy(struct khwq_qos_info *info,
 	error = khwq_qos_set_drop_cfg_red_high(kdev, policy->drop_cfg_idx,
 					       policy->red_high, false);
 
-	val = policy->half_life * (info->ticks_per_sec / 1000);
+	val = policy->half_life / 100;
 	time_constant = ilog2((3 * val) + 1);
 
 	error = khwq_qos_set_drop_cfg_time_const(kdev, policy->drop_cfg_idx,
@@ -673,18 +673,18 @@ khwq_qos_get_drop_policy(struct khwq_device *kdev, struct khwq_qos_info *info,
 	if (elements > 1)
 		policy->red_high = temp[1];
 
-	policy->max_drop_prob = 20;
+	policy->max_drop_prob = 2;
 	if (elements > 2)
 		policy->max_drop_prob = temp[2];
 	if (policy->max_drop_prob >= 100) {
 		dev_warn(kdev->dev, "invalid max drop prob %d on policy %s, taking defaults\n",
 			 policy->max_drop_prob, policy->name);
-		policy->max_drop_prob = 20;
+		policy->max_drop_prob = 2;
 	}
 
 	policy->half_life = 2000;
 	if (elements > 3)
-		policy->half_life = temp[2];
+		policy->half_life = temp[3];
 
 done:
 	if (of_find_property(node, "default", NULL)) {
@@ -2132,7 +2132,7 @@ static int khwq_qos_tree_start_port(struct khwq_qos_info *info,
 	if (WARN_ON(error))
 		return error;
 
-	val = 0;
+	val = qnode->output_rate / info->ticks_per_sec;
 	error = khwq_qos_set_sched_out_throttle(kdev, idx, val, sync);
 	if (WARN_ON(error))
 		return error;
-- 
2.7.4

