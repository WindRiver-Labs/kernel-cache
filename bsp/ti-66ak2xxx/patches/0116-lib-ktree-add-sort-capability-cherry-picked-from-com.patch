From 533f21b581ae4515cd9e97b7f1f0b9389e809277 Mon Sep 17 00:00:00 2001
From: Cyril Chemparathy <cyril@ti.com>
Date: Sat, 27 Oct 2012 00:39:26 -0400
Subject: [PATCH 116/257] lib/ktree: add sort capability (cherry picked from
 commit 084b3db94ff1649e2b1e8ca3befce2bef1f0b6c5)

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 include/linux/ktree.h |  5 +++++
 lib/ktree.c           | 29 +++++++++++++++++++++++++++++
 2 files changed, 34 insertions(+)

diff --git a/include/linux/ktree.h b/include/linux/ktree.h
index 229674a..fe80872 100644
--- a/include/linux/ktree.h
+++ b/include/linux/ktree.h
@@ -119,4 +119,9 @@ int ktree_for_each_child(struct ktree_node *parent,
 			 int (*visitor)(struct ktree_node *child, void *arg),
 			 void *arg);
 
+void ktree_sort_children(struct ktree_node *parent,
+			 int (*cmp)(struct ktree_node *a, struct ktree_node *b,
+				    void *arg),
+			 void *arg);
+
 #endif
diff --git a/lib/ktree.c b/lib/ktree.c
index 46a54c2..5e03632 100644
--- a/lib/ktree.c
+++ b/lib/ktree.c
@@ -37,6 +37,7 @@
 #include <linux/export.h>
 #include <linux/sched.h>
 #include <linux/ktree.h>
+#include <linux/list_sort.h>
 
 static void knode_release(struct kref *kref);
 static void __ktree_put_node(struct ktree_node *node, bool kill);
@@ -354,3 +355,31 @@ int ktree_for_each_child(struct ktree_node *parent,
 	return 0;
 }
 EXPORT_SYMBOL_GPL(ktree_for_each_child);
+
+struct ktree_sort_params
+{
+	int	(*cmp)(struct ktree_node *a, struct ktree_node *b,
+		       void *arg);
+	void	*arg;
+};
+
+static int __ktree_cmp(void *arg, struct list_head *_a, struct list_head *_b)
+{
+	struct ktree_node *a = container_of(_a, struct ktree_node, siblings);
+	struct ktree_node *b = container_of(_b, struct ktree_node, siblings);
+	struct ktree_sort_params *params = arg;
+
+	return params->cmp(a, b, params->arg);
+}
+
+void ktree_sort_children(struct ktree_node *parent,
+			 int (*cmp)(struct ktree_node *a, struct ktree_node *b,
+				    void *arg),
+			 void *arg)
+{
+	struct ktree_sort_params params = { .cmp = cmp, .arg = arg };
+	spin_lock(&parent->ktree->lock);
+	list_sort(&params, &parent->children, __ktree_cmp);
+	spin_unlock(&parent->ktree->lock);
+}
+EXPORT_SYMBOL_GPL(ktree_sort_children);
-- 
2.7.4

