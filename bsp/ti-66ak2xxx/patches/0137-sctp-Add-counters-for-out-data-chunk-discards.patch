From f921c850ee808cabea94cc5625bbf6afae856249 Mon Sep 17 00:00:00 2001
From: Prabhu Kuttiyam <pkuttiyam@ti.com>
Date: Tue, 30 Oct 2012 14:14:06 -0400
Subject: [PATCH 137/257] sctp: Add counters for out data chunk discards

This commit adds a MIB entry for out data chunk discards.
Number of outgoing SCTP DATA chunks for a SCTP association for which no
problems were encountered to prevent their transmission but were discarded.
Data chunks are discarded due to ungraceful closing of the SCTP association.

Signed-off-by: Prabhu Kuttiyam <pkuttiyam@ti.com>
(cherry picked from commit ea034d2b4de06dcbb6a70c7c6be4e38c190477c9)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 include/net/sctp/sctp.h | 1 +
 net/sctp/outqueue.c     | 1 +
 net/sctp/proc.c         | 1 +
 3 files changed, 3 insertions(+)

diff --git a/include/net/sctp/sctp.h b/include/net/sctp/sctp.h
index ba41e01..867d74e 100644
--- a/include/net/sctp/sctp.h
+++ b/include/net/sctp/sctp.h
@@ -212,6 +212,7 @@ enum {
 	SCTP_MIB_IN_PKT_BACKLOG,
 	SCTP_MIB_IN_PKT_DISCARDS,
 	SCTP_MIB_IN_DATA_CHUNK_DISCARDS,
+	SCTP_MIB_OUT_DATA_CHUNK_DISCARDS,
 	__SCTP_MIB_MAX
 };
 
diff --git a/net/sctp/outqueue.c b/net/sctp/outqueue.c
index 9c77947..e286157 100644
--- a/net/sctp/outqueue.c
+++ b/net/sctp/outqueue.c
@@ -315,6 +315,7 @@ int sctp_outq_tail(struct sctp_outq *q, struct sctp_chunk *chunk)
 		case SCTP_STATE_SHUTDOWN_RECEIVED:
 		case SCTP_STATE_SHUTDOWN_ACK_SENT:
 			/* Cannot send after transport endpoint shutdown */
+			SCTP_INC_STATS(net, SCTP_MIB_OUT_DATA_CHUNK_DISCARDS);
 			error = -ESHUTDOWN;
 			break;
 
diff --git a/net/sctp/proc.c b/net/sctp/proc.c
index 0947f1e..2305953 100644
--- a/net/sctp/proc.c
+++ b/net/sctp/proc.c
@@ -67,6 +67,7 @@ static const struct snmp_mib sctp_snmp_list[] = {
 	SNMP_MIB_ITEM("SctpInPktBacklog", SCTP_MIB_IN_PKT_BACKLOG),
 	SNMP_MIB_ITEM("SctpInPktDiscards", SCTP_MIB_IN_PKT_DISCARDS),
 	SNMP_MIB_ITEM("SctpInDataChunkDiscards", SCTP_MIB_IN_DATA_CHUNK_DISCARDS),
+	SNMP_MIB_ITEM("SctpOutDataChunkDiscards", SCTP_MIB_OUT_DATA_CHUNK_DISCARDS),
 	SNMP_MIB_SENTINEL
 };
 
-- 
2.7.4

