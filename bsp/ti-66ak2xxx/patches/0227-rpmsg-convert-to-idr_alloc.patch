From b89a4ffb7f05cb960eafeba4e9746f59447baeee Mon Sep 17 00:00:00 2001
From: Robert Tivy <rtivy@ti.com>
Date: Tue, 15 Oct 2013 18:15:39 -0700
Subject: [PATCH 227/257] rpmsg: convert to idr_alloc()

Convert to the much saner new idr interface.  Preloading unnecessary since
idr is protected w/ mutex.

Signed-off-by: Robert Tivy <rtivy@ti.com>
(cherry picked from commit c77377f21a996826700dc5a706e6319b5f1e11b2)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/rpmsg/virtio_rpmsg_bus.c | 12 +++---------
 1 file changed, 3 insertions(+), 9 deletions(-)

diff --git a/drivers/rpmsg/virtio_rpmsg_bus.c b/drivers/rpmsg/virtio_rpmsg_bus.c
index 21a47cf..595330b 100644
--- a/drivers/rpmsg/virtio_rpmsg_bus.c
+++ b/drivers/rpmsg/virtio_rpmsg_bus.c
@@ -1017,17 +1017,12 @@ static int rpmsg_probe(struct virtio_device *vdev)
 	mutex_init(&vrp->tx_lock);
 	init_waitqueue_head(&vrp->sendq);
 
-	if (!idr_pre_get(&vprocs, GFP_KERNEL))
-		goto free_vrp;
-
 	mutex_lock(&vprocs_mutex);
-
-	err = idr_get_new(&vprocs, vrp, &vproc_id);
-
+	vproc_id = idr_alloc(&vprocs, vrp, 0, 0, GFP_KERNEL);
 	mutex_unlock(&vprocs_mutex);
 
-	if (err) {
-		dev_err(&vdev->dev, "idr_get_new failed: %d\n", err);
+	if (vproc_id < 0) {
+		dev_err(&vdev->dev, "idr_alloc failed: %d\n", vproc_id);
 		goto free_vrp;
 	}
 
@@ -1190,7 +1185,6 @@ static void __exit rpmsg_fini(void)
 	unregister_virtio_driver(&virtio_ipc_driver);
 	bus_unregister(&rpmsg_bus);
 
-	idr_remove_all(&vprocs);
 	idr_destroy(&vprocs);
 }
 module_exit(rpmsg_fini);
-- 
2.7.4

