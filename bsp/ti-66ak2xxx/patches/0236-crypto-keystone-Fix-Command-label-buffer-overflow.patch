From 037a4ebefa1a076cf2e0cdf4d374736edd4de7af Mon Sep 17 00:00:00 2001
From: Sandeep Nair <sandeep_n@ti.com>
Date: Tue, 29 Jul 2014 15:11:43 -0400
Subject: [PATCH 236/257] crypto: keystone: Fix Command label buffer overflow

The maximum size of PSDATA allowed in a 128byte pktdma descriptor
is 64 bytes. Keystone crypto driver sends command-label & the
crypto request context identifier in PSDATA. The driver needs
to ensure that the total size of these don't exceed the size of
PSDATA. Also there was a bug in the driver code that the buffer
size for holding this data was not sufficient.

Signed-off-by: Sandeep Nair <sandeep_n@ti.com>
(cherry picked from commit 2238af0669998d3fcd63b7845eb3542195e6f5de)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/crypto/keystone-sa.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/drivers/crypto/keystone-sa.c b/drivers/crypto/keystone-sa.c
index e0ec336..8e44d90 100644
--- a/drivers/crypto/keystone-sa.c
+++ b/drivers/crypto/keystone-sa.c
@@ -296,7 +296,7 @@ struct sa_tfm_ctx {
 /* Tx DMA callback param */
 struct sa_dma_req_ctx {
 	struct keystone_crypto_data *dev_data;
-	u32		cmdl[SA_MAX_CMDL_WORDS];
+	u32		cmdl[SA_MAX_CMDL_WORDS + SA_NUM_PSDATA_CTX_WORDS];
 	unsigned	map_idx;
 	struct sg_table sg_tbl;
 	dma_cookie_t	cookie;
@@ -2613,7 +2613,7 @@ static int sa_aead_setkey(struct crypto_aead *authenc,
 	memcpy(&ctx->enc.epib[1], &swinfo.word[0], sizeof(swinfo));
 	cmdl_len = sa_format_cmdl_gen(&cfg,
 				(u8 *)ctx->enc.cmdl, &ctx->enc.cmdl_upd_info);
-	if (cmdl_len <= 0)
+	if ((cmdl_len <= 0) || (cmdl_len > SA_MAX_CMDL_WORDS * sizeof(u32)))
 		goto badkey;
 
 	ctx->enc.cmdl_size = cmdl_len;
@@ -2631,7 +2631,7 @@ static int sa_aead_setkey(struct crypto_aead *authenc,
 	cmdl_len = sa_format_cmdl_gen(&cfg,
 				(u8 *)ctx->dec.cmdl, &ctx->dec.cmdl_upd_info);
 
-	if (cmdl_len <= 0)
+	if ((cmdl_len <= 0) || (cmdl_len > SA_MAX_CMDL_WORDS * sizeof(u32)))
 		goto badkey;
 
 	ctx->dec.cmdl_size = cmdl_len;
-- 
2.7.4

