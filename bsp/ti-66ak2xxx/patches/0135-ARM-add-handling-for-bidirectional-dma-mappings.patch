From 25f8d65c36ba2cf0727bbe1d6a03b7aee98c716c Mon Sep 17 00:00:00 2001
From: Cyril Chemparathy <cyril@ti.com>
Date: Tue, 8 May 2012 14:37:29 -0400
Subject: [PATCH 135/257] ARM: add handling for bidirectional dma mappings

This patch adds handling for bidirectional dma maps.  The modification to
v7_dma_map_area is consistent with existing implementation on earlier ARM
architectures (e.g. see arch/arm/mm/cache-v6.S).  In addition,
__dma_page_cpu_to_dev() has been extended to clean and invalidate
the outer cache for bidirectional maps.
(cherry picked from commit ee352abc680ffdaf8f4dc17a45e53acf6fc37806)

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mm/cache-v7.S    |  7 ++++---
 arch/arm/mm/dma-mapping.c | 13 ++++++++-----
 2 files changed, 12 insertions(+), 8 deletions(-)

diff --git a/arch/arm/mm/cache-v7.S b/arch/arm/mm/cache-v7.S
index 778bcf8..7f93601 100644
--- a/arch/arm/mm/cache-v7.S
+++ b/arch/arm/mm/cache-v7.S
@@ -424,9 +424,10 @@ ENDPROC(v7_dma_flush_range)
  */
 ENTRY(v7_dma_map_area)
 	add	r1, r1, r0
-	teq	r2, #DMA_FROM_DEVICE
-	beq	v7_dma_inv_range
-	b	v7_dma_clean_range
+	cmp	r2, #DMA_TO_DEVICE
+	beq	v7_dma_clean_range
+	bcs	v7_dma_inv_range
+	b	v7_dma_flush_range
 ENDPROC(v7_dma_map_area)
 
 /*
diff --git a/arch/arm/mm/dma-mapping.c b/arch/arm/mm/dma-mapping.c
index 42f2fb8..0c6df19 100644
--- a/arch/arm/mm/dma-mapping.c
+++ b/arch/arm/mm/dma-mapping.c
@@ -899,15 +899,18 @@ static void __dma_page_cpu_to_dev(struct page *page, unsigned long off,
 {
 	unsigned long paddr;
 
+	if (unlikely(dir == DMA_NONE))
+		return;
+
 	dma_cache_maint_page(page, off, size, dir, dmac_map_area);
 
 	paddr = page_to_phys(page) + off;
-	if (dir == DMA_FROM_DEVICE) {
-		outer_inv_range(paddr, paddr + size);
-	} else {
+
+	if (dir != DMA_FROM_DEVICE)
 		outer_clean_range(paddr, paddr + size);
-	}
-	/* FIXME: non-speculating: flush on bidirectional mappings? */
+
+	if (dir != DMA_TO_DEVICE)
+		outer_inv_range(paddr, paddr + size);
 }
 
 static void __dma_page_dev_to_cpu(struct page *page, unsigned long off,
-- 
2.7.4

