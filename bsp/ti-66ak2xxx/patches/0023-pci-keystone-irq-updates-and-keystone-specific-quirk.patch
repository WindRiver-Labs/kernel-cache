From 3648be7cf86742fdf084ae8e150017c85271ca9c Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Tue, 28 Feb 2017 09:52:57 +0800
Subject: [PATCH 023/257] pci: keystone: irq updates and keystone specific
 quirks

Update IRQ_EOI for msi irq ack function. Also add a pci quirks to
change maximum read request size to 256 bytes to force all EP
to use this size for Keystone PCI.

Signed-off-by: Murali Karicheri <m-karicheri2@ti.com>
(cherry picked from commit fe261e9f7b4942d0ce21d4b6df35e81695adddbd)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/pci/host/pcie-keystone.c |  4 +++-
 drivers/pci/quirks.c             | 12 ++++++++++++
 2 files changed, 15 insertions(+), 1 deletion(-)

diff --git a/drivers/pci/host/pcie-keystone.c b/drivers/pci/host/pcie-keystone.c
index 85a03ee..211bc0b 100644
--- a/drivers/pci/host/pcie-keystone.c
+++ b/drivers/pci/host/pcie-keystone.c
@@ -66,7 +66,7 @@
 #define IRQ_ENABLE_SET			0x188
 #define IRQ_ENABLE_CLR			0x18c
 
-#define MSI_IRQ_OFFSET_SHIFT            4
+#define MSI_IRQ_OFFSET			4
 
 /*
  * PCIe Config Register Offsets (capabilities)
@@ -762,6 +762,8 @@ static void ack_msi(struct irq_data *d)
 
 	__raw_writel(BIT(bit_pos),
 		info->reg_cfg_virt + MSI0_IRQ_STATUS + (offset << 2));
+
+	__raw_writel(offset + MSI_IRQ_OFFSET, info->reg_cfg_virt + IRQ_EOI);
 }
 
 static void mask_msi(struct irq_data *d)
diff --git a/drivers/pci/quirks.c b/drivers/pci/quirks.c
index 27abeb4..4e227e0 100644
--- a/drivers/pci/quirks.c
+++ b/drivers/pci/quirks.c
@@ -3496,3 +3496,15 @@ int pci_dev_specific_acs_enabled(struct pci_dev *dev, u16 acs_flags)
 
 	return -ENOTTY;
 }
+
+#ifdef CONFIG_TI_KEYSTONE_PCIE
+/*
+ * The KeyStone PCIe controller has maximum read request size of 256 bytes.
+ * Force this configuration for all EP including bridges.
+ */
+static void __init quirk_limit_readrequest(struct pci_dev *dev)
+{
+       pcie_set_readrq(dev, 256);
+}
+DECLARE_PCI_FIXUP_FINAL(PCI_ANY_ID, PCI_ANY_ID, quirk_limit_readrequest);
+#endif /* CONFIG_TI_KEYSTONE_PCIE */
-- 
2.7.4

