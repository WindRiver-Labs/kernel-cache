From 793eec969ae6d520005f65fc601525d1abc15b85 Mon Sep 17 00:00:00 2001
From: Cyril Chemparathy <cyril@ti.com>
Date: Thu, 8 Nov 2012 10:52:34 -0500
Subject: [PATCH 040/257] dma: keystone: fix cookie range to honor min limit
 (cherry picked from commit 2f04ce465b208d4b111a79cb9c3ad6ba7133c739)

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/dma/keystone-pktdma.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/dma/keystone-pktdma.c b/drivers/dma/keystone-pktdma.c
index fecb814..11ea6ba 100644
--- a/drivers/dma/keystone-pktdma.c
+++ b/drivers/dma/keystone-pktdma.c
@@ -1072,7 +1072,7 @@ static int chan_setup_descs(struct keystone_dma_chan *chan)
 		desc = desc_from_index(chan, i);
 
 		adesc = desc_to_adesc(desc);
-		adesc->cookie = desc_to_index(chan, desc);
+		adesc->cookie = DMA_MIN_COOKIE + desc_to_index(chan, desc);
 		adesc->chan = to_achan(chan);
 		adesc->tx_submit = chan_submit;
 
@@ -1469,9 +1469,10 @@ static enum dma_status chan_xfer_status(struct dma_chan *achan,
 				      struct dma_tx_state *txstate)
 {
 	struct keystone_dma_chan *chan = from_achan(achan);
-	struct keystone_dma_desc *desc = desc_from_index(chan, cookie);
+	struct keystone_dma_desc *desc;
 	enum dma_status status;
 
+	desc = desc_from_index(chan, cookie - DMA_MIN_COOKIE);
 	status = desc ? desc->status : DMA_ERROR;
 	chan_vdbg(chan, "returning status %d for desc %p\n", status, desc);
 
-- 
2.7.4

