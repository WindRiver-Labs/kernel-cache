From f77ea0b4d6d8fd1cd68737f68a7dd91170f4e226 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Mon, 13 Apr 2015 15:42:44 +0800
Subject: [PATCH 061/257] ethernet: keystone: fix not exist sctp_update_cksum

Since sctp_update_cksum and sctp_end_cksum don't exist any more
so we fallback on crc32c.

drivers/net/ethernet/ti/keystone_pa.c:1829:3: error: implicit declaration of function 'sctp_update_cksum' [-Werror=implicit-function-declaration]
   csum = sctp_update_cksum(skb->data + offset, copy, csum);
   ^

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/ti/keystone_pa.c  | 9 +++++----
 drivers/net/ethernet/ti/keystone_pa2.c | 8 ++++----
 2 files changed, 9 insertions(+), 8 deletions(-)

diff --git a/drivers/net/ethernet/ti/keystone_pa.c b/drivers/net/ethernet/ti/keystone_pa.c
index 5b4875f..f37f7ef 100644
--- a/drivers/net/ethernet/ti/keystone_pa.c
+++ b/drivers/net/ethernet/ti/keystone_pa.c
@@ -1826,7 +1826,7 @@ static __wsum skb_sctp_csum(struct sk_buff *skb, int offset,
 	if (copy > 0) {
 		if (copy > len)
 			copy = len;
-		csum = sctp_update_cksum(skb->data + offset, copy, csum);
+		csum = crc32c((__u32)csum, (u8 *)(skb->data + offset), copy);
 		if ((len -= copy) == 0)
 			return csum;
 		offset += copy;
@@ -1846,8 +1846,9 @@ static __wsum skb_sctp_csum(struct sk_buff *skb, int offset,
 			if (copy > len)
 				copy = len;
 			vaddr = kmap_atomic(skb_frag_page(frag));
-			csum = sctp_update_cksum(vaddr + frag->page_offset +
-					 offset - start, copy, csum);
+
+			csum = crc32c((__u32)csum, (u8 *)(vaddr + frag->page_offset +
+					 offset - start), copy);
 			kunmap_atomic(vaddr);
 			if (!(len -= copy))
 				return csum;
@@ -1923,7 +1924,7 @@ static int skb_sctp_csum_help(struct sk_buff *skb)
 			goto out;
 	}
 
-	*(__le32 *)(skb->data + offset) = sctp_end_cksum(csum);
+	*(__le32 *)(skb->data + offset) = cpu_to_le32(~(__u32)csum);
 out_set_summed:
 	skb->ip_summed = CHECKSUM_NONE;
 out:
diff --git a/drivers/net/ethernet/ti/keystone_pa2.c b/drivers/net/ethernet/ti/keystone_pa2.c
index caca6ff..4cf4228 100644
--- a/drivers/net/ethernet/ti/keystone_pa2.c
+++ b/drivers/net/ethernet/ti/keystone_pa2.c
@@ -2220,7 +2220,7 @@ static __wsum skb_sctp_csum(struct sk_buff *skb, int offset,
 	if (copy > 0) {
 		if (copy > len)
 			copy = len;
-		csum = sctp_update_cksum(skb->data + offset, copy, csum);
+		csum = crc32c((__u32)csum, (u8 *)(skb->data + offset), copy);
 		len -= copy;
 		if (len == 0)
 			return csum;
@@ -2242,8 +2242,8 @@ static __wsum skb_sctp_csum(struct sk_buff *skb, int offset,
 			if (copy > len)
 				copy = len;
 			vaddr = kmap_atomic(skb_frag_page(frag));
-			csum = sctp_update_cksum(vaddr + frag->page_offset +
-					 offset - start, copy, csum);
+			csum = crc32c((__u32)csum, (u8 *)(vaddr + frag->page_offset +
+					 offset - start), copy);
 			kunmap_atomic(vaddr);
 			len -= copy;
 			if (!len)
@@ -2322,7 +2322,7 @@ static int skb_sctp_csum_help(struct sk_buff *skb)
 			goto out;
 	}
 
-	*(__le32 *)(skb->data + offset) = sctp_end_cksum(csum);
+	*(__le32 *)(skb->data + offset) = cpu_to_le32(~(__u32)csum);
 out_set_summed:
 	skb->ip_summed = CHECKSUM_NONE;
 out:
-- 
2.7.4

