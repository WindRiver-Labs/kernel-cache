From 33dcc9c620b999b4517f0c6b8e6a96fedb9fc663 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Tue, 12 May 2015 23:58:51 +0800
Subject: [PATCH 252/257] arm: mm: Keystone skip fixup_pv_table

Since Keystone uses __fixup_pv_offsets in arch/arm/kernel/head.S for memory
greater than 4G, so skip fixup_pv_table when early_paging_init as well.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mm/mmu.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/arch/arm/mm/mmu.c b/arch/arm/mm/mmu.c
index d830561..6288100 100644
--- a/arch/arm/mm/mmu.c
+++ b/arch/arm/mm/mmu.c
@@ -1544,6 +1544,7 @@ void __init early_paging_init(const struct machine_desc *mdesc,
 
 	mdesc->init_meminfo();
 
+#ifndef CONFIG_ARCH_KEYSTONE
 	/* Run the patch stub to update the constants */
 	fixup_pv_table(&__pv_table_begin,
 		(&__pv_table_end - &__pv_table_begin) << 2);
@@ -1557,6 +1558,7 @@ void __init early_paging_init(const struct machine_desc *mdesc,
 	flush_cache_louis();
 	dsb();
 	isb();
+#endif
 
 	/* remap level 1 table */
 	for (i = 0; i < PTRS_PER_PGD; pud0++, i++) {
@@ -1570,7 +1572,7 @@ void __init early_paging_init(const struct machine_desc *mdesc,
 	do {
 		*pmdk++ = __pmd(phys | pmdprot);
 		phys += PMD_SIZE;
-	} while (phys < map_end);
+	} while (phys < __pa(map_end));
 
 	flush_cache_all();
 	cpu_switch_mm(pgd0, &init_mm);
-- 
2.7.4

