From ce89b423d7ce8481ccb6193fc906de19bf8bdf96 Mon Sep 17 00:00:00 2001
From: Sam Nelson <sam.nelson@ti.com>
Date: Wed, 16 Oct 2013 11:58:37 -0400
Subject: [PATCH 215/257] remoteproc: resolve issue with RT kernel

The request_firmware_nowait cause issue with RT kernel
- Avoided the issue by setting the firmware to NULL

Signed-off-by: Sam Nelson <sam.nelson@ti.com>
(cherry picked from commit 66c8ea03800c2facf190bb887d251cde2d9a70c8)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/remoteproc/remoteproc_core.c | 9 ---------
 drivers/remoteproc/remoteproc_user.c | 3 +++
 2 files changed, 3 insertions(+), 9 deletions(-)

diff --git a/drivers/remoteproc/remoteproc_core.c b/drivers/remoteproc/remoteproc_core.c
index e036861..94cb6e4 100644
--- a/drivers/remoteproc/remoteproc_core.c
+++ b/drivers/remoteproc/remoteproc_core.c
@@ -903,15 +903,6 @@ static int rproc_fw_boot(struct rproc *rproc, const struct firmware *fw)
 	/* Set state to indicate RPROC is loaded */
 	rproc->state = RPROC_LOADED;
 
-	if (!fw) {
-		/* handle vdev resources */
-		ret = rproc_handle_resources(rproc, tablesz, rproc_vdev_handler);
-		if (ret) {
-			dev_err(dev, "Failed to process resources: %d\n", ret);
-			goto clean_up;
-		}
-	}
-
 	/*
 	 * Update table_ptr so that all subsequent vring allocations and
 	 * virtio fields manipulation update the actual loaded resource table
diff --git a/drivers/remoteproc/remoteproc_user.c b/drivers/remoteproc/remoteproc_user.c
index 0b81096..bd8ab46 100644
--- a/drivers/remoteproc/remoteproc_user.c
+++ b/drivers/remoteproc/remoteproc_user.c
@@ -385,6 +385,7 @@ uproc_find_rsc_table(struct rproc *rproc, const struct firmware *fw,
 		*tablesz = uproc->rsc_table_size;
 	return uproc->rsc_table;
 }
+
 static struct resource_table *
 uproc_find_loaded_rsc_table(struct rproc *rproc, const struct firmware *fw)
 {
@@ -494,6 +495,8 @@ static int uproc_driver_probe(struct platform_device *pdev)
 			    sizeof(*uproc));
 	if (!rproc)
 		return -ENOMEM;
+	/* Override default firmware name, as we the firwmare download is done externally */
+	rproc->firmware = NULL;
 
 	rproc->fw_ops	= &uproc_fw_ops;
 
-- 
2.7.4

