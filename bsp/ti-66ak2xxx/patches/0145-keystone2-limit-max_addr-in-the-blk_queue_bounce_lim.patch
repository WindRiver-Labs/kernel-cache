From 03c01d5d3c4bbee77f78509224446bf881322f28 Mon Sep 17 00:00:00 2001
From: Vitaly Andrianov <vitalya@ti.com>
Date: Mon, 29 Jul 2013 15:08:17 -0400
Subject: [PATCH 145/257] keystone2: limit max_addr in the
 blk_queue_bounce_limit()

Keystone2 devices can do DMA on the first 2GB of DDR only.
This patch limits the dms_mask in the blk_queue_bounce_limit() to the
first 2GB.

Signed-off-by: Vitaly Andrianov <vitalya@ti.com>
(cherry picked from commit 54257aa5c18eced52797ce912775c89af289786b)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 block/blk-settings.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/block/blk-settings.c b/block/blk-settings.c
index 95138e9..5dd2783 100644
--- a/block/blk-settings.c
+++ b/block/blk-settings.c
@@ -209,6 +209,14 @@ void blk_queue_bounce_limit(struct request_queue *q, u64 max_addr)
 	unsigned long b_pfn = max_addr >> PAGE_SHIFT;
 	int dma = 0;
 
+#ifdef CONFIG_ARCH_KEYSTONE
+#define BLK_BOUNCE_ABOVE_2GB 0x7ffff000ULL
+	if (max_addr > BLK_BOUNCE_ABOVE_2GB) {
+		max_addr = BLK_BOUNCE_ABOVE_2GB;
+		b_pfn = max_addr >> PAGE_SHIFT;
+	}
+#endif
+
 	q->bounce_gfp = GFP_NOIO;
 #if BITS_PER_LONG == 64
 	/*
-- 
2.7.4

