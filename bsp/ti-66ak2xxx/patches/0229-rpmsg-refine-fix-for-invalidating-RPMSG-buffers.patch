From fcc240b57bf337293e5b121c2d75064f36d3cd18 Mon Sep 17 00:00:00 2001
From: Sam Nelson <sam.nelson@ti.com>
Date: Wed, 6 Aug 2014 20:28:00 -0400
Subject: [PATCH 229/257] rpmsg: refine fix for invalidating RPMSG buffers

-  The code was deciding on the size of buffer to invalidate
   based on size read from the Buffer
   ( fixed by invalidating the complete buffer)

Signed-off-by: Sam Nelson <sam.nelson@ti.com>
(cherry picked from commit 2d14f4bab1965c52347cc53b2327b6d4f32c6f10)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/rpmsg/virtio_rpmsg_bus.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/drivers/rpmsg/virtio_rpmsg_bus.c b/drivers/rpmsg/virtio_rpmsg_bus.c
index 60f692b..a409d40 100644
--- a/drivers/rpmsg/virtio_rpmsg_bus.c
+++ b/drivers/rpmsg/virtio_rpmsg_bus.c
@@ -781,7 +781,7 @@ int rpmsg_send_offchannel_raw(struct rpmsg_channel *rpdev, u32 src, u32 dst,
 #ifdef CONFIG_KEYSTONE2_DMA_COHERENT
 	/* Sync buffer to give access to remote device */
 	dma_sync_single_for_device(dev, virt_to_dma(dev, (void *)(msg)),
-					sizeof(struct rpmsg_hdr) + msg->len - 1,
+					RPMSG_BUF_SIZE,
 					DMA_TO_DEVICE);
 #endif
 	dev_dbg(dev, "TX From 0x%x, To 0x%x, Len %d, Flags %d, Reserved %d\n",
@@ -825,7 +825,7 @@ static int rpmsg_recv_single(struct virtproc_info *vrp, struct device *dev,
 #ifdef CONFIG_KEYSTONE2_DMA_COHERENT
 	/* Sync buffer to receive message */
 	dma_sync_single_for_cpu(dev, virt_to_dma(dev, (void *)(msg)),
-					sizeof(struct rpmsg_hdr) + msg->len - 1,
+					RPMSG_BUF_SIZE,
 					DMA_FROM_DEVICE);
 #endif
 
@@ -877,7 +877,7 @@ static int rpmsg_recv_single(struct virtproc_info *vrp, struct device *dev,
 #ifdef CONFIG_KEYSTONE2_DMA_COHERENT
 	/* Sync buffer for remote device to use */
 	dma_sync_single_for_device(dev, virt_to_dma(dev, (void *)(msg)),
-		sizeof(struct rpmsg_hdr) + msg->len - 1, DMA_FROM_DEVICE);
+		RPMSG_BUF_SIZE, DMA_FROM_DEVICE);
 #endif
 
 	/* add the buffer back to the remote processor's virtqueue */
-- 
2.7.4

