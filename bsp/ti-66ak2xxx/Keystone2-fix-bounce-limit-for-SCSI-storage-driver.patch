From d2adb0b2fcfdfd3542a4a1ae46d87e5c46a78d43 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Fri, 17 Apr 2015 13:55:16 +0800
Subject: [PATCH 191/256] Keystone2: fix bounce limit for SCSI storage driver

This patch comes from:
  git://git.ti.com/keystone-linux/linux.git

Keystone2 devices cannot use more than 2GB of memory for DMA.
This patch fixes the bounce limit for SCSI storage driver to limit DMA
available memory.
Please see the "Keystone2: set bounce_limit to BLK_BOUNCE_HIGH patch

Signed-off-by: Vitaly Andrianov <vitalya@ti.com>
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/scsi/storvsc_drv.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/scsi/storvsc_drv.c b/drivers/scsi/storvsc_drv.c
index ed0f899..afb247e 100644
--- a/drivers/scsi/storvsc_drv.c
+++ b/drivers/scsi/storvsc_drv.c
@@ -1443,7 +1443,11 @@ static int storvsc_device_configure(struct scsi_device *sdevice)
 
 	blk_queue_max_segment_size(sdevice->request_queue, PAGE_SIZE);
 
+#ifdef CONFIG_ARCH_KEYSTONE
+	blk_queue_bounce_limit(sdevice->request_queue, BLK_BOUNCE_HIGH);
+#else
 	blk_queue_bounce_limit(sdevice->request_queue, BLK_BOUNCE_ANY);
+#endif
 
 	blk_queue_rq_timeout(sdevice->request_queue, (storvsc_timeout * HZ));
 
-- 
1.7.5.4

