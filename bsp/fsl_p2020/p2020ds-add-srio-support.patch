From 653f6055af351d0c2a60401279497d32f9aba3ba Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Thu, 18 Nov 2010 16:20:20 +0800
Subject: [PATCH] p2020ds: add srio support

This is from kernel-2.6.30-p2020ds-add-srio-support-2.patch of
P2020DS_20091110_ltib.iso.

Add the corresponding RapidIO device node on dts and provide
the associated kernel option dedicated to p2020ds. And add
{ .compatible = "fsl,rapidio-delta", },
into mpc85xxds_ids[] to create the RapidIO device.

Signed-off-by: Li Yang <leoli@freescale.com>
[Correct incorrect RapidIO REG offset according to help html of ISO.]
Integrated-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/boot/dts/p2020ds.dts        |   14 ++++++++++++++
 arch/powerpc/platforms/85xx/Kconfig      |    1 +
 arch/powerpc/platforms/85xx/mpc85xx_ds.c |    1 +
 3 files changed, 16 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/boot/dts/p2020ds.dts b/arch/powerpc/boot/dts/p2020ds.dts
index 95506fb..fe02ca0 100644
--- a/arch/powerpc/boot/dts/p2020ds.dts
+++ b/arch/powerpc/boot/dts/p2020ds.dts
@@ -25,6 +25,8 @@
 		pci0 = &pci0;
 		pci1 = &pci1;
 		pci2 = &pci2;
+
+		rio0 = &rapidio0;
 	};
 
 	cpus {
@@ -157,6 +159,18 @@
 		};
 	};
 
+	rapidio0: rapidio@ffec0000 {
+		#address-cells = <2>;
+		#size-cells = <2>;
+		compatible = "fsl,rapidio-delta";
+		reg = <0 0xffec0000 0 0x20000>;
+		ranges = <0 0 0 0xa0000000 0 0x10000000>;
+		interrupt-parent = <&mpic>;
+		/* err_irq bell_outb_irq bell_inb_irq
+			msg1_tx_irq msg1_rx_irq msg2_tx_irq msg2_rx_irq */
+		interrupts = <48 2 49 2 50 2 53 2 54 2 55 2 56 2>;
+	};
+
 	soc@ffe00000 {
 		#address-cells = <1>;
 		#size-cells = <1>;
diff --git a/arch/powerpc/platforms/85xx/Kconfig b/arch/powerpc/platforms/85xx/Kconfig
index 20a664c..c4b634b 100644
--- a/arch/powerpc/platforms/85xx/Kconfig
+++ b/arch/powerpc/platforms/85xx/Kconfig
@@ -53,6 +53,7 @@ config MPC85xx_DS
 	select DEFAULT_UIMAGE
 	select FSL_ULI1575 if PCI
 	select SWIOTLB
+	select HAS_RAPIDIO
 	help
 	  This option enables support for the MPC85xx DS (MPC8544 DS) board
 
diff --git a/arch/powerpc/platforms/85xx/mpc85xx_ds.c b/arch/powerpc/platforms/85xx/mpc85xx_ds.c
index 09b8bd8..c4f3537 100644
--- a/arch/powerpc/platforms/85xx/mpc85xx_ds.c
+++ b/arch/powerpc/platforms/85xx/mpc85xx_ds.c
@@ -230,6 +230,7 @@ static struct of_device_id __initdata mpc85xxds_ids[] = {
 	{ .compatible = "soc", },
 	{ .compatible = "simple-bus", },
 	{ .compatible = "gianfar", },
+	{ .compatible = "fsl,rapidio-delta", },
 	{},
 };
 
-- 
1.6.5.2

