From 058128dadbf5d6bb6f8a80e78912afde4797818f Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Fri, 7 Aug 2015 15:50:33 +0800
Subject: [PATCH] irqchip/gicv3-its:Add thunderX implementation

Call pci_requester_id() for thunderX platform when parsing msi irq on
thunderX.

Extracted from ThunderX-SDK pre-release 0.4.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/irqchip/irq-gic-v3-its.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/drivers/irqchip/irq-gic-v3-its.c b/drivers/irqchip/irq-gic-v3-its.c
index edc78e2..6b6f341 100644
--- a/drivers/irqchip/irq-gic-v3-its.c
+++ b/drivers/irqchip/irq-gic-v3-its.c
@@ -1212,6 +1212,10 @@ static int its_msi_get_vec_count(struct pci_dev *pdev, struct msi_desc *desc)
 #endif
 }
 
+#ifdef CONFIG_PCI_THUNDER
+int pci_requester_id(struct pci_dev *dev);
+#endif
+
 static int its_msi_setup_irq(struct msi_chip *chip,
 			     struct pci_dev *pdev,
 			     struct msi_desc *desc)
@@ -1223,7 +1227,11 @@ static int its_msi_setup_irq(struct msi_chip *chip,
 	u64 addr;
 	int hwirq;
 	int err;
+#ifdef CONFIG_PCI_THUNDER
+	u32 dev_id = pci_requester_id(pdev);
+#else
 	u32 dev_id = PCI_REQUESTER_ID(pdev);
+#endif
 	u32 vec_nr;
 
 	its_dev = its_find_device(its, dev_id);
-- 
1.7.5.4

