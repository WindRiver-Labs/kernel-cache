From fa88686fcf71e27cf5e813ef8e9bb54bfdec98e0 Mon Sep 17 00:00:00 2001
From: lwang1 <li.wang@windriver.com>
Date: Thu, 11 Sep 2008 15:51:48 +0800
Subject: [PATCH] fsl_hpcnet Fix Hwtimer Ratio

Modidy PROC_PLL_RATIO according to the board of fsl_hcpnet.
Get bus frequency from of_get_property(cpu, "bus-frequency", NULL).

Signed-off-by: Li Wang <li.wang@windriver.com>
---
 arch/powerpc/platforms/86xx/mpc86xx_hpcn.c |   19 +++++++++++++++++++
 arch/powerpc/sysdev/mpic.c                 |    3 +++
 2 files changed, 22 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/86xx/mpc86xx_hpcn.c b/arch/powerpc/platforms/86xx/mpc86xx_hpcn.c
index f712d9c..7a91358 100644
--- a/arch/powerpc/platforms/86xx/mpc86xx_hpcn.c
+++ b/arch/powerpc/platforms/86xx/mpc86xx_hpcn.c
@@ -65,6 +65,21 @@ static int mpc86xx_exclude_device(struct pci_controller *hose,
 }
 #endif /* CONFIG_PCI */
 
+#ifdef CONFIG_HWTIMER_HOOKS
+unsigned long mpc86xx_hpcn_bus_frequency;
+static void get_bus_frequency(void)
+{
+	struct device_node *cpu;
+	const unsigned int *fp;
+
+	cpu = of_find_node_by_type(NULL, "cpu");
+
+	fp = of_get_property(cpu, "bus-frequency", NULL);
+	mpc86xx_hpcn_bus_frequency = of_read_ulong(fp, 1);
+
+	of_node_put(cpu);
+}
+#endif
 
 static void __init
 mpc86xx_hpcn_setup_arch(void)
@@ -95,6 +110,10 @@ mpc86xx_hpcn_setup_arch(void)
 #ifdef CONFIG_SMP
 	mpc86xx_smp_init();
 #endif
+
+#ifdef CONFIG_HWTIMER_HOOKS
+	get_bus_frequency();
+#endif
 }
 
 
diff --git a/arch/powerpc/sysdev/mpic.c b/arch/powerpc/sysdev/mpic.c
index 51612ae..9344584 100644
--- a/arch/powerpc/sysdev/mpic.c
+++ b/arch/powerpc/sysdev/mpic.c
@@ -275,6 +275,9 @@ static int pll_divisor[4]={1,2,1,2};
 static int pll_dividend[4]={2,5,3,7};
 static int pll_index=1;
 #define PROC_PLL_RATIO pll_divisor[pll_index]/pll_dividend[pll_index]
+#elif defined(CONFIG_MPC8641_HPCN)
+extern unsigned long mpc86xx_hpcn_bus_frequency;
+#define PROC_PLL_RATIO 1 / ppc_proc_freq * mpc86xx_hpcn_bus_frequency
 #else
 #define PROC_PLL_RATIO 2/5
 #endif
-- 
1.5.5.1

