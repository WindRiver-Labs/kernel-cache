From da1093a9e5d18ae0f69ef275a46b0c807769ff45 Mon Sep 17 00:00:00 2001
From: Wu Fei <fei.wu@windriver.com>
Date: Tue, 8 Dec 2009 23:46:16 -0800
Subject: [PATCH] arm/cache: put sync barrier after cache flush

The moved line is a memory barrier and will drain the write buffer,
so it should be put after the cache flush operations.

Signed-off-by: Fei Wu <fei.wu@windriver.com>
---
 arch/arm/mm/flush.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mm/flush.c b/arch/arm/mm/flush.c
index 6313c90..8ffe295 100644
--- a/arch/arm/mm/flush.c
+++ b/arch/arm/mm/flush.c
@@ -91,7 +91,6 @@ void flush_cache_range(struct vm_area_struct *vma, unsigned long start,
 
 	if (cache_is_vipt_aliasing()) {
 		asm("mcr	p15, 0, %0, c7, c14, 0\n"
-		"	mcr	p15, 0, %0, c7, c10, 4\n"
 #ifndef CONFIG_ARM_ERRATA_411920
 #if __LINUX_ARM_ARCH__ != 6 || defined(CONFIG_SMP)
 		"	mcr	p15, 0, %0, c7, c5, 0\n"
@@ -100,6 +99,7 @@ void flush_cache_range(struct vm_area_struct *vma, unsigned long start,
 		"	bl	v6_icache_inval_all\n"
 #endif
 #endif
+		"	mcr	p15, 0, %0, c7, c10, 4\n"
 		    :
 		    : "r" (0)
 		    : "cc");
-- 
1.6.5.2

