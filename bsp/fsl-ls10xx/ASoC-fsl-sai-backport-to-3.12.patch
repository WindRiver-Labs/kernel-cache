From 30cfe014856fe259b7fdf43e881f34c17a607c47 Mon Sep 17 00:00:00 2001
From: Xiubo Li <Li.Xiubo@freescale.com>
Date: Mon, 24 Mar 2014 18:32:28 +0800
Subject: [PATCH 073/129] ASoC: fsl-sai: backport to 3.12

Signed-off-by: Xiubo Li <Li.Xiubo@freescale.com>
Change-Id: I4e1f12afb9aefa0de69bcbab393eb8ec28f56df1
Reviewed-on: http://git.am.freescale.net:8181/19754
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Zhengxiong Jin <Jason.Jin@freescale.com>
[Xulin:Original patch taken from
Freescale-Linux-SDK-for-LS1021A-IOT-Rev2-v0.4-SOURCE-20150907-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 sound/soc/fsl/fsl_sai.c |   36 ++++++++++++++++++++++++++++++++++++
 sound/soc/fsl/fsl_sai.h |    2 ++
 2 files changed, 38 insertions(+), 0 deletions(-)

diff --git a/sound/soc/fsl/fsl_sai.c b/sound/soc/fsl/fsl_sai.c
index ec79c3d..7089ec1 100644
--- a/sound/soc/fsl/fsl_sai.c
+++ b/sound/soc/fsl/fsl_sai.c
@@ -555,6 +555,42 @@ static const struct regmap_config fsl_sai_regmap_config = {
 	.writeable_reg = fsl_sai_writeable_reg,
 };
 
+static bool fsl_sai_filter(struct dma_chan *chan, void *param)
+{
+	struct snd_dmaengine_dai_dma_data *dma_data = param;
+
+	chan->private = dma_data->filter_data;
+
+	return true;
+}
+
+static const struct snd_pcm_hardware fsl_sai_pcm_hardware = {
+	.info = SNDRV_PCM_INFO_INTERLEAVED |
+		SNDRV_PCM_INFO_BLOCK_TRANSFER |
+		SNDRV_PCM_INFO_MMAP |
+		SNDRV_PCM_INFO_MMAP_VALID |
+		SNDRV_PCM_INFO_PAUSE |
+		SNDRV_PCM_INFO_RESUME,
+	.formats = SNDRV_PCM_FMTBIT_S16_LE,
+	.rate_min = 8000,
+	.channels_min = 2,
+	.channels_max = 2,
+	.buffer_bytes_max = FSL_SAI_DMABUF_SIZE,
+	.period_bytes_min = 128,
+	.period_bytes_max = 65535,
+	.periods_min = 2,
+	.periods_max = 255,
+	.fifo_size = 0,
+};
+
+static const struct snd_dmaengine_pcm_config fsl_sai_dmaengine_pcm_config = {
+	.pcm_hardware = &fsl_sai_pcm_hardware,
+	.prepare_slave_config = snd_dmaengine_pcm_prepare_slave_config,
+	.compat_filter_fn = fsl_sai_filter,
+	.prealloc_buffer_size = FSL_SAI_DMABUF_SIZE,
+};
+
+
 static int fsl_sai_probe(struct platform_device *pdev)
 {
 	struct device_node *np = pdev->dev.of_node;
diff --git a/sound/soc/fsl/fsl_sai.h b/sound/soc/fsl/fsl_sai.h
index 3466720..d9eaf3a 100644
--- a/sound/soc/fsl/fsl_sai.h
+++ b/sound/soc/fsl/fsl_sai.h
@@ -11,6 +11,8 @@
 
 #include <sound/dmaengine_pcm.h>
 
+#define FSL_SAI_DMABUF_SIZE    (64 * 1024)
+
 #define FSL_SAI_FORMATS (SNDRV_PCM_FMTBIT_S16_LE |\
 			 SNDRV_PCM_FMTBIT_S20_3LE |\
 			 SNDRV_PCM_FMTBIT_S24_LE)
-- 
1.7.5.4

