From bc5e1e5077e0bf35561ab71353a750700619e143 Mon Sep 17 00:00:00 2001
From: Xiubo Li <Li.Xiubo@freescale.com>
Date: Mon, 24 Mar 2014 18:32:28 +0800
Subject: [PATCH 021/255] ASoC: fsl-sai: backport to 3.12

Signed-off-by: Xiubo Li <Li.Xiubo@freescale.com>
[Kevin: Original patch taken from
LS1021A-SDK-V1.1-ARM-SOURCE-20140815-yocto.iso, keep the
snd_soc_dai_init_dma_data() and remove the unnecessary
introduction of fsl_sai_remove()]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 sound/soc/fsl/fsl_sai.c | 40 ++++++++++++++++++++++++++++++++++++++--
 sound/soc/fsl/fsl_sai.h |  2 ++
 2 files changed, 40 insertions(+), 2 deletions(-)

diff --git a/sound/soc/fsl/fsl_sai.c b/sound/soc/fsl/fsl_sai.c
index c4a4231..5fb7d04 100644
--- a/sound/soc/fsl/fsl_sai.c
+++ b/sound/soc/fsl/fsl_sai.c
@@ -484,6 +484,41 @@ static struct regmap_config fsl_sai_regmap_config = {
 	.writeable_reg = fsl_sai_writeable_reg,
 };
 
+static bool fsl_sai_filter(struct dma_chan *chan, void *param)
+{
+	struct snd_dmaengine_dai_dma_data *dma_data = param;
+
+	chan->private = dma_data->filter_data;
+
+	return true;
+}
+
+static const struct snd_pcm_hardware fsl_sai_pcm_hardware = {
+	.info = SNDRV_PCM_INFO_INTERLEAVED |
+		SNDRV_PCM_INFO_BLOCK_TRANSFER |
+		SNDRV_PCM_INFO_MMAP |
+		SNDRV_PCM_INFO_MMAP_VALID |
+		SNDRV_PCM_INFO_PAUSE |
+		SNDRV_PCM_INFO_RESUME,
+	.formats = SNDRV_PCM_FMTBIT_S16_LE,
+	.rate_min = 8000,
+	.channels_min = 2,
+	.channels_max = 2,
+	.buffer_bytes_max = FSL_SAI_DMABUF_SIZE,
+	.period_bytes_min = 128,
+	.period_bytes_max = 65535,
+	.periods_min = 2,
+	.periods_max = 255,
+	.fifo_size = 0,
+};
+
+static const struct snd_dmaengine_pcm_config fsl_sai_dmaengine_pcm_config = {
+	.pcm_hardware = &fsl_sai_pcm_hardware,
+	.prepare_slave_config = snd_dmaengine_pcm_prepare_slave_config,
+	.compat_filter_fn = fsl_sai_filter,
+	.prealloc_buffer_size = FSL_SAI_DMABUF_SIZE,
+};
+
 static int fsl_sai_probe(struct platform_device *pdev)
 {
 	struct device_node *np = pdev->dev.of_node;
@@ -526,8 +561,9 @@ static int fsl_sai_probe(struct platform_device *pdev)
 	if (ret)
 		return ret;
 
-	return devm_snd_dmaengine_pcm_register(&pdev->dev, NULL,
-			SND_DMAENGINE_PCM_FLAG_NO_RESIDUE);
+	return devm_snd_dmaengine_pcm_register(&pdev->dev,
+		&fsl_sai_dmaengine_pcm_config,
+		SND_DMAENGINE_PCM_FLAG_NO_RESIDUE);
 }
 
 static const struct of_device_id fsl_sai_ids[] = {
diff --git a/sound/soc/fsl/fsl_sai.h b/sound/soc/fsl/fsl_sai.h
index e432260..fc12d96 100644
--- a/sound/soc/fsl/fsl_sai.h
+++ b/sound/soc/fsl/fsl_sai.h
@@ -11,6 +11,8 @@
 
 #include <sound/dmaengine_pcm.h>
 
+#define FSL_SAI_DMABUF_SIZE    (64 * 1024)
+
 #define FSL_SAI_FORMATS (SNDRV_PCM_FMTBIT_S16_LE |\
 			 SNDRV_PCM_FMTBIT_S20_3LE |\
 			 SNDRV_PCM_FMTBIT_S24_LE)
-- 
2.0.2

