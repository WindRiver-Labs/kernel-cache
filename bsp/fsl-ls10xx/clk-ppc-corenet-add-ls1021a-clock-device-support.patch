From f637071b3b527efae247054d23c225b36d785a2c Mon Sep 17 00:00:00 2001
From: Jingchang Lu <b35083@freescale.com>
Date: Thu, 13 Feb 2014 13:40:20 +0800
Subject: [PATCH 008/255] clk: ppc-corenet: add ls1021a clock device support

The Freescale LAYERSCAPE LS102xa SoC deploy a similar
clock IP block supplying clock to the core and peripheral.
The clock initialization is usally defined by CLK_OF_DECLARE
on ARM architecture.

Signed-off-by: Jingchang Lu <b35083@freescale.com>
[Kevin: Original patch taken from
LS1021A-SDK-V1.1-ARM-SOURCE-20140815-yocto.iso, just drop the
unneeded inclusive of of_address.h]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/clk/Kconfig           |  2 +-
 drivers/clk/clk-ppc-corenet.c | 13 ++++++++++++-
 2 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/drivers/clk/Kconfig b/drivers/clk/Kconfig
index 7641965..55e57a5 100644
--- a/drivers/clk/Kconfig
+++ b/drivers/clk/Kconfig
@@ -88,7 +88,7 @@ config COMMON_CLK_AXI_CLKGEN
 
 config CLK_PPC_CORENET
 	bool "Clock driver for PowerPC corenet platforms"
-	depends on PPC_E500MC && OF
+	depends on (PPC_E500MC || ARCH_LAYERSCAPE) && OF
 	---help---
 	  This adds the clock driver support for Freescale PowerPC corenet
 	  platforms using common clock framework.
diff --git a/drivers/clk/clk-ppc-corenet.c b/drivers/clk/clk-ppc-corenet.c
index c4f76ed..358dd4a 100644
--- a/drivers/clk/clk-ppc-corenet.c
+++ b/drivers/clk/clk-ppc-corenet.c
@@ -239,6 +239,7 @@ err_clks:
 
 static const struct of_device_id clk_match[] __initconst = {
 	{ .compatible = "fixed-clock", .data = of_fixed_clk_setup, },
+	{ .compatible = "fsl,sys-clock", .data = of_fixed_clk_setup, },
 	{ .compatible = "fsl,core-pll-clock", .data = core_pll_init, },
 	{ .compatible = "fsl,core-mux-clock", .data = core_mux_init, },
 	{}
@@ -265,7 +266,7 @@ static const struct of_device_id ppc_clk_ids[] __initconst = {
 	{}
 };
 
-static struct platform_driver ppc_corenet_clk_driver = {
+static struct platform_driver ppc_corenet_clk_driver __initdata = {
 	.driver = {
 		.name = "ppc_corenet_clock",
 		.owner = THIS_MODULE,
@@ -279,3 +280,13 @@ static int __init ppc_corenet_clk_init(void)
 	return platform_driver_register(&ppc_corenet_clk_driver);
 }
 subsys_initcall(ppc_corenet_clk_init);
+
+static void __init ls1021a_clocks_init(struct device_node *np)
+{
+	base = of_iomap(np, 0);
+	if (!base)
+		return;
+
+	of_clk_init(clk_match);
+}
+CLK_OF_DECLARE(ls1021a, "fsl,ls1021a-clockgen", ls1021a_clocks_init);
-- 
2.0.2

