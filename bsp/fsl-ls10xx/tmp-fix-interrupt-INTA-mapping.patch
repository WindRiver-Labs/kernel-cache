From 03b92ece4ca0b5a9a2074878145e3217cc39185b Mon Sep 17 00:00:00 2001
From: Minghuan Lian <Minghuan.Lian@freescale.com>
Date: Mon, 12 May 2014 21:08:08 +0000
Subject: [PATCH 099/255] tmp: fix interrupt INTA mapping

Signed-off-by: Minghuan Lian <Minghuan.Lian@freescale.com>
[Kevin: Original patch taken from
LS1021A-SDK-V1.1-ARM-SOURCE-20140815-yocto.iso, drop the parts
for drivers/pci/host/pcie-designware.c]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/arm/boot/dts/ls1021a-40b.dtsi | 4 ++--
 drivers/pci/host/pcie-layerscape.c | 9 ++++++++-
 2 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/arch/arm/boot/dts/ls1021a-40b.dtsi b/arch/arm/boot/dts/ls1021a-40b.dtsi
index d595f87..eb1bc51 100644
--- a/arch/arm/boot/dts/ls1021a-40b.dtsi
+++ b/arch/arm/boot/dts/ls1021a-40b.dtsi
@@ -607,8 +607,8 @@
 		pcie@3400000 {
 			compatible = "fsl,pcie", "snps,dw-pcie", "fsl,ls1021a-pcie";
 			reg = <0x00 0x3400000 0x10000>;
-			interrupts = <0 177 0x04>, <0 179 0x04>, <0 181 0x04>, <0 183 0x04>;
-			interrupt-names = "intr", "msi", "pme", "cfg-err";
+			interrupts = <0 177 0x04>, <0 179 0x04>, <0 181 0x04>, <0 183 0x04>, <0 91 0x04>;
+			interrupt-names = "intr", "msi", "pme", "cfg-err", "inta";
 			#address-cells = <3>;
 			#size-cells = <2>;
 			device_type = "pci";
diff --git a/drivers/pci/host/pcie-layerscape.c b/drivers/pci/host/pcie-layerscape.c
index f35d403..ed255e5 100644
--- a/drivers/pci/host/pcie-layerscape.c
+++ b/drivers/pci/host/pcie-layerscape.c
@@ -41,6 +41,7 @@ struct ls_pcie {
 	int msi_irq;
 	int pme_irq;
 	int cfg_irq;
+	int inta_irq;
 };
 
 /* PEX1/2 Misc Ports Status Register */
@@ -127,7 +128,7 @@ static int ls_add_pcie_port(struct ls_pcie *pcie)
 	pp = &pcie->pp;
 	pp->dev = pcie->dev;
 	pp->dbi_base = pcie->dbi;
-	pp->irq = pcie->irq;
+	pp->irq = pcie->inta_irq;
 
 	ret = devm_request_irq(pp->dev, pcie->irq, ls_pcie_irq_handler,
 				IRQF_SHARED, "ls-pcie", pp);
@@ -223,6 +224,12 @@ static int __init ls_pcie_probe(struct platform_device *pdev)
 		goto err;
 	}
 
+	pcie->inta_irq = platform_get_irq_byname(pdev, "inta");
+	if (pcie->inta_irq < 0) {
+		dev_err(&pdev->dev,
+			"failed to get INTA IRQ: %d\n", pcie->inta_irq);
+		goto err;
+	}
 	ret = ls_add_pcie_port(pcie);
 	if (ret < 0)
 		goto err;
-- 
2.0.2

