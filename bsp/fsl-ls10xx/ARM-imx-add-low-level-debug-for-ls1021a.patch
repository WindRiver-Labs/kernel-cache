From 33349cf18f084e9f3f6c89fd30b4b5c20327b5d3 Mon Sep 17 00:00:00 2001
From: Jingchang Lu <jingchang.lu@freescale.com>
Date: Mon, 5 May 2014 07:43:22 +0800
Subject: [PATCH 080/255] ARM: imx: add low-level debug for ls1021a

Add low-level debug support for ls1021a, so that earlyprintk can be
enabled for debugging early boot issue.

Signed-off-by: Jingchang Lu <jingchang.lu@freescale.com>
[Kevin: Original patch taken from
LS1021A-SDK-V1.1-ARM-SOURCE-20140815-yocto.iso]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/arm/Kconfig.debug       |  8 ++++++++
 arch/arm/include/debug/ls1.S | 27 +++++++++++++++++++++++++++
 2 files changed, 35 insertions(+)
 create mode 100644 arch/arm/include/debug/ls1.S

diff --git a/arch/arm/Kconfig.debug b/arch/arm/Kconfig.debug
index 0531da8..973cf2d 100644
--- a/arch/arm/Kconfig.debug
+++ b/arch/arm/Kconfig.debug
@@ -445,6 +445,13 @@ choice
 		  Say Y here if you want kernel low-level debugging support
 		  on Vybrid based platforms.
 
+	config DEBUG_LS1021A_LPUART
+		bool "Freescale Layerscape LPUART"
+		depends on SOC_LS1021A
+		help
+		  Say Y here if you want kernel low-level debugging support
+		  on Freescale LS1021A based platforms.
+
 	config DEBUG_NOMADIK_UART
 		bool "Kernel low-level debugging messages via NOMADIK UART"
 		depends on ARCH_NOMADIK
@@ -983,6 +990,7 @@ config DEBUG_LL_INCLUDE
 	default "debug/ux500.S" if DEBUG_UX500_UART
 	default "debug/vexpress.S" if DEBUG_VEXPRESS_UART0_DETECT
 	default "debug/vf.S" if DEBUG_VF_UART
+	default "debug/ls1.S" if DEBUG_LS1021A_LPUART
 	default "debug/vt8500.S" if DEBUG_VT8500_UART0
 	default "debug/zynq.S" if DEBUG_ZYNQ_UART0 || DEBUG_ZYNQ_UART1
 	default "mach/debug-macro.S"
diff --git a/arch/arm/include/debug/ls1.S b/arch/arm/include/debug/ls1.S
new file mode 100644
index 0000000..b1a2b08
--- /dev/null
+++ b/arch/arm/include/debug/ls1.S
@@ -0,0 +1,27 @@
+/*
+ * Copyright 2014 Freescale Semiconductor, Inc.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ *
+ */
+
+	.macro	addruart, rp, rv, tmp
+	ldr	\rp, = 0x02950000
+	ldr	\rv, = 0xfd950000
+	.endm
+
+	.macro	senduart, rd, rx
+	lsl	\rd, \rd, #24		@ The Data register is big-endian
+	str	\rd, [\rx, #0xc]	@ Data Register
+	.endm
+
+	.macro	busyuart, rd, rx
+1001:	ldr	\rd, [\rx, #0x4]	@ Status Register 1
+	tst	\rd, #1 << 14		@ TC
+	beq	1001b			@ wait until transmit done
+	.endm
+
+	.macro	waituart,rd,rx
+	.endm
-- 
2.0.2

