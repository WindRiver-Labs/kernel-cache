From 5b13d6c0d0db1a84bfa584df6333ce0cba0915e5 Mon Sep 17 00:00:00 2001
From: Sandeep Malik <Sandeep.Malik@freescale.com>
Date: Fri, 9 May 2014 18:58:13 +0530
Subject: [PATCH 055/129] asf_gfar: Patch to fix the crash seen in ifup for
 bsc9132.

ASF uses two TX queues to avoid contention. BSC9132 even though having
controller which can support two groups was having the DTS file written
for one group. To fix this we allow ASF to override the default tx queue
mapping with the "fsl,tx-bit-map" value given in the DT.

This patch resolves the crash seen in case of bsc9132 board
when the network interface is up and trying to xmit the packet.

Signed-off-by: Sandeep Malik <Sandeep.Malik@freescale.com>
[Xulin: Original patch taken from
Freescale-Linux-SDK-for-LS1021A-IOT-Rev2-v0.4-SOURCE-20150907-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 drivers/net/ethernet/freescale/gianfar.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/freescale/gianfar.c b/drivers/net/ethernet/freescale/gianfar.c
index 2ab9b24..985554c 100644
--- a/drivers/net/ethernet/freescale/gianfar.c
+++ b/drivers/net/ethernet/freescale/gianfar.c
@@ -751,7 +751,12 @@ static int gfar_parse_group(struct device_node *np,
 			/* One Q per interrupt group: Q0 to G0, Q1 to G1 */
 			grp->rx_bit_map = (DEFAULT_MAPPING >> priv->num_grps);
 			grp->tx_bit_map = (DEFAULT_MAPPING >> priv->num_grps);
-		}
+	#ifdef CONFIG_AS_FASTPATH
+			grp->rx_bit_map = rxq_mask ?
+			*rxq_mask : (DEFAULT_MAPPING >> priv->num_grps);
+			grp->tx_bit_map = txq_mask ?
+			*txq_mask : (DEFAULT_MAPPING >> priv->num_grps);
+	#endif
 	} else {
 		grp->rx_bit_map = 0xFF;
 		grp->tx_bit_map = 0xFF;
-- 
1.7.5.4

