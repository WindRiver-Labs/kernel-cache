From c5c03eaac85d400c1bc92f56581ee101458e1d32 Mon Sep 17 00:00:00 2001
From: Minghuan Lian <Minghuan.Lian@freescale.com>
Date: Mon, 12 May 2014 18:03:33 +0000
Subject: [PATCH 096/255] arm: pci: fix LTSSM reading

Signed-off-by: Minghuan Lian <Minghuan.Lian@freescale.com>
[Kevin: Original patch taken from
LS1021A-SDK-V1.1-ARM-SOURCE-20140815-yocto.iso]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/pci/host/pcie-layerscape.c | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/drivers/pci/host/pcie-layerscape.c b/drivers/pci/host/pcie-layerscape.c
index 742c798..e199efb 100644
--- a/drivers/pci/host/pcie-layerscape.c
+++ b/drivers/pci/host/pcie-layerscape.c
@@ -45,9 +45,9 @@ struct ls_pcie {
 
 /* PEX1/2 Misc Ports Status Register */
 #define PEXMSCPORTSR(idx)	(0x94 + (idx) * 4)
-#define LTSSM_STATE_SHIFT	11
+#define LTSSM_STATE_SHIFT	20
 #define LTSSM_STATE_MASK	0x3f
-#define LTSSM_PCIE_L0		0x16 /* L0 state */
+#define LTSSM_PCIE_L0		0x11 /* L0 state */
 
 static int global_index;
 static LIST_HEAD(ls_pcie_list);
@@ -60,8 +60,9 @@ static int ls_pcie_link_up(struct pcie_port *pp)
 	u32 rc;
 
 	/* RM did not say the value meaning */
-	rc = (readl(pcie->scfg + PEXMSCPORTSR(pcie->index)) >>
-	     LTSSM_STATE_SHIFT) | LTSSM_STATE_MASK;
+	rc = (ioread32(pcie->scfg + PEXMSCPORTSR(pcie->index)) >>
+	     LTSSM_STATE_SHIFT) & LTSSM_STATE_MASK;
+
 	if (rc < LTSSM_PCIE_L0)
 		return 0;
 
-- 
2.0.2

