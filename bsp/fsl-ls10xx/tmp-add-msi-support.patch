From 62345a1d559bb2fac25e7849f655491f58f27e60 Mon Sep 17 00:00:00 2001
From: Minghuan Lian <Minghuan.Lian@freescale.com>
Date: Mon, 12 May 2014 18:31:17 +0000
Subject: [PATCH 097/255] tmp: add msi support

Signed-off-by: Minghuan Lian <Minghuan.Lian@freescale.com>
[Kevin: Original patch taken from
LS1021A-SDK-V1.1-ARM-SOURCE-20140815-yocto.iso]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/pci/host/pcie-layerscape.c | 17 ++++++-----------
 1 file changed, 6 insertions(+), 11 deletions(-)

diff --git a/drivers/pci/host/pcie-layerscape.c b/drivers/pci/host/pcie-layerscape.c
index e199efb..b1d505c 100644
--- a/drivers/pci/host/pcie-layerscape.c
+++ b/drivers/pci/host/pcie-layerscape.c
@@ -69,7 +69,7 @@ static int ls_pcie_link_up(struct pcie_port *pp)
 	return 1;
 }
 
-/*
+
 static irqreturn_t ls_pcie_msi_irq_handler(int irq, void *arg)
 {
 	struct pcie_port *pp = arg;
@@ -78,7 +78,6 @@ static irqreturn_t ls_pcie_msi_irq_handler(int irq, void *arg)
 
 	return IRQ_HANDLED;
 }
-*/
 
 static void ls_pcie_host_init(struct pcie_port *pp)
 {
@@ -95,13 +94,9 @@ static void ls_pcie_host_init(struct pcie_port *pp)
 		}
 	}
 
-	/*
-	if (IS_ENABLED(CONFIG_PCI_MSI)) {
-		pp->quirks |= DW_PCIE_QUIRK_NO_MSI_VEC;
-		pp->quirks |= DW_PCIE_QUIRK_MSI_SELF_EN;
+
+	if (IS_ENABLED(CONFIG_PCI_MSI))
 		dw_pcie_msi_init(pp);
-	}
-	*/
 
 	return;
 }
@@ -125,18 +120,18 @@ static int ls_add_pcie_port(struct ls_pcie *pcie)
 	pp->dbi_base = pcie->dbi;
 	pp->irq = pcie->irq;
 
-/*
+
 	if (IS_ENABLED(CONFIG_PCI_MSI)) {
 		pp->msi_irq = pcie->msi_irq;
 		ret = devm_request_irq(pp->dev, pp->msi_irq,
-					imx_pcie_msi_irq_handler,
+					ls_pcie_msi_irq_handler,
 					IRQF_SHARED, "ls-pcie", pp);
 		if (ret) {
 			dev_err(pp->dev, "failed to request msi irq\n");
 			return ret;
 		}
 	}
-*/
+
 	pp->root_bus_nr = -1;
 	pp->ops = &ls_pcie_host_ops;
 
-- 
2.0.2

