From e9f6a8f6cfee99a39f9fdb2e7983aa0f32395571 Mon Sep 17 00:00:00 2001
From: Minghuan Lian <Minghuan.Lian@freescale.com>
Date: Mon, 21 Jul 2014 16:26:06 +0000
Subject: [PATCH 217/255] arm: pci: workaround QDS MSI support

LS1021AQDS board needs to manually generate the first MSI
interrupt, otherwise PCI device can not generate MSI
interrupt.

Signed-off-by: Minghuan Lian <Minghuan.Lian@freescale.com>
[Kevin: Original patch taken from
LS1021A-SDK-V1.1-ARM-SOURCE-20140815-yocto.iso]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/pci/host/pcie-layerscape.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/pci/host/pcie-layerscape.c b/drivers/pci/host/pcie-layerscape.c
index 21c626a..7e3f1f4 100644
--- a/drivers/pci/host/pcie-layerscape.c
+++ b/drivers/pci/host/pcie-layerscape.c
@@ -372,6 +372,9 @@ static int ls_msi_setup_irq(struct msi_chip *chip, struct pci_dev *pdev,
 
 	/* MSI needs to set bit reverse */
 	iowrite32(SCFG_BIT_REVERSE, msi->pcie->scfg + SCFG_SCFGREVCR_OFF);
+	/* Generate the first MSI interrupt */
+	iowrite32(msi->data, msi->pcie->scfg + SCFG_SPIMSICR_OFF);
+
 	write_msi_msg(irq, &msg);
 
 	return 0;
-- 
2.0.2

