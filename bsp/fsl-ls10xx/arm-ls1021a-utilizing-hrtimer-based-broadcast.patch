From 731978215bd274034675e7ab3eecdc37311d6ae5 Mon Sep 17 00:00:00 2001
From: Jingchang Lu <jingchang.lu@freescale.com>
Date: Wed, 26 Nov 2014 17:07:11 +0800
Subject: [PATCH 17/70] arm: ls1021a: utilizing hrtimer based broadcast

This add utilization on hrtimer based broadcast instead the
periodic tick broadcast to provide high resolution clock
in SMP.

Signed-off-by: Jingchang Lu <jingchang.lu@freescale.com>
Change-Id: I391bf06fa4b238ab49bced26e3be8c2b6c677c32
Reviewed-on: http://git.am.freescale.net:8181/30436
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Yangbo Lu <yangbo.lu@freescale.com>
Reviewed-by: Zhengxiong Jin <Jason.Jin@freescale.com>
[czou:Original patch taken from
LS1021A-IOT-Rev2-v0.4-20150907-yocto.iso]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 arch/arm/mach-imx/mach-ls1021a.c |   11 +++++++++++
 1 files changed, 11 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-imx/mach-ls1021a.c b/arch/arm/mach-imx/mach-ls1021a.c
index 3895ffc..3692dd0 100644
--- a/arch/arm/mach-imx/mach-ls1021a.c
+++ b/arch/arm/mach-imx/mach-ls1021a.c
@@ -7,6 +7,9 @@
  * (at your option) any later version.
  */
 
+#include <linux/clk-provider.h>
+#include <linux/clockchips.h>
+#include <linux/clocksource.h>
 #include <linux/of_platform.h>
 #include <asm/mach/arch.h>
 
@@ -18,6 +21,13 @@ static void __init ls1021a_init_machine(void)
 	of_platform_populate(NULL, of_default_bus_match_table, NULL, NULL);
 }
 
+static void __init ls1021a_init_time(void)
+{
+	of_clk_init(NULL);
+	clocksource_of_init();
+	tick_setup_hrtimer_broadcast();
+}
+
 static const char *ls1021a_dt_compat[] __initdata = {
 	"fsl,ls1021a",
 	NULL,
@@ -25,6 +35,7 @@ static const char *ls1021a_dt_compat[] __initdata = {
 
 DT_MACHINE_START(LS1021A, "Freescale LS1021A")
 	.smp		= smp_ops(ls1021a_smp_ops),
+	.init_time	= ls1021a_init_time,
 	.init_machine   = ls1021a_init_machine,
 	.dt_compat	= ls1021a_dt_compat,
 	.restart	= mxc_restart,
-- 
1.7.5.4

