From 4393c1d53a78bcb2a54dc4fa077f0a5ab840083c Mon Sep 17 00:00:00 2001
From: Jingchang Lu <jingchang.lu@freescale.com>
Date: Wed, 26 Nov 2014 17:07:11 +0800
Subject: [PATCH 078/129] arm: ls1021a: utilizing hrtimer based broadcast

This add utilization on hrtimer based broadcast instead the
periodic tick broadcast to provide high resolution clock
in SMP.

Signed-off-by: Jingchang Lu <jingchang.lu@freescale.com>
Change-Id: I391bf06fa4b238ab49bced26e3be8c2b6c677c32
Reviewed-on: http://git.am.freescale.net:8181/30436
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Yangbo Lu <yangbo.lu@freescale.com>
Reviewed-by: Zhengxiong Jin <Jason.Jin@freescale.com>
[Xulin:Original patch taken from
Freescale-Linux-SDK-for-LS1021A-IOT-Rev2-v0.4-SOURCE-20150907-yocto.iso]
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 arch/arm/mach-imx/mach-ls1021a.c |   13 +++++++++++++
 1 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-imx/mach-ls1021a.c b/arch/arm/mach-imx/mach-ls1021a.c
index b89c858..8cbfe35 100644
--- a/arch/arm/mach-imx/mach-ls1021a.c
+++ b/arch/arm/mach-imx/mach-ls1021a.c
@@ -7,10 +7,21 @@
  * (at your option) any later version.
  */
 
+#include <linux/clk-provider.h>
+#include <linux/clockchips.h>
+#include <linux/clocksource.h>
+#include <linux/of_platform.h>
 #include <asm/mach/arch.h>
 
 #include "common.h"
 
+static void __init ls1021a_init_time(void)
+{
+	of_clk_init(NULL);
+	clocksource_of_init();
+	tick_setup_hrtimer_broadcast();
+}
+
 static const char * const ls1021a_dt_compat[] __initconst = {
 	"fsl,ls1021a",
 	NULL,
@@ -18,5 +29,7 @@ static const char * const ls1021a_dt_compat[] __initconst = {
 
 DT_MACHINE_START(LS1021A, "Freescale LS1021A")
 	.smp		= smp_ops(ls1021a_smp_ops),
+	.init_time	= ls1021a_init_time,
+	.init_machine   = ls1021a_init_machine,
 	.dt_compat	= ls1021a_dt_compat,
 MACHINE_END
-- 
1.7.5.4

