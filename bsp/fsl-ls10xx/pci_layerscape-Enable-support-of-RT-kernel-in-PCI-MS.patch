From 98bb73ae1e3f4caa1dc686445c8b7fc336bd3f6f Mon Sep 17 00:00:00 2001
From: Meenakshi Aggarwal <meenakshi.aggarwal@freescale.com>
Date: Fri, 20 Feb 2015 12:21:31 +0530
Subject: [PATCH 24/70] pci_layerscape : Enable support of RT kernel in
 PCI-MSI interrupt handler

generic_handle_irq() should always be called in interrupt disabled context,
this patch ensures that interrupts are disabled while calling generic_handle_irq().

It call local_irq_disable() before calling generic_handle_irq() and local_irq_enable() on exit.

In case of non-rt kernel, ls_pcie_msi_irq_handler is called in interrupt disabled context,
so no need to explicitly disabling interrupt while calling generic_handle_irq().

Signed-off-by: Meenakshi Aggarwal <meenakshi.aggarwal@freescale.com>
Change-Id: I13d83423ea45c1ce5021474c04640ac7118664af
Reviewed-on: http://git.am.freescale.net:8181/31478
Tested-by: Review Code-CDREVIEW <CDREVIEW@freescale.com>
Reviewed-by: Priyanka Jain <Priyanka.Jain@freescale.com>
Reviewed-by: Honghua Yin <Hong-Hua.Yin@freescale.com>
[czou:Original patch taken from
LS1021A-IOT-Rev2-v0.4-20150907-yocto.iso]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/pci/host/pci-layerscape.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/drivers/pci/host/pci-layerscape.c b/drivers/pci/host/pci-layerscape.c
index 6e3fa7c..278382e 100644
--- a/drivers/pci/host/pci-layerscape.c
+++ b/drivers/pci/host/pci-layerscape.c
@@ -101,8 +101,13 @@ static irqreturn_t ls_pcie_msi_irq_handler(int irq, void *data)
 		dev_err(pcie->dev, "unexpected MSI\n");
 		return IRQ_NONE;
 	}
-
+#if defined(CONFIG_PREEMPT_RT_FULL) || defined(CONFIG_PREEMPT_RTB)
+	local_irq_disable();
+#endif
 	generic_handle_irq(msi_irq);
+#if defined(CONFIG_PREEMPT_RT_FULL) || defined(CONFIG_PREEMPT_RTB)
+	local_irq_enable();
+#endif
 	return IRQ_HANDLED;
 }
 
-- 
1.7.5.4

