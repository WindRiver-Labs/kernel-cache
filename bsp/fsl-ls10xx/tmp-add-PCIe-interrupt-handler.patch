From 6f283f11338d3f97d1ede64c8e43ce2229989827 Mon Sep 17 00:00:00 2001
From: Minghuan Lian <Minghuan.Lian@freescale.com>
Date: Mon, 12 May 2014 18:52:14 +0000
Subject: [PATCH 098/255] tmp: add PCIe interrupt handler

Signed-off-by: Minghuan Lian <Minghuan.Lian@freescale.com>
[Kevin: Original patch taken from
LS1021A-SDK-V1.1-ARM-SOURCE-20140815-yocto.iso]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/pci/host/pcie-layerscape.c | 29 +++++++++++++++++++++++++++++
 1 file changed, 29 insertions(+)

diff --git a/drivers/pci/host/pcie-layerscape.c b/drivers/pci/host/pcie-layerscape.c
index b1d505c..f35d403 100644
--- a/drivers/pci/host/pcie-layerscape.c
+++ b/drivers/pci/host/pcie-layerscape.c
@@ -79,6 +79,15 @@ static irqreturn_t ls_pcie_msi_irq_handler(int irq, void *arg)
 	return IRQ_HANDLED;
 }
 
+static irqreturn_t ls_pcie_irq_handler(int irq, void *arg)
+{
+	struct pcie_port *pp = arg;
+
+	printk("get irq %d\n", irq);
+
+	return IRQ_HANDLED;
+}
+
 static void ls_pcie_host_init(struct pcie_port *pp)
 {
 	int count = 0;
@@ -120,6 +129,19 @@ static int ls_add_pcie_port(struct ls_pcie *pcie)
 	pp->dbi_base = pcie->dbi;
 	pp->irq = pcie->irq;
 
+	ret = devm_request_irq(pp->dev, pcie->irq, ls_pcie_irq_handler,
+				IRQF_SHARED, "ls-pcie", pp);
+	if (ret) {
+		dev_err(pp->dev, "failed to requesppt irq\n");
+		return ret;
+	}
+
+	ret = devm_request_irq(pp->dev, pcie->cfg_irq, ls_pcie_irq_handler,
+				IRQF_SHARED, "ls-pcie-cfg", pcie);
+	if (ret) {
+		dev_err(pp->dev, "failed to request CFG error irq\n");
+		return ret;
+	}
 
 	if (IS_ENABLED(CONFIG_PCI_MSI)) {
 		pp->msi_irq = pcie->msi_irq;
@@ -187,6 +209,13 @@ static int __init ls_pcie_probe(struct platform_device *pdev)
 		goto err;
 	}
 
+	pcie->cfg_irq = platform_get_irq_byname(pdev, "cfg-err");
+	if (pcie->cfg_irq < 0) {
+		dev_err(&pdev->dev,
+			"failed to get CFG error IRQ: %d\n", pcie->cfg_irq);
+		goto err;
+	}
+
 	pcie->msi_irq = platform_get_irq_byname(pdev, "msi");
 	if (pcie->msi_irq < 0) {
 		dev_err(&pdev->dev,
-- 
2.0.2

