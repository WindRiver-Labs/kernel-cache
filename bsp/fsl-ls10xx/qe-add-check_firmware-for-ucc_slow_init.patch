From 19db891e43bf7b82850a2c7ca28dff61feeabff3 Mon Sep 17 00:00:00 2001
From: Zhao Qiang <B45475@freescale.com>
Date: Mon, 26 May 2014 14:05:27 +0800
Subject: [PATCH 126/255] qe: add check_firmware for ucc_slow_init

ucc can't work without qe firmware, so check it
when init ucc.

Signed-off-by: Zhao Qiang <B45475@freescale.com>
[Kevin: Original patch taken from
LS1021A-SDK-V1.1-ARM-SOURCE-20140815-yocto.iso]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/qe/qe.c        | 9 +++++++++
 drivers/qe/ucc_slow.c  | 2 ++
 include/linux/fsl/qe.h | 1 +
 3 files changed, 12 insertions(+)

diff --git a/drivers/qe/qe.c b/drivers/qe/qe.c
index 8d9dd7d..34e406f 100644
--- a/drivers/qe/qe.c
+++ b/drivers/qe/qe.c
@@ -682,6 +682,15 @@ unsigned int qe_get_num_of_snums(void)
 }
 EXPORT_SYMBOL(qe_get_num_of_snums);
 
+int qe_check_firmware(void)
+{
+	if (!ioread32be(&qe_immr->cp.ceurnr))
+		return -EPERM;
+	else
+		return 0;
+}
+EXPORT_SYMBOL(qe_check_firmware);
+
 #if defined(CONFIG_SUSPEND) && defined(CONFIG_PPC_85xx)
 static int qe_resume(struct platform_device *ofdev)
 {
diff --git a/drivers/qe/ucc_slow.c b/drivers/qe/ucc_slow.c
index 517c0a0..a150d41 100644
--- a/drivers/qe/ucc_slow.c
+++ b/drivers/qe/ucc_slow.c
@@ -136,6 +136,8 @@ int ucc_slow_init(struct ucc_slow_info * us_info, struct ucc_slow_private ** ucc
 	u32 command;
 	int ret = 0;
 
+	if (qe_check_firmware())
+		return -EPERM;
 	if (!us_info)
 		return -EINVAL;
 
diff --git a/include/linux/fsl/qe.h b/include/linux/fsl/qe.h
index a28817a..5ee495d 100644
--- a/include/linux/fsl/qe.h
+++ b/include/linux/fsl/qe.h
@@ -166,6 +166,7 @@ int qe_get_snum(void);
 void qe_put_snum(u8 snum);
 unsigned int qe_get_num_of_risc(void);
 unsigned int qe_get_num_of_snums(void);
+int qe_check_firmware(void);
 
 static inline int qe_alive_during_sleep(void)
 {
-- 
2.0.2

