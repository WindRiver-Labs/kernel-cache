From abb87db35e618537241ffc86e30ffe2c937cf191 Mon Sep 17 00:00:00 2001
From: zou cao <cao.zou@windriver.com>
Date: Mon, 5 Jun 2017 14:08:02 +0800
Subject: [PATCH] mxc_edid: fixed a kmemleak of mode buffer in
 mxc_edid_parse_ext_blk

Add a check of modedb pointer before set a new value, it will fix
a kmemleak of mode buffer as follow:
unreferenced object 0xa8012000 (size 2048):
  comm "swapper/0", pid 1, jiffies 4294937654 (age 576.060s)
  hex dump (first 32 bytes):
    00 00 00 00 3b 00 00 00 90 06 00 00 1a 04 00 00 ....;...........
    b5 1a 00 00 18 01 00 00 68 00 00 00 1e 00 00 00 ........h.......
  backtrace:
    [<80836040>] kmemleak_alloc+0x40/0x74
    [<8013e9a8>] __kmalloc+0x1fc/0x35c
    [<8043ff10>] mxc_edid_parse_ext_blk+0x7d0/0x864
    [<804401b8>] mxc_edid_read+0x214/0x228
    [<8044c4f8>] sii902x_read_edid+0xb4/0x124
    [<8044c684>] sii902x_probe+0x11c/0x35c
    [<805a6ee8>] i2c_device_probe+0x104/0x12c
    [<804c3278>] driver_probe_device+0x104/0x268
    [<804c34a8>] __driver_attach+0x78/0x9c
    [<804c1864>] bus_for_each_dev+0x7c/0xa0
    [<804c2d28>] driver_attach+0x28/0x30
    [<804c2990>] bus_add_driver+0xf4/0x1dc
    [<804c3ecc>] driver_register+0xac/0xf0
    [<805a7ae0>] i2c_register_driver+0x50/0x84
    [<80bf4bc0>] sii902x_driver_init+0x18/0x20
    [<80009774>] do_one_initcall+0x114/0x1c4

Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/video/fbdev/mxc/mxc_edid.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/video/fbdev/mxc/mxc_edid.c b/drivers/video/fbdev/mxc/mxc_edid.c
index 23110ce..5911843 100644
--- a/drivers/video/fbdev/mxc/mxc_edid.c
+++ b/drivers/video/fbdev/mxc/mxc_edid.c
@@ -583,7 +583,7 @@ int mxc_edid_parse_ext_blk(unsigned char *edid,
 		return 0;
 	}
 
-	if (specs->modedb_len) {
+	if (specs->modedb || specs->modedb_len) {
 		memmove(m, specs->modedb,
 			specs->modedb_len * sizeof(struct fb_videomode));
 		kfree(specs->modedb);
-- 
1.7.5.4

