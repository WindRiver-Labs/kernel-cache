From 86f3a09c4b7d1ebc940682521d2edb03a55fbf9d Mon Sep 17 00:00:00 2001
From: Dong Aisheng <aisheng.dong@nxp.com>
Date: Thu, 1 Sep 2016 20:49:45 +0800
Subject: [PATCH 80/85] MLK-13179-3 bcmdhd: add OOB support for all IMX6 and
 IMX7 platforms

Enable OOB feature for MX6Q/DL SDB, MX6SL EVK, MX6SX SDB, MX7D SDB boards.

NOTE: The performance optimization option CONFIG_BCM4339 is disabled
by default due to a WiFi driver issue that it breaks MX6SL EVK.

If user want to test performance on the above platforms (except MX6SL EVK),
CONFIG_BCM4339 has to be enabled manually.

Signed-off-by: Dong Aisheng <aisheng.dong@nxp.com>
(cherry picked from commit ae55027339431f7d1c4251dd39ac484c9f9f4245)
[zou:Original patch taken from
git://git.freescale.com/imx/linux-imx.git imx_4.1.15_2.0.0_ga]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 arch/arm/boot/dts/imx6qdl-sabresd-btwifi.dtsi |    2 ++
 arch/arm/boot/dts/imx6sx-sdb-btwifi.dts       |    3 +++
 arch/arm/boot/dts/imx7d-sdb.dts               |    7 +++++--
 drivers/net/wireless/bcmdhd/Kconfig           |    4 ++++
 drivers/net/wireless/bcmdhd/Makefile          |    6 ++++--
 drivers/net/wireless/bcmdhd/dhd_sdio.c        |   16 +++++++++++++++-
 6 files changed, 33 insertions(+), 5 deletions(-)

diff --git a/arch/arm/boot/dts/imx6qdl-sabresd-btwifi.dtsi b/arch/arm/boot/dts/imx6qdl-sabresd-btwifi.dtsi
index 5c69ece..5e697a0 100644
--- a/arch/arm/boot/dts/imx6qdl-sabresd-btwifi.dtsi
+++ b/arch/arm/boot/dts/imx6qdl-sabresd-btwifi.dtsi
@@ -36,6 +36,7 @@
 
 	bcmdhd_wlan_0: bcmdhd_wlan@0 {
 		compatible = "android,bcmdhd_wlan";
+		gpios = <&gpio4 6 0>; /* WL_HOST_WAKE */
 		wlreg_on-supply = <&wlreg_on>;
 	};
 };
@@ -56,6 +57,7 @@
 				MX6QDL_PAD_SD2_DAT2__SD2_DATA2		0x17059
 				MX6QDL_PAD_SD2_DAT3__SD2_DATA3		0x17059
 				MX6QDL_PAD_KEY_ROW0__GPIO4_IO07		0x13069	/* WL_REG_ON */
+				MX6QDL_PAD_KEY_COL0__GPIO4_IO06		0x13069	/* WL_HOST_WAKE */
 			>;
 		};
 	};
diff --git a/arch/arm/boot/dts/imx6sx-sdb-btwifi.dts b/arch/arm/boot/dts/imx6sx-sdb-btwifi.dts
index 09db554..ba5512e 100644
--- a/arch/arm/boot/dts/imx6sx-sdb-btwifi.dts
+++ b/arch/arm/boot/dts/imx6sx-sdb-btwifi.dts
@@ -30,6 +30,8 @@
 
 	bcmdhd_wlan_0: bcmdhd_wlan@0 {
 		compatible = "android,bcmdhd_wlan";
+		/* WL_HOST_WAKE: SD2_DAT1 (gpio6 9) */
+		gpios = <&gpio6 9 0>;
 		wlreg_on-supply = <&wlreg_on>;
 	};
 };
@@ -72,6 +74,7 @@
 				MX6SX_PAD_KEY_COL0__GPIO2_IO_10		0x17059 /* CD */
 				MX6SX_PAD_KEY_ROW0__GPIO2_IO_15		0x17059 /* WP */
 				/* Murata Module control signals */
+				MX6SX_PAD_SD2_DATA1__GPIO6_IO_9         0x13069 /* WL_HOST_WAKE */
 				MX6SX_PAD_SD2_DATA2__GPIO6_IO_10	0x13069 /* WL_REG_ON */
 			>;
 		};
diff --git a/arch/arm/boot/dts/imx7d-sdb.dts b/arch/arm/boot/dts/imx7d-sdb.dts
index 09089bb..8f03224 100644
--- a/arch/arm/boot/dts/imx7d-sdb.dts
+++ b/arch/arm/boot/dts/imx7d-sdb.dts
@@ -29,6 +29,7 @@
 
 	bcmdhd_wlan_0: bcmdhd_wlan@0 {
 		compatible = "android,bcmdhd_wlan";
+		gpios = <&gpio4 20 0>;		/* WL_HOST_WAKE */
 		wlreg_on-supply = <&wlreg_on>;
 	};
 
@@ -151,6 +152,7 @@
 			regulator-max-microvolt = <5000000>;
 			regulator-name = "wlreg_on";
 			gpio = <&gpio4 21 GPIO_ACTIVE_HIGH>;
+			startup-delay-us = <100>;
 			enable-active-high;
 		};
 	};
@@ -549,7 +551,7 @@
 	imx7d-sdb {
 		pinctrl_hog_1: hoggrp-1 {
 			fsl,pins = <
-				MX7D_PAD_ECSPI2_SS0__GPIO4_IO23	0x80000000  /* bt reg on */
+				MX7D_PAD_ECSPI2_SS0__GPIO4_IO23	0x19 /* BT_REG_ON */
 				MX7D_PAD_EPDC_BDR0__GPIO2_IO28	0x59 /* headphone detect */
 			>;
 		};
@@ -898,7 +900,8 @@
 				MX7D_PAD_SD2_DATA1__SD2_DATA1   0x59
 				MX7D_PAD_SD2_DATA2__SD2_DATA2   0x59
 				MX7D_PAD_SD2_DATA3__SD2_DATA3   0x59
-				MX7D_PAD_ECSPI2_MOSI__GPIO4_IO21	0x59 /* WL_REG_ON */
+				MX7D_PAD_ECSPI2_MOSI__GPIO4_IO21	0x19 /* WL_REG_ON */
+				MX7D_PAD_ECSPI2_SCLK__GPIO4_IO20	0x19 /* WL_HOST_WAKE */
 			>;
 		};
 
diff --git a/drivers/net/wireless/bcmdhd/Kconfig b/drivers/net/wireless/bcmdhd/Kconfig
index b05d5e5..2a0856e 100644
--- a/drivers/net/wireless/bcmdhd/Kconfig
+++ b/drivers/net/wireless/bcmdhd/Kconfig
@@ -15,6 +15,10 @@ config BCMDHD_PCIE
 	bool "PCIe bus interface support"
 	depends on BCMDHD && PCI && !BCMDHD_SDIO
 
+config BCM4339
+	tristate "BCM4339 support"
+	depends on BCMDHD
+
 config BCM4354
 	tristate "BCM4354 support"
 	depends on BCMDHD
diff --git a/drivers/net/wireless/bcmdhd/Makefile b/drivers/net/wireless/bcmdhd/Makefile
index 5ee0fb1..c98a5be 100644
--- a/drivers/net/wireless/bcmdhd/Makefile
+++ b/drivers/net/wireless/bcmdhd/Makefile
@@ -133,6 +133,8 @@ ifneq ($(CONFIG_BCM4339),)
 
   # tput enhancement
   DHDCFLAGS += -DCUSTOM_GLOM_SETTING=8 -DCUSTOM_RXCHAIN=1
+  DHDCFLAGS += -DCUSTOM_RXCHAIN=1
+
   DHDCFLAGS += -DUSE_DYNAMIC_F2_BLKSIZE -DDYNAMIC_F2_BLKSIZE_FOR_NONLEGACY=128
   DHDCFLAGS += -DBCMSDIOH_TXGLOM -DCUSTOM_TXGLOM=1 -DBCMSDIOH_TXGLOM_HIGHSPEED
   DHDCFLAGS += -DDHDTCPACK_SUPPRESS
@@ -141,8 +143,8 @@ ifneq ($(CONFIG_BCM4339),)
   DHDCFLAGS += -DRXFRAME_THREAD
   DHDCFLAGS += -DCUSTOM_AMPDU_BA_WSIZE=64
   DHDCFLAGS += -DCUSTOM_DPC_CPUCORE=0
-  DHDCFLAGS += -DPROP_TXSTATUS_VSDB
-  DHDCFLAGS += -DCUSTOM_MAX_TXGLOM_SIZE=32
+#  DHDCFLAGS += -DPROP_TXSTATUS_VSDB
+   DHDCFLAGS += -DCUSTOM_MAX_TXGLOM_SIZE=32
 
   # New Features
   DHDCFLAGS += -DWL11U
diff --git a/drivers/net/wireless/bcmdhd/dhd_sdio.c b/drivers/net/wireless/bcmdhd/dhd_sdio.c
index 7e0e7ab..1207bb3 100644
--- a/drivers/net/wireless/bcmdhd/dhd_sdio.c
+++ b/drivers/net/wireless/bcmdhd/dhd_sdio.c
@@ -381,6 +381,9 @@ typedef struct dhd_bus {
 	bool		txglom_enable;	/* Flag to indicate whether tx glom is enabled/disabled */
 	uint32		txglomsize;	/* Glom size limitation */
 	void		*pad_pkt;
+#ifdef HW_OOB
+	int		bus_wake_on_resume; /* addition to fix suspend/resume powersave issue */
+#endif
 } dhd_bus_t;
 
 /* clkstate */
@@ -6536,7 +6539,13 @@ dhd_bus_watchdog(dhd_pub_t *dhdp)
 	DHD_TIMER(("%s: Enter\n", __FUNCTION__));
 
 	bus = dhdp->bus;
-
+#ifdef HW_OOB
+	/* this code segment added to fix suspend/resume powersave issue */
+	if (bus->bus_wake_on_resume) {
+		BUS_WAKE(bus);
+		bus->bus_wake_on_resume = 0;
+	}
+#endif
 	if (bus->dhd->dongle_reset)
 		return FALSE;
 
@@ -7508,6 +7517,11 @@ dhdsdio_resume(void *context)
 			bcmsdh_oob_intr_set(bus->sdh, TRUE);
 	}
 #endif 
+#ifdef HW_OOB
+	/* this code segment added to fix suspend/resume powersave issue */
+	bus->bus_wake_on_resume = 1;
+	dhd_os_wd_timer(bus->dhd, 1000);
+#endif
 	return 0;
 }
 
-- 
1.7.5.4

