From 5135290bbcbd2a93579723aaaf9b34d16903928f Mon Sep 17 00:00:00 2001
From: Prabhu Sundararaj <prabhu.sundararaj@nxp.com>
Date: Tue, 13 Sep 2016 10:27:49 -0500
Subject: [PATCH 75/85] MGS-2233 [#imx-178] fix gpu axi bus error with process
 kill operations

GPU MMU pages are removed with process kill event, but the memory is still in hardware access.
gckKERNEL_DestroyProcessDB --> gckOS_UnmapUserMemory --> gckMMU_FreePages --> _FreePages --> clear MMU
pages with gcdMMU_CLEAR_VALUE.
This is the common issue in GPU driver, can be reproduced easily on GC400T due to low hardware performance.

this patch add the command stall to complete gpu hardware pipeline before remove the MMU pages.
the original issue can be reproduced with several minutes, not reproducible with the fix.

Date: Sep 13, 2016
Signed-off-by: Xianzhong <xianzhong.li@nxp.com>
[zou:Original patch taken from
git://git.freescale.com/imx/linux-imx.git imx_4.1.15_2.0.0_ga]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/mxc/gpu-viv/hal/kernel/gc_hal_kernel_db.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/mxc/gpu-viv/hal/kernel/gc_hal_kernel_db.c b/drivers/mxc/gpu-viv/hal/kernel/gc_hal_kernel_db.c
index 1c3eaa6..2cf92fe 100644
--- a/drivers/mxc/gpu-viv/hal/kernel/gc_hal_kernel_db.c
+++ b/drivers/mxc/gpu-viv/hal/kernel/gc_hal_kernel_db.c
@@ -1485,6 +1485,9 @@ gckKERNEL_DestroyProcessDB(
             break;
 
         case gcvDB_MAP_USER_MEMORY:
+
+            gcmkERR_BREAK(gckCOMMAND_Stall(Kernel->command, gcvFALSE));
+
             /* TODO: Unmap user memory. */
             status = gckOS_UnmapUserMemory(Kernel->os,
                                            Kernel->core,
-- 
1.7.5.4

