From 51df3f497100f9a5950981012f8057df117da8a1 Mon Sep 17 00:00:00 2001
From: zou cao <cao.zou@windriver.com>
Date: Mon, 5 Jun 2017 14:46:39 +0800
Subject: [PATCH] Input: ads7846: use gpio_desc to replace gpio number

Use gpio_desc to replace gpio number, it will fixed a calltrace as
follow:
BUG: sleeping function called from invalid context at kernel/locking/rtmutex.c:917
in_atomic(): 1, irqs_disabled(): 128, pid: 69, name: spi2
Preemption disabled at:[< (null)>] (null)

CPU: 0 PID: 69 Comm: spi2 Not tainted 4.1.21-rt13-WR8.0.0.0_preempt-rt #1
Hardware name: Freescale i.MX7 Dual (Device Tree)
[<8001a0e8>] (unwind_backtrace) from [<80013b30>] (show_stack+0x20/0x24)
[<80013b30>] (show_stack) from [<8093e0d8>] (dump_stack+0x84/0xa8)
[<8093e0d8>] (dump_stack) from [<8005b198>] (___might_sleep+0x184/0x1b8)
[<8005b198>] (___might_sleep) from [<80945650>] (rt_spin_lock+0x28/0x78)
[<80945650>] (rt_spin_lock) from [<803f6ec0>] (gpio_to_desc+0x24/0xc4)
[<803f6ec0>] (gpio_to_desc) from [<805fa880>] (get_pendown_state+0x30/0x40)
[<805fa880>] (get_pendown_state) from [<805fa8ac>] (ads7846_hard_irq+0x1c/0x2c)
[<805fa8ac>] (ads7846_hard_irq) from [<8007f608>] (handle_irq_event_percpu+0xf0/0x308)
[<8007f608>] (handle_irq_event_percpu) from [<8007f8b4>] (handle_irq_event+0x94/0xb4)
[<8007f8b4>] (handle_irq_event) from [<80083158>] (handle_level_irq+0xf0/0x178)
[<80083158>] (handle_level_irq) from [<8007ebb8>] (generic_handle_irq+0x30/0x40)
[<8007ebb8>] (generic_handle_irq) from [<803fa780>] (mxc_gpio_irq_handler+0xf8/0x110)
[<803fa780>] (mxc_gpio_irq_handler) from [<803fa850>] (mx3_gpio_irq_handler+0xb8/0xd4)
[<803fa850>] (mx3_gpio_irq_handler) from [<8007ebb8>] (generic_handle_irq+0x30/0x40)
[<8007ebb8>] (generic_handle_irq) from [<8007ef08>] (__handle_domain_irq+0xb0/0xf0)
[<8007ef08>] (__handle_domain_irq) from [<80009458>] (gic_handle_irq+0x4c/0x6c)
[<80009458>] (gic_handle_irq) from [<800146c0>] (__irq_svc+0x40/0x88)
Signed-off-by: zou cao <cao.zou@windriver.com>

Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/input/touchscreen/ads7846.c |   10 +++++-----
 1 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/drivers/input/touchscreen/ads7846.c b/drivers/input/touchscreen/ads7846.c
index c1e7a8d..93a1f8d 100644
--- a/drivers/input/touchscreen/ads7846.c
+++ b/drivers/input/touchscreen/ads7846.c
@@ -141,7 +141,7 @@ struct ads7846 {
 	void			*filter_data;
 	void			(*filter_cleanup)(void *data);
 	int			(*get_pendown_state)(void);
-	int			gpio_pendown;
+	struct gpio_desc			*gpio_pendown_desc;
 
 	void			(*wait_for_sync)(void);
 };
@@ -612,7 +612,7 @@ static int get_pendown_state(struct ads7846 *ts)
 	if (ts->get_pendown_state)
 		return ts->get_pendown_state();
 
-	return !gpio_get_value(ts->gpio_pendown);
+	return !gpiod_get_raw_value(ts->gpio_pendown_desc);
 }
 
 static void null_wait_for_sync(void)
@@ -958,7 +958,7 @@ static int ads7846_setup_pendown(struct spi_device *spi,
 			return err;
 		}
 
-		ts->gpio_pendown = pdata->gpio_pendown;
+		ts->gpio_pendown_desc = gpio_to_desc(pdata->gpio_pendown);
 
 		if (pdata->gpio_pendown_debounce)
 			gpio_set_debounce(pdata->gpio_pendown,
@@ -1452,7 +1452,7 @@ static int ads7846_probe(struct spi_device *spi)
 	regulator_put(ts->reg);
  err_free_gpio:
 	if (!ts->get_pendown_state)
-		gpio_free(ts->gpio_pendown);
+		gpiod_put(ts->gpio_pendown_desc);
  err_cleanup_filter:
 	if (ts->filter_cleanup)
 		ts->filter_cleanup(ts->filter_data);
@@ -1486,7 +1486,7 @@ static int ads7846_remove(struct spi_device *spi)
 		 * If we are not using specialized pendown method we must
 		 * have been relying on gpio we set up ourselves.
 		 */
-		gpio_free(ts->gpio_pendown);
+		gpiod_put(ts->gpio_pendown_desc);
 	}
 
 	if (ts->filter_cleanup)
-- 
1.7.5.4

