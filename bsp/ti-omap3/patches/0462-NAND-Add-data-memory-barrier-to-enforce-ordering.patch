From 59f0b301c83755acda0ff4b870854f1f045c52ee Mon Sep 17 00:00:00 2001
From: Sriramakrishnan <srk@ti.com>
Date: Wed, 3 Mar 2010 14:58:03 +0530
Subject: [PATCH 462/609] NAND : Add data memory barrier to enforce ordering

Original commit: bb7510439d6ae624fa2c20f5b69deb878c213abb

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

When using delay loop for wait states, need to ascertain that
the write to OMAP HW register is reflected befor the delay
loop starts. This patch adds a dmb() instruction to this effect.
Without this fix, NAND read failures reported with mtd_oobtests.

Signed-off-by: Sriramakrishnan <srk@ti.com>
Signed-off-by: Sriramakrishnan A G <srk@ti.com>
---
 drivers/mtd/nand/nand_base.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/mtd/nand/nand_base.c b/drivers/mtd/nand/nand_base.c
index eb9f5fb..3cda040 100644
--- a/drivers/mtd/nand/nand_base.c
+++ b/drivers/mtd/nand/nand_base.c
@@ -752,6 +752,8 @@ static void nand_command_lp(struct mtd_info *mtd, unsigned int command,
 		chip->cmd_ctrl(mtd, NAND_CMD_NONE,
 			       NAND_NCE | NAND_CTRL_CHANGE);
 
+		dmb();
+
 		/* This applies to read commands */
 	default:
 		/*
-- 
1.7.5.4

