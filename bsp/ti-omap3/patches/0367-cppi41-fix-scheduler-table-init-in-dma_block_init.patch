From 3dac6e5ef64024c3a51775ac26f71c3c5c6e8484 Mon Sep 17 00:00:00 2001
From: Ajay Kumar Gupta <ajay.gupta@ti.com>
Date: Mon, 9 Nov 2009 17:05:47 +0530
Subject: [PATCH 367/609] cppi41: fix scheduler table init in dma_block_init()

Original commit: 01f1e3c7a1d6a81d919fc9fcb3ae084ade271a56

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

scheduler table init programming is unreliable using for loops so
fixing this by using scheduler table entries.

Signed-off-by: Ajay Kumar Gupta <ajay.gupta@ti.com>
Signed-off-by: Vaibhav Hiremath <hvaibhav@ti.com>
---
 drivers/usb/musb/cppi41.c |   13 ++++---------
 drivers/usb/musb/cppi41.h |    2 +-
 2 files changed, 5 insertions(+), 10 deletions(-)

diff --git a/drivers/usb/musb/cppi41.c b/drivers/usb/musb/cppi41.c
index d98d62f..3b2ea3d 100644
--- a/drivers/usb/musb/cppi41.c
+++ b/drivers/usb/musb/cppi41.c
@@ -107,14 +107,14 @@ int cppi41_queue_mgr_init(u8 q_mgr, dma_addr_t rgn0_base, u16 rgn0_size)
 }
 
 int cppi41_dma_block_init(u8 dma_num, u8 q_mgr, u8 num_order,
-				 u8 *sched_tbl, u8 tbl_size)
+				 u32 *sched_tbl, u8 tbl_size)
 {
 	const struct cppi41_dma_block *dma_block;
 	struct cppi41_teardown_desc *curr_td;
 	dma_addr_t td_addr;
 	unsigned num_desc, num_reg;
 	void *ptr;
-	int error, i, j, k;
+	int error, i;
 	u16 q_num;
 	u32 val;
 
@@ -193,13 +193,8 @@ int cppi41_dma_block_init(u8 dma_num, u8 q_mgr, u8 num_order,
 
 	/* Initialize the DMA scheduler. */
 	num_reg = (tbl_size + 3) / 4;
-	for (k = i = 0; i < num_reg; i++) {
-		for (val = j = 0; j < 4; j++, k++) {
-			val >>= 8;
-			if (k < tbl_size)
-				val |= sched_tbl[k] << 24;
-		}
-
+	for (i = 0; i < num_reg; i++) {
+		val = sched_tbl[i];
 		__raw_writel(val, dma_block->sched_table_base +
 			     DMA_SCHED_TABLE_WORD_REG(i));
 		DBG("DMA scheduler table @ %p, value written: %x\n",
diff --git a/drivers/usb/musb/cppi41.h b/drivers/usb/musb/cppi41.h
index d66947a..6b79c10 100644
--- a/drivers/usb/musb/cppi41.h
+++ b/drivers/usb/musb/cppi41.h
@@ -537,7 +537,7 @@ int cppi41_mem_rgn_free(u8 q_mgr, u8 mem_rgn);
  * Returns 0 on success, error otherwise.
  */
 int cppi41_dma_block_init(u8 dma_num, u8 q_mgr, u8 num_order,
-				 u8 *sched_tbl, u8 tbl_size);
+				 u32 *sched_tbl, u8 tbl_size);
 
 /*
  * CPPI 4.1 DMA Channel Management APIs
-- 
1.7.5.4

