From 004a89708e5c066052a23baae3ec7fdc93574b55 Mon Sep 17 00:00:00 2001
From: Eyal Reizer <eyalr@ti.com>
Date: Wed, 6 Jun 2012 19:07:43 +0530
Subject: [PATCH 258/609] ARM: OMAP2+: am335x: Add wlan suspend-resume support

Original commit: 2710c5e5c01f24558edd12062f1c3b1b16a95e25

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

Configure the wlan_enable pin to output mode on every resume
as its configuration is lost during suspend

MMC_PM_KEEP_POWER flag is removed from the .caps structure element
since it needs to a part of .pm_caps, if required.

Signed-off-by: Eyal Reizer <eyalr@ti.com>
[vaibhav.bedia@ti.com - Update the patch to take care of the
recent changes in the board file, drop the pad context save
and restore since that is now handled in pm33xx.c and update
the commit message accordingly]
Signed-off-by: Vaibhav Bedia <vaibhav.bedia@ti.com>
---
 arch/arm/mach-omap2/board-am335xevm.c |    9 ++++-----
 1 files changed, 4 insertions(+), 5 deletions(-)

diff --git a/arch/arm/mach-omap2/board-am335xevm.c b/arch/arm/mach-omap2/board-am335xevm.c
index 144cd30..6903097 100644
--- a/arch/arm/mach-omap2/board-am335xevm.c
+++ b/arch/arm/mach-omap2/board-am335xevm.c
@@ -1591,8 +1591,7 @@ static void mmc2_wl12xx_init(int evm_id, int profile)
 
 	am335x_mmc[1].mmc = 3;
 	am335x_mmc[1].name = "wl1271";
-	am335x_mmc[1].caps = MMC_CAP_4_BIT_DATA | MMC_CAP_POWER_OFF_CARD
-				| MMC_PM_KEEP_POWER;
+	am335x_mmc[1].caps = MMC_CAP_4_BIT_DATA | MMC_CAP_POWER_OFF_CARD;
 	am335x_mmc[1].nonremovable = true;
 	am335x_mmc[1].gpio_cd = -EINVAL;
 	am335x_mmc[1].gpio_wp = -EINVAL;
@@ -1621,11 +1620,11 @@ static void wl12xx_bluetooth_enable(void)
 static int wl12xx_set_power(struct device *dev, int slot, int on, int vdd)
 {
 	if (on) {
-		gpio_set_value(am335xevm_wlan_data.wlan_enable_gpio, 1);
+		gpio_direction_output(am335xevm_wlan_data.wlan_enable_gpio, 1);
 		mdelay(70);
+	} else {
+		gpio_direction_output(am335xevm_wlan_data.wlan_enable_gpio, 0);
 	}
-	else
-		gpio_set_value(am335xevm_wlan_data.wlan_enable_gpio, 0);
 
 	return 0;
 }
-- 
1.7.5.4

