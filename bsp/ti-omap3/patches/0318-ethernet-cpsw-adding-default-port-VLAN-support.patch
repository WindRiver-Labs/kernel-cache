From a9a196f1b043cbc7a0ef7f62e58c928d2c823603 Mon Sep 17 00:00:00 2001
From: Mugunthan V N <mugunthanvnm@ti.com>
Date: Tue, 7 Aug 2012 14:15:29 +0800
Subject: [PATCH 318/609] ethernet: cpsw: adding default port VLAN support

Original commit: 8f4a08176990d64ab287749058d03e1033768f69

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

This patch enables configuring any VID as default VLAN.
Default VLAN can be configured in CPSW with adding VLAN to ale and
configuring the port VLAN

Signed-off-by: Mugunthan V N <mugunthanvnm@ti.com>
---
 drivers/net/ethernet/ti/cpsw.c     |   15 +++++++++++++++
 include/linux/platform_data/cpsw.h |    2 ++
 2 files changed, 17 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/ti/cpsw.c b/drivers/net/ethernet/ti/cpsw.c
index b6564bd..e4ee227 100644
--- a/drivers/net/ethernet/ti/cpsw.c
+++ b/drivers/net/ethernet/ti/cpsw.c
@@ -812,6 +812,21 @@ static void cpsw_slave_open(struct cpsw_slave *slave, struct cpsw_priv *priv)
 	}
 }
 
+#if defined(VLAN_SUPPORT) && !defined(CONFIG_TI_CPSW_DUAL_EMAC)
+static inline void cpsw_add_default_vlan(struct cpsw_priv *priv)
+{
+	writel(priv->data.default_vlan, &priv->host_port_regs->port_vlan);
+	writel(priv->data.default_vlan, &priv->slaves[0].regs->port_vlan);
+	writel(priv->data.default_vlan, &priv->slaves[1].regs->port_vlan);
+	cpsw_ale_add_vlan(priv->ale, priv->data.default_vlan,
+			ALE_ALL_PORTS << priv->host_port,
+			ALE_ALL_PORTS << priv->host_port,
+			ALE_ALL_PORTS << priv->host_port, 0);
+}
+#else
+#define cpsw_add_default_vlan(priv)
+#endif
+
 static void cpsw_init_host_port(struct cpsw_priv *priv)
 {
 	u32 control_reg;
diff --git a/include/linux/platform_data/cpsw.h b/include/linux/platform_data/cpsw.h
index 505753b..16a0150 100644
--- a/include/linux/platform_data/cpsw.h
+++ b/include/linux/platform_data/cpsw.h
@@ -48,6 +48,8 @@ struct cpsw_platform_data {
 	u32	bd_ram_size;  /*buffer descriptor ram size */
 	u32	hw_ram_addr; /*if the HW address for BD RAM is different */
 	bool	no_bd_ram; /* no embedded BD ram*/
+	u8	version;
+	u32	default_vlan; /* Default VLAN for Untagged packet handling*/
 
 	u32	rx_descs;	/* Number of Rx Descriptios */
 
-- 
1.7.5.4

