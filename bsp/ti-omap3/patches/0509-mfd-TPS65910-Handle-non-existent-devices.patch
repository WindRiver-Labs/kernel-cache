From 0831aed3d4ea085e9ca720af8c61e10eb7949a68 Mon Sep 17 00:00:00 2001
From: Kyle Manna <kyle.manna@fuel7.com>
Date: Sat, 30 Jun 2012 14:58:47 +0800
Subject: [PATCH 509/609] mfd: TPS65910: Handle non-existent devices

Original commit: 833d23a58cefb2a2b6abaa40d3d00531206cde38

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

Attempt to read the first register of the device, if there is no
device return -ENODEV

Signed-off-by: Kyle Manna <kyle.manna@fuel7.com>
Signed-off-by: Afzal Mohammed <afzal@ti.com>
Signed-off-by: Vaibhav Hiremath <hvaibhav@ti.com>
---
 drivers/mfd/tps65910.c |   22 +++++++++++++++++++---
 1 files changed, 19 insertions(+), 3 deletions(-)

diff --git a/drivers/mfd/tps65910.c b/drivers/mfd/tps65910.c
index bf2b25e..4addebd 100644
--- a/drivers/mfd/tps65910.c
+++ b/drivers/mfd/tps65910.c
@@ -97,6 +97,7 @@ static int tps65910_i2c_probe(struct i2c_client *i2c,
 	struct tps65910_board *pmic_plat_data;
 	struct tps65910_platform_data *init_data;
 	int ret = 0;
+	unsigned char buff;
 
 	pmic_plat_data = dev_get_platdata(&i2c->dev);
 	if (!pmic_plat_data)
@@ -127,9 +128,24 @@ static int tps65910_i2c_probe(struct i2c_client *i2c,
 		goto regmap_err;
 	}
 
-	ret = mfd_add_devices(tps65910->dev, -1,
-			      tps65910s, ARRAY_SIZE(tps65910s),
-			      NULL, 0);
+	/* Check that the device is actually there */
+	ret = tps65910_i2c_read(tps65910, 0x0, 1, &buff);
+	if (ret < 0) {
+		dev_err(tps65910->dev, "could not be detected\n");
+		ret = -ENODEV;
+		goto err;
+	}
+
+	dev_info(tps65910->dev, "JTAGREVNUM 0x%x\n", buff);
+
+	if (buff & ~JTAGVERNUM_VERNUM_MASK) {
+		dev_err(tps65910->dev, "unknown version\n");
+		ret = -ENODEV;
+		goto err;
+	}
+
+	ret = mfd_add_devices(tps65910->dev, -1, tps65910s,
+			ARRAY_SIZE(tps65910s), NULL, 0);
 	if (ret < 0)
 		goto err;
 
-- 
1.7.5.4

