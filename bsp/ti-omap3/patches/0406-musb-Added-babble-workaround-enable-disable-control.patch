From c468cff763e32e49ae41959e67cec5dc0be665c3 Mon Sep 17 00:00:00 2001
From: Ravi B <ravibabu@ti.com>
Date: Mon, 5 Sep 2011 11:40:05 +0530
Subject: [PATCH 406/609] musb: Added babble workaround enable/disable control

Original commit: a0acdaa046068f424e5ab0ecd6b650deb3f3b65a

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

Added enable/disable babble workaround through procfs entry
to eanble babble workaround
echo 'K' > /proc/driver/musb_hdrc.0 or 1
to disable babble workaround
echo 'k' > /proc/driver/musb_hdrc.0 or 1

Signed-off-by: Ravi B <ravibabu@ti.com>
Signed-off-by: Vaibhav Hiremath <hvaibhav@ti.com>
---
 drivers/usb/musb/musb_core.h   |    1 +
 drivers/usb/musb/musb_procfs.c |   13 +++++++++++++
 drivers/usb/musb/ti81xx.c      |    3 ++-
 3 files changed, 16 insertions(+), 1 deletions(-)

diff --git a/drivers/usb/musb/musb_core.h b/drivers/usb/musb/musb_core.h
index a1df2ce..997446e 100644
--- a/drivers/usb/musb/musb_core.h
+++ b/drivers/usb/musb/musb_core.h
@@ -330,6 +330,7 @@ struct musb {
 	struct work_struct	irq_work;
 	struct work_struct      work;
 	struct work_struct	otg_notifier_work;
+	u8                      enable_babble_work;
 	u16			hwvers;
 
 /* this hub status bit is reserved by USB 2.0 and not seen by usbcore */
diff --git a/drivers/usb/musb/musb_procfs.c b/drivers/usb/musb/musb_procfs.c
index f282fb9..ce44d06 100644
--- a/drivers/usb/musb/musb_procfs.c
+++ b/drivers/usb/musb/musb_procfs.c
@@ -750,6 +750,18 @@ static int musb_proc_write(struct file *file, const char __user *buffer,
 		musb_simulate_babble_intr(musb);
 		break;
 
+	case 'K':
+		/* enable babble workaround */
+		musb->enable_babble_work = 1;
+		INFO("enabled babble workaround\n");
+		break;
+
+	case 'k':
+		/* disable babble workaround */
+		musb->enable_babble_work = 0;
+		INFO("disabled babble workaround\n");
+		break;
+
 	case '?':
 		INFO("?: you are seeing it\n");
 		INFO("S: suspend the usb bus\n");
@@ -759,6 +771,7 @@ static int musb_proc_write(struct file *file, const char __user *buffer,
 		INFO("H: host mode\n");
 		INFO("T: start sending TEST_PACKET\n");
 		INFO("D: set/read dbug level\n");
+		INFO("K/k: enable/disable babble workaround\n");
 		break;
 #endif
 
diff --git a/drivers/usb/musb/ti81xx.c b/drivers/usb/musb/ti81xx.c
index 2e1c550..0c1895a 100644
--- a/drivers/usb/musb/ti81xx.c
+++ b/drivers/usb/musb/ti81xx.c
@@ -856,7 +856,7 @@ static irqreturn_t ti81xx_interrupt(int irq, void *hci)
 	}
 
 	is_babble = is_host_capable() && (musb->int_usb & MUSB_INTR_BABBLE);
-	if (is_babble)
+	if (is_babble && musb->enable_babble_work)
 		musb->int_usb |= MUSB_INTR_DISCONNECT;
 
 	if (usbintr & (USB_INTR_DRVVBUS << USB_INTR_USB_SHIFT)) {
@@ -1068,6 +1068,7 @@ int ti81xx_musb_init(struct musb *musb)
 	/* set musb controller to host mode */
 	musb_platform_set_mode(musb, mode);
 
+	/* enable babble workaround */
 	INIT_WORK(&musb->work, evm_deferred_musb_restart);
 	musb->enable_babble_work = 0;
 
-- 
1.7.5.4

