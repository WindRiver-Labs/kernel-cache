From b22f91ca241df860215ab2c2cb7a3d36efbe86a4 Mon Sep 17 00:00:00 2001
From: "Satyanarayana, Sandhya" <sandhya.satyanarayana@ti.com>
Date: Mon, 18 Jun 2012 17:22:55 +0530
Subject: [PATCH 266/609] ARM: OMAP: AM33XX: Fix bug which incorrectly chooses
 memory type for PM

Original commit: 447d0cf0cddfb6c6258d47ae97883da6c5aa07d4

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

This patch fixes the bug where the memory type was being
derived incorrectly from the SDRAM_CONFIG register.

Because of this, the VTP settings for DDR2 and DDR3
were being incorrectly chosen.
Also, the memory type was always being selected as DDR2
and DDR2 suspend-resume sequence was executing for both
DDR2 and DDR3.

Note:
With this patch suspend-to-RAM fails on EVM-SK rev 1.1.

On AM335x using DDR3, we need to disable VTP in order to
get to a low power state. This patch makes it happen.
Once VTP is disabled, none of the control outputs are driven
by the EMIF/PHY. That is why an external pull-up is needed
on DDR_RESET and a pull down is required on CKE.

On EVM-SK Rev 1.1, the pull down is enabled on CKE, but
it is a weak pull down. This is not enough to overcome the
VTT pull up to 0.75V. Thus, the DDR never properly goes
to self refresh.

On the next revision of the EVM-SK board (rev 1.2),
there is an ability to disable the VTT regulator, and there
is an external pull down on CKE. Thus we should be able to
keep CKE low throughout self-refresh.

Based on a fix suggested by James Doublesin.

Reported-by: James Doublesin <doublesin@ti.com>
Signed-off-by: Satyanarayana, Sandhya <sandhya.satyanarayana@ti.com>
---
 arch/arm/mach-omap2/pm33xx.c           |    2 +-
 arch/arm/plat-omap/include/plat/emif.h |    3 ++-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-omap2/pm33xx.c b/arch/arm/mach-omap2/pm33xx.c
index 46b89d5..fc3f2b8 100644
--- a/arch/arm/mach-omap2/pm33xx.c
+++ b/arch/arm/mach-omap2/pm33xx.c
@@ -500,7 +500,7 @@ static int __init am33xx_pm_init(void)
 /* Read SDRAM_CONFIG register to determine Memory Type */
 	base = am33xx_get_ram_base();
 	reg = readl(base + EMIF4_0_SDRAM_CONFIG);
-	reg &= SDRAM_TYPE ;
+	reg = (reg & SDRAM_TYPE_MASK) >> SDRAM_TYPE_SHIFT;
 	suspend_cfg_param_list[MEMORY_TYPE] = reg;
 
 /*
diff --git a/arch/arm/plat-omap/include/plat/emif.h b/arch/arm/plat-omap/include/plat/emif.h
index 79f2a39..22a1e66 100644
--- a/arch/arm/plat-omap/include/plat/emif.h
+++ b/arch/arm/plat-omap/include/plat/emif.h
@@ -38,5 +38,6 @@
 #define SELF_REFRESH_ENABLE(m)		(0x2 << 8 | (m << 4))
 #define SELF_REFRESH_DISABLE		(0x0 << 8)
 
-#define SDRAM_TYPE			(0xe0000000 >> 29)
+#define SDRAM_TYPE_MASK			0xe0000000
+#define SDRAM_TYPE_SHIFT		29
 #endif /* __EMIF_H */
-- 
1.7.5.4

