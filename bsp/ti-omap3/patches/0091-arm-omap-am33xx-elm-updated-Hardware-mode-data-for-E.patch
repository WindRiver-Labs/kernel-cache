From 6c596cb01ab6f357cb0f0845719e913428f16df3 Mon Sep 17 00:00:00 2001
From: "Philip, Avinash" <avinashphilip@ti.com>
Date: Fri, 10 Aug 2012 11:58:43 +0800
Subject: [PATCH 091/609] arm: omap: am33xx: elm - updated Hardware mode data
 for ELM

Original commit: 5649d6a83056b4c9b7d90ca1c48e115a7dbbfa5f

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

Hardware mode data is updated for ELM module

Signed-off-by: Philip, Avinash <avinashphilip@ti.com>
Signed-off-by: Hebbar, Gururaja <gururaja.hebbar@ti.com>
Signed-off-by: Vaibhav Hiremath <hvaibhav@ti.com>
---
 arch/arm/mach-omap2/devices.c              |   28 +++++++++++++++++++
 arch/arm/mach-omap2/omap_hwmod_33xx_data.c |   40 ++++++++++++++++++++++++++++
 arch/arm/plat-omap/include/plat/am33xx.h   |    2 +
 3 files changed, 70 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-omap2/devices.c b/arch/arm/mach-omap2/devices.c
index 2c9b5d8..aeab6b6 100644
--- a/arch/arm/mach-omap2/devices.c
+++ b/arch/arm/mach-omap2/devices.c
@@ -515,6 +515,33 @@ static void omap_init_mcspi(void)
 static inline void omap_init_mcspi(void) {}
 #endif
 
+#ifdef CONFIG_SOC_OMAPAM33XX
+
+static int omap_elm_init(struct omap_hwmod *oh, void *unused)
+{
+	struct platform_device *pdev;
+	char *name = "omap2_elm";
+	static int elm_num;
+
+
+	elm_num++;
+	pdev = omap_device_build(name, elm_num, oh, NULL,
+				0,	NULL,
+				0, 0);
+	return 0;
+}
+
+static void omap_init_elm(void)
+{
+
+	omap_hwmod_for_each_by_class("elm", omap_elm_init, NULL);
+}
+
+#else
+static void omap_init_elm(void) {}
+#endif
+
+
 static struct resource omap2_pmu_resource = {
 	.start	= 3,
 	.end	= 3,
@@ -1351,6 +1378,7 @@ static int __init omap2_init_devices(void)
 	omap_init_camera();
 	omap_init_mbox();
 	omap_init_mcspi();
+	omap_init_elm();
 	omap_init_pmu();
 	omap_hdq_init();
 	omap_init_sti();
diff --git a/arch/arm/mach-omap2/omap_hwmod_33xx_data.c b/arch/arm/mach-omap2/omap_hwmod_33xx_data.c
index a71729d..5201fce 100644
--- a/arch/arm/mach-omap2/omap_hwmod_33xx_data.c
+++ b/arch/arm/mach-omap2/omap_hwmod_33xx_data.c
@@ -66,6 +66,7 @@ static struct omap_hwmod am33xx_mmc1_hwmod;
 static struct omap_hwmod am33xx_mmc2_hwmod;
 static struct omap_hwmod am33xx_spi0_hwmod;
 static struct omap_hwmod am33xx_spi1_hwmod;
+static struct omap_hwmod am33xx_elm_hwmod;
 
 /*
  * Interconnects hwmod structures
@@ -446,17 +447,56 @@ static struct omap_hwmod am33xx_debugss_hwmod = {
 #endif
 };
 
+static struct omap_hwmod_class_sysconfig am33xx_elm_sysc = {
+	.rev_offs	= 0x0000,
+	.sysc_offs	= 0x0010,
+	.syss_offs	= 0x0014,
+	.sysc_flags	= (SYSC_HAS_CLOCKACTIVITY | SYSC_HAS_SIDLEMODE |
+				SYSC_HAS_SOFTRESET |
+				SYSS_HAS_RESET_STATUS),
+	.idlemodes	= (SIDLE_FORCE | SIDLE_NO | SIDLE_SMART),
+	.sysc_fields	= &omap_hwmod_sysc_type1,
+};
 /* 'elm' class */
 static struct omap_hwmod_class am33xx_elm_hwmod_class = {
 	.name		= "elm",
+	.sysc		= &am33xx_elm_sysc,
+};
+
+static struct omap_hwmod_irq_info am33xx_elm_irqs[] = {
+	{ .irq = AM33XX_IRQ_ELM },
+	{ .irq = -1 }
+};
+
+struct omap_hwmod_addr_space am33xx_elm_addr_space[] = {
+	{
+		.pa_start	= AM33XX_ELM_BASE,
+		.pa_end		= AM33XX_ELM_BASE + SZ_8K - 1,
+		.flags		= ADDR_MAP_ON_INIT | ADDR_TYPE_RT,
+	},
+	{ }
+};
+
+struct omap_hwmod_ocp_if am33xx_l4_core__elm = {
+	.master		= &am33xx_l4per_hwmod,
+	.slave		= &am33xx_elm_hwmod,
+	.addr		= am33xx_elm_addr_space,
+	.user		= OCP_USER_MPU,
+};
+
+static struct omap_hwmod_ocp_if *am33xx_elm_slaves[] = {
+	&am33xx_l4_core__elm,
 };
 
 /* elm */
 static struct omap_hwmod am33xx_elm_hwmod = {
 	.name		= "elm",
 	.class		= &am33xx_elm_hwmod_class,
+	.mpu_irqs       = am33xx_elm_irqs,
 	.main_clk	= "elm_fck",
 	.clkdm_name	= "l4ls_clkdm",
+	.slaves		= am33xx_elm_slaves,
+	.slaves_cnt	= ARRAY_SIZE(am33xx_elm_slaves),
 	.prcm		= {
 		.omap4	= {
 			.clkctrl_offs	= AM33XX_CM_PER_ELM_CLKCTRL_OFFSET,
diff --git a/arch/arm/plat-omap/include/plat/am33xx.h b/arch/arm/plat-omap/include/plat/am33xx.h
index 8891bf2..9b55119 100644
--- a/arch/arm/plat-omap/include/plat/am33xx.h
+++ b/arch/arm/plat-omap/include/plat/am33xx.h
@@ -81,4 +81,6 @@
 #define AM33XX_EPWMSS1_BASE	0x48302000
 #define AM33XX_EPWMSS2_BASE	0x48304000
 
+#define AM33XX_ELM_BASE		0x48080000
+
 #endif /* __ASM_ARCH_AM33XX_H */
-- 
1.7.5.4

