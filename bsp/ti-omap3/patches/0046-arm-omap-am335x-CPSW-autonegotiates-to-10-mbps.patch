From 31d5c1929575dc4fdf00a9224dfcddf8bd5fae0f Mon Sep 17 00:00:00 2001
From: Chandan Nath <chandan.nath@ti.com>
Date: Thu, 9 Aug 2012 21:34:16 +0800
Subject: [PATCH 046/609] arm:omap:am335x: CPSW autonegotiates to 10 mbps

Original commit: 33f41e93ebf0db86e8039cc5c9882264fb1be117

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

This patch is added as an workaround for cpsw in case of beaglebone
board to autonegotiates to 10 mbps speed even if it is connected to
100 mbps link. The reason for this is to overcome hardware issue of
100 mbps speed. However, CPSW works fine for both 10 and 100 mbps
speed in case of am335x evm.

Signed-off-by: Chandan Nath <chandan.nath@ti.com>
Signed-off-by: Vaibhav Hiremath <hvaibhav@ti.com>
---
 arch/arm/mach-omap2/board-am335xevm.c |   17 ++++++++++++++++-
 1 files changed, 16 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-omap2/board-am335xevm.c b/arch/arm/mach-omap2/board-am335xevm.c
index 21f6292..cc42eca 100644
--- a/arch/arm/mach-omap2/board-am335xevm.c
+++ b/arch/arm/mach-omap2/board-am335xevm.c
@@ -27,6 +27,7 @@
 #include <linux/clk.h>
 #include <linux/err.h>
 #include <linux/wl12xx.h>
+#include <linux/ethtool.h>
 
 /* LCD controller is similar to DA850 */
 #include <video/da8xx-fb.h>
@@ -54,6 +55,10 @@
 /* Convert GPIO signal to GPIO pin number */
 #define GPIO_TO_PIN(bank, gpio) (32 * (bank) + (gpio))
 
+/* BBB PHY IDs */
+#define BBB_PHY_ID		0x7c0f1
+#define BBB_PHY_MASK		0xfffffffe
+
 static const struct display_panel disp_panel = {
 	WVGA,
 	32,
@@ -989,7 +994,6 @@ static void mmc0_no_cd_init(int evm_id, int profile)
 	return;
 }
 
-
 /* setup spi0 */
 static void spi0_init(int evm_id, int profile)
 {
@@ -1008,6 +1012,14 @@ static void spi1_init(int evm_id, int profile)
 	return;
 }
 
+static int beaglebone_phy_fixup(struct phy_device *phydev)
+{
+	phydev->supported &= ~(SUPPORTED_100baseT_Half |
+				SUPPORTED_100baseT_Full);
+
+	return 0;
+}
+
 /* Low-Cost EVM */
 static struct evm_dev_cfg low_cost_evm_dev_cfg[] = {
 	{rgmii1_init,	DEV_ON_BASEBOARD, PROFILE_NONE},
@@ -1157,6 +1169,9 @@ static void setup_beaglebone_old(void)
 	am335x_mmc[0].gpio_wp = -EINVAL;
 
 	_configure_device(LOW_COST_EVM, beaglebone_old_dev_cfg, PROFILE_NONE);
+
+	phy_register_fixup_for_uid(BBB_PHY_ID, BBB_PHY_MASK,
+					beaglebone_phy_fixup);
 }
 
 /* BeagleBone after Rev A3 */
-- 
1.7.5.4

