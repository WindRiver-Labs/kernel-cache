From 5948a71af91c9722b53ad5d54fb71612a547273c Mon Sep 17 00:00:00 2001
From: Mugunthan V N <mugunthanvnm@ti.com>
Date: Fri, 25 May 2012 15:41:36 +0530
Subject: [PATCH 249/609] arm: omap2+: am335x: cpsw: add tx clk delay phy fix
 up

Original commit: e1b08eedb60cf482795427b9341f456122773522

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

CPSW RGMII Internal Delay Mode is not supported in all PVT operating points.

This patch disabling the Internal delay in SoC and adds phy fixup to enable
tx clock delay feature in AR8051 phy.

Signed-off-by: Mugunthan V N <mugunthanvnm@ti.com>
---
 arch/arm/mach-omap2/board-am335xevm.c |   23 +++++++++++++++++++++++
 arch/arm/mach-omap2/control.h         |    4 +++-
 2 files changed, 26 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-omap2/board-am335xevm.c b/arch/arm/mach-omap2/board-am335xevm.c
index 7f9316e..bfe1d3f 100644
--- a/arch/arm/mach-omap2/board-am335xevm.c
+++ b/arch/arm/mach-omap2/board-am335xevm.c
@@ -75,6 +75,14 @@
 #define BBB_PHY_ID		0x7c0f1
 #define BBB_PHY_MASK		0xfffffffe
 
+/* AM335X EVM Phy ID and Debug Registers */
+#define AM335X_EVM_PHY_ID		0x4dd074
+#define AM335X_EVM_PHY_MASK		0xfffffffe
+#define AR8051_PHY_DEBUG_ADDR_REG	0x1d
+#define AR8051_PHY_DEBUG_DATA_REG	0x1e
+#define AR8051_DEBUG_RGMII_CLK_DLY_REG	0x5
+#define AR8051_RGMII_TX_CLK_DLY		BIT(8)
+
 static const struct display_panel disp_panel = {
 	WVGA,
 	32,
@@ -1926,6 +1934,15 @@ static struct evm_dev_cfg evm_sk_dev_cfg[] = {
 	{NULL, 0, 0},
 };
 
+static int am33xx_evm_tx_clk_dly_phy_fixup(struct phy_device *phydev)
+{
+	phy_write(phydev, AR8051_PHY_DEBUG_ADDR_REG,
+		  AR8051_DEBUG_RGMII_CLK_DLY_REG);
+	phy_write(phydev, AR8051_PHY_DEBUG_DATA_REG, AR8051_RGMII_TX_CLK_DLY);
+
+	return 0;
+}
+
 static void setup_general_purpose_evm(void)
 {
 	u32 prof_sel = am335x_get_profile_selection();
@@ -1934,6 +1951,9 @@ static void setup_general_purpose_evm(void)
 	_configure_device(GEN_PURP_EVM, gen_purp_evm_dev_cfg, (1L << prof_sel));
 
 	am33xx_cpsw_init(AM33XX_CPSW_MODE_RGMII, NULL, NULL);
+	/* Atheros Tx Clk delay Phy fixup */
+	phy_register_fixup_for_uid(AM335X_EVM_PHY_ID, AM335X_EVM_PHY_MASK,
+				   am33xx_evm_tx_clk_dly_phy_fixup);
 }
 
 static void setup_ind_auto_motor_ctrl_evm(void)
@@ -2000,6 +2020,9 @@ static void setup_starterkit(void)
 	_configure_device(EVM_SK, evm_sk_dev_cfg, PROFILE_NONE);
 
 	am33xx_cpsw_init(AM33XX_CPSW_MODE_RGMII, NULL, NULL);
+	/* Atheros Tx Clk delay Phy fixup */
+	phy_register_fixup_for_uid(AM335X_EVM_PHY_ID, AM335X_EVM_PHY_MASK,
+				   am33xx_evm_tx_clk_dly_phy_fixup);
 }
 
 static void am335x_setup_daughter_board(struct memory_accessor *m, void *c)
diff --git a/arch/arm/mach-omap2/control.h b/arch/arm/mach-omap2/control.h
index e8d59b0..a1ea403 100644
--- a/arch/arm/mach-omap2/control.h
+++ b/arch/arm/mach-omap2/control.h
@@ -369,9 +369,11 @@
  * CONTROL AM33XX GMII_SEL register for MII mode selection
  */
 #define AM33XX_CONTROL_GMII_SEL_OFFSET	0x650
+#define AM33XX_RGMII_DISABLE_INT_DLY	(BIT(4) | BIT(5))
 #define AM33XX_MII_MODE_EN		0x0
 #define AM33XX_RMII_MODE_EN		((1 << 0) | (1 << 2))
-#define AM33XX_RGMII_MODE_EN		((0x2 << 0) | (0x2 << 2))
+#define AM33XX_RGMII_MODE_EN		((0x2 << 0) | (0x2 << 2) | \
+					(AM33XX_RGMII_DISABLE_INT_DLY))
 
 /*
  * CONTROL AM33XX PWMSS_CTRL register to enable time base clock Enable
-- 
1.7.5.4

