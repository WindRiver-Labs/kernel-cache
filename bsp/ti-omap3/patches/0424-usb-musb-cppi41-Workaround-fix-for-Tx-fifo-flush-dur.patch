From 5e39b21d3f5cc35d07393f0ea853faf40aa9ab4d Mon Sep 17 00:00:00 2001
From: Ajay Kumar Gupta <ajay.gupta@ti.com>
Date: Fri, 18 Nov 2011 12:26:02 +0530
Subject: [PATCH 424/609] usb: musb: cppi41: Workaround fix for Tx fifo flush
 during disconnect

Original commit: a866e3278835e0390506033e626455eb1beb77ae

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

Unable to flush musb Tx endpoint fifo during disconnect while i/o
in progress. The workaround is to set only fifoflush bit and clear
other bits in tx-csr register.

Signed-off-by: Ravi B <ravibabu@ti.com>
Signed-off-by: Vaibhav Hiremath <hvaibhav@ti.com>
---
 drivers/usb/musb/musb_host.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/drivers/usb/musb/musb_host.c b/drivers/usb/musb/musb_host.c
index 6a83b91..f14fd8e 100644
--- a/drivers/usb/musb/musb_host.c
+++ b/drivers/usb/musb/musb_host.c
@@ -141,9 +141,11 @@ static void musb_h_tx_flush_fifo(struct musb_hw_ep *ep)
 		if (csr != lastcsr)
 			dev_dbg(musb->controller, "Host TX FIFONOTEMPTY csr: %02x\n", csr);
 		lastcsr = csr;
-		csr |= MUSB_TXCSR_FLUSHFIFO;
+		csr = MUSB_TXCSR_FLUSHFIFO;
 		musb_writew(epio, MUSB_TXCSR, csr);
 		csr = musb_readw(epio, MUSB_TXCSR);
+		if (!(csr & MUSB_TXCSR_FIFONOTEMPTY))
+			break;
 		if (retries-- < 1) {
 			dev_dbg(musb->controller, "Could not flush host TX%d fifo: csr: %04x\n",
 				ep->epnum, csr);
-- 
1.7.5.4

