From 1c505c119cee02a09994186b47280f647e24c2f3 Mon Sep 17 00:00:00 2001
From: "Patil, Rachna" <rachna@ti.com>
Date: Tue, 7 Aug 2012 12:59:08 +0800
Subject: [PATCH 521/609] input: TSC: fix warning related to TSC

Original commit: 3aed4a1e5b10fd18a90b7d55c95a3fd6d9d50e24

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

Remove function in touchscreen did not check for idle state of
the module previously, due to which disable of module failed.
This patch disables all the steps before removal of module from
kernel, which helps the module enter into idle state.

Signed-off-by: Patil, Rachna <rachna@ti.com>
---
 drivers/input/touchscreen/ti_tscadc.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/input/touchscreen/ti_tscadc.c b/drivers/input/touchscreen/ti_tscadc.c
index 7980a74..1652090 100644
--- a/drivers/input/touchscreen/ti_tscadc.c
+++ b/drivers/input/touchscreen/ti_tscadc.c
@@ -434,6 +434,7 @@ static int __devinit tscadc_probe(struct platform_device *pdev)
 	return 0;
 
 err_disable_clk:
+	pm_runtime_put_sync(&pdev->dev);
 	pm_runtime_disable(&pdev->dev);
 err_free_irq:
 	free_irq(ts_dev->irq, ts_dev);
@@ -443,6 +444,7 @@ err_release_mem_region:
 	release_mem_region(res->start, resource_size(res));
 err_free_mem:
 	input_free_device(input_dev);
+	platform_set_drvdata(pdev, NULL);
 	kfree(ts_dev);
 	return err;
 }
@@ -452,6 +454,7 @@ static int __devexit tscadc_remove(struct platform_device *pdev)
 	struct tscadc *ts_dev = platform_get_drvdata(pdev);
 	struct resource *res;
 
+	tscadc_writel(ts_dev, REG_SE, 0x00);
 	free_irq(ts_dev->irq, ts_dev);
 
 	input_unregister_device(ts_dev->input);
@@ -460,6 +463,7 @@ static int __devexit tscadc_remove(struct platform_device *pdev)
 	iounmap(ts_dev->tsc_base);
 	release_mem_region(res->start, resource_size(res));
 
+	pm_runtime_put_sync(&pdev->dev);
 	pm_runtime_disable(&pdev->dev);
 
 	kfree(ts_dev);
-- 
1.7.5.4

