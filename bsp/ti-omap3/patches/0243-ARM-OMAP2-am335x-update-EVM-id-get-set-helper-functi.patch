From 0e8c2b5588a806aa4257b389b47274ce0fd46bdb Mon Sep 17 00:00:00 2001
From: "Hebbar, Gururaja" <gururaja.hebbar@ti.com>
Date: Mon, 13 Aug 2012 11:39:36 +0800
Subject: [PATCH 243/609] ARM: OMAP2+: am335x: update EVM id get/set helper
 functions

Original commit: 93ab9545e4f832d0e5cb63e9435ead152d1ca03d

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

This patch
1. Moves EVM id set/get helper functions to board-am335xevm.c which is
correct place for holding board related code.

2. Moves EVM id setup into a device configuration function
(_configure_device()) so that it happens for all boards. Currently EVM
ID is filled up in the board config function only for few boards.

3. Sets default am33xx_evmid to -EINVAL instead of GP EVM.

4. Renames am33xx_evmid_fillup() to am335x_evm_set_id() to be inline
with the other helper func(). Currently, am33xx_evmid_fillup() sets up
board id type & am335x_evm_get_id() returns board id type.

Signed-off-by: Hebbar, Gururaja <gururaja.hebbar@ti.com>
Signed-off-by: Sekhar Nori <nsekhar@ti.com>
---
 arch/arm/mach-omap2/board-am335xevm.c              |   35 ++++++++++++++++---
 arch/arm/mach-omap2/devices.c                      |   19 -----------
 arch/arm/mach-omap2/include/mach/board-am335xevm.h |    4 +-
 3 files changed, 31 insertions(+), 27 deletions(-)

diff --git a/arch/arm/mach-omap2/board-am335xevm.c b/arch/arm/mach-omap2/board-am335xevm.c
index 13d5caa..8d220ed 100644
--- a/arch/arm/mach-omap2/board-am335xevm.c
+++ b/arch/arm/mach-omap2/board-am335xevm.c
@@ -30,6 +30,7 @@
 #include <linux/platform_device.h>
 #include <linux/clk.h>
 #include <linux/err.h>
+#include <linux/export.h>
 #include <linux/wl12xx.h>
 #include <linux/ethtool.h>
 #include <linux/mfd/tps65910.h>
@@ -300,6 +301,32 @@ static char am335x_mac_addr[EEPROM_NO_OF_MAC_ADDR][ETH_ALEN];
 
 #define AM335X_EEPROM_HEADER		0xEE3355AA
 
+static int am33xx_evmid = -EINVAL;
+
+/*
+* am335x_evm_set_id - set up board evmid
+* @evmid - evm id which needs to be configured
+*
+* This function is called to configure board evm id.
+*/
+void am335x_evm_set_id(unsigned int evmid)
+{
+	am33xx_evmid = evmid;
+	return;
+}
+
+/*
+* am335x_evm_get_id - returns Board Type (EVM/BB/EVM-SK ...)
+*
+* Note:
+*	returns -EINVAL if Board detection hasn't happened yet.
+*/
+int am335x_evm_get_id(void)
+{
+	return am33xx_evmid;
+}
+EXPORT_SYMBOL(am335x_evm_get_id);
+
 /* current profile if exists else PROFILE_0 on error */
 static u32 am335x_get_profile_selection(void)
 {
@@ -767,6 +794,8 @@ static void _configure_device(int evm_id, struct evm_dev_cfg *dev_cfg,
 {
 	int i;
 
+	am335x_evm_set_id(evm_id);
+
 	/*
 	* Only General Purpose & Industrial Auto Motro Control
 	* EVM has profiles. So check if this evm has profile.
@@ -1916,9 +1945,6 @@ static void setup_beaglebone_old(void)
 	phy_register_fixup_for_uid(BBB_PHY_ID, BBB_PHY_MASK,
 					beaglebone_phy_fixup);
 
-	/* Fill up global evmid */
-	am33xx_evmid_fillup(BEAGLE_BONE_OLD);
-
 	am33xx_cpsw_init(AM33XX_CPSW_MODE_RMII, NULL, NULL);
 }
 
@@ -1935,9 +1961,6 @@ static void setup_beaglebone(void)
 	/* TPS65217 regulator has full constraints */
 	regulator_has_full_constraints();
 
-	/* Fill up global evmid */
-	am33xx_evmid_fillup(BEAGLE_BONE_A3);
-
 	am33xx_cpsw_init(AM33XX_CPSW_MODE_MII, NULL, NULL);
 }
 
diff --git a/arch/arm/mach-omap2/devices.c b/arch/arm/mach-omap2/devices.c
index 130fb4f..70e6324 100644
--- a/arch/arm/mach-omap2/devices.c
+++ b/arch/arm/mach-omap2/devices.c
@@ -1292,25 +1292,6 @@ static struct platform_device am33xx_cpsw_device = {
 
 static unsigned char  am33xx_macid0[ETH_ALEN];
 static unsigned char  am33xx_macid1[ETH_ALEN];
-static unsigned int   am33xx_evmid = GEN_PURP_EVM;
-
-/*
-* am33xx_evmid_fillup - set up board evmid
-* @evmid - evm id which needs to be configured
-*
-* This function is called to configure board evm id.
-*/
-void am33xx_evmid_fillup(unsigned int evmid)
-{
-	am33xx_evmid = evmid;
-	return;
-}
-
-unsigned int get_am33xx_evmid(void)
-{
-	return am33xx_evmid;
-}
-EXPORT_SYMBOL(get_am33xx_evmid);
 
 /*
 * am33xx_cpsw_macidfillup - setup mac adrresses
diff --git a/arch/arm/mach-omap2/include/mach/board-am335xevm.h b/arch/arm/mach-omap2/include/mach/board-am335xevm.h
index ba335e8..1f011c8 100644
--- a/arch/arm/mach-omap2/include/mach/board-am335xevm.h
+++ b/arch/arm/mach-omap2/include/mach/board-am335xevm.h
@@ -38,8 +38,8 @@
 #define PROFILE_7		(0x1 << 7)
 #define PROFILE_ALL		0xFF
 
-void am335x_evmid_fillup(unsigned int evmid);
-unsigned int get_am33xx_evmid(void);
+void am335x_evm_set_id(unsigned int evmid);
+int am335x_evm_get_id(void);
 void am335x_cpsw_macidfillup(char *eeprommacid0, char *eeprommacid1);
 void am33xx_d_can_init(unsigned int instance);
 
-- 
1.7.5.4

