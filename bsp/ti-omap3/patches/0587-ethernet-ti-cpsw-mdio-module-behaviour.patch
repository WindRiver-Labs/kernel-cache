From a273e50b678957ca7617bd15d8ac22345ee3d251 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Fri, 31 Aug 2012 22:11:49 +0800
Subject: [PATCH 587/609] ethernet: ti: cpsw mdio module behaviour

Change into the standard platform for module stuffs.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/ti/cpsw.c         |   28 ++++++----------------------
 drivers/net/ethernet/ti/davinci_mdio.c |   28 +++++++---------------------
 2 files changed, 13 insertions(+), 43 deletions(-)

diff --git a/drivers/net/ethernet/ti/cpsw.c b/drivers/net/ethernet/ti/cpsw.c
index 965a07f..2bc2d3f 100644
--- a/drivers/net/ethernet/ti/cpsw.c
+++ b/drivers/net/ethernet/ti/cpsw.c
@@ -2535,9 +2535,8 @@ static inline void cpsw_stop_slaves_interface(struct net_device *ndev)
 
 #endif
 
-static int cpsw_suspend(struct device *dev)
+static int cpsw_suspend(struct platform_device *pdev, pm_message_t state)
 {
-	struct platform_device	*pdev = to_platform_device(dev);
 	struct net_device	*ndev = platform_get_drvdata(pdev);
 
 	cpsw_stop_slaves_interface(ndev);
@@ -2546,9 +2545,8 @@ static int cpsw_suspend(struct device *dev)
 	return 0;
 }
 
-static int cpsw_resume(struct device *dev)
+static int cpsw_resume(struct platform_device *pdev)
 {
-	struct platform_device	*pdev = to_platform_device(dev);
 	struct net_device	*ndev = platform_get_drvdata(pdev);
 
 	pm_runtime_get_sync(&pdev->dev);
@@ -2557,32 +2555,18 @@ static int cpsw_resume(struct device *dev)
 	return 0;
 }
 
-static const struct dev_pm_ops cpsw_pm_ops = {
-	.suspend	= cpsw_suspend,
-	.resume		= cpsw_resume,
-};
-
 static struct platform_driver cpsw_driver = {
 	.driver = {
 		.name	 = "cpsw",
 		.owner	 = THIS_MODULE,
-		.pm	 = &cpsw_pm_ops,
 	},
+	.suspend	= cpsw_suspend,
+	.resume		= cpsw_resume,
 	.probe = cpsw_probe,
-	.remove = __devexit_p(cpsw_remove),
+	.remove = __exit_p(cpsw_remove),
 };
 
-static int __init cpsw_init(void)
-{
-	return platform_driver_register(&cpsw_driver);
-}
-late_initcall(cpsw_init);
-
-static void __exit cpsw_exit(void)
-{
-	platform_driver_unregister(&cpsw_driver);
-}
-module_exit(cpsw_exit);
+module_platform_driver(cpsw_driver);
 
 MODULE_LICENSE("GPL");
 MODULE_AUTHOR("Cyril Chemparathy <cyril@ti.com>");
diff --git a/drivers/net/ethernet/ti/davinci_mdio.c b/drivers/net/ethernet/ti/davinci_mdio.c
index 53c89c2..b5d9fae 100644
--- a/drivers/net/ethernet/ti/davinci_mdio.c
+++ b/drivers/net/ethernet/ti/davinci_mdio.c
@@ -412,9 +412,9 @@ static int __devexit davinci_mdio_remove(struct platform_device *pdev)
 	return 0;
 }
 
-static int davinci_mdio_suspend(struct device *dev)
+static int davinci_mdio_suspend(struct platform_device *pdev, pm_message_t state)
 {
-	struct davinci_mdio_data *data = dev_get_drvdata(dev);
+	struct davinci_mdio_data *data = platform_get_drvdata(pdev);
 	u32 ctrl;
 
 	spin_lock(&data->lock);
@@ -460,9 +460,9 @@ iounmap_ret:
 	return 0;
 }
 
-static int davinci_mdio_resume(struct device *dev)
+static int davinci_mdio_resume(struct platform_device *pdev)
 {
-	struct davinci_mdio_data *data = dev_get_drvdata(dev);
+	struct davinci_mdio_data *data = platform_get_drvdata(pdev);
 	u32 ctrl;
 
 	spin_lock(&data->lock);
@@ -482,32 +482,18 @@ static int davinci_mdio_resume(struct device *dev)
 	return 0;
 }
 
-static const struct dev_pm_ops davinci_mdio_pm_ops = {
-	.suspend	= davinci_mdio_suspend,
-	.resume		= davinci_mdio_resume,
-};
-
 static struct platform_driver davinci_mdio_driver = {
 	.driver = {
 		.name	 = "davinci_mdio",
 		.owner	 = THIS_MODULE,
-		.pm	 = &davinci_mdio_pm_ops,
 	},
+	.suspend	= davinci_mdio_suspend,
+	.resume		= davinci_mdio_resume,
 	.probe = davinci_mdio_probe,
 	.remove = __devexit_p(davinci_mdio_remove),
 };
 
-static int __init davinci_mdio_init(void)
-{
-	return platform_driver_register(&davinci_mdio_driver);
-}
-device_initcall(davinci_mdio_init);
-
-static void __exit davinci_mdio_exit(void)
-{
-	platform_driver_unregister(&davinci_mdio_driver);
-}
-module_exit(davinci_mdio_exit);
+module_platform_driver(davinci_mdio_driver);
 
 MODULE_LICENSE("GPL");
 MODULE_DESCRIPTION("DaVinci MDIO driver");
-- 
1.7.5.4

