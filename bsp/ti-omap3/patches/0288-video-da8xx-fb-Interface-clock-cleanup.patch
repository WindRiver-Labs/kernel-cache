From f25e8b917403b0106a2188761307e402ec69340f Mon Sep 17 00:00:00 2001
From: "Manjunathappa, Prakash" <prakash.pm@ti.com>
Date: Tue, 10 Jan 2012 16:33:56 +0530
Subject: [PATCH 288/609] video: da8xx-fb: Interface clock cleanup

Original commit: e78558a980b201ddc69a1379e8bea8e60ec2c135

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

Patch does interface clock cleanup in driver suspend and remove
callbacks.

Signed-off-by: Manjunathappa, Prakash <prakash.pm@ti.com>
---
 drivers/video/da8xx-fb.c |    9 ++++++++-
 1 files changed, 8 insertions(+), 1 deletions(-)

diff --git a/drivers/video/da8xx-fb.c b/drivers/video/da8xx-fb.c
index 0931fe3..db01bc2 100644
--- a/drivers/video/da8xx-fb.c
+++ b/drivers/video/da8xx-fb.c
@@ -134,6 +134,7 @@ static resource_size_t da8xx_fb_reg_base;
 static struct resource *lcdc_regs;
 static unsigned int lcd_revision;
 static irq_handler_t lcdc_irq_handler;
+struct clk *lcdc_ick;
 
 static inline unsigned int lcdc_read(unsigned int addr)
 {
@@ -1036,6 +1037,8 @@ static int __devexit fb_remove(struct platform_device *dev)
 		free_irq(par->irq, par);
 		clk_disable(par->lcdc_clk);
 		clk_put(par->lcdc_clk);
+		clk_disable(lcdc_ick);
+		clk_put(lcdc_ick);
 		framebuffer_release(info);
 		iounmap((void __iomem *)da8xx_fb_reg_base);
 		release_mem_region(lcdc_regs->start, resource_size(lcdc_regs));
@@ -1223,7 +1226,6 @@ static int __devinit fb_probe(struct platform_device *device)
 	struct da8xx_panel *lcdc_info;
 	struct fb_info *da8xx_fb_info;
 	struct clk *fb_clk = NULL;
-	struct clk *lcdc_ick = NULL;
 	struct da8xx_fb_par *par;
 	resource_size_t len;
 	int ret, i;
@@ -1482,6 +1484,9 @@ err_clk_put:
 	clk_put(fb_clk);
 
 err_ioremap:
+	clk_disable(lcdc_ick);
+	clk_put(lcdc_ick);
+
 	iounmap((void __iomem *)da8xx_fb_reg_base);
 
 err_request_mem:
@@ -1525,6 +1530,7 @@ static int fb_suspend(struct platform_device *dev, pm_message_t state)
 	}
 
 	clk_disable(par->lcdc_clk);
+	clk_disable(lcdc_ick);
 	console_unlock();
 
 	return 0;
@@ -1538,6 +1544,7 @@ static int fb_resume(struct platform_device *dev)
 	if (par->panel_power_ctrl)
 		par->panel_power_ctrl(1);
 
+	clk_enable(lcdc_ick);
 	clk_enable(par->lcdc_clk);
 
 	lcd_enable_raster();
-- 
1.7.5.4

