From ee5c4a2af52742e9eef9cb680de46c4cf0a5c9e1 Mon Sep 17 00:00:00 2001
From: Mugunthan V N <mugunthanvnm@ti.com>
Date: Tue, 7 Aug 2012 14:27:26 +0800
Subject: [PATCH 322/609] ethernet: cpsw: dual emac remove module kernel crash
 bug fix

Original commit: 541cac1861095eabcbdb3daeb54dc5dbfcd84dbe

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

In dual emac, while removing the ti_cpsw module leads to kernel crash as the
second network interface created is not unregistered and freed. Adding support
to unregister and free the second network interface.

Do not set the second network interface to platform driver data as there is no
separate device for second network interface, so that in cpsw_remove() the
platform device received corresponds to the first network interface all the
time.

Signed-off-by: Mugunthan V N <mugunthanvnm@ti.com>
---
 drivers/net/ethernet/ti/cpsw.c |   11 ++++++++++-
 1 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/ti/cpsw.c b/drivers/net/ethernet/ti/cpsw.c
index 55ecfe4..c0cb4d1 100644
--- a/drivers/net/ethernet/ti/cpsw.c
+++ b/drivers/net/ethernet/ti/cpsw.c
@@ -2109,7 +2109,6 @@ static int cpsw_init_slave_emac(struct platform_device *pdev,
 		return -ENOMEM;
 	}
 
-	platform_set_drvdata(pdev, ndev);
 	priv_sl2 = netdev_priv(ndev);
 	spin_lock_init(&priv_sl2->lock);
 	priv_sl2->data = *data;
@@ -2176,8 +2175,17 @@ static int cpsw_init_slave_emac(struct platform_device *pdev,
 	return ret;
 }
 
+static inline void cpsw_deinit_slave_emac(struct cpsw_priv *priv)
+{
+	struct net_device *ndev = priv->slaves[1].ndev;
+
+	unregister_netdev(ndev);
+	free_netdev(ndev);
+}
+
 #else
 #define cpsw_init_slave_emac(pdev, priv)	0
+#define cpsw_deinit_slave_emac(priv)
 #endif
 
 static int __devinit cpsw_probe(struct platform_device *pdev)
@@ -2470,6 +2478,7 @@ static int __devexit cpsw_remove(struct platform_device *pdev)
 	pr_info("removing device");
 	platform_set_drvdata(pdev, NULL);
 
+	cpsw_deinit_slave_emac(priv);
 	omap_dm_timer_free(dmtimer_rx);
 	omap_dm_timer_free(dmtimer_tx);
 
-- 
1.7.5.4

