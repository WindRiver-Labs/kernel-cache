From 486575a9fb88ea7b43ba5d56e03d24efebd02426 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Mon, 12 Nov 2012 05:13:50 +0800
Subject: [PATCH 610/612] ethernet: cpsw: fix dmtimer set no proper with sync

The following commit will disable dmtimer with sync:
  commit 8c17041815762b385631d3a680128dca5a9be31b
  ARM: OMAP2+: Fix dmtimer set source clock failure

dmtimer_rx/tx CAPTURE will be expired after disable with
sync, so they are not started for CPSW, then boot will be
halted. And I found it is not necessary to enable/disable
back and forth, so remove them, and just enable it
at first.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/plat-omap/dmtimer.c   |    4 ----
 drivers/net/ethernet/ti/cpsw.c |    4 ++--
 2 files changed, 2 insertions(+), 6 deletions(-)

diff --git a/arch/arm/plat-omap/dmtimer.c b/arch/arm/plat-omap/dmtimer.c
index de3747c..88752b2 100644
--- a/arch/arm/plat-omap/dmtimer.c
+++ b/arch/arm/plat-omap/dmtimer.c
@@ -514,7 +514,6 @@ int omap_dm_timer_set_capture(struct omap_dm_timer *timer, bool lht,
 	if (unlikely(!timer))
 		return -EINVAL;
 
-	omap_dm_timer_enable(timer);
 	l = omap_dm_timer_read_reg(timer, OMAP_TIMER_CTRL_REG);
 
 	if (lht && hlt)
@@ -535,7 +534,6 @@ int omap_dm_timer_set_capture(struct omap_dm_timer *timer, bool lht,
 
 	/* Save the context */
 	timer->context.tclr = l;
-	omap_dm_timer_disable(timer);
 	return 0;
 }
 EXPORT_SYMBOL_GPL(omap_dm_timer_set_capture);
@@ -569,13 +567,11 @@ int omap_dm_timer_set_int_enable(struct omap_dm_timer *timer,
 	if (unlikely(!timer))
 		return -EINVAL;
 
-	omap_dm_timer_enable(timer);
 	__omap_dm_timer_int_enable(timer, value);
 
 	/* Save the context */
 	timer->context.tier = value;
 	timer->context.twer = value;
-	omap_dm_timer_disable(timer);
 	return 0;
 }
 EXPORT_SYMBOL_GPL(omap_dm_timer_set_int_enable);
diff --git a/drivers/net/ethernet/ti/cpsw.c b/drivers/net/ethernet/ti/cpsw.c
index ce4265d..ee87b0c 100644
--- a/drivers/net/ethernet/ti/cpsw.c
+++ b/drivers/net/ethernet/ti/cpsw.c
@@ -943,14 +943,14 @@ static int cpsw_ndo_open(struct net_device *ndev)
 	}
 
 	/* Enable Timer for capturing cpsw rx interrupts */
+	omap_dm_timer_enable(dmtimer_rx);
 	omap_dm_timer_set_int_enable(dmtimer_rx, OMAP_TIMER_INT_CAPTURE);
 	omap_dm_timer_set_capture(dmtimer_rx, 1, 0, 0);
-	omap_dm_timer_enable(dmtimer_rx);
 
 	/* Enable Timer for capturing cpsw tx interrupts */
+	omap_dm_timer_enable(dmtimer_tx);
 	omap_dm_timer_set_int_enable(dmtimer_tx, OMAP_TIMER_INT_CAPTURE);
 	omap_dm_timer_set_capture(dmtimer_tx, 1, 0, 0);
-	omap_dm_timer_enable(dmtimer_tx);
 
 	cpdma_ctlr_start(priv->dma);
 	cpsw_intr_enable(priv);
-- 
1.7.3.5

