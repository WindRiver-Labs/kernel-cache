From 92fbb1a26b1b7c1ab059c4aa56c6b589d717da52 Mon Sep 17 00:00:00 2001
From: "Manjunathappa, Prakash" <prakash.pm@ti.com>
Date: Fri, 29 Jun 2012 11:27:55 +0800
Subject: [PATCH 280/609] video: enable DA8XX LCDC on AM335X

Original commit: 20c31f51b37173a49f1045bc13e039ff7c775260

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

Adding pinmux, platform resource information. Also add
AM335X panel inforamtion.

Signed-off-by: Manjunathappa, Prakash <prakash.pm@ti.com>
Signed-off-by: Vaibhav Hiremath <hvaibhav@ti.com>
---
 drivers/video/Kconfig    |    2 +-
 drivers/video/da8xx-fb.c |   32 +++++++++++++++++++++++++++++++-
 include/video/da8xx-fb.h |    5 +++--
 3 files changed, 35 insertions(+), 4 deletions(-)

diff --git a/drivers/video/Kconfig b/drivers/video/Kconfig
index 24f70a0..9db4a15 100644
--- a/drivers/video/Kconfig
+++ b/drivers/video/Kconfig
@@ -2281,7 +2281,7 @@ config FB_SH7760
 
 config FB_DA8XX
 	tristate "DA8xx/OMAP-L1xx Framebuffer support"
-	depends on FB && ARCH_DAVINCI_DA8XX
+	depends on FB && (ARCH_DAVINCI_DA8XX || SOC_AM33XX)
 	select FB_CFB_FILLRECT
 	select FB_CFB_COPYAREA
 	select FB_CFB_IMAGEBLIT
diff --git a/drivers/video/da8xx-fb.c b/drivers/video/da8xx-fb.c
index c1e7522..a1b4571 100644
--- a/drivers/video/da8xx-fb.c
+++ b/drivers/video/da8xx-fb.c
@@ -255,6 +255,20 @@ static struct da8xx_panel known_lcd_panels[] = {
 		.pxl_clk = 7833600,
 		.invert_pxl_clk = 0,
 	},
+	/* ThreeFive S9700RTWV35TR */
+	[2] = {
+		.name = "TFC_S9700RTWV35TR_01B",
+		.width = 800,
+		.height = 480,
+		.hfp = 39,
+		.hbp = 39,
+		.hsw = 47,
+		.vfp = 13,
+		.vbp = 29,
+		.vsw = 2,
+		.pxl_clk = 30000000,
+		.invert_pxl_clk = 0,
+	},
 };
 
 /* Enable the Raster Engine of the LCD Controller */
@@ -715,7 +729,9 @@ static int lcd_init(struct da8xx_fb_par *par, const struct lcd_ctrl_config *cfg,
 	if (ret < 0)
 		return ret;
 
-	if (QVGA != cfg->p_disp_panel->panel_type)
+
+	if ((QVGA != cfg->p_disp_panel->panel_type) &&
+			(WVGA != cfg->p_disp_panel->panel_type))
 		return -EINVAL;
 
 	if (cfg->bpp <= cfg->p_disp_panel->max_bpp &&
@@ -1157,6 +1173,7 @@ static int __devinit fb_probe(struct platform_device *device)
 	struct da8xx_panel *lcdc_info;
 	struct fb_info *da8xx_fb_info;
 	struct clk *fb_clk = NULL;
+	struct clk *lcdc_ick = NULL;
 	struct da8xx_fb_par *par;
 	resource_size_t len;
 	int ret, i;
@@ -1185,6 +1202,18 @@ static int __devinit fb_probe(struct platform_device *device)
 		goto err_request_mem;
 	}
 
+	/*
+	 * Some SoC will not have seperate interface clock,
+	 * so make lazy check here
+	 */
+	lcdc_ick = clk_get(&device->dev, "lcdc_ick");
+	if (IS_ERR(lcdc_ick))
+		dev_err(&device->dev, "Can not get lcdc_ick\n");
+
+	ret = clk_enable(lcdc_ick);
+	if (ret)
+		dev_err(&device->dev, "failed to enable lcdc_ick\n");
+
 	fb_clk = clk_get(&device->dev, NULL);
 	if (IS_ERR(fb_clk)) {
 		dev_err(&device->dev, "Can not get device clock\n");
@@ -1201,6 +1230,7 @@ static int __devinit fb_probe(struct platform_device *device)
 		lcd_revision = LCD_VERSION_1;
 		break;
 	case 0x4F200800:
+	case 0x4F201000:
 		lcd_revision = LCD_VERSION_2;
 		break;
 	default:
diff --git a/include/video/da8xx-fb.h b/include/video/da8xx-fb.h
index 89d43b3..f96f570 100644
--- a/include/video/da8xx-fb.h
+++ b/include/video/da8xx-fb.h
@@ -13,7 +13,8 @@
 #define DA8XX_FB_H
 
 enum panel_type {
-	QVGA = 0
+	QVGA = 0,
+	WVGA,
 };
 
 enum panel_shade {
@@ -28,7 +29,7 @@ enum raster_load_mode {
 };
 
 struct display_panel {
-	enum panel_type panel_type; /* QVGA */
+	enum panel_type panel_type;
 	int max_bpp;
 	int min_bpp;
 	enum panel_shade panel_shade;
-- 
1.7.5.4

