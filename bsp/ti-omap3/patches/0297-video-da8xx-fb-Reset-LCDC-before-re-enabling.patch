From 2b1a39a948d068b669ed364735a2fe23cc161cb9 Mon Sep 17 00:00:00 2001
From: "Manjunathappa, Prakash" <prakash.pm@ti.com>
Date: Fri, 16 Mar 2012 11:21:00 +0530
Subject: [PATCH 297/609] video: da8xx-fb: Reset LCDC before re-enabling

Original commit: 646a1fc5ea44f504609941e8145894ecf66cab33

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

"08657ec video: da8xx-fb: correct suspend/resume sequence"
moved reset	out of raster enable. For proper LCDC enable,
reset also has to be done. Reintroduce reset in raster enable.

Without this raster enable will not guarantee proper
enabling of LCDC (like in the case of blank/unblank).

Signed-off-by: Manjunathappa, Prakash <prakash.pm@ti.com>
---
 drivers/video/da8xx-fb.c |   20 +++++++++++---------
 1 files changed, 11 insertions(+), 9 deletions(-)

diff --git a/drivers/video/da8xx-fb.c b/drivers/video/da8xx-fb.c
index fe5a8c2..7aca603 100644
--- a/drivers/video/da8xx-fb.c
+++ b/drivers/video/da8xx-fb.c
@@ -284,10 +284,19 @@ static inline void lcd_enable_raster(void)
 {
 	u32 reg;
 
+	/* Put LCDC in reset for several cycles */
+	if (lcd_revision == LCD_VERSION_2)
+		lcdc_write(LCD_CLK_MAIN_RESET, LCD_CLK_RESET_REG);
+
+	mdelay(1);
+
 	/* Bring LCDC out of reset */
 	if (lcd_revision == LCD_VERSION_2)
 		lcdc_write(0, LCD_CLK_RESET_REG);
 
+	mdelay(1);
+
+	/* Above reset sequence doesnot reset register context */
 	reg = lcdc_read(LCD_RASTER_CTRL_REG);
 	if (!(reg & LCD_RASTER_ENABLE))
 		lcdc_write(reg | LCD_RASTER_ENABLE, LCD_RASTER_CTRL_REG);
@@ -1539,8 +1548,7 @@ static void lcd_context_save(void)
 		lcdc_read(LCD_DMA_FRM_BUF_BASE_ADDR_1_REG);
 	reg_context.dma_frm_buf_ceiling_addr_1 =
 		lcdc_read(LCD_DMA_FRM_BUF_CEILING_ADDR_1_REG);
-	reg_context.raster_ctrl = lcdc_read(LCD_RASTER_CTRL_REG) &
-		~LCD_RASTER_ENABLE;
+	reg_context.raster_ctrl = lcdc_read(LCD_RASTER_CTRL_REG);
 	return;
 }
 
@@ -1575,9 +1583,8 @@ static int fb_suspend(struct platform_device *dev, pm_message_t state)
 		par->panel_power_ctrl(0);
 
 	fb_set_suspend(info, 1);
-	lcd_context_save();
 	lcd_disable_raster(WAIT_FOR_FRAME_DONE);
-	msleep(10);
+	lcd_context_save();
 
 	pm_runtime_put(&dev->dev);
 	console_unlock();
@@ -1594,11 +1601,6 @@ static int fb_resume(struct platform_device *dev)
 	pm_runtime_get_sync(&dev->dev);
 
 	msleep(1);
-	lcdc_write(LCD_CLK_MAIN_RESET, LCD_CLK_RESET_REG);
-	msleep(10);
-	lcdc_write(0, LCD_CLK_RESET_REG);
-	msleep(1);
-
 	lcd_context_restore();
 	lcd_enable_raster();
 
-- 
1.7.5.4

