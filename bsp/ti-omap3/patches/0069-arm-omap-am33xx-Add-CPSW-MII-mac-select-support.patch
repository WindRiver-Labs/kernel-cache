From f8ebc819bc8bc0e4014381f539dc2b150011c081 Mon Sep 17 00:00:00 2001
From: Chandan Nath <chandan.nath@ti.com>
Date: Fri, 10 Aug 2012 09:45:50 +0800
Subject: [PATCH 069/609] arm: omap: am33xx: Add CPSW MII mac select support

Original commit: 06b2d14954e0d9332490413cb9fb377b1c988480

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

This patch fixes missing configuration for MII interface
configuration in device control register. MII mode selection
should be done depending up on the board/phy type.
This was missing in linux, however without this also it was
working as it was configured in uboot. This is required in
linux also in order to remove any dependency on uboot.

Signed-off-by: Chandan Nath <chandan.nath@ti.com>
---
 arch/arm/mach-omap2/board-am335xevm.c              |    6 ++++++
 arch/arm/mach-omap2/devices.c                      |   19 +++++++++++++++++++
 arch/arm/mach-omap2/include/mach/board-am335xevm.h |    4 +++-
 3 files changed, 28 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-omap2/board-am335xevm.c b/arch/arm/mach-omap2/board-am335xevm.c
index fc5a9bb..2dcc845 100644
--- a/arch/arm/mach-omap2/board-am335xevm.c
+++ b/arch/arm/mach-omap2/board-am335xevm.c
@@ -1377,6 +1377,9 @@ static void setup_beaglebone_old(void)
 
 	phy_register_fixup_for_uid(BBB_PHY_ID, BBB_PHY_MASK,
 					beaglebone_phy_fixup);
+
+	/* Fill up global evmid */
+	am33xx_evmid_fillup(BEAGLE_BONE_OLD);
 }
 
 /* BeagleBone after Rev A3 */
@@ -1388,6 +1391,9 @@ static void setup_beaglebone(void)
 	am335x_mmc[0].gpio_wp = -EINVAL;
 
 	_configure_device(LOW_COST_EVM, beaglebone_dev_cfg, PROFILE_NONE);
+
+	/* Fill up global evmid */
+	am33xx_evmid_fillup(BEAGLE_BONE_A3);
 }
 
 static void profibus_init(int evm_id, int profile)
diff --git a/arch/arm/mach-omap2/devices.c b/arch/arm/mach-omap2/devices.c
index bd91857..80fa3b7 100644
--- a/arch/arm/mach-omap2/devices.c
+++ b/arch/arm/mach-omap2/devices.c
@@ -1285,6 +1285,11 @@ void am33xx_cpsw_macidfillup(char *eeprommacid0, char *eeprommacid1)
 	return;
 }
 
+#define MII_MODE_ENABLE		0x0
+#define RMII_MODE_ENABLE	0x5
+#define RGMII_MODE_ENABLE	0xA
+#define MAC_MII_SEL		0x650
+
 void am33xx_cpsw_init(void)
 {
 	u32 mac_lo, mac_hi;
@@ -1320,6 +1325,20 @@ void am33xx_cpsw_init(void)
 			am33xx_cpsw_slaves[1].mac_addr[i] = am33xx_macid1[i];
 	}
 
+	if (am33xx_evmid == BEAGLE_BONE_OLD) {
+		__raw_writel(RMII_MODE_ENABLE,
+				AM33XX_CTRL_REGADDR(MAC_MII_SEL));
+	} else if (am33xx_evmid == BEAGLE_BONE_A3) {
+		__raw_writel(MII_MODE_ENABLE,
+				AM33XX_CTRL_REGADDR(MAC_MII_SEL));
+	} else if (am33xx_evmid == IND_AUT_MTR_EVM) {
+		am33xx_cpsw_slaves[0].phy_id = "0:1e";
+		am33xx_cpsw_slaves[1].phy_id = "0:00";
+	} else {
+		__raw_writel(RGMII_MODE_ENABLE,
+				AM33XX_CTRL_REGADDR(MAC_MII_SEL));
+	}
+
 	memcpy(am33xx_cpsw_pdata.mac_addr,
 			am33xx_cpsw_slaves[0].mac_addr, ETH_ALEN);
 	platform_device_register(&am33xx_cpsw_mdiodevice);
diff --git a/arch/arm/mach-omap2/include/mach/board-am335xevm.h b/arch/arm/mach-omap2/include/mach/board-am335xevm.h
index 630d0d0..cdea864 100644
--- a/arch/arm/mach-omap2/include/mach/board-am335xevm.h
+++ b/arch/arm/mach-omap2/include/mach/board-am335xevm.h
@@ -23,7 +23,9 @@
 #define LOW_COST_EVM		0
 #define GEN_PURP_EVM		1
 #define IND_AUT_MTR_EVM		2
-#define IP_PHN_EVM			3
+#define IP_PHN_EVM		3
+#define BEAGLE_BONE_OLD		4
+#define BEAGLE_BONE_A3		5
 
 /* REVIST : check posibility of PROFILE_(x) syntax usage */
 #define PROFILE_NONE	-1	/* Few EVM doesn't have profiles */
-- 
1.7.5.4

