From 9718052ceda038a5138ed1423ddef7e7a6da8a25 Mon Sep 17 00:00:00 2001
From: Goutam Kumar <goutam.kumar@ti.com>
Date: Wed, 28 Sep 2011 14:17:51 +0530
Subject: [PATCH 050/609] arm: omap: am335xevm: Volume Keys Support Added.

Original commit: 081cc1da9de1999395e237d97a96c22e3b3d9c4e

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

  1. GPIO Keys Support Enabled for volume up/down push bottons.
  2. Correction in Matrix Keypad for DB boot mode.

Signed-off-by: Goutam Kumar <goutam.kumar@ti.com>
Signed-off-by: Hebbar, Gururaja <gururaja.hebbar@ti.com>
Signed-off-by: Vaibhav Hiremath <hvaibhav@ti.com>
---
 arch/arm/mach-omap2/board-am335xevm.c |   53 +++++++++++++++++++++++++++++++++
 arch/arm/mach-omap2/mux33xx.c         |    4 +-
 2 files changed, 55 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-omap2/board-am335xevm.c b/arch/arm/mach-omap2/board-am335xevm.c
index e05c8d3..d19e271 100644
--- a/arch/arm/mach-omap2/board-am335xevm.c
+++ b/arch/arm/mach-omap2/board-am335xevm.c
@@ -20,6 +20,7 @@
 #include <linux/gpio.h>
 #include <linux/spi/spi.h>
 #include <linux/spi/flash.h>
+#include <linux/gpio_keys.h>
 #include <linux/input.h>
 #include <linux/input/matrix_keypad.h>
 #include <linux/mtd/mtd.h>
@@ -605,6 +606,57 @@ static void matrix_keypad_init(int evm_id, int profile)
 	}
 }
 
+
+/* pinmux for keypad device */
+static struct pinmux_config volume_keys_pin_mux[] = {
+	{"spi0_sclk.gpio0_2",  OMAP_MUX_MODE7 | AM33XX_PIN_INPUT},
+	{"spi0_d0.gpio0_3",    OMAP_MUX_MODE7 | AM33XX_PIN_INPUT},
+	{NULL, 0},
+};
+
+/* Configure GPIOs for Volume Keys */
+static struct gpio_keys_button am335x_evm_volume_gpio_buttons[] = {
+	{
+		.code                   = KEY_VOLUMEUP,
+		.gpio                   = GPIO_TO_PIN(0, 2),
+		.active_low             = true,
+		.desc                   = "volume-up",
+		.type                   = EV_KEY,
+		.wakeup                 = 1,
+	},
+	{
+		.code                   = KEY_VOLUMEDOWN,
+		.gpio                   = GPIO_TO_PIN(0, 3),
+		.active_low             = true,
+		.desc                   = "volume-down",
+		.type                   = EV_KEY,
+		.wakeup                 = 1,
+	},
+};
+
+static struct gpio_keys_platform_data am335x_evm_volume_gpio_key_info = {
+	.buttons        = am335x_evm_volume_gpio_buttons,
+	.nbuttons       = ARRAY_SIZE(am335x_evm_volume_gpio_buttons),
+};
+
+static struct platform_device am335x_evm_volume_keys = {
+	.name   = "gpio-keys",
+	.id     = -1,
+	.dev    = {
+		.platform_data  = &am335x_evm_volume_gpio_key_info,
+	},
+};
+
+static void volume_keys_init(int evm_id, int profile)
+{
+	int err;
+
+	setup_pin_mux(volume_keys_pin_mux);
+	err = platform_device_register(&am335x_evm_volume_keys);
+	if (err)
+		pr_err("failed to register matrix keypad (2x3) device\n");
+}
+
 /*
 * @evm_id - evm id which needs to be configured
 * @dev_cfg - single evm structure which includes
@@ -1156,6 +1208,7 @@ static struct evm_dev_cfg gen_purp_evm_dev_cfg[] = {
 	{wl12xx_init,	DEV_ON_BASEBOARD, (PROFILE_0 | PROFILE_3 | PROFILE_5)},
 	{d_can_init,	DEV_ON_DGHTR_BRD, PROFILE_1},
 	{matrix_keypad_init, DEV_ON_DGHTR_BRD, PROFILE_0},
+	{volume_keys_init,  DEV_ON_DGHTR_BRD, PROFILE_0},
 	{NULL, 0, 0},
 };
 
diff --git a/arch/arm/mach-omap2/mux33xx.c b/arch/arm/mach-omap2/mux33xx.c
index ec726bf..08d9ae6 100644
--- a/arch/arm/mach-omap2/mux33xx.c
+++ b/arch/arm/mach-omap2/mux33xx.c
@@ -286,10 +286,10 @@ static struct omap_mux __initdata am33xx_muxmodes[] = {
 		"mmc0_sdwp", "mmc1_clk", "mmc2_clk", NULL),
 	_AM33XX_MUXENTRY(SPI0_SCLK, 0,
 		"spi0_sclk", NULL, NULL, NULL,
-		NULL, NULL, NULL, NULL),
+		NULL, NULL, NULL, "gpio0_2"),
 	_AM33XX_MUXENTRY(SPI0_D0, 0,
 		"spi0_d0", NULL, NULL, NULL,
-		NULL, NULL, NULL, NULL),
+		NULL, NULL, NULL, "gpio0_3"),
 	_AM33XX_MUXENTRY(SPI0_D1, 0,
 		"spi0_d1", "mmc1_sdwp", "i2c1_sda", NULL,
 		NULL, NULL, NULL, NULL),
-- 
1.7.5.4

