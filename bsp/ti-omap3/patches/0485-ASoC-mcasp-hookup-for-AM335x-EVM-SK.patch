From 11cfed90632aa3901a6ee5c528bd49cfd0cf9865 Mon Sep 17 00:00:00 2001
From: "Hebbar, Gururaja" <gururaja.hebbar@ti.com>
Date: Mon, 11 Jun 2012 14:34:52 +0530
Subject: [PATCH 485/609] ASoC: mcasp: hookup for AM335x EVM-SK

Original commit: 5ecde319c11a334142eef9b0deba30d56d5ef5e5 driver part

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

This patch modifies the existing machine driver for am335x to suite
EVM-SK Board configuration.
Codec is interfaced on i2c 0 bus. Codec gets its mclk from the SOC
(through clkout1 pin) which is derived from sysclk (24MHz).

EVM-SK doesn't support Audio capture through TLV320AIC3X codec.

ToDO/Issues:
Currently "arecord -l" advertises capture devices and recording a stream
using arecord starts but just hangs waiting for interrupt.
This is because both Davinci mcasp and tlvaic3x codec driver advertises
playback & capture capabilities. Instead of hacking these drivers, a
suitable methods needs to be adapted to get proper platform data into
these drivers and advertise capabilities accordingly.ts

Signed-off-by: Hebbar, Gururaja <gururaja.hebbar@ti.com>
---
 sound/soc/davinci/davinci-evm.c |   31 ++++++++++++++++++++++++++++++-
 1 files changed, 30 insertions(+), 1 deletions(-)

diff --git a/sound/soc/davinci/davinci-evm.c b/sound/soc/davinci/davinci-evm.c
index 7370e12..a1a90d0 100644
--- a/sound/soc/davinci/davinci-evm.c
+++ b/sound/soc/davinci/davinci-evm.c
@@ -24,6 +24,9 @@
 
 #include <asm/hardware/asp.h>
 #include <mach/edma.h>
+#ifdef CONFIG_MACH_AM335XEVM
+#include <mach/board-am335xevm.h>
+#endif
 
 #include "davinci-pcm.h"
 #include "davinci-i2s.h"
@@ -57,7 +60,12 @@ static int evm_hw_params(struct snd_pcm_substream *substream,
 		sysclk = 24576000;
 	/* On AM335X, CODEC gets MCLK from external Xtal (12MHz). */
 	else if (machine_is_am335xevm())
-		sysclk = 12000000;
+#ifdef CONFIG_MACH_AM335XEVM
+		if (am335x_evm_get_id() == EVM_SK)
+			sysclk = 24000000;
+		else
+#endif
+			sysclk = 12000000;
 
 	else
 		return -EINVAL;
@@ -252,6 +260,17 @@ static struct snd_soc_dai_link am335x_evm_dai = {
 	.ops = &evm_ops,
 };
 
+static struct snd_soc_dai_link am335x_evm_sk_dai = {
+	.name = "TLV320AIC3X",
+	.stream_name = "AIC3X",
+	.cpu_dai_name = "davinci-mcasp.1",
+	.codec_dai_name = "tlv320aic3x-hifi",
+	.codec_name = "tlv320aic3x-codec.1-001b",
+	.platform_name = "davinci-pcm-audio",
+	.init = evm_aic3x_init,
+	.ops = &evm_ops,
+};
+
 /* davinci dm6446 evm audio machine driver */
 static struct snd_soc_card dm6446_snd_soc_card_evm = {
 	.name = "DaVinci DM6446 EVM",
@@ -304,6 +323,12 @@ static struct snd_soc_card am335x_snd_soc_card = {
 	.num_links = 1,
 };
 
+static struct snd_soc_card am335x_evm_sk_snd_soc_card = {
+	.name = "AM335X EVM",
+	.dai_link = &am335x_evm_sk_dai,
+	.num_links = 1,
+};
+
 static struct platform_device *evm_snd_device;
 
 static int __init evm_init(void)
@@ -332,6 +357,10 @@ static int __init evm_init(void)
 		index = 0;
 	} else if (machine_is_am335xevm()) {
 		evm_snd_dev_data = &am335x_snd_soc_card;
+#ifdef CONFIG_MACH_AM335XEVM
+		if (am335x_evm_get_id() == EVM_SK)
+			evm_snd_dev_data = &am335x_evm_sk_snd_soc_card;
+#endif
 		index = 0;
 	} else
 		return -EINVAL;
-- 
1.7.5.4

