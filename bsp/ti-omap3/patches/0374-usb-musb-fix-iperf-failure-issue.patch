From c04500332740b08ef4952bc5ee275b3566408c75 Mon Sep 17 00:00:00 2001
From: Ajay Kumar Gupta <ajay.gupta@ti.com>
Date: Thu, 24 Dec 2009 10:13:31 +0530
Subject: [PATCH 374/609] usb: musb: fix iperf failure issue

Original commit: 5bbda2ae22bbb9df8f3e8a074a09f5405a1e5e98

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

As we get DMA completion interrupt even when data is in FIFO.
Fixing the issue by adding delay before calling dma completion.

Signed-off-by: Ajay Kumar Gupta <ajay.gupta@ti.com>
Signed-off-by: Vaibhav Hiremath <hvaibhav@ti.com>
---
 drivers/usb/musb/cppi41_dma.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/musb/cppi41_dma.c b/drivers/usb/musb/cppi41_dma.c
index 48d77d3..38e725d 100644
--- a/drivers/usb/musb/cppi41_dma.c
+++ b/drivers/usb/musb/cppi41_dma.c
@@ -1164,6 +1164,15 @@ static void usb_process_tx_queue(struct cppi41 *cppi, unsigned index)
 		else if (tx_ch->channel.actual_len >= tx_ch->length) {
 			tx_ch->channel.status = MUSB_DMA_STATUS_FREE;
 
+			/*
+			 * We get Tx DMA completion interrupt even when
+			 * data is still in FIFO and not moved out to
+			 * USB bus. As we program the next request we
+			 * flush out and old data in FIFO which affects
+			 * USB functionality. So far, we have obsered
+			 * failure with iperf.
+			 */
+			udelay(20);
 			/* Tx completion routine callback */
 			musb_dma_completion(cppi->musb, ep_num, 1);
 		}
-- 
1.7.5.4

