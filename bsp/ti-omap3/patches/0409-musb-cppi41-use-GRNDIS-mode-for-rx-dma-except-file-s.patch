From 860766f6c063ba62f6de9f0fdfbdc596e42e9ccb Mon Sep 17 00:00:00 2001
From: Ravi B <ravibabu@ti.com>
Date: Wed, 10 Aug 2011 16:22:46 +0530
Subject: [PATCH 409/609] musb:cppi41: use GRNDIS mode for rx-dma except
 file-storage gadget

Original commit: e141f0a5ab310a5d5ec9a937070577c7e5b0f4a7

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

The cppi41 rx-dma in gadget mode is configured for transparent mode
only for file-storage-gadget driver and GRNDIS mode is used for
other gadget driver.
Also fixes the interrupt out transfer for 1024 bytes in gadget mode,
since the transparent mode does not work for interrupt transfer of
1024 size.

Signed-off-by: Ravi B <ravibabu@ti.com>
Signed-off-by: Vaibhav Hiremath <hvaibhav@ti.com>
---
 drivers/usb/musb/cppi41_dma.c |   11 ++++-------
 1 files changed, 4 insertions(+), 7 deletions(-)

diff --git a/drivers/usb/musb/cppi41_dma.c b/drivers/usb/musb/cppi41_dma.c
index 63d9916..a6b314d 100644
--- a/drivers/usb/musb/cppi41_dma.c
+++ b/drivers/usb/musb/cppi41_dma.c
@@ -751,19 +751,16 @@ static unsigned cppi41_next_rx_segment(struct cppi41_channel *rx_ch)
 		 * GENERIC_RNDIS mode. Without this RNDIS gadget taking
 		 * more then 2K ms for a 64 byte pings.
 		 */
-#ifdef CONFIG_USB_GADGET_MUSB_HDRC
+#if defined(CONFIG_USB_GADGET_MUSB_HDRC) || defined(CONFIG_USB_GADGET_MUSB_HDRC_MODULE)
 		gadget_driver = cppi->musb->gadget_driver;
 #endif
-		if (!strcmp(gadget_driver->driver.name, "g_ether")) {
-			cppi41_mode_update(rx_ch, USB_GENERIC_RNDIS_MODE);
-		} else {
-			max_rx_transfer_size = 512;
-			cppi41_mode_update(rx_ch, USB_TRANSPARENT_MODE);
-		}
+		if (!strcmp(gadget_driver->driver.name, "g_file_storage"))
+			max_rx_transfer_size = rx_ch->pkt_size;
 		pkt_len = 0;
 		if (rx_ch->length < max_rx_transfer_size)
 			pkt_len = rx_ch->length;
 		cppi41_set_ep_size(rx_ch, pkt_len);
+		cppi41_mode_update(rx_ch, USB_GENERIC_RNDIS_MODE);
 	} else {
 		/*
 		 * Rx can use the generic RNDIS mode where we can
-- 
1.7.5.4

