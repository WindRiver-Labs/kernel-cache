From e078bb6c8412a61ac97042d85c40cda49a25f7f4 Mon Sep 17 00:00:00 2001
From: "Satyanarayana, Sandhya" <sandhya.satyanarayana@ti.com>
Date: Thu, 12 Jul 2012 11:56:41 +0530
Subject: [PATCH 271/609] ARM: OMAP: AM33XX: Fix resume via abort path issue
 for PM

Original commit: a0ea744a10c1ed9b6c96ffb03724fee238b56ca8

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

This patch fixes the issue of resume not happening
correctly via abort path.

These fixes were suggested by hardware team.

Signed-off-by: Satyanarayana, Sandhya <sandhya.satyanarayana@ti.com>
---
 arch/arm/mach-omap2/sleep33xx.S |   17 ++++++++++++++++-
 1 files changed, 16 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-omap2/sleep33xx.S b/arch/arm/mach-omap2/sleep33xx.S
index 4f25904..4af2e3a 100644
--- a/arch/arm/mach-omap2/sleep33xx.S
+++ b/arch/arm/mach-omap2/sleep33xx.S
@@ -494,6 +494,21 @@ emif_self_refresh_dis:
 	str	r1, [r0]
 	str	r1, [r0, #4]
 
+/*
+ * A write to SDRAM CONFIG register triggers
+ * an init sequence and hence it must be done
+ * at the end
+ */
+	ldr r0, emif_addr_virt
+	add r0, r0, #EMIF4_0_SDRAM_CONFIG
+	ldr r4, emif_sdcfg_val
+	str r4, [r0]
+
+	mov r0, #0x2000
+wait_loop4:
+	subs   r0, r0, #1
+	bne wait_loop4
+
 	mov	r0, #7
 	ldmfd	sp!, {r4 - r11, pc}	@ restore regs and return
 
@@ -833,7 +848,7 @@ susp_io_pull_cmd2:
 resume_io_pull_data:
 	.word	0x18B
 resume_io_pull_cmd:
-	.word	0x4
+	.word	0x18B
 
 susp_vtp_ctrl_val:
 	.word	0xDEADBEEF
-- 
1.7.5.4

