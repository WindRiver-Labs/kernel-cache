From 70946eb6c4f061b0871bbbba23e57bbf2f4f26fb Mon Sep 17 00:00:00 2001
From: Afzal Mohammed <afzal@ti.com>
Date: Sat, 30 Jun 2012 22:46:20 +0800
Subject: [PATCH 512/609] regulator: TPS65910: VDD1 error handling

Original commit: 2d1fa9a2b287961afccef4759efbf5327b870bb0

  From git://arago-project.org/git/projects/linux-am33x.git
  And ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

Proper error handling w.r.t I2C transactions
for setting & getting voltage for VDD1

Signed-off-by: Afzal Mohammed <afzal@ti.com>
---
 drivers/regulator/tps65910-regulator.c |   14 +++++++++++---
 1 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/drivers/regulator/tps65910-regulator.c b/drivers/regulator/tps65910-regulator.c
index 4a37c2b6..4d6b68f 100644
--- a/drivers/regulator/tps65910-regulator.c
+++ b/drivers/regulator/tps65910-regulator.c
@@ -570,9 +570,15 @@ static int tps65910_get_voltage_dcdc_sel(struct regulator_dev *dev)
 	switch (id) {
 	case TPS65910_REG_VDD1:
 		opvsel = tps65910_reg_read(pmic, TPS65910_VDD1_OP);
+		if (opvsel < 0)
+			return opvsel;
 		mult = tps65910_reg_read(pmic, TPS65910_VDD1);
+		if (mult < 0)
+			return mult;
 		mult = (mult & VDD1_VGAIN_SEL_MASK) >> VDD1_VGAIN_SEL_SHIFT;
 		srvsel = tps65910_reg_read(pmic, TPS65910_VDD1_SR);
+		if (srvsel < 0)
+			return srvsel;
 		sr = opvsel & VDD1_OP_CMD_MASK;
 		opvsel &= VDD1_OP_SEL_MASK;
 		srvsel &= VDD1_SR_SEL_MASK;
@@ -717,6 +723,7 @@ static int tps65910_set_voltage_dcdc_sel(struct regulator_dev *dev,
 	struct tps65910_reg *pmic = rdev_get_drvdata(dev);
 	int id = rdev_get_id(dev), vsel;
 	int dcdc_mult = 0;
+	int ret = 0;
 
 	switch (id) {
 	case TPS65910_REG_VDD1:
@@ -725,10 +732,11 @@ static int tps65910_set_voltage_dcdc_sel(struct regulator_dev *dev,
 			dcdc_mult--;
 		vsel = (selector % VDD1_2_NUM_VOLT_FINE) + 3;
 
-		tps65910_modify_bits(pmic, TPS65910_VDD1,
+		ret = tps65910_modify_bits(pmic, TPS65910_VDD1,
 				(dcdc_mult << VDD1_VGAIN_SEL_SHIFT),
 						VDD1_VGAIN_SEL_MASK);
-		tps65910_reg_write(pmic, TPS65910_VDD1_OP, vsel);
+		if (!ret)
+			ret = tps65910_reg_write(pmic, TPS65910_VDD1_OP, vsel);
 		break;
 	case TPS65910_REG_VDD2:
 		dcdc_mult = (selector / VDD1_2_NUM_VOLT_FINE) + 1;
@@ -746,7 +754,7 @@ static int tps65910_set_voltage_dcdc_sel(struct regulator_dev *dev,
 		tps65910_reg_write(pmic, TPS65911_VDDCTRL_OP, vsel);
 	}
 
-	return 0;
+	return ret;
 }
 
 static int tps65910_set_voltage_sel(struct regulator_dev *dev,
-- 
1.7.5.4

