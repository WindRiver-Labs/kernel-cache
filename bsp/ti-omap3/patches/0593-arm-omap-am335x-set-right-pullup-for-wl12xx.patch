From 2d9b7229ff2aa1719fe887503e9da11b864d4734 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Fri, 7 Sep 2012 11:05:42 +0800
Subject: [PATCH 593/609] arm: omap: am335x: set right pullup for wl12xx

Original changes from

  ti-sdk-am335x-evm-05.05.00.00-Linux-x86-Install image

This patch sets proper pullup for wl12xx when wlan on/off.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-omap2/board-am335xevm.c |   24 ++++++++++++++++++++++++
 1 files changed, 24 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-omap2/board-am335xevm.c b/arch/arm/mach-omap2/board-am335xevm.c
index 28cdd90..63067a2 100644
--- a/arch/arm/mach-omap2/board-am335xevm.c
+++ b/arch/arm/mach-omap2/board-am335xevm.c
@@ -64,6 +64,7 @@
 #include <plat/nand.h>
 
 #include "board-flash.h"
+#include "iomap.h"
 #include "cpuidle33xx.h"
 #include "mux.h"
 #include "devices.h"
@@ -1682,6 +1683,7 @@ static void mmc1_wl12xx_init(int evm_id, int profile)
 	am335x_mmc[1].name = "wl1271";
 	am335x_mmc[1].caps = MMC_CAP_4_BIT_DATA | MMC_CAP_POWER_OFF_CARD;
 	am335x_mmc[1].nonremovable = true;
+	am335x_mmc[1].pm_caps = MMC_PM_KEEP_POWER;
 	am335x_mmc[1].gpio_cd = -EINVAL;
 	am335x_mmc[1].gpio_wp = -EINVAL;
 	am335x_mmc[1].ocr_mask = MMC_VDD_32_33 | MMC_VDD_33_34; /* 3V3 */
@@ -1719,13 +1721,35 @@ static void wl12xx_bluetooth_enable(void)
 	gpio_direction_output(am335xevm_wlan_data.bt_enable_gpio, 0);
 }
 
+#define AM33XX_CTRL_REGADDR(reg)		\
+		AM33XX_L4_WK_IO_ADDRESS(AM33XX_SCM_BASE + (reg))
+
+/* wlan enable pin */
+#define AM33XX_CONTROL_PADCONF_GPMC_CSN0_OFFSET		0x087C
 static int wl12xx_set_power(struct device *dev, int slot, int on, int vdd)
 {
+	int pad_mux_value;
+
 	if (on) {
 		gpio_direction_output(am335xevm_wlan_data.wlan_enable_gpio, 1);
+
+		/* Enable pullup on the WLAN enable pin for keeping wlan active during suspend
+		   in wowlan mode */
+		if ( am335x_evm_get_id() == EVM_SK ) {
+			pad_mux_value = readl(AM33XX_CTRL_REGADDR(AM33XX_CONTROL_PADCONF_GPMC_CSN0_OFFSET));
+			pad_mux_value &= (~AM33XX_PULL_DISA);
+			writel(pad_mux_value, AM33XX_CTRL_REGADDR(AM33XX_CONTROL_PADCONF_GPMC_CSN0_OFFSET));
+		}
+
 		mdelay(70);
 	} else {
 		gpio_direction_output(am335xevm_wlan_data.wlan_enable_gpio, 0);
+		/* Disable pullup on the WLAN enable when WLAN is off */
+		if ( am335x_evm_get_id() == EVM_SK ) {
+			pad_mux_value = readl(AM33XX_CTRL_REGADDR(AM33XX_CONTROL_PADCONF_GPMC_CSN0_OFFSET));
+			pad_mux_value |= AM33XX_PULL_DISA;
+			writel(pad_mux_value, AM33XX_CTRL_REGADDR(AM33XX_CONTROL_PADCONF_GPMC_CSN0_OFFSET));
+		}
 	}
 
 	return 0;
-- 
1.7.5.4

