From e681f1522842ee4c1f0bae9fdeeff14ffe00498f Mon Sep 17 00:00:00 2001
From: czou <cao.zou@windriver.com>
Date: Wed, 19 Aug 2015 13:03:15 +0800
Subject: [PATCH 03/29] musb: omap3evm: twl4030: enable GPIO2 output

the usb of omap3evm enables VBUS by setting twl4030 gpio2 as output,
add the support  for device-tree parameter

Signed-off-by: czou <cao.zou@windriver.com>
---
 arch/arm/boot/dts/omap3-evm.dts |  4 ++++
 drivers/gpio/gpio-twl4030.c     | 10 ++++++++++
 2 files changed, 14 insertions(+)

diff --git a/arch/arm/boot/dts/omap3-evm.dts b/arch/arm/boot/dts/omap3-evm.dts
index e10dcd0..4108f3e 100644
--- a/arch/arm/boot/dts/omap3-evm.dts
+++ b/arch/arm/boot/dts/omap3-evm.dts
@@ -19,3 +19,7 @@
 		reg = <0x80000000 0x10000000>; /* 256 MB */
 	};
 };
+
+&twl_gpio {
+	ti,usb-vbus = <1>;
+};
diff --git a/drivers/gpio/gpio-twl4030.c b/drivers/gpio/gpio-twl4030.c
index 2b1d577..826e7bf 100644
--- a/drivers/gpio/gpio-twl4030.c
+++ b/drivers/gpio/gpio-twl4030.c
@@ -561,6 +561,16 @@ no_irqs:
 				      TWL4030_GPIO_MAX);
 		if (status)
 			dev_dbg(&pdev->dev, "setup --> %d\n", status);
+	} else if (node) {
+		int usb_gpio;
+		if (of_property_read_u32(node, "ti,usb-vbus",
+			     &usb_gpio) == 0) {
+			u8 val;
+
+			twl_i2c_read_u8(TWL4030_MODULE_GPIO, &val, REG_GPIODATADIR1);
+			val |= 0x04; /* TWL4030.GPIO2DIR BIT at GPIODATADIR1(0x9B) */
+			twl_i2c_write_u8(TWL4030_MODULE_GPIO, val, REG_GPIODATADIR1);
+		}
 	}
 
 out:
-- 
1.9.1

