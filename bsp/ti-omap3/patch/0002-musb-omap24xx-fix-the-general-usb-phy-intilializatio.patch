From b6fdedcc85ca582984bfc9d16b6f477ea2c5141e Mon Sep 17 00:00:00 2001
From: czou <cao.zou@windriver.com>
Date: Tue, 18 Aug 2015 16:21:16 +0800
Subject: [PATCH 02/29] musb: omap24xx: fix the general usb phy intilialization
 error

pm_runtime_enable will resume the usb general phy PM_RUNTIME, but it is based on
the data of usb host control, so move these pm_runtime functions below the initialazation
of control data.

Signed-off-by: czou <cao.zou@windriver.com>
---
 drivers/usb/musb/musb_core.c | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/drivers/usb/musb/musb_core.c b/drivers/usb/musb/musb_core.c
index 0757690..5b578e3 100644
--- a/drivers/usb/musb/musb_core.c
+++ b/drivers/usb/musb/musb_core.c
@@ -1860,16 +1860,22 @@ musb_init_controller(struct device *dev, int nIrq, void __iomem *ctrl)
 		goto fail0;
 	}
 
-	pm_runtime_use_autosuspend(musb->controller);
+	/*pm_runtime_use_autosuspend(musb->controller);
 	pm_runtime_set_autosuspend_delay(musb->controller, 200);
 	pm_runtime_enable(musb->controller);
-
+*/
 	spin_lock_init(&musb->lock);
 	musb->board_set_power = plat->set_power;
 	musb->min_power = plat->min_power;
 	musb->ops = plat->platform_ops;
 	musb->port_mode = plat->mode;
 
+	/* We need musb_read/write functions initialized for PM */
+	pm_runtime_use_autosuspend(musb->controller);
+	pm_runtime_set_autosuspend_delay(musb->controller, 200);
+	pm_runtime_irq_safe(musb->controller);
+	pm_runtime_enable(musb->controller);
+
 	/* The musb_platform_init() call:
 	 *   - adjusts musb->mregs
 	 *   - sets the musb->isr
-- 
1.9.1

