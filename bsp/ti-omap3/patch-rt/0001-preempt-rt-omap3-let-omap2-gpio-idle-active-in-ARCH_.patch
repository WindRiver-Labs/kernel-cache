From c571f4a26b8719c3f24287f736404c40b5a263b4 Mon Sep 17 00:00:00 2001
From: czou <cao.zou@windriver.com>
Date: Tue, 15 Sep 2015 15:22:12 +0800
Subject: [PATCH] preempt-rt: omap3: let omap2 gpio idle active in ARCH_OMAP2

omap2_gpio_resume_after_idle and omap2_gpio_resume_after_idle is
a workaround patch based on "9564f5", it will cause spinlock warning
in preemrt kernel, so set it is active for ARCH_OMAP2, warning log as
follow:
kernel/locking/rtmutex.c:1165
in_atomic(): 1, irqs_disabled(): 128, pid: 0, name: swapper
Preemption disabled at:[<  (null)>]   (null)

CPU: 0 PID: 0 Comm: swapper Not tainted
3.14.39ltsi-rt37-WR7.0.0.0_preempt-rt #11
[<c0017610>] (unwind_backtrace) from [<c0013154>] (show_stack+0x20/0x24)
[<c0013154>] (show_stack) from [<c06c5154>] (dump_stack+0x24/0x28)
[<c06c5154>] (dump_stack) from [<c006abc0>] (__might_sleep+0x108/0x160)
[<c006abc0>] (__might_sleep) from [<c06c999c>] (rt_spin_lock+0x2c/0x6c)
[<c06c999c>] (rt_spin_lock) from [<c0444a98>]
(__pm_runtime_suspend+0x68/0xa4)
[<c0444a98>] (__pm_runtime_suspend) from [<c03b8b30>]
(omap2_gpio_prepare_for_idle+0x70/0x80)
[<c03b8b30>] (omap2_gpio_prepare_for_idle) from [<c002cb54>]
(omap_sram_idle+0x150/0x288)
[<c002cb54>] (omap_sram_idle) from [<c002dc54>]
(omap3_enter_idle_bm+0x130/0x23c)
[<c002dc54>] (omap3_enter_idle_bm) from [<c052f340>]
(cpuidle_enter_state+0x50/0xf4)
[<c052f340>] (cpuidle_enter_state) from [<c052f4d4>]
(cpuidle_idle_call+0xf0/0x2bc)
[<c052f4d4>] (cpuidle_idle_call) from [<c000fe4c>]
(arch_cpu_idle+0x18/0x48)
[<c000fe4c>] (arch_cpu_idle) from [<c00803b8>]
(cpu_startup_entry+0x158/0x2a0)
[<c00803b8>] (cpu_startup_entry) from [<c06c2738>] (rest_init+0x94/0x98)
[<c06c2738>] (rest_init) from [<c0975b20>] (start_kernel+0x378/0x384)

Signed-off-by: czou <cao.zou@windriver.com>
---
 arch/arm/mach-omap2/pm34xx.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/arch/arm/mach-omap2/pm34xx.c b/arch/arm/mach-omap2/pm34xx.c
index 1f3770a..8faf6d6 100644
--- a/arch/arm/mach-omap2/pm34xx.c
+++ b/arch/arm/mach-omap2/pm34xx.c
@@ -244,7 +244,9 @@ void omap_sram_idle(void)
 	int mpu_next_state = PWRDM_POWER_ON;
 	int per_next_state = PWRDM_POWER_ON;
 	int core_next_state = PWRDM_POWER_ON;
+#ifdef CONFIG_ARCH_OMAP2
 	int per_going_off;
+#endif
 	int core_prev_state;
 	u32 sdrc_pwr = 0;
 
@@ -273,12 +275,13 @@ void omap_sram_idle(void)
 	core_next_state = pwrdm_read_next_pwrst(core_pwrdm);
 
 	pwrdm_pre_transition(NULL);
-
+#ifdef CONFIG_ARCH_OMAP2
 	/* PER */
 	if (per_next_state < PWRDM_POWER_ON) {
 		per_going_off = (per_next_state == PWRDM_POWER_OFF) ? 1 : 0;
 		omap2_gpio_prepare_for_idle(per_going_off);
 	}
+#endif
 
 	/* CORE */
 	if (core_next_state < PWRDM_POWER_ON) {
@@ -339,9 +342,11 @@ void omap_sram_idle(void)
 
 	pwrdm_post_transition(NULL);
 
+#ifdef CONFIG_ARCH_OMAP2
 	/* PER */
 	if (per_next_state < PWRDM_POWER_ON)
 		omap2_gpio_resume_after_idle();
+#endif
 }
 
 static void omap3_pm_idle(void)
-- 
2.0.1

