From cc9359e38e5f60bd4e50e5e2df2e90040f523656 Mon Sep 17 00:00:00 2001
From: Lans Zhang <jia.zhang@windriver.com>
Date: Tue, 7 Jan 2014 11:29:28 +0800
Subject: [PATCH 5/9] quark: fix kernel bug when releasing debugfs.

debugfs for stmmac driver is limited to be registered/unregistered one time
only because the registration/unregistration of debugfs for stmmac
driver is called along with adding/removing each interface. For
a multiple interface system, this counter should ensure the unregistration
of debugfs is called one time. However, current code breaks this
rule, triggering the following kernel bug when stoping the 2nd NIC
if debugfs is enabled:

kernel BUG at /home/windriver/prj_0.80_2/bitbake_build/tmp/work/intel_quark-wrs-linux/linux-windriver-3.4-r0/linux/fs/dcache.c:536!
invalid opcode: 0000 [#1]
Modules linked in: hwmon industrialio_triggered_buffer spi_pxa2xx_pci mfd_core lpc_sch thermal_sys evdev stmmac intel_cln_gip button uio i2c_core processor kfifo_buf gpio_sch spidev cdc_acm spi_pxa2xx cy8c9540a at24 ad7298 industrialio udc_core pch_udc i2c_dev led_class g_serial slhc crc_ccitt mtd rfkill crypto_algapi m25p80 crypto_hash ppp_async btusb hidp usbhid cfg80211 af_packet hid ppp_generic rfcomm mac80211 iwlwifi bluetooth ipv6

Pid: 1861, comm: ifconfig Not tainted 3.4.43-WR5.0.1.9_standard #1 Intel Corp. Clanton Peak
EIP: 0060:[<c10cfa92>] EFLAGS: 00210246 CPU: 0
EIP is at dput+0x212/0x220
EAX: 00000000 EBX: cddd6b40 ECX: c178a640 EDX: ced73c60
ESI: 00000000 EDI: cdf1e460 EBP: cec1bdd0 ESP: cec1bdbc
DS: 007b ES: 007b FS: 0000 GS: 0033 SS: 0068
CR0: 8005003b CR2: 088e1404 CR3: 0ecec000 CR4: 00100010
DR0: 00000000 DR1: 00000000 DR2: 00000000 DR3: 00000000
DR6: ffff0ff0 DR7: 00000400
Process ifconfig (pid: 1861, ti=cec1a000 task=ced73c60 task.ti=cec1a000)
Stack:
cec1bdd0 cddd6b90 cddd6b40 00000000 cdf1e460 cec1bde4 c11a584d cdf1e460
cddd6b40 c10064b0 cec1bdf4 c11a5a05 cedd8000 00002000 cec1be20 e076e5ed
0ede0000 00000000 c0183860 0ede0000 c0183860 cede0000 cedd8000 cec1be44
Call Trace:
[<c11a584d>] __debugfs_remove+0x7d/0xb0
[<c10064b0>] ? dma_generic_alloc_coherent+0xb0/0xb0
[<c11a5a05>] debugfs_remove+0x35/0x80
[<e076e5ed>] stmmac_release+0x29d/0x310 [stmmac]
[<c12d1121>] __dev_close_many+0x71/0xc0
[<c102f9f9>] ? local_bh_enable_ip+0x59/0xc0
[<c12d1198>] __dev_close+0x28/0x40
[<c12d5a1c>] __dev_change_flags+0x7c/0x150
[<c12dfb3f>] ? rtnl_lock+0xf/0x20
[<c12d5b8c>] dev_change_flags+0x1c/0x60
[<c13265bc>] devinet_ioctl+0x52c/0x6e0
[<c12d6110>] ? dev_ioctl+0x1b0/0x5e0
[<c13269d5>] inet_ioctl+0x85/0xb0
[<c12c0a4b>] sock_ioctl+0x6b/0x2a0
[<c1371db2>] ? _raw_spin_unlock_irq+0x22/0x30
[<c12c09e0>] ? sock_fasync+0x80/0x80
[<c10cb8d2>] do_vfs_ioctl+0x82/0x570
[<c1370a52>] ? __schedule+0x182/0x4a0
[<c1022277>] ? do_page_fault+0x1c7/0x3f0
[<c105fd0c>] ? trace_hardirqs_on_caller+0xec/0x170
[<c108379d>] ? call_rcu_sched+0xd/0x10
[<c104905e>] ? __put_cred+0x2e/0x40
[<c10baf0a>] ? sys_faccessat+0x10a/0x180
[<c10cbe27>] sys_ioctl+0x67/0x80
[<c13720f5>] syscall_call+0x7/0xb
Code: 00 00 89 93 84 00 00 00 89 b0 ec 00 00 00 8b 43 74 83 05 c4 83 4e c1 01 83 80 f4 00 00 00 01 b8 20 84 4e c1 e8 90 23 2a 00 eb 9d <0f> 0b 8d b6 00 00 00 00 8d bf 00 00 00 00 55 89 e5 57 56 53 83
EIP: [<c10cfa92>] dput+0x212/0x220 SS:ESP 0068:cec1bdbc
---[ end trace a82d74e253b2368d ]---

This patch confirms doing correct resource cleanup on unloading driver.

Signed-off-by: Lans Zhang <jia.zhang@windriver.com>
Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 drivers/net/ethernet/stmicro/stmmac/stmmac_main.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c b/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
index d24d2aa..cd34fc1 100644
--- a/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
+++ b/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
@@ -1885,7 +1885,10 @@ static int stmmac_release(struct net_device *dev)
 	netif_carrier_off(dev);
 
 #ifdef CONFIG_DEBUG_FS
-	stmmac_exit_fs();
+	if (debugfs_registered) {
+		debugfs_registered = 0;
+		stmmac_exit_fs();
+	}
 #endif
 
 	stmmac_release_ptp(priv);
-- 
1.7.5.4

