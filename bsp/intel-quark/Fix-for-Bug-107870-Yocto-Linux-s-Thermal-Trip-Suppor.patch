From 589a12ebeda0649a4dcd5430daee7948dbb3d076 Mon Sep 17 00:00:00 2001
From: "Saini, Naveen Kumar" <naveen.kumarx.saini@intel.com>
Date: Thu, 18 Jun 2015 10:19:12 +0800
Subject: [PATCH 35/65] Fix for Bug #107870 - Yocto Linux's Thermal Trip
 Support For Negative Temperature

Due to reading wrong temperature value from the sensor register

Signed-off-by: Naveen Saini<naveen.kumarx.saini@intel.com>

Change-Id: Idbb14163d7481ce261e7cc915028024a72343163
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/5258
Reviewed-by: Fung, Joshua <joshua.fung@intel.com>
Tested-by: Tan, Raymond <raymond.tan@intel.com>
Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 .../platform/x86/intel-quark/intel_qrk_thermal.c   |    9 +++++----
 1 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/drivers/platform/x86/intel-quark/intel_qrk_thermal.c b/drivers/platform/x86/intel-quark/intel_qrk_thermal.c
index acddb14..28ff2e4 100644
--- a/drivers/platform/x86/intel-quark/intel_qrk_thermal.c
+++ b/drivers/platform/x86/intel-quark/intel_qrk_thermal.c
@@ -126,15 +126,16 @@ static int intel_qrk_thermal_get_temp(struct thermal_zone_device *tz,
 	/* Need to apply mask */
 	/* Bits 16-23: Thermal sensor relative temperature */
 	/* Bits 0-7: Thermal sensor temperature */
+	/* THRM_SENSR_TEMP[7:0] */
 	*temp &= 0x000000FF;
 
-	*temp -= RAW2CELSIUS_DIFF;
-
 	/* Clip to unsigned output value if sensor is reporting sub-zero */
-	if ((int)*temp < 0)
+	if (*temp <= RAW2CELSIUS_DIFF) 
 		*temp = 0;
+	else 
+		*temp -= RAW2CELSIUS_DIFF;
 
-	*temp = MCELSIUS(*temp&0x000000FF);
+	*temp = MCELSIUS(*temp);
 
 	return 0;
 }
-- 
1.7.5.4

