From 05ebc91b6252e60ee456468c7503b13bc959bf14 Mon Sep 17 00:00:00 2001
From: Lans Zhang <jia.zhang@windriver.com>
Date: Mon, 11 Nov 2013 12:58:24 +0800
Subject: [PATCH 08/12] Fix board-data iomap.

The failure of ioremap() -> no cln-plat -> cannot get platform id item
within mfh -> intel_cln_plat_get_id() returns CLANTON_PLAT_UNDEFINED ->
stmmac driver cannot be initialized properly.

To fix this issue from root, be aware of using a proper value of mapped
area determined by the maximum size of MFH and platform data area,
which cannot conflict with other MFH items.

Additionally, a proper calculation to the end of a resource requiring
plus 1 is required.

Signed-off-by: Lans Zhang <jia.zhang@windriver.com>
---
 drivers/platform/x86/quark/intel_cln_board_data.c |    7 ++++---
 drivers/platform/x86/quark/intel_cln_plat_data.c  |    3 ++-
 2 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/drivers/platform/x86/quark/intel_cln_board_data.c b/drivers/platform/x86/quark/intel_cln_board_data.c
index da226c7..2d57bbc 100644
--- a/drivers/platform/x86/quark/intel_cln_board_data.c
+++ b/drivers/platform/x86/quark/intel_cln_board_data.c
@@ -41,7 +41,7 @@
 #define MTD_PART_LEN				0x00040000
 #define MFH_PADDING				0x1E8
 #define MFH_MAGIC				0x5F4D4648
-#define FLASH_SIZE				0x00400000
+#define FLASH_SIZE				(PLATFORM_DATA_OFFSET + 0x1000)
 
 /* MFH types supported @ version #1 */
 #define MFH_ITEM_FW_STAGE1			0x00000000
@@ -191,8 +191,9 @@ static int __init intel_cln_board_data_init(void)
 
 		/* Platform data */
 		plat_res.start = SPIFLASH_BASEADDR + PLATFORM_DATA_OFFSET;
-		count = *(uint32_t*)(spi_data + PLATFORM_DATA_OFFSET + sizeof(uint32_t));
-		plat_res.end = count;
+		/* Hardcode the size of header. */
+		count = 12 + *(uint32_t*)(spi_data + PLATFORM_DATA_OFFSET + sizeof(uint32_t));
+		plat_res.end = plat_res.start + count - 1;
 		ret = intel_cln_plat_probe(&plat_res);
 	}
 
diff --git a/drivers/platform/x86/quark/intel_cln_plat_data.c b/drivers/platform/x86/quark/intel_cln_plat_data.c
index 059fcee..959c066 100644
--- a/drivers/platform/x86/quark/intel_cln_plat_data.c
+++ b/drivers/platform/x86/quark/intel_cln_plat_data.c
@@ -329,7 +329,8 @@ int intel_cln_plat_probe(struct resource * pres)
 	}
 
 	/* Validate length is sane */
-	if ((char*)plat_hdr + plat_hdr->length > end_addr ||
+	if ((char*)plat_hdr + sizeof(struct cln_plat_dat_hdr) +
+		plat_hdr->length > end_addr ||
 		plat_hdr->length < sizeof(struct cln_plat_data)){
 		pr_err(PREFIX"Invalid length 0x%08lx\n",
 			(unsigned long)plat_hdr->length);
-- 
1.7.5.4

