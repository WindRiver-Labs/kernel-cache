From d536f9acf331e8d0f3e68dc99ac1500a235c1da9 Mon Sep 17 00:00:00 2001
From: "Tan, Raymond" <raymond.tan@intel.com>
Date: Tue, 9 Jun 2015 15:38:17 +0800
Subject: [PATCH 41/42] platform: x86: intel_quark_platform_cross_hill:
 Delayed SPI devices registration at later stage

The original NC and SC GPIO have the probing flow restricted
in a particular order through the qrk-gpio-restrict driver.
Moving on to Kernel 3.14, the drivers probe is dependant on
the deferred probing mechanism.

While this changes don't affect both I2C and GPIO, it does cause
failure to SPI devices. SPI devices registration on embedded platform,
is done through spi_register_board_info, which calls to a void function
spi_match_master_to_boardinfo that doesn't handle EPROBE_DEFER.

Since SPI devices are dependent on GPIO, the SPI device registration
is moved after GPIO instead.

Signed-off-by: Tan, Raymond <raymond.tan@intel.com>
Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 .../intel-quark/intel_quark_platform_cross_hill.c  |   21 ++++++++++++++-----
 1 files changed, 15 insertions(+), 6 deletions(-)

diff --git a/drivers/platform/x86/intel-quark/intel_quark_platform_cross_hill.c b/drivers/platform/x86/intel-quark/intel_quark_platform_cross_hill.c
index f58f747..3dce53b 100644
--- a/drivers/platform/x86/intel-quark/intel_quark_platform_cross_hill.c
+++ b/drivers/platform/x86/intel-quark/intel_quark_platform_cross_hill.c
@@ -384,23 +384,32 @@ error_gpio_free:
 static int intel_qrk_plat_cross_hill_probe(struct platform_device *pdev)
 {
 	int ret = 0;
+	static int bpeak_done;
 	static int spi_done;
 
-	if (spi_done)
-		goto bpeak_devs;
+	if (bpeak_done)
+		goto spi;
 
-	ret = intel_qrk_spi_add_onboard_devs();
+	ret = intel_qrk_spi_add_bpeak_devs();
 	if (ret)
 		goto end;
  
-	spi_done = 1;
+	bpeak_done = 1;
 
-bpeak_devs:
-	ret = intel_qrk_spi_add_bpeak_devs();
+spi:
+
+	if (spi_done)
+		goto slb;
+
+	ret = intel_qrk_spi_add_onboard_devs();
 	if (ret)
 		goto end;
 
+	spi_done = 1;
+
+slb:
 	ret = intel_qrk_slb9645tt_probe();
+
 end:
 	return ret;
 }
-- 
1.7.5.4

