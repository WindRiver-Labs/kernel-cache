From 1bfb914973c04615f10423a55382a887a4dded1a Mon Sep 17 00:00:00 2001
From: Lans Zhang <jia.zhang@windriver.com>
Date: Tue, 15 Dec 2015 15:34:36 +0800
Subject: [PATCH] stmmac: fix calltrace during the interface removal

The debugfs entry for stmmac NIC always binds to a specific NIC device
so the removal operation should be aware of it.

Signed-off-by: Lans Zhang <jia.zhang@windriver.com>
---
 drivers/net/ethernet/stmicro/stmmac/stmmac_main.c |   11 ++++++-----
 1 files changed, 6 insertions(+), 5 deletions(-)

diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c b/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
index b697473..05ac7f7 100644
--- a/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
+++ b/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
@@ -119,7 +119,7 @@ static irqreturn_t stmmac_interrupt(int irq, void *dev_id);
 #ifdef CONFIG_DEBUG_FS
 static int stmmac_init_fs(struct net_device *dev);
 static void stmmac_exit_fs(struct net_device *dev);
-static int debugfs_registered = 0;
+static struct net_device *debugfs_registered_dev;
 #endif
 
 #define STMMAC_COAL_TIMER(x) (jiffies + usecs_to_jiffies(x))
@@ -1700,11 +1700,12 @@ static int stmmac_hw_setup(struct net_device *dev, bool init_ptp)
 	}
 
 #ifdef CONFIG_DEBUG_FS
-	if (debugfs_registered == 0) {
-		debugfs_registered = 1;
+	if (!debugfs_registered_dev) {
 		ret = stmmac_init_fs(dev);
 		if (ret < 0)
 			pr_warn("%s: failed debugFS registration\n", __func__);
+		else
+			debugfs_registered_dev = dev;
 	}
 #endif
 	/* Start the ball rolling... */
@@ -1885,8 +1886,8 @@ static int stmmac_release(struct net_device *dev)
 	netif_carrier_off(dev);
 
 #ifdef CONFIG_DEBUG_FS
-	if (debugfs_registered) {
-		debugfs_registered = 0;
+	if (debugfs_registered_dev == dev) {
+		debugfs_registered_dev = NULL;
 		stmmac_exit_fs(dev);
 	}
 #endif
-- 
1.7.5.4

