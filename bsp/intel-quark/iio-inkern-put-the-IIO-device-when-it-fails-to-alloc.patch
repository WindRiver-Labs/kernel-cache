From c8f2bef05578d1d9c8a32eace28a281fcc573e7b Mon Sep 17 00:00:00 2001
From: "Kim, Milo" <Milo.Kim@ti.com>
Date: Tue, 18 Sep 2012 05:55:00 +0100
Subject: [PATCH 0916/1187] iio: inkern: put the IIO device when it fails to
 allocate memory

commit 801c4b5ca373c4cfe78912616d68e1f7fd84110c	upstream

 The reference count of the IIO device is increased if the IIO map has
 matched consumer name.
 After then, it tries to allocate the iio_channel which is used by the consumer.
 If it fails to allocate memory, the reference count should be decreased.

 This patch enables restoring the reference count of the IIO device.

Signed-off-by: Milo(Woogyom) Kim <milo.kim@ti.com>
Signed-off-by: Jonathan Cameron <jic23@kernel.org>
Signed-off-by: Lans Zhang <jia.zhang@windriver.com>
---
 drivers/iio/inkern.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/iio/inkern.c b/drivers/iio/inkern.c
index 25b0076..e38f414 100644
--- a/drivers/iio/inkern.c
+++ b/drivers/iio/inkern.c
@@ -132,7 +132,7 @@ struct iio_channel *iio_channel_get(const char *name, const char *channel_name)
 
 	channel = kzalloc(sizeof(*channel), GFP_KERNEL);
 	if (channel == NULL)
-		return ERR_PTR(-ENOMEM);
+		goto error_no_mem;
 
 	channel->indio_dev = c->indio_dev;
 
@@ -151,6 +151,9 @@ error_no_chan:
 	iio_device_put(c->indio_dev);
 	kfree(channel);
 	return ERR_PTR(-EINVAL);
+error_no_mem:
+	iio_device_put(c->indio_dev);
+	return ERR_PTR(-ENOMEM);
 }
 EXPORT_SYMBOL_GPL(iio_channel_get);
 
-- 
1.7.5.4

