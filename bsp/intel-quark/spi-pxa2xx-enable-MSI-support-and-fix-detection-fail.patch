From 18d0b4f28d9b6c4c244a38bf2a976e54b7efb10f Mon Sep 17 00:00:00 2001
From: Lans Zhang <jia.zhang@windriver.com>
Date: Sun, 11 Jan 2015 16:51:30 +0800
Subject: [PATCH 7/9] spi-pxa2xx: enable MSI support and fix detection
 failure.

Use PCI function as port_id to identify SPI master instead for Quark
SoC specific.

Signed-off-by: Lans Zhang <jia.zhang@windriver.com>
Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 drivers/spi/spi-pxa2xx-pci.c |   27 +++++++++++++++++++++++----
 drivers/spi/spi-pxa2xx.c     |   14 +++++++++++++-
 include/linux/pxa2xx_ssp.h   |    1 +
 3 files changed, 37 insertions(+), 5 deletions(-)

diff --git a/drivers/spi/spi-pxa2xx-pci.c b/drivers/spi/spi-pxa2xx-pci.c
index 88b8f91..3e63224 100644
--- a/drivers/spi/spi-pxa2xx-pci.c
+++ b/drivers/spi/spi-pxa2xx-pci.c
@@ -54,6 +54,14 @@ static bool lpss_dma_filter(struct dma_chan *chan, void *param)
 	return true;
 }
 
+#ifdef CONFIG_X86_INTEL_QUARK
+static int enable_msi = 1;
+#else
+static int enable_msi;
+#endif
+module_param(enable_msi, int, S_IRUGO | S_IWUSR);
+MODULE_PARM_DESC(enable_msi, "Enable PCI MSI mode");
+
 static struct pxa_spi_info spi_info_configs[] = {
 	[PORT_CE4100] = {
 		.type = PXA25x_SSP,
@@ -96,7 +104,7 @@ static struct pxa_spi_info spi_info_configs[] = {
 	[PORT_QUARK_X1000] = {
 		.type = QUARK_X1000_SSP,
 		.port_id = -1,
-		.num_chipselect = 1,
+		.num_chipselect = 4,
 		.max_clk_rate = 50000000,
 	},
 };
@@ -151,17 +159,28 @@ static int pxa2xx_spi_pci_probe(struct pci_dev *dev,
 	spi_pdata.enable_dma = c->rx_param && c->tx_param;
 
 	ssp = &spi_pdata.ssp;
+	ssp->pcidev = dev;
 	ssp->phys_base = pci_resource_start(dev, 0);
 	ssp->mmio_base = pcim_iomap_table(dev)[0];
 	if (!ssp->mmio_base) {
 		dev_err(&dev->dev, "failed to ioremap() registers\n");
 		return -EIO;
 	}
+
+	pci_set_master(dev);
+	if (enable_msi == 1) {
+		ret = pci_enable_msi(dev);
+		if (ret) {
+			dev_dbg(&dev->dev, "failed to allocate MSI entry\n");
+		}
+	}
+
 	ssp->irq = dev->irq;
 	ssp->port_id = (c->port_id >= 0) ? c->port_id : dev->devfn;
-#ifdef CONFIG_X86_INTEL_QUARK
-	ssp->port_id = PCI_FUNC(ssp->port_id);
-#endif
+	if (c->type != QUARK_X1000_SSP)
+		ssp->port_id = (c->port_id >= 0) ? c->port_id : dev->devfn;
+	else
+		ssp->port_id = PCI_FUNC(dev->devfn);
 	ssp->type = c->type;
 
 	snprintf(buf, sizeof(buf), "pxa2xx-spi.%d", ssp->port_id);
diff --git a/drivers/spi/spi-pxa2xx.c b/drivers/spi/spi-pxa2xx.c
index cba00ac..8568c48 100644
--- a/drivers/spi/spi-pxa2xx.c
+++ b/drivers/spi/spi-pxa2xx.c
@@ -38,6 +38,9 @@
 #include <asm/io.h>
 #include <asm/irq.h>
 #include <asm/delay.h>
+#ifdef CONFIG_X86_INTEL_QUARK
+#include <asm/qrk.h>
+#endif
 
 #include "spi-pxa2xx.h"
 
@@ -686,6 +689,7 @@ static irqreturn_t ssp_int(int irq, void *dev_id)
 	u32 sccr1_reg;
 	u32 mask = drv_data->mask_sr;
 	u32 status;
+	irqreturn_t ret;
 
 	/*
 	 * The IRQ might be shared with other peripherals so we must first
@@ -715,6 +719,10 @@ static irqreturn_t ssp_int(int irq, void *dev_id)
 	if (!(status & mask))
 		return IRQ_NONE;
 
+#ifdef CONFIG_X86_INTEL_QUARK
+	mask_pvm(drv_data->ssp->pcidev);
+#endif
+
 	if (!drv_data->cur_msg) {
 
 		write_SSCR0(read_SSCR0(reg) & ~SSCR0_SSE, reg);
@@ -730,7 +738,11 @@ static irqreturn_t ssp_int(int irq, void *dev_id)
 		return IRQ_HANDLED;
 	}
 
-	return drv_data->transfer_handler(drv_data);
+	ret = drv_data->transfer_handler(drv_data);
+#ifdef CONFIG_X86_INTEL_QUARK
+	unmask_pvm(drv_data->ssp->pcidev);
+#endif
+	return ret;
 }
 
 /*
diff --git a/include/linux/pxa2xx_ssp.h b/include/linux/pxa2xx_ssp.h
index 671248c..95f443d 100644
--- a/include/linux/pxa2xx_ssp.h
+++ b/include/linux/pxa2xx_ssp.h
@@ -212,6 +212,7 @@ struct ssp_device {
 	int		irq;
 	int		drcmr_rx;
 	int		drcmr_tx;
+	struct pci_dev  *pcidev;
 
 	struct device_node	*of_node;
 };
-- 
1.7.5.4

