From 348dc2b484828f82c9927f5a5de63b30885a8a13 Mon Sep 17 00:00:00 2001
From: Lans Zhang <jia.zhang@windriver.com>
Date: Sun, 11 Jan 2015 16:51:30 +0800
Subject: [PATCH 3/3] spi-pxa2xx: enable MSI support and fix detection
 failure.

Use PCI function as port_id to identify SPI master instead for Quark
SoC specific.

Signed-off-by: Lans Zhang <jia.zhang@windriver.com>
---
 drivers/spi/spi-pxa2xx-pci.c |   25 +++++++++++++++++++++++--
 drivers/spi/spi-pxa2xx.c     |   14 +++++++++++++-
 include/linux/pxa2xx_ssp.h   |    1 +
 3 files changed, 37 insertions(+), 3 deletions(-)

diff --git a/drivers/spi/spi-pxa2xx-pci.c b/drivers/spi/spi-pxa2xx-pci.c
index 9f22924..75339ff 100644
--- a/drivers/spi/spi-pxa2xx-pci.c
+++ b/drivers/spi/spi-pxa2xx-pci.c
@@ -31,6 +31,14 @@ struct pxa_spi_info {
 #endif
 };
 
+#ifdef CONFIG_INTEL_QUARK_X1000_SOC
+static int enable_msi = 1;
+#else
+static int enable_msi;
+#endif
+module_param(enable_msi, int, S_IRUGO | S_IWUSR);
+MODULE_PARM_DESC(enable_msi, "Enable PCI MSI mode");
+
 static struct pxa_spi_info spi_info_configs[] = {
 	[PORT_CE4100] = {
 		.type = PXA25x_SSP,
@@ -59,7 +67,7 @@ static struct pxa_spi_info spi_info_configs[] = {
 	[PORT_QUARK_X1000] = {
 		.type = QUARK_X1000_SSP,
 		.port_id = -1,
-		.num_chipselect = 1,
+		.num_chipselect = 4,
 #ifdef CONFIG_COMMON_CLK
 		.max_clk_rate = 50000000,
 #endif
@@ -99,14 +107,27 @@ static int pxa2xx_spi_pci_probe(struct pci_dev *dev,
 	spi_pdata.enable_dma = c->rx_slave_id >= 0 && c->tx_slave_id >= 0;
 
 	ssp = &spi_pdata.ssp;
+	ssp->pcidev = dev;
 	ssp->phys_base = pci_resource_start(dev, 0);
 	ssp->mmio_base = pcim_iomap_table(dev)[0];
 	if (!ssp->mmio_base) {
 		dev_err(&dev->dev, "failed to ioremap() registers\n");
 		return -EIO;
 	}
+
+	pci_set_master(dev);
+	if (enable_msi == 1) {
+		ret = pci_enable_msi(dev);
+		if (ret) {
+			dev_dbg(&dev->dev, "failed to allocate MSI entry\n");
+		}
+	}
+
 	ssp->irq = dev->irq;
-	ssp->port_id = (c->port_id >= 0) ? c->port_id : dev->devfn;
+	if (c->type != QUARK_X1000_SSP)
+		ssp->port_id = (c->port_id >= 0) ? c->port_id : dev->devfn;
+	else
+		ssp->port_id = PCI_FUNC(dev->devfn);
 	ssp->type = c->type;
 
 #ifdef CONFIG_COMMON_CLK
diff --git a/drivers/spi/spi-pxa2xx.c b/drivers/spi/spi-pxa2xx.c
index db4c7e2..2d2cfd7 100644
--- a/drivers/spi/spi-pxa2xx.c
+++ b/drivers/spi/spi-pxa2xx.c
@@ -38,6 +38,9 @@
 #include <asm/io.h>
 #include <asm/irq.h>
 #include <asm/delay.h>
+#ifdef CONFIG_INTEL_QUARK_X1000_SOC
+#include <asm/qrk.h>
+#endif
 
 #include "spi-pxa2xx.h"
 
@@ -686,6 +689,7 @@ static irqreturn_t ssp_int(int irq, void *dev_id)
 	u32 sccr1_reg;
 	u32 mask = drv_data->mask_sr;
 	u32 status;
+	irqreturn_t ret;
 
 	/*
 	 * The IRQ might be shared with other peripherals so we must first
@@ -706,6 +710,10 @@ static irqreturn_t ssp_int(int irq, void *dev_id)
 	if (!(status & mask))
 		return IRQ_NONE;
 
+#ifdef CONFIG_INTEL_QUARK_X1000_SOC
+	mask_pvm(drv_data->ssp->pcidev);
+#endif
+
 	if (!drv_data->cur_msg) {
 
 		write_SSCR0(read_SSCR0(reg) & ~SSCR0_SSE, reg);
@@ -721,7 +729,11 @@ static irqreturn_t ssp_int(int irq, void *dev_id)
 		return IRQ_HANDLED;
 	}
 
-	return drv_data->transfer_handler(drv_data);
+	ret = drv_data->transfer_handler(drv_data);
+#ifdef CONFIG_INTEL_QUARK_X1000_SOC
+	unmask_pvm(drv_data->ssp->pcidev);
+#endif
+	return ret;
 }
 
 /*
diff --git a/include/linux/pxa2xx_ssp.h b/include/linux/pxa2xx_ssp.h
index afb8507..b2cd28d 100644
--- a/include/linux/pxa2xx_ssp.h
+++ b/include/linux/pxa2xx_ssp.h
@@ -210,6 +210,7 @@ struct ssp_device {
 	int		irq;
 	int		drcmr_rx;
 	int		drcmr_tx;
+	struct pci_dev	*pcidev;
 };
 
 /**
-- 
1.7.5.4

