From 73d6efe12b5808197c562ae54981b2d16c8cb28f Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Mon, 10 Sep 2012 15:48:22 +0800
Subject: [PATCH 1/2] net/acp: set the correct value for advertise register
 before autoneg

The FEMAC provides a 10/100 Ethernet MAC. But in the current driver
the advertise register is always set to 0x61 (10M full/half duplex),
so the NIC can only work in 10M speed. Set the correct value for
advertise register to fix this issue.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/lsi/acp/net.c |   11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/drivers/lsi/acp/net.c b/drivers/lsi/acp/net.c
index a4007f6..7f5aa35 100644
--- a/drivers/lsi/acp/net.c
+++ b/drivers/lsi/acp/net.c
@@ -1969,7 +1969,6 @@ phy_renegotiate_( int phy )
 	int autoneg_complete_retries = 8;
 
 	printk( "Initiating Auto Negotiation" );
-	phy_write_( phy, PHY_AUTONEG_ADVERTISE, 0x61 );
 
 	do {
 		phy_read_( phy, PHY_CONTROL, & control.raw );
@@ -2010,7 +2009,17 @@ extern int ubootenv_get( const char *, char * );
 static int phy_enable_( int phy ) {
 
 #ifdef CONFIG_ACP
+  unsigned short ad_value;
   phy_address_ = 0x1e;
+
+  ad_value = PHY_AUTONEG_ADVERTISE_100FULL |
+		PHY_AUTONEG_ADVERTISE_100 |
+		PHY_AUTONEG_ADVERTISE_10FULL |
+		PHY_AUTONEG_ADVERTISE_10;
+
+  if (0 != phy_write_(phy_address_, PHY_AUTONEG_ADVERTISE, ad_value))
+		return -1;
+
   phy_renegotiate_( phy_address_ );
 #else
   /*
-- 
1.7.9.7

