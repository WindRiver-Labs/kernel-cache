From 3c4ab50d49b932f8865a39de69ed5e1856c7dab8 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Thu, 3 May 2012 17:08:02 +0800
Subject: [PATCH 02/11] powerpc/476: add X2 DD2 core support

Extracted from ibm.patch in lsi_acp_linux_3.8.1.28 tarball.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/include/asm/reg.h |    1 +
 arch/powerpc/kernel/cputable.c |   14 ++++++++++++++
 arch/powerpc/kernel/head_44x.S |    3 +++
 3 files changed, 18 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/reg.h b/arch/powerpc/include/asm/reg.h
index 9d7f0fb..713f88f 100644
--- a/arch/powerpc/include/asm/reg.h
+++ b/arch/powerpc/include/asm/reg.h
@@ -957,6 +957,7 @@
 #define PVR_405GP	0x40110000
 #define PVR_476		0x11a52000
 #define PVR_476FPE	0x7ff50000
+#define PVR_476X2	0x11b22080
 #define PVR_STB03XXX	0x40310000
 #define PVR_NP405H	0x41410000
 #define PVR_NP405L	0x41610000
diff --git a/arch/powerpc/kernel/cputable.c b/arch/powerpc/kernel/cputable.c
index 455faa3..70541ce 100644
--- a/arch/powerpc/kernel/cputable.c
+++ b/arch/powerpc/kernel/cputable.c
@@ -1872,6 +1872,20 @@ static struct cpu_spec __initdata cpu_specs[] = {
 		.machine_check		= machine_check_47x,
 		.platform		= "ppc470",
 	},
+	{ /* X2 DD2 core */
+		.pvr_mask		= 0xffffffff,
+		.pvr_value		= 0x11b22080,
+		.cpu_name		= "476",
+		.cpu_features		= CPU_FTRS_47X | CPU_FTR_476_DD2,
+		.cpu_user_features	= COMMON_USER_BOOKE |
+			PPC_FEATURE_HAS_FPU,
+		.mmu_features		= MMU_FTR_TYPE_47x |
+			MMU_FTR_USE_TLBIVAX_BCAST | MMU_FTR_LOCK_BCAST_INVAL,
+		.icache_bsize		= 32,
+		.dcache_bsize		= 128,
+		.machine_check		= machine_check_47x,
+		.platform		= "ppc470",
+	},
 	{ /* 476 others */
 		.pvr_mask		= 0xffff0000,
 		.pvr_value		= 0x11a50000,
diff --git a/arch/powerpc/kernel/head_44x.S b/arch/powerpc/kernel/head_44x.S
index 4aa3bd3..d1b0e79 100644
--- a/arch/powerpc/kernel/head_44x.S
+++ b/arch/powerpc/kernel/head_44x.S
@@ -824,6 +824,9 @@ _GLOBAL(init_cpu_state)
 	/* We use the PVR to differenciate 44x cores from 476 */
 	mfspr	r3,SPRN_PVR
 	srwi	r3,r3,16
+	/* Some X2 chips had a PVR that doesn't conform to the standard */
+	cmplwi	cr0,r3,PVR_476X2@h
+	beq	head_start_47x
 	cmplwi	cr0,r3,PVR_476FPE@h
 	beq	head_start_47x
 	cmplwi	cr0,r3,PVR_476@h
-- 
1.7.0.4

