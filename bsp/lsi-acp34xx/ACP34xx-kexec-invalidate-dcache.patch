From d45c6451dbb7f9b49d88a5b8c8983a347ba76b66 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Thu, 7 Feb 2013 12:35:29 +0800
Subject: [PATCH] ACP34xx/kexec: invalidate dcache

When performing kexec, default_machine_kexec() for PPC32 kernel
flush dcache & icache before jumping to reboot code with
flush_icache_range().

flush_icache_range invoke dcbst instruction to flush dcache, While
flush_dcache_range() invoke dcbf to flush dcache.

According IBM's document, dcbst allows program to copy the contents
of a modified block to main memory, dcbf copies modified cache
blocks to main storage and invalidates the copy in the data cache.

On ACP34xx, we have to invoke flush_dcache_range() to invalidate
dcache on reboot code area before flush icache, or system may hang
when booting second kernel.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/kernel/machine_kexec_32.c |    5 +++++
 arch/powerpc/platforms/44x/acpx1.c     |    6 ++++++
 2 files changed, 11 insertions(+)

diff --git a/arch/powerpc/kernel/machine_kexec_32.c b/arch/powerpc/kernel/machine_kexec_32.c
index affe5dc..0975e9a 100644
--- a/arch/powerpc/kernel/machine_kexec_32.c
+++ b/arch/powerpc/kernel/machine_kexec_32.c
@@ -16,6 +16,9 @@
 #include <asm/hw_irq.h>
 #include <asm/io.h>
 
+extern __attribute__((weak)) void flush_kexec_code_buffer
+	(unsigned long code_buffer);
+
 typedef void (*relocate_new_kernel_t)(
 				unsigned long indirection_page,
 				unsigned long reboot_code_buffer,
@@ -54,6 +57,8 @@ void default_machine_kexec(struct kimage *image)
 	memcpy((void *)reboot_code_buffer, relocate_new_kernel,
 						relocate_new_kernel_size);
 
+	flush_kexec_code_buffer(reboot_code_buffer);
+
 	flush_icache_range(reboot_code_buffer,
 				reboot_code_buffer + KEXEC_CONTROL_PAGE_SIZE);
 	printk(KERN_INFO "Bye!\n");
diff --git a/arch/powerpc/platforms/44x/acpx1.c b/arch/powerpc/platforms/44x/acpx1.c
index 28b421b..1820576 100644
--- a/arch/powerpc/platforms/44x/acpx1.c
+++ b/arch/powerpc/platforms/44x/acpx1.c
@@ -171,6 +171,12 @@ static void smp_acpx14xx_machine_kexec(struct kimage *image)
 
 	default_machine_kexec(image);
 }
+
+void flush_kexec_code_buffer(unsigned long code_buffer)
+{
+	flush_dcache_range(code_buffer,
+		code_buffer + KEXEC_CONTROL_PAGE_SIZE);
+}
 #endif /* CONFIG_KEXEC */
 
 static void __cpuinit smp_acpx14xx_setup_cpu(int cpu)
-- 
1.7.9.7

