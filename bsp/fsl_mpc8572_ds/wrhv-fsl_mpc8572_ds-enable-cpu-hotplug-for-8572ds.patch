From 7e021581973ba64c8f086e2cd08e9afa6dd38ab6 Mon Sep 17 00:00:00 2001
From: Liang Li <liang.li@windriver.com>
Date: Tue, 27 Jul 2010 11:17:57 +0800
Subject: [PATCH] wrhv/fsl_mpc8572_ds: enable cpu hotplug for 8572ds

o add cpu_die member for platform ops to enable cpu hotplug
o setup proper msr for 8572ds when bring up APs

Signed-off-by: Liang Li <liang.li@windriver.com>
---
 arch/powerpc/platforms/85xx/wrhv_8572ds.c |   21 ++++++++++++++++++++-
 1 files changed, 20 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/wrhv_8572ds.c b/arch/powerpc/platforms/85xx/wrhv_8572ds.c
index 8efdf08..eebf4b2 100644
--- a/arch/powerpc/platforms/85xx/wrhv_8572ds.c
+++ b/arch/powerpc/platforms/85xx/wrhv_8572ds.c
@@ -222,6 +222,22 @@ static int __init p2020_ds_probe(void)
 	return 0;
 }
 
+#ifdef CONFIG_HOTPLUG_CPU
+void wrhv_setup_msr_for_ap(VBI_HREG_SET_CMPLX_QUALIFIED *regs)
+{
+	/*
+	 * The MSR value depends on hypervisor's preparation for us.
+	 * Hypervisor just has one tlb entry in TLB0 with TS == 1 for GOS
+	 * when AP starts from entry point of GOS, aka '_start'. So we
+	 * need to have IS and DS to be '1'. Then it is also well known
+	 * that GOS on e500 is running in 'user mode' and interrupts
+	 * are enabled on hardware hence CE | ME | EE.
+	 */
+	regs->vbiRegSet.hreg32.msr =
+		MSR_CE | MSR_EE | MSR_PR | MSR_ME | MSR_IS | MSR_DS;
+}
+#endif
+
 define_machine(mpc8544_ds) {
 	.name			= "MPC8544 DS",
 	.probe			= mpc8544_ds_probe,
@@ -237,7 +253,7 @@ define_machine(mpc8544_ds) {
 };
 
 define_machine(mpc8572_ds) {
-	.name			= "WHRV MPC8572 DS",
+	.name			= "Wind River Hypervisor MPC8572 DS",
 	.probe			= mpc8572_ds_probe,
 	.setup_arch		= mpc85xx_ds_setup_arch,
 	.init_IRQ		= wrhv_mpc85xx_pic_init,
@@ -254,6 +270,9 @@ define_machine(mpc8572_ds) {
 	.progress		= udbg_progress,
 	.earlycon_setup		= wrhv_earlycon_setup,
 	.power_save		= wrhv_power_save,
+#ifdef CONFIG_HOTPLUG_CPU
+	.cpu_die        = cpu_die,
+#endif
 };
 
 define_machine(p2020_ds) {
-- 
1.6.5.2

