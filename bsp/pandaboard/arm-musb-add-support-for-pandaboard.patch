From 9beb839b005704d87f17e65ca6bc064ef55ce064 Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Tue, 28 Jun 2011 11:17:54 +0800
Subject: [PATCH 015/108] arm/musb: add support for pandaboard

picked from git://gitorious.org/pandroid/kernel-omap.git
commits:
e0fd716513829f693c877d9036ed35a2a5a35f12
c0f6ea843e79faa2253328a021dade68e3448d58
83a58f8ed891c1b5826a8c342e3167b5e7b2aa9f

Integrate three commits into one.

Signed-off-by: Jingdong Lu <jingdong.lu@windriver.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/usb/musb/musb_core.c |   75 +++++++++++++++++++++++++++++++++++++++++-
 1 files changed, 74 insertions(+), 1 deletions(-)

diff --git a/drivers/usb/musb/musb_core.c b/drivers/usb/musb/musb_core.c
index 826485b..fbb3603 100644
--- a/drivers/usb/musb/musb_core.c
+++ b/drivers/usb/musb/musb_core.c
@@ -98,6 +98,7 @@
 #include <linux/kobject.h>
 #include <linux/platform_device.h>
 #include <linux/io.h>
+#include <linux/i2c/twl.h>
 
 #ifdef	CONFIG_ARM
 #include <mach/hardware.h>
@@ -755,7 +756,9 @@ b_host:
 			musb->xceiv->state = OTG_STATE_B_HOST;
 			hcd->self.is_b_host = 1;
 			musb->ignore_disconnect = 0;
+#ifdef CONFIG_USB_MUSB_OTG
 			del_timer(&musb->otg_timer);
+#endif
 			break;
 		default:
 			if ((devctl & MUSB_DEVCTL_VBUS)
@@ -864,12 +867,16 @@ b_host:
 				DBG(1, "HNP: in %s, %d msec timeout\n",
 						otg_state_string(musb),
 						TA_WAIT_BCON(musb));
+#ifdef CONFIG_USB_MUSB_OTG
 				mod_timer(&musb->otg_timer, jiffies
 					+ msecs_to_jiffies(TA_WAIT_BCON(musb)));
+#endif
 				break;
 			case OTG_STATE_A_PERIPHERAL:
 				musb->ignore_disconnect = 0;
+#ifdef CONFIG_USB_MUSB_OTG
 				del_timer(&musb->otg_timer);
+#endif
 				musb_g_reset(musb);
 				break;
 			case OTG_STATE_B_WAIT_ACON:
@@ -1942,6 +1949,15 @@ static void musb_free(struct musb *musb)
 #endif
 }
 
+#define VUSB_CFG_STATE                  0x72
+#define MISC2                           0xE5
+#define CFG_LDO_PD2                     0xF5
+#define VUSB_CFG_VOLTAGE                0x73
+#define VUSB_CFG_TRANS                  0x71
+#define USB_VBUS_CTRL_SET               0x4
+#define USB_ID_CTRL_SET                 0x6
+#define CHARGERUSB_CTRL1                0x8
+
 /*
  * Perform generic per-controller initialization.
  *
@@ -1969,12 +1985,56 @@ musb_init_controller(struct device *dev, int nIrq, void __iomem *ctrl)
 	switch (plat->mode) {
 	case MUSB_HOST:
 #ifdef CONFIG_USB_MUSB_HDRC_HCD
+        if (cpu_is_omap44xx()) {
+                /* Program CFG_LDO_PD2 register and set VUSB bit */
+                twl_i2c_write_u8(TWL6030_MODULE_ID0 , 0x1, CFG_LDO_PD2);
+
+                /* Program MISC2 register and set bit VUSB_IN_VBAT */
+                twl_i2c_write_u8(TWL6030_MODULE_ID0 , 0x10, MISC2);
+
+                /*
+                 * Program the VUSB_CFG_VOLTAGE register to set the VUSB
+                 * voltage to 3.3V
+                 */
+                twl_i2c_write_u8(TWL_MODULE_PM_RECEIVER, 0x18,
+                                                VUSB_CFG_VOLTAGE);
+
+                /* Program the VUSB_CFG_TRANS for ACTIVE state. */
+                twl_i2c_write_u8(TWL_MODULE_PM_RECEIVER, 0x3F,
+                                        VUSB_CFG_TRANS);
+
+                /* Program the VUSB_CFG_STATE register to ON on all groups. */
+                twl_i2c_write_u8(TWL_MODULE_PM_RECEIVER, 0xE1,
+                                        VUSB_CFG_STATE);
+
+                /* Program the USB_VBUS_CTRL_SET and set VBUS_ACT_COMP bit */
+                twl_i2c_write_u8(TWL_MODULE_USB, 0x4, USB_VBUS_CTRL_SET);
+
+                /*
+                 * Program the USB_ID_CTRL_SET register to enable GND drive
+                 * and the ID comparators
+                 */
+                twl_i2c_write_u8(TWL_MODULE_USB, 0x24, USB_ID_CTRL_SET);
+
+                /* Enable VBUS Valid, BValid, AValid. Clear SESSEND.*/
+                omap_writel(0x00000005, 0x4A00233C);
+
+        }
 		break;
 #else
 		goto bad_config;
 #endif
 	case MUSB_PERIPHERAL:
 #ifdef CONFIG_USB_GADGET_MUSB_HDRC
+		/* FIXME */
+		/* TODO:- Phoenix Settings to be done from Phoenix Layer */
+		if (cpu_is_omap44xx()) {
+			twl_i2c_write_u8(TWL_MODULE_PM_RECEIVER, 0x21,
+					VUSB_CFG_STATE);
+			twl_i2c_write_u8(TWL6030_MODULE_ID0 , 0x10,
+					MISC2);
+			omap_writel(0x00000015, 0x4A00233C);
+		}
 		break;
 #else
 		goto bad_config;
@@ -2158,7 +2218,6 @@ bad_config:
 	if (status)
 		goto fail5;
 #endif
-
 	dev_info(dev, "USB %s mode controller at %p using %s, IRQ %d\n",
 			({char *s;
 			 switch (musb->board_mode) {
@@ -2171,6 +2230,20 @@ bad_config:
 			? "DMA" : "PIO",
 			musb->nIrq);
 
+#ifdef CONFIG_USB_MUSB_HDRC_HCD
+        if (cpu_is_omap44xx()) {
+                /* Delay supply of VBUS. This fixes bootup enumeration issue */
+                mdelay(500);
+
+                /*
+                 * Start driving VBUS. Set OPA_MODE bit in CHARGERUSB_CTRL1
+                 * register. This enables boost mode.
+                 */
+                twl_i2c_write_u8(TWL_MODULE_MAIN_CHARGE , 0x40,
+                                                CHARGERUSB_CTRL1);
+        }
+#endif
+
 	return 0;
 
 fail5:
-- 
1.7.4.1

