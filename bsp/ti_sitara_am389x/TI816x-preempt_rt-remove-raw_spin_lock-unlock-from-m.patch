From 156e67638d548ec70b98b2ead3fc6f88182078b4 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Tue, 5 Jul 2011 11:26:10 +0800
Subject: [PATCH 03/13] TI816x preempt_rt: remove raw_spin_lock/unlock from musb_giveback

We can't call raw_spin_lock/unlock in musb_giveback, otherwise there
are lots of calltrace and usb host can't work well.

WARNING: at /buildarea/gjiang/am389x-git-tree-preempt_rt/build/linux/kernel/sched.c:3707 musb_giveback+0xd8/0x128()
Modules linked in:
[<c003a988>] (unwind_backtrace+0x0/0xe4) from [<c005a51c>] (warn_slowpath_common+0x48/0x60)
[<c005a51c>] (warn_slowpath_common+0x48/0x60) from [<c031b7e4>] (musb_giveback+0xd8/0x128)
[<c031b7e4>] (musb_giveback+0xd8/0x128) from [<c031b910>] (musb_advance_schedule+0xdc/0x22c)
[<c031b910>] (musb_advance_schedule+0xdc/0x22c) from [<c031d8c8>] (musb_h_ep0_irq+0x458/0x4a8)
[<c031d8c8>] (musb_h_ep0_irq+0x458/0x4a8) from [<c0318fb8>] (musb_interrupt+0x58c/0x7fc)
[<c0318fb8>] (musb_interrupt+0x58c/0x7fc) from [<c0319db4>] (ti816x_interrupt+0x234/0x2ec)
[<c0319db4>] (ti816x_interrupt+0x234/0x2ec) from [<c00a4a60>] (irq_thread+0xc0/0x20c)
[<c00a4a60>] (irq_thread+0xc0/0x20c) from [<c0075208>] (kthread+0x7c/0x84)
[<c0075208>] (kthread+0x7c/0x84) from [<c0035098>] (kernel_thread_exit+0x0/0x8)
---[ end trace 7f770c8dc30afcf3 ]---
BUG: scheduling while atomic: irq/18-musb_hdr/0x00000001/34, CPU#0
Modules linked in:
[<c003a988>] (unwind_backtrace+0x0/0xe4) from [<c04387a4>] (__schedule+0x5c/0x3fc)
[<c04387a4>] (__schedule+0x5c/0x3fc) from [<c0438c60>] (schedule+0x20/0x38)
[<c0438c60>] (schedule+0x20/0x38) from [<c00a4b60>] (irq_thread+0x1c0/0x20c)
[<c00a4b60>] (irq_thread+0x1c0/0x20c) from [<c0075208>] (kthread+0x7c/0x84)
[<c0075208>] (kthread+0x7c/0x84) from [<c0035098>] (kernel_thread_exit+0x0/0x8)
BUG: scheduling while atomic: irq/18-musb_hdr/0x00000001/34, CPU#0
Modules linked in:
[<c003a988>] (unwind_backtrace+0x0/0xe4) from [<c04387a4>] (__schedule+0x5c/0x3fc)
[<c04387a4>] (__schedule+0x5c/0x3fc) from [<c0438c60>] (schedule+0x20/0x38)
[<c0438c60>] (schedule+0x20/0x38) from [<c00a4b60>] (irq_thread+0x1c0/0x20c)
[<c00a4b60>] (irq_thread+0x1c0/0x20c) from [<c0075208>] (kthread+0x7c/0x84)
[<c0075208>] (kthread+0x7c/0x84) from [<c0035098>] (kernel_thread_exit+0x0/0x8)

Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 drivers/usb/musb/musb_host.c |    2 --
 1 files changed, 0 insertions(+), 2 deletions(-)

diff --git a/drivers/usb/musb/musb_host.c b/drivers/usb/musb/musb_host.c
index a97bc82..78f0a33 100644
--- a/drivers/usb/musb/musb_host.c
+++ b/drivers/usb/musb/musb_host.c
@@ -360,9 +360,7 @@ __acquires(musb->lock)
 			);
 
 	usb_hcd_unlink_urb_from_ep(musb_to_hcd(musb), urb);
-	raw_spin_unlock(&musb->lock);
 	usb_hcd_giveback_urb(musb_to_hcd(musb), urb, status);
-	raw_spin_lock(&musb->lock);
 }
 
 void free_queue(struct musb *musb)
-- 
1.7.0.4

