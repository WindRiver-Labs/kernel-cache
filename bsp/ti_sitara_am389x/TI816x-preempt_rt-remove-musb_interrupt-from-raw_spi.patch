From f5d7ef8ad118ba468fba0e9d0fc20d874f8cbce4 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Mon, 4 Jul 2011 17:41:27 +0800
Subject: [PATCH 07/13] TI816x preempt_rt: remove musb_interrupt from raw_spin_lock/unlock

Spin_lock is sleepable in rt kernel, if we call it in an atomic and
irq_disabled context then calltrace appears. The following paths will
cause calltrace if we call musb_interrupt between raw_spin_lock_irqsave
and raw_spin_unlock_irqrestore.

BUG: sleeping function called from invalid context at /buildarea/gjiang/am389x-git-tree-preempt_rt/build/linux/kernel/rtmutex.c:707
pcnt: 1 0 in_atomic(): 1, irqs_disabled(): 128, pid: 34, name: irq/18-musb_hdr
[<c003a988>] (unwind_backtrace+0x0/0xe4) from [<c043a714>] (rt_spin_lock+0x30/0x5c)
[<c043a714>] (rt_spin_lock+0x30/0x5c) from [<c0309eb4>] (usb_hcd_poll_rh_status+0x50/0x130)
[<c0309eb4>] (usb_hcd_poll_rh_status+0x50/0x130) from [<c0318e18>] (musb_interrupt+0x3ec/0x7fc)
[<c0318e18>] (musb_interrupt+0x3ec/0x7fc) from [<c0319d74>] (ti816x_interrupt+0x1f4/0x294)
[<c0319d74>] (ti816x_interrupt+0x1f4/0x294) from [<c00a4a60>] (irq_thread+0xc0/0x20c)
[<c00a4a60>] (irq_thread+0xc0/0x20c) from [<c0075208>] (kthread+0x7c/0x84)
[<c0075208>] (kthread+0x7c/0x84) from [<c0035098>] (kernel_thread_exit+0x0/0x8)

Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 drivers/usb/musb/ti816x.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/musb/ti816x.c b/drivers/usb/musb/ti816x.c
index b13bb36..1bf0e8a 100644
--- a/drivers/usb/musb/ti816x.c
+++ b/drivers/usb/musb/ti816x.c
@@ -1010,7 +1010,9 @@ static irqreturn_t ti816x_interrupt(int irq, void *hci)
 
 	if (musb->int_tx || musb->int_rx || musb->int_usb) {
 		irqreturn_t mret;
+		raw_spin_unlock_irqrestore(&musb->lock, flags);
 		mret = musb_interrupt(musb);
+		raw_spin_lock_irqsave(&musb->lock, flags);
 		if (mret == IRQ_HANDLED)
 			ret = IRQ_HANDLED;
 	}
-- 
1.7.0.4

