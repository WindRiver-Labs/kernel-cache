From af4ead1afe3bba0b695ba200264c81330de020a6 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Tue, 5 Jul 2011 10:12:53 +0800
Subject: [PATCH 10/13] TI816x preempt_rt: avoid potential calltrace when call usb_hcd_unlink_urb_from_ep with raw lock

Avoid potential calltrace when call usb_hcd_unlink_urb_from_ep
with raw_spin_lock_irqsave and raw_spin_unlock_irqrestore, since
in usb_hcd_unlink_urb_from_ep, it invokes spin_lock and spin_unlock.

Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 drivers/usb/musb/musb_host.c |    4 ----
 1 files changed, 0 insertions(+), 4 deletions(-)

diff --git a/drivers/usb/musb/musb_host.c b/drivers/usb/musb/musb_host.c
index 76509d3..a70c3e0 100644
--- a/drivers/usb/musb/musb_host.c
+++ b/drivers/usb/musb/musb_host.c
@@ -2007,9 +2007,7 @@ static int musb_urb_enqueue(
 	 */
 	qh = kzalloc(sizeof *qh, mem_flags);
 	if (!qh) {
-		raw_spin_lock_irqsave(&musb->lock, flags);
 		usb_hcd_unlink_urb_from_ep(hcd, urb);
-		raw_spin_unlock_irqrestore(&musb->lock, flags);
 		return -ENOMEM;
 	}
 
@@ -2138,9 +2136,7 @@ static int musb_urb_enqueue(
 
 done:
 	if (ret != 0) {
-		raw_spin_lock_irqsave(&musb->lock, flags);
 		usb_hcd_unlink_urb_from_ep(hcd, urb);
-		raw_spin_unlock_irqrestore(&musb->lock, flags);
 		kfree(qh);
 	}
 	return ret;
-- 
1.7.0.4

