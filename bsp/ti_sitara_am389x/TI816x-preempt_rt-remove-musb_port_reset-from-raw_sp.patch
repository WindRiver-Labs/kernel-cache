From 0f1fdf376723d26ad0e92a4e4ff1fe65fc58f07b Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Mon, 4 Jul 2011 17:17:02 +0800
Subject: [PATCH 05/13] TI816x preempt_rt: remove musb_port_reset from raw_spin_lock/unlock

Spin_lock is sleepable in rt kernel, if we call it in an atomic and
irq_disabled context then calltrace appears. The following paths will
cause calltrace if we call musb_port_reset  between raw_spin_lock_irqsave
and raw_spin_unlock_irqrestore.

BUG: sleeping function called from invalid context at /buildarea/gjiang/am389x-git-tree-preempt_rt/build/linux/kernel/rtmutex.c:707
pcnt: 1 0 in_atomic(): 1, irqs_disabled(): 128, pid: 29, name: khubd
[<c003a988>] (unwind_backtrace+0x0/0xe4) from [<c043a5c4>] (rt_spin_lock+0x30/0x5c)
[<c043a5c4>] (rt_spin_lock+0x30/0x5c) from [<c0309eb4>] (usb_hcd_poll_rh_status+0x50/0x130)
[<c0309eb4>] (usb_hcd_poll_rh_status+0x50/0x130) from [<c031a264>] (musb_port_reset+0x150/0x174)
[<c031a264>] (musb_port_reset+0x150/0x174) from [<c031a608>] (musb_hub_control+0x204/0x440)
[<c031a608>] (musb_hub_control+0x204/0x440) from [<c030aa58>] (usb_hcd_submit_urb+0x3fc/0x794)
[<c030aa58>] (usb_hcd_submit_urb+0x3fc/0x794) from [<c030c4f8>] (usb_start_wait_urb+0x40/0xac)
[<c030c4f8>] (usb_start_wait_urb+0x40/0xac) from [<c030c7c4>] (usb_control_msg+0x164/0x190)
[<c030c7c4>] (usb_control_msg+0x164/0x190) from [<c0305480>] (hub_port_status+0x78/0x118)
[<c0305480>] (hub_port_status+0x78/0x118) from [<c0305be4>] (hub_port_reset+0x90/0x230)
[<c0305be4>] (hub_port_reset+0x90/0x230) from [<c03066a0>] (hub_port_init+0x98/0x720)
[<c03066a0>] (hub_port_init+0x98/0x720) from [<c0307f44>] (hub_thread+0x6fc/0xda4)
[<c0307f44>] (hub_thread+0x6fc/0xda4) from [<c0075208>] (kthread+0x7c/0x84)
[<c0075208>] (kthread+0x7c/0x84) from [<c0035098>] (kernel_thread_exit+0x0/0x8)

Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 drivers/usb/musb/musb_virthub.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/musb/musb_virthub.c b/drivers/usb/musb/musb_virthub.c
index f1be381..90203d2 100644
--- a/drivers/usb/musb/musb_virthub.c
+++ b/drivers/usb/musb/musb_virthub.c
@@ -304,10 +304,12 @@ int musb_hub_control(
 		if (wIndex != 1)
 			goto error;
 
+		raw_spin_unlock_irqrestore(&musb->lock, flags);
 		/* finish RESET signaling? */
 		if ((musb->port1_status & USB_PORT_STAT_RESET)
 				&& time_after_eq(jiffies, musb->rh_timer))
 			musb_port_reset(musb, false);
+		raw_spin_lock_irqsave(&musb->lock, flags);
 
 		/* finish RESUME signaling? */
 		if ((musb->port1_status & MUSB_PORT_STAT_RESUME)
@@ -362,7 +364,9 @@ int musb_hub_control(
 				musb_start(musb);
 			break;
 		case USB_PORT_FEAT_RESET:
+			raw_spin_unlock_irqrestore(&musb->lock, flags);
 			musb_port_reset(musb, true);
+			raw_spin_lock_irqsave(&musb->lock, flags);
 			break;
 		case USB_PORT_FEAT_SUSPEND:
 			musb_port_suspend(musb, true);
-- 
1.7.0.4

