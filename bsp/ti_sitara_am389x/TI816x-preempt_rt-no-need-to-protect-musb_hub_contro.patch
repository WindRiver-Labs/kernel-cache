From 992aeae88026b57a6a293617867580a5740cab74 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Tue, 5 Jul 2011 11:49:48 +0800
Subject: [PATCH 11/13] TI816x preempt_rt: no need to protect musb_hub_control with raw_spin_lock_irqsave/raw_spin_unlock_irqrestore

musb_hub_control can be call with enable preempt, and to avoid latency
issue, we should remove raw_spin_lock_irqsave/raw_spin_unlock_irqrestore
in musb_hub_control since it is a long path between the lock.

Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 drivers/usb/musb/musb_virthub.c |    9 ---------
 1 files changed, 0 insertions(+), 9 deletions(-)

diff --git a/drivers/usb/musb/musb_virthub.c b/drivers/usb/musb/musb_virthub.c
index 90203d2..5dc6a63 100644
--- a/drivers/usb/musb/musb_virthub.c
+++ b/drivers/usb/musb/musb_virthub.c
@@ -227,12 +227,8 @@ int musb_hub_control(
 	struct musb	*musb = hcd_to_musb(hcd);
 	u32		temp;
 	int		retval = 0;
-	unsigned long	flags;
-
-	raw_spin_lock_irqsave(&musb->lock, flags);
 
 	if (unlikely(!test_bit(HCD_FLAG_HW_ACCESSIBLE, &hcd->flags))) {
-		raw_spin_unlock_irqrestore(&musb->lock, flags);
 		return -ESHUTDOWN;
 	}
 
@@ -304,12 +300,10 @@ int musb_hub_control(
 		if (wIndex != 1)
 			goto error;
 
-		raw_spin_unlock_irqrestore(&musb->lock, flags);
 		/* finish RESET signaling? */
 		if ((musb->port1_status & USB_PORT_STAT_RESET)
 				&& time_after_eq(jiffies, musb->rh_timer))
 			musb_port_reset(musb, false);
-		raw_spin_lock_irqsave(&musb->lock, flags);
 
 		/* finish RESUME signaling? */
 		if ((musb->port1_status & MUSB_PORT_STAT_RESUME)
@@ -364,9 +358,7 @@ int musb_hub_control(
 				musb_start(musb);
 			break;
 		case USB_PORT_FEAT_RESET:
-			raw_spin_unlock_irqrestore(&musb->lock, flags);
 			musb_port_reset(musb, true);
-			raw_spin_lock_irqsave(&musb->lock, flags);
 			break;
 		case USB_PORT_FEAT_SUSPEND:
 			musb_port_suspend(musb, true);
@@ -423,6 +415,5 @@ error:
 		/* "protocol stall" on error */
 		retval = -EPIPE;
 	}
-	raw_spin_unlock_irqrestore(&musb->lock, flags);
 	return retval;
 }
-- 
1.7.0.4

