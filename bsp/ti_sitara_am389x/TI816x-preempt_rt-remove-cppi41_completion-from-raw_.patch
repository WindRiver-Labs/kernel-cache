From 0b2eabe874faa6084eb6da96d0582434630d18a4 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Mon, 4 Jul 2011 17:33:20 +0800
Subject: [PATCH 06/13] TI816x preempt_rt: remove cppi41_completion from raw_spin_lock/unlock

Spin_lock is sleepable in rt kernel, if we call it in an atomic and
irq_disabled context then calltrace appears. The following paths will
cause calltrace if we call musb_port_reset  between raw_spin_lock_irqsave
and raw_spin_unlock_irqrestore.

BUG: scheduling while atomic: irq/17-cppi41_d/0x00000001/33, CPU#0
Modules linked in:
[<c003a988>] (unwind_backtrace+0x0/0xe4) from [<c043867c>] (__schedule+0x5c/0x3fc)
[<c043867c>] (__schedule+0x5c/0x3fc) from [<c0438b38>] (schedule+0x20/0x38)
[<c0438b38>] (schedule+0x20/0x38) from [<c0439c44>] (rt_spin_lock_slowlock+0x180/0x264)
[<c0439c44>] (rt_spin_lock_slowlock+0x180/0x264) from [<c004ee60>] (complete+0x1c/0x54)
[<c004ee60>] (complete+0x1c/0x54) from [<c0309bdc>] (usb_hcd_giveback_urb+0x70/0xb8)
[<c0309bdc>] (usb_hcd_giveback_urb+0x70/0xb8) from [<c031b7e8>] (musb_advance_schedule+0xdc/0x22c)
[<c031b7e8>] (musb_advance_schedule+0xdc/0x22c) from [<c031de68>] (cppi41_completion+0x22c/0x270)
[<c031de68>] (cppi41_completion+0x22c/0x270) from [<c031a09c>] (cppi41dma_Interrupt+0xc4/0x178)
[<c031a09c>] (cppi41dma_Interrupt+0xc4/0x178) from [<c00a4a60>] (irq_thread+0xc0/0x20c)
[<c00a4a60>] (irq_thread+0xc0/0x20c) from [<c0075208>] (kthread+0x7c/0x84)

Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 drivers/usb/musb/ti816x.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/musb/ti816x.c b/drivers/usb/musb/ti816x.c
index 24532da..b13bb36 100644
--- a/drivers/usb/musb/ti816x.c
+++ b/drivers/usb/musb/ti816x.c
@@ -889,6 +889,7 @@ static irqreturn_t cppi41dma_Interrupt(int irq, void *hci)
 
 		DBG(4, "CPPI 4.1 IRQ: Tx %x, Rx %x\n", usb0_tx_intr,
 					usb0_rx_intr);
+		raw_spin_unlock_irqrestore(&musb->lock, flags);
 		if (usb0_tx_intr || usb0_rx_intr) {
 			cppi41_completion(gmusb[0], usb0_rx_intr,
 						usb0_tx_intr);
@@ -902,6 +903,7 @@ static irqreturn_t cppi41dma_Interrupt(int irq, void *hci)
 				usb1_tx_intr);
 			ret = IRQ_HANDLED;
 		}
+		raw_spin_lock_irqsave(&musb->lock, flags);
 		usbss_write(USBSS_IRQ_EOI, 0);
 	}
 	raw_spin_unlock_irqrestore(&musb->lock, flags);
-- 
1.7.0.4

