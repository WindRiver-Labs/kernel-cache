From 41985ea8c99402a770db82a497c4c77bcad97ecf Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyun.kwon@xilinx.com>
Date: Fri, 25 Apr 2014 19:38:40 -0700
Subject: [PATCH 134/290] drm: xilinx: drv: Set bpp and color depth to
 drm_framebuffer

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

The drm crtc helper doesn't set bpp and color depth for non RGB format
drm_framebuffer, and that results in not supporting YUV format planes
properly. This patch fixes and the YUV format drm_framebuffer can be allocated
and used for planes.

Signed-off-by: Hyun Kwon <hyunk@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 6d72b0b1c70740007fea93fc0b55038c7d0ab0f0)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpu/drm/xilinx/xilinx_drm_drv.c | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/xilinx/xilinx_drm_drv.c b/drivers/gpu/drm/xilinx/xilinx_drm_drv.c
index a86bd65..0cc0f96 100644
--- a/drivers/gpu/drm/xilinx/xilinx_drm_drv.c
+++ b/drivers/gpu/drm/xilinx/xilinx_drm_drv.c
@@ -74,12 +74,16 @@ static const struct xilinx_video_format_desc xilinx_video_formats[] = {
 	{ "yuv420", 16, 16, XILINX_VIDEO_FORMAT_YUV420, DRM_FORMAT_YUV420 },
 };
 
+static unsigned int xilinx_drm_format_bpp(uint32_t drm_format);
+static unsigned int xilinx_drm_format_depth(uint32_t drm_format);
+
 /* create a fb */
 static struct drm_framebuffer *
 xilinx_drm_fb_create(struct drm_device *drm, struct drm_file *file_priv,
 		     struct drm_mode_fb_cmd2 *mode_cmd)
 {
 	struct xilinx_drm_private *private = drm->dev_private;
+	struct drm_framebuffer *fb;
 	bool res;
 
 	res = xilinx_drm_crtc_check_format(private->crtc,
@@ -90,7 +94,14 @@ xilinx_drm_fb_create(struct drm_device *drm, struct drm_file *file_priv,
 		return ERR_PTR(-EINVAL);
 	}
 
-	return drm_fb_cma_create(drm, file_priv, mode_cmd);
+	fb = drm_fb_cma_create(drm, file_priv, mode_cmd);
+	if (IS_ERR(fb))
+		return fb;
+
+	fb->bits_per_pixel = xilinx_drm_format_bpp(mode_cmd->pixel_format);
+	fb->depth = xilinx_drm_format_depth(mode_cmd->pixel_format);
+
+	return fb;
 }
 
 /* poll changed handler */
-- 
2.0.2

