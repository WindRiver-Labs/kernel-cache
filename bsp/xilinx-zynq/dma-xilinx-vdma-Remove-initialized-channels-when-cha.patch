From 15987f0e47dbf65916637289057db572bf7ad559 Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date: Wed, 25 Sep 2013 21:30:46 +0200
Subject: [PATCH 289/509] dma: xilinx: vdma: Remove initialized channels when
 channel probe fails

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit 2f013174fdbba9c2f153ee75179bd36104519362

If a channel fails to probe correctly when need to clean up the already
initialized channels. Check the return value of xilinx_vdma_chan_probe()
and call xilinx_vdma_chan_remove() on all previously initialized
channels in case of failure.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Acked-by: Srikanth Thokala <sthokal@xilinx.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/dma/xilinx/xilinx_axivdma.c |   14 ++++++++++++--
 1 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/drivers/dma/xilinx/xilinx_axivdma.c b/drivers/dma/xilinx/xilinx_axivdma.c
index 5de0b13..9e835f4 100644
--- a/drivers/dma/xilinx/xilinx_axivdma.c
+++ b/drivers/dma/xilinx/xilinx_axivdma.c
@@ -1147,7 +1147,6 @@ static int xilinx_vdma_chan_probe(struct xilinx_vdma_device *xdev,
 		xdev->common.copy_align = my_log(width);
 
 	chan->dev = xdev->dev;
-	xdev->chan[chan->id] = chan;
 
 	tasklet_init(&chan->tasklet, dma_do_tasklet, (unsigned long)chan);
 
@@ -1175,6 +1174,7 @@ static int xilinx_vdma_chan_probe(struct xilinx_vdma_device *xdev,
 
 	/* Add the channel to DMA device channel list */
 	list_add_tail(&chan->common.device_node, &xdev->common.channels);
+	xdev->chan[chan->id] = chan;
 	xdev->common.chancnt++;
 
 	return 0;
@@ -1282,7 +1282,9 @@ static int xilinx_vdma_of_probe(struct platform_device *op)
 	platform_set_drvdata(op, xdev);
 
 	for_each_child_of_node(node, child) {
-		xilinx_vdma_chan_probe(xdev, child, xdev->feature);
+		err = xilinx_vdma_chan_probe(xdev, child, xdev->feature);
+		if (err < 0)
+			goto error;
 	}
 
 	for (i = 0; i < XILINX_VDMA_MAX_CHANS_PER_DEVICE; i++) {
@@ -1298,6 +1300,14 @@ static int xilinx_vdma_of_probe(struct platform_device *op)
 		dev_err(&op->dev, "Unable to register DMA to DT\n");
 
 	return 0;
+
+error:
+	for (i = 0; i < XILINX_VDMA_MAX_CHANS_PER_DEVICE; i++) {
+		if (xdev->chan[i])
+			xilinx_vdma_chan_remove(xdev->chan[i]);
+	}
+
+	return err;
 }
 
 static int xilinx_vdma_of_remove(struct platform_device *op)
-- 
1.7.5.4

