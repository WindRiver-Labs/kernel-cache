From 6ef46149c973cfb2759cbdf6de4c911519c267ea Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyun.kwon@xilinx.com>
Date: Tue, 10 Jun 2014 17:40:34 -0700
Subject: [PATCH 149/290] drm: xilinx: dp: Replace udelay() with usleep_range()

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Change the 1ms delay (udelay(1000)) to sleep (usleep_range(1000, 1100)),
since 1ms is too long to be a delay and there's no need to do busy wait.

Signed-off-by: Hyun Kwon <hyunk@xilinx.com>
Acked-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 55dd21649382f517a5d8d4cddde70a125371be21)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpu/drm/xilinx/xilinx_drm_dp.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/xilinx/xilinx_drm_dp.c b/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
index 3096654..8f4c009 100644
--- a/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
+++ b/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
@@ -22,6 +22,7 @@
 #include <drm/drm_encoder_slave.h>
 
 #include <linux/clk.h>
+#include <linux/delay.h>
 #include <linux/device.h>
 #include <linux/module.h>
 #include <linux/mutex.h>
@@ -356,7 +357,7 @@ static int xilinx_drm_dp_aux_cmd_submit(struct xilinx_drm_dp *dp, u32 cmd,
 		    i == 2)
 			return -ETIMEDOUT;
 
-		udelay(1000);
+		usleep_range(1000, 1100);
 	}
 
 	reg = xilinx_drm_readl(iomem, XILINX_DP_TX_AUX_REPLY_CODE);
@@ -486,7 +487,7 @@ static int xilinx_drm_dp_phy_ready(struct xilinx_drm_dp *dp)
 	/* Wait for 100 * 1ms. This should be enough time for PHY to be ready */
 	do {
 		reg = xilinx_drm_readl(dp->iomem, XILINX_DP_TX_PHY_STATUS);
-		udelay(1000);
+		usleep_range(1000, 1100);
 	} while ((reg & XILINX_DP_TX_PHY_STATUS_READY_MASK) !=
 		 XILINX_DP_TX_PHY_STATUS_READY_MASK && --count > 0);
 
-- 
2.0.2

