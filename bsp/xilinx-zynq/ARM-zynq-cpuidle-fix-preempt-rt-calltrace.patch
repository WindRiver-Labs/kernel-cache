From de69384f289671b9ce34527a4461e99226af2c93 Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Thu, 22 May 2014 18:54:44 +0800
Subject: [PATCH] ARM: zynq: cpuidle: fix preempt-rt calltrace

The kernel will print calltrace when calling cpuidle function:

BUG: sleeping function called from invalid context at linux/kernel/rtmutex.c:659
in_atomic(): 1, irqs_disabled(): 128, pid: 0, name: swapper/0
Preemption disabled at:[<  (null)>]   (null)

CPU: 0 PID: 0 Comm: swapper/0 Not tainted 3.10.38-ltsi-rt34-WR6.0.0.0_preempt-rt #1
[<80017864>] (unwind_backtrace+0x0/0xec) from [<80012cb4>] (show_stack+0x20/0x24)
[<80012cb4>] (show_stack+0x20/0x24) from [<805d3de0>] (dump_stack+0x20/0x28)
[<805d3de0>] (dump_stack+0x20/0x28) from [<80054058>] (__might_sleep+0x14c/0x178)
[<80054058>] (__might_sleep+0x14c/0x178) from [<805d7940>] (__rt_spin_lock+0x28/0x38)
[<805d7940>] (__rt_spin_lock+0x28/0x38) from [<805d7bd4>] (rt_read_lock+0x3c/0x4c)
[<805d7bd4>] (rt_read_lock+0x3c/0x4c) from [<800c2b5c>] (cpu_pm_enter+0x24/0x6c)
[<800c2b5c>] (cpu_pm_enter+0x24/0x6c) from [<8048bc2c>] (zynq_enter_idle+0x1c/0x2c)
[<8048bc2c>] (zynq_enter_idle+0x1c/0x2c) from [<8048a3fc>] (cpuidle_enter_state+0x4c/0xe8)
[<8048a3fc>] (cpuidle_enter_state+0x4c/0xe8) from [<8048a5c4>] (cpuidle_idle_call+0x12c/0x2b4)
[<8048a5c4>] (cpuidle_idle_call+0x12c/0x2b4) from [<8000f784>] (arch_cpu_idle+0x18/0x48)
[<8000f784>] (arch_cpu_idle+0x18/0x48) from [<80068a1c>] (cpu_startup_entry+0x1e8/0x254)
[<80068a1c>] (cpu_startup_entry+0x1e8/0x254) from [<805c8c44>] (rest_init+0x80/0x98)
[<805c8c44>] (rest_init+0x80/0x98) from [<807ffad0>] (start_kernel+0x2d4/0x330)

It seems that rwlock (from cpu_pm_enter) can't be called on atomic context under
preempt-rt. This patch excludes the second state of the zynq cpuidle to avoid
calling the rwlock.

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/cpuidle/cpuidle-zynq.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/cpuidle/cpuidle-zynq.c b/drivers/cpuidle/cpuidle-zynq.c
index aded759..b35a4fd 100644
--- a/drivers/cpuidle/cpuidle-zynq.c
+++ b/drivers/cpuidle/cpuidle-zynq.c
@@ -32,7 +32,11 @@
 #include <asm/proc-fns.h>
 #include <asm/cpuidle.h>
 
+#ifdef CONFIG_PREEMPT_RT_FULL
+#define ZYNQ_MAX_STATES		1
+#else
 #define ZYNQ_MAX_STATES		2
+#endif
 
 /* Actual code that puts the SoC in different idle states */
 static int zynq_enter_idle(struct cpuidle_device *dev,
-- 
1.7.5.4

