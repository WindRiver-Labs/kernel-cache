From 761e2bb9069dfcfdca227260363e1e939335176d Mon Sep 17 00:00:00 2001
From: Zhixiong Chi <zhixiong.chi@windriver.com>
Date: Thu, 24 Sep 2015 10:28:14 +0800
Subject: [PATCH] mmc: add sd wp-invert into picozed dtb

Issue: LIN7-4767

Boot failure when use mmc card to hold rootfs on picozed board.
The error info as follow:
 mmcblk0: mmc0:1234 SA04G 3.63 GiB (ro)
  mmcblk0: p1 p2
 VFS: Cannot open root device "mmcblk0p2" or unknown-block(179,2): error -30
 Please append a correct "root=" boot option; here are the available partitions:
 1f00            1024 mtdblock0  (driver?)
 1f01            5120 mtdblock1  (driver?)
 1f02             128 mtdblock2  (driver?)
 1f03            6016 mtdblock3  (driver?)
 1f04            4096 mtdblock4  (driver?)
 b300         3813376 mmcblk0  driver: mmcblk
   b301           51200 mmcblk0p1 85b1a274-01
   b302         3761152 mmcblk0p2 85b1a274-02
 VFS: Unable to mount root fs on unknown-block(179,2)
 User configuration error - no valid root filesystem found
 Kernel panic - not syncing: Invalid configuration from end user prevents continuing

The error value(-30) means that the sd card is read only, but in fact the card isn't
write-protect. After review the driver code, we find it calls the function of
set_readonly. We add the wr-inverted into picozed-dts to change the return value for
 getting the correct state, so that we can mount the rootfs normally and it works well.

The handling:
 is_readonly = !(sdhci_readl(host, SDHCI_PRESENT_STATE) & SDHCI_WRITE_PROTECT);
 return host->quirks & SDHCI_QUIRK_INVERTED_WRITE_PROTECT ?
		!is_readonly : is_readonly;

Signed-off-by: Zhixiong Chi <zhixiong.chi@windriver.com>
---
 arch/arm/boot/dts/zynq-picozed.dts |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/arch/arm/boot/dts/zynq-picozed.dts b/arch/arm/boot/dts/zynq-picozed.dts
index faafeb5..76c2bcb 100644
--- a/arch/arm/boot/dts/zynq-picozed.dts
+++ b/arch/arm/boot/dts/zynq-picozed.dts
@@ -259,6 +259,7 @@
 			xlnx,has-cd = <0x1>;
 			xlnx,has-power = <0x0>;
 			xlnx,has-wp = <0x1>;
+			wp-inverted = <0x1>;
 		} ;
 		ps7_sd_1: ps7-sdio@e0101000 {
 			clock-frequency = <125000000>;
@@ -271,6 +272,7 @@
 			xlnx,has-cd = <0x1>;
 			xlnx,has-power = <0x0>;
 			xlnx,has-wp = <0x1>;
+			wp-inverted = <0x1>;
 		};
 		ps7_slcr_0: ps7-slcr@f8000000 {
 			#address-cells = <1>;
-- 
1.7.5.4

