From 16eb6d91b8461061c2027123d2ec23eb914df350 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Fri, 20 Jul 2012 09:52:16 +0800
Subject: [PATCH 02/36] arm/zynq: Separate board's code from machine file

SDK: yocto-1.2(http://git.yoctoproject.org/cgit.cgi/meta-zynq/)

Signed-off-by: Vlad Lungu <vlad.lungu@windriver.com>
Integrated-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 arch/arm/mach-zynq/Makefile      |    2 +-
 arch/arm/mach-zynq/board_zc702.c |   48 ++++++++++++++++++++++++++++++++++++++
 arch/arm/mach-zynq/common.c      |   25 ++++----------------
 arch/arm/mach-zynq/common.h      |    4 ++++
 4 files changed, 57 insertions(+), 22 deletions(-)
 create mode 100644 arch/arm/mach-zynq/board_zc702.c

diff --git a/arch/arm/mach-zynq/Makefile b/arch/arm/mach-zynq/Makefile
index 7d13a03..4dc4d3c 100644
--- a/arch/arm/mach-zynq/Makefile
+++ b/arch/arm/mach-zynq/Makefile
@@ -3,6 +3,6 @@
 #
 
 # Common support
-obj-y:= common.o timer.o clock.o
+obj-y:= common.o timer.o clock.o board_zc702.o
 
 obj-$(CONFIG_SMP) += platsmp.o
diff --git a/arch/arm/mach-zynq/board_zc702.c b/arch/arm/mach-zynq/board_zc702.c
new file mode 100644
index 0000000..15b8220
--- /dev/null
+++ b/arch/arm/mach-zynq/board_zc702.c
@@ -0,0 +1,48 @@
+/*
+ *  Copyright (C) 2011 Xilinx
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
+
+#include <linux/types.h>
+#include <linux/init.h>
+#include <linux/of_platform.h>
+
+#include <asm/mach-types.h>
+#include <asm/mach/arch.h>
+#include <asm/hardware/gic.h>
+
+#include "common.h"
+
+static void __init board_zc702_init(void)
+{
+
+	/* initialize the xilinx common code before the board
+	 * specific
+	 */
+	xilinx_init_machine();
+
+}
+
+static const char *xilinx_dt_match[] __initdata = {
+	"xlnx,zynq-ep107",
+	"xlnx,zynq-zc702",
+	NULL
+};
+
+DT_MACHINE_START(XILINX_DT, "Xilinx Zynq Platform")
+	.map_io		= xilinx_map_io,
+	.init_irq	= xilinx_irq_init,
+	.handle_irq	= gic_handle_irq,
+	.init_machine	= board_zc702_init,
+	.timer		= &xttcpss_sys_timer,
+	.dt_compat	= xilinx_dt_match,
+	.reserve        = xilinx_memory_init,
+MACHINE_END
diff --git a/arch/arm/mach-zynq/common.c b/arch/arm/mach-zynq/common.c
index eb9088d..1e980f2 100644
--- a/arch/arm/mach-zynq/common.c
+++ b/arch/arm/mach-zynq/common.c
@@ -24,7 +24,6 @@
 #include <linux/of.h>
 #include <linux/memblock.h>
 
-#include <asm/mach/arch.h>
 #include <asm/mach/map.h>
 #include <asm/mach-types.h>
 #include <asm/page.h>
@@ -44,7 +43,7 @@ static struct of_device_id zynq_of_bus_ids[] __initdata = {
  * xilinx_init_machine() - System specific initialization, intended to be
  *			   called from board specific initialization.
  */
-static void __init xilinx_init_machine(void)
+void __init xilinx_init_machine(void)
 {
 	of_platform_populate(NULL, zynq_of_bus_ids, NULL, NULL);
 
@@ -64,7 +63,7 @@ static void __init xilinx_init_machine(void)
 /**
  * xilinx_irq_init() - Interrupt controller initialization for the GIC.
  */
-static void __init xilinx_irq_init(void)
+void __init xilinx_irq_init(void)
 {
 	gic_init(0, 29, SCU_GIC_DIST_BASE, SCU_GIC_CPU_BASE);
 }
@@ -113,7 +112,7 @@ static struct map_desc io_desc[] __initdata = {
 /**
  * xilinx_map_io() - Create memory mappings needed for early I/O.
  */
-static void __init xilinx_map_io(void)
+void __init xilinx_map_io(void)
 {
 	iotable_init(io_desc, ARRAY_SIZE(io_desc));
 }
@@ -124,7 +123,7 @@ static void __init xilinx_map_io(void)
  * We need to stop things allocating the low memory as DMA can't work in
  * the 1st 512K of memory.  Using reserve vs remove is not totally clear yet.
  */
-static void __init xilinx_memory_init(void)
+void __init xilinx_memory_init(void)
 {
 	/* Reserve the 0-0x4000 addresses (before page tables and kernel)
 	 * which can't be used for DMA
@@ -136,19 +135,3 @@ static void __init xilinx_memory_init(void)
 	 */
 	memblock_remove(0xF000000, 0x1000000);
 }
-
-static const char *xilinx_dt_match[] = {
-	"xlnx,zynq-ep107",
-	"xlnx,zynq-zc702",
-	NULL
-};
-
-MACHINE_START(XILINX_EP107, "Xilinx Zynq Platform")
-	.map_io		= xilinx_map_io,
-	.init_irq	= xilinx_irq_init,
-	.handle_irq	= gic_handle_irq,
-	.init_machine	= xilinx_init_machine,
-	.timer		= &xttcpss_sys_timer,
-	.dt_compat	= xilinx_dt_match,
-	.reserve        = xilinx_memory_init,
-MACHINE_END
diff --git a/arch/arm/mach-zynq/common.h b/arch/arm/mach-zynq/common.h
index 1220617..33be71e 100644
--- a/arch/arm/mach-zynq/common.h
+++ b/arch/arm/mach-zynq/common.h
@@ -22,4 +22,8 @@
 void secondary_startup(void);
 extern struct sys_timer xttcpss_sys_timer;
 
+void xilinx_init_machine(void);
+void xilinx_irq_init(void);
+void xilinx_map_io(void);
+void xilinx_memory_init(void);
 #endif
-- 
1.7.9.7

