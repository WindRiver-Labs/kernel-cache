From d10a7a095ff8c90565768b66d6209793221b1b09 Mon Sep 17 00:00:00 2001
From: Punnaiah Choudary Kalluri <punnaiah.choudary.kalluri@xilinx.com>
Date: Tue, 10 Dec 2013 11:02:40 +0530
Subject: [PATCH 6/7] net: xilinx_emacps: Disable napi when xemacps_mii_probe fails

The patch based on commit:
https://github.com/Xilinx/linux-xlnx/commit/379b01ab003aa8e2306d56ce6e2b7bcf140867fe

In xemacps_open(), call napi_disable() when the xemacps_mii_probe() fails.
This change is needed to undo the napi_enable() which called before the
xemacps_mii_probe().

This fix is needed because of below commit
"net: xilinx_emacps: Fix race condition occurs during link up/down"
(sha1: 49028589bcd9c7d2657b3b6fec82d216a9c9f5c6)

Reported-by: Soren Brinkmann <soren.brinkmann@xilinx.com>
Signed-off-by: Punnaiah Choudary Kalluri <punnaia@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/net/ethernet/xilinx/xilinx_emacps.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/xilinx/xilinx_emacps.c b/drivers/net/ethernet/xilinx/xilinx_emacps.c
index 566f8ea..56c18d0 100644
--- a/drivers/net/ethernet/xilinx/xilinx_emacps.c
+++ b/drivers/net/ethernet/xilinx/xilinx_emacps.c
@@ -1832,6 +1832,7 @@ static int xemacps_open(struct net_device *ndev)
 	return 0;
 
 err_pm_put:
+	napi_disable(&lp->napi);
 	xemacps_reset_hw(lp);
 	pm_runtime_put(&lp->pdev->dev);
 err_free_rings:
-- 
1.7.0

