From 71cb70f09a411ac5ac17ea90ecd03ecf2295616d Mon Sep 17 00:00:00 2001
From: Nicolae Rosia <nicolae.rosia@certsign.ro>
Date: Mon, 5 Jan 2015 18:11:02 +0200
Subject: [PATCH 025/456] ARM: zynq: xilinx_axidma: fix race condition in
 xilinx_dma_tx_submit

The error flag should be protected against race conditions as other
member variables are.

Signed-off-by: Nicolae Rosia <nicolae.rosia@certsign.ro>
Acked-by: Kedareswara rao Appana <appanad@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 1b28f178c797236da36bf33a75d861f2be95028f)
---
 drivers/dma/xilinx/xilinx_axidma.c |    7 ++++---
 1 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/drivers/dma/xilinx/xilinx_axidma.c b/drivers/dma/xilinx/xilinx_axidma.c
index 9e44f66..ca7a619 100644
--- a/drivers/dma/xilinx/xilinx_axidma.c
+++ b/drivers/dma/xilinx/xilinx_axidma.c
@@ -605,6 +605,8 @@ static dma_cookie_t xilinx_dma_tx_submit(struct dma_async_tx_descriptor *tx)
 
 	desc = container_of(tx, struct xilinx_dma_desc_sw, async_tx);
 
+	spin_lock_irqsave(&chan->lock, flags);
+
 	if (chan->err) {
 		/*
 		 * If reset fails, need to hard reset the system.
@@ -613,11 +615,9 @@ static dma_cookie_t xilinx_dma_tx_submit(struct dma_async_tx_descriptor *tx)
 		if (!dma_reset(chan))
 			chan->err = false;
 		else
-			return cookie;
+			goto out_unlock;
 	}
 
-	spin_lock_irqsave(&chan->lock, flags);
-
 	/*
 	 * Assign cookies to all of the software descriptors
 	 * that make up this transaction
@@ -636,6 +636,7 @@ static dma_cookie_t xilinx_dma_tx_submit(struct dma_async_tx_descriptor *tx)
 	/* Put this transaction onto the tail of the pending queue */
 	append_desc_queue(chan, desc);
 
+out_unlock:
 	spin_unlock_irqrestore(&chan->lock, flags);
 
 	return cookie;
-- 
1.7.5.4

