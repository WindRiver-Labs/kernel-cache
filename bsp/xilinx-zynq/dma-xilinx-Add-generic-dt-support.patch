From 48c4613692a7cc84caffb8d09249b5939a3f93ca Mon Sep 17 00:00:00 2001
From: Lars-Peter Clausen <lars@metafoo.de>
Date: Sat, 23 Mar 2013 14:52:03 +0100
Subject: [PATCH 364/509] dma: xilinx: Add generic dt support

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit aa3b7487e5d5ea88d8bbed8861a451f5892fc268

Signed-off-by: Lars-Peter Clausen <lars@metafoo.de>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/dma/xilinx_dma.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/drivers/dma/xilinx_dma.c b/drivers/dma/xilinx_dma.c
index 6199503d..ad6b439 100644
--- a/drivers/dma/xilinx_dma.c
+++ b/drivers/dma/xilinx_dma.c
@@ -40,6 +40,7 @@
 #include <linux/amba/xilinx_dma.h>
 #include <linux/debugfs.h>
 #include <linux/sched.h>
+#include <linux/of_dma.h>
 
 /* Hw specific definitions
  */
@@ -1487,6 +1488,11 @@ static int __devinit xilinx_dma_of_probe(struct platform_device *pdev)
 	if (ret)
 		goto err_free_chan;
 
+	ret = of_dma_controller_register(pdev->dev.of_node,
+			of_dma_xlate_by_chan_id, &xdev->common);
+	if (ret)
+		goto err_unregister_device;
+
 	for (i = 0; i < XILINX_DMA_MAX_CHANS_PER_DEVICE; i++) {
 		if (xdev->chan[i]) {
 			chan = xdev->chan[i];
@@ -1498,6 +1504,8 @@ static int __devinit xilinx_dma_of_probe(struct platform_device *pdev)
 
 	return 0;
 
+err_unregister_device:
+	dma_async_device_unregister(&xdev->common);
 err_free_chan:
 	for (i = 0; i < XILINX_DMA_MAX_CHANS_PER_DEVICE; i++) {
 		if (xdev->chan[i])
@@ -1512,6 +1520,7 @@ static int __devexit xilinx_dma_of_remove(struct platform_device *pdev)
 	struct xilinx_dma_device *xdev = platform_get_drvdata(pdev);
 	int i;
 
+	of_dma_controller_free(pdev->dev.of_node);
 	dma_async_device_unregister(&xdev->common);
 
 	for (i = 0; i < XILINX_DMA_MAX_CHANS_PER_DEVICE; i++) {
-- 
1.7.5.4

