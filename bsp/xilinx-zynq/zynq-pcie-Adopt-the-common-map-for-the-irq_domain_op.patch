From 708373459a344c92c340330d08c1843b8680128e Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Wed, 10 Sep 2014 10:39:46 +0800
Subject: [PATCH 1/2] zynq: pcie: Adopt the common map for the irq_domain_ops

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-zynq/xaxipcie-msi.c |   14 ++++++++++++--
 1 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-zynq/xaxipcie-msi.c b/arch/arm/mach-zynq/xaxipcie-msi.c
index 43500e0..e05ad39 100644
--- a/arch/arm/mach-zynq/xaxipcie-msi.c
+++ b/arch/arm/mach-zynq/xaxipcie-msi.c
@@ -59,7 +59,6 @@ again:
 		goto again;
 
 	dynamic_irq_init(irq);
-	set_irq_flags(irq, IRQF_VALID);
 
 	return irq;
 }
@@ -144,11 +143,22 @@ int arch_setup_msi_irq(struct pci_dev *pdev, struct msi_desc *desc)
 
 	write_msi_msg(irq, &msg);
 
+	return 0;
+}
+
+static int xilinx_pcie_msi_map(struct irq_domain *domain, unsigned int irq,
+		                        irq_hw_number_t hwirq)
+{
 	irq_set_chip_and_handler(irq, &xilinx_msi_chip, handle_simple_irq);
+	irq_set_chip_data(irq, domain->host_data);
+	set_irq_flags(irq, IRQF_VALID);
 
 	return 0;
 }
 
+static const struct irq_domain_ops msi_domain_ops = {
+	.map = xilinx_pcie_msi_map,
+};
 
 /**
  * xaxipcie_alloc_msi_irqdescs - allocate msi irq descs
@@ -176,7 +186,7 @@ int xaxipcie_alloc_msi_irqdescs(struct device_node *node,
 	xaxipcie_irq_domain = irq_domain_add_legacy(node,
 				XILINX_NUM_MSI_IRQS,
 				xaxipcie_msi_irq_base,
-				0, &irq_domain_simple_ops, NULL);
+				0, &msi_domain_ops, NULL);
 
 	if (!xaxipcie_irq_domain)
 		return -ENOMEM;
-- 
1.7.5.4

