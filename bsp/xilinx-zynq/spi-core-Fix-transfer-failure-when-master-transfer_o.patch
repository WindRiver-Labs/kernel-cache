From c7099a960584e73d3487d055f12061b9be1b6cce Mon Sep 17 00:00:00 2001
From: Axel Lin <axel.lin@ingics.com>
Date: Sat, 18 Jan 2014 22:05:22 +0800
Subject: [PATCH 105/509] spi: core: Fix transfer failure when
 master->transfer_one returns positive value

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit 13a4279880229240af38486611c94587492b24d3

master->transfer_one returns positive value is not a error.
So set ret to 0 when master->transfer_one returns positive value.
Otherwise, I hit "spi_master spi0: failed to transfer one message from
queue"
error when my transfer_one callback returns 1.

Signed-off-by: Axel Lin <axel.lin@ingics.com>
Signed-off-by: Mark Brown <broonie@linaro.org>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/spi/spi.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/drivers/spi/spi.c b/drivers/spi/spi.c
index 36cecc4..306bd13 100644
--- a/drivers/spi/spi.c
+++ b/drivers/spi/spi.c
@@ -561,8 +561,10 @@ static int spi_transfer_one_message(struct spi_master *master,
 			goto out;
 		}
 
-		if (ret > 0)
+		if (ret > 0) {
+			ret = 0;
 			wait_for_completion(&master->xfer_completion);
+		}
 
 		if (msg->status != -EINPROGRESS)
 			goto out;
-- 
1.7.5.4

