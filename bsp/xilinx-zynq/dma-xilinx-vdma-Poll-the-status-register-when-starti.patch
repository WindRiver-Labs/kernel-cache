From d544ed5698a935eff17cea2b3c88c883f5ca2059 Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date: Tue, 18 Jun 2013 02:53:03 +0200
Subject: [PATCH 316/509] dma: xilinx: vdma: Poll the status register when
 starting/stopping

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit 1eea5b1e62a7bdb58f34d18189618f5acb110856

After setting or clearing the run/stop bit in the control register, the
DMA engine run status is reflected by the halted bit in the status
register. Fix the driver to poll the halted bit instead of polling the
run/stop bit.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Acked-by: Srikanth Thokala <sthokal@xilinx.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/dma/xilinx/xilinx_axivdma.c |   12 ++++++------
 1 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/drivers/dma/xilinx/xilinx_axivdma.c b/drivers/dma/xilinx/xilinx_axivdma.c
index 5d81e43..9ac3a76 100644
--- a/drivers/dma/xilinx/xilinx_axivdma.c
+++ b/drivers/dma/xilinx/xilinx_axivdma.c
@@ -447,8 +447,8 @@ static void xilinx_vdma_halt(struct xilinx_vdma_chan *chan)
 
 	/* Wait for the hardware to halt */
 	while (loop) {
-		if (!(vdma_ctrl_read(chan, XILINX_VDMA_REG_DMACR)
-		      & XILINX_VDMA_DMACR_RUNSTOP))
+		if (vdma_ctrl_read(chan, XILINX_VDMA_REG_DMASR)
+		    & XILINX_VDMA_DMASR_HALTED)
 			break;
 
 		loop -= 1;
@@ -456,7 +456,7 @@ static void xilinx_vdma_halt(struct xilinx_vdma_chan *chan)
 
 	if (!loop) {
 		dev_err(chan->dev, "Cannot stop channel %p: %x\n",
-			chan, vdma_ctrl_read(chan, XILINX_VDMA_REG_DMACR));
+			chan, vdma_ctrl_read(chan, XILINX_VDMA_REG_DMASR));
 		chan->err = 1;
 	}
 
@@ -472,8 +472,8 @@ static void xilinx_vdma_start(struct xilinx_vdma_chan *chan)
 
 	/* Wait for the hardware to start */
 	while (loop) {
-		if (vdma_ctrl_read(chan, XILINX_VDMA_REG_DMACR)
-		    & XILINX_VDMA_DMACR_RUNSTOP)
+		if (!(vdma_ctrl_read(chan, XILINX_VDMA_REG_DMASR)
+		      & XILINX_VDMA_DMASR_HALTED))
 			break;
 
 		loop -= 1;
@@ -481,7 +481,7 @@ static void xilinx_vdma_start(struct xilinx_vdma_chan *chan)
 
 	if (!loop) {
 		dev_err(chan->dev, "Cannot start channel %p: %x\n",
-			chan, vdma_ctrl_read(chan, XILINX_VDMA_REG_DMACR));
+			chan, vdma_ctrl_read(chan, XILINX_VDMA_REG_DMASR));
 
 		chan->err = 1;
 	}
-- 
1.7.5.4

