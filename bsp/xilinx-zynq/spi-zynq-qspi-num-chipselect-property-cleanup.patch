From 9ac8f97a9d70dd1a1ba93d8cf6fa914e627021f3 Mon Sep 17 00:00:00 2001
From: Harini Katakam <harini.katakam@xilinx.com>
Date: Mon, 7 Apr 2014 19:46:55 +0530
Subject: [PATCH 128/509] spi: zynq-qspi: num-chipselect property cleanup

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit d8508ce31327571dec5075982e6e73e14c4a8c3e

Rename num-chipselect property to the commonly used num-cs.
When reading num-cs read into temporary u32 variable and then
copy to master->num_chipselect which is u16.
When num-cs is not present, use a default value instead of
returning error.

Signed-off-by: Harini Katakam <harinik@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/boot/dts/zynq-zc702.dts |    2 +-
 arch/arm/boot/dts/zynq-zc706.dts |    2 +-
 arch/arm/boot/dts/zynq-zed.dts   |    2 +-
 drivers/spi/spi-zynq-qspi.c      |   16 ++++++++++------
 4 files changed, 13 insertions(+), 9 deletions(-)

diff --git a/arch/arm/boot/dts/zynq-zc702.dts b/arch/arm/boot/dts/zynq-zc702.dts
index ee32eda..3a138fc 100644
--- a/arch/arm/boot/dts/zynq-zc702.dts
+++ b/arch/arm/boot/dts/zynq-zc702.dts
@@ -271,7 +271,7 @@
 			interrupt-parent = <&ps7_scugic_0>;
 			interrupts = <0 19 4>;
 			is-dual = <0>;
-			num-chip-select = <1>;
+			num-cs = <1>;
 			reg = <0xe000d000 0x1000>;
 			xlnx,fb-clk = <0x1>;
 			xlnx,qspi-mode = <0x0>;
diff --git a/arch/arm/boot/dts/zynq-zc706.dts b/arch/arm/boot/dts/zynq-zc706.dts
index b955065..fcaf089 100644
--- a/arch/arm/boot/dts/zynq-zc706.dts
+++ b/arch/arm/boot/dts/zynq-zc706.dts
@@ -256,7 +256,7 @@
 			interrupt-parent = <&ps7_scugic_0>;
 			interrupts = <0 19 4>;
 			is-dual = <1>;
-			num-chip-select = <1>;
+			num-cs = <1>;
 			reg = <0xe000d000 0x1000>;
 			xlnx,fb-clk = <0x1>;
 			xlnx,qspi-mode = <0x2>;
diff --git a/arch/arm/boot/dts/zynq-zed.dts b/arch/arm/boot/dts/zynq-zed.dts
index 4d015e4..4cb7139 100644
--- a/arch/arm/boot/dts/zynq-zed.dts
+++ b/arch/arm/boot/dts/zynq-zed.dts
@@ -180,7 +180,7 @@
 			interrupt-parent = <&ps7_scugic_0>;
 			interrupts = <0 19 4>;
 			is-dual = <0>;
-			num-chip-select = <1>;
+			num-cs = <1>;
 			reg = <0xe000d000 0x1000>;
 			xlnx,fb-clk = <0x1>;
 			xlnx,qspi-mode = <0x0>;
diff --git a/drivers/spi/spi-zynq-qspi.c b/drivers/spi/spi-zynq-qspi.c
index 7b47ec6..5cb784d 100644
--- a/drivers/spi/spi-zynq-qspi.c
+++ b/drivers/spi/spi-zynq-qspi.c
@@ -121,6 +121,9 @@
  */
 #define MODEBITS			(SPI_CPOL | SPI_CPHA)
 
+/* Default number of chip selects */
+#define ZYNQ_QSPI_DEFAULT_NUM_CS	1
+
 /**
  * struct zynq_qspi - Defines qspi driver instance
  * @regs:		Virtual address of the QSPI controller registers
@@ -628,6 +631,7 @@ static int zynq_qspi_probe(struct platform_device *pdev)
 	struct spi_master *master;
 	struct zynq_qspi *xqspi;
 	struct resource *res;
+	u32 num_cs;
 
 	master = spi_alloc_master(&pdev->dev, sizeof(*xqspi));
 	if (master == NULL)
@@ -692,12 +696,12 @@ static int zynq_qspi_probe(struct platform_device *pdev)
 	/* QSPI controller initializations */
 	zynq_qspi_init_hw(xqspi);
 
-	ret = of_property_read_u32(pdev->dev.of_node, "num-chip-select",
-				   (u32 *)&master->num_chipselect);
-	if (ret < 0) {
-		dev_err(&pdev->dev, "couldn't determine num-chip-select\n");
-		goto clk_dis_all;
-	}
+	ret = of_property_read_u32(pdev->dev.of_node, "num-cs",
+				   &num_cs);
+	if (ret < 0)
+		master->num_chipselect = ZYNQ_QSPI_DEFAULT_NUM_CS;
+	else
+		master->num_chipselect = num_cs;
 
 	master->setup = zynq_qspi_setup;
 	master->set_cs = zynq_qspi_chipselect;
-- 
1.7.5.4

