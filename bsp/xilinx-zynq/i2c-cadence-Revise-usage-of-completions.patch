From 9c3abd2b862cf1005476f6bf4a5bb33b305f8cb1 Mon Sep 17 00:00:00 2001
From: Soren Brinkmann <soren.brinkmann@xilinx.com>
Date: Thu, 10 Apr 2014 08:04:01 -0700
Subject: [PATCH 171/182] i2c: cadence: Revise usage of completions

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Initialize completion once during probe and use reinit_completion()
during transfers.

Signed-off-by: Soren Brinkmann <soren.brinkmann@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 1730730177eb7cd44df0610415d1a320fb08dfe4)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/i2c/busses/i2c-cadence.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/i2c/busses/i2c-cadence.c b/drivers/i2c/busses/i2c-cadence.c
index 5a17edd..e6935f8 100644
--- a/drivers/i2c/busses/i2c-cadence.c
+++ b/drivers/i2c/busses/i2c-cadence.c
@@ -443,7 +443,7 @@ static int cdns_i2c_process_msg(struct cdns_i2c *id, struct i2c_msg *msg,
 	id->p_msg = msg;
 	do {
 		id->err_status = 0;
-		init_completion(&id->xfer_done);
+		reinit_completion(&id->xfer_done);
 
 		/* Check for the TEN Bit mode on each msg */
 		reg = cdns_i2c_readreg(CDNS_I2C_CR_OFFSET);
@@ -809,6 +809,7 @@ static int cdns_i2c_probe(struct platform_device *pdev)
 	id->adap.retries = 3;		/* Default retry value. */
 	id->adap.algo_data = id;
 	id->adap.dev.parent = &pdev->dev;
+	init_completion(&id->xfer_done);
 	snprintf(id->adap.name, sizeof(id->adap.name),
 		 "Cadence I2C at %08lx", (unsigned long)r_mem->start);
 
-- 
1.7.5.4

