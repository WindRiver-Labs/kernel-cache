From 9e9b62963c3ee675048ba7ea260217fc995af67c Mon Sep 17 00:00:00 2001
From: Punnaiah Choudary Kalluri <punnaia@xilinx.com>
Date: Mon, 7 Apr 2014 19:46:50 +0530
Subject: [PATCH 124/509] spi: zynq-qspi: Clean up isr

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit 2c89b88d7a6d2a54ff1e3b46d43daca4fa0e52ae

Cleanup ISR for readability.
Dont disable interrupts and re-enable again.

Signed-off-by: Punnaiah Choudary Kalluri <punnaia@xilinx.com>
Signed-off-by: Harini Katakam <harinik@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/spi/spi-zynq-qspi.c |   12 +-----------
 1 files changed, 1 insertions(+), 11 deletions(-)

diff --git a/drivers/spi/spi-zynq-qspi.c b/drivers/spi/spi-zynq-qspi.c
index 69476f5..519e1b6 100644
--- a/drivers/spi/spi-zynq-qspi.c
+++ b/drivers/spi/spi-zynq-qspi.c
@@ -441,8 +441,6 @@ static irqreturn_t zynq_qspi_irq(int irq, void *dev_id)
 
 	intr_status = zynq_qspi_read(xqspi->regs + ZYNQ_QSPI_STATUS_OFFSET);
 	zynq_qspi_write(xqspi->regs + ZYNQ_QSPI_STATUS_OFFSET , intr_status);
-	zynq_qspi_write(xqspi->regs + ZYNQ_QSPI_IDIS_OFFSET,
-			ZYNQ_QSPI_IXR_ALL_MASK);
 
 	if ((intr_status & ZYNQ_QSPI_IXR_TXNFULL_MASK) ||
 		   (intr_status & ZYNQ_QSPI_IXR_RXNEMTY_MASK)) {
@@ -498,18 +496,10 @@ static irqreturn_t zynq_qspi_irq(int irq, void *dev_id)
 					zynq_qspi_write(xqspi->regs +
 						offset[tmp - 1], data);
 			}
-			zynq_qspi_write(xqspi->regs + ZYNQ_QSPI_IEN_OFFSET,
-					ZYNQ_QSPI_IXR_ALL_MASK);
 		} else {
 			/* If transfer and receive is completed then only send
 			 * complete signal */
-			if (xqspi->bytes_to_receive) {
-				/* There is still some data to be received.
-				   Enable Rx not empty interrupt */
-				zynq_qspi_write(xqspi->regs +
-						ZYNQ_QSPI_IEN_OFFSET,
-						ZYNQ_QSPI_IXR_ALL_MASK);
-			} else {
+			if (!xqspi->bytes_to_receive) {
 				zynq_qspi_write(xqspi->regs +
 						ZYNQ_QSPI_IDIS_OFFSET,
 						ZYNQ_QSPI_IXR_ALL_MASK);
-- 
1.7.5.4

