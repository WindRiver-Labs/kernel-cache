From df55f41f59641646a25faab9bedfc861572ccd05 Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyun.kwon@xilinx.com>
Date: Tue, 10 Jun 2014 17:40:38 -0700
Subject: [PATCH 153/290] drm: xilinx: dp: Clean up the mutex

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Clean up the mutex when error-exiting and when driver is removed.

Signed-off-by: Hyun Kwon <hyunk@xilinx.com>
Acked-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 0f6a8b43f1ef2f883152acd3edea7c75e624b3b4)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpu/drm/xilinx/xilinx_drm_dp.c | 19 ++++++++++++++-----
 1 file changed, 14 insertions(+), 5 deletions(-)

diff --git a/drivers/gpu/drm/xilinx/xilinx_drm_dp.c b/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
index 7e7733f..7eb13af 100644
--- a/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
+++ b/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
@@ -1397,18 +1397,20 @@ static int xilinx_drm_dp_probe(struct platform_device *pdev)
 	ret = xilinx_drm_dp_i2c_init(dp);
 	if (ret < 0) {
 		dev_err(dp->dev, "failed to initialize DP i2c\n");
-		return ret;
+		goto error;
 	}
 
 	irq = platform_get_irq(pdev, 0);
-	if (irq < 0)
-		return irq;
+	if (irq < 0) {
+		ret = irq;
+		goto error;
+	}
 
 	ret = devm_request_threaded_irq(dp->dev, irq, NULL,
 					xilinx_drm_dp_irq_handler, IRQF_ONESHOT,
 					dev_name(dp->dev), dp);
 	if (ret < 0)
-		return ret;
+		goto error;
 
 	version = xilinx_drm_readl(dp->iomem, XILINX_DP_TX_VERSION);
 
@@ -1423,7 +1425,8 @@ static int xilinx_drm_dp_probe(struct platform_device *pdev)
 	version = xilinx_drm_readl(dp->iomem, XILINX_DP_TX_CORE_ID);
 	if (version & XILINX_DP_TX_CORE_ID_DIRECTION) {
 		dev_err(dp->dev, "Receiver is not supported\n");
-		return -ENODEV;
+		ret = -ENODEV;
+		goto error;
 	}
 
 	dev_info(dp->dev, "Display Port, version %u.%02x%02x (tx)\n",
@@ -1435,6 +1438,10 @@ static int xilinx_drm_dp_probe(struct platform_device *pdev)
 		  XILINX_DP_TX_CORE_ID_REVISION_SHIFT));
 
 	return 0;
+
+error:
+	mutex_destroy(&dp->aux_lock);
+	return ret;
 }
 
 static int xilinx_drm_dp_remove(struct platform_device *pdev)
@@ -1445,6 +1452,8 @@ static int xilinx_drm_dp_remove(struct platform_device *pdev)
 
 	xilinx_drm_writel(dp->iomem, XILINX_DP_TX_ENABLE, 0);
 
+	mutex_destroy(&dp->aux_lock);
+
 	return 0;
 }
 
-- 
2.0.2

