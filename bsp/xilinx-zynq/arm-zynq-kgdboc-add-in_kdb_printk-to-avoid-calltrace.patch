From 8d1e00229f441f38690972ab59dbf4cc8928b702 Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Mon, 21 Jan 2013 16:25:10 +0800
Subject: [PATCH] arm/zynq, kgdboc: add in_kdb_printk to avoid calltrace in
 preempt-rt

Add check function in_kdb_printk to avoid calling spin_lock with the
irq disabeld in preemp-rt kernel if KGDBoC is triggered. Otherwise the
call path trips the rtmutex debug code:

BUG: sleeping function called from invalid context at kernel/rtmutex.c:646

This change is inspired by serial8250_console_write() function in
drivers/tty/serial/8250/8250.c file.

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/tty/serial/xilinx_uartps.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/tty/serial/xilinx_uartps.c b/drivers/tty/serial/xilinx_uartps.c
index 5bb62ab..9018676 100644
--- a/drivers/tty/serial/xilinx_uartps.c
+++ b/drivers/tty/serial/xilinx_uartps.c
@@ -27,6 +27,7 @@
 #include <linux/of.h>
 #include <linux/moduleparam.h>
 #include <linux/module.h>
+#include <linux/kdb.h>
 
 #define XUARTPS_TTY_NAME	"ttyPS"
 #define XUARTPS_NAME		"xuartps"
@@ -969,7 +970,7 @@ static void xuartps_console_write(struct console *co, const char *s,
 	unsigned int imr;
 	int locked = 1;
 
-	if (oops_in_progress)
+	if (oops_in_progress || in_kdb_printk())
 		locked = spin_trylock_irqsave(&port->lock, flags);
 	else
 		spin_lock_irqsave(&port->lock, flags);
-- 
1.7.9.7

