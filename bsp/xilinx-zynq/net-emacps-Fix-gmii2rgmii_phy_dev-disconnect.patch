From 8aff356fd6a047bb086e146fc087166a6f46ba8b Mon Sep 17 00:00:00 2001
From: Thomas Betker <thomas.betker@rohde-schwarz.com>
Date: Sun, 21 Jun 2015 17:46:15 +0200
Subject: [PATCH 26/77] net: emacps: Fix gmii2rgmii_phy_dev disconnect

In xemacps_mii_probe(), when connecting lp->phy_node fails, clean up
and disconnect lp->gmii2rgmii_phy_dev [which may be already connected].

In xemacps_close(), check lp->gmii2rgmii_phy_dev before disconnecting
it, not lp->gmii2rgmii_phy_node.

Signed-off-by: Thomas Betker <thomas.betker@rohde-schwarz.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
[zou:Original patch taken from
https://github.com/Xilinx/linux-xlnx.git Petalinux 2015.4]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/net/ethernet/xilinx/xilinx_emacps.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/net/ethernet/xilinx/xilinx_emacps.c b/drivers/net/ethernet/xilinx/xilinx_emacps.c
index 747141c..246dae9 100644
--- a/drivers/net/ethernet/xilinx/xilinx_emacps.c
+++ b/drivers/net/ethernet/xilinx/xilinx_emacps.c
@@ -827,6 +827,10 @@ static int xemacps_mii_probe(struct net_device *ndev)
 		if (!phydev) {
 			dev_err(&lp->pdev->dev, "%s: no gmii to rgmii converter found\n",
 			ndev->name);
+		if (lp->gmii2rgmii_phy_dev) {
+			phy_disconnect(lp->gmii2rgmii_phy_dev);
+			lp->gmii2rgmii_phy_dev = NULL;
+		}
 			return -1;
 		}
 		lp->gmii2rgmii_phy_dev = phydev;
-- 
1.7.5.4

