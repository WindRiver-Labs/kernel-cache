From fd197ab04e675f0ba34252888b85070f0ef4e3cf Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date: Sat, 1 Nov 2014 15:26:27 +0200
Subject: [PATCH 304/456] v4l: xilinx: dma: Return buffers to vb2 when
 start_streaming fails

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

vb2 expects the driver to return all queued buffers when the
start_streaming operation fails.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
(cherry picked from commit 16e8a9df9608f13c5d670ed3784b83ab8b7398d5)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-dma.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/drivers/media/platform/xilinx/xilinx-dma.c b/drivers/media/platform/xilinx/xilinx-dma.c
index 9be6345..1db16e8 100644
--- a/drivers/media/platform/xilinx/xilinx-dma.c
+++ b/drivers/media/platform/xilinx/xilinx-dma.c
@@ -468,6 +468,15 @@ static int xvip_dma_start_streaming(struct vb2_queue *vq, unsigned int count)
 
 error:
 	media_entity_pipeline_stop(&dma->video.entity);
+
+	/* Give back all queued buffers to videobuf2. */
+	spin_lock_irq(&dma->queued_lock);
+	list_for_each_entry_safe(buf, nbuf, &dma->queued_bufs, queue) {
+		vb2_buffer_done(&buf->buf, VB2_BUF_STATE_QUEUED);
+		list_del(&buf->queue);
+	}
+	spin_unlock_irq(&dma->queued_lock);
+
 	return ret;
 }
 
-- 
1.7.5.4

