From dad7cb8d34134dc2306a20c2aca970fcda514019 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Thu, 15 Oct 2015 14:02:25 +0800
Subject: [PATCH 71/80] mtd:spi-nor: Added 4byte addressing support in
 spi-nor.c

This commit 2f57262b comes from:
  https://github.com/Xilinx/linux-xlnx.git

Added 4 byte addressing support in spi_nor_read,spi_nor_write and
spi_nor_erase functions.

Signed-off-by: Anurag Kumar Vulisha <anuragku@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/mtd/spi-nor/spi-nor.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/mtd/spi-nor/spi-nor.c b/drivers/mtd/spi-nor/spi-nor.c
index cd37127..1a667d4 100644
--- a/drivers/mtd/spi-nor/spi-nor.c
+++ b/drivers/mtd/spi-nor/spi-nor.c
@@ -1013,7 +1013,10 @@ static int spi_nor_read_ext(struct mtd_info *mtd, loff_t from, size_t len,
 	ret = spi_nor_lock_and_prep(nor, SPI_NOR_OPS_READ);
 	if (ret)
 		return ret;
-
+	if (nor->addr_width == 4) {
+		ret = nor->read(nor, from, len, retlen, buf);
+		goto read_err;
+	}
 	while (len) {
 		bank = addr / (OFFSET_16_MB << nor->shift);
 		rem_bank_len = ((OFFSET_16_MB << nor->shift) * (bank + 1)) -
@@ -1047,8 +1050,9 @@ static int spi_nor_read_ext(struct mtd_info *mtd, loff_t from, size_t len,
 
 	*retlen = read_count;
 
+read_err:
 	spi_nor_unlock_and_unprep(nor, SPI_NOR_OPS_READ);
-	return 0;
+	return ret;
 }
 
 static int sst_write(struct mtd_info *mtd, loff_t to, size_t len,
-- 
2.0.2

