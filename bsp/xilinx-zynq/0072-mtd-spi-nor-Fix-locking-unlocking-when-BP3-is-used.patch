From 0978bd87c3cfbffdba1d169d38fdc49f70c3de8e Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Thu, 15 Oct 2015 14:06:13 +0800
Subject: [PATCH 72/80] mtd: spi-nor: Fix locking/unlocking when BP3 is used

This commit 5bd80478 comes from:
  https://github.com/Xilinx/linux-xlnx.git

Fix status register parsing error when 3rd block protect bit
is used.

Signed-off-by: Jesper B. Christensen <jesper.christensen@cobham.com>
Reviewed-by: Harini Katakam <harinik@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/mtd/spi-nor/spi-nor.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/drivers/mtd/spi-nor/spi-nor.c b/drivers/mtd/spi-nor/spi-nor.c
index 1a667d4..ea0a4bc 100644
--- a/drivers/mtd/spi-nor/spi-nor.c
+++ b/drivers/mtd/spi-nor/spi-nor.c
@@ -609,6 +609,18 @@ static int write_sr_modify_protection(struct spi_nor *nor, uint8_t status,
 	return 0;
 }
 
+static uint8_t bp_bits_from_sr(struct spi_nor *nor, uint8_t status)
+{
+    uint8_t ret;
+
+    ret = (((status) & SR_BP_BIT_MASK) >> SR_BP_BIT_OFFSET);
+    if (nor->jedec_id == 0x20) {
+        ret |= ((status & SR_BP3) >> (SR_BP_BIT_OFFSET + 1));
+    }
+
+    return ret;
+}
+
 static int spi_nor_lock(struct mtd_info *mtd, loff_t ofs, uint64_t len)
 {
 	struct spi_nor *nor = mtd_to_spi_nor(mtd);
-- 
2.0.2

