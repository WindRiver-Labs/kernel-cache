From 77ddede15cb40f569e9ebc5755834d24d0a3bff9 Mon Sep 17 00:00:00 2001
From: Maarten Brock <m.brock@vanmierlo.com>
Date: Tue, 13 Oct 2015 11:01:31 +0200
Subject: [PATCH 65/77] dma: xilinx: xilinx_dma: Fix bugs in transfers.

Fix wrong XILINX_DMA_REG_DSTADDR value by merging with XILINX_DMA_REG_SRCADDR into XILINX_DMA_REG_SRCDSTADDR.
Also fix misplaced '{' to start transfer in both directions.

Signed-off-by: Maarten Brock <m.brock@vanmierlo.com>
Reviewed-by: Kedareswara rao Appana <appanad@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
[zou:Original patch taken from
https://github.com/Xilinx/linux-xlnx.git Petalinux 2015.4]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/dma/xilinx/xilinx_dma.c |   23 ++++-------------------
 1 files changed, 4 insertions(+), 19 deletions(-)

diff --git a/drivers/dma/xilinx/xilinx_dma.c b/drivers/dma/xilinx/xilinx_dma.c
index 93433c6..b2e6dbb 100644
--- a/drivers/dma/xilinx/xilinx_dma.c
+++ b/drivers/dma/xilinx/xilinx_dma.c
@@ -40,10 +40,8 @@
 #define XILINX_DMA_REG_CURDESCMSB	0x0C
 #define XILINX_DMA_REG_TAILDESC		0x10
 #define XILINX_DMA_REG_TAILDESCMSB	0x14
-#define XILINX_DMA_REG_SRCADDR		0x18
-#define XILINX_DMA_REG_SRCADDRMSB	0x1C
-#define XILINX_DMA_REG_DSTADDR		0x20
-#define XILINX_DMA_REG_DSTADDRMSB	0x24
+#define XILINX_DMA_REG_SRCDSTADDR	0x18
+#define XILINX_DMA_REG_SRCDSTADDRMSB	0x1C
 #define XILINX_DMA_REG_BTT		0x28
 
 /* Channel/Descriptor Offsets */
@@ -641,27 +639,14 @@ static void xilinx_dma_start_transfer(struct xilinx_dma_chan *chan)
 					   struct xilinx_dma_tx_segment, node);
 		hw = &segment->hw;
 
-		if (head_desc->direction == DMA_MEM_TO_DEV) {
 #ifdef CONFIG_PHYS_ADDR_T_64BIT
-			dma_ctrl_writeq(chan, XILINX_DMA_REG_SRCADDR,
-					hw->buf_addr);
+		dma_ctrl_writeq(chan, XILINX_DMA_REG_SRCDSTADDR, hw->buf_addr);
 #else
-			dma_ctrl_write(chan, XILINX_DMA_REG_SRCADDR,
-				       hw->buf_addr);
+		dma_ctrl_write(chan, XILINX_DMA_REG_SRCDSTADDR, hw->buf_addr);
 #endif
-		} else {
-#ifdef CONFIG_PHYS_ADDR_T_64BIT
-			dma_ctrl_writeq(chan, XILINX_DMA_REG_DSTADDR,
-					hw->buf_addr);
-#else
-			dma_ctrl_write(chan, XILINX_DMA_REG_DSTADDR,
-				       hw->buf_addr);
-#endif
-
 		/* Start the transfer */
 		dma_ctrl_write(chan, XILINX_DMA_REG_BTT,
 			       hw->control & XILINX_DMA_MAX_TRANS_LEN);
-		}
 	}
 
 	list_splice_tail_init(&chan->pending_list, &chan->active_list);
-- 
1.7.5.4

