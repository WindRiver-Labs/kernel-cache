From 5769ebacf06123b4a7a28c60219370f0f89a6306 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Mon, 22 Apr 2013 15:21:13 +0800
Subject: [PATCH 10/13] arm: zynq: fix smp_twd clock not found

Since smp_twd init depend on the clock of smp_twd,
So the clock must be initialized before the smp_twd.

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-zynq/board_zc702.c |   14 ++++++++++++++
 arch/arm/mach-zynq/common.c      |    2 --
 arch/arm/mach-zynq/common.h      |    1 +
 arch/arm/mach-zynq/timer.c       |    9 +--------
 4 files changed, 16 insertions(+), 10 deletions(-)

diff --git a/arch/arm/mach-zynq/board_zc702.c b/arch/arm/mach-zynq/board_zc702.c
index 464c08a..8685354 100644
--- a/arch/arm/mach-zynq/board_zc702.c
+++ b/arch/arm/mach-zynq/board_zc702.c
@@ -18,6 +18,7 @@
 #include <asm/mach-types.h>
 #include <asm/mach/arch.h>
 #include <asm/hardware/gic.h>
+#include <mach/clk.h>
 
 #include "common.h"
 
@@ -31,6 +32,19 @@ static void __init board_zc702_init(void)
 
 }
 
+static void __init xilinx_zynq_timer_init(void)
+{
+	zynq_clock_init();
+	xttcpss_timer_init();
+}
+
+/*
+ * Instantiate and initialize the system timer structure
+ */
+struct sys_timer xttcpss_sys_timer = {
+	.init	= xilinx_zynq_timer_init,
+};
+
 static const char *xilinx_dt_match[] __initdata = {
 	"xlnx,zynq-zc702",
 	"xlnx,zynq-zc706",
diff --git a/arch/arm/mach-zynq/common.c b/arch/arm/mach-zynq/common.c
index 8df986a..a94a133 100644
--- a/arch/arm/mach-zynq/common.c
+++ b/arch/arm/mach-zynq/common.c
@@ -33,7 +33,6 @@
 #include <asm/hardware/cache-l2x0.h>
 
 #include <mach/zynq_soc.h>
-#include <mach/clk.h>
 #include <mach/pdev.h>
 #include <mach/slcr.h>
 #include "common.h"
@@ -115,7 +114,6 @@ static void __init xilinx_opp_init(void) {}
  */
 void __init xilinx_init_machine(void)
 {
-	zynq_clock_init();
 	of_platform_populate(NULL, zynq_of_bus_ids, NULL, NULL);
 
 #ifdef CONFIG_CACHE_L2X0
diff --git a/arch/arm/mach-zynq/common.h b/arch/arm/mach-zynq/common.h
index 7f07225..c9e69aa 100644
--- a/arch/arm/mach-zynq/common.h
+++ b/arch/arm/mach-zynq/common.h
@@ -29,4 +29,5 @@ void xilinx_memory_init(void);
 void zynq_reset(char mode, const char *cmd);
 
 void platform_device_init(void);
+void __init xttcpss_timer_init(void);
 #endif
diff --git a/arch/arm/mach-zynq/timer.c b/arch/arm/mach-zynq/timer.c
index 042f3bf..5d3e88e 100644
--- a/arch/arm/mach-zynq/timer.c
+++ b/arch/arm/mach-zynq/timer.c
@@ -296,7 +296,7 @@ static struct clock_event_device xttcpss_clockevent = {
  * Initializes the timer hardware and register the clock source and clock event
  * timers with Linux kernal timer framework
  **/
-static void __init xttcpss_timer_init(void)
+void __init xttcpss_timer_init(void)
 {
 	u32 irq;
 	struct device_node *timer = NULL;
@@ -392,10 +392,3 @@ static void __init xttcpss_timer_init(void)
 
 	zynq_twd_init();
 }
-
-/*
- * Instantiate and initialize the system timer structure
- */
-struct sys_timer xttcpss_sys_timer = {
-	.init		= xttcpss_timer_init,
-};
-- 
1.7.5.4

