From 360a19613466b522e1590764b9332a230b0ef49f Mon Sep 17 00:00:00 2001
From: Lars-Peter Clausen <lars@metafoo.de>
Date: Tue, 25 Jun 2013 18:46:12 +0200
Subject: [PATCH 239/509] DRM: adi_axi_hdmi: Always stop DMA transfers before
 starting a new one

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit b8e4a8df5c2d00b77c64d43d0ef61be1a46ebfee

Make sure to always stop the DMA transfer before a new one is started.

Signed-off-by: Lars-Peter Clausen <lars@metafoo.de>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_crtc.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_crtc.c b/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_crtc.c
index 460deac..00aab2a 100644
--- a/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_crtc.c
+++ b/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_crtc.c
@@ -43,6 +43,8 @@ static int axi_hdmi_crtc_update(struct drm_crtc *crtc)
 	if (!mode || !fb)
 		return -EINVAL;
 
+	dmaengine_terminate_all(axi_hdmi_crtc->dma);
+
 	if (axi_hdmi_crtc->mode == DRM_MODE_DPMS_ON) {
 		obj = drm_fb_cma_get_gem_obj(fb, 0);
 		if (!obj)
@@ -68,8 +70,6 @@ static int axi_hdmi_crtc_update(struct drm_crtc *crtc)
 			dmaengine_submit(desc);
 			dma_async_issue_pending(axi_hdmi_crtc->dma);
 		}
-	} else {
-		dmaengine_terminate_all(axi_hdmi_crtc->dma);
 	}
 
 	return 0;
-- 
1.7.5.4

