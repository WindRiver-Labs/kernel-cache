From 82e89be830787c96dd456798d2e48a6690f51e04 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Fri, 13 Jul 2012 12:47:22 +0800
Subject: [PATCH 06/36] arm/zynq: Add platform device support for pmu

SDK: yocto-1.2(http://git.yoctoproject.org/cgit.cgi/meta-zynq/)

Signed-off-by: Vlad Lungu <vlad.lungu@windriver.com>
Integrated-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 arch/arm/mach-zynq/Makefile           |    2 +-
 arch/arm/mach-zynq/common.c           |    2 +
 arch/arm/mach-zynq/common.h           |    2 +
 arch/arm/mach-zynq/platform_devices.c |   70 +++++++++++++++++++++++++++++++++
 4 files changed, 75 insertions(+), 1 deletion(-)
 create mode 100644 arch/arm/mach-zynq/platform_devices.c

diff --git a/arch/arm/mach-zynq/Makefile b/arch/arm/mach-zynq/Makefile
index 4dc4d3c..ffb33cb 100644
--- a/arch/arm/mach-zynq/Makefile
+++ b/arch/arm/mach-zynq/Makefile
@@ -3,6 +3,6 @@
 #
 
 # Common support
-obj-y:= common.o timer.o clock.o board_zc702.o
+obj-y:= common.o timer.o clock.o board_zc702.o platform_devices.o
 
 obj-$(CONFIG_SMP) += platsmp.o
diff --git a/arch/arm/mach-zynq/common.c b/arch/arm/mach-zynq/common.c
index 0434447..ca7897f 100644
--- a/arch/arm/mach-zynq/common.c
+++ b/arch/arm/mach-zynq/common.c
@@ -58,6 +58,8 @@ void __init xilinx_init_machine(void)
 	l2x0_of_init(0x72060000, 0xF0F0FFFF);
 #endif
 #endif
+
+	platform_device_init();
 }
 
 static const struct of_device_id xilinx_dt_irq_match[] __initconst = {
diff --git a/arch/arm/mach-zynq/common.h b/arch/arm/mach-zynq/common.h
index 33be71e..ed22a30 100644
--- a/arch/arm/mach-zynq/common.h
+++ b/arch/arm/mach-zynq/common.h
@@ -26,4 +26,6 @@ void xilinx_init_machine(void);
 void xilinx_irq_init(void);
 void xilinx_map_io(void);
 void xilinx_memory_init(void);
+
+void platform_device_init(void);
 #endif
diff --git a/arch/arm/mach-zynq/platform_devices.c b/arch/arm/mach-zynq/platform_devices.c
new file mode 100644
index 0000000..ab96053
--- /dev/null
+++ b/arch/arm/mach-zynq/platform_devices.c
@@ -0,0 +1,70 @@
+/*
+ * Copyright (C) 2011 Xilinx
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
+
+#include <linux/kernel.h>
+#include <linux/init.h>
+#include <linux/platform_device.h>
+#include <linux/device.h>
+#include <linux/module.h>
+#include <asm/pmu.h>
+#include "common.h"
+
+static struct resource xilinx_pmu_resource = {
+	.start	= 37,
+	.end	= 38,
+	.flags	= IORESOURCE_IRQ,
+};
+
+static struct platform_device xilinx_pmu_device = {
+	.name		= "arm-pmu",
+	.id		= ARM_PMU_DEVICE_CPU,
+	.num_resources	= 1,
+	.resource	= &xilinx_pmu_resource,
+};
+
+/* add all platform devices to the following table so they
+ * will be registered
+ */
+struct platform_device *xilinx_pdevices[] __initdata = {
+	&xilinx_pmu_device,
+};
+
+
+/**
+ * platform_device_init - Initialize all the platform devices.
+ *
+ **/
+void __init platform_device_init(void)
+{
+	int ret, i;
+	struct platform_device **devptr;
+	int size;
+
+	devptr = &xilinx_pdevices[0];
+	size = ARRAY_SIZE(xilinx_pdevices);
+
+	ret = 0;
+
+	/* Initialize all the platform devices */
+
+	for (i = 0; i < size; i++, devptr++) {
+		pr_info("registering platform device '%s' id %d\n",
+			(*devptr)->name,
+			(*devptr)->id);
+			ret = platform_device_register(*devptr);
+		if (ret)
+			pr_info("Unable to register platform device '%s': %d\n",
+				(*devptr)->name, ret);
+	}
+
+}
-- 
1.7.9.7

