From 35e4ae6a7842de44918ae468a1d7fc9da5b5795f Mon Sep 17 00:00:00 2001
From: Lars-Peter Clausen <lars@metafoo.de>
Date: Sat, 23 Mar 2013 14:54:24 +0100
Subject: [PATCH 232/509] drm: adi-axi-hdmi: Switch to generic dma bindings

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit 121cc55f54e837672d87b3cce87f6bf56d821c62

Signed-off-by: Lars-Peter Clausen <lars@metafoo.de>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_crtc.c |   22 +---------------------
 drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_drv.c  |   15 ++++++---------
 drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_drv.h  |    3 ++-
 3 files changed, 9 insertions(+), 31 deletions(-)

diff --git a/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_crtc.c b/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_crtc.c
index 5dc3ad5..460deac 100644
--- a/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_crtc.c
+++ b/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_crtc.c
@@ -140,7 +140,6 @@ static void axi_hdmi_crtc_destroy(struct drm_crtc *crtc)
 	struct axi_hdmi_crtc *axi_hdmi_crtc = to_axi_hdmi_crtc(crtc);
 
 	drm_crtc_cleanup(crtc);
-	dma_release_channel(axi_hdmi_crtc->dma);
 	kfree(axi_hdmi_crtc);
 }
 
@@ -149,22 +148,12 @@ static struct drm_crtc_funcs axi_hdmi_crtc_funcs = {
 	.destroy	= axi_hdmi_crtc_destroy,
 };
 
-static bool xlnx_pcm_filter(struct dma_chan *chan, void *param)
-{
-	struct xlnx_pcm_dma_params *p = param;
-
-	return chan->device->dev->of_node == p->of_node &&
-		chan->chan_id == p->chan_id;
-}
-
 struct drm_crtc *axi_hdmi_crtc_create(struct drm_device *dev)
 {
 	struct axi_hdmi_private *p = dev->dev_private;
 	struct axi_hdmi_crtc *axi_hdmi_crtc;
 	struct drm_crtc *crtc;
 
-	dma_cap_mask_t mask;
-
 	axi_hdmi_crtc = kzalloc(sizeof(*axi_hdmi_crtc), GFP_KERNEL);
 	if (!axi_hdmi_crtc) {
 		DRM_ERROR("failed to allocate axi_hdmi crtc\n");
@@ -173,16 +162,7 @@ struct drm_crtc *axi_hdmi_crtc_create(struct drm_device *dev)
 
 	crtc = &axi_hdmi_crtc->drm_crtc;
 
-	dma_cap_zero(mask);
-	dma_cap_set(DMA_SLAVE, mask);
-	dma_cap_set(DMA_PRIVATE, mask);
-
-	axi_hdmi_crtc->dma = dma_request_channel(mask, xlnx_pcm_filter,
-						&p->dma_params);
-	if (!axi_hdmi_crtc->dma) {
-		kfree(axi_hdmi_crtc);
-		return ERR_PTR(-EINVAL);
-	}
+	axi_hdmi_crtc->dma = p->dma;
 
 	drm_crtc_init(dev, crtc, &axi_hdmi_crtc_funcs);
 	drm_crtc_helper_add(crtc, &axi_hdmi_crtc_helper_funcs);
diff --git a/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_drv.c b/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_drv.c
index 06046b8..16542f0 100644
--- a/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_drv.c
+++ b/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_drv.c
@@ -14,6 +14,7 @@
 #include <linux/i2c.h>
 #include <linux/of_address.h>
 #include <linux/of_i2c.h>
+#include <linux/of_dma.h>
 #include <linux/clk.h>
 
 #include <drm/drmP.h>
@@ -143,15 +144,8 @@ static struct drm_driver axi_hdmi_driver = {
 static int axi_hdmi_platform_probe(struct platform_device *pdev)
 {
 	struct axi_hdmi_private *private;
-	struct of_phandle_args dma_spec;
 	struct device_node *slave_node;
 	struct resource *res;
-	int ret;
-
-	ret = of_parse_phandle_with_args(pdev->dev.of_node, "dma-request",
-			"#dma-cells", 0, &dma_spec);
-	if (ret)
-		return ret;
 
 	private = devm_kzalloc(&pdev->dev, sizeof(*private), GFP_KERNEL);
 	if (!private)
@@ -178,8 +172,9 @@ static int axi_hdmi_platform_probe(struct platform_device *pdev)
 	if (!private->encoder_slave)
 		return -EPROBE_DEFER;
 
-	private->dma_params.of_node = dma_spec.np;
-	private->dma_params.chan_id = dma_spec.args[0];
+	private->dma = of_dma_request_slave_channel(pdev->dev.of_node, "video");
+	if (private->dma == NULL)
+		return -EPROBE_DEFER;
 
 	platform_set_drvdata(pdev, private);
 
@@ -188,7 +183,9 @@ static int axi_hdmi_platform_probe(struct platform_device *pdev)
 
 static int axi_hdmi_platform_remove(struct platform_device *pdev)
 {
+	struct axi_hdmi_private *private = platform_get_drvdata(pdev);
 	drm_platform_exit(&axi_hdmi_driver, pdev);
+	dma_release_channel(private->dma);
 	return 0;
 }
 
diff --git a/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_drv.h b/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_drv.h
index 5eb5d49..a594440 100644
--- a/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_drv.h
+++ b/drivers/gpu/drm/adi_axi_hdmi/axi_hdmi_drv.h
@@ -32,7 +32,8 @@ struct axi_hdmi_private {
 
 	struct clk *hdmi_clock;
 
-	struct xlnx_pcm_dma_params dma_params;
+	struct dma_chan *dma;
+
 	bool is_rgb;
 };
 
-- 
1.7.5.4

