From cdfd85bab3445da1c56528880363d6023f80ab10 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Tue, 3 Feb 2015 14:14:03 +0800
Subject: [PATCH 455/456] ASoC: Codec: fix the right call relationship among
 ADAU

The original calls between driver and bus register was not right,
and this patch fixes this issue avoiding the driver crash.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 sound/soc/codecs/adau1761-i2c.c |    2 +-
 sound/soc/codecs/adau1761.c     |    6 +++---
 sound/soc/codecs/adau1761.h     |    2 +-
 sound/soc/codecs/adau17x1.c     |    8 ++++++--
 sound/soc/codecs/adau17x1.h     |    3 ++-
 5 files changed, 13 insertions(+), 8 deletions(-)

diff --git a/sound/soc/codecs/adau1761-i2c.c b/sound/soc/codecs/adau1761-i2c.c
index 862796d..2009c88 100644
--- a/sound/soc/codecs/adau1761-i2c.c
+++ b/sound/soc/codecs/adau1761-i2c.c
@@ -24,7 +24,7 @@ static int adau1761_i2c_probe(struct i2c_client *client,
 	config.val_bits = 8;
 	config.reg_bits = 16;
 
-	return adau1761_probe(&client->dev,
+	return adau1761_bus_probe(&client->dev,
 		devm_regmap_init_i2c(client, &config),
 		id->driver_data, NULL);
 }
diff --git a/sound/soc/codecs/adau1761.c b/sound/soc/codecs/adau1761.c
index f8d73d2..c56d2624 100644
--- a/sound/soc/codecs/adau1761.c
+++ b/sound/soc/codecs/adau1761.c
@@ -903,7 +903,7 @@ static struct adau1761_platform_data zed_pdata = {
 	.digmic_jackdetect_pin_mode = ADAU1761_DIGMIC_JACKDET_PIN_MODE_NONE,
 };
 
-int adau1761_probe(struct device *dev, struct regmap *regmap,
+int adau1761_bus_probe(struct device *dev, struct regmap *regmap,
 	enum adau17x1_type type, void (*switch_mode)(struct device *dev))
 {
 	struct snd_soc_dai_driver *dai_drv;
@@ -913,7 +913,7 @@ int adau1761_probe(struct device *dev, struct regmap *regmap,
 	if (!dev->platform_data)
 		dev->platform_data = &zed_pdata;
 
-	ret = adau17x1_probe(dev, regmap, type, switch_mode);
+	ret = adau17x1_bus_probe(dev, regmap, type, switch_mode);
 	if (ret)
 		return ret;
 
@@ -924,7 +924,7 @@ int adau1761_probe(struct device *dev, struct regmap *regmap,
 
 	return snd_soc_register_codec(dev, &adau1761_codec_driver, dai_drv, 1);
 }
-EXPORT_SYMBOL_GPL(adau1761_probe);
+EXPORT_SYMBOL_GPL(adau1761_bus_probe);
 
 const struct regmap_config adau1761_regmap_config = {
 	.val_bits = 8,
diff --git a/sound/soc/codecs/adau1761.h b/sound/soc/codecs/adau1761.h
index a9e0d28..6395592 100644
--- a/sound/soc/codecs/adau1761.h
+++ b/sound/soc/codecs/adau1761.h
@@ -15,7 +15,7 @@
 
 struct device;
 
-int adau1761_probe(struct device *dev, struct regmap *regmap,
+int adau1761_bus_probe(struct device *dev, struct regmap *regmap,
 	enum adau17x1_type type, void (*switch_mode)(struct device *dev));
 
 extern const struct regmap_config adau1761_regmap_config;
diff --git a/sound/soc/codecs/adau17x1.c b/sound/soc/codecs/adau17x1.c
index fcb060f..8f66b02 100644
--- a/sound/soc/codecs/adau17x1.c
+++ b/sound/soc/codecs/adau17x1.c
@@ -774,6 +774,10 @@ int adau17x1_add_widgets(struct snd_soc_codec *codec)
 	struct adau *adau = snd_soc_codec_get_drvdata(codec);
 	int ret;
 
+        ret = snd_soc_codec_set_cache_io(codec, 0, 0, SND_SOC_REGMAP);
+        if (ret)
+                return ret;
+
 	ret = snd_soc_add_codec_controls(codec, adau17x1_controls,
 		ARRAY_SIZE(adau17x1_controls));
 	if (ret)
@@ -836,7 +840,7 @@ int adau17x1_resume(struct snd_soc_codec *codec)
 }
 EXPORT_SYMBOL_GPL(adau17x1_resume);
 
-int adau17x1_probe(struct device *dev, struct regmap *regmap,
+int adau17x1_bus_probe(struct device *dev, struct regmap *regmap,
 	enum adau17x1_type type, void (*switch_mode)(struct device *dev))
 {
 	struct adau *adau;
@@ -859,7 +863,7 @@ int adau17x1_probe(struct device *dev, struct regmap *regmap,
 
 	return 0;
 }
-EXPORT_SYMBOL_GPL(adau17x1_probe);
+EXPORT_SYMBOL_GPL(adau17x1_bus_probe);
 
 MODULE_DESCRIPTION("ASoC ADAU1X61/ADAU1X81 common code");
 MODULE_AUTHOR("Lars-Peter Clausen <lars@metafoo.de>");
diff --git a/sound/soc/codecs/adau17x1.h b/sound/soc/codecs/adau17x1.h
index 3ffabaf..330d286 100644
--- a/sound/soc/codecs/adau17x1.h
+++ b/sound/soc/codecs/adau17x1.h
@@ -46,8 +46,9 @@ struct adau {
 
 int adau17x1_add_widgets(struct snd_soc_codec *codec);
 int adau17x1_add_routes(struct snd_soc_codec *codec);
-int adau17x1_probe(struct device *dev, struct regmap *regmap,
+int adau17x1_bus_probe(struct device *dev, struct regmap *regmap,
 	enum adau17x1_type type, void (*switch_mode)(struct device *dev));
+
 int adau17x1_set_micbias_voltage(struct snd_soc_codec *codec,
 	enum adau17x1_micbias_voltage micbias);
 bool adau17x1_readable_register(struct device *dev, unsigned int reg);
-- 
1.7.5.4

