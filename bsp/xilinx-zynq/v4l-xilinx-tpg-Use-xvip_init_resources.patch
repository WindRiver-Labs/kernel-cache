From 0235855a17f55f5e41c8b496d79c69fd6bacaa0a Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date: Thu, 27 Nov 2014 04:03:15 +0200
Subject: [PATCH 314/456] v4l: xilinx: tpg: Use xvip_init_resources()

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Replace the manual ioremap by a call to xvip_init_resources(), which
also handles the functional clock.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
(cherry picked from commit d23e24dbe42d24488b463e8eb8ab9dfd4d50502a)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 .../bindings/media/xilinx/xlnx,v-tpg.txt           |    3 ++
 drivers/media/platform/xilinx/xilinx-tpg.c         |   26 +++++++++++--------
 2 files changed, 18 insertions(+), 11 deletions(-)

diff --git a/Documentation/devicetree/bindings/media/xilinx/xlnx,v-tpg.txt b/Documentation/devicetree/bindings/media/xilinx/xlnx,v-tpg.txt
index c6de1e3..ffc47a9 100644
--- a/Documentation/devicetree/bindings/media/xilinx/xlnx,v-tpg.txt
+++ b/Documentation/devicetree/bindings/media/xilinx/xlnx,v-tpg.txt
@@ -13,6 +13,8 @@ Required properties:
 
 - reg: Physical base address and length of the registers set for the device.
 
+- clocks: Reference to the video core clock.
+
 - xlnx,video-format, xlnx,video-width: Video format and width, as defined in
   video.txt.
 
@@ -36,6 +38,7 @@ Example:
 	tpg_0: tpg@40050000 {
 		compatible = "xlnx,v-tpg-6.0", "xlnx,v-tpg-5.0";
 		reg = <0x40050000 0x10000>;
+		clocks = <&clkc 15>;
 
 		xlnx,vtc = <&vtc_3>;
 		timing-gpios = <&ps7_gpio_0 55 GPIO_ACTIVE_LOW>;
diff --git a/drivers/media/platform/xilinx/xilinx-tpg.c b/drivers/media/platform/xilinx/xilinx-tpg.c
index dfdec7a..bb1e65d 100644
--- a/drivers/media/platform/xilinx/xilinx-tpg.c
+++ b/drivers/media/platform/xilinx/xilinx-tpg.c
@@ -762,7 +762,6 @@ static int xtpg_probe(struct platform_device *pdev)
 {
 	struct v4l2_subdev *subdev;
 	struct xtpg_device *xtpg;
-	struct resource *res;
 	u32 i, bayer_phase;
 	int ret;
 
@@ -776,20 +775,23 @@ static int xtpg_probe(struct platform_device *pdev)
 	if (ret < 0)
 		return ret;
 
-	res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
-	xtpg->xvip.iomem = devm_ioremap_resource(&pdev->dev, res);
-	if (IS_ERR(xtpg->xvip.iomem))
-		return PTR_ERR(xtpg->xvip.iomem);
+	ret = xvip_init_resources(&xtpg->xvip);
+	if (ret < 0)
+		return ret;
 
 	xtpg->vtmux_gpio = devm_gpiod_get_index(&pdev->dev, "timing", 0);
-	if (PTR_ERR(xtpg->vtmux_gpio) == -EPROBE_DEFER)
-		return -EPROBE_DEFER;
+	if (PTR_ERR(xtpg->vtmux_gpio) == -EPROBE_DEFER) {
+		ret = -EPROBE_DEFER;
+		goto error;
+	}
 	if (!IS_ERR(xtpg->vtmux_gpio))
 		gpiod_direction_output(xtpg->vtmux_gpio, 1);
 
 	xtpg->vtc = xvtc_of_get(pdev->dev.of_node);
-	if (IS_ERR(xtpg->vtc))
-		return PTR_ERR(xtpg->vtc);
+	if (IS_ERR(xtpg->vtc)) {
+		ret = PTR_ERR(xtpg->vtc);
+		goto error;
+	}
 
 	/* Reset and initialize the core */
 	xvip_reset(&xtpg->xvip);
@@ -830,7 +832,7 @@ static int xtpg_probe(struct platform_device *pdev)
 
 	ret = media_entity_init(&subdev->entity, xtpg->npads, xtpg->pads, 0);
 	if (ret < 0)
-		goto error_media_init;
+		goto error;
 
 	v4l2_ctrl_handler_init(&xtpg->ctrl_handler, 3 + ARRAY_SIZE(xtpg_ctrls));
 
@@ -878,8 +880,8 @@ static int xtpg_probe(struct platform_device *pdev)
 error:
 	v4l2_ctrl_handler_free(&xtpg->ctrl_handler);
 	media_entity_cleanup(&subdev->entity);
-error_media_init:
 	xvtc_put(xtpg->vtc);
+	xvip_cleanup_resources(&xtpg->xvip);
 	return ret;
 }
 
@@ -892,6 +894,8 @@ static int xtpg_remove(struct platform_device *pdev)
 	v4l2_ctrl_handler_free(&xtpg->ctrl_handler);
 	media_entity_cleanup(&subdev->entity);
 
+	xvip_cleanup_resources(&xtpg->xvip);
+
 	return 0;
 }
 
-- 
1.7.5.4

