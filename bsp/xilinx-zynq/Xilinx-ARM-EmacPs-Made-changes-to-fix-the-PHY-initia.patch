From 5c1a644a5c04dd17b42d76c7be32248c0afd1584 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Tue, 21 Aug 2012 16:23:54 +0800
Subject: [PATCH 32/36] Xilinx: ARM: EmacPs: Made changes to fix the PHY
 initialization issues

A wrong PHY address in the device tree was crashing the kernel. The patch
fixes this issue.

Signed-off-by: Anirudha <anirudh@xilinx.com>
Integrated-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 drivers/net/ethernet/xilinx/xilinx_emacps.c |   23 ++++++++++++++---------
 1 file changed, 14 insertions(+), 9 deletions(-)

diff --git a/drivers/net/ethernet/xilinx/xilinx_emacps.c b/drivers/net/ethernet/xilinx/xilinx_emacps.c
index 3be9170..f4e2b8f 100644
--- a/drivers/net/ethernet/xilinx/xilinx_emacps.c
+++ b/drivers/net/ethernet/xilinx/xilinx_emacps.c
@@ -281,6 +281,10 @@ static int xemacps_mii_probe(struct net_device *ndev)
 					0,
 					PHY_INTERFACE_MODE_RGMII_ID);
 	}
+	if (!phydev) {
+		printk(KERN_ERR "%s: no PHY found\n", ndev->name);
+		return -1;
+	}
 #else
 	for (phy_addr = 0; phy_addr < PHY_MAX_ADDR; phy_addr++) {
 		if (lp->mii_bus->phy_map[phy_addr]) {
@@ -299,17 +303,15 @@ static int xemacps_mii_probe(struct net_device *ndev)
 
 	if (IS_ERR(phydev)) {
 		printk(KERN_ERR "%s: can not connect phy\n", ndev->name);
-		return -1;
+		return -2;
 	}
 #endif
 #ifdef DEBUG
 	printk(KERN_INFO "GEM: phydev %p, phydev->phy_id 0x%x, phydev->addr 0x%x\n",
 		phydev, phydev->phy_id, phydev->addr);
 #endif
-	phydev->supported |= PHY_GBIT_FEATURES;
-	phydev->supported |= SUPPORTED_Pause;
-	phydev->supported |= SUPPORTED_Asym_Pause;
-
+	phydev->supported &= (PHY_GBIT_FEATURES | SUPPORTED_Pause |
+							SUPPORTED_Asym_Pause);
 	phydev->advertising = phydev->supported;
 
 	lp->link    = 0;
@@ -1586,11 +1588,14 @@ static int xemacps_open(struct net_device *ndev)
 	}
 	xemacps_init_hw(lp);
 	napi_enable(&lp->napi);
-	if (xemacps_mii_probe(ndev) != 0) {
+	rc = xemacps_mii_probe(ndev);
+	if (rc != 0) {
 		printk(KERN_ERR "%s mii_probe fail.\n", lp->mii_bus->name);
-		mdiobus_unregister(lp->mii_bus);
-		kfree(lp->mii_bus->irq);
-		mdiobus_free(lp->mii_bus);
+		if (rc == (-2)) {
+			mdiobus_unregister(lp->mii_bus);
+			kfree(lp->mii_bus->irq);
+			mdiobus_free(lp->mii_bus);
+		}
 		return -ENXIO;
 	}
 
-- 
1.7.9.7

