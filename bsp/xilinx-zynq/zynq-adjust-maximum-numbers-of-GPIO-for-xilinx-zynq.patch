From 07561df90133850c6cd2c693442cafb590ff95b0 Mon Sep 17 00:00:00 2001
From: Baogen Shang <baogen.shang@windriver.com>
Date: Fri, 13 Sep 2013 11:05:47 +0800
Subject: [PATCH] zynq: adjust maximum numbers of GPIO for xilinx-zynq

CQID: WIND00431321

In the Linux kernel/BSP code in the define "ARCH_NR_GPIOS" which is set
to 256 and the driver for the Xilinx GPIO driver which already allocates
246 GPIOs.It leads to that the Xilinx-zynq BSP does not allow to add more
than 10 further GPIO in the system.So we must adjust maximum numbers of
GPIO for xilinx-zynq,and make the numbers of GPIO configurable.

Signed-off-by: Baogen Shang <baogen.shang@windriver.com>
---
 arch/arm/Kconfig                       |    4 +++-
 arch/arm/include/asm/irq.h             |    3 +++
 arch/arm/mach-zynq/include/mach/gpio.h |    1 -
 arch/arm/mach-zynq/include/mach/irqs.h |    1 -
 4 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/arch/arm/Kconfig b/arch/arm/Kconfig
index 219d523..e3c9283 100644
--- a/arch/arm/Kconfig
+++ b/arch/arm/Kconfig
@@ -1660,7 +1660,9 @@ config LOCAL_TIMERS
 	  "thundering herd" at every timer tick.
 
 config ARCH_NR_GPIO
-	int
+	int "Maximum number of GPIOs (1-1024)" if ARCH_ZYNQ
+	range 1 1024 if ARCH_ZYNQ
+	default 256 if ARCH_ZYNQ
 	default 1024 if ARCH_SHMOBILE || ARCH_TEGRA
 	default 355 if ARCH_U8500
 	default 264 if MACH_H4700
diff --git a/arch/arm/include/asm/irq.h b/arch/arm/include/asm/irq.h
index 35c21c3..2a6de32 100644
--- a/arch/arm/include/asm/irq.h
+++ b/arch/arm/include/asm/irq.h
@@ -1,6 +1,9 @@
 #ifndef __ASM_ARM_IRQ_H
 #define __ASM_ARM_IRQ_H
 
+/*The macro CONFIG_ARCH_NR_GPIO can never be zero*/
+#define ARCH_NR_GPIOS CONFIG_ARCH_NR_GPIO
+
 #define NR_IRQS_LEGACY	16
 
 #ifndef CONFIG_SPARSE_IRQ
diff --git a/arch/arm/mach-zynq/include/mach/gpio.h b/arch/arm/mach-zynq/include/mach/gpio.h
index a669b68..a566f88 100644
--- a/arch/arm/mach-zynq/include/mach/gpio.h
+++ b/arch/arm/mach-zynq/include/mach/gpio.h
@@ -18,7 +18,6 @@
 #define __ASM_ARCH_GPIO_H
 
 
-#define ARCH_NR_GPIOS		256
 #define XGPIOPS_IRQBASE		256
 
 struct xgpio_platform_data {
diff --git a/arch/arm/mach-zynq/include/mach/irqs.h b/arch/arm/mach-zynq/include/mach/irqs.h
index b36d94b..0f33117 100644
--- a/arch/arm/mach-zynq/include/mach/irqs.h
+++ b/arch/arm/mach-zynq/include/mach/irqs.h
@@ -15,7 +15,6 @@
 #ifndef __MACH_IRQS_H
 #define __MACH_IRQS_H
 
-#define ARCH_NR_GPIOS	256
 #define NR_IRQS		(256 + ARCH_NR_GPIOS)
 #define XGPIOPS_IRQBASE	256
 
-- 
1.7.5.4

