From a5b208109e6989d1a247195bd6387a183e98352f Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Mon, 8 Apr 2013 15:12:27 +0800
Subject: [PATCH 07/13] arm: zynq: platsmp: Release lock in error path

git://git.xilinx.com/linux-xlnx.git master
commit 2063f7085f1880185a70a71221432f7067b23d4d

boot_secondary() aquired a spin lock but never released it
in case of an error.

Signed-off-by: Soren Brinkmann <soren.brinkmann@xilinx.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-zynq/platsmp.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-zynq/platsmp.c b/arch/arm/mach-zynq/platsmp.c
index bb79d0b..a352cb8 100644
--- a/arch/arm/mach-zynq/platsmp.c
+++ b/arch/arm/mach-zynq/platsmp.c
@@ -128,8 +128,11 @@ int __cpuinit boot_secondary(unsigned int cpu, struct task_struct *idle)
 
 
 	ret = zynq_cpu1_start(virt_to_phys(secondary_startup));
-	if (ret)
+	if (ret) {
+		spin_unlock(&boot_lock);
 		return -1;
+	}
+
 	/*
 	 * now the secondary core is starting up let it run its
 	 * calibrations, then wait for it to finish
-- 
1.7.5.4

