From 4d72edbc8c87dc587ad4b349e431290b4ac254b1 Mon Sep 17 00:00:00 2001
From: Michal Simek <michal.simek@xilinx.com>
Date: Mon, 18 Nov 2013 16:48:19 +0100
Subject: [PATCH 008/509] zynq: clk: Move topswitch code from PM driver

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit e2cce9db3a3e8545fb3ce3503497e468fd71a9ab

This is purely clock code and should be in clock driver.

Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/mach-zynq/pm.c  |   12 +++---------
 drivers/clk/zynq/clkc.c  |   21 +++++++++++++++++++++
 include/linux/clk/zynq.h |    3 +++
 3 files changed, 27 insertions(+), 9 deletions(-)

diff --git a/arch/arm/mach-zynq/pm.c b/arch/arm/mach-zynq/pm.c
index 84f1a26..d28a3aa 100644
--- a/arch/arm/mach-zynq/pm.c
+++ b/arch/arm/mach-zynq/pm.c
@@ -38,12 +38,10 @@
 #define DDRC_CTRL_REG1_OFFS		0x60
 #define DDRC_DRAM_PARAM_REG3_OFFS	0x20
 #define SCU_CTRL			0
-#define SLCR_TOPSW_CLK_CTRL		0x16c
 
 #define DDRC_CLOCKSTOP_MASK	BIT(23)
 #define DDRC_SELFREFRESH_MASK	BIT(12)
 #define SCU_STBY_EN_MASK	BIT(5)
-#define TOPSW_CLK_CTRL_DIS_MASK	BIT(0)
 
 static void __iomem *ddrc_base;
 static void __iomem *ocm_base;
@@ -91,9 +89,7 @@ static int zynq_pm_suspend(unsigned long arg)
 	}
 
 	/* Topswitch clock stop disable */
-	reg = zynq_slcr_read(SLCR_TOPSW_CLK_CTRL);
-	reg |= TOPSW_CLK_CTRL_DIS_MASK;
-	zynq_slcr_write(reg, SLCR_TOPSW_CLK_CTRL);
+	zynq_clk_topswitch_disable();
 
 	/* A9 clock gating */
 	asm volatile ("mrc  p15, 0, r12, c15, c0, 0\n"
@@ -146,10 +142,8 @@ static int zynq_pm_suspend(unsigned long arg)
 		kfree(ocm_swap_area);
 	}
 
-	/* Topswitch clock stop disable */
-	reg = zynq_slcr_read(SLCR_TOPSW_CLK_CTRL);
-	reg &= ~TOPSW_CLK_CTRL_DIS_MASK;
-	zynq_slcr_write(reg, SLCR_TOPSW_CLK_CTRL);
+	/* Topswitch clock stop enable */
+	zynq_clk_topswitch_enable();
 
 	/* SCU standby mode */
 	if (zynq_scu_base) {
diff --git a/drivers/clk/zynq/clkc.c b/drivers/clk/zynq/clkc.c
index 319d298..bf6b010 100644
--- a/drivers/clk/zynq/clkc.c
+++ b/drivers/clk/zynq/clkc.c
@@ -47,6 +47,7 @@ static void __iomem *zynq_slcr_base_priv;
 #define SLCR_CAN_MIOCLK_CTRL		(zynq_slcr_base_priv + 0x160)
 #define SLCR_DBG_CLK_CTRL		(zynq_slcr_base_priv + 0x164)
 #define SLCR_PCAP_CLK_CTRL		(zynq_slcr_base_priv + 0x168)
+#define SLCR_TOPSW_CLK_CTRL		(zynq_slcr_base_priv + 0x16c)
 #define SLCR_FPGA0_CLK_CTRL		(zynq_slcr_base_priv + 0x170)
 #define SLCR_621_TRUE			(zynq_slcr_base_priv + 0x1c4)
 #define SLCR_SWDT_CLK_SEL		(zynq_slcr_base_priv + 0x304)
@@ -106,6 +107,8 @@ unsigned int zynq_clk_suspended;
 static struct clk *armpll_save_parent;
 static struct clk *iopll_save_parent;
 
+#define TOPSW_CLK_CTRL_DIS_MASK	BIT(0)
+
 int zynq_clk_suspend_early(void)
 {
 	int ret;
@@ -133,6 +136,24 @@ void zynq_clk_resume_late(void)
 
 	zynq_clk_suspended = 0;
 }
+
+void zynq_clk_topswitch_enable(void)
+{
+	u32 reg;
+
+	reg = readl(SLCR_TOPSW_CLK_CTRL);
+	reg &= ~TOPSW_CLK_CTRL_DIS_MASK;
+	writel(reg, SLCR_TOPSW_CLK_CTRL);
+}
+
+void zynq_clk_topswitch_disable(void)
+{
+	u32 reg;
+
+	reg = readl(SLCR_TOPSW_CLK_CTRL);
+	reg |= TOPSW_CLK_CTRL_DIS_MASK;
+	writel(reg, SLCR_TOPSW_CLK_CTRL);
+}
 #endif
 
 static void __init zynq_clk_register_fclk(enum zynq_clk fclk,
diff --git a/include/linux/clk/zynq.h b/include/linux/clk/zynq.h
index 96827d5..bb6aecb 100644
--- a/include/linux/clk/zynq.h
+++ b/include/linux/clk/zynq.h
@@ -28,6 +28,9 @@ void zynq_clock_init(void __iomem *slcr);
 int zynq_clk_suspend_early(void);
 void zynq_clk_resume_late(void);
 
+void zynq_clk_topswitch_enable(void);
+void zynq_clk_topswitch_disable(void);
+
 struct clk *clk_register_zynq_pll(const char *name, const char *parent,
 		void __iomem *pll_ctrl, void __iomem *pll_status, u8 lock_index,
 		spinlock_t *lock);
-- 
1.7.5.4

