From 48ef35042cfc0a6b528f8665c6a8c7fcc4a0b9b9 Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date: Thu, 23 May 2013 13:48:17 +0200
Subject: [PATCH 308/509] dma: xilinx: vdma: Configure the hardware when
 starting the transfer

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit 5982f6e2e94f88464e4fbb4a13dd585c86d500b1

Set the XILINX_VDMA_REG_HSIZE and XILINX_VDMA_REG_FRMDLY_STRIDE
registers when starting the transfer, not when preparing the request.
This is needed to allow several requests to be prepared and submitted
for execution.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Acked-by: Srikanth Thokala <sthokal@xilinx.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/dma/xilinx/xilinx_axivdma.c |   20 +++++++++-----------
 1 files changed, 9 insertions(+), 11 deletions(-)

diff --git a/drivers/dma/xilinx/xilinx_axivdma.c b/drivers/dma/xilinx/xilinx_axivdma.c
index 87841c0..9083196 100644
--- a/drivers/dma/xilinx/xilinx_axivdma.c
+++ b/drivers/dma/xilinx/xilinx_axivdma.c
@@ -509,11 +509,18 @@ static void xilinx_vdma_start_transfer(struct xilinx_vdma_chan *chan)
 		      XILINX_VDMA_DMAXR_ALL_IRQ_MASK);
 
 	/* Start the transfer */
-	if (chan->has_sg)
+	if (chan->has_sg) {
 		vdma_ctrl_write(chan, XILINX_VDMA_REG_TAILDESC,
 				desct->async_tx.phys);
-	else
+	} else {
+		vdma_desc_write(chan, XILINX_VDMA_REG_HSIZE, config->hsize);
+		vdma_desc_write(chan, XILINX_VDMA_REG_FRMDLY_STRIDE,
+				(config->frm_dly <<
+				 XILINX_VDMA_FRMDLY_STRIDE_FRMDLY_SHIFT) |
+				(config->stride <<
+				 XILINX_VDMA_FRMDLY_STRIDE_STRIDE_SHIFT));
 		vdma_desc_write(chan, XILINX_VDMA_REG_VSIZE, config->vsize);
+	}
 
 out_unlock:
 	spin_unlock_irqrestore(&chan->lock, flags);
@@ -792,15 +799,6 @@ static struct dma_async_tx_descriptor *xilinx_vdma_prep_slave_sg(
 		return NULL;
 	}
 
-	if (!chan->has_sg) {
-		vdma_desc_write(chan, XILINX_VDMA_REG_HSIZE, chan->config.hsize);
-		vdma_desc_write(chan, XILINX_VDMA_REG_FRMDLY_STRIDE,
-				(chan->config.frm_dly <<
-				 XILINX_VDMA_FRMDLY_STRIDE_FRMDLY_SHIFT) |
-				(chan->config.stride <<
-				 XILINX_VDMA_FRMDLY_STRIDE_STRIDE_SHIFT));
-	}
-
 	/* Build transactions using information in the scatter gather list */
 	for_each_sg(sgl, sg, sg_len, i) {
 		/* Allocate the link descriptor from DMA pool */
-- 
1.7.5.4

