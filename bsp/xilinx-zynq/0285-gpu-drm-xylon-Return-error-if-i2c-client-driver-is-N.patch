From 093cd6847f5a6f8ea2ea0071f52bf38b4c311616 Mon Sep 17 00:00:00 2001
From: Radhey Shyam Pandey <radhey.shyam.pandey@xilinx.com>
Date: Tue, 19 May 2015 17:16:53 +0530
Subject: [PATCH 285/290] gpu: drm: xylon: Return error if i2c client driver is
 NULL

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Return error if i2c_client driver instance is NULL.
Incase i2c encoder(adv7511) probe fails not checking
it will result in NULL pointer dereference.

<snip>
Unable to handle kernel NULL pointer dereference at virtual address 00000050
pgd = 40004000
[00000050] *pgd=00000000
Internal error: Oops - BUG: 17 [#1] PREEMPT SMP ARM
Modules linked in:
CPU: 0 PID: 690 Comm: kworker/u4:2 Not tainted 3.19.0-xilinx-13711-g2b55e97-dirty #49
Hardware name: Xilinx Zynq Platform
Workqueue: deferwq deferred_probe_work_func
task: 771ab100 ti: 72a42000 task.ti: 72a42000
PC is at xylon_drm_encoder_create+0xf4/0x188
LR is at xylon_drm_encoder_create+0xf4/0x188

Signed-off-by: Radhey Shyam Pandey <radheys@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Tested-by: Christian Kohn <christian.kohn@xilinx.com>
(cherry picked from commit 64e05292dfbe8fb158ca422d01378de45affb40f)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpu/drm/xylon/xylon_encoder.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/xylon/xylon_encoder.c b/drivers/gpu/drm/xylon/xylon_encoder.c
index cac88d0..aeac57a 100644
--- a/drivers/gpu/drm/xylon/xylon_encoder.c
+++ b/drivers/gpu/drm/xylon/xylon_encoder.c
@@ -187,7 +187,7 @@ struct drm_encoder *xylon_drm_encoder_create(struct drm_device *dev)
 
 	encoder->client = of_find_i2c_device_by_node(sub_node);
 	of_node_put(sub_node);
-	if (!encoder->client) {
+	if (!encoder->client || !encoder->client->dev.driver) {
 		DRM_INFO("failed find encoder\n");
 		return ERR_PTR(-EPROBE_DEFER);
 	}
-- 
2.0.2

