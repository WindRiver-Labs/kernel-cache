From 2b59ef8f2090b80f5b673043eb99aa79fb42daac Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date: Thu, 27 Nov 2014 04:02:18 +0200
Subject: [PATCH 312/456] v4l: xilinx: vip: Add resource init and cleanup
 helpers

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

All video entities have at least one iomem resource and a functional
clock. Add a function to remap the memory and retrieve and enable the
clock.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
(cherry picked from commit 535f4c9b778e19849657c90ca65fe801618a8b8d)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-vip.c |   27 +++++++++++++++++++++++++++
 drivers/media/platform/xilinx/xilinx-vip.h |    6 ++++++
 2 files changed, 33 insertions(+), 0 deletions(-)

diff --git a/drivers/media/platform/xilinx/xilinx-vip.c b/drivers/media/platform/xilinx/xilinx-vip.c
index 174e888..4e057d7 100644
--- a/drivers/media/platform/xilinx/xilinx-vip.c
+++ b/drivers/media/platform/xilinx/xilinx-vip.c
@@ -10,9 +10,11 @@
  * published by the Free Software Foundation.
  */
 
+#include <linux/clk.h>
 #include <linux/export.h>
 #include <linux/kernel.h>
 #include <linux/of.h>
+#include <linux/platform_device.h>
 
 #include <media/media-entity.h>
 
@@ -190,6 +192,31 @@ void xvip_clr_and_set(struct xvip_device *xvip, u32 addr, u32 clr, u32 set)
 }
 EXPORT_SYMBOL_GPL(xvip_clr_and_set);
 
+int xvip_init_resources(struct xvip_device *xvip)
+{
+	struct platform_device *pdev = to_platform_device(xvip->dev);
+	struct resource *res;
+
+	res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
+	xvip->iomem = devm_ioremap_resource(xvip->dev, res);
+	if (IS_ERR(xvip->iomem))
+		return PTR_ERR(xvip->iomem);
+
+	xvip->clk = devm_clk_get(xvip->dev, NULL);
+	if (IS_ERR(xvip->clk))
+		return PTR_ERR(xvip->clk);
+
+	clk_prepare_enable(xvip->clk);
+	return 0;
+}
+EXPORT_SYMBOL_GPL(xvip_init_resources);
+
+void xvip_cleanup_resources(struct xvip_device *xvip)
+{
+	clk_disable_unprepare(xvip->clk);
+}
+EXPORT_SYMBOL_GPL(xvip_cleanup_resources);
+
 /* -----------------------------------------------------------------------------
  * Subdev operation helpers
  */
diff --git a/drivers/media/platform/xilinx/xilinx-vip.h b/drivers/media/platform/xilinx/xilinx-vip.h
index da1bf36..2c6c87d 100644
--- a/drivers/media/platform/xilinx/xilinx-vip.h
+++ b/drivers/media/platform/xilinx/xilinx-vip.h
@@ -16,6 +16,8 @@
 #include <linux/io.h>
 #include <media/v4l2-subdev.h>
 
+struct clk;
+
 /*
  * Minimum and maximum width and height common to most video IP cores. IP
  * cores with different requirements must define their own values.
@@ -97,6 +99,7 @@ struct xvip_device {
 	struct v4l2_subdev subdev;
 	struct device *dev;
 	void __iomem *iomem;
+	struct clk *clk;
 
 	unsigned int npads;
 	struct media_pad *pads;
@@ -167,6 +170,9 @@ static inline void xvip_set(struct xvip_device *xvip, u32 addr, u32 set)
 void xvip_clr_or_set(struct xvip_device *xvip, u32 addr, u32 mask, bool set);
 void xvip_clr_and_set(struct xvip_device *xvip, u32 addr, u32 clr, u32 set);
 
+int xvip_init_resources(struct xvip_device *xvip);
+void xvip_cleanup_resources(struct xvip_device *xvip);
+
 static inline void xvip_reset(struct xvip_device *xvip)
 {
 	xvip_write(xvip, XVIP_CTRL_CONTROL, XVIP_CTRL_CONTROL_SW_RESET);
-- 
1.7.5.4

