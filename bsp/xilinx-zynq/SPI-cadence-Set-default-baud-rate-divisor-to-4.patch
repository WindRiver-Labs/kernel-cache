From 4f161bddea0741cbc5bb3b96433944aab0251892 Mon Sep 17 00:00:00 2001
From: Harini Katakam <harini.katakam@xilinx.com>
Date: Mon, 17 Mar 2014 13:16:56 +0530
Subject: [PATCH 098/509] SPI: cadence: Set default baud rate divisor to 4

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit e9ccec3e937ecf0311913698907f91ebd18eb9ae

Set default config register value with baud rate 4 as that is the
default valid value. Reflect the same in xspi->speed_hz in probe.

Signed-off-by: Harini Katakam <harinik@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/spi/spi-cadence.c |    9 ++++++---
 1 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/drivers/spi/spi-cadence.c b/drivers/spi/spi-cadence.c
index f47e9fa..814b019 100644
--- a/drivers/spi/spi-cadence.c
+++ b/drivers/spi/spi-cadence.c
@@ -55,9 +55,11 @@
 #define CDNS_SPI_CR_MSTREN_MASK		0x00000001 /* Master Enable Mask */
 #define CDNS_SPI_CR_MANSTRTEN_MASK	0x00008000 /* Manual TX Enable Mask */
 #define CDNS_SPI_CR_SSFORCE_MASK	0x00004000 /* Manual SS Enable Mask */
+#define CDNS_SPI_CR_BAUD_DIV_4_MASK	0x00000008 /* Default Baud Div Mask */
 #define CDNS_SPI_CR_DEFAULT_MASK	(CDNS_SPI_CR_MSTREN_MASK | \
 					CDNS_SPI_CR_SSCTRL_MASK | \
-					CDNS_SPI_CR_SSFORCE_MASK)
+					CDNS_SPI_CR_SSFORCE_MASK | \
+					CDNS_SPI_CR_BAUD_DIV_4_MASK)
 
 /*
  * SPI Configuration Register - Baud rate and slave select
@@ -143,7 +145,7 @@ struct cdns_spi {
  * @regs_base:		Base address of SPI controller
  *
  * On reset the SPI controller is configured to be in master mode, baud rate
- * divisor is set to 2, threshold value for TX FIFO not full interrupt is set
+ * divisor is set to 4, threshold value for TX FIFO not full interrupt is set
  * to 1 and size of the word to be transferred as 8 bit.
  * This function initializes the SPI controller to disable and clear all the
  * interrupts, enable manual slave select and manual start, deselect all the
@@ -653,7 +655,8 @@ static int cdns_spi_probe(struct platform_device *pdev)
 	master->unprepare_transfer_hardware = cdns_unprepare_transfer_hardware;
 	master->mode_bits = SPI_CPOL | SPI_CPHA;
 
-	xspi->speed_hz = clk_get_rate(xspi->ref_clk) / 2;
+	/* Set to default valid value */
+	xspi->speed_hz = clk_get_rate(xspi->ref_clk) / 4;
 
 	xspi->driver_state = CDNS_SPI_DRIVER_STATE_READY;
 
-- 
1.7.5.4

