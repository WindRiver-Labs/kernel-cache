From 3c1de3577dd8ead95f703592b9d5f0c98e782a94 Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyun.kwon@xilinx.com>
Date: Mon, 5 May 2014 19:52:30 -0700
Subject: [PATCH 189/456] drm: adv7511: Add adv7511_encoder_mode_valid()
 function

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Add adv7511_encoder_mode_valid() function. This valid check code was
implemented in the drm connector driver, but this check should be done in
the adv7511 driver.

Signed-off-by: Hyun Kwon <hyunk@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit c39abdcd3fe2822696656f2153f9065912e7a417)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpu/drm/i2c/adv7511_core.c |   15 +++++++++++++++
 1 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/i2c/adv7511_core.c b/drivers/gpu/drm/i2c/adv7511_core.c
index dd65ad6..08a680a 100644
--- a/drivers/gpu/drm/i2c/adv7511_core.c
+++ b/drivers/gpu/drm/i2c/adv7511_core.c
@@ -21,6 +21,8 @@
 
 #include <drm/i2c/adv7511.h>
 
+#define MAX_CLOCK	165000
+
 static const uint8_t adv7511_register_defaults[] = {
 	0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 00 */
 	0x00, 0x00, 0x01, 0x0e, 0xbc, 0x18, 0x01, 0x13,
@@ -625,6 +627,18 @@ adv7511_encoder_detect(struct drm_encoder *encoder,
 	return status;
 }
 
+static int adv7511_encoder_mode_valid(struct drm_encoder *encoder,
+				      struct drm_display_mode *mode)
+{
+	if (mode->clock > MAX_CLOCK)
+		return MODE_CLOCK_HIGH;
+
+	if (mode->flags & DRM_MODE_FLAG_INTERLACE)
+		return MODE_NO_INTERLACE;
+
+	return MODE_OK;
+}
+
 static void adv7511_encoder_mode_set(struct drm_encoder *encoder,
 				     struct drm_display_mode *mode,
 				     struct drm_display_mode *adj_mode)
@@ -719,6 +733,7 @@ static struct drm_encoder_slave_funcs adv7511_encoder_funcs = {
 	.set_config = adv7511_set_config,
 	.dpms = adv7511_encoder_dpms,
 	/* .destroy = adv7511_encoder_destroy,*/
+	.mode_valid = adv7511_encoder_mode_valid,
 	.mode_set = adv7511_encoder_mode_set,
 	.detect = adv7511_encoder_detect,
 	.get_modes = adv7511_get_modes,
-- 
1.7.5.4

