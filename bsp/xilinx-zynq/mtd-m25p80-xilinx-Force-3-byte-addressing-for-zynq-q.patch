From 991e8c2b45391810b75f6bab1968e4fc5227b5e5 Mon Sep 17 00:00:00 2001
From: Suneel Garapati <suneel.garapati@xilinx.com>
Date: Tue, 18 Jun 2013 15:00:07 +0530
Subject: [PATCH 12/20] mtd: m25p80: xilinx: Force 3 byte addressing for zynq
 qspi for large flash size

git://github.com/Xilinx/linux-xlnx.git xilinx-v14.7
commit 7f1a600e05208fca7c6595c592ec11e5a78a7c00

Hack the addr width to 3 in case of large size flash connected to
zynq qspi controller and force this only if the connected spi controller
is zynq ps qspi.

Signed-off-by: Suneel Garapati <suneel.garapati@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/mtd/devices/m25p80.c |   13 +++++++++++--
 1 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/drivers/mtd/devices/m25p80.c b/drivers/mtd/devices/m25p80.c
index 1089270..2bccb94 100644
--- a/drivers/mtd/devices/m25p80.c
+++ b/drivers/mtd/devices/m25p80.c
@@ -1197,8 +1197,17 @@ static int m25p_probe(struct spi_device *spi)
 	else {
 		/* enable 4-byte addressing if the device exceeds 16MiB */
 		if (flash->mtd.size > 0x1000000) {
-			flash->addr_width = 4;
-			set_4byte(flash, info->jedec_id, 1);
+			struct device_node *np;
+			const char *comp_str;
+			np = of_get_next_parent(spi->dev.of_node);
+			of_property_read_string(np, "compatible", &comp_str);
+			if (!strcmp(comp_str, "xlnx,ps7-qspi-1.00.a")) {
+				flash->addr_width = 3;
+				set_4byte(flash, info->jedec_id, 0);
+			} else {
+				flash->addr_width = 4;
+				set_4byte(flash, info->jedec_id, 1);
+			}
 		} else
 			flash->addr_width = 3;
 	}
-- 
1.7.5.4

