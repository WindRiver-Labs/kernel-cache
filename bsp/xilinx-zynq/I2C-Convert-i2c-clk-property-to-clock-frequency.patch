From edbe5a47ee286e8493f0f91320f710a0f9900bde Mon Sep 17 00:00:00 2001
From: Soren Brinkmann <soren.brinkmann@xilinx.com>
Date: Fri, 24 Jan 2014 09:22:28 -0800
Subject: [PATCH 177/509] I2C: Convert 'i2c-clk' property to 'clock-frequency'

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit 9db63cbcc2499b82d866c2089e7934d77f4e8b67

Align this driver more with other drivers by using the property
'clock-frequency' to specify the maximum I2C bus frequency.

Signed-off-by: Soren Brinkmann <soren.brinkmann@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/boot/dts/zynq-zc702.dts |    3 ++-
 arch/arm/boot/dts/zynq-zc706.dts |    3 ++-
 drivers/i2c/busses/i2c-zynq.c    |   14 +++++++-------
 3 files changed, 11 insertions(+), 9 deletions(-)

diff --git a/arch/arm/boot/dts/zynq-zc702.dts b/arch/arm/boot/dts/zynq-zc702.dts
index bc604b9..4cb5d19 100644
--- a/arch/arm/boot/dts/zynq-zc702.dts
+++ b/arch/arm/boot/dts/zynq-zc702.dts
@@ -165,7 +165,8 @@
 		ps7_i2c_0: ps7-i2c@e0004000 {
 			clocks = <&clkc 38>;
 			compatible = "xlnx,ps7-i2c-1.00.a";
-			i2c-clk = <400000>;
+			clock-frequency = <400000>;
+			i2c-reset = <&ps7_gpio_0 13 0>;
 			interrupt-parent = <&ps7_scugic_0>;
 			interrupts = <0 25 4>;
 			reg = <0xe0004000 0x1000>;
diff --git a/arch/arm/boot/dts/zynq-zc706.dts b/arch/arm/boot/dts/zynq-zc706.dts
index bbdfdb9..b64e407 100644
--- a/arch/arm/boot/dts/zynq-zc706.dts
+++ b/arch/arm/boot/dts/zynq-zc706.dts
@@ -157,7 +157,8 @@
 		ps7_i2c_0: ps7-i2c@e0004000 {
 			clocks = <&clkc 38>;
 			compatible = "xlnx,ps7-i2c-1.00.a";
-			i2c-clk = <400000>;
+			clock-frequency = <400000>;
+			i2c-reset = <&ps7_gpio_0 46 0>;
 			interrupt-parent = <&ps7_scugic_0>;
 			interrupts = <0 25 4>;
 			reg = <0xe0004000 0x1000>;
diff --git a/drivers/i2c/busses/i2c-zynq.c b/drivers/i2c/busses/i2c-zynq.c
index ea2446a..70e6cad 100644
--- a/drivers/i2c/busses/i2c-zynq.c
+++ b/drivers/i2c/busses/i2c-zynq.c
@@ -90,6 +90,8 @@
 
 #define DRIVER_NAME		"zynq-i2c"
 
+#define ZYNQ_I2C_SPEED_MAX	400000
+
 #define zynq_i2c_readreg(offset)	__raw_readl(id->membase + offset)
 #define zynq_i2c_writereg(val, offset)	__raw_writel(val, id->membase + offset)
 
@@ -108,7 +110,7 @@
  * @irq:		IRQ number
  * @cur_timeout:	The current timeout value used by the device
  * @input_clk:		Input clock to I2C controller
- * @i2c_clk:		Current I2C frequency
+ * @i2c_clk:		Maximum I2C clock speed
  * @bus_hold_flag:	Flag used in repeated start for clearing HOLD bit
  * @clk:		Pointer to struct clk
  * @clk_rate_change_nb:	Notifier block for clock rate changes
@@ -842,12 +844,10 @@ static int zynq_i2c_probe(struct platform_device *pdev)
 		dev_warn(&pdev->dev, "Unable to register clock notifier.\n");
 	id->input_clk = clk_get_rate(id->clk);
 
-	ret = of_property_read_u32(pdev->dev.of_node, "i2c-clk", &id->i2c_clk);
-	if (ret) {
-		ret = -ENXIO;
-		dev_err(&pdev->dev, "couldn't determine i2c-clk\n");
-		goto err_clk_dis;
-	}
+	ret = of_property_read_u32(pdev->dev.of_node, "clock-frequency",
+			&id->i2c_clk);
+	if (ret || (id->i2c_clk > ZYNQ_I2C_SPEED_MAX))
+		id->i2c_clk = ZYNQ_I2C_SPEED_MAX;
 
 	/*
 	 * Set Master Mode,Normal addressing mode (7 bit address),
-- 
1.7.5.4

