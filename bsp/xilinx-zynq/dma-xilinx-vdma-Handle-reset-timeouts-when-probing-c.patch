From 045e5b383fc892c12cdd4b63bd0a1417ed87f8bc Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date: Wed, 25 Sep 2013 21:27:58 +0200
Subject: [PATCH 288/509] dma: xilinx: vdma: Handle reset timeouts when
 probing channel

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit 20803abbc3482b6458e7070308c568aface9000b

Make the vdma_init() function return a proper error code, and propagate
it to the caller of xilinx_vdma_chan_probe() when vdma_init() fails.
This fixes returning an uninitialized error value to the probe function.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Acked-by: Srikanth Thokala <sthokal@xilinx.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/dma/xilinx/xilinx_axivdma.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/dma/xilinx/xilinx_axivdma.c b/drivers/dma/xilinx/xilinx_axivdma.c
index 2a5621b..5de0b13 100644
--- a/drivers/dma/xilinx/xilinx_axivdma.c
+++ b/drivers/dma/xilinx/xilinx_axivdma.c
@@ -609,7 +609,7 @@ static int vdma_init(struct xilinx_vdma_chan *chan)
 		dev_err(chan->dev, "reset timeout, cr %x, sr %x\n",
 			vdma_ctrl_read(chan, XILINX_VDMA_REG_DMACR),
 			vdma_ctrl_read(chan, XILINX_VDMA_REG_DMASR));
-		return 1;
+		return -ETIMEDOUT;
 	}
 
 	return 0;
@@ -1152,7 +1152,8 @@ static int xilinx_vdma_chan_probe(struct xilinx_vdma_device *xdev,
 	tasklet_init(&chan->tasklet, dma_do_tasklet, (unsigned long)chan);
 
 	/* Initialize the channel */
-	if (vdma_init(chan)) {
+	err = vdma_init(chan);
+	if (err < 0) {
 		dev_err(xdev->dev, "Reset channel failed\n");
 		return err;
 	}
-- 
1.7.5.4

