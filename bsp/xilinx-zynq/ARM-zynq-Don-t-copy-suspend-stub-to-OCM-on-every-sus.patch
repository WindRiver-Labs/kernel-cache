From c8db75341dc041abd3b39a83e0b9fa56d5a7ff5d Mon Sep 17 00:00:00 2001
From: Soren Brinkmann <soren.brinkmann@xilinx.com>
Date: Wed, 30 Jul 2014 09:13:04 -0700
Subject: [PATCH 157/182] ARM: zynq: Don't copy suspend stub to OCM on every
 suspend

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

With the migration to the OCM allocator, the suspend code allocates and
holds OCM space throughout the whole run-time. Hence, copying the OCM
stub to OCM can be reduced to being done once only.

Signed-off-by: Soren Brinkmann <soren.brinkmann@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit c0e313e847605b4cc0b3e68991dee857046a9833)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-zynq/pm.c |   31 +++++++++++++++----------------
 1 files changed, 15 insertions(+), 16 deletions(-)

diff --git a/arch/arm/mach-zynq/pm.c b/arch/arm/mach-zynq/pm.c
index d49ecb9..e6ea94f 100644
--- a/arch/arm/mach-zynq/pm.c
+++ b/arch/arm/mach-zynq/pm.c
@@ -61,7 +61,8 @@ static void zynq_pm_wake(void)
 static int zynq_pm_suspend(unsigned long arg)
 {
 	u32 reg;
-	int (*zynq_suspend_ptr)(void __iomem *, void __iomem *);
+	int (*zynq_suspend_ptr)(void __iomem *, void __iomem *) =
+		(__force void *)ocm_base;
 	int do_ddrpll_bypass = 1;
 
 	/* Enable DDR self-refresh and clock stop */
@@ -95,22 +96,9 @@ static int zynq_pm_suspend(unsigned long arg)
 		      : /* no inputs */
 		      : "r12");
 
-	if (ocm_base) {
-		/*
-		 * Copy code to suspend system into OCM. The suspend code
-		 * needs to run from OCM as DRAM may no longer be available
-		 * when the PLL is stopped.
-		 */
-		memcpy((__force void *)ocm_base, &zynq_sys_suspend,
-			zynq_sys_suspend_sz);
-		flush_icache_range((unsigned long)ocm_base,
-			(unsigned long)(ocm_base) + zynq_sys_suspend_sz);
-		zynq_suspend_ptr = (__force void *)ocm_base;
-	} else {
+	if (!ocm_base)
 		do_ddrpll_bypass = 0;
-	}
 
-	/* Transfer to suspend code in OCM */
 	if (do_ddrpll_bypass) {
 		/*
 		 * Going this way will turn off DDR related clocks and the DDR
@@ -267,8 +255,19 @@ int __init zynq_pm_late_init(void)
 		pr_warn("%s: Unable to map DDRC IO memory.\n", __func__);
 
 	ocm_base = zynq_pm_remap_ocm();
-	if (!ocm_base)
+	if (!ocm_base) {
 		pr_warn("%s: Unable to map OCM.\n", __func__);
+	} else {
+		/*
+		 * Copy code to suspend system into OCM. The suspend code
+		 * needs to run from OCM as DRAM may no longer be available
+		 * when the PLL is stopped.
+		 */
+		memcpy((__force void *)ocm_base, &zynq_sys_suspend,
+			zynq_sys_suspend_sz);
+		flush_icache_range((unsigned long)ocm_base,
+			(unsigned long)(ocm_base) + zynq_sys_suspend_sz);
+	}
 
 	suspend_set_ops(&zynq_pm_ops);
 
-- 
1.7.5.4

