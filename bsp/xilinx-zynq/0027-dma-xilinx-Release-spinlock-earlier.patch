From d7375f046e70e0c72048f784ce007016db716fed Mon Sep 17 00:00:00 2001
From: Joseph Zavodny <Joseph.Zavodny@jhuapl.edu>
Date: Tue, 25 Aug 2015 15:28:00 -0400
Subject: [PATCH 27/53] dma: xilinx: Release spinlock earlier

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

There is no need to hold the lock when setting the residue.  The
lock protects access to the descriptor and segment linked lists.

Signed-off-by: Joseph Zavodny <Joseph.Zavodny@jhuapl.edu>
Acked-by: Kedareswara rao Appana <appanad@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit dc6281a565c599ad260175f9d32f152b2efcfe7b)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/dma/xilinx/xilinx_dma.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/dma/xilinx/xilinx_dma.c b/drivers/dma/xilinx/xilinx_dma.c
index 6a670ae..c434baa 100644
--- a/drivers/dma/xilinx/xilinx_dma.c
+++ b/drivers/dma/xilinx/xilinx_dma.c
@@ -503,10 +503,10 @@ static enum dma_status xilinx_dma_tx_status(struct dma_chan *dchan,
 				   XILINX_DMA_MAX_TRANS_LEN;
 		}
 	}
+	spin_unlock_irqrestore(&chan->lock, flags);
 
 	chan->residue = residue;
 	dma_set_residue(txstate, chan->residue);
-	spin_unlock_irqrestore(&chan->lock, flags);
 
 	return ret;
 }
-- 
1.7.10.4

