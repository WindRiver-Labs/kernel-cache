From 6dcf13e951700ecb4200674a40ab5af4c3b95ed6 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Wed, 4 Jul 2012 15:29:09 +0800
Subject: [PATCH 23/36] arm/zynq: Add restart support for Zynq board

SDK: yocto-1.2(http://git.yoctoproject.org/cgit.cgi/meta-zynq/)

Signed-off-by: Vlad Lungu <vlad.lungu@windriver.com>
Integrated-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 arch/arm/mach-zynq/board_zc702.c       |    1 +
 arch/arm/mach-zynq/common.c            |   18 ++++++++++++++++++
 arch/arm/mach-zynq/common.h            |    1 +
 arch/arm/mach-zynq/include/mach/slcr.h |    1 +
 4 files changed, 21 insertions(+)

diff --git a/arch/arm/mach-zynq/board_zc702.c b/arch/arm/mach-zynq/board_zc702.c
index 15b8220..264b104 100644
--- a/arch/arm/mach-zynq/board_zc702.c
+++ b/arch/arm/mach-zynq/board_zc702.c
@@ -45,4 +45,5 @@ DT_MACHINE_START(XILINX_DT, "Xilinx Zynq Platform")
 	.timer		= &xttcpss_sys_timer,
 	.dt_compat	= xilinx_dt_match,
 	.reserve        = xilinx_memory_init,
+	.restart	= zynq_reset,
 MACHINE_END
diff --git a/arch/arm/mach-zynq/common.c b/arch/arm/mach-zynq/common.c
index ca7897f..c6c9c27 100644
--- a/arch/arm/mach-zynq/common.c
+++ b/arch/arm/mach-zynq/common.c
@@ -23,6 +23,7 @@
 #include <linux/of_platform.h>
 #include <linux/of.h>
 #include <linux/memblock.h>
+#include <linux/delay.h>
 
 #include <asm/mach/map.h>
 #include <asm/mach-types.h>
@@ -32,6 +33,7 @@
 
 #include <mach/zynq_soc.h>
 #include <mach/clkdev.h>
+#include <mach/slcr.h>
 #include "common.h"
 
 static struct of_device_id zynq_of_bus_ids[] __initdata = {
@@ -136,3 +138,19 @@ void __init xilinx_memory_init(void)
 	 */
 	memblock_remove(0xF000000, 0x1000000);
 }
+
+void zynq_reset(char mode, const char *cmd)
+{
+	xslcr_system_reset();
+
+	/* wait for reset ... */
+	mdelay(500);
+
+	printk(KERN_ERR "Reset failed\n");
+
+	/* delay to allow the serial port to show the message */
+	mdelay(50);
+
+	/* we'll take a jump through zero as a poor second */
+	cpu_reset(0);
+}
diff --git a/arch/arm/mach-zynq/common.h b/arch/arm/mach-zynq/common.h
index ed22a30..7f07225 100644
--- a/arch/arm/mach-zynq/common.h
+++ b/arch/arm/mach-zynq/common.h
@@ -26,6 +26,7 @@ void xilinx_init_machine(void);
 void xilinx_irq_init(void);
 void xilinx_map_io(void);
 void xilinx_memory_init(void);
+void zynq_reset(char mode, const char *cmd);
 
 void platform_device_init(void);
 #endif
diff --git a/arch/arm/mach-zynq/include/mach/slcr.h b/arch/arm/mach-zynq/include/mach/slcr.h
index 474e3d5..bd4c7fb 100644
--- a/arch/arm/mach-zynq/include/mach/slcr.h
+++ b/arch/arm/mach-zynq/include/mach/slcr.h
@@ -17,6 +17,7 @@
 
 extern void xslcr_write(u32 offset, u32 val);
 extern u32 xslcr_read(u32 offset);
+extern void xslcr_system_reset(void);
 
 extern void xslcr_init_preload_fpga(void);
 extern void xslcr_init_postload_fpga(void);
-- 
1.7.9.7

