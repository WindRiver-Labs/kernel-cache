From 2b9b0a6ce218cc8abd378171483315e249dd358a Mon Sep 17 00:00:00 2001
From: Joseph Zavodny <Joseph.Zavodny@jhuapl.edu>
Date: Tue, 25 Aug 2015 15:27:59 -0400
Subject: [PATCH 26/53] dma: xilinx: Fix infinite loop in xilinx_dma driver.

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

This patch fixes an infinite loop which would result in a system
deadlock since the driver holds a spinlock in the loop.  Use
list_for_each_entry to iterate over all the segments in the active
descriptor to calculate the residue.

Signed-off-by: Joseph Zavodny <Joseph.Zavodny@jhuapl.edu>
Acked-by: Kedareswara rao Appana <appanad@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit ec210e10bd9272c971a4d66e163e33809d8a9ed1)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/dma/xilinx/xilinx_dma.c |    4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)

diff --git a/drivers/dma/xilinx/xilinx_dma.c b/drivers/dma/xilinx/xilinx_dma.c
index 6f6c450d..6a670ae 100644
--- a/drivers/dma/xilinx/xilinx_dma.c
+++ b/drivers/dma/xilinx/xilinx_dma.c
@@ -497,9 +497,7 @@ static enum dma_status xilinx_dma_tx_status(struct dma_chan *dchan,
 
 	spin_lock_irqsave(&chan->lock, flags);
 	if (chan->has_sg) {
-		while (!list_empty(&desc->segments)) {
-			segment = list_first_entry(&desc->segments,
-					struct xilinx_dma_tx_segment, node);
+		list_for_each_entry(segment, &desc->segments, node) {
 			hw = &segment->hw;
 			residue += (hw->control - hw->status) &
 				   XILINX_DMA_MAX_TRANS_LEN;
-- 
1.7.10.4

