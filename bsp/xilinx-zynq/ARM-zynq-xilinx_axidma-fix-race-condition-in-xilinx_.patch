From a76cf26dc0ed6e7b76717d749dbefcad822db146 Mon Sep 17 00:00:00 2001
From: Nicolae Rosia <nicolae.rosia@certsign.ro>
Date: Mon, 5 Jan 2015 18:09:49 +0200
Subject: [PATCH 019/456] ARM: zynq: xilinx_axidma: fix race condition in
 xilinx_dma_start_transfer

The error flag should be protected against race conditions as other
member variables are.

Signed-off-by: Nicolae Rosia <nicolae.rosia@certsign.ro>
Acked-by: Kedareswara rao Appana <appanad@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 4a00b2ca601c9095891cf84cd4865e803acf3e75)
---
 drivers/dma/xilinx/xilinx_axidma.c |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/drivers/dma/xilinx/xilinx_axidma.c b/drivers/dma/xilinx/xilinx_axidma.c
index e90c7b7..5ad8d60 100644
--- a/drivers/dma/xilinx/xilinx_axidma.c
+++ b/drivers/dma/xilinx/xilinx_axidma.c
@@ -351,11 +351,11 @@ static void xilinx_dma_start_transfer(struct xilinx_dma_chan *chan)
 	struct xilinx_dma_desc_sw *desch, *desct;
 	struct xilinx_dma_desc_hw *hw;
 
-	if (chan->err)
-		return;
-
 	spin_lock_irqsave(&chan->lock, flags);
 
+	if (chan->err)
+		goto out_unlock;
+
 	if (list_empty(&chan->pending_list))
 		goto out_unlock;
 
-- 
1.7.5.4

