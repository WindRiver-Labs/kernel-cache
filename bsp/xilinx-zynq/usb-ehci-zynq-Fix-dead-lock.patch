From 0ec03583a7c92def1bf83271b58a0ccf60bc7966 Mon Sep 17 00:00:00 2001
From: Lars-Peter Clausen <lars@metafoo.de>
Date: Wed, 19 Feb 2014 11:54:24 +0100
Subject: [PATCH 106/182] usb: ehci-zynq: Fix dead-lock

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Looks like starting with commit commit c04ee4b11 ("Revert "Revert "USB: EHCI:
support running URB giveback in tasklet context") it is necessary to set the
HCD_BH flag on EHCI drivers, otherwise the system will dead-lock when plugging
in a USB device.

Signed-off-by: Lars-Peter Clausen <lars@metafoo.de>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 2651f9d20dcc0d82cf7aa83c117687ab633f9c8b)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/usb/host/ehci-zynq.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/usb/host/ehci-zynq.c b/drivers/usb/host/ehci-zynq.c
index 1a4a895..f1e8797 100644
--- a/drivers/usb/host/ehci-zynq.c
+++ b/drivers/usb/host/ehci-zynq.c
@@ -459,7 +459,7 @@ static const struct hc_driver ehci_zynq_hc_driver = {
 	 * generic hardware linkage
 	 */
 	.irq = ehci_irq,
-	.flags = HCD_USB2 | HCD_MEMORY,
+	.flags = HCD_USB2 | HCD_MEMORY | HCD_BH,
 
 	/*
 	 * basic lifecycle operations
-- 
1.7.5.4

