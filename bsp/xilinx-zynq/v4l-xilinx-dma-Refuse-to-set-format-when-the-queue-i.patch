From 83dc29146547dc55cdc9ef7ed4ef954e48e74d91 Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date: Sat, 1 Nov 2014 15:26:27 +0200
Subject: [PATCH 303/456] v4l: xilinx: dma: Refuse to set format when the
 queue is busy

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Setting the format must be rejected not only when the queue is streaming
but also just when buffers have been allocated. Fix it.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
(cherry picked from commit d7caccf402882541f93e17a1005d781fdadaf408)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-dma.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/media/platform/xilinx/xilinx-dma.c b/drivers/media/platform/xilinx/xilinx-dma.c
index 10bbaba..9be6345 100644
--- a/drivers/media/platform/xilinx/xilinx-dma.c
+++ b/drivers/media/platform/xilinx/xilinx-dma.c
@@ -650,7 +650,7 @@ xvip_dma_set_format(struct file *file, void *fh, struct v4l2_format *format)
 
 	mutex_lock(&dma->lock);
 
-	if (vb2_is_streaming(&dma->queue)) {
+	if (vb2_is_busy(&dma->queue)) {
 		ret = -EBUSY;
 		goto done;
 	}
-- 
1.7.5.4

