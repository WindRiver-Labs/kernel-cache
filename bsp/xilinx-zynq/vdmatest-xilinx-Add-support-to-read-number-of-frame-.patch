From 6ff55127a9c786dc94c4e6b4afe3b2d92361c760 Mon Sep 17 00:00:00 2001
From: Srikanth Thokala <srikanth.thokala@xilinx.com>
Date: Fri, 13 Dec 2013 14:37:35 +0530
Subject: [PATCH 339/509] vdmatest: xilinx: Add support to read number of
 frame stores from device node

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit ed3d4f6cca225ace6b1a18b317e3e02881e0fa3a

This patch adds support to read number of frame stores from the vdmatest
device node. And it documents this new node member to device tree bindings
documentation.

Signed-off-by: Srikanth Thokala <sthokal@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 .../devicetree/bindings/dma/xilinx/vdmatest.txt    |    7 +++++++
 drivers/dma/xilinx/vdmatest.c                      |    9 ++++++++-
 2 files changed, 15 insertions(+), 1 deletions(-)

diff --git a/Documentation/devicetree/bindings/dma/xilinx/vdmatest.txt b/Documentation/devicetree/bindings/dma/xilinx/vdmatest.txt
index 56acce1..1c035ac 100644
--- a/Documentation/devicetree/bindings/dma/xilinx/vdmatest.txt
+++ b/Documentation/devicetree/bindings/dma/xilinx/vdmatest.txt
@@ -6,6 +6,8 @@ Required properties:
 	where Channel ID is '0' for write/tx and '1' for read/rx
 	channel.
 - dma-names: a list of DMA channel names, one per "dmas" entry
+- xlnx,num-fstores: Should be the number of framebuffers as configured in
+	VDMA device node.
 
 Example:
 ++++++++
@@ -15,6 +17,7 @@ vdmatest_0: vdmatest@0 {
 	dmas = <&axi_vdma_0 0
 		&axi_vdma_0 1>;
 	dma-names = "vdma0", "vdma1";
+	xlnx,num-fstores = <0x8>;
 } ;
 
 
@@ -25,8 +28,12 @@ axi_vdma_0: axivdma@44A40000 {
 	...
 	dma-channel@44A40000 {
 		...
+		xlnx,num-fstores = <0x8>;
+		...
 	} ;
 	dma-channel@44A40030 {
 		...
+		xlnx,num-fstores = <0x8>;
+		...
 	} ;
 } ;
diff --git a/drivers/dma/xilinx/vdmatest.c b/drivers/dma/xilinx/vdmatest.c
index c504cc3..f624ce8 100644
--- a/drivers/dma/xilinx/vdmatest.c
+++ b/drivers/dma/xilinx/vdmatest.c
@@ -68,6 +68,7 @@ struct vdmatest_chan {
  */
 static LIST_HEAD(vdmatest_channels);
 static unsigned int nr_channels;
+static unsigned int frm_cnt;
 
 static void vdmatest_init_srcs(u8 **bufs, unsigned int start, unsigned int len)
 {
@@ -192,7 +193,6 @@ static int vdmatest_slave_func(void *data)
 	enum dma_status status;
 	enum dma_ctrl_flags flags;
 	int ret;
-	int frm_cnt = 8;
 	int i;
 	int hsize = 64;
 	int vsize = 32;
@@ -546,6 +546,13 @@ static int vdmatest_of_probe(struct platform_device *pdev)
 	struct dma_chan *chan, *rx_chan;
 	int err;
 
+	err = of_property_read_u32(pdev->dev.of_node,
+					"xlnx,num-fstores", &frm_cnt);
+	if (err < 0) {
+		pr_err("vdmatest: missing xlnx,num-fstores property\n");
+		return err;
+	}
+
 	chan = dma_request_slave_channel(&pdev->dev, "vdma0");
 	if (IS_ERR(chan)) {
 		pr_err("vdmatest: No Tx channel\n");
-- 
1.7.5.4

