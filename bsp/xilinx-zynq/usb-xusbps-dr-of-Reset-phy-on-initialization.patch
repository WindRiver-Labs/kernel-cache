From 400a1e4767a550b664c75344b035a00caf25d2ce Mon Sep 17 00:00:00 2001
From: Lars-Peter Clausen <lars@metafoo.de>
Date: Thu, 19 Dec 2013 14:41:08 +0100
Subject: [PATCH 393/509] usb:xusbps-dr-of: Reset phy on initialization

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit 793220b3aaa17a954ec3ad49ed3ddb46f6019acf

Pulse the USB ULPI phy reset pin before trying to talk to the phy. This seems to
fix the occasional USB problems that were observed on some boards.

Signed-off-by: Lars-Peter Clausen <lars@metafoo.de>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 arch/arm/boot/dts/zynq-zc702.dts |    2 +-
 arch/arm/boot/dts/zynq-zc706.dts |    2 +-
 arch/arm/boot/dts/zynq-zed.dts   |    2 +-
 drivers/usb/host/zynq-dr-of.c    |   15 +++++++++++++++
 4 files changed, 18 insertions(+), 3 deletions(-)

diff --git a/arch/arm/boot/dts/zynq-zc702.dts b/arch/arm/boot/dts/zynq-zc702.dts
index 2b2b951..33496ec 100644
--- a/arch/arm/boot/dts/zynq-zc702.dts
+++ b/arch/arm/boot/dts/zynq-zc702.dts
@@ -402,7 +402,7 @@
 			interrupts = <0 21 4>;
 			phy_type = "ulpi";
 			reg = <0xe0002000 0x1000>;
-			xlnx,usb-reset = "MIO 7";
+			xlnx,phy-reset-gpio = <&ps7_gpio_0 7 0>;
 		} ;
 		ps7_wdt_0: ps7-wdt@f8005000 {
 			clocks = <&clkc 45>;
diff --git a/arch/arm/boot/dts/zynq-zc706.dts b/arch/arm/boot/dts/zynq-zc706.dts
index 1c1ddaa..3a682b9 100644
--- a/arch/arm/boot/dts/zynq-zc706.dts
+++ b/arch/arm/boot/dts/zynq-zc706.dts
@@ -395,7 +395,7 @@
 			interrupts = <0 21 4>;
 			phy_type = "ulpi";
 			reg = <0xe0002000 0x1000>;
-			xlnx,usb-reset = "MIO 7";
+			xlnx,phy-reset-gpio = <&ps7_gpio_0 7 0>;
 		} ;
 		ps7_wdt_0: ps7-wdt@f8005000 {
 			clocks = <&clkc 45>;
diff --git a/arch/arm/boot/dts/zynq-zed.dts b/arch/arm/boot/dts/zynq-zed.dts
index 282b20b..15c3c09 100644
--- a/arch/arm/boot/dts/zynq-zed.dts
+++ b/arch/arm/boot/dts/zynq-zed.dts
@@ -310,7 +310,7 @@
 			interrupts = <0 21 4>;
 			phy_type = "ulpi";
 			reg = <0xe0002000 0x1000>;
-			xlnx,usb-reset = <0xffffffff>;
+			xlnx,phy-reset-gpio = <&ps7_gpio_0 85 0>;
 		} ;
 		ps7_xadc: ps7-xadc@f8007100 {
 			clocks = <&clkc 12>;
diff --git a/drivers/usb/host/zynq-dr-of.c b/drivers/usb/host/zynq-dr-of.c
index 0613630..c3d33da 100644
--- a/drivers/usb/host/zynq-dr-of.c
+++ b/drivers/usb/host/zynq-dr-of.c
@@ -26,6 +26,8 @@
 #include <linux/string.h>
 #include <linux/clk.h>
 #include <linux/usb/ulpi.h>
+#include <linux/gpio.h>
+#include <linux/of_gpio.h>
 
 #include "ehci-zynq.h"
 
@@ -152,6 +154,7 @@ static int zynq_dr_of_probe(struct platform_device *ofdev)
 	static unsigned int idx;
 	struct resource *res;
 	int i, phy_init;
+	int reset_gpio;
 	int ret;
 
 	pdata = &data;
@@ -199,6 +202,18 @@ static int zynq_dr_of_probe(struct platform_device *ofdev)
 
 	/* If ULPI phy type, set it up */
 	if (pdata->phy_mode == ZYNQ_USB2_PHY_ULPI) {
+		reset_gpio = of_get_named_gpio(np, "xlnx,phy-reset-gpio", 0);
+		if (gpio_is_valid(reset_gpio)) {
+			ret = devm_gpio_request_one(&ofdev->dev, reset_gpio,
+					GPIOF_INIT_LOW, "ulpi resetb");
+			if (ret) {
+				dev_err(&ofdev->dev, "Failed to request ULPI reset gpio: %d\n", ret);
+				goto err_out_clk_disable;
+			}
+			msleep(5);
+			gpio_set_value(reset_gpio, 1);
+			msleep(1);
+		}
 		pdata->ulpi = otg_ulpi_create(&ulpi_viewport_access_ops,
 			ULPI_OTG_DRVVBUS | ULPI_OTG_DRVVBUS_EXT);
 		if (pdata->ulpi) {
-- 
1.7.5.4

