From 207efb8b1e4a71f97c83a597e36a1400dbe2823d Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Fri, 13 Jul 2012 11:34:48 +0800
Subject: [PATCH 03/36] arm/zynq: Zynq is OF driven platfrom which requires
 irq OF initialization

SDK: yocto-1.2(http://git.yoctoproject.org/cgit.cgi/meta-zynq/)

Signed-off-by: Vlad Lungu <vlad.lungu@windriver.com>
Integrated-by: Hongbo Zhong <hongbo.zhong@windriver.com>
---
 arch/arm/boot/dts/zc702.dtsi           |    2 +-
 arch/arm/boot/dts/zynq-ep107.dts       |    2 +-
 arch/arm/mach-zynq/common.c            |    8 ++++++--
 arch/arm/mach-zynq/include/mach/irqs.h |    2 +-
 4 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/arch/arm/boot/dts/zc702.dtsi b/arch/arm/boot/dts/zc702.dtsi
index 6ee7802..b655f58 100644
--- a/arch/arm/boot/dts/zc702.dtsi
+++ b/arch/arm/boot/dts/zc702.dtsi
@@ -12,7 +12,7 @@
 
 		intc: intc@f8f01000 {
 			interrupt-controller;
-			compatible = "arm,gic";
+			compatible = "arm,cortex-a9-gic";
 			reg = <0xf8f01000 0x1000>,<0xf8f00100 0x0100>;
 			#interrupt-cells = <0x3>;
 			#address-cells = <1>;
diff --git a/arch/arm/boot/dts/zynq-ep107.dts b/arch/arm/boot/dts/zynq-ep107.dts
index 37ca192..ce70e29 100644
--- a/arch/arm/boot/dts/zynq-ep107.dts
+++ b/arch/arm/boot/dts/zynq-ep107.dts
@@ -37,7 +37,7 @@
 
 		intc: interrupt-controller@f8f01000 {
 			interrupt-controller;
-			compatible = "arm,gic";
+			compatible = "arm,cortex-a9-gic";
 			reg = <0xF8F01000 0x1000>;
 			#interrupt-cells = <2>;
 		};
diff --git a/arch/arm/mach-zynq/common.c b/arch/arm/mach-zynq/common.c
index 1e980f2..eba134e 100644
--- a/arch/arm/mach-zynq/common.c
+++ b/arch/arm/mach-zynq/common.c
@@ -60,18 +60,22 @@ void __init xilinx_init_machine(void)
 #endif
 }
 
+static const struct of_device_id xilinx_dt_irq_match[] __initconst = {
+	{ .compatible = "arm,cortex-a9-gic", .data = gic_of_init },
+	{ }
+};
+
 /**
  * xilinx_irq_init() - Interrupt controller initialization for the GIC.
  */
 void __init xilinx_irq_init(void)
 {
-	gic_init(0, 29, SCU_GIC_DIST_BASE, SCU_GIC_CPU_BASE);
+	of_irq_init(xilinx_dt_irq_match);
 }
 
 /* The minimum devices needed to be mapped before the VM system is up and
  * running include the GIC, UART and Timer Counter.
  */
-
 static struct map_desc io_desc[] __initdata = {
 	{
 		.virtual	= TTC0_VIRT,
diff --git a/arch/arm/mach-zynq/include/mach/irqs.h b/arch/arm/mach-zynq/include/mach/irqs.h
index 5fb04fd..2eba43c 100644
--- a/arch/arm/mach-zynq/include/mach/irqs.h
+++ b/arch/arm/mach-zynq/include/mach/irqs.h
@@ -16,6 +16,6 @@
 #define __MACH_IRQS_H
 
 #define ARCH_NR_GPIOS	118
-#define NR_IRQS		(128 + ARCH_NR_GPIOS)
+#define NR_IRQS		128
 
 #endif
-- 
1.7.9.7

