From 726a381bfe65bd9a3f7de10430bd2c292ee0a8f2 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Mon, 4 Aug 2014 16:58:44 +0800
Subject: [PATCH 155/509] Merge remote-tracking branch 'xilinx/master-next'
 into xcomm_zynq

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit 5ea3bc963dcd5c00af3244e01772e3cded552ecb

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/spi/spi-cadence.c |   16 +++++++++-------
 1 files changed, 9 insertions(+), 7 deletions(-)

diff --git a/drivers/spi/spi-cadence.c b/drivers/spi/spi-cadence.c
index 5bdf81e..c3a8ef4 100644
--- a/drivers/spi/spi-cadence.c
+++ b/drivers/spi/spi-cadence.c
@@ -9,10 +9,6 @@
  * the terms of the GNU General Public License version 2 as published by the
  * Free Software Foundation; either version 2 of the License, or (at your
  * option) any later version.
- *
- * You should have received a copy of the GNU General Public License along with
- * this program; if not, write to the Free Software Foundation, Inc., 59 Temple
- * Place, Suite 330, Boston, MA  02111-1307  USA
  */
 
 #include <linux/clk.h>
@@ -119,6 +115,7 @@ struct cdns_spi {
 	void __iomem *regs;
 	struct clk *ref_clk;
 	struct clk *pclk;
+	unsigned int clk_rate;
 	u32 speed_hz;
 	const u8 *txbuf;
 	u8 *rxbuf;
@@ -256,7 +253,7 @@ static void cdns_spi_config_clock_freq(struct spi_device *spi,
 	u32 ctrl_reg, baud_rate_val;
 	unsigned long frequency;
 
-	frequency = clk_get_rate(xspi->ref_clk);
+	frequency = xspi->clk_rate;
 
 	ctrl_reg = cdns_spi_read(xspi, CDNS_SPI_CR_OFFSET);
 
@@ -477,6 +474,7 @@ static int cdns_spi_probe(struct platform_device *pdev)
 	struct spi_master *master;
 	struct cdns_spi *xspi;
 	struct resource *res;
+	unsigned long aper_clk_rate;
 	u32 num_cs;
 
 	master = spi_alloc_master(&pdev->dev, sizeof(*xspi));
@@ -491,7 +489,6 @@ static int cdns_spi_probe(struct platform_device *pdev)
 	xspi->regs = devm_ioremap_resource(&pdev->dev, res);
 	if (IS_ERR(xspi->regs)) {
 		ret = PTR_ERR(xspi->regs);
-		dev_err(&pdev->dev, "ioremap failed\n");
 		goto remove_master;
 	}
 
@@ -560,7 +557,12 @@ static int cdns_spi_probe(struct platform_device *pdev)
 	master->mode_bits = SPI_CPOL | SPI_CPHA;
 
 	/* Set to default valid value */
-	master->max_speed_hz = clk_get_rate(xspi->ref_clk) / 4;
+	aper_clk_rate = clk_get_rate(xspi->pclk) / 2 * 3;
+	if (aper_clk_rate > clk_get_rate(xspi->ref_clk))
+		clk_set_rate(xspi->ref_clk, aper_clk_rate);
+
+	xspi->clk_rate = clk_get_rate(xspi->ref_clk);
+	master->max_speed_hz = xspi->clk_rate / 4;
 	xspi->speed_hz = master->max_speed_hz;
 
 	master->bits_per_word_mask = SPI_BPW_MASK(8);
-- 
1.7.5.4

