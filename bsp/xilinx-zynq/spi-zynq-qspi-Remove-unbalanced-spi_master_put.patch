From 39b411301899461023a0a97a2719053920e51658 Mon Sep 17 00:00:00 2001
From: Thomas Betker <thomas.betker@rohde-schwarz.com>
Date: Wed, 19 Mar 2014 22:37:46 +0100
Subject: [PATCH 112/509] spi: zynq-qspi: Remove unbalanced spi_master_put()

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit 83fa97f4326b39173bc1b50e7b07a393d38eed51

zynq_qspi_remove() calls spi_master_put() without an associated
spi_master_get(). This breaks reference counting, so remove the call.

Note that spi_unregister_master() already does spi_master_put() [just
as spi_alloc_master() does spi_master_get()], so we don't need the
additional spi_master_put(). It may even lead to memory corruption when
spi_unregister_master() has implicitly freed the memory for the master
because the reference count dropped to 0.

Signed-off-by: Thomas Betker <thomas.betker@rohde-schwarz.com>
Reviewed-by: Harini Katakam <harinik@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/spi/spi-zynq-qspi.c |    1 -
 1 files changed, 0 insertions(+), 1 deletions(-)

diff --git a/drivers/spi/spi-zynq-qspi.c b/drivers/spi/spi-zynq-qspi.c
index 4873c97..4796596 100644
--- a/drivers/spi/spi-zynq-qspi.c
+++ b/drivers/spi/spi-zynq-qspi.c
@@ -1195,7 +1195,6 @@ static int zynq_qspi_remove(struct platform_device *pdev)
 
 
 	spi_unregister_master(master);
-	spi_master_put(master);
 
 	dev_dbg(&pdev->dev, "remove succeeded\n");
 	return 0;
-- 
1.7.5.4

