From 7ece4cc1953238d742ece0d882e8d3296b2cbd44 Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date: Wed, 26 Mar 2014 04:02:05 +0100
Subject: [PATCH 264/456] media: xilinx: tpg: Add video timing mux support

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

The current version of the TPG core has no video timing input interface
but requires video timings to be supplied through its AXI stream slave
interface when generating a test pattern.

The VDF design thus instantiates a video timing mux in front of the
video 2 AXI stream core. The mux is controlled through a GPIO, which
needs to be controlled by the TPG driver.

Future versions of the TPG core might have a video timing input
interface, removing the need for GPIO mux control.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 03ef0e828cb2922f20772a693c67b3407e591ff5)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 .../bindings/media/xilinx/xlnx,axi-tpg.txt         |   11 ++++++++---
 drivers/media/platform/xilinx/xilinx-tpg.c         |   12 ++++++++++++
 2 files changed, 20 insertions(+), 3 deletions(-)

diff --git a/Documentation/devicetree/bindings/media/xilinx/xlnx,axi-tpg.txt b/Documentation/devicetree/bindings/media/xilinx/xlnx,axi-tpg.txt
index 60ca856..75b8825 100644
--- a/Documentation/devicetree/bindings/media/xilinx/xlnx,axi-tpg.txt
+++ b/Documentation/devicetree/bindings/media/xilinx/xlnx,axi-tpg.txt
@@ -16,10 +16,14 @@ Required properties:
 Optional properties:
 
 - xlnx,vtc: A phandle referencing the Video Timing Controller that generates
-  video timings for the TPG test patterns. This property is mandatory when the
-  TPG is synthesized with two ports and forbidden when synthesized with one
-  port.
+  video timings for the TPG test patterns.
 
+- timing-gpios: Specifier for a GPIO that controls the timing mux at the TPG
+  input. The GPIO active level corresponds to the selection of VTC-generated
+  video timings.
+
+The xlnx,vtc and timing-gpios properties are mandatory when the TPG is
+synthesized with two ports and forbidden when synthesized with one port.
 
 Example:
 
@@ -28,6 +32,7 @@ Example:
 		reg = <0x40050000 0x10000>;
 
 		xlnx,vtc = <&vtc_3>;
+		timing-gpios = <&ps7_gpio_0 55 GPIO_ACTIVE_LOW>;
 
 		ports {
 			#address-cells = <1>;
diff --git a/drivers/media/platform/xilinx/xilinx-tpg.c b/drivers/media/platform/xilinx/xilinx-tpg.c
index b8b89b2..89bd7f2 100644
--- a/drivers/media/platform/xilinx/xilinx-tpg.c
+++ b/drivers/media/platform/xilinx/xilinx-tpg.c
@@ -11,6 +11,7 @@
  */
 
 #include <linux/device.h>
+#include <linux/gpio/consumer.h>
 #include <linux/module.h>
 #include <linux/of.h>
 #include <linux/platform_device.h>
@@ -69,6 +70,7 @@
  * @bayer: boolean flag if TPG is set to any bayer format
  * @ctrl_handler: control handler
  * @vtc: video timing controller
+ * @vtmux_gpio: video timing mux GPIO
  */
 struct xtpg_device {
 	struct xvip_device xvip;
@@ -84,6 +86,7 @@ struct xtpg_device {
 	struct v4l2_ctrl_handler ctrl_handler;
 
 	struct xvtc_device *vtc;
+	struct gpio_desc *vtmux_gpio;
 };
 
 static inline struct xtpg_device *to_tpg(struct v4l2_subdev *subdev)
@@ -286,6 +289,9 @@ static void xtpg_set_test_pattern(struct xtpg_device *xtpg,
 	xvip_clr_and_set(&xtpg->xvip, XTPG_PATTERN_CONTROL, XTPG_PATTERN_MASK,
 			 pattern);
 
+	if (!IS_ERR(xtpg->vtmux_gpio))
+		gpiod_set_value_cansleep(xtpg->vtmux_gpio, pattern ? 1 : 0);
+
 	xvip_enable_reg_update(&xtpg->xvip);
 }
 
@@ -694,6 +700,12 @@ static int xtpg_probe(struct platform_device *pdev)
 	if (IS_ERR(xtpg->xvip.iomem))
 		return PTR_ERR(xtpg->xvip.iomem);
 
+	xtpg->vtmux_gpio = devm_gpiod_get_index(&pdev->dev, "timing", 0);
+	if (PTR_ERR(xtpg->vtmux_gpio) == -EPROBE_DEFER)
+		return -EPROBE_DEFER;
+	if (!IS_ERR(xtpg->vtmux_gpio))
+		gpiod_direction_output(xtpg->vtmux_gpio, 0);
+
 	xtpg->vtc = xvtc_of_get(pdev->dev.of_node);
 	if (IS_ERR(xtpg->vtc))
 		return PTR_ERR(xtpg->vtc);
-- 
1.7.5.4

