From ee8dc896d28e2a81d8ff2df1e184f878883e1178 Mon Sep 17 00:00:00 2001
From: Julie Zhu <julie.zhu@xilinx.com>
Date: Tue, 21 Jun 2011 12:26:02 -0600
Subject: [PATCH 354/509] Xilinx: Dma: Driver update for loopback widget and
 test fix for receive buffer

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit 1ace8cb022b05f9e6b520df4f0c475ab1f94dc56

Driver updated for loopback widget v3.00.a. Test file, dmatest.c.cdma_dma,
updated for receive buffer proper flush before test starts. Tested on peep10,
with Linux version pele-beta1_1.1.

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/dma/xilinx_dma.c |   16 ++++++++++++++--
 1 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/drivers/dma/xilinx_dma.c b/drivers/dma/xilinx_dma.c
index 54ce133..6decca3 100644
--- a/drivers/dma/xilinx_dma.c
+++ b/drivers/dma/xilinx_dma.c
@@ -25,7 +25,7 @@
  *
  */
 
-// #define TEST_DMA_WITH_LOOPBACK
+#define TEST_DMA_WITH_LOOPBACK
 
 #include <linux/init.h>
 #include <linux/module.h>
@@ -1075,6 +1075,10 @@ static struct dma_async_tx_descriptor *xilinx_dma_prep_slave_sg(
 	size_t sg_used;
 	dma_addr_t dma_src;
 
+#ifdef TEST_DMA_WITH_LOOPBACK
+	int total_len;
+#endif
+
 	if (!dchan)
 		return NULL;
 
@@ -1084,6 +1088,14 @@ static struct dma_async_tx_descriptor *xilinx_dma_prep_slave_sg(
 		return NULL;
 	}
 
+#ifdef TEST_DMA_WITH_LOOPBACK
+	total_len = 0;
+
+	for_each_sg(sgl, sg, sg_len, i) {
+		total_len += sg_dma_len(sg);
+	}
+#endif
+
 	/*
 	 * Build transactions using information in the scatter gather list
 	 */
@@ -1127,7 +1139,7 @@ static struct dma_async_tx_descriptor *xilinx_dma_prep_slave_sg(
 				if (direction == DMA_TO_DEVICE) {
 					hw->control |= XILINX_DMA_BD_SOP;
 #ifdef TEST_DMA_WITH_LOOPBACK
-					hw->app_4 = copy;
+					hw->app_4 = total_len;
 #endif
 				}
 			} else {
-- 
1.7.5.4

