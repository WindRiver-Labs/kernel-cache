From 0af7e4e6eb654d08f459b76ffc917ed2e6b2dc8b Mon Sep 17 00:00:00 2001
From: Nicolae Rosia <nicolae.rosia@certsign.ro>
Date: Mon, 5 Jan 2015 18:02:36 +0200
Subject: [PATCH 010/456] ARM: zynq: xilinx_axidma: check if there are
 channels defined

Since it makes no sense to register a DMA Engine without any
channels, add a check for this.

Signed-off-by: Nicolae Rosia <nicolae.rosia@certsign.ro>
Acked-by: Kedareswara rao Appana <appanad@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 6ac0b33533d9e77d061f0697cd131b954d484d6b)
---
 drivers/dma/xilinx/xilinx_axidma.c |    9 +++++++--
 1 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/drivers/dma/xilinx/xilinx_axidma.c b/drivers/dma/xilinx/xilinx_axidma.c
index 237f530..78c16c0 100644
--- a/drivers/dma/xilinx/xilinx_axidma.c
+++ b/drivers/dma/xilinx/xilinx_axidma.c
@@ -980,6 +980,13 @@ static int xilinx_dma_probe(struct platform_device *pdev)
 	bool has_sg;
 	unsigned int i;
 
+	node = pdev->dev.of_node;
+
+	if (of_get_child_count(node) == 0) {
+		dev_err(&pdev->dev, "no channels defined\n");
+		return -ENODEV;
+	}
+
 	xdev = devm_kzalloc(&pdev->dev, sizeof(*xdev), GFP_KERNEL);
 	if (!xdev)
 		return -ENOMEM;
@@ -987,8 +994,6 @@ static int xilinx_dma_probe(struct platform_device *pdev)
 	xdev->dev = &(pdev->dev);
 	INIT_LIST_HEAD(&xdev->common.channels);
 
-	node = pdev->dev.of_node;
-
 	/* iomap registers */
 	res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
 	xdev->regs = devm_ioremap_resource(&pdev->dev, res);
-- 
1.7.5.4

