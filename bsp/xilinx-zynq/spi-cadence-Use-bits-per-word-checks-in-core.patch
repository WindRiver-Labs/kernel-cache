From 863e194c8be9394b73ada2785ddd34d8cadab07d Mon Sep 17 00:00:00 2001
From: Harini Katakam <harini.katakam@xilinx.com>
Date: Tue, 6 May 2014 14:59:01 +0530
Subject: [PATCH 138/509] spi: cadence: Use bits per word checks in core

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit aa5daf0071041d3918cf30df560017e574b4c8ac

Set master->bits_per_word_mask. Remove checks in driver.

Signed-off-by: Harini Katakam <harinik@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/spi/spi-cadence.c |   17 +++--------------
 1 files changed, 3 insertions(+), 14 deletions(-)

diff --git a/drivers/spi/spi-cadence.c b/drivers/spi/spi-cadence.c
index c1c5290..1369fa5 100644
--- a/drivers/spi/spi-cadence.c
+++ b/drivers/spi/spi-cadence.c
@@ -256,22 +256,12 @@ static void cdns_spi_config_clock(struct spi_device *spi,
  * Sets the operational mode of SPI controller for the next SPI transfer and
  * sets the requested clock frequency.
  *
- * Return:	0 on success and error value on error
+ * Return:	Always 0
  */
 static int cdns_spi_setup_transfer(struct spi_device *spi,
 		struct spi_transfer *transfer)
 {
 	struct cdns_spi *xspi = spi_master_get_devdata(spi->master);
-	u8 bits_per_word;
-
-	bits_per_word = transfer ?
-			transfer->bits_per_word : spi->bits_per_word;
-
-	if (bits_per_word != 8) {
-		dev_err(&spi->dev, "%s, unsupported bits per word %x\n",
-			__func__, spi->bits_per_word);
-		return -EINVAL;
-	}
 
 	cdns_spi_config_clock(spi, transfer);
 
@@ -293,9 +283,6 @@ static int cdns_spi_setup_transfer(struct spi_device *spi,
  */
 static int cdns_spi_setup(struct spi_device *spi)
 {
-	if (!spi->bits_per_word)
-		spi->bits_per_word = 8;
-
 	return cdns_spi_setup_transfer(spi, NULL);
 }
 
@@ -651,6 +638,8 @@ static int cdns_spi_probe(struct platform_device *pdev)
 	master->max_speed_hz = clk_get_rate(xspi->ref_clk) / 4;
 	xspi->speed_hz = master->max_speed_hz;
 
+	master->bits_per_word_mask = SPI_BPW_MASK(8);
+
 	xspi->driver_state = CDNS_SPI_DRIVER_STATE_READY;
 
 	ret = spi_register_master(master);
-- 
1.7.5.4

