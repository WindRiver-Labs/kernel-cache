From 01dc0caf626097f2817006d0ee3e9cbb0c0025f5 Mon Sep 17 00:00:00 2001
From: Harini Katakam <harini.katakam@xilinx.com>
Date: Fri, 7 Mar 2014 18:58:18 +0530
Subject: [PATCH 070/509] SPI: zynq: Cleanup of irq function

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit 277cfb6f1a8812169d525b8cd0012968f1746045

Interrupts are being disabled and enabled again in the irq function.
Changed this to disable interrupts only in case of tranfer completion
or error.

Signed-off-by: Harini Katakam <harinik@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/spi/spi-zynq.c |    8 ++++----
 1 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/spi/spi-zynq.c b/drivers/spi/spi-zynq.c
index 0f11053..d2ba818 100644
--- a/drivers/spi/spi-zynq.c
+++ b/drivers/spi/spi-zynq.c
@@ -327,12 +327,13 @@ static irqreturn_t zynq_spi_irq(int irq, void *dev_id)
 
 	intr_status = zynq_spi_read(xspi->regs + ZYNQ_SPI_ISR_OFFSET);
 	zynq_spi_write(xspi->regs + ZYNQ_SPI_ISR_OFFSET, intr_status);
-	zynq_spi_write(xspi->regs + ZYNQ_SPI_IDR_OFFSET, ZYNQ_SPI_IXR_ALL_MASK);
 
 	if (intr_status & ZYNQ_SPI_IXR_MODF_MASK) {
 		/* Indicate that transfer is completed, the SPI subsystem will
 		 * identify the error as the remaining bytes to be
 		 * transferred is non-zero */
+		zynq_spi_write(xspi->regs + ZYNQ_SPI_IDR_OFFSET,
+				ZYNQ_SPI_IXR_ALL_MASK);
 		complete(&xspi->done);
 	} else if (intr_status & ZYNQ_SPI_IXR_TXOW_MASK) {
 		u32 ctrl_reg;
@@ -360,9 +361,6 @@ static irqreturn_t zynq_spi_irq(int irq, void *dev_id)
 			/* There is more data to send */
 			zynq_spi_fill_tx_fifo(xspi);
 
-			zynq_spi_write(xspi->regs + ZYNQ_SPI_IER_OFFSET,
-					ZYNQ_SPI_IXR_ALL_MASK);
-
 			spin_lock(&xspi->ctrl_reg_lock);
 
 			ctrl_reg = zynq_spi_read(xspi->regs +
@@ -374,6 +372,8 @@ static irqreturn_t zynq_spi_irq(int irq, void *dev_id)
 			spin_unlock(&xspi->ctrl_reg_lock);
 		} else {
 			/* Transfer is completed */
+			zynq_spi_write(xspi->regs + ZYNQ_SPI_IDR_OFFSET,
+					ZYNQ_SPI_IXR_ALL_MASK);
 			complete(&xspi->done);
 		}
 	}
-- 
1.7.5.4

