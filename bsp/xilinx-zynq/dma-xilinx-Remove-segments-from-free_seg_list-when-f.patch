From 4b868a9cbd54846af2c30a6a96c8f48106b14d7c Mon Sep 17 00:00:00 2001
From: Joseph Zavodny <Joseph.Zavodny@jhuapl.edu>
Date: Mon, 14 Sep 2015 02:00:02 -0400
Subject: [PATCH 62/77] dma: xilinx: Remove segments from free_seg_list when
 freeing channel resources.

This patch fixes a bug in which requesting and releasing the dma channel
multiple times would result in undefined behavior.  When the memory that was
allocated for the segments is freed, all the segments must be removed from the
free segment list.  Without doing this the driver will continue to access
memory which it no longer owns.  This in turn leads to memory corruption
and unpredictable hardware operations as the hardware descriptors are
contained within this memory.

Signed-off-by: Joseph Zavodny <Joseph.Zavodny@jhuapl.edu>
Reviewed-by: Kedareswara rao Appana <appanad@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
[zou:Original patch taken from
https://github.com/Xilinx/linux-xlnx.git Petalinux 2015.4]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/dma/xilinx/xilinx_dma.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/drivers/dma/xilinx/xilinx_dma.c b/drivers/dma/xilinx/xilinx_dma.c
index 1eaf34f..93433c6 100644
--- a/drivers/dma/xilinx/xilinx_dma.c
+++ b/drivers/dma/xilinx/xilinx_dma.c
@@ -432,9 +432,16 @@ static void xilinx_dma_free_descriptors(struct xilinx_dma_chan *chan)
 static void xilinx_dma_free_chan_resources(struct dma_chan *dchan)
 {
 	struct xilinx_dma_chan *chan = to_xilinx_chan(dchan);
+	unsigned long flags;
 
 	xilinx_dma_free_descriptors(chan);
 
+	/* Remove all segments from free segment list */
+	spin_lock_irqsave(&chan->lock, flags);
+	INIT_LIST_HEAD(&chan->free_seg_list);
+	spin_unlock_irqrestore(&chan->lock, flags);
+
+	/* Free memory that was allocated for the segments */
 	dma_free_coherent(chan->dev,
 			  sizeof(*chan->seg_v) * XILINX_DMA_NUM_DESCS,
 			  chan->seg_v, chan->seg_p);
-- 
1.7.5.4

