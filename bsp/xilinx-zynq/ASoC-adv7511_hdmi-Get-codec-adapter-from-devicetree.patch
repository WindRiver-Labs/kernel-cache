From c363fe3e3f4e89e9edf84ba56958abec45e12f5e Mon Sep 17 00:00:00 2001
From: Lars-Peter Clausen <lars@metafoo.de>
Date: Mon, 29 Oct 2012 13:06:50 +0100
Subject: [PATCH 260/509] ASoC: adv7511_hdmi: Get codec adapter from
 devicetree

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit abdb1e4419a1b4d3ac4032491c9e7a522dab8acd

Get the I2C adapter on which the adv7511 is registered from the devicetree. This
allows the code to run on both ZC702 and ZED without modification.

Signed-off-by: Lars-Peter Clausen <lars@metafoo.de>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 sound/soc/xlnx/adv7511_hdmi.c |   16 ++++++++++++++--
 1 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/sound/soc/xlnx/adv7511_hdmi.c b/sound/soc/xlnx/adv7511_hdmi.c
index 79be998..410ad19 100644
--- a/sound/soc/xlnx/adv7511_hdmi.c
+++ b/sound/soc/xlnx/adv7511_hdmi.c
@@ -18,16 +18,19 @@
 #include <linux/interrupt.h>
 #include <linux/platform_device.h>
 #include <linux/of.h>
+#include <linux/of_i2c.h>
 #include <sound/core.h>
 #include <sound/pcm.h>
 #include <sound/soc.h>
 
+static char adv7511_codec_name[] = "adv7511.2-0039";
+
 static struct snd_soc_dai_link hdmi_dai_link = {
 	.name = "HDMI",
 	.stream_name = "HDMI",
 /*	.cpu_dai_name = "75c00000.axi-spdif-tx",
 	.platform_name = "xilinx_pcm_audio.2",*/
-	.codec_name = "adv7511.2-0039",
+	.codec_name = adv7511_codec_name,
 	.codec_dai_name = "adv7511",
 	.dai_fmt = SND_SOC_DAIFMT_SPDIF |
 			SND_SOC_DAIFMT_NB_NF |
@@ -41,20 +44,29 @@ static struct snd_soc_card hdmi_card = {
 	.num_links = 1,
 };
 
+
 static int __devinit adv7511_hdmi_probe(struct platform_device *pdev)
 {
 	struct snd_soc_card *card = &hdmi_card;
 	struct device_node *of_node = pdev->dev.of_node;
+	struct device_node *adapter_node;
+	struct i2c_adapter *adapter;
 
 	if (!of_node)
 		return -ENXIO;
 
 	card->dev = &pdev->dev;
 
-/*	hdmi_dai_link.codec_of_node = of_parse_phandle(of_node, "audio-codec", 0);*/
 	hdmi_dai_link.cpu_dai_of_node = of_parse_phandle(of_node, "cpu-dai", 0);
 	hdmi_dai_link.platform_of_node = of_parse_phandle(of_node, "pcm", 0);
 
+	adapter_node = of_parse_phandle(of_node, "audio-codec-adapter", 0);
+	adapter = of_find_i2c_adapter_by_node(adapter_node);
+	if (adapter) {
+		snprintf(adv7511_codec_name, sizeof(adv7511_codec_name),
+			"adv7511.%d-0039", i2c_adapter_id(adapter));
+	}
+
 	if (/*!hdmi_dai_link.codec_of_node || */!hdmi_dai_link.cpu_dai_of_node ||
 		!hdmi_dai_link.platform_of_node)
 		return -ENXIO;
-- 
1.7.5.4

