From 35b16aeeb66accdc481d14b9d9354ac080a2dcd6 Mon Sep 17 00:00:00 2001
From: Soren Brinkmann <soren.brinkmann@xilinx.com>
Date: Wed, 30 Jul 2014 09:13:07 -0700
Subject: [PATCH 160/182] ARM: zynq: Enable A9 clock gating feature

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Signed-off-by: Soren Brinkmann <soren.brinkmann@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 51c3e24f3d35de5144e77d6f0d8dbebab4090f85)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-zynq/common.c  |    1 +
 arch/arm/mach-zynq/common.h  |   11 +++++++++++
 arch/arm/mach-zynq/platsmp.c |    1 +
 arch/arm/mach-zynq/pm.c      |   15 ---------------
 4 files changed, 13 insertions(+), 15 deletions(-)

diff --git a/arch/arm/mach-zynq/common.c b/arch/arm/mach-zynq/common.c
index c549ca2..fffa206 100644
--- a/arch/arm/mach-zynq/common.c
+++ b/arch/arm/mach-zynq/common.c
@@ -97,6 +97,7 @@ early_initcall(zynq_l2c_init);
 static void __init zynq_init_late(void)
 {
 	zynq_pm_late_init();
+	zynq_core_pm_init();
 	zynq_prefetch_init();
 }
 
diff --git a/arch/arm/mach-zynq/common.h b/arch/arm/mach-zynq/common.h
index 9b5ef0b..0b60098 100644
--- a/arch/arm/mach-zynq/common.h
+++ b/arch/arm/mach-zynq/common.h
@@ -73,4 +73,15 @@ static inline void zynq_prefetch_init(void)
 		      : : : "r1");
 }
 
+static inline void zynq_core_pm_init(void)
+{
+	/* A9 clock gating */
+	asm volatile ("mrc  p15, 0, r12, c15, c0, 0\n"
+		      "orr  r12, r12, #1\n"
+		      "mcr  p15, 0, r12, c15, c0, 0\n"
+		      : /* no outputs */
+		      : /* no inputs */
+		      : "r12");
+}
+
 #endif
diff --git a/arch/arm/mach-zynq/platsmp.c b/arch/arm/mach-zynq/platsmp.c
index 3dd4bb6..d42e8bb 100644
--- a/arch/arm/mach-zynq/platsmp.c
+++ b/arch/arm/mach-zynq/platsmp.c
@@ -117,6 +117,7 @@ static void __init zynq_smp_prepare_cpus(unsigned int max_cpus)
  */
 static void zynq_secondary_init(unsigned int cpu)
 {
+	zynq_core_pm_init();
 	zynq_prefetch_init();
 }
 
diff --git a/arch/arm/mach-zynq/pm.c b/arch/arm/mach-zynq/pm.c
index 248ef3d..0524c15 100644
--- a/arch/arm/mach-zynq/pm.c
+++ b/arch/arm/mach-zynq/pm.c
@@ -65,13 +65,6 @@ static int zynq_pm_suspend(unsigned long arg)
 	/* Topswitch clock stop disable */
 	zynq_clk_topswitch_disable();
 
-	/* A9 clock gating */
-	asm volatile ("mrc  p15, 0, r12, c15, c0, 0\n"
-		      "orr  r12, r12, #1\n"
-		      "mcr  p15, 0, r12, c15, c0, 0\n"
-		      : /* no outputs */
-		      : /* no inputs */
-		      : "r12");
 
 	if (!ocm_base || !ddrc_base)
 		do_ddrpll_bypass = 0;
@@ -94,14 +87,6 @@ static int zynq_pm_suspend(unsigned long arg)
 	/* Topswitch clock stop enable */
 	zynq_clk_topswitch_enable();
 
-	/* A9 clock gating */
-	asm volatile ("mrc  p15, 0, r12, c15, c0, 0\n"
-		      "bic  r12, r12, #1\n"
-		      "mcr  p15, 0, r12, c15, c0, 0\n"
-		      : /* no outputs */
-		      : /* no inputs */
-		      : "r12");
-
 	return 0;
 }
 
-- 
1.7.5.4

