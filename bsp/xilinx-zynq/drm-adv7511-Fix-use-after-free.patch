From eff6b3740dbf15ebe4891e41d2b3b5fccaa620d9 Mon Sep 17 00:00:00 2001
From: Lars-Peter Clausen <lars@metafoo.de>
Date: Wed, 4 Sep 2013 17:35:05 +0200
Subject: [PATCH 184/456] drm: adv7511: Fix use after free

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

We need to use the free the old edid buffer not the new one.

Reported-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Signed-off-by: Lars-Peter Clausen <lars@metafoo.de>
(cherry picked from commit c6ac0fac308289b9be5b935d7ce85e72afba3fcc)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpu/drm/i2c/adv7511_core.c |    3 +--
 1 files changed, 1 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/i2c/adv7511_core.c b/drivers/gpu/drm/i2c/adv7511_core.c
index 303d49e..59c98fe 100644
--- a/drivers/gpu/drm/i2c/adv7511_core.c
+++ b/drivers/gpu/drm/i2c/adv7511_core.c
@@ -461,6 +461,7 @@ static int adv7511_get_modes(struct drm_encoder *encoder,
 				   ADV7511_POWER_POWER_DOWN,
 				   ADV7511_POWER_POWER_DOWN);
 
+	kfree(adv7511->edid);
 	adv7511->edid = edid;
 	if (!edid)
 		return 0;
@@ -468,8 +469,6 @@ static int adv7511_get_modes(struct drm_encoder *encoder,
 	drm_mode_connector_update_edid_property(connector, edid);
 	count = drm_add_edid_modes(connector, edid);
 
-	kfree(adv7511->edid);
-
 	return count;
 }
 
-- 
1.7.5.4

