From d58b24296dd7cbd7ff2223eecd8e014631b71eff Mon Sep 17 00:00:00 2001
From: Lars-Peter Clausen <lars@metafoo.de>
Date: Wed, 4 Sep 2013 17:35:05 +0200
Subject: [PATCH 242/509] drm: adv7511: Fix use after free

https://github.com/analogdevicesinc/linux.git xcomm_zynq
commit 40d8cf29d5f6cbe51f6b9efdc6be49e0108ba4c7

We need to use the free the old edid buffer not the new one.

Reported-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Signed-off-by: Lars-Peter Clausen <lars@metafoo.de>
Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/gpu/drm/i2c/adv7511_core.c |    3 +--
 1 files changed, 1 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/i2c/adv7511_core.c b/drivers/gpu/drm/i2c/adv7511_core.c
index f26151d..8150a8e 100644
--- a/drivers/gpu/drm/i2c/adv7511_core.c
+++ b/drivers/gpu/drm/i2c/adv7511_core.c
@@ -497,6 +497,7 @@ static int adv7511_get_modes(struct drm_encoder *encoder,
 		regmap_update_bits(adv7511->regmap, ADV7511_REG_POWER,
 				ADV7511_POWER_POWER_DOWN, ADV7511_POWER_POWER_DOWN);
 
+	kfree(adv7511->edid);
 	adv7511->edid = edid;
 	if (!edid)
 		return 0;
@@ -504,8 +505,6 @@ static int adv7511_get_modes(struct drm_encoder *encoder,
 	drm_mode_connector_update_edid_property(connector, edid);
 	count = drm_add_edid_modes(connector, edid);
 
-	kfree(adv7511->edid);
-
 	return count;
 }
 
-- 
1.7.5.4

