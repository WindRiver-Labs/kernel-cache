From 1a9848bcb540a61bbdfca0018ea047e605b30e1b Mon Sep 17 00:00:00 2001
From: Soren Brinkmann <soren.brinkmann@xilinx.com>
Date: Thu, 10 Apr 2014 08:03:56 -0700
Subject: [PATCH 165/182] i2c: cadence: Report NACK errors with correct error
 code

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Report NACK properly using -ENXIO instead of -EIO error code.

Signed-off-by: Soren Brinkmann <soren.brinkmann@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit c2f40bdb8bd1027ffc807cc2b419becbebdad049)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/i2c/busses/i2c-cadence.c |    8 ++++++--
 1 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/i2c/busses/i2c-cadence.c b/drivers/i2c/busses/i2c-cadence.c
index 0b90e59..75aabd5 100644
--- a/drivers/i2c/busses/i2c-cadence.c
+++ b/drivers/i2c/busses/i2c-cadence.c
@@ -554,9 +554,13 @@ static int cdns_i2c_master_xfer(struct i2c_adapter *adap, struct i2c_msg *msgs,
 		if (ret)
 			return ret;
 
-		/* Report the other error interrupts to application as EIO */
-		if (id->err_status & 0xE4) {
+		/* Report the other error interrupts to application */
+		if (id->err_status) {
 			cdns_i2c_master_reset(adap);
+
+			if (id->err_status & CDNS_I2C_IXR_NACK)
+				return -ENXIO;
+
 			return -EIO;
 		}
 	}
-- 
1.7.5.4

