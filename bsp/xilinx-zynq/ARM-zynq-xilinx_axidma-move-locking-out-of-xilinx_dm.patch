From 27e4c61cabd1c40d8e9009099b8b753c964368e0 Mon Sep 17 00:00:00 2001
From: Nicolae Rosia <nicolae.rosia@certsign.ro>
Date: Mon, 5 Jan 2015 18:12:06 +0200
Subject: [PATCH 028/456] ARM: zynq: xilinx_axidma: move locking out of
 xilinx_dma_update_completed_cookie

Signed-off-by: Nicolae Rosia <nicolae.rosia@certsign.ro>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 32db5675b651faa7cae5a4913dbb39e49b14a8dc)
---
 drivers/dma/xilinx/xilinx_axidma.c |   10 +++-------
 1 files changed, 3 insertions(+), 7 deletions(-)

diff --git a/drivers/dma/xilinx/xilinx_axidma.c b/drivers/dma/xilinx/xilinx_axidma.c
index 3b8d478..6b70695 100644
--- a/drivers/dma/xilinx/xilinx_axidma.c
+++ b/drivers/dma/xilinx/xilinx_axidma.c
@@ -432,13 +432,10 @@ static void xilinx_dma_update_completed_cookie(struct xilinx_dma_chan *chan)
 {
 	struct xilinx_dma_desc_sw *desc = NULL;
 	struct xilinx_dma_desc_hw *hw = NULL;
-	unsigned long flags;
-
-	spin_lock_irqsave(&chan->lock, flags);
 
 	if (list_empty(&chan->active_list)) {
 		dev_dbg(chan->dev, "no running descriptors\n");
-		goto out_unlock;
+		return;
 	}
 
 	/* Get the last completed descriptor, update the cookie to that */
@@ -456,9 +453,6 @@ static void xilinx_dma_update_completed_cookie(struct xilinx_dma_chan *chan)
 			chan->completed_cookie = desc->async_tx.cookie;
 		}
 	}
-
-out_unlock:
-	spin_unlock_irqrestore(&chan->lock, flags);
 }
 /**
  * xilinx_dma_chan_config - Configure DMA Channel IRQThreshold, IRQDelay
@@ -541,7 +535,9 @@ static irqreturn_t dma_intr_handler(int irq, void *data)
 		dev_dbg(chan->dev, "Inter-packet latency too long\n");
 
 	if (stat & XILINX_DMA_XR_IRQ_IOC_MASK) {
+		spin_lock(&chan->lock);
 		xilinx_dma_update_completed_cookie(chan);
+		spin_unlock(&chan->lock);
 		xilinx_dma_start_transfer(chan);
 	}
 
-- 
1.7.5.4

