From dfab38d87d3cea1e6ec821f69da3af961ebd0c25 Mon Sep 17 00:00:00 2001
From: Ranjit Waghmode <ranjit.waghmode@xilinx.com>
Date: Fri, 6 Nov 2015 11:09:51 +0530
Subject: [PATCH 296/299] qspi: mtd: spi-nor: fix spansion register read issue

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

This patch enables stripe option before reading registers
in spansion_quad_enable() to avoid any read register issues.

Signed-off-by: Ranjit Waghmode <ranjit.waghmode@xilinx.com>
Reviewed-by: Harini Katakam <harinik@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 3d49456a0baa6e9d006463274e184c20381314d9)
---
 drivers/mtd/spi-nor/spi-nor.c | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/drivers/mtd/spi-nor/spi-nor.c b/drivers/mtd/spi-nor/spi-nor.c
index afb1c10..95ff0cd 100644
--- a/drivers/mtd/spi-nor/spi-nor.c
+++ b/drivers/mtd/spi-nor/spi-nor.c
@@ -1335,9 +1335,15 @@ static int __maybe_unused spansion_quad_enable(struct spi_nor *nor)
 	int ret;
 	int quad_en = CR_QUAD_EN_SPAN << 8;
 
+	if (nor->isparallel)
+		nor->spi->master->flags |= SPI_DATA_STRIPE;
+
 	quad_en |= read_sr(nor);
 	quad_en |= (read_cr(nor) << 8);
 
+	if (nor->isparallel)
+		nor->spi->master->flags &= ~SPI_DATA_STRIPE;
+
 	write_enable(nor);
 
 	ret = write_sr_cr(nor, quad_en);
@@ -1347,13 +1353,20 @@ static int __maybe_unused spansion_quad_enable(struct spi_nor *nor)
 		return -EINVAL;
 	}
 
+	if (nor->isparallel)
+		nor->spi->master->flags |= SPI_DATA_STRIPE;
 	/* read back and check it */
 	ret = read_cr(nor);
 	if (!(ret > 0 && (ret & CR_QUAD_EN_SPAN))) {
 		dev_err(nor->dev, "Spansion Quad bit not set\n");
+		if (nor->isparallel)
+			nor->spi->master->flags &= ~SPI_DATA_STRIPE;
 		return -EINVAL;
 	}
 
+	if (nor->isparallel)
+		nor->spi->master->flags &= ~SPI_DATA_STRIPE;
+
 	return 0;
 }
 
-- 
2.0.2

