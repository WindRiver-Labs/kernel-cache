From ce039e23da7674a6ccc57b7814b7ac223cbd4624 Mon Sep 17 00:00:00 2001
From: Liang Li <Liang.Li@windriver.com>
Date: Thu, 22 Jan 2009 11:36:17 +0800
Subject: [PATCH] broadcom_bcm98548xmc: add warm reset support

Since the common warm reset function fsl_rstcr_restart don't work
on this BSP and_board has its specific board reset control register, we
should make use of it to do warm reset.

Signed-off-by: Yang Shi <Yang.Shi@windriver.com>
Signed-off-by: Liang Li <Liang.Li@windriver.com>
---
 arch/powerpc/platforms/85xx/bcm98548xmc.c |   29 ++++++++++++++++++++++++++++-
 1 files changed, 28 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/bcm98548xmc.c b/arch/powerpc/platforms/85xx/bcm98548xmc.c
index dcbe4e5..67a37f4 100644
--- a/arch/powerpc/platforms/85xx/bcm98548xmc.c
+++ b/arch/powerpc/platforms/85xx/bcm98548xmc.c
@@ -171,6 +171,33 @@ static void bcm98548xmc_show_cpuinfo(struct seq_file *m)
 	seq_printf(m, "Memory\t\t: %d MB\n", memsize / (1024 * 1024));
 }
 
+static __be32 __iomem *rstcr;
+static __be32 __iomem *rstdr;
+static int __init bcm98548xmc_init_rstcr(void)
+{
+	/* map reset control register */
+	printk(KERN_INFO "bcm98548xmc : map reset control register.\n");
+	rstdr = ioremap(get_immrbase() + 0xE0040, 0xff);
+	rstcr = ioremap(get_immrbase() + 0xE0030, 0xff);
+	return 0;
+}
+arch_initcall(bcm98548xmc_init_rstcr);
+
+void bcm98548xmc_restart(char *cmd)
+{
+	local_irq_disable();
+	if (rstcr && rstdr) {
+		/* set reset control register */
+		out_be32(rstdr, ~0x0);	/* HRESET_REQ */
+		out_be32(rstcr, 0x200);	/* HRESET_REQ */
+		out_be32(rstdr, ~0x1);	/* HRESET_REQ */
+		out_be32(rstdr, ~0x3);	/* HRESET_REQ */
+	} else
+		printk (KERN_EMERG "Error: reset control register not mapped."
+				"Please power cycle board manually!\n");
+	while(1);
+}
+
 /*
  * Called very early, device-tree isn't unflattened
  */
@@ -186,7 +213,7 @@ define_machine(bcm98548xmc) {
 	.init_IRQ	= bcm98548xmc_pic_init,
 	.show_cpuinfo	= bcm98548xmc_show_cpuinfo,
 	.get_irq	= mpic_get_irq,
-	.restart	= fsl_rstcr_restart,
+	.restart	= bcm98548xmc_restart,
 	.calibrate_decr = generic_calibrate_decr,
 	.progress	= udbg_progress,
 };
-- 
1.6.0.4

