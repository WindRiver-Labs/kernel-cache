From 264abf904168858509ec0ebdc4ed2dfd4406079c Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Wed, 5 Jan 2011 18:36:43 +0800
Subject: [PATCH 02/16] Ethernet support for spear1310

Original sources came from STMicro's vendor drop.

Add Ethernet support for spear13xx.

Signed-off-by: Rajeev Kumar <rajeev-dlh.kumar@st.com>
Signed-off-by: Viresh Kumar <viresh.kumar@st.com>
Integrated-by: Stanlen.Miao <stanley.miao@windriver.com>
---
 arch/arm/mach-spear13xx/include/mach/generic.h |    1 +
 arch/arm/mach-spear13xx/spear1310_evb.c        |   30 ++++++++++++++++++
 arch/arm/mach-spear13xx/spear13xx.c            |   40 ++++++++++++++++++++++++
 drivers/net/stmmac/Kconfig                     |    2 +-
 4 files changed, 72 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-spear13xx/include/mach/generic.h b/arch/arm/mach-spear13xx/include/mach/generic.h
index 445b3ba..bae6467 100644
--- a/arch/arm/mach-spear13xx/include/mach/generic.h
+++ b/arch/arm/mach-spear13xx/include/mach/generic.h
@@ -29,6 +29,7 @@
 #define SPEAR_GPT0_CHAN1_IRQ	IRQ_GPT0_TMR1
 
 extern struct amba_device spear13xx_uart_device;
+extern struct platform_device spear13xx_eth0_device;
 extern struct sys_timer spear13xx_timer;
 
 /* Add spear13xx family function declarations here */
diff --git a/arch/arm/mach-spear13xx/spear1310_evb.c b/arch/arm/mach-spear13xx/spear1310_evb.c
index 12d7329..7d3ed95 100644
--- a/arch/arm/mach-spear13xx/spear1310_evb.c
+++ b/arch/arm/mach-spear13xx/spear1310_evb.c
@@ -12,16 +12,46 @@
  */
 
 #include <linux/types.h>
+#include <linux/phy.h>
 #include <asm/mach/arch.h>
+#include <linux/stmmac.h>
 #include <asm/mach-types.h>
 #include <mach/generic.h>
 #include <mach/spear.h>
+#include <mach/hardware.h>
+
+/* Ethernet phy-0 device registeration */
+static struct plat_stmmacphy_data phy0_private_data = {
+	.bus_id = 0,
+	.phy_addr = 5,
+	.phy_mask = 0,
+	.interface = PHY_INTERFACE_MODE_GMII,
+};
+
+static struct resource phy0_resources = {
+	.name = "phyirq",
+	.start = -1,
+	.end = -1,
+	.flags = IORESOURCE_IRQ,
+};
+
+struct platform_device spear1310_phy0_device = {
+	.name		= "stmmacphy",
+	.id		= 0,
+	.num_resources	= 1,
+	.resource	= &phy0_resources,
+	.dev.platform_data = &phy0_private_data,
+};
 
 static struct amba_device *amba_devs[] __initdata = {
 	&spear13xx_uart_device,
 };
 
 static struct platform_device *plat_devs[] __initdata = {
+	&spear13xx_eth0_device,
+
+	/* spear1310 specific devices */
+	&spear1310_phy0_device,
 };
 
 static void __init spear1310_evb_init(void)
diff --git a/arch/arm/mach-spear13xx/spear13xx.c b/arch/arm/mach-spear13xx/spear13xx.c
index 4abcc23..81adc16 100644
--- a/arch/arm/mach-spear13xx/spear13xx.c
+++ b/arch/arm/mach-spear13xx/spear13xx.c
@@ -15,6 +15,7 @@
 #include <linux/ptrace.h>
 #include <linux/io.h>
 #include <linux/clk.h>
+#include <linux/stmmac.h>
 #include <asm/hardware/gic.h>
 #include <asm/irq.h>
 #include <asm/localtimer.h>
@@ -37,6 +38,45 @@ struct amba_device spear13xx_uart_device = {
 	.irq = {IRQ_UART, NO_IRQ},
 };
 
+/* Ethernet device registeration */
+static struct plat_stmmacenet_data ether0_platform_data = {
+	.bus_id = 0,
+	.has_gmac = 1,
+	.pbl = 32,
+};
+
+static struct resource eth0_resources[] = {
+	[0] = {
+		.start = SPEAR13XX_GETH0_BASE,
+		.end = SPEAR13XX_GETH0_BASE + SZ_32K - 1,
+		.flags = IORESOURCE_MEM,
+	},
+	[1] = {
+		.start = IRQ_GMAC_1,
+		.flags = IORESOURCE_IRQ,
+		.name = "macirq",
+	},
+	[2] = {
+		.start = IRQ_GMAC_2,
+		.flags = IORESOURCE_IRQ,
+	},
+};
+
+static u64 eth0_dma_mask = ~(u32) 0;
+
+struct platform_device spear13xx_eth0_device = {
+	.name = "stmmaceth",
+	.id = 0,
+	.num_resources = ARRAY_SIZE(eth0_resources),
+	.resource = eth0_resources,
+	.dev = {
+		.platform_data = &ether0_platform_data,
+		.dma_mask = &eth0_dma_mask,
+		.coherent_dma_mask = ~0,
+	},
+};
+
+
 /* Do spear13xx familiy common initialization part here */
 void __init spear13xx_init(void)
 {
diff --git a/drivers/net/stmmac/Kconfig b/drivers/net/stmmac/Kconfig
index eb63d44..50bb0c0 100644
--- a/drivers/net/stmmac/Kconfig
+++ b/drivers/net/stmmac/Kconfig
@@ -3,7 +3,7 @@ config STMMAC_ETH
 	select MII
 	select PHYLIB
 	select CRC32
-	depends on NETDEVICES && CPU_SUBTYPE_ST40
+	depends on NETDEVICES && (CPU_SUBTYPE_ST40 || PLAT_SPEAR)
 	help
 	  This is the driver for the Ethernet IPs are built around a
 	  Synopsys IP Core and fully tested on the STMicroelectronics
-- 
1.7.0.4

