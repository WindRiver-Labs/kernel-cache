From c4997da22bd5447cf4c8650898304c10d79f35c4 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Thu, 23 Dec 2010 12:00:45 +0800
Subject: [PATCH] mx31: don't use same resource struct for different device

Both otg_device and udc_device share same otg_resources
struct as it's resource member. which cause endless loop
when cat iomem, and testcase proc01 will hang the target.

Add definition for udc_resources struct, and dr_udc_device
use udc_resources as resource member to replace otg_resources.

Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 arch/arm/mach-mx3/usb_dr.c |   16 ++++++++++++++--
 1 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-mx3/usb_dr.c b/arch/arm/mach-mx3/usb_dr.c
index a204150..2f940ee 100644
--- a/arch/arm/mach-mx3/usb_dr.c
+++ b/arch/arm/mach-mx3/usb_dr.c
@@ -76,6 +76,18 @@ static struct resource otg_resources[] = {
 	},
 };
 
+static struct resource udc_resources[] = {
+	[0] = {
+		.start = (u32)(USB_OTGREGS_BASE),
+		.end   = (u32)(USB_OTGREGS_BASE + 0x1ff),
+		.flags = IORESOURCE_MEM,
+	},
+	[1] = {
+		.start = MXC_INT_USB3,
+		.flags = IORESOURCE_IRQ,
+	},
+};
+
 
 static u64 dr_udc_dmamask = ~(u32) 0;
 static void dr_udc_release(struct device *dev)
@@ -99,8 +111,8 @@ static struct platform_device __maybe_unused dr_udc_device = {
 		.dma_mask          = &dr_udc_dmamask,
 		.coherent_dma_mask = 0xffffffff,
 	},
-	.resource      = otg_resources,
-	.num_resources = ARRAY_SIZE(otg_resources),
+	.resource      = udc_resources,
+	.num_resources = ARRAY_SIZE(udc_resources),
 };
 
 static struct platform_device __maybe_unused dr_otg_device = {
-- 
1.7.3.3

