From 458bedb71163db4efb57e3222edfeb1c3fa84c33 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 12 Oct 2011 11:48:24 -0700
Subject: [PATCH 206/238] NET: octeon-ethernet: Only report CHECKSUM_UNNECESSARY for TCP/UDP packets.

Source: Cavium SDK 2.3-427

The hardware checksum is only done for TCP or UDP packets, so those
are the only ones we can assert have a good the checksum.

Signed-off-by: David Daney <david.daney@cavium.com>
Integrated-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/net/octeon/ethernet-napi.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/net/octeon/ethernet-napi.c b/drivers/net/octeon/ethernet-napi.c
index c5e8593..be131b3 100644
--- a/drivers/net/octeon/ethernet-napi.c
+++ b/drivers/net/octeon/ethernet-napi.c
@@ -373,7 +373,8 @@ static int CVM_OCT_NAPI_POLL(struct napi_struct *napi, int budget)
 				skb->protocol = eth_type_trans(skb, priv->netdev);
 				skb->dev = priv->netdev;
 
-				if (unlikely(work->word2.s.not_IP || work->word2.s.IP_exc || work->word2.s.L4_error))
+				if (unlikely(work->word2.s.not_IP || !work->word2.s.tcp_or_udp ||
+					     work->word2.s.IP_exc || work->word2.s.L4_error))
 					skb->ip_summed = CHECKSUM_NONE;
 				else
 					skb->ip_summed = CHECKSUM_UNNECESSARY;
-- 
1.7.0

