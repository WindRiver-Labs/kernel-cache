From 3764703b1a7e5e04b1ec843759cba5cfd4c53265 Mon Sep 17 00:00:00 2001
From: Phil Staub <Phil.Staub@windriver.com>
Date: Thu, 29 Sep 2011 11:57:14 -0700
Subject: [PATCH 096/238] MIPS: Restore missing iPTE_LW macro

The hugetlbfs TLB refill path is missing a step to restore the PTE in
build_r4000_tlb_load_handler. One end result of this is that a
hugetlbfs page attached in read-only mode will be inaccessible
(generates a segfault).

Signed-off-by: Phil Staub <Phil.Staub@windriver.com>
---
 arch/mips/mm/tlbex.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/arch/mips/mm/tlbex.c b/arch/mips/mm/tlbex.c
index 327c82d..a298e10 100644
--- a/arch/mips/mm/tlbex.c
+++ b/arch/mips/mm/tlbex.c
@@ -1971,6 +1971,8 @@ static void __cpuinit build_r4000_tlb_load_handler(void)
 			uasm_i_andi(&p, wr.r3, wr.r3, 2);
 			uasm_il_beqz(&p, &r, wr.r3, label_tlbl_goaround2);
 		}
+		/* Reload the PTE value */
+		iPTE_LW(&p, wr.r1, wr.r2); 
 
 		/*
 		 * We clobbered C0_PAGEMASK, restore it.  On the other branch
-- 
1.7.0

