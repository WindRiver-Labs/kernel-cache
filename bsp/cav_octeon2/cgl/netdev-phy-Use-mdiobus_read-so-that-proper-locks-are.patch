From bd3ca8ba2ae08d9085162c93db7dc9d8ca184c08 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Mon, 4 Jun 2012 18:58:58 +0800
Subject: [PATCH 202/238] netdev/phy: Use mdiobus_read() so that proper locks are taken.

commit 6fe3264945ee63292cdfb27b6e95bc52c603bb09 upstream.

Accesses to the mdio busses must be done with the mdio_lock to ensure
proper operation.  Conveniently we have the helper function
mdiobus_read() to do that for us.  Lets use it in get_phy_id() instead
of accessing the bus without the lock held.

Signed-off-by: David Daney <david.daney@cavium.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Integrated-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/net/phy/phy_device.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/net/phy/phy_device.c b/drivers/net/phy/phy_device.c
index 8b94e81..9fd9863 100644
--- a/drivers/net/phy/phy_device.c
+++ b/drivers/net/phy/phy_device.c
@@ -202,7 +202,7 @@ int get_phy_id(struct mii_bus *bus, int addr, u32 *phy_id)
 	for (i = 1; i < 5; i++) {
 		/* Grab the bits from PHYIR1, and put them
 		 * in the upper half */
-		phy_reg = bus->read(bus, addr, i, MII_PHYSID1);
+		phy_reg = mdiobus_read(bus, addr, i, MII_PHYSID1);
 
 		if (phy_reg < 0)
 			return -EIO;
@@ -210,7 +210,7 @@ int get_phy_id(struct mii_bus *bus, int addr, u32 *phy_id)
 		*phy_id = (phy_reg & 0xffff) << 16;
 
 		/* Grab the bits from PHYIR2, and put them in the lower half */
-		phy_reg = bus->read(bus, addr, i, MII_PHYSID2);
+		phy_reg = mdiobus_read(bus, addr, i, MII_PHYSID2);
 
 		if (phy_reg < 0)
 			return -EIO;
-- 
1.7.0

