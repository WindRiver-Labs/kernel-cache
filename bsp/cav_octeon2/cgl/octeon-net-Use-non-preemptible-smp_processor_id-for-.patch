From a39156d02b8f02e30083f4768a212224a8d83912 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Mon, 13 Feb 2012 09:08:02 -0800
Subject: [PATCH 172/238] octeon/net: Use non-preemptible smp_processor_id for enabling NAPI

When loading octeon-ethernet.ko, below bug is captured:

BUG: using smp_processor_id() in preemptible [00000000] code: modprobe/631
caller is cvm_oct_enable_napi+0x18/0x80 [octeon_ethernet]
Call Trace:
[<ffffffff8010ffe4>] dump_stack+0x8/0x34
[<ffffffff80589824>] debug_smp_processor_id+0xec/0x100
[<ffffffffc00d6cb0>] cvm_oct_enable_napi+0x18/0x80 [octeon_ethernet]
[<ffffffffc00e4970>] cvm_oct_init_module+0x8c8/0x94c [octeon_ethernet]
[<ffffffff80113d28>] do_one_initcall+0x38/0x180
[<ffffffff802c733c>] SyS_init_module+0xfc/0x230
[<ffffffff80103624>] handle_sysn32+0x44/0x84

So, change smp_processor_id to raw version.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 drivers/net/octeon/ethernet-rx.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/net/octeon/ethernet-rx.c b/drivers/net/octeon/ethernet-rx.c
index 301df69..33a4d5b 100644
--- a/drivers/net/octeon/ethernet-rx.c
+++ b/drivers/net/octeon/ethernet-rx.c
@@ -94,7 +94,7 @@ static int cvm_oct_enable_one_message;
 
 static void cvm_oct_enable_napi(void)
 {
-	int cpu = smp_processor_id();
+	int cpu = raw_smp_processor_id();
 
 	napi_schedule(&cvm_oct_napi[cpu].napi);
 }
-- 
1.7.0

