From 13adce86a43ab4ed95cd61c435e87fd48da2d651 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Mon, 13 Feb 2012 10:59:18 -0800
Subject: [PATCH 215/238] NET: octeon-ethernet: Make sure recycled transmit buffers are usable.

Source: Cavium SDK 2.3-427

If we are recycling transmit SKBs back into the FPA, they must be big
enough. We need to account for the padding added for the SKB back
pointer too.

Signed-off-by: David Daney <david.daney@cavium.com>
Integrated-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/net/octeon/ethernet-tx.c   |    2 +-
 drivers/net/octeon/ethernet-xmit.c |    2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/net/octeon/ethernet-tx.c b/drivers/net/octeon/ethernet-tx.c
index 117b263..415e6ef 100644
--- a/drivers/net/octeon/ethernet-tx.c
+++ b/drivers/net/octeon/ethernet-tx.c
@@ -78,7 +78,7 @@ static bool cvm_oct_skb_ok_for_reuse(struct sk_buff *skb)
 	if (unlikely(skb->data < fpa_head))
 		return false;
 
-	if (unlikely((skb_end_pointer(skb) - fpa_head) < CVMX_FPA_PACKET_POOL_SIZE))
+	if (unlikely((skb_end_pointer(skb) - fpa_head) < (CVMX_FPA_PACKET_POOL_SIZE + CVM_OCT_SKB_TO_FPA_PADDING)))
 		return false;
 	return true;
 }
diff --git a/drivers/net/octeon/ethernet-xmit.c b/drivers/net/octeon/ethernet-xmit.c
index 55c86e1..230a57e 100644
--- a/drivers/net/octeon/ethernet-xmit.c
+++ b/drivers/net/octeon/ethernet-xmit.c
@@ -247,7 +247,7 @@ CVM_OCT_XMIT
 		 */
 		goto dont_put_skbuff_in_hw;
 	}
-	if (unlikely(skb_cloned(skb))) {
+	if (unlikely(skb_cloned(skb) || skb->fclone != SKB_FCLONE_UNAVAILABLE)) {
 		/*
 		   printk("TX buffer has been cloned\n");
 		 */
-- 
1.7.0

