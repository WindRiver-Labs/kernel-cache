From 6d7f8d0ce5c29781408ff2559881e5dacf3e49c3 Mon Sep 17 00:00:00 2001
From: Jiang Bin <bin.jiang@windriver.com>
Date: Wed, 2 May 2012 18:13:06 +0800
Subject: [PATCH 224/238] i2c: i2c-octeon: Add CGL support by adding IRQ_NODELAY to IRQ flags

The i2c irq handler does not function correctly when handled in threads. Add
IRQF_NODELAY to prevent threading.

Signed-off-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/i2c/busses/i2c-octeon.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/i2c/busses/i2c-octeon.c b/drivers/i2c/busses/i2c-octeon.c
index 5c397b0..c87b4e2 100644
--- a/drivers/i2c/busses/i2c-octeon.c
+++ b/drivers/i2c/busses/i2c-octeon.c
@@ -960,8 +960,13 @@ static int __devinit octeon_i2c_probe(struct platform_device *pdev)
 
 	i2c->irq = irq;
 
+#ifdef  CONFIG_PREEMPT_HARDIRQS
+	result = devm_request_irq(&pdev->dev, i2c->irq,
+				  octeon_i2c_isr, IRQF_NODELAY, DRV_NAME, i2c);
+#else
 	result = devm_request_irq(&pdev->dev, i2c->irq,
 				  octeon_i2c_isr, 0, DRV_NAME, i2c);
+#endif
 	if (result < 0) {
 		dev_err(i2c->dev, "failed to attach interrupt\n");
 		goto out;
-- 
1.7.0

