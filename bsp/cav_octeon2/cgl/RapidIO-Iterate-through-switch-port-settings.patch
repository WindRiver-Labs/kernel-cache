From 2b61661fd4aeee29acec58437218acc4c7922522 Mon Sep 17 00:00:00 2001
From: Chad Reese <kreese@caviumnetworks.com>
Date: Thu, 2 Dec 2010 07:45:50 -0800
Subject: [PATCH 040/238] RapidIO: Iterate through switch port settings

Source: Cavium SDK 2.1.0-407

Based on work submitted upstream as commit

a3725c45c114bd06e091802f90533332d1e93819

Incorporate changes from IDT to program setting on all switch ports.
Some minor changes were made to IDT's code to fix compile issues.

Signed-off-by: Phil Staub <Phil.Staub@windriver.com>
---
 drivers/rapidio/switches/idt_gen2.c |   36 ++++++++++++++++++++++------------
 1 files changed, 23 insertions(+), 13 deletions(-)

diff --git a/drivers/rapidio/switches/idt_gen2.c b/drivers/rapidio/switches/idt_gen2.c
index 7192659..d471f89 100644
--- a/drivers/rapidio/switches/idt_gen2.c
+++ b/drivers/rapidio/switches/idt_gen2.c
@@ -108,6 +108,7 @@ idtg2_route_add_entry(struct rio_mport *mport, u16 destid, u8 hopcount,
 	rio_mport_write_config_32(mport, destid, hopcount,
 				  RIO_STD_RTE_CONF_PORT_SEL_CSR,
 				  (u32)route_port);
+	udelay(10);
 
 	return 0;
 }
@@ -213,6 +214,7 @@ idtg2_em_init(struct rio_dev *rdev)
 	u16 destid = rdev->rswitch->destid;
 	u8 hopcount = rdev->rswitch->hopcount;
 	u32 regval;
+	int i, tmp;
 
 	/*
 	 * This routine performs device-specific initialization only.
@@ -252,18 +254,21 @@ idtg2_em_init(struct rio_dev *rdev)
 	rio_mport_write_config_32(mport, destid, hopcount,
 			IDT_PORT_ERR_REPORT_EN_BC, 0x807e8037);
 
-	/* Configure repoting of implementation specific errors/events */
+	/* Configure reporting of implementation specific errors/events */
 	rio_mport_write_config_32(mport, destid, hopcount,
 			IDT_PORT_ISERR_REPORT_EN_BC, IDT_PORT_INIT_TX_ACQUIRED);
 
 	/* Use Port-Writes for port error reporting and enable error logging */
-	rio_mport_read_config_32(mport, destid, hopcount,
-			IDT_PORT_OPS_BC, &regval);
-	rio_mport_write_config_32(mport, destid, hopcount,
-			IDT_PORT_OPS_BC, regval | IDT_PORT_OPS_GENPW |
-			IDT_PORT_OPS_PL_ELOG |
-			IDT_PORT_OPS_LL_ELOG |
-			IDT_PORT_OPS_LT_ELOG);
+	tmp = (rdev->did == RIO_DID_IDTCPS1848) ? 48 : 16;
+	for (i = 0; i < rdev->rswitch->nports; i++) {
+		rio_mport_read_config_32(mport, destid, hopcount,
+				IDT_PORT_OPS(i), &regval);
+		rio_mport_write_config_32(mport, destid, hopcount,
+				IDT_PORT_OPS(i), regval | IDT_PORT_OPS_GENPW |
+				IDT_PORT_OPS_PL_ELOG |
+				IDT_PORT_OPS_LL_ELOG |
+				IDT_PORT_OPS_LT_ELOG);
+	}
 	/* Overwrite error log if full */
 	rio_mport_write_config_32(mport, destid, hopcount,
 			IDT_ERR_CAP, IDT_ERR_CAP_LOG_OVERWR);
@@ -276,11 +281,16 @@ idtg2_em_init(struct rio_dev *rdev)
 	rio_mport_write_config_32(mport, destid, hopcount,
 			IDT_LANE_ERR_REPORT_EN_BC, 0);
 
-	/* Use Port-Writes for lane error reporting (when enabled) */
-	rio_mport_read_config_32(mport, destid, hopcount,
-			IDT_LANE_CTRL_BC, &regval);
-	rio_mport_write_config_32(mport, destid, hopcount,
-			IDT_LANE_CTRL_BC, regval | IDT_LANE_CTRL_GENPW);
+	/* Use Port-Writes for lane error reporting (when enabled)
+	 * (do per-lane update because lanes may have different configuration)
+	 */
+	tmp = (rdev->did == RIO_DID_IDTCPS1848) ? 48 : 16;
+	for (i = 0; i < tmp; i++) {
+		rio_mport_read_config_32(mport, destid, hopcount,
+				IDT_LANE_CTRL(i), &regval);
+		rio_mport_write_config_32(mport, destid, hopcount,
+				IDT_LANE_CTRL(i), regval | IDT_LANE_CTRL_GENPW);
+	}
 
 	/*
 	 * Configure AUX error reporting.
-- 
1.7.0

