From 0bd14a2d0b2ebfce15f0d062d9f670fa9afe5810 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 23 Sep 2011 15:23:43 -0700
Subject: [PATCH 204/238] NET: octeon-ethernet: Don't call netif_carrier_{on,off} if the phy driver already did it.

Source: Cavium SDK 2.3-427

Signed-off-by: David Daney <david.daney@cavium.com>
Integrated-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/net/octeon/ethernet-mdio.c |   34 ++++++++++++++++++++++------------
 1 files changed, 22 insertions(+), 12 deletions(-)

diff --git a/drivers/net/octeon/ethernet-mdio.c b/drivers/net/octeon/ethernet-mdio.c
index d183024..59bd8f4 100644
--- a/drivers/net/octeon/ethernet-mdio.c
+++ b/drivers/net/octeon/ethernet-mdio.c
@@ -337,17 +337,10 @@ int cvm_oct_ioctl(struct net_device *dev, struct ifreq *rq, int cmd)
 	}
 }
 
-/**
- * cvm_oct_set_carrier - common wrapper of netif_carrier_{on,off}
- *
- * @priv: Device struct.
- * @link_info: Current state.
- */
-void cvm_oct_set_carrier(struct octeon_ethernet *priv, cvmx_helper_link_info_t link_info)
+
+static void cvm_oct_note_carrier(struct octeon_ethernet *priv, cvmx_helper_link_info_t link_info)
 {
 	if (link_info.s.link_up) {
-		if (!netif_carrier_ok(priv->netdev))
-			netif_carrier_on(priv->netdev);
 		if (priv->num_tx_queues)
 			DEBUGPRINT("%s: %u Mbps %s duplex, port %2d, queue %2d\n",
 				   priv->netdev->name, link_info.s.speed,
@@ -359,9 +352,25 @@ void cvm_oct_set_carrier(struct octeon_ethernet *priv, cvmx_helper_link_info_t l
 				   (link_info.s.full_duplex) ? "Full" : "Half",
 				   priv->ipd_port);
 	} else {
+		DEBUGPRINT("%s: Link down\n", priv->netdev->name);
+	}
+}
+
+/**
+ * cvm_oct_set_carrier - common wrapper of netif_carrier_{on,off}
+ *
+ * @priv: Device struct.
+ * @link_info: Current state.
+ */
+void cvm_oct_set_carrier(struct octeon_ethernet *priv, cvmx_helper_link_info_t link_info)
+{
+	cvm_oct_note_carrier(priv, link_info);
+	if (link_info.s.link_up) {
+		if (!netif_carrier_ok(priv->netdev))
+			netif_carrier_on(priv->netdev);
+	} else {
 		if (netif_carrier_ok(priv->netdev))
 			netif_carrier_off(priv->netdev);
-		DEBUGPRINT("%s: Link down\n", priv->netdev->name);
 	}
 }
 
@@ -376,12 +385,13 @@ static void cvm_oct_adjust_link(struct net_device *dev)
 		link_info.s.link_up = priv->last_link ? 1 : 0;
 		link_info.s.full_duplex = priv->phydev->duplex ? 1 : 0;
 		link_info.s.speed = priv->phydev->speed;
+
+		cvm_oct_note_carrier(priv, link_info);
+
 		cvmx_helper_link_set(priv->ipd_port, link_info);
-		cvm_oct_set_carrier(priv, link_info);
 	}
 }
 
-
 /**
  * cvm_oct_phy_setup_device - setup the PHY
  *
-- 
1.7.0

