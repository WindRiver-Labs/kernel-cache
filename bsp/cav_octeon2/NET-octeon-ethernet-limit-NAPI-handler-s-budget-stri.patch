From 71142f29637c148b6c7ceb755cce2617535436af Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Thu, 28 Feb 2013 11:10:48 +0800
Subject: [PATCH] NET: octeon-ethernet limit NAPI handler's budget strictly

The budget means how many packages should be treated
intead of how many packages have been received.

Without this modification, in special cases, lots of useless received packages
will block system long time in NAPI handler.

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 drivers/net/octeon/ethernet-napi.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/net/octeon/ethernet-napi.c b/drivers/net/octeon/ethernet-napi.c
index db173ee..c80160f 100644
--- a/drivers/net/octeon/ethernet-napi.c
+++ b/drivers/net/octeon/ethernet-napi.c
@@ -137,6 +137,8 @@ static int CVM_OCT_NAPI_POLL(struct napi_struct *napi, int budget)
 				cvm_oct_enable_one_cpu();
 		}
 
+		rx_count++;
+
 		/*
 		 * If WORD2[SOFTWARE] then this WQE is a complete for
 		 * a TX packet.
@@ -392,7 +394,6 @@ static int CVM_OCT_NAPI_POLL(struct napi_struct *napi, int budget)
 					switch (callback_result) {
 					case CVM_OCT_PASS:
 						netif_receive_skb(skb);
-						rx_count++;
 						break;
 					case CVM_OCT_DROP:
 						dev_kfree_skb_any(skb);
@@ -422,7 +423,6 @@ static int CVM_OCT_NAPI_POLL(struct napi_struct *napi, int budget)
 				} else {
 					netif_receive_skb(skb);
 					callback_result = CVM_OCT_PASS;
-					rx_count++;
 				}
 			} else {
 				/* Drop any packet received for a device that isn't up */
-- 
1.7.0

