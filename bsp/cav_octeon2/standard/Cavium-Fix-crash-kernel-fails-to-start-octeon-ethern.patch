From 6eec8d1fae4d56be8eb2efcf2fd03ffa38a99028 Mon Sep 17 00:00:00 2001
From: Jiang Bin <bin.jiang@windriver.com>
Date: Tue, 26 Jun 2012 14:52:31 +0800
Subject: [PATCH 232/236] Cavium: Fix crash kernel fails to start octeon ethernet.

crash kernel boots with "reset_devices" which requires to reset network
devices, otherwise octeon ethernet can't work.

Signed-off-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/net/octeon/Makefile   |    1 +
 drivers/net/octeon/ethernet.c |    4 ++--
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/net/octeon/Makefile b/drivers/net/octeon/Makefile
index f008731..729764f 100644
--- a/drivers/net/octeon/Makefile
+++ b/drivers/net/octeon/Makefile
@@ -16,6 +16,7 @@ obj-$(CONFIG_OCTEON_POW_ONLY_ETHERNET)	+= octeon-pow-ethernet.o
 
 obj-${CONFIG_OCTEON_ETHERNET} +=  octeon-ethernet.o
 obj-${CONFIG_KEXEC} +=  octeon-kexec-net.o
+obj-${CONFIG_CRASH_DUMP} +=  octeon-kexec-net.o
 
 octeon-ethernet-objs := ethernet.o
 octeon-ethernet-objs += ethernet-mdio.o
diff --git a/drivers/net/octeon/ethernet.c b/drivers/net/octeon/ethernet.c
index f3c601f..909705a 100644
--- a/drivers/net/octeon/ethernet.c
+++ b/drivers/net/octeon/ethernet.c
@@ -688,7 +688,7 @@ static void cvm_oct_override_pko_queue_priority(int pko_port, u64 priorities[16]
 	}
 }
 
-#ifdef CONFIG_KEXEC
+#if defined(CONFIG_KEXEC) || defined(CONFIG_CRASH_DUMP)
 extern void octeon_shutdown_network_hw(void);
 #endif
 
@@ -776,7 +776,7 @@ static int __init cvm_oct_init_module(void)
 	int i;
 	int rv = 0;
 
-#ifdef CONFIG_KEXEC
+#if defined(CONFIG_KEXEC) || defined(CONFIG_CRASH_DUMP)
 	if (reset_devices)
 		octeon_shutdown_network_hw();
 #endif
-- 
1.7.0

