From a8a76d95377471edf1abedda549317961244603e Mon Sep 17 00:00:00 2001
From: Chandrakala Chavva <cchavva@cavium.com>
Date: Fri, 17 Feb 2012 11:20:48 -0800
Subject: [PATCH 194/236] MIPS: Octeon: Fix MSI teardown for ebb6800p2.

Source: Cavium SDK 2.3-427

Free msi_irq_bitmask only if it is allocated while freeing MSI interrupt after
the interrupt is handled.

Signed-off-by: Chandrakala Chavva <cchavva@cavium.com>
Integrated-by: Jiang Bin <bin.jiang@windriver.com>
---
 arch/mips/pci/msi-octeon.c |    6 ++----
 1 files changed, 2 insertions(+), 4 deletions(-)

diff --git a/arch/mips/pci/msi-octeon.c b/arch/mips/pci/msi-octeon.c
index 6b232b5..3e7a91c 100644
--- a/arch/mips/pci/msi-octeon.c
+++ b/arch/mips/pci/msi-octeon.c
@@ -230,9 +230,6 @@ void arch_teardown_msi_irq(unsigned int irq)
 	int index = 0;
 	int irq0;
 
-	if (OCTEON_IS_MODEL(OCTEON_CN68XX) && !OCTEON_IS_MODEL(OCTEON_CN68XX_PASS1_X))
-		return;
-
 	if ((irq < OCTEON_IRQ_MSI_BIT0)
 		|| (irq > msi_irq_size + OCTEON_IRQ_MSI_BIT0))
 		panic("arch_teardown_msi_irq: Attempted to teardown illegal "
@@ -257,7 +254,8 @@ void arch_teardown_msi_irq(unsigned int irq)
 	bitmask = (1 << number_irqs) - 1;
 	/* Shift the mask to the correct bit location */
 	bitmask <<= irq0;
-	if ((msi_free_irq_bitmask[index] & bitmask) != bitmask)
+	if (msi_free_irq_bitmask[index]
+	    && (msi_free_irq_bitmask[index] & bitmask) != bitmask)
 		panic("arch_teardown_msi_irq: Attempted to teardown MSI "
 		      "interrupt (%d) not in use", irq);
 
-- 
1.7.0

