From bdacf818a9707a0712da8dfe785a22c81a5e84a2 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Fri, 7 Oct 2011 12:01:19 -0700
Subject: [PATCH 203/236] NET: octeon-ethernet: Report some ethtool information for ports without PHYs.

Source: Cavium SDK 2.3-427

For ports with no connected PHY driver, we can still report some
minimal information about the link.  Do that instead of returning
-EINVAL.

Signed-off-by: David Daney <david.daney@cavium.com>
Integrated-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/net/octeon/ethernet-mdio.c |   11 ++++++++---
 1 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/drivers/net/octeon/ethernet-mdio.c b/drivers/net/octeon/ethernet-mdio.c
index 59bd8f4..665614d 100644
--- a/drivers/net/octeon/ethernet-mdio.c
+++ b/drivers/net/octeon/ethernet-mdio.c
@@ -57,12 +57,17 @@ static void cvm_oct_get_drvinfo(struct net_device *dev,
 
 static int cvm_oct_get_settings(struct net_device *dev, struct ethtool_cmd *cmd)
 {
+	cvmx_helper_link_info_t link_info;
 	struct octeon_ethernet *priv = netdev_priv(dev);
 
 	if (priv->phydev)
 		return phy_ethtool_gset(priv->phydev, cmd);
 
-	return -EINVAL;
+	link_info = cvmx_helper_link_get(priv->ipd_port);
+	cmd->speed = link_info.s.link_up ? link_info.s.speed : 0;
+	cmd->duplex = link_info.s.full_duplex ? DUPLEX_FULL : DUPLEX_HALF;
+
+	return 0;
 }
 
 static int cvm_oct_set_settings(struct net_device *dev, struct ethtool_cmd *cmd)
@@ -75,7 +80,7 @@ static int cvm_oct_set_settings(struct net_device *dev, struct ethtool_cmd *cmd)
 	if (priv->phydev)
 		return phy_ethtool_sset(priv->phydev, cmd);
 
-	return -EINVAL;
+	return -EOPNOTSUPP;
 }
 
 static int cvm_oct_nway_reset(struct net_device *dev)
@@ -88,7 +93,7 @@ static int cvm_oct_nway_reset(struct net_device *dev)
 	if (priv->phydev)
 		return phy_start_aneg(priv->phydev);
 
-	return -EINVAL;
+	return -EOPNOTSUPP;
 }
 
 const struct ethtool_ops cvm_oct_ethtool_ops = {
-- 
1.7.0

