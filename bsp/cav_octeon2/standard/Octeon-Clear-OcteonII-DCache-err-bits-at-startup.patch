From 18079813f3baaa5d78d729bead7cb06d5fee4073 Mon Sep 17 00:00:00 2001
From: Phil Staub <Phil.Staub@windriver.com>
Date: Thu, 16 Jun 2011 16:15:26 -0700
Subject: [PATCH 081/236] Octeon: Clear OcteonII DCache err bits at startup

Source: Cavium SDK 2.1.0-407

For OcteonII, we'll read the CP0 DCACHE_ERR_REG and make sure the
error bits are clear at boot time.

Signed-off-by: Phil Staub <Phil.Staub@windriver.com>
---
 .../asm/mach-cavium-octeon/kernel-entry-init.h     |   15 +++++++++------
 1 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h b/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h
index b529dea..29ec353 100644
--- a/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h
+++ b/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h
@@ -11,12 +11,12 @@
 #ifdef CONFIG_WRHV
 #include <wrhv-kernel-entry-init.h>
 #else
-#define CP0_CYCLE_COUNTER $9, 6
 #define CP0_CVMCTL_REG $9, 7
 #define CP0_CVMMEMCTL_REG $11,7
 #define CP0_PRID_REG $15, 0
 #define CP0_PRID_OCTEON_PASS1 0x000d0000
 #define CP0_PRID_OCTEON_CN30XX 0x000d0200
+#define CP0_DCACHE_ERR_REG $27, 1
 
 .macro  kernel_entry_setup
 	# Registers set by bootloader:
@@ -158,11 +158,17 @@ skip:
 1:	dsubu	v0, 8
 	sd	$0, -32768(v0)
 	bnez	v0, 1b
-2:	# Get my core id
+2:
+	mfc0	v0, CP0_PRID_REG
+	bbit0	v0, 15, 1f
+	# OCTEON II or better have bit 15 set.  Clear the error bits.
+	dli	v0, 0x27
+	dmtc0	v0, CP0_DCACHE_ERR_REG
+1:
+	# Get my core id
 	rdhwr   v0, $0
 	# Jump the master to kernel_entry
 	bne     a2, zero, octeon_main_processor
-	nop
 
 #ifdef CONFIG_SMP
 
@@ -178,7 +184,6 @@ octeon_spin_wait_boot:
 	LONG_L  t1, (t0)
 	# Keep looping if it isn't me
 	bne t1, v0, octeon_spin_wait_boot
-	nop
 	# Get my GP from the global variable
 	PTR_LA  t0, octeon_processor_gp
 	LONG_L  gp, (t0)
@@ -195,7 +200,6 @@ octeon_spin_wait_boot:
 #endif
 	# Jump to the normal Linux SMP entry point
 	j   smp_bootstrap
-	nop
 #else /* CONFIG_SMP */
 
 	#
@@ -205,7 +209,6 @@ octeon_spin_wait_boot:
 octeon_wait_forever:
 	wait
 	b   octeon_wait_forever
-	nop
 
 #endif /* CONFIG_SMP */
 octeon_main_processor:
-- 
1.7.0

