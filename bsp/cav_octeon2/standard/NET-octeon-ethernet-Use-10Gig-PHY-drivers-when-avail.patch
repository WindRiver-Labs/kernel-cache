From f9a05d60dffbc5ccdd240a832716367b82370879 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 27 Oct 2011 11:37:04 -0700
Subject: [PATCH 206/236] NET: octeon-ethernet: Use 10Gig PHY drivers when available.

Source: Cavium SDK 2.3-427

If the device tree says there is a PHY attached to a XAUI port, try to
use it.

Signed-off-by: David Daney <david.daney@cavium.com>
Integrated-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/net/octeon/ethernet-mdio.c |   19 +++++++++++++------
 1 files changed, 13 insertions(+), 6 deletions(-)

diff --git a/drivers/net/octeon/ethernet-mdio.c b/drivers/net/octeon/ethernet-mdio.c
index 665614d..11c1410 100644
--- a/drivers/net/octeon/ethernet-mdio.c
+++ b/drivers/net/octeon/ethernet-mdio.c
@@ -408,22 +408,29 @@ int cvm_oct_phy_setup_device(struct net_device *dev)
 {
 	struct octeon_ethernet *priv = netdev_priv(dev);
 	struct device_node *phy_node;
+	int ret = 0;
 
-	if (!priv->of_node || priv->imode == CVMX_HELPER_INTERFACE_MODE_XAUI)
+	if (!priv->of_node)
 		return 0;
 
 	phy_node = of_parse_phandle(priv->of_node, "phy-handle", 0);
 	if (!phy_node)
 		return 0;
 
-	priv->phydev = of_phy_connect(dev, phy_node, cvm_oct_adjust_link, 0,
-				      PHY_INTERFACE_MODE_GMII);
-
+	priv->phydev = of_phy_find_device(phy_node);
 	if (priv->phydev == NULL)
 		return -ENODEV;
 
+	ret = phy_connect_direct(dev, priv->phydev, cvm_oct_adjust_link,
+				 0, PHY_INTERFACE_MODE_GMII);
+
+	if (ret) {
+		priv->phydev = NULL;
+		goto err;
+	}
+
 	priv->last_link = 0;
 	phy_start_aneg(priv->phydev);
-
-	return 0;
+err:
+	return ret;
 }
-- 
1.7.0

