From 4b63f88d76a742fac6c796f419666da402c2d2ad Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Fri, 11 Nov 2011 11:33:59 -0800
Subject: [PATCH 132/236] netdev/of/phy: New function: of_mdio_find_bus()

Source: Cavium SDK 2.2-414

Add of_mdio_find_bus() which allows an mii_bus to be located given its
associated the device tree node.

This is needed by the follow-on patch to add a driver for MDIO bus
multiplexers.

The of_mdiobus_register() function is modified so that the device tree
node is recorded in the mii_bus.  Then we can find it again by
iterating over all mdio_bus_class devices.

Signed-off-by: David Daney <david.daney@cavium.com>
Cc: Grant Likely <grant.likely@secretlab.ca>
Cc: "David S. Miller" <davem@davemloft.net>

Integrated-by: Yang Shi <yang.shi@windriver.com>
---
 drivers/net/phy/mdio_bus.c |    3 ++-
 include/linux/of_mdio.h    |    2 ++
 include/linux/phy.h        |    1 +
 3 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/drivers/net/phy/mdio_bus.c b/drivers/net/phy/mdio_bus.c
index 5c7df03..a544ae9 100644
--- a/drivers/net/phy/mdio_bus.c
+++ b/drivers/net/phy/mdio_bus.c
@@ -70,10 +70,11 @@ static void mdiobus_release(struct device *d)
 	kfree(bus);
 }
 
-static struct class mdio_bus_class = {
+struct class mdio_bus_class = {
 	.name		= "mdio_bus",
 	.dev_release	= mdiobus_release,
 };
+EXPORT_SYMBOL(mdio_bus_class);
 
 /**
  * mdiobus_register - bring up all the PHYs on a given bus and attach them to bus
diff --git a/include/linux/of_mdio.h b/include/linux/of_mdio.h
index 514fef4..4ed53ef 100644
--- a/include/linux/of_mdio.h
+++ b/include/linux/of_mdio.h
@@ -25,4 +25,6 @@ extern struct phy_device *of_phy_attach(struct net_device *dev,
 				struct device_node *phy_np, u32 flags,
 				phy_interface_t iface);
 
+extern struct mii_bus *of_mdio_find_bus(struct device_node *mdio_np);
+
 #endif /* __LINUX_OF_MDIO_H */
diff --git a/include/linux/phy.h b/include/linux/phy.h
index 7e0550f..c95994c 100644
--- a/include/linux/phy.h
+++ b/include/linux/phy.h
@@ -548,4 +548,5 @@ int __init mdio_bus_init(void);
 void mdio_bus_exit(void);
 
 extern struct bus_type mdio_bus_type;
+extern struct class mdio_bus_class;
 #endif /* __PHY_H */
-- 
1.7.0

