From e7af008af782b38a546335329209b2f16e256838 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 23 Nov 2011 10:37:02 -0800
Subject: [PATCH 207/236] NET: octeon-ethernet: Handle large MTUs

Source: Cavium SDK 2.3-427

For some chips, we were setting PIP_FRM_LEN_CHKX[MAXLEN]. This is
incorrect as that affects all ports instead of a single port.  Turn
off the use of PIP_FRM_LEN_CHKX[MAXLEN] and rely on GMXX_RXX_JABBER
instead.

Signed-off-by: David Daney <david.daney@cavium.com>
Integrated-by: Jiang Bin <bin.jiang@windriver.com>
---
 drivers/net/octeon/ethernet.c |   25 ++++++++++++++++---------
 1 files changed, 16 insertions(+), 9 deletions(-)

diff --git a/drivers/net/octeon/ethernet.c b/drivers/net/octeon/ethernet.c
index 2419d94..531bbe0 100644
--- a/drivers/net/octeon/ethernet.c
+++ b/drivers/net/octeon/ethernet.c
@@ -332,15 +332,22 @@ static int cvm_oct_common_change_mtu(struct net_device *dev, int new_mtu)
 			cvmx_write_csr(CVMX_GMXX_RXX_FRM_MAX(priv->interface_port, priv->interface),
 				       max_packet);
 		} else {
-			/*
-			 * Set the hardware to truncate packets larger
-			 * than the MTU and smaller the 64 bytes.
-			 */
-			union cvmx_pip_frm_len_chkx frm_len_chk;
-			frm_len_chk.u64 = 0;
-			frm_len_chk.s.minlen = 64;
-			frm_len_chk.s.maxlen = max_packet;
-			cvmx_write_csr(CVMX_PIP_FRM_LEN_CHKX(priv->interface), frm_len_chk.u64);
+			union cvmx_pip_prt_cfgx port_cfg;
+			int offset = octeon_has_feature(OCTEON_FEATURE_PKND) ?
+				cvmx_helper_get_pknd(priv->interface, priv->interface_port) :
+				cvmx_helper_get_ipd_port(priv->interface, priv->interface_port);
+
+			port_cfg.u64 = cvmx_read_csr(CVMX_PIP_PRT_CFGX(offset));
+			if (port_cfg.s.maxerr_en) {
+				/*
+				 * Disable the PIP check as it can
+				 * only be controlled over a group of
+				 * ports, let the check be done in the
+				 * GMX instead.
+				 */
+				port_cfg.s.maxerr_en = 0;
+				cvmx_write_csr(CVMX_PIP_PRT_CFGX(offset), port_cfg.u64);
+			}
 		}
 		/*
 		 * Set the hardware to truncate packets larger than
-- 
1.7.0

