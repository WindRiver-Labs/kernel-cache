From 3b8181bcf0ed200dd1cac341c281e29ead26fdb1 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Thu, 10 Nov 2011 13:46:29 -0800
Subject: [PATCH 103/236] i2c: i2c-octeon: Retry more situations where arbitration is lost

Source: Cavium SDK 2.2-414

Also enable the High Level Controller if needed.

Signed-off-by: David Daney <david.daney@cavium.com>
Integrated-by: Yang Shi <yang.shi@windriver.com>
---
 drivers/i2c/busses/i2c-octeon.c |  101 ++++++++++++++++++++++++++++++++-------
 1 files changed, 84 insertions(+), 17 deletions(-)

diff --git a/drivers/i2c/busses/i2c-octeon.c b/drivers/i2c/busses/i2c-octeon.c
index 8822e0c..cb08926 100644
--- a/drivers/i2c/busses/i2c-octeon.c
+++ b/drivers/i2c/busses/i2c-octeon.c
@@ -82,6 +82,7 @@ struct octeon_i2c {
 	resource_size_t regsize;
 	struct device *dev;
 	int broken_irq_mode;
+	bool octeon_i2c_hlc_enabled;
 };
 
 /**
@@ -256,6 +257,44 @@ static int octeon_i2c_wait(struct octeon_i2c *i2c)
 	return 0;
 }
 
+static int octeon_i2c_enable_hlc(struct octeon_i2c *i2c)
+{
+	if (i2c->octeon_i2c_hlc_enabled)
+		return 0;
+
+	octeon_i2c_write_sw(i2c, SW_TWSI_EOP_TWSI_CTL,
+			    TWSI_CTL_CE | TWSI_CTL_ENAB);
+
+	i2c->octeon_i2c_hlc_enabled = true;
+	return 0;
+}
+
+static bool octeon_i2c_lost_arb(u64 code)
+{
+	switch (code & 0xffull) {
+	/* Arbitration lost in address or data byte */
+	case 0x38:
+	/*
+	 * Arbitration lost in address as master, slave address +
+	 * write bit received, ACK transmitted.
+	 */
+	case 0x68:
+	/*
+	 * Arbitration lost in address as master, general call address
+	 * received, ACK transmitted.
+	 */
+	case 0x78:
+	/*
+	 * Arbitration lost in address as master, slave address + read
+	 * bit received, ACK transmitted.
+	 */
+	case 0xb0:
+		return true;
+	default:
+		return false;
+	}
+}
+
 /**
  * octeon_i2c_start - send START to the bus.
  * @i2c: The struct octeon_i2c.
@@ -267,6 +306,8 @@ static int octeon_i2c_start(struct octeon_i2c *i2c)
 	u8 data;
 	int result;
 
+	i2c->octeon_i2c_hlc_enabled = false;
+
 	octeon_i2c_write_sw(i2c, SW_TWSI_EOP_TWSI_CTL,
 				TWSI_CTL_ENAB | TWSI_CTL_STA);
 
@@ -325,13 +366,14 @@ static int octeon_i2c_stop(struct octeon_i2c *i2c)
  * @target: Target address.
  * @data: Pointer to the data to be sent.
  * @length: Length of the data.
+ * @phase: which phase of a combined operation.
  *
  * The address is sent over the bus, then the data.
  *
  * Returns 0 on success, otherwise a negative errno.
  */
 static int octeon_i2c_write(struct octeon_i2c *i2c, int target,
-			    const u8 *data, int length)
+			    const u8 *data, int length, int phase)
 {
 	int i, result;
 	u8 tmp;
@@ -344,12 +386,16 @@ static int octeon_i2c_write(struct octeon_i2c *i2c, int target,
 	octeon_i2c_write_sw(i2c, SW_TWSI_EOP_TWSI_DATA, target << 1);
 	octeon_i2c_write_sw(i2c, SW_TWSI_EOP_TWSI_CTL, TWSI_CTL_ENAB);
 
+restart:
 	result = octeon_i2c_wait(i2c);
 	if (result)
 		return result;
 
 	for (i = 0; i < length; i++) {
 		tmp = octeon_i2c_read_sw(i2c, SW_TWSI_EOP_TWSI_STAT);
+		if (phase == 0 && octeon_i2c_lost_arb(tmp))
+			goto restart;
+
 		if ((tmp != STAT_TXADDR_ACK) && (tmp != STAT_TXDATA_ACK)) {
 			dev_err(i2c->dev,
 				"%s: bad status before write (0x%x)\n",
@@ -374,13 +420,14 @@ static int octeon_i2c_write(struct octeon_i2c *i2c, int target,
  * @target: Target address.
  * @data: Pointer to the location to store the datae .
  * @length: Length of the data.
+ * @phase: which phase of a combined operation.
  *
  * The address is sent over the bus, then the data is read.
  *
  * Returns 0 on success, otherwise a negative errno.
  */
 static int octeon_i2c_read(struct octeon_i2c *i2c, int target,
-			   u8 *data, int length)
+			   u8 *data, int length, int phase)
 {
 	int i, result;
 	u8 tmp;
@@ -388,6 +435,7 @@ static int octeon_i2c_read(struct octeon_i2c *i2c, int target,
 	if (length < 1)
 		return -EINVAL;
 
+restart:
 	result = octeon_i2c_start(i2c);
 	if (result)
 		return result;
@@ -401,6 +449,9 @@ static int octeon_i2c_read(struct octeon_i2c *i2c, int target,
 
 	for (i = 0; i < length; i++) {
 		tmp = octeon_i2c_read_sw(i2c, SW_TWSI_EOP_TWSI_STAT);
+		if (phase == 0 && octeon_i2c_lost_arb(tmp))
+			goto restart;
+
 		if ((tmp != STAT_RXDATA_ACK) && (tmp != STAT_RXADDR_ACK)) {
 			dev_err(i2c->dev,
 				"%s: bad status before read (0x%x)\n",
@@ -496,6 +547,7 @@ static int octeon_i2c_simple_read(struct octeon_i2c *i2c, struct i2c_msg *msgs)
 	int i, j;
 	int ret = 0;
 
+	octeon_i2c_enable_hlc(i2c);
 retry:
 	cmd = SW_TWSI_V | SW_TWSI_R | SW_TWSI_SOVR;
 	/* SIZE */
@@ -519,17 +571,10 @@ retry:
 	cmd = __raw_readq(i2c->twsi_base + SW_TWSI);
 
 	if ((cmd & SW_TWSI_R) == 0) {
-		switch (cmd & 0xff) {
-		case 0x38:
-		case 0x68:
-		case 0x78:
-		case 0xb0:
-			/* Lost arbitration */
+		if (octeon_i2c_lost_arb(cmd))
 			goto retry;
-		default:
-			ret = -EIO;
-			goto err;
-		}
+		ret = -EIO;
+		goto err;
 	}
 
 	for (i = 0, j = msgs[0].len - 1; i  < msgs[0].len && i < 4; i++, j--)
@@ -551,6 +596,9 @@ static int octeon_i2c_simple_write(struct octeon_i2c *i2c, struct i2c_msg *msgs)
 	int i, j;
 	int ret = 0;
 
+	octeon_i2c_enable_hlc(i2c);
+
+retry:
 	cmd = SW_TWSI_V | SW_TWSI_SOVR;
 	/* SIZE */
 	cmd |= (u64)(msgs[0].len - 1) << SW_TWSI_SIZE_SHIFT;
@@ -582,8 +630,13 @@ static int octeon_i2c_simple_write(struct octeon_i2c *i2c, struct i2c_msg *msgs)
 
 	cmd = __raw_readq(i2c->twsi_base + SW_TWSI);
 
-	if ((cmd & SW_TWSI_R) == 0)
+	if ((cmd & SW_TWSI_R) == 0) {
+		if (octeon_i2c_lost_arb(cmd))
+			goto retry;
 		ret = -EIO;
+		goto err;
+	}
+
 err:
 	return ret;
 }
@@ -594,6 +647,9 @@ static int octeon_i2c_ia_read(struct octeon_i2c *i2c, struct i2c_msg *msgs)
 	int i, j;
 	int ret = 0;
 
+	octeon_i2c_enable_hlc(i2c);
+
+retry:
 	cmd = SW_TWSI_V | SW_TWSI_R | SW_TWSI_SOVR;
 	/* SIZE */
 	cmd |= (u64)(msgs[1].len - 1) << SW_TWSI_SIZE_SHIFT;
@@ -625,8 +681,12 @@ static int octeon_i2c_ia_read(struct octeon_i2c *i2c, struct i2c_msg *msgs)
 
 	cmd = __raw_readq(i2c->twsi_base + SW_TWSI);
 
-	if ((cmd & SW_TWSI_R) == 0)
+	if ((cmd & SW_TWSI_R) == 0) {
+		if (octeon_i2c_lost_arb(cmd))
+			goto retry;
 		ret = -EIO;
+		goto err;
+	}
 
 	for (i = 0, j = msgs[1].len - 1; i  < msgs[1].len && i < 4; i++, j--)
 		msgs[1].buf[j] = (cmd >> (8 * i)) & 0xff;
@@ -649,6 +709,9 @@ static int octeon_i2c_ia_write(struct octeon_i2c *i2c, struct i2c_msg *msgs)
 	u64 ext = 0;
 	bool set_ext = false;
 
+	octeon_i2c_enable_hlc(i2c);
+
+retry:
 	cmd = SW_TWSI_V | SW_TWSI_SOVR;
 	/* SIZE */
 	cmd |= (u64)(msgs[1].len - 1) << SW_TWSI_SIZE_SHIFT;
@@ -689,8 +752,12 @@ static int octeon_i2c_ia_write(struct octeon_i2c *i2c, struct i2c_msg *msgs)
 
 	cmd = __raw_readq(i2c->twsi_base + SW_TWSI);
 
-	if ((cmd & SW_TWSI_R) == 0)
+	if ((cmd & SW_TWSI_R) == 0) {
+		if (octeon_i2c_lost_arb(cmd))
+			goto retry;
 		ret = -EIO;
+		goto err;
+	}
 
 err:
 	return ret;
@@ -743,10 +810,10 @@ static int octeon_i2c_xfer(struct i2c_adapter *adap,
 			 pmsg->len, pmsg->addr, i + 1, num);
 		if (pmsg->flags & I2C_M_RD)
 			ret = octeon_i2c_read(i2c, pmsg->addr, pmsg->buf,
-						pmsg->len);
+					      pmsg->len, i);
 		else
 			ret = octeon_i2c_write(i2c, pmsg->addr, pmsg->buf,
-						pmsg->len);
+					       pmsg->len, i);
 	}
 	octeon_i2c_stop(i2c);
 out:
-- 
1.7.0

