From 0d6e8c9c2b87a054d660e6dc70e8f5d3dbc2de4c Mon Sep 17 00:00:00 2001
From: Phil Staub <Phil.Staub@windriver.com>
Date: Wed, 24 Aug 2011 12:36:12 -0700
Subject: [PATCH 001/236] MIPS: oprofile: Remove out of array bounds access

Only the first two enum values in the register_name enum defined in
arch/mips/oprofile/mips_context.h are valid for use in connection with
the op_context.gpregs array: BT_REG_LR is a valid index, and
BT_NUM_GPREGS is valid to describe the size of the array.

Remove the references in arch/mips/oprofile/backtrace.c to
child.gpregs[BT_REG_SP], as these are not needed and access elements
of the op_context structure that are beyond the end of the array.

Signed-off-by: Peder Andersen <Peder.Andersen@windriver.com>
Signed-off-by: Phil Staub <Phil.Staub@windriver.com>
---
 arch/mips/oprofile/backtrace.c |    2 --
 1 files changed, 0 insertions(+), 2 deletions(-)

diff --git a/arch/mips/oprofile/backtrace.c b/arch/mips/oprofile/backtrace.c
index 3512a7c..3b3d51a 100644
--- a/arch/mips/oprofile/backtrace.c
+++ b/arch/mips/oprofile/backtrace.c
@@ -125,7 +125,6 @@ void op_user_backtrace(struct pt_regs *const regs, unsigned int *depth)
 	unsigned long pc_sample;
 	child.pc = (void *)regs->cp0_epc;
 	child.sp = (void *)regs->regs[REG_SP];
-	child.gpregs[BT_REG_SP] = regs->regs[REG_SP];
 	child.gpregs[BT_REG_LR] = regs->regs[REG_RA];
 	/*  child could be a leaf, impacting frame_crawl */
 	child.leaf = true;
@@ -148,7 +147,6 @@ void op_user_backtrace(struct pt_regs *const regs, unsigned int *depth)
 		oprofile_add_trace(pc_sample);
 		child.pc = parent.pc;
 		child.sp = parent.sp;
-		child.gpregs[BT_REG_SP] = (unsigned long)parent.sp;
 		child.leaf = 0;
 		have_gprs = 0;
 		if (pc_sample == BACKTRACE_ABORTED)
-- 
1.7.0

