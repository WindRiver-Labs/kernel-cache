From 0459615e6dd466cdf1678d6484f057625667ff83 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Thu, 1 Dec 2011 16:39:54 -0800
Subject: [PATCH 1/3] MIPS: Octeon: Implement the core-16057 workaround

Source: SDK.2.3.0-427

Disable ICache prefetch for certian Octeon II processors.

Signed-off-by: David Daney <david.daney@cavium.com>
Integrated-by: Yong Zhang <yong.zhang@windriver.com>
---
 .../asm/mach-cavium-octeon/kernel-entry-init.h     |   18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h b/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h
index c7c3885..ae2435e 100644
--- a/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h
+++ b/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h
@@ -124,6 +124,24 @@ skip:
 	dli	v1, ~(7 << 7)
 	and	v0, v0, v1
 	or	v0, v0, 0x300		# (6 << 7)
+
+	mfc0	v1, CP0_PRID_REG
+	and	v1, v1, 0xfff0
+	xor	t1, v1, 0x9000		# 63-P1
+	beqz	t1, 4f
+	xor	t1, v1, 0x9010		# 63-P2
+	beqz	t1, 4f
+	xor	t1, v1, 0x9100		# 68-P0
+	beqz	t1, 4f
+	xor	t1, v1, 0x9200		# 66-P0
+	beqz	t1, 4f
+	b	5f			# Skip WAR for others.
+
+
+4:	# core-16057 work around
+	or	v0, v0, 0x2000		# Set IPREF bit.
+	
+5:	# No core-16057 work around
 	# Write the cavium control register
 	dmtc0   v0, CP0_CVMCTL_REG
 	sync
-- 
1.7.9.7

