From c0fa3db835711f917918f43be6dcf2ded4dd3c78 Mon Sep 17 00:00:00 2001
From: David Daney <david.daney@cavium.com>
Date: Wed, 7 Dec 2011 16:33:00 -0800
Subject: [PATCH 2/3] MIPS: Octeon: Don't do core-16057 WAR for cn66xx-P1.2

Source: SDK.2.3.0-427

It is fixed in pass 1.2 of cn66xx, so exclude that version from the
workaround.

Signed-off-by: David Daney <david.daney@cavium.com>
Integrated-by: Yong Zhang <yong.zhang@windriver.com>
---
 .../asm/mach-cavium-octeon/kernel-entry-init.h     |   20 ++++++++++++--------
 1 file changed, 12 insertions(+), 8 deletions(-)

diff --git a/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h b/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h
index ae2435e..90abc80 100644
--- a/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h
+++ b/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h
@@ -126,17 +126,21 @@ skip:
 	or	v0, v0, 0x300		# (6 << 7)
 
 	mfc0	v1, CP0_PRID_REG
-	and	v1, v1, 0xfff0
-	xor	t1, v1, 0x9000		# 63-P1
+	and	t1, v1, 0xfff0
+	xor	t1, t1, 0x9000		# 63-P1
 	beqz	t1, 4f
-	xor	t1, v1, 0x9010		# 63-P2
+	and	t1, v1, 0xfff0
+	xor	t1, t1, 0x9010		# 63-P2
 	beqz	t1, 4f
-	xor	t1, v1, 0x9100		# 68-P0
+	and	t1, v1, 0xfff0
+	xor	t1, t1, 0x9100		# 68-P0
 	beqz	t1, 4f
-	xor	t1, v1, 0x9200		# 66-P0
-	beqz	t1, 4f
-	b	5f			# Skip WAR for others.
-
+	and	t1, v1, 0xff00
+	xor	t1, t1, 0x9200		# 66-PX
+	bnez	t1, 5f			# Skip WAR for others.
+	and	t1, v1, 0x00ff
+	slti	t1, t1, 2		# 66-P1.2 and later good.
+	beqz	t1, 5f
 
 4:	# core-16057 work around
 	or	v0, v0, 0x2000		# Set IPREF bit.
-- 
1.7.9.7

