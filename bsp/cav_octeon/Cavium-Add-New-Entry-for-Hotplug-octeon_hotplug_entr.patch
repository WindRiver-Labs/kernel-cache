From 11bc93fde6739c845a2ca5e5a10516cf0d12ba4f Mon Sep 17 00:00:00 2001
From: ltian <le.tian@windriver.com>
Date: Fri, 1 Apr 2011 14:18:29 -0400
Subject: [PATCH] Cavium: Add New Entry for Hotplug octeon_hotplug_entry

This patch is re-splited from cavium SDK 2.0-366.
Create new entry for hotplug 'octeon_hotplug_entry' in unmapped space that the
HOTPLUG_CPU code passes to the bootloader.

Signed-off-by: Tian Le <le.tian@windriver.com>
---
 .../asm/mach-cavium-octeon/kernel-entry-init.h     |   54 ++++++++++++++++++++
 1 files changed, 54 insertions(+), 0 deletions(-)

diff --git a/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h b/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h
index 976fab7..7413321 100644
--- a/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h
+++ b/arch/mips/include/asm/mach-cavium-octeon/kernel-entry-init.h
@@ -29,6 +29,60 @@
 	# a3 = address of boot descriptor block
 	.set push
 	.set arch=octeon
+#ifdef CONFIG_HOTPLUG_CPU
+	b	7f
+
+FEXPORT(octeon_hotplug_entry)
+	move	a0, zero
+	move	a1, zero
+	move	a2, zero
+	move	a3, zero
+7:
+#endif
+	mfc0	v0, CP0_STATUS
+	/* Force 64-bit addressing enabled */
+	ori	v0, v0, (ST0_UX | ST0_SX | ST0_KX)
+	mtc0	v0, CP0_STATUS
+
+	# Clear the TLB.
+	mfc0	v0, CP0_CONFIG, 1	# Config1
+	dsrl	v0, v0, 25
+	andi	v0, v0, 0x3f
+	mfc0	v1, CP0_CONFIG, 3	# Config3
+	bgez	v1, 1f
+	mfc0	v1, CP0_CONFIG, 4	# Config4
+	andi	v1, 0x7f
+	dsll	v1, 6
+	or	v0, v0, v1
+1:					# Number of TLBs in v0
+
+	dmtc0	zero, CP0_ENTRYLO0, 0
+	dmtc0	zero, CP0_ENTRYLO1, 0
+	dmtc0	zero, CP0_PAGEMASK, 0
+	dla	t0, 0xffffffff90000000
+10:
+	dmtc0	t0, CP0_ENTRYHI, 0
+	tlbp
+	mfc0	t1, CP0_INDEX, 0
+	bltz	t1, 1f
+	tlbr
+	dmtc0	zero, CP0_ENTRYLO0, 0
+	dmtc0	zero, CP0_ENTRYLO1, 0
+	dmtc0	zero, CP0_PAGEMASK, 0
+	tlbwi				# Make it a 'normal' sized page
+	daddiu	t0, t0, 8192
+	b	10b
+1:
+	mtc0	v0, CP0_INDEX, 0
+	tlbwi
+	.set	noreorder
+	bne	v0, zero, 10b
+	addiu	v0, v0, -1
+	.set	reorder
+
+	mtc0	zero, CP0_INDEX, 0
+	dmtc0	zero, CP0_ENTRYHI, 0
+
 	# Read the cavium mem control register
 	dmfc0   v0, CP0_CVMMEMCTL_REG
 	# Clear the lower 6 bits, the CVMSEG size
-- 
1.7.0.4

