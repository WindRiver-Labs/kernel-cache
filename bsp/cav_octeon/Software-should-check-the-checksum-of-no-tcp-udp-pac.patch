From 20680efeed7b3b69e55f4f9f949ea3c2e05155f3 Mon Sep 17 00:00:00 2001
From: Roy.Li <rongqing.li@windriver.com>
Date: Mon, 24 Oct 2011 16:26:38 +0800
Subject: [PATCH] Software should check the checksum of no tcp/udp packets

When icmpv6_rcv handles the packets, it would not verify the icmp
checksum if the skb->ip_summed is CHECKSUM_UNNECESSARY.

The L4_error register can report L4 checksum error, if it is Zero,
it means the L4 checksum verification is OK, and does not need
software to verify the checksum again, so CHECKSUM_UNNECESSARY is
set.

But L4_error only works for TCP/UDP, not for ICMP from test result.

Signed-off-by: Roy.Li <rongqing.li@windriver.com>
---
 drivers/net/octeon/ethernet-rx.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/net/octeon/ethernet-rx.c b/drivers/net/octeon/ethernet-rx.c
index c684037..9c56865 100644
--- a/drivers/net/octeon/ethernet-rx.c
+++ b/drivers/net/octeon/ethernet-rx.c
@@ -543,7 +543,8 @@ static int cvm_oct_napi_poll(struct napi_struct *napi, int budget)
 				skb->protocol = eth_type_trans(skb, priv->netdev);
 				skb->dev = priv->netdev;
 
-				if (unlikely(work->word2.s.not_IP || work->word2.s.IP_exc || work->word2.s.L4_error))
+				if (unlikely(work->word2.s.not_IP || work->word2.s.IP_exc ||
+					    work->word2.s.L4_error || !work->word2.s.tcp_or_udp))
 					skb->ip_summed = CHECKSUM_NONE;
 				else
 					skb->ip_summed = CHECKSUM_UNNECESSARY;
-- 
1.7.0.4

