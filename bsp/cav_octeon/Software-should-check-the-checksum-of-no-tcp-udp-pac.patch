From 596a0aa539f5577e8220507c68d2a1872e35e99a Mon Sep 17 00:00:00 2001
From: Roy.Li <rongqing.li@windriver.com>
Date: Thu, 8 Sep 2011 15:21:18 +0800
Subject: [PATCH] Software should check the checksum of no tcp/udp packets

When icmpv6_rcv handles the packets, it would not verify the icmp
checksum if the skb->ip_summed is CHECKSUM_UNNECESSARY.

The L4_error register can report L4 checksum error, if it is Zero,
it means the L4 checksum verification is OK, and does not need
software to verify the checksum again, so CHECKSUM_UNNECESSARY is
set.

But L4_error only works for TCP/UDP, not for ICMP from test result.

Signed-off-by: Roy.Li <rongqing.li@windriver.com>
---
 drivers/staging/octeon/ethernet-rx.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/staging/octeon/ethernet-rx.c b/drivers/staging/octeon/ethernet-rx.c
index cb38f9e..563633c 100644
--- a/drivers/staging/octeon/ethernet-rx.c
+++ b/drivers/staging/octeon/ethernet-rx.c
@@ -409,7 +409,8 @@ static int cvm_oct_napi_poll(struct napi_struct *napi, int budget)
 				skb->protocol = eth_type_trans(skb, dev);
 				skb->dev = dev;
 
-				if (unlikely(work->word2.s.not_IP || work->word2.s.IP_exc || work->word2.s.L4_error))
+				if (unlikely(work->word2.s.not_IP || work->word2.s.IP_exc ||
+					 work->word2.s.L4_error || !work->word2.s.tcp_or_udp))
 					skb->ip_summed = CHECKSUM_NONE;
 				else
 					skb->ip_summed = CHECKSUM_UNNECESSARY;
-- 
1.7.0.4

