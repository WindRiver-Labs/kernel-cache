From 29510b50b457c479fbc70500511673faf147d1da Mon Sep 17 00:00:00 2001
From: ltian <le.tian@windriver.com>
Date: Thu, 11 Nov 2010 16:32:31 +0800
Subject: [PATCH 022/132] Cavium: Use Cavium hweight builtins

Source: SDK 2.0.0-366

The compiler has built-in Hamming weight operations when compiling for
Octeon. This uses those built-ins instead of calling library
functions.

Signed-off-by: ltian <le.tian@windriver.com>
---
 arch/mips/Kconfig              |    2 +-
 arch/mips/include/asm/bitops.h |   23 +++++++++++++++++++++++
 2 files changed, 24 insertions(+), 1 deletions(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index e171a7a..4b2760f 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -726,7 +726,7 @@ config GENERIC_FIND_NEXT_BIT
 
 config GENERIC_HWEIGHT
 	bool
-	default y
+	default y if !CPU_CAVIUM_OCTEON
 
 config GENERIC_CALIBRATE_DELAY
 	bool
diff --git a/arch/mips/include/asm/bitops.h b/arch/mips/include/asm/bitops.h
index eb2b900..9183fbc 100644
--- a/arch/mips/include/asm/bitops.h
+++ b/arch/mips/include/asm/bitops.h
@@ -701,7 +701,30 @@ static inline int ffs(int word)
 #ifdef __KERNEL__
 
 #include <asm-generic/bitops/sched.h>
+
+#ifdef CONFIG_CPU_CAVIUM_OCTEON
+static inline unsigned int hweight32(unsigned int w)
+{
+	return __builtin_popcount(w);
+}
+
+static inline unsigned long hweight64(__u64 w)
+{
+	return __builtin_popcountll(w);
+}
+
+static inline unsigned int hweight16(unsigned int w)
+{
+	return __builtin_popcount(w & 0xffff);
+}
+
+static inline unsigned int hweight8(unsigned int w)
+{
+	return __builtin_popcount(w & 0xff);
+}
+#else
 #include <asm-generic/bitops/hweight.h>
+#endif
 #include <asm-generic/bitops/ext2-non-atomic.h>
 #include <asm-generic/bitops/ext2-atomic.h>
 #include <asm-generic/bitops/minix.h>
-- 
1.6.5.2

