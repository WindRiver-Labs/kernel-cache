From 8817a4d06190da4e4a169d7957a6ebdb856f7226 Mon Sep 17 00:00:00 2001
From: Hui Zhu <hui.zhu@windriver.com>
Date: Wed, 7 Jul 2010 13:30:50 -0400
Subject: [PATCH] cavium-octeon: add code to put cpu message to note when kernel kdump

This bug is because the vmcore file did't have the cpu message.
It don't have cpu message because it didn't put the cpu message
to note when kernel kdump.
Add code to put it.

Signed-off-by: Hui Zhu <hui.zhu@windriver.com>
---
 arch/mips/cavium-octeon/hal.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/arch/mips/cavium-octeon/hal.c b/arch/mips/cavium-octeon/hal.c
index a617ccc..d83bf86 100644
--- a/arch/mips/cavium-octeon/hal.c
+++ b/arch/mips/cavium-octeon/hal.c
@@ -759,6 +759,8 @@ static void octeon_kexec_shutdown_other_cpus(void *ignore)
 
 	local_irq_disable();
 
+	crash_save_cpu(task_pt_regs(current), cpu);
+
 	cpu_set(cpu, kexec_cpus);
 
 	while (!atomic_read(&kexec_ready_to_reboot)) {
@@ -851,6 +853,7 @@ void octeon_kexec_shutdown(void)
 void octeon_crash_shutdown(struct pt_regs *regs)
 {
 #ifdef CONFIG_SMP
+	crash_save_cpu(regs, smp_processor_id());
 	/* just use the normal shutdown() mechanism */
 	octeon_kexec_shutdown();
 #endif /* CONFIG_SMP */
-- 
1.7.0.4

