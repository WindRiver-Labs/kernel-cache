From fef144aacf8c09861daca9e813f7e13792cedc8e Mon Sep 17 00:00:00 2001
From: Yong Zhang <yong.zhang@windriver.com>
Date: Thu, 4 Mar 2010 15:42:20 +0800
Subject: [PATCH] MIPS: Octeon: bring up usable memory by default

By default, the system can only boot up with MAX_MEMORY(512M)
system memory. This change is introduced by commit:
[commit 839c8e825ca3cce447052e399ada2cec28713855
 Author: Greg Moffatt <greg.moffatt@windriver.com>
 Date:   Thu Jul 9 16:31:51 2009 -0400

    cavium: kernel hooks to support kexec

    Areas of kernel code specific to the Cavium MIPS variant are
    modified to enable kexec.  Specifically:
    - new functions created to cleanup bootloader-reserved memory segments
      and shutdown networking devices gracefully during kexec shutdown
    - new cavium-specific target functions for kexec prepare/shutdown
      functions that trigger cavium-specific actions during kexec
    - SMP support for kexec graceful and crash shutdowns

    Signed-off-by: Greg Moffatt <greg.moffatt@windriver.com>]

This will make trouble on boards with different memory size because
the kernel cann't be deployed with universal command line.

This patch also fix wrong memory resize in cleanup_phy_mem().

Signed-off-by: Yong Zhang <yong.zhang@windriver.com>
---
 arch/mips/cavium-octeon/setup.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index 696fb84..bc69f3c 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -355,7 +355,7 @@ void cleanup_phy_mem(void)
 		__cvmx_bootmem_phy_free(curr_addr,
 			OCTEON_DDR0_SIZE - curr_addr, 0);
 
-		memory -= (OCTEON_DDR0_SIZE - curr_addr);
+		memory -= OCTEON_DDR0_SIZE;
 
 		if (memory > OCTEON_DDR1_SIZE) {
 			__cvmx_bootmem_phy_free(OCTEON_DDR1_BASE,
@@ -449,7 +449,8 @@ void __init plat_mem_setup(void)
 		 */
 
 		cvmx_bootmem_lock();
-		while ((boot_mem_map.nr_map < BOOT_MEM_MAP_MAX) && (total < MAX_MEMORY)) {
+		while ((boot_mem_map.nr_map < BOOT_MEM_MAP_MAX) &&
+				(total <= OCTEON_MAX_PHY_MEM_SIZE)) {
 #if defined(CONFIG_64BIT) || defined(CONFIG_64BIT_PHYS_ADDR)
 		int64_t memory =
 			cvmx_bootmem_phy_alloc(mem_alloc_size,
-- 
1.7.0

