From 6e264a4fb9ec99dbd07625f4bb4afea54509a116 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Mon, 20 Dec 2010 13:25:37 +0800
Subject: [PATCH 27/30] WRHV: Cavium: hardcode Octeon Plus icache parameters

In probe_octeon, need read config1 to get some cache configuration
info, but GOS can't access config1, so hardcode icache line size,
sets and ways for Octeon Plus and Octeon II.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/include/asm/octeon/octeon-cache.h |   17 +++++++++++++++++
 arch/mips/mm/c-octeon.c                     |   12 +++++++++++-
 2 files changed, 28 insertions(+), 1 deletions(-)
 create mode 100644 arch/mips/include/asm/octeon/octeon-cache.h

diff --git a/arch/mips/include/asm/octeon/octeon-cache.h b/arch/mips/include/asm/octeon/octeon-cache.h
new file mode 100644
index 0000000..86b242e
--- /dev/null
+++ b/arch/mips/include/asm/octeon/octeon-cache.h
@@ -0,0 +1,17 @@
+/*
+ * This file is subject to the terms and conditions of the GNU General Public
+ * License.  See the file "COPYING" in the main directory of this archive
+ * for more details.
+ *
+ * Copyright (C) 2010-2011 Wind River System
+ */
+#ifndef __OCTEON_CACHE_H__
+#define __OCTEON_CACHE_H__
+
+#define OCTEON_PLUS_ICACHE_LINE_SIZE	128
+#define OCTEON_PLUS_ICACHE_SETS		( 64 << 0)
+#define OCTEON_PLUS_ICACHE_WAYS		4
+
+#define OCTEON_II_ICACHE_LINE_SIZE	128
+
+#endif
diff --git a/arch/mips/mm/c-octeon.c b/arch/mips/mm/c-octeon.c
index e53de96..8a879f6 100644
--- a/arch/mips/mm/c-octeon.c
+++ b/arch/mips/mm/c-octeon.c
@@ -27,6 +27,10 @@
 
 #include <asm/octeon/octeon.h>
 
+#ifdef CONFIG_WRHV
+#include <asm/octeon/octeon-cache.h>
+#endif
+
 unsigned long long cache_err_dcache[NR_CPUS];
 
 /**
@@ -189,9 +193,15 @@ static void __cpuinit probe_octeon(void)
 	switch (c->cputype) {
 	case CPU_CAVIUM_OCTEON:
 	case CPU_CAVIUM_OCTEON_PLUS:
+#ifdef CONFIG_WRHV
+		c->icache.linesz = OCTEON_PLUS_ICACHE_LINE_SIZE;
+		c->icache.sets = OCTEON_PLUS_ICACHE_SETS;
+		c->icache.ways = OCTEON_PLUS_ICACHE_WAYS;
+#else
 		c->icache.linesz = 2 << ((config1 >> 19) & 7);
 		c->icache.sets = 64 << ((config1 >> 22) & 7);
 		c->icache.ways = 1 + ((config1 >> 16) & 7);
+#endif
 		c->icache.flags |= MIPS_CACHE_VTAG;
 		icache_size =
 			c->icache.sets * c->icache.ways * c->icache.linesz;
@@ -210,7 +220,7 @@ static void __cpuinit probe_octeon(void)
 
 	case CPU_CAVIUM_OCTEON2:
 #ifdef CONFIG_WRHV
-		c->icache.linesz = 128;
+		c->icache.linesz = OCTEON_II_ICACHE_LINE_SIZE;
 #else
 		c->icache.linesz = 2 << ((config1 >> 19) & 7);
 #endif
-- 
1.6.5.2

