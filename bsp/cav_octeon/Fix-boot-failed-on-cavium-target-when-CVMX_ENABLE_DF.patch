From 0a5a4876bc2d55d6c99d67a9a44a7ff82178e484 Mon Sep 17 00:00:00 2001
From: Xufeng Zhang <xufeng.zhang@windriver.com>
Date: Fri, 22 Oct 2010 18:27:35 +0800
Subject: [PATCH] Fix boot failed on cavium target when CVMX_ENABLE_DFA_FUNCTIONS is defined

This issue is caused by the inconsistent define of CVMX_FPA_OUTPUT_BUFFER_POOL
on driver code and on simple_exec_open code when CVMX_ENABLE_DFA_FUNCTIONS is defined.
on driver code, CVMX_FPA_OUTPUT_BUFFER_POOL is defined as 2, however, when
CVMX_ENABLE_DFA_FUNCTIONS is defined, CVMX_FPA_OUTPUT_BUFFER_POOL is defined as 3 on simple_exec_open
in generated cvmx-config.h file. The point is that FPA pool is initialized on driver code,
so the driver code has not initialized enough buffer for PKO queue command buffers.

Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
---
 .../gpl-executive/config/cvmx-config.h             |   15 +++++++++------
 1 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/arch/mips/cavium-octeon/gpl-executive/config/cvmx-config.h b/arch/mips/cavium-octeon/gpl-executive/config/cvmx-config.h
index 4c4e662..bcb735b 100644
--- a/arch/mips/cavium-octeon/gpl-executive/config/cvmx-config.h
+++ b/arch/mips/cavium-octeon/gpl-executive/config/cvmx-config.h
@@ -23,8 +23,8 @@
 /* Pool sizes in bytes, must be multiple of a cache line */
 #define CVMX_FPA_POOL_0_SIZE (16 * CVMX_CACHE_LINE_SIZE)
 #define CVMX_FPA_POOL_1_SIZE (1 * CVMX_CACHE_LINE_SIZE)
-#define CVMX_FPA_POOL_2_SIZE (8 * CVMX_CACHE_LINE_SIZE)
-#define CVMX_FPA_POOL_3_SIZE (0 * CVMX_CACHE_LINE_SIZE)
+#define CVMX_FPA_POOL_2_SIZE (2 * CVMX_CACHE_LINE_SIZE)
+#define CVMX_FPA_POOL_3_SIZE (8 * CVMX_CACHE_LINE_SIZE)
 #define CVMX_FPA_POOL_4_SIZE (0 * CVMX_CACHE_LINE_SIZE)
 #define CVMX_FPA_POOL_5_SIZE (0 * CVMX_CACHE_LINE_SIZE)
 #define CVMX_FPA_POOL_6_SIZE (0 * CVMX_CACHE_LINE_SIZE)
@@ -35,8 +35,10 @@
 #define CVMX_FPA_PACKET_POOL_SIZE           CVMX_FPA_POOL_0_SIZE
 #define CVMX_FPA_WQE_POOL                   (1)             /**< Work queue entrys */
 #define CVMX_FPA_WQE_POOL_SIZE              CVMX_FPA_POOL_1_SIZE
-#define CVMX_FPA_OUTPUT_BUFFER_POOL         (2)             /**< PKO queue command buffers */
-#define CVMX_FPA_OUTPUT_BUFFER_POOL_SIZE    CVMX_FPA_POOL_2_SIZE
+#define CVMX_FPA_DFA_POOL                   (2)             /**< DFA command buffers */
+#define CVMX_FPA_DFA_POOL_SIZE              CVMX_FPA_POOL_2_SIZE
+#define CVMX_FPA_OUTPUT_BUFFER_POOL         (3)             /**< PKO queue command buffers */
+#define CVMX_FPA_OUTPUT_BUFFER_POOL_SIZE    CVMX_FPA_POOL_3_SIZE
 
 /*************************  FAU allocation ********************************/
 /* The fetch and add registers are allocated here.  They are arranged
@@ -51,8 +53,9 @@
 #define CVMX_FAU_REG_64_ADDR(x) ((x <<3) + CVMX_FAU_REG_64_START)
 typedef enum
 {
-    CVMX_FAU_REG_64_START          = 0, 
-    CVMX_FAU_REG_64_END            = CVMX_FAU_REG_64_ADDR(0),
+    CVMX_FAU_REG_64_START          = 0,
+    CVMX_FAU_DFA_STATE             = CVMX_FAU_REG_64_ADDR(0), /**< FAU registers for the state of the DFA command queue */
+    CVMX_FAU_REG_64_END            = CVMX_FAU_REG_64_ADDR(1), 
 } cvmx_fau_reg_64_t;
 
 #define CVMX_FAU_REG_32_ADDR(x) ((x <<2) + CVMX_FAU_REG_32_START)
-- 
1.7.0.4

