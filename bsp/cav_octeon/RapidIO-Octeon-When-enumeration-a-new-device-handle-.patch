From d3c26c0efd1437ad590b89c19708c25efcc17771 Mon Sep 17 00:00:00 2001
From: ltian <le.tian@windriver.com>
Date: Mon, 15 Nov 2010 14:20:44 +0800
Subject: [PATCH 086/132] RapidIO: Octeon: When enumeration a new device, handle a failure to read the device lock gracefully.

The first maint transaction to a device may fail if there is
something wrong with the bus configuration or device. Check
the return code from the read transaction and handle it
gracefully. Devices that don't respond to the initial read
will be skipped.

Signed-off-by: Chad Reese <kreese@caviumnetworks.com>
Signed-off-by: ltian <le.tian@windriver.com>
---
 drivers/rapidio/rio-scan.c |   25 ++++++++++++++++++-------
 1 files changed, 18 insertions(+), 7 deletions(-)

diff --git a/drivers/rapidio/rio-scan.c b/drivers/rapidio/rio-scan.c
index 5664321..1924b8f 100644
--- a/drivers/rapidio/rio-scan.c
+++ b/drivers/rapidio/rio-scan.c
@@ -707,14 +707,19 @@ rio_route_get_entry(struct rio_mport *mport, struct rio_switch *rswitch, u16 tab
  * Used during enumeration to read the Host Device ID Lock CSR on a
  * RIO device. Returns the value of the lock register.
  */
-static u16 rio_get_host_deviceid_lock(struct rio_mport *port, u8 hopcount)
+static int rio_get_host_deviceid_lock(struct rio_mport *port, u8 hopcount)
 {
 	u32 result;
-
-	rio_mport_read_config_32(port, RIO_ANY_DESTID(port->sys_size), hopcount,
-				 RIO_HOST_DID_LOCK_CSR, &result);
-
-	return (u16) (result & 0xffff);
+	int status;
+
+	status = rio_mport_read_config_32(port, RIO_ANY_DESTID(port->sys_size),
+		hopcount, RIO_HOST_DID_LOCK_CSR, &result);
+	if ((status == 0) && (result != 0xffffffff))
+		return (u16) (result & 0xffff);
+	else if (status)
+		return status;
+	else
+		return -ETIMEDOUT;
 }
 
 /**
@@ -791,7 +796,13 @@ static int __devinit rio_enum_peer(struct rio_net *net, struct rio_mport *port,
 	u16 destid;
 	int tmp;
 
-	if (rio_get_host_deviceid_lock(port, hopcount) == port->host_deviceid) {
+	tmp = rio_get_host_deviceid_lock(port, hopcount);
+	if (tmp < 0) {
+		pr_debug("RIO: Reading device lock failed. Skipping.\n");
+		return 0;
+	}
+
+	if (tmp == port->host_deviceid) {
 		pr_debug("RIO: PE already discovered by this host\n");
 		/*
 		 * Already discovered by this host. Add it as another
-- 
1.6.5.2

