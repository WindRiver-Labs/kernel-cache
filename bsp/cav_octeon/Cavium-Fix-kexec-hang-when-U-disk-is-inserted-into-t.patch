From e68504855181246ded0e3143ae7c30881b15476d Mon Sep 17 00:00:00 2001
From: Tian Le <le.tian@windriver.com>
Date: Thu, 17 Feb 2011 18:53:23 +0800
Subject: [PATCH 130/132] Cavium: Fix kexec hang when U-disk is inserted into the board

The function of usb_remove_hcd()(drivers/usb/core/hcd.c) can't
be called in IRQ context. So move kexec_octeon_shutdown_usb_ports()
ahead of IPI sending.

Signed-off-by: Tian Le <le.tian@windriver.com>
---
 arch/mips/cavium-octeon/setup.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index dfc9227..aa3335b 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -1189,7 +1189,10 @@ static void octeon_kexec_shutdown(void)
 #ifdef CONFIG_SMP
 	unsigned int msecs;
 	unsigned int ncpus;
+#endif
 
+	kexec_octeon_shutdown_usb_ports();
+#ifdef CONFIG_SMP
 	/* proceed to shutdown the other CPUs */
 	ncpus = num_online_cpus() - 1; /* exclude this CPU */
 	cpus_clear(kexec_cpus);
@@ -1205,8 +1208,6 @@ static void octeon_kexec_shutdown(void)
 		mdelay(1);
 	}
 #endif /* CONFIG_SMP */
-
-	kexec_octeon_shutdown_usb_ports();
 }
 
 static void octeon_crash_shutdown(struct pt_regs *regs)
-- 
1.6.5.2

