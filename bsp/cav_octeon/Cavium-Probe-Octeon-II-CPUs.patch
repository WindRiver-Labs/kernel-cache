From 1b1ff852561954eea692468d630065c57291de72 Mon Sep 17 00:00:00 2001
From: ltian <le.tian@windriver.com>
Date: Thu, 11 Nov 2010 16:54:12 +0800
Subject: [PATCH 023/132] Cavium: Probe Octeon II CPUs

Source: SDK 2.0.0-366

Add support for Octeon II CPUs in CPU probes. Detect Octeon II
in platform code. Add defines for Octeon II CPUs.

Signed-off-by: ltian <le.tian@windriver.com>
---
 arch/mips/cavium-octeon/octeon-platform.c          |   32 ++++++++++++++++++--
 arch/mips/cavium-octeon/setup.c                    |    4 ++
 arch/mips/include/asm/cpu-info.h                   |    1 +
 arch/mips/include/asm/cpu.h                        |    3 +-
 .../asm/mach-cavium-octeon/cpu-feature-overrides.h |    6 ++-
 arch/mips/kernel/cpu-probe.c                       |   10 ++++++
 arch/mips/kernel/proc.c                            |    2 +
 7 files changed, 52 insertions(+), 6 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-platform.c b/arch/mips/cavium-octeon/octeon-platform.c
index 6ac9b1a..b35ded3 100644
--- a/arch/mips/cavium-octeon/octeon-platform.c
+++ b/arch/mips/cavium-octeon/octeon-platform.c
@@ -10,11 +10,13 @@
 #include <linux/init.h>
 #include <linux/irq.h>
 #include <linux/i2c.h>
+#include <linux/usb.h>
 #include <linux/module.h>
 #include <linux/platform_device.h>
 
 #include <asm/octeon/octeon.h>
 #include <asm/octeon/cvmx-rnm-defs.h>
+#include <asm/octeon/cvmx-uahcx-defs.h>
 
 static struct octeon_cf_data octeon_cf_data;
 
@@ -198,13 +200,14 @@ static int __init octeon_i2c_device_init(void)
 		}
 	};
 
-	if (OCTEON_IS_MODEL(OCTEON_CN56XX) || OCTEON_IS_MODEL(OCTEON_CN52XX))
+	if (OCTEON_IS_MODEL(OCTEON_CN56XX) || OCTEON_IS_MODEL(OCTEON_CN52XX)
+	    || OCTEON_IS_MODEL(OCTEON_CN63XX))
 		num_ports = 2;
 	else
 		num_ports = 1;
 
 	for (port = 0; port < num_ports; port++) {
-		octeon_i2c_data[port].sys_freq = octeon_get_clock_rate();
+		octeon_i2c_data[port].sys_freq = octeon_get_io_clock_rate();
 		/*FIXME: should be examined. At the moment is set for 100Khz */
 		octeon_i2c_data[port].i2c_freq = 100000;
 
@@ -259,6 +262,13 @@ static int __init octeon_mdiobus_device_init(void)
 	if (octeon_is_simulation())
 		return 0; /* No mdio in the simulator. */
 
+	/*
+	 * Landbird NIC card does not have PHY. Probing MDIO is
+	 * putting XAUI in interface 0 in bad state.
+	 */
+	if (octeon_bootinfo->board_type == CVMX_BOARD_TYPE_NIC_XLE_10G)
+		return 0;
+
 	/* The bus number is the platform_device id.  */
 	pd = platform_device_alloc("mdio-octeon", 0);
 	if (!pd) {
@@ -270,6 +280,20 @@ static int __init octeon_mdiobus_device_init(void)
 	if (ret)
 		goto fail;
 
+	if (!OCTEON_IS_MODEL(OCTEON_CN56XX) && !OCTEON_IS_MODEL(OCTEON_CN6XXX))
+		goto out;
+
+	/* The bus number is the platform_device id.  */
+	pd = platform_device_alloc("mdio-octeon", 1);
+	if (!pd) {
+		ret = -ENOMEM;
+		goto out;
+	}
+
+	ret = platform_device_add(pd);
+	if (ret)
+		goto fail;
+
 	return ret;
 fail:
 	platform_device_put(pd);
@@ -293,7 +317,9 @@ static int __init octeon_mgmt_device_init(void)
 		.end	= -1
 	};
 
-	if (!OCTEON_IS_MODEL(OCTEON_CN56XX) && !OCTEON_IS_MODEL(OCTEON_CN52XX))
+	if (!OCTEON_IS_MODEL(OCTEON_CN56XX)
+	    && !OCTEON_IS_MODEL(OCTEON_CN52XX)
+	    && !OCTEON_IS_MODEL(OCTEON_CN6XXX))
 		return 0;
 
 	if (OCTEON_IS_MODEL(OCTEON_CN56XX))
diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index d2f63a0..8fce39b 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -102,6 +102,8 @@ static int octeon_uart;
 extern asmlinkage void handle_int(void);
 extern asmlinkage void plat_irq_dispatch(void);
 
+#define SDK_VERSION "2.0"
+
 /**
  * Return non zero if we are currently running in the Octeon simulator
  *
@@ -911,6 +913,8 @@ void __init prom_init(void)
 #ifdef CONFIG_CRASH_DUMP
 	octeon_crash_dump_setup();
 #endif
+
+	pr_info("Cavium Networks SDK-" SDK_VERSION "\n");
 }
 
 /* constants for memory initialization */
diff --git a/arch/mips/include/asm/cpu-info.h b/arch/mips/include/asm/cpu-info.h
index b39def3..f6299be 100644
--- a/arch/mips/include/asm/cpu-info.h
+++ b/arch/mips/include/asm/cpu-info.h
@@ -78,6 +78,7 @@ struct cpuinfo_mips {
 	unsigned int		watch_reg_use_cnt; /* Usable by ptrace */
 #define NUM_WATCH_REGS 4
 	u16			watch_reg_masks[NUM_WATCH_REGS];
+	unsigned int            kscratch_mask; /* Usable KScratch mask. */
 } __attribute__((aligned(SMP_CACHE_BYTES)));
 
 extern struct cpuinfo_mips cpu_data[];
diff --git a/arch/mips/include/asm/cpu.h b/arch/mips/include/asm/cpu.h
index a5acda4..b6734f7 100644
--- a/arch/mips/include/asm/cpu.h
+++ b/arch/mips/include/asm/cpu.h
@@ -131,6 +131,7 @@
 #define PRID_IMP_CAVIUM_CN56XX 0x0400
 #define PRID_IMP_CAVIUM_CN50XX 0x0600
 #define PRID_IMP_CAVIUM_CN52XX 0x0700
+#define PRID_IMP_CAVIUM_CN63XX 0x9000
 
 /*
  * Definitions for 7:0 on legacy processors
@@ -224,7 +225,7 @@ enum cpu_type_enum {
 	 * MIPS64 class processors
 	 */
 	CPU_5KC, CPU_20KC, CPU_25KF, CPU_SB1, CPU_SB1A, CPU_LOONGSON2,
-	CPU_CAVIUM_OCTEON, CPU_CAVIUM_OCTEON_PLUS,
+	CPU_CAVIUM_OCTEON, CPU_CAVIUM_OCTEON_PLUS, CPU_CAVIUM_OCTEON2,
 
 	CPU_LAST
 };
diff --git a/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h b/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h
index d7180ee..fb70139 100644
--- a/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h
+++ b/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h
@@ -45,6 +45,9 @@
 #define cpu_has_dc_aliases	0
 #define cpu_has_ic_fills_f_dc	0
 #define cpu_has_64bits		1
+#define cpu_has_3k_cache       0
+#define cpu_has_4k_cache       0
+#define cpu_has_tx39_cache     0
 #define cpu_has_octeon_cache	1
 #ifdef CONFIG_CAVIUM_OCTEON2
 #define cpu_has_saa            1
@@ -59,12 +62,11 @@
 #define cpu_has_mips_r2_exec_hazard 0
 #define cpu_has_dsp		0
 #define cpu_has_mipsmt		0
-#define cpu_has_userlocal	0
 #define cpu_has_vint		0
 #define cpu_has_veic		0
 #define cpu_hwrena_impl_bits	0xc0000000
 
-#define kernel_uses_smartmips_rixi (cpu_data[0].cputype == CPU_CAVIUM_OCTEON_PLUS)
+#define kernel_uses_smartmips_rixi (cpu_data[0].cputype != CPU_CAVIUM_OCTEON)
 
 #define ARCH_HAS_READ_CURRENT_TIMER 1
 #define ARCH_HAS_IRQ_PER_CPU	1
diff --git a/arch/mips/kernel/cpu-probe.c b/arch/mips/kernel/cpu-probe.c
index 51d87c2..c6eeb30 100644
--- a/arch/mips/kernel/cpu-probe.c
+++ b/arch/mips/kernel/cpu-probe.c
@@ -169,6 +169,7 @@ void __init check_wait(void)
 	case CPU_BCM6358:
 	case CPU_CAVIUM_OCTEON:
 	case CPU_CAVIUM_OCTEON_PLUS:
+	case CPU_CAVIUM_OCTEON2:
 #ifdef CONFIG_WRHV
 		cpu_wait = wrhv_wait;
 #else
@@ -721,6 +722,8 @@ static inline unsigned int decode_config4(struct cpuinfo_mips *c)
 	    && cpu_has_tlb)
 		c->tlbsize += (config4 & MIPS_CONF4_MMUSIZEEXT) * 0x40;
 
+	c->kscratch_mask = (config4 >> 16) & 0xff;
+
 	return config4 & MIPS_CONF_M;
 }
 
@@ -935,11 +938,18 @@ platform:
 		if (cpu == 0)
 			__elf_platform = "octeon";
 		break;
+	case PRID_IMP_CAVIUM_CN63XX:
+		c->cputype = CPU_CAVIUM_OCTEON2;
+		__cpu_name[cpu] = "Cavium Octeon II";
+		if (cpu == 0)
+			__elf_platform = "octeon2";
+		break;
 	default:
 		printk(KERN_INFO "Unknown Octeon chip!\n");
 		c->cputype = CPU_UNKNOWN;
 		break;
 	}
+	c->core = read_c0_ebase() & 0x3ff;
 }
 
 const char *__cpu_name[NR_CPUS];
diff --git a/arch/mips/kernel/proc.c b/arch/mips/kernel/proc.c
index ed15fa8..1461c29 100644
--- a/arch/mips/kernel/proc.c
+++ b/arch/mips/kernel/proc.c
@@ -71,6 +71,8 @@ static int show_cpuinfo(struct seq_file *m, void *v)
 		);
 	seq_printf(m, "shadow register sets\t: %d\n",
 		       cpu_data[n].srsets);
+	seq_printf(m, "kscratch registers\t: %d\n",
+		   hweight8(cpu_data[n].kscratch_mask));
 	seq_printf(m, "core\t\t\t: %d\n", cpu_data[n].core);
 
 	sprintf(fmt, "VCE%%c exceptions\t\t: %s\n",
-- 
1.7.0.4

