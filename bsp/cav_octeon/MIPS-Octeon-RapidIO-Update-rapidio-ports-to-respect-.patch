From 9e824eaedb3242c166715e8cd592361b26fe825a Mon Sep 17 00:00:00 2001
From: ltian <le.tian@windriver.com>
Date: Mon, 15 Nov 2010 11:25:56 +0800
Subject: [PATCH 074/132] MIPS: Octeon: RapidIO: Update rapidio ports to respect host/endpoint mode.

Endpoint mode rapidio ports perform discovery, but not enumeration.
Set the host ID such that the rapidio subsystem knows when to perform
enumeration.

Signed-off-by: Chad Reese <kreese@caviumnetworks.com>
Signed-off-by: ltian <le.tian@windriver.com>
---
 arch/mips/cavium-octeon/octeon-rapidio.c |    9 +++++++--
 1 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/octeon-rapidio.c b/arch/mips/cavium-octeon/octeon-rapidio.c
index 71d1ce6..943dfd1 100644
--- a/arch/mips/cavium-octeon/octeon-rapidio.c
+++ b/arch/mips/cavium-octeon/octeon-rapidio.c
@@ -528,7 +528,7 @@ static int __init octeon_rio_init(void)
 	srio_ops.unmap = octeon_rio_mem_unmap;
 
 	memset(srio_ports, 0, sizeof(srio_ports));
-	for (srio_port = 0; srio_port < 2; srio_port++) {
+	for (srio_port = 0; srio_port < 1; srio_port++) {
 		cvmx_sriox_int_enable_t int_enable;
 		cvmx_sriox_status_reg_t sriox_status_reg;
 		cvmx_mio_rst_ctlx_t mio_rst_ctl;
@@ -537,7 +537,12 @@ static int __init octeon_rio_init(void)
 		if (!sriox_status_reg.s.srio)
 			continue;
 		INIT_WORK(&srio_ports[srio_port].work, octeon_rio_work);
-		srio_ports[srio_port].mport.host_deviceid = 0;
+		/* Only host mode ports enumerate. Endpoint does discovery */
+		mio_rst_ctl.u64 = cvmx_read_csr(CVMX_MIO_RST_CTLX(srio_port));
+		if (mio_rst_ctl.s.prtmode)
+			srio_ports[srio_port].mport.host_deviceid = srio_port;
+		else
+			srio_ports[srio_port].mport.host_deviceid = -1;
 		srio_ports[srio_port].mport.ops = &srio_ops;
 		srio_ports[srio_port].mport.id = srio_port;
 		srio_ports[srio_port].mport.index = 0;
-- 
1.6.5.2

