From 3aee1f21da31298ec3da7c69e4b7f570af332e0b Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Tue, 16 Mar 2010 15:22:57 +0800
Subject: [PATCH 15/17] MIPS: Octeon: Add disable build-id kernel config

The 1.7.x SDK u-boot bootloader does not know how to
handle the presence of a non-empty NOTES program header
in the kernel load file. This occurs when the linker
option '--build-id' is specified. Setting this option
to 'Y' prevents use of the build-id feature and allows
u-boot to load the kernel.

1.9.x SDK u-boot bootloader can handle this correctly,
so set the default value to N. If 1.7.x SDK u-boot is
used, please set this option to Y.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 Makefile                        |    2 ++
 arch/mips/cavium-octeon/Kconfig |   15 +++++++++++++++
 2 files changed, 17 insertions(+), 0 deletions(-)

diff --git a/Makefile b/Makefile
index 08ff02d..af3c5f9 100644
--- a/Makefile
+++ b/Makefile
@@ -601,8 +601,10 @@ ifneq ($(KCFLAGS),)
 endif
 
 # Use --build-id when available.
+ifndef CONFIG_BUILD_ID_DISABLE
 LDFLAGS_BUILD_ID = $(patsubst -Wl$(comma)%,%,\
 			      $(call cc-ldoption, -Wl$(comma)--build-id,))
+endif
 LDFLAGS_MODULE += $(LDFLAGS_BUILD_ID)
 LDFLAGS_vmlinux += $(LDFLAGS_BUILD_ID)
 
diff --git a/arch/mips/cavium-octeon/Kconfig b/arch/mips/cavium-octeon/Kconfig
index 6cf54f7..0ecc2ba 100644
--- a/arch/mips/cavium-octeon/Kconfig
+++ b/arch/mips/cavium-octeon/Kconfig
@@ -204,3 +204,18 @@ config CAVIUM_OCTEON_WATCHDOG
 	  On first expiration of the watchdog, the interrupt handler pokes it.
 	  The second expiration causes an NMI that prints a message and resets
 	  the chip. The third expiration causes a global soft reset.
+
+config BUILD_ID_DISABLE
+	bool "Disable the build-id feature of the linker"
+	default "n"
+	help
+	  The 1.7.x SDK u-boot bootloader does not know how to
+	  handle the presence of a non-empty NOTES program header
+	  in the kernel load file. This occurs when the linker
+	  option '--build-id' is specified. Setting this option
+	  to 'Y' prevents use of the build-id feature and allows
+	  u-boot to load the kernel.
+
+	  1.9.x SDK u-boot bootloader can handle this correctly,
+	  so set the default value to N. If 1.7.x SDK u-boot is
+	  used, please se this option to Y.
-- 
1.6.5.2

