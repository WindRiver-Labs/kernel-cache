From 8e6e4189f12443135be2170ac8fbf59eb4f73bba Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Tue, 20 Apr 2010 18:10:48 +0800
Subject: [PATCH 2/2] MIPS: Octeon: Avoid force SIGILL signal for CU2 exception

Since Cavium Octeon uses coprocessor 2 as crypto engine, so kernel
need handle CU2 exception for access to cop 2 from kernel or
user applications. But, kernel force SIGILL signal for all of
CU2 exception, so force do_cpu return to avoid SIGILL signal
for Cavium Octeon.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/include/asm/cpu-features.h               |    3 +++
 .../asm/mach-cavium-octeon/cpu-feature-overrides.h |    3 +++
 arch/mips/kernel/traps.c                           |    6 +++++-
 3 files changed, 11 insertions(+), 1 deletions(-)

diff --git a/arch/mips/include/asm/cpu-features.h b/arch/mips/include/asm/cpu-features.h
index ac73ced..9a7050f 100644
--- a/arch/mips/include/asm/cpu-features.h
+++ b/arch/mips/include/asm/cpu-features.h
@@ -98,6 +98,9 @@
 #ifndef kernel_uses_smartmips_rixi
 #define kernel_uses_smartmips_rixi 0
 #endif
+#ifndef kernel_uses_cpu2
+#define kernel_uses_cpu2 0
+#endif
 #ifndef cpu_has_vtag_icache
 #define cpu_has_vtag_icache	(cpu_data[0].icache.flags & MIPS_CACHE_VTAG)
 #endif
diff --git a/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h b/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h
index bbf0540..8c61621 100644
--- a/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h
+++ b/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h
@@ -61,6 +61,9 @@
 
 #define kernel_uses_smartmips_rixi (cpu_data[0].cputype == CPU_CAVIUM_OCTEON_PLUS)
 
+#define kernel_uses_cu2 (cpu_data[0].cputype == CPU_CAVIUM_OCTEON_PLUS || \
+			 cpu_data[0].cputype == CPU_CAVIUM_OCTEON)
+
 #define ARCH_HAS_READ_CURRENT_TIMER 1
 #define ARCH_HAS_IRQ_PER_CPU	1
 #define ARCH_HAS_SPINLOCK_PREFETCH 1
diff --git a/arch/mips/kernel/traps.c b/arch/mips/kernel/traps.c
index 47983b5..9842219 100644
--- a/arch/mips/kernel/traps.c
+++ b/arch/mips/kernel/traps.c
@@ -1011,7 +1011,11 @@ asmlinkage void do_cpu(struct pt_regs *regs)
 
 	case 2:
 		raw_notifier_call_chain(&cu2_chain, CU2_EXCEPTION, regs);
-		break;
+
+		if (kernel_uses_cu2)
+			return;
+		else
+			break;
 
 	case 3:
 		break;
-- 
1.6.5.2

