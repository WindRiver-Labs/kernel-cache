From 70ac67d2f36d4086988e854429571e9005962d13 Mon Sep 17 00:00:00 2001
From: Phil Staub <Phil.Staub@windriver.com>
Date: Wed, 6 Apr 2011 11:12:44 -0700
Subject: [PATCH] WRHV: MIPS: Add wrhv_macaddr commandline option

Hypervisor needs to be able to control the VB's MAC address. Make
provisions to read the desired address from the command line.

Signed-off-by: Phil Staub <Phil.Staub@windriver.com>
---
 arch/mips/kernel/vbi/wrhv.c |   30 ++++++++++++++++++++++++++++++
 1 files changed, 30 insertions(+), 0 deletions(-)

diff --git a/arch/mips/kernel/vbi/wrhv.c b/arch/mips/kernel/vbi/wrhv.c
index 63323e4..21b1127 100644
--- a/arch/mips/kernel/vbi/wrhv.c
+++ b/arch/mips/kernel/vbi/wrhv.c
@@ -46,6 +46,10 @@ void wrhv_unmask_IPIs_for_vcore(void);
 
 #define VECTORSPACING 0x100
 
+#ifndef NUM_MACS
+#define NUM_MACS 2
+#endif
+
 unsigned long max_asid;
 
 static void get_max_asid(void)
@@ -434,6 +438,32 @@ void __init wrhv_init(void)
 	pv_misc_ops.kernel_thread = wrhv_kernel_thread;
 }
 
+#ifdef CONFIG_CPU_CAVIUM_OCTEON
+#define wrhv_mac_addr_base	octeon_bootinfo->mac_addr_base
+#else
+export __initdata int wrhv_mac_addr_base[NUM_MACS];
+#endif
+
+static int __init wrhv_macaddr_setup(char *str)
+{
+	int i;
+
+	for (i = 0; i < NUM_MACS; i++) {
+		int ret, oct;
+
+		ret = get_option(&str, &oct);
+		if (!ret)
+			break;
+
+		wrhv_mac_addr_base[i] = oct;
+		if (ret != 2)
+			break;
+	}
+	return 1;
+}
+
+__setup("wrhv_macaddr=", wrhv_macaddr_setup);
+
 #ifdef CONFIG_PARAVIRT
 extern void paravirt_init(void);
 #endif
-- 
1.7.0.4

