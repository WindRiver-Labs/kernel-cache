From 640ba9c0149085ae4a0827965cc0f874dcceab63 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Mon, 20 Dec 2010 11:10:29 +0800
Subject: [PATCH 18/38] WRHV: MIPS: Get interrupt state from VB_STATUS in exception return

Since SR doesn't keep any interrupt status info for GOS, so in exception
return, get interrupt status from VB_STATUS instead of saved SR to determine
if reschedule is needed or not.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/kernel/wrhv_entry.S |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/arch/mips/kernel/wrhv_entry.S b/arch/mips/kernel/wrhv_entry.S
index 0e9f996..97060ba 100644
--- a/arch/mips/kernel/wrhv_entry.S
+++ b/arch/mips/kernel/wrhv_entry.S
@@ -58,9 +58,10 @@ need_resched:
 	LONG_L	t0, TI_FLAGS($28)
 	andi	t1, t0, _TIF_NEED_RESCHED
 	beqz	t1, restore_all
-	LONG_L	t0, PT_STATUS(sp)		# Interrupts off?
+	PTR_L	t0, wr_vb_status
+	LONG_L	t0, VB_STATUS_OLD_INT_DISABLE(t0)	# Interrupts off?
 	andi	t0, 1
-	beqz	t0, restore_all
+	bnez	t0, restore_all
 	jal	preempt_schedule_irq
 	b	need_resched
 #endif
-- 
1.6.5.2

