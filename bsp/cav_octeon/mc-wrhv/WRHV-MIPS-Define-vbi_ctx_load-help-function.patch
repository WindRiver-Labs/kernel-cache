From ee5cef7733f935efc87fc069171d9f76a3d3b6f4 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Wed, 23 Feb 2011 10:41:46 +0800
Subject: [PATCH 24/38] WRHV: MIPS: Define vbi_ctx_load help function

vbi_ctx_laod is called once VMMU context is changed to force the
new setting take effect immediately via sending vbiCtxLoad
hypercall.

Setup VB_CONTROL(SR, EPC, V0, interrupt status) so that Hypervisor
can load the correct context.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/kernel/vbi/syscalls.S |   14 +++++++++++++-
 1 files changed, 13 insertions(+), 1 deletions(-)

diff --git a/arch/mips/kernel/vbi/syscalls.S b/arch/mips/kernel/vbi/syscalls.S
index fa842f1..a52d43d 100644
--- a/arch/mips/kernel/vbi/syscalls.S
+++ b/arch/mips/kernel/vbi/syscalls.S
@@ -658,9 +658,21 @@ FUNC_END(vbi_io_apic_ioctl)
  */
 
 FUNC_LABEL(vbi_ctx_load)
+	.set	noat
+	PTR_L	k1, wr_vb_control
+	LONG_S	k0, VB_CONTROL_K0(k1)
+	PTR_L	k0, wr_vb_status
+	LONG_L	k0, VB_STATUS_OLD_INT_DISABLE(k0)
+	LONG_S	k0, VB_CONTROL_NEW_INT_DISABLE(k1)
+	LONG_S	v0, VB_CONTROL_V0(k1)
+	LONG_S	ra, VB_CONTROL_EPC(k1)
+	LONG_L	k0, VB_CONTROL_SR(k1)
+	li	v0, 0xffffffef
+	and	k0, k0, v0
+	ori	k0, 0x8
+	LONG_S	k0, VB_CONTROL_SR(k1)
 	li	v0, VBI_SYS_ctx_load
 	syscall
-	j ra
 	nop
 FUNC_END(vbi_ctx_load)
 
-- 
1.6.5.2

