From bde938e70023b9d4e957caf0d3ae5094d9a64a52 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Thu, 24 Mar 2011 11:21:42 +0800
Subject: [PATCH 6/7] WRHV: MIPS: Call vbi_idle when the current run into idle

Paravirtualize cpu_wait to call vbi_idle to yield the CPU time for
other tasks which can run at that time.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/kernel/cpu-probe.c |    8 ++++++++
 arch/mips/kernel/process.c   |    2 --
 arch/mips/kernel/vbi/wrhv.c  |    5 +++++
 3 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/arch/mips/kernel/cpu-probe.c b/arch/mips/kernel/cpu-probe.c
index 7e1e51b..51d87c2 100644
--- a/arch/mips/kernel/cpu-probe.c
+++ b/arch/mips/kernel/cpu-probe.c
@@ -35,6 +35,10 @@
 void (*cpu_wait)(void);
 EXPORT_SYMBOL(cpu_wait);
 
+#ifdef CONFIG_WRHV
+extern void wrhv_wait(void);
+#endif
+
 static void r3081_wait(void)
 {
 	unsigned long cfg = read_c0_conf();
@@ -165,7 +169,11 @@ void __init check_wait(void)
 	case CPU_BCM6358:
 	case CPU_CAVIUM_OCTEON:
 	case CPU_CAVIUM_OCTEON_PLUS:
+#ifdef CONFIG_WRHV
+		cpu_wait = wrhv_wait;
+#else
 		cpu_wait = r4k_wait;
+#endif
 		break;
 
 	case CPU_RM7000:
diff --git a/arch/mips/kernel/process.c b/arch/mips/kernel/process.c
index b3f1d7c..b273992 100644
--- a/arch/mips/kernel/process.c
+++ b/arch/mips/kernel/process.c
@@ -70,14 +70,12 @@ void __noreturn cpu_idle(void)
 
 			smtc_idle_loop_hook();
 #endif
-#ifndef CONFIG_WRHV
 			if (cpu_wait) {
 				/* Don't trace irqs off for idle */
 				stop_critical_timings();
 				(*cpu_wait)();
 				start_critical_timings();
 			}
-#endif
 		}
 #ifdef CONFIG_HOTPLUG_CPU
 		if (!cpu_online(cpu) && !cpu_isset(cpu, cpu_callin_map) &&
diff --git a/arch/mips/kernel/vbi/wrhv.c b/arch/mips/kernel/vbi/wrhv.c
index 46dd13c..dfce673 100644
--- a/arch/mips/kernel/vbi/wrhv.c
+++ b/arch/mips/kernel/vbi/wrhv.c
@@ -416,6 +416,11 @@ void wrhv_unmask_IPIs_for_vcore(void)
 }
 #endif
  
+void wrhv_wait(void)
+{
+ 	vbi_idle(1);
+}
+ 
 void __init wrhv_init(void)
 {
 	/* initialize wr_config so that we can access
-- 
1.7.0.4

