From 52ac0fbf73d36da0ee691e39ccdcaa51fc77785e Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Tue, 21 Dec 2010 16:54:51 +0800
Subject: [PATCH 21/38] WRHV: MIPS: Call ctx_load VBI via direct syscall instead of function call

Since 'jal' instruction can update ra register, so replace 'jal vbi_ctx_load'
with direct syscall for VBI_SYS_ctx_load.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/include/asm/wrhv_stackframe.h |    4 +++-
 arch/mips/kernel/wrhv_genex.S           |    4 +++-
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/arch/mips/include/asm/wrhv_stackframe.h b/arch/mips/include/asm/wrhv_stackframe.h
index 3291ec3..7295256 100644
--- a/arch/mips/include/asm/wrhv_stackframe.h
+++ b/arch/mips/include/asm/wrhv_stackframe.h
@@ -467,7 +467,9 @@
 		PTR_L	k1, wr_vb_control
 		LONG_S	k0, VB_CONTROL_K0(k1)
 #endif
-		jal	vbi_ctx_load
+		lui	v0, %hi(VBI_SYS_ctx_load)
+		ori	v0, %lo(VBI_SYS_ctx_load)
+		syscall
 		nop
 		.set	mips0
 		.endm
diff --git a/arch/mips/kernel/wrhv_genex.S b/arch/mips/kernel/wrhv_genex.S
index 851017d..508d0ae 100644
--- a/arch/mips/kernel/wrhv_genex.S
+++ b/arch/mips/kernel/wrhv_genex.S
@@ -561,7 +561,9 @@ NESTED(nmi_handler, PT_SIZE, sp)
 	LONG_L	v0, VB_STATUS_V0(k1)
 	LONG_S	v0, VB_CONTROL_V0(k0)
 	.set	mips3
-	jal	vbi_ctx_load
+	lui	v0, %hi(VBI_SYS_ctx_load)
+	ori	v0, %lo(VBI_SYS_ctx_load)
+	syscall
 	nop	
 	.set	mips0
 #endif
-- 
1.6.5.2

