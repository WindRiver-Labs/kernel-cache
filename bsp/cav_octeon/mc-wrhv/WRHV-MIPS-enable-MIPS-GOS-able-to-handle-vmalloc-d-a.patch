From d4ffb5e2926041c17c0a889739ba864ca808e915 Mon Sep 17 00:00:00 2001
From: Liang Li <liang.li@windriver.com>
Date: Fri, 15 Apr 2011 10:46:08 +0800
Subject: [PATCH] WRHV: MIPS: enable MIPS GOS able to handle vmalloc'd addresses

o fixed a typo in vmalloc address range definition
o copy page table entries from init_mm to page table of
userspace processes for vmalloc'd addresses then hypervisor
could handle TLB issue for xsseg addresses

Signed-off-by: Liang Li <liang.li@windriver.com>
Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/include/asm/pgtable-64.h |    2 +-
 arch/mips/mm/fault.c               |   22 ++++++++++++++++++++++
 2 files changed, 23 insertions(+), 1 deletions(-)

diff --git a/arch/mips/include/asm/pgtable-64.h b/arch/mips/include/asm/pgtable-64.h
index ab9cdcb..8dc8135 100644
--- a/arch/mips/include/asm/pgtable-64.h
+++ b/arch/mips/include/asm/pgtable-64.h
@@ -127,7 +127,7 @@
  */
 #ifdef CONFIG_WRHV
 #define VMALLOC_START		(MAP_BASE + (2 * PAGE_SIZE) + 0x100000000UL)
-#define VMALLOC_END		0x400000001fffffff
+#define VMALLOC_END		(MAP_BASE + 0x1ffffffffUL)
 #else
 #define VMALLOC_START		(MAP_BASE + (2 * PAGE_SIZE))
 #define VMALLOC_END	\
diff --git a/arch/mips/mm/fault.c b/arch/mips/mm/fault.c
index 499d3e2..49eb415 100644
--- a/arch/mips/mm/fault.c
+++ b/arch/mips/mm/fault.c
@@ -70,6 +70,11 @@ asmlinkage void do_page_fault(struct pt_regs *regs, unsigned long write,
 # define VMALLOC_FAULT_TARGET vmalloc_fault
 #endif
 
+#ifdef CONFIG_WRHV
+#undef   VMALLOC_FAULT_TARGET
+# define VMALLOC_FAULT_TARGET wrhv_vmalloc_fault
+#endif
+
 	if (unlikely(address >= VMALLOC_START && address <= VMALLOC_END))
 		goto VMALLOC_FAULT_TARGET;
 #ifdef MODULE_START
@@ -281,4 +286,21 @@ vmalloc_fault:
 		return;
 	}
 #endif
+wrhv_vmalloc_fault:
+	{
+		pgd_t *upd, *pgd;
+		pgd_t *v_start, *v_end;
+
+		pgd = (pgd_t *)pgd_current[raw_smp_processor_id()];
+
+		v_start = pgd_offset_k(VMALLOC_START);
+		v_end   = pgd_offset_k(VMALLOC_END);
+
+		upd = pgd + pgd_index(VMALLOC_START);
+
+		memcpy(upd, v_start, ((phys_addr_t)v_end - 
+				(phys_addr_t)v_start + 1) * sizeof(pgd_t));
+
+		return;
+	}
 }
-- 
1.7.0.4

