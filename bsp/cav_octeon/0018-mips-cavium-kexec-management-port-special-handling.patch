From d0e1113b7784960c82f818adeba4748cb4b091d6 Mon Sep 17 00:00:00 2001
From: auto commit <unknown@unknown>
Date: Thu, 24 Sep 2009 23:47:14 -0700
Subject: [PATCH] mips/cavium: kexec management port special handling

For cavium targets where the management port is used for booting
kexec fails to mount the rootfs.  The management ports require
some special handling and notification to correctly re-initialize
after a kexec.  If a kexec has just occurred, the mac address
for the mgmt port will be derived from the bootinfo, rather than
being set later by the interface initialization.

Signed-off-by: Greg Moffatt <greg.moffatt@windriver.com>
Signed-off-by: Phil Staub <Phil.Staub@windriver.com>
---
 arch/mips/cavium-octeon/executive/cvmx-mgmt-port.c |   19 +++++++++++++++++--
 1 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/executive/cvmx-mgmt-port.c b/arch/mips/cavium-octeon/executive/cvmx-mgmt-port.c
index f40cb8c..c86e863 100644
--- a/arch/mips/cavium-octeon/executive/cvmx-mgmt-port.c
+++ b/arch/mips/cavium-octeon/executive/cvmx-mgmt-port.c
@@ -121,6 +121,7 @@ cvmx_mgmt_port_result_t cvmx_mgmt_port_initialize(int port)
     char *alloc_name = "cvmx_mgmt_port";
     cvmx_mixx_oring1_t oring1;
     cvmx_mixx_ctl_t mix_ctl;
+    uint64_t *prev_mac;
 
     if ((port < 0) || (port >= __cvmx_mgmt_port_num_ports()))
         return CVMX_MGMT_PORT_INVALID_PARAM;
@@ -142,6 +143,9 @@ cvmx_mgmt_port_result_t cvmx_mgmt_port_initialize(int port)
         }
     }
 
+    /* see if we stored a MAC from a previous kernel */
+    prev_mac = cvmx_bootmem_find_named_block("kexec_previous_mac");
+
     /* Reset the MIX block if the previous user had a different TX ring size, or if
     ** we allocated a new (and blank) state structure. */
     mix_ctl.u64 = cvmx_read_csr(CVMX_MIXX_CTL(port));
@@ -199,8 +203,19 @@ cvmx_mgmt_port_result_t cvmx_mgmt_port_initialize(int port)
             state->phy_id = port;  /* Will need to be change to match the board */
 
         /* Create a default MAC address */
-        state->mac = 0x000000dead000000ull;
-        state->mac += 0xffffff & CAST64(state);
+		if(prev_mac) {
+			/* get the mac from the bootinfo */
+			cvmx_sysinfo_t *sysinfo = cvmx_sysinfo_get();
+			state->mac = 0ull;
+			for(i=0; i < 6; i++) {
+				state->mac = state->mac << 8;
+				state->mac += (uint64_t)sysinfo->mac_addr_base[i];
+			}
+			cvmx_bootmem_free_named("kexec_previous_mac");
+		} else {
+			state->mac = 0x000000dead000000ull;
+			state->mac += 0xffffff & CAST64(state);
+		}
 
         /* Setup the TX ring */
         for (i=0; i<CVMX_MGMT_PORT_NUM_TX_BUFFERS; i++)
-- 
1.5.5.1

