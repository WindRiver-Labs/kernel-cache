From fbe78b898fb129b1e78e7c3384046e1d8495be23 Mon Sep 17 00:00:00 2001
From: Phil Staub <Phil.Staub@windriver.com>
Date: Mon, 4 Apr 2011 12:03:43 -0700
Subject: [PATCH 3/5] WRHV: Cavium: Replace virt_to_phys w/ Hyp translation

virt_to_phys does not provide the correct translation in a virtual
board. Use vbi_get_guest_dma_addr instead.

Signed-off-by: Phil Staub <Phil.Staub@windriver.com>
---
 arch/mips/cavium-octeon/dma-octeon.c |   18 ++++++++++++++++--
 1 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/arch/mips/cavium-octeon/dma-octeon.c b/arch/mips/cavium-octeon/dma-octeon.c
index a999a6e..7843eaa 100644
--- a/arch/mips/cavium-octeon/dma-octeon.c
+++ b/arch/mips/cavium-octeon/dma-octeon.c
@@ -49,18 +49,32 @@ static struct bar1_index_state bar1_state[32];
 dma_addr_t octeon_map_dma_mem(struct device *dev, void *ptr, size_t size)
 {
 #ifndef CONFIG_PCI
+#ifdef CONFIG_WRHV
+	u64 paddr;
+#endif
 	/* Without PCI/PCIe this function can be called for Octeon internal
 	   devices such as USB. These devices all support 64bit addressing */
 	mb();
-	return virt_to_phys(ptr);
+#ifdef CONFIG_WRHV
+	vbi_get_guest_dma_addr((void *)ptr, &paddr);
+	return (dma_addr_t)paddr;
 #else
+	return virt_to_phys(ptr);
+#endif
+#else /* CONFIG_PCI */
 	unsigned long flags;
 	uint64_t dma_mask;
 	int64_t start_index;
 	dma_addr_t result = -1;
-	uint64_t physical = virt_to_phys(ptr);
+	uint64_t physical;
 	int64_t index;
 
+#ifdef CONFIG_WRHV
+	vbi_get_guest_dma_addr((void *)ptr, &physical);
+#else
+	physical = virt_to_phys(ptr);
+#endif
+
 	mb();
 	/*
 	 * Use the DMA masks to determine the allowed memory
-- 
1.7.0.4

