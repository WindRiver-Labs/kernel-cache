From 084a6786510c07da9d80e85bef5553fb339de131 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Fri, 25 Feb 2011 12:46:10 +0800
Subject: [PATCH 15/30] WRHV: Cavium: Define GOS specific read_current_timer

Since GOS can access CP0 count register, so read current timer from
VB_CONFIG timestamp instead of CP0 count register.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 .../asm/mach-cavium-octeon/cpu-feature-overrides.h |    2 ++
 arch/mips/kernel/vbi/wrhv.c                        |    7 +++++++
 2 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h b/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h
index bb37d51..76ff3b2 100644
--- a/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h
+++ b/arch/mips/include/asm/mach-cavium-octeon/cpu-feature-overrides.h
@@ -82,6 +82,7 @@
 #define spin_lock_prefetch(x) prefetch(x)
 #define PREFETCH_STRIDE 128
 
+#ifndef CONFIG_WRHV
 static inline int read_current_timer(unsigned long *result)
 {
 	asm volatile ("rdhwr %0,$31\n"
@@ -91,6 +92,7 @@ static inline int read_current_timer(unsigned long *result)
 		      : "=r" (*result));
 	return 0;
 }
+#endif
 
 static inline int octeon_has_saa(void)
 {
diff --git a/arch/mips/kernel/vbi/wrhv.c b/arch/mips/kernel/vbi/wrhv.c
index 7c2612d..223a98f 100644
--- a/arch/mips/kernel/vbi/wrhv.c
+++ b/arch/mips/kernel/vbi/wrhv.c
@@ -20,6 +20,7 @@
 #include <linux/interrupt.h>
 #include <linux/clockchips.h>
 #include <linux/clocksource.h>
+#include <linux/timex.h>
 #include <linux/bootmem.h>
 #include <linux/proc_fs.h>
 #include <linux/swap.h>
@@ -827,6 +828,12 @@ void __init wrhv_plat_mem_setup(void)
 #endif /* CONFIG_CAVIUM_RESERVE32 */
 }
 
+int read_current_timer(unsigned long *timer_val)
+{
+	*timer_val = (unsigned long) VBI_TICK_COUNT_GET();
+	return 0;
+}
+
 void __init wrhv_init(void)
 {
 	/* initialize wr_config so that we can access
-- 
1.7.3

