From 1900f4e675364c430c9d4927e700d4752b077382 Mon Sep 17 00:00:00 2001
From: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
Date: Tue, 24 May 2011 16:24:03 -0400
Subject: [PATCH 2/2] WRHV/cavium: Bootline NIC infastructure

Basic infastructure needed to incrementatlly populate NIC mac addresses.

Signed-off-by: Jeremy McNicoll <jeremy.mcnicoll@windriver.com>
---
 arch/mips/kernel/vbi/wrhv.c |   39 ++++++++++++++++++++++++++++++++++++++-
 1 files changed, 38 insertions(+), 1 deletions(-)

diff --git a/arch/mips/kernel/vbi/wrhv.c b/arch/mips/kernel/vbi/wrhv.c
index 0c9839c..a5f7834 100644
--- a/arch/mips/kernel/vbi/wrhv.c
+++ b/arch/mips/kernel/vbi/wrhv.c
@@ -73,6 +73,10 @@ extern void pci_console_init(const char *arg);
 #define NUM_MACS 2
 #endif
 
+char wrhv_net_name[15]; /* eth0, eth1, eth2, mgmt0, mgmt1, ... */
+int wrhv_nic_num = 0; /* start with eth0 as default */
+int wrhv_nic_start = 0;
+
 extern unsigned long long MAX_MEMORY;
 extern char __initdata rd_name[64];
 
@@ -969,8 +973,41 @@ static int __init wrhv_macaddr_setup(char *str)
 	}
 	return 1;
 }
+__setup("ifmacaddr=", wrhv_macaddr_setup);
+
+#define WRHV_IF_NAME 7 /* sizeof(ifname) */
+#define ETH_LENGTH   4 /* length of eth */
+static int __init wrhv_net_name_setup(void)
+{
+	char *p = NULL;
+
+	if ((p = strstr(arcs_cmdline, "ifname=")) != NULL) {
+		printk(KERN_INFO, "WRHV: replacing MAC address for %s\n", p);
+		/* First occurance of ifname= in the bootline. Only copy 1
+		"ethX" for now */
+		strncpy(wrhv_net_name, p + WRHV_IF_NAME, ETH_LENGTH);
+		wrhv_nic_start = p[WRHV_IF_NAME + ETH_LENGTH-1] - 0x30;
+		return 1;
+	}
+	return 0;
+}
+__setup("ifname=", wrhv_net_name_setup);
+
+/* How many nics are we setting up? */
+#define WRHV_IFNIC_SIZE 7
+static int __init wrhv_net_num_setup(void)
+{
+	char *p = NULL;
+
+	if ((p = strstr(arcs_cmdline, "ifnics=")) != NULL) {
+		wrhv_nic_num = p[WRHV_IFNIC_SIZE] - 0x30;
+		return 1;
+	}
+	return 0;
+}
+__setup("ifnics=", wrhv_net_num_setup);
+
 
-__setup("wrhv_macaddr=", wrhv_macaddr_setup);
 
 #ifdef CONFIG_PARAVIRT
 extern void paravirt_init(void);
-- 
1.6.5.2

