From 437de10d4d2d76e810f4398ca6eabb28e7ee84a8 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Wed, 23 Mar 2011 13:49:50 +0800
Subject: [PATCH 2/5] WRHV: Cavium: Make early bootstrap SMP safe

On SMP, boot core goes the different bootstrap path from secondary
cores, so get the current core id to select the proper early
bootstrap path for the different cores.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 .../mach-cavium-octeon/wrhv-kernel-entry-init.h    |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/arch/mips/include/asm/mach-cavium-octeon/wrhv-kernel-entry-init.h b/arch/mips/include/asm/mach-cavium-octeon/wrhv-kernel-entry-init.h
index f9d6d81..7063ade 100644
--- a/arch/mips/include/asm/mach-cavium-octeon/wrhv-kernel-entry-init.h
+++ b/arch/mips/include/asm/mach-cavium-octeon/wrhv-kernel-entry-init.h
@@ -16,12 +16,22 @@
 #ifndef __ASM_MACH_CAVIUM_OCTEON_WRHV_KERNEL_ENTRY_H
 #define __ASM_MACH_CAVIUM_OCTEON_WRHV_KERNEL_ENTRY_H
 
+#define WRHV_COREID_OFFSET	0x98
+#define VB_CONFIG_ADDR		0xFFFFFFFFD0000000
+
 .macro  kernel_entry_setup
 	.set push
 	.set arch=octeon
+#ifdef CONFIG_SMP
+	li	v0, VB_CONFIG_ADDR
+	lw	v0, WRHV_COREID_OFFSET(v0)
 	# Jump the master to kernel_entry
+	beq	v0, zero, octeon_main_processor
+	nop
+#else
 	b	octeon_main_processor
 	nop
+#endif
 
 #ifdef CONFIG_SMP
 
-- 
1.7.0.4

