From b04e3a41cc3cef872b3d3dfca20d4df06959ad5a Mon Sep 17 00:00:00 2001
From: Phil Staub <Phil.Staub@windriver.com>
Date: Wed, 6 Apr 2011 17:28:47 -0700
Subject: [PATCH 5/5] WRHV: Cavium: Replace call to read_c0_cvmcount()

The read_c0_cvmcount macro ultimately uses a dmfc0 instruction, which
is prohibited in supervisor mode (where the GOS runs). Replace this
macro with read_current_timer(), which, when CONFIG_WRHV is defined,
accesses VBI_TICK_COUNT_GET() instead.

Signed-off-by: Phil Staub <Phil.Staub@windriver.com>
---
 arch/mips/cavium-octeon/csrc-octeon.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/arch/mips/cavium-octeon/csrc-octeon.c b/arch/mips/cavium-octeon/csrc-octeon.c
index f671d93..6ad3f48 100644
--- a/arch/mips/cavium-octeon/csrc-octeon.c
+++ b/arch/mips/cavium-octeon/csrc-octeon.c
@@ -197,7 +197,11 @@ void octeon_io_clk_delay(unsigned long count)
 {
 	u64 cur, end;
 
+#ifdef CONFIG_WRHV
+	read_current_timer((long unsigned int *)&cur);
+#else
 	cur = read_c0_cvmcount();
+#endif
 	if (rdiv != 0) {
 		end = count * rdiv;
 		if (f != 0) {
@@ -212,6 +216,10 @@ void octeon_io_clk_delay(unsigned long count)
 		end = cur + count;
 	}
 	while (end > cur)
+#ifdef CONFIG_WRHV
+		read_current_timer((long unsigned int *)&cur);
+#else
 		cur = read_c0_cvmcount();
+#endif
 }
 EXPORT_SYMBOL(octeon_io_clk_delay);
-- 
1.7.0.4

