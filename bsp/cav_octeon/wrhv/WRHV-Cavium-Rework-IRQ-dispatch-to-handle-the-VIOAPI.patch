From bbf4f42b7d61aa1859cbae5df526e47d4e64b108 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Wed, 23 Mar 2011 13:20:54 +0800
Subject: [PATCH 5/5] WRHV: Cavium: Rework IRQ dispatch to handle the VIOAPIC interrupts

For the interrupts come from VIOAPIC, need get the pending IRQ
number from VB_CONTROL, and need recheck if there is more coming
interrupts when handling the interrupt otherwise some interrupts
will be dropped inadvertently.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/mips/kernel/vbi/wrhv.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/arch/mips/kernel/vbi/wrhv.c b/arch/mips/kernel/vbi/wrhv.c
index 8fc33de..0003912 100644
--- a/arch/mips/kernel/vbi/wrhv.c
+++ b/arch/mips/kernel/vbi/wrhv.c
@@ -815,8 +815,17 @@ asmlinkage void wrhv_plat_irq_dispatch(void)
 {
 	uint64_t irq;
 
+check_again:
+	irq = wr_vb_control->irq_pend;
+	if (irq != 0xffff) {
+		wr_vb_control->irq_pend = 0xffff;
+		do_IRQ(irq);
+		goto check_again;
+	}
+
 	irq = wr_vb_status->vb_status_regs.ciu_sum;
 
+	/* Timer interrupt */
 	if (irq & CVM_CIU_INT_SUM_TIM0)
 		do_IRQ(0);
 
-- 
1.7.0.4

