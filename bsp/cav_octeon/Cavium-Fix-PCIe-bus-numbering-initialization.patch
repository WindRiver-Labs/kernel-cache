From 296115d13dd36b33c1448f1283da2b6269d6b5ee Mon Sep 17 00:00:00 2001
From: Phil Staub <Phil.Staub@windriver.com>
Date: Thu, 10 Mar 2011 11:38:33 -0800
Subject: [PATCH 06/13] Cavium: Fix PCIe bus numbering initialization

Source: Cavium sdk_2.0.0_updates_p4.tgz

Correct initialization of bus_number when bus->parent == NULL, and only
do the initialization in octeon_pcie_read_config() rather than in
octeon_pcie_write_config().

Signed-off-by: Phil Staub <Phil.Staub@windriver.com>
Signed-off-by: ltian <le.tian@windriver.com>
---
 arch/mips/pci/pcie-octeon.c |   28 +++++++++++++++-------------
 1 files changed, 15 insertions(+), 13 deletions(-)

diff --git a/arch/mips/pci/pcie-octeon.c b/arch/mips/pci/pcie-octeon.c
index 88f98a7..bfaa556 100644
--- a/arch/mips/pci/pcie-octeon.c
+++ b/arch/mips/pci/pcie-octeon.c
@@ -87,12 +87,21 @@ static inline int octeon_pcie_read_config(int pcie_port, struct pci_bus *bus,
 	union octeon_cvmemctl cvmmemctl_save;
 	int bus_number = bus->number;
 
-	/*
-	 * For the top level bus make sure our hardware bus number
-	 * matches the software one.
-	 */
-	if (bus->parent == NULL)
-		bus_number = 0;
+	/* For the top level bus make sure our hardware bus number matches the
+		software one */
+	if (bus->parent == NULL) {
+		cvmx_pciercx_cfg006_t pciercx_cfg006;
+		pciercx_cfg006.u32 = cvmx_pcie_cfgx_read(pcie_port,
+			CVMX_PCIERCX_CFG006(pcie_port));
+		if (pciercx_cfg006.s.pbnum != bus_number) {
+			pciercx_cfg006.s.pbnum = bus_number;
+			pciercx_cfg006.s.sbnum = bus_number;
+			pciercx_cfg006.s.subbnum = bus_number;
+			cvmx_pcie_cfgx_write(pcie_port,
+				CVMX_PCIERCX_CFG006(pcie_port),
+				pciercx_cfg006.u32);
+		}
+	}
 
 	/*
 	 * PCIe only has a single device connected to Octeon. It is
@@ -249,13 +258,6 @@ static inline int octeon_pcie_write_config(int pcie_port, struct pci_bus *bus,
 	int bus_number = bus->number;
 
 	/*
-	 * We need to force the bus number to be zero on the root bus. Linux
-	 * numbers the 2nd root bus to start after all busses on root 0.
-	 */
-	if (bus->parent == NULL)
-		bus_number = 0;
-
-	/*
 	pr_debug("octeon_pcie_write_config(pcie_port=%d, bus=%d, devfn=0x%x,\
 		 reg=0x%x, size=%d, val=0x%x)\n",
 		 pcie_port, bus_number, devfn, reg, size, val);
-- 
1.7.0.4

