From e0369e1881f468aaebe634348467a402dbb18596 Mon Sep 17 00:00:00 2001
From: ltian <le.tian@windriver.com>
Date: Mon, 15 Nov 2010 14:15:45 +0800
Subject: [PATCH 080/132] MIPS: Octeon: RapidIO: Fix incorrect port to mailbox mappings.

The code connecting IPD port number to SRIO mailboxes was
incorrect. The new code correctly connects the proper IPD and PKO
ports and queues based on SRIO mailbox number.

Signed-off-by: Chad Reese <kreese@caviumnetworks.com>
Signed-off-by: ltian <le.tian@windriver.com>
---
 drivers/net/octeon/ethernet.c |   10 ++++++----
 1 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/drivers/net/octeon/ethernet.c b/drivers/net/octeon/ethernet.c
index 4a85591..66538c4 100644
--- a/drivers/net/octeon/ethernet.c
+++ b/drivers/net/octeon/ethernet.c
@@ -865,17 +865,19 @@ static int __init cvm_oct_init_module(void)
 			priv->imode = imode;
 
 			if (imode == CVMX_HELPER_INTERFACE_MODE_SRIO) {
+				int mbox = port - cvmx_helper_get_ipd_port(interface, 0);
 				cvmx_srio_tx_message_header_t tx_header;
 				tx_header.u64 = 0;
 				tx_header.s.tt = 1;
 				tx_header.s.ssize = 0xe;
-				tx_header.s.mbox = port;
+				tx_header.s.mbox = mbox;
 				tx_header.s.lns = 1;
+				tx_header.s.intr = 1;
 				priv->srio_tx_header = tx_header.u64;
-				priv->port = cvmx_helper_get_ipd_port(interface, port >> 1);
-				base_queue = cvmx_pko_get_base_queue(priv->port) + (port & 1);
+				priv->port = cvmx_helper_get_ipd_port(interface, mbox >> 1);
+				base_queue = cvmx_pko_get_base_queue(priv->port) + (mbox & 1);
 				priv->num_tx_queues = 1;
-				cvm_oct_by_srio_mbox[interface - 4][port] = priv;
+				cvm_oct_by_srio_mbox[interface - 4][mbox] = priv;
 			} else {
 				priv->port = port;
 				base_queue = cvmx_pko_get_base_queue(priv->port);
-- 
1.6.5.2

