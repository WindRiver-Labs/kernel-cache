From c977bd08ea7d09fa542bdc0d27eb36aa0a00e758 Mon Sep 17 00:00:00 2001
From: ltian <le.tian@windriver.com>
Date: Fri, 12 Nov 2010 15:24:58 +0800
Subject: [PATCH 042/132] Cavium: Probe for presence of Core-14445 workaround

Octeon II pass 1 parts require a workaround for a prefetch
issue. Panic if not in place.

Signed-off-by: ltian <le.tian@windriver.com>
---
 arch/mips/cavium-octeon/setup.c |   27 ++++++++++++++++++++++++++-
 1 files changed, 26 insertions(+), 1 deletions(-)

diff --git a/arch/mips/cavium-octeon/setup.c b/arch/mips/cavium-octeon/setup.c
index 25e6a9c..77b7979 100644
--- a/arch/mips/cavium-octeon/setup.c
+++ b/arch/mips/cavium-octeon/setup.c
@@ -1124,8 +1124,33 @@ EXPORT_SYMBOL(prom_putchar);
 
 void prom_free_prom_memory(void)
 {
+        if (current_cpu_type() == CPU_CAVIUM_OCTEON2) {
+                /* Check for presence of Core-14445 fix.  */
+                u32 insn;
+                u32 *foo;
+ 
+                foo = &insn;
+
+                asm volatile("# before" : : : "memory");
+                prefetch(foo);
+                asm volatile(
+                        ".set push\n\t"
+                        ".set noreorder\n\t"
+                        "bal 1f\n\t"
+                        "nop\n"
+                        "1:\tlw %0,-12($31)\n\t"
+                        ".set pop\n\t"
+                        : "=r" (insn) : : "$31", "memory");
+
+                if ((insn >> 26) != 0x33)
+                        panic("No PREF instruction at Core-14449 probe point.\n");
+ 
+                if (((insn >> 16) & 0x1f) != 28)
+                        panic("Core-14449 WAR not in place (%04x).\n"
+                                "Please build kernel with proper options (CONFIG_CAVIUM_OCTEON2).\n", insn);
+        }
 #ifdef CONFIG_CAVIUM_DECODE_RSL
-	/* Add an interrupt handler for general failures. */
+ 	/* Add an interrupt handler for general failures. */
 	if (request_irq(OCTEON_IRQ_RML, octeon_rml_interrupt, IRQF_SHARED,
                         "RML_RSL", octeon_rml_interrupt)) {	
  		panic("Unable to request_irq(OCTEON_IRQ_RML)\n");
-- 
1.6.5.2

