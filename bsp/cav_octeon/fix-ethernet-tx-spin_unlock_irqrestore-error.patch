From 6157ab28bb57150adae1d7256da86233e7ffa7d5 Mon Sep 17 00:00:00 2001
From: weixing shi <Weixing.Shi@windriver.com>
Date: Fri, 8 Apr 2011 10:30:37 +0800
Subject: [PATCH] fix ethernet-tx spin_unlock_irqrestore error

spin_lock_irqsave and spin_unlock_irqrestore lost brackets.

Signed-off-by: weixing shi <Weixing.Shi@windriver.com>
---
 drivers/net/cavium-ethernet/ethernet-tx.c |   13 +++++++------
 1 files changed, 7 insertions(+), 6 deletions(-)

diff --git a/drivers/net/cavium-ethernet/ethernet-tx.c b/drivers/net/cavium-ethernet/ethernet-tx.c
index 8dd9e64..5cc4825 100644
--- a/drivers/net/cavium-ethernet/ethernet-tx.c
+++ b/drivers/net/cavium-ethernet/ethernet-tx.c
@@ -315,14 +315,15 @@ dont_put_skbuff_in_hw:
 		dropped = 1;
 	}
 	/* Send the packet to the output queue */
-	else
-	spin_lock_irqsave(&(priv->oct_tx_lock), flags);
-	if (unlikely(cvmx_pko_send_packet_finish(priv->port, priv->queue + qos, pko_command, hw_buffer, CVMX_PKO_LOCK_NONE))) {
-		DEBUGPRINT("%s: Failed to send the packet\n", dev->name);
-		dropped = 1;
+	else{
+		spin_lock_irqsave(&(priv->oct_tx_lock), flags);
+		if (unlikely(cvmx_pko_send_packet_finish(priv->port, priv->queue + qos, pko_command, hw_buffer, CVMX_PKO_LOCK_NONE))) {
+			DEBUGPRINT("%s: Failed to send the packet\n", dev->name);
+			dropped = 1;
+		}
+		spin_unlock_irqrestore(&(priv->oct_tx_lock), flags);
 	}
 
-	spin_unlock_irqrestore(&(priv->oct_tx_lock), flags);
 	if (USE_ASYNC_IOBDMA) {
 		/* Restore the scratch area */
 		cvmx_scratch_write64(CVMX_SCR_SCRATCH, old_scratch);
-- 
1.7.0.2

