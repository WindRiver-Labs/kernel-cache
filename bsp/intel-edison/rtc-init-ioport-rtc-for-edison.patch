From d972dc948f4619ef5dcf789279545b192826d904 Mon Sep 17 00:00:00 2001
From: Liwei Song <liwei.song@windriver.com>
Date: Fri, 6 May 2016 05:48:57 -0400
Subject: [PATCH] rtc: init ioport rtc for edison

Patch from yocto Intel Edison support:
http://downloadmirror.intel.com/25028/eng/edison-src-ww25.5-15.tgz

Intel Edison doesn't have vRTC, but have ioport rtc,
this patch use to init ioport rtc on edison board.

Signed-off-by: Liwei Song <liwei.song@windriver.com>
---
 arch/x86/kernel/rtc.c |   35 +++++++++++++++++++++++++++++++++--
 1 files changed, 33 insertions(+), 2 deletions(-)

diff --git a/arch/x86/kernel/rtc.c b/arch/x86/kernel/rtc.c
index ca9622a..aed810f 100644
--- a/arch/x86/kernel/rtc.c
+++ b/arch/x86/kernel/rtc.c
@@ -14,6 +14,7 @@
 #include <asm/time.h>
 #include <asm/intel-mid.h>
 #include <asm/rtc.h>
+#include <asm/io_apic.h>
 
 #ifdef CONFIG_X86_32
 /*
@@ -146,6 +147,27 @@ void read_persistent_clock(struct timespec *ts)
 	x86_platform.get_wallclock(ts);
 }
 
+static int handle_mrfl_dev_ioapic(int irq)
+{
+       int ret = 0;
+       int ioapic;
+       struct io_apic_irq_attr irq_attr;
+
+       ioapic = mp_find_ioapic(irq);
+       if (ioapic >= 0) {
+               irq_attr.ioapic = ioapic;
+               irq_attr.ioapic_pin = irq;
+               irq_attr.trigger = 1;
+               irq_attr.polarity = 0; /* Active high */
+               io_apic_set_pci_routing(NULL, irq, &irq_attr);
+       } else {
+               pr_warn("can not find interrupt %d in ioapic\n", irq);
+               ret = -EINVAL;
+       }
+
+       return ret;
+}
+
 
 static struct resource rtc_resources[] = {
 	[0] = {
@@ -169,6 +191,8 @@ static struct platform_device rtc_device = {
 
 static __init int add_rtc_cmos(void)
 {
+       int ret;
+
 #ifdef CONFIG_PNP
 	static const char * const  const ids[] __initconst =
 	    { "PNP0b00", "PNP0b01", "PNP0b02", };
@@ -188,10 +212,17 @@ static __init int add_rtc_cmos(void)
 	if (of_have_populated_dt())
 		return 0;
 
-	/* Intel MID platforms don't have ioport rtc */
-	if (intel_mid_identify_cpu())
+	/* Intel MID platforms don't have ioport rtc
+	 * except Tangier platform, which doesn't have vRTC
+	 */
+	if (intel_mid_identify_cpu() &&
+		intel_mid_identify_cpu() != INTEL_MID_CPU_CHIP_TANGIER)
 		return -ENODEV;
 
+	ret = handle_mrfl_dev_ioapic(RTC_IRQ);
+	if (ret)
+		return ret;
+
 #ifdef CONFIG_ACPI
 	if (acpi_gbl_FADT.boot_flags & ACPI_FADT_NO_CMOS_RTC) {
 		/* This warning can likely go away again in a year or two. */
-- 
1.7.5.4

