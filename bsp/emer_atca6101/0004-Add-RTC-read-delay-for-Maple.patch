From ac967d620fc9fab99da86145ba5193501a9365c7 Mon Sep 17 00:00:00 2001
Message-Id: <ac967d620fc9fab99da86145ba5193501a9365c7.1224568101.git.weiwei.wang@windriver.com>
In-Reply-To: <f05fc30d72d7287662a889ddd870105998b697dc.1224568101.git.weiwei.wang@windriver.com>
References: <f05fc30d72d7287662a889ddd870105998b697dc.1224568101.git.weiwei.wang@windriver.com>
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Tue, 21 Oct 2008 13:47:09 +0800
Subject: [PATCH 4/5] Add RTC read delay for Maple

maple_time_init is introduced to create a delay observed to be required
on some maple targets in reading the clock.

Signed-off-by: Amy Fong <amy.fong@windriver.com>
Integrated-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/powerpc/platforms/maple/time.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/maple/time.c b/arch/powerpc/platforms/maple/time.c
index 80c0fe4..ad74c9a 100644
--- a/arch/powerpc/platforms/maple/time.c
+++ b/arch/powerpc/platforms/maple/time.c
@@ -42,6 +42,7 @@
 #endif
 
 static int maple_rtc_addr;
+static int maple_time_init;
 
 static int maple_clock_read(int addr)
 {
@@ -59,6 +60,11 @@ void maple_get_rtc_time(struct rtc_time *tm)
 {
 	int century = 0;
 
+	if (maple_time_init)
+		mdelay(5);
+	else
+		maple_time_init = 1;
+
 	do {
 		tm->tm_sec = maple_clock_read(RTC_SECONDS);
 		tm->tm_min = maple_clock_read(RTC_MINUTES);
-- 
1.5.5.1

