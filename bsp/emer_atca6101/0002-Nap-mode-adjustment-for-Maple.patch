From d93dde898f9ef04d3c269faa40339947d1b70e8b Mon Sep 17 00:00:00 2001
Message-Id: <d93dde898f9ef04d3c269faa40339947d1b70e8b.1224568101.git.weiwei.wang@windriver.com>
In-Reply-To: <f05fc30d72d7287662a889ddd870105998b697dc.1224568101.git.weiwei.wang@windriver.com>
References: <f05fc30d72d7287662a889ddd870105998b697dc.1224568101.git.weiwei.wang@windriver.com>
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Tue, 21 Oct 2008 13:45:34 +0800
Subject: [PATCH 2/5] Nap mode adjustment for Maple

Signed-off-by: Amy Fong <amy.fong@windriver.com>
Integrated-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/powerpc/Kconfig               |    8 ++++++++
 arch/powerpc/kernel/idle_power4.S  |    2 ++
 arch/powerpc/kernel/setup-common.c |    3 +++
 3 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/Kconfig b/arch/powerpc/Kconfig
index 6f4c635..84828c6 100644
--- a/arch/powerpc/Kconfig
+++ b/arch/powerpc/Kconfig
@@ -106,6 +106,14 @@ config GENERIC_GPIO
 config ARCH_NO_VIRT_TO_BUS
 	def_bool PPC64
 
+config PPC_MAPLE_NAP_MODE
+	depends on PPC_MAPLE
+	bool "Nap (sleep) mode for Maple 970FX board"
+	default n
+	help
+	  This option enables nap mode for the Maple 970FX board.
+	  Currently this mode has a stability issue (hardware related), so it is off by default.
+
 config PPC
 	bool
 	default y
diff --git a/arch/powerpc/kernel/idle_power4.S b/arch/powerpc/kernel/idle_power4.S
index 5328709..d540af8 100644
--- a/arch/powerpc/kernel/idle_power4.S
+++ b/arch/powerpc/kernel/idle_power4.S
@@ -30,6 +30,7 @@ END_FTR_SECTION_IFCLR(CPU_FTR_CAN_NAP)
 	beqlr
 
 	/* Go to NAP now */
+#if !defined(CONFIG_PPC_MAPLE) || defined(CONFIG_PPC_MAPLE_NAP_MODE)
 	mfmsr	r7
 	rldicl	r0,r7,48,1
 	rotldi	r0,r0,16
@@ -52,6 +53,7 @@ END_FTR_SECTION_IFSET(CPU_FTR_ALTIVEC)
 	mtmsrd	r7
 	isync
 	b	1b
+#endif /* CONFIG_PPC_MAPLE_NAP MODE */
 
 _GLOBAL(power4_cpu_offline_powersave)
 	/* Go to NAP now */
diff --git a/arch/powerpc/kernel/setup-common.c b/arch/powerpc/kernel/setup-common.c
index 9cc5a52..cf44b07 100644
--- a/arch/powerpc/kernel/setup-common.c
+++ b/arch/powerpc/kernel/setup-common.c
@@ -180,6 +180,9 @@ static int show_cpuinfo(struct seq_file *m, void *v)
 		seq_printf(m, "timebase\t: %lu\n", ppc_tb_freq);
 		if (ppc_md.name)
 			seq_printf(m, "platform\t: %s\n", ppc_md.name);
+#ifdef CONFIG_PPC_MAPLE
+		seq_printf(m, "machine\t\t: ATCA6101\n");
+#endif
 		root = of_find_node_by_path("/");
 		if (root)
 			model = of_get_property(root, "model", NULL);
-- 
1.5.5.1

