From ff83090eca2679b6e6f7341c766b47a54aeeafd8 Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Tue, 23 Apr 2013 11:38:18 +0800
Subject: [PATCH 55/66] i2c-qup: add a module parameter to set i2c freq

module parameter i2c_clk_freq is added, user can set it
through kernel command line.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
Signed-off-by: Catalin Enache <catalin.enache@windriver.com>
---
 drivers/i2c/busses/i2c-qup.c |   15 +++++++++++++++
 1 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/drivers/i2c/busses/i2c-qup.c b/drivers/i2c/busses/i2c-qup.c
index 7c0d095..93cacf7 100644
--- a/drivers/i2c/busses/i2c-qup.c
+++ b/drivers/i2c/busses/i2c-qup.c
@@ -37,10 +37,19 @@
 #include <linux/of.h>
 #include <linux/of_i2c.h>
 
+#define MODULE_NAME "i2c_qup"
 MODULE_LICENSE("GPL v2");
 MODULE_VERSION("0.2");
 MODULE_ALIAS("platform:i2c_qup");
 
+/*
+ * On the kernel command line specify
+ * i2c_qup.i2c_clk_freq = xxx to set the i2c bus freq
+ */
+static int i2c_clk_freq;
+module_param(i2c_clk_freq, uint, 0);
+MODULE_PARM_DESC(i2c_clk_freq, "i2c bus frequency: max 400000");
+
 /* QUP Registers */
 enum {
 	QUP_CONFIG              = 0x0,
@@ -1191,6 +1200,12 @@ blsp_core_init:
 		goto err_clk_get_failed;
 	}
 
+	/* use i2c_clk_freq to set i2c freq if i2c_clk_freq is set */
+	if (i2c_clk_freq != 0 && i2c_clk_freq <= 400000) {
+		dev_dbg(&pdev->dev, "set i2c freq to %d\n", i2c_clk_freq);
+		pdata->clk_freq = i2c_clk_freq;
+	}
+
 	/* We support frequencies upto FAST Mode(400KHz) */
 	if (pdata->clk_freq <= 0 ||
 			pdata->clk_freq > 400000) {
-- 
1.7.5.4

