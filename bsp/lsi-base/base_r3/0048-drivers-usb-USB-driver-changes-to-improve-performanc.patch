From 7da820ff6288e6f1b90fc5c0a7f6c238629e6888 Mon Sep 17 00:00:00 2001
From: SangeethaRao <sangeetha.rao@lsi.com>
Date: Sat, 28 Sep 2013 01:23:29 -0500
Subject: [PATCH 48/75] drivers/usb: USB driver changes to improve performance
 on AXM55xx.

Also, updated check for DTS compatible field to match the DTS

Signed-off-by: SangeethaRao <sangeetha.rao@lsi.com>
---
 drivers/usb/host/ehci-ci13612.c |   14 +++++++++++---
 1 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/drivers/usb/host/ehci-ci13612.c b/drivers/usb/host/ehci-ci13612.c
index 4f9e4b1..b3860ad 100644
--- a/drivers/usb/host/ehci-ci13612.c
+++ b/drivers/usb/host/ehci-ci13612.c
@@ -120,6 +120,7 @@ static int ehci_run_fix(struct usb_hcd *hcd)
 #endif
 	unsigned burst_size;
 	int retval;
+	unsigned usb_cmd;
 
 #ifdef CONFIG_LSI_USB_SW_WORKAROUND
 	/* Fix a HW erratum during the USB reset process. */
@@ -140,7 +141,6 @@ static int ehci_run_fix(struct usb_hcd *hcd)
 	ehci_writel(ehci, burst_size, &ehci->regs->reserved[1]);
 
 #else
-#if 1
     /* Fix for HW errata 9000373951: You can adjust the burst size and fill the
      * level to minimize under-run possibilities. In the failing case, the
      * transfer size was 96 bytes, the burst size was 16, and the fill
@@ -154,11 +154,19 @@ static int ehci_run_fix(struct usb_hcd *hcd)
 	burst_size = (burst_size & 0xffff00ff) | 0x4000;	/* TXPBURST */
 	ehci_writel(ehci, burst_size, &ehci->regs->reserved[1]);
 
+	/* Set the SBUSCFG[2:0] to 3 (AHBBRST3) */
+	writel(0x3, (void __iomem *)USB_SBUSCFG);
+
 	retval = ehci_run(hcd);
+
+	/* Performance tweaking */
+	/* Clear ITC field 23:16 to zero */
+	usb_cmd = inl(USB_USBCMD) & 0xFF00FFFF;
+	writel(usb_cmd, (void __iomem *)USB_USBCMD);
+
 	if (retval)
 		return retval;
 #endif
-#endif
 
 	return 0;
 }
@@ -307,7 +315,7 @@ MODULE_ALIAS("platform:ci13612-ehci");
 static struct of_device_id ci13612_match[] = {
 	{
 		.type	= "usb",
-		.compatible = "acp-usb",
+		.compatible = "lsi,acp-usb",
 	},
 	{},
 };
-- 
1.7.5.4

