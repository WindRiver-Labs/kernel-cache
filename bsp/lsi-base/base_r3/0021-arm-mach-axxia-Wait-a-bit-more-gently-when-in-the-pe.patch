From 9343aaf2b10ca68e06d6b9b8c7e6fee6281fdcb7 Mon Sep 17 00:00:00 2001
From: John Jacques <john.jacques@lsi.com>
Date: Wed, 4 Sep 2013 15:02:20 -0500
Subject: [PATCH 21/75] arm/mach-axxia: Wait a bit more gently when in the
 pen.

Signed-off-by: John Jacques <john.jacques@lsi.com>
---
 arch/arm/mach-axxia/headsmp.S |   30 +++++++++++++++++++++++++++++-
 1 files changed, 29 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-axxia/headsmp.S b/arch/arm/mach-axxia/headsmp.S
index 6a36f38..f467cc5 100644
--- a/arch/arm/mach-axxia/headsmp.S
+++ b/arch/arm/mach-axxia/headsmp.S
@@ -28,7 +28,35 @@ ENTRY(axxia_secondary_startup)
 	sub	r4, r4, r5
 	add	r6, r6, r4
 pen:	ldr	r7, [r6]
-	cmp	r7, r0
+	/*
+	 * It seems that just looping over read/compare kills starves
+	 * ethernet, this will happen if we start the kernel with
+	 * maxcpus=X where X < 16. Which we really want in order to
+	 * isolate cores.
+	 *
+	 * FIXME: We should really use wfi or wfe here
+	 */
+	mov	r4, #0x7000
+__delay:
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	nop
+	subs	r4,r4,#1
+	bne	__delay
+ 	cmp	r7, r0
 	bne	pen
 
 	/*
-- 
1.7.5.4

