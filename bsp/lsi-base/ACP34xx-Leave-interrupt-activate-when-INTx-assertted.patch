From 022f2b0db9fb72a2621f099e9949fac40060aee5 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Thu, 23 May 2013 18:27:38 +0800
Subject: [PATCH 2/2] ACP34xx:Leave interrupt activate when INTx assertted

On acp34xx, PCIe interrupt is trigged by PCIe I/O event. The ISR of
Acp34xx's PCIe driver reads all message in PCIe FIFO and cleaned
interrupt status.

Since the PCIe interrupt is a level triggered interrupt. PCIe ISR
should not clean interrupt status when there is asserted INTx
line, or system may lost IRQ.

This patch keeps watch on state each INTx line in ISR, if any line
asserted, the ISR didn't clean external IRQ bit of status register.
It will assure system could trigger IRQ when INTx asserted.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/sysdev/ppc4xx_pci.c |    8 ++++++--
 1 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/sysdev/ppc4xx_pci.c b/arch/powerpc/sysdev/ppc4xx_pci.c
index 2205fd1..43e6ce3 100644
--- a/arch/powerpc/sysdev/ppc4xx_pci.c
+++ b/arch/powerpc/sysdev/ppc4xx_pci.c
@@ -2596,7 +2596,7 @@ acp_pcie_isr(int irq, void *arg)
 	u32 msg_fifo_stat;
 	u32 msg_fifo_info;
 	u8  externalPciIntr = 0;
-
+	u8 pciIntrLevel = 0;
 
 	/* read the PEI interrupt status register */
 	intr_status = in_le32(mbase + 0x10c0);
@@ -2627,11 +2627,13 @@ acp_pcie_isr(int irq, void *arg)
 			case 0x21:  /*    assert_INTb */
 			case 0x22:  /*    assert_INTc */
 			case 0x23:  /*    assert_INTd */
+				pciIntrLevel |= (1 << (msg_type - 0x20));
+				break;
 			case 0x24:  /* de-assert_INTa */
 			case 0x25:  /* de-assert_INTb */
 			case 0x26:  /* de-assert_INTc */
 			case 0x27:  /* de-assert_INTd */
-				/* do nothing */
+				pciIntrLevel &= ~(1 << (msg_type - 0x24));
 				break;
 			default:
 				printk(KERN_INFO
@@ -2643,6 +2645,8 @@ acp_pcie_isr(int irq, void *arg)
 			/* re-read fifo status */
 			msg_fifo_stat = in_le32(mbase + 0x10b4);
 		}
+		if (pciIntrLevel)
+			intr_status &= ~0x00000010;
 	} else {
 		/*
 		 * Ignore the common interrupts, still need to figure out what
-- 
1.7.5.4

