From 4a3ac5277c63fba464287491001a7380c7215c4f Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Tue, 14 Oct 2014 14:36:47 +0800
Subject: [PATCH 3/4] arch/powerpc/sysdev: Fixed PCIe enumeration issue on
 AXM3500 emulation

the patch comes from:
git://git.yoctoproject.org/linux-yocto-3.4 of branch standard/axxia/base
upstream 20737d2c5f43cd13511c600056db77b27d854a2c commit

Fixed PCIe enumeration issue on AXM3500 emulation

Signed-off-by: SangeethaRao <sangeetha.rao@lsi.com>
Signed-off-by: Li Wang <li.wang@windriver.com>
---
 arch/powerpc/sysdev/lsi_pci.c |   16 ++++++++++++----
 1 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/arch/powerpc/sysdev/lsi_pci.c b/arch/powerpc/sysdev/lsi_pci.c
index 61b1800..07b3448 100644
--- a/arch/powerpc/sysdev/lsi_pci.c
+++ b/arch/powerpc/sysdev/lsi_pci.c
@@ -97,6 +97,7 @@ static void __init fixup_acp_pci_bridge(struct pci_dev *dev)
 
 DECLARE_PCI_FIXUP_HEADER(0x1000, 0x5101, fixup_acp_pci_bridge);
 DECLARE_PCI_FIXUP_HEADER(0x1000, 0x5108, fixup_acp_pci_bridge);
+DECLARE_PCI_FIXUP_HEADER(0x1000, 0x5102, fixup_acp_pci_bridge);
 
 static int __init acp_parse_dma_ranges(struct pci_controller *hose,
 				       void __iomem *reg,
@@ -910,6 +911,7 @@ static void __init acp_pciex_port_setup_hose(struct pciex_port *port)
 	u32 pci_status;
 	u32 link_state;
 	u32 pci_config;
+	u32 version;
 
 	/* Check if primary bridge */
 	if (of_get_property(port->node, "primary", NULL))
@@ -1013,6 +1015,16 @@ static void __init acp_pciex_port_setup_hose(struct pciex_port *port)
 		}
 	}
 
+	/* get the device version */
+	if (0 != ncr_read(NCP_REGION_ID(0x16, 0xff), 0x0, 4, &version)) {
+		pr_err("Unable to detect ACP revision!\n");
+		goto fail;
+	}
+
+	port->acp_chip_type = (version & 0xff);
+	pr_info("Using PEI register set for ACP chipType %d\n",
+		port->acp_chip_type);
+
 	/* Set bus numbers on our root port */
 	out_8(mbase + PCI_PRIMARY_BUS, hose->first_busno);
 	out_8(mbase + PCI_SECONDARY_BUS, hose->first_busno + 1);
@@ -1117,10 +1129,6 @@ static void __init probe_acp_pciex_bridge(struct device_node *np)
 		return;
 	}
 
-	port->acp_chip_type = 0x2;
-	pr_info("Using PEI register set for ACP chipType %d\n",
-	port->acp_chip_type);
-
 	/* Check for the PLX work-around. */
 	field = of_get_property(np, "plx", NULL);
 
-- 
1.7.5.4

