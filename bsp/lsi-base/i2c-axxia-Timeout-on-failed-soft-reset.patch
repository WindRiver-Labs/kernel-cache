From 7a98ff59840ff2d1b7f4d2e89041d988444617ae Mon Sep 17 00:00:00 2001
From: Anders Berg <anders.berg@lsi.com>
Date: Tue, 7 Jan 2014 10:34:41 +0100
Subject: [PATCH 2/9] i2c-axxia: Timeout on failed soft reset

Add a timeout condition to the soft reset code.

Currently this will time out when running on simulator since it fails to clear
the soft reset bit.

Signed-off-by: Anders Berg <anders.berg@lsi.com>
Signed-off-by: Xulin Sun <xulin.sun@windriver.com>
---
 drivers/i2c/busses/i2c-axxia.c |   10 ++++++++--
 1 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/drivers/i2c/busses/i2c-axxia.c b/drivers/i2c/busses/i2c-axxia.c
index 94a07e9..e5b7df8 100644
--- a/drivers/i2c/busses/i2c-axxia.c
+++ b/drivers/i2c/busses/i2c-axxia.c
@@ -167,14 +167,20 @@ axxia_i2c_init(struct axxia_i2c_dev *idev)
 	u32 t_setup;
 	u32 tmo_clk;
 	u32 prescale;
+	unsigned long timeout;
 
 	dev_dbg(idev->dev, "rate=%uHz per_clk=%uMHz -> ratio=1:%u\n",
 		idev->bus_clk_rate, clk_mhz, divisor);
 
 	/* Reset controller */
 	writel(0x01, &idev->regs->soft_reset);
-	while (readl(&idev->regs->soft_reset) & 1)
-		cpu_relax();
+	timeout = jiffies + msecs_to_jiffies(100);
+	while (readl(&idev->regs->soft_reset) & 1) {
+		if (time_after(jiffies, timeout)) {
+			dev_warn(idev->dev, "Soft reset failed\n");
+			break;
+		}
+	}
 
 	/* Enable Master Mode */
 	writel(0x1, &idev->regs->global_control);
-- 
1.7.5.4

