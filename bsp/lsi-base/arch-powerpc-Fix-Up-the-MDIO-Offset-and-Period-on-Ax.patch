From e0884af36b5a7f1d6db4ea39f7918037e2cd0511 Mon Sep 17 00:00:00 2001
From: Li Wang <li.wang@windriver.com>
Date: Mon, 22 Dec 2014 13:41:07 +0800
Subject: [PATCH 1/4] arch/powerpc: Fix Up the MDIO Offset and Period on Axxia

the patch comes from: git://git.yoctoproject.org/linux-yocto-3.4
branch: standard/axxia/base
commit id: 3af2e47344d6d5d1eca3059cce9a069e2800a4bf

If the MDIO offset and period are defined in the device tree,
use them.  Otherwise, don't change anything.

Signed-off-by: John Jacques <john.jacques@lsi.com>
Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
Signed-off-by: Li Wang <li.wang@windriver.com>
---
 drivers/net/ethernet/lsi/lsi_acp_mdio.c |   27 +++++++++++++++++----------
 1 files changed, 17 insertions(+), 10 deletions(-)

diff --git a/drivers/net/ethernet/lsi/lsi_acp_mdio.c b/drivers/net/ethernet/lsi/lsi_acp_mdio.c
index 07643fc..8045eab 100644
--- a/drivers/net/ethernet/lsi/lsi_acp_mdio.c
+++ b/drivers/net/ethernet/lsi/lsi_acp_mdio.c
@@ -252,15 +252,10 @@ EXPORT_SYMBOL(acp_mdio_write);
 */
 
 static int
-acp_mdio_initialize(void)
+acp_mdio_initialize(u32 offset, u32 period)
 {
-#ifdef CONFIG_ARM
-	WRITE(MDIO_CLK_OFFSET, 0x1c);
-	WRITE(MDIO_CLK_PERIOD, 0xf0);
-#else
-	WRITE(MDIO_CLK_OFFSET, 0x10);
-	WRITE(MDIO_CLK_PERIOD, 0x2c);
-#endif
+	WRITE(MDIO_CLK_OFFSET, offset);
+	WRITE(MDIO_CLK_PERIOD, period);
 
 	return 0;
 }
@@ -288,6 +283,8 @@ acp_mdio_init(void)
 	const u32 *field;
 	u64 mdio_address;
 	u32 mdio_size;
+	u32 mdio_offset = 0;
+	u32 mdio_period = 0;
 
 	pr_info("Initializing Axxia Wrappers.\n");
 
@@ -310,7 +307,17 @@ acp_mdio_init(void)
 	mdio_address = of_translate_address(np, field);
 	mdio_size = field[1];
 	mdio_base = (unsigned long)ioremap(mdio_address, mdio_size);
-	rc = acp_mdio_initialize();
+
+	field = of_get_property(np, "mdio-clock-offset", NULL);
+	if (field)
+		mdio_offset = ntohl(field[0]);
+
+	field = of_get_property(np, "mdio-clock-period", NULL);
+	if (field)
+		mdio_period = ntohl(field[0]);
+
+	if (mdio_offset != 0 && mdio_period != 0)
+		rc = acp_mdio_initialize(mdio_offset, mdio_period);
 #else
 	rc = 0;
 #endif
@@ -322,5 +329,5 @@ error:
 module_init(acp_mdio_init);
 
 MODULE_AUTHOR("LSI Corporation");
-MODULE_DESCRIPTION("Timing Test");
+MODULE_DESCRIPTION("MDIO Access");
 MODULE_LICENSE("GPL");
-- 
1.7.5.4

