From 9c1a929b5b561c465d6b2588f504b1a320cd0f40 Mon Sep 17 00:00:00 2001
From: Ming Liu <ming.liu@windriver.com>
Date: Thu, 8 May 2014 11:15:00 +0800
Subject: [PATCH] lsi-dma32: tune the modifier calculation for LSI acp

In some cases, it's required that a fixed length of SRIO transfer to be
written in one instance for acp34xx, or it may lead some incorrect reading.

Signed-off-by: Ming Liu <ming.liu@windriver.com>
---
 drivers/dma/lsi-dma32.c |   19 ++++++++++++++++++-
 1 files changed, 18 insertions(+), 1 deletions(-)

diff --git a/drivers/dma/lsi-dma32.c b/drivers/dma/lsi-dma32.c
index d62af64..9f136d7 100644
--- a/drivers/dma/lsi-dma32.c
+++ b/drivers/dma/lsi-dma32.c
@@ -533,6 +533,23 @@ gpdma_prep_memcpy(struct dma_chan *chan,
 	}
 
 	/* Maximize memory access width based on job src, dst and length */
+#ifdef CONFIG_ACP
+	access_size = 5;
+	if (!(size % 16)) {
+		src_size = 16;
+		access_size |= (4 << 3);
+	} else if (!(size % 8)) {
+		src_size = 8;
+		access_size |= (3 << 3);
+	} else if (!(size % 4)) {
+		src_size = 4;
+		access_size |= (2 << 3);
+	} else if (!(size % 2)) {
+		src_size = 2;
+		access_size |= (1 << 3);
+	} else
+		src_size = 1;
+#else
 	switch (ffs((u32)dst | (u32)src | size)) {
 	case 1:
 		src_size = 1;
@@ -555,7 +572,7 @@ gpdma_prep_memcpy(struct dma_chan *chan,
 		access_size = (4 << 3);
 		break;
 	}
-
+#endif
 	ch_dbg(dmac, "dst=%#llx src=%#llx size=%u mod=%d\n",
 		dst, src, size, src_size);
 	x_count = (size/src_size) - 1;
-- 
1.7.5.4

