From 24c18cc415bd1323868143f5edc89201c7e5d895 Mon Sep 17 00:00:00 2001
From: Wang Hui <Hui.Wang@windriver.com>
Date: Thu, 18 Apr 2013 09:56:48 +0800
Subject: [PATCH 40/76] arm: fmboot: make the fmboot image

Signed-off-by: Wang Hui <Hui.Wang@windriver.com>
---
 arch/arm/boot/Makefile        |    3 +++
 arch/arm/boot/fmboot/Makefile |   24 ++++++++++++------------
 2 files changed, 15 insertions(+), 12 deletions(-)

diff --git a/arch/arm/boot/Makefile b/arch/arm/boot/Makefile
index c877087..e7df7e4 100644
--- a/arch/arm/boot/Makefile
+++ b/arch/arm/boot/Makefile
@@ -53,6 +53,9 @@ $(obj)/compressed/vmlinux: $(obj)/Image FORCE
 
 $(obj)/zImage:	$(obj)/compressed/vmlinux FORCE
 	$(call if_changed,objcopy)
+ifeq ($(MACHINE),arch/arm/mach-axxia/)
+		$(Q)$(MAKE) $(build)=$(obj)/fmboot $(obj)/linux.img
+endif
 	@echo '  Kernel: $@ is ready'
 
 endif
diff --git a/arch/arm/boot/fmboot/Makefile b/arch/arm/boot/fmboot/Makefile
index 14db83f..3ae512f 100644
--- a/arch/arm/boot/fmboot/Makefile
+++ b/arch/arm/boot/fmboot/Makefile
@@ -3,23 +3,23 @@
 AS		= $(CROSS_COMPILE)gcc -c
 LD		= $(CROSS_COMPILE)ld
 
-DTC = ../../../../scripts/dtc/dtc
-DTS = ../dts/axm55xxsim.dts
-ZIMAGE = ../zImage
-
-all: clean linux.img
+DTC = $(obj)/../../../../scripts/dtc/dtc
+DTS = $(obj)/../dts/axm55xxsim.dts
+ZIMAGE = $(obj)/../zImage
 
 clean:
-	rm -f linux.img fmboot.o zImage.fm axm55xxsim.dtb
+	rm -f $(obj)/../linux.img $(obj)/fmboot.o $(obj)/zImage.fm $(obj)/axm55xxsim.dtb
 
-linux.img: fmboot.o fmboot.lds zImage.fm
-	$(LD) -o $@ --script=fmboot.lds
+arch/arm/boot/linux.img: $(obj)/fmboot.o $(srctree)/$(obj)/fmboot.lds $(obj)/zImage.fm
+	cd $(obj) && $(LD) -o ../linux.img --script=$(srctree)/$(obj)/fmboot.lds
+	tar jcf $(obj)/../linux.img.tar.bz2 $(obj)/../linux.img
+	rm -rf $(obj)/../linux.img
 
-zImage.fm: $(ZIMAGE) axm55xxsim.dtb
-	python pack.py $(ZIMAGE) axm55xxsim.dtb > $@
+$(obj)/zImage.fm: $(ZIMAGE) $(obj)/axm55xxsim.dtb
+	python $(srctree)/$(obj)/pack.py $(ZIMAGE) $(obj)/axm55xxsim.dtb > $@
 
-axm55xxsim.dtb: $(DTS)
+$(obj)/axm55xxsim.dtb: $(DTS)
 	$(DTC) -O dtb -o $@ $<
 
-fmboot.o: fmboot.S
+$(obj)/fmboot.o: $(obj)/fmboot.S
 	$(AS) -o $@ $<
-- 
1.7.0.5

