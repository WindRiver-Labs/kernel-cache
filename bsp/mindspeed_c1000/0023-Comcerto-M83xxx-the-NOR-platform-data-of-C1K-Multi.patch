From 5c4fd18a0e3ee80028a5116323b660594987e6a3 Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Wed, 27 Oct 2010 18:45:59 +0800
Subject: [PATCH 23/26] Comcerto: M83xxx: the NOR platform data of C1K Multifunction board.

Add NOR platform data for C1K Multifunction board.

Note: NOR flash and NAND flash can't be enabled at the same time on M83xxx.

Signed-off-by: Stanley.Miao <stanley.miao@windriver.com>
---
 arch/arm/mach-comcerto/board-c1kmfcn_evm.c |   59 ++++++++++++++++++++++++++++
 1 files changed, 59 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-comcerto/board-c1kmfcn_evm.c b/arch/arm/mach-comcerto/board-c1kmfcn_evm.c
index ab602bf..b15eb6f 100644
--- a/arch/arm/mach-comcerto/board-c1kmfcn_evm.c
+++ b/arch/arm/mach-comcerto/board-c1kmfcn_evm.c
@@ -28,6 +28,7 @@
 #include <asm/mach-types.h>
 #include <asm/io.h>
 #include <asm/mach/arch.h>
+#include <asm/mach/flash.h>
 #include <mach/hardware.h>
 #include <mach/nand.h>
 #include <mach/gpio.h>
@@ -39,12 +40,67 @@ static void __init board_gpio_init(void)
 	writel(readl(COMCERTO_GPIO_PIN_SELECT_REG) | EXP_NAND_RDY, COMCERTO_GPIO_PIN_SELECT_REG);
 	comcerto_gpio_enable_output(COMCERTO_OUTPUT_GPIO);
 	writel((readl(COMCERTO_GPIO_BOOTSTRAP_OVERRIDE) | (0x3 << 12)), COMCERTO_GPIO_BOOTSTRAP_OVERRIDE);
+#elif defined(CONFIG_MTD_COMCERTO_NOR) || defined(CONFIG_MTD_COMCERTO_NOR_MODULE)
+	writel(readl(COMCERTO_GPIO_PIN_SELECT_REG) & ~EXP_BUS, COMCERTO_GPIO_PIN_SELECT_REG);
+	writel((readl(COMCERTO_GPIO_BOOTSTRAP_OVERRIDE) & ~(0x3 << 12)), COMCERTO_GPIO_BOOTSTRAP_OVERRIDE);
 #else
 	writel(readl(COMCERTO_GPIO_PIN_SELECT_REG) | NAND_BUS, COMCERTO_GPIO_PIN_SELECT_REG);
 #endif
 }
 
 /* --------------------------------------------------------------------
+ *  NOR device
+ * -------------------------------------------------------------------- */
+#if defined(CONFIG_MTD_COMCERTO_NOR)
+#define NORFLASH_MEMORY_PHY1 COMCERTO_EXP_CS0_BASE
+static struct resource comcerto_nor_resources[] = {
+	{
+		.start	= NORFLASH_MEMORY_PHY1,
+		.end	= NORFLASH_MEMORY_PHY1 + SZ_16M - 1,
+		.flags	= IORESOURCE_MEM,
+	},
+};
+
+struct mtd_partition c1kmfcn_evm_nor_partition[] = {
+	{
+		.name           = "u-boot (NOR)",
+		.offset         = 0,
+		.size           = 2 * SZ_128K,
+		.mask_flags     = MTD_WRITEABLE,
+	},
+	{
+		.name           = "u-boot env(NOR)",
+		.offset         = MTDPART_OFS_APPEND,
+		.size           = SZ_128K,
+		.mask_flags     = MTD_WRITEABLE,
+	},
+	{
+		.name           = "kernel",
+		.offset         = SZ_2M,
+		.size           = MTDPART_SIZ_FULL,
+		.mask_flags     = 0,
+	},
+};
+
+static struct flash_platform_data comcerto_nor_data = {
+	.map_name	= "cfi_probe",
+	.width		= 2,
+	.parts		= c1kmfcn_evm_nor_partition,
+	.nr_parts	= ARRAY_SIZE(c1kmfcn_evm_nor_partition),
+};
+
+static struct platform_device comcerto_nor = {
+	.name           = "comcertoflash",
+	.id             = 0,
+	.num_resources  = ARRAY_SIZE(comcerto_nor_resources),
+	.resource       = comcerto_nor_resources,
+	.dev = {
+		.platform_data	= &comcerto_nor_data,
+	},
+};
+#endif
+
+/* --------------------------------------------------------------------
  *  NAND device
  * -------------------------------------------------------------------- */
 struct mtd_partition c1kmfcn_evm_nandflash_partition[] = {
@@ -430,6 +486,9 @@ static struct platform_device comcerto_usb0_device = {
 static struct platform_device *comcerto_devices[] __initdata = {
 	&comcerto_uart,
 	&comcerto_nand,
+#if defined(CONFIG_MTD_COMCERTO_NOR)
+	&comcerto_nor,
+#endif
 	&comcerto_fbpoolA_device,
 	&comcerto_fbpoolB_device,
 	&comcerto_mdio0_device,
-- 
1.5.4.3

