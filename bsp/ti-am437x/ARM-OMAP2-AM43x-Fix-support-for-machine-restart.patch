From 89f5b28026be4105b2f86b69cef7a71d0455c62e Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Fri, 28 Feb 2014 09:56:39 +0800
Subject: [PATCH 138/188] ARM: OMAP2+: AM43x: Fix support for machine restart

This commit comes from branch ti-linux-3.12.y:

  git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git

Currently machine restart for AM43x is hooked with am43xx_restart
function, which calls functions that are in file prm33xx.c. This file
is not built for AM43x, So this give a build error for AM43x alone builds.
Fixing this by using omap44xx_restart.

Reported-by: Felipe Balbi <balbi@ti.com>
Signed-off-by: Lokesh Vutla <lokeshvutla@ti.com>
(cherry picked from commit 8e84a2b344061003a01feab10123b42249b9f411)
---
 arch/arm/mach-omap2/Makefile         |    2 +-
 arch/arm/mach-omap2/am33xx-restart.c |   22 ----------------------
 arch/arm/mach-omap2/board-generic.c  |    2 +-
 arch/arm/mach-omap2/common.h         |    8 --------
 arch/arm/mach-omap2/prminst44xx.c    |    3 +++
 5 files changed, 5 insertions(+), 32 deletions(-)

diff --git a/arch/arm/mach-omap2/Makefile b/arch/arm/mach-omap2/Makefile
index c08cf5c..8a01e91 100644
--- a/arch/arm/mach-omap2/Makefile
+++ b/arch/arm/mach-omap2/Makefile
@@ -61,7 +61,7 @@ AFLAGS_sram34xx.o			:=-Wa,-march=armv7-a
 obj-$(CONFIG_SOC_OMAP2420)		+= omap2-restart.o
 obj-$(CONFIG_SOC_OMAP2430)		+= omap2-restart.o
 obj-$(CONFIG_SOC_AM33XX)		+= am33xx-restart.o
-obj-$(CONFIG_SOC_AM43XX)		+= am33xx-restart.o
+obj-$(CONFIG_SOC_AM43XX)		+= omap4-restart.o
 obj-$(CONFIG_ARCH_OMAP3)		+= omap3-restart.o
 obj-$(CONFIG_ARCH_OMAP4)		+= omap4-restart.o
 obj-$(CONFIG_SOC_OMAP5)			+= omap4-restart.o
diff --git a/arch/arm/mach-omap2/am33xx-restart.c b/arch/arm/mach-omap2/am33xx-restart.c
index e5ea2c2..87b8ca5 100644
--- a/arch/arm/mach-omap2/am33xx-restart.c
+++ b/arch/arm/mach-omap2/am33xx-restart.c
@@ -33,25 +33,3 @@ void am33xx_restart(char mode, const char *cmd)
 	(void)am33xx_prm_read_reg(AM33XX_PRM_DEVICE_MOD,
 				  AM33XX_PRM_RSTCTRL_OFFSET);
 }
-
-/**
- * am43xx_restart - trigger a software restart of the SoC
- * @mode: the "reboot mode", see arch/arm/kernel/{setup,process}.c
- * @cmd: passed fr-om the userspace program rebooting the system (if provided)
- *
- * Resets the SoC.  For @cmd, see the 'reboot' syscall in
- * kernel/sys.c.  No return value.
- */
-void am43xx_restart(char mode, const char *cmd)
-{
-	/* TODO: Handle mode and cmd if necessary */
-
-	am33xx_prm_rmw_reg_bits(AM33XX_RST_GLOBAL_WARM_SW_MASK,
-				AM33XX_RST_GLOBAL_WARM_SW_MASK,
-				AM43XX_PRM_DEVICE_INST,
-				AM33XX_PRM_RSTCTRL_OFFSET);
-
-	/* OCP barrier */
-	(void)am33xx_prm_read_reg(AM43XX_PRM_DEVICE_INST,
-				  AM33XX_PRM_RSTCTRL_OFFSET);
-}
diff --git a/arch/arm/mach-omap2/board-generic.c b/arch/arm/mach-omap2/board-generic.c
index d41de61..7ebdca8 100644
--- a/arch/arm/mach-omap2/board-generic.c
+++ b/arch/arm/mach-omap2/board-generic.c
@@ -232,7 +232,7 @@ DT_MACHINE_START(AM43_DT, "Generic AM43 (Flattened Device Tree)")
 	.init_machine	= omap_generic_init,
 	.init_time	= omap3_sync32k_timer_init,
 	.dt_compat	= am43_boards_compat,
-	.restart	= am43xx_restart,
+	.restart	= omap44xx_restart,
 MACHINE_END
 #endif
 
diff --git a/arch/arm/mach-omap2/common.h b/arch/arm/mach-omap2/common.h
index 604484e..b931655 100644
--- a/arch/arm/mach-omap2/common.h
+++ b/arch/arm/mach-omap2/common.h
@@ -151,14 +151,6 @@ static inline void am33xx_restart(char mode, const char *cmd)
 }
 #endif
 
-#ifdef CONFIG_SOC_AM43XX
-void am43xx_restart(char mode, const char *cmd);
-#else
-static inline void am43xx_restart(char mode, const char *cmd)
-{
-}
-#endif
-
 #ifdef CONFIG_ARCH_OMAP3
 void omap3xxx_restart(char mode, const char *cmd);
 #else
diff --git a/arch/arm/mach-omap2/prminst44xx.c b/arch/arm/mach-omap2/prminst44xx.c
index 5fb9bfa..1b03adf 100644
--- a/arch/arm/mach-omap2/prminst44xx.c
+++ b/arch/arm/mach-omap2/prminst44xx.c
@@ -20,6 +20,7 @@
 #include "common.h"
 #include "prcm-common.h"
 #include "prm44xx.h"
+#include "prcm43xx.h"
 #include "prm54xx.h"
 #include "prm7xx.h"
 #include "prminst44xx.h"
@@ -176,6 +177,8 @@ void omap4_prminst_global_warm_sw_reset(void)
 		dev_inst = OMAP54XX_PRM_DEVICE_INST;
 	else if (soc_is_dra7xx())
 		dev_inst = DRA7XX_PRM_DEVICE_INST;
+	else if (soc_is_am43xx())
+		dev_inst = AM43XX_PRM_DEVICE_INST;
 	else
 		return;
 
-- 
1.7.5.4

