From e382fd9f8d7415887046610f5b2d61ef1f881223 Mon Sep 17 00:00:00 2001
From: George Cherian <george.cherian@ti.com>
Date: Thu, 12 Dec 2013 19:34:38 +0530
Subject: [PATCH 268/285] usb: dwc3: core: poweroff phy in core suspend and
 switch on in resume

Power-off the USB phy in core suspend and power-on during resume.
This will turn off the PHY clocks during suspend.

Signed-off-by: George Cherian <george.cherian@ti.com>
[Kevin: The original patch taken from TI
ti-sdk-am437x-evm-07.01.00.00-Linux-x86-Install.bin]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/usb/dwc3/core.c |   16 ++++++++++++----
 1 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/drivers/usb/dwc3/core.c b/drivers/usb/dwc3/core.c
index 33f49ad..a82fc0a 100644
--- a/drivers/usb/dwc3/core.c
+++ b/drivers/usb/dwc3/core.c
@@ -772,10 +772,14 @@ static int dwc3_suspend(struct device *dev)
 	usb_phy_shutdown(dwc->usb3_phy);
 	usb_phy_shutdown(dwc->usb2_phy);
 
-	if (dwc->usb2_generic_phy)
+	if (dwc->usb2_generic_phy) {
+		phy_power_off(dwc->usb2_generic_phy);
 		phy_exit(dwc->usb2_generic_phy);
-	if (dwc->usb3_generic_phy)
+	}
+	if (dwc->usb3_generic_phy) {
+		phy_power_off(dwc->usb3_generic_phy);
 		phy_exit(dwc->usb3_generic_phy);
+	}
 
 	return 0;
 }
@@ -788,10 +792,14 @@ static int dwc3_resume(struct device *dev)
 	usb_phy_init(dwc->usb3_phy);
 	usb_phy_init(dwc->usb2_phy);
 
-	if (dwc->usb2_generic_phy)
+	if (dwc->usb2_generic_phy) {
 		phy_init(dwc->usb2_generic_phy);
-	if (dwc->usb3_generic_phy)
+		phy_power_on(dwc->usb2_generic_phy);
+	}
+	if (dwc->usb3_generic_phy) {
 		phy_init(dwc->usb3_generic_phy);
+		phy_power_on(dwc->usb3_generic_phy);
+	}
 
 	spin_lock_irqsave(&dwc->lock, flags);
 
-- 
1.7.5.4

