From c360cbd8f7a0653275040fa39e4169c2b4bb7b2f Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Sat, 1 Feb 2014 15:57:43 -0600
Subject: [PATCH 207/285] ARM: dts: am437x-gp-evm: Enable wkup_m3 control of
 IO isolation

With this flag wkup_m3 is able to control IO isolation during
suspend on the board.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
[Kevin: The original patch taken from TI
ti-sdk-am437x-evm-07.01.00.00-Linux-x86-Install.bin]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 .../devicetree/bindings/arm/omap/amx3xx-pm.txt     |   63 +++++++++++++++++++-
 arch/arm/boot/dts/am437x-gp-evm.dts                |    4 +
 2 files changed, 64 insertions(+), 3 deletions(-)

diff --git a/Documentation/devicetree/bindings/arm/omap/amx3xx-pm.txt b/Documentation/devicetree/bindings/arm/omap/amx3xx-pm.txt
index 9b0e2a1..4b5c598 100644
--- a/Documentation/devicetree/bindings/arm/omap/amx3xx-pm.txt
+++ b/Documentation/devicetree/bindings/arm/omap/amx3xx-pm.txt
@@ -4,15 +4,25 @@ Support for VTT Toggle
 
 In order to enable the support for VTT toggle during Suspend/Resume
 sequence needed by some boards (like AM335x EVM-SK & AM437x GP EVM),
-below DT properties needs to be added under the M3 Wakeup Node.
+the below DT properties are required. It is possible to toggle VTT
+using one of two methods depending on the SoC being used, either
+GPIO0 toggle (AM335x and AM437x), or any GPIO with DS_PAD_CONFIG
+bits in the control module (AM437x only).
+
+VTT Toggle using GPIO0
+==================================
+Supported by: AM335x and AM437x
+Used on: AM335x EVM-SK
 
 Required properties:
 - ti,needs-vtt-toggle:	Indicates that the boards requires VTT toggling
 			during suspend/resume.
-- ti,vtt-gpio-pin:	Specifies the GPIO pin used for VTT toggle.
+- ti,vtt-gpio-pin:	Specifies the GPIO0 pin used for VTT toggle.
 
 Important Note:
-- Here it is assumed that VTT Toggle will be done using a pin on GPIO-0 Instance
+- Here it is assumed that VTT Toggle will be done using a pin on GPIO-0 Instance.
+  It will not work on any other GPIO using the above properties, regardless of
+  which part is being used.
 
 Example:
 	wkup_m3: wkup_m3@44d00000 {
@@ -22,3 +32,50 @@ Example:
 		ti,needs-vtt-toggle;
 		ti,vtt-gpio-pin = <7>;
 	};
+
+VTT Toggle using any GPIO
+==================================
+Supported by: AM437x ONLY
+Used on: AM437x GP EVM
+
+Many of the pins on AM437x have the ability to configure both normal and
+sleep states. Because of this it is possible to use any pin with a
+corresponding CTRL_CONF_* register in the control module and the
+DS_PAD_CONFIG bits to toggle the VTT regulator enable pin. The DS state of
+the pin must be configured such that the pin disables the VTT regulator. The
+normal state of the pin must be configured such that the VTT regulator is
+enabled by the state alone. This is because the VTT regulator must be enabled
+before context is restored to the controlling GPIO.
+
+Required properties:
+- ti,set-io-isolation:	Indicates that the IO's should be placed into
+			isolation and the DS_PAD_CONFIG values should be
+			used during suspend.
+
+Example:
+
+On the AM437x GP EVM, the VTT enable line must be held low to disable VTT
+regulator and held high to enable, so the following pinctrl entry is used.
+The DS pull is enabled which uses a pull down by default and DS off mode is
+used which outputs a low by default. For the normal state, a pull up is
+specified so that the VTT enable line gets pulled high immediately after
+the DS states are removed upon exit from DeepSleep0.
+
+&am43xx_pinmux {
+	pinctrl-names = "default";
+	pinctrl-0 = <&ddr3_vtt_toggle_default>;
+
+	ddr3_vtt_toggle_default: ddr_vtt_toggle_default {
+        pinctrl-single,pins = <
+                0x25C (DS0_PULL_UP_DOWN_EN | PIN_OUTPUT_PULLUP | DS0_FORCE_OFF_MODE | MUX_MODE7)
+		>;
+	};
+	...
+};
+
+wkup_m3: wkup_m3@44d00000 {
+	compatible = "ti,am3353-wkup-m3";
+	...
+	ti,set-io-isolation;
+};
+
diff --git a/arch/arm/boot/dts/am437x-gp-evm.dts b/arch/arm/boot/dts/am437x-gp-evm.dts
index db24288..2e6c25f 100644
--- a/arch/arm/boot/dts/am437x-gp-evm.dts
+++ b/arch/arm/boot/dts/am437x-gp-evm.dts
@@ -743,3 +743,7 @@
 &clkout_32k_mux_ck {
 	clock-default = <&clk_32768_ck>;
 };
+
+&wkup_m3 {
+	ti,set-io-isolation;
+};
-- 
1.7.5.4

