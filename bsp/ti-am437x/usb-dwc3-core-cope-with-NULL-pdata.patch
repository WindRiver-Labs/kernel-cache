From 7046dfc3ca001cca3a48b96d0de46a661a5b96bc Mon Sep 17 00:00:00 2001
From: Felipe Balbi <balbi@ti.com>
Date: Wed, 14 Aug 2013 13:21:23 -0500
Subject: [PATCH 077/285] usb: dwc3: core: cope with NULL pdata

commit bb674907111272ca40926ca3d3bad4046fffed52 upstream

if pdata is a NULL pointer we could cause a
kernel oops when probing the driver. Make sure
to cope with systems which won't pass pdata
to the driver.

Tested-by: Paul Zimmerman <paulz@synopsys.com>
Reported-by: Paul Zimmerman <paulz@synopsys.com>
Signed-off-by: Felipe Balbi <balbi@ti.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
---
 drivers/usb/dwc3/core.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/drivers/usb/dwc3/core.c b/drivers/usb/dwc3/core.c
index 71040e0..f97b449 100644
--- a/drivers/usb/dwc3/core.c
+++ b/drivers/usb/dwc3/core.c
@@ -501,7 +501,7 @@ static int dwc3_probe(struct platform_device *pdev)
 		}
 
 		dwc->needs_fifo_resize = of_property_read_bool(node, "tx-fifo-resize");
-	} else {
+	} else if (pdata) {
 		dwc->maximum_speed = pdata->maximum_speed;
 
 		switch (dwc->maximum_speed) {
@@ -536,6 +536,9 @@ static int dwc3_probe(struct platform_device *pdev)
 		}
 
 		dwc->needs_fifo_resize = pdata->tx_fifo_resize;
+	} else {
+		dwc->usb2_phy = devm_usb_get_phy(dev, USB_PHY_TYPE_USB2);
+		dwc->usb3_phy = devm_usb_get_phy(dev, USB_PHY_TYPE_USB3);
 	}
 
 	/* default to superspeed if no maximum_speed passed */
-- 
1.7.5.4

