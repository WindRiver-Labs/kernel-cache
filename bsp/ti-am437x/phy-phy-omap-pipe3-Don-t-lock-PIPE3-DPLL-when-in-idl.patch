From 0e41788b7c04788282fd1c84d120d9de694e3107 Mon Sep 17 00:00:00 2001
From: Kishon Vijay Abraham I <kishon@ti.com>
Date: Tue, 19 Nov 2013 15:14:32 +0530
Subject: [PATCH 265/285] phy: phy-omap-pipe3: Don't lock PIPE3 DPLL when in
 idle mode

If tried to lock PIPE3 DPLL while the DPLL is in idle mode, the DPLL fails
to be locked. So before trying to lock the DPLL, reset the DPLL idle mode bit.

OMAP5: USB DPLL failed to lock on system resume (D-01179)

Reported-by: Tomi Valkeinen <tomi.valkeinen@ti.com>
Signed-off-by: Kishon Vijay Abraham I <kishon@ti.com>
Acked-by: Roger Quadros <rogerq@ti.com>
Tested-by: Tomi Valkeinen <tomi.valkeinen@ti.com>
[Kevin: The original patch taken from TI
ti-sdk-am437x-evm-07.01.00.00-Linux-x86-Install.bin]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/phy/phy-omap-pipe3.c |   12 ++++++------
 1 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/drivers/phy/phy-omap-pipe3.c b/drivers/phy/phy-omap-pipe3.c
index 012400c..bd0e4bf 100644
--- a/drivers/phy/phy-omap-pipe3.c
+++ b/drivers/phy/phy-omap-pipe3.c
@@ -187,12 +187,6 @@ static int omap_pipe3_init(struct phy *x)
 	if (of_device_is_compatible(phy->dev->of_node, "ti,phy-pipe3-pcie"))
 		return 0;
 
-	/* Program the DPLL only if not locked */
-	val = omap_pipe3_readl(phy->pll_ctrl_base, PLL_STATUS);
-	if (!(val & PLL_LOCK))
-		if (omap_pipe3_dpll_program(phy))
-			return -EINVAL;
-
 	/* Bring it out of IDLE if it is IDLE */
 	val = omap_pipe3_readl(phy->pll_ctrl_base, PLL_CONFIGURATION2);
 	if (val & PLL_IDLE) {
@@ -201,6 +195,12 @@ static int omap_pipe3_init(struct phy *x)
 		ret = omap_pipe3_wait_lock(phy);
 	}
 
+	/* Program the DPLL only if not locked */
+	val = omap_pipe3_readl(phy->pll_ctrl_base, PLL_STATUS);
+	if (!(val & PLL_LOCK))
+		if (omap_pipe3_dpll_program(phy))
+			return -EINVAL;
+
 	return ret;
 }
 
-- 
1.7.5.4

