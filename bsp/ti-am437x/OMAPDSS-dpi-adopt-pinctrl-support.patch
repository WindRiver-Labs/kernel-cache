From e6e295a0d764c71d87a8bfbe6211a7649b1fa953 Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Mon, 10 Feb 2014 22:58:44 +0000
Subject: [PATCH 222/285] OMAPDSS: dpi: adopt pinctrl support

Update omapdss/dpi driver to set the state of the pins to:
- "default on enable
- "sleep" on disable

The disable and enable functions are called from a PM hook within
omapdss so the sleep and default states will be used with suspend
and resume, respectively.

By optionally putting the pins into sleep state in the suspend callback
we can accomplish two things.
- minimize current leakage from pins and thus save power,
- prevent the IP from driving pins output in an uncontrolled manner,
which may happen if the power domain drops the domain regulator.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
Signed-off-by: Darren Etheridge <detheridge@ti.com>
[Kevin: The original patch taken from TI
ti-sdk-am437x-evm-07.01.00.00-Linux-x86-Install.bin]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/video/omap2/dss/dpi.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/video/omap2/dss/dpi.c b/drivers/video/omap2/dss/dpi.c
index 1b42c86..d2c23c2 100644
--- a/drivers/video/omap2/dss/dpi.c
+++ b/drivers/video/omap2/dss/dpi.c
@@ -353,6 +353,8 @@ static int dpi_display_enable(struct omap_dss_device *dssdev)
 
 	mutex_lock(&dpi.lock);
 
+	pinctrl_pm_select_default_state(&dpi.pdev->dev);
+
 	if (dss_has_feature(FEAT_DPI_USES_VDDS_DSI) && !dpi.vdds_dsi_reg) {
 		DSSERR("no VDSS_DSI regulator\n");
 		r = -ENODEV;
@@ -421,6 +423,7 @@ err_get_dispc:
 err_reg_enable:
 err_no_out_mgr:
 err_no_reg:
+	pinctrl_pm_select_sleep_state(&dpi.pdev->dev);
 	mutex_unlock(&dpi.lock);
 	return r;
 }
@@ -444,6 +447,8 @@ static void dpi_display_disable(struct omap_dss_device *dssdev)
 	if (dss_has_feature(FEAT_DPI_USES_VDDS_DSI))
 		regulator_disable(dpi.vdds_dsi_reg);
 
+	pinctrl_pm_select_sleep_state(&dpi.pdev->dev);
+
 	mutex_unlock(&dpi.lock);
 }
 
-- 
1.7.5.4

