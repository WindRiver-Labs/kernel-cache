From d767d979dc69db7dcebd7648b698f8e43e092691 Mon Sep 17 00:00:00 2001
From: Joel Fernandes <joelf@ti.com>
Date: Wed, 6 Nov 2013 22:11:07 -0600
Subject: [PATCH 168/285] clk: clk-mux: Setup default clock parent during mux
 setup

In an effort to not have to hard code parent clock names for system timers,
this patch introduces a DT property "clock-default" to mux-clocks which allows
one to specify the default mux clock in DT by referring to the clock phandle.
Doing so would allow us to eliminate the clk_set_parent code from
mach-omap2/timer.c and also we wouldn't have to hardcode clock parent names in
the OMAP_SYS_32K_TIMER_INIT and OMAP_SYS_GP_TIMER_INIT macros.

Tested on AM335x beaglebone with timer1 clock.

Cc: Nishanth Menon <nm@ti.com>
Cc: Tero Kristo <t-kristo@ti.com>
Cc: Santosh Shilimkar <santosh.shilimkar@ti.com>
Tested-by: Sekhar Nori <nsekhar@ti.com>
Signed-off-by: Joel Fernandes <joelf@ti.com>
[Kevin: The original patch taken from TI
ti-sdk-am437x-evm-07.01.00.00-Linux-x86-Install.bin]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/clk/clk-mux.c |   24 ++++++++++++++++++++++--
 1 files changed, 22 insertions(+), 2 deletions(-)

diff --git a/drivers/clk/clk-mux.c b/drivers/clk/clk-mux.c
index 3189bd8..1ccf4b0 100644
--- a/drivers/clk/clk-mux.c
+++ b/drivers/clk/clk-mux.c
@@ -186,10 +186,12 @@ EXPORT_SYMBOL_GPL(clk_register_mux);
  */
 void of_mux_clk_setup(struct device_node *node)
 {
-	struct clk *clk;
+	struct clk *clk, *parent;
+	struct device_node *parent_node;
+	struct of_phandle_args clkspec;
 	const char *clk_name = node->name;
 	void __iomem *reg;
-	int num_parents;
+	int num_parents, parent_idx;
 	const char **parent_names;
 	int i;
 	u8 clk_mux_flags = 0;
@@ -243,6 +245,24 @@ void of_mux_clk_setup(struct device_node *node)
 
 	if (!IS_ERR(clk))
 		of_clk_add_provider(node, of_clk_src_simple_get, clk);
+
+	parent_node = of_parse_phandle(node, "clock-default", 0);
+
+	if (parent_node) {
+		parent_idx = of_count_phandle_with_args(node, "clocks",
+							"#clock-cells");
+		while (parent_idx--) {
+			if (parent_node == of_parse_phandle(node, "clocks",
+							    parent_idx)) {
+				clkspec.np = parent_node;
+				parent = of_clk_get_from_provider(&clkspec);
+				if (parent)
+					clk_set_parent(clk, parent);
+				break;
+			}
+		}
+		of_node_put(parent_node);
+	}
 }
 EXPORT_SYMBOL_GPL(of_mux_clk_setup);
 CLK_OF_DECLARE(mux_clk, "mux-clock", of_mux_clk_setup);
-- 
1.7.5.4

