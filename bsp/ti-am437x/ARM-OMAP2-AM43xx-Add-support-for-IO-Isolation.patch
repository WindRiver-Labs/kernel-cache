From 6f0fa231ba1cc08e2320e60c548f8c5738121af3 Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Sat, 1 Feb 2014 15:57:41 -0600
Subject: [PATCH 163/188] ARM: OMAP2+: AM43xx: Add support for IO Isolation

This commit comes from branch ti-linux-3.12.y:
  git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git

AM43xx support isolation of the many of the IOs so that control is taken
from the peripheral they are connected to and overridden by values
present in the CTRL_CONF_* registers for the pad in the control module.

The actual toggling happens from the wkup_m3, so use a DT property from the
wkup_m3 node to allow the PM code to communicate the necessity for
placing the IOs into isolation.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
(cherry picked from commit fadedda594ce0e99ba1b39def9553c1679dec409)
---
 arch/arm/mach-omap2/pm33xx.c |    3 +++
 arch/arm/mach-omap2/pm33xx.h |    2 ++
 2 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-omap2/pm33xx.c b/arch/arm/mach-omap2/pm33xx.c
index 1996e32..01759bd 100644
--- a/arch/arm/mach-omap2/pm33xx.c
+++ b/arch/arm/mach-omap2/pm33xx.c
@@ -626,6 +626,9 @@ int __init am33xx_pm_init(void)
 			else
 				pr_warn("PM: Invalid VTT GPIO(%d) pin\n", temp);
 		}
+
+		if (of_find_property(np, "ti,set-io-isolation", NULL))
+			am33xx_pm->ipc.reg4 |= (1 << IO_ISOLATION_STAT_SHIFT);
 	}
 
 #ifdef CONFIG_SUSPEND
diff --git a/arch/arm/mach-omap2/pm33xx.h b/arch/arm/mach-omap2/pm33xx.h
index 6a71b0e..8a0020c 100644
--- a/arch/arm/mach-omap2/pm33xx.h
+++ b/arch/arm/mach-omap2/pm33xx.h
@@ -106,6 +106,8 @@ int am33xx_do_sram_cpuidle(u32, u32);
 #define VTT_STAT_MASK		(0x1 << 3)
 #define VTT_GPIO_PIN_SHIFT	(0x4)
 #define VTT_GPIO_PIN_MASK	(0x3f << 4)
+#define IO_ISOLATION_STAT_SHIFT (10)
+#define IO_ISOLATION_STAT_MASK  (0x1 << 10)
 
 #define MPU_WAKE		0x800
 
-- 
1.7.5.4

