From 7569999a9b1b94e487f01c934a503e6c69b22e91 Mon Sep 17 00:00:00 2001
From: Afzal Mohammed <afzal@ti.com>
Date: Wed, 4 Dec 2013 19:35:13 +0530
Subject: [PATCH 243/285] bus: omap_l3_noc: mask unclearable flagmux source

Timeout errors in AM43x can't be cleared per h/w team, neither does it
have a STDERRLOG_MAIN to clear the error. Upon occurance of error from
such sources, mask it. Otherwise, isr would loop continously as
interrupt is not cleared at the source.

This change also helps in handling undocumented flagmux bits gracefully.

As currently, L3 timeout error is observed on every boot of
AM43x ePOS EVM, degrade from WARN to pr_warn. Also provide sufficient
information on the source of unclearable error.

Signed-off-by: Afzal Mohammed <afzal@ti.com>
[Kevin: The original patch taken from TI
ti-sdk-am437x-evm-07.01.00.00-Linux-x86-Install.bin]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/bus/omap_l3_noc.c |   15 ++++++++++++---
 drivers/bus/omap_l3_noc.h |    4 ++++
 2 files changed, 16 insertions(+), 3 deletions(-)

diff --git a/drivers/bus/omap_l3_noc.c b/drivers/bus/omap_l3_noc.c
index ad43775..264867b 100644
--- a/drivers/bus/omap_l3_noc.c
+++ b/drivers/bus/omap_l3_noc.c
@@ -80,9 +80,18 @@ static irqreturn_t l3_interrupt_handler(int irq, void *_l3)
 			/* Identify the source from control status register */
 			err_src = __ffs(err_reg);
 
-			if (*(l3->l3_targets[i] + err_src) == 0xdeadbeef) {
-				WARN(true, "L3 error for UN IDENTIFIED TARGET: %d\n",
-				     err_src);
+			if (*(l3->l3_targets[i] + err_src) ==
+						L3_FLAGMUX_TARGET_OFS_INVALID) {
+				u32 val;
+				void __iomem *reg = base + l3->l3_flag_mux[i] +
+					L3_FLAGMUX_MASK0 + (inttype << 3);
+
+				pr_warn("L3 %s error: target %d clkdm %d %s\n",
+					inttype ? "debug" : "application",
+					err_src, i, "(unclearable)");
+				val = readl(reg);
+				val &= ~(1 << err_src);
+				writel(val, reg);
 				break;
 			}
 
diff --git a/drivers/bus/omap_l3_noc.h b/drivers/bus/omap_l3_noc.h
index a6ce34d..0255b4c 100644
--- a/drivers/bus/omap_l3_noc.h
+++ b/drivers/bus/omap_l3_noc.h
@@ -36,6 +36,10 @@
 #define L3_TARG_STDERRLOG_SLVOFSLSB	0x5c
 #define L3_TARG_STDERRLOG_MSTADDR	0x68
 #define L3_FLAGMUX_REGERR0		0xc
+#define L3_FLAGMUX_MASK0		0x8
+
+#define L3_FLAGMUX_TARGET_OFS_INVALID	0xdeadbeef
+#define L3_FLAGMUX_TARGET_OFS_TIMEOUT	L3_FLAGMUX_TARGET_OFS_INVALID
 
 #define NUM_OF_L3_MASTERS	(sizeof(l3_masters)/sizeof(l3_masters[0]))
 
-- 
1.7.5.4

