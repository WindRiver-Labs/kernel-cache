From 00508bd0f41738ec6aecd3029e4d2a436f52095e Mon Sep 17 00:00:00 2001
From: Felipe Balbi <balbi@ti.com>
Date: Tue, 21 Jan 2014 11:23:55 -0600
Subject: [PATCH 156/285] usb: dwc3: ep0: add missing lock to ep0_set_halt()

dwc3_gadget_ep0_set_halt() was missing a lock
which it should have, as it races with IRQ
handlers.

this patch fixes the problem by adding the
missingn lock.

Signed-off-by: Felipe Balbi <balbi@ti.com>
Tested-by: Aparna Balasubramanian <aparnab@ti.com>
[Kevin: The original patch taken from TI
ti-sdk-am437x-evm-07.01.00.00-Linux-x86-Install.bin]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/usb/dwc3/ep0.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/dwc3/ep0.c b/drivers/usb/dwc3/ep0.c
index 3cea676..aa9caf1 100644
--- a/drivers/usb/dwc3/ep0.c
+++ b/drivers/usb/dwc3/ep0.c
@@ -289,8 +289,11 @@ int dwc3_gadget_ep0_set_halt(struct usb_ep *ep, int value)
 {
 	struct dwc3_ep			*dep = to_dwc3_ep(ep);
 	struct dwc3			*dwc = dep->dwc;
+	unsigned long			flags;
 
+	spin_lock_irqsave(&dwc->lock, flags);
 	dwc3_ep0_stall_and_restart(dwc);
+	spin_unlock_irqrestore(&dwc->lock, flags);
 
 	return 0;
 }
-- 
1.7.5.4

