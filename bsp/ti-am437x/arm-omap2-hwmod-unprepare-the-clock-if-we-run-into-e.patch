From 3134349ad28de9c2dfa4412a7f2c83e97ab268ff Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Fri, 15 Aug 2014 09:33:21 +0800
Subject: [PATCH 3/4] arm: omap2: hwmod: unprepare the clock if we run into
 error

We should restore the clock to the original status by using
clk_unprepare() if we run into error.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
Tested-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-omap2/omap_hwmod.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-omap2/omap_hwmod.c b/arch/arm/mach-omap2/omap_hwmod.c
index 5762adc..08e5160 100644
--- a/arch/arm/mach-omap2/omap_hwmod.c
+++ b/arch/arm/mach-omap2/omap_hwmod.c
@@ -896,12 +896,19 @@ static int _init_opt_clks_dt(struct omap_hwmod *oh, struct device_node *np)
 			pr_warn("omap_hwmod: %s: cannot clk_get opt_clk %s\n",
 				oh->name, opt_clk_names[i]);
 			ret = -EINVAL;
+			break;
 		}
 		oh->opt_clks[i]._clk = c;
 		oh->opt_clks[i].role = opt_clk_names[i];
 		clk_prepare(oh->opt_clks[i]._clk);
 	}
 
+	if (ret && i > 0) {
+		for (i -= 1; i >= 0; i--)
+			clk_unprepare(oh->opt_clks[i]._clk);
+		kfree(oh->opt_clks);
+	}
+
 	kfree(opt_clk_names);
 	return ret;
 }
-- 
1.7.5.4

