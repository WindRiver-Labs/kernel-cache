From 398613789331ea2aa3495e36a7fac0ca31d9ecba Mon Sep 17 00:00:00 2001
From: Roger Quadros <rogerq@ti.com>
Date: Fri, 25 Oct 2013 17:38:34 +0300
Subject: [PATCH 260/285] usb: dwc3: core: Initialize PHY at probe() instead
 of softreset()

The PHY must be initialized before it is powered on and not the other way
round as is currently done in the dwc3 driver.
Also, doing phy_init() in softreset() seems wrong, so move it to
probe() and just before powering ON the PHY.

Signed-off-by: Roger Quadros <rogerq@ti.com>
[Kevin: The original patch taken from TI
ti-sdk-am437x-evm-07.01.00.00-Linux-x86-Install.bin]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/usb/dwc3/core.c |   18 ++++++++----------
 1 files changed, 8 insertions(+), 10 deletions(-)

diff --git a/drivers/usb/dwc3/core.c b/drivers/usb/dwc3/core.c
index 5b0dfd6..33f49ad 100644
--- a/drivers/usb/dwc3/core.c
+++ b/drivers/usb/dwc3/core.c
@@ -97,14 +97,6 @@ static void dwc3_core_soft_reset(struct dwc3 *dwc)
 	reg |= DWC3_GUSB2PHYCFG_PHYSOFTRST;
 	dwc3_writel(dwc->regs, DWC3_GUSB2PHYCFG(0), reg);
 
-	usb_phy_init(dwc->usb2_phy);
-	usb_phy_init(dwc->usb3_phy);
-
-	if (dwc->usb2_generic_phy)
-		phy_init(dwc->usb2_generic_phy);
-	if (dwc->usb3_generic_phy)
-		phy_init(dwc->usb3_generic_phy);
-
 	mdelay(100);
 
 	/* Clear USB3 PHY reset */
@@ -538,13 +530,19 @@ static int dwc3_probe(struct platform_device *pdev)
 	if (IS_ERR(regs))
 		return PTR_ERR(regs);
 
+	usb_phy_init(dwc->usb2_phy);
+	usb_phy_init(dwc->usb3_phy);
 	usb_phy_set_suspend(dwc->usb2_phy, 0);
 	usb_phy_set_suspend(dwc->usb3_phy, 0);
 
-	if (dwc->usb2_generic_phy)
+	if (dwc->usb2_generic_phy) {
+		phy_init(dwc->usb2_generic_phy);
 		phy_power_on(dwc->usb2_generic_phy);
-	if (dwc->usb3_generic_phy)
+	}
+	if (dwc->usb3_generic_phy) {
+		phy_init(dwc->usb3_generic_phy);
 		phy_power_on(dwc->usb3_generic_phy);
+	}
 
 	spin_lock_init(&dwc->lock);
 	platform_set_drvdata(pdev, dwc);
-- 
1.7.5.4

