From d502ef2d95048c4158762e758e569d7c64685f36 Mon Sep 17 00:00:00 2001
From: Roger Quadros <rogerq@ti.com>
Date: Fri, 25 Oct 2013 18:02:37 +0300
Subject: [PATCH 248/285] phy: omap-pipe3: Wait for some time after power on

The commit (17b2b8d5) reduced the occurance of the problem [1]
but I was still observing the dwc3-usb failures occassionally.

Adding a 100ms delay just after phy_power_on() seems to make it
more robust.

Fixes:
    D-01110 - dwc3 controller crashes at boot

[1] Failure signature:

[    7.442151] Unhandled fault: imprecise external abort (0x1406) at 0x00000000
[    7.442158] Internal error: : 1406 [#1] SMP ARM
[    7.442164] Modules linked in:
[    7.442170] CPU: 0 PID: 6 Comm: kworker/u4:0 Not tainted 3.12.0-rc6-00730-g08c3a22 #428
[    7.442185] Workqueue: deferwq deferred_probe_work_func
[    7.442189] task: ed914080 ti: ed91c000 task.ti: ed91c000
[    7.442197] PC is at dwc3_probe+0x79c/0xb28
[    7.442204] LR is at arch_timer_read_counter_long+0x10/0x18
[    7.442209] pc : [<c04361dc>]    lr : [<c001a6b0>]    psr: 60000013
[    7.442209] sp : ed91dca8  ip : c0a267c8  fp : c08a9e34
[    7.442212] r10: 00000000  r9 : ede47c10  r8 : ffff8c0d
[    7.442215] r7 : c08a4880  r6 : ede6a810  r5 : c090fa6c  r4 : 00000000
[    7.442218] r3 : f01e0100  r2 : 02bcf9e5  r1 : 00000000  r0 : 02bcf9e5
[    7.442223] Flags: nZCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment kernel
[    7.442226] Control: 10c53c7d  Table: 8000406a  DAC: 00000017

Signed-off-by: Roger Quadros <rogerq@ti.com>
[Kevin: The original patch taken from TI
ti-sdk-am437x-evm-07.01.00.00-Linux-x86-Install.bin]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/phy/phy-omap-pipe3.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/phy/phy-omap-pipe3.c b/drivers/phy/phy-omap-pipe3.c
index 4db8bf3..b0f8ea2 100644
--- a/drivers/phy/phy-omap-pipe3.c
+++ b/drivers/phy/phy-omap-pipe3.c
@@ -135,6 +135,8 @@ static int omap_pipe3_power_on(struct phy *x)
 		udelay(1);
 	} while (--timeout);
 
+	msleep(100);
+
 	return 0;
 }
 
-- 
1.7.5.4

