From 6a894c6c5dffbcb0d58b20226e0f539f6d52ee64 Mon Sep 17 00:00:00 2001
From: Liu Changhui <changhui.liu@windriver.com>
Date: Fri, 29 Jan 2010 13:28:10 +0800
Subject: [PATCH] Clock API: Add clock api driver for rmi xls

Add clock api driver for rmi xls.

source: from RMI SDK1.7

Signed-off-by: shuo.kang <shuo.kang@windriver.com>
---
 arch/mips/Kconfig           |    1 +
 arch/mips/kernel/cevt-r4k.c |   24 ++++++++++++++++++++++++
 2 files changed, 25 insertions(+), 0 deletions(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index a9a098d..3f6594f 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -604,6 +604,7 @@ config RMI_PTR
 	select SMP
 	select BOOT_ELF32
 	select RMI_PHOENIX
+	select SYS_R4K_CVET_HWTIMER
 	select SYS_HAS_CPU_PHOENIX
 	select SYS_SUPPORTS_SMP
 	select HW_HAS_PCI
diff --git a/arch/mips/kernel/cevt-r4k.c b/arch/mips/kernel/cevt-r4k.c
index 5cdb270..0931848 100644
--- a/arch/mips/kernel/cevt-r4k.c
+++ b/arch/mips/kernel/cevt-r4k.c
@@ -48,6 +48,10 @@ static struct hwtimer mips_hwtimer = {
 	.hook = NULL,
 	.hook_data = NULL
 };
+
+#ifdef CONFIG_RMI_PHOENIX
+atomic_t hwtimer_cpu_trigger[NR_CPUS];
+#endif
 #endif
 
 static int mips_next_event(unsigned long delta,
@@ -104,10 +108,22 @@ irqreturn_t c0_compare_interrupt(int irq, void *dev_id)
 	}
 
 #if defined (CONFIG_SYS_R4K_CVET_HWTIMER) && defined (CONFIG_HWTIMER_HOOKS)
+
+#ifdef CONFIG_RMI_PHOENIX
+	if (atomic_dec_and_test(&hwtimer_cpu_trigger[smp_processor_id()])) {
+		atomic_set(&hwtimer_cpu_trigger[smp_processor_id()],
+            		num_online_cpus());
+#endif
+
 	spin_lock(mips_hwtimer.lock);
 	if (mips_hwtimer.hook != NULL)
 		(mips_hwtimer.hook)(mips_hwtimer.hook_data);
 	spin_unlock(mips_hwtimer.lock);
+
+#ifdef CONFIG_RMI_PHOENIX
+	}
+#endif
+
 #endif
 out:
 	return IRQ_HANDLED;
@@ -209,6 +225,14 @@ int __cpuinit mips_clockevent_init(void)
 		return -ENXIO;
 
 #if defined (CONFIG_SYS_R4K_CVET_HWTIMER) && defined (CONFIG_HWTIMER_HOOKS)
+
+#ifdef CONFIG_RMI_PHOENIX
+	unsigned int i;
+	for_each_possible_cpu(i)
+		atomic_set(&hwtimer_cpu_trigger[i], i + 1);
+
+	if (smp_processor_id() == 0)
+#endif
 	register_hwtimer(&mips_hwtimer);
 #endif
 	/*
-- 
1.6.0.4

