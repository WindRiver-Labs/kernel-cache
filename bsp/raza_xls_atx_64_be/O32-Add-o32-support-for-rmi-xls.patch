From f0473eff523ce4e05c6bfe8d145fb54ff0b2aacf Mon Sep 17 00:00:00 2001
From: Dongdong Deng <dongdong.deng@windriver.com>
Date: Mon, 7 Jun 2010 15:24:37 +0800
Subject: [PATCH] O32: Add o32 support for rmi xls

Add old 32bit elf format support for rmi xls platform.

source: from RMI SDK1.7

Signed-off-by: shuo.kang <shuo.kang@windriver.com>
---
 arch/mips/kernel/scall64-n32.S |    4 ++--
 arch/mips/kernel/scall64-o32.S |    2 +-
 fs/dcookies.c                  |   37 +++++++++++++++++++++++++++++++++++++
 kernel/sys_ni.c                |    1 +
 4 files changed, 41 insertions(+), 3 deletions(-)

diff --git a/arch/mips/kernel/scall64-n32.S b/arch/mips/kernel/scall64-n32.S
index 082128d..4036745 100644
--- a/arch/mips/kernel/scall64-n32.S
+++ b/arch/mips/kernel/scall64-n32.S
@@ -328,7 +328,7 @@ EXPORT(sysn32_call_table)
 	PTR	sys_io_submit
 	PTR	sys_io_cancel
 	PTR	sys_exit_group			/* 6205 */
-	PTR	sys_lookup_dcookie
+	PTR	compat_sys_lookup_dcookie
 	PTR	sys_epoll_create
 	PTR	sys_epoll_ctl
 	PTR	sys_epoll_wait
@@ -387,7 +387,7 @@ EXPORT(sysn32_call_table)
 	PTR	sys_fchmodat
 	PTR	sys_faccessat
 	PTR	compat_sys_pselect6
-	PTR	sys_ppoll			/* 6265 */
+	PTR	compat_sys_ppoll		/* 6265 */
 	PTR	sys_unshare
 	PTR	sys_splice
 	PTR	sys_sync_file_range
diff --git a/arch/mips/kernel/scall64-o32.S b/arch/mips/kernel/scall64-o32.S
index ba95441..73d6c30 100644
--- a/arch/mips/kernel/scall64-o32.S
+++ b/arch/mips/kernel/scall64-o32.S
@@ -477,7 +477,7 @@ EXPORT(sys_call_table)
 	PTR	sys_io_submit
 	PTR	sys_io_cancel			/* 4245 */
 	PTR	sys_exit_group
-	PTR	sys32_lookup_dcookie
+	PTR compat_sys_lookup_dcookie
 	PTR	sys_epoll_create
 	PTR	sys_epoll_ctl
 	PTR	sys_epoll_wait			/* 4250 */
diff --git a/fs/dcookies.c b/fs/dcookies.c
index f0da95b..64c975a 100644
--- a/fs/dcookies.c
+++ b/fs/dcookies.c
@@ -201,6 +201,43 @@ asmlinkage long SyS_lookup_dcookie(u64 cookie64, long buf, long len)
 SYSCALL_ALIAS(sys_lookup_dcookie, SyS_lookup_dcookie);
 #endif
 
+#if defined (CONFIG_64BIT) && defined (CONFIG_RMI_PHOENIX)
+#if defined (CONFIG_MIPS32_O32) || defined (CONFIG_MIPS32_N32)
+#ifdef CONFIG_HAVE_SYSCALL_WRAPPERS
+compat_SyS_lookup_dcookie(u32 cookie_msb, u32 cookie_lsb,
+        compat_uptr_t buf, compat_size_t len)
+{
+	u64 cookie;
+	char __user *user_buf;
+	size_t size;
+
+	size = (size_t)len;
+
+	user_buf = compat_ptr(buf);
+	cookie = (((u64)cookie_msb) << 32) | (u64)cookie_lsb;
+
+	return SYSC_lookup_dcookie(cookie, user_buf, size);
+}
+SYSCALL_ALIAS(compat_sys_lookup_dcookie, compat_SyS_lookup_dcookie);
+#else
+compat_sys_lookup_dcookie(u32 cookie_msb, u32 cookie_lsb,
+        compat_uptr_t buf, compat_size_t len)
+{
+	u64 cookie;
+	char __user *user_buf;
+	size_t size;
+
+	size = (size_t)len;
+
+	user_buf = compat_ptr(buf);
+	cookie = (((u64)cookie_msb) << 32) | (u64)cookie_lsb;
+
+	return sys_lookup_dcookie(cookie, user_buf, size);
+}
+#endif
+#endif
+#endif
+
 static int dcookie_init(void)
 {
 	struct list_head * d;
diff --git a/kernel/sys_ni.c b/kernel/sys_ni.c
index 2fba5eb..1fa86fa 100644
--- a/kernel/sys_ni.c
+++ b/kernel/sys_ni.c
@@ -21,6 +21,7 @@ cond_syscall(sys_quotactl);
 cond_syscall(sys32_quotactl);
 cond_syscall(sys_acct);
 cond_syscall(sys_lookup_dcookie);
+cond_syscall(compat_sys_lookup_dcookie);
 cond_syscall(sys_swapon);
 cond_syscall(sys_swapoff);
 cond_syscall(sys_kexec_load);
-- 
1.6.0.4

