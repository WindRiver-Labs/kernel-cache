From 3dd3ea5e8b9def5120f476ae92254a89fa6ab958 Mon Sep 17 00:00:00 2001
From: zumeng chen <zchen@pek-cc-pb02l.(none)>
Date: Fri, 20 Jun 2008 19:55:16 +0800
Subject: [PATCH] EXAR XR17C152 init

This patch addes pci exar init routine into
8250_pci.c.

Signed-off-by: zumeng chen <zumeng.chen@windriver.com>
Integrated-by: shuo liu <shuo.liu@windriver.com>
---
 drivers/serial/8250_pci.c |   61 ++++++++++++++++++++++++++++++++++++++++++++-
 1 files changed, 60 insertions(+), 1 deletions(-)

diff --git a/drivers/serial/8250_pci.c b/drivers/serial/8250_pci.c
index 01c012d..064616c 100644
--- a/drivers/serial/8250_pci.c
+++ b/drivers/serial/8250_pci.c
@@ -621,6 +621,53 @@ pci_timedia_setup(struct serial_private *priv,
 
 	return setup_port(priv, port, bar, offset, board->reg_shift);
 }
+/*
+ *
+ * EXAR XR17C152 setup routine
+ *
+ */
+static int __devinit pci_exar_init(struct pci_dev *dev)
+{
+	u8 *p;
+	u8 reg;
+	u16 i; 
+
+	if ((pci_resource_flags(dev, 0) & IORESOURCE_MEM) == 0) {
+		moan_device("no memory in bar 0", dev);
+		return 0;
+	}
+
+	p = ioremap(pci_resource_start(dev, 0), 0x80);
+	if (p == NULL)
+		return -ENOMEM;
+
+	/*
+	 * soft reset uart channels  (make sure in 16550 mode)
+	 */ 
+	writeb(0x03, (unsigned long)p + 0x8A);
+
+	/*
+	 * Set baud clock prescaler to divide by 4 mode 
+	 */
+
+	for ( i = 0; i <= 0x200; i += 0x200 ) {
+	/* set EFR Bit 4 */
+		reg = readb( (unsigned long)p + i + 0x09 );
+	writeb( (reg|0x10), ((unsigned long)p + i + 0x09));
+
+	/* set MCR Bit 7 */
+	reg = readb( (unsigned long)p + i + 0x04 );
+	writeb( (reg|0x80), ((unsigned long)p + i + 0x04) );
+
+	/* clear EFR Bit 4 */
+	reg = readb( (unsigned long)p + i + 0x09 );
+	writeb( (reg&0xef), ((unsigned long)p + i + 0x09) );
+	}
+
+	iounmap(p);
+
+	return 0;
+}
 
 /*
  * Some Titan cards are also a little weird
@@ -1393,6 +1440,18 @@ static struct pci_serial_quirk pci_serial_quirks[] __refdata = {
 		.init		= pci_oxsemi_tornado_init,
 		.setup		= pci_default_setup,
 	},
+
+	/* 
+	 * EXAR XR17C152
+	 */
+	{
+		.vendor         = PCI_VENDOR_ID_EXAR,
+		.device         = PCI_DEVICE_ID_EXAR_XR17C152,
+		.subvendor      = PCI_ANY_ID,
+		.subdevice      = PCI_ANY_ID,
+		.init           = pci_exar_init,
+		.setup          = pci_default_setup,
+	},
 	/*
 	 * Default "match everything" terminator entry
 	 */
@@ -2144,7 +2203,7 @@ static struct pciserial_board pci_boards[] __devinitdata = {
 	[pbn_exar_XR17C152] = {
 		.flags		= FL_BASE0,
 		.num_ports	= 2,
-		.base_baud	= 921600,
+		.base_baud	= 230400,
 		.uart_offset	= 0x200,
 	},
 	[pbn_exar_XR17C154] = {
-- 
1.6.5.2

