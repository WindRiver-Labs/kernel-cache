From bd18e7e50b789b05068d3e5eab863155d8b68dc8 Mon Sep 17 00:00:00 2001
From: Benjamin Walsh <benjamin.walsh@windriver.com>
Date: Sat, 11 Jul 2009 17:07:53 -0400
Subject: [PATCH] RMI/kexec: Add copy of boot parameters for kexec

Boot parameters live in the bootloader memory space for a short
while when the kernel boots, but get overwritten shortly after.
Since the second kernel needs access to them when booting, they
have to be saved in the first kernel's memory until passed to it.

Signed-off-by: Benjamin Walsh <benjamin.walsh@windriver.com>
---
 arch/mips/rmi/ptr/setup.c |   24 +++++++++++++++++++++++-
 1 files changed, 23 insertions(+), 1 deletions(-)

diff --git a/arch/mips/rmi/ptr/setup.c b/arch/mips/rmi/ptr/setup.c
index 4ad2492..0ff7e08 100644
--- a/arch/mips/rmi/ptr/setup.c
+++ b/arch/mips/rmi/ptr/setup.c
@@ -1060,6 +1060,18 @@ void prom_update_exclude_region(void)
 #define FALSE 0
 
 struct boot_mem_map prom_map;
+#ifdef CONFIG_KEXEC
+/* In the case of kexec, these are needed to be passed to the next kernel.
+ * The bootloader's memory gets overwritten, so we have to keep another copy
+ * in the kernel's memory so that they can get passed to the second kernel.
+ * Since the second kernel's data/bss segments will most probably be stomping
+ * on the first kernel's, these will be copied to an intermediate page
+ * obtained at runtime when preparing the second kernel.
+ */
+struct boot_mem_map psb_mem_map_copy;
+struct boot_mem_map avail_mem_map_copy;
+struct boot_mem_map *avail_mem_map_copy_ptr = NULL;
+#endif
 int use_default_phymem = FALSE;
 
 void read_prom_memory(void)
@@ -1079,7 +1091,17 @@ void read_prom_memory(void)
 	if (!(map->nr_map > 0 && map->nr_map <= 32))
 		goto use_default;
 	memcpy(&prom_map, map, sizeof(struct boot_mem_map));
-	
+
+#ifdef CONFIG_KEXEC
+	/* keep what's needed for a possible kexec call */
+	memcpy(&psb_mem_map_copy, (void*)prom_info->psb_mem_map,
+			sizeof(struct boot_mem_map));
+	if(prom_info->avail_mem_map) {
+		memcpy(&avail_mem_map_copy, map, sizeof(struct boot_mem_map));
+		avail_mem_map_copy_ptr = &avail_mem_map_copy;
+	}
+#endif
+
 	return;
 
 use_default:
-- 
1.6.0.4

