From 7d8d4c94491291f6433b780001bb42f8f9c9c087 Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Wed, 4 Nov 2009 13:37:44 +0800
Subject: [PATCH] Ptrace fixup for raza_xlr_atx BSP

Add a cache flush in ptrace to avoid cache inconsistency.

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 arch/mips/kernel/ptrace32.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/arch/mips/kernel/ptrace32.c b/arch/mips/kernel/ptrace32.c
index 76818be..306fcf8 100644
--- a/arch/mips/kernel/ptrace32.c
+++ b/arch/mips/kernel/ptrace32.c
@@ -35,6 +35,7 @@
 #include <asm/system.h>
 #include <asm/uaccess.h>
 #include <asm/bootinfo.h>
+#include <asm/cacheflush.h>
 
 int ptrace_getregs(struct task_struct *child, __s64 __user *data);
 int ptrace_setregs(struct task_struct *child, __s64 __user *data);
@@ -241,6 +242,9 @@ asmlinkage int sys32_ptrace(int request, int pid, int addr, int data)
 	case PTRACE_POKETEXT: /* write the word at location addr. */
 	case PTRACE_POKEDATA:
 		ret = 0;
+#ifdef CONFIG_RMI_PHOENIX
+		__flush_cache_all();
+#endif
 		if (access_process_vm(child, addr, &data, sizeof(data), 1)
 		    == sizeof(data))
 			break;
-- 
1.6.0.4

