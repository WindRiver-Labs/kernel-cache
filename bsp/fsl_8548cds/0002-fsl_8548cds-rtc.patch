From e3b51f3ace8293cd7f90e2d870bcad95b7170786 Mon Sep 17 00:00:00 2001
From: lwang1 <li.wang@windriver.com>
Date: Mon, 1 Sep 2008 09:46:03 +0800
Subject: [PATCH] Add rtc support to fsl_8548cds

Add dts file and platform device for rtc support of fsl_8548cds(Freescale).

Signed-off-by: Li Wang <Li.Wang@windriver.com>
---
 arch/powerpc/boot/dts/mpc8548cds.dts      |    9 +++++++
 arch/powerpc/platforms/85xx/mpc85xx_cds.c |   35 ++++++++++++++++++++++++++++-
 2 files changed, 43 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/boot/dts/mpc8548cds.dts b/arch/powerpc/boot/dts/mpc8548cds.dts
index 6d00074..719b738 100644
--- a/arch/powerpc/boot/dts/mpc8548cds.dts
+++ b/arch/powerpc/boot/dts/mpc8548cds.dts
@@ -493,6 +493,7 @@
 
 		ranges = <0x0 0x0 0xff800000 0x00800000		/*8MB Flash boot bank*/
 			  0x1 0x0 0xff000000 0x00800000		/*8MB Flash 2nd bank*/
+			  0x2 0x0 0xf8000000 0x00002000		/*rtc1553/NVRAM*/
 			  0x3 0x0 0xf0000000 0x04000000>;	/*64MB SDRAM*/
 
 		flash@0,0 {
@@ -525,5 +526,13 @@
 				reg = <0x00000000 0x00800000>;
 			};
 		};
+
+		rtc@2,0 {
+			device_type = "rtc";
+			compatible = "rtc-ds1553";
+			#address-cells = <2>;
+			#size-cells = <1>;
+			reg = <0x2 0x0 0x00002000>;
+		};
 	};
 };
diff --git a/arch/powerpc/platforms/85xx/mpc85xx_cds.c b/arch/powerpc/platforms/85xx/mpc85xx_cds.c
index 50d7ea8..53cd787 100644
--- a/arch/powerpc/platforms/85xx/mpc85xx_cds.c
+++ b/arch/powerpc/platforms/85xx/mpc85xx_cds.c
@@ -54,7 +54,7 @@
 #define CM_VER	(0)
 #define CM_CSR	(1)
 #define CM_RST	(2)
-
+#undef CONFIG_PPC_I8259
 
 static int cds_pci_slot = 2;
 static volatile u8 *cadmus;
@@ -185,6 +185,39 @@ static struct irqaction mpc85xxcds_8259_irqaction = {
 #endif /* PPC_I8259 */
 #endif /* CONFIG_PCI */
 
+#if defined(CONFIG_RTC_CLASS) && defined(CONFIG_RTC_DRV_DS1553)
+static int __init mpc85xx_ds1553_rtc_init(void)
+{
+	struct device_node *np;
+	struct resource r;
+	struct platform_device *rtc_dev = NULL;
+	int ret;
+
+	np = of_find_compatible_node(NULL, "rtc", "rtc-ds1553");
+	if (NULL == np) {
+		printk(KERN_ERR "Could not find rtc-ds1553 node\n");
+		return -1;
+	}
+
+	ret = of_address_to_resource(np, 0, &r);
+	if (ret) {
+		printk(KERN_ERR "Could not get rtc-ds1553 reg resource\n");
+		return -1;
+	}
+
+	of_node_put(np);
+
+	rtc_dev = platform_device_register_simple("rtc-ds1553", 0, &r, 1);
+	if (IS_ERR(rtc_dev)) {
+		printk(KERN_ERR "Could not platform_device_register_simple rtc-ds1553\n");
+		return -1;
+	}
+
+	return 0;
+}
+arch_initcall(mpc85xx_ds1553_rtc_init);
+#endif /* CONFIG_RTC_CLASS && CONFIG_RTC_DRV_DS1553 */
+
 static void __init mpc85xx_cds_pic_init(void)
 {
 	struct mpic *mpic;
-- 
1.5.5.1

