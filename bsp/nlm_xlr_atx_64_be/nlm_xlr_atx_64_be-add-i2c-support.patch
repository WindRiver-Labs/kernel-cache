From e39ad8cfa926fdb193a52f1acbc3fbcb490b6397 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Mon, 6 Dec 2010 19:54:08 +0800
Subject: [PATCH 20/47] nlm_xlr_atx_64_be: add i2c support

Extracted from RMI SDK 1.7.0.

This enables the PalmChip's I2C interfaces and the BK3220 I2C Host
Adapter on the RMI Phoenix.

[ Zhangjin: Modify the original support to provide standard interfaces
to ensure the default i2c rtc drivers works without any change. ]

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 drivers/i2c/algos/Kconfig         |    9 +
 drivers/i2c/algos/Makefile        |    1 +
 drivers/i2c/algos/i2c-algo-palm.c |  311 +++++++++++++++++++++++++++++++++++++
 drivers/i2c/algos/i2c-algo-palm.h |   71 +++++++++
 drivers/i2c/busses/Kconfig        |   11 ++
 drivers/i2c/busses/Makefile       |    1 +
 drivers/i2c/busses/i2c-bk3220.c   |  130 +++++++++++++++
 include/linux/i2c-id.h            |    3 +
 8 files changed, 537 insertions(+), 0 deletions(-)
 create mode 100644 drivers/i2c/algos/i2c-algo-palm.c
 create mode 100644 drivers/i2c/algos/i2c-algo-palm.h
 create mode 100644 drivers/i2c/busses/i2c-bk3220.c

diff --git a/drivers/i2c/algos/Kconfig b/drivers/i2c/algos/Kconfig
index 7b2ce4a..fe8d326 100644
--- a/drivers/i2c/algos/Kconfig
+++ b/drivers/i2c/algos/Kconfig
@@ -11,6 +11,15 @@ config I2C_ALGOBIT
 config I2C_ALGOPCF
 	tristate "I2C PCF 8584 interfaces"
 
+config I2C_ALGOPALM
+	tristate "PalmChip's I2C interfaces"
+	depends on I2C && RMI_PHOENIX
+	help
+	  This allows you to use the BK3220 I2C Host Adapter on the RMI Phoenix.
+
+	  This support is also available as a module.  If so, the module
+	  will be called i2c-algo-palm.
+
 config I2C_ALGOPCA
 	tristate "I2C PCA 9564 interfaces"
 
diff --git a/drivers/i2c/algos/Makefile b/drivers/i2c/algos/Makefile
index 18b3e96..815f8e0 100644
--- a/drivers/i2c/algos/Makefile
+++ b/drivers/i2c/algos/Makefile
@@ -5,6 +5,7 @@
 obj-$(CONFIG_I2C_ALGOBIT)	+= i2c-algo-bit.o
 obj-$(CONFIG_I2C_ALGOPCF)	+= i2c-algo-pcf.o
 obj-$(CONFIG_I2C_ALGOPCA)	+= i2c-algo-pca.o
+obj-$(CONFIG_I2C_ALGOPALM)	+= i2c-algo-palm.o
 
 ifeq ($(CONFIG_I2C_DEBUG_ALGO),y)
 EXTRA_CFLAGS += -DDEBUG
diff --git a/drivers/i2c/algos/i2c-algo-palm.c b/drivers/i2c/algos/i2c-algo-palm.c
new file mode 100644
index 0000000..5429500
--- /dev/null
+++ b/drivers/i2c/algos/i2c-algo-palm.c
@@ -0,0 +1,311 @@
+/*
+
+  Copyright 2003-2006 Raza Microelectronics, Inc. (RMI). All rights
+  reserved.
+
+  Redistribution and use in source and binary forms, with or without
+  modification, are permitted provided that the following conditions
+  are met:
+
+  1. Redistributions of source code must retain the above copyright
+  notice, this list of conditions and the following disclaimer.
+  2. Redistributions in binary form must reproduce the above copyright
+  notice, this list of conditions and the following disclaimer in
+  the documentation and/or other materials provided with the
+  distribution.
+
+  THIS SOFTWARE IS PROVIDED BY Raza Microelectronics, Inc. ``AS IS'' AND
+  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL RMI OR CONTRIBUTORS BE LIABLE
+  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
+  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
+  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
+  THE POSSIBILITY OF SUCH DAMAGE.
+
+*/
+
+/*
+ *  i2c-algo-palm.c i2c driver algorithms for the BK3220 I2C Host
+ *  adapter on the RMI Phoenix System.
+ *  Derived from the PCA-ISA I2C-Algo/Bus files.
+ */
+
+#include <linux/kernel.h>
+#include <linux/module.h>
+#include <linux/moduleparam.h>
+#include <linux/delay.h>
+#include <linux/slab.h>
+#include <linux/init.h>
+#include <linux/errno.h>
+#include <linux/spinlock.h>
+#include <linux/i2c.h>
+#include "i2c-algo-palm.h"
+
+#define DRIVER "i2c-algo-palm"
+
+#define DEB1(fmt, args...) \
+	do { if (i2c_debug >= 1) pr_info(fmt, ## args); } while (0)
+#define DEB2(fmt, args...) \
+	do { if (i2c_debug >= 2) pr_info(fmt, ## args); } while (0)
+#define DEB3(fmt, args...) \
+	do { if (i2c_debug >= 3) pr_info(fmt, ## args); } while (0)
+
+static int i2c_debug;
+spinlock_t palm_lock;
+
+#define palm_write(algo_data, reg, val)	((algo_data)->write(reg, val))
+#define palm_read(algo_data, reg)	((algo_data)->read(reg))
+
+#define palm_clock(adap)		((adap)->get_clock(adap))
+#define palm_status(adap)		palm_inw(adap, I2C_PCA_STA)
+#define palm_set_con(adap, val)		palm_outw(adap, I2C_PCA_CON, val)
+#define palm_get_con(adap)		palm_inw(adap, I2C_PCA_CON)
+
+/*
+ * Check if the I2C Bus is idle or busy
+ */
+static int wait_for_idle(struct i2c_algo_palm_data *algo_data)
+{
+	int timeOut = 0x1000;
+	volatile __u32 regVal = 0x00;
+	regVal = palm_read(algo_data, I2C_PALM_STATUS) & 0x0001;
+
+	while (regVal && timeOut--)
+		regVal = palm_read(algo_data, I2C_PALM_STATUS) & 0x0001;
+	if (timeOut == 0x00)
+		return -1;	/* Timed Out */
+	else
+		return 0;
+}
+
+
+static int palm_rx(struct i2c_algo_palm_data *algo_data, __u8 *buf,
+		__u16 addr, __u16 length)
+{
+	volatile __u32 tmp, regVal;
+	int len = length, i;
+
+	if (length == 0) /* special case of I2C_SMBUS_QUICK */ {
+		/* issue a address only transaction */
+		palm_write(algo_data, I2C_PALM_DEVADDR, addr);
+		palm_write(algo_data, I2C_PALM_CFG, 0xfa);
+		palm_write(algo_data, I2C_PALM_STARTXFR, 0x3);
+
+		regVal = palm_read(algo_data, I2C_PALM_STATUS);
+		if (regVal & 0x0008) {
+			pr_err("start quick: ACKERR. Aborting...\n");
+			return -1;
+		}
+		return 0;
+	}
+
+
+	palm_write(algo_data, I2C_PALM_DEVADDR, addr);
+	palm_write(algo_data, I2C_PALM_CFG, 0xfa);
+	palm_write(algo_data, I2C_PALM_BYTECNT, len-1);
+	palm_write(algo_data, I2C_PALM_STARTXFR, 0x1);
+
+
+	regVal = palm_read(algo_data, I2C_PALM_STATUS);
+	if (regVal & 0x0008) {
+		pr_err("start read: ACKERR. Aborting...\n");
+		return -1;
+	}
+
+	for (tmp = 0; tmp < len; tmp++) {
+		i = 0;
+		while (1) {
+			regVal = palm_read(algo_data, I2C_PALM_STATUS);
+			if (regVal & 0x4) {
+				buf[tmp] = (__u8)palm_read(algo_data,
+							I2C_PALM_DATAIN);
+				break;
+
+			}
+			mdelay(1);
+			i++;
+			if (i >= 1000) {
+				pr_err("* read Timed OUT byte %d.\n", tmp);
+				return -1;
+			}
+		}
+	}
+	return 0;
+}
+
+
+
+
+static int palm_tx(struct i2c_algo_palm_data *algo_data,  __u16 len,
+		__u8 *buf, __u16 addr)
+{
+	volatile __u32 tmp, regVal;
+	int i;
+
+	if (wait_for_idle(algo_data) < 0) {
+		pr_err("TimedOut on Waiting for I2C Bus Idle.\n");
+		return -1;
+	}
+
+	if (len == 0) { /* special case of I2C_SMBUS_QUICK */
+		/* issue a address only transaction */
+		palm_write(algo_data, I2C_PALM_DEVADDR, addr);
+		palm_write(algo_data, I2C_PALM_CFG, 0xfa);
+		palm_write(algo_data, I2C_PALM_STARTXFR, 0x2);
+
+		regVal = palm_read(algo_data, I2C_PALM_STATUS);
+		if (regVal & 0x0008) {
+			pr_err("start quick: ACKERR. Aborting...\n");
+			return -1;
+		}
+		return 0;
+	}
+
+	palm_write(algo_data, I2C_PALM_DEVADDR, addr);
+	palm_write(algo_data, I2C_PALM_DATAOUT, buf[0]);
+	palm_write(algo_data, I2C_PALM_CFG,     0xfa);
+	palm_write(algo_data, I2C_PALM_BYTECNT, len-1);
+	palm_write(algo_data, I2C_PALM_STARTXFR, 0x0);
+
+	regVal = palm_read(algo_data, I2C_PALM_STATUS);
+	if (regVal & 0x0008) {
+		pr_err("write: ACKERR. Aborting...\n");
+		return -1;
+	}
+
+
+	i = 0x1000;
+	regVal = palm_read(algo_data, I2C_PALM_STATUS);
+	while (!(regVal & 0x0002) && i) {
+		regVal = palm_read(algo_data, I2C_PALM_STATUS);
+		i--;
+	}
+	if (i == 0x00) {
+		pr_err(" Write %d Test failed.[TimeOut]SDOEMPTY Not Set\n", tmp);
+		pr_err(" status: 0x%x.\n", regVal);
+		return -1;
+	}
+
+	for (tmp = 1; tmp < len; tmp++) {
+		palm_write(algo_data, I2C_PALM_DATAOUT, buf[tmp]);
+		palm_write(algo_data, I2C_PALM_STARTXFR, 0x0);
+
+		regVal = palm_read(algo_data, I2C_PALM_STATUS);
+		if (regVal & 0x0008) {
+			pr_err("start write: ACKERR. Aborting...\n");
+			return -1;
+		}
+
+		i = 0x1000;
+		regVal = palm_read(algo_data, I2C_PALM_STATUS);
+		while (!(regVal & 0x0002) && i) {
+			regVal = palm_read(algo_data, I2C_PALM_STATUS);
+			i--;
+		}
+		if (i == 0x00) {
+			pr_err(" Write %d Test failed.[TimeOut]SDOEMPTY Not Set\n", tmp);
+			return -1;
+		}
+	}
+	return 0;
+}
+
+
+static int palm_xfer(struct i2c_adapter *i2c_adap,
+		struct i2c_msg msgs[],
+		int num)
+{
+	struct i2c_algo_palm_data *algo_data = i2c_adap->algo_data;
+	struct i2c_msg *msg = NULL;
+	int curmsg;
+
+	for (curmsg = 0; curmsg < num; curmsg++) {
+		int addr;
+		msg = &msgs[curmsg];
+
+		addr = (0x7f & msg->addr);
+
+		/*
+		 * Check if I2C State Machine is idle
+		 * 'wait_for_idle' returns 0 => timedOut
+		 * 'BUSY' bit cleared => BUS is IDLE
+		 */
+		if (wait_for_idle(algo_data) < 0) {
+			pr_err("TimedOut on Waiting for I2C Bus Idle.\n");
+			return -EIO;
+		}
+		if (msg->flags & I2C_M_RD) {
+			if ((palm_rx(algo_data, &msg->buf[0], addr,
+							msg->len)) == -1) {
+				pr_err("I2C Read Fail.\n");
+				return -EIO;
+			}
+			if (msg->flags & I2C_M_RECV_LEN)
+				msg->len += msg->buf[0];
+		} else if ((palm_tx(algo_data, msg->len, &msg->buf[0],
+						addr)) == -1) {
+				pr_err("I2C Write Fail.\n");
+				return -EIO;
+		}
+	}
+	return num;
+}
+
+static u32 palm_func(struct i2c_adapter *adap)
+{
+	/* We emulate SMBUS over I2C */
+	return I2C_FUNC_SMBUS_EMUL;
+}
+
+static int palm_init(struct i2c_algo_palm_data *algo_data)
+{
+	pr_info("Intializing BK-3220 I2C Host Adapter...");
+	spin_lock_init(&palm_lock);
+	pr_info("done.\n");
+	return 0;
+}
+
+static struct i2c_algorithm palm_algo = {
+	.master_xfer	= palm_xfer,
+	.functionality	= palm_func,
+};
+
+/*
+ * registering functions to load algorithms at runtime
+ */
+int i2c_palm_add_bus(struct i2c_adapter *adap)
+{
+	struct i2c_algo_palm_data *palm_adap = adap->algo_data;
+	int rval;
+
+	adap->algo = &palm_algo;
+
+	adap->timeout = 100;
+	adap->retries = 3;
+
+	rval = palm_init(palm_adap);
+
+	/* register new adapter to i2c module... */
+	if (!rval)
+		i2c_add_numbered_adapter(adap);
+
+	return rval;
+}
+
+int i2c_palm_del_bus(struct i2c_adapter *adap)
+{
+	return i2c_del_adapter(adap);
+}
+
+EXPORT_SYMBOL(i2c_palm_add_bus);
+EXPORT_SYMBOL(i2c_palm_del_bus);
+
+MODULE_AUTHOR("RMI");
+MODULE_DESCRIPTION("I2C-Bus PalmChip's Host Adapter algorithm");
+MODULE_LICENSE("GPL");
+
+module_param(i2c_debug, int, 0);
diff --git a/drivers/i2c/algos/i2c-algo-palm.h b/drivers/i2c/algos/i2c-algo-palm.h
new file mode 100644
index 0000000..9571015
--- /dev/null
+++ b/drivers/i2c/algos/i2c-algo-palm.h
@@ -0,0 +1,71 @@
+/*
+
+  Copyright 2003-2006 Raza Microelectronics, Inc. (RMI). All rights
+  reserved.
+
+  Redistribution and use in source and binary forms, with or without
+  modification, are permitted provided that the following conditions
+  are met:
+
+  1. Redistributions of source code must retain the above copyright
+  notice, this list of conditions and the following disclaimer.
+  2. Redistributions in binary form must reproduce the above copyright
+  notice, this list of conditions and the following disclaimer in
+  the documentation and/or other materials provided with the
+  distribution.
+
+  THIS SOFTWARE IS PROVIDED BY Raza Microelectronics, Inc. ``AS IS'' AND
+  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL RMI OR CONTRIBUTORS BE LIABLE
+  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
+  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
+  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
+  THE POSSIBILITY OF SUCH DAMAGE.
+
+*/
+
+/*
+ *  i2c-algo-palm.c i2c driver algorithms for the BK3220 I2C Host
+ *  adapter on the RMI Phoenix System.
+ *  Derived from the PCA-ISA I2C-Algo/Bus files.
+ */
+
+#ifndef I2C_PALM_H
+#define I2C_PALM_H
+
+#define I2C_PALM_CFG			0x00
+#define I2C_PALM_CLKDIV			0x01
+#define I2C_PALM_DEVADDR		0x02
+#define I2C_PALM_ADDR			0x03
+#define I2C_PALM_DATAOUT		0x04
+#define I2C_PALM_DATAIN			0x05
+#define I2C_PALM_STATUS			0x06
+#define I2C_PALM_STARTXFR		0x07
+#define I2C_PALM_BYTECNT		0x08
+#define I2C_PALM_HDSTATIM		0x09
+
+/* TEST Values!! Change as required */
+#define I2C_PALM_CFG_DEF		0x000000F8	/* 8-Bit Addr + POR Values */
+#define I2C_PALM_CLKDIV_DEF		0x14A /* 0x00000052 */
+#define I2C_PALM_HDSTATIM_DEF		0x107 /* 0x00000000 */
+
+#define I2C_PALM_STARTXFR_RD		0x00000001
+#define I2C_PALM_STARTXFR_WR		0x00000000
+
+#define WORD	1
+
+struct i2c_algo_palm_data {
+	void (*write)(int ctl, int val);
+	int  (*read) (int ctl);
+};
+
+#define I2C_PCA_ADAP_MAX	16
+
+int i2c_palm_add_bus(struct i2c_adapter *);
+int i2c_palm_del_bus(struct i2c_adapter *);
+
+#endif /* I2C_PALM_H */
diff --git a/drivers/i2c/busses/Kconfig b/drivers/i2c/busses/Kconfig
index 9c6170c..6948fcd 100644
--- a/drivers/i2c/busses/Kconfig
+++ b/drivers/i2c/busses/Kconfig
@@ -295,6 +295,17 @@ config I2C_AT91
 	  to support combined I2C messages.  Use the i2c-gpio driver
 	  unless your system can cope with those limitations.
 
+config I2C_BK3220
+	tristate "PalmChip BK-3220"
+	depends on I2C && EXPERIMENTAL
+	select I2C_ALGOPALM
+	help
+	  This supports the BK-3220 I2C adapter.  Say Y if you own
+	  such an adapter.
+
+	  This support is also available as a module.  If so, the module
+	  will be called i2c-bk3220.
+
 config I2C_AU1550
 	tristate "Au1550/Au1200 SMBus interface"
 	depends on SOC_AU1550 || SOC_AU1200
diff --git a/drivers/i2c/busses/Makefile b/drivers/i2c/busses/Makefile
index 097236f..0b5c4c9 100644
--- a/drivers/i2c/busses/Makefile
+++ b/drivers/i2c/busses/Makefile
@@ -12,6 +12,7 @@ obj-$(CONFIG_I2C_ALI15X3)	+= i2c-ali15x3.o
 obj-$(CONFIG_I2C_AMD756)	+= i2c-amd756.o
 obj-$(CONFIG_I2C_AMD756_S4882)	+= i2c-amd756-s4882.o
 obj-$(CONFIG_I2C_AMD8111)	+= i2c-amd8111.o
+obj-$(CONFIG_I2C_BK3220)	+= i2c-bk3220.o
 obj-$(CONFIG_I2C_I801)		+= i2c-i801.o
 obj-$(CONFIG_I2C_ISCH)		+= i2c-isch.o
 obj-$(CONFIG_I2C_NFORCE2)	+= i2c-nforce2.o
diff --git a/drivers/i2c/busses/i2c-bk3220.c b/drivers/i2c/busses/i2c-bk3220.c
new file mode 100644
index 0000000..7aa40f2
--- /dev/null
+++ b/drivers/i2c/busses/i2c-bk3220.c
@@ -0,0 +1,130 @@
+/*
+  Copyright 2003-2006 Raza Microelectronics, Inc. (RMI). All rights
+  reserved.
+
+  Redistribution and use in source and binary forms, with or without
+  modification, are permitted provided that the following conditions
+  are met:
+
+  1. Redistributions of source code must retain the above copyright
+  notice, this list of conditions and the following disclaimer.
+  2. Redistributions in binary form must reproduce the above copyright
+  notice, this list of conditions and the following disclaimer in
+  the documentation and/or other materials provided with the
+  distribution.
+
+  THIS SOFTWARE IS PROVIDED BY Raza Microelectronics, Inc. ``AS IS'' AND
+  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL RMI OR CONTRIBUTORS BE LIABLE
+  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
+  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
+  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
+  THE POSSIBILITY OF SUCH DAMAGE.
+*/
+
+/*
+ *  i2c-palm-bk3220.c driver for the BK-3220 Host Adapter on the
+ *  RMI Phoenix System.
+ */
+
+#include <linux/kernel.h>
+#include <linux/ioport.h>
+#include <linux/module.h>
+#include <linux/moduleparam.h>
+#include <linux/delay.h>
+#include <linux/slab.h>
+#include <linux/init.h>
+#include <linux/interrupt.h>
+#include <linux/pci.h>
+#include <linux/wait.h>
+#include <linux/i2c.h>
+#include <asm/io.h>
+#include <asm/irq.h>
+#include <asm/rmi/iomap.h>
+#include <asm/rmi/sim.h>
+
+#include "../algos/i2c-algo-palm.h"
+
+#undef	DEBUG
+
+#define ARIZONA_RTC_BUS 1
+#define PHOENIX_CPLD_PHYS_ADDR	0xbd850000
+
+static wait_queue_head_t palm_wait;
+__u32 *iobase_i2c_regs;
+
+__u32 *get_i2c_base(unsigned short bus)
+{
+	phoenix_reg_t *mmio = 0;
+
+	if (bus == 0)
+		mmio = phoenix_io_mmio(PHOENIX_IO_I2C_0_OFFSET);
+	else
+		mmio = phoenix_io_mmio(PHOENIX_IO_I2C_1_OFFSET);
+
+	return (__u32 *)mmio;
+}
+
+static void palm_bk3220_write(int reg, int val)
+{
+	/*
+	 * Code to access the low-level
+	 * I2C Block on the RMI Phoenix
+	 */
+	phoenix_write_reg(iobase_i2c_regs, reg, val);
+}
+
+static int palm_bk3220_read(int reg)
+{
+	/*
+	* Code to access the low-level
+	* I2C Block on the RMI Phoenix
+	*/
+	__u32 retVal = phoenix_read_reg(iobase_i2c_regs, reg);
+	return (int)retVal;
+}
+
+static struct i2c_algo_palm_data palm_bk3220_data = {
+	.write		= palm_bk3220_write,
+	.read		= palm_bk3220_read,
+};
+
+/* This is our i2c_adapter structure */
+static struct i2c_adapter palm_bk3220_ops = {
+	.owner	= THIS_MODULE,
+	.id		= I2C_HW_PALM_BK3220,
+	.algo_data	= &palm_bk3220_data,
+	.nr		= 0,
+	.name		= "Palm Chip BK3220 Adapter",
+};
+
+static int __init palm_bk3220_init(void)
+{
+	iobase_i2c_regs = get_i2c_base(ARIZONA_RTC_BUS);
+
+	init_waitqueue_head(&palm_wait);
+
+	if (i2c_palm_add_bus(&palm_bk3220_ops) < 0) {
+		pr_err("i2c-palm-bk3220: Failed to add i2c bus\n");
+		return -ENODEV;
+	} else
+		pr_info("i2c-palm-bk3220: Added I2C Bus.\n");
+
+	return 0;
+}
+
+static void palm_bk3220_exit(void)
+{
+	i2c_palm_del_bus(&palm_bk3220_ops);
+}
+
+MODULE_AUTHOR("RMI Inc.");
+MODULE_DESCRIPTION("BK3220 I2C Host adapter driver");
+MODULE_LICENSE("GPL");
+
+module_init(palm_bk3220_init);
+module_exit(palm_bk3220_exit);
diff --git a/include/linux/i2c-id.h b/include/linux/i2c-id.h
index e844a0b..2a5cbbb 100644
--- a/include/linux/i2c-id.h
+++ b/include/linux/i2c-id.h
@@ -56,4 +56,7 @@
 #define I2C_HW_SAA7146		0x060000 /* SAA7146 video decoder bus */
 #define I2C_HW_SAA7134		0x090000 /* SAA7134 video decoder bus */
 
+/* --- Palm Chip adapter */
+#define I2C_HW_PALM_BK3220	0x00
+
 #endif /* LINUX_I2C_ID_H */
-- 
1.7.0.4

