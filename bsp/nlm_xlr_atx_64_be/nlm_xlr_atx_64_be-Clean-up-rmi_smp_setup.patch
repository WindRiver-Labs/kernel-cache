From eba1d91f323bb1557f6eb9bccd340fc04977f799 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Wed, 2 Mar 2011 14:20:00 +0800
Subject: [PATCH 45/47] nlm_xlr_atx_64_be: Clean up rmi_smp_setup

This clears the cpu_possible_map and adds phys_cpu_present_map,
cpu_present_map.

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/mips/rmi/ptr/smp.c |   29 ++++++++++++++++++++---------
 1 files changed, 20 insertions(+), 9 deletions(-)

diff --git a/arch/mips/rmi/ptr/smp.c b/arch/mips/rmi/ptr/smp.c
index 44732b7..83fe388 100644
--- a/arch/mips/rmi/ptr/smp.c
+++ b/arch/mips/rmi/ptr/smp.c
@@ -122,38 +122,49 @@ unsigned int fast_syscall_cpumask_phy = 0x1;
 
 void __init rmi_smp_setup(void)
 {
-	int num_cpus = 1, i;
+	cpumask_t phys_cpu_present_map;	/* Bitmask of available CPUs */
+	int num_cpus;
+	int i;
+
 	__u32 boot_cpu_online_map = 0, boot_cpu = 0x0;
 
 	boot_cpu = hard_smp_processor_id();
 
+	cpus_clear(phys_cpu_present_map);
 	cpus_clear(cpu_possible_map);
 
 	boot_cpu_online_map = smp_boot.online_map;
 	pr_info("(PROM) CPU present map: %x\n", boot_cpu_online_map);
 
-	/* Fill the entries for boot cpu */
+	/*
+	 * the entry in the logical_map should be the bootcpu and all
+	 * others proceeds after that
+	 * Fill the entries for boot cpu
+	 */
 	boot_cpu_online_map &= (~(1 << boot_cpu));
-	cpu_set(boot_cpu, cpu_possible_map);
+	cpu_set(boot_cpu, phys_cpu_present_map);
+
 	__cpu_number_map[boot_cpu] = 0;
 	__cpu_logical_map[0] = boot_cpu;
 	cpu_set(0, cpu_possible_map);
 
+	num_cpus = 1;
 	for (i = 0; i < NR_CPUS; i++) {
 		if (boot_cpu_online_map & (1 << i)) {
-			cpu_set(i, cpu_possible_map);
+			cpu_set(num_cpus, cpu_possible_map);
 			__cpu_number_map[i] = num_cpus;
 			__cpu_logical_map[num_cpus] = i;
-			cpu_set(num_cpus, cpu_possible_map);
-			++num_cpus;
+			num_cpus++;
 		}
 	}
+	cpu_present_map = cpu_possible_map;
 
-	fast_syscall_cpumask_phy = (unsigned int)cpu_possible_map.bits[0];
+	fast_syscall_cpumask_phy = (unsigned int)phys_cpu_present_map.bits[0];
 
+	pr_info("Boot CPU: %d\n", boot_cpu);
 	pr_info("Phys CPU present map: %lx, possible map %lx\n",
-		(unsigned long)cpu_possible_map.bits[0],
-		(unsigned long)cpu_possible_map.bits[0]);
+	       (unsigned long)phys_cpu_present_map.bits[0],
+	       (unsigned long)cpu_possible_map.bits[0]);
 
 	pr_info("Detected %i Slave CPU(s)\n", num_cpus);
 }
-- 
1.7.0.4

