From a59b761a75f1193f63ccef14eae6f532ae85e366 Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Wed, 19 May 2010 23:57:28 +0800
Subject: [PATCH 11/47] nlm_xlr_atx_64_be: add mips mmap extention

Add the XLR's mmap check function.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/mips/include/asm/mman.h |    5 +++++
 arch/mips/kernel/syscall.c   |   16 ++++++++++++++++
 2 files changed, 21 insertions(+), 0 deletions(-)

diff --git a/arch/mips/include/asm/mman.h b/arch/mips/include/asm/mman.h
index c892bfb..2737abf 100644
--- a/arch/mips/include/asm/mman.h
+++ b/arch/mips/include/asm/mman.h
@@ -80,4 +80,9 @@
 /* compatibility flags */
 #define MAP_FILE	0
 
+#if defined(CONFIG_RMI_PHOENIX) && defined(CONFIG_64BIT)
+#define arch_mmap_check(addr, len, flags) mips_mmap_check(addr, len, flags)
+int mips_mmap_check(unsigned long addr, unsigned long len,
+		unsigned long flags);
+#endif
 #endif /* _ASM_MMAN_H */
diff --git a/arch/mips/kernel/syscall.c b/arch/mips/kernel/syscall.c
index b8405bc..6aced3d 100644
--- a/arch/mips/kernel/syscall.c
+++ b/arch/mips/kernel/syscall.c
@@ -136,6 +136,22 @@ unsigned long arch_get_unmapped_area(struct file *filp, unsigned long addr,
 	}
 }
 
+#if defined(CONFIG_RMI_PHOENIX) && defined(CONFIG_64BIT)
+int mips_mmap_check(unsigned long addr, unsigned long len,
+		unsigned long flags)
+{
+	int app_is_32bit = test_thread_flag(TIF_32BIT_ADDR);
+
+	if (app_is_32bit) {
+		if (len >= TASK_SIZE32)
+			return -EINVAL;
+		if ((flags & MAP_FIXED) && addr > (TASK_SIZE32 - len))
+			return -EINVAL;
+	}
+	return 0;
+}
+#endif
+
 SYSCALL_DEFINE6(mips_mmap, unsigned long, addr, unsigned long, len,
 	unsigned long, prot, unsigned long, flags, unsigned long,
 	fd, off_t, offset)
-- 
1.7.0.4

