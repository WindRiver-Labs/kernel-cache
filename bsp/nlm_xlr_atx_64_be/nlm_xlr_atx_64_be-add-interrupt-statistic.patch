From 43488951a510467fa27eceaa2c621c1e8eb199d0 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Wed, 15 Dec 2010 15:05:34 +0800
Subject: [PATCH 40/47] nlm_xlr_atx_64_be: add interrupt statistic

This patch clears the action name for different types of interrupts and
add statistic for them respectively.

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/mips/rmi/phoenix/irq.c     |   59 ++++++++++++++++++++++++++++++--------
 arch/mips/rmi/phoenix/on_chip.c |    3 ++
 arch/mips/rmi/phoenix/smp.c     |    3 ++
 3 files changed, 52 insertions(+), 13 deletions(-)

diff --git a/arch/mips/rmi/phoenix/irq.c b/arch/mips/rmi/phoenix/irq.c
index 519b618..b13a431 100644
--- a/arch/mips/rmi/phoenix/irq.c
+++ b/arch/mips/rmi/phoenix/irq.c
@@ -246,14 +246,6 @@ static irqreturn_t phnx_rsvd_irq_handler(int irq, void *dev_id)
 	return IRQ_NONE;
 }
 
-struct irqaction phnx_rsvd_action = {
-	.handler = phnx_rsvd_irq_handler,
-	.flags = 0,
-	.name = "phnx_rsvd_action",
-	.dev_id = 0,
-	.next = 0
-};
-
 extern int noirqdebug;
 
 void handle_xlr_irq(unsigned int irq, struct irq_desc *desc)
@@ -277,6 +269,47 @@ void handle_xlr_irq(unsigned int irq, struct irq_desc *desc)
 		desc->chip->eoi(irq);
 }
 
+struct irqaction remote_debug_action = {
+	.handler = phnx_rsvd_irq_handler,
+	.flags = 0,
+	.name = "remote_debug",
+	.dev_id = 0,
+	.next = 0
+};
+
+struct irqaction smp_function_action = {
+	.handler = phnx_rsvd_irq_handler,
+	.flags = 0,
+	.name = "ipi_smp_func",
+	.dev_id = 0,
+	.next = 0
+};
+
+struct irqaction smp_resched_action = {
+	.handler = phnx_rsvd_irq_handler,
+	.flags = 0,
+	.name = "ipi_smp_resched",
+	.dev_id = 0,
+	.next = 0
+};
+
+struct irqaction netrx_action = {
+	.handler = phnx_rsvd_irq_handler,
+	.flags = 0,
+	.name = "ipi_netrx",
+	.dev_id = 0,
+	.next = 0
+};
+
+struct irqaction msgring_action = {
+	.handler = phnx_rsvd_irq_handler,
+	.flags = 0,
+	.name = "msgring",
+	.dev_id = 0,
+	.next = 0
+};
+
+
 void __init init_phoenix_irqs(void)
 {
 	int i;
@@ -286,16 +319,16 @@ void __init init_phoenix_irqs(void)
 
 #ifdef CONFIG_REMOTE_DEBUG
 	irq_desc[IRQ_REMOTE_DEBUG].chip = &phnx_rsvd_pic;
-	irq_desc[IRQ_REMOTE_DEBUG].action = phnx_rsvd_action;
+	irq_desc[IRQ_REMOTE_DEBUG].action = remote_debug_action;
 	phnx_irq_mask |= (1ULL << IRQ_REMOTE_DEBUG);
 #endif
 
 #ifdef CONFIG_SMP
 	irq_desc[IRQ_IPI_SMP_FUNCTION].chip = &phnx_rsvd_pic;
-	irq_desc[IRQ_IPI_SMP_FUNCTION].action = &phnx_rsvd_action;
+	irq_desc[IRQ_IPI_SMP_FUNCTION].action = &smp_function_action;
 
 	irq_desc[IRQ_IPI_SMP_RESCHEDULE].chip = &phnx_rsvd_pic;
-	irq_desc[IRQ_IPI_SMP_RESCHEDULE].action = &phnx_rsvd_action;
+	irq_desc[IRQ_IPI_SMP_RESCHEDULE].action = &smp_resched_action;
 
 	phnx_irq_mask |=
 	    	((1ULL << IRQ_IPI_SMP_FUNCTION) | (1ULL << IRQ_IPI_SMP_RESCHEDULE));
@@ -303,7 +336,7 @@ void __init init_phoenix_irqs(void)
 #ifdef CONFIG_PHOENIX_IP_FLOW_AFFINITY
 	/* PR: New IPI added here for netrx balancing */
 	irq_desc[IRQ_IPI_NETRX].chip = &phnx_rsvd_pic;
-	irq_desc[IRQ_IPI_NETRX].action = &phnx_rsvd_action;
+	irq_desc[IRQ_IPI_NETRX].action = &netrx_action;
 	phnx_irq_mask |= (1ULL<<IRQ_IPI_NETRX);
 #endif
 
@@ -311,7 +344,7 @@ void __init init_phoenix_irqs(void)
 
 	/* msgring interrupt */
 	irq_desc[IRQ_MSGRING].chip = &phnx_rsvd_pic;
-	irq_desc[IRQ_MSGRING].action = &phnx_rsvd_action;
+	irq_desc[IRQ_MSGRING].action = &msgring_action;
 	phnx_irq_mask |= (1ULL << IRQ_MSGRING);
 
 	irq_desc[IRQ_TIMER].chip = &phnx_rsvd_pic_irq_timer;
diff --git a/arch/mips/rmi/phoenix/on_chip.c b/arch/mips/rmi/phoenix/on_chip.c
index 5788432..de5388b 100644
--- a/arch/mips/rmi/phoenix/on_chip.c
+++ b/arch/mips/rmi/phoenix/on_chip.c
@@ -26,6 +26,7 @@
   THE POSSIBILITY OF SUCH DAMAGE.
  */
 
+#include <linux/kernel_stat.h>
 #include <linux/init.h>
 #include <linux/smp.h>
 #include <linux/interrupt.h>
@@ -433,6 +434,8 @@ void phnx_msgring_int_handler(unsigned int irq, struct pt_regs *regs)
 		/* normal message ring interrupt */
 		phnx_inc_counter(MSGRNG_INT);
 		phoenix_cpu_stat_update_msgring_int();
+
+		kstat_incr_irqs_this_cpu(irq, irq_to_desc(irq));
 	} else {
 		phoenix_cpu_stat_update_msgring_pic_int();
 	}
diff --git a/arch/mips/rmi/phoenix/smp.c b/arch/mips/rmi/phoenix/smp.c
index 7793b5c..36d683a 100644
--- a/arch/mips/rmi/phoenix/smp.c
+++ b/arch/mips/rmi/phoenix/smp.c
@@ -26,6 +26,7 @@
   THE POSSIBILITY OF SUCH DAMAGE.
 */
 
+#include <linux/kernel_stat.h>
 #include <linux/hardirq.h>
 #include <linux/module.h>
 
@@ -78,6 +79,8 @@ extern __u64 phnx_irq_mask;
 
 void phoenix_ipi_handler(int irq, struct pt_regs *regs)
 {
+	kstat_incr_irqs_this_cpu(irq, irq_to_desc(irq));
+
 	if (irq == IRQ_IPI_SMP_FUNCTION) {
 		pr_debug("[%s]: cpu_%d processing ipi_%d\n", __func__,
 			 smp_processor_id(), irq);
-- 
1.7.0.4

