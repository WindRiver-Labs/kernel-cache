From c342c5d06cf3afbdcb2f8a4261766daf396446dd Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Fri, 8 Jul 2011 01:49:07 +0800
Subject: [PATCH] nlm_xlr_atx_64_be: Workaround pata_pdc2027x for >2G RAM

pata_pdc2027x has been observed that it didn't work well in DMA mode
with >2G RAM, so, libata.force=1:pio4 is used to force it work in PIO
mode before, but PIO mode is too slow, especially for the big partition.

This finally workaround the DMA mode with a simple and clean method:

  o Limit the DMA zone in low 2G (Already done in previous patch)
  o Change ATA_DMA_MASK to 31bit for pata_pdc2027x and RMI board
  o Force dma_alloc_noncoherent() allocate memory in DMA zone
    arch/mips/mm/dma-default.c (Already done in previous patch)

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 drivers/ata/pata_pdc2027x.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/ata/pata_pdc2027x.c b/drivers/ata/pata_pdc2027x.c
index 0116529..b1b9f7e 100644
--- a/drivers/ata/pata_pdc2027x.c
+++ b/drivers/ata/pata_pdc2027x.c
@@ -44,6 +44,11 @@
 #define PDPRINTK(fmt, args...)
 #endif
 
+#ifdef CONFIG_RMI_PHOENIX
+#undef ATA_DMA_MASK
+#define ATA_DMA_MASK	DMA_BIT_MASK(31)
+#endif
+
 enum {
 	PDC_MMIO_BAR		= 5,
 
-- 
1.7.0.4

