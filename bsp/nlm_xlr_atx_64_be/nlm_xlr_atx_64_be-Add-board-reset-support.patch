From 0ab81d100ed3f7e7bc948355e123f575053cff98 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Thu, 2 Dec 2010 13:51:50 +0800
Subject: [PATCH 19/47] nlm_xlr_atx_64_be: Add board reset support

This part is separated from the original setup support to simplify the
future maintaining.

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/mips/rmi/ptr/Makefile |    3 +-
 arch/mips/rmi/ptr/reset.c  |   45 ++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 47 insertions(+), 1 deletions(-)
 create mode 100644 arch/mips/rmi/ptr/reset.c

diff --git a/arch/mips/rmi/ptr/Makefile b/arch/mips/rmi/ptr/Makefile
index 6d79cfa..1d1fa3a 100644
--- a/arch/mips/rmi/ptr/Makefile
+++ b/arch/mips/rmi/ptr/Makefile
@@ -1,4 +1,5 @@
-obj-y			= setup.o
+obj-y			= setup.o reset.o
+
 obj-$(CONFIG_SMP)      += smp.o smpboot.o
 
 EXTRA_AFLAGS := $(CFLAGS)
diff --git a/arch/mips/rmi/ptr/reset.c b/arch/mips/rmi/ptr/reset.c
new file mode 100644
index 0000000..c13f5c7
--- /dev/null
+++ b/arch/mips/rmi/ptr/reset.c
@@ -0,0 +1,45 @@
+/*
+ * This program is free software; you can redistribute  it and/or modify it
+ * under  the terms of  the GNU General  Public License as published by the
+ * Free Software Foundation;  either version 2 of the  License, or (at your
+ * option) any later version.
+ *
+ * Copyright (C) 2010 Wind River Systems,
+ *   written by Wu Zhangjin <zhangjin.wu@windriver.com>
+ */
+#include <linux/kernel.h>
+#include <linux/init.h>
+#include <linux/pm.h>
+
+#include <asm/reboot.h>
+#include <asm/rmi/iomap.h>
+
+#define GPIO_SWRESET_REG 8
+
+static void ptr_exit(void)
+{
+	phoenix_reg_t *mmio = phoenix_io_mmio(PHOENIX_IO_GPIO_OFFSET);
+
+	/* trigger a chip reset */
+	phoenix_write_reg(mmio, GPIO_SWRESET_REG, 1);
+	for (;;)
+		cpu_wait();
+}
+
+static void ptr_restart(char *c)
+{
+	ptr_exit();
+}
+
+static int __init ptr_reboot_setup(void)
+{
+	panic_timeout = 5;
+
+	_machine_restart = ptr_restart;
+	_machine_halt = ptr_exit;
+	pm_power_off = ptr_exit;
+
+	return 0;
+}
+
+arch_initcall(ptr_reboot_setup);
-- 
1.7.0.4

