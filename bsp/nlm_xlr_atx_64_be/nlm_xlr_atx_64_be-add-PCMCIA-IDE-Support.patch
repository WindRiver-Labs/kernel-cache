From 7e84c49d49028d7b4fad3a52b33d1af5bb014ec7 Mon Sep 17 00:00:00 2001
From: Wu Zhangjin <zhangjin.wu@windriver.com>
Date: Mon, 27 Dec 2010 16:21:27 +0800
Subject: [PATCH 29/47] nlm_xlr_atx_64_be: add PCMCIA IDE Support

The PCMCIA Card/IDE support is added with the help of the pata_platform
driver(PATA_PLATFORM with libata interface or BLK_DEV_PLATFORM with ide
interface).

Signed-off-by: Wu Zhangjin <zhangjin.wu@windriver.com>
---
 arch/mips/rmi/phoenix/platform.c |   55 ++++++++++++++++++++++++++++++++++++++
 1 files changed, 55 insertions(+), 0 deletions(-)

diff --git a/arch/mips/rmi/phoenix/platform.c b/arch/mips/rmi/phoenix/platform.c
index 90efbfb..2fcc407 100644
--- a/arch/mips/rmi/phoenix/platform.c
+++ b/arch/mips/rmi/phoenix/platform.c
@@ -13,6 +13,12 @@
 
 #include <linux/i2c.h>
 
+#include <linux/dma-mapping.h>
+#include <linux/ata_platform.h>
+#include <asm/rmi/pic.h>
+#include <asm/rmi/phoenix_ide.h>
+#include <asm/rmi/sim.h>
+
 static struct i2c_board_info rmi_i2c_info[] __initdata = {
 	{
 		I2C_BOARD_INFO("ds1374", 0x68),
@@ -99,10 +105,51 @@ static struct platform_device rmi_mtd_device = {
 	.resource	= &rmi_mtd_resource,
 };
 
+#define IDE_SHIFT	0
+#define IDE_BASE	0x1f0
+#define IDE_CTRL	0x3f6
+
+static struct pata_platform_info rmi_ide_platdata = {
+	.ioport_shift	= IDE_SHIFT,
+};
+
+static struct resource rmi_ide_res[] = {
+	[0] = {
+		.start	= IDE_PHYS + (IDE_BASE << IDE_SHIFT),
+		.end	= IDE_PHYS + (IDE_BASE << IDE_SHIFT) + 8*32 - 1,
+		.flags	= IORESOURCE_MEM,
+	},
+	[1] = {
+		.start	= IDE_PHYS + (IDE_CTRL << IDE_SHIFT),
+		.end	= IDE_PHYS + (IDE_CTRL << IDE_SHIFT) + 32 - 1,
+		.flags	= IORESOURCE_MEM,
+	},
+	[2] = {
+		.start	= PIC_PCMCIA_IRQ,
+		.end	= PIC_PCMCIA_IRQ,
+		.flags	= IORESOURCE_IRQ,
+	}
+};
+
+static struct platform_device rmi_ide_device = {
+	.name		= "pata_platform",
+	.id		= 0,
+	.dev = {
+		.platform_data		= &rmi_ide_platdata,
+		.coherent_dma_mask	= ~0,
+	},
+	.num_resources	= ARRAY_SIZE(rmi_ide_res),
+	.resource	= rmi_ide_res,
+};
+
 static struct platform_device *rmi_mtd_devices[] __initdata = {
 	&rmi_mtd_device,
 };
 
+static struct platform_device *rmi_ide_devices[] __initdata = {
+	&rmi_ide_device,
+};
+
 int xlr_platform_init(void)
 {
 	int err;
@@ -121,6 +168,14 @@ int xlr_platform_init(void)
 	if (err < 0)
 		pr_err("phoenix-mtd: cannot register board mtd devices\n");
 
+	if (xlr_board_atx_i()) {
+		pr_info("Register phoenix ide devices\n");
+		err = platform_add_devices(rmi_ide_devices, ARRAY_SIZE(rmi_ide_devices));
+
+		if (err < 0)
+			pr_err("phoenix-ide: cannot register board ide devices\n");
+	}
+
 	return err;
 }
 
-- 
1.7.0.4

