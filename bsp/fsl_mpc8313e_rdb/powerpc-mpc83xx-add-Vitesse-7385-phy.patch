From 686190a336c0cb05c167bedab9ebc5d41148f0e1 Mon Sep 17 00:00:00 2001
From: Luo Chunbo <chunbo.luo@windriver.com>
Date: Tue, 6 Apr 2010 16:24:23 +0800
Subject: [PATCH 1/3] powerpc/mpc83xx: add Vitesse 7385 phy

Support the vitesse 7385 phy on the plaform.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
Integrated-by: Luo Chunbo <chunbo.luo@windriver.com>
---
 drivers/net/phy/Kconfig        |    6 ++
 drivers/net/phy/Makefile       |    1 +
 drivers/net/phy/phy_device.c   |   13 +++++
 drivers/net/phy/vitesse_7385.c |  108 ++++++++++++++++++++++++++++++++++++++++
 include/linux/phy.h            |    8 +++-
 5 files changed, 135 insertions(+), 1 deletions(-)
 create mode 100644 drivers/net/phy/vitesse_7385.c

diff --git a/drivers/net/phy/Kconfig b/drivers/net/phy/Kconfig
index fc5938b..dff603b 100644
--- a/drivers/net/phy/Kconfig
+++ b/drivers/net/phy/Kconfig
@@ -45,6 +45,12 @@ config VITESSE_PHY
         ---help---
           Currently supports the vsc8244
 
+config VITESSE_7385
+	tristate "Drivers for the Vitesse 7385 L2 switch"
+	depends on PHYLIB
+	---help---
+	  Currently supports the vsc7385
+
 config SMSC_PHY
 	tristate "Drivers for SMSC PHYs"
 	---help---
diff --git a/drivers/net/phy/Makefile b/drivers/net/phy/Makefile
index 1342585..2babf61 100644
--- a/drivers/net/phy/Makefile
+++ b/drivers/net/phy/Makefile
@@ -10,6 +10,7 @@ obj-$(CONFIG_LXT_PHY)		+= lxt.o
 obj-$(CONFIG_QSEMI_PHY)		+= qsemi.o
 obj-$(CONFIG_SMSC_PHY)		+= smsc.o
 obj-$(CONFIG_VITESSE_PHY)	+= vitesse.o
+obj-$(CONFIG_VITESSE_7385)	+= vitesse_7385.o
 obj-$(CONFIG_BROADCOM_PHY)	+= broadcom.o
 obj-$(CONFIG_BCM63XX_PHY)	+= bcm63xx.o
 obj-$(CONFIG_ICPLUS_PHY)	+= icplus.o
diff --git a/drivers/net/phy/phy_device.c b/drivers/net/phy/phy_device.c
index db17945..8d7da47 100644
--- a/drivers/net/phy/phy_device.c
+++ b/drivers/net/phy/phy_device.c
@@ -235,6 +235,19 @@ struct phy_device * get_phy_device(struct mii_bus *bus, int addr)
 	if (r)
 		return ERR_PTR(r);
 
+#ifdef CONFIG_MPC831x_RDB
+	/* if the switch on the MPC8313ERDB platform */
+	if (addr == MPC8313ERDB_SWITCHADDR)
+		phy_id = MPC8313ERDB_SWITCHID;
+
+	/* on platform, a reading of address 0x1F returns a value of 0 and
+	* causes a PHY to be hooked in to this address.  If 0x1f, return
+	* NULL (i.e. no PHY present).  Not sure if this is platform specific
+	* or TSEC specific */
+	if (addr == 0x1f)
+		return NULL;
+#endif /* CONFIG_MPC831x_RDB */
+
 	/* If the phy_id is mostly Fs, there is no device there */
 	if ((phy_id & 0x1fffffff) == 0x1fffffff)
 		return NULL;
diff --git a/drivers/net/phy/vitesse_7385.c b/drivers/net/phy/vitesse_7385.c
new file mode 100644
index 0000000..a1a3d3e
--- /dev/null
+++ b/drivers/net/phy/vitesse_7385.c
@@ -0,0 +1,108 @@
+/*
+ * drivers/net/phy/vitesse_7385.c
+ *
+ * Dummy Ethernet switch driver for MPC8313ERDB platform
+ *
+ * Author:  Tony Li <Tony.Li@freescale.com>
+ *      Based on the MPC8349-mITX switch code. All the substantial init
+ *      operations has been done in u-boot. This code just creats a dummy
+ *      phy device to deal with kernel stock and do not touch hardware.
+ *
+ * Copyright (C) 2006 Freescale Semiconductor, Inc.
+ *
+ * This program is free software; you can redistribute  it and/or modify it
+ * under  the terms of  the GNU General  Public License as published by the
+ * Free Software Foundation;  either version 2 of the  License, or (at your
+ * option) any later version.
+ *
+ */
+
+#include <linux/kernel.h>
+#include <linux/sched.h>
+#include <linux/string.h>
+#include <linux/errno.h>
+#include <linux/unistd.h>
+#include <linux/slab.h>
+#include <linux/interrupt.h>
+#include <linux/init.h>
+#include <linux/delay.h>
+#include <linux/netdevice.h>
+#include <linux/etherdevice.h>
+#include <linux/skbuff.h>
+#include <linux/spinlock.h>
+#include <linux/mm.h>
+#include <linux/module.h>
+#include <linux/mii.h>
+#include <linux/ethtool.h>
+#include <linux/phy.h>
+
+#include <linux/io.h>
+#include <asm/irq.h>
+#include <linux/uaccess.h>
+
+MODULE_DESCRIPTION("Dummy Ethernet switch driver for MPC8313ERDB platform");
+MODULE_AUTHOR("Tony Li");
+MODULE_LICENSE("GPL");
+
+static int vitesse_7385_config_init(struct phy_device *phydev)
+{
+	return 0;
+}
+
+static int vitesse_7385_ack_interrupt(struct phy_device *phydev)
+{
+	return 0;
+}
+
+static int vitesse_7385_config_intr(struct phy_device *phydev)
+{
+	return 0;
+}
+
+static int vitesse_7385_config_aneg(struct phy_device *phydev)
+{
+	return 0;
+}
+
+static int vitesse_7385_read_status(struct phy_device *phydev)
+{
+	/* Switch is always assumed to be up */
+	phydev->speed = SPEED_1000;
+	phydev->duplex = DUPLEX_FULL;
+	phydev->pause = phydev->asym_pause = 0;
+/*	phydev->link = 1;
+	phydev->state = PHY_RUNNING;
+	netif_carrier_on(phydev->attached_dev);
+*/
+	return 0;
+}
+
+
+
+/* Dummy Ethernet switch driver for MPC8313ERDB platform */
+static struct phy_driver vitesse_7385_driver = {
+	.phy_id		= MPC8313ERDB_SWITCHID,
+	.name		= "MPC8313ERDB Ethernet Switch",
+	.phy_id_mask	= 0x0000FFFF,
+	.features	= PHY_GBIT_FEATURES,
+	.flags		= 0,
+	.config_init	= &vitesse_7385_config_init,
+	.config_aneg	= &vitesse_7385_config_aneg,
+	.read_status	= &vitesse_7385_read_status,
+	.ack_interrupt	= &vitesse_7385_ack_interrupt,
+	.config_intr	= &vitesse_7385_config_intr,
+	.driver		= { .owner = THIS_MODULE,},
+};
+
+static int __init vitesse_7385_init(void)
+{
+	return phy_driver_register(&vitesse_7385_driver);
+}
+
+static void __exit vitesse_7385_exit(void)
+{
+	phy_driver_unregister(&vitesse_7385_driver);
+}
+
+module_init(vitesse_7385_init);
+module_exit(vitesse_7385_exit);
diff --git a/include/linux/phy.h b/include/linux/phy.h
index 14d7fdf..909774f 100644
--- a/include/linux/phy.h
+++ b/include/linux/phy.h
@@ -6,7 +6,10 @@
  *
  * Author: Andy Fleming
  *
- * Copyright (c) 2004 Freescale Semiconductor, Inc.
+ * Copyright (c) 2004-2006 Freescale Semiconductor, Inc.
+ * CHANGLOG:
+ *     2006: Tony Li(Tony.Li@freescale.com)
+ *             Add MPC8313ERDB specific phy support
  *
  * This program is free software; you can redistribute  it and/or modify it
  * under  the terms of  the GNU General  Public License as published by the
@@ -27,6 +30,9 @@
 
 #include <asm/atomic.h>
 
+#define MPC8313ERDB_SWITCHADDR 0x1     /* PHY Address 1*/
+#define MPC8313ERDB_SWITCHID   0x8349  /* PHY ID */
+
 #define PHY_BASIC_FEATURES	(SUPPORTED_10baseT_Half | \
 				 SUPPORTED_10baseT_Full | \
 				 SUPPORTED_100baseT_Half | \
-- 
1.6.5.2

