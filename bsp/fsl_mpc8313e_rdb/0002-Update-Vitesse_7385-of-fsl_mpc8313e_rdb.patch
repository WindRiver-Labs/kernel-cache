From 51ff31372437d3bcab3744f852a633ac4b04b169 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Thu, 11 Dec 2008 14:08:37 +0800
Subject: [PATCH] Update Vitesse_7385 of fsl_mpc8313e_rdb

Support the vitesse 7385 phy on the plaform.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 drivers/net/phy/Kconfig        |    6 ++
 drivers/net/phy/Makefile       |    1 +
 drivers/net/phy/phy_device.c   |   16 ++++++-
 drivers/net/phy/vitesse_7385.c |  108 ++++++++++++++++++++++++++++++++++++++++
 include/linux/phy.h            |   10 +++-
 5 files changed, 139 insertions(+), 2 deletions(-)
 create mode 100644 drivers/net/phy/vitesse_7385.c

diff --git a/drivers/net/phy/Kconfig b/drivers/net/phy/Kconfig
index d55932a..a035ec8 100644
--- a/drivers/net/phy/Kconfig
+++ b/drivers/net/phy/Kconfig
@@ -45,6 +45,12 @@ config VITESSE_PHY
         ---help---
           Currently supports the vsc8244
 
+config VITESSE_7385
+        tristate "Drivers for the Vitesse 7385 L2 switch"
+        depends on PHYLIB
+        ---help---
+          Currently supports the vsc7385
+
 config SMSC_PHY
 	tristate "Drivers for SMSC PHYs"
 	---help---
diff --git a/drivers/net/phy/Makefile b/drivers/net/phy/Makefile
index eee329f..cdd460a 100644
--- a/drivers/net/phy/Makefile
+++ b/drivers/net/phy/Makefile
@@ -10,6 +10,7 @@ obj-$(CONFIG_LXT_PHY)		+= lxt.o
 obj-$(CONFIG_QSEMI_PHY)		+= qsemi.o
 obj-$(CONFIG_SMSC_PHY)		+= smsc.o
 obj-$(CONFIG_VITESSE_PHY)	+= vitesse.o
+obj-$(CONFIG_VITESSE_7385)	+= vitesse_7385.o
 obj-$(CONFIG_BROADCOM_PHY)	+= broadcom.o
 obj-$(CONFIG_ICPLUS_PHY)	+= icplus.o
 obj-$(CONFIG_REALTEK_PHY)	+= realtek.o
diff --git a/drivers/net/phy/phy_device.c b/drivers/net/phy/phy_device.c
index 16a0e7d..455f891 100644
--- a/drivers/net/phy/phy_device.c
+++ b/drivers/net/phy/phy_device.c
@@ -6,7 +6,11 @@
  *
  * Author: Andy Fleming
  *
- * Copyright (c) 2004 Freescale Semiconductor, Inc.
+ * Copyright (C) 2004-2006 Freescale Semiconductor, Inc.
+ *
+ * Change log:
+ * 2006: Tony Li(Tony.Li@freescale.com)
+ *           Add MPC8313ERDB specific phy support.
  *
  * This program is free software; you can redistribute  it and/or modify it
  * under  the terms of  the GNU General  Public License as published by the
@@ -227,6 +231,16 @@ struct phy_device * get_phy_device(struct mii_bus *bus, int addr)
 	if (r)
 		return ERR_PTR(r);
 
+#ifdef CONFIG_MPC831x_RDB
+       if (addr == MPC8313ERDB_SWITCHADDR)     /* if the switch on the MPC8313ERDB platform */
+               phy_id = MPC8313ERDB_SWITCHID;
+
+       /* on platform, a reading of address 0x1F returns a value of 0 and causes a PHY to be hooked in to this
+       address.  If 0x1f, return NULL (i.e. no PHY present).  Not sure if this is platform specific or TSEC specific */
+       if (addr == 0x1f)
+                return NULL;
+#endif /* CONFIG_MPC831x_RDB */
+
 	/* If the phy_id is all Fs, there is no device there */
 	if (0xffffffff == phy_id)
 		return NULL;
diff --git a/drivers/net/phy/vitesse_7385.c b/drivers/net/phy/vitesse_7385.c
new file mode 100644
index 0000000..a2eec25
--- /dev/null
+++ b/drivers/net/phy/vitesse_7385.c
@@ -0,0 +1,108 @@
+/*
+ * drivers/net/phy/vitesse_7385.c
+ *
+ * Dummy Ethernet switch driver for MPC8313ERDB platform
+ *
+ * Author:  Tony Li <Tony.Li@freescale.com>
+ *      Based on the MPC8349-mITX switch code. All the substantial init
+ *      operations has been done in u-boot. This code just creats a dummy
+ *      phy device to deal with kernel stock and do not touch hardware.
+ *
+ * Copyright (C) 2006 Freescale Semiconductor, Inc.
+ *
+ * This program is free software; you can redistribute  it and/or modify it
+ * under  the terms of  the GNU General  Public License as published by the
+ * Free Software Foundation;  either version 2 of the  License, or (at your
+ * option) any later version.
+ *
+ */
+
+#include <linux/kernel.h>
+#include <linux/sched.h>
+#include <linux/string.h>
+#include <linux/errno.h>
+#include <linux/unistd.h>
+#include <linux/slab.h>
+#include <linux/interrupt.h>
+#include <linux/init.h>
+#include <linux/delay.h>
+#include <linux/netdevice.h>
+#include <linux/etherdevice.h>
+#include <linux/skbuff.h>
+#include <linux/spinlock.h>
+#include <linux/mm.h>
+#include <linux/module.h>
+#include <linux/mii.h>
+#include <linux/ethtool.h>
+#include <linux/phy.h>
+
+#include <asm/io.h>
+#include <asm/irq.h>
+#include <asm/uaccess.h>
+
+MODULE_DESCRIPTION("Dummy Ethernet switch driver for MPC8313ERDB platform");
+MODULE_AUTHOR("Tony Li");
+MODULE_LICENSE("GPL");
+
+static int vitesse_7385_config_init(struct phy_device *phydev)
+{
+	return 0;
+}
+
+static int vitesse_7385_ack_interrupt(struct phy_device *phydev)
+{
+	return 0;
+}
+
+static int vitesse_7385_config_intr(struct phy_device *phydev)
+{
+	return 0;
+}
+
+static int vitesse_7385_config_aneg(struct phy_device *phydev)
+{
+	return 0;
+}
+
+static int vitesse_7385_read_status(struct phy_device *phydev)
+{
+	/* Switch is always assumed to be up */
+	phydev->speed = SPEED_1000;
+	phydev->duplex = DUPLEX_FULL;
+	phydev->pause = phydev->asym_pause = 0;
+/*	phydev->link = 1;
+	phydev->state = PHY_RUNNING;
+	netif_carrier_on(phydev->attached_dev);
+*/
+	return 0;
+}
+
+
+
+/* Dummy Ethernet switch driver for MPC8313ERDB platform */
+static struct phy_driver vitesse_7385_driver = {
+	.phy_id		= MPC8313ERDB_SWITCHID,
+	.name		= "MPC8313ERDB Ethernet Switch",
+	.phy_id_mask	= 0x0000FFFF,
+	.features	= PHY_GBIT_FEATURES,
+	.flags		= 0,
+	.config_init	= &vitesse_7385_config_init,
+	.config_aneg	= &vitesse_7385_config_aneg,
+	.read_status	= &vitesse_7385_read_status,
+	.ack_interrupt	= &vitesse_7385_ack_interrupt,
+	.config_intr	= &vitesse_7385_config_intr,
+	.driver 	= { .owner = THIS_MODULE,},
+};
+
+static int __init vitesse_7385_init(void)
+{
+	return phy_driver_register(&vitesse_7385_driver);
+}
+
+static void __exit vitesse_7385_exit(void)
+{
+	phy_driver_unregister(&vitesse_7385_driver);
+}
+
+module_init(vitesse_7385_init);
+module_exit(vitesse_7385_exit);
diff --git a/include/linux/phy.h b/include/linux/phy.h
index 7224c40..4fb21dd 100644
--- a/include/linux/phy.h
+++ b/include/linux/phy.h
@@ -6,7 +6,10 @@
  *
  * Author: Andy Fleming
  *
- * Copyright (c) 2004 Freescale Semiconductor, Inc.
+ * Copyright (c) 2004-2006 Freescale Semiconductor, Inc.
+ * CHANGLOG:
+ *     2006: Tony Li(Tony.Li@freescale.com)
+ *             Add MPC8313ERDB specific phy support
  *
  * This program is free software; you can redistribute  it and/or modify it
  * under  the terms of  the GNU General  Public License as published by the
@@ -27,6 +30,11 @@
 
 #include <asm/atomic.h>
 
+#ifdef CONFIG_MPC831x_RDB      /* TSEC2 (switch) PHY hack  */
+#define MPC8313ERDB_SWITCHADDR 0x1     /* PHY Address 1*/
+#define MPC8313ERDB_SWITCHID   0x8349  /* PHY ID */
+#endif /* CONFIG_MPC831x_RDB */
+
 #define PHY_BASIC_FEATURES	(SUPPORTED_10baseT_Half | \
 				 SUPPORTED_10baseT_Full | \
 				 SUPPORTED_100baseT_Half | \
-- 
1.6.0.2.GIT

