From e2dfb3ab82aa31ad3159d5e4f0188758fdcfc5e4 Mon Sep 17 00:00:00 2001
From: Pardha Saradhi K <pardha.saradhi.kesapragada@intel.com>
Date: Wed, 26 Oct 2016 16:34:54 +0530
Subject: [PATCH 4706/4706] ASoC: Intel: Skylake: Decouple/Recouple for Stream
 Format

commit 435c0950fd5b89eba02860a3aadc85b8247a5ff9 from
git://git.yoctoproject.org/linux-yocto-4.1

Due to a bug in DMA FIFO HW, the controller needs to be put in
coupled mode before performing writes to the Stream Format Register.
Once the write is completed, it can be reconfigured back to
de-coupled mode
This WA is needed to avoid roll over of the DMA Buffer in the FW
code, before even the DSP consumes data. If not done, this can result
in audio being played slowly as the DSP inserts silence data to
complete 1ms frame.

Change-Id: I439b4d13e2a18aa1b90cf959a251835479f90903
Signed-off-by: Pardha Saradhi K <pardha.saradhi.kesapragada@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/11762
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Sangaraju, KarthikeyaX <karthikeyax.sangaraju@intel.com>
---
 sound/soc/intel/skylake/skl-pcm.c |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-pcm.c b/sound/soc/intel/skylake/skl-pcm.c
index 9b9e3db..d45055d 100644
--- a/sound/soc/intel/skylake/skl-pcm.c
+++ b/sound/soc/intel/skylake/skl-pcm.c
@@ -271,7 +271,17 @@ static int skl_pcm_prepare(struct snd_pcm_substream *substream,
 	if (err < 0)
 		return err;
 
+	/*
+	 * Hardware WA valid for upto C Steppings of BXT-P -
+	 * Before writing to Format Register, put the controller in
+	 * coupled mode. Once done, put it back to de-coupled mode.
+	 * This WA is needed to avoid the DMA roll-over even before
+	 * the DSP consumes the data from the buffer
+	 */
+	snd_hdac_ext_stream_decouple(ebus, stream, false);
 	err = snd_hdac_stream_setup(hdac_stream(stream));
+	snd_hdac_ext_stream_decouple(ebus, stream, true);
+
 	if (err < 0)
 		return err;
 
-- 
1.7.5.4

