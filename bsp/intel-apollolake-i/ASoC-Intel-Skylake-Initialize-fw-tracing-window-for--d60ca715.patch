From 0059936f603427b1d31bbaff8ac76dae115ffb5b Mon Sep 17 00:00:00 2001
From: "Panwar, Ashish" <ashish.panwar@intel.com>
Date: Wed, 20 Jan 2016 19:15:24 +0530
Subject: [PATCH 1855/2508] ASoC: Intel: Skylake: Initialize fw tracing window
 for skylake.

commit 024fadb750c773026dde9296897624cc2aea063a from
https://github.com/01org/linux-apollolake-i

Here, we initialize the tracing window for the platform along
with the firmware write pointers.

Change-Id: If2170f01cd5925b56129f9a60015d4985cec04a6
Signed-off-by: Panwar, Ashish <ashish.panwar@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/8049
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
---
 sound/soc/intel/skylake/skl-sst.c |   17 ++++++++++++++++-
 1 files changed, 16 insertions(+), 1 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-sst.c b/sound/soc/intel/skylake/skl-sst.c
index 54fed0a..7f5f8738 100644
--- a/sound/soc/intel/skylake/skl-sst.c
+++ b/sound/soc/intel/skylake/skl-sst.c
@@ -20,9 +20,9 @@
 #include <linux/delay.h>
 #include <linux/device.h>
 #include "../common/sst-dsp.h"
-#include "../common/sst-dsp-priv.h"
 #include "../common/sst-ipc.h"
 #include "skl-sst-ipc.h"
+#include "skl-fwlog.h"
 
 #define SKL_BASEFW_TIMEOUT	300
 #define SKL_INIT_TIMEOUT	1000
@@ -30,6 +30,13 @@
 /* Intel HD Audio SRAM Window 0*/
 #define SKL_ADSP_SRAM0_BASE	0x8000
 
+/* Trace Buffer Window */
+#define SKL_ADSP_SRAM2_BASE     0x0C000
+#define SKL_ADSP_W2_SIZE        0x2000
+#define SKL_ADSP_WP_DSP0        (SKL_ADSP_SRAM0_BASE+0x30)
+#define SKL_ADSP_WP_DSP1        (SKL_ADSP_SRAM0_BASE+0x34)
+#define SKL_ADSP_NR_DSP         2
+
 /* Firmware status window */
 #define SKL_ADSP_FW_STATUS	SKL_ADSP_SRAM0_BASE
 #define SKL_ADSP_ERROR_CODE	(SKL_ADSP_FW_STATUS + 0x4)
@@ -434,6 +441,7 @@ int skl_sst_dsp_init(struct device *dev, void __iomem *mmio_base, int irq,
 {
 	struct skl_sst *skl;
 	struct sst_dsp *sst;
+	u32 dsp_wp[] = {SKL_ADSP_WP_DSP0, SKL_ADSP_WP_DSP1};
 	int ret;
 
 	skl = devm_kzalloc(dev, sizeof(*skl), GFP_KERNEL);
@@ -456,6 +464,13 @@ int skl_sst_dsp_init(struct device *dev, void __iomem *mmio_base, int irq,
 	sst_dsp_mailbox_init(sst, (SKL_ADSP_SRAM0_BASE + SKL_ADSP_W0_STAT_SZ),
 			SKL_ADSP_W0_UP_SZ, SKL_ADSP_SRAM1_BASE, SKL_ADSP_W1_SZ);
 
+	ret = skl_dsp_init_trace_window(sst, dsp_wp, SKL_ADSP_SRAM2_BASE,
+				SKL_ADSP_W2_SIZE, SKL_ADSP_NR_DSP);
+	if (ret) {
+		dev_err(dev, "Fw tracing init failed : %x", ret);
+		return ret;
+	}
+
 	INIT_LIST_HEAD(&sst->module_list);
 	sst->dsp_ops = dsp_ops;
 	sst->fw_ops = skl_fw_ops;
-- 
1.7.5.4

