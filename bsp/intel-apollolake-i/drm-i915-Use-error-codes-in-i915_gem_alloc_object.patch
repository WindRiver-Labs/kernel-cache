From a7c1520e8792d2c7d98f37397446479483d51bae Mon Sep 17 00:00:00 2001
From: Jeff McGee <jeff.mcgee@intel.com>
Date: Fri, 30 Sep 2016 13:21:12 -0700
Subject: [PATCH 66/68] drm/i915: Use error codes in i915_gem_alloc_object

commit a49b9421e275dbe7ec5019df720b18f55f72237d from
git://git.yoctoproject.org/linux-yocto-4.1

Commit "drm/i915: Propagating correct error codes to the userspace"
updated i915_gem_create to expect error pointers instead of NULL
pointers but did not update i915_gem_alloc_object correspondingly.
So NULL pointers returned from i915_gem_alloc_object were missed and
later dereferenced.

Signed-off-by: Jeff McGee <jeff.mcgee@intel.com>
---
 drivers/gpu/drm/i915/i915_gem.c |    8 +++++---
 1 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gem.c b/drivers/gpu/drm/i915/i915_gem.c
index 98e3e01..4da3a93 100644
--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -5452,14 +5452,16 @@ struct drm_i915_gem_object *i915_gem_alloc_object(struct drm_device *dev,
 						  size_t size)
 {
 	struct drm_i915_gem_object *obj;
+	int ret;
 
 	obj = i915_gem_object_alloc(dev);
 	if (obj == NULL)
-		return NULL;
+		return ERR_PTR(-ENOMEM);
 
-	if (drm_gem_object_init(dev, &obj->base, size) != 0) {
+	ret = drm_gem_object_init(dev, &obj->base, size);
+	if (ret) {
 		i915_gem_object_free(obj);
-		return NULL;
+		return ERR_PTR(ret);
 	}
 
 	i915_gem_set_inode_gfp(dev, obj->base.filp);
-- 
1.7.5.4

