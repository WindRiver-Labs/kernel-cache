From 1329ac8ba104762cd0f3ee4d3eb2043a94ccf708 Mon Sep 17 00:00:00 2001
From: Yael Samet <yael.samet@intel.com>
Date: Sun, 6 Nov 2016 07:40:37 +0200
Subject: [PATCH 4639/4706] mei: dal: initialize ta access list for IVM
 device.

commit 08ad0f3749e74adc019a2697d3926bbd51413b66 from
git://git.yoctoproject.org/linux-yocto-4.1

The IVM device type limits access to trusted applications.

Change-Id: Iffc59adcdfc5d7c457e61ab681333e76b669a3b4
Signed-off-by: Yael Samet <yael.samet@intel.com>
---
 drivers/misc/mei/dal/dal_class.c |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/drivers/misc/mei/dal/dal_class.c b/drivers/misc/mei/dal/dal_class.c
index 0a70c54..d18825c 100644
--- a/drivers/misc/mei/dal/dal_class.c
+++ b/drivers/misc/mei/dal/dal_class.c
@@ -565,6 +565,8 @@ static void dal_class_release(struct device *dev)
 {
 	struct dal_device *ddev = to_dal_device(dev);
 
+	dal_access_list_free(ddev);
+
 	kfree(ddev);
 }
 
@@ -617,6 +619,14 @@ static int dal_probe(struct mei_cl_device *cldev,
 
 	dal_dev_setup(ddev);
 
+	if (ddev->device_id == DAL_MEI_DEVICE_IVM) {
+		ret = dal_access_list_init(ddev);
+		if (ret) {
+			dev_err(&cldev->dev, "failed to init access list\n");
+			goto err_dev_create;
+		}
+	}
+
 	ret = device_register(&ddev->dev);
 	if (ret) {
 		dev_err(&cldev->dev, "unable to register device\n");
-- 
1.7.5.4

