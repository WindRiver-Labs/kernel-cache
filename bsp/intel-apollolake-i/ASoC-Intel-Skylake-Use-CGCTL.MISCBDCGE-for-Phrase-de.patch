From 6726ed6503888e12a7ed5aa4b65b7716ec50b5e0 Mon Sep 17 00:00:00 2001
From: "Dharageswari.R" <dharageswari.r@intel.com>
Date: Fri, 18 Dec 2015 15:12:04 +0530
Subject: [PATCH 2011/2508] ASoC: Intel: Skylake: Use CGCTL.MISCBDCGE for
 Phrase detection notification

commit afdac6ecb9be2e25ce3b4fbc16ff5bb2c46a8d99 from
https://github.com/01org/linux-apollolake-i

Per HW recommendation, SW shall clear the CGCTL.MISCBDCGE and set
it back once data is transferred. So clear this when we get the
IPC and track using a driver flag, and set back on closure

Change-Id: I0ecb3c30a08580e04eadba4354eac45467e99ba4
Signed-off-by: Dharageswari.R <dharageswari.r@intel.com>
Signed-off-by: Jayachandran B <jayachandran.b@intel.com>
Signed-off-by: Vinod Koul <vinod.koul@intel.com>
Signed-off-by: Mark Brown <broonie@kernel.org>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/9616
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Jayanti, Satya Charitardha <satya.charitardha.jayanti@intel.com>
---
 sound/soc/intel/skylake/skl-pcm.c     |   12 ++++++++++++
 sound/soc/intel/skylake/skl-sst-ipc.c |    9 +++++++++
 2 files changed, 21 insertions(+), 0 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-pcm.c b/sound/soc/intel/skylake/skl-pcm.c
index 39328c8..26b8323 100644
--- a/sound/soc/intel/skylake/skl-pcm.c
+++ b/sound/soc/intel/skylake/skl-pcm.c
@@ -30,6 +30,8 @@
 #include "skl-sst-ipc.h"
 #include "skl-fwlog.h"
 #include "skl-probe.h"
+#include "skl-sst-dsp.h"
+#include "skl-sst-ipc.h"
 
 #define HDA_MONO 1
 #define HDA_STEREO 2
@@ -324,6 +326,7 @@ static void skl_pcm_close(struct snd_pcm_substream *substream,
 	struct hdac_ext_stream *stream = get_hdac_ext_stream(substream);
 	struct hdac_ext_bus *ebus = dev_get_drvdata(dai->dev);
 	struct skl_dma_params *dma_params = NULL;
+	struct skl *skl = ebus_to_skl(ebus);
 
 	dev_dbg(dai->dev, "%s: %s\n", __func__, dai->name);
 
@@ -338,6 +341,15 @@ static void skl_pcm_close(struct snd_pcm_substream *substream,
 	skl_set_suspend_active(substream, dai, false);
 
 	skl_tplg_update_d0i3_stream_count(dai, false);
+	/*
+	 * check if close is for "Reference Pin" and set back the
+	 * CGCTL.MISCBDCGE if disabled by driver
+	 */
+	if (!strncmp(dai->name, "Reference Pin", 13) &&
+			skl->skl_sst->miscbdcg_disabled) {
+		skl->skl_sst->enable_miscbdcge(dai->dev, true);
+		skl->skl_sst->miscbdcg_disabled = false;
+	}
 
 	kfree(dma_params);
 }
diff --git a/sound/soc/intel/skylake/skl-sst-ipc.c b/sound/soc/intel/skylake/skl-sst-ipc.c
index 4a5a32d..bc8918a 100644
--- a/sound/soc/intel/skylake/skl-sst-ipc.c
+++ b/sound/soc/intel/skylake/skl-sst-ipc.c
@@ -475,6 +475,15 @@ int skl_ipc_process_notification(struct sst_generic_ipc *ipc,
 			dev_err(ipc->dev, "*****Pharse Detected **********\n");
 			mdelay(1);
 			skl->notify_ops.notify_cb(skl->params);
+
+			/*
+			 * Per HW recomendation, After phrase detection,
+			 * clear the CGCTL.MISCBDCGE.
+			 *
+			 * This will be set back on stream closure
+			 */
+			skl->enable_miscbdcge(ipc->dev, false);
+			skl->miscbdcg_disabled = true;
 			break;
 
 		case IPC_GLB_NOTIFY_EXCEPTION_CAUGHT:
-- 
1.7.5.4

