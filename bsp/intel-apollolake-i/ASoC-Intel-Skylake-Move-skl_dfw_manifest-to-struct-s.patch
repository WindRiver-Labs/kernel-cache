From 93f96f0ab6a39d8cb5a672f9ecea9852b7bda0d6 Mon Sep 17 00:00:00 2001
From: Jayachandran B <jayachandran.b@intel.com>
Date: Wed, 25 May 2016 17:05:00 +0530
Subject: [PATCH 1970/2508] ASoC: Intel: Skylake: Move skl_dfw_manifest to
 struct skl_sst

commit 6f28c2cb9a1538e6a643550ede59a8666b895426 from
https://github.com/01org/linux-apollolake-i

skl_dfw_manifest was part of the controller structure struct skl.
This patch moves this structure to struct skl_sst so that the
manifest structure can be accessed from the platform specific
code which does not have access to controller structure.

Change-Id: I4d9cfd6278af3edfe606af667f3d1019644696e9
Signed-off-by: Jayachandran B <jayachandran.b@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/9450
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
---
 sound/soc/intel/skylake/bxt-sst.c      |   13 ++++++-------
 sound/soc/intel/skylake/cnl-sst-dsp.h  |    3 +--
 sound/soc/intel/skylake/cnl-sst.c      |   10 +++++-----
 sound/soc/intel/skylake/skl-messages.c |    2 +-
 sound/soc/intel/skylake/skl-sst-dsp.h  |   10 +++-------
 sound/soc/intel/skylake/skl-sst-ipc.h  |    2 ++
 sound/soc/intel/skylake/skl-sst.c      |    3 +--
 sound/soc/intel/skylake/skl-topology.c |    2 +-
 sound/soc/intel/skylake/skl.h          |    4 +---
 9 files changed, 21 insertions(+), 28 deletions(-)

diff --git a/sound/soc/intel/skylake/bxt-sst.c b/sound/soc/intel/skylake/bxt-sst.c
index 6973d74..e2903fd 100644
--- a/sound/soc/intel/skylake/bxt-sst.c
+++ b/sound/soc/intel/skylake/bxt-sst.c
@@ -71,8 +71,7 @@ static int bxt_set_dsp_D3(struct sst_dsp *ctx, unsigned int core_id);
 static int bxt_schedule_dsp_D0i3(struct sst_dsp *ctx);
 static int bxt_set_dsp_D0i0(struct sst_dsp *ctx);
 static void bxt_set_dsp_D0i3(struct work_struct *work);
-static int bxt_load_library(struct sst_dsp *ctx,
-		struct skl_dfw_manifest *minfo);
+static int bxt_load_library(struct sst_dsp *ctx);
 
 static unsigned int bxt_get_errorcode(struct sst_dsp *ctx)
 {
@@ -169,8 +168,7 @@ int bxt_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 }
 EXPORT_SYMBOL_GPL(bxt_sst_dsp_init_hw);
 
-int bxt_sst_dsp_init_fw(struct device *dev, struct skl_sst *ctx,
-			struct skl_dfw_manifest *minfo)
+int bxt_sst_dsp_init_fw(struct device *dev, struct skl_sst *ctx)
 {
 	int ret;
 
@@ -182,8 +180,8 @@ int bxt_sst_dsp_init_fw(struct device *dev, struct skl_sst *ctx,
 		return ret;
 	}
 	ctx->fw_loaded = true;
-	if (minfo->lib_count > 1) {
-		ret = ctx->dsp->fw_ops.load_library(ctx->dsp, minfo);
+	if (ctx->manifest.lib_count > 1) {
+		ret = ctx->dsp->fw_ops.load_library(ctx->dsp);
 		if (ret < 0) {
 			dev_err(dev, "Load Library failed : %x", ret);
 			return ret;
@@ -604,10 +602,11 @@ sst_load_base_firmware_failed:
 	return ret;
 }
 
-static int bxt_load_library(struct sst_dsp *ctx, struct skl_dfw_manifest *minfo)
+static int bxt_load_library(struct sst_dsp *ctx)
 {
 	struct snd_dma_buffer dmab;
 	struct skl_sst *skl = ctx->thread_context;
+	struct skl_dfw_manifest *minfo = &skl->manifest;
 	struct firmware *fw = NULL;
 	struct skl_ext_manifest_header *hdr;
 	u32 size;
diff --git a/sound/soc/intel/skylake/cnl-sst-dsp.h b/sound/soc/intel/skylake/cnl-sst-dsp.h
index bc0148f..4d04ff8 100644
--- a/sound/soc/intel/skylake/cnl-sst-dsp.h
+++ b/sound/soc/intel/skylake/cnl-sst-dsp.h
@@ -106,8 +106,7 @@ void cnl_dsp_free(struct sst_dsp *dsp);
 
 int cnl_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 		struct skl_dsp_loader_ops dsp_ops, struct skl_sst **dsp);
-int cnl_sst_dsp_init_fw(struct device *dev,
-	struct skl_sst *ctx, struct skl_dfw_manifest *minfo);
+int cnl_sst_dsp_init_fw(struct device *dev, struct skl_sst *ctx);
 void cnl_sst_dsp_cleanup(struct device *dev, struct skl_sst *ctx);
 
 void cnl_ipc_int_disable(struct sst_dsp *ctx);
diff --git a/sound/soc/intel/skylake/cnl-sst.c b/sound/soc/intel/skylake/cnl-sst.c
index e65c0b7..01b8301 100644
--- a/sound/soc/intel/skylake/cnl-sst.c
+++ b/sound/soc/intel/skylake/cnl-sst.c
@@ -403,10 +403,11 @@ static unsigned int cnl_get_errorcode(struct sst_dsp *ctx)
 	 return sst_dsp_shim_read(ctx, CNL_ADSP_ERROR_CODE);
 }
 
-static int cnl_load_library(struct sst_dsp *ctx, struct skl_dfw_manifest *minfo)
+static int cnl_load_library(struct sst_dsp *ctx)
 {
 	struct snd_dma_buffer dmab;
 	struct skl_sst *cnl = ctx->thread_context;
+	struct skl_dfw_manifest *minfo = &cnl->manifest;
 	const struct firmware *fw = NULL;
 	struct skl_ext_manifest_header *hdr;
 	u32 size;
@@ -663,8 +664,7 @@ int cnl_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 }
 EXPORT_SYMBOL_GPL(cnl_sst_dsp_init_hw);
 
-int cnl_sst_dsp_init_fw(struct device *dev,
-			struct skl_sst *ctx, struct skl_dfw_manifest *minfo)
+int cnl_sst_dsp_init_fw(struct device *dev, struct skl_sst *ctx)
 {
 	int ret;
 
@@ -675,8 +675,8 @@ int cnl_sst_dsp_init_fw(struct device *dev,
 	}
 	ctx->fw_loaded = true;
 
-	if (minfo->lib_count > 1) {
-		ret = ctx->dsp->fw_ops.load_library(ctx->dsp, minfo);
+	if (ctx->manifest.lib_count > 1) {
+		ret = ctx->dsp->fw_ops.load_library(ctx->dsp);
 		if (ret < 0) {
 			dev_err(dev, "Load library failed: %d", ret);
 			return ret;
diff --git a/sound/soc/intel/skylake/skl-messages.c b/sound/soc/intel/skylake/skl-messages.c
index 41e5a1a..c8f26ab 100644
--- a/sound/soc/intel/skylake/skl-messages.c
+++ b/sound/soc/intel/skylake/skl-messages.c
@@ -293,7 +293,7 @@ int skl_init_dsp_fw(struct skl *skl)
 		return ret;
 	}
 
-	ret = dsp_ops[index].init_fw(bus->dev, skl->skl_sst, &skl->manifest);
+	ret = dsp_ops[index].init_fw(bus->dev, skl->skl_sst);
 
 	if (ret < 0) {
 		skl_free_dsp(skl);
diff --git a/sound/soc/intel/skylake/skl-sst-dsp.h b/sound/soc/intel/skylake/skl-sst-dsp.h
index 04709e3..b1b34ad 100644
--- a/sound/soc/intel/skylake/skl-sst-dsp.h
+++ b/sound/soc/intel/skylake/skl-sst-dsp.h
@@ -23,7 +23,6 @@
 struct sst_dsp;
 struct skl_sst;
 struct sst_dsp_device;
-struct skl_dfw_manifest;
 
 /* Intel HD Audio General DSP Registers */
 #define SKL_ADSP_GEN_BASE		0x0
@@ -132,8 +131,7 @@ enum skl_dsp_states {
 struct skl_dsp_fw_ops {
 	int (*load_fw)(struct sst_dsp  *ctx);
 	/* FW module parser/loader */
-	int (*load_library)(struct sst_dsp *ctx,
-		struct skl_dfw_manifest *minfo);
+	int (*load_library)(struct sst_dsp *ctx);
 	int (*parse_fw)(struct sst_dsp *ctx);
 	int (*set_state_D0)(struct sst_dsp *ctx, unsigned int core_id);
 	int (*set_state_D3)(struct sst_dsp *ctx, unsigned int core_id);
@@ -217,10 +215,8 @@ int skl_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 		struct skl_dsp_loader_ops dsp_ops, struct skl_sst **dsp);
 int bxt_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 		struct skl_dsp_loader_ops dsp_ops, struct skl_sst **dsp);
-int skl_sst_dsp_init_fw(struct device *dev,
-	struct skl_sst *ctx, struct skl_dfw_manifest *minfo);
-int bxt_sst_dsp_init_fw(struct device *dev,
-	struct skl_sst *ctx, struct skl_dfw_manifest *minfo);
+int skl_sst_dsp_init_fw(struct device *dev, struct skl_sst *ctx);
+int bxt_sst_dsp_init_fw(struct device *dev, struct skl_sst *ctx);
 void skl_sst_dsp_cleanup(struct device *dev, struct skl_sst *ctx);
 void bxt_sst_dsp_cleanup(struct device *dev, struct skl_sst *ctx);
 
diff --git a/sound/soc/intel/skylake/skl-sst-ipc.h b/sound/soc/intel/skylake/skl-sst-ipc.h
index ee4a627..32f400a 100644
--- a/sound/soc/intel/skylake/skl-sst-ipc.h
+++ b/sound/soc/intel/skylake/skl-sst-ipc.h
@@ -20,6 +20,7 @@
 #include <linux/irqreturn.h>
 #include "../common/sst-ipc.h"
 #include "skl-sst-dsp.h"
+#include "skl-tplg-interface.h"
 
 struct sst_dsp;
 struct skl_sst;
@@ -97,6 +98,7 @@ struct skl_sst {
 	struct skl_d0i3_data d0i3_data;
 
 	struct skl_probe_config probe_config;
+	struct skl_dfw_manifest manifest;
 
 	/* Callback to update D0i3C register */
 	void (*update_d0i3c)(struct device *dev,  bool enable);
diff --git a/sound/soc/intel/skylake/skl-sst.c b/sound/soc/intel/skylake/skl-sst.c
index a2be084..7f9ce8b 100644
--- a/sound/soc/intel/skylake/skl-sst.c
+++ b/sound/soc/intel/skylake/skl-sst.c
@@ -489,8 +489,7 @@ int skl_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 }
 EXPORT_SYMBOL_GPL(skl_sst_dsp_init_hw);
 
-int skl_sst_dsp_init_fw(struct device *dev,
-		struct skl_sst *ctx, struct skl_dfw_manifest *minfo)
+int skl_sst_dsp_init_fw(struct device *dev, struct skl_sst *ctx)
 {
 	int ret;
 
diff --git a/sound/soc/intel/skylake/skl-topology.c b/sound/soc/intel/skylake/skl-topology.c
index 389313e..2d037b0 100644
--- a/sound/soc/intel/skylake/skl-topology.c
+++ b/sound/soc/intel/skylake/skl-topology.c
@@ -2119,7 +2119,7 @@ static int skl_manifest_load(struct snd_soc_component *cmpnt,
 	int ret = 0;
 	u8 *mdata;
 
-	minfo = &skl->manifest;
+	minfo = &skl->skl_sst->manifest;
 	mdata = manifest->priv.data;
 	minfo->lib_count = *mdata;
 
diff --git a/sound/soc/intel/skylake/skl.h b/sound/soc/intel/skylake/skl.h
index 43ee0739..e04172a 100644
--- a/sound/soc/intel/skylake/skl.h
+++ b/sound/soc/intel/skylake/skl.h
@@ -79,7 +79,6 @@ struct skl {
 
 	struct skl_debug *debugfs;
 	bool nhlt_override;
-	struct skl_dfw_manifest manifest;
 };
 
 struct platform_info {
@@ -110,8 +109,7 @@ struct skl_dsp_ops {
 
 	int (*init_hw)(struct device *dev, void __iomem *mmio_base, int irq,
 		struct skl_dsp_loader_ops loader_ops, struct skl_sst **skl_sst);
-	int (*init_fw)(struct device *dev, struct skl_sst *ctx,
-		struct skl_dfw_manifest *minfo);
+	int (*init_fw)(struct device *dev, struct skl_sst *ctx);
 	void (*cleanup)(struct device *dev, struct skl_sst *ctx);
 };
 
-- 
1.7.5.4

