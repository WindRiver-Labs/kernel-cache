From 06255b275740ea9dda2ea4ffbf55d7851b24b52f Mon Sep 17 00:00:00 2001
From: Bob Paauwe <bob.j.paauwe@intel.com>
Date: Tue, 19 Apr 2016 14:46:33 -0700
Subject: [PATCH 1256/2508] drm/i915/profiling: Add profiling for some second
 level steps.

commit 1c62ceb788b0a93bb5cab089647e30c131010fb9 from
https://github.com/01org/linux-apollolake-i

Collect data for gmbus intialization, modeset gem init and the
intel_modeset_init functions.

Also better format the time values.

Signed-off-by: Bob Paauwe <bob.j.paauwe@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_debugfs.c  |   22 ++++++++++++++--------
 drivers/gpu/drm/i915/i915_drv.h      |    5 ++++-
 drivers/gpu/drm/i915/intel_display.c |    5 +++++
 drivers/gpu/drm/i915/intel_i2c.c     |    2 ++
 4 files changed, 25 insertions(+), 9 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_debugfs.c b/drivers/gpu/drm/i915/i915_debugfs.c
index 2971198..2bc5276 100644
--- a/drivers/gpu/drm/i915/i915_debugfs.c
+++ b/drivers/gpu/drm/i915/i915_debugfs.c
@@ -2398,21 +2398,27 @@ static int i915_timing_info(struct seq_file *m, void *data)
 	seq_printf(m, "Timing info\n");
 	seq_printf(m, "  Total driver load time:      %lldms\n",
 		   (dev_priv->profile.driver_load / 1000000));
-	seq_printf(m, "    Hardware init time:                 %lldms\n",
+	seq_printf(m, "    Hardware init time:                 %4lldms\n",
 		   (dev_priv->profile.hardware_init / 1000000));
-	seq_printf(m, "    Modeset init time:                  %lldms\n",
+	seq_printf(m, "    Modeset init time:                  %4lldms\n",
 		   (dev_priv->profile.modeset_init / 1000000));
-	seq_printf(m, "        GUC firmware init time:             %lldms\n",
+	seq_printf(m, "        GMBUS init time:                    %4lldms\n",
+		   (dev_priv->profile.gmbus_init / 1000000));
+	seq_printf(m, "        Modeset init time:                  %4lldms\n",
+		   (dev_priv->profile.modeset_init_2 / 1000000));
+	seq_printf(m, "        GUC firmware init time:             %4lldms\n",
 		   (dev_priv->profile.guc_init / 1000000));
-	seq_printf(m, "        GUC firmware load time:             %lldms\n",
+	seq_printf(m, "        GUC firmware load time:             %4lldms\n",
 		   (dev_priv->profile.guc_load / 1000000));
-	seq_printf(m, "        Global GTT init time:               %lldms\n",
+	seq_printf(m, "        Global GTT init time:               %4lldms\n",
 		   (dev_priv->profile.gtt_init / 1000000));
-	seq_printf(m, "    Register time:                      %lldms\n",
+	seq_printf(m, "        Modeset GEM init time:              %4lldms\n",
+		   (dev_priv->profile.modeset_gem_init / 1000000));
+	seq_printf(m, "    Register driver time:               %4lldms\n",
 		   (dev_priv->profile.driver_register / 1000000));
-	seq_printf(m, "  Frambuffer device load time: %lldms\n",
+	seq_printf(m, "  Frambuffer device load time: %4lldms\n",
 		   (dev_priv->profile.fbdev_load / 1000000));
-	seq_printf(m, "  CSR firmware load time:      %lldms\n",
+	seq_printf(m, "  CSR firmware load time:      %4lldms\n",
 		   (dev_priv->profile.csr_load / 1000000));
 
 	return 0;
diff --git a/drivers/gpu/drm/i915/i915_drv.h b/drivers/gpu/drm/i915/i915_drv.h
index 5c1f188..2ebab5a 100644
--- a/drivers/gpu/drm/i915/i915_drv.h
+++ b/drivers/gpu/drm/i915/i915_drv.h
@@ -1639,8 +1639,11 @@ struct intel_load_profiles {
 	unsigned long long driver_load;
 	unsigned long long hardware_init;
 	unsigned long long modeset_init;
-	unsigned long long driver_register;
+	unsigned long long gmbus_init;
+	unsigned long long modeset_init_2;
 	unsigned long long gtt_init;
+	unsigned long long modeset_gem_init;
+	unsigned long long driver_register;
 	unsigned long long fbdev_load;
 	unsigned long long guc_init;
 	unsigned long long guc_load;
diff --git a/drivers/gpu/drm/i915/intel_display.c b/drivers/gpu/drm/i915/intel_display.c
index 3800535..eafe38d 100644
--- a/drivers/gpu/drm/i915/intel_display.c
+++ b/drivers/gpu/drm/i915/intel_display.c
@@ -15315,6 +15315,7 @@ void intel_modeset_init(struct drm_device *dev)
 	int sprite, ret;
 	enum pipe pipe;
 	struct intel_crtc *crtc;
+	unsigned long long start = sched_clock();
 
 	drm_mode_config_init(dev);
 
@@ -15434,6 +15435,7 @@ void intel_modeset_init(struct drm_device *dev)
 	 * since the watermark calculation done here will use pstate->fb.
 	 */
 	sanitize_watermarks(dev);
+	dev_priv->profile.modeset_init_2 = sched_clock() - start;
 }
 
 static void intel_enable_pipe_a(struct drm_device *dev)
@@ -15956,6 +15958,8 @@ void intel_modeset_gem_init(struct drm_device *dev)
 	struct drm_crtc *c;
 	struct drm_i915_gem_object *obj;
 	int ret;
+	struct drm_i915_private *dev_priv = to_i915(dev);
+	unsigned long long start = sched_clock();
 
 	intel_init_gt_powersave(dev);
 
@@ -15989,6 +15993,7 @@ void intel_modeset_gem_init(struct drm_device *dev)
 	}
 
 	intel_backlight_register(dev);
+	dev_priv->profile.modeset_gem_init = sched_clock() - start;
 }
 
 void intel_connector_unregister(struct intel_connector *intel_connector)
diff --git a/drivers/gpu/drm/i915/intel_i2c.c b/drivers/gpu/drm/i915/intel_i2c.c
index 52fbe53..b52e71b 100644
--- a/drivers/gpu/drm/i915/intel_i2c.c
+++ b/drivers/gpu/drm/i915/intel_i2c.c
@@ -632,6 +632,7 @@ int intel_setup_gmbus(struct drm_device *dev)
 	struct intel_gmbus *bus;
 	unsigned int pin;
 	int ret;
+	unsigned long long start = sched_clock();
 
 	if (HAS_PCH_NOP(dev))
 		return 0;
@@ -685,6 +686,7 @@ int intel_setup_gmbus(struct drm_device *dev)
 	}
 
 	intel_i2c_reset(dev_priv->dev);
+	dev_priv->profile.gmbus_init = sched_clock() - start;
 
 	return 0;
 
-- 
1.7.5.4

