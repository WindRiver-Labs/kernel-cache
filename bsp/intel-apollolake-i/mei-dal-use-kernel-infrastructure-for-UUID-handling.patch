From 61c3ea2814021e4f9214d736990325e72881530f Mon Sep 17 00:00:00 2001
From: Tomas Winkler <tomas.winkler@intel.com>
Date: Thu, 27 Oct 2016 16:10:35 +0300
Subject: [PATCH 4635/4706] mei: dal: use kernel infrastructure for UUID
 handling

commit 9ede72b320c3269f7120a722beb90aa3cb2fbe80 from
git://git.yoctoproject.org/linux-yocto-4.1

Utilize kernel infrastructure for UUID handling instead of
duplicating the functionality.
Hyphen-less UUIDs are handled by translating to the standard
string form and then using the uuid library functions.
The uuids are in big endina format.

Change-Id: I33c67c2f75d2dea3f4298c46881cf65baeddf4e6
Signed-off-by: Tomas Winkler <tomas.winkler@intel.com>
---
 drivers/misc/mei/dal/bhp_impl_ta.c |   84 ++++++++++++-----------------------
 1 files changed, 29 insertions(+), 55 deletions(-)

diff --git a/drivers/misc/mei/dal/bhp_impl_ta.c b/drivers/misc/mei/dal/bhp_impl_ta.c
index b6c48e3..6f94300 100644
--- a/drivers/misc/mei/dal/bhp_impl_ta.c
+++ b/drivers/misc/mei/dal/bhp_impl_ta.c
@@ -57,7 +57,6 @@
  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  *
  *****************************************************************************/
-
 /*
  *
  * @file  bhp_impl_ta.cpp
@@ -68,6 +67,9 @@
  */
 
 #include <linux/string.h>
+#include <linux/uuid.h>
+#include <linux/ctype.h>
+
 #include "bh_errcode.h"
 #include "bhp_impl.h"
 
@@ -76,72 +78,41 @@ enum bhp_vm_mode {
 	BHP_OPEN_VM_NORMAL_MODE = 1
 };
 
-static int char2hex(char c)
-{
-	if (c >= '0' && c <= '9')
-		return (c - '0');
-	else if (c >= 'a' && c <= 'f')
-		return (c - 'a' + 0xA);
-	else
-		return (c - 'A' + 0xA);
-}
-
-static int string_check1_uuid(const char *str)
+static bool uuid_is_valid_hyphenless(const char *uuid_str)
 {
-	int i;
-
-	for (i = 0; i < BH_GUID_LENGTH * 2; i++, str++)
-		if (!((*str >= '0' && *str <= '9') ||
-				(*str >= 'a' && *str <= 'f') ||
-				(*str >= 'A' && *str <= 'F')))
-			return 0;
+	unsigned int i;
 
-	/* incorrect string length */
-	if (*str != 0)
-		return 0;
+	/* exclude (i == 8 || i == 13 || i == 18 || i == 23) */
+	for (i = 0; i < UUID_STRING_LEN - 4; i++)
+		if (!isxdigit(uuid_str[i]))
+			return false;
 
-	return 1;
+	return true;
 }
 
-static int string_check2_uuid(const char *str)
+static void uuid_normalize_hyphenless(const char *uuid_hl, char *uuid_str)
 {
-	int i;
-
-	for (i = 0; i < BH_GUID_LENGTH * 2; i++, str++) {
-
-		if (*str == '-' && (i == 8 || i == 12 || i == 16 || i == 20))
-			str++;
+	unsigned int i;
 
-		if (!((*str >= '0' && *str <= '9') ||
-				(*str >= 'a' && *str <= 'f') ||
-				(*str >= 'A' && *str <= 'F')))
-			return 0;
+	for (i = 0; i < UUID_STRING_LEN; i++) {
+		if (i == 8 || i == 13 || i == 18 || i == 23)
+			uuid_str[i] = '-';
+		else
+			uuid_str[i] = *uuid_hl++;
 	}
-
-	/* incorrect string length */
-	if (*str != 0)
-		return 0;
-
-	return 1;
+	uuid_str[i] = '\0';
 }
 
-static s32 string_to_uuid(const s8 *str, s8 *uuid)
+static int __uuid_be_to_bin(const char *uuid_str, uuid_be *uuid)
 {
-	int i;
+	char __uuid_str[UUID_STRING_LEN + 1];
 
-	if (!string_check1_uuid(str) && !string_check2_uuid(str))
-		return 0;
-
-	for (i = 0; i < BH_GUID_LENGTH; i++, uuid++) {
-
-		if (*str == '-')
-			str++;
-
-		*uuid = (s8) char2hex(*str++);
-		*uuid <<= 4;
-		*uuid += (s8) char2hex(*str++);
+	if (uuid_is_valid_hyphenless(uuid_str)) {
+		uuid_normalize_hyphenless(uuid_str, __uuid_str);
+		uuid_str = __uuid_str;
 	}
-	return 1;
+
+	return uuid_be_to_bin(uuid_str, uuid);
 }
 
 /* try to session_enter for IVM, then SVM */
@@ -418,6 +389,7 @@ int bhp_open_ta_session(u64 *session, const char *app_id,
 {
 	int ret;
 	struct bh_ta_id ta_id;
+	uuid_be ta_uuid;
 	int conn_idx = 0;
 	int vm_conn_closed = 0;
 	struct bh_sd_id sdid;
@@ -435,9 +407,11 @@ int bhp_open_ta_session(u64 *session, const char *app_id,
 	if (!init_buffer && init_len != 0)
 		return BPE_INVALID_PARAMS;
 
-	if (!string_to_uuid(app_id, (char *) &ta_id))
+	if (__uuid_be_to_bin(app_id, &ta_uuid))
 		return BPE_INVALID_PARAMS;
 
+	memcpy(ta_id.data, ta_uuid.b, sizeof(ta_id.data));
+
 	*session = 0;
 
 	/* 1.1: get the TA's sdid */
-- 
1.7.5.4

