From 5d2fdf59823c16afbea1efefc74c4ee716abf30a Mon Sep 17 00:00:00 2001
From: Vinod Koul <vinod.koul@intel.com>
Date: Wed, 1 Jul 2015 18:47:46 +0530
Subject: [PATCH 1665/2508] ASoC: Intel: Skylake: Add i915 enabling in skl
 probe

commit b253d5063a72cc2780663228b7dbcc826c85dafd from
https://github.com/01org/linux-apollolake-i

The SKL also supports HDMI output so in probe we need to enable the HDMI
using common i915 APIs to ensure if gets probed on the bus

Signed-off-by: Vinod Koul <vinod.koul@intel.com>
Signed-off-by: Subhransu S. Prusty <subhransu.s.prusty@intel.com>

Conflicts:
	sound/soc/intel/Kconfig

Change-Id: Ic10bd151c8180283d6c94a665fc04f874987f8d0
---
 sound/soc/intel/Kconfig       |    1 +
 sound/soc/intel/skylake/skl.c |   32 ++++++++++++++++++++++++++++++++
 2 files changed, 33 insertions(+), 0 deletions(-)

diff --git a/sound/soc/intel/Kconfig b/sound/soc/intel/Kconfig
index 556cdbb..0e8b7d92 100644
--- a/sound/soc/intel/Kconfig
+++ b/sound/soc/intel/Kconfig
@@ -133,6 +133,7 @@ config SND_SOC_INTEL_SKYLAKE
 config SND_SOC_INTEL_SKL_RT286_MACH
 	tristate "ASoC Audio driver for SKL with RT286 I2S mode"
 	depends on X86 && ACPI
+	select SND_HDA_I915
 	select SND_SOC_INTEL_SST
 	select SND_SOC_INTEL_SKYLAKE
 	select SND_SOC_RT286
diff --git a/sound/soc/intel/skylake/skl.c b/sound/soc/intel/skylake/skl.c
index 211ef6e2..f705a05 100644
--- a/sound/soc/intel/skylake/skl.c
+++ b/sound/soc/intel/skylake/skl.c
@@ -26,6 +26,9 @@
 #include <linux/pm_runtime.h>
 #include <linux/platform_device.h>
 #include <sound/pcm.h>
+#include <sound/hda_register.h>
+#include <sound/hdaudio.h>
+#include <sound/hda_i915.h>
 #include "skl.h"
 
 /*
@@ -368,6 +371,27 @@ static int skl_create(struct pci_dev *pci,
 	return 0;
 }
 
+static int skl_i915_init(struct hdac_bus *bus)
+{
+	int err;
+
+	/* the HDMI codec is in GPU so we need to ensure that it is powered
+	 * up and ready for probe
+	 */
+	err = snd_hdac_i915_init(bus);
+	if (err < 0)
+		return err;
+
+	err = snd_hdac_display_power(bus, true);
+	if (err < 0) {
+		dev_err(bus->dev, "Cannot turn on display power on i915\n");
+		return err;
+	}
+	snd_hdac_set_codec_wakeup(bus, true);
+
+	return err;
+}
+
 static int skl_first_init(struct hdac_ext_bus *ebus)
 {
 	struct skl *skl = ebus_to_skl(ebus);
@@ -430,8 +454,14 @@ static int skl_first_init(struct hdac_ext_bus *ebus)
 	/* initialize chip */
 	skl_init_pci(skl);
 
+	err = skl_i915_init(bus);
+	if (err < 0)
+		return err;
+
 	snd_hdac_bus_init_chip(bus, true);
 
+	snd_hdac_set_codec_wakeup(bus, false);
+
 	/* codec detection */
 	if (!bus->codec_mask) {
 		dev_info(bus->dev, "no hda codecs found!\n");
@@ -519,6 +549,8 @@ static void skl_remove(struct pci_dev *pci)
 	struct hdac_ext_bus *ebus = pci_get_drvdata(pci);
 	struct skl *skl = ebus_to_skl(ebus);
 
+	snd_hdac_display_power(&ebus->bus, false);
+	snd_hdac_i915_exit(&ebus->bus);
 	if (pci_dev_run_wake(pci))
 		pm_runtime_get_noresume(&pci->dev);
 	pci_dev_put(pci);
-- 
1.7.5.4

