From 19442308f4d3b2bf06b2d1fa3ba512e8390c1dae Mon Sep 17 00:00:00 2001
From: "Subhransu S. Prusty" <subhransu.s.prusty@intel.com>
Date: Thu, 14 Apr 2016 10:07:36 +0530
Subject: [PATCH 2123/2508] ASoC: Intel: Skylake: Update channel map based on
 runtime params

commit 6d2c30cc737fe1910f757d308212f21459ba713d from
https://github.com/01org/linux-apollolake-i

Default channel map is set for 2 channels. Fix the channel map
based on runtime params to support multichannel.

Change-Id: I8a283d6df3b0e44be6e5bb5bc2b7282268d98107
Signed-off-by: Subhransu S. Prusty <subhransu.s.prusty@intel.com>
Signed-off-by: Vinod Koul <vinod.koul@intel.com>
Signed-off-by: Mark Brown <broonie@kernel.org>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/10211
Reviewed-by: B, Jayachandran <jayachandran.b@intel.com>
Tested-by: Jayanti, Satya Charitardha <satya.charitardha.jayanti@intel.com>
---
 sound/soc/intel/skylake/skl-topology.c |   20 ++++++++++++++++++--
 1 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-topology.c b/sound/soc/intel/skylake/skl-topology.c
index f6cec48..bb8b8eb 100644
--- a/sound/soc/intel/skylake/skl-topology.c
+++ b/sound/soc/intel/skylake/skl-topology.c
@@ -372,6 +372,23 @@ static void skl_dump_mconfig(struct skl_sst *ctx,
 	dev_dbg(ctx->dev, "ch_cfg = %d\n", mcfg->out_fmt[0].ch_cfg);
 }
 
+static void skl_tplg_update_chmap(struct skl_module_fmt *fmt, int chs)
+{
+	int slot_map = 0xFFFFFFFF;
+	int start_slot = 0;
+	int i;
+
+	for (i = 0; i < chs; i++) {
+		/*
+		 * For 2 channels with starting slot as 0, slot map will
+		 * look like 0xFFFFFF10.
+		 */
+		slot_map &= (~(0xF << (4 * i)) | (start_slot << (4 * i)));
+		start_slot++;
+	}
+	fmt->ch_map = slot_map;
+}
+
 static void skl_tplg_update_params(struct skl_module_fmt *fmt,
 			struct skl_pipe_params *params, int fixup)
 {
@@ -379,12 +396,11 @@ static void skl_tplg_update_params(struct skl_module_fmt *fmt,
 		fmt->s_freq = params->s_freq;
 	if (fixup & SKL_CH_FIXUP_MASK) {
 		fmt->channels = params->ch;
+		skl_tplg_update_chmap(fmt, fmt->channels);
 		if (fmt->channels == 1) {
 			fmt->ch_cfg = SKL_CH_CFG_MONO;
-			fmt->ch_map = 0xfffffff0;
 		} else if (fmt->channels == 2) {
 			fmt->ch_cfg = SKL_CH_CFG_STEREO;
-			fmt->ch_map = 0xffffff10;
 		}
 	}
 	if (fixup & SKL_FMT_FIXUP_MASK) {
-- 
1.7.5.4

