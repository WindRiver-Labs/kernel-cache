From e6b8a434c218a07e6ad4f85475684736c0796607 Mon Sep 17 00:00:00 2001
From: "Panwar, Ashish" <ashish.panwar@intel.com>
Date: Fri, 26 Feb 2016 11:03:30 +0530
Subject: [PATCH 1904/2508] ASoC: Intel: Skylake: Move compr ops to dai ops

commit f38c666c9e3a1a89ec1a6aca22e4e036978e2ccc from
https://github.com/01org/linux-apollolake-i

Moving compr_ops from platform to dai. This way, different compress
streams can be used in different ways depending on the usecase. For
example, probe and logging streams have very different implementations.

Change-Id: I0e87447e436c915f8a35e640d5590334280b9a7d
Signed-off-by: Panwar, Ashish <ashish.panwar@intel.com>
Signed-off-by: Divya Prakash <divya1.prakash@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/8265
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
---
 sound/soc/intel/skylake/skl-pcm.c |   36 ++++++++++++++++++++++++++----------
 1 files changed, 26 insertions(+), 10 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-pcm.c b/sound/soc/intel/skylake/skl-pcm.c
index 2b933da..638ffa0 100644
--- a/sound/soc/intel/skylake/skl-pcm.c
+++ b/sound/soc/intel/skylake/skl-pcm.c
@@ -595,6 +595,14 @@ static int skl_get_compr_core(struct snd_compr_stream *stream)
 		return INT_MIN;
 }
 
+static int skl_is_logging_core(int core)
+{
+	if (core == 0 || core == 1)
+		return 1;
+	else
+		return 0;
+}
+
 static struct skl_sst *skl_get_sst_compr(struct snd_compr_stream *stream)
 {
 	struct snd_soc_pcm_runtime *rtd = stream->private_data;
@@ -607,7 +615,8 @@ static struct skl_sst *skl_get_sst_compr(struct snd_compr_stream *stream)
 }
 
 static int skl_trace_compr_set_params(struct snd_compr_stream *stream,
-					struct snd_compr_params *params)
+					struct snd_compr_params *params,
+						struct snd_soc_dai *cpu_dai)
 {
 	int ret;
 	struct skl_sst *skl_sst = skl_get_sst_compr(stream);
@@ -644,7 +653,8 @@ static int skl_trace_compr_set_params(struct snd_compr_stream *stream,
 }
 
 static int skl_trace_compr_tstamp(struct snd_compr_stream *stream,
-					struct snd_compr_tstamp *tstamp)
+					struct snd_compr_tstamp *tstamp,
+						struct snd_soc_dai *cpu_dai)
 {
 	struct skl_sst *skl_sst = skl_get_sst_compr(stream);
 	struct sst_dsp *sst = skl_sst->dsp;
@@ -664,13 +674,14 @@ static int skl_trace_compr_copy(struct snd_compr_stream *stream,
 	struct sst_dsp *sst = skl_sst->dsp;
 	int core = skl_get_compr_core(stream);
 
-	if (!skl_is_core_valid(core))
-		return -EINVAL;
-
-	return skl_dsp_copy_log_user(sst, core, dest, count);
+	if (skl_is_logging_core(core))
+		return skl_dsp_copy_log_user(sst, core, dest, count);
+	else
+		return 0;
 }
 
-static int skl_trace_compr_free(struct snd_compr_stream *stream)
+static int skl_trace_compr_free(struct snd_compr_stream *stream,
+						struct snd_soc_dai *cpu_dai)
 {
 	struct skl_sst *skl_sst = skl_get_sst_compr(stream);
 	struct sst_dsp *sst = skl_sst->dsp;
@@ -689,9 +700,12 @@ static int skl_trace_compr_free(struct snd_compr_stream *stream)
 	return 0;
 }
 
-static struct snd_compr_ops skl_trace_compr_ops = {
-	.free = skl_trace_compr_free,
+static struct snd_compr_ops skl_platform_compr_ops = {
 	.copy = skl_trace_compr_copy,
+};
+
+static struct snd_soc_cdai_ops skl_trace_compr_ops = {
+	.shutdown = skl_trace_compr_free,
 	.pointer = skl_trace_compr_tstamp,
 	.set_params = skl_trace_compr_set_params,
 };
@@ -724,6 +738,7 @@ static struct snd_soc_dai_driver skl_platform_dai[] = {
 {
 	.name = "TraceBuffer0 Pin",
 	.compress_dai = 1,
+	.cops = &skl_trace_compr_ops,
 	.capture = {
 		.stream_name = "TraceBuffer Capture",
 		.channels_min = HDA_MONO,
@@ -733,6 +748,7 @@ static struct snd_soc_dai_driver skl_platform_dai[] = {
 {
 	.name = "TraceBuffer1 Pin",
 	.compress_dai = 1,
+	.cops = &skl_trace_compr_ops,
 	.capture = {
 		.stream_name = "TraceBuffer1 Capture",
 		.channels_min = HDA_MONO,
@@ -1379,7 +1395,7 @@ static struct snd_soc_platform_driver skl_platform_drv  = {
 	.probe		= skl_platform_soc_probe,
 	.remove         = skl_platform_soc_remove,
 	.ops		= &skl_platform_ops,
-	.compr_ops	= &skl_trace_compr_ops,
+	.compr_ops	= &skl_platform_compr_ops,
 	.pcm_new	= skl_pcm_new,
 	.pcm_free	= skl_pcm_free,
 };
-- 
1.7.5.4

