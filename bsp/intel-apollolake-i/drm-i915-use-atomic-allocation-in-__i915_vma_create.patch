From c9752bc985aa4267c93091a589c043fa10c0c567 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Wed, 19 Apr 2017 16:11:05 +0800
Subject: [PATCH 1/7] drm/i915: use atomic allocation in __i915_vma_create()

The __i915_vma_create() may be invoked in an atomic context, so we
should use the atomic allocation in it to fix call trace like this:
 BUG: sleeping function called from invalid context at mm/slub.c:1272
 in_atomic(): 1, irqs_disabled(): 0, pid: 314, name: Xorg
 CPU: 3 PID: 314 Comm: Xorg Not tainted 4.1.21-rt13-WR8.0.0.0_preempt-rt+ #208
 Hardware name: Intel Corp. Broxton P/NOTEBOOK, BIOS APLIRVPA.X64.0138.B35.1608091058 08/09/2016
  0000000000000000 ffff8802702276e8 ffffffff81a365e1 ffff880270321800
  00000000000004f8 ffff880270227708 ffffffff8107a759 0000000000000001
  ffffffff81ed39a0 ffff880270227738 ffffffff8107a7ed ffff880270227738
 Call Trace:
  [<ffffffff81a365e1>] dump_stack+0x54/0x71
  [<ffffffff8107a759>] ___might_sleep+0xd9/0x120
  [<ffffffff8107a7ed>] __might_sleep+0x4d/0x90
  [<ffffffff81178e37>] kmem_cache_alloc+0x1d7/0x280
  [<ffffffff8154f0ae>] ? __i915_vma_create+0x2e/0x210
  [<ffffffff8154f0ae>] __i915_vma_create+0x2e/0x210
  [<ffffffff81553e5e>] i915_gem_obj_lookup_or_create_vma+0x3e/0x50
  [<ffffffff81558d55>] i915_gem_object_ggtt_pin+0x35/0x1a0
  [<ffffffff81548e0d>] i915_gem_execbuffer_relocate_entry+0x63d/0x930
  [<ffffffff8118586d>] ? delete_object_full+0x2d/0x40
  [<ffffffff8154920d>] i915_gem_execbuffer_relocate_vma.isra.13+0x10d/0x190
  [<ffffffff8154d33d>] ? kunmap_page_dma+0x5d/0x80
  [<ffffffff815515d8>] ? gen8_ppgtt_insert_pte_entries.isra.18+0x158/0x1d0
  [<ffffffff8154c81e>] ? ppgtt_bind_vma+0x3e/0x50
  [<ffffffff81553ef9>] ? i915_vma_bind+0x89/0x140
  [<ffffffff81558ab6>] ? __i915_vma_do_pin+0x2a6/0x510
  [<ffffffff8154f0ae>] ? __i915_vma_create+0x2e/0x210
  [<ffffffff81548383>] ? i915_gem_execbuffer_reserve_vma.isra.10+0x153/0x1c0
  [<ffffffff8154878c>] ? i915_gem_execbuffer_reserve.isra.11+0x39c/0x3e0
  [<ffffffff81549f7d>] i915_gem_do_execbuffer.isra.17+0x97d/0x1d60
  [<ffffffff8154b775>] i915_gem_execbuffer2+0xc5/0x270
  [<ffffffff814f24f4>] drm_ioctl+0x204/0x490
  [<ffffffff81185652>] ? put_object+0x32/0x60
  [<ffffffff8154b6b0>] ? i915_gem_execbuffer+0x350/0x350
  [<ffffffff811a1cff>] ? dentry_free+0x5f/0xb0
  [<ffffffff811a1ec2>] ? __dentry_kill+0x172/0x210
  [<ffffffff8119d8fe>] do_vfs_ioctl+0x30e/0x580
  [<ffffffff811aaf44>] ? mntput+0x24/0x40
  [<ffffffff8118bf80>] ? __fput+0x150/0x210
  [<ffffffff8107a7ed>] ? __might_sleep+0x4d/0x90
  [<ffffffff8119dbf1>] SyS_ioctl+0x81/0xa0
  [<ffffffff8106397d>] ? SyS_rt_sigprocmask+0xad/0xe0
  [<ffffffff81a3e91b>] system_call_fastpath+0x16/0x6e

Signed-off-by: Kevin Hao <kexin.hao@windriver>
---
 drivers/gpu/drm/i915/i915_gem_gtt.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gem_gtt.c b/drivers/gpu/drm/i915/i915_gem_gtt.c
index 27ae8e7..26aac90 100644
--- a/drivers/gpu/drm/i915/i915_gem_gtt.c
+++ b/drivers/gpu/drm/i915/i915_gem_gtt.c
@@ -3351,7 +3351,7 @@ __i915_vma_create(struct drm_i915_gem_object *obj,
 
 	GEM_BUG_ON(vm->closed);
 
-	vma = kmem_cache_zalloc(to_i915(obj->base.dev)->vmas, GFP_KERNEL);
+	vma = kmem_cache_zalloc(to_i915(obj->base.dev)->vmas, GFP_ATOMIC);
 	if (vma == NULL)
 		return ERR_PTR(-ENOMEM);
 
-- 
1.7.5.4

