From 7cdf4a45acd6d1c50d4929a76a459ee0073a635b Mon Sep 17 00:00:00 2001
From: "Pawse, GuruprasadX" <guruprasadx.pawse@intel.com>
Date: Tue, 9 Aug 2016 17:28:32 +0530
Subject: [PATCH 4699/4706] ASoC: Intel: Skylake: Probe - Fix DMA assignment
 and reset

commit 40df0d02079d5da2fed924b01e0ea96759072eb2 from
git://git.yoctoproject.org/linux-yocto-4.1

1. Extractor DMA is to be assigned when the first probe stream(irrespective
of whether it is injector or extractor) is opened. But if the first probe
stream is injector, we get injector's substream pointer and we do not
have the right substream pointer for extractor.

The existing code passed injector's substream while assigning extractor
DMA.This patch sets NULL for substream while assigning the DMA for
extractor and sets the correct substream pointer later when open is
indeed for extractor.

2. DMA reset for exractor should not be done after  probe module is
initialized.

The existing code reset DMA in hw_params. This can result in DMA reset
after probe module init when  injector and extractor are started one
after the other.

This patch moves the DMA reset from hw params to immediately after DMA
assignment in open call back for both injector and extractor.

Change-Id: I8bc37b55af3068aed5f3b1547ec2fb0e19e4565d
Signed-off-by: Pawse, GuruprasadX <guruprasadx.pawse@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/10830
Reviewed-by: B, Jayachandran <jayachandran.b@intel.com>
Reviewed-by: Kale, Sanyog R <sanyog.r.kale@intel.com>
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Jayanti, Satya Charitardha <satya.charitardha.jayanti@intel.com>
---
 sound/soc/intel/skylake/skl-probe.c |   20 ++++++++++++++++++--
 1 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-probe.c b/sound/soc/intel/skylake/skl-probe.c
index 958b3ee..52c4806 100644
--- a/sound/soc/intel/skylake/skl-probe.c
+++ b/sound/soc/intel/skylake/skl-probe.c
@@ -99,8 +99,18 @@ int skl_probe_compr_open(struct snd_compr_stream *substream,
 	if ((pconfig->i_refc + pconfig->e_refc) == 0) {
 		pconfig->edma_buffsize = SKL_EXTRACT_PROBE_DMA_BUFF_SIZE;
 		pconfig->edma_type = SKL_DMA_HDA_HOST_INPUT_CLASS;
+		/*
+		 * Extractor DMA is to be assigned when the first probe
+		 * stream(irrespective of whether it is injector or extractor)
+		 * is opened. But if the first probe stream is injector, we
+		 * get injector's substream pointer and we do not have the
+		 * right substream pointer for extractor. So, pass NULL for
+		 * substream while assigning the DMA for extractor and set the
+		 * correct substream pointer later when open is indeed for
+		 * extractor.
+		 */
 		pconfig->estream = hdac_ext_host_stream_compr_assign(ebus,
-								substream,
+								NULL,
 							SND_COMPRESS_CAPTURE);
 		if (!pconfig->estream) {
 			dev_err(dai->dev, "Failed to assign extractor stream\n");
@@ -108,6 +118,7 @@ int skl_probe_compr_open(struct snd_compr_stream *substream,
 		}
 
 		pconfig->edma_id = hdac_stream(pconfig->estream)->stream_tag - 1;
+		snd_hdac_stream_reset(hdac_stream(pconfig->estream));
 	}
 
 	if (substream->direction == SND_COMPRESS_PLAYBACK) {
@@ -123,10 +134,16 @@ int skl_probe_compr_open(struct snd_compr_stream *substream,
 		}
 		set_injector_stream(stream, dai);
 		runtime->private_data = stream;
+		snd_hdac_stream_reset(hdac_stream(stream));
 
 	} else if (substream->direction == SND_COMPRESS_CAPTURE) {
 		stream = pconfig->estream;
 		runtime->private_data = pconfig->estream;
+		/*
+		 * Open is indeed for extractor. So, set the correct substream
+		 * pointer now.
+		 */
+		stream->hstream.stream = substream;
 	}
 
 	hdac_stream(stream)->curr_pos = 0;
@@ -165,7 +182,6 @@ int skl_probe_compr_set_params(struct snd_compr_stream *substream,
 	dma_id = hdac_stream(stream)->stream_tag - 1;
 	dev_dbg(dai->dev, "dma_id=%d\n", dma_id);
 
-	snd_hdac_stream_reset(hdac_stream(stream));
 
 	err = snd_hdac_stream_set_params(hdac_stream(stream), format_val);
 	if (err < 0)
-- 
1.7.5.4

