From e09f9f6eda7653b7d5065078b291ea45c1393f88 Mon Sep 17 00:00:00 2001
From: "Kamble, Sagar A" <sagar.a.kamble@intel.com>
Date: Wed, 27 Jul 2016 09:26:08 -0700
Subject: [PATCH 2062/2508] drm/i915: Sample GuC forcewakes before enabling
 CPG

commit 98afad472b7a67ebdd154a1c5e44d2e7fff95176 from
https://github.com/01org/linux-apollolake-i

During i915_gem_init_hw, i915 holds forcewake for all engines
Hence notification of sampling of GuC forcewakes can be deferred
from submission enablement path to enabling of CPG/RC6. This will
fix issue where RC6 stops working due to GuC keeping forcewake ON
inadvertently due to special case CSB interrupt timing.

Signed-off-by: Kamble, Sagar A <sagar.a.kamble@intel.com>
Signed-off-by: Jeff McGee <jeff.mcgee@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_guc_submission.c |    9 +++------
 drivers/gpu/drm/i915/intel_guc.h           |    1 +
 drivers/gpu/drm/i915/intel_pm.c            |    2 ++
 3 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_guc_submission.c b/drivers/gpu/drm/i915/i915_guc_submission.c
index 597eb0f..58648d9 100644
--- a/drivers/gpu/drm/i915/i915_guc_submission.c
+++ b/drivers/gpu/drm/i915/i915_guc_submission.c
@@ -218,11 +218,10 @@ static int host2guc_release_doorbell(struct intel_guc *guc,
 	return host2guc_action(guc, data, 2);
 }
 
-static int host2guc_sample_forcewake(struct intel_guc *guc,
-				     struct i915_guc_client *client)
+int i915_guc_sample_forcewake(struct drm_device *dev)
 {
-	struct drm_i915_private *dev_priv = guc_to_i915(guc);
-	struct drm_device *dev = dev_priv->dev;
+	struct drm_i915_private *dev_priv = dev->dev_private;
+	struct intel_guc *guc = &dev_priv->guc;
 	u32 data[2];
 
 	data[0] = HOST2GUC_ACTION_SAMPLE_FORCEWAKE;
@@ -1040,8 +1039,6 @@ int i915_guc_submission_enable(struct drm_device *dev)
 		DRM_ERROR("Failed to create preemptive guc_client\n");
 	guc->preempt_client = client;
 
-	host2guc_sample_forcewake(guc, client);
-
 	return 0;
 }
 
diff --git a/drivers/gpu/drm/i915/intel_guc.h b/drivers/gpu/drm/i915/intel_guc.h
index e9bfb65..2a54cd7 100644
--- a/drivers/gpu/drm/i915/intel_guc.h
+++ b/drivers/gpu/drm/i915/intel_guc.h
@@ -137,5 +137,6 @@ int i915_guc_submit(struct i915_guc_client *client,
 void i915_guc_submission_disable(struct drm_device *dev);
 void i915_guc_submission_fini(struct drm_device *dev);
 int i915_guc_wq_check_space(struct i915_guc_client *client);
+int i915_guc_sample_forcewake(struct drm_device *dev);
 
 #endif
diff --git a/drivers/gpu/drm/i915/intel_pm.c b/drivers/gpu/drm/i915/intel_pm.c
index d7e34ba..676f009 100644
--- a/drivers/gpu/drm/i915/intel_pm.c
+++ b/drivers/gpu/drm/i915/intel_pm.c
@@ -5262,6 +5262,8 @@ static void gen9_enable_rc6(struct drm_device *dev)
 			   rc6_mask);
 	}
 
+	i915_guc_sample_forcewake(dev);
+
 	/*
 	 * 3b: Enable Coarse Power Gating only when RC6 is enabled.
 	 * WaRsDisableCoarsePowerGating:skl,bxt - Render/Media PG need to be disabled with RC6.
-- 
1.7.5.4

