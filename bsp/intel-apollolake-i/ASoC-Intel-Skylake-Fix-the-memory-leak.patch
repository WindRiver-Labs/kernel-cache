From d47d1dfaffb878c65e9e98d2d173779335946763 Mon Sep 17 00:00:00 2001
From: Vinod Koul <vinod.koul@intel.com>
Date: Tue, 5 Jan 2016 17:16:04 +0530
Subject: [PATCH 2015/2508] ASoC: Intel: Skylake: Fix the memory leak

commit 3ebc7b25360065aca48c30d30ec392bd1390a33c from
https://github.com/01org/linux-apollolake-i

This patch will provide the fix for firmware memory by freeing the pointer in driver
remove where it is safe to do so, also inline with some of changes done by previous
patch set.

Change-Id: I1897ebde96356457d6a3b817081a3d272c278ebd
Signed-off-by: G Kranthi <gudishax.kranthikumar@intel.com>
Signed-off-by: Vinod Koul <vinod.koul@intel.com>
Signed-off-by: Mark Brown <broonie@kernel.org>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/9633
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Jayanti, Satya Charitardha <satya.charitardha.jayanti@intel.com>
---
 sound/soc/intel/skylake/skl-pcm.c      |    6 +++---
 sound/soc/intel/skylake/skl-topology.c |    7 ++++---
 sound/soc/intel/skylake/skl.c          |    3 +++
 sound/soc/intel/skylake/skl.h          |    2 +-
 4 files changed, 11 insertions(+), 7 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-pcm.c b/sound/soc/intel/skylake/skl-pcm.c
index 6d8eb06..0bbbfc0 100644
--- a/sound/soc/intel/skylake/skl-pcm.c
+++ b/sound/soc/intel/skylake/skl-pcm.c
@@ -1633,9 +1633,9 @@ static int skl_platform_soc_remove(struct snd_soc_platform *platform)
 	struct hdac_ext_bus *ebus = dev_get_drvdata(platform->dev);
 	struct skl *skl = ebus_to_skl(ebus);
 
-	if (skl->fw) {
-		release_firmware(skl->fw);
-		skl->fw = NULL;
+	if (skl->tplg) {
+		release_firmware(skl->tplg);
+		skl->tplg= NULL;
 	}
 	return 0;
 }
diff --git a/sound/soc/intel/skylake/skl-topology.c b/sound/soc/intel/skylake/skl-topology.c
index 0c2b42b..a392f46 100644
--- a/sound/soc/intel/skylake/skl-topology.c
+++ b/sound/soc/intel/skylake/skl-topology.c
@@ -2201,7 +2201,7 @@ int skl_tplg_init(struct snd_soc_platform *platform, struct hdac_ext_bus *ebus)
 	struct hdac_bus *bus = ebus_to_hbus(ebus);
 	struct skl *skl = ebus_to_skl(ebus);
 
-	ret = request_firmware(&skl->fw, "dfw_sst.bin", bus->dev);
+	ret = request_firmware(&skl->tplg, "dfw_sst.bin", bus->dev);
 	if (ret < 0) {
 		dev_err(bus->dev, "tplg fw %s load failed with %d\n",
 				"dfw_sst.bin", ret);
@@ -2213,15 +2213,16 @@ int skl_tplg_init(struct snd_soc_platform *platform, struct hdac_ext_bus *ebus)
 	 * any other index
 	 */
 	ret = snd_soc_tplg_component_load(&platform->component,
-					&skl_tplg_ops, skl->fw, 0);
+					&skl_tplg_ops, skl->tplg, 0);
 	if (ret < 0) {
 		dev_err(bus->dev, "tplg component load failed%d\n", ret);
-		release_firmware(skl->fw);
+		release_firmware(skl->tplg);
 		return -EINVAL;
 	}
 
 	skl->resource.max_mcps = SKL_MAX_MCPS;
 	skl->resource.max_mem = SKL_FW_MAX_MEM;
 
+
 	return 0;
 }
diff --git a/sound/soc/intel/skylake/skl.c b/sound/soc/intel/skylake/skl.c
index b0a69f7..ac70af7 100644
--- a/sound/soc/intel/skylake/skl.c
+++ b/sound/soc/intel/skylake/skl.c
@@ -834,6 +834,9 @@ static void skl_remove(struct pci_dev *pci)
 
 	snd_hdac_display_power(&ebus->bus, false);
 	snd_hdac_i915_exit(&ebus->bus);
+	if (skl->tplg)
+		release_firmware(skl->tplg);
+
 	if (pci_dev_run_wake(pci))
 		pm_runtime_get_noresume(&pci->dev);
 	pci_dev_put(pci);
diff --git a/sound/soc/intel/skylake/skl.h b/sound/soc/intel/skylake/skl.h
index b7f028c..7004c27 100644
--- a/sound/soc/intel/skylake/skl.h
+++ b/sound/soc/intel/skylake/skl.h
@@ -77,7 +77,7 @@ struct skl {
 
 	struct skl_dsp_resource resource;
 	struct list_head ppl_list;
-	const struct firmware *fw;
+	const struct firmware *tplg;
 
 	struct skl_debug *debugfs;
 	bool nhlt_override;
-- 
1.7.5.4

