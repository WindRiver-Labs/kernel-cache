From 393e03430a8fefcb5a13b6bae45f3ebd066530fd Mon Sep 17 00:00:00 2001
From: Jeeja KP <jeeja.kp@intel.com>
Date: Wed, 16 Sep 2015 01:56:54 +0530
Subject: [PATCH 1696/2508] ASoC: core: Adds support for DSP loopback dai link

commit dac70f48998666224838221d85d04433998bf817 from
https://github.com/01org/linux-apollolake-i

Only codec-codec dai link is supported. This patch adds support
for dsp loopback dai link

Signed-off-by: Jeeja KP <jeeja.kp@intel.com>
---
 include/sound/soc.h  |    3 +++
 sound/soc/soc-core.c |   20 ++++++++++++++++----
 2 files changed, 19 insertions(+), 4 deletions(-)

diff --git a/include/sound/soc.h b/include/sound/soc.h
index 213d777..345511a 100644
--- a/include/sound/soc.h
+++ b/include/sound/soc.h
@@ -972,6 +972,9 @@ struct snd_soc_dai_link {
 	const struct snd_soc_pcm_stream *params;
 	unsigned int num_params;
 
+	/* flag to create dsp loopback link */
+	unsigned int dsp_loopback:1;
+
 	unsigned int dai_fmt;           /* format to set on init */
 
 	enum snd_soc_dpcm_trigger trigger[2]; /* trigger type for DPCM */
diff --git a/sound/soc/soc-core.c b/sound/soc/soc-core.c
index 1cdc6ef..adb5a31 100644
--- a/sound/soc/soc-core.c
+++ b/sound/soc/soc-core.c
@@ -1295,8 +1295,14 @@ static int soc_link_dai_widgets(struct snd_soc_card *card,
 		dev_warn(card->dev, "ASoC: Multiple codecs not supported yet\n");
 
 	/* link the DAI widgets */
-	play_w = codec_dai->playback_widget;
-	capture_w = cpu_dai->capture_widget;
+	if (!dai_link->dsp_loopback) {
+		play_w = codec_dai->playback_widget;
+		capture_w = cpu_dai->capture_widget;
+	} else {
+		play_w = codec_dai->playback_widget;
+		capture_w = cpu_dai->playback_widget;
+	}
+
 	if (play_w && capture_w) {
 		ret = snd_soc_dapm_new_pcm(card, dai_link->params,
 					   dai_link->num_params, capture_w,
@@ -1308,8 +1314,14 @@ static int soc_link_dai_widgets(struct snd_soc_card *card,
 		}
 	}
 
-	play_w = cpu_dai->playback_widget;
-	capture_w = codec_dai->capture_widget;
+	if (!dai_link->dsp_loopback) {
+		play_w = cpu_dai->playback_widget;
+		capture_w = codec_dai->capture_widget;
+	} else {
+		play_w = cpu_dai->capture_widget;
+		capture_w = codec_dai->capture_widget;
+	}
+
 	if (play_w && capture_w) {
 		ret = snd_soc_dapm_new_pcm(card, dai_link->params,
 					   dai_link->num_params, capture_w,
-- 
1.7.5.4

