From 948e3f10db4405e7ee03d2db23dea368f017e888 Mon Sep 17 00:00:00 2001
From: G Kranthi <gudishax.kranthikumar@intel.com>
Date: Wed, 13 Jul 2016 10:23:57 +0530
Subject: [PATCH 2120/2508] ASoC: Intel: Skylake: Fix missed code for Loadable
 modules

commit 96974144a395038853ad38e9f9b50e31482262f3 from
https://github.com/01org/linux-apollolake-i

Change-Id: Ib6a72867f6380116abce10e8f14e3877cc2c54a0
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/10208
Reviewed-by: B, Jayachandran <jayachandran.b@intel.com>
Tested-by: Jayanti, Satya Charitardha <satya.charitardha.jayanti@intel.com>
---
 sound/soc/intel/skylake/skl-topology.c |   15 ++++++++-------
 1 files changed, 8 insertions(+), 7 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-topology.c b/sound/soc/intel/skylake/skl-topology.c
index 165e87e..7c0cc32 100644
--- a/sound/soc/intel/skylake/skl-topology.c
+++ b/sound/soc/intel/skylake/skl-topology.c
@@ -28,6 +28,8 @@
 #include "skl.h"
 #include "skl-tplg-interface.h"
 #include "skl-fwlog.h"
+#include "../common/sst-dsp.h"
+#include "../common/sst-dsp-priv.h"
 
 #define SKL_CH_FIXUP_MASK		(1 << 0)
 #define SKL_RATE_FIXUP_MASK		(1 << 1)
@@ -806,10 +808,9 @@ skl_tplg_init_pipe_modules(struct skl *skl, struct skl_pipe *pipe)
 		if (!skl_is_pipe_mcps_avail(skl, mconfig))
 			return -ENOMEM;
 
-		skl_tplg_alloc_pipe_mcps(skl, mconfig);
-
-		if (mconfig->is_loadable) {
-			ret = skl_load_modules(ctx, mconfig);
+		if (mconfig->is_loadable && ctx->dsp->fw_ops.load_mod) {
+			ret = ctx->dsp->fw_ops.load_mod(ctx->dsp,
+				mconfig->id.module_id, mconfig->guid);
 			if (ret < 0)
 				return ret;
 		}
@@ -857,9 +858,9 @@ static int skl_tplg_unload_pipe_modules(struct skl_sst *ctx,
 		mconfig  = w_module->w->priv;
 		dev_dbg(ctx->dev, "unload module_id=%d\n", mconfig->id.module_id);
 
-		if (mconfig->is_loadable)
-			ret = skl_unload_modules(ctx, mconfig);
-
+		if (mconfig->is_loadable && ctx->dsp->fw_ops.unload_mod)
+			return ctx->dsp->fw_ops.unload_mod(ctx->dsp,
+						mconfig->id.module_id);
 		ret = skl_dsp_put_core(ctx->dsp, mconfig->core_id);
 		if (ret < 0) {
 			/* notify error, continue with other modules */
-- 
1.7.5.4

