From 1e6ee6b38cde5597fdc7c48402eb2e146b496003 Mon Sep 17 00:00:00 2001
From: "Chrisanthus, Anitha" <anitha.chrisanthus@intel.com>
Date: Thu, 6 Oct 2016 16:13:52 -0700
Subject: [PATCH 4435/4706] drm/i915: moved edid read from _force() to
 _get_modes()

commit 605e3066c9140c8f563963127d0201e20b04b83d from
git://git.yoctoproject.org/linux-yocto-4.1

When the connector is forced ON and firmware EDID is provided,
driver still tries to read the EDID from the sink device, this can increase
the driver's start up time by ~25ms per attempt.
This change is to fix this problem.
By moving the point where we attempt to read EDID from the hdmi and dp
_force functions to the corresponding _get_modes() functions we only
attempt to read EDID if EDID firmware is not provided or if there is no
valid EDID.
This change should have no effect on the general case where the EDID is
normally read during the hdmi or dp _detect() call.

Signed-off-by: Chrisanthus, Anitha <anitha.chrisanthus@intel.com>
Reviewed-by: Bob Paauwe <bob.j.paauwe@intel.com>
[mattrope: Fixed checkpatch warnings]
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
[Kevin: Just some minor context mods in order to port to wrlinux]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/gpu/drm/i915/intel_dp.c   |   31 +++++++++++++++++++++----------
 drivers/gpu/drm/i915/intel_hdmi.c |   14 ++++++++------
 2 files changed, 29 insertions(+), 16 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_dp.c b/drivers/gpu/drm/i915/intel_dp.c
index fd96e36..0b8487a 100644
--- a/drivers/gpu/drm/i915/intel_dp.c
+++ b/drivers/gpu/drm/i915/intel_dp.c
@@ -4487,20 +4487,10 @@ intel_dp_force(struct drm_connector *connector)
 
 	DRM_DEBUG_KMS("[CONNECTOR:%d:%s]\n",
 		      connector->base.id, connector->name);
-	intel_dp_unset_edid(intel_dp);
 
 	if (connector->status != connector_status_connected)
 		return;
 
-	power_domain = intel_display_port_aux_power_domain(intel_encoder);
-	intel_display_power_get(dev_priv, power_domain);
-
-	intel_dp_detect_dpcd(intel_dp);
-
-	intel_dp_set_edid(intel_dp);
-
-	intel_display_power_put(dev_priv, power_domain);
-
 	if (intel_encoder->type != INTEL_OUTPUT_EDP)
 		intel_encoder->type = INTEL_OUTPUT_DP;
 }
@@ -4509,8 +4499,29 @@ static int intel_dp_get_modes(struct drm_connector *connector)
 {
 	struct intel_connector *intel_connector = to_intel_connector(connector);
 	struct edid *edid;
+	struct intel_dp *intel_dp = intel_attached_dp(connector);
+	struct intel_encoder *intel_encoder = &dp_to_dig_port(intel_dp)->base;
+	struct drm_i915_private *dev_priv = to_i915(intel_encoder->base.dev);
+	enum intel_display_power_domain power_domain;
 
 	edid = intel_connector->detect_edid;
+	if ((edid == NULL) &&
+	    (connector->status == connector_status_connected)) {
+
+		intel_dp_unset_edid(intel_dp);
+
+		power_domain =
+			intel_display_port_aux_power_domain(intel_encoder);
+		intel_display_power_get(dev_priv, power_domain);
+
+		intel_dp_detect_dpcd(intel_dp);
+
+		intel_dp_set_edid(intel_dp);
+
+		intel_display_power_put(dev_priv, power_domain);
+
+		edid = intel_connector->detect_edid;
+	}
 	if (edid) {
 		int ret = intel_connector_update_modes(connector, edid);
 		if (ret)
diff --git a/drivers/gpu/drm/i915/intel_hdmi.c b/drivers/gpu/drm/i915/intel_hdmi.c
index 13c3061..0fdf213 100644
--- a/drivers/gpu/drm/i915/intel_hdmi.c
+++ b/drivers/gpu/drm/i915/intel_hdmi.c
@@ -1517,12 +1517,9 @@ intel_hdmi_force(struct drm_connector *connector)
 	DRM_DEBUG_KMS("[CONNECTOR:%d:%s]\n",
 		      connector->base.id, connector->name);
 
-	intel_hdmi_unset_edid(connector);
-
 	if (connector->status != connector_status_connected)
 		return;
 
-	intel_hdmi_set_edid(connector);
 	hdmi_to_dig_port(intel_hdmi)->base.type = INTEL_OUTPUT_HDMI;
 }
 
@@ -1531,9 +1528,14 @@ static int intel_hdmi_get_modes(struct drm_connector *connector)
 	struct edid *edid;
 
 	edid = to_intel_connector(connector)->detect_edid;
-	if (edid == NULL)
-		return 0;
-
+	if ((edid == NULL) &&
+	    (connector->status == connector_status_connected)) {
+		intel_hdmi_unset_edid(connector);
+		intel_hdmi_set_edid(connector);
+		edid = to_intel_connector(connector)->detect_edid;
+		if (edid == NULL)
+			return 0;
+	}
 	return intel_connector_update_modes(connector, edid);
 }
 
-- 
1.7.5.4

