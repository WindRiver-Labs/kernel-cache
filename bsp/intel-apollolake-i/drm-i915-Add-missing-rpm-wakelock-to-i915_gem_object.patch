From 431dbd1649ae1e6e495307806b518e41beaad144 Mon Sep 17 00:00:00 2001
From: "Kamble, Sagar A" <sagar.a.kamble@intel.com>
Date: Wed, 12 Oct 2016 09:01:38 -0700
Subject: [PATCH 4418/4706] drm/i915: Add missing rpm wakelock to
 i915_gem_object_clear

commit 6e75ebc13e44e74bb760e3e4da4d4309514c0bfa from
git://git.yoctoproject.org/linux-yocto-4.1

i915_gem_object_clear was doing the GGTT access, but without using the
rpm wakelock around it. The wakelock is required in order for the GTT
to function.
Just like the GGTT pread, added the wakelock only around the GTT access.

Signed-off-by: Kamble, Sagar A <sagar.a.kamble@intel.com>
Signed-off-by: Jeff McGee <jeff.mcgee@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_gem.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gem.c b/drivers/gpu/drm/i915/i915_gem.c
index ae0582f6..3412657 100644
--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -5083,6 +5083,7 @@ int i915_gem_object_clear(struct drm_i915_gem_object *obj)
 	i915_gem_object_pin_pages(obj);
 	base = io_mapping_map_wc(&i915->ggtt.mappable, node.start, PAGE_SIZE);
 
+	intel_runtime_pm_get(i915);
 	for (i = 0; i < size/PAGE_SIZE; i++) {
 		ggtt->base.insert_page(&ggtt->base,
 				       i915_gem_object_get_dma_address(obj, i),
@@ -5094,6 +5095,7 @@ int i915_gem_object_clear(struct drm_i915_gem_object *obj)
 
 	io_mapping_unmap(base);
 	ggtt->base.clear_range(&ggtt->base, node.start, node.size, true);
+	intel_runtime_pm_put(i915);
 	i915_gem_object_unpin_pages(obj);
 
 err_remove_node:
-- 
1.7.5.4

