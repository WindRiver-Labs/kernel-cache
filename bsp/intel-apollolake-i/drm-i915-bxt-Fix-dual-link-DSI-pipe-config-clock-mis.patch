From 1f89eadab3739dada96edbff7c0de45626380b0e Mon Sep 17 00:00:00 2001
From: Bob Paauwe <bob.j.paauwe@intel.com>
Date: Tue, 20 Dec 2016 10:24:23 -0800
Subject: [PATCH 4454/4706] drm/i915/bxt: Fix dual-link DSI pipe config clock
 mismatch.

commit 55e82def83d27e96d247704248e9f622d45373b1 from
git://git.yoctoproject.org/linux-yocto-4.1

When using a dual link DSI panel, the port clock is programed to
approximately half of crtc clock specified by the mode. When we
read back the hardware value and compare it to the state we need
to account for this.

[drm:intel_pipe_config_compare [i915]] *ERROR* mismatch in base.adjusted_mode.crtc_clock (expected 268630, found 134400)
[drm:intel_pipe_config_compare [i915]] *ERROR* mismatch in port_clock (expected 268630, found 134400)

Signed-off-by: Bob Paauwe <bob.j.paauwe@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/intel_dsi.c |   20 ++++++++++++++------
 1 files changed, 14 insertions(+), 6 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_dsi.c b/drivers/gpu/drm/i915/intel_dsi.c
index 34b65a2..adb9fd6 100644
--- a/drivers/gpu/drm/i915/intel_dsi.c
+++ b/drivers/gpu/drm/i915/intel_dsi.c
@@ -980,23 +980,31 @@ static void bxt_dsi_get_pipe_config(struct intel_encoder *encoder,
 					adjusted_mode_sw->crtc_hblank_end;
 }
 
-static void intel_dsi_get_config(struct intel_encoder *encoder,
+static void intel_dsi_get_config(struct intel_encoder *intel_encoder,
 				 struct intel_crtc_state *pipe_config)
 {
-	struct drm_device *dev = encoder->base.dev;
+	struct drm_device *dev = intel_encoder->base.dev;
+	struct drm_encoder *encoder = &intel_encoder->base;
+	struct intel_dsi *intel_dsi = enc_to_intel_dsi(encoder);
 	u32 pclk;
 	DRM_DEBUG_KMS("\n");
 
 	if (IS_BROXTON(dev))
-		bxt_dsi_get_pipe_config(encoder, pipe_config);
+		bxt_dsi_get_pipe_config(intel_encoder, pipe_config);
 
-	pclk = intel_dsi_get_pclk(encoder, pipe_config->pipe_bpp,
+	pclk = intel_dsi_get_pclk(intel_encoder, pipe_config->pipe_bpp,
 				  pipe_config);
 	if (!pclk)
 		return;
 
-	pipe_config->base.adjusted_mode.crtc_clock = pclk;
-	pipe_config->port_clock = pclk;
+	/* dual link pclk is about 1/2 of crtc clock */
+	if (IS_BROXTON(dev) && (intel_dsi->dual_link)) {
+		pipe_config->base.adjusted_mode.crtc_clock = pclk * 2;
+		pipe_config->port_clock = pclk * 2;
+	} else {
+		pipe_config->base.adjusted_mode.crtc_clock = pclk;
+		pipe_config->port_clock = pclk;
+	}
 }
 
 static enum drm_mode_status
-- 
1.7.5.4

