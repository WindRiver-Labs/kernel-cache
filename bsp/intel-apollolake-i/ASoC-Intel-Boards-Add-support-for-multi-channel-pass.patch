From e33f09d0d1fe449bde27c6e130032b387f0ad37b Mon Sep 17 00:00:00 2001
From: "Panwar, Ashish" <ashish.panwar@intel.com>
Date: Wed, 24 Feb 2016 10:34:39 +0530
Subject: [PATCH 1887/2508] ASoC: Intel: Boards: Add support for multi-channel
 passthrough capture

commit d4a9d4955386310527147f2d66da8bb862da1856 from
https://github.com/01org/linux-apollolake-i

Change-Id: I0c10d42acea86357cd2f51f9506a8d34eabffee2
Signed-off-by: Panwar, Ashish <ashish.panwar@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/8329
Reviewed-by: Shah, Hardik T <hardik.t.shah@intel.com>
Tested-by: Shah, Hardik T <hardik.t.shah@intel.com>
---
 sound/soc/intel/boards/cnl_wm8281.c |   51 +++++++++++++++++++++++++++++++++++
 1 files changed, 51 insertions(+), 0 deletions(-)

diff --git a/sound/soc/intel/boards/cnl_wm8281.c b/sound/soc/intel/boards/cnl_wm8281.c
index 50cdd6e..55db1b9 100644
--- a/sound/soc/intel/boards/cnl_wm8281.c
+++ b/sound/soc/intel/boards/cnl_wm8281.c
@@ -407,6 +407,44 @@ static struct snd_soc_ops mrgfld_florida_ops = {
 	.startup = mrgfld_florida_startup,
 };
 
+static unsigned int rates[] = {
+	16000,
+	48000,
+};
+
+static struct snd_pcm_hw_constraint_list constraints_rates = {
+	.count = ARRAY_SIZE(rates),
+	.list  = rates,
+	.mask = 0,
+};
+
+static unsigned int channels_dmic[] = {
+	2, 4,
+};
+
+static struct snd_pcm_hw_constraint_list constraints_dmic_channels = {
+	.count = ARRAY_SIZE(channels_dmic),
+	.list = channels_dmic,
+	.mask = 0,
+};
+
+static int cnl_dmic_startup(struct snd_pcm_substream *substream)
+{
+	struct snd_pcm_runtime *runtime = substream->runtime;
+
+	runtime->hw.channels_max = 4;
+
+	snd_pcm_hw_constraint_list(runtime, 0, SNDRV_PCM_HW_PARAM_CHANNELS,
+						&constraints_dmic_channels);
+
+	return snd_pcm_hw_constraint_list(substream->runtime, 0,
+			SNDRV_PCM_HW_PARAM_RATE, &constraints_rates);
+}
+
+static struct snd_soc_ops cnl_dmic_ops = {
+	.startup = cnl_dmic_startup,
+};
+
 static int mrgfld_florida_codec_fixup(struct snd_soc_pcm_runtime *rtd,
 			    struct snd_pcm_hw_params *params)
 {
@@ -501,6 +539,19 @@ struct snd_soc_dai_link mrgfld_florida_msic_dailink[] = {
 		.dynamic = 1,
 		.dpcm_capture = 1,
 	},
+	{
+		.name = "CNL Audio DMIC cap",
+		.stream_name = "dmiccap",
+		.cpu_dai_name = "DMIC Pin",
+		.codec_name = "snd-soc-dummy",
+		.codec_dai_name = "snd-soc-dummy-dai",
+		.platform_name = "0000:02:18.0",
+		.init = NULL,
+		.dpcm_capture = 1,
+		.nonatomic = 1,
+		.dynamic = 1,
+		.ops = &cnl_dmic_ops,
+	},
 	/* back ends */
 	{
 		.name = "SSP0-Codec",
-- 
1.7.5.4

