From 16dbf5f3faa1ba98d6b77388f5d18051df8d6d6c Mon Sep 17 00:00:00 2001
From: Takashi Iwai <tiwai@suse.de>
Date: Wed, 26 Aug 2015 07:22:49 +0200
Subject: [PATCH 1745/2508] ALSA: hda - Fix widget sysfs tree corruption after
 refresh

commit a92d5ee8666afcb4abc7686d7b760f0fb7a0c14c upstream

When snd_hdac_refresh_widget_sysfs() is called before the first
hda_widget_sysfs_init(), the next call overrides and eventually
fails.  This results in unexpected Oops, something like:
  BUG: unable to handle kernel NULL pointer dereference at 00000000000000c8
  IP: [<ffffffff8180e2a3>] hdmi_chmap_ctl_info+0x23/0x40

The fix is to add a check of the existing sysfs tree.  Also, for more
safety, this patch adds the checks of device_is_registered() in
snd-hdac_refresh_wdiget_sysfs(), too.

Fixes: fa4f18b4f402 ('ALSA: hda - Refresh widgets sysfs at probing Haswell+ HDMI codecs')
Bugizlla: https://bugzilla.kernel.org/show_bug.cgi?id=103431
Reported-by: Andreas Reis <andreas.reis@gmail.com>
Signed-off-by: Takashi Iwai <tiwai@suse.de>
---
 sound/hda/hdac_device.c |   14 ++++++++------
 sound/hda/hdac_sysfs.c  |    3 +++
 2 files changed, 11 insertions(+), 6 deletions(-)

diff --git a/sound/hda/hdac_device.c b/sound/hda/hdac_device.c
index 72ec9d6..81452f0 100644
--- a/sound/hda/hdac_device.c
+++ b/sound/hda/hdac_device.c
@@ -384,18 +384,20 @@ int snd_hdac_refresh_widget_sysfs(struct hdac_device *codec)
 {
 	int ret;
 
-	hda_widget_sysfs_exit(codec);
+	if (device_is_registered(&codec->dev))
+		hda_widget_sysfs_exit(codec);
 	ret = snd_hdac_refresh_widgets(codec);
 	if (ret) {
 		dev_err(&codec->dev, "failed to refresh widget: %d\n", ret);
 		return ret;
 	}
-	ret = hda_widget_sysfs_init(codec);
-	if (ret) {
-		dev_err(&codec->dev, "failed to init sysfs: %d\n", ret);
-		return ret;
+	if (device_is_registered(&codec->dev)) {
+		ret = hda_widget_sysfs_init(codec);
+		if (ret) {
+			dev_err(&codec->dev, "failed to init sysfs: %d\n", ret);
+			return ret;
+		}
 	}
-
 	return ret;
 }
 EXPORT_SYMBOL_GPL(snd_hdac_refresh_widget_sysfs);
diff --git a/sound/hda/hdac_sysfs.c b/sound/hda/hdac_sysfs.c
index 3fe84f6..e707b5f 100644
--- a/sound/hda/hdac_sysfs.c
+++ b/sound/hda/hdac_sysfs.c
@@ -405,6 +405,9 @@ int hda_widget_sysfs_init(struct hdac_device *codec)
 {
 	int err;
 
+	if (codec->widgets)
+		return 0; /* already created */
+
 	err = widget_tree_create(codec);
 	if (err < 0) {
 		widget_tree_free(codec);
-- 
1.7.5.4

