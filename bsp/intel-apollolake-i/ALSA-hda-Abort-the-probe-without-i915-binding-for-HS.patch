From 42e39a66b97881cb577b001db2a758e86718c26c Mon Sep 17 00:00:00 2001
From: Takashi Iwai <tiwai@suse.de>
Date: Fri, 12 Jun 2015 07:53:58 +0200
Subject: [PATCH 2220/2508] ALSA: hda - Abort the probe without i915 binding
 for HSW/BDW

commit 75509bf35a6f61b231fe9c60fc25d9784c927494 from
https://github.com/01org/linux-apollolake-i

The previous patch tried to continue the probe if i915 binding fails.
For for simplicity reason, we haven't implemented abort even for
controller chips that are dedicated for HDMI/DP on HSW and BDW.
However, Mengdong suggested that this can be dangerous; BIOS may
disable gfx power well although the PCI entry for HD-audio is left,
and this may result in the unexpected behavior, kernel errors, etc.

For avoiding this situation, abort the probe at i915 binding failure
only for HSW/BDW chips selectively.  For other chips, it still
continues.

Fixes: bf06848bdbe5 ('ALSA: hda - Continue probing even if i915 binding fails')
Reported-by: Mengdong Lin <mengdong.lin@intel.com>
Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 535115b5ff51c702a9a22feb918707c2fe1fbd17)
Signed-off-by: SengKai,Tan <seng.kai.tan@intel.com>

Conflicts:
	sound/pci/hda/hda_intel.c
---
 sound/pci/hda/hda_intel.c |   15 +++++++++++++--
 1 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/sound/pci/hda/hda_intel.c b/sound/pci/hda/hda_intel.c
index 45dd233..9827811 100644
--- a/sound/pci/hda/hda_intel.c
+++ b/sound/pci/hda/hda_intel.c
@@ -2031,8 +2031,19 @@ static int azx_probe_continue(struct azx *chip)
 			hda->need_i915_power = 1;
 
 		err = snd_hdac_i915_init(bus);
-		if (err < 0)
-			goto i915_power_fail;
+		if (err < 0) {
+			/* if the controller is bound only with HDMI/DP
+			 * (for HSW and BDW), we need to abort the probe;
+			 * for other chips, still continue probing as other
+			 * codecs can be on the same link.
+			 */
+			if (CONTROLLER_IN_GPU(pci)) {
+				dev_err(chip->card->dev,
+					"HSW/BDW HD-audio HDMI/DP requires binding with gfx driver\n");
+				goto out_free;
+			} else
+				goto skip_i915;
+		}
 
 		err = snd_hdac_display_power(bus, true);
 		if (err < 0) {
-- 
1.7.5.4

