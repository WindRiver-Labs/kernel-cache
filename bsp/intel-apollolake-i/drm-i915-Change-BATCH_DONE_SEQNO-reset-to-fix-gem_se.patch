From 9fe03cbcff74c301d3d005b56d8ff6d9acb314b1 Mon Sep 17 00:00:00 2001
From: Nick Hoath <nicholas.hoath@intel.com>
Date: Mon, 11 Jul 2016 13:54:01 -0700
Subject: [PATCH 2024/2508] drm/i915: Change BATCH_DONE_SEQNO reset to fix
 gem_seqno_wrap lockup

commit a266f5fbe509034cf4247c967a18c2ed4fcfa442 from
https://github.com/01org/linux-apollolake-i

Resetting the HSW seqno to 0 breaks seqno tracking. Set it to passed in seqno
instead.

Fixes: ffb7f1f8d1b208 ("drm/i915/preempt: scheduler logic for landing preemptive requests")
Signed-off-by: Nick Hoath <nicholas.hoath@intel.com>
Signed-off-by: Jeff McGee <jeff.mcgee@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_gem.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gem.c b/drivers/gpu/drm/i915/i915_gem.c
index c958d98..92bf8da 100644
--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -2585,7 +2585,7 @@ i915_gem_init_seqno(struct drm_device *dev, u32 seqno)
 
 	/* Also reset sw batch tracking state */
 	for_each_engine(engine, dev_priv) {
-		intel_write_status_page(engine, I915_BATCH_DONE_SEQNO, 0);
+		intel_write_status_page(engine, I915_BATCH_DONE_SEQNO, seqno);
 		intel_write_status_page(engine, I915_BATCH_ACTIVE_SEQNO, 0);
 		intel_write_status_page(engine, I915_PREEMPTIVE_DONE_SEQNO, 0);
 		intel_write_status_page(engine, I915_PREEMPTIVE_ACTIVE_SEQNO, 0);
-- 
1.7.5.4

