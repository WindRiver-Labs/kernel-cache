From cafcc555bb1e7d95260d57f7303dc1a07289b1a1 Mon Sep 17 00:00:00 2001
From: Ramesh Babu <ramesh.babu@intel.com>
Date: Thu, 16 Jun 2016 16:01:00 +0530
Subject: [PATCH 1996/2508] ALSA: pcm: conditionally avoid mmap of control
 data

commit 34e2ef507b35a890009581bdac35fb9b7eeb7f1f from
https://github.com/01org/linux-apollolake-i

If driver subscribes for appl ptr notifcation,
driver needs to get notification whenever appl ptr changes.
In case of mmap, by default alsa-lib mmaps both control
and status data. So in this case driver won't get
appl ptr notications.

This patch returns error when user land asks for
mmaping control & status data, thus forcing user to issue
IOCTL_SYNC_PTR.

This patch may not be final solution for getting sync ptr
ioctl. It requires more elegant approach/solution.
This needs to proposed in alsa community and
re-modify based on feedback. We need to revert this
patch once we backport the upstream patch.

Change-Id: I61b0526b28c50cb4213e88a2bf95e4cb4dd3af3e
Signed-off-by: Ramesh Babu <ramesh.babu@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/9715
---
 sound/core/pcm_native.c |   12 ++++++++++++
 1 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/sound/core/pcm_native.c b/sound/core/pcm_native.c
index bfb1d29..95560ae 100644
--- a/sound/core/pcm_native.c
+++ b/sound/core/pcm_native.c
@@ -3537,10 +3537,22 @@ static int snd_pcm_mmap(struct file *file, struct vm_area_struct *area)
 	case SNDRV_PCM_MMAP_OFFSET_STATUS:
 		if (pcm_file->no_compat_mmap)
 			return -ENXIO;
+		/*
+		 * we want to force sync pointer,
+		 * if driver implements appl_ptr_update
+		 */
+		if (substream->ops->appl_ptr_update)
+			return -ENXIO;
 		return snd_pcm_mmap_status(substream, file, area);
 	case SNDRV_PCM_MMAP_OFFSET_CONTROL:
 		if (pcm_file->no_compat_mmap)
 			return -ENXIO;
+		/*
+		 * we want to force sync pointer,
+		 * if driver implements appl_ptr_update
+		 */
+		if (substream->ops->appl_ptr_update)
+			return -ENXIO;
 		return snd_pcm_mmap_control(substream, file, area);
 	default:
 		return snd_pcm_mmap_data(substream, file, area);
-- 
1.7.5.4

