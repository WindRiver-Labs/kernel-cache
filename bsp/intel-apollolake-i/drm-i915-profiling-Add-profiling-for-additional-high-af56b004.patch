From f7f720b1387239d3bb009dd14425259515284bfc Mon Sep 17 00:00:00 2001
From: Bob Paauwe <bob.j.paauwe@intel.com>
Date: Tue, 19 Apr 2016 14:46:32 -0700
Subject: [PATCH 4385/4706] drm/i915/profiling: Add profiling for additional
 high level steps.

commit 34cca0be80bc1f3d15b17425e1ed240caf6dd44c from
git://git.yoctoproject.org/linux-yocto-4.1

in the driver load process:

  - hardware initialization time
  - modeset initialization time
  - driver registration time

Signed-off-by: Bob Paauwe <bob.j.paauwe@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_debugfs.c |   12 +++++++++---
 drivers/gpu/drm/i915/i915_drv.c     |   11 +++++++++--
 drivers/gpu/drm/i915/i915_drv.h     |    3 +++
 3 files changed, 21 insertions(+), 5 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_debugfs.c b/drivers/gpu/drm/i915/i915_debugfs.c
index 764efc5..2bc0d01 100644
--- a/drivers/gpu/drm/i915/i915_debugfs.c
+++ b/drivers/gpu/drm/i915/i915_debugfs.c
@@ -2396,12 +2396,18 @@ static int i915_timing_info(struct seq_file *m, void *data)
 	seq_printf(m, "Timing info\n");
 	seq_printf(m, "  Total driver load time:      %lldms\n",
 		   (dev_priv->profile.driver_load / 1000000));
-	seq_printf(m, "    GUC firmware init time:             %lldms\n",
+	seq_printf(m, "    Hardware init time:                 %lldms\n",
+		   (dev_priv->profile.hardware_init / 1000000));
+	seq_printf(m, "    Modeset init time:                  %lldms\n",
+		   (dev_priv->profile.modeset_init / 1000000));
+	seq_printf(m, "        GUC firmware init time:             %lldms\n",
 		   (dev_priv->profile.guc_init / 1000000));
-	seq_printf(m, "    GUC firmware load time:             %lldms\n",
+	seq_printf(m, "        GUC firmware load time:             %lldms\n",
 		   (dev_priv->profile.guc_load / 1000000));
-	seq_printf(m, "    Global GTT init time:               %lldms\n",
+	seq_printf(m, "        Global GTT init time:               %lldms\n",
 		   (dev_priv->profile.gtt_init / 1000000));
+	seq_printf(m, "    Register time:                      %lldms\n",
+		   (dev_priv->profile.driver_register / 1000000));
 	seq_printf(m, "  Frambuffer device load time: %lldms\n",
 		   (dev_priv->profile.fbdev_load / 1000000));
 	seq_printf(m, "  CSR firmware load time:      %lldms\n",
diff --git a/drivers/gpu/drm/i915/i915_drv.c b/drivers/gpu/drm/i915/i915_drv.c
index 2c469e4..19a0e81 100644
--- a/drivers/gpu/drm/i915/i915_drv.c
+++ b/drivers/gpu/drm/i915/i915_drv.c
@@ -1178,9 +1178,9 @@ int i915_driver_load(struct pci_dev *pdev, const struct pci_device_id *ent)
 {
 	struct drm_i915_private *dev_priv;
 	int ret;
-	unsigned long long start_tm;
+	unsigned long long start_tm, sub_load_tm;
 
-	start_tm = sched_clock();
+	start_tm = sub_load_tm = sched_clock();
 
 	if (i915.nuclear_pageflip)
 		driver.driver_features |= DRIVER_ATOMIC;
@@ -1219,6 +1219,9 @@ int i915_driver_load(struct pci_dev *pdev, const struct pci_device_id *ent)
 	if (ret < 0)
 		goto out_cleanup_mmio;
 
+	dev_priv->profile.hardware_init = sched_clock() - sub_load_tm;
+	sub_load_tm = sched_clock();
+
 	/*
 	 * TODO: move the vblank init and parts of modeset init steps into one
 	 * of the i915_driver_init_/i915_driver_register functions according
@@ -1235,7 +1238,11 @@ int i915_driver_load(struct pci_dev *pdev, const struct pci_device_id *ent)
 	if (ret < 0)
 		goto out_cleanup_vblank;
 
+	dev_priv->profile.modeset_init = sched_clock() - sub_load_tm;
+	sub_load_tm = sched_clock();
+
 	i915_driver_register(dev_priv);
+	dev_priv->profile.driver_register = sched_clock() - sub_load_tm;
 
 	intel_runtime_pm_enable(dev_priv);
 
diff --git a/drivers/gpu/drm/i915/i915_drv.h b/drivers/gpu/drm/i915/i915_drv.h
index 7cddd0a..f32ff80 100644
--- a/drivers/gpu/drm/i915/i915_drv.h
+++ b/drivers/gpu/drm/i915/i915_drv.h
@@ -1703,6 +1703,9 @@ struct intel_pipe_crc {
 
 struct intel_load_profiles {
 	unsigned long long driver_load;
+	unsigned long long hardware_init;
+	unsigned long long modeset_init;
+	unsigned long long driver_register;
 	unsigned long long gtt_init;
 	unsigned long long fbdev_load;
 	unsigned long long guc_init;
-- 
1.7.5.4

