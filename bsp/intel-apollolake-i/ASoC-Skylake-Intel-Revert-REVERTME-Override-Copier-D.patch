From ccea1ff24526005fd0ebb301cc932665fbdcccae Mon Sep 17 00:00:00 2001
From: Ramesh Babu <ramesh.babu@intel.com>
Date: Sun, 19 Jun 2016 19:39:50 +0530
Subject: [PATCH 1990/2508] ASoC: Skylake: Intel: Revert "[REVERTME]: Override
 Copier DMA FIFO size"

commit b1131abdb7530ba74ffbbe039c56a0bd87558f82 from
https://github.com/01org/linux-apollolake-i

DMA Buffer size for gateway copier needs to come from
topology binary. Revert the below commit, so that
we can get DMA buffer size from topology binary.

This reverts commit 558201fb467cb76a25cca68d9cd4aa35a80e97c0.

Change-Id: I7f41dbbf9cc71ad39e015ed92b5b4d0d1c9dfa0f
Signed-off-by: Ramesh Babu <ramesh.babu@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/9714
---
 sound/soc/intel/skylake/skl-messages.c |    8 ++------
 sound/soc/intel/skylake/skl-pcm.c      |   28 +++-------------------------
 sound/soc/intel/skylake/skl-topology.h |    1 -
 3 files changed, 5 insertions(+), 32 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-messages.c b/sound/soc/intel/skylake/skl-messages.c
index c9ccd49..ea0137b 100644
--- a/sound/soc/intel/skylake/skl-messages.c
+++ b/sound/soc/intel/skylake/skl-messages.c
@@ -475,7 +475,6 @@ static void skl_setup_cpr_gateway_cfg(struct skl_sst *ctx,
 	union skl_connector_node_id node_id = {0};
 	union skl_ssp_dma_node ssp_node  = {0};
 	struct skl_pipe_params *params = mconfig->pipe->p_params;
-	int dma_buf_dur_ms = 2; /* Default 2 ms */
 
 	switch (mconfig->dev_type) {
 	case SKL_DEVICE_BT:
@@ -517,7 +516,6 @@ static void skl_setup_cpr_gateway_cfg(struct skl_sst *ctx,
 			SKL_DMA_HDA_HOST_OUTPUT_CLASS :
 			SKL_DMA_HDA_HOST_INPUT_CLASS;
 		node_id.node.vindex = params->host_dma_id;
-		dma_buf_dur_ms = mconfig->dma_buf_dur_ms;
 		break;
 
 	default:
@@ -529,11 +527,9 @@ static void skl_setup_cpr_gateway_cfg(struct skl_sst *ctx,
 	cpr_mconfig->gtw_cfg.node_id = node_id.val;
 
 	if (SKL_CONN_SOURCE == mconfig->hw_conn_type)
-		cpr_mconfig->gtw_cfg.dma_buffer_size =
-			dma_buf_dur_ms * mconfig->obs;
+		cpr_mconfig->gtw_cfg.dma_buffer_size = 2 * mconfig->obs;
 	else
-		cpr_mconfig->gtw_cfg.dma_buffer_size =
-			dma_buf_dur_ms * mconfig->ibs;
+		cpr_mconfig->gtw_cfg.dma_buffer_size = 2 * mconfig->ibs;
 
 	cpr_mconfig->cpr_feature_mask = mconfig->fast_mode;
 	cpr_mconfig->gtw_cfg.config_length  = 0;
diff --git a/sound/soc/intel/skylake/skl-pcm.c b/sound/soc/intel/skylake/skl-pcm.c
index 6698a19..9faada7 100644
--- a/sound/soc/intel/skylake/skl-pcm.c
+++ b/sound/soc/intel/skylake/skl-pcm.c
@@ -22,7 +22,6 @@
 #include <linux/pci.h>
 #include <linux/pm_runtime.h>
 #include <linux/firmware.h>
-#include <linux/moduleparam.h>
 #include <sound/pcm_params.h>
 #include <sound/soc.h>
 #include <asm/cacheflush.h>
@@ -37,10 +36,6 @@
 #define HDA_QUAD 4
 #define HDA_8_CH 8
 
-/* FIFO size in ms for Deepbuffer */
-static int dpb_fifo_ms = 30;
-module_param(dpb_fifo_ms, int, 0644);
-
 static struct snd_pcm_hardware azx_pcm_hw = {
 	.info =			(SNDRV_PCM_INFO_MMAP |
 				 SNDRV_PCM_INFO_INTERLEAVED |
@@ -255,18 +250,6 @@ static int skl_pcm_prepare(struct snd_pcm_substream *substream,
 	return err;
 }
 
-static void skl_set_cpr_gtw_dma_fifo_size(struct snd_soc_dai *dai,
-		struct skl_module_cfg *m_cfg)
-{
-	if (!strncmp(dai->name, "Deepbuffer Pin", 14))
-		m_cfg->dma_buf_dur_ms = dpb_fifo_ms;
-	else
-		m_cfg->dma_buf_dur_ms = 2;
-
-	dev_dbg(dai->dev, "Setting copier FIFO size =%d for Dai %s\n",
-			m_cfg->dma_buf_dur_ms, dai->name);
-}
-
 static int skl_pcm_hw_params(struct snd_pcm_substream *substream,
 				struct snd_pcm_hw_params *params,
 				struct snd_soc_dai *dai)
@@ -297,14 +280,9 @@ static int skl_pcm_hw_params(struct snd_pcm_substream *substream,
 	p_params.stream = substream->stream;
 
 	m_cfg = skl_tplg_fe_get_cpr_module(dai, p_params.stream);
-	if (m_cfg) {
-		skl_set_cpr_gtw_dma_fifo_size(dai, m_cfg);
-		skl_tplg_update_pipe_params(dai->dev,
-					m_cfg,
-					&p_params,
-					params_format(params));
-	}
-
+	if (m_cfg)
+		skl_tplg_update_pipe_params(dai->dev, m_cfg,
+					&p_params, params_format(params));
 	return 0;
 }
 
diff --git a/sound/soc/intel/skylake/skl-topology.h b/sound/soc/intel/skylake/skl-topology.h
index c050b1d..39a333c 100644
--- a/sound/soc/intel/skylake/skl-topology.h
+++ b/sound/soc/intel/skylake/skl-topology.h
@@ -321,7 +321,6 @@ struct skl_module_cfg {
 	u32 vbus_id;
 	u32 mem_pages;
 	u32 fast_mode;
-	u32 dma_buf_dur_ms;
 	u32 in_frame_size;
 	u32 out_frame_size;
 	struct skl_module_pin *m_in_pin;
-- 
1.7.5.4

