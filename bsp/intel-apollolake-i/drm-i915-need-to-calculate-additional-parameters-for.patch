From 511cec496c33eac4ee233ecf9a38e60d009e3a0a Mon Sep 17 00:00:00 2001
From: Dongwon Kim <dongwon.kim@intel.com>
Date: Tue, 17 Jan 2017 17:43:58 -0800
Subject: [PATCH 4481/4706] drm/i915: need to calculate additional parameters
 for aux- params

commit e53973d825950ce329a8abbdd5ed1fbc80364f3d from
git://git.yoctoproject.org/linux-yocto-4.1

We need to calcuate height_in_mem and tile_row_adjustment for
the plane prior to calcualtion of aux_dist and aux_stride.

Signed-off-by: Dongwon Kim <dongwon.kim@intel.com>
Acknowledged-by: Matt Roper <matthew.d.roper@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/intel_display.c |   13 +++++++++----
 1 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_display.c b/drivers/gpu/drm/i915/intel_display.c
index 9a8ec9d..69272f1 100644
--- a/drivers/gpu/drm/i915/intel_display.c
+++ b/drivers/gpu/drm/i915/intel_display.c
@@ -3404,7 +3404,8 @@ static void skylake_update_primary_plane(struct drm_plane *plane,
 	const struct drm_intel_sprite_colorkey *key =
 		&to_intel_plane_state(plane->state)->ckey;
 	int pipe = intel_crtc->pipe;
-	u32 plane_ctl;
+	u32 plane_ctl, stride_div;
+	u32 tile_height;
 	unsigned int rotation = plane_state->base.rotation;
 	unsigned int render_comp;
 	u32 stride = skl_plane_stride(fb, 0, rotation);
@@ -3437,11 +3438,15 @@ static void skylake_update_primary_plane(struct drm_plane *plane,
 		 * FIXME: This calculation may change based on HW team's
 		 * confirmation.
 		 */
+		stride_div = intel_fb_stride_alignment(dev_priv, fb->modifier[0],
+                                                  fb->pixel_format);
+		tile_height = PAGE_SIZE / stride_div;
+		height_in_mem = (fb->offsets[1]/fb->pitches[0]);
+		tile_row_adjustment = height_in_mem % tile_height;
+
 		aux_dist = (fb->pitches[0] *
 			   (height_in_mem - tile_row_adjustment));
-		aux_stride = fb->pitches[1] /
-			intel_fb_stride_alignment(dev_priv, fb->modifier[0],
-						  fb->pixel_format);
+		aux_stride = fb->pitches[1] / stride_div;
 
 		plane_ctl |= PLANE_CTL_DECOMPRESSION_ENABLE;
 	} else {
-- 
1.7.5.4

