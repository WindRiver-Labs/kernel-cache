From c2f791102fd170d24392258e2307ef4c0e4c2c5c Mon Sep 17 00:00:00 2001
From: Matt Roper <matthew.d.roper@intel.com>
Date: Fri, 17 Jun 2016 10:39:42 -0700
Subject: [PATCH 1454/2508] drm/i915/gen9: Don't clobber active_crtcs if first
 atomic commit is a modeset

commit 995f2fb845c099de9b1eba73116bf5457c644b65 from
https://github.com/01org/linux-apollolake-i

We sanitize SKL-style watermarks by faking a modeset on first atomic
commit to force a full recompute of watermark-related data.  However if
the first commit actually is a modeset, we don't want to clobber the
active_crtcs field that's been modified already.

Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/intel_pm.c |    8 +++++++-
 1 files changed, 7 insertions(+), 1 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_pm.c b/drivers/gpu/drm/i915/intel_pm.c
index 8e004e8..9a5f02f 100644
--- a/drivers/gpu/drm/i915/intel_pm.c
+++ b/drivers/gpu/drm/i915/intel_pm.c
@@ -3874,6 +3874,11 @@ skl_compute_ddb(struct drm_atomic_state *state)
 	 * ensure a full DDB recompute.
 	 */
 	if (dev_priv->wm.distrust_bios_wm) {
+		ret = drm_modeset_lock(&dev->mode_config.connection_mutex,
+				       state->acquire_ctx);
+		if (ret)
+			return ret;
+
 		intel_state->active_pipe_changes = ~0;
 
 		/*
@@ -3882,7 +3887,8 @@ skl_compute_ddb(struct drm_atomic_state *state)
 		 * initialized during the sanitization process that happens
 		 * on the first commit too.
 		 */
-		intel_state->active_crtcs = dev_priv->active_crtcs;
+		if (!intel_state->modeset)
+			intel_state->active_crtcs = dev_priv->active_crtcs;
 	}
 
 	/*
-- 
1.7.5.4

