From 1e7b368c0496eba2e767de9399238465d7efd81c Mon Sep 17 00:00:00 2001
From: Mousumi Jana <mousumix.jana@intel.com>
Date: Thu, 21 Jul 2016 20:09:25 +0530
Subject: [PATCH 2153/2508] ASoC: Intel: Interface changes to the init hw api

commit 030d70656e8fa93aaad7cc28840d95e39f93579f from
https://github.com/01org/linux-apollolake-i

INIT HW API has been modified to accommodate the number
of SSPs. This is required, for setting the SSPs into
slave mode during firmware download and D0/D3 transitions.
The function has been modified to work with a reduced
argument list for readibility.

Change-Id: I88d369717ad759bc4708ec188d1808cf86a25874
Signed-off-by: Pardha Saradhi K <pardha.saradhi.kesapragada@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/9689
Reviewed-by: B, Jayachandran <jayachandran.b@intel.com>
Tested-by: Jayanti, Satya Charitardha <satya.charitardha.jayanti@intel.com>
---
 sound/soc/intel/common/sst-dsp-priv.h  |    3 +++
 sound/soc/intel/skylake/bxt-sst.c      |   15 ++++++++-------
 sound/soc/intel/skylake/cnl-sst-dsp.h  |    4 ++--
 sound/soc/intel/skylake/cnl-sst.c      |   12 ++++++------
 sound/soc/intel/skylake/skl-messages.c |   12 +++++++++---
 sound/soc/intel/skylake/skl-sst-dsp.h  |    9 +++++----
 sound/soc/intel/skylake/skl-sst.c      |   14 +++++++-------
 sound/soc/intel/skylake/skl.c          |   22 ++++++++++++++--------
 sound/soc/intel/skylake/skl.h          |   14 +++++++++++---
 9 files changed, 65 insertions(+), 40 deletions(-)

diff --git a/sound/soc/intel/common/sst-dsp-priv.h b/sound/soc/intel/common/sst-dsp-priv.h
index 848aab9..af888e5 100644
--- a/sound/soc/intel/common/sst-dsp-priv.h
+++ b/sound/soc/intel/common/sst-dsp-priv.h
@@ -356,6 +356,9 @@ struct sst_dsp {
 	/* DMA FW loading */
 	struct sst_dma *dma;
 	bool fw_use_dma;
+	/* cAVS I2S data */
+	u8 num_i2s_ports;
+
 
 	/* SKL data */
 
diff --git a/sound/soc/intel/skylake/bxt-sst.c b/sound/soc/intel/skylake/bxt-sst.c
index 307366a..1076881 100644
--- a/sound/soc/intel/skylake/bxt-sst.c
+++ b/sound/soc/intel/skylake/bxt-sst.c
@@ -31,6 +31,7 @@
 #include "skl-sst-ipc.h"
 #include "skl-tplg-interface.h"
 #include "skl-fwlog.h"
+#include "skl.h"
 
 #define FW_ROM_INIT_DONE                0x1
 
@@ -101,14 +102,13 @@ static struct sst_dsp_device skl_dev = {
 	.ops = &skl_ops,
 };
 
-int bxt_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
-		struct skl_dsp_loader_ops dsp_ops, struct skl_sst **dsp)
+int bxt_sst_dsp_init_hw(struct device *dev, struct skl_sst **dsp,
+			struct dsp_init *d)
 {
 	struct skl_sst *skl;
 	struct sst_dsp *sst;
 	u32 dsp_wp[] = {BXT_ADSP_WP_DSP0, BXT_ADSP_WP_DSP1};
 	int ret = 0;
-
 	dev_dbg(dev, "In %s\n", __func__);
 
 	skl = devm_kzalloc(dev, sizeof(*skl), GFP_KERNEL);
@@ -119,7 +119,7 @@ int bxt_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 	skl->dev = dev;
 	skl_dev.thread_context = skl;
 
-	skl->dsp = skl_dsp_ctx_init(dev, &skl_dev, irq);
+	skl->dsp = skl_dsp_ctx_init(dev, &skl_dev, d->irq);
 	if (!skl->dsp) {
 		dev_err(skl->dev, "%s: no device\n", __func__);
 		return -ENODEV;
@@ -127,10 +127,10 @@ int bxt_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 
 	sst = skl->dsp;
 
-	sst->dsp_ops = dsp_ops;
+	sst->dsp_ops = d->dsp_ops;
 	sst->fw_ops = bxt_fw_ops;
-	sst->addr.lpe = mmio_base;
-	sst->addr.shim = mmio_base;
+	sst->addr.lpe = d->mmio_base;
+	sst->addr.shim = d->mmio_base;
 	sst->addr.sram0_base = BXT_ADSP_SRAM0_BASE;
 	sst->addr.sram1_base = BXT_ADSP_SRAM1_BASE;
 	sst->addr.w0_stat_sz = BXT_ADSP_W0_STAT_SZ;
@@ -151,6 +151,7 @@ int bxt_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 		return ret;
 
 	sst->core_info.cores = 2;
+	sst->num_i2s_ports = d->num_ssp;
 
 	skl->boot_complete = false;
 	init_waitqueue_head(&skl->boot_wait);
diff --git a/sound/soc/intel/skylake/cnl-sst-dsp.h b/sound/soc/intel/skylake/cnl-sst-dsp.h
index 5f41f1b..3ca1f05 100644
--- a/sound/soc/intel/skylake/cnl-sst-dsp.h
+++ b/sound/soc/intel/skylake/cnl-sst-dsp.h
@@ -104,8 +104,8 @@ int cnl_dsp_disable_core(struct sst_dsp *ctx, unsigned core);
 irqreturn_t cnl_dsp_sst_interrupt(int irq, void *dev_id);
 void cnl_dsp_free(struct sst_dsp *dsp);
 
-int cnl_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
-		struct skl_dsp_loader_ops dsp_ops, struct skl_sst **dsp);
+int cnl_sst_dsp_init_hw(struct device *dev, struct skl_sst **dsp,
+				struct dsp_init *d);
 int cnl_sst_dsp_init_fw(struct device *dev, struct skl_sst *ctx);
 void cnl_sst_dsp_cleanup(struct device *dev, struct skl_sst *ctx);
 
diff --git a/sound/soc/intel/skylake/cnl-sst.c b/sound/soc/intel/skylake/cnl-sst.c
index fd3e3f3..42a5d899 100644
--- a/sound/soc/intel/skylake/cnl-sst.c
+++ b/sound/soc/intel/skylake/cnl-sst.c
@@ -709,8 +709,8 @@ static int cnl_ipc_init(struct device *dev, struct skl_sst *cnl)
 	return 0;
 }
 
-int cnl_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
-		struct skl_dsp_loader_ops dsp_ops, struct skl_sst **dsp)
+int cnl_sst_dsp_init_hw(struct device *dev, struct skl_sst **dsp,
+			struct dsp_init *d)
 {
 	struct skl_sst *cnl;
 	struct sst_dsp *sst;
@@ -725,7 +725,7 @@ int cnl_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 	cnl->dev = dev;
 	cnl_dev.thread_context = cnl;
 
-	cnl->dsp = skl_dsp_ctx_init(dev, &cnl_dev, irq);
+	cnl->dsp = skl_dsp_ctx_init(dev, &cnl_dev, d->irq);
 	if (!cnl->dsp) {
 		dev_err(cnl->dev, "%s: no device\n", __func__);
 		return -ENODEV;
@@ -733,10 +733,10 @@ int cnl_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 
 	sst = cnl->dsp;
 
-	sst->dsp_ops = dsp_ops;
+	sst->dsp_ops = d->dsp_ops;
 	sst->fw_ops = cnl_fw_ops;
-	sst->addr.lpe = mmio_base;
-	sst->addr.shim = mmio_base;
+	sst->addr.lpe = d->mmio_base;
+	sst->addr.shim = d->mmio_base;
 	sst_dsp_mailbox_init(sst, (CNL_ADSP_SRAM0_BASE + CNL_ADSP_W0_STAT_SZ),
 			CNL_ADSP_W0_UP_SZ, CNL_ADSP_SRAM1_BASE, CNL_ADSP_W1_SZ);
 	ret = skl_dsp_init_trace_window(sst, dsp_wp, CNL_ADSP_SRAM2_BASE,
diff --git a/sound/soc/intel/skylake/skl-messages.c b/sound/soc/intel/skylake/skl-messages.c
index 0b068d0..9b8894c 100644
--- a/sound/soc/intel/skylake/skl-messages.c
+++ b/sound/soc/intel/skylake/skl-messages.c
@@ -247,7 +247,7 @@ static int skl_get_dsp_ops(int pci_id)
 	return -EINVAL;
 }
 
-int skl_init_dsp_hw(struct skl *skl)
+int skl_init_dsp_hw(struct skl *skl, u32 num_ssp)
 {
 	void __iomem *mmio_base;
 	struct hdac_ext_bus *ebus = &skl->ebus;
@@ -255,6 +255,7 @@ int skl_init_dsp_hw(struct skl *skl)
 	struct skl_dsp_loader_ops loader_ops;
 	int irq = bus->irq;
 	int ret, index;
+	struct dsp_init *d;
 
 	/* enable ppcap interrupt */
 	snd_hdac_ext_bus_ppcap_enable(&skl->ebus, true);
@@ -275,8 +276,13 @@ int skl_init_dsp_hw(struct skl *skl)
 	}
 
 	loader_ops = dsp_ops[index].loader_ops();
-	ret = dsp_ops[index].init_hw(bus->dev, mmio_base, irq,
-		loader_ops, &skl->skl_sst);
+	d = kzalloc(sizeof(struct dsp_init), GFP_KERNEL);
+	d->mmio_base = mmio_base;
+	d->irq = irq;
+	d->dsp_ops = loader_ops;
+	d->num_ssp = num_ssp;
+	ret = dsp_ops[index].init_hw(bus->dev, &skl->skl_sst, d);
+	kfree(d);
 dsp_init_exit:
 	dev_dbg(bus->dev, "dsp registration status=%d\n", ret);
 
diff --git a/sound/soc/intel/skylake/skl-sst-dsp.h b/sound/soc/intel/skylake/skl-sst-dsp.h
index 5e06335..9e90691 100644
--- a/sound/soc/intel/skylake/skl-sst-dsp.h
+++ b/sound/soc/intel/skylake/skl-sst-dsp.h
@@ -24,6 +24,7 @@
 struct sst_dsp;
 struct skl_sst;
 struct sst_dsp_device;
+struct dsp_init;
 
 /* Intel HD Audio General DSP Registers */
 #define SKL_ADSP_GEN_BASE		0x0
@@ -238,10 +239,10 @@ int skl_dsp_get_core(struct sst_dsp *ctx, unsigned int core_id);
 int skl_dsp_put_core(struct sst_dsp *ctx, unsigned int core_id);
 
 int skl_dsp_boot(struct sst_dsp *ctx);
-int skl_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
-		struct skl_dsp_loader_ops dsp_ops, struct skl_sst **dsp);
-int bxt_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
-		struct skl_dsp_loader_ops dsp_ops, struct skl_sst **dsp);
+int skl_sst_dsp_init_hw(struct device *dev, struct skl_sst **dsp,
+			struct dsp_init *d);
+int bxt_sst_dsp_init_hw(struct device *dev, struct skl_sst **dsp,
+			struct dsp_init *d);
 int skl_sst_dsp_init_fw(struct device *dev, struct skl_sst *ctx);
 int bxt_sst_dsp_init_fw(struct device *dev, struct skl_sst *ctx);
 void skl_sst_dsp_cleanup(struct device *dev, struct skl_sst *ctx);
diff --git a/sound/soc/intel/skylake/skl-sst.c b/sound/soc/intel/skylake/skl-sst.c
index a1f8dfe..ca76a98 100644
--- a/sound/soc/intel/skylake/skl-sst.c
+++ b/sound/soc/intel/skylake/skl-sst.c
@@ -23,6 +23,7 @@
 #include "../common/sst-ipc.h"
 #include "skl-sst-ipc.h"
 #include "skl-fwlog.h"
+#include "skl.h"
 
 #define SKL_BASEFW_TIMEOUT	300
 #define SKL_INIT_TIMEOUT	1000
@@ -450,8 +451,7 @@ static struct sst_dsp_device skl_dev = {
 	.ops = &skl_ops,
 };
 
-int skl_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
-		struct skl_dsp_loader_ops dsp_ops, struct skl_sst **dsp)
+int skl_sst_dsp_init_hw(struct device *dev, struct skl_sst **dsp, struct dsp_init *d)
 {
 	struct skl_sst *skl;
 	struct sst_dsp *sst;
@@ -465,7 +465,7 @@ int skl_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 	skl->dev = dev;
 	skl_dev.thread_context = skl;
 
-	skl->dsp = skl_dsp_ctx_init(dev, &skl_dev, irq);
+	skl->dsp = skl_dsp_ctx_init(dev, &skl_dev, d->irq);
 	if (!skl->dsp) {
 		dev_err(skl->dev, "%s: no device\n", __func__);
 		return -ENODEV;
@@ -473,8 +473,8 @@ int skl_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 
 	sst = skl->dsp;
 
-	sst->addr.lpe = mmio_base;
-	sst->addr.shim = mmio_base;
+	sst->addr.lpe = d->mmio_base;
+	sst->addr.shim = d->mmio_base;
 	sst_dsp_mailbox_init(sst, (SKL_ADSP_SRAM0_BASE + SKL_ADSP_W0_STAT_SZ),
 			SKL_ADSP_W0_UP_SZ, SKL_ADSP_SRAM1_BASE, SKL_ADSP_W1_SZ);
 
@@ -486,7 +486,7 @@ int skl_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 	}
 
 	INIT_LIST_HEAD(&sst->module_list);
-	sst->dsp_ops = dsp_ops;
+	sst->dsp_ops = d->dsp_ops;
 	sst->fw_ops = skl_fw_ops;
 
 	ret = skl_ipc_init(dev, skl);
@@ -494,7 +494,7 @@ int skl_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 		return ret;
 
 	sst->core_info.cores = 2;
-
+	sst->num_i2s_ports = d->num_ssp;
 
 	if (dsp)
 		*dsp = skl;
diff --git a/sound/soc/intel/skylake/skl.c b/sound/soc/intel/skylake/skl.c
index 8138f61..64cb4ea 100644
--- a/sound/soc/intel/skylake/skl.c
+++ b/sound/soc/intel/skylake/skl.c
@@ -46,10 +46,15 @@ static char *machine;
 module_param(machine, charp, 0444);
 MODULE_PARM_DESC(machine, "machine driver string for Intel soundcard.");
 
+#define SKL_NUM_I2S_PORTS	3
+#define BXT_NUM_I2S_PORTS	4
+#define BXTP_NUM_I2S_PORTS	6
+#define CNL_NUM_I2S_PORTS	3
 
 struct sst_machines {
 	char *codec_id;
 	char *machine;
+	unsigned int num_i2s_ports;
 };
 
 /*
@@ -488,8 +493,8 @@ static struct sst_machines *sst_acpi_find_machine(
 
 /* TODO fill codec acpi name */
 static struct sst_machines sst_cnl_devdata[] = {
-	{ "dummy", "cnl_florida" },
-	{ "dummy", "cnl_florida" },
+	{ "dummy", "cnl_florida", CNL_NUM_I2S_PORTS },
+	{ "dummy", "cnl_florida", CNL_NUM_I2S_PORTS },
 };
 
 static int skl_machine_device_register(struct skl *skl, void *driver_data)
@@ -797,6 +802,7 @@ static int skl_probe(struct pci_dev *pci,
 	const struct firmware *nhlt_fw = NULL;
 #endif
 	int err;
+	struct sst_machines *mch = (struct sst_machines *)(pci_id->driver_data);
 
 	/* we use ext core ops, so provide NULL for ops here */
 	err = skl_create(pci, NULL, &skl);
@@ -835,7 +841,7 @@ static int skl_probe(struct pci_dev *pci,
 
 	/* check if dsp is there */
 	if (ebus->ppcap) {
-		err = skl_init_dsp_hw(skl);
+		err = skl_init_dsp_hw(skl, mch->num_i2s_ports);
 		if (err) {
 			dev_err(bus->dev, "DSP HW Init failed\n");
 			goto out_free;
@@ -956,17 +962,17 @@ static void skl_remove(struct pci_dev *pci)
 }
 
 static struct sst_machines sst_skl_devdata[] = {
-	{ "INT343A", "skl_alc286s_i2s" },
-	{ "INT343B", "skl_nau88l25_ssm4567_i2s" },
+	{ "INT343A", "skl_alc286s_i2s", SKL_NUM_I2S_PORTS },
+	{ "INT343B", "skl_nau88l25_ssm4567_i2s", SKL_NUM_I2S_PORTS },
 };
 
 static struct sst_machines sst_bxt_devdata[] = {
-	{ "INT34C1", "mrgfld_florida" },
-	{ "INT34E0", "mrgfld_florida" },
+	{ "INT34C1", "mrgfld_florida", BXT_NUM_I2S_PORTS },
+	{ "INT34E0", "mrgfld_florida", BXT_NUM_I2S_PORTS },
 };
 
 static struct sst_machines sst_bxtp_devdata[] = {
-	{ "INT343A", "bxt_alc298s_i2s" },
+	{ "INT343A", "bxt_alc298s_i2s", BXTP_NUM_I2S_PORTS },
 };
 
 /* PCI IDs */
diff --git a/sound/soc/intel/skylake/skl.h b/sound/soc/intel/skylake/skl.h
index 9fc09490..efbf05a 100644
--- a/sound/soc/intel/skylake/skl.h
+++ b/sound/soc/intel/skylake/skl.h
@@ -25,6 +25,7 @@
 #include <sound/hdaudio_ext.h>
 #include "skl-nhlt.h"
 #include "skl-tplg-interface.h"
+#include "skl-sst-dsp.h"
 
 #define SKL_SUSPEND_DELAY 2000
 
@@ -67,6 +68,13 @@ struct skl_dsp_resource {
 struct skl_debug;
 struct snd_soc_dapm_widget;
 
+struct dsp_init {
+	void __iomem *mmio_base;
+	int irq;
+	struct skl_dsp_loader_ops dsp_ops;
+	u8 num_ssp;
+};
+
 struct skl {
 	struct hdac_ext_bus ebus;
 	struct pci_dev *pci;
@@ -113,8 +121,8 @@ struct skl_dsp_ops {
 	int id;
 	struct skl_dsp_loader_ops (*loader_ops)(void);
 
-	int (*init_hw)(struct device *dev, void __iomem *mmio_base, int irq,
-		struct skl_dsp_loader_ops loader_ops, struct skl_sst **skl_sst);
+	int (*init_hw)(struct device *dev, struct skl_sst **skl_sst,
+		struct dsp_init *d);
 	int (*init_fw)(struct device *dev, struct skl_sst *ctx);
 	void (*cleanup)(struct device *dev, struct skl_sst *ctx);
 };
@@ -127,7 +135,7 @@ void skl_nhlt_free(struct nhlt_acpi_table *addr);
 struct nhlt_specific_cfg *skl_get_ep_blob(struct skl *skl, u32 instance,
 			u8 link_type, u8 s_fmt, u8 no_ch, u32 s_rate, u8 dirn);
 
-int skl_init_dsp_hw(struct skl *skl);
+int skl_init_dsp_hw(struct skl *skl, u32 num_ssp);
 int skl_init_dsp_fw(struct skl *skl);
 int skl_free_dsp(struct skl *skl);
 int skl_suspend_dsp(struct skl *skl);
-- 
1.7.5.4

