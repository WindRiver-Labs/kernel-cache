From 0c115ff84ecb4c5779a913587ba66b1b05c17448 Mon Sep 17 00:00:00 2001
From: "Kamble, Sagar A" <sagar.a.kamble@intel.com>
Date: Wed, 27 Jul 2016 09:26:08 -0700
Subject: [PATCH 4380/4706] drm/i915: Sample GuC forcewakes before enabling
 CPG

commit 8e06e27da6001352b4c7bbe66de27ad8451dd0bf from
git://git.yoctoproject.org/linux-yocto-4.1

During i915_gem_init_hw, i915 holds forcewake for all engines
Hence notification of sampling of GuC forcewakes can be deferred
from submission enablement path to enabling of CPG/RC6. This will
fix issue where RC6 stops working due to GuC keeping forcewake ON
inadvertently due to special case CSB interrupt timing.

Signed-off-by: Kamble, Sagar A <sagar.a.kamble@intel.com>
Signed-off-by: Jeff McGee <jeff.mcgee@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_guc_submission.c |    6 ++----
 drivers/gpu/drm/i915/intel_guc.h           |    1 +
 drivers/gpu/drm/i915/intel_pm.c            |    2 ++
 3 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_guc_submission.c b/drivers/gpu/drm/i915/i915_guc_submission.c
index 3106dcc..fdbd24a 100644
--- a/drivers/gpu/drm/i915/i915_guc_submission.c
+++ b/drivers/gpu/drm/i915/i915_guc_submission.c
@@ -153,10 +153,9 @@ static int host2guc_release_doorbell(struct intel_guc *guc,
 	return host2guc_action(guc, data, 2);
 }
 
-static int host2guc_sample_forcewake(struct intel_guc *guc,
-				     struct i915_guc_client *client)
+int i915_guc_sample_forcewake(struct drm_i915_private *dev_priv)
 {
-	struct drm_i915_private *dev_priv = guc_to_i915(guc);
+	struct intel_guc *guc = &dev_priv->guc;
 	u32 data[2];
 
 	data[0] = HOST2GUC_ACTION_SAMPLE_FORCEWAKE;
@@ -1029,7 +1028,6 @@ int i915_guc_submission_enable(struct drm_i915_private *dev_priv)
 	}
 
 	guc->execbuf_client = client;
-	host2guc_sample_forcewake(guc, client);
 	guc_init_doorbell_hw(guc);
 
 	/* Take over from manual control of ELSP (execlists) */
diff --git a/drivers/gpu/drm/i915/intel_guc.h b/drivers/gpu/drm/i915/intel_guc.h
index 5cdf7aa..1363efa 100644
--- a/drivers/gpu/drm/i915/intel_guc.h
+++ b/drivers/gpu/drm/i915/intel_guc.h
@@ -159,6 +159,7 @@ extern int intel_guc_resume(struct drm_device *dev);
 /* i915_guc_submission.c */
 int i915_guc_submission_init(struct drm_i915_private *dev_priv);
 int i915_guc_submission_enable(struct drm_i915_private *dev_priv);
+int i915_guc_sample_forcewake(struct drm_i915_private *dev_priv);
 int i915_guc_wq_reserve(struct drm_i915_gem_request *rq);
 void i915_guc_wq_unreserve(struct drm_i915_gem_request *request);
 void i915_guc_submission_disable(struct drm_i915_private *dev_priv);
diff --git a/drivers/gpu/drm/i915/intel_pm.c b/drivers/gpu/drm/i915/intel_pm.c
index 627b775..b540bf2 100644
--- a/drivers/gpu/drm/i915/intel_pm.c
+++ b/drivers/gpu/drm/i915/intel_pm.c
@@ -5417,6 +5417,8 @@ static void gen9_enable_rc6(struct drm_i915_private *dev_priv)
 			   rc6_mask);
 	}
 
+	i915_guc_sample_forcewake(dev_priv);
+
 	/*
 	 * 3b: Enable Coarse Power Gating only when RC6 is enabled.
 	 * WaRsDisableCoarsePowerGating:skl,bxt - Render/Media PG need to be disabled with RC6.
-- 
1.7.5.4

