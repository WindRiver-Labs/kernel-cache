From 88cb794a36119ba0b7b42243eb099e3e923771ec Mon Sep 17 00:00:00 2001
From: Evyatar Vaalani <evyatar.vaalani@intel.com>
Date: Wed, 24 Aug 2016 10:17:56 +0300
Subject: [PATCH 18/68] mei: dal: use corret device for debug and error
 messages

commit 4674b5e530d461ce20b13f76c79bd4f6c3c5a23c from
git://git.yoctoproject.org/linux-yocto-4.1

Prevent crashing in prints during power management transitions,
as the print device my not be present.

Change-Id: I042e43c3117689860c5ba00cbe18b3d0bc663cbe
Signed-off-by: Evyatar Vaalani <evyatar.vaalani@intel.com>
Signed-off-by: Tomas Winkler <tomas.winkler@intel.com>
---
 drivers/misc/mei/dal/bhp_impl.c  |    7 +++----
 drivers/misc/mei/dal/dal_cdev.c  |    5 ++---
 drivers/misc/mei/dal/dal_class.c |    2 +-
 3 files changed, 6 insertions(+), 8 deletions(-)

diff --git a/drivers/misc/mei/dal/bhp_impl.c b/drivers/misc/mei/dal/bhp_impl.c
index 0b23a6b..1a8c7dd 100644
--- a/drivers/misc/mei/dal/bhp_impl.c
+++ b/drivers/misc/mei/dal/bhp_impl.c
@@ -198,12 +198,11 @@ static int kdi_recv_wrapper(unsigned int handle,
 
 	ret = kfifo_out(&dc->read_queue,
 			&bh_msg[ddev->device_id], sizeof(struct dal_bh_msg));
-	dev_dbg(&ddev->cldev->dev, "kfifo_out() ret = %zd\n", ret);
+	dev_dbg(&ddev->dev, "kfifo_out() ret = %zd\n", ret);
 
 	if (bh_msg[ddev->device_id].len > *length) {
-		dev_dbg(&ddev->cldev->dev, "could not copy buffer. ");
-		dev_dbg(&ddev->cldev->dev, "src buffer size = %zd, dest buffer size = %u\n",
-				bh_msg[ddev->device_id].len, *length);
+		dev_dbg(&ddev->dev, "could not copy buffer: src size = %zd, dest size = %u\n",
+			bh_msg[ddev->device_id].len, *length);
 		ret = BPE_COMMS_ERROR;
 		goto out;
 	}
diff --git a/drivers/misc/mei/dal/dal_cdev.c b/drivers/misc/mei/dal/dal_cdev.c
index 2072911..8211b5c 100644
--- a/drivers/misc/mei/dal/dal_cdev.c
+++ b/drivers/misc/mei/dal/dal_cdev.c
@@ -154,9 +154,8 @@ static ssize_t dal_dev_read(struct file *fp, char __user *buff,
 	dev_dbg(&ddev->dev, "kfifo_out() ret = %zd\n", ret);
 
 	if (bh_msg[ddev->device_id].len > count) {
-		dev_dbg(&ddev->dev, "could not copy buffer. ");
-		dev_dbg(&ddev->dev, "src buffer size = %zd, dest buffer size = %zu\n",
-				bh_msg[ddev->device_id].len, count);
+		dev_dbg(&ddev->dev, "could not copy buffer: src size = %zd, dest size = %zu\n",
+			bh_msg[ddev->device_id].len, count);
 		return -EFAULT;
 	}
 
diff --git a/drivers/misc/mei/dal/dal_class.c b/drivers/misc/mei/dal/dal_class.c
index 16e83a9..fddd7c0 100644
--- a/drivers/misc/mei/dal/dal_class.c
+++ b/drivers/misc/mei/dal/dal_class.c
@@ -357,7 +357,7 @@ ssize_t dal_read(struct dal_client *dc)
 
 	/* FIXME: use reference counter */
 	if (ddev->is_device_removed) {
-		dev_dbg(&ddev->cldev->dev, "woke up, device was removed\n");
+		dev_dbg(dev, "woke up, device was removed\n");
 		return -ENODEV;
 	}
 
-- 
1.7.5.4

