From 5905a4ddd04691cbb0fa4c5cb72f1ccf3da886be Mon Sep 17 00:00:00 2001
From: Bob Paauwe <bob.j.paauwe@intel.com>
Date: Fri, 22 Apr 2016 16:43:24 -0700
Subject: [PATCH 1427/2508] drm/i915/modeset: Add function timing info.

commit c4a851615274f734cb4e4efe2ca0d66dda17100e from
https://github.com/01org/linux-apollolake-i

Track the time it takes to do the initial mode set. In addition track the
setup time separately.

v2: Fix cut-n-paste error with commit timing output.

Signed-off-by: Bob Paauwe <bob.j.paauwe@intel.com>
Reviewed-by: Matt Roper <matthew.d.roper@intel.com>
Reviewed-by: James Xiong <james.xiong@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_debugfs.c          |    4 ++++
 drivers/gpu/drm/i915/i915_drv.h              |    2 ++
 drivers/gpu/drm/i915/intel_initial_modeset.c |    4 ++++
 3 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_debugfs.c b/drivers/gpu/drm/i915/i915_debugfs.c
index 8ac1313..c27bf2a 100644
--- a/drivers/gpu/drm/i915/i915_debugfs.c
+++ b/drivers/gpu/drm/i915/i915_debugfs.c
@@ -2691,6 +2691,10 @@ static int i915_timing_info(struct seq_file *m, void *data)
 		   (dev_priv->profile.fbdev_load / 1000000));
 	seq_printf(m, "  CSR firmware load time:      %4lldms\n",
 		   (dev_priv->profile.csr_load / 1000000));
+	seq_printf(m, "  Initial mode run time:       %4lldms\n",
+		   (dev_priv->profile.initial_mode_run / 1000000));
+	seq_printf(m, "  Initial mode get config time:         %4lldms\n",
+		   (dev_priv->profile.initial_mode_get_config / 1000000));
 
 	return 0;
 }
diff --git a/drivers/gpu/drm/i915/i915_drv.h b/drivers/gpu/drm/i915/i915_drv.h
index 3bd9e0f..958bd8f 100644
--- a/drivers/gpu/drm/i915/i915_drv.h
+++ b/drivers/gpu/drm/i915/i915_drv.h
@@ -1732,6 +1732,8 @@ struct intel_load_profiles {
 	unsigned long long guc_init;
 	unsigned long long guc_load;
 	unsigned long long csr_load;
+	unsigned long long initial_mode_run;
+	unsigned long long initial_mode_get_config;
 };
 
 struct i915_frontbuffer_tracking {
diff --git a/drivers/gpu/drm/i915/intel_initial_modeset.c b/drivers/gpu/drm/i915/intel_initial_modeset.c
index c490e76..3f73667 100644
--- a/drivers/gpu/drm/i915/intel_initial_modeset.c
+++ b/drivers/gpu/drm/i915/intel_initial_modeset.c
@@ -337,6 +337,7 @@ static void modeset_config_fn(struct work_struct *work)
 	struct drm_plane *plane;
 	int ret;
 	bool found = false;
+	unsigned long long start = sched_clock();
 
 	state = drm_atomic_state_alloc(dev);
 	if (!state)
@@ -392,6 +393,8 @@ retry:
 		}
 	}
 
+	dev_priv->profile.initial_mode_get_config = sched_clock() - start;
+
 	if (found) {
 		ret = drm_modeset_lock(&dev->mode_config.connection_mutex,
 				       state->acquire_ctx);
@@ -426,6 +429,7 @@ out:
 	}
 	drm_modeset_drop_locks(&ctx);
 	drm_modeset_acquire_fini(&ctx);
+	dev_priv->profile.initial_mode_run = sched_clock() - start;
 }
 
 void intel_initial_mode_config_init(struct drm_device *dev)
-- 
1.7.5.4

