From 55bd9acc5d18296186e4f55d6fe0e111f579ca9c Mon Sep 17 00:00:00 2001
From: Yael Samet <yael.samet@intel.com>
Date: Thu, 12 Jan 2017 13:22:09 +0200
Subject: [PATCH 4661/4706] mei: dal: revamp retry look in bh_cmd_transfer

commit a515e23d33ec8bbb3a5a179b8a6eb572d9c7fcbb from
git://git.yoctoproject.org/linux-yocto-4.1

Make the retry loop more readable; use a for loop
rather than do-while and print an error on failure.

Change-Id: I707d33aa491811262c9413b0fc5fdae57b8b5c15
Signed-off-by: Yael Samet <yael.samet@intel.com>
---
 drivers/misc/mei/dal/bhp_impl.c |   31 ++++++++++++++++++-------------
 1 files changed, 18 insertions(+), 13 deletions(-)

diff --git a/drivers/misc/mei/dal/bhp_impl.c b/drivers/misc/mei/dal/bhp_impl.c
index a899264..268ad24 100644
--- a/drivers/misc/mei/dal/bhp_impl.c
+++ b/drivers/misc/mei/dal/bhp_impl.c
@@ -565,33 +565,38 @@ static void bh_connections_deinit(void)
 		bh_do_disconnect(i);
 }
 
-#define MAX_RETRY_COUNT   (3)
+#define MAX_RETRY_COUNT 3
 int bh_cmd_transfer(int conn_idx, void *cmd, unsigned int clen,
 		    const void *data, unsigned int dlen, u64 seq)
 {
 	int ret;
-	u32 retry_count = 0;
+	u32 retry_count;
 	u64 seq_response = 0;
 
 	ret = bh_send_message(conn_idx, cmd, clen, data, dlen, seq);
 	if (ret)
 		return ret;
 
-	do {
+	for (retry_count = 0; retry_count < MAX_RETRY_COUNT; retry_count++) {
 		ret = bh_recv_message(conn_idx, &seq_response);
-		if (!ret) {
-			pr_debug("recv message with seq=%llu\n",
-					seq_response);
-			if (seq_response == seq)
-				break;
+		if (ret) {
+			pr_debug("failed to recv msg = %d\n", ret);
+			continue;
 		}
-		pr_debug("recv message with seq=%llu != seq_response=%llu\n",
-				seq, seq_response);
-		retry_count++;
-	} while (retry_count < MAX_RETRY_COUNT);
+
+		if (seq_response != seq) {
+			pr_debug("recv message with seq=%llu != seq_response=%llu\n",
+				 seq, seq_response);
+			continue;
+		}
+
+		pr_debug("recv message with try=%d seq=%llu\n",
+			 retry_count, seq_response);
+		break;
+	}
 
 	if (retry_count == MAX_RETRY_COUNT) {
-		pr_debug("out of retry attempts\n");
+		pr_err("out of retry attempts\n");
 		ret = -EFAULT;
 	}
 
-- 
1.7.5.4

