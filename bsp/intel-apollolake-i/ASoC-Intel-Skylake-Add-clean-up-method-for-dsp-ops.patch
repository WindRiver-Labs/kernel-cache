From d6c6a6ee562b1b03143869042bf63eeb305f4dda Mon Sep 17 00:00:00 2001
From: "Pawse, GuruprasadX" <guruprasadx.pawse@intel.com>
Date: Tue, 8 Sep 2015 18:25:24 +0530
Subject: [PATCH 1754/2508] ASoC: Intel: Skylake: Add clean-up method for dsp
 ops

commit be575404da9f0721fade7a8b8a4755d6bde273d6 from
https://github.com/01org/linux-apollolake-i

We need to have dsp cleanup method similar to init
which would get invoked based on the SoC.

Change-Id: I18670168cb30faf164a2c15dbb0da4ef330f4bae
Signed-off-by: Pawse, GuruprasadX <guruprasadx.pawse@intel.com>
Signed-off-by: Ramesh Babu <ramesh.babu@intel.com>
---
 sound/soc/intel/skylake/skl-messages.c |   10 ++++++++--
 sound/soc/intel/skylake/skl.h          |    1 +
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-messages.c b/sound/soc/intel/skylake/skl-messages.c
index 29fec69..d381aa2 100644
--- a/sound/soc/intel/skylake/skl-messages.c
+++ b/sound/soc/intel/skylake/skl-messages.c
@@ -192,7 +192,7 @@ static struct skl_dsp_loader_ops bxt_get_loader_ops(void)
 };
 
 static const struct skl_dsp_ops dsp_ops[] = {
-{.id = 0x9d70, .loader_ops = skl_get_loader_ops, .init = skl_sst_dsp_init}
+{.id = 0x9d70, .loader_ops = skl_get_loader_ops, .init = skl_sst_dsp_init, .cleanup = skl_sst_dsp_cleanup}
 };
 
 static int skl_get_dsp_ops(int pci_id)
@@ -248,11 +248,17 @@ void skl_free_dsp(struct skl *skl)
 	struct hdac_ext_bus *ebus = &skl->ebus;
 	struct hdac_bus *bus = ebus_to_hbus(ebus);
 	struct skl_sst *ctx =  skl->skl_sst;
+	int index;
 
 	/* disable  ppcap interrupt */
 	snd_hdac_ext_bus_ppcap_int_enable(&skl->ebus, false);
 
-	skl_sst_dsp_cleanup(bus->dev, ctx);
+	index  = skl_get_dsp_ops(skl->pci->device);
+	if (index  < 0)
+		return -EINVAL;
+
+	dsp_ops[index].cleanup(bus->dev, ctx);
+
 	if (ctx->dsp->addr.lpe)
 		iounmap(ctx->dsp->addr.lpe);
 }
diff --git a/sound/soc/intel/skylake/skl.h b/sound/soc/intel/skylake/skl.h
index 96b4b28..adfdbf3 100644
--- a/sound/soc/intel/skylake/skl.h
+++ b/sound/soc/intel/skylake/skl.h
@@ -92,6 +92,7 @@ struct skl_dsp_ops {
 	int (*init)(struct device *dev, void __iomem *mmio_base,
 			int irq, struct skl_dsp_loader_ops loader_ops,
 						struct skl_sst **skl_sst);
+	void (*cleanup)(struct device *dev, struct skl_sst *ctx);
 };
 
 int skl_platform_unregister(struct device *dev);
-- 
1.7.5.4

