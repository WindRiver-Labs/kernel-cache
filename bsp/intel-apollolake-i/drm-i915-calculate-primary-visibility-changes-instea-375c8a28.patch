From 054d92fedb74b409fa985c0b3a770088d4b38ab2 Mon Sep 17 00:00:00 2001
From: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
Date: Fri, 2 Oct 2015 10:48:06 -0700
Subject: [PATCH 0630/4706] drm/i915: calculate primary visibility changes
 instead of calling from set_config

commit 609c0c98afcf20c0ce529e2b521e8e955f7e4c77 from
git://git.yoctoproject.org/linux-yocto-4.1

This should be much cleaner, with the same effects.

Signed-off-by: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
Reviewed-by: Matt Roper <matthew.d.roper@intel.com>
Signed-off-by: Jani Nikula <jani.nikula@intel.com>
(cherry picked from commit fb9d6cf8c29bfcb0b3c602f7ded87f128d730382)
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>

Conflicts:
	drivers/gpu/drm/i915/intel_display.c
---
 drivers/gpu/drm/i915/intel_display.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_display.c b/drivers/gpu/drm/i915/intel_display.c
index fb5cc7a..a59ab51d 100644
--- a/drivers/gpu/drm/i915/intel_display.c
+++ b/drivers/gpu/drm/i915/intel_display.c
@@ -13607,7 +13607,7 @@ intel_check_primary_plane(struct drm_plane *plane,
 			if (IS_BROADWELL(dev))
 				intel_crtc->atomic.wait_vblank = true;
 
-			if (crtc_state)
+			if (crtc_state && !needs_modeset(&crtc_state->base))
 				intel_crtc->atomic.post_enable_primary = true;
 		}
 
-- 
1.7.5.4

