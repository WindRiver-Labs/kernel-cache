From 3d46cea56d001cb01f39aec2c710ef15278f7751 Mon Sep 17 00:00:00 2001
From: "Ooi, Joyce" <joyce.ooi@intel.com>
Date: Fri, 2 Dec 2016 10:57:50 +0800
Subject: [PATCH 4559/4706] Revert "hid: intel-ish-hid: ipc: consolidate ish
 wake up operation"

commit 57493ca28c33b6a8effc752ad91b9710e9d1b0de from
git://git.yoctoproject.org/linux-yocto-4.1

This reverts commit 259eec782030 ("hid: intel-ish-hid: ipc: consolidate ish
wake up operation").
Patches related to ISH drivers are reverted to pick up upstream ISH
drivers.

Signed-off-by: Ooi, Joyce <joyce.ooi@intel.com>
---
 drivers/hid/intel-ish-hid/ipc/ipc.c |   45 ++++++++++++++--------------------
 1 files changed, 19 insertions(+), 26 deletions(-)

diff --git a/drivers/hid/intel-ish-hid/ipc/ipc.c b/drivers/hid/intel-ish-hid/ipc/ipc.c
index 2b5d32d..9b174d4 100644
--- a/drivers/hid/intel-ish-hid/ipc/ipc.c
+++ b/drivers/hid/intel-ish-hid/ipc/ipc.c
@@ -521,28 +521,6 @@ eoi:
 	return	IRQ_HANDLED;
 }
 
-/**
- * ish_wakeup() - wakeup ishfw from waiting-for-host state
- * @dev: ishtp device pointer
- *
- * Set the dma enable bit and send a void message to FW,
- * it wil wakeup FW from waiting-for-host state
- */
-static void ish_wakeup(struct ishtp_device *dev)
-{
-	/* Set dma enable bit */
-	ish_reg_write(dev, IPC_REG_ISH_RMP2, IPC_RMP2_DMA_ENABLED);
-
-	/*
-	 * Send 0 IPC message so that ISH FW wakes up if it was already
-	 * asleep
-	 */
-
-	ish_reg_write(dev, IPC_REG_HOST2ISH_DRBL, IPC_DRBL_BUSY_BIT);
-	/* Flush writes to doorbell and REMAP2 */
-	ish_reg_read(dev, IPC_REG_ISH_HOST_FWSTS);
-}
-
 static int _ish_hw_reset(struct ishtp_device *dev)
 {
 	struct pci_dev *pdev = dev->pdev;
@@ -588,8 +566,16 @@ static int _ish_hw_reset(struct ishtp_device *dev)
 	csr |= PCI_D0;
 	pci_write_config_word(pdev, pdev->pm_cap + PCI_PM_CTRL, csr);
 
-	/* Now we can enable ISH DMA operation and wakeup ISHFW */
-	ish_wakeup(dev);
+	ish_reg_write(dev, IPC_REG_ISH_RMP2, IPC_RMP2_DMA_ENABLED);
+
+	/*
+	 * Send 0 IPC message so that ISH FW wakes up if it was already
+	 * asleep
+	 */
+	ish_reg_write(dev, IPC_REG_HOST2ISH_DRBL, IPC_DRBL_BUSY_BIT);
+
+	/* Flush writes to doorbell and REMAP2 */
+	ish_reg_read(dev, IPC_REG_ISH_HOST_FWSTS);
 
 	return	0;
 }
@@ -633,9 +619,16 @@ static int _ish_ipc_reset(struct ishtp_device *dev)
 int ish_hw_start(struct ishtp_device *dev)
 {
 	ish_set_host_rdy(dev);
+	/* After that we can enable ISH DMA operation */
+	ish_reg_write(dev, IPC_REG_ISH_RMP2, IPC_RMP2_DMA_ENABLED);
 
-	/* After that we can enable ISH DMA operation and wakeup ISHFW */
-	ish_wakeup(dev);
+	/*
+	 * Send 0 IPC message so that ISH FW wakes up if it was already
+	 * asleep
+	 */
+	ish_reg_write(dev, IPC_REG_HOST2ISH_DRBL, IPC_DRBL_BUSY_BIT);
+	/* Flush write to doorbell */
+	ish_reg_read(dev, IPC_REG_ISH_HOST_FWSTS);
 
 	set_host_ready(dev);
 
-- 
1.7.5.4

