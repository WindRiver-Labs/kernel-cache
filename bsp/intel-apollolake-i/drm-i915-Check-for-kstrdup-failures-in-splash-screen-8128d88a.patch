From 4b846463f21983f27abd1d9f5c8fe6ac7c0faf02 Mon Sep 17 00:00:00 2001
From: Matt Roper <matthew.d.roper@intel.com>
Date: Mon, 16 May 2016 16:37:06 -0700
Subject: [PATCH 4429/4706] drm/i915: Check for kstrdup() failures in splash
 screen code

commit 9c3a08c7ba301564cec4f737a736f6f6470103a2 from
git://git.yoctoproject.org/linux-yocto-4.1

KW: 1114942
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
Reviewed-by: Bob Paauwe <bob.j.paauwe@intel.com>
---
 drivers/gpu/drm/i915/intel_initial_modeset.c |   12 +++++++++---
 1 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_initial_modeset.c b/drivers/gpu/drm/i915/intel_initial_modeset.c
index 21886fa..9816412 100644
--- a/drivers/gpu/drm/i915/intel_initial_modeset.c
+++ b/drivers/gpu/drm/i915/intel_initial_modeset.c
@@ -184,9 +184,9 @@ static struct splash_screen_info *match_splash_info(
 static void intel_splash_screen_init(struct drm_device *dev)
 {
 	struct drm_i915_private *dev_priv = to_i915(dev);
-	struct splash_screen_info *splash_info;
-	char *splash_dup;
-	char *splash_str;
+	struct splash_screen_info *splash_info = NULL;
+	char *splash_dup = NULL;
+	char *splash_str = NULL;
 	char *sep;
 	u32 fw_npages;
 
@@ -196,6 +196,8 @@ static void intel_splash_screen_init(struct drm_device *dev)
 		return;
 
 	splash_dup = kstrdup(splash, GFP_KERNEL);
+	if (!splash_dup)
+		goto fail;
 	splash_str = splash_dup;
 
 	/*
@@ -215,6 +217,8 @@ static void intel_splash_screen_init(struct drm_device *dev)
 
 		*sep = '\0';
 		splash_info->connector_name = kstrdup(splash_str, GFP_KERNEL);
+		if (!splash_info->connector_name)
+			goto fail;
 		splash_str = sep + 1;
 
 		/*
@@ -231,6 +235,8 @@ static void intel_splash_screen_init(struct drm_device *dev)
 		if (!shared_image(dev_priv, splash_str, splash_info)) {
 			splash_info->image_name = kstrdup(splash_str,
 							  GFP_KERNEL);
+			if (!splash_info->image_name)
+				goto fail;
 			request_firmware(&splash_info->fw, splash_str,
 					 &dev_priv->drm.pdev->dev);
 			if (splash_info->fw == NULL)
-- 
1.7.5.4

