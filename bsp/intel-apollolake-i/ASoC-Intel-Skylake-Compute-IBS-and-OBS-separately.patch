From 0ebd35804d65662fce3d2d8ec4084e5a95f67244 Mon Sep 17 00:00:00 2001
From: Mousumi Jana <mousumix.jana@intel.com>
Date: Wed, 10 Feb 2016 02:25:44 +0530
Subject: [PATCH 1881/2508] ASoC: Intel: Skylake: Compute IBS and OBS
 separately

commit 50570b8c65b51002530e1e03876cae8236ad2e66 from
https://github.com/01org/linux-apollolake-i

IBS and OBS of all algorithms need not be the same. Algorithms
like SRC when operating in DP need larger output buffers
especially for fractional rates. Hence there is a need
to compute them seperately from two different params
from the XML.
For example, SRC operating in DP for 11025Hz needs
2ms of buffer at input and 3ms of buffer at output when conveted
to 48Khz.

Change-Id: Ia38bce52fe7ea72e4d36dec61775fb0cb4e6af10
Signed-off-by: Mousumi Jana <mousumix.jana@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/8129
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
---
 sound/soc/intel/skylake/skl-topology.c       |    8 +++++---
 sound/soc/intel/skylake/skl-topology.h       |    3 ++-
 sound/soc/intel/skylake/skl-tplg-interface.h |    5 ++++-
 3 files changed, 11 insertions(+), 5 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-topology.c b/sound/soc/intel/skylake/skl-topology.c
index 8b87c3f..9e13a9f 100644
--- a/sound/soc/intel/skylake/skl-topology.c
+++ b/sound/soc/intel/skylake/skl-topology.c
@@ -266,12 +266,12 @@ static void skl_tplg_update_buffer_size(struct skl_sst *ctx,
 	mcfg->ibs = ((in_fmt->s_freq + 999) / 1000) *
 				(mcfg->in_fmt->channels) *
 				(mcfg->in_fmt->bit_depth >> 3) *
-				mcfg->frame_size;
+				mcfg->in_frame_size;
 
 	mcfg->obs = ((mcfg->out_fmt->s_freq + 999) / 1000) *
 				(mcfg->out_fmt->channels) *
 				(mcfg->out_fmt->bit_depth >> 3) *
-				mcfg->frame_size;
+				mcfg->out_frame_size;
 }
 
 static void skl_tplg_update_module_params(struct snd_soc_dapm_widget *w,
@@ -1359,6 +1359,7 @@ static int skl_tplg_widget_load(struct snd_soc_component *cmpnt,
 	mconfig->max_out_queue = dfw_config->max_out_queue;
 	mconfig->is_loadable = dfw_config->is_loadable;
 	mconfig->domain = dfw_config->proc_domain;
+
 	skl_tplg_fill_fmt(mconfig->in_fmt, dfw_config->in_fmt,
 						MODULE_MAX_IN_PINS);
 	skl_tplg_fill_fmt(mconfig->out_fmt, dfw_config->out_fmt,
@@ -1370,7 +1371,8 @@ static int skl_tplg_widget_load(struct snd_soc_component *cmpnt,
 	mconfig->vbus_id = dfw_config->vbus_id;
 	mconfig->mem_pages = dfw_config->mem_pages;
 	mconfig->fast_mode = dfw_config->fast_mode;
-	mconfig->frame_size = dfw_config->frame_size;
+	mconfig->in_frame_size = dfw_config->in_frame_size;
+	mconfig->out_frame_size = dfw_config->out_frame_size;
 
 	pipe = skl_tplg_add_pipe(bus->dev, skl, &dfw_config->pipe);
 	if (pipe)
diff --git a/sound/soc/intel/skylake/skl-topology.h b/sound/soc/intel/skylake/skl-topology.h
index ed35649..5b41b48 100644
--- a/sound/soc/intel/skylake/skl-topology.h
+++ b/sound/soc/intel/skylake/skl-topology.h
@@ -286,8 +286,9 @@ struct skl_module_cfg {
 	u32 vbus_id;
 	u32 mem_pages;
 	u32 fast_mode;
-	u32 frame_size;
 	u32 dma_buf_dur_ms;
+	u32 in_frame_size;
+	u32 out_frame_size;
 	struct skl_module_pin *m_in_pin;
 	struct skl_module_pin *m_out_pin;
 	enum skl_module_type m_type;
diff --git a/sound/soc/intel/skylake/skl-tplg-interface.h b/sound/soc/intel/skylake/skl-tplg-interface.h
index f126217..f511182 100644
--- a/sound/soc/intel/skylake/skl-tplg-interface.h
+++ b/sound/soc/intel/skylake/skl-tplg-interface.h
@@ -205,7 +205,7 @@ struct skl_dfw_module {
 
 	u32 params_fixup:8;
 	u32 converter:8;
-	u32 frame_size:8;
+	u32 in_frame_size:8;
 	u32 input_pin_type:1;
 	u32 output_pin_type:1;
 	u32 is_dynamic_in_pin:1;
@@ -215,6 +215,9 @@ struct skl_dfw_module {
 	u32 proc_domain:1;
 	u32 rsvd3:1;
 
+	u32 out_frame_size:8;
+	u32 rsvd4:24;
+
 	struct skl_dfw_pipe pipe;
 	struct skl_dfw_module_fmt in_fmt[MAX_IN_QUEUE];
 	struct skl_dfw_module_fmt out_fmt[MAX_OUT_QUEUE];
-- 
1.7.5.4

