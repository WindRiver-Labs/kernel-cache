From 372440d4a6cb0a49a976c8e1b260ad0d2f95fd9c Mon Sep 17 00:00:00 2001
From: Pardha Saradhi K <pardha.saradhi.kesapragada@intel.com>
Date: Fri, 8 Jul 2016 17:36:45 +0530
Subject: [PATCH 2132/2508] ASoC: Intel: Skylake: Add support to notify
 resource event

commit 165713fd7e2d855156969d4ffc3f099333a99ebc from
https://github.com/01org/linux-apollolake-i

ADSP notifies to driver in case of any resource events that
occur while executing a usecase. These are notification
IPCs that belong to a class called RESOURCE_EVENT.
This patch displays such notifications to the console
via debug messages.

Change-Id: I8c553a33f8961904bcf2024f023ee8c8694e8012
Signed-off-by: Pardha Saradhi K <pardha.saradhi.kesapragada@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/10160
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Jayanti, Satya Charitardha <satya.charitardha.jayanti@intel.com>
---
 sound/soc/intel/skylake/skl-sst-ipc.c |   71 ++++++++++++++++++++++++++++++++-
 1 files changed, 69 insertions(+), 2 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-sst-ipc.c b/sound/soc/intel/skylake/skl-sst-ipc.c
index a8dc4ea..6f76c83 100644
--- a/sound/soc/intel/skylake/skl-sst-ipc.c
+++ b/sound/soc/intel/skylake/skl-sst-ipc.c
@@ -194,6 +194,7 @@
 
 #define SET_LARGE_CFG_FW_CONFIG		7
 #define SKL_FW_CONFIG_DMA_CFG_SET       4
+#define SKL_FW_RSRCE_EVNT_DATA_SZ		6
 
 enum skl_ipc_msg_target {
 	IPC_FW_GEN_MSG = 0,
@@ -273,6 +274,16 @@ enum skl_ipc_notification_type {
 	IPC_GLB_NOTIFY_EXCEPTION_CAUGHT = 10
 };
 
+enum skl_ipc_resource_event_type {
+	SKL_BUDGET_VIOLATION = 0,
+	SKL_MIXER_UNDERRUN = 1,
+	SKL_STREAM_DATA_SEGMENT = 2,
+	SKL_PROCESS_DATA_ERR = 3,
+	SKL_BUFFERING_MODE_CHANGED = 5,
+	SKL_GATEWAY_UNDERRUN = 6,
+	SKL_GATEWAY_OVERRUN = 7
+};
+
 /* Module Message Types */
 enum skl_ipc_module_msg {
 	IPC_MOD_INIT_INSTANCE = 0,
@@ -287,6 +298,13 @@ enum skl_ipc_module_msg {
 	IPC_MOD_DELETE_INSTANCE = 11
 };
 
+struct skl_event_notif {
+	u32 resource_type;
+	u32 resource_id;
+	u32 event_type;
+	u32 event_data[SKL_FW_RSRCE_EVNT_DATA_SZ];
+} __packed;
+
 static void fw_exception_dump_read(struct sst_dsp *dsp)
 {
 	struct skl_dsp_core_dump *coredump;
@@ -448,6 +466,56 @@ skl_process_log_buffer(struct sst_dsp *sst, struct skl_ipc_header header)
 	skl_dsp_put_log_buff(sst, core);
 }
 
+static void
+skl_parse_resource_event(struct sst_dsp *sst, struct skl_ipc_header header)
+{
+	struct skl_event_notif notif;
+
+	/* read the message contents from mailbox */
+	sst_dsp_inbox_read(sst, &notif, sizeof(struct skl_event_notif));
+
+	/* notify user about the event type */
+	switch (notif.event_type) {
+
+	case SKL_BUDGET_VIOLATION:
+		dev_err(sst->dev, "MCPS Budget Violation: %x\n",
+					header.primary);
+		break;
+	case SKL_MIXER_UNDERRUN:
+		dev_err(sst->dev, "Mixer Underrun Detected: %x\n",
+					header.primary);
+		break;
+	case SKL_STREAM_DATA_SEGMENT:
+		dev_err(sst->dev, "Stream Data Segment: %x\n",
+					header.primary);
+		break;
+	case SKL_PROCESS_DATA_ERR:
+		dev_err(sst->dev, "Process Data Error: %x\n",
+					header.primary);
+		break;
+	case SKL_BUFFERING_MODE_CHANGED:
+		dev_err(sst->dev, "Buffering Mode Changed: %x\n",
+					header.primary);
+		break;
+	case SKL_GATEWAY_UNDERRUN:
+		dev_err(sst->dev, "Gateway Underrun Detected: %x\n",
+					header.primary);
+		break;
+	case SKL_GATEWAY_OVERRUN:
+		dev_err(sst->dev, "Gateway Overrun Detected: %x\n",
+					header.primary);
+		break;
+	default:
+		dev_err(sst->dev, "ipc: Unhandled resource event=%x",
+					header.primary);
+		break;
+	}
+
+	print_hex_dump(KERN_DEBUG, "Params:", DUMP_PREFIX_OFFSET, 8, 4,
+			&notif, sizeof(struct skl_event_notif), false);
+
+}
+
 int skl_ipc_process_notification(struct sst_generic_ipc *ipc,
 		struct skl_ipc_header header)
 {
@@ -463,8 +531,7 @@ int skl_ipc_process_notification(struct sst_generic_ipc *ipc,
 			break;
 
 		case IPC_GLB_NOTIFY_RESOURCE_EVENT:
-			dev_err(ipc->dev, "MCPS Budget Violation: %x\n",
-						header.primary);
+			skl_parse_resource_event(skl->dsp, header);
 			break;
 
 		case IPC_GLB_NOTIFY_FW_READY:
-- 
1.7.5.4

