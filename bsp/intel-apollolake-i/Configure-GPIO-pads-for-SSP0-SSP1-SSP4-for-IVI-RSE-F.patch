From 3f027e8972b99e3285fa294c488da3438e5e9898 Mon Sep 17 00:00:00 2001
From: Pardha Saradhi K <pardha.saradhi.kesapragada@intel.com>
Date: Tue, 24 Nov 2015 18:22:20 +0530
Subject: [PATCH 1822/2508] Configure GPIO pads for SSP0, SSP1, SSP4 for IVI
 RSE Fix

commit 004b4cda5030724c3713d64ff38f609d56beeb70 from
https://github.com/01org/linux-apollolake-i

Change-Id: I68ec67454f09189f5292fbfd6e9a9674b4d191a6
Signed-off-by: Pardha Saradhi K <pardha.saradhi.kesapragada@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/7585
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
---
 sound/soc/intel/boards/bxtp_ivi_rse_rt298.c |   81 ++++++++++++++++++++++++++-
 1 files changed, 78 insertions(+), 3 deletions(-)

diff --git a/sound/soc/intel/boards/bxtp_ivi_rse_rt298.c b/sound/soc/intel/boards/bxtp_ivi_rse_rt298.c
index f03bc32..ff09128 100644
--- a/sound/soc/intel/boards/bxtp_ivi_rse_rt298.c
+++ b/sound/soc/intel/boards/bxtp_ivi_rse_rt298.c
@@ -52,6 +52,81 @@ static const struct snd_soc_dapm_route broxton_rt298_map[] = {
 	{ "ssp0 Rx", NULL, "Dummy Capture1" },
 };
 
+static int bxtp_ssp0_gpio_init(struct snd_soc_pcm_runtime *rtd)
+{
+	int ret = 0;
+	char *gpio_addr;
+	u32 gpio_value1 = 0x40900500;
+	u32 gpio_value2 = 0x44000600;
+
+	gpio_addr = (void *)ioremap_nocache(0xd0c40610, 0x30);
+
+	memcpy_toio(gpio_addr + 0x8, &gpio_value1, sizeof(gpio_value1));
+	memcpy_toio(gpio_addr + 0x10, &gpio_value2, sizeof(gpio_value2));
+	memcpy_toio(gpio_addr + 0x18, &gpio_value2, sizeof(gpio_value2));
+	memcpy_toio(gpio_addr + 0x20, &gpio_value2, sizeof(gpio_value2));
+
+        printk("SSP0: %p has %#x\n", gpio_addr + 0x8, *(u32 *)(gpio_addr + 0x8));
+        printk("SSP0: %p has %#x\n", gpio_addr + 0x10, *(u32 *)(gpio_addr + 0x10));
+        printk("SSP0: %p has %#x\n", gpio_addr + 0x18, *(u32 *)(gpio_addr + 0x18));
+        printk("SSP0: %p has %#x\n", gpio_addr + 0x20, *(u32 *)(gpio_addr + 0x20));
+
+        iounmap(gpio_addr);
+        return 0;
+
+}
+
+static int bxtp_ssp1_gpio_init(struct snd_soc_pcm_runtime *rtd)
+{
+        int ret = 0;
+        char *gpio_addr;
+        u32 gpio_value1 = 0x44000400;
+
+        gpio_addr = (void *)ioremap_nocache(0xd0c40660, 0x30);
+
+        printk("%p has %#x\n", gpio_addr, *(u32 *)gpio_addr);
+
+        memcpy_toio(gpio_addr + 0x8, &gpio_value1, sizeof(gpio_value1));
+        memcpy_toio(gpio_addr + 0x10, &gpio_value1, sizeof(gpio_value1));
+        memcpy_toio(gpio_addr + 0x18, &gpio_value1, sizeof(gpio_value1));
+        memcpy_toio(gpio_addr + 0x20, &gpio_value1, sizeof(gpio_value1));
+
+        printk("SSP1: %p has %#x\n", gpio_addr + 0x8, *(u32 *)(gpio_addr + 0x8));
+        printk("SSP1: %p has %#x\n", gpio_addr + 0x10, *(u32 *)(gpio_addr + 0x10));
+        printk("SSP1: %p has %#x\n", gpio_addr + 0x18, *(u32 *)(gpio_addr + 0x18));
+        printk("SSP1: %p has %#x\n", gpio_addr + 0x20, *(u32 *)(gpio_addr + 0x20));
+
+        iounmap(gpio_addr);
+        return 0;
+
+}
+
+static int bxtp_ssp4_gpio_init(struct snd_soc_pcm_runtime *rtd)
+{
+        int ret = 0;
+        char *gpio_addr;
+        u32 gpio_value1 = 0x44000A00;
+        u32 gpio_value2 = 0x44000800;
+
+        gpio_addr = (void *)ioremap_nocache(0xd0c705A0, 0x30);
+
+        printk("%p has %#x\n", gpio_addr, *(u32 *)gpio_addr);
+
+        memcpy_toio(gpio_addr, &gpio_value1, sizeof(gpio_value1));
+        memcpy_toio(gpio_addr + 0x8, &gpio_value1, sizeof(gpio_value1));
+        memcpy_toio(gpio_addr + 0x10, &gpio_value1, sizeof(gpio_value1));
+        memcpy_toio(gpio_addr + 0x18, &gpio_value2, sizeof(gpio_value2));
+
+        printk("SSP4: %p has %#x\n", gpio_addr, *(u32 *)(gpio_addr));
+        printk("SSP4: %p has %#x\n", gpio_addr + 0x8, *(u32 *)(gpio_addr + 0x8));
+        printk("SSP4: %p has %#x\n", gpio_addr + 0x10, *(u32 *)(gpio_addr + 0x10));
+        printk("SSP4: %p has %#x\n", gpio_addr + 0x18, *(u32 *)(gpio_addr + 0x18));
+
+        iounmap(gpio_addr);
+        return 0;
+
+}
+
 static int broxton_ssp0_fixup(struct snd_soc_pcm_runtime *rtd,
 			struct snd_pcm_hw_params *params)
 {
@@ -195,7 +270,7 @@ static struct snd_soc_dai_link broxton_rt298_dais[] = {
 		.no_pcm = 1,
 		.codec_name = "snd-soc-dummy",
 		.codec_dai_name = "snd-soc-dummy-dai1",
-		.init = NULL,
+		.init = bxtp_ssp0_gpio_init,
 		.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |
 			SND_SOC_DAIFMT_CBS_CFS,
 		.ignore_suspend = 1,
@@ -212,7 +287,7 @@ static struct snd_soc_dai_link broxton_rt298_dais[] = {
 		.no_pcm = 1,
 		.codec_name = "snd-soc-dummy",
 		.codec_dai_name = "snd-soc-dummy-dai",
-		.init = NULL,
+		.init =  bxtp_ssp1_gpio_init,
 		.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |
 			SND_SOC_DAIFMT_CBS_CFS,
 		.ignore_suspend = 1,
@@ -246,7 +321,7 @@ static struct snd_soc_dai_link broxton_rt298_dais[] = {
 		.no_pcm = 1,
 		.codec_name = "snd-soc-dummy",
 		.codec_dai_name = "snd-soc-dummy-dai2",
-		.init = NULL,
+		.init =  bxtp_ssp4_gpio_init,
 		.dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |
 			SND_SOC_DAIFMT_CBS_CFS,
 		.ignore_suspend = 1,
-- 
1.7.5.4

