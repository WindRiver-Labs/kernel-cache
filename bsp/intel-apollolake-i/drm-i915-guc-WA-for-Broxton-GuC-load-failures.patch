From 2e4eae319b2a041dda4bd6e7d9f43e6e7ea65ce6 Mon Sep 17 00:00:00 2001
From: Jeff McGee <jeff.mcgee@intel.com>
Date: Tue, 10 May 2016 11:40:45 -0700
Subject: [PATCH 1261/2508] drm/i915/guc: WA for Broxton GuC load failures

commit 320e986d96d69ee0bcf1f5bc3f5d651409b6ef8a from
https://github.com/01org/linux-apollolake-i

There seems to be an issue on Broxton where booting of firmware fails
if RC6 has been enabled by BIOS, but an RC6 state transition has never
occurred. We workaround the issue by going into RC6 for a time if
necessary and back out.

Signed-off-by: Jeff McGee <jeff.mcgee@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/intel_guc_loader.c |   21 +++++++++++++++++++++
 1 files changed, 21 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_guc_loader.c b/drivers/gpu/drm/i915/intel_guc_loader.c
index 790ba39..394b003 100644
--- a/drivers/gpu/drm/i915/intel_guc_loader.c
+++ b/drivers/gpu/drm/i915/intel_guc_loader.c
@@ -590,6 +590,7 @@ void intel_guc_ucode_init(struct drm_device *dev)
 	struct intel_guc_fw *guc_fw = &dev_priv->guc.guc_fw;
 	const char *fw_path;
 	unsigned long long start = sched_clock();
+	bool is_forced_rc6 = false;
 
 	if (!HAS_GUC_SCHED(dev))
 		i915.enable_guc_submission = false;
@@ -624,9 +625,29 @@ void intel_guc_ucode_init(struct drm_device *dev)
 
 	guc_fw->guc_fw_fetch_status = GUC_FIRMWARE_PENDING;
 	DRM_DEBUG_DRIVER("GuC firmware pending, path %s\n", fw_path);
+
+	/*
+	 * We are about to fetch GuC firmware, and if successful, will later
+	 * load for booting. There seems to be an issue on Broxton where
+	 * booting of firmware fails if RC6 has been enabled by BIOS, but an
+	 * RC6 state transition has never occurred. We workaround the issue by
+	 * going into RC6 for a time if necessary and back out. We do it now
+	 * because the load/boot stage occurs under forcewake.
+	 */
+	if (IS_BROXTON(dev) && !(I915_READ(GEN6_RC_STATE) & RC6_STATE)) {
+		DRM_DEBUG_DRIVER("Begin Broxton GuC load WA: enter RC6\n");
+		I915_WRITE(GEN6_RC_STATE, I915_READ(GEN6_RC_STATE) | RC6_STATE);
+		is_forced_rc6 = true;
+	}
+
 	guc_fw_fetch(dev, guc_fw);
 	dev_priv->profile.guc_init = sched_clock() - start;
 	/* status must now be FAIL or SUCCESS */
+
+	if (is_forced_rc6) {
+		DRM_DEBUG_DRIVER("End Broxton GuC load WA: exit RC6\n");
+		I915_WRITE(GEN6_RC_STATE, I915_READ(GEN6_RC_STATE) & ~RC6_STATE);
+	}
 }
 
 /**
-- 
1.7.5.4

