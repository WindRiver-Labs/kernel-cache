From 88fc526eb362fbd8601c7e89b98cddb338068dcc Mon Sep 17 00:00:00 2001
From: Jarkko Sakkinen <jarkko.sakkinen@linux.intel.com>
Date: Wed, 23 Mar 2016 07:10:22 +0200
Subject: [PATCH 2302/2508] tpm: drop tpm_atmel specific fields from
 tpm_vendor_specific

commit 23d06ff700f546a6a1d63c85ade095dbd75b7ab5 upstream

Introduced a private struct tpm_atmel_priv that contains the variables
have_region and region_size that were previously located in struct
tpm_vendor_specific. These fields were only used by tpm_atmel.

Signed-off-by: Jarkko Sakkinen <jarkko.sakkinen@linux.intel.com>
Reviewed-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
---
 drivers/char/tpm/tpm.h       |    3 ---
 drivers/char/tpm/tpm_atmel.c |   18 ++++++++++++++----
 drivers/char/tpm/tpm_atmel.h |    5 +++++
 3 files changed, 19 insertions(+), 7 deletions(-)

diff --git a/drivers/char/tpm/tpm.h b/drivers/char/tpm/tpm.h
index bab70c0..8684e76 100644
--- a/drivers/char/tpm/tpm.h
+++ b/drivers/char/tpm/tpm.h
@@ -143,9 +143,6 @@ struct tpm_vendor_specific {
 
 	int irq;
 
-	int region_size;
-	int have_region;
-
 	struct list_head list;
 	int locality;
 	unsigned long timeout_a, timeout_b, timeout_c, timeout_d; /* jiffies */
diff --git a/drivers/char/tpm/tpm_atmel.c b/drivers/char/tpm/tpm_atmel.c
index a48a878..0267d85 100644
--- a/drivers/char/tpm/tpm_atmel.c
+++ b/drivers/char/tpm/tpm_atmel.c
@@ -136,12 +136,13 @@ static struct platform_device *pdev;
 static void atml_plat_remove(void)
 {
 	struct tpm_chip *chip = dev_get_drvdata(&pdev->dev);
+	struct tpm_atmel_priv *priv = chip->vendor.priv;
 
 	if (chip) {
 		tpm_chip_unregister(chip);
-		if (chip->vendor.have_region)
+		if (priv->have_region)
 			atmel_release_region(chip->vendor.base,
-					     chip->vendor.region_size);
+					     priv->region_size);
 		atmel_put_base_addr(chip->vendor.iobase);
 		platform_device_unregister(pdev);
 	}
@@ -163,6 +164,7 @@ static int __init init_atmel(void)
 	int have_region, region_size;
 	unsigned long base;
 	struct  tpm_chip *chip;
+	struct tpm_atmel_priv *priv;
 
 	rc = platform_driver_register(&atml_drv);
 	if (rc)
@@ -183,6 +185,15 @@ static int __init init_atmel(void)
 		goto err_rel_reg;
 	}
 
+	priv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);
+	if (!priv) {
+		rc = -ENOMEM;
+		goto err_unreg_dev;
+	}
+
+	priv->have_region = have_region;
+	priv->region_size = region_size;
+
 	chip = tpmm_chip_alloc(&pdev->dev, &tpm_atmel);
 	if (IS_ERR(chip)) {
 		rc = PTR_ERR(chip);
@@ -191,8 +202,7 @@ static int __init init_atmel(void)
 
 	chip->vendor.iobase = iobase;
 	chip->vendor.base = base;
-	chip->vendor.have_region = have_region;
-	chip->vendor.region_size = region_size;
+	chip->vendor.priv = priv;
 
 	rc = tpm_chip_register(chip);
 	if (rc)
diff --git a/drivers/char/tpm/tpm_atmel.h b/drivers/char/tpm/tpm_atmel.h
index 6c831f9..3fd929d 100644
--- a/drivers/char/tpm/tpm_atmel.h
+++ b/drivers/char/tpm/tpm_atmel.h
@@ -22,6 +22,11 @@
  *
  */
 
+struct tpm_atmel_priv {
+	int region_size;
+	int have_region;
+};
+
 #ifdef CONFIG_PPC64
 
 #include <asm/prom.h>
-- 
1.7.5.4

