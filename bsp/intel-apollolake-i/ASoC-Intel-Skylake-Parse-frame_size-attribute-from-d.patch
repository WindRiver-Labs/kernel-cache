From 9c47e1ba441002bfbe217613973a197e125238e7 Mon Sep 17 00:00:00 2001
From: Senthilnathan Veppur <senthilnathanx.veppur@intel.com>
Date: Wed, 16 Dec 2015 19:24:36 +0530
Subject: [PATCH 1806/2508] ASoC: Intel: Skylake: Parse frame_size attribute
 from dfw

commit 524f78950e59c146df6c4d5a39914b29c6c95b14 from
https://github.com/01org/linux-apollolake-i

This will parse module's frame size from dfw and
accordingly calculate module's ibs and obs.

Change-Id: I1f4423012c706e1dfed3cf783a08d3c2a5922c47
Signed-off-by: Senthilnathan Veppur <senthilnathanx.veppur@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/7775
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
---
 sound/soc/intel/skylake/skl-topology.c       |   14 +++++---------
 sound/soc/intel/skylake/skl-topology.h       |    1 +
 sound/soc/intel/skylake/skl-tplg-interface.h |    3 ++-
 3 files changed, 8 insertions(+), 10 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-topology.c b/sound/soc/intel/skylake/skl-topology.c
index 12bdce1..66144b7 100644
--- a/sound/soc/intel/skylake/skl-topology.c
+++ b/sound/soc/intel/skylake/skl-topology.c
@@ -228,27 +228,22 @@ static void skl_tplg_update_params_fixup(struct skl_module_cfg *m_cfg,
 static void skl_tplg_update_buffer_size(struct skl_sst *ctx,
 				struct skl_module_cfg *mcfg)
 {
-	int multiplier = 1;
 	struct skl_module_fmt *in_fmt, *out_fmt;
 
-
 	/* Since fixups is applied to pin 0 only, ibs, obs needs
 	 * change for pin 0 only
 	 */
 	in_fmt = &mcfg->in_fmt[0];
 	out_fmt = &mcfg->out_fmt[0];
-
-	if (mcfg->m_type == SKL_MODULE_TYPE_SRCINT)
-		multiplier = 5;
-	mcfg->ibs = (in_fmt->s_freq / 1000) *
+	mcfg->ibs = ((in_fmt->s_freq + 999) / 1000) *
 				(mcfg->in_fmt->channels) *
 				(mcfg->in_fmt->bit_depth >> 3) *
-				multiplier;
+				mcfg->frame_size;
 
-	mcfg->obs = (mcfg->out_fmt->s_freq / 1000) *
+	mcfg->obs = ((mcfg->out_fmt->s_freq + 999) / 1000) *
 				(mcfg->out_fmt->channels) *
 				(mcfg->out_fmt->bit_depth >> 3) *
-				multiplier;
+				mcfg->frame_size;
 }
 
 static void skl_tplg_update_module_params(struct snd_soc_dapm_widget *w,
@@ -1359,6 +1354,7 @@ static int skl_tplg_widget_load(struct snd_soc_component *cmpnt,
 	mconfig->vbus_id = dfw_config->vbus_id;
 	mconfig->mem_pages = dfw_config->mem_pages;
 	mconfig->fast_mode = dfw_config->fast_mode;
+	mconfig->frame_size = dfw_config->frame_size;
 
 	pipe = skl_tplg_add_pipe(bus->dev, skl, &dfw_config->pipe);
 	if (pipe)
diff --git a/sound/soc/intel/skylake/skl-topology.h b/sound/soc/intel/skylake/skl-topology.h
index 67abdc0..9f56023 100644
--- a/sound/soc/intel/skylake/skl-topology.h
+++ b/sound/soc/intel/skylake/skl-topology.h
@@ -285,6 +285,7 @@ struct skl_module_cfg {
 	u32 vbus_id;
 	u32 mem_pages;
 	u32 fast_mode;
+	u32 frame_size;
 	struct skl_module_pin *m_in_pin;
 	struct skl_module_pin *m_out_pin;
 	enum skl_module_type m_type;
diff --git a/sound/soc/intel/skylake/skl-tplg-interface.h b/sound/soc/intel/skylake/skl-tplg-interface.h
index 2d02cf7..0c591b4 100644
--- a/sound/soc/intel/skylake/skl-tplg-interface.h
+++ b/sound/soc/intel/skylake/skl-tplg-interface.h
@@ -202,6 +202,7 @@ struct skl_dfw_module {
 
 	u32 params_fixup:8;
 	u32 converter:8;
+	u32 frame_size:8;
 	u32 input_pin_type:1;
 	u32 output_pin_type:1;
 	u32 is_dynamic_in_pin:1;
@@ -209,7 +210,7 @@ struct skl_dfw_module {
 	u32 is_loadable:1;
 	u32 fast_mode:1;
 	u32 proc_domain:1;
-	u32 rsvd3:9;
+	u32 rsvd3:1;
 
 	struct skl_dfw_pipe pipe;
 	struct skl_dfw_module_fmt in_fmt[MAX_IN_QUEUE];
-- 
1.7.5.4

