From 50a74fe2680d95c3dfe4b501ba1e9368298c6c71 Mon Sep 17 00:00:00 2001
From: Bob Paauwe <bob.j.paauwe@intel.com>
Date: Thu, 4 Feb 2016 10:17:47 -0800
Subject: [PATCH 1243/2508] drm/i915/bxt: Use BIOS set hotplug control sense
 configuration.

commit b552d8d306e624e34a67d98a23d7b906da7b85da from
https://github.com/01org/linux-apollolake-i

Broxton has some additional bits in the HOTPLUG_CTL register that
indicate whether the HPD sense lines need to be inverted or not for the
current platform.  The BIOS sets these bits to an appropriate value at
boot time, but the value is lost across suspend/resume.  We need to save
the value set by the BIOS and use that to restore the sense bits after
resume.

Signed-off-by: Bob Paauwe <bob.j.paauwe@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_drv.h      |    1 +
 drivers/gpu/drm/i915/i915_irq.c      |    6 ++++++
 drivers/gpu/drm/i915/i915_reg.h      |    3 +++
 drivers/gpu/drm/i915/intel_hotplug.c |    5 +++++
 4 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_drv.h b/drivers/gpu/drm/i915/i915_drv.h
index 0d5f975..cdfca0a 100644
--- a/drivers/gpu/drm/i915/i915_drv.h
+++ b/drivers/gpu/drm/i915/i915_drv.h
@@ -273,6 +273,7 @@ struct i915_hotplug {
 	struct intel_digital_port *irq_port[I915_MAX_PORTS];
 	u32 long_port_mask;
 	u32 short_port_mask;
+	u32 invert_bits;
 	struct work_struct dig_port_work;
 
 	/*
diff --git a/drivers/gpu/drm/i915/i915_irq.c b/drivers/gpu/drm/i915/i915_irq.c
index fd0559f..10091ec 100644
--- a/drivers/gpu/drm/i915/i915_irq.c
+++ b/drivers/gpu/drm/i915/i915_irq.c
@@ -3499,6 +3499,7 @@ static void bxt_hpd_irq_setup(struct drm_device *dev)
 	hotplug = I915_READ(PCH_PORT_HOTPLUG);
 	hotplug |= PORTC_HOTPLUG_ENABLE | PORTB_HOTPLUG_ENABLE |
 		PORTA_HOTPLUG_ENABLE;
+
 	if(i915.hpd_sense_invert == 1) {
 		hotplug |= PORTC_HOTPLUG_SENSE_INVERT |
 			PORTB_HOTPLUG_SENSE_INVERT |
@@ -3507,7 +3508,12 @@ static void bxt_hpd_irq_setup(struct drm_device *dev)
 		hotplug &= ~(PORTC_HOTPLUG_SENSE_INVERT |
 			PORTB_HOTPLUG_SENSE_INVERT |
 			PORTA_HOTPLUG_SENSE_INVERT);
+	} else {
+		/* use the value set by the BIOS */
+		hotplug &= ~BXT_DDI_HPD_INVERT_MASK;
+		hotplug |= dev_priv->hotplug.invert_bits;
 	}
+
 	I915_WRITE(PCH_PORT_HOTPLUG, hotplug);
 }
 
diff --git a/drivers/gpu/drm/i915/i915_reg.h b/drivers/gpu/drm/i915/i915_reg.h
index 2841fdd..cbf10a6 100644
--- a/drivers/gpu/drm/i915/i915_reg.h
+++ b/drivers/gpu/drm/i915/i915_reg.h
@@ -6232,6 +6232,9 @@ enum skl_disp_power_wells {
 #define  PORTB_HOTPLUG_NO_DETECT	(0 << 0)
 #define  PORTB_HOTPLUG_SHORT_DETECT	(1 << 0)
 #define  PORTB_HOTPLUG_LONG_DETECT	(2 << 0)
+#define  BXT_DDI_HPD_INVERT_MASK        (PORTA_HOTPLUG_SENSE_INVERT | \
+					 PORTC_HOTPLUG_SENSE_INVERT | \
+					 PORTB_HOTPLUG_SENSE_INVERT)
 
 #define PCH_PORT_HOTPLUG2		_MMIO(0xc403C)	/* SHOTPLUG_CTL2 SPT+ */
 #define  PORTE_HOTPLUG_ENABLE		(1 << 4)
diff --git a/drivers/gpu/drm/i915/intel_hotplug.c b/drivers/gpu/drm/i915/intel_hotplug.c
index bee6730..da29699 100644
--- a/drivers/gpu/drm/i915/intel_hotplug.c
+++ b/drivers/gpu/drm/i915/intel_hotplug.c
@@ -479,6 +479,11 @@ void intel_hpd_init(struct drm_i915_private *dev_priv)
 			connector->polled = DRM_CONNECTOR_POLL_HPD;
 	}
 
+	/* Save sense invert bits as set by the BIOS */
+	if (IS_BROXTON(dev))
+		dev_priv->hotplug.invert_bits =
+			I915_READ(PCH_PORT_HOTPLUG) & BXT_DDI_HPD_INVERT_MASK;
+
 	/*
 	 * Interrupt setup is already guaranteed to be single-threaded, this is
 	 * just to make the assert_spin_locked checks happy.
-- 
1.7.5.4

