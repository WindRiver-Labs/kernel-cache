From b2ea1f8dc469312661e10f576861aba9c1306fc8 Mon Sep 17 00:00:00 2001
From: Dongwon Kim <dongwon.kim@intel.com>
Date: Tue, 17 Jan 2017 17:44:09 -0800
Subject: [PATCH 4482/4706] drm: Check should be skipped for
 DRM_MODE_FB_AUX_PLANE

commit c8b8631d192d3dec591e69343ee9b37da72ac708 from
git://git.yoctoproject.org/linux-yocto-4.1

Need to do num_planes++ in case of DRM_MODE_FB_AUX_PLANE
to bypass extra checks on it.

(this commit message might have to be modified...)

Signed-off-by: Dongwon Kim <dongwon.kim@intel.com>
Acknowledged-by: Matt Roper <matthew.d.roper@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/drm_framebuffer.c |   19 ++++++++++---------
 1 files changed, 10 insertions(+), 9 deletions(-)

diff --git a/drivers/gpu/drm/drm_framebuffer.c b/drivers/gpu/drm/drm_framebuffer.c
index 75353d9..e0cc6ea 100644
--- a/drivers/gpu/drm/drm_framebuffer.c
+++ b/drivers/gpu/drm/drm_framebuffer.c
@@ -227,15 +227,6 @@ static int framebuffer_check(const struct drm_mode_fb_cmd2 *r)
 		return -EINVAL;
 	}
 
-	if (r->flags & DRM_MODE_FB_AUX_PLANE) {
-		num_planes++;
-
-		if (num_planes == 4) {
-			DRM_DEBUG_KMS("num_planes cannot exceed 3 including aux plane\n");
-			return -EINVAL;
-		}
-	}
-
 	for (i = 0; i < num_planes; i++) {
 		unsigned int width = r->width / (i != 0 ? hsub : 1);
 		unsigned int height = r->height / (i != 0 ? vsub : 1);
@@ -282,6 +273,16 @@ static int framebuffer_check(const struct drm_mode_fb_cmd2 *r)
 		}
 	}
 
+	if (r->flags & DRM_MODE_FB_AUX_PLANE) {
+		num_planes++;
+
+		if (num_planes == 4) {
+			DRM_DEBUG_KMS("num_planes cannot exceed 3 including aux plane\n");
+			return -EINVAL;
+		}
+	}
+
+
 	for (i = num_planes; i < 4; i++) {
 		if (r->modifier[i]) {
 			DRM_DEBUG_KMS("non-zero modifier for unused plane %d\n", i);
-- 
1.7.5.4

