From 9cb0c7542d0f556382a8c6e0e85d03a290434c62 Mon Sep 17 00:00:00 2001
From: "Pawse, GuruprasadX" <guruprasadx.pawse@intel.com>
Date: Thu, 4 Feb 2016 12:33:04 +0530
Subject: [PATCH 1875/2508] ASoC: Intel: Skylake: Fix TLV set and put methods

commit d0ec59f084d2f1b5d903d80127c75abf8ab09209 from
https://github.com/01org/linux-apollolake-i

This patch address below issues:
1. Incorrect pointer assignment during module init.
2. Copy valid number of bytes from userspace.

Driver assumes FW specific Type and Length are part of payload.
Hence the length should be taken care in DFW.

Change-Id: Iac506c83326dbae74c6b3661f3f8e76411cb2e6e
Tracked-On: https://jira01.devtools.intel.com/browse/OAM-20777
Signed-off-by: Pawse, GuruprasadX <guruprasadx.pawse@intel.com>
Reviewed-on: https://android.intel.com:443/459759
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/7983
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
---
 sound/soc/intel/skylake/skl-topology.c |   26 ++++++++------------------
 1 files changed, 8 insertions(+), 18 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-topology.c b/sound/soc/intel/skylake/skl-topology.c
index d9bd9f3..8b87c3f 100644
--- a/sound/soc/intel/skylake/skl-topology.c
+++ b/sound/soc/intel/skylake/skl-topology.c
@@ -409,7 +409,7 @@ static int skl_tplg_set_module_init_data(struct snd_soc_dapm_widget *w)
 			bc = (struct skl_algo_data *)sb->dobj.private;
 			if (bc->set_params != SKL_PARAM_INIT)
 				continue;
-			mconfig->formats_config.caps = (u32 *)&bc->params;
+			mconfig->formats_config.caps = (u32 *)bc->params;
 			mconfig->formats_config.caps_size = bc->max;
 			break;
 		}
@@ -947,8 +947,6 @@ static int skl_tplg_tlv_control_get(struct snd_kcontrol *kcontrol,
 	return 0;
 }
 
-#define SKL_PARAM_VENDOR_ID 0xff
-
 static int skl_tplg_tlv_control_set(struct snd_kcontrol *kcontrol,
 			const unsigned int __user *data, unsigned int size)
 {
@@ -962,22 +960,14 @@ static int skl_tplg_tlv_control_set(struct snd_kcontrol *kcontrol,
 
 	dev_dbg(dapm->dev, "in %s control=%s\n", __func__, kcontrol->id.name);
 	dev_dbg(dapm->dev, "size = %u, %#x\n", size, size);
+
 	if (ac->params) {
-		/*
-		 * if the param_is is of type Vendor, firmware expects actual
-		 * parameter id and size from the control.
-		 */
-		if (ac->param_id == SKL_PARAM_VENDOR_ID) {
-			if (copy_from_user(ac->params,
-					   ((unsigned char *)data),
-					   size))
-				return -EIO;
-		} else {
-			if (copy_from_user(ac->params,
-					   ((unsigned char *)data) + 2*sizeof(u32),
-					   size))
-				return -EIO;
-		}
+		memset(ac->params, 0, ac->max);
+                /* skip copying first two u32 words from user which is the TLV header */
+		if (copy_from_user(ac->params,
+				   ((unsigned char *)data) + 2*sizeof(u32),
+				   size - 2*sizeof(u32)))
+			return -EIO;
 
 		if (w->power)
 			return skl_set_module_params(skl->skl_sst, (void *)ac->params,
-- 
1.7.5.4

