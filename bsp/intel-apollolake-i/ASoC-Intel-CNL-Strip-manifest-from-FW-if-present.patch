From b7bd1713973cc8595649cbab3ae6f6f2b0aa6b81 Mon Sep 17 00:00:00 2001
From: Guneshwor Singh <guneshwor.o.singh@intel.com>
Date: Wed, 16 Mar 2016 18:49:46 +0530
Subject: [PATCH 1924/2508] ASoC: Intel: CNL: Strip manifest from FW if
 present

commit 0be926b9d189e94e708a6199fecde6ccb78d4aaf from
https://github.com/01org/linux-apollolake-i

Change-Id: I6dc1b27b759eb4e250ada0c1373b6da9f19e59d3
Signed-off-by: Guneshwor Singh <guneshwor.o.singh@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/8513
Reviewed-by: Shah, Hardik T <hardik.t.shah@intel.com>
Tested-by: Shah, Hardik T <hardik.t.shah@intel.com>
---
 sound/soc/intel/skylake/cnl-sst.c |   24 ++++++++++++++++++++----
 1 files changed, 20 insertions(+), 4 deletions(-)

diff --git a/sound/soc/intel/skylake/cnl-sst.c b/sound/soc/intel/skylake/cnl-sst.c
index 90cb2b4..076892f 100644
--- a/sound/soc/intel/skylake/cnl-sst.c
+++ b/sound/soc/intel/skylake/cnl-sst.c
@@ -252,16 +252,32 @@ static int sst_transfer_fw_host_dma(struct sst_dsp *ctx)
 static int cnl_load_base_firmware(struct sst_dsp *ctx)
 {
 	int ret = 0;
-	const struct firmware *fw = NULL;
 	struct skl_sst *cnl = ctx->thread_context;
+	struct skl_ext_manifest_header *hdr;
+	u32 size;
+	const void *data;
 
-	ret = request_firmware(&fw, "dsp_fw_release.bin", ctx->dev);
+	ret = request_firmware(&ctx->fw, "dsp_fw_release.bin", ctx->dev);
 	if (ret < 0) {
 		dev_err(ctx->dev, "Request firmware failed: 0x%x\n", ret);
 		goto cnl_load_base_firmware_failed;
 	}
 
-	ret = cnl_prepare_fw(ctx, fw->data, fw->size);
+	size = ctx->fw->size;
+	data = ctx->fw->data;
+	hdr = (struct skl_ext_manifest_header *)ctx->fw->data;
+	if (hdr->ext_manifest_id == SKL_EXT_MANIFEST_MAGIC_HEADER_ID)
+	{
+		dev_dbg(ctx->dev, "Found Extended manifest in FW Binary\n");
+		if (hdr->ext_manifest_len >= ctx->fw->size) {
+			ret = -EINVAL;
+			goto cnl_load_base_firmware_failed;
+		}
+		size = ctx->fw->size - hdr->ext_manifest_len;
+		data = (u8 *)ctx->fw->data + hdr->ext_manifest_len;
+	}
+
+	ret = cnl_prepare_fw(ctx, data, size);
 	if (ret < 0) {
 		dev_err(ctx->dev, "Prepare firmware failed: 0x%x\n", ret);
 		goto cnl_load_base_firmware_failed;
@@ -287,7 +303,7 @@ static int cnl_load_base_firmware(struct sst_dsp *ctx)
 	}
 
 cnl_load_base_firmware_failed:
-	release_firmware(fw);
+	release_firmware(ctx->fw);
 	return ret;
 }
 
-- 
1.7.5.4

