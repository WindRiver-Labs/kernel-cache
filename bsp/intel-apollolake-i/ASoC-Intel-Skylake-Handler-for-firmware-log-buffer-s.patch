From 632ae4c0973987da9a10c255d7c6a57725e743fd Mon Sep 17 00:00:00 2001
From: "Panwar, Ashish" <ashish.panwar@intel.com>
Date: Wed, 20 Jan 2016 19:19:21 +0530
Subject: [PATCH 1856/2508] ASoC: Intel: Skylake: Handler for firmware log
 buffer status notification

commit e3a268ff6159645be6a26994760d586e476fdf1f from
https://github.com/01org/linux-apollolake-i

We copy half of the firmware log buffer on this notification. We
figure which half of trace buffer to copy based on the write pointer.

Change-Id: I32d8f47b5eaed3d35b4d2a0761bf4878f0c14d97
Signed-off-by: Panwar, Ashish <ashish.panwar@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/8051
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
---
 sound/soc/intel/skylake/skl-sst-ipc.c |   36 +++++++++++++++++++++++++++++++-
 1 files changed, 34 insertions(+), 2 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-sst-ipc.c b/sound/soc/intel/skylake/skl-sst-ipc.c
index 66275d8..ce0ee0d 100644
--- a/sound/soc/intel/skylake/skl-sst-ipc.c
+++ b/sound/soc/intel/skylake/skl-sst-ipc.c
@@ -16,10 +16,9 @@
 #include <linux/delay.h>
 
 #include "../common/sst-dsp.h"
-#include "../common/sst-dsp-priv.h"
 #include "skl-sst-dsp.h"
 #include "skl-sst-ipc.h"
-
+#include "skl-fwlog.h"
 
 #define IPC_IXC_STATUS_BITS		24
 
@@ -47,6 +46,10 @@
 #define IPC_MSG_DIR(x)			(((x) & IPC_MSG_DIR_MASK) \
 					<< IPC_MSG_DIR_SHIFT)
 /* Global Notification Message */
+#define IPC_GLB_NOTIFY_CORE_SHIFT	15
+#define IPC_GLB_NOTIFY_CORE_MASK	0x1
+#define IPC_GLB_NOTIFY_CORE_ID(x)	(((x) >> IPC_GLB_NOTIFY_CORE_SHIFT) \
+					& IPC_GLB_NOTIFY_CORE_MASK)
 #define IPC_GLB_NOTIFY_TYPE_SHIFT	16
 #define IPC_GLB_NOTIFY_TYPE_MASK	0xFF
 #define IPC_GLB_NOTIFY_TYPE(x)		(((x) >> IPC_GLB_NOTIFY_TYPE_SHIFT) \
@@ -361,6 +364,31 @@ out:
 	return msg;
 }
 
+static void
+skl_process_log_buffer(struct sst_dsp *sst, struct skl_ipc_header header)
+{
+	int core, size;
+	u32 *ptr, avail;
+	u8 *base;
+
+	core = IPC_GLB_NOTIFY_CORE_ID(header.primary);
+	if (!(BIT(core) & sst->trace_wind.flags)) {
+		dev_err(sst->dev, "Logging is disabled on dsp %d\n", core);
+		return;
+	}
+	skl_dsp_get_log_buff(sst, core);
+	size = sst->trace_wind.size/sst->trace_wind.nr_dsp;
+	base = (u8 *)sst->trace_wind.addr;
+	/* move to the source dsp tracing window */
+	base += (core * size);
+	ptr = (u32 *)sst->trace_wind.dsp_wps[core];
+	avail = *ptr;
+	if (avail < size/2)
+		base += size/2;
+	skl_dsp_write_log(sst, (void __iomem *)base, core, size/2);
+	skl_dsp_put_log_buff(sst, core);
+}
+
 int skl_ipc_process_notification(struct sst_generic_ipc *ipc,
 		struct skl_ipc_header header)
 {
@@ -383,6 +411,10 @@ int skl_ipc_process_notification(struct sst_generic_ipc *ipc,
 			wake_up(&skl->boot_wait);
 			break;
 
+		case IPC_GLB_NOTIFY_LOG_BUFFER_STATUS:
+			skl_process_log_buffer(skl->dsp, header);
+			break;
+
 		case IPC_GLB_NOTIFY_PHRASE_DETECTED:
 			dev_err(ipc->dev, "*****Pharse Detected **********\n");
 			mdelay(1);
-- 
1.7.5.4

