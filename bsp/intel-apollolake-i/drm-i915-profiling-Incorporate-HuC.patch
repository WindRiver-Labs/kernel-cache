From 6684d3ef6ba8407556e037204d719ca059a467aa Mon Sep 17 00:00:00 2001
From: Jeff McGee <jeff.mcgee@intel.com>
Date: Thu, 18 Aug 2016 09:57:55 -0700
Subject: [PATCH 44/68] drm/i915/profiling: Incorporate HuC

commit 34771378eb282ba5d32c5f65455f5305d590ccb9 from
git://git.yoctoproject.org/linux-yocto-4.1

Signed-off-by: Jeff McGee <jeff.mcgee@intel.com>
Signed-off-by: Bob Paauwe <bob.j.paauwe@intel.com>
[Kevin: use div_u64() for the changes in i915_timing_info()]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/gpu/drm/i915/i915_debugfs.c     |    6 ++++--
 drivers/gpu/drm/i915/i915_drv.h         |    3 ++-
 drivers/gpu/drm/i915/intel_guc_loader.c |    2 +-
 drivers/gpu/drm/i915/intel_huc_loader.c |    2 ++
 4 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_debugfs.c b/drivers/gpu/drm/i915/i915_debugfs.c
index c565eeb..a416b4e 100644
--- a/drivers/gpu/drm/i915/i915_debugfs.c
+++ b/drivers/gpu/drm/i915/i915_debugfs.c
@@ -2678,10 +2678,12 @@ static int i915_timing_info(struct seq_file *m, void *data)
 		   div_u64(dev_priv->profile.gmbus_init, 1000000));
 	seq_printf(m, "        Modeset init time:                  %4lldms\n",
 		   div_u64(dev_priv->profile.modeset_init_2, 1000000));
+	seq_printf(m, "        HUC firmware init time:             %4lldms\n",
+		   div_u64(dev_priv->profile.huc_init, 1000000));
 	seq_printf(m, "        GUC firmware init time:             %4lldms\n",
 		   div_u64(dev_priv->profile.guc_init, 1000000));
-	seq_printf(m, "        GUC firmware load time:             %4lldms\n",
-		   div_u64(dev_priv->profile.guc_load, 1000000));
+	seq_printf(m, "        GUC/HUC firmware load time:         %4lldms\n",
+		   div_u64(dev_priv->profile.guc_huc_load, 1000000));
 	seq_printf(m, "        Global GTT init time:               %4lldms\n",
 		   div_u64(dev_priv->profile.gtt_init, 1000000));
 	seq_printf(m, "        Modeset GEM init time:              %4lldms\n",
diff --git a/drivers/gpu/drm/i915/i915_drv.h b/drivers/gpu/drm/i915/i915_drv.h
index f6a08f7..d56d608 100644
--- a/drivers/gpu/drm/i915/i915_drv.h
+++ b/drivers/gpu/drm/i915/i915_drv.h
@@ -1750,8 +1750,9 @@ struct intel_load_profiles {
 	unsigned long long modeset_gem_init;
 	unsigned long long driver_register;
 	unsigned long long fbdev_load;
+	unsigned long long huc_init;
 	unsigned long long guc_init;
-	unsigned long long guc_load;
+	unsigned long long guc_huc_load;
 	unsigned long long csr_load;
 	unsigned long long initial_mode_run;
 	unsigned long long initial_mode_get_config;
diff --git a/drivers/gpu/drm/i915/intel_guc_loader.c b/drivers/gpu/drm/i915/intel_guc_loader.c
index fb2cb85..61d187e 100644
--- a/drivers/gpu/drm/i915/intel_guc_loader.c
+++ b/drivers/gpu/drm/i915/intel_guc_loader.c
@@ -491,7 +491,7 @@ int intel_guc_ucode_load(struct drm_device *dev)
 		direct_interrupts_to_guc(dev_priv);
 	}
 
-	dev_priv->profile.guc_load = sched_clock() - start;
+	dev_priv->profile.guc_huc_load = sched_clock() - start;
 	return 0;
 
 fail:
diff --git a/drivers/gpu/drm/i915/intel_huc_loader.c b/drivers/gpu/drm/i915/intel_huc_loader.c
index 2bddf0b..cd6c457 100644
--- a/drivers/gpu/drm/i915/intel_huc_loader.c
+++ b/drivers/gpu/drm/i915/intel_huc_loader.c
@@ -150,6 +150,7 @@ void intel_huc_init(struct drm_device *dev)
 	struct intel_huc *huc = &dev_priv->huc;
 	struct intel_uc_fw *huc_fw = &huc->huc_fw;
 	const char *fw_path = NULL;
+	unsigned long long start = sched_clock();
 
 	huc_fw->uc_dev = dev;
 	huc_fw->uc_fw_path = NULL;
@@ -179,6 +180,7 @@ void intel_huc_init(struct drm_device *dev)
 	DRM_DEBUG_DRIVER("HuC firmware pending, path %s\n", fw_path);
 
 	intel_uc_fw_fetch(dev, huc_fw);
+	dev_priv->profile.huc_init = sched_clock() - start;
 }
 
 /**
-- 
1.7.5.4

