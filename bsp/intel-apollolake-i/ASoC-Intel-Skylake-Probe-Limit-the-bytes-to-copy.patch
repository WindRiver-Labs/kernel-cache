From 0fbb7bf956dfaa036a194efb156bf899911b1de0 Mon Sep 17 00:00:00 2001
From: Jayachandran B <jayachandran.b@intel.com>
Date: Tue, 14 Jun 2016 10:39:48 +0530
Subject: [PATCH 1976/2508] ASoC: Intel: Skylake: Probe-Limit the bytes to
 copy

commit 6ae1069db711ddf7caa31afc51dabb4b22d4fb71 from
https://github.com/01org/linux-apollolake-i

If userspace happens to issue a copy with count > ring buffer size,
limit the count to the allocated ring buffer size to avoid out of
bound access into the buffer.

Change-Id: I7acbfb64bda299237a9d56bbac4a022d36b28bfd
Signed-off-by: Jayachandran B <jayachandran.b@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/9597
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
---
 sound/soc/intel/skylake/skl-probe.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-probe.c b/sound/soc/intel/skylake/skl-probe.c
index 8b6734a..47bb094 100644
--- a/sound/soc/intel/skylake/skl-probe.c
+++ b/sound/soc/intel/skylake/skl-probe.c
@@ -239,6 +239,12 @@ int skl_probe_compr_copy(struct snd_compr_stream *stream, char __user *buf,
 {
 	int offset = 0, availcount = 0, retval = 0, copy;
 	void *dstn;
+	/*
+	 * If userspace happens to issue a copy with count > ring buffer size,
+	 * limit the count to the allocated ring buffer size.
+	 */
+	if (count > stream->runtime->buffer_size)
+		count = stream->runtime->buffer_size;
 
 	if (stream->direction == SND_COMPRESS_CAPTURE) {
 		offset = stream->runtime->total_bytes_transferred %
-- 
1.7.5.4

