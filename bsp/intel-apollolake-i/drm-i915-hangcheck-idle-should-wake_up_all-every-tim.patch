From 0864fd2573e65a1f2dc8a675e9f4e6ac7ff461fd Mon Sep 17 00:00:00 2001
From: Dave Gordon <david.s.gordon@intel.com>
Date: Fri, 8 Apr 2016 13:52:56 -0700
Subject: [PATCH 1342/2508] drm/i915: hangcheck=idle should wake_up_all every
 time, not just once

commit 2c5d543489f84562400e322694b08c542f68767c from
https://github.com/01org/linux-apollolake-i

For: VIZ-2021
Signed-off-by: Dave Gordon <david.s.gordon@intel.com>
Signed-off-by: Jeff McGee <jeff.mcgee@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_irq.c |   23 ++++++++++++-----------
 1 files changed, 12 insertions(+), 11 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_irq.c b/drivers/gpu/drm/i915/i915_irq.c
index 7fb8ab1..aa6c418 100644
--- a/drivers/gpu/drm/i915/i915_irq.c
+++ b/drivers/gpu/drm/i915/i915_irq.c
@@ -3104,23 +3104,24 @@ static void i915_hangcheck_elapsed(struct work_struct *work)
 
 		if (engine->hangcheck.seqno == seqno) {
 			if (ring_idle(engine, seqno)) {
+				busy = false;
 				engine->hangcheck.action = HANGCHECK_IDLE;
 
 				if (waitqueue_active(&engine->irq_queue)) {
+					if (!(dev_priv->gpu_error.test_irq_rings & intel_engine_flag(engine)))
+						DRM_ERROR("Hangcheck timer elapsed... %s idle\n",
+							  engine->name);
+					else
+						DRM_INFO("Fake missed irq on %s\n",
+							 engine->name);
+
 					/* Issue a wake-up to catch stuck h/w. */
-					if (!test_and_set_bit(engine->id, &dev_priv->gpu_error.missed_irq_rings)) {
-						if (!(dev_priv->gpu_error.test_irq_rings & intel_engine_flag(engine)))
-							DRM_ERROR("Hangcheck timer elapsed... %s idle\n",
-								  engine->name);
-						else
-							DRM_INFO("Fake missed irq on %s\n",
-								 engine->name);
-						wake_up_all(&engine->irq_queue);
-					}
+					set_bit(engine->id, &dev_priv->gpu_error.missed_irq_rings);
+					wake_up_all(&engine->irq_queue);
 					/* Safeguard against driver failure */
 					engine->hangcheck.score += BUSY;
-				} else
-					busy = false;
+					busy = true;
+				}
 			} else {
 				/* We always increment the hangcheck score
 				 * if the ring is busy and still processing
-- 
1.7.5.4

