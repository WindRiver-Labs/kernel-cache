From 3f1afa2229e7fbee594cb44744f94047904ac15a Mon Sep 17 00:00:00 2001
From: "Dharageswari.R" <dharageswari.r@intel.com>
Date: Mon, 24 Aug 2015 08:54:06 +0530
Subject: [PATCH 1709/2508] ASoC: Intel: Skylake: Add support for Mic Select
 module in DSP

commit da03ec832dc1ae830fe4c774d90555b2b99b7a4a from
https://github.com/01org/linux-apollolake-i

Mic select is a DSP module which is used to configure input
to output channel map. This patch adds support to add and
configure Mic select module in Firmware topology.

Signed-off-by: Dharageswari.R <dharageswari.r@intel.com>
Signed-off-by: Jeeja KP <jeeja.kp@intel.com>
---
 sound/soc/intel/skylake/skl-messages.c       |   22 ++++++++++++++++++++++
 sound/soc/intel/skylake/skl-topology.h       |    5 +++++
 sound/soc/intel/skylake/skl-tplg-interface.h |    3 ++-
 3 files changed, 29 insertions(+), 1 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-messages.c b/sound/soc/intel/skylake/skl-messages.c
index 0975f4e..5db3f63 100644
--- a/sound/soc/intel/skylake/skl-messages.c
+++ b/sound/soc/intel/skylake/skl-messages.c
@@ -426,6 +426,22 @@ static void skl_set_algo_format(struct skl_sst *ctx,
 
 }
 
+/*
+ * Mic select module allows input to output channel map. mic select
+ * module take base module configuration and out format configuration
+ */
+static void skl_set_mic_select_format(struct skl_sst *ctx,
+			struct skl_module_cfg *mconfig,
+			struct skl_mic_select_cfg *mic_sel_mcfg)
+{
+	struct skl_audio_data_format *out_fmt = &mic_sel_mcfg->out_fmt;
+	struct skl_base_cfg *base_cfg = (struct skl_base_cfg *)mic_sel_mcfg;
+
+	skl_set_base_module_format(ctx, mconfig, base_cfg);
+
+	skl_setup_out_format(ctx, mconfig, out_fmt);
+}
+
 static u16 skl_get_module_param_size(struct skl_sst *ctx,
 			struct skl_module_cfg *mconfig)
 {
@@ -448,6 +464,9 @@ static u16 skl_get_module_param_size(struct skl_sst *ctx,
 		param_size += mconfig->formats_config.caps_size;
 		return param_size;
 
+	case SKL_MODULE_TYPE_MIC_SELECT:
+		return sizeof(struct skl_mic_select_cfg);
+
 	default:
 		/*
 		 * return only base cfg when no specific module type is
@@ -496,6 +515,9 @@ static int skl_set_module_format(struct skl_sst *ctx,
 
 	case SKL_MODULE_TYPE_ALGO:
 		skl_set_algo_format(ctx, module_config, *param_data);
+
+	case SKL_MODULE_TYPE_MIC_SELECT:
+		skl_set_mic_select_format(ctx, module_config, *param_data);
 		break;
 
 	default:
diff --git a/sound/soc/intel/skylake/skl-topology.h b/sound/soc/intel/skylake/skl-topology.h
index 78ebc38..23dbbdd 100644
--- a/sound/soc/intel/skylake/skl-topology.h
+++ b/sound/soc/intel/skylake/skl-topology.h
@@ -145,6 +145,11 @@ struct skl_algo_cfg {
 	char params[0];
 } __packed;
 
+struct skl_mic_select_cfg {
+	struct skl_base_cfg base_cfg;
+	struct skl_audio_data_format out_fmt;
+} __packed;
+
 enum skl_dma_type {
 	SKL_DMA_HDA_HOST_OUTPUT_CLASS = 0,
 	SKL_DMA_HDA_HOST_INPUT_CLASS = 1,
diff --git a/sound/soc/intel/skylake/skl-tplg-interface.h b/sound/soc/intel/skylake/skl-tplg-interface.h
index a26a91d..964567b 100644
--- a/sound/soc/intel/skylake/skl-tplg-interface.h
+++ b/sound/soc/intel/skylake/skl-tplg-interface.h
@@ -78,7 +78,8 @@ enum skl_module_type {
 	SKL_MODULE_TYPE_COPIER,
 	SKL_MODULE_TYPE_UPDWMIX,
 	SKL_MODULE_TYPE_SRCINT,
-	SKL_MODULE_TYPE_ALGO
+	SKL_MODULE_TYPE_ALGO,
+	SKL_MODULE_TYPE_MIC_SELECT
 };
 
 enum skl_core_affinity {
-- 
1.7.5.4

