From 35b91aea7a70f9f3df920f6d153bcb6635d4e293 Mon Sep 17 00:00:00 2001
From: Sagar Arun Kamble <sagar.a.kamble@intel.com>
Date: Fri, 13 Jan 2017 09:45:45 -0800
Subject: [PATCH 4473/4706] drm/i915: Notify GuC to sample forcewakes while
 enabling CPG

commit 5da6b9123ee9f27f82ddacb52b7eda830ff873ae from
git://git.yoctoproject.org/linux-yocto-4.1

Signed-off-by: Sagar Arun Kamble <sagar.a.kamble@intel.com>
Signed-off-by: Jeff McGee <jeff.mcgee@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_gem.c            |    3 +++
 drivers/gpu/drm/i915/i915_guc_submission.c |    9 +++++++++
 drivers/gpu/drm/i915/intel_pm.c            |    4 +++-
 3 files changed, 15 insertions(+), 1 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gem.c b/drivers/gpu/drm/i915/i915_gem.c
index 3412657..55c872c 100644
--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@ -2706,12 +2706,15 @@ static void i915_gem_reset_engine(struct intel_engine_cs *engine)
 void i915_gem_reset(struct drm_i915_private *dev_priv)
 {
 	struct intel_engine_cs *engine;
+	struct intel_uc_fw *guc_fw = &dev_priv->guc.guc_fw;
 
 	i915_gem_retire_requests(dev_priv);
 
 	for_each_engine(engine, dev_priv)
 		i915_gem_reset_engine(engine);
 
+	guc_fw->load_status = UC_FIRMWARE_PENDING;
+
 	i915_gem_restore_fences(&dev_priv->drm);
 
 	if (dev_priv->gt.awake) {
diff --git a/drivers/gpu/drm/i915/i915_guc_submission.c b/drivers/gpu/drm/i915/i915_guc_submission.c
index 05dddbf..e0ddeb0 100644
--- a/drivers/gpu/drm/i915/i915_guc_submission.c
+++ b/drivers/gpu/drm/i915/i915_guc_submission.c
@@ -1045,6 +1045,15 @@ int i915_guc_submission_enable(struct drm_i915_private *dev_priv)
 	}
 
 	guc->execbuf_client = client;
+
+	/*
+	 * During reset, RC6 gets enabled prior to GuC load hence i915
+	 * will not be able to send guc action to sample forcewake then.
+	 * Send it now.
+	 */
+	if (test_bit(I915_RESET_IN_PROGRESS, &dev_priv->gpu_error.flags))
+		i915_guc_sample_forcewake(dev_priv);
+
 	guc_init_doorbell_hw(guc);
 
 	/* Take over from manual control of ELSP (execlists) */
diff --git a/drivers/gpu/drm/i915/intel_pm.c b/drivers/gpu/drm/i915/intel_pm.c
index 5a8ea73..72af2f7 100644
--- a/drivers/gpu/drm/i915/intel_pm.c
+++ b/drivers/gpu/drm/i915/intel_pm.c
@@ -5366,6 +5366,7 @@ static void gen9_enable_rps(struct drm_i915_private *dev_priv)
 static void gen9_enable_rc6(struct drm_i915_private *dev_priv)
 {
 	struct intel_engine_cs *engine;
+	struct intel_guc *guc = &dev_priv->guc;
 	uint32_t rc6_mask = 0;
 
 	/* 1a: Software RC state - RC0 */
@@ -5417,7 +5418,8 @@ static void gen9_enable_rc6(struct drm_i915_private *dev_priv)
 			   rc6_mask);
 	}
 
-	i915_guc_sample_forcewake(dev_priv);
+	if (guc->guc_fw.load_status == UC_FIRMWARE_SUCCESS)
+		i915_guc_sample_forcewake(dev_priv);
 
 	/*
 	 * 3b: Enable Coarse Power Gating only when RC6 is enabled.
-- 
1.7.5.4

