From 27745cd740766b55045f6125c824774c91dabf8c Mon Sep 17 00:00:00 2001
From: Jeff McGee <jeff.mcgee@intel.com>
Date: Fri, 13 Jan 2017 15:40:50 -0800
Subject: [PATCH 4478/4706] drm/i915: Fix for RPS debugfs disabling

commit 3b41caa1075f534e41bdd8e0880a0088f83e7752 from
git://git.yoctoproject.org/linux-yocto-4.1

Exit immediately from gen6_set_rps if RPS is to be disabled,
otherwise gen6_set_rps_thresholds will re-enable RPS through
the control register.

Signed-off-by: Jeff McGee <jeff.mcgee@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/intel_pm.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_pm.c b/drivers/gpu/drm/i915/intel_pm.c
index 5be8484..0077fff 100644
--- a/drivers/gpu/drm/i915/intel_pm.c
+++ b/drivers/gpu/drm/i915/intel_pm.c
@@ -4943,6 +4943,9 @@ static void gen6_set_rps(struct drm_i915_private *dev_priv, u8 val)
 	if (IS_BXT_REVID(dev_priv, 0, BXT_REVID_A1))
 		return;
 
+	if (dev_priv->rps.rps_disable)
+		return;
+
 	WARN_ON(!mutex_is_locked(&dev_priv->rps.hw_lock));
 	WARN_ON(val > dev_priv->rps.max_freq);
 	WARN_ON(val < dev_priv->rps.min_freq);
-- 
1.7.5.4

