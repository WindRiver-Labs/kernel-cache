From d750060aab718753d01941b15baccfb2929a9eaf Mon Sep 17 00:00:00 2001
From: Dave Gordon <david.s.gordon@intel.com>
Date: Fri, 8 Apr 2016 13:53:07 -0700
Subject: [PATCH 1353/2508] drm/i915/guc: Expose GuC-maintained statistics

commit c660e134793fcfde7b7ced72c0bbd31dd66cc37f from
https://github.com/01org/linux-apollolake-i

For: VIZ-2021
Signed-off-by: Dave Gordon <david.s.gordon@intel.com>
Signed-off-by: Jeff McGee <jeff.mcgee@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_guc_submission.c |   20 +++++++++++++++++++-
 drivers/gpu/drm/i915/intel_guc_fwif.h      |    7 ++++++-
 2 files changed, 25 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_guc_submission.c b/drivers/gpu/drm/i915/i915_guc_submission.c
index e08e70b..b28bf9f 100644
--- a/drivers/gpu/drm/i915/i915_guc_submission.c
+++ b/drivers/gpu/drm/i915/i915_guc_submission.c
@@ -168,9 +168,27 @@ host2guc_preempt(struct i915_guc_client *client,
 	data[4] = guc->execbuf_client->priority;		/* victim priority			*/
 	data[5] = guc->execbuf_client->ctx_index;		/* victim ctx/wq			*/
 	data[6] = i915_gem_obj_ggtt_offset(ctx_obj) + LRC_GUCSHR_PN*PAGE_SIZE;
+	data[7] = 0;
 
 	ret = host2guc_action(guc, data, 7);
-	WARN_ON(ret);
+	if (WARN_ON(ret)) {
+		u32 *gsp;
+		int i;
+
+		gsp = kmap_atomic(i915_gem_object_get_page(ctx_obj, LRC_GUCSHR_PN));
+		DRM_DEBUG_DRIVER("GuC preemption request data:\n");
+		for (i = 0; i < 8; i += 4)
+			DRM_DEBUG_DRIVER("\t%08x %08x  %08x %08x\n",
+				data[i+0], data[i+1], data[i+2], data[i+3]);
+
+		DRM_DEBUG_DRIVER("GuC per-context shared data @ 0x%llx:\n",
+			i915_gem_obj_ggtt_offset(ctx_obj) + LRC_GUCSHR_PN*PAGE_SIZE);
+		for (i = 0; i < 32; i += 4)
+			DRM_DEBUG_DRIVER("\t%08x %08x  %08x %08x\n",
+				gsp[i+0], gsp[i+1], gsp[i+2], gsp[i+3]);
+
+		kunmap_atomic(gsp);
+	}
 	return ret;
 }
 
diff --git a/drivers/gpu/drm/i915/intel_guc_fwif.h b/drivers/gpu/drm/i915/intel_guc_fwif.h
index 7032bae..32324f8 100644
--- a/drivers/gpu/drm/i915/intel_guc_fwif.h
+++ b/drivers/gpu/drm/i915/intel_guc_fwif.h
@@ -258,7 +258,12 @@ struct guc_process_desc {
 	u32 wq_status;
 	u32 engine_presence;
 	u32 priority;
-	u32 reserved[30];
+	u32 reserved1[4];
+	u32 reserved2[5];
+	u32 items_parsed,
+	    items_collaped,
+	    items_cancelled;
+	u32 reserved3[18];
 } __packed;
 
 /* engine id and context id is packed into guc_execlist_context.context_id*/
-- 
1.7.5.4

