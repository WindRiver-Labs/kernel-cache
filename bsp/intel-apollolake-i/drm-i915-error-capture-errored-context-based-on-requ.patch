From 7230a4945c6fe80fb1fcd334d901e54a38a6e272 Mon Sep 17 00:00:00 2001
From: Dave Gordon <david.s.gordon@intel.com>
Date: Fri, 8 Apr 2016 13:53:09 -0700
Subject: [PATCH 1355/2508] drm/i915/error: capture errored context based on
 request context-id

commit 0b484f263ea00db1c8071e3225d76fe7ae9d926a from
https://github.com/01org/linux-apollolake-i

Context capture hasn't worked for a while now, probably since the
introduction of execlists; this patch makes it work again by using
a different way of identifying the context of interest.

For: VIZ-2021
Signed-off-by: Dave Gordon <david.s.gordon@intel.com>
Signed-off-by: Jeff McGee <jeff.mcgee@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_gpu_error.c |    7 +++----
 1 files changed, 3 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gpu_error.c b/drivers/gpu/drm/i915/i915_gpu_error.c
index 151451a..8522a7a 100644
--- a/drivers/gpu/drm/i915/i915_gpu_error.c
+++ b/drivers/gpu/drm/i915/i915_gpu_error.c
@@ -1117,13 +1117,12 @@ static void i915_gem_record_active_context(struct intel_engine_cs *engine,
 			continue;
 		}
 
-		if (!error->ccid)
-			continue;
-
 		if (i915.enable_execlists)
 			base += LRC_PPHWSP_PN * PAGE_SIZE;
 
-		if (base == (error->ccid & PAGE_MASK))
+		if (error->ccid && base == (error->ccid & PAGE_MASK))
+			ering->ctx = i915_error_ggtt_object_create(dev_priv, obj);
+		else if (((base ^ ering->ctx_desc) & 0x00000000FFFFF000ULL) == 0)
 			ering->ctx = i915_error_ggtt_object_create(dev_priv, obj);
 	}
 }
-- 
1.7.5.4

