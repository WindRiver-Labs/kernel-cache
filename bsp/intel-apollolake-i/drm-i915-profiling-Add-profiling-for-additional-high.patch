From ae2cd6c4180bbb78f5c0baa2166eca3d49ecc8b3 Mon Sep 17 00:00:00 2001
From: Bob Paauwe <bob.j.paauwe@intel.com>
Date: Tue, 19 Apr 2016 14:46:32 -0700
Subject: [PATCH 1255/2508] drm/i915/profiling: Add profiling for additional
 high level steps.

commit ab0febad4d0f98e6f0788880699d1b2c3f10f018 from
https://github.com/01org/linux-apollolake-i

in the driver load process:

  - hardware initialization time
  - modeset initialization time
  - driver registration time

Signed-off-by: Bob Paauwe <bob.j.paauwe@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_debugfs.c |   12 +++++++++---
 drivers/gpu/drm/i915/i915_dma.c     |    9 +++++++--
 drivers/gpu/drm/i915/i915_drv.h     |    3 +++
 3 files changed, 19 insertions(+), 5 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_debugfs.c b/drivers/gpu/drm/i915/i915_debugfs.c
index c6f22eb..2971198 100644
--- a/drivers/gpu/drm/i915/i915_debugfs.c
+++ b/drivers/gpu/drm/i915/i915_debugfs.c
@@ -2398,12 +2398,18 @@ static int i915_timing_info(struct seq_file *m, void *data)
 	seq_printf(m, "Timing info\n");
 	seq_printf(m, "  Total driver load time:      %lldms\n",
 		   (dev_priv->profile.driver_load / 1000000));
-	seq_printf(m, "    GUC firmware init time:             %lldms\n",
+	seq_printf(m, "    Hardware init time:                 %lldms\n",
+		   (dev_priv->profile.hardware_init / 1000000));
+	seq_printf(m, "    Modeset init time:                  %lldms\n",
+		   (dev_priv->profile.modeset_init / 1000000));
+	seq_printf(m, "        GUC firmware init time:             %lldms\n",
 		   (dev_priv->profile.guc_init / 1000000));
-	seq_printf(m, "    GUC firmware load time:             %lldms\n",
+	seq_printf(m, "        GUC firmware load time:             %lldms\n",
 		   (dev_priv->profile.guc_load / 1000000));
-	seq_printf(m, "    Global GTT init time:               %lldms\n",
+	seq_printf(m, "        Global GTT init time:               %lldms\n",
 		   (dev_priv->profile.gtt_init / 1000000));
+	seq_printf(m, "    Register time:                      %lldms\n",
+		   (dev_priv->profile.driver_register / 1000000));
 	seq_printf(m, "  Frambuffer device load time: %lldms\n",
 		   (dev_priv->profile.fbdev_load / 1000000));
 	seq_printf(m, "  CSR firmware load time:      %lldms\n",
diff --git a/drivers/gpu/drm/i915/i915_dma.c b/drivers/gpu/drm/i915/i915_dma.c
index 4d5a7a4..26d31e0 100644
--- a/drivers/gpu/drm/i915/i915_dma.c
+++ b/drivers/gpu/drm/i915/i915_dma.c
@@ -1337,9 +1337,9 @@ int i915_driver_load(struct drm_device *dev, unsigned long flags)
 {
 	struct drm_i915_private *dev_priv;
 	int ret = 0;
-	unsigned long long start_tm;
+	unsigned long long start_tm, sub_load_tm;
 
-	start_tm = sched_clock();
+	start_tm = sub_load_tm = sched_clock();
 
 	dev_priv = kzalloc(sizeof(*dev_priv), GFP_KERNEL);
 	if (dev_priv == NULL)
@@ -1365,6 +1365,8 @@ int i915_driver_load(struct drm_device *dev, unsigned long flags)
 	if (ret < 0)
 		goto out_cleanup_mmio;
 
+	dev_priv->profile.hardware_init = sched_clock() - sub_load_tm;
+	sub_load_tm = sched_clock();
 	/*
 	 * TODO: move the vblank init and parts of modeset init steps into one
 	 * of the i915_driver_init_/i915_driver_register functions according
@@ -1379,8 +1381,11 @@ int i915_driver_load(struct drm_device *dev, unsigned long flags)
 	ret = i915_load_modeset_init(dev);
 	if (ret < 0)
 		goto out_cleanup_vblank;
+	dev_priv->profile.modeset_init = sched_clock() - sub_load_tm;
+	sub_load_tm = sched_clock();
 
 	i915_driver_register(dev_priv);
+	dev_priv->profile.driver_register = sched_clock() - sub_load_tm;
 
 	intel_runtime_pm_enable(dev_priv);
 
diff --git a/drivers/gpu/drm/i915/i915_drv.h b/drivers/gpu/drm/i915/i915_drv.h
index 866a6ef..5c1f188 100644
--- a/drivers/gpu/drm/i915/i915_drv.h
+++ b/drivers/gpu/drm/i915/i915_drv.h
@@ -1637,6 +1637,9 @@ struct intel_pipe_crc {
 
 struct intel_load_profiles {
 	unsigned long long driver_load;
+	unsigned long long hardware_init;
+	unsigned long long modeset_init;
+	unsigned long long driver_register;
 	unsigned long long gtt_init;
 	unsigned long long fbdev_load;
 	unsigned long long guc_init;
-- 
1.7.5.4

