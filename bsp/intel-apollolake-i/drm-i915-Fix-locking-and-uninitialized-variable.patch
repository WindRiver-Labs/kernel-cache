From ce031304d172fee8001eb61fd46a97164e66f4d3 Mon Sep 17 00:00:00 2001
From: Bob Paauwe <bob.j.paauwe@intel.com>
Date: Thu, 19 Jan 2017 14:54:00 -0800
Subject: [PATCH 4485/4706] drm/i915: Fix locking and uninitialized variable

commit f6d76c59951409d9284dc3ac9fd53f31478ff3c7 from
git://git.yoctoproject.org/linux-yocto-4.1

With the change to move the connector detection outside of the atomic
locking, we lost the connection mutex lock.  That's needed for most
of the connector related code.

Also the connector mode array could have garbage leading to failures
setting the atomic state so clear it before use.

Signed-off-by: Bob Paauwe <bob.j.paauwe@intel.com>
Reviewed-by: Matt Roper <matthew.d.roper@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/intel_initial_modeset.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_initial_modeset.c b/drivers/gpu/drm/i915/intel_initial_modeset.c
index baa5d93..5e7eac0 100644
--- a/drivers/gpu/drm/i915/intel_initial_modeset.c
+++ b/drivers/gpu/drm/i915/intel_initial_modeset.c
@@ -534,6 +534,8 @@ static void modeset_config_fn(struct work_struct *work)
 
 	intel_splash_screen_init(dev);
 
+	memset(connector_mode, 0, sizeof(connector_mode));
+	mutex_lock(&dev->mode_config.mutex);
 	drm_for_each_connector(connector, dev) {
 		if (use_connector(connector)) {
 			if (!(encoder = connector->encoder))
@@ -572,6 +574,7 @@ static void modeset_config_fn(struct work_struct *work)
 			}
 		}
 	}
+	mutex_unlock(&dev->mode_config.mutex);
 
 	if (!found)
 		return;
-- 
1.7.5.4

