From 9f9d42eb925248624042c6b32e2f07a3d0f06bce Mon Sep 17 00:00:00 2001
From: Sudip Mukherjee <sudipm.mukherjee@gmail.com>
Date: Thu, 21 Jan 2016 17:27:59 +0530
Subject: [PATCH 2119/2508] ASoC: Intel: Skylake: Fix memory leak

commit ab0b783912fa846568b660c219f12e556d585da5 from
https://github.com/01org/linux-apollolake-i

If snd_soc_tplg_component_load() fails we just printed an error message
and returned the error code but we missed releasing the firmware.

Change-Id: I4df6a3127a2794084689989322a78d269bee4e21
Signed-off-by: Sudip Mukherjee <sudip@vectorindia.org>
Signed-off-by: Mark Brown <broonie@kernel.org>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/10207
Reviewed-by: Jayanti, Satya Charitardha <satya.charitardha.jayanti@intel.com>
Tested-by: Jayanti, Satya Charitardha <satya.charitardha.jayanti@intel.com>
---
 sound/soc/intel/skylake/skl-topology.c |    9 +++++----
 1 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-topology.c b/sound/soc/intel/skylake/skl-topology.c
index 3933e29..165e87e 100644
--- a/sound/soc/intel/skylake/skl-topology.c
+++ b/sound/soc/intel/skylake/skl-topology.c
@@ -2509,11 +2509,12 @@ static void skl_tplg_set_pipe_type(struct skl *skl, struct skl_pipe *pipe)
 int skl_tplg_init(struct snd_soc_platform *platform, struct hdac_ext_bus *ebus)
 {
 	int ret;
+	const struct firmware *fw;
 	struct hdac_bus *bus = ebus_to_hbus(ebus);
 	struct skl *skl = ebus_to_skl(ebus);
 	struct skl_pipeline *ppl;
 
-	ret = request_firmware(&skl->tplg, "dfw_sst.bin", bus->dev);
+	ret = request_firmware(&fw, "dfw_sst.bin", bus->dev);
 	if (ret < 0) {
 		dev_err(bus->dev, "tplg fw %s load failed with %d\n",
 				"dfw_sst.bin", ret);
@@ -2525,17 +2526,17 @@ int skl_tplg_init(struct snd_soc_platform *platform, struct hdac_ext_bus *ebus)
 	 * any other index
 	 */
 	ret = snd_soc_tplg_component_load(&platform->component,
-					&skl_tplg_ops, skl->tplg, 0);
+					&skl_tplg_ops, fw, 0);
 	if (ret < 0) {
 		dev_err(bus->dev, "tplg component load failed%d\n", ret);
-		release_firmware(skl->tplg);
+		release_firmware(fw);
 		return -EINVAL;
 	}
 
 	skl->resource.max_mcps = SKL_MAX_MCPS;
 	skl->resource.max_mem = SKL_FW_MAX_MEM;
 
-
+	skl->tplg = fw;
 	list_for_each_entry(ppl, &skl->ppl_list, node)
 		skl_tplg_set_pipe_type(skl, ppl->pipe);
 
-- 
1.7.5.4

