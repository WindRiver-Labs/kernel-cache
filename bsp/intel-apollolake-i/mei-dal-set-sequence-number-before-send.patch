From 3dc144971d974f952bd736d958f34b0f296f3220 Mon Sep 17 00:00:00 2001
From: Evyatar Vaalani <evyatar.vaalani@intel.com>
Date: Wed, 24 Aug 2016 09:48:52 +0300
Subject: [PATCH 17/68] mei: dal: set sequence number before send.

commit b729ea87bed6e96a5dc9e078d7a56c6684eddd62 from
git://git.yoctoproject.org/linux-yocto-4.1

The sequence number should be set before a buffer is send.
Without this fix the kdi open_session hang frequently.

Change-Id: I6be993802c14c576dc75dfb048f02d4e658d98bd
Signed-off-by: Evyatar Vaalani <evyatar.vaalani@intel.com>
Signed-off-by: Tomas Winkler <tomas.winkler@intel.com>
---
 drivers/misc/mei/dal/dal_class.c |   10 +++++-----
 1 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/drivers/misc/mei/dal/dal_class.c b/drivers/misc/mei/dal/dal_class.c
index a66fa42..16e83a9 100644
--- a/drivers/misc/mei/dal/dal_class.c
+++ b/drivers/misc/mei/dal/dal_class.c
@@ -204,6 +204,11 @@ ssize_t dal_write(struct dal_client *dc, size_t count, u64 seq)
 	dev_dbg(dev, "before write_queue_lock - client type %d", intf);
 	mutex_lock(&ddev->write_queue_lock);
 
+	/* update client on latest msg seq number*/
+	dc->seq = seq;
+	dev_dbg(dev, "current_write_client seq = %llu",
+			dc->seq);
+
 	ddev->is_write_pending = true;
 
 	/* put dc in write queue*/
@@ -302,11 +307,6 @@ ssize_t dal_write(struct dal_client *dc, size_t count, u64 seq)
 		ddev->is_write_pending = false;
 	}
 
-	/* update client on latest msg seq number*/
-	ddev->current_write_client->seq = seq;
-	dev_dbg(dev, "current_write_client seq = %llu",
-		ddev->current_write_client->seq);
-
 	ret = wr;
 
 cleanup:
-- 
1.7.5.4

