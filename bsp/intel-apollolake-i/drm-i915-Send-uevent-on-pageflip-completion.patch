From c382d304e39f21cd08bdae411cec3d237238af29 Mon Sep 17 00:00:00 2001
From: Matt Roper <matthew.d.roper@intel.com>
Date: Wed, 1 Jun 2016 09:05:23 -0700
Subject: [PATCH 1457/2508] drm/i915: Send uevent on pageflip completion

commit 9a2c33b217bd8e27f1883697491202accdaa97e1 from
https://github.com/01org/linux-apollolake-i

We weren't honoring the atomic ioctl's DRM_MODE_PAGE_FLIP_EVENT flag; we
need to actually send the event to userspace once the flip is done.

Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
Tested-by: Mitul Chokshi <mitul.chokshi@intel.com>
---
 drivers/gpu/drm/i915/intel_display.c |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_display.c b/drivers/gpu/drm/i915/intel_display.c
index ec76ff5..aa3790a 100644
--- a/drivers/gpu/drm/i915/intel_display.c
+++ b/drivers/gpu/drm/i915/intel_display.c
@@ -13833,6 +13833,16 @@ static void finish_atomic_commit(struct work_struct *work)
 	if (hw_check)
 		intel_modeset_check_state(dev, state);
 
+	for_each_crtc_in_state(state, crtc, old_crtc_state, i) {
+		if (crtc && crtc->state->event) {
+			spin_lock_irq(&dev->event_lock);
+			drm_send_vblank_event(dev, to_intel_crtc(crtc)->pipe,
+					      crtc->state->event);
+			crtc->state->event = NULL;
+			spin_unlock_irq(&dev->event_lock);
+		}
+	}
+
 	/* Unblock other commits against these CRTC's */
 	flip_completion(commit);
 	kfree(commit);
-- 
1.7.5.4

