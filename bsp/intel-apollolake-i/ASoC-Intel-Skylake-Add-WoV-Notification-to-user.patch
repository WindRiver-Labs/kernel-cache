From 55a6409a053e2217136784cb7bf2add1e32367de Mon Sep 17 00:00:00 2001
From: Guneshwor Singh <guneshwor.o.singh@intel.com>
Date: Tue, 3 May 2016 05:57:03 +0530
Subject: [PATCH 1968/2508] ASoC: Intel: Skylake: Add WoV Notification to user

commit b6d35061ad365737b10435eaaa51538c79279c23 from
https://github.com/01org/linux-apollolake-i

Change-Id: I9eab49c54a2cebce5b8aac84d92112b3b269fb04
Signed-off-by: Kranthi G <gudishax.kranthikumar@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/7772
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
---
 sound/soc/intel/skylake/bxt-sst.c     |    5 +++++
 sound/soc/intel/skylake/skl-pcm.c     |   30 ++++++++++++++++++++++++++++++
 sound/soc/intel/skylake/skl-sst-dsp.h |    8 ++++++++
 sound/soc/intel/skylake/skl-sst-ipc.c |    1 +
 sound/soc/intel/skylake/skl-sst-ipc.h |    4 ++++
 5 files changed, 48 insertions(+), 0 deletions(-)

diff --git a/sound/soc/intel/skylake/bxt-sst.c b/sound/soc/intel/skylake/bxt-sst.c
index 03a8ab1..6973d74 100644
--- a/sound/soc/intel/skylake/bxt-sst.c
+++ b/sound/soc/intel/skylake/bxt-sst.c
@@ -31,6 +31,7 @@
 #include "skl-sst-ipc.h"
 #include "skl-tplg-interface.h"
 #include "skl-fwlog.h"
+#include "skl.h"
 
 #define FW_ROM_INIT_DONE                0x1
 
@@ -108,6 +109,7 @@ int bxt_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 	struct skl_sst *skl;
 	struct sst_dsp *sst;
 	u32 dsp_wp[] = {BXT_ADSP_WP_DSP0, BXT_ADSP_WP_DSP1};
+	struct skl_dsp_notify_params *params;
 	int ret = 0;
 
 	dev_dbg(dev, "In %s\n", __func__);
@@ -145,6 +147,9 @@ int bxt_sst_dsp_init_hw(struct device *dev, void __iomem *mmio_base, int irq,
 		dev_err(dev, "FW tracing init failed : %x", ret);
 		return ret;
 	}
+	params = devm_kzalloc(dev, sizeof(struct skl_dsp_notify_params), GFP_KERNEL);
+	params->skl_sst = skl;
+	skl->params = params;
 
 	ret = skl_ipc_init(dev, skl);
 	if (ret)
diff --git a/sound/soc/intel/skylake/skl-pcm.c b/sound/soc/intel/skylake/skl-pcm.c
index 34654c4..831f749 100644
--- a/sound/soc/intel/skylake/skl-pcm.c
+++ b/sound/soc/intel/skylake/skl-pcm.c
@@ -746,6 +746,34 @@ static struct snd_soc_dai_ops skl_link_dai_ops = {
 	.trigger = skl_link_pcm_trigger,
 };
 
+static int skl_dsp_cb_event(struct skl_dsp_notify_params *params)
+{
+	struct snd_soc_platform *soc_platform = params->skl_sst->platform;
+	struct snd_soc_card *card;
+	struct snd_kcontrol *kcontrol;
+
+	if (!soc_platform) {
+		dev_err(params->skl_sst->dev,
+			"%s: Platform not found\n", __func__);
+		return -EINVAL;
+	}
+
+	card = soc_platform->component.card;
+	kcontrol = snd_soc_card_get_kcontrol(card,
+				"hwd_in hwd 0 notif params"); /*control name of WoV notification*/
+	if (!kcontrol) {
+			dev_err(params->skl_sst->dev,
+				"hwd notification control not found\n");
+			return -EINVAL;
+		}
+	snd_ctl_notify(card->snd_card, SNDRV_CTL_EVENT_MASK_VALUE, &kcontrol->id);
+	return 0;
+}
+
+struct skl_dsp_notify_ops cb_ops = {
+	.notify_cb = skl_dsp_cb_event,
+};
+
 static struct snd_soc_dai_driver skl_platform_dai[] = {
 {
 	.name = "TraceBuffer0 Pin",
@@ -1427,6 +1455,8 @@ static int skl_platform_soc_probe(struct snd_soc_platform *platform)
 			goto out_free;
 		}
 		skl->skl_sst->update_d0i3c = skl_update_d0i3c;
+		skl->skl_sst->platform = platform;
+		skl->skl_sst->notify_ops = cb_ops;
 	}
 
 	skl_get_probe_widget(platform, skl);
diff --git a/sound/soc/intel/skylake/skl-sst-dsp.h b/sound/soc/intel/skylake/skl-sst-dsp.h
index 32c003b..04709e3 100644
--- a/sound/soc/intel/skylake/skl-sst-dsp.h
+++ b/sound/soc/intel/skylake/skl-sst-dsp.h
@@ -161,6 +161,14 @@ struct skl_dsp_loader_ops {
 				 int stream_tag);
 };
 
+struct skl_dsp_notify_params {
+	struct skl_sst *skl_sst;
+	u32 event;
+};
+struct skl_dsp_notify_ops {
+	int (*notify_cb)(struct skl_dsp_notify_params *params);
+};
+
 struct skl_load_module_info {
 	u16 mod_id;
 	const struct firmware *fw;
diff --git a/sound/soc/intel/skylake/skl-sst-ipc.c b/sound/soc/intel/skylake/skl-sst-ipc.c
index 0c44689..319b64f 100644
--- a/sound/soc/intel/skylake/skl-sst-ipc.c
+++ b/sound/soc/intel/skylake/skl-sst-ipc.c
@@ -433,6 +433,7 @@ int skl_ipc_process_notification(struct sst_generic_ipc *ipc,
 		case IPC_GLB_NOTIFY_PHRASE_DETECTED:
 			dev_err(ipc->dev, "*****Pharse Detected **********\n");
 			mdelay(1);
+			skl->notify_ops.notify_cb(skl->params);
 			break;
 
 		default:
diff --git a/sound/soc/intel/skylake/skl-sst-ipc.h b/sound/soc/intel/skylake/skl-sst-ipc.h
index 3c800c7..8f0aa81 100644
--- a/sound/soc/intel/skylake/skl-sst-ipc.h
+++ b/sound/soc/intel/skylake/skl-sst-ipc.h
@@ -19,6 +19,7 @@
 #include <linux/kthread.h>
 #include <linux/irqreturn.h>
 #include "../common/sst-ipc.h"
+#include "skl-sst-dsp.h"
 
 struct sst_dsp;
 struct skl_sst;
@@ -99,6 +100,9 @@ struct skl_sst {
 
 	/* Callback to update D0i3C register */
 	void (*update_d0i3c)(struct device *dev,  bool enable);
+	struct snd_soc_platform *platform;
+	struct skl_dsp_notify_ops notify_ops;
+	struct skl_dsp_notify_params *params;
 };
 
 struct skl_ipc_init_instance_msg {
-- 
1.7.5.4

