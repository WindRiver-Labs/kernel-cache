From d66cbd759315145f0484af2bb04c3b63cf44340f Mon Sep 17 00:00:00 2001
From: Dave Gordon <david.s.gordon@intel.com>
Date: Fri, 8 Apr 2016 13:53:15 -0700
Subject: [PATCH 1361/2508] drm/i915/sched: include scheduler state in error
 capture

commit 90b744d488fd55fcf4a9c317e7151f57af744a2f from
https://github.com/01org/linux-apollolake-i

For: VIZ-2021
Signed-off-by: Dave Gordon <david.s.gordon@intel.com>
Signed-off-by: Jeff McGee <jeff.mcgee@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_drv.h       |    1 +
 drivers/gpu/drm/i915/i915_gpu_error.c |    6 ++++++
 2 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_drv.h b/drivers/gpu/drm/i915/i915_drv.h
index b266424..239209d 100644
--- a/drivers/gpu/drm/i915/i915_drv.h
+++ b/drivers/gpu/drm/i915/i915_drv.h
@@ -552,6 +552,7 @@ struct drm_i915_error_state {
 			u32 tail;
 			u32 submission_count;
 			u64 ringbuffer_gtt;
+			char scheduler_state;
 		} *requests;
 
 		struct {
diff --git a/drivers/gpu/drm/i915/i915_gpu_error.c b/drivers/gpu/drm/i915/i915_gpu_error.c
index 4cd515c..1c413d5 100644
--- a/drivers/gpu/drm/i915/i915_gpu_error.c
+++ b/drivers/gpu/drm/i915/i915_gpu_error.c
@@ -619,10 +619,12 @@ int i915_error_state_to_str(struct drm_i915_error_state_buf *m,
 				err_printf(m, "  seqno 0x%08x, ringbuf 0x%llx "
 					      "head 0x%08x tail 0x%08x, "
 					      "emitted %ld, %d submissions, "
+					      "sched %c "
 					      "ctx_desc 0x%08x_%08x\n",
 					erq->seqno, erq->ringbuffer_gtt,
 					erq->head, erq->tail,
 					erq->jiffies, erq->submission_count,
+					erq->scheduler_state,
 					upper_32_bits(erq->ctx_desc),
 					lower_32_bits(erq->ctx_desc));
 			}
@@ -1339,6 +1341,8 @@ static void i915_gem_record_rings(struct drm_device *dev,
 
 		count = 0;
 		list_for_each_entry(request, &engine->request_list, list) {
+			struct i915_scheduler_queue_entry *sqe =
+							request->scheduler_qe;
 			struct intel_context *ctx = request->ctx;
 			struct drm_i915_error_request *erq;
 
@@ -1370,6 +1374,8 @@ static void i915_gem_record_rings(struct drm_device *dev,
 			erq->submission_count = request->elsp_submitted;
 			erq->ringbuffer_gtt =
 				i915_gem_obj_ggtt_offset(request->ringbuf->obj);
+			erq->scheduler_state = !sqe ? 'u' :
+				i915_scheduler_queue_status_chr(sqe->status);
 		}
 	}
 }
-- 
1.7.5.4

