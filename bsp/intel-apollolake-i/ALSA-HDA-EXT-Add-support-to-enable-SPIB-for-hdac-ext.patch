From 43cf6f148f938f16d3db5f1d55e671948f832a60 Mon Sep 17 00:00:00 2001
From: Jeeja KP <jeeja.kp@intel.com>
Date: Fri, 7 Aug 2015 08:17:02 +0530
Subject: [PATCH 1753/2508] ALSA: HDA: EXT: Add support to enable SPIB for
 hdac ext stream

commit 347880050f939c3a0b18fa0ef7431d5cd8bc3f55 from
https://github.com/01org/linux-apollolake-i

Adds support to enable SPIB for streams. This adds new
API to set the spib for hdac_ext_stream and read
the spib maxfifo value for hdac_ext_stream

Change-Id: Ie09f05022a449d6cb89f9b950e9f88978e6ea8b4
Signed-off-by: Jeeja KP <jeeja.kp@intel.com>
---
 include/sound/hda_register.h    |    4 ++++
 include/sound/hdaudio_ext.h     |    2 ++
 sound/hda/ext/hdac_ext_stream.c |   22 +++++++++++++++++++++-
 3 files changed, 27 insertions(+), 1 deletions(-)

diff --git a/include/sound/hda_register.h b/include/sound/hda_register.h
index 2ae8812..7964585 100644
--- a/include/sound/hda_register.h
+++ b/include/sound/hda_register.h
@@ -163,6 +163,10 @@ enum { SDI0, SDI1, SDI2, SDI3, SDO0, SDO1, SDO2, SDO3 };
 /* SPIB base */
 #define AZX_SPB_SPIB			0x00
 /* SPIB MAXFIFO base*/
+#define AZX_SPB_MAXFIO			0x04
+/* SPIB base */
+#define AZX_SPB_SPIB			0x00
+/* SPIB MAXFIFO base*/
 #define AZX_SPB_MAXFIFO			0x04
 
 /* registers of Global Time Synchronization Capability Structure */
diff --git a/include/sound/hdaudio_ext.h b/include/sound/hdaudio_ext.h
index 719edff..f7ee45f 100644
--- a/include/sound/hdaudio_ext.h
+++ b/include/sound/hdaudio_ext.h
@@ -107,6 +107,8 @@ void snd_hdac_ext_stop_streams(struct hdac_ext_bus *sbus);
 
 int snd_hdac_ext_stream_set_spib(struct hdac_ext_bus *ebus,
 				 struct hdac_ext_stream *stream, u32 value);
+int snd_hdac_ext_stream_spbmaxfifo(struct hdac_ext_bus *ebus,
+				 struct hdac_ext_stream *stream);
 int snd_hdac_ext_stream_get_spbmaxfifo(struct hdac_ext_bus *ebus,
 				 struct hdac_ext_stream *stream);
 
diff --git a/sound/hda/ext/hdac_ext_stream.c b/sound/hda/ext/hdac_ext_stream.c
index cb89ec7..1fd8630 100644
--- a/sound/hda/ext/hdac_ext_stream.c
+++ b/sound/hda/ext/hdac_ext_stream.c
@@ -460,6 +460,27 @@ int snd_hdac_ext_stream_set_spib(struct hdac_ext_bus *ebus,
 EXPORT_SYMBOL_GPL(snd_hdac_ext_stream_set_spib);
 
 /**
+ * snd_hdac_ext_stream_spbmaxfifo - sets the spib value of a stream
+ * @ebus: HD-audio ext core bus
+ * @stream: hdac_ext_stream
+ *
+ * Return maxfifo for the stream
+ */
+int snd_hdac_ext_stream_spbmaxfifo(struct hdac_ext_bus *ebus,
+				 struct hdac_ext_stream *stream)
+{
+	struct hdac_bus *bus = &ebus->bus;
+
+	if (!ebus->spbcap) {
+		dev_err(bus->dev, "Address of SPB capability is NULL");
+		return -EINVAL;
+	}
+
+	return readl(stream->fifo_addr);
+}
+EXPORT_SYMBOL_GPL(snd_hdac_ext_stream_spbmaxfifo);
+
+/**
  * snd_hdac_ext_stream_get_spbmaxfifo - gets the spib value of a stream
  * @ebus: HD-audio ext core bus
  * @stream: hdac_ext_stream
@@ -480,7 +501,6 @@ int snd_hdac_ext_stream_get_spbmaxfifo(struct hdac_ext_bus *ebus,
 }
 EXPORT_SYMBOL_GPL(snd_hdac_ext_stream_get_spbmaxfifo);
 
-
 /**
  * snd_hdac_ext_stop_streams - stop all stream if running
  * @ebus: HD-audio ext core bus
-- 
1.7.5.4

