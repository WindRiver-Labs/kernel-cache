From 04603037efb7fa92aad42e787d0815db02e3a6d6 Mon Sep 17 00:00:00 2001
From: Pardha Saradhi K <pardha.saradhi.kesapragada@intel.com>
Date: Thu, 25 Feb 2016 11:13:35 +0530
Subject: [PATCH 1879/2508] ASoC: Intel: Skylake: Send correct size in ipc
 header for large config

commit b3f94e504ac7fefec78ad44f25cea8fb74c9a6dd from
https://github.com/01org/linux-apollolake-i

Large Config Get messages accept arguments in the form of
extended params, for querying certain information from ADSP. Hence
they involve sending a Tx message of fixed size (8 bytes) in mailbox
for retrieving a large reply.
For this case, the IPC header should reflect the correct size of
Tx message.

Change-Id: Ib055c879d6e9dc00e8c861ab25ea9d9080e98732
Signed-off-by: Pardha Saradhi K <pardha.saradhi.kesapragada@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/8240
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
---
 sound/soc/intel/skylake/skl-sst-ipc.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-sst-ipc.c b/sound/soc/intel/skylake/skl-sst-ipc.c
index ce0ee0d..c8fcf90 100644
--- a/sound/soc/intel/skylake/skl-sst-ipc.c
+++ b/sound/soc/intel/skylake/skl-sst-ipc.c
@@ -947,7 +947,11 @@ int skl_ipc_get_large_config(struct sst_generic_ipc *ipc,
 	header.primary |= IPC_MOD_INSTANCE_ID(msg->instance_id);
 	header.primary |= IPC_MOD_ID(msg->module_id);
 
-	header.extension = IPC_DATA_OFFSET_SZ(msg->param_data_size);
+	if(!size)
+                header.extension = IPC_DATA_OFFSET_SZ(msg->param_data_size);
+        else
+                header.extension = IPC_DATA_OFFSET_SZ(size);
+
 	header.extension |= IPC_LARGE_PARAM_ID(msg->large_param_id);
 	header.extension |= IPC_FINAL_BLOCK(1);
 	header.extension |= IPC_INITIAL_BLOCK(1);
-- 
1.7.5.4

