From 1e4ad4a94515afcac9ca44900b3ede46fb5c3cc3 Mon Sep 17 00:00:00 2001
From: Jayachandran B <jayachandran.b@intel.com>
Date: Wed, 30 Mar 2016 19:34:40 +0530
Subject: [PATCH 1969/2508] ASoC: Intel: Skylake: Add LP mode pipeline
 attribute.

commit 743da9fa8dcbed3006f73813f8512bb1641df606 from
https://github.com/01org/linux-apollolake-i

FW pipelines have an attribute "LP" which when set indicates
that the pipeline needs to continue running in low power mode.
Add support for specifiying this attribute by obtaining it
from topology binary and passing it to create pipeline IPC.

Change-Id: Ic46a50a7b39b02b50a17de89f295a3a522e02c8c
Tracked-On: https://jira01.devtools.intel.com/browse/OAM-27123
Signed-off-by: Jayachandran B <jayachandran.b@intel.com>
Reviewed-on: https://android.intel.com:443/488174
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/8888
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
---
 sound/soc/intel/skylake/skl-messages.c       |    3 ++-
 sound/soc/intel/skylake/skl-sst-ipc.c        |    8 +++++++-
 sound/soc/intel/skylake/skl-sst-ipc.h        |    2 +-
 sound/soc/intel/skylake/skl-topology.c       |    1 +
 sound/soc/intel/skylake/skl-topology.h       |    1 +
 sound/soc/intel/skylake/skl-tplg-interface.h |    3 ++-
 6 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-messages.c b/sound/soc/intel/skylake/skl-messages.c
index 6653b9d..41e5a1a 100644
--- a/sound/soc/intel/skylake/skl-messages.c
+++ b/sound/soc/intel/skylake/skl-messages.c
@@ -1187,7 +1187,8 @@ int skl_create_pipeline(struct skl_sst *ctx, struct skl_pipe *pipe)
 	dev_dbg(ctx->dev, "%s: pipe_id = %d\n", __func__, pipe->ppl_id);
 
 	ret = skl_ipc_create_pipeline(&ctx->ipc, pipe->memory_pages,
-				pipe->pipe_priority, pipe->ppl_id);
+				pipe->pipe_priority, pipe->ppl_id,
+				pipe->lp_mode);
 	if (ret < 0) {
 		dev_err(ctx->dev, "Failed to create pipeline\n");
 		return ret;
diff --git a/sound/soc/intel/skylake/skl-sst-ipc.c b/sound/soc/intel/skylake/skl-sst-ipc.c
index 319b64f..3c54ea2 100644
--- a/sound/soc/intel/skylake/skl-sst-ipc.c
+++ b/sound/soc/intel/skylake/skl-sst-ipc.c
@@ -83,6 +83,10 @@
 #define IPC_INSTANCE_ID(x)		(((x) & IPC_INSTANCE_ID_MASK) \
 					<< IPC_INSTANCE_ID_SHIFT)
 
+#define IPC_PPL_LP_MODE_SHIFT		0
+#define IPC_PPL_LP_MODE_MASK		0x1
+#define IPC_PPL_LP_MODE(x)		(((x) & IPC_PPL_LP_MODE_MASK) \
+					<< IPC_PPL_LP_MODE_SHIFT)
 /* Set pipeline state message */
 #define IPC_PPL_STATE_SHIFT		0
 #define IPC_PPL_STATE_MASK		0x1F
@@ -640,7 +644,7 @@ void skl_ipc_free(struct sst_generic_ipc *ipc)
 }
 
 int skl_ipc_create_pipeline(struct sst_generic_ipc *ipc,
-		u16 ppl_mem_size, u8 ppl_type, u8 instance_id)
+		u16 ppl_mem_size, u8 ppl_type, u8 instance_id, u8 lp_mode)
 {
 	struct skl_ipc_header header = {0};
 	u64 *ipc_header = (u64 *)(&header);
@@ -653,6 +657,8 @@ int skl_ipc_create_pipeline(struct sst_generic_ipc *ipc,
 	header.primary |= IPC_PPL_TYPE(ppl_type);
 	header.primary |= IPC_PPL_MEM_SIZE(ppl_mem_size);
 
+	header.extension = IPC_PPL_LP_MODE(lp_mode);
+
 	dev_dbg(ipc->dev, "In %s header=%d\n", __func__, header.primary);
 	ret = skl_ipc_tx_message(ipc, *ipc_header, NULL, 0, NULL, 0, true,
 			SKL_IPC_DEFAULT_TIMEOUT);
diff --git a/sound/soc/intel/skylake/skl-sst-ipc.h b/sound/soc/intel/skylake/skl-sst-ipc.h
index 8f0aa81..ee4a627 100644
--- a/sound/soc/intel/skylake/skl-sst-ipc.h
+++ b/sound/soc/intel/skylake/skl-sst-ipc.h
@@ -159,7 +159,7 @@ struct skl_log_state_msg {
 irqreturn_t skl_dsp_irq_thread_handler(int irq, void *context);
 
 int skl_ipc_create_pipeline(struct sst_generic_ipc *sst_ipc,
-		u16 ppl_mem_size, u8 ppl_type, u8 instance_id);
+		u16 ppl_mem_size, u8 ppl_type, u8 instance_id, u8 lp_mode);
 
 int skl_ipc_delete_pipeline(struct sst_generic_ipc *sst_ipc, u8 instance_id);
 
diff --git a/sound/soc/intel/skylake/skl-topology.c b/sound/soc/intel/skylake/skl-topology.c
index ab1c647..389313e 100644
--- a/sound/soc/intel/skylake/skl-topology.c
+++ b/sound/soc/intel/skylake/skl-topology.c
@@ -1881,6 +1881,7 @@ static struct skl_pipe *skl_tplg_add_pipe(struct device *dev,
 	pipe->memory_pages = dfw_pipe->memory_pages;
 	pipe->pipe_priority = dfw_pipe->pipe_priority;
 	pipe->conn_type = dfw_pipe->conn_type;
+	pipe->lp_mode = dfw_pipe->lp_mode;
 	pipe->state = SKL_PIPE_INVALID;
 	pipe->p_params = params;
 	INIT_LIST_HEAD(&pipe->w_list);
diff --git a/sound/soc/intel/skylake/skl-topology.h b/sound/soc/intel/skylake/skl-topology.h
index e4a271c..ef106b2 100644
--- a/sound/soc/intel/skylake/skl-topology.h
+++ b/sound/soc/intel/skylake/skl-topology.h
@@ -267,6 +267,7 @@ struct skl_pipe {
 	u8 pipe_priority;
 	u16 conn_type;
 	u32 memory_pages;
+	u8 lp_mode;
 	struct skl_pipe_params *p_params;
 	enum skl_pipe_state state;
 	struct list_head w_list;
diff --git a/sound/soc/intel/skylake/skl-tplg-interface.h b/sound/soc/intel/skylake/skl-tplg-interface.h
index a3e9b5e..cf8a315 100644
--- a/sound/soc/intel/skylake/skl-tplg-interface.h
+++ b/sound/soc/intel/skylake/skl-tplg-interface.h
@@ -196,7 +196,8 @@ struct skl_dfw_pipe {
 	u8 pipe_id;
 	u8 pipe_priority;
 	u16 conn_type:4;
-	u16 rsvd:4;
+	u16 lp_mode:1;
+	u16 rsvd:3;
 	u16 memory_pages:8;
 } __packed;
 
-- 
1.7.5.4

