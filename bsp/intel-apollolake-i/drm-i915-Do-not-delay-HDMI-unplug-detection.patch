From 7dfe4429a9502de69dd6457b670c048b6014e225 Mon Sep 17 00:00:00 2001
From: Shashank Sharma <shashank.sharma@intel.com>
Date: Fri, 15 Jul 2016 15:28:15 -0700
Subject: [PATCH 2060/2508] drm/i915: Do not delay HDMI unplug detection

commit 5d6cb55172c3c1f3803a6a164386362bceedbf45 from
https://github.com/01org/linux-apollolake-i

To work around  the issue that live status register takes
some time to settle we implemented a de-bounce filter in
the hdmi detection code that can take up to 80ms to detect
a successful plug-in detection.

The way this was implement meant that upon an unplug event
the driver would always take 80ms to detect it. This long delay
is causing us to fail a HDMI conformance test that requires that
the port be taken down within 100ms of an unplug.

The solution is to report the unplug event straight way when we
know that the connector was plugged in, thus giving the rest of the
driver the maximum amount we can to meet the 100ms conformance
requirement.

V2: Addressed review comments by Raf
	- Replace the commit message with the suggested one
	- Change the comment
	- Fix the pre-increment in while loop

Signed-off-by: Shashank Sharma <shashank.sharma@intel.com>
Reviewed-by: Rafael Barbalho <rafael.barbalho@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/intel_hdmi.c |   19 +++++++++++++++----
 1 files changed, 15 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_hdmi.c b/drivers/gpu/drm/i915/intel_hdmi.c
index e2dab48..9622b14 100644
--- a/drivers/gpu/drm/i915/intel_hdmi.c
+++ b/drivers/gpu/drm/i915/intel_hdmi.c
@@ -1398,18 +1398,29 @@ intel_hdmi_detect(struct drm_connector *connector, bool force)
 	struct intel_hdmi *intel_hdmi = intel_attached_hdmi(connector);
 	struct drm_i915_private *dev_priv = to_i915(connector->dev);
 	bool live_status = false;
-	unsigned int try;
+	unsigned int try = 0;
 
 	DRM_DEBUG_KMS("[CONNECTOR:%d:%s]\n",
 		      connector->base.id, connector->name);
 
 	intel_display_power_get(dev_priv, POWER_DOMAIN_GMBUS);
 
-	for (try = 0; !live_status && try < 9; try++) {
-		if (try)
+	live_status = intel_digital_port_connected(dev_priv,
+		hdmi_to_dig_port(intel_hdmi));
+
+	/*
+	 * During a HDMI plug-in, the live status register can take a
+	 * while to get stable, thus we sample it for upto 80ms to
+	 * make sure we get its right status. However, on an unplug
+	 * we must report it straight away in order to pass HDCP
+	 * compliance test.
+	 */
+	if (connector->status != connector_status_connected) {
+		while (!live_status && try++ < 8) {
 			msleep(10);
-		live_status = intel_digital_port_connected(dev_priv,
+			live_status = intel_digital_port_connected(dev_priv,
 				hdmi_to_dig_port(intel_hdmi));
+		}
 	}
 
 	if (!live_status)
-- 
1.7.5.4

