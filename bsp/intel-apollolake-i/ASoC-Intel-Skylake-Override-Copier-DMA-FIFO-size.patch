From b4fd4bd8251c15d0f7e5aa6fd3d557a6c9362ae9 Mon Sep 17 00:00:00 2001
From: Jayachandran B <jayachandran.b@intel.com>
Date: Wed, 13 Jan 2016 20:23:36 +0530
Subject: [PATCH 1849/2508] ASoC: Intel: Skylake: Override Copier DMA FIFO
 size

commit bdc043d6eadebad5c08e7e5b492e73461fd97cc0 from
https://github.com/01org/linux-apollolake-i

The DMA FIFO sizes should ideally be taken from the
topology binary. Instead, Override the copier DMA FIFO
size to correspond to 2ms for normal streams and 50ms
for deepbuffer streams.

Also provide a module parameter to tune the FIFO size of
deep buffer streams. This tuning will be done for D0i3
(and hence S0ix) residency and then the value will be
set in topology binary.

Change-Id: I324c498886e42bd597a31fdfec5f15a38780c253
Signed-off-by: Jayachandran B <jayachandran.b@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/7982
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
---
 sound/soc/intel/skylake/skl-messages.c |    8 ++++++--
 sound/soc/intel/skylake/skl-pcm.c      |   21 ++++++++++++++++++++-
 sound/soc/intel/skylake/skl-topology.h |    1 +
 3 files changed, 27 insertions(+), 3 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-messages.c b/sound/soc/intel/skylake/skl-messages.c
index 2668bcb..c9968ba 100644
--- a/sound/soc/intel/skylake/skl-messages.c
+++ b/sound/soc/intel/skylake/skl-messages.c
@@ -413,6 +413,7 @@ static void skl_setup_cpr_gateway_cfg(struct skl_sst *ctx,
 	union skl_connector_node_id node_id = {0};
 	union skl_ssp_dma_node ssp_node  = {0};
 	struct skl_pipe_params *params = mconfig->pipe->p_params;
+	int dma_buf_dur_ms = 2; /* Default 2 ms */
 
 	switch (mconfig->dev_type) {
 	case SKL_DEVICE_BT:
@@ -454,6 +455,7 @@ static void skl_setup_cpr_gateway_cfg(struct skl_sst *ctx,
 			SKL_DMA_HDA_HOST_OUTPUT_CLASS :
 			SKL_DMA_HDA_HOST_INPUT_CLASS;
 		node_id.node.vindex = params->host_dma_id;
+		dma_buf_dur_ms = mconfig->dma_buf_dur_ms;
 		break;
 
 	default:
@@ -465,9 +467,11 @@ static void skl_setup_cpr_gateway_cfg(struct skl_sst *ctx,
 	cpr_mconfig->gtw_cfg.node_id = node_id.val;
 
 	if (SKL_CONN_SOURCE == mconfig->hw_conn_type)
-		cpr_mconfig->gtw_cfg.dma_buffer_size = 2 * mconfig->obs;
+		cpr_mconfig->gtw_cfg.dma_buffer_size =
+			dma_buf_dur_ms * mconfig->obs;
 	else
-		cpr_mconfig->gtw_cfg.dma_buffer_size = 2 * mconfig->ibs;
+		cpr_mconfig->gtw_cfg.dma_buffer_size =
+			dma_buf_dur_ms * mconfig->ibs;
 
 	cpr_mconfig->cpr_feature_mask = mconfig->fast_mode;
 	cpr_mconfig->gtw_cfg.config_length  = 0;
diff --git a/sound/soc/intel/skylake/skl-pcm.c b/sound/soc/intel/skylake/skl-pcm.c
index 1879afc..e275314 100644
--- a/sound/soc/intel/skylake/skl-pcm.c
+++ b/sound/soc/intel/skylake/skl-pcm.c
@@ -22,6 +22,7 @@
 #include <linux/pci.h>
 #include <linux/pm_runtime.h>
 #include <linux/firmware.h>
+#include <linux/moduleparam.h>
 #include <sound/pcm_params.h>
 #include <sound/soc.h>
 #include "skl.h"
@@ -34,6 +35,10 @@
 #define HDA_QUAD 4
 #define HDA_8_CH 8
 
+/* FIFO size in ms for Deepbuffer */
+static int dpb_fifo_ms = 30;
+module_param(dpb_fifo_ms, int, 0644);
+
 static struct snd_pcm_hardware azx_pcm_hw = {
 	.info =			(SNDRV_PCM_INFO_MMAP |
 				 SNDRV_PCM_INFO_INTERLEAVED |
@@ -247,6 +252,18 @@ static int skl_pcm_prepare(struct snd_pcm_substream *substream,
 	return err;
 }
 
+static void skl_set_cpr_gtw_dma_fifo_size(struct snd_soc_dai *dai,
+		struct skl_module_cfg *m_cfg)
+{
+	if (!strncmp(dai->name, "Deepbuffer Pin", 14))
+		m_cfg->dma_buf_dur_ms = dpb_fifo_ms;
+	else
+		m_cfg->dma_buf_dur_ms = 2;
+
+	dev_dbg(dai->dev, "Setting copier FIFO size =%d for Dai %s\n",
+			m_cfg->dma_buf_dur_ms, dai->name);
+}
+
 static int skl_pcm_hw_params(struct snd_pcm_substream *substream,
 				struct snd_pcm_hw_params *params,
 				struct snd_soc_dai *dai)
@@ -277,8 +294,10 @@ static int skl_pcm_hw_params(struct snd_pcm_substream *substream,
 	p_params.stream = substream->stream;
 
 	m_cfg = skl_tplg_fe_get_cpr_module(dai, p_params.stream);
-	if (m_cfg)
+	if (m_cfg) {
+		skl_set_cpr_gtw_dma_fifo_size(dai, m_cfg);
 		skl_tplg_update_pipe_params(dai->dev, m_cfg, &p_params);
+	}
 
 	return 0;
 }
diff --git a/sound/soc/intel/skylake/skl-topology.h b/sound/soc/intel/skylake/skl-topology.h
index e8e456a..ed35649 100644
--- a/sound/soc/intel/skylake/skl-topology.h
+++ b/sound/soc/intel/skylake/skl-topology.h
@@ -287,6 +287,7 @@ struct skl_module_cfg {
 	u32 mem_pages;
 	u32 fast_mode;
 	u32 frame_size;
+	u32 dma_buf_dur_ms;
 	struct skl_module_pin *m_in_pin;
 	struct skl_module_pin *m_out_pin;
 	enum skl_module_type m_type;
-- 
1.7.5.4

