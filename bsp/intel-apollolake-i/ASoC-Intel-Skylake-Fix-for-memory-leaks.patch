From 49862f680f8e7534168049704e13adb53de87e86 Mon Sep 17 00:00:00 2001
From: Senthilnathan Veppur <senthilnathanx.veppur@intel.com>
Date: Mon, 19 Oct 2015 16:14:07 +0530
Subject: [PATCH 1778/2508] ASoC: Intel: Skylake: Fix for memory leaks

commit 834d0b7a3edfe9fe8708c1900758e1a3155af266 from
https://github.com/01org/linux-apollolake-i

...also fixes null error checks.

Change-Id: Id9fe133cce3ce02a375c6f87bc5ce58ae9e672c1
Signed-off-by: Senthilnathan Veppur <senthilnathanx.veppur@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/7050
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/7520
---
 sound/soc/intel/common/sst-ipc.c       |    2 +-
 sound/soc/intel/skylake/skl-debug.c    |    4 ++--
 sound/soc/intel/skylake/skl-messages.c |   19 +++++++++++--------
 sound/soc/intel/skylake/skl-topology.c |    1 +
 sound/soc/intel/skylake/skl.h          |    2 +-
 5 files changed, 16 insertions(+), 12 deletions(-)

diff --git a/sound/soc/intel/common/sst-ipc.c b/sound/soc/intel/common/sst-ipc.c
index 211825b..58a6343 100644
--- a/sound/soc/intel/common/sst-ipc.c
+++ b/sound/soc/intel/common/sst-ipc.c
@@ -211,7 +211,7 @@ struct ipc_message *sst_ipc_reply_find_msg(struct sst_generic_ipc *ipc,
 	u64 header)
 {
 	struct ipc_message *msg;
-	u64 mask;
+	u64 mask = 0x0;
 
 	if (ipc->ops.reply_msg_match != NULL)
 		header = ipc->ops.reply_msg_match(header, &mask);
diff --git a/sound/soc/intel/skylake/skl-debug.c b/sound/soc/intel/skylake/skl-debug.c
index 8bf9f50..5d20ba2f 100644
--- a/sound/soc/intel/skylake/skl-debug.c
+++ b/sound/soc/intel/skylake/skl-debug.c
@@ -176,10 +176,10 @@ static int skl_init_nhlt(struct skl_debug *d)
 	}
 
 	for (i = 0; i < MAX_SSP; i++) {
-		sprintf(name, "ssp%dp", i);
+		snprintf(name, (sizeof(name)-1),"ssp%dp", i);
 		if (!debugfs_create_file(name, 0644, d->nhlt, &d->ssp_blob[i], &nhlt_fops))
 			dev_err(d->dev, "%s: debugfs init failed\n", name);
-		sprintf(name, "ssp%dc", i);
+		snprintf(name, (sizeof(name)-1),"ssp%dc", i);
 		if (!debugfs_create_file(name, 0644, d->nhlt, &d->ssp_blob[MAX_SSP + i], &nhlt_fops))
 			dev_err(d->dev, "%s: debugfs init failed\n", name);
 	}
diff --git a/sound/soc/intel/skylake/skl-messages.c b/sound/soc/intel/skylake/skl-messages.c
index 915296a..5462be4 100644
--- a/sound/soc/intel/skylake/skl-messages.c
+++ b/sound/soc/intel/skylake/skl-messages.c
@@ -129,13 +129,13 @@ static int skl_dsp_prepare(struct device *dev, unsigned int format,
 static int skl_dsp_trigger(struct device *dev, bool start, int stream_tag)
 {
 	struct hdac_ext_bus *ebus = dev_get_drvdata(dev);
+	struct hdac_stream *stream;
 	struct hdac_bus *bus = ebus_to_hbus(ebus);
-	struct hdac_stream *stream = snd_hdac_get_hdac_stream(bus,
-					SNDRV_PCM_STREAM_PLAYBACK, stream_tag);
-
 	if (!bus)
 		return -ENODEV;
 
+	stream = snd_hdac_get_hdac_stream(bus,
+					SNDRV_PCM_STREAM_PLAYBACK, stream_tag);
 	if (!stream)
 		return -EINVAL;
 
@@ -148,14 +148,14 @@ static int skl_dsp_cleanup(struct device *dev, struct snd_dma_buffer *dmab,
 								int stream_tag)
 {
 	struct hdac_ext_bus *ebus = dev_get_drvdata(dev);
-	struct hdac_bus *bus = ebus_to_hbus(ebus);
+	struct hdac_stream *stream;
 	struct hdac_ext_stream *estream;
-	struct hdac_stream *stream = snd_hdac_get_hdac_stream(bus,
-					SNDRV_PCM_STREAM_PLAYBACK, stream_tag);
-
+	struct hdac_bus *bus = ebus_to_hbus(ebus);
 	if (!bus)
 		return -ENODEV;
 
+	stream = snd_hdac_get_hdac_stream(bus,
+					SNDRV_PCM_STREAM_PLAYBACK, stream_tag);
 	if (!stream)
 		return -EINVAL;
 
@@ -171,6 +171,7 @@ static int skl_dsp_cleanup(struct device *dev, struct snd_dma_buffer *dmab,
 static struct skl_dsp_loader_ops skl_get_loader_ops(void)
 {
 	struct skl_dsp_loader_ops loader_ops;
+	memset(&loader_ops,0,sizeof(struct skl_dsp_loader_ops));
 
 	loader_ops.alloc_dma_buf = skl_alloc_dma_buf;
 	loader_ops.free_dma_buf = skl_free_dma_buf;
@@ -181,6 +182,7 @@ static struct skl_dsp_loader_ops skl_get_loader_ops(void)
 static struct skl_dsp_loader_ops bxt_get_loader_ops(void)
 {
 	struct skl_dsp_loader_ops loader_ops;
+	memset(&loader_ops,0,sizeof(struct skl_dsp_loader_ops));
 
 	loader_ops.alloc_dma_buf = skl_alloc_dma_buf;
 	loader_ops.free_dma_buf = skl_free_dma_buf;
@@ -246,7 +248,7 @@ int skl_init_dsp(struct skl *skl)
 	return ret;
 }
 
-void skl_free_dsp(struct skl *skl)
+int skl_free_dsp(struct skl *skl)
 {
 	struct hdac_ext_bus *ebus = &skl->ebus;
 	struct hdac_bus *bus = ebus_to_hbus(ebus);
@@ -264,6 +266,7 @@ void skl_free_dsp(struct skl *skl)
 
 	if (ctx->dsp->addr.lpe)
 		iounmap(ctx->dsp->addr.lpe);
+	return 0;
 }
 
 int skl_suspend_dsp(struct skl *skl)
diff --git a/sound/soc/intel/skylake/skl-topology.c b/sound/soc/intel/skylake/skl-topology.c
index 43a6343..6f47729 100644
--- a/sound/soc/intel/skylake/skl-topology.c
+++ b/sound/soc/intel/skylake/skl-topology.c
@@ -1515,6 +1515,7 @@ int skl_tplg_init(struct snd_soc_platform *platform, struct hdac_ext_bus *ebus)
 					&skl_tplg_ops, fw, 0);
 	if (ret < 0) {
 		dev_err(bus->dev, "tplg component load failed%d\n", ret);
+		release_firmware(fw);
 		return -EINVAL;
 	}
 
diff --git a/sound/soc/intel/skylake/skl.h b/sound/soc/intel/skylake/skl.h
index adfdbf3..c43e0f9 100644
--- a/sound/soc/intel/skylake/skl.h
+++ b/sound/soc/intel/skylake/skl.h
@@ -104,7 +104,7 @@ struct nhlt_specific_cfg *skl_get_ep_blob(struct skl *skl, u32 instance,
 			u8 link_type, u8 s_fmt, u8 no_ch, u32 s_rate, u8 dirn);
 
 int skl_init_dsp(struct skl *skl);
-void skl_free_dsp(struct skl *skl);
+int skl_free_dsp(struct skl *skl);
 int skl_suspend_dsp(struct skl *skl);
 int skl_resume_dsp(struct skl *skl);
 
-- 
1.7.5.4

