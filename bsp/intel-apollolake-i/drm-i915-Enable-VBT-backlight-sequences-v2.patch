From 4f91d16e705761588b638a504df4433ca161066e Mon Sep 17 00:00:00 2001
From: Uma Shankar <uma.shankar@intel.com>
Date: Tue, 20 Dec 2016 10:24:33 -0800
Subject: [PATCH 4462/4706] drm/i915: Enable VBT backlight sequences (v2)

commit f76f69e19cd670ad1dafb7e1a5ffdb193b8734ba from
git://git.yoctoproject.org/linux-yocto-4.1

Enable the support for backlight sequences to configure
backlight settings based on VBT Backlight on/off sequence.

v2: rebased on IOTG release (Bob)

Signed-off-by: Uma Shankar <uma.shankar@intel.com>
Signed-off-by: Deepak M <m.deepak@intel.com>
Signed-off-by: Bob Paauwe <bob.j.paauwe@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/intel_dsi.c           |   10 +++++++++-
 drivers/gpu/drm/i915/intel_dsi_panel_vbt.c |   18 ++++++++++++++++--
 include/drm/drm_panel.h                    |    2 ++
 3 files changed, 27 insertions(+), 3 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_dsi.c b/drivers/gpu/drm/i915/intel_dsi.c
index c4b0948..508b43c 100644
--- a/drivers/gpu/drm/i915/intel_dsi.c
+++ b/drivers/gpu/drm/i915/intel_dsi.c
@@ -534,6 +534,10 @@ static void intel_dsi_enable(struct intel_encoder *encoder)
 	}
 
 	intel_panel_enable_backlight(intel_dsi->attached_connector);
+
+	if (intel_dsi->panel && intel_dsi->panel->funcs &&
+	    intel_dsi->panel->funcs->backlight_on)
+		intel_dsi->panel->funcs->backlight_on(intel_dsi->panel);
 }
 
 static void intel_dsi_prepare(struct intel_encoder *intel_encoder,
@@ -625,7 +629,11 @@ static void intel_dsi_pre_disable(struct intel_encoder *encoder,
 
 	DRM_DEBUG_KMS("\n");
 
-	intel_panel_disable_backlight(intel_dsi->attached_connector);
+	if (intel_dsi->panel && intel_dsi->panel->funcs &&
+			intel_dsi->panel->funcs->backlight_off)
+		intel_panel_disable_backlight(intel_dsi->attached_connector);
+
+	intel_dsi->panel->funcs->backlight_off(intel_dsi->panel);
 
 	/*
 	 * Disable Device ready before the port shutdown in order
diff --git a/drivers/gpu/drm/i915/intel_dsi_panel_vbt.c b/drivers/gpu/drm/i915/intel_dsi_panel_vbt.c
index 57fc2c8..72dffa6 100644
--- a/drivers/gpu/drm/i915/intel_dsi_panel_vbt.c
+++ b/drivers/gpu/drm/i915/intel_dsi_panel_vbt.c
@@ -507,14 +507,12 @@ static int vbt_panel_unprepare(struct drm_panel *panel)
 static int vbt_panel_enable(struct drm_panel *panel)
 {
 	generic_exec_sequence(panel, MIPI_SEQ_DISPLAY_ON);
-	generic_exec_sequence(panel, MIPI_SEQ_BACKLIGHT_ON);
 
 	return 0;
 }
 
 static int vbt_panel_disable(struct drm_panel *panel)
 {
-	generic_exec_sequence(panel, MIPI_SEQ_BACKLIGHT_OFF);
 	generic_exec_sequence(panel, MIPI_SEQ_DISPLAY_OFF);
 
 	return 0;
@@ -564,6 +562,20 @@ static int vbt_panel_reset(struct drm_panel *panel)
 	return 0;
 }
 
+static int vbt_panel_backlight_on(struct drm_panel *panel)
+{
+	generic_exec_sequence(panel, MIPI_SEQ_BACKLIGHT_ON);
+
+	return 0;
+}
+
+static int vbt_panel_backlight_off(struct drm_panel *panel)
+{
+	generic_exec_sequence(panel, MIPI_SEQ_BACKLIGHT_OFF);
+
+	return 0;
+}
+
 static const struct drm_panel_funcs vbt_panel_funcs = {
 	.disable = vbt_panel_disable,
 	.unprepare = vbt_panel_unprepare,
@@ -573,6 +585,8 @@ static const struct drm_panel_funcs vbt_panel_funcs = {
 	.power_off = vbt_panel_power_off,
 	.enable = vbt_panel_enable,
 	.get_modes = vbt_panel_get_modes,
+	.backlight_on = vbt_panel_backlight_on,
+	.backlight_off = vbt_panel_backlight_off,
 };
 
 struct drm_panel *vbt_panel_init(struct intel_dsi *intel_dsi, u16 panel_id)
diff --git a/include/drm/drm_panel.h b/include/drm/drm_panel.h
index e808d34..2509a37 100644
--- a/include/drm/drm_panel.h
+++ b/include/drm/drm_panel.h
@@ -74,6 +74,8 @@ struct drm_panel_funcs {
 	int (*power_off)(struct drm_panel *panel);
 	int (*enable)(struct drm_panel *panel);
 	int (*get_modes)(struct drm_panel *panel);
+	int (*backlight_on)(struct drm_panel *panel);
+	int (*backlight_off)(struct drm_panel *panel);
 	int (*get_timings)(struct drm_panel *panel, unsigned int num_timings,
 			   struct display_timing *timings);
 };
-- 
1.7.5.4

