From c194cf86f7b6bf6edcbf7d589b67c61382fbf0a2 Mon Sep 17 00:00:00 2001
From: Yael Samet <yael.samet@intel.com>
Date: Tue, 27 Dec 2016 10:54:12 +0200
Subject: [PATCH 4654/4706] mei: dal: return error if the msg first fragment
 isn't hdr

commit 13fb6c51edce06acef392e69b0da58800448e1f8 from
git://git.yoctoproject.org/linux-yocto-4.1

In write function, when getting the first fragment we send the
hdr to "filter" function to validate tht the a msg is proper.
We didn't checked that indeed we have hdr at the first fragment,
so we had a NULL ptr bug when we got inproper msg.

Change-Id: I819544f01ef308888445e1b6a08e2430769ece0a
Signed-off-by: Yael Samet <yael.samet@intel.com>
Signed-off-by: Tomas Winkler <tomas.winkler@intel.com>
---
 drivers/misc/mei/dal/dal_class.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/drivers/misc/mei/dal/dal_class.c b/drivers/misc/mei/dal/dal_class.c
index 8903aa5..92de3d9 100644
--- a/drivers/misc/mei/dal/dal_class.c
+++ b/drivers/misc/mei/dal/dal_class.c
@@ -248,7 +248,11 @@ ssize_t dal_write(struct dal_client *dc, size_t count, u64 seq)
 		const struct bhp_command_header *hdr;
 
 		hdr = bh_msg_cmd_hdr(dc->write_buffer, count);
-
+		if (!hdr) {
+			dev_err(dev, "expected cmd hdr at first fragment\n");
+			ret = -EINVAL;
+			goto out;
+		}
 		ret = bh_filter_hdr(hdr, count, dc, dal_write_filter_tbl);
 		if (ret == -EPERM) {
 			ret = dal_send_error_access_denied(dc);
-- 
1.7.5.4

