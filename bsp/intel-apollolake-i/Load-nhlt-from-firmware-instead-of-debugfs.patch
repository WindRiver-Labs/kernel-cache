From 2172f42715a5eac801e79627334d868c6324a29d Mon Sep 17 00:00:00 2001
From: Guneshwor Singh <guneshwor.o.singh@intel.com>
Date: Thu, 14 Apr 2016 12:02:14 +0530
Subject: [PATCH 2140/2508] Load nhlt from firmware instead of debugfs

commit 7d822bbb7a6e2a78e962c0cf19a146ba4d713e17 from
https://github.com/01org/linux-apollolake-i

Change-Id: I316804db785699f28359b35455790c95cccacd10
Signed-off-by: Guneshwor Singh <guneshwor.o.singh@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/8855
Reviewed-by: Shah, Hardik T <hardik.t.shah@intel.com>
Tested-by: Shah, Hardik T <hardik.t.shah@intel.com>
[Kevin: Just some minor context changes in order to port to wrlinux]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 sound/soc/intel/skylake/skl.c |   15 +++++++++++++++
 1 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/sound/soc/intel/skylake/skl.c b/sound/soc/intel/skylake/skl.c
index 6794ef0..24f48da 100644
--- a/sound/soc/intel/skylake/skl.c
+++ b/sound/soc/intel/skylake/skl.c
@@ -26,6 +26,7 @@
 #include <linux/pm_runtime.h>
 #include <linux/platform_device.h>
 #include <linux/delay.h>
+#include <linux/firmware.h>
 #include <sound/pcm.h>
 #include <sound/hda_register.h>
 #include <sound/hdaudio.h>
@@ -785,6 +786,7 @@ static int skl_probe(struct pci_dev *pci,
 	struct hdac_ext_bus *ebus = NULL;
 	struct hdac_bus *bus = NULL;
 	struct hdac_ext_link *hlink = NULL;
+	const struct firmware *nhlt_fw = NULL;
 	int err;
 
 	/* we use ext core ops, so provide NULL for ops here */
@@ -807,6 +809,19 @@ static int skl_probe(struct pci_dev *pci,
 	if (skl->nhlt == NULL)
 		goto out_free;
 #endif
+
+#ifdef CONFIG_SND_SOC_INTEL_CNL_FPGA
+	if (0 > request_firmware(&nhlt_fw, "intel/nhlt_blob.bin", bus->dev)) {
+		dev_err(bus->dev, "Request nhlt firmware failed!\n");
+		goto out_free;
+	}
+
+	skl->nhlt = devm_kzalloc(&pci->dev, nhlt_fw->size, GFP_KERNEL);
+	if (skl->nhlt == NULL)
+		return -ENOMEM;
+	memcpy(skl->nhlt, nhlt_fw->data, nhlt_fw->size);
+#endif
+
 	pci_set_drvdata(skl->pci, ebus);
 
 	/* check if dsp is there */
-- 
1.7.5.4

