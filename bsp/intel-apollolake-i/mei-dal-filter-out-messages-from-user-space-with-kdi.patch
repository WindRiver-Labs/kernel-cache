From 69e3f737e45148a114890d58ba6ef92a5a55cce1 Mon Sep 17 00:00:00 2001
From: Yael Samet <yael.samet@intel.com>
Date: Tue, 8 Nov 2016 07:56:40 +0200
Subject: [PATCH 4643/4706] mei: dal: filter out messages from user space with
 kdi sequence numbers

commit 7eaa29ac2e49aa82430ae61b99d291cd256a10a9 from
git://git.yoctoproject.org/linux-yocto-4.1

Avoid sending a message from user space interface
with sequence in range of a kernel space sessions.

Change-Id: Iaea22d20e0d4af088a8a268f5c3762fe9a14afa7
Signed-off-by: Yael Samet <yael.samet@intel.com>
Signed-off-by: Tomas Winkler <tomas.winkler@intel.com>
---
 drivers/misc/mei/dal/bhp_impl.h    |    3 +++
 drivers/misc/mei/dal/bhp_impl_ta.c |   11 +++++++++++
 drivers/misc/mei/dal/dal_class.c   |   11 +++++++++++
 3 files changed, 25 insertions(+), 0 deletions(-)

diff --git a/drivers/misc/mei/dal/bhp_impl.h b/drivers/misc/mei/dal/bhp_impl.h
index 9d2b331..c92e2e8 100644
--- a/drivers/misc/mei/dal/bhp_impl.h
+++ b/drivers/misc/mei/dal/bhp_impl.h
@@ -188,6 +188,9 @@ const uuid_be *bh_open_session_ta_id(const char *hdr, size_t count);
 void bh_prep_access_denied_response(const char *cmd,
 				    struct bhp_response_header *res);
 
+/* true when sequence is in kernel space seq range */
+bool bh_is_kdi_hdr(const char *msg);
+
 bool bh_msg_is_response(const char *hdr);
 bool bh_msg_is_spooler(const char *hdr);
 bool bh_msg_is_cmd(const char *hdr);
diff --git a/drivers/misc/mei/dal/bhp_impl_ta.c b/drivers/misc/mei/dal/bhp_impl_ta.c
index a61ea1b..801abd4 100644
--- a/drivers/misc/mei/dal/bhp_impl_ta.c
+++ b/drivers/misc/mei/dal/bhp_impl_ta.c
@@ -708,3 +708,14 @@ void bh_prep_access_denied_response(const char *cmd,
 	res->seq = cmd_hdr->seq;
 }
 
+bool bh_is_kdi_hdr(const char *msg)
+{
+	const struct bhp_command_header *cmd_hdr;
+
+	if (!bh_msg_is_cmd(msg))
+		return 0;
+
+	cmd_hdr = (const struct bhp_command_header *)msg;
+
+	return cmd_hdr->seq >= MSG_SEQ_START_NUMBER;
+}
diff --git a/drivers/misc/mei/dal/dal_class.c b/drivers/misc/mei/dal/dal_class.c
index 52361ea..c46af6c 100644
--- a/drivers/misc/mei/dal/dal_class.c
+++ b/drivers/misc/mei/dal/dal_class.c
@@ -203,8 +203,19 @@ static int dal_validate_access(const char *msg, size_t count, void *ctx)
 	return dal_access_policy_allowed(ddev, *ta_id, dc);
 }
 
+static int dal_validate_seq(const char *msg, size_t count, void *ctx)
+{
+	struct dal_client *dc = ctx;
+
+	if (dc->intf != DAL_INTF_KDI && bh_is_kdi_hdr(msg))
+		return -EPERM;
+
+	return 0;
+}
+
 static const bh_filter_func dal_write_filter_tbl[] = {
 	dal_validate_access,
+	dal_validate_seq,
 	NULL,
 };
 
-- 
1.7.5.4

