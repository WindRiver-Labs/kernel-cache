From b3e7a769b9c88676775e9306704cae5b87876a43 Mon Sep 17 00:00:00 2001
From: Jayachandran B <jayachandran.b@intel.com>
Date: Wed, 30 Dec 2015 18:24:00 +0530
Subject: [PATCH 1862/2508] ASoC: Intel: Skylake: Do explicit cache flush for
 audio buffers

commit d93a6ea3548a5ec2f2e77c1f15220cc3c708f0ba from
https://github.com/01org/linux-apollolake-i

Though audio buffers were specified as uncached, there was noise
in playback/capture indicating issue with cache flush.
Explicit cache flusing fixed the noise.

Change-Id: I2e1afd60e8091ccbc6c72b02bf75fa2fd92aa6d5
Signed-off-by: Jayachandran B <jayachandran.b@intel.com>
Tracked-On: https://jira01.devtools.intel.com/browse/OAM-15919
Signed-off-by: Andy Ross <andrew.j.ross@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/8273
Reviewed-by: Babu, Ramesh <ramesh.babu@intel.com>
Tested-by: Babu, Ramesh <ramesh.babu@intel.com>
---
 sound/soc/intel/skylake/skl-pcm.c |   12 ++++++++++--
 1 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-pcm.c b/sound/soc/intel/skylake/skl-pcm.c
index 5868c78..d7903bc 100644
--- a/sound/soc/intel/skylake/skl-pcm.c
+++ b/sound/soc/intel/skylake/skl-pcm.c
@@ -25,6 +25,7 @@
 #include <linux/moduleparam.h>
 #include <sound/pcm_params.h>
 #include <sound/soc.h>
+#include <asm/cacheflush.h>
 #include "skl.h"
 #include "skl-topology.h"
 #include "skl-sst-ipc.h"
@@ -1211,9 +1212,16 @@ static snd_pcm_uframes_t skl_platform_pcm_pointer
 			(struct snd_pcm_substream *substream)
 {
 	struct hdac_ext_stream *hstream = get_hdac_ext_stream(substream);
+	struct snd_dma_buffer *dmab;
+	int ret;
+
+	ret = bytes_to_frames(substream->runtime,
+			skl_get_position(hstream, 0));
 
-	return bytes_to_frames(substream->runtime,
-			       skl_get_position(hstream, 0));
+	dmab = snd_pcm_get_dma_buf(substream);
+	clflush_cache_range(dmab->area, dmab->bytes);
+
+	return ret;
 }
 
 static u64 skl_adjust_codec_delay(struct snd_pcm_substream *substream,
-- 
1.7.5.4

