From 98c05662d446258911e5fe58c220b416a7c0a373 Mon Sep 17 00:00:00 2001
From: "Chokshi, Mitul" <mitul.chokshi@intel.com>
Date: Tue, 1 Dec 2015 09:38:28 -0800
Subject: [PATCH 1242/2508] drm/i915: Add support to invert polarity of HPD
 sense signal (v2)

commit a5cb29019a8cf1140019f180b3c0d025604a69c2 from
https://github.com/01org/linux-apollolake-i

Added a parameter hpd_sense_invert in i915 driver to support changing
the polarity of hotplug detect signal.

v2: changed hpd_sense_invert default value to -1 for "use whatever is
already set"

Signed-off-by: Mitul Chokshi <mitul.chokshi@intel.com>
Reviewed-by: Matt Roper <matthew.d.roper@intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
---
 drivers/gpu/drm/i915/i915_irq.c    |    9 +++++++++
 drivers/gpu/drm/i915/i915_params.c |    4 ++++
 drivers/gpu/drm/i915/i915_params.h |    1 +
 drivers/gpu/drm/i915/i915_reg.h    |    3 +++
 4 files changed, 17 insertions(+), 0 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_irq.c b/drivers/gpu/drm/i915/i915_irq.c
index a926330..fd0559f 100644
--- a/drivers/gpu/drm/i915/i915_irq.c
+++ b/drivers/gpu/drm/i915/i915_irq.c
@@ -3499,6 +3499,15 @@ static void bxt_hpd_irq_setup(struct drm_device *dev)
 	hotplug = I915_READ(PCH_PORT_HOTPLUG);
 	hotplug |= PORTC_HOTPLUG_ENABLE | PORTB_HOTPLUG_ENABLE |
 		PORTA_HOTPLUG_ENABLE;
+	if(i915.hpd_sense_invert == 1) {
+		hotplug |= PORTC_HOTPLUG_SENSE_INVERT |
+			PORTB_HOTPLUG_SENSE_INVERT |
+			PORTA_HOTPLUG_SENSE_INVERT;
+	} else if(i915.hpd_sense_invert == 0) {
+		hotplug &= ~(PORTC_HOTPLUG_SENSE_INVERT |
+			PORTB_HOTPLUG_SENSE_INVERT |
+			PORTA_HOTPLUG_SENSE_INVERT);
+	}
 	I915_WRITE(PCH_PORT_HOTPLUG, hotplug);
 }
 
diff --git a/drivers/gpu/drm/i915/i915_params.c b/drivers/gpu/drm/i915/i915_params.c
index 1779f02..800b67f 100644
--- a/drivers/gpu/drm/i915/i915_params.c
+++ b/drivers/gpu/drm/i915/i915_params.c
@@ -58,6 +58,7 @@ struct i915_params i915 __read_mostly = {
 	.guc_log_level = -1,
 	.enable_dp_mst = true,
 	.inject_load_failure = 0,
+	.hpd_sense_invert = -1,
 };
 
 module_param_named(modeset, i915.modeset, int, 0400);
@@ -210,3 +211,6 @@ MODULE_PARM_DESC(enable_dp_mst,
 module_param_named_unsafe(inject_load_failure, i915.inject_load_failure, uint, 0400);
 MODULE_PARM_DESC(inject_load_failure,
 	"Force an error after a number of failure check points (0:disabled (default), N:force failure at the Nth failure check point)");
+module_param_named_unsafe(hpd_sense_invert, i915.hpd_sense_invert, int, 0400);
+MODULE_PARM_DESC(hpd_sense_invert,
+		 "Invert HPD sense (-1=auto [default], 1=Invert, 0=Do not invert)");
diff --git a/drivers/gpu/drm/i915/i915_params.h b/drivers/gpu/drm/i915/i915_params.h
index 02bc278..906ae0d 100644
--- a/drivers/gpu/drm/i915/i915_params.h
+++ b/drivers/gpu/drm/i915/i915_params.h
@@ -50,6 +50,7 @@ struct i915_params {
 	int mmio_debug;
 	int edp_vswing;
 	unsigned int inject_load_failure;
+	int hpd_sense_invert;
 	/* leave bools at the end to not create holes */
 	bool enable_hangcheck;
 	bool fastboot;
diff --git a/drivers/gpu/drm/i915/i915_reg.h b/drivers/gpu/drm/i915/i915_reg.h
index 7e92c6c..2841fdd 100644
--- a/drivers/gpu/drm/i915/i915_reg.h
+++ b/drivers/gpu/drm/i915/i915_reg.h
@@ -6195,6 +6195,7 @@ enum skl_disp_power_wells {
 /* digital port hotplug */
 #define PCH_PORT_HOTPLUG		_MMIO(0xc4030)	/* SHOTPLUG_CTL */
 #define  PORTA_HOTPLUG_ENABLE		(1 << 28) /* LPT:LP+ & BXT */
+#define  PORTA_HOTPLUG_SENSE_INVERT	(1 << 27) /* LPT:LP+ & BXT */
 #define  PORTA_HOTPLUG_STATUS_MASK	(3 << 24) /* SPT+ & BXT */
 #define  PORTA_HOTPLUG_NO_DETECT	(0 << 24) /* SPT+ & BXT */
 #define  PORTA_HOTPLUG_SHORT_DETECT	(1 << 24) /* SPT+ & BXT */
@@ -6210,6 +6211,7 @@ enum skl_disp_power_wells {
 #define  PORTD_HOTPLUG_SHORT_DETECT	(1 << 16)
 #define  PORTD_HOTPLUG_LONG_DETECT	(2 << 16)
 #define  PORTC_HOTPLUG_ENABLE		(1 << 12)
+#define  PORTC_HOTPLUG_SENSE_INVERT	(1 << 11)
 #define  PORTC_PULSE_DURATION_2ms	(0 << 10) /* pre-LPT */
 #define  PORTC_PULSE_DURATION_4_5ms	(1 << 10) /* pre-LPT */
 #define  PORTC_PULSE_DURATION_6ms	(2 << 10) /* pre-LPT */
@@ -6220,6 +6222,7 @@ enum skl_disp_power_wells {
 #define  PORTC_HOTPLUG_SHORT_DETECT	(1 << 8)
 #define  PORTC_HOTPLUG_LONG_DETECT	(2 << 8)
 #define  PORTB_HOTPLUG_ENABLE		(1 << 4)
+#define  PORTB_HOTPLUG_SENSE_INVERT	(1 << 3)
 #define  PORTB_PULSE_DURATION_2ms	(0 << 2) /* pre-LPT */
 #define  PORTB_PULSE_DURATION_4_5ms	(1 << 2) /* pre-LPT */
 #define  PORTB_PULSE_DURATION_6ms	(2 << 2) /* pre-LPT */
-- 
1.7.5.4

