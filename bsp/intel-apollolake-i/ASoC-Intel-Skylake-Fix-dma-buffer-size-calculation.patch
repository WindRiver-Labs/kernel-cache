From ac31866781e2a48696d3263b44a188ebd23c5acc Mon Sep 17 00:00:00 2001
From: Ramesh Babu <ramesh.babu@intel.com>
Date: Thu, 9 Jun 2016 17:35:44 +0530
Subject: [PATCH 1992/2508] ASoC: Intel: Skylake: Fix dma buffer size
 calculation

commit bc0f0d03707f358f54ba001298430ef864814bd7 from
https://github.com/01org/linux-apollolake-i

DMA buffer size for gateway copier will be
calculated based on:

Host DMA copier:
Input buffer size (ibs) for output direction (playback)
Output buffer size (obs) for input direction (capture)

Link DMA copier:
IBS for input direction (capture)
OBS for output direction (playback)

Change-Id: I018c6775a363d6d4c1c165c338759c12117b9850
Signed-off-by: Ramesh Babu <ramesh.babu@intel.com>
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/9564
---
 sound/soc/intel/skylake/skl-messages.c |   25 +++++++++++++++++++++----
 1 files changed, 21 insertions(+), 4 deletions(-)

diff --git a/sound/soc/intel/skylake/skl-messages.c b/sound/soc/intel/skylake/skl-messages.c
index ea0137b..74f6395 100644
--- a/sound/soc/intel/skylake/skl-messages.c
+++ b/sound/soc/intel/skylake/skl-messages.c
@@ -475,6 +475,7 @@ static void skl_setup_cpr_gateway_cfg(struct skl_sst *ctx,
 	union skl_connector_node_id node_id = {0};
 	union skl_ssp_dma_node ssp_node  = {0};
 	struct skl_pipe_params *params = mconfig->pipe->p_params;
+	u32 dma_io_buf;
 
 	switch (mconfig->dev_type) {
 	case SKL_DEVICE_BT:
@@ -526,10 +527,26 @@ static void skl_setup_cpr_gateway_cfg(struct skl_sst *ctx,
 
 	cpr_mconfig->gtw_cfg.node_id = node_id.val;
 
-	if (SKL_CONN_SOURCE == mconfig->hw_conn_type)
-		cpr_mconfig->gtw_cfg.dma_buffer_size = 2 * mconfig->obs;
-	else
-		cpr_mconfig->gtw_cfg.dma_buffer_size = 2 * mconfig->ibs;
+	switch (mconfig->hw_conn_type) {
+	case SKL_CONN_SOURCE:
+		if (mconfig->dev_type == SKL_DEVICE_HDAHOST)
+			dma_io_buf =  mconfig->ibs;
+		else
+			dma_io_buf =  mconfig->obs;
+		break;
+
+	case SKL_CONN_SINK:
+		if (mconfig->dev_type == SKL_DEVICE_HDAHOST)
+			dma_io_buf =  mconfig->obs;
+		else
+			dma_io_buf =  mconfig->ibs;
+		break;
+
+	default: /* This should not occur */
+		dma_io_buf =  mconfig->obs;
+	}
+
+	cpr_mconfig->gtw_cfg.dma_buffer_size = mconfig->dma_buffer_size * dma_io_buf;
 
 	cpr_mconfig->cpr_feature_mask = mconfig->fast_mode;
 	cpr_mconfig->gtw_cfg.config_length  = 0;
-- 
1.7.5.4

