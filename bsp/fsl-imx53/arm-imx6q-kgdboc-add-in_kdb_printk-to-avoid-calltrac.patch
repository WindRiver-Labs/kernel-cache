From 49c7973a8cb932436f342a57d84717eadb57a88c Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Tue, 19 Feb 2013 10:31:41 +0800
Subject: [PATCH 2/2] arm/imx6q, kgdboc: add in_kdb_printk to avoid calltrace in preempt-rt

Add check function in_kdb_printk to avoid calling spin_lock with the
irq disabled in preemp-rt kernel if KGDBoC is triggered. Otherwise the
call path trips the rtmutex debug code:

BUG: sleeping function called from invalid context at kernel/rtmutex.c:646

This change is inspired by serial8250_console_write() function in
drivers/tty/serial/8250/8250.c file.

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/tty/serial/imx.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/tty/serial/imx.c b/drivers/tty/serial/imx.c
index 040550b..67732e6 100644
--- a/drivers/tty/serial/imx.c
+++ b/drivers/tty/serial/imx.c
@@ -47,6 +47,7 @@
 #include <linux/slab.h>
 #include <linux/of.h>
 #include <linux/of_device.h>
+#include <linux/kdb.h>
 
 #include <asm/io.h>
 #include <asm/irq.h>
@@ -1233,7 +1234,7 @@ imx_console_write(struct console *co, const char *s, unsigned int count)
 
 	if (sport->port.sysrq)
 		locked = 0;
-	else if (oops_in_progress)
+	else if (oops_in_progress || in_kdb_printk())
 		locked = spin_trylock_irqsave(&sport->port.lock, flags);
 	else
 		spin_lock_irqsave(&sport->port.lock, flags);
-- 
1.7.0

