From 0ab8d9e49972fcb122325c178a6fb9dea18310ef Mon Sep 17 00:00:00 2001
From: chunguang yang <chunguang.yang@windriver.com>
Date: Tue, 29 Sep 2015 14:41:06 +0800
Subject: [PATCH] spi-amd-steppeeagle: Add completion to notify spi_amd_spi

spi-amd-steppeeagle.c use a kernel thread to monitor data transfer
queue. In the thread main loop, it polls the amd_spi->msg_queue to
check if any transfer. Change this so that the polled message queue
won't consume 95% cpu on a core that is running only the polling thread
and reduce power consumption. To fix this, use completion to notify
the thread when data transfer is ready.
Signed-off-by: chunguang yang <chunguang.yang@windriver.com>
---
 drivers/spi/spi-amd-steppeeagle.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/spi/spi-amd-steppeeagle.c b/drivers/spi/spi-amd-steppeeagle.c
index 4035d21..ea4ab80 100644
--- a/drivers/spi/spi-amd-steppeeagle.c
+++ b/drivers/spi/spi-amd-steppeeagle.c
@@ -50,6 +50,7 @@ struct amd_spi {
 	struct list_head msg_queue;
 };
 
+static DECLARE_COMPLETION(data_ready);
 static struct pci_device_id amd_spi_pci_device_id[] = {
 	{ PCI_DEVICE(PCI_VENDOR_ID_AMD, PCI_DEVICE_ID_AMD_LPC_BRIDGE) },
 	{}
@@ -216,6 +217,7 @@ static int amd_spi_master_transfer(struct spi_device *spi,
 	spin_lock(&amd_spi->lock);
 	list_add_tail(&msg->queue, &amd_spi->msg_queue);
 	spin_unlock(&amd_spi->lock);
+	complete(&data_ready);
 
 	return 0;
 }
@@ -247,6 +249,9 @@ static int amd_spi_thread(void *t)
 			break;
 		}
 
+		/* wait for transfer enqueue */
+		wait_for_completion(&data_ready);
+
 		/*
 		 * If the message queue is empty, then there is no need to waste
 		 * CPU cycles. So we let other processes execute, and continue
-- 
1.7.5.4

