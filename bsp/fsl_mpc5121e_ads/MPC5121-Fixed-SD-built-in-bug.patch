From da6d07c87e8ff5928795f107022b98258c65c657 Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Wed, 8 Jul 2009 10:20:18 +0800
Subject: [PATCH 25/25] MPC5121: Fixed SD built-in bug.

Original patch taken from Freescale BSP Global
Package Pool:
  http://www.bitshrine.org/gpp/

When SD driver is configured as built-in, system
will crash during booting process.

Signed-off-by: Shaohui Xie <b21989@freecale.com>
Integrated-by: Andrew Liu <shengping.liu@windriver.com>
---
 drivers/mmc/host/mpc5121sdhcioctl.c |   12 +++++++++---
 1 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/drivers/mmc/host/mpc5121sdhcioctl.c b/drivers/mmc/host/mpc5121sdhcioctl.c
index 0e83a37..0fd2eb8 100644
--- a/drivers/mmc/host/mpc5121sdhcioctl.c
+++ b/drivers/mmc/host/mpc5121sdhcioctl.c
@@ -1,7 +1,7 @@
 /*
  * drivers/mmc/host/mpc5121ioctl.c
  *
- * Copyright (C) 2008 Freescale Semicondutor, Inc. All rights reserved.
+ *  Copyright (C) 2008-2009 Freescale Semicondutor, Inc. All rights reserved.
  *
  * Author: <allgosystems.com>
  *
@@ -121,8 +121,14 @@ release:
 void
 mpc5121_sdhc_io_pullup_d3_cd(void)
 {
-	fsl_writel(H2_SDHC_D3_CD | DATA_SKEW_RATE_STD_4 | PU_ENABLE,
-		ioaddr + D3_CD_LINE);
+	struct device_node *np;
+	np = of_find_compatible_node(NULL, NULL, "fsl,mpc5121-ioctl");
+	if (np) {
+		void __iomem *ioctl = of_iomap(np, 0);
+		fsl_writel(H2_SDHC_D3_CD | DATA_SKEW_RATE_STD_4 | PU_ENABLE,
+				ioctl + D3_CD_LINE);
+		iounmap(ioctl);
+	}
 }
 EXPORT_SYMBOL(mpc5121_sdhc_io_pullup_d3_cd);
 
-- 
1.6.3.1

