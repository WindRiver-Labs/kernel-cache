From 1564240eeb12ec8caa36e353079dbb94da69630a Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Thu, 18 Jun 2009 15:33:47 +0800
Subject: [PATCH 06/25] MPC5121 USB: Fix module loading sequence in OTG mode

In USB OTG mode, the kernel module loading sequence of
three drivers: USB OTG, USB host and USB gadget is very
important for them always to work well.

However, MODULE_ALIAS macro exports important module
nformation for user space application(generally, it
is udev) to load kernel module automatically, thus
can cause incorrect USB kernel module loading
sequence in USB OTG mode.

This patch fixes above stated issue, and offer
opportunity to load USB kernel module manually o
r in your own init script as follows:

  modprobe fsl_usb2_otg
  modprobe ehci-hcd
  modprobe fsl_usb2_udc

Signed-off-by: Andrew Liu <shengping.liu@windriver.com>
---
 drivers/usb/gadget/fsl_usb2_udc.c |    2 ++
 drivers/usb/host/ehci-fsl.c       |    2 ++
 2 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/gadget/fsl_usb2_udc.c b/drivers/usb/gadget/fsl_usb2_udc.c
index bef43a2..6a9083e 100644
--- a/drivers/usb/gadget/fsl_usb2_udc.c
+++ b/drivers/usb/gadget/fsl_usb2_udc.c
@@ -2676,4 +2676,6 @@ module_exit(udc_exit);
 MODULE_DESCRIPTION(DRIVER_DESC);
 MODULE_AUTHOR(DRIVER_AUTHOR);
 MODULE_LICENSE("GPL");
+#ifndef CONFIG_USB_OTG
 MODULE_ALIAS("platform:fsl-usb2-udc");
+#endif
diff --git a/drivers/usb/host/ehci-fsl.c b/drivers/usb/host/ehci-fsl.c
index 040a2f1..59c928b 100644
--- a/drivers/usb/host/ehci-fsl.c
+++ b/drivers/usb/host/ehci-fsl.c
@@ -673,7 +673,9 @@ static int ehci_fsl_drv_resume(struct platform_device *pdev)
 }
 #endif				/* CONFIG_USB_OTG */
 
+#ifndef CONFIG_USB_OTG
 MODULE_ALIAS("platform:fsl-ehci");
+#endif
 
 static struct platform_driver ehci_fsl_driver = {
 	.probe = ehci_fsl_drv_probe,
-- 
1.6.3.1

