From aa5eae466af5bd04f4f3bd47fe8cad125dfe7e2e Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Tue, 4 Nov 2008 14:46:01 +0800
Subject: [PATCH] Support console on port other than default

arch/powerpc/platforms/512x/mpc5121_ads.c:
   If the kernel is using a different PSC for the console
   than u-boot then that psc's clock will not be enabled.
   The clock driver runs after console_init so turn on
   the clock here.

drivers/serial/mpc52xx_uart.c:
    move prescaler init out of fifo init and into
    mpc52xx_uart_setup and mpc52xx_console_setup

Signed-off-by: Andrew Liu <shengping.liu@windriver.com>
---
 arch/powerpc/platforms/512x/mpc5121_ads.c    |    3 +++
 arch/powerpc/platforms/512x/mpc512x.h        |    2 ++
 arch/powerpc/platforms/512x/mpc512x_shared.c |   26 ++++++++++++++++++++++++++
 drivers/serial/mpc52xx_uart.c                |   12 +++++++++---
 4 files changed, 40 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/platforms/512x/mpc5121_ads.c b/arch/powerpc/platforms/512x/mpc5121_ads.c
index a6395b3..200b4d0 100644
--- a/arch/powerpc/platforms/512x/mpc5121_ads.c
+++ b/arch/powerpc/platforms/512x/mpc5121_ads.c
@@ -50,6 +50,9 @@ static void __init mpc5121_ads_setup_arch(void)
 		iounmap(ioctl);
 	}
 
+	/* Turn on all PSC's clock */
+	mpc5121_psc_lowlevel_clock_init();
+
 	/* Initialize PSC fifo size */
 	g_mpc5121_psc_fifo_init();
 
diff --git a/arch/powerpc/platforms/512x/mpc512x.h b/arch/powerpc/platforms/512x/mpc512x.h
index af003ff..94bbcfc 100644
--- a/arch/powerpc/platforms/512x/mpc512x.h
+++ b/arch/powerpc/platforms/512x/mpc512x.h
@@ -18,4 +18,6 @@ extern void mpc512x_restart(char *cmd);
 extern void __init g_mpc5121_psc_fifo_init(void);
 extern void __init mpc5121_psc_iopad_init(void __iomem *ioctl);
 extern void __init mpc5121_can_iopad_init(void __iomem *ioctl);
+extern void __init mpc5121_psc_lowlevel_clock_init(void);
+
 #endif				/* __MPC512X_H__ */
diff --git a/arch/powerpc/platforms/512x/mpc512x_shared.c b/arch/powerpc/platforms/512x/mpc512x_shared.c
index fabeacd..a41cc2f 100644
--- a/arch/powerpc/platforms/512x/mpc512x_shared.c
+++ b/arch/powerpc/platforms/512x/mpc512x_shared.c
@@ -223,3 +223,29 @@ void __init mpc5121_can_iopad_init(void __iomem *ioctl)
 		}
 	}
 }
+
+/*
+ * If the kernel is using a different PSC for the console than
+ * u-boot then that psc's clock will not be enabled.
+ * The clock driver runs after console_init so turn on
+ * the clock here.
+ */
+void __init mpc5121_psc_lowlevel_clock_init(void)
+{
+	struct device_node *np;
+	const u32 *cell_index;
+	void __iomem *clockctl;
+
+	np = of_find_compatible_node(NULL, NULL, "fsl,mpc5121-clock");
+	clockctl = of_iomap(np, 0);
+	of_node_put(np);
+
+	if (clockctl)
+		for_each_compatible_node(np, NULL, "fsl,mpc5121-psc") {
+			cell_index = of_get_property(np, "cell-index", NULL);
+			if (cell_index)
+				setbits32(clockctl+4, \
+					0x08000000 >> *cell_index);
+		}
+	iounmap(clockctl);
+}
diff --git a/drivers/serial/mpc52xx_uart.c b/drivers/serial/mpc52xx_uart.c
index 3612607..ab7ab09 100644
--- a/drivers/serial/mpc52xx_uart.c
+++ b/drivers/serial/mpc52xx_uart.c
@@ -161,9 +161,6 @@ static void mpc52xx_psc_fifo_init(struct uart_port *port)
 	struct mpc52xx_psc __iomem *psc = PSC(port);
 	struct mpc52xx_psc_fifo __iomem *fifo = FIFO_52xx(port);
 
-	/* /32 prescaler */
-	out_be16(&psc->mpc52xx_psc_clock_select, 0xdd00);
-
 	out_8(&fifo->rfcntl, 0x00);
 	out_be16(&fifo->rfalarm, 0x1ff);
 	out_8(&fifo->tfcntl, 0x07);
@@ -526,6 +523,9 @@ mpc52xx_uart_startup(struct uart_port *port)
 
 	out_be32(&psc->sicr, 0);	/* UART mode DCD ignored */
 
+	/* set prescaler */
+	out_be16(&PSC(port)->mpc52xx_psc_clock_select, 0xdd00);
+
 	psc_ops->fifo_init(port);
 
 	out_8(&psc->command, MPC52xx_PSC_TX_ENABLE);
@@ -972,6 +972,9 @@ mpc52xx_console_setup(struct console *co, char *options)
 	if (port->membase == NULL)
 		return -EINVAL;
 
+	/* set prescaler */
+	out_be16(&PSC(port)->mpc52xx_psc_clock_select, 0xdd00);
+
 	/* Setup the port parameters accoding to options */
 	if (options)
 		uart_parse_options(options, &baud, &parity, &bits, &flow);
@@ -1038,6 +1041,9 @@ mpc52xx_console_setup(struct console *co, char *options)
 	if (port->membase == NULL)
 		return -EINVAL;
 
+	/* set prescaler */
+	out_be16(&PSC(port)->mpc52xx_psc_clock_select, 0xdd00);
+
 	pr_debug("mpc52xx-psc uart at %p, mapped to %p, irq=%x, freq=%i\n",
 		 (void *)port->mapbase, port->membase,
 		 port->irq, port->uartclk);
-- 
1.6.0.90.g436ed

