From 3fd82bf0fb106f4ccfdf11279fb10e6d687fcd06 Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Tue, 23 Jun 2009 17:00:36 +0800
Subject: [PATCH 20/25] MPC5121 PM: CAN deep-sleep fix

Original patch taken from rev 4 board support ISO image:
  mpc5121ads-20081208_ltib-beta.iso
  http://www.freescale.com/webapp/sps/site/overview.jsp?
  nodeId=0127260061033202A5621E

This fixes an issue that caused resuming from
deep sleep multiple times to fail.

Signed-off-by: Hongjun Chen <hong-jun.chen@freescale.com>
Signed-off-by: Andrew Liu <shengping.liu@windriver.com>
---
 drivers/net/can/mscan/mpc52xx_can.c |   12 ++++++++++++
 1 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/drivers/net/can/mscan/mpc52xx_can.c b/drivers/net/can/mscan/mpc52xx_can.c
index 0d9c6d9..be34041 100644
--- a/drivers/net/can/mscan/mpc52xx_can.c
+++ b/drivers/net/can/mscan/mpc52xx_can.c
@@ -156,6 +156,16 @@ static int mpc52xx_can_suspend(struct platform_device *pdev, pm_message_t state)
 
 	_memcpy_fromio(&saved_regs, regs, sizeof(*regs));
 
+	regs->canctl1 |= MSCAN_CANE;
+	regs->canctl1 &= ~MSCAN_LISTEN;
+	regs->canctl0 |= MSCAN_SLPRQ;
+	regs->canctl0 |= MSCAN_INITRQ;
+	mdelay(20);
+	regs->canctl0 &= ~MSCAN_INITRQ;
+	regs->canctl0 |= MSCAN_WUPE;
+	mdelay(20);
+	regs->canrier |= 0xff;
+
 	return 0;
 }
 
@@ -183,6 +193,8 @@ static int mpc52xx_can_resume(struct platform_device *pdev)
 	regs->cantier = saved_regs.cantier;
 	regs->canctl0 = saved_regs.canctl0;
 
+	regs->canrflg &= 0xc3;
+
 	return 0;
 }
 #endif
-- 
1.6.3.1

