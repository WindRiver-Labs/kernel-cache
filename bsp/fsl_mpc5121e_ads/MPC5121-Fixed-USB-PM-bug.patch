From c12946dc8a0c3c8bef1728103d08c48d2067f3eb Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Wed, 8 Jul 2009 10:20:15 +0800
Subject: [PATCH 22/25] MPC5121: Fixed USB PM bug

Original patch taken from Freescale BSP Global
Package Pool:
  http://www.bitshrine.org/gpp/

Bug description: system will reboot when it wakes
up from sleep in memory mode.

Signed-off-by: Kai Jiang <b18973@freescale.com>
[Andrew Liu: minor context mods in order to backport to 2.6.27]
Integrated-by: Andrew Liu <shengping.liu@windriver.com>
---
 drivers/usb/host/ehci-fsl.c |    5 +++++
 drivers/usb/host/ehci-fsl.h |   10 +++++++++-
 2 files changed, 14 insertions(+), 1 deletions(-)

diff --git a/drivers/usb/host/ehci-fsl.c b/drivers/usb/host/ehci-fsl.c
index 3ab602c..7058866 100644
--- a/drivers/usb/host/ehci-fsl.c
+++ b/drivers/usb/host/ehci-fsl.c
@@ -653,6 +653,11 @@ static int ehci_fsl_drv_resume(struct platform_device *pdev)
 	 */
 	ehci_writel(ehci, SBUSCFG_INCR8, hcd->regs + FSL_SOC_USB_SBUSCFG);
 
+	ehci_writel(ehci, USBGENCTRL_PPP | USBGENCTRL_PFP,
+			hcd->regs + FSL_SOC_USB_USBGENCTRL);
+	ehci_writel(ehci, ISIPHYCTRL_PXE | ISIPHYCTRL_PHYE,
+			hcd->regs + FSL_SOC_USB_ISIPHYCTRL);
+
 	/* restore EHCI registers */
 	ehci_writel(ehci, usb_ehci_regs.command, &ehci->regs->command);
 	ehci_writel(ehci, usb_ehci_regs.status, &ehci->regs->status);
diff --git a/drivers/usb/host/ehci-fsl.h b/drivers/usb/host/ehci-fsl.h
index d3f9489..fa4296b 100644
--- a/drivers/usb/host/ehci-fsl.h
+++ b/drivers/usb/host/ehci-fsl.h
@@ -1,4 +1,4 @@
-/* Copyright (c) 2005 freescale semiconductor
+/* Copyright (C) 2005-2009 Freescale Semiconductor, Inc. All rights reserved.
  * Copyright (c) 2005 MontaVista Software
  *
  * This program is free software; you can redistribute  it and/or modify it
@@ -33,6 +33,14 @@
 #define FSL_SOC_USB_USBMODE	0x1a8
 #define USBMODE_CM_HOST		(3 << 0)	/* controller mode: host */
 #define USBMODE_ES		(1 << 2)	/* (Big) Endian Select */
+
+#define FSL_SOC_USB_USBGENCTRL	0x200
+#define USBGENCTRL_PPP		(1 << 3)
+#define USBGENCTRL_PFP		(1 << 2)
+#define FSL_SOC_USB_ISIPHYCTRL	0x204
+#define ISIPHYCTRL_PXE		(1)
+#define ISIPHYCTRL_PHYE		(1 << 4)
+
 #define FSL_SOC_USB_SNOOP1	0x400	/* NOTE: big-endian */
 #define FSL_SOC_USB_SNOOP2	0x404	/* NOTE: big-endian */
 #define FSL_SOC_USB_AGECNTTHRSH	0x408	/* NOTE: big-endian */
-- 
1.6.3.1

