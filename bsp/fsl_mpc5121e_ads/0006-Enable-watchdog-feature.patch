From 63c7f13a619d0154169e49ccde355f93eeeadfa2 Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Tue, 4 Nov 2008 14:45:53 +0800
Subject: [PATCH] Enable watchdog feature

The watchdog on mpc512x is same to its
counterpart on mpc8xxx.

Signed-off-by: Andrew Liu <shengping.liu@windriver.com>
---
 arch/powerpc/boot/dts/mpc5121ads.dts |    6 ++++++
 drivers/watchdog/Kconfig             |    5 +++--
 drivers/watchdog/mpc8xxx_wdt.c       |   14 ++++++++++----
 3 files changed, 19 insertions(+), 6 deletions(-)

diff --git a/arch/powerpc/boot/dts/mpc5121ads.dts b/arch/powerpc/boot/dts/mpc5121ads.dts
index 9b59591..3dee690 100644
--- a/arch/powerpc/boot/dts/mpc5121ads.dts
+++ b/arch/powerpc/boot/dts/mpc5121ads.dts
@@ -160,6 +160,12 @@
 			reg = <0xc00 0x100>;
 		};
 
+		wdt@900 {
+			device_type = "watchdog";
+			compatible ="fsl,mpc512x-wdt";
+			reg = <0x900 0x100>;
+		};
+
 		rtc@a00 {	// Real time clock
 			compatible = "fsl,mpc5121-rtc";
 			reg = <0xa00 0x100>;
diff --git a/drivers/watchdog/Kconfig b/drivers/watchdog/Kconfig
index b02d0cd..6f09f75 100644
--- a/drivers/watchdog/Kconfig
+++ b/drivers/watchdog/Kconfig
@@ -713,14 +713,15 @@ config MPC5200_WDT
 	depends on PPC_MPC52xx
 
 config 8xxx_WDT
-	tristate "MPC8xxx Platform Watchdog Timer"
-	depends on PPC_8xx || PPC_83xx || PPC_86xx
+	tristate "MPC8xxx/MPC512x Platform Watchdog Timer"
+	depends on PPC_8xx || PPC_83xx || PPC_86xx || PPC_MPC512x
 	help
 	  This driver is for a SoC level watchdog that exists on some
 	  Freescale PowerPC processors. So far this driver supports:
 	  - MPC8xx watchdogs
 	  - MPC83xx watchdogs
 	  - MPC86xx watchdogs
+	  - MPC512x watchdogs
 
 	  For BookE processors (MPC85xx) use the BOOKE_WDT driver instead.
 
diff --git a/drivers/watchdog/mpc8xxx_wdt.c b/drivers/watchdog/mpc8xxx_wdt.c
index 38c588e..4781722 100644
--- a/drivers/watchdog/mpc8xxx_wdt.c
+++ b/drivers/watchdog/mpc8xxx_wdt.c
@@ -220,8 +220,8 @@ static int __devinit mpc8xxx_wdt_probe(struct of_device *ofdev,
 		goto err_unmap;
 #endif
 
-	pr_info("WDT driver for MPC8xxx initialized. mode:%s timeout=%d "
-		"(%d seconds)\n", reset ? "reset" : "interrupt", timeout,
+	pr_info("WDT driver for MPC8xxx/MPC512x initialized. mode:%s timeout=%d"
+		" (%d seconds)\n", reset ? "reset" : "interrupt", timeout,
 		timeout_sec);
 
 	/*
@@ -268,6 +268,12 @@ static const struct of_device_id mpc8xxx_wdt_match[] = {
 			.prescaler = 0x800,
 		},
 	},
+	{
+		.compatible = "fsl,mpc512x-wdt",
+		.data = &(struct mpc8xxx_wdt_type) {
+			.prescaler = 0x10000,
+		},
+	},
 	{},
 };
 MODULE_DEVICE_TABLE(of, mpc8xxx_wdt_match);
@@ -319,7 +325,7 @@ static void __exit mpc8xxx_wdt_exit(void)
 module_exit(mpc8xxx_wdt_exit);
 
 MODULE_AUTHOR("Dave Updegraff, Kumar Gala");
-MODULE_DESCRIPTION("Driver for watchdog timer in MPC8xx/MPC83xx/MPC86xx "
-		   "uProcessors");
+MODULE_DESCRIPTION("Driver for watchdog timer in MPC8xx/MPC83xx/MPC86xx/MPC512x"
+			"uProcessors");
 MODULE_LICENSE("GPL");
 MODULE_ALIAS_MISCDEV(WATCHDOG_MINOR);
-- 
1.6.0.90.g436ed

