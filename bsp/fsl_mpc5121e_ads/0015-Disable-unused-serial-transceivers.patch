From 0055853dbe4d4886f772cc20edd393e76b2cf34a Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Tue, 4 Nov 2008 14:46:02 +0800
Subject: [PATCH] Disable unused serial transceivers

Depending on the board configuration psc3
and psc4 can be used as uarts or for spi.
When a psc is not in uart mode the
serial transceiver needs to be disabled so
as not to conflict with spi.

Signed-off-by: Andrew Liu <shengping.liu@windriver.com>
---
 arch/powerpc/platforms/512x/mpc5121_ads.c      |    6 ++++
 arch/powerpc/platforms/512x/mpc5121_ads_cpld.c |   38 ++++++++++++++++++++++++
 arch/powerpc/platforms/512x/mpc512x.h          |    1 +
 3 files changed, 45 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/512x/mpc5121_ads.c b/arch/powerpc/platforms/512x/mpc5121_ads.c
index 200b4d0..384c392 100644
--- a/arch/powerpc/platforms/512x/mpc5121_ads.c
+++ b/arch/powerpc/platforms/512x/mpc5121_ads.c
@@ -56,6 +56,12 @@ static void __init mpc5121_ads_setup_arch(void)
 	/* Initialize PSC fifo size */
 	g_mpc5121_psc_fifo_init();
 
+	/* Disable any unused serial transceivers so they don't
+	 * interfere with spi or what ever else they might be
+	 * used for.
+	*/
+	mpc5121ads_psc_disable_unused_serial();
+
 	/*
 	 * turn on i2c interrupts
 	 */
diff --git a/arch/powerpc/platforms/512x/mpc5121_ads_cpld.c b/arch/powerpc/platforms/512x/mpc5121_ads_cpld.c
index a6ce805..8103827 100644
--- a/arch/powerpc/platforms/512x/mpc5121_ads_cpld.c
+++ b/arch/powerpc/platforms/512x/mpc5121_ads_cpld.c
@@ -202,3 +202,41 @@ mpc5121_ads_cpld_pic_init(void)
 end:
 	of_node_put(np);
 }
+
+/* disable rs232 transceivers */
+static void mpc5121_ads_cpld_uart_foff(int uart)
+{
+	/*
+	 * xx0xxxxx turns off transceiver for uart 0
+	 * xxx0xxxx turns off transceiver for uart 1
+	 */
+	if (cpld_regs)
+		clrbits8(&cpld_regs->misc_control, 0x20 >> uart);
+}
+
+/*
+ * Disable any unused serial transceivers so they don't interfere with
+ * spi or what ever else they might be used for.
+ */
+void mpc5121ads_psc_disable_unused_serial(void)
+{
+	struct device_node *np;
+	const u32 *cell_index;
+
+	for_each_compatible_node(np, NULL, "fsl,mpc5121-psc") {
+		cell_index = of_get_property(np, "cell-index", NULL);
+		if (cell_index) {
+			/*
+			 * if not uart then then disable transceiver
+			 */
+			if (!of_device_is_compatible(np,
+				    "fsl,mpc5121-psc-uart")) {
+				if (*cell_index == 3)
+					mpc5121_ads_cpld_uart_foff(0);
+				else if (*cell_index == 4)
+					mpc5121_ads_cpld_uart_foff(1);
+
+			}
+		}
+	}
+}
diff --git a/arch/powerpc/platforms/512x/mpc512x.h b/arch/powerpc/platforms/512x/mpc512x.h
index 94bbcfc..3d2fe41 100644
--- a/arch/powerpc/platforms/512x/mpc512x.h
+++ b/arch/powerpc/platforms/512x/mpc512x.h
@@ -19,5 +19,6 @@ extern void __init g_mpc5121_psc_fifo_init(void);
 extern void __init mpc5121_psc_iopad_init(void __iomem *ioctl);
 extern void __init mpc5121_can_iopad_init(void __iomem *ioctl);
 extern void __init mpc5121_psc_lowlevel_clock_init(void);
+extern void mpc5121ads_psc_disable_unused_serial(void);
 
 #endif				/* __MPC512X_H__ */
-- 
1.6.0.90.g436ed

