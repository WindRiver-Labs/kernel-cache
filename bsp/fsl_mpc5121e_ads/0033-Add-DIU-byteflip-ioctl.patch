From c5076931e6d29fef7c59330ac6d2c98118c0a432 Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Tue, 18 Nov 2008 17:11:05 +0800
Subject: [PATCH] Add DIU byteflip ioctl

Add byteflip ioctl, so on a per fb basis
one can change the byte order of the pixel
format.

This patch is from:
http://www.bitshrine.org/gpp/
linux-2.6.24.6-mpc5121-105-DIU-add-byteflip-ioctl.patch

Signed-off-by: Andrew Liu <shengping.liu@windriver.com>
---
 arch/powerpc/platforms/512x/mpc5121_diu.c |   21 ++++++++++++++-------
 arch/powerpc/platforms/512x/mpc512x.h     |    2 +-
 arch/powerpc/sysdev/fsl_soc.h             |    4 ++++
 drivers/video/fsl-diu-fb.c                |   14 +++++++++++++-
 drivers/video/fsl-diu-fb.h                |    1 +
 5 files changed, 33 insertions(+), 9 deletions(-)

diff --git a/arch/powerpc/platforms/512x/mpc5121_diu.c b/arch/powerpc/platforms/512x/mpc5121_diu.c
index c9022c2..8443384 100644
--- a/arch/powerpc/platforms/512x/mpc5121_diu.c
+++ b/arch/powerpc/platforms/512x/mpc5121_diu.c
@@ -54,17 +54,24 @@ static u32 get_busfreq(void)
 }
 
 unsigned int
-mpc5121ads_get_pixel_format(unsigned int bits_per_pixel, int monitor_port)
+mpc5121ads_get_pixel_format(unsigned int bits_per_pixel, int monitor_port,
+				char byte_flip)
 {
 	unsigned int pix_fmt;
 
-	if (bits_per_pixel == 32)
-		pix_fmt = 0x88883316;
-	else if (bits_per_pixel == 24)
+	if (bits_per_pixel == 32) {
+		if (byte_flip)
+			pix_fmt = 0x88883316;
+		else
+			pix_fmt = 0x88883306;
+	} else if (bits_per_pixel == 24)
 		pix_fmt = 0x88082219;
-	else if (bits_per_pixel == 16)
-		pix_fmt = 0x65053118;
-	else
+	else if (bits_per_pixel == 16) {
+		if (byte_flip)
+			pix_fmt = 0x65053118;
+		else
+			pix_fmt = 0x65052908;
+	} else
 		pix_fmt = 0x88883316;
 
 	return pix_fmt;
diff --git a/arch/powerpc/platforms/512x/mpc512x.h b/arch/powerpc/platforms/512x/mpc512x.h
index 17fee24..0319b2d 100644
--- a/arch/powerpc/platforms/512x/mpc512x.h
+++ b/arch/powerpc/platforms/512x/mpc512x.h
@@ -23,7 +23,7 @@ extern void mpc5121ads_psc_disable_unused_serial(void);
 extern int mpc5121ads_get_pendown_state(void);
 
 #if defined(CONFIG_FB_FSL_DIU) || defined(CONFIG_FB_FSL_DIU_MODULE)
-extern unsigned int mpc5121ads_get_pixel_format(unsigned int, int);
+extern unsigned int mpc5121ads_get_pixel_format(unsigned int, int, char);
 extern void mpc5121ads_set_gamma_table(int, char *);
 extern void mpc5121ads_set_monitor_port(int monitor_port);
 extern void mpc5121ads_set_pixel_clock(unsigned int pixclock);
diff --git a/arch/powerpc/sysdev/fsl_soc.h b/arch/powerpc/sysdev/fsl_soc.h
index 83a0f06..33405b9 100644
--- a/arch/powerpc/sysdev/fsl_soc.h
+++ b/arch/powerpc/sysdev/fsl_soc.h
@@ -29,7 +29,11 @@ struct platform_diu_data_ops {
 	void *diu_mem;
 
 	unsigned int (*get_pixel_format) (unsigned int bits_per_pixel,
+#ifndef CONFIG_PPC_MPC512x
 		int monitor_port);
+#else
+		int monitor_port, char byte_flip);
+#endif
 	void (*set_gamma_table) (int monitor_port, char *gamma_table_base);
 	void (*set_monitor_port) (int monitor_port);
 	void (*set_pixel_clock) (unsigned int pixclock);
diff --git a/drivers/video/fsl-diu-fb.c b/drivers/video/fsl-diu-fb.c
index f6336f1..22d9b6a 100644
--- a/drivers/video/fsl-diu-fb.c
+++ b/drivers/video/fsl-diu-fb.c
@@ -833,6 +833,7 @@ static int fsl_diu_set_par(struct fb_info *info)
 	struct fsl_diu_data *machine_data = mfbi->parent;
 	struct diu_ad *ad = mfbi->ad;
 	struct diu *hw;
+	char byte_flip = 1;
 
 	hw = dr.diu_reg;
 
@@ -855,7 +856,7 @@ static int fsl_diu_set_par(struct fb_info *info)
 
 	ad->pix_fmt =
 		diu_ops.get_pixel_format(var->bits_per_pixel,
-					 machine_data->monitor_port);
+				machine_data->monitor_port, byte_flip);
 	ad->addr    = cpu_to_le32(info->fix.smem_start);
 	ad->src_size_g_alpha = cpu_to_le32((var->yres_virtual << 12) |
 				var->xres_virtual) | mfbi->g_alpha;
@@ -1001,6 +1002,7 @@ static int fsl_diu_ioctl(struct fb_info *info, unsigned int cmd,
 		       unsigned long arg)
 {
 	struct mfb_info *mfbi = info->par;
+	struct fb_var_screeninfo *var = &info->var;
 	struct diu_ad *ad = mfbi->ad;
 	struct mfb_chroma_key ck;
 	unsigned char global_alpha;
@@ -1008,6 +1010,7 @@ static int fsl_diu_ioctl(struct fb_info *info, unsigned int cmd,
 	__u32 pix_fmt;
 	void __user *buf = (void __user *)arg;
 	struct diu *hw = dr.diu_reg;
+	char byte_flip;
 
 	if (!arg)
 		return -EINVAL;
@@ -1085,6 +1088,15 @@ static int fsl_diu_ioctl(struct fb_info *info, unsigned int cmd,
 		}
 		pr_debug("set chroma key\n");
 		break;
+
+	case MFB_SET_BYTE_FLIP:
+		if (arg)
+			byte_flip = 1;
+		else
+			byte_flip = 0;
+		ad->pix_fmt = diu_ops.get_pixel_format(var->bits_per_pixel,
+			monitor_port, byte_flip);
+		break;
 	case FBIOGET_GWINFO:
 		if (mfbi->type == MFB_TYPE_OFF)
 			return -ENODEV;
diff --git a/drivers/video/fsl-diu-fb.h b/drivers/video/fsl-diu-fb.h
index 5b10ec1..0ba3fff 100644
--- a/drivers/video/fsl-diu-fb.h
+++ b/drivers/video/fsl-diu-fb.h
@@ -63,6 +63,7 @@ struct aoi_display_offset {
 #define MFB_GET_AOID		0x40084d04
 #define MFB_SET_PIXFMT		0x80014d08
 #define MFB_GET_PIXFMT		0x40014d08
+#define MFB_SET_BYTE_FLIP	0x80044d00
 
 #define FBIOGET_GWINFO		0x46E0
 #define FBIOPUT_GWINFO		0x46E1
-- 
1.6.0.2.GIT

