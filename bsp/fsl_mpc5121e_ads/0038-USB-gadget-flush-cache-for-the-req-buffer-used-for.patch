From 6fb4cdc36cedbca7d726f06fdfc6f2a0bd6e02bc Mon Sep 17 00:00:00 2001
From: Bruce Schmid <duck@freescale.com>
Date: Mon, 15 Dec 2008 17:00:09 +0800
Subject: [PATCH] USB gadget: flush cache for the req buffer used for GetStatus reply.

Without this patch, the correct reply to an endpoint
GetStatus is written to 'req', but doesn't make it
out to the USB bus since the buffer hasn't been
flushed. This would cause the USBCV Halt Endpoint
test to fail.

This patch is from:
  http://www.bitshrine.org/gpp/
  linux-2.6.24.6-mpc5121-110-USB-gadget-flush-cache-for-the-.patch

Signed-off-by: Bruce Schmid <duck@freescale.com>
Signed-off-by: Andrew Liu <shengping.liu@windriver.com>
---
 drivers/usb/gadget/fsl_usb2_udc.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/gadget/fsl_usb2_udc.c b/drivers/usb/gadget/fsl_usb2_udc.c
index 52af700..bef43a2 100644
--- a/drivers/usb/gadget/fsl_usb2_udc.c
+++ b/drivers/usb/gadget/fsl_usb2_udc.c
@@ -1273,6 +1273,10 @@ static void ch9getstatus(struct fsl_udc *udc, u8 request_type, u16 value,
 	req = udc->status_req;
 	/* Fill in the reqest structure */
 	*((u16 *) req->req.buf) = cpu_to_le16(tmp);
+
+	/* flush cache for the req buffer */
+	flush_dcache_range((u32)req->req.buf, (u32)req->req.buf + 8);
+
 	req->ep = ep;
 	req->req.length = 2;
 	req->req.status = -EINPROGRESS;
-- 
1.6.0.2.GIT

