From 74a1f06aab34a63ff533836b7adba6db04be3f73 Mon Sep 17 00:00:00 2001
From: Chunbo Luo <chunbo.luo@windriver.com>
Date: Thu, 11 Sep 2008 15:34:57 +0800
Subject: [PATCH] nec_emma3p: uImage support

Add uImage support for nec_emma3p.
Since the u-boot of nec_emma3p can't support a gzipped image,
change the uImage to not be compressed.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
Signed-off-by: Chunbo Luo <chunbo.luo@windriver.com>
---
 arch/mips/Makefile      |    4 ++++
 arch/mips/boot/Makefile |   13 ++++++++++++-
 2 files changed, 16 insertions(+), 1 deletions(-)

diff --git a/arch/mips/Makefile b/arch/mips/Makefile
index 9aab51c..df2c7f4 100644
--- a/arch/mips/Makefile
+++ b/arch/mips/Makefile
@@ -682,6 +682,9 @@ vmlinux.ecoff: $(vmlinux-32)
 vmlinux.srec: $(vmlinux-32)
 	+@$(call makeboot,$@)
 
+uImage: $(vmlinux-32)
+	+@$(call makeboot,$@)
+
 CLEAN_FILES += vmlinux.ecoff \
 	       vmlinux.srec
 
@@ -703,6 +706,7 @@ define archhelp
 	echo '  vmlinux.ecoff        - ECOFF boot image'
 	echo '  vmlinux.bin          - Raw binary boot image'
 	echo '  vmlinux.srec         - SREC boot image'
+	echo '  uImage               - U-Boot image'
 	echo
 	echo '  These will be default as apropriate for a configured platform.'
 endef
diff --git a/arch/mips/boot/Makefile b/arch/mips/boot/Makefile
index 2a209d7..4e08edc 100644
--- a/arch/mips/boot/Makefile
+++ b/arch/mips/boot/Makefile
@@ -16,6 +16,12 @@ else
   E2EFLAGS =
 endif
 
+MKIMAGE         := $(srctree)/scripts/mkuboot.sh
+LOAD_ADDR=$(shell $(NM) -n $(VMLINUX) | grep "\ _text$$" |  \
+				cut -d ' ' -f 1)
+ENTRY_ADDR=$(shell $(NM) -n $(VMLINUX) | grep "\ kernel_entry$$" |  \
+				cut -d ' ' -f 1)
+
 #
 # Drop some uninteresting sections in the kernel.
 # This is only relevant for ELF kernels but doesn't hurt a.out
@@ -25,7 +31,7 @@ strip-flags	= $(addprefix --remove-section=,$(drop-sections))
 
 VMLINUX = vmlinux
 
-all: vmlinux.ecoff vmlinux.srec addinitrd
+all: vmlinux.ecoff vmlinux.srec uImage addinitrd
 
 vmlinux.ecoff: $(obj)/elf2ecoff $(VMLINUX)
 	$(obj)/elf2ecoff $(VMLINUX) vmlinux.ecoff $(E2EFLAGS)
@@ -39,6 +45,10 @@ vmlinux.bin: $(VMLINUX)
 vmlinux.srec: $(VMLINUX)
 	$(OBJCOPY) -S -O srec $(strip-flags) $(VMLINUX) $(obj)/vmlinux.srec
 
+uImage: vmlinux.bin
+	$(CONFIG_SHELL) $(MKIMAGE) -A mips -T kernel -a $(LOAD_ADDR) \
+		-e $(ENTRY_ADDR) -C none -n 'Linux-$(KERNELRELEASE)' -d $(obj)/$< $@
+
 $(obj)/addinitrd: $(obj)/addinitrd.c
 	$(HOSTCC) -o $@ $^
 
@@ -46,4 +56,5 @@ clean-files += addinitrd \
 	       elf2ecoff \
 	       vmlinux.bin \
 	       vmlinux.ecoff \
+	       uImage \
 	       vmlinux.srec
-- 
1.5.5.1

