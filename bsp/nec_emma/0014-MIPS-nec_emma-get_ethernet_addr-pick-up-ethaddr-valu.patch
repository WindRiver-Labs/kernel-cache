From 1c11a826bbca6f7539ed2106440d767a02bb519f Mon Sep 17 00:00:00 2001
From: Shinya Kuribayashi <shinya.kuribayashi@necel.com>
Date: Mon, 7 Sep 2009 09:21:44 +0900
Subject: [PATCH 14/18] MIPS: nec_emma: get_ethernet_addr - pick up 'ethaddr' value

Get_ethernet_addr() searches for 'ethaddr' environment variable, and
then converts a string representation of a MAC address to the binary
version.

We'd prefer Alchemy's version of get_ethernet_addr() rather than
Malta's one, as it searches 'ethaddr' value not only in the environment
variables, but also in the command-line options.

Signed-off-by: Shinya Kuribayashi <shinya.kuribayashi@necel.com>
---
 arch/mips/emma/common/prom.c |   55 ++++++++++++++++++++++++++++++++++++++++++
 include/asm-mips/emma/prom.h |    1 +
 2 files changed, 56 insertions(+), 0 deletions(-)

diff --git a/arch/mips/emma/common/prom.c b/arch/mips/emma/common/prom.c
index b16df0a..be9b05c 100644
--- a/arch/mips/emma/common/prom.c
+++ b/arch/mips/emma/common/prom.c
@@ -30,6 +30,7 @@
  */
 #include <linux/init.h>
 #include <linux/string.h>
+#include <linux/kernel.h>
 
 #include <asm/bootinfo.h>
 #include <asm/emma/prom.h>
@@ -102,3 +103,57 @@ char * __init prom_getenv(char *envname)
 void __init prom_free_prom_memory(void)
 {
 }
+
+#ifdef CONFIG_EMMA_HAS_NEC_CANDY
+
+static inline unsigned char str2hexnum(unsigned char c)
+{
+	if (c >= '0' && c <= '9')
+		return c - '0';
+	if (c >= 'a' && c <= 'f')
+		return c - 'a' + 10;
+	if (c >= 'A' && c <= 'F')
+		return c - 'A' + 10;
+	return 0; /* foo */
+}
+
+static inline void str2eaddr(unsigned char *ea, unsigned char *str)
+{
+	int i;
+
+	for (i = 0; i < 6; i++) {
+		unsigned char num;
+
+		if ((*str == '.') || (*str == ':'))
+			str++;
+		num  = str2hexnum(*str++) << 4;
+		num |= str2hexnum(*str++);
+		ea[i] = num;
+	}
+}
+
+int get_ethernet_addr(unsigned char *ethernet_addr)
+{
+	char *str;
+	char *cmdline;
+
+	/* Check the environment variables first */
+	str = prom_getenv("ethaddr");
+	if (!str) {
+		/* Check command line */
+		cmdline = prom_getcmdline();
+		str = strstr(cmdline, "ethaddr=");
+		if (!str) {
+			printk(KERN_INFO "ethaddr is not set in boot prom\n");
+			return -1;
+		}
+
+		str += strlen("ethaddr=");
+	}
+
+	str2eaddr(ethernet_addr, str);
+
+	return 0;
+}
+
+#endif /* CONFIG_EMMA_HAS_NEC_CANDY */
diff --git a/include/asm-mips/emma/prom.h b/include/asm-mips/emma/prom.h
index 56c382d..b160b21 100644
--- a/include/asm-mips/emma/prom.h
+++ b/include/asm-mips/emma/prom.h
@@ -15,5 +15,6 @@ extern char **prom_envp;
 extern char *prom_getcmdline(void);
 extern char *prom_getenv(char *envname);
 extern void prom_init_cmdline(void);
+extern int get_ethernet_addr(unsigned char *ethernet_addr);
 
 #endif /* _ASM_EMMA_PROM_H */
-- 
1.6.3.3

