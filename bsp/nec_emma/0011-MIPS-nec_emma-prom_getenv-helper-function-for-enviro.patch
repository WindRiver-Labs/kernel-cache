From 5c39efc4dfcb78c4e62f541468087e8a07d5edd4 Mon Sep 17 00:00:00 2001
From: Shinya Kuribayashi <shinya.kuribayashi@necel.com>
Date: Mon, 7 Sep 2009 09:20:11 +0900
Subject: [PATCH 11/18] MIPS: nec_emma: prom_getenv - helper function for environment variable

Prom_getenv searches for the given environment variable in the passed
environment array, and if it's found returns a pointer to the "value"
string.

This is derived from Malta version of prom_getenv(), so it's meant for
YAMON.  Note that YAMON passes "name" and "value" strings with separate
prom_envp[] pointers.

Signed-off-by: Shinya Kuribayashi <shinya.kuribayashi@necel.com>
---
 arch/mips/emma/common/prom.c |   26 ++++++++++++++++++++++++++
 include/asm-mips/emma/prom.h |    2 ++
 2 files changed, 28 insertions(+), 0 deletions(-)

diff --git a/arch/mips/emma/common/prom.c b/arch/mips/emma/common/prom.c
index 7827a42..46ec5a4 100644
--- a/arch/mips/emma/common/prom.c
+++ b/arch/mips/emma/common/prom.c
@@ -1,6 +1,12 @@
 /*
  * Copyright (C) 2009  NEC Electronics Corporation
  *
+ * PROM library initialisation code:
+ * Copyright (C) 1999, 2000, 2004, 2005  MIPS Technologies, Inc.
+ *	All rights reserved.
+ *	Authors: Carsten Langgaard <carstenl@mips.com>
+ *		 Maciej W. Rozycki <macro@mips.com>
+ *
  * Kernel command line creation using the prom monitor (YAMON) argc/argv:
  * Carsten Langgaard, carstenl@mips.com
  * Copyright (C) 1999,2000 MIPS Technologies, Inc.  All rights reserved.
@@ -26,6 +32,7 @@
 
 int prom_argc;
 char **prom_argv;
+char **prom_envp;
 
 char * __init prom_getcmdline(void)
 {
@@ -53,6 +60,25 @@ void __init prom_init_cmdline(void)
 	}
 }
 
+char * __init prom_getenv(char *envname)
+{
+	int index, len;
+
+	index = 0;
+	len = strlen(envname);
+
+	/*
+	 * Return a pointer to the given environment variable.
+	 */
+	while (prom_envp[index]) {
+		if (strncmp(envname, prom_envp[index], len) == 0)
+			return prom_envp[index + 1];
+		index += 2;
+	}
+
+	return NULL;
+}
+
 void __init prom_free_prom_memory(void)
 {
 }
diff --git a/include/asm-mips/emma/prom.h b/include/asm-mips/emma/prom.h
index 213a68f..56c382d 100644
--- a/include/asm-mips/emma/prom.h
+++ b/include/asm-mips/emma/prom.h
@@ -10,8 +10,10 @@
 
 extern int prom_argc;
 extern char **prom_argv;
+extern char **prom_envp;
 
 extern char *prom_getcmdline(void);
+extern char *prom_getenv(char *envname);
 extern void prom_init_cmdline(void);
 
 #endif /* _ASM_EMMA_PROM_H */
-- 
1.6.3.3

