From 7ee873a52c0014b550b014f0802f52ea1b89edaf Mon Sep 17 00:00:00 2001
From: Shinya Kuribayashi <shinya.kuribayashi@necel.com>
Date: Mon, 7 Sep 2009 09:20:44 +0900
Subject: [PATCH 12/18] MIPS: nec_emma: prom_getenv: U-Boot-style environment string support

While YAMON passes "name" and "value" strings with separate prom_envp[]
pointers, U-Boot concatenates them in single "name=value" form.

In order to handle both styles, search for '=' character in prom_envp[0]
string first, and if it's not there assume we're accompanied by YAMON.

This is derived from Alchemy's PROM routines (au1000/common/prom.c).

Signed-off-by: Shinya Kuribayashi <shinya.kuribayashi@necel.com>
---
 arch/mips/emma/common/prom.c |   21 +++++++++++++++++----
 1 files changed, 17 insertions(+), 4 deletions(-)

diff --git a/arch/mips/emma/common/prom.c b/arch/mips/emma/common/prom.c
index 46ec5a4..12eb89b 100644
--- a/arch/mips/emma/common/prom.c
+++ b/arch/mips/emma/common/prom.c
@@ -1,6 +1,10 @@
 /*
  * Copyright (C) 2009  NEC Electronics Corporation
  *
+ * PROM library initialisation code, supports YAMON and U-Boot:
+ * Copyright 2000-2001, 2006, 2008 MontaVista Software Inc.
+ * Author: MontaVista Software, Inc. <source@mvista.com>
+ *
  * PROM library initialisation code:
  * Copyright (C) 1999, 2000, 2004, 2005  MIPS Technologies, Inc.
  *	All rights reserved.
@@ -62,18 +66,27 @@ void __init prom_init_cmdline(void)
 
 char * __init prom_getenv(char *envname)
 {
-	int index, len;
+	int index, len, yamon;
 
 	index = 0;
 	len = strlen(envname);
+	yamon = (prom_envp[0] && strchr(prom_envp[0], '=') == NULL);
 
 	/*
 	 * Return a pointer to the given environment variable.
+	 * YAMON uses "name", "value" pairs, while U-Boot uses "name=value".
 	 */
 	while (prom_envp[index]) {
-		if (strncmp(envname, prom_envp[index], len) == 0)
-			return prom_envp[index + 1];
-		index += 2;
+		if (yamon) {
+			if (strncmp(envname, prom_envp[index], len) == 0)
+				return prom_envp[index + 1];
+			index += 2;
+		} else {
+			if (strncmp(envname, prom_envp[index], len) == 0 &&
+			    *(prom_envp[index] + len) == '=')
+				return prom_envp[index] + len + 1;
+			index++;
+		}
 	}
 
 	return NULL;
-- 
1.6.3.3

