From 63887f29c98df6460f2277e372c73ce6f34ff6d6 Mon Sep 17 00:00:00 2001
From: Shinya Kuribayashi <shinya.kuribayashi@necel.com>
Date: Mon, 7 Sep 2009 09:19:31 +0900
Subject: [PATCH 10/18] MIPS: nec_emma: Introduce MIPS Malta's PROM command line routines

One of the problems with our current PROM implementation is that we can
not handle environment variables.  Environment variables are different
with the command-line options, and used for passing various information;
memory size, console configurations, ethernet MAC addresses, etc.  Main
boot loaders such as YAMON(TM) and U-Boot are capable of passing
environment variables along with the command-line options.

From EMMA platform's standpoint, we may be as well to support environment
variables sooner than later.  For instance, we can utilize them as a
means to pass the ethernet MAC address used for NEC Candy.

There are several MIPS ports which support environment variables, and
from among those we'd like to follow the Malta's PROM implementation.
Its PROM library is wiedely used by other ports, and of course capable
of processing environment variables.

As a first step, this patch simply introduces its prom_init_cmdline()
and prom_getcmdline() with little modification.  We'll fix bugs, and
enhance a function later in the patch series.

Signed-off-by: Shinya Kuribayashi <shinya.kuribayashi@necel.com>
---
 arch/mips/emma/common/prom.c |   67 +++++++++++++++++++++++-------------------
 include/asm-mips/emma/prom.h |    4 ++
 2 files changed, 41 insertions(+), 30 deletions(-)

diff --git a/arch/mips/emma/common/prom.c b/arch/mips/emma/common/prom.c
index 780a45b..7827a42 100644
--- a/arch/mips/emma/common/prom.c
+++ b/arch/mips/emma/common/prom.c
@@ -1,48 +1,55 @@
 /*
- *  arch/mips/emma/common/prom.c
- *      This file is prom file.
+ * Copyright (C) 2009  NEC Electronics Corporation
  *
- *  Copyright (C) NEC Electronics Corporation 2004-2007
+ * Kernel command line creation using the prom monitor (YAMON) argc/argv:
+ * Carsten Langgaard, carstenl@mips.com
+ * Copyright (C) 1999,2000 MIPS Technologies, Inc.  All rights reserved.
  *
- *  This file is based on the arch/mips/ddb5xxx/common/prom.c
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * (version 2) as published by the Free Software Foundation.
  *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
  *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software Foundation,
+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
  */
 #include <linux/init.h>
 #include <linux/string.h>
 
 #include <asm/bootinfo.h>
+#include <asm/emma/prom.h>
+
+int prom_argc;
+char **prom_argv;
+
+char * __init prom_getcmdline(void)
+{
+	return &(arcs_cmdline[0]);
+}
 
-/* [jsun@junsun.net] PMON passes arguments in C main() style */
 void __init prom_init_cmdline(void)
 {
-	int argc = fw_arg0;
-	char **arg = (char **)fw_arg1;
-	int i;
+	char *cp;
+	int actr;
 
-	/* if user passes kernel args, ignore the default one */
-	if (argc > 1)
-		arcs_cmdline[0] = '\0';
+	actr = 1; /* Always ignore argv[0] */
 
-	/* arg[0] is "g", the rest is boot parameters */
-	for (i = 1; i < argc; i++) {
-		if (strlen(arcs_cmdline) + strlen(arg[i] + 1)
-		    >= sizeof(arcs_cmdline))
-			break;
-		strcat(arcs_cmdline, arg[i]);
-		strcat(arcs_cmdline, " ");
+	cp = &(arcs_cmdline[0]);
+	while (actr < prom_argc) {
+		strcpy(cp, prom_argv[actr]);
+		cp += strlen(prom_argv[actr]);
+		*cp++ = ' ';
+		actr++;
+	}
+	if (cp != &(arcs_cmdline[0])) {
+		/* get rid of trailing space */
+		--cp;
+		*cp = '\0';
 	}
 }
 
diff --git a/include/asm-mips/emma/prom.h b/include/asm-mips/emma/prom.h
index 10408af..213a68f 100644
--- a/include/asm-mips/emma/prom.h
+++ b/include/asm-mips/emma/prom.h
@@ -8,6 +8,10 @@
 #ifndef _ASM_EMMA_PROM_H
 #define _ASM_EMMA_PROM_H
 
+extern int prom_argc;
+extern char **prom_argv;
+
+extern char *prom_getcmdline(void);
 extern void prom_init_cmdline(void);
 
 #endif /* _ASM_EMMA_PROM_H */
-- 
1.6.3.3

