From b2878b6169c8e14f7311f155015c7f44d5a097f9 Mon Sep 17 00:00:00 2001
From: Liang Li <Liang.Li@windriver.com>
Date: Wed, 3 Dec 2008 17:49:08 +0800
Subject: [PATCH] Add MTD support to fsl_lite5200b BSP

-Add definition of local plus bus and flash partition into dts
-Add local plus bus probe code to platform code

Signed-off-by: Liang Li <Liang.Li@windriver.com>
---
 arch/powerpc/boot/dts/lite5200b.dts    |   44 ++++++++++++++++++++++++++++++++
 arch/powerpc/platforms/52xx/lite5200.c |   12 ++++++++
 2 files changed, 56 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/boot/dts/lite5200b.dts b/arch/powerpc/boot/dts/lite5200b.dts
index 761f2f6..ea53458 100644
--- a/arch/powerpc/boot/dts/lite5200b.dts
+++ b/arch/powerpc/boot/dts/lite5200b.dts
@@ -338,4 +338,48 @@
 			  0x02000000 0 0xa0000000 0xa0000000 0 0x10000000
 			  0x01000000 0 0x00000000 0xb0000000 0 0x01000000>;
 	};
+
+	localbus@0xf0003c00 {
+		#address-cells = <2>;
+		#size-cells = <1>;
+		compatible = "fsl,mpc5200-localbus", "simple-bus";
+		reg = <0xf0003c00 0x100>;
+		interrupt-parent = <&mpc5200_pic>;
+
+		ranges = <0x0 0x0 0xfe000000 0x01000000
+				  0x1 0x0 0xff000000 0x01000000>;
+
+		flash@0,0 {
+			#address-cells = <1>;
+			#size-cells = <1>;
+			compatible = "cfi-flash";
+			reg = <0x0 0x0 0x01000000>;
+			bank-width = <1>;
+			device-width = <1>;
+
+			partition@0 {
+				label = "data0";
+				reg = <0x00000000 0x01000000>;
+			};
+		};
+
+		flash@1,0 {
+			#address-cells = <1>;
+			#size-cells = <1>;
+			compatible = "cfi-flash";
+			reg = <0x1 0x0 0x01000000>;
+			bank-width = <1>;
+			device-width = <1>;
+
+			partition@0 {
+				label = "data1";
+				reg = <0x00000000 0x00f00000>;
+			};
+			partition@1 {
+				label = "uboot";
+				reg = <0x00f00000 0x00100000>;
+				read-only;
+			};
+		};
+	};
 };
diff --git a/arch/powerpc/platforms/52xx/lite5200.c b/arch/powerpc/platforms/52xx/lite5200.c
index 6d584f4..56e09e3 100644
--- a/arch/powerpc/platforms/52xx/lite5200.c
+++ b/arch/powerpc/platforms/52xx/lite5200.c
@@ -24,6 +24,7 @@
 #include <asm/io.h>
 #include <asm/machdep.h>
 #include <asm/prom.h>
+#include <asm/of_platform.h>
 #include <asm/mpc52xx.h>
 
 /* ************************************************************************
@@ -45,6 +46,17 @@ static struct of_device_id mpc5200_gpio_ids[] __initdata = {
 	{}
 };
 
+static struct of_device_id __initdata mpc5200_ids[] = {
+	{ .compatible = "simple-bus", },
+	{},
+};
+
+static int __init lite5200_publish_devices(void)
+{
+	return of_platform_bus_probe(NULL, mpc5200_ids, NULL);
+}
+machine_device_initcall(lite5200, lite5200_publish_devices);
+
 /*
  * Fix clock configuration.
  *
-- 
1.6.0.2.GIT

