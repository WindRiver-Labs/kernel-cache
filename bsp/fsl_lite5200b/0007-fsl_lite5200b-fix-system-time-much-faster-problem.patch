From b4a98cd0b3710061356d0b3f180c2f21198cc081 Mon Sep 17 00:00:00 2001
From: Liang Li <Liang.Li@windriver.com>
Date: Wed, 24 Jun 2009 16:30:16 +0800
Subject: [PATCH] fsl_lite5200b: fix system time much faster problem

The v1.2 U-boot pass wrong 'timebase-frequency' and 'clock-frequency' to
kernel. As the result, the system time on the target goes much faster
then real time.

To fix the problem, we have two choice, update U-boot to higher version or
calibrate corresponding values in BSP code.

Since we should not being got involved into stuff that upgrade bootloader
for ref board. Fix the issue in BSP seems reasonable for us. When we got
newer U-boot support with newer vendor drop, we may drop this patch safely.

Zumeng's patch for wrl2.0 does give me good hint on the whole issue, so
keep his SOB at here still.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
Signed-off-by: Liang Li <Liang.Li@windriver.com>
---
 arch/powerpc/platforms/52xx/lite5200.c |   16 +++++++++++++++-
 1 files changed, 15 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/platforms/52xx/lite5200.c b/arch/powerpc/platforms/52xx/lite5200.c
index 56e09e3..211899a 100644
--- a/arch/powerpc/platforms/52xx/lite5200.c
+++ b/arch/powerpc/platforms/52xx/lite5200.c
@@ -199,6 +199,20 @@ static int __init lite5200_probe(void)
 	return 1;
 }
 
+void __init lite5200_calibrate_decr(void)
+{
+	ppc_tb_freq = 33000000UL;		/* hardcoded default */
+	ppc_proc_freq = 462000000UL;	/* hardcoded default */
+
+#ifdef CONFIG_BOOKE
+	/* Clear any pending timer interrupts */
+	mtspr(SPRN_TSR, TSR_ENW | TSR_WIS | TSR_DIS | TSR_FIS);
+
+	/* Enable decrementer interrupt */
+	mtspr(SPRN_TCR, TCR_DIE);
+#endif
+}
+
 define_machine(lite5200) {
 	.name 		= "lite5200",
 	.probe 		= lite5200_probe,
@@ -207,5 +221,5 @@ define_machine(lite5200) {
 	.init_IRQ 	= mpc52xx_init_irq,
 	.get_irq 	= mpc52xx_get_irq,
 	.restart	= mpc52xx_restart,
-	.calibrate_decr	= generic_calibrate_decr,
+	.calibrate_decr	= lite5200_calibrate_decr,
 };
-- 
1.6.3.1

