From 5a95a96560773821f55af7abfa663a6c22970397 Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Mon, 13 Jul 2009 15:08:44 +0800
Subject: [PATCH 07/15] p2020ds: Add if to judge if SPI node exist in dtb and protect SPI init code with #if

Since there is no SPI node in core1 dtb and this causes boot
failed on core1, so add the judgement to avoid boot failure.
And, add #if to protect SPI init code.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/powerpc/platforms/85xx/mpc85xx_ds.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/mpc85xx_ds.c b/arch/powerpc/platforms/85xx/mpc85xx_ds.c
index ca7ec94..01fb842 100644
--- a/arch/powerpc/platforms/85xx/mpc85xx_ds.c
+++ b/arch/powerpc/platforms/85xx/mpc85xx_ds.c
@@ -140,6 +140,7 @@ static int mpc85xx_exclude_device(struct pci_controller *hose,
 }
 #endif	/* CONFIG_PCI */
 
+#if defined(CONFIG_FSL_ESPI) || defined(CONFIG_FSL_ESPI_MODULE)
 static int __init mpc85xx_spi_init(void)
 {
 	struct device_node *np, *dp = NULL;
@@ -151,6 +152,10 @@ static int __init mpc85xx_spi_init(void)
 	int i, nr_parts, bd_num = 0, n = -1;
 
 	np = of_find_compatible_node(NULL, NULL, "fsl,mpc8536-espi");
+
+	if (!np)
+		return 0;
+
 	while ((dp = of_get_next_child(np, dp)))
 		bd_num++;
 	of_node_put(np);
@@ -250,6 +255,7 @@ static int __init mpc85xx_spi_init(void)
 }
 
 device_initcall(mpc85xx_spi_init);
+#endif /* CONFIG_FSL_ESPI) || CONFIG_FSL_ESPI_MODULE */
 
 /*
  * Setup the architecture
-- 
1.6.3.3

