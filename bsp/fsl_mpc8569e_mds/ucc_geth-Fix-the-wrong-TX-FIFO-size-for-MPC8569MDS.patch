From cbf90ce3b00d1cc1ee69969f52616075f0c0e065 Mon Sep 17 00:00:00 2001
From: Luo Chunbo <chunbo.luo@windriver.com>
Date: Thu, 20 May 2010 13:34:53 +0800
Subject: [PATCH 1/2] ucc_geth: Fix the wrong TX FIFO size for MPC8569MDS

The ucc driver of the MPC8569E-MDS Rev 1.0 board cannot
work with the default UCC_GETH_UTFS_GIGA_INIT(4096),
Here we use the vlue 8192 instead for the MPC8569E-MDS.

We also add compatible "fsl,mpc8569-ucc-geth" in DTS
to identify the MPC8569E board.

Signed-off-by: Luo Chunbo <chunbo.luo@windriver.com>
---
 arch/powerpc/boot/dts/mpc8569mds.dts |   18 ++++++++++++------
 drivers/net/ucc_geth.c               |   11 ++++++++++-
 2 files changed, 22 insertions(+), 7 deletions(-)

diff --git a/arch/powerpc/boot/dts/mpc8569mds.dts b/arch/powerpc/boot/dts/mpc8569mds.dts
index 8b72eaf..18a08d5 100644
--- a/arch/powerpc/boot/dts/mpc8569mds.dts
+++ b/arch/powerpc/boot/dts/mpc8569mds.dts
@@ -526,7 +526,8 @@
 
 		enet0: ucc@2000 {
 			device_type = "network";
-			compatible = "ucc_geth";
+			compatible = "fsl,mpc8569-ucc-geth",
+				     "ucc_geth";
 			cell-index = <1>;
 			reg = <0x2000 0x200>;
 			interrupts = <32>;
@@ -609,7 +610,8 @@
 
 		enet2: ucc@2200 {
 			device_type = "network";
-			compatible = "ucc_geth";
+			compatible = "fsl,mpc8569-ucc-geth",
+				     "ucc_geth";
 			cell-index = <3>;
 			reg = <0x2200 0x200>;
 			interrupts = <34>;
@@ -636,7 +638,8 @@
 
 		enet1: ucc@3000 {
 			device_type = "network";
-			compatible = "ucc_geth";
+			compatible = "fsl,mpc8569-ucc-geth",
+				     "ucc_geth";
 			cell-index = <2>;
 			reg = <0x3000 0x200>;
 			interrupts = <33>;
@@ -663,7 +666,8 @@
 
 		enet3: ucc@3200 {
 			device_type = "network";
-			compatible = "ucc_geth";
+			compatible = "fsl,mpc8569-ucc-geth",
+				     "ucc_geth";
 			cell-index = <4>;
 			reg = <0x3200 0x200>;
 			interrupts = <35>;
@@ -690,7 +694,8 @@
 
 		enet5: ucc@3400 {
 			device_type = "network";
-			compatible = "ucc_geth";
+			compatible = "fsl,mpc8569-ucc-geth",
+				     "ucc_geth";
 			cell-index = <6>;
 			reg = <0x3400 0x200>;
 			interrupts = <41>;
@@ -705,7 +710,8 @@
 
 		enet7: ucc@3600 {
 			device_type = "network";
-			compatible = "ucc_geth";
+			compatible = "fsl,mpc8569-ucc-geth",
+				     "ucc_geth";
 			cell-index = <8>;
 			reg = <0x3600 0x200>;
 			interrupts = <43>;
diff --git a/drivers/net/ucc_geth.c b/drivers/net/ucc_geth.c
index 1b0aef3..418b30c 100644
--- a/drivers/net/ucc_geth.c
+++ b/drivers/net/ucc_geth.c
@@ -3867,11 +3867,20 @@ static int ucc_geth_probe(struct of_device* ofdev, const struct of_device_id *ma
 		ug_info->uf_info.urfs = UCC_GETH_URFS_GIGA_INIT;
 		ug_info->uf_info.urfet = UCC_GETH_URFET_GIGA_INIT;
 		ug_info->uf_info.urfset = UCC_GETH_URFSET_GIGA_INIT;
-		ug_info->uf_info.utfs = UCC_GETH_UTFS_GIGA_INIT;
 		ug_info->uf_info.utfet = UCC_GETH_UTFET_GIGA_INIT;
 		ug_info->uf_info.utftt = UCC_GETH_UTFTT_GIGA_INIT;
 		ug_info->numThreadsTx = UCC_GETH_NUM_OF_THREADS_4;
 
+		/* The ucc driver of the MPC8569E-MDS Rev 1.0 board cannot
+		 * work with the default UCC_GETH_UTFS_GIGA_INIT(4096).
+		 * Here we use the vlue 8192 instead for the MPC8569E-MDS
+		 */
+		if (of_device_is_compatible(np, "fsl,mpc8569-ucc-geth") &&
+		    mfspr(SPRN_SVR) == 0x80880010)
+			ug_info->uf_info.utfs = 8192;
+		else
+			ug_info->uf_info.utfs = UCC_GETH_UTFS_GIGA_INIT;
+
 		/* If QE's snum number is 46 which means we need to support
 		 * 4 UECs at 1000Base-T simultaneously, we need to allocate
 		 * more Threads to Rx.
-- 
1.6.5.2

