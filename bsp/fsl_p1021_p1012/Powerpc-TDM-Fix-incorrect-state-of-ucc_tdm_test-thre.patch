From 429be7daa2b153e016a403af95397cae03acf057 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Mon, 19 Sep 2011 19:31:05 +0800
Subject: [PATCH] Powerpc:TDM:Fix incorrect state of ucc_tdm_test thread

During remove the ucc_tdm_test module operation, the tdm test thread
introduces exception:

ops: Exception in kernel mode, sig: 4 [#1]
PREEMPT SMP NR_CPUS=2 LTT NESTING LEVEL : 0
P1021 MDS
last sysfs file: /sys/kernel/uevent_seqnum
Modules linked in: binfmt_misc ipv6 [last unloaded: ucc_tdm_test]
NIP: e22b91a0 LR: e22b91a0 CTR: c0044dd0
REGS: deea9e60 TRAP: 0700   Not tainted  (2.6.34.10-rt-WR4.3.0.0_preempt_rt)
MSR: 00029000 <EE,ME,CE>  CR: 24424022  XER: 20000000
TASK = def246b0[1742] 'tdm_thread' THREAD: deea8000 CPU: 1
GPR00: e22b91a0 deea9f10 def246b0 00000000 000002c3 000002c3 00008000 ffffffff
GPR08: 00000003 def246b0 def246b0 00000000 0000003c d81c6200 1ff95100 00000000
GPR16: 00000000 1ff88adc 1ff88adc 1ffb13b4 00000000 00000000 c0728000 00000000
GPR24: 00000000 00000002 00000000 c0075b1c c072d320 00000000 e22b9164 e22b940c
NIP [e22b91a0] 0xe22b91a0
LR [e22b91a0] 0xe22b91a0
Call Trace:
[deea9f10] [e22b91a0] 0xe22b91a0 (unreliable)
[deea9fa0] [c0075b94] kthread+0x78/0x7c
[deea9ff0] [c0011f04] original_kernel_thread+0x4c/0x68
Instruction dump:
XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX
XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX
BUG: using smp_processor_id() in preemptible [00000000] code: tdm_thread/1742
caller is die+0xc8/0x224
Call Trace:
[deea9cd0] [c00084d8] show_stack+0x44/0x160 (unreliable)
[deea9d00] [c036378c] debug_smp_processor_id+0xe0/0xf0
[deea9d20] [c000f1ec] die+0xc8/0x224
[deea9d50] [c000f590] _exception+0xe4/0x200
[deea9e50] [c0012d00] ret_from_prog_exc+0x0/0x4
-- Exception: 700 at 0xe22b91a0
    LR = 0xe22b91a0
[deea9fa0] [c0075b94] kthread+0x78/0x7c
[deea9ff0] [c0011f04] original_kernel_thread+0x4c/0x68
--[ end trace 49e82c42943fa398 ]---

This is caused by incorrect state indicated by tdm_thread_state.
The UCC_TDM_TEST module involve tdm_thread_state to determine whether
need stop test thread when free module. The value of this variable
should be 1 when thread running and 0 when thread finished.

The patch sets tdm_thread_state to 1 when thread started, and sets it
to 0 before thread exit.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/tdm/test/ucc_tdm_test.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/tdm/test/ucc_tdm_test.c b/drivers/tdm/test/ucc_tdm_test.c
index cc8e2d0..15a8d37 100644
--- a/drivers/tdm/test/ucc_tdm_test.c
+++ b/drivers/tdm/test/ucc_tdm_test.c
@@ -83,7 +83,7 @@ static int tdm_thread(void *ptr)
 {
 	u8 send_buf[WRITE_LEN];
 	int i;
-
+	tdm_thread_state = 1;
 	for (i = 0; i < 0x80; i++)
 		send_buf[i] = i;
 	/* start TDM */
@@ -95,6 +95,7 @@ static int tdm_thread(void *ptr)
 	/* stop TDM */
 	tdm_master_disable(&test_tdmdev_driver);
 
+	tdm_thread_state = 0;
 	return 0;
 }
 static int test_attach_adapter(struct tdm_adapter *adap)
-- 
1.7.0.4

