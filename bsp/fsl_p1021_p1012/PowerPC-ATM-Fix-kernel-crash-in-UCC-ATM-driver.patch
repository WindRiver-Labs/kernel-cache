From 29243083bcf80772e9e0759cb6fae1aa31d1286c Mon Sep 17 00:00:00 2001
From: Hongjun Chen <Hong-jun.chen@freescale.com>
Date: Tue, 13 Apr 2010 15:23:23 +0800
Subject: [PATCH 06/10] PowerPC:ATM:Fix kernel crash in UCC ATM driver

UCC ATM driver would lead kernel crash when there is no ATM hardware
present. This is caused by reference to NULL pointer in failure
routine of UCC ATM driver.

The patch fixed the issue by adding NULL-pointer check.

Signed-off-by: Hongjun Chen <Hong-jun.chen@freescale.com>

[Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-Fix-kernel-crash-in-ATM-driver.patch
]

Integrated-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/atm/suni5384.c |   14 ++++++++------
 1 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/drivers/atm/suni5384.c b/drivers/atm/suni5384.c
index b66c2d2..7949488 100644
--- a/drivers/atm/suni5384.c
+++ b/drivers/atm/suni5384.c
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2006-2009 Freescale Semiconductor, Inc. All rights reserved.
+ * Copyright (C) 2006-2010 Freescale Semiconductor, Inc. All rights reserved.
  *
  * Author: Dave Liu (daveliu@freescale.com)
  *         Tony Li (tony.li@freescale.com)
@@ -235,12 +235,14 @@ static int suni_stop(struct atm_dev *dev)
 {
 	struct suni_priv **walk;
 	unsigned long flags;
+	spin_lock_irqsave(&sunis_lock, flags);
+	if (PRIV(dev)) {
+		/* let SAR driver worry about stopping interrupts */
+		for (walk = &sunis; *walk != PRIV(dev);
+			walk = &(*walk)->next);
+		*walk = (*walk)->next;
+	}
 
-	/* let SAR driver worry about stopping interrupts */
-	spin_lock_irqsave(&sunis_lock,flags);
-	for (walk = &sunis; *walk != PRIV(dev);
-		walk = &(*walk)->next);
-	*walk = (*walk)->next;
 	if (!sunis) del_timer_sync(&poll_timer);
 	spin_unlock_irqrestore(&sunis_lock,flags);
 
-- 
1.7.0.2

