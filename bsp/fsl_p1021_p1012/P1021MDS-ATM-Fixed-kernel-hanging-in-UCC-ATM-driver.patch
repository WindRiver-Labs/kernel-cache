From 0776355cc5d66eab5be13327f12e5e771851d061 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Tue, 16 Aug 2011 18:11:08 +0800
Subject: [PATCH 10/10] P1021MDS:ATM:Fixed kernel hanging in UCC ATM driver

Without atm card inserting on the board, the atm driver will fail to probe.
Then it will call suni_stop to release its timer, which is only initialized
during the normal process. This will cause the kernel hanging.
Add another flag to release the timer correctly.

Signed-off-by: Kai.Jiang <Kai.Jiang@freescale.com>

[Extracted from the P1021MDS-20101124-ltib.iso vendor drop.
linux-2.6.32-Fixed-kernel-hanging-without-atm-card-inserting-1.patch]

Integrated-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/atm/suni5384.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/drivers/atm/suni5384.c b/drivers/atm/suni5384.c
index 7949488..4f64860 100644
--- a/drivers/atm/suni5384.c
+++ b/drivers/atm/suni5384.c
@@ -243,7 +243,9 @@ static int suni_stop(struct atm_dev *dev)
 		*walk = (*walk)->next;
 	}
 
-	if (!sunis) del_timer_sync(&poll_timer);
+	if (!sunis && (poll_timer.data != 0))
+		del_timer_sync(&poll_timer);
+
 	spin_unlock_irqrestore(&sunis_lock,flags);
 
 	return 0;
-- 
1.7.0.2

