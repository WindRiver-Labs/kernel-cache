From a419020a7a5524249ae2c0b3866c450c95da9bc9 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Fri, 26 Aug 2011 13:37:57 +0800
Subject: [PATCH 1/2] PowerPC:P1021MDS:Update device tree

The Main changes include:
- Add IEEE 1588 support
- power node added to enable PM
- timer node added to test wakeup from timer
- Add ATM & UTOPIA node
- Update multi-host-mode property in crypto node of AMP device tree

All these changes are extracted from vendor drop
QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/boot/dts/p1021mds.dts            |  143 +++++++++++++++++++++++++
 arch/powerpc/boot/dts/p1021mds_camp_core0.dts |    2 +
 arch/powerpc/boot/dts/p1021mds_camp_core1.dts |    2 +-
 arch/powerpc/boot/dts/p1021mds_tdm.dts        |    8 +-
 4 files changed, 152 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/boot/dts/p1021mds.dts b/arch/powerpc/boot/dts/p1021mds.dts
index d0b9ca7..ae5fd48 100644
--- a/arch/powerpc/boot/dts/p1021mds.dts
+++ b/arch/powerpc/boot/dts/p1021mds.dts
@@ -427,6 +427,16 @@
 			};
 		};
 
+		ptp_timer: ptimer@b0e00 {
+			compatible = "fsl,gianfar-ptp-timer";
+			reg = <0xb0e00 0xb0>;
+			interrupts = <68 2 69 2 70 2>;
+			interrupt-parent = <&mpic>;
+			tmr-prsc = <0x2>;
+			cksel = <1>;
+			timer-frequency = <200000000>;
+		};
+
 		enet0: ethernet@B0000 {
 			#address-cells = <1>;
 			#size-cells = <1>;
@@ -436,9 +446,12 @@
 			compatible = "fsl,etsec2";
 			fsl,num_rx_queues = <0x8>;
 			fsl,num_tx_queues = <0x8>;
+			fsl,magic-packet;
+			clk-handle = <&etsec1_clk>;
 			local-mac-address = [ 00 00 00 00 00 00 ];
 			interrupt-parent = <&mpic>;
 			phy-handle = <&phy0>;
+			ptimer-handle = <&ptp_timer>;
 			phy-connection-type = "rgmii-id";
 			queue-group@0{
 				#address-cells = <1>;
@@ -463,9 +476,12 @@
 			compatible = "fsl,etsec2";
 			fsl,num_rx_queues = <0x8>;
 			fsl,num_tx_queues = <0x8>;
+			fsl,magic-packet;
+			clk-handle = <&etsec2_clk>;
 			local-mac-address = [ 00 00 00 00 00 00 ];
 			interrupt-parent = <&mpic>;
 			phy-handle = <&phy4>;
+			ptimer-handle = <&ptp_timer>;
 			tbi-handle = <&tbi0>;
 			phy-connection-type = "sgmii";
 			queue-group@0{
@@ -491,9 +507,12 @@
 			compatible = "fsl,etsec2";
 			fsl,num_rx_queues = <0x8>;
 			fsl,num_tx_queues = <0x8>;
+			fsl,magic-packet;
+			clk-handle = <&etsec3_clk>;
 			local-mac-address = [ 00 00 00 00 00 00 ];
 			interrupt-parent = <&mpic>;
 			phy-handle = <&phy1>;
+			ptimer-handle = <&ptp_timer>;
 			phy-connection-type = "rgmii-id";
 			queue-group@0{
 				#address-cells = <1>;
@@ -529,6 +548,29 @@
 			fsl,channel-fifo-len = <24>;
 			fsl,exec-units-mask = <0x97c>;
 			fsl,descriptor-types-mask = <0x3a30abf>;
+			fsl,multi-host-mode = "dual";
+			fsl,channel-remap = <0x3>;
+		};
+
+		power@e0070{
+			compatible = "fsl,mpc8548-pmc", "fsl,p1021-pmc";
+			reg = <0xe0070 0x20>;
+			etsec1_clk: soc-clk@B0{
+				fsl,pmcdr-mask = <0x00000080>;
+			};
+			etsec2_clk: soc-clk@B1{
+				fsl,pmcdr-mask = <0x00000040>;
+			};
+			etsec3_clk: soc-clk@B2{
+				fsl,pmcdr-mask = <0x00000020>;
+			};
+		};
+
+		timer@41100 {
+			compatible = "fsl,mpic-global-timer";
+			reg = <0x41100 0x204>;
+			interrupts = <0xf7 0x2>;
+			interrupt-parent = <&mpic>;
 		};
 
 		mpic: pic@40000 {
@@ -677,6 +719,75 @@
 		};
 	};
 
+	qoc3@f8010000 {
+		#address-cells = <1>;
+		#size-cells = <1>;
+		#interrupt-cells = <2>;
+		device_type = "qoc3 atm card";
+		ranges = <0 0 0xf8010000 0x1e00>;
+		compatible = "simple-bus";
+
+		pm5384a: fua-phy@e00 {
+			device_type = "atm phy";
+			compatible = "fua-phy";
+			device-id = <1>;
+			reg = <0xe00 0x200>;
+			interrupt-parent = <&mpic>;
+			interrupts = <4 1>;
+			upc-slot = <&upcs0>;
+			ucc-handle = <&ucc_atm>;
+			line_bitr = <0x93d1cc0>;  /* 155000000 - 0x93d1cc0 */
+			max_bitr = <0x93d1cc0>;   /* 50000000  - 0x2faf080 */
+			min_bitr = <0x2faf080>;
+			port-width = <0>;
+		};
+
+		pm5384b: fua-phy@1600 {
+			device_type = "atm phy";
+			compatible = "fua-phy";
+			device-id = <2>;
+			reg = <0x1600 0x200>;
+			interrupt-parent = <&mpic>;
+			interrupts = <4 1>;
+			upc-slot = <&upcs0>;
+			ucc-handle = <&ucc_atm>;
+			line_bitr = <0x93d1cc0>;
+			max_bitr = <0x93d1cc0>;
+			min_bitr = <0x2faf080>;
+			port-width = <0>;
+		};
+
+		pm5384c: fua-phy@1a00 {
+			device_type = "atm phy";
+			compatible = "fua-phy";
+			device-id = <3>;
+			reg = <0x1a00 0x200>;
+			interrupt-parent = <&mpic>;
+			interrupts = <5 1>;
+			upc-slot = <&upcs0>;
+			ucc-handle = <&ucc_atm>;
+			line_bitr = <0x93d1cc0>;
+			max_bitr = <0x93d1cc0>;
+			min_bitr = <0x2faf080>;
+			port-width = <0>;
+		};
+
+		pm5384d: fua-phy@1c00 {
+			device_type = "atm phy";
+			compatible = "fua-phy";
+			device-id = <4>;
+			reg = <0x1c00 0x200>;
+			interrupt-parent = <&mpic>;
+			interrupts = <5 1>;
+			upc-slot = <&upcs0>;
+			ucc-handle = <&ucc_atm>;
+			line_bitr = <0x93d1cc0>;
+			max_bitr = <0x93d1cc0>;
+			min_bitr = <0x2faf080>;
+			port-width = <0>;
+		};
+	};
+
 	pci0: pcie@ffe09000 {
 		compatible = "fsl,mpc8548-pcie";
 		cell-index = <2>;
@@ -798,6 +909,28 @@
 			};
 		};
 
+		upc@2e00 {
+			#address-cells = <1>;
+			#size-cells = <0>;
+			compatible = "fsl,qe-upc";
+			device-id = <1>;
+			reg = <0x2e00 0x200>;
+			fsl,rx-clock = "clk20";
+			fsl,tx-clock = "clk19";
+			fsl,internal-clock = "clk19";
+			fsl,utopia;
+			fsl,tx-slave = <0>;
+			fsl,rx-slave = <0>;
+			fsl,address-mode = <0>;
+			pio-handle = <&pio_atm>;
+
+			upcs0: upc-slot@00 {
+				compatible = "fsl,qe-upc-slot";
+				device-id = <1>;
+				fsl,end-point = <4>;
+			};
+		};
+
 		enet3: ucc@2000 {
 			device_type = "network";
 			compatible = "ucc_geth";
@@ -876,6 +1009,16 @@
 			multithread;
 		};
 
+		ucc_atm: ucc@2200 {
+			device_type = "network";
+			compatible = "ucc_geth", "fsl,qe-ucc-atm";
+			cell-index = <3>;
+			reg = <0x2200 0x200>;
+			interrupts = <34>;
+			interrupt-parent = <&qeic>;
+			multithread;
+		};
+
 		muram@10000 {
 			#address-cells = <1>;
 			#size-cells = <1>;
diff --git a/arch/powerpc/boot/dts/p1021mds_camp_core0.dts b/arch/powerpc/boot/dts/p1021mds_camp_core0.dts
index 0a4f695..8fb2af6 100644
--- a/arch/powerpc/boot/dts/p1021mds_camp_core0.dts
+++ b/arch/powerpc/boot/dts/p1021mds_camp_core0.dts
@@ -413,6 +413,8 @@
 			fsl,channel-fifo-len = <24>;
 			fsl,exec-units-mask = <0x97c>;
 			fsl,descriptor-types-mask = <0x3a30abf>;
+			fsl,multi-host-mode = "secondary";
+			fsl,channel-remap = <0x3>;
 		};
 
 		mpic: pic@40000 {
diff --git a/arch/powerpc/boot/dts/p1021mds_camp_core1.dts b/arch/powerpc/boot/dts/p1021mds_camp_core1.dts
index bf3c1f5..11f7ff1 100644
--- a/arch/powerpc/boot/dts/p1021mds_camp_core1.dts
+++ b/arch/powerpc/boot/dts/p1021mds_camp_core1.dts
@@ -121,7 +121,7 @@
 			fsl,channel-fifo-len = <24>;
 			fsl,exec-units-mask = <0x97c>;
 			fsl,descriptor-types-mask = <0x3a30abf>;
-			fsl,multi-host-mode = "secondary";
+			fsl,multi-host-mode = "primary";
 			fsl,channel-remap = <0x3>;
 		};
 
diff --git a/arch/powerpc/boot/dts/p1021mds_tdm.dts b/arch/powerpc/boot/dts/p1021mds_tdm.dts
index 4d1ff3b..6cfe231 100644
--- a/arch/powerpc/boot/dts/p1021mds_tdm.dts
+++ b/arch/powerpc/boot/dts/p1021mds_tdm.dts
@@ -376,6 +376,11 @@
 		ptp_timer: ptimer@b0e00 {
 			compatible = "fsl,gianfar-ptp-timer";
 			reg = <0xb0e00 0xb0>;
+			interrupts = <68 2 69 2 70 2>;
+			interrupt-parent = <&mpic>;
+			tmr-prsc = <0x2>;
+			cksel = <1>;
+			timer-frequency = <200000000>;
 		};
 
 		enet0: ethernet@B0000 {
@@ -494,8 +499,7 @@
 		};
 
 		power@e0070{
-			compatible = "fsl,mpc8536-pmc", "fsl,mpc8548-pmc",
-			             "fsl,p1022-pmc";
+			compatible = "fsl,mpc8548-pmc", "fsl,p1021-pmc";
 			reg = <0xe0070 0x20>;
 			etsec1_clk: soc-clk@B0{
 				fsl,pmcdr-mask = <0x00000080>;
-- 
1.7.0.4

