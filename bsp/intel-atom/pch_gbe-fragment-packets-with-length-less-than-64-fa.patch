From 393c51a8d920ca6913a3933761a7a0ffc4e6d02f Mon Sep 17 00:00:00 2001
From: Wei Yang <Wei.Yang@windriver.com>
Date: Wed, 6 Jun 2012 12:50:19 +0800
Subject: [PATCH 09/11] pch_gbe: fragment packets with length less than 64
 fail to transmit

The ethernet driver will check the checksum of UDP/TCP packet with
length less than 64. For fragment packets, the checksum is stored
in the first fragment packet. When ethernet driver check and store
checksum in last fragment packet, the checksum value may be actually
stored in data section of UDP/TCP packet and then destroy the content
of the UDP/TCP packet.

Ethernet driver doesn't need to check the checksum of fragment packets.

Signed-off-by: Jiang Bin <bin.jiang@windriver.com>
Integrated-by: Yang Wei <wei.yang@windriver.com>
---
 .../net/ethernet/oki-semi/pch_gbe/pch_gbe_main.c   |    6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/oki-semi/pch_gbe/pch_gbe_main.c b/drivers/net/ethernet/oki-semi/pch_gbe/pch_gbe_main.c
index 1e38d50..f8ec23b 100644
--- a/drivers/net/ethernet/oki-semi/pch_gbe/pch_gbe_main.c
+++ b/drivers/net/ethernet/oki-semi/pch_gbe/pch_gbe_main.c
@@ -1181,7 +1181,8 @@ static void pch_gbe_tx_queue(struct pch_gbe_adapter *adapter,
 			iph->check = 0;
 			iph->check = ip_fast_csum((u8 *) iph, iph->ihl);
 			offset = skb_transport_offset(skb);
-			if (iph->protocol == IPPROTO_TCP) {
+			if (iph->protocol == IPPROTO_TCP &&
+						!(ip_hdr(skb)->frag_off & htons(IP_MF | IP_OFFSET))) {
 				skb->csum = 0;
 				tcp_hdr(skb)->check = 0;
 				skb->csum = skb_checksum(skb, offset,
@@ -1192,7 +1193,8 @@ static void pch_gbe_tx_queue(struct pch_gbe_adapter *adapter,
 							  skb->len - offset,
 							  IPPROTO_TCP,
 							  skb->csum);
-			} else if (iph->protocol == IPPROTO_UDP) {
+			} else if (iph->protocol == IPPROTO_UDP &&
+						!(ip_hdr(skb)->frag_off & htons(IP_MF | IP_OFFSET))) {
 				skb->csum = 0;
 				udp_hdr(skb)->check = 0;
 				skb->csum =
-- 
1.7.9.7

