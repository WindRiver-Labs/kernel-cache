From acad7c665b908042ac30e287ee327034f59cd3fc Mon Sep 17 00:00:00 2001
From: fupan li <fupan.li@windriver.com>
Date: Tue, 21 Jan 2014 10:31:23 +0800
Subject: [PATCH] atomisp: fix the call trace on standard kernel

The spin_unlock's location was wrong, which will cause the following call
trace after S3:
WARNING: at kernel/sched/core.c:3313 sub_preempt_count+0xa0/0xb0()
Hardware name: VALLEYVIEW B0 PLATFORM
Modules linked in: videobuf2_memops videobuf2_dma_contig drm_kms_helper mt9m114 videobuf2_core video x_tables ov5640_2 ip_tables ov5640_1 emgd atomisp
Pid: 1413, comm: kworker/u:14 Not tainted 3.4.43-WR5.0.1.0 #7
Call Trace:
 [<c202e573>] warn_slowpath_common+0x73/0xa0
 [<c27148e0>] ? sub_preempt_count+0xa0/0xb0
 [<c27148e0>] ? sub_preempt_count+0xa0/0xb0
 [<c202e5c3>] warn_slowpath_null+0x23/0x30
 [<c27148e0>] sub_preempt_count+0xa0/0xb0
 [<c2711137>] _raw_spin_unlock_irqrestore+0x17/0x40
 [<f883bc74>] atomisp_suspend+0x84/0x140 [atomisp]
 [<c205bb6b>] ? get_parent_ip+0xb/0x40
 [<c2320fe6>] pci_pm_suspend+0x56/0x190
 [<c205bb6b>] ? get_parent_ip+0xb/0x40
 [<c23cda92>] dpm_run_callback.isra.8+0x32/0x70
 [<c2320f90>] ? pci_pm_resume+0x100/0x100
 [<c23ce487>] __device_suspend+0x107/0x220
 [<c23ce5c0>] async_suspend+0x20/0x90
 [<c20557f6>] async_run_entry_fn+0x76/0x180
 [<c205bb6b>] ? get_parent_ip+0xb/0x40
 [<c27148b3>] ? sub_preempt_count+0x73/0xb0
 [<c2048937>] process_one_work+0x107/0x410
 [<c205e9df>] ? wake_up_process+0x1f/0x40
 [<c2046c85>] ? start_worker+0x25/0x30
 [<c2055780>] ? async_schedule+0x20/0x20
 [<c2049185>] worker_thread+0x135/0x2e0
 [<c2049050>] ? manage_workers.isra.26+0x200/0x200
 [<c2049050>] ? manage_workers.isra.26+0x200/0x200
 [<c204dce3>] kthread+0x73/0x80
 [<c204dc70>] ? __init_kthread_worker+0x40/0x40
 [<c2717e36>] kernel_thread_helper+0x6/0x10
---[ end trace 0000000000000002 ]---

Signed-off-by: fupan li <fupan.li@windriver.com>
---
 drivers/media/atomisp2/atomisp_v4l2.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/media/atomisp2/atomisp_v4l2.c b/drivers/media/atomisp2/atomisp_v4l2.c
index a27778b..852f380 100644
--- a/drivers/media/atomisp2/atomisp_v4l2.c
+++ b/drivers/media/atomisp2/atomisp_v4l2.c
@@ -470,8 +470,8 @@ static int atomisp_suspend(struct device *dev)
 				    "atomisp cannot suspend at this time.\n");
 			return -EINVAL;
 		}
-		spin_unlock_irqrestore(&isp->lock, flags);
 	}
+	spin_unlock_irqrestore(&isp->lock, flags);
 
 	/* Prepare for MRFLD IUNIT power down */
 	if (IS_MRFLD) {
-- 
1.7.5.4

