From 7b833ec9217104d0300b56c2c403a30003f47838 Mon Sep 17 00:00:00 2001
From: Limeng <Meng.Li@windriver.com>
Date: Wed, 31 May 2017 13:33:38 +0800
Subject: [PATCH] arch: arm: mach-owl: modify code to get the correct GPIO
 bank number

In SDK kernel 3.10, it gets GPIO bank number via current GPIO irq minus
the fixing GPIOA irq, but in kernel 4.1.21 irq is not fixing number, it
is mapped during add GPIO device. So we need to use the mapped irq.

Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 arch/arm/mach-owl/gpio-owl.c |   15 +++++++--------
 1 files changed, 7 insertions(+), 8 deletions(-)

diff --git a/arch/arm/mach-owl/gpio-owl.c b/arch/arm/mach-owl/gpio-owl.c
index 079fa2f..a54ac7a 100755
--- a/arch/arm/mach-owl/gpio-owl.c
+++ b/arch/arm/mach-owl/gpio-owl.c
@@ -297,6 +297,12 @@ static int owl_gpio_irq_set_type(struct irq_data *d, unsigned int flow_type)
 	return 0;
 }
 
+struct owl_gpio_bank {
+	int irq;
+};
+
+static struct owl_gpio_bank owl_gpio_banks[OWL_GPIO_BANKS];
+
 /*
  * When the summary IRQ is raised, any number of GPIO lines may be high.
  * It is the job of the summary handler to find all those GPIO lines
@@ -312,7 +318,7 @@ static void owl_gpio_irq_handler(unsigned int irq, struct irq_desc *desc)
 
 	gpioctl = act_readl(INTC_GPIOCTL);
 
-	bank = irq - OWL_IRQ_GPIOA;
+	bank = irq - owl_gpio_banks[0].irq;
 
 	if (bank >= 0 && bank < 5) {
 		if (gpioctl & (1 << ((bank * 5)))) {
@@ -340,13 +346,6 @@ static struct irq_chip owl_gpio_irq_chip = {
 	.irq_set_type   = owl_gpio_irq_set_type,
 };
 
-struct owl_gpio_bank {
-	int irq;
-};
-
-static struct owl_gpio_bank owl_gpio_banks[OWL_GPIO_BANKS];
-
-
 static struct of_device_id owl_gpio_of_match[] = {
 	{ .compatible = "actions,atm7039c-gpio"},
 	{ .compatible = "actions,atm7059a-gpio"},
-- 
1.7.5.4

