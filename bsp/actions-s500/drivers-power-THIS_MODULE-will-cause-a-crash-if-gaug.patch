From 465fc07e8282e41bf209a862b44aaaf535f0f855 Mon Sep 17 00:00:00 2001
From: Limeng <Meng.Li@windriver.com>
Date: Wed, 5 Apr 2017 16:29:38 +0800
Subject: [PATCH 1/3] drivers: power: THIS_MODULE will cause a crash if gauge
 driver is built into image with static style.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

After enable PMIC gauge function, there will be crash as below:
Unable to handle kernel NULL pointer dereference at virtual address 00000080
pgd = c0004000
[00000080] *pgd=00000000
Internal error: Oops: 5 [#1] PREEMPT SMP ARM
Modules linked in:
CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.1.21-WR8.0.0.0_standard #22
Hardware name: gs705a
task: eb4e8000 ti: eb4be000 task.ti: eb4be000
PC is at atc260x_gauge_init+0x18/0x4c
LR is at vprintk_emit+0x440/0x4bc
pc : [<c0b37d04>]    lr : [<c0075cc0>]    psr: 60000113
sp : eb4bfe90  ip : eb4bfde8  fp : eb4bfea4
r10: 00000000  r9 : c0c3bf00  r8 : c0ba2320
r7 : c0ba2320  r6 : 00000000  r5 : c0b37cec  r4 : 00000000
r3 : 00000000  r2 : 00000000  r1 : 00000000  r0 : 0000004d
Flags: nZCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment kernel
Control: 10c5387d  Table: 0000404a  DAC: 00000015
Process swapper/0 (pid: 1, stack limit = 0xeb4be210)
Stack: (0xeb4bfe90 to 0xeb4c0000)
fe80:                                     ea93a600 c0b37cec eb4bff1c eb4bfea8
fea0: c0009774 c0b37cf8 00000000 c0bb44e0 60000113 c004e6ac eb4bfe00 eb4bfec8
fec0: c0b02600 c038c8b4 ef2ffa4d ef2ffa56 eb4bff1c eb4bfee0 c004e8f0 c0b025f0
fee0: 000000d8 00000006 00000006 000000d9 c0b5fb08 00000006 00000006 000000d9
ff00: c0b87e40 c0b5fb24 c0c3bf00 c0c3bf00 eb4bff94 eb4bff20 c0b02eb8 c000966c
ff20: 00000006 00000006 c0b025e4 ffffffff ffeffeff ffffffff ffffffff ffffffff
ff40: ffffffff ffffffff eb4e8540 c07f8fcc 00000000 c0804374 eb4bff74 eb4bff68
ff60: c0804374 c00561e4 eb4bff94 eb4bff78 c0c3bf00 c07f8fcc 00000000 00000000
ff80: 00000000 00000000 eb4bffac eb4bff98 c07f8fe8 c0b02d2c 00000000 c07f8fcc
ffa0: 00000000 eb4bffb0 c000f3c8 c07f8fd8 00000000 00000000 00000000 00000000
ffc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
ffe0: 00000000 00000000 00000000 00000000 00000013 00000000 ffffffff ffffffff
[<c0b37d04>] (atc260x_gauge_init) from [<c0009774>] (do_one_initcall+0x114/0x1c4)
[<c0009774>] (do_one_initcall) from [<c0b02eb8>] (kernel_init_freeable+0x198/0x294)
[<c0b02eb8>] (kernel_init_freeable) from [<c07f8fe8>] (kernel_init+0x1c/0xf4)
[<c07f8fe8>] (kernel_init) from [<c000f3c8>] (ret_from_fork+0x14/0x2c)
Code: e24cb004 e3a04000 e59f0024 ebf30991 (e5943080)
---[ end trace 06553da39f228a0a ]---

The reason is that gauge driver is built into image with static style
and THIS_MODULE is used as a pointer.

This issues is introduced by commit 09053722fe0b
(“pmu: add atc260x pmu driver”) when merge SDK patch related with
pmu driver.

Therefore, remove THIS_MODULE and use string to indicate driver’s
name and version

Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/power/atc260x_cap_gauge.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/power/atc260x_cap_gauge.c b/drivers/power/atc260x_cap_gauge.c
index fe5f7cb..1b0e05c 100755
--- a/drivers/power/atc260x_cap_gauge.c
+++ b/drivers/power/atc260x_cap_gauge.c
@@ -3055,7 +3055,7 @@ static struct platform_driver atc260x_gauge_driver = {
 static int __init atc260x_gauge_init(void)
 {
 	GAUGE_INFO("========This is a new reconstructed gauge by actions==========\n");
-	GAUGE_INFO("[%s] drv name:%s, drv version:%s\n", __func__, THIS_MODULE->name, THIS_MODULE->version);
+	GAUGE_INFO("[%s] drv name:%s, drv version:%s\n", __func__, "atc260x-cap-gauge", "Actions-v1-20150720151405");
 	return platform_driver_register(&atc260x_gauge_driver);
 }
 module_init(atc260x_gauge_init);
-- 
1.7.5.4

