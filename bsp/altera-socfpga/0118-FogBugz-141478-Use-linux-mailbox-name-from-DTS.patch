From 8dce864d7360295709ddb3dc6b3c547c1a7cd61d Mon Sep 17 00:00:00 2001
From: Ley Foon Tan <lftan@altera.com>
Date: Mon, 29 Jul 2013 19:37:09 +0800
Subject: [PATCH 118/248] FogBugz #141478: Use "linux,mailbox-name" from DTS

Uses "linux,mailbox-name" from DTS. Sopc2dts tool already support
to add this property automatically.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Ley Foon Tan <lftan@altera.com>
---
 Documentation/devicetree/bindings/mailbox/mailbox-altera.txt | 4 +++-
 drivers/mailbox/mailbox-altera.c                             | 9 ++++++++-
 2 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/Documentation/devicetree/bindings/mailbox/mailbox-altera.txt b/Documentation/devicetree/bindings/mailbox/mailbox-altera.txt
index dbfcfb6..4227e70 100644
--- a/Documentation/devicetree/bindings/mailbox/mailbox-altera.txt
+++ b/Documentation/devicetree/bindings/mailbox/mailbox-altera.txt
@@ -4,13 +4,14 @@ Required properties:
 - compatible : "altr,mailbox-1.0".
 - reg : physical base address of the mailbox and length of memory mapped
      region.
+- linux,mailbox-name : Mailbox instance name
 
 Optional properties:
 - interrupt-parent : interrupt source phandle.
 - interrupts : interrupt number. The interrupt specifier format depends on the
 	       interrupt controller parent.
 
-The name of mailbox device node must be unique. This name will be used as
+The property of "linux,mailbox-name" must be unique. This name will be used as
 controller name in driver to identify the controller and the mailbox client will
 use this name when requesting a mailbox channel.
 
@@ -20,6 +21,7 @@ Example:
 		reg = <0x100 0x8>;
 		interrupt-parent = < &gic_0 >;
 		interrupts = <5>;
+		linux,mailbox-name = "mailbox0";
 	};
 
 Example of mailbox's client node that includes mailbox phandle.
diff --git a/drivers/mailbox/mailbox-altera.c b/drivers/mailbox/mailbox-altera.c
index b23113c..c59561e 100644
--- a/drivers/mailbox/mailbox-altera.c
+++ b/drivers/mailbox/mailbox-altera.c
@@ -302,6 +302,7 @@ static int altera_mbox_probe(struct platform_device *pdev)
 	struct resource	*regs;
 	struct device_node *np = pdev->dev.of_node;
 	int ret;
+	const char *mbox_name = NULL;
 
 	mbox = devm_kzalloc(&pdev->dev, sizeof(struct altera_mbox),
 		GFP_KERNEL);
@@ -336,8 +337,14 @@ static int altera_mbox_probe(struct platform_device *pdev)
 		dev_warn(&pdev->dev, "Length of mailbox controller name is greater than %d\n",
 		sizeof(mbox->ipc_con.controller_name));
 
+	ret = of_property_read_string(np, "linux,mailbox-name", &mbox_name);
+	if (ret) {
+		dev_err(&pdev->dev, "Missing linux,mailbox-name property in device tree\n");
+		goto err;
+	}
+
 	snprintf(mbox->ipc_con.controller_name,
-		sizeof(mbox->ipc_con.controller_name), "%s", np->name);
+		sizeof(mbox->ipc_con.controller_name), "%s", mbox_name);
 
 	dev_info(&pdev->dev, "Mailbox controller name is %s\n",
 		mbox->ipc_con.controller_name);
-- 
1.9.1

