From c86c0744628b43fec00d09d1ab6f792b20425d5c Mon Sep 17 00:00:00 2001
From: Vince Bridgers <vbridger@altera.com>
Date: Mon, 9 Dec 2013 15:01:39 -0600
Subject: [PATCH 166/248] FogBugz #169570: TX TCP Checksum offload is broken
 for Jumbo frames

The Synopsys EMAC will checksum jumbo transmit frames only up to a
certain size correctly, since the controller will start to egress
an outbound packet when it starts reaching the maximum size of the
transmit fifo. In the Altera configuration case, the PBL, or
programmed burst length is set to 64, the transmit fifo size is 4K,
and the bus datawidth is 32-bits. The equation to determine the
correct maximum MTU is FIFOSIZE-((PBL+3)*(BUSWIDTH/8)) ==
4096-(67*4) = 3828. Then we need to account for possible VLAN tags,
inner and outer, and then transform than number into an Ethernet
MTU, which gives us 3828-8-14-4 (8 bytes for two VLANs, 14 bytes
for the standard Ethernet header size, and another 4 bytes for
CRC). That gives us 3802. So we'll make it a maximum jumbo frame
size of 3800.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Vince Bridgers <vbridger@altera.com>
---
 arch/arm/boot/dts/socfpga_cyclone5.dtsi | 1 +
 1 file changed, 1 insertion(+)

diff --git a/arch/arm/boot/dts/socfpga_cyclone5.dtsi b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
index e10a657..49f37fb 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5.dtsi
+++ b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
@@ -185,5 +185,6 @@
 	txc-skew-ps = <2600>;
 	rxdv-skew-ps = <0>;
 	rxc-skew-ps = <2000>;
+	snps,max-mtu = <3800>;
 	status = "okay";
 };
-- 
1.9.1

