From 55fe06257533003b01eeae1c894ea16d16c7b90a Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Tue, 9 Jul 2013 17:42:42 -0500
Subject: [PATCH 02/13] watchdog: Add watchdog timer support

commit 0294516d0675ce59af137d196e56a7fd2f257408
git://git.rocketboards.org/linux-socfpga.git socfpga-3.10-ltsi branch

Enable device tree support in the Synopsys DW watchdog timer driver.

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>

v2:
- Use of_match_ptr() so that the module does not depend on OF
- Enable watchdog support in the defconfig
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 arch/arm/boot/dts/socfpga.dtsi         |   16 ++++++++++++++++
 arch/arm/boot/dts/socfpga_cyclone5.dts |    4 ++++
 arch/arm/boot/dts/socfpga_ice.dts      |    4 ++++
 arch/arm/boot/dts/socfpga_vt.dts       |    4 ++++
 drivers/watchdog/dw_wdt.c              |    8 ++++++++
 5 files changed, 36 insertions(+), 0 deletions(-)

diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index 3a25362..93161c1 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -710,5 +710,21 @@
 			dev-tx-fifo-size = <512 512 512 512 512 512
 				512 512 512 512 512 512 512 512 512>;
 		};
+
+		watchdog0: wd@ffd02000 {
+			compatible = "snps,dw-wdt";
+			reg = <0xffd02000 0x1000>;
+			interrupts = <0 171 4>;
+			clocks = <&per_base_clk>;
+			status = "disabled";
+		};
+
+		watchdog1: wd@ffd03000 {
+			compatible = "snps,dw-wdt";
+			reg = <0xffd03000 0x1000>;
+			interrupts = <0 172 4>;
+			clocks = <&per_base_clk>;
+			status = "disabled";
+		};
 	};
 };
diff --git a/arch/arm/boot/dts/socfpga_cyclone5.dts b/arch/arm/boot/dts/socfpga_cyclone5.dts
index b4f5af5..b7c129e 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5.dts
+++ b/arch/arm/boot/dts/socfpga_cyclone5.dts
@@ -220,6 +220,10 @@
 			}; //end bridge@0x40000 (mm_clock_crossing_bridge_LW)
 		}; //end bridge@0xff200000 (hps_0_h2f_lw)
 
+		watchdog0: wd@ffd02000 {
+			status = "okay";
+		};
+
 		leds {
 			compatible = "gpio-leds";
 			hps0 {
diff --git a/arch/arm/boot/dts/socfpga_ice.dts b/arch/arm/boot/dts/socfpga_ice.dts
index 7fededc..99b9269 100644
--- a/arch/arm/boot/dts/socfpga_ice.dts
+++ b/arch/arm/boot/dts/socfpga_ice.dts
@@ -165,5 +165,9 @@
 		serial1@ffc03000 {
 			clock-frequency = <77161>;
 		};
+
+		watchdog0: wd@ffd02000 {
+			status = "okay";
+		};
 	};
 };
diff --git a/arch/arm/boot/dts/socfpga_vt.dts b/arch/arm/boot/dts/socfpga_vt.dts
index 78bb023..4c3b5e9 100644
--- a/arch/arm/boot/dts/socfpga_vt.dts
+++ b/arch/arm/boot/dts/socfpga_vt.dts
@@ -157,6 +157,10 @@
 			clock-frequency = <7000000>;
 		};
 
+		watchdog0: wd@ffd02000 {
+			status = "okay";
+		};
+
 		usb0: usb@ffb00000 {
 			ulpi-ddr = <0>;
 		};
diff --git a/drivers/watchdog/dw_wdt.c b/drivers/watchdog/dw_wdt.c
index 06de121..6b40135 100644
--- a/drivers/watchdog/dw_wdt.c
+++ b/drivers/watchdog/dw_wdt.c
@@ -30,6 +30,7 @@
 #include <linux/module.h>
 #include <linux/moduleparam.h>
 #include <linux/pm.h>
+#include <linux/of.h>
 #include <linux/platform_device.h>
 #include <linux/spinlock.h>
 #include <linux/timer.h>
@@ -343,12 +344,19 @@ static int __devexit dw_wdt_drv_remove(struct platform_device *pdev)
 	return 0;
 }
 
+static const struct of_device_id dw_wdt_of_match[] = {
+	{ .compatible = "snps,dw-wdt", },
+	{ /* sentinel */ }
+};
+MODULE_DEVICE_TABLE(of, dw_wdt_of_match);
+
 static struct platform_driver dw_wdt_driver = {
 	.probe		= dw_wdt_drv_probe,
 	.remove		= __devexit_p(dw_wdt_drv_remove),
 	.driver		= {
 		.name	= "dw_wdt",
 		.owner	= THIS_MODULE,
+		.of_match_table = of_match_ptr(dw_wdt_of_match),
 #ifdef CONFIG_PM
 		.pm	= &dw_wdt_pm_ops,
 #endif /* CONFIG_PM */
-- 
1.7.5.4

