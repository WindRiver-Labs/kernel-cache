From 012658eb99cee5029c3406eb3f43d0374fab7ee7 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Mon, 21 Jan 2013 15:54:31 -0600
Subject: [PATCH 178/254] arm: socfpga: Add reset code to SOCFPGA

Upstream: git://git.rocketboards.org/linux-socfpga.git

Issue a cold or warm reset to the HW.

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
(cherry picked from commit 2213a6f08f104a74b63ebcc50b055ca49fffed54)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-socfpga/core.h    |    9 +++++++--
 arch/arm/mach-socfpga/socfpga.c |   14 +++++++++++---
 2 files changed, 18 insertions(+), 5 deletions(-)

diff --git a/arch/arm/mach-socfpga/core.h b/arch/arm/mach-socfpga/core.h
index 1895b38..485a23d 100644
--- a/arch/arm/mach-socfpga/core.h
+++ b/arch/arm/mach-socfpga/core.h
@@ -20,8 +20,13 @@
 #ifndef __MACH_CORE_H
 #define __MACH_CORE_H
 
-#define SOCFPGA_MODPERRST	0x14
-#define SOCFPGA_BRGMODRST	0x1c
+#define SOCFPGA_RSTMGR_CTRL	0x04
+#define SOCFPGA_RSTMGR_MODPERRST	0x14
+#define SOCFPGA_RSTMGR_BRGMODRST	0x1c
+
+/* System Manager bits */
+#define RSTMGR_CTRL_SWCOLDRSTREQ	0x1	/* Cold Reset */
+#define RSTMGR_CTRL_SWWARMRSTREQ	0x2	/* Warm Reset */
 
 extern void secondary_startup(void);
 extern void __iomem *socfpga_scu_base_addr;
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index f898630..47e0589 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -82,10 +82,10 @@ static void __init init_socfpga(void)
 static void __init enable_periphs(void)
 {
 	/* Release all peripherals from reset.*/
-	__raw_writel(0, rst_manager_base_addr + SOCFPGA_MODPERRST);
+	__raw_writel(0, rst_manager_base_addr + SOCFPGA_RSTMGR_MODPERRST);
 
 	/* Release all FPGA bridges from reset.*/
-	__raw_writel(0, rst_manager_base_addr + SOCFPGA_BRGMODRST);
+	__raw_writel(0, rst_manager_base_addr + SOCFPGA_RSTMGR_BRGMODRST);
 }
 
 static void __init socfpga_sysmgr_init(void)
@@ -138,7 +138,15 @@ static void __init gic_init_irq(void)
 
 static void socfpga_cyclone5_restart(char mode, const char *cmd)
 {
-	/* TODO: */
+	u32 temp;
+
+	temp = __raw_readl(rst_manager_base_addr + SOCFPGA_RSTMGR_CTRL);
+
+	if (mode == 'h')
+		temp |= RSTMGR_CTRL_SWCOLDRSTREQ;
+	else
+		temp |= RSTMGR_CTRL_SWWARMRSTREQ;
+	__raw_writel(temp, rst_manager_base_addr + SOCFPGA_RSTMGR_CTRL);
 }
 
 static void __init socfpga_cyclone5_init(void)
-- 
1.7.5.4

