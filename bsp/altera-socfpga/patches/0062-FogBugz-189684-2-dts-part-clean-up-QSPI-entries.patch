From 8715d1e25694a4976aef7e46328dc358ab941474 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Tue, 11 Mar 2014 15:39:50 -0500
Subject: [PATCH 062/172] FogBugz #189684-2: dts part: clean up QSPI entries

Moves the base QSPI dts entry into socfpga.dtsi and add board specific QSPI
entry to the appropriate board file DTS files.

Removes the hard-coded clock frequency.

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
[czou:Original patch taken from
https://github.com/altera-opensource/linux-socfpga.git socfpga-4.1]
Signed-off-by: czou <cao.zou@windriver.com>

Conflicts:
	arch/arm/boot/dts/socfpga.dtsi
	arch/arm/boot/dts/socfpga_arria5.dtsi
	arch/arm/boot/dts/socfpga_cyclone5.dtsi
	arch/arm/boot/dts/socfpga_cyclone5_socdk.dts
---
 .../devicetree/bindings/spi/spi-cadence-qspi.txt   |  3 +--
 arch/arm/boot/dts/socfpga.dtsi                     |  2 +-
 arch/arm/boot/dts/socfpga_cyclone5.dtsi            |  4 +++
 arch/arm/boot/dts/socfpga_cyclone5_sockit.dts      | 30 ++++++++++++++++++++++
 arch/arm/boot/dts/socfpga_vt.dts                   | 29 +++++++++++++++++++++
 5 files changed, 65 insertions(+), 3 deletions(-)

diff --git a/Documentation/devicetree/bindings/spi/spi-cadence-qspi.txt b/Documentation/devicetree/bindings/spi/spi-cadence-qspi.txt
index d4dda9a..4952896 100644
--- a/Documentation/devicetree/bindings/spi/spi-cadence-qspi.txt
+++ b/Documentation/devicetree/bindings/spi/spi-cadence-qspi.txt
@@ -7,7 +7,6 @@ Required properties:
 	length of the controller register set.  The second entry is the
 	address and length of the QSPI Controller data area.
 - interrupts : Unit interrupt specifier for the controller interrupt.
-- master-ref-clk : Specifies the frequency of the controller input clock.
 - ext-decoder : Value of 0 means no external chipselect decoder is
 	connected, 1 means there is an external chipselect decoder connected.
 - num-chipselect : Number of chip select lines.
@@ -26,7 +25,7 @@ Example:
 		reg = <0xff705000 0x1000>,
 			<0xffa00000 0x1000>;
 		interrupts = <0 151 4>;
-		master-ref-clk = <400000000>;
+		clocks = <&qspi_clk>;
 		ext-decoder = <0>;
 		num-chipselect = <4>;
 		fifo-depth = <128>;
diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index 98df36b..9beb859 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -772,7 +772,7 @@
 			#address-cells = <1>;
 			#size-cells = <0>;
 			reg = <0xff705000 0x1000>,
-			<0xffa00000 0x1000>;
+				<0xffa00000 0x1000>;
 			interrupts = <0 151 4>;
 			clocks = <&qspi_clk>;
 			ext-decoder = <0>;  /* external decoder */
diff --git a/arch/arm/boot/dts/socfpga_cyclone5.dtsi b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
index a05e3df..6794301 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5.dtsi
+++ b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
@@ -41,6 +41,10 @@
 		sysmgr@ffd08000 {
 			cpu1-start-addr = <0xffd080c4>;
 		};
+
+		qspi: spi@ff705000 {
+			status = "okay";
+		};
 	};
 };
 
diff --git a/arch/arm/boot/dts/socfpga_cyclone5_sockit.dts b/arch/arm/boot/dts/socfpga_cyclone5_sockit.dts
index 16ea6f5..7b29536 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5_sockit.dts
+++ b/arch/arm/boot/dts/socfpga_cyclone5_sockit.dts
@@ -68,3 +68,33 @@
 &usb1 {
 	status = "okay";
 };
+
+&qspi {
+	flash0: n25q00@0 {
+		#address-cells = <1>;
+		#size-cells = <1>;
+		compatible = "n25q00";
+		reg = <0>;      /* chip select */
+		spi-max-frequency = <100000000>;
+		m25p,fast-read;
+		page-size = <256>;
+		block-size = <16>; /* 2^16, 64KB */
+		read-delay = <4>;  /* delay value in read data capture register */
+		tshsl-ns = <50>;
+		tsd2d-ns = <50>;
+		tchsh-ns = <4>;
+		tslch-ns = <4>;
+
+		partition@qspi-boot {
+			/* 8MB for raw data. */
+			label = "Flash 0 Raw Data";
+			reg = <0x0 0x800000>;
+		};
+
+		partition@qspi-rootfs {
+			/* 120MB for jffs2 data. */
+			label = "Flash 0 jffs2 Filesystem";
+			reg = <0x800000 0x7800000>;
+		};
+	};
+};
diff --git a/arch/arm/boot/dts/socfpga_vt.dts b/arch/arm/boot/dts/socfpga_vt.dts
index f9345e0..5a46c82 100644
--- a/arch/arm/boot/dts/socfpga_vt.dts
+++ b/arch/arm/boot/dts/socfpga_vt.dts
@@ -58,6 +58,35 @@
 			clock-frequency = <7000000>;
 		};
 
+		qspi: spi@ff705000 {
+			status = "okay";
+			flash0: n25q128@0 {
+				#address-cells = <1>;
+				#size-cells = <1>;
+				compatible = "n25q128";
+				reg = <0>;      /* chip select */
+				spi-max-frequency = <100000000>;
+				page-size = <256>;
+				block-size = <16>; /* 2^16, 64KB */
+				quad = <1>;        /* 1-support quad */
+				tshsl-ns = <200>;
+				tsd2d-ns = <255>;
+				tchsh-ns = <20>;
+				tslch-ns = <20>;
+
+				partition@0 {
+					/* 8MB for raw data. */
+					label = "Flash 0 Raw Data";
+					reg = <0x0 0x800000>;
+				};
+				partition@800000 {
+					/* 8MB for jffs2 data. */
+					label = "Flash 0 jffs2 Filesystem";
+					reg = <0x800000 0x800000>;
+				};
+			};
+		};
+
 		timer1@ffc09000 {
 			clock-frequency = <7000000>;
 		};
-- 
1.9.1

