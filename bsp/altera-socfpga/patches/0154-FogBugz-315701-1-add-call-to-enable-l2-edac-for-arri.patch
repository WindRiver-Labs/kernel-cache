From 3421ce3751c602ca0c42f697041f685ca7c4d2bf Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@opensource.altera.com>
Date: Mon, 3 Aug 2015 15:53:06 -0500
Subject: [PATCH 154/172] FogBugz #315701-1: add call to enable l2 edac for
 arria10

Call socfpga_init_arria10_l2_ecc to initialize the L2 ECC on Arria10.

Signed-off-by: Roman Bulgakov <roman.bulgakov@globallogic.com>
Signed-off-by: Dinh Nguyen <dinguyen@opensource.altera.com>
[czou:Original patch taken from
https://github.com/altera-opensource/linux-socfpga.git socfpga-4.1]
Signed-off-by: czou <cao.zou@windriver.com>
---
 arch/arm/mach-socfpga/core.h     | 10 ++++++++++
 arch/arm/mach-socfpga/l2_cache.c | 34 ++++++++++++++++++++++++++++++++++
 arch/arm/mach-socfpga/l2_cache.h |  4 ++++
 arch/arm/mach-socfpga/socfpga.c  |  1 +
 4 files changed, 49 insertions(+)

diff --git a/arch/arm/mach-socfpga/core.h b/arch/arm/mach-socfpga/core.h
index 113f3ac..edb6f0c 100644
--- a/arch/arm/mach-socfpga/core.h
+++ b/arch/arm/mach-socfpga/core.h
@@ -31,6 +31,16 @@
 #define SOCFPGA_A10_RSTMGR_PER1MODRST	0x28
 #define SOCFPGA_A10_RSTMGR_BRGMODRST	0x2C
 
+/* A10 System Manager L2 cache ECC control register */
+#define SOCFPGA_A10_SYSMGR_L2_ECC_CTRL	0x10
+
+/* A10 System Manager ECC interrupt mask control registers */
+#define SOCFPGA_A10_SYSMGR_ECC_INTMASK_SET	0x94
+#define SOCFPGA_A10_SYSMGR_ECC_INTMASK_CLR	0x98
+
+#define SOCFPGA_A10_MPU_CTRL_L2_ECC_EN		BIT(0)
+#define SOCFPGA_A10_ECC_INTMASK_CLR_EN		BIT(0)
+
 /* System Manager bits */
 #define RSTMGR_CTRL_SWCOLDRSTREQ	0x1	/* Cold Reset */
 #define RSTMGR_CTRL_SWWARMRSTREQ	0x2	/* Warm Reset */
diff --git a/arch/arm/mach-socfpga/l2_cache.c b/arch/arm/mach-socfpga/l2_cache.c
index a2e3bb6..bc94689 100644
--- a/arch/arm/mach-socfpga/l2_cache.c
+++ b/arch/arm/mach-socfpga/l2_cache.c
@@ -17,6 +17,40 @@
 #include <linux/of_platform.h>
 #include <linux/of_address.h>
 
+#include "core.h"
+
+void socfpga_init_arria10_l2_ecc(void)
+{
+	struct device_node *np;
+	void __iomem *mapped_l2_edac_addr;
+
+	np = of_find_compatible_node(NULL, NULL, "altr,a10-l2-edac");
+	if (!np) {
+		pr_err("SOCFPGA: Unable to find altr,a10-l2-edac in dtb\n");
+		return;
+	}
+
+	if (!sys_manager_base_addr) {
+		pr_err("SOCFPGA: sys-mgr is not initialized\n");
+		return;
+	}
+
+	mapped_l2_edac_addr = of_iomap(np, 0);
+	if (!mapped_l2_edac_addr) {
+		pr_err("SOCFPGA: Unable to find L2 ECC mapping in dtb\n");
+		return;
+	}
+
+	writel(SOCFPGA_A10_ECC_INTMASK_CLR_EN, sys_manager_base_addr +
+	       SOCFPGA_A10_SYSMGR_ECC_INTMASK_CLR);
+	writel(SOCFPGA_A10_MPU_CTRL_L2_ECC_EN, mapped_l2_edac_addr +
+	       SOCFPGA_A10_SYSMGR_L2_ECC_CTRL);
+
+	pr_alert("SOCFPGA: Success Initializing L2 cache ECC for Arria10");
+
+	return;
+}
+
 void socfpga_init_l2_ecc(void)
 {
 	struct device_node *np;
diff --git a/arch/arm/mach-socfpga/l2_cache.h b/arch/arm/mach-socfpga/l2_cache.h
index de84d0d..8e750b6 100644
--- a/arch/arm/mach-socfpga/l2_cache.h
+++ b/arch/arm/mach-socfpga/l2_cache.h
@@ -19,10 +19,14 @@
 
 #ifdef CONFIG_EDAC_ALTERA_L2_ECC
 void socfpga_init_l2_ecc(void);
+void socfpga_init_arria10_l2_ecc(void);
 #else
 inline void socfpga_init_l2_ecc(void)
 {
 }
+inline void socfpga_init_arria10_l2_ecc(void)
+{
+}
 #endif
 
 #endif /* #ifndef MACH_SOCFPGA_L2_CACHE_H */
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 19d4790..7508664 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -199,6 +199,7 @@ static void __init socfpga_init_irq(void)
 	irqchip_init();
 	socfpga_sysmgr_init();
 	socfpga_init_l2_ecc();
+	socfpga_init_arria10_l2_ecc();
 }
 
 static void socfpga_cyclone5_restart(enum reboot_mode mode, const char *cmd)
-- 
1.9.1

