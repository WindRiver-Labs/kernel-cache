From 0f13b9693ca8d63589e5f1aeb8bd6fddeb55e3f9 Mon Sep 17 00:00:00 2001
From: Thor Thayer <tthayer@opensource.altera.com>
Date: Fri, 30 Jan 2015 16:22:42 -0600
Subject: [PATCH 107/172] FogBugz #270904-4: Enable SPI on the arria10 devkit

The MAX5 GPIO extender actually uses the SPI1 so the device tree
needs to be updated accordingly. Add the L4 Main clock to the fixed
clock tree for use by SPI.

Signed-off-by: Thor Thayer <tthayer@opensource.altera.com>
[czou:Original patch taken from
https://github.com/altera-opensource/linux-socfpga.git socfpga-4.1]
Signed-off-by: czou <cao.zou@windriver.com>
---
 arch/arm/boot/dts/socfpga_arria10.dtsi      | 14 +++++++++++---
 arch/arm/boot/dts/socfpga_arria10_socdk.dts |  6 ++++--
 2 files changed, 15 insertions(+), 5 deletions(-)

diff --git a/arch/arm/boot/dts/socfpga_arria10.dtsi b/arch/arm/boot/dts/socfpga_arria10.dtsi
index 2a683fd..99f799a 100644
--- a/arch/arm/boot/dts/socfpga_arria10.dtsi
+++ b/arch/arm/boot/dts/socfpga_arria10.dtsi
@@ -120,6 +120,12 @@
 						compatible = "fixed-clock";
 						clock-frequency = <200000000>;
 					};
+
+					l4_main_clk: l4_main_clk {
+						#clock-cells = <0>;
+						compatible = "fixed-clock";
+						clock-frequency = <400000000>;
+					};
 				};
 		};
 
@@ -260,16 +266,18 @@
 			status = "disabled";
 		};
 
-		spi0: spi@ffda4000 {
+		spi1: spi@ffda5000 {
 			compatible = "snps,dw-spi-mmio";
 			#address-cells = <1>;
 			#size-cells = <0>;
-			reg = <0xffda4000 0x100>;
-			interrupts = <0 101 4>;
+			reg = <0xffda5000 0x100>;
+			interrupts = <0 102 4>;
 			num-chipselect = <4>;
 			bus-num = <0>;
 			tx-dma-channel = <&pdma 16>;
 			rx-dma-channel = <&pdma 17>;
+			clocks = <&l4_main_clk>;
+			status = "disabled";
 		};
 
 		L2: l2-cache@fffff000 {
diff --git a/arch/arm/boot/dts/socfpga_arria10_socdk.dts b/arch/arm/boot/dts/socfpga_arria10_socdk.dts
index 880055e..d8efc3f 100755
--- a/arch/arm/boot/dts/socfpga_arria10_socdk.dts
+++ b/arch/arm/boot/dts/socfpga_arria10_socdk.dts
@@ -148,7 +148,9 @@
 	status = "okay";
 };
 
-&spi0 {
+&spi1 {
+	status = "okay";
+
 	a10_sysctl: a10_sysctl@0 {
 		compatible = "altr,a10sycon";
 		reg = <0>;
@@ -157,7 +159,7 @@
 		interrupts = <5 0x8>;
 		interrupt-controller;
 		#interrupt-cells = <2>;
-		spi-max-frequency = <100000>;
+		spi-max-frequency = <1000000>;
 
 		gpio4: gpio-controller {
 			compatible = "altr,a10sycon-gpio";
-- 
1.9.1

