From fae9f50273611fbbe5f25bdf6795b4c9539caffa Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@opensource.altera.com>
Date: Thu, 28 May 2015 14:37:29 -0500
Subject: [PATCH 136/172] FogBugz #294131: Fix cpu hotplug on Arria10

We were not putting the CPU1 into reset correctly on the Arria10. Also add
the define for the Arria10 MPU reset register offset.

Signed-off-by: Dinh Nguyen <dinguyen@opensource.altera.com>
[czou:Original patch taken from
https://github.com/altera-opensource/linux-socfpga.git socfpga-4.1]
Signed-off-by: czou <cao.zou@windriver.com>
---
 arch/arm/mach-socfpga/core.h    |  1 +
 arch/arm/mach-socfpga/platsmp.c | 14 ++++++++++----
 2 files changed, 11 insertions(+), 4 deletions(-)

diff --git a/arch/arm/mach-socfpga/core.h b/arch/arm/mach-socfpga/core.h
index c550c47..113f3ac 100644
--- a/arch/arm/mach-socfpga/core.h
+++ b/arch/arm/mach-socfpga/core.h
@@ -26,6 +26,7 @@
 #define SOCFPGA_RSTMGR_BRGMODRST	0x1c
 
 #define SOCFPGA_A10_RSTMGR_CTRL		0xC
+#define SOCFPGA_A10_RSTMGR_MODMPURST	0x20
 #define SOCFPGA_A10_RSTMGR_PER0MODRST	0x24
 #define SOCFPGA_A10_RSTMGR_PER1MODRST	0x28
 #define SOCFPGA_A10_RSTMGR_BRGMODRST	0x2C
diff --git a/arch/arm/mach-socfpga/platsmp.c b/arch/arm/mach-socfpga/platsmp.c
index 54a9eab..b1a38f6 100644
--- a/arch/arm/mach-socfpga/platsmp.c
+++ b/arch/arm/mach-socfpga/platsmp.c
@@ -35,8 +35,12 @@ static int socfpga_boot_secondary(unsigned int cpu, struct task_struct *idle)
 
 	if (socfpga_cpu1start_addr) {
 		/* This will put CPU #1 into reset. */
-		writel(RSTMGR_MPUMODRST_CPU1,
-		       rst_manager_base_addr + SOCFPGA_RSTMGR_MODMPURST);
+		if (of_machine_is_compatible("altr,socfpga-arria10"))
+			writel(RSTMGR_MPUMODRST_CPU1, rst_manager_base_addr +
+			       SOCFPGA_A10_RSTMGR_MODMPURST);
+		else
+			writel(RSTMGR_MPUMODRST_CPU1, rst_manager_base_addr +
+			       SOCFPGA_RSTMGR_MODMPURST);
 
 		memcpy(phys_to_virt(0), &secondary_trampoline, trampoline_size);
 
@@ -49,9 +53,11 @@ static int socfpga_boot_secondary(unsigned int cpu, struct task_struct *idle)
 
 		/* This will release CPU #1 out of reset.*/
 		if (of_machine_is_compatible("altr,socfpga-arria10"))
-			writel(0, rst_manager_base_addr + 0x20);
+			writel(0, rst_manager_base_addr +
+			       SOCFPGA_A10_RSTMGR_MODMPURST);
 		else
-			writel(0, rst_manager_base_addr + 0x10);
+			writel(0, rst_manager_base_addr +
+			       SOCFPGA_RSTMGR_MODMPURST);
 	}
 
 	return 0;
-- 
1.9.1

