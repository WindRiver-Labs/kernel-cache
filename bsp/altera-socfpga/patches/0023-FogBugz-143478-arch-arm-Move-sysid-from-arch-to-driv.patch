From 9c017459519d6672831634b37d9d21b169425def Mon Sep 17 00:00:00 2001
From: Ley Foon Tan <lftan@altera.com>
Date: Mon, 12 Aug 2013 11:09:10 +0800
Subject: [PATCH 023/172] FogBugz #143478: arch/arm: Move sysid from arch to
 drivers

Removed sysid from arch/arm and read silicon ID from
system manager for soc_id and revision.

Signed-off-by: Ley Foon Tan <lftan@altera.com>
[czou:Original patch taken from
https://github.com/altera-opensource/linux-socfpga.git socfpga-4.1]
Signed-off-by: czou <cao.zou@windriver.com>

Conflicts:

	arch/arm/mach-socfpga/core.h
---
 arch/arm/mach-socfpga/core.h    | 15 ++++++++-------
 arch/arm/mach-socfpga/socfpga.c | 29 +++++++++++++----------------
 2 files changed, 21 insertions(+), 23 deletions(-)

diff --git a/arch/arm/mach-socfpga/core.h b/arch/arm/mach-socfpga/core.h
index 0f52b73..ab082d6 100644
--- a/arch/arm/mach-socfpga/core.h
+++ b/arch/arm/mach-socfpga/core.h
@@ -32,20 +32,21 @@
 #define RSTMGR_MPUMODRST_CPU1		0x2     /* CPU1 Reset */
 
 extern void __iomem *socfpga_scu_base_addr;
-#define SOCFPGA_SYSID_DEFAULT		0x1
-#define SOCFPGA_REVISION_DEFAULT	0x1
-
-/* Sysid register map */
-#define SYSID_ID_REG			0x0
 
-extern void socfpga_init_clocks(void);
-extern void socfpga_sysmgr_init(void);
 /*MPU Module Reset Register */
 #define RSTMGR_MPUMODRST_CPU0	0x1	/*CPU0 Reset*/
 #define RSTMGR_MPUMODRST_CPU1	0x2	/*CPU1 Reset*/
 #define RSTMGR_MPUMODRST_WDS		0x4	/*Watchdog Reset*/
 #define RSTMGR_MPUMODRST_SCUPER	0x8	/*SCU and periphs reset*/
 #define RSTMGR_MPUMODRST_L2		0x10	/*L2 Cache reset*/
+#define SOCFPGA_ID_DEFAULT		0x1
+#define SOCFPGA_REVISION_DEFAULT	0x1
+
+#define SYSMGR_SILICON_ID1_OFFSET 0x0
+#define SYSMGR_SILICON_ID1_REV_SHIFT 0
+#define SYSMGR_SILICON_ID1_REV_MASK 0x0000FFFF
+#define SYSMGR_SILICON_ID1_ID_SHIFT 16
+#define SYSMGR_SILICON_ID1_ID_MASK 0xFFFF0000
 
 extern void __iomem *sys_manager_base_addr;
 extern void __iomem *rst_manager_base_addr;
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 07fa754..286566e 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -71,12 +71,11 @@ static struct map_desc uart_io_desc __initdata = {
 static void __init socfpga_soc_device_init(void)
 {
 	struct device_node *root;
-	struct device_node *sysid_node;
 	struct soc_device *soc_dev;
 	struct soc_device_attribute *soc_dev_attr;
-	void __iomem *sysid_base;
 	const char *machine;
-	u32 id = SOCFPGA_SYSID_DEFAULT;
+	u32 id = SOCFPGA_ID_DEFAULT;
+	u32 rev = SOCFPGA_REVISION_DEFAULT;
 	int err;
 
 	root = of_find_node_by_path("/");
@@ -87,26 +86,24 @@ static void __init socfpga_soc_device_init(void)
 	if (err)
 		return;
 
+	of_node_put(root);
+
 	soc_dev_attr = kzalloc(sizeof(*soc_dev_attr), GFP_KERNEL);
 	if (!soc_dev_attr)
 		return;
 
-	sysid_node = of_find_compatible_node(root, NULL, "ALTR,sysid-1.0");
-	if (sysid_node) {
-		sysid_base = of_iomap(sysid_node, 0);
-		if (sysid_base) {
-			/* Use id from Sysid hardware. */
-			id = readl(sysid_base + SYSID_ID_REG);
-			iounmap(sysid_base);
-		}
-		of_node_put(sysid_node);
+	/* Read Silicon ID from System manager */
+	if (sys_manager_base_addr) {
+		id =  __raw_readl(sys_manager_base_addr +
+			SYSMGR_SILICON_ID1_OFFSET);
+		rev = (id & SYSMGR_SILICON_ID1_REV_MASK)
+				>> SYSMGR_SILICON_ID1_REV_SHIFT;
+		id = (id & SYSMGR_SILICON_ID1_ID_MASK)
+				>> SYSMGR_SILICON_ID1_ID_SHIFT;
 	}
 
-	of_node_put(root);
-
 	soc_dev_attr->soc_id = kasprintf(GFP_KERNEL, "%u", id);
-	soc_dev_attr->revision = kasprintf(GFP_KERNEL, "%d",
-		SOCFPGA_REVISION_DEFAULT);
+	soc_dev_attr->revision = kasprintf(GFP_KERNEL, "%d", rev);
 	soc_dev_attr->machine = kasprintf(GFP_KERNEL, "%s", machine);
 	soc_dev_attr->family = "SOCFPGA";
 
-- 
1.9.1

