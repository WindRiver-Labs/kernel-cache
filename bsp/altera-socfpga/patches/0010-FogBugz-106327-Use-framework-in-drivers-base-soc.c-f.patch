From 6435ea73598c0d1a48e9fe5c45f2c87d6ccf011b Mon Sep 17 00:00:00 2001
From: Ley Foon Tan <lftan@altera.com>
Date: Thu, 14 Mar 2013 15:22:44 +0800
Subject: [PATCH 010/172] FogBugz #106327: Use framework in drivers/base/soc.c
 for system id

Open source committees recommend to use existing
framework in drivers/base/soc.c for system
properties like system id (soc_id).
See more detail in Documentation/ABI/testing/sysfs-devices-soc.

Usage:
cat /sys/devices/soc0/soc_id
cat /sys/devices/soc0/family
cat /sys/devices/soc0/machine
cat /sys/devices/soc0/revision

Signed-off-by: Ley Foon Tan <lftan@altera.com>
[czou:Original patch taken from
https://github.com/altera-opensource/linux-socfpga.git socfpga-4.1]
Signed-off-by: czou <cao.zou@windriver.com>

Conflicts:

	arch/arm/mach-socfpga/Kconfig
	arch/arm/mach-socfpga/core.h
	arch/arm/mach-socfpga/socfpga.c
---
 arch/arm/mach-socfpga/Kconfig   |  1 +
 arch/arm/mach-socfpga/core.h    |  5 ++++
 arch/arm/mach-socfpga/socfpga.c | 63 +++++++++++++++++++++++++++++++++++++++++
 3 files changed, 69 insertions(+)

diff --git a/arch/arm/mach-socfpga/Kconfig b/arch/arm/mach-socfpga/Kconfig
index 96b03d4..9aa9331 100644
--- a/arch/arm/mach-socfpga/Kconfig
+++ b/arch/arm/mach-socfpga/Kconfig
@@ -11,3 +11,4 @@ config ARCH_SOCFPGA
 	select MIGHT_HAVE_CACHE_L2X0
 	select SPARSE_IRQ
 	select USE_OF
+	select SOC_BUS
diff --git a/arch/arm/mach-socfpga/core.h b/arch/arm/mach-socfpga/core.h
index a500e6c..0f52b73 100644
--- a/arch/arm/mach-socfpga/core.h
+++ b/arch/arm/mach-socfpga/core.h
@@ -32,6 +32,11 @@
 #define RSTMGR_MPUMODRST_CPU1		0x2     /* CPU1 Reset */
 
 extern void __iomem *socfpga_scu_base_addr;
+#define SOCFPGA_SYSID_DEFAULT		0x1
+#define SOCFPGA_REVISION_DEFAULT	0x1
+
+/* Sysid register map */
+#define SYSID_ID_REG			0x0
 
 extern void socfpga_init_clocks(void);
 extern void socfpga_sysmgr_init(void);
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index b1df4dc..2963760 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -19,6 +19,8 @@
 #include <linux/of_irq.h>
 #include <linux/of_platform.h>
 #include <linux/reboot.h>
+#include <linux/slab.h>
+#include <linux/sys_soc.h>
 
 #include <asm/hardware/cache-l2x0.h>
 #include <asm/mach/arch.h>
@@ -46,6 +48,60 @@ static struct map_desc uart_io_desc __initdata = {
 	.type		= MT_DEVICE,
 };
 
+static void __init socfpga_soc_device_init(void)
+{
+	struct device_node *root;
+	struct device_node *sysid_node;
+	struct soc_device *soc_dev;
+	struct soc_device_attribute *soc_dev_attr;
+	void __iomem *sysid_base;
+	const char *machine;
+	u32 id = SOCFPGA_SYSID_DEFAULT;
+	int err;
+
+	root = of_find_node_by_path("/");
+	if (!root)
+		return;
+
+	err = of_property_read_string(root, "model", &machine);
+	if (err)
+		return;
+
+	soc_dev_attr = kzalloc(sizeof(*soc_dev_attr), GFP_KERNEL);
+	if (!soc_dev_attr)
+		return;
+
+	sysid_node = of_find_compatible_node(root, NULL, "ALTR,sysid-1.0");
+	if (sysid_node) {
+		sysid_base = of_iomap(sysid_node, 0);
+		if (sysid_base) {
+			/* Use id from Sysid hardware. */
+			id = readl(sysid_base + SYSID_ID_REG);
+			iounmap(sysid_base);
+		}
+		of_node_put(sysid_node);
+	}
+
+	of_node_put(root);
+
+	soc_dev_attr->soc_id = kasprintf(GFP_KERNEL, "%u", id);
+	soc_dev_attr->revision = kasprintf(GFP_KERNEL, "%d",
+		SOCFPGA_REVISION_DEFAULT);
+	soc_dev_attr->machine = kasprintf(GFP_KERNEL, "%s", machine);
+	soc_dev_attr->family = "SOCFPGA";
+
+	soc_dev = soc_device_register(soc_dev_attr);
+	if (IS_ERR_OR_NULL(soc_dev)) {
+		kfree(soc_dev_attr->soc_id);
+		kfree(soc_dev_attr->machine);
+		kfree(soc_dev_attr->revision);
+		kfree(soc_dev_attr);
+		return;
+	}
+
+	return;
+}
+
 static void __init socfpga_scu_map_io(void)
 {
 	unsigned long base;
@@ -103,6 +159,12 @@ static void socfpga_cyclone5_restart(enum reboot_mode mode, const char *cmd)
 	writel(temp, rst_manager_base_addr + SOCFPGA_RSTMGR_CTRL);
 }
 
+static void __init socfpga_cyclone5_init(void)
+{
+	enable_periphs();
+	socfpga_soc_device_init();
+}
+
 static const char *altera_dt_match[] = {
 	"altr,socfpga",
 	NULL
@@ -115,6 +177,7 @@ DT_MACHINE_START(SOCFPGA, "Altera SOCFPGA")
 	.smp		= smp_ops(socfpga_smp_ops),
 	.map_io		= socfpga_map_io,
 	.init_irq	= socfpga_init_irq,
+	.init_machine	= socfpga_cyclone5_init,
 	.restart	= socfpga_cyclone5_restart,
 	.dt_compat	= altera_dt_match,
 MACHINE_END
-- 
1.9.1

