From f412b60f1b85fe4e945aab913d21e542f57805e1 Mon Sep 17 00:00:00 2001
From: Graham Moore <grmoore@opensource.altera.com>
Date: Tue, 17 Feb 2015 11:02:34 -0600
Subject: [PATCH 111/172] FogBugz #270904-9: Add qspi node for Arria10

Update arria10 dts board files for mutually exclusive support of QSPI and SD/MMC

Creates 2 new dts board files:
socfpga_arria10_socdk_qspi.dts -> support for devkit with QPSI
socfpga_arria10_socdk_sdmmc.dts -> support for devkit with SD/MMC

Signed-off-by: Graham Moore <grmoore@opensource.altera.com>
Signed-off-by: Dinh Nguyen <dinguyen@opensource.altera.com>
[czou:Original patch taken from
https://github.com/altera-opensource/linux-socfpga.git socfpga-4.1]
Signed-off-by: czou <cao.zou@windriver.com>
---
 arch/arm/boot/dts/Makefile                        |   3 +-
 arch/arm/boot/dts/socfpga_arria10.dtsi            |  16 ++
 arch/arm/boot/dts/socfpga_arria10_socdk.dts       | 199 -----------------
 arch/arm/boot/dts/socfpga_arria10_socdk_qspi.dts  | 256 ++++++++++++++++++++++
 arch/arm/boot/dts/socfpga_arria10_socdk_sdmmc.dts | 198 +++++++++++++++++
 5 files changed, 472 insertions(+), 200 deletions(-)
 delete mode 100755 arch/arm/boot/dts/socfpga_arria10_socdk.dts
 create mode 100755 arch/arm/boot/dts/socfpga_arria10_socdk_qspi.dts
 create mode 100755 arch/arm/boot/dts/socfpga_arria10_socdk_sdmmc.dts

diff --git a/arch/arm/boot/dts/Makefile b/arch/arm/boot/dts/Makefile
index b2a87e0..3473e12 100644
--- a/arch/arm/boot/dts/Makefile
+++ b/arch/arm/boot/dts/Makefile
@@ -496,7 +496,8 @@ dtb-$(CONFIG_ARCH_SHMOBILE_MULTI) += \
 	sh73a0-kzm9g.dtb
 dtb-$(CONFIG_ARCH_SOCFPGA) += \
 	socfpga_arria5_socdk.dtb \
-	socfpga_arria10_socdk.dtb \
+	socfpga_arria10_socdk_qspi.dtb \
+	socfpga_arria10_socdk_sdmmc.dtb \
 	socfpga_cyclone5_socdk.dtb \
 	socfpga_cyclone5_sockit.dtb \
 	socfpga_cyclone5_socrates.dtb \
diff --git a/arch/arm/boot/dts/socfpga_arria10.dtsi b/arch/arm/boot/dts/socfpga_arria10.dtsi
index e930203..e87ef9e 100644
--- a/arch/arm/boot/dts/socfpga_arria10.dtsi
+++ b/arch/arm/boot/dts/socfpga_arria10.dtsi
@@ -297,6 +297,7 @@
 			fifo-depth = <0x400>;
 			clocks = <&l4_mp_clk>, <&sdmmc_clk>;
 			clock-names = "biu", "ciu";
+			status = "disabled";
 		};
 
 		ocram: sram@ffe00000 {
@@ -304,6 +305,21 @@
 			reg = <0xffe00000 0x40000>;
 		};
 
+		qspi: spi@ff809000 {
+			#address-cells = <1>;
+			#size-cells = <0>;
+			compatible = "cadence,qspi";
+			reg = <0xff809000 0x100>,
+				<0xffa00000 0x100000>;
+			interrupts = <0 100 IRQ_TYPE_LEVEL_HIGH>;
+			clocks = <&l4_main_clk>;
+			ext-decoder = <0>;  /* external decoder */
+			num-chipselect = <4>;
+			fifo-depth = <128>;
+			bus-num = <2>;
+			status = "disabled";
+		};
+
 		rst: rstmgr@ffd05000 {
 			#reset-cells = <1>;
 			compatible = "altr,rst-mgr";
diff --git a/arch/arm/boot/dts/socfpga_arria10_socdk.dts b/arch/arm/boot/dts/socfpga_arria10_socdk.dts
deleted file mode 100755
index 069c5e5..0000000
--- a/arch/arm/boot/dts/socfpga_arria10_socdk.dts
+++ /dev/null
@@ -1,199 +0,0 @@
-/*
- * Copyright (C) 2014 Altera Corporation <www.altera.com>
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation; either version 2 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- */
-
-/dts-v1/;
-#include "socfpga_arria10.dtsi"
-
-/ {
-	model = "Altera SOCFPGA Arria 10";
-	compatible = "altr,socfpga-arria10", "altr,socfpga";
-
-	chosen {
-		bootargs = "console=ttyS0,115200 rootwait";
-	};
-
-	memory {
-		name = "memory";
-		device_type = "memory";
-		reg = <0x0 0x40000000>; /* 1GB */
-	};
-
-	a10_leds {
-		compatible = "gpio-leds";
-
-		a10sycon0 {
-			label = "a10sycon_led0";
-			gpios = <&gpio4 4 1>;
-		};
-
-		a10sycon1 {
-			label = "a10sycon_led1";
-			gpios = <&gpio4 5 1>;
-		};
-
-		a10sycon2 {
-			label = "a10sycon_led2";
-			gpios = <&gpio4 6 1>;
-		};
-
-		a10sycon03 {
-			label = "a10sycon_led3";
-			gpios = <&gpio4 7 1>;
-		};
-	};
-
-	a10_keys {
-		compatible = "gpio-keys";
-		#address-cells = <1>;
-		#size-cells = <0>;
-
-		dip_sw0 {
-			label = "DIP_SW0";
-			gpios = <&gpio4 8 1>;
-			linux,code = <0x40>;
-			debounce-interval = <50>;
-		};
-
-		dip_sw1 {
-			label = "DIP_SW1";
-			gpios = <&gpio4 9 1>;
-			linux,code = <0x41>;
-			debounce-interval = <50>;
-		};
-
-		dip_sw2 {
-			label = "DIP_SW2";
-			gpios = <&gpio4 10 1>;
-			linux,code = <0x42>;
-			debounce-interval = <50>;
-		};
-
-		dip_sw3 {
-			label = "DIP_SW3";
-			gpios = <&gpio4 11 1>;
-			linux,code = <0x43>;
-			debounce-interval = <50>;
-		};
-
-		pb_sw0 {
-			label = "PB_SW0";
-			gpios = <&gpio4 12 1>;
-			linux,code = <0x44>;
-			debounce-interval = <50>;
-		};
-
-		pb_sw1 {
-			label = "PB_SW1";
-			gpios = <&gpio4 13 1>;
-			linux,code = <0x45>;
-			debounce-interval = <50>;
-		};
-
-		pb_sw2 {
-			label = "PB_SW2";
-			gpios = <&gpio4 14 1>;
-			linux,code = <0x46>;
-			debounce-interval = <50>;
-		};
-
-		pb_sw3 {
-			label = "PB_SW3";
-			gpios = <&gpio4 15 1>;
-			linux,code = <0x47>;
-			debounce-interval = <50>;
-		};
-	};
-	soc {
-		clkmgr@ffd04000 {
-			clocks {
-				osc1 {
-					clock-frequency = <25000000>;
-				};
-			};
-		};
-
-		serial1@ffc02100 {
-			status = "okay";
-		};
-	};
-};
-
-&gmac0 {
-	phy-mode = "rgmii";
-	phy-addr = <0xffffffff>; /* probe for phy addr */
-	rxd0-skew-ps = <0>;
-	rxd0-skew-ps = <0>;
-	rxd1-skew-ps = <0>;
-	rxd2-skew-ps = <0>;
-	rxd3-skew-ps = <0>;
-	txen-skew-ps = <0>;
-	txc-skew-ps = <0>;
-	rxdv-skew-ps = <0>;
-	rxc-skew-ps = <0>;
-	snps,max-mtu = <0>;
-	status = "okay";
-};
-
-&spi1 {
-	status = "okay";
-
-	a10_sysctl: a10_sysctl@0 {
-		compatible = "altr,a10sycon";
-		reg = <0>;
-		interrupt-parent = <&gpio1>;
-		/* low-level active IRQ at GPIO1_5 */
-		interrupts = <5 0x8>;
-		interrupt-controller;
-		#interrupt-cells = <2>;
-		spi-max-frequency = <1000000>;
-
-		gpio4: gpio-controller {
-			compatible = "altr,a10sycon-gpio";
-			gpio-controller;
-			#gpio-cells = <2>;
-			ngpios = <16>;
-		};
-
-		hwmon: a10hwmon {
-			compatible = "altr,a10sycon-hwmon";
-		};
-
-		a10rst: a10rst {
-			compatible = "altr,a10sycon-reset";
-			#reset-cells = <1>;
-		};
-	};
-};
-
-&mmc {
-	num-slots = <1>;
-	supports-highspeed;
-	broken-cd;
-	altr,dw-mshc-ciu-div = <3>;
-	altr,dw-mshc-sdr-timing = <0 3>;
-	clock-frequency = <50000000>;
-	clock-freq-min-max = <400000 25000000>;
-
-	slot@0 {
-		reg = <0>;
-		bus-width = <1>;
-	};
-};
-
-&usb0 {
-	status = "okay";
-};
diff --git a/arch/arm/boot/dts/socfpga_arria10_socdk_qspi.dts b/arch/arm/boot/dts/socfpga_arria10_socdk_qspi.dts
new file mode 100755
index 0000000..852b528
--- /dev/null
+++ b/arch/arm/boot/dts/socfpga_arria10_socdk_qspi.dts
@@ -0,0 +1,256 @@
+/*
+ * Copyright (C) 2014 Altera Corporation <www.altera.com>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ */
+
+/dts-v1/;
+#include "socfpga_arria10.dtsi"
+
+/ {
+	model = "Altera SOCFPGA Arria 10";
+	compatible = "altr,socfpga-arria10", "altr,socfpga";
+
+	chosen {
+		bootargs = "console=ttyS0,115200 rootwait";
+	};
+
+	memory {
+		name = "memory";
+		device_type = "memory";
+		reg = <0x0 0x40000000>; /* 1GB */
+	};
+
+	a10_leds {
+		compatible = "gpio-leds";
+
+		a10sycon0 {
+			label = "a10sycon_led0";
+			gpios = <&gpio4 4 1>;
+		};
+
+		a10sycon1 {
+			label = "a10sycon_led1";
+			gpios = <&gpio4 5 1>;
+		};
+
+		a10sycon2 {
+			label = "a10sycon_led2";
+			gpios = <&gpio4 6 1>;
+		};
+
+		a10sycon03 {
+			label = "a10sycon_led3";
+			gpios = <&gpio4 7 1>;
+		};
+	};
+
+	a10_keys {
+		compatible = "gpio-keys";
+		#address-cells = <1>;
+		#size-cells = <0>;
+
+		dip_sw0 {
+			label = "DIP_SW0";
+			gpios = <&gpio4 8 1>;
+			linux,code = <0x40>;
+			debounce-interval = <50>;
+		};
+
+		dip_sw1 {
+			label = "DIP_SW1";
+			gpios = <&gpio4 9 1>;
+			linux,code = <0x41>;
+			debounce-interval = <50>;
+		};
+
+		dip_sw2 {
+			label = "DIP_SW2";
+			gpios = <&gpio4 10 1>;
+			linux,code = <0x42>;
+			debounce-interval = <50>;
+		};
+
+		dip_sw3 {
+			label = "DIP_SW3";
+			gpios = <&gpio4 11 1>;
+			linux,code = <0x43>;
+			debounce-interval = <50>;
+		};
+
+		pb_sw0 {
+			label = "PB_SW0";
+			gpios = <&gpio4 12 1>;
+			linux,code = <0x44>;
+			debounce-interval = <50>;
+		};
+
+		pb_sw1 {
+			label = "PB_SW1";
+			gpios = <&gpio4 13 1>;
+			linux,code = <0x45>;
+			debounce-interval = <50>;
+		};
+
+		pb_sw2 {
+			label = "PB_SW2";
+			gpios = <&gpio4 14 1>;
+			linux,code = <0x46>;
+			debounce-interval = <50>;
+		};
+
+		pb_sw3 {
+			label = "PB_SW3";
+			gpios = <&gpio4 15 1>;
+			linux,code = <0x47>;
+			debounce-interval = <50>;
+		};
+	};
+	soc {
+		clkmgr@ffd04000 {
+			clocks {
+				osc1 {
+					clock-frequency = <25000000>;
+				};
+			};
+		};
+
+		serial1@ffc02100 {
+			status = "okay";
+		};
+
+		sysmgr@ffd06000 {
+			cpu1-start-addr = <0xffd06230>;
+		};
+
+		qspi: spi@ff809000 {
+			compatible = "cadence,qspi";
+			#address-cells = <1>;
+			#size-cells = <0>;
+			reg = <0xff809000 0x100>,
+				<0xffa00000 0x100000>;
+			interrupts = <0 100 IRQ_TYPE_LEVEL_HIGH>;
+			clocks = <&l4_main_clk>;
+			ext-decoder = <0>;  /* external decoder */
+			num-chipselect = <4>;
+			fifo-depth = <128>;
+			bus-num = <2>;
+			status = "okay";
+			flash0: n25q00@0 {
+				#address-cells = <1>;
+				#size-cells = <1>;
+				compatible = "n25q00aa";
+				reg = <0>;      /* chip select */
+				spi-max-frequency = <100000000>;
+				m25p,fast-read;
+				page-size = <256>;
+				block-size = <16>; /* 2^16, 64KB */
+				read-delay = <4>;  /* delay value in read data capture register */
+				tshsl-ns = <50>;
+				tsd2d-ns = <50>;
+				tchsh-ns = <4>;
+				tslch-ns = <4>;
+
+				partition@qspi-boot {
+					label = "Boot and fpga data";
+					reg = <0x0 0x1B20000>;
+				};
+				partition@qspi-rootfs {
+					label = "Root Filesystem - JFFS2";
+					reg = <0x1B20000 0x64E0000>;
+				};
+			};
+		};
+	};
+};
+
+&gmac0 {
+	phy-mode = "rgmii";
+	phy-addr = <0xffffffff>; /* probe for phy addr */
+	rxd0-skew-ps = <0>;
+	rxd0-skew-ps = <0>;
+	rxd1-skew-ps = <0>;
+	rxd2-skew-ps = <0>;
+	rxd3-skew-ps = <0>;
+	txen-skew-ps = <0>;
+	txc-skew-ps = <2600>;
+	rxdv-skew-ps = <0>;
+	rxc-skew-ps = <2000>;
+	snps,max-mtu = <0>;
+	status = "okay";
+};
+
+&spi1 {
+	status = "okay";
+
+	a10_sysctl: a10_sysctl@0 {
+		compatible = "altr,a10sycon";
+		reg = <0>;
+		interrupt-parent = <&gpio1>;
+		/* low-level active IRQ at GPIO1_5 */
+		interrupts = <5 0x8>;
+		interrupt-controller;
+		#interrupt-cells = <2>;
+		spi-max-frequency = <1000000>;
+
+		gpio4: gpio-controller {
+			compatible = "altr,a10sycon-gpio";
+			gpio-controller;
+			#gpio-cells = <2>;
+			ngpios = <16>;
+		};
+
+		hwmon: a10hwmon {
+			compatible = "altr,a10sycon-hwmon";
+		};
+
+		a10rst: a10rst {
+			compatible = "altr,a10sycon-reset";
+			#reset-cells = <1>;
+		};
+	};
+};
+
+&qspi {
+	status = "okay";
+	flash0: n25q00@0 {
+		#address-cells = <1>;
+		#size-cells = <1>;
+		compatible = "n25q00aa";
+		reg = <0>;      /* chip select */
+		spi-max-frequency = <100000000>;
+		m25p,fast-read;
+		page-size = <256>;
+		block-size = <16>; /* 2^16, 64KB */
+		read-delay = <4>;  /* delay value in read data capture register */
+		tshsl-ns = <50>;
+		tsd2d-ns = <50>;
+		tchsh-ns = <4>;
+		tslch-ns = <4>;
+
+		partition@qspi-boot {
+			label = "Boot and fpga data";
+			reg = <0x0 0x1B20000>;
+		};
+
+		partition@qspi-rootfs {
+			label = "Root Filesystem - JFFS2";
+			reg = <0x1B20000 0x64E0000>;
+		};
+	};
+};
+
+&usb0 {
+	status = "okay";
+};
diff --git a/arch/arm/boot/dts/socfpga_arria10_socdk_sdmmc.dts b/arch/arm/boot/dts/socfpga_arria10_socdk_sdmmc.dts
new file mode 100755
index 0000000..96dd49f
--- /dev/null
+++ b/arch/arm/boot/dts/socfpga_arria10_socdk_sdmmc.dts
@@ -0,0 +1,198 @@
+/*
+ * Copyright (C) 2014 Altera Corporation <www.altera.com>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ */
+
+/dts-v1/;
+#include "socfpga_arria10.dtsi"
+
+/ {
+	model = "Altera SOCFPGA Arria 10";
+	compatible = "altr,socfpga-arria10", "altr,socfpga";
+
+	chosen {
+		bootargs = "console=ttyS0,115200 rootwait";
+	};
+
+	memory {
+		name = "memory";
+		device_type = "memory";
+		reg = <0x0 0x40000000>; /* 1GB */
+	};
+
+	a10_leds {
+		compatible = "gpio-leds";
+
+		a10sycon0 {
+			label = "a10sycon_led0";
+			gpios = <&gpio4 4 1>;
+		};
+
+		a10sycon1 {
+			label = "a10sycon_led1";
+			gpios = <&gpio4 5 1>;
+		};
+
+		a10sycon2 {
+			label = "a10sycon_led2";
+			gpios = <&gpio4 6 1>;
+		};
+
+		a10sycon03 {
+			label = "a10sycon_led3";
+			gpios = <&gpio4 7 1>;
+		};
+	};
+
+	a10_keys {
+		compatible = "gpio-keys";
+		#address-cells = <1>;
+		#size-cells = <0>;
+
+		dip_sw0 {
+			label = "DIP_SW0";
+			gpios = <&gpio4 8 1>;
+			linux,code = <0x40>;
+			debounce-interval = <50>;
+		};
+
+		dip_sw1 {
+			label = "DIP_SW1";
+			gpios = <&gpio4 9 1>;
+			linux,code = <0x41>;
+			debounce-interval = <50>;
+		};
+
+		dip_sw2 {
+			label = "DIP_SW2";
+			gpios = <&gpio4 10 1>;
+			linux,code = <0x42>;
+			debounce-interval = <50>;
+		};
+
+		dip_sw3 {
+			label = "DIP_SW3";
+			gpios = <&gpio4 11 1>;
+			linux,code = <0x43>;
+			debounce-interval = <50>;
+		};
+
+		pb_sw0 {
+			label = "PB_SW0";
+			gpios = <&gpio4 12 1>;
+			linux,code = <0x44>;
+			debounce-interval = <50>;
+		};
+
+		pb_sw1 {
+			label = "PB_SW1";
+			gpios = <&gpio4 13 1>;
+			linux,code = <0x45>;
+			debounce-interval = <50>;
+		};
+
+		pb_sw2 {
+			label = "PB_SW2";
+			gpios = <&gpio4 14 1>;
+			linux,code = <0x46>;
+			debounce-interval = <50>;
+		};
+
+		pb_sw3 {
+			label = "PB_SW3";
+			gpios = <&gpio4 15 1>;
+			linux,code = <0x47>;
+			debounce-interval = <50>;
+		};
+	};
+	soc {
+		clkmgr@ffd04000 {
+			clocks {
+				osc1 {
+					clock-frequency = <25000000>;
+				};
+			};
+		};
+
+		serial1@ffc02100 {
+			status = "okay";
+		};
+	};
+};
+
+&gmac0 {
+	phy-mode = "rgmii";
+	phy-addr = <0xffffffff>; /* probe for phy addr */
+	rxd0-skew-ps = <0>;
+	rxd0-skew-ps = <0>;
+	rxd1-skew-ps = <0>;
+	rxd2-skew-ps = <0>;
+	rxd3-skew-ps = <0>;
+	txen-skew-ps = <0>;
+	txc-skew-ps = <0>;
+	rxdv-skew-ps = <0>;
+	rxc-skew-ps = <0>;
+	snps,max-mtu = <0>;
+	status = "okay";
+};
+
+&spi1 {
+	a10_sysctl: a10_sysctl@0 {
+		compatible = "altr,a10sycon";
+		reg = <0>;
+		interrupt-parent = <&gpio1>;
+		/* low-level active IRQ at GPIO1_5 */
+		interrupts = <5 0x8>;
+		interrupt-controller;
+		#interrupt-cells = <2>;
+		spi-max-frequency = <1000000>;
+
+		gpio4: gpio-controller {
+			compatible = "altr,a10sycon-gpio";
+			gpio-controller;
+			#gpio-cells = <2>;
+			ngpios = <16>;
+		};
+
+		hwmon: a10hwmon {
+			compatible = "altr,a10sycon-hwmon";
+		};
+
+		a10rst: a10rst {
+			compatible = "altr,a10sycon-reset";
+			#reset-cells = <1>;
+		};
+	};
+};
+
+&mmc {
+	status = "okay";
+	num-slots = <1>;
+	supports-highspeed;
+	broken-cd;
+	altr,dw-mshc-ciu-div = <3>;
+	altr,dw-mshc-sdr-timing = <0 3>;
+	clock-frequency = <50000000>;
+	clock-freq-min-max = <400000 25000000>;
+
+	slot@0 {
+		reg = <0>;
+		bus-width = <1>;
+	};
+};
+
+&usb0 {
+	status = "okay";
+};
-- 
1.9.1

