From 52afcb62fc39d4b3c7f37459d67e0c8f9a2de5c3 Mon Sep 17 00:00:00 2001
From: Alan Tull <atull@altera.com>
Date: Tue, 30 Jul 2013 14:07:53 -0500
Subject: [PATCH 018/172] FogBugz #142060: do not clear the mpuzero bit

The remap register is write-only (!) and reads zeros.  So doing a
'read, modify, write' operation on that register will clear the
mpuzero bit that was set by u-boot.

Signed-off-by: Alan Tull <atull@altera.com>
[czou:Original patch taken from
https://github.com/altera-opensource/linux-socfpga.git socfpga-4.1]
Signed-off-by: czou <cao.zou@windriver.com>
---
 drivers/misc/fpga-bridge/altera-hps2fpga.c | 11 ++++++-----
 1 file changed, 6 insertions(+), 5 deletions(-)

diff --git a/drivers/misc/fpga-bridge/altera-hps2fpga.c b/drivers/misc/fpga-bridge/altera-hps2fpga.c
index 76f2542..13af155 100644
--- a/drivers/misc/fpga-bridge/altera-hps2fpga.c
+++ b/drivers/misc/fpga-bridge/altera-hps2fpga.c
@@ -33,6 +33,7 @@
 #define ALT_RSTMGR_BRGMODRST_F2H_MSK		0x00000004
 
 #define ALT_L3_REMAP_OFST			0x0
+#define ALT_L3_REMAP_MPUZERO_MSK		0x00000001
 #define ALT_L3_REMAP_H2F_MSK			0x00000008
 #define ALT_L3_REMAP_LWH2F_MSK			0x00000010
 
@@ -63,6 +64,7 @@ static void alt_hps2fpga_enable_set(struct fpga_bridge *bridge, bool enable)
 	struct altera_hps2fpga_data *priv = bridge->priv;
 	int value;
 
+	/* bring bridge out of reset */
 	if (enable)
 		value = 0;
 	else
@@ -73,13 +75,12 @@ static void alt_hps2fpga_enable_set(struct fpga_bridge *bridge, bool enable)
 
 	/* Allow bridge to be visible to L3 masters or not */
 	if (priv->remap_mask) {
+		value = ALT_L3_REMAP_MPUZERO_MSK;
+
 		if (enable)
-			value = 0;
-		else
-			value = priv->remap_mask;
+			value |= priv->remap_mask;
 
-		regmap_update_bits(priv->l3reg, ALT_L3_REMAP_OFST,
-				priv->remap_mask, value);
+		regmap_write(priv->l3reg, ALT_L3_REMAP_OFST, value);
 	}
 }
 
-- 
1.9.1

