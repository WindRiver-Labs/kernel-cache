From dcfe5bd079af2a8a5cf73de7bc4dca5043278fb9 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@opensource.altera.com>
Date: Fri, 30 Jan 2015 15:20:11 -0600
Subject: [PATCH 105/172] FogBugz #270904-2: Add SD/MMC support for arria10
 devkit

Add a temporary hack in the sd/mmc driver to not enable PWREN register since
the SD power line on the A10 devkit is reverse logic. 0->on, 1->off.

Update the DTS to for the sdmmc node.

Signed-off-by: Dinh Nguyen <dinguyen@opensource.altera.com>
[czou:Original patch taken from
https://github.com/altera-opensource/linux-socfpga.git socfpga-4.1]
Signed-off-by: czou <cao.zou@windriver.com>
---
 arch/arm/boot/dts/socfpga_arria10.dtsi      |  1 +
 arch/arm/boot/dts/socfpga_arria10_socdk.dts | 15 +++++++++++++++
 drivers/mmc/host/dw_mmc.c                   |  3 ++-
 3 files changed, 18 insertions(+), 1 deletion(-)

diff --git a/arch/arm/boot/dts/socfpga_arria10.dtsi b/arch/arm/boot/dts/socfpga_arria10.dtsi
index 387e026..f8f10ee 100644
--- a/arch/arm/boot/dts/socfpga_arria10.dtsi
+++ b/arch/arm/boot/dts/socfpga_arria10.dtsi
@@ -112,6 +112,7 @@
 					sdmmc_clk: sdmmc_clk {
 						#clock-cells = <0>;
 						compatible = "fixed-clock";
+						clock-frequency = <50000000>;
 					};
 
 					mpu_periph_clk: mpu_periph_clk {
diff --git a/arch/arm/boot/dts/socfpga_arria10_socdk.dts b/arch/arm/boot/dts/socfpga_arria10_socdk.dts
index 65a4eca..a757b79 100755
--- a/arch/arm/boot/dts/socfpga_arria10_socdk.dts
+++ b/arch/arm/boot/dts/socfpga_arria10_socdk.dts
@@ -160,3 +160,18 @@
 		};
 	};
 };
+
+&mmc {
+	num-slots = <1>;
+	supports-highspeed;
+	broken-cd;
+	altr,dw-mshc-ciu-div = <3>;
+	altr,dw-mshc-sdr-timing = <0 3>;
+	clock-frequency = <50000000>;
+	clock-freq-min-max = <400000 25000000>;
+
+	slot@0 {
+		reg = <0>;
+		bus-width = <1>;
+	};
+};
diff --git a/drivers/mmc/host/dw_mmc.c b/drivers/mmc/host/dw_mmc.c
index 7ed9148..66c2c0f 100644
--- a/drivers/mmc/host/dw_mmc.c
+++ b/drivers/mmc/host/dw_mmc.c
@@ -1202,7 +1202,8 @@ static void dw_mci_set_ios(struct mmc_host *mmc, struct mmc_ios *ios)
 		set_bit(DW_MMC_CARD_NEED_INIT, &slot->flags);
 		regs = mci_readl(slot->host, PWREN);
 		regs |= (1 << slot->id);
-		mci_writel(slot->host, PWREN, regs);
+		/* TEMP HACK for A10. Don't turn on the PWREN. */
+		/* mci_writel(slot->host, PWREN, regs);*/
 		break;
 	case MMC_POWER_ON:
 		if (!slot->host->vqmmc_enabled) {
-- 
1.9.1

