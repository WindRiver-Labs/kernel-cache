From 4874e06dcf87f3a27ce6beb36988cabee1623a15 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@opensource.altera.com>
Date: Wed, 4 Mar 2015 16:57:40 -0600
Subject: [PATCH 114/172] FogBugz #270904-11: enable warm reboot on arria10
 devkit

This enables the "reboot" command.

NOTE: On the Arria10 Revision A devkit, only warm reset is working. Doing
a "reboot" in linux will issue a cold reboot, thus you need to add a
kernel parameter "reboot=warm" for you linux boot parameters.

Signed-off-by: Dinh Nguyen <dinguyen@opensource.altera.com>
[czou:Original patch taken from
https://github.com/altera-opensource/linux-socfpga.git socfpga-4.1]
Signed-off-by: czou <cao.zou@windriver.com>
---
 arch/arm/mach-socfpga/core.h    |  2 ++
 arch/arm/mach-socfpga/socfpga.c | 16 ++++++++++++----
 2 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/arch/arm/mach-socfpga/core.h b/arch/arm/mach-socfpga/core.h
index ef06a00..f9e50b9 100644
--- a/arch/arm/mach-socfpga/core.h
+++ b/arch/arm/mach-socfpga/core.h
@@ -25,6 +25,8 @@
 #define SOCFPGA_RSTMGR_MODPERRST	0x14
 #define SOCFPGA_RSTMGR_BRGMODRST	0x1c
 
+#define SOCFPGA_A10_RSTMGR_CTRL		0xC
+
 /* System Manager bits */
 #define RSTMGR_CTRL_SWCOLDRSTREQ	0x1	/* Cold Reset */
 #define RSTMGR_CTRL_SWWARMRSTREQ	0x2	/* Warm Reset */
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 05b4b68..28f4ba9 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -202,15 +202,23 @@ static void socfpga_cyclone5_restart(enum reboot_mode mode, const char *cmd)
 	u32 temp;
 
 	/* Turn on all periph PLL clocks */
-	writel(0xffff, clkmgr_base_addr + SOCFPGA_ENABLE_PLL_REG);
-
-	temp = readl(rst_manager_base_addr + SOCFPGA_RSTMGR_CTRL);
+	if (!of_machine_is_compatible("altr,socfpga-arria10")) {
+		writel(0xffff, clkmgr_base_addr + SOCFPGA_ENABLE_PLL_REG);
+		temp = readl(rst_manager_base_addr + SOCFPGA_RSTMGR_CTRL);
+	} else {
+		temp = readl(rst_manager_base_addr + SOCFPGA_A10_RSTMGR_CTRL);
+	}
 
 	if (mode == REBOOT_HARD)
 		temp |= RSTMGR_CTRL_SWCOLDRSTREQ;
 	else
 		temp |= RSTMGR_CTRL_SWWARMRSTREQ;
-	writel(temp, rst_manager_base_addr + SOCFPGA_RSTMGR_CTRL);
+
+	if (of_machine_is_compatible("altr,socfpga-arria10")) {
+		writel(temp, rst_manager_base_addr + SOCFPGA_A10_RSTMGR_CTRL);
+	} else {
+		writel(temp, rst_manager_base_addr + SOCFPGA_RSTMGR_CTRL);
+	}
 }
 
 static void __init socfpga_cyclone5_init(void)
-- 
1.9.1

