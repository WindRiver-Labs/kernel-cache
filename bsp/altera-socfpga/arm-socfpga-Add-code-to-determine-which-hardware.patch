From 198b3ca2f1aac9b2dc2490cd1bb2bb22129b3558 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Fri, 2 Nov 2012 18:13:23 -0600
Subject: [PATCH 165/254] arm: socfpga: Add code to determine which hardware

Upstream: git://git.rocketboards.org/linux-socfpga.git
 linux is running on

Use device tree entries to determine which hardware linux is running on.
For this patch, its only make the appropriate change to CPU1 start addr,
but it also lays the foundation on how this can be done.

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
(cherry picked from commit 9246138c36759b39414ec2d7b87e09a44bf2b280)

Conflicts:
	arch/arm/boot/dts/Makefile
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-socfpga/core.h    |    1 +
 arch/arm/mach-socfpga/platsmp.c |    2 +-
 arch/arm/mach-socfpga/socfpga.c |   16 ++++++++++++++++
 3 files changed, 18 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-socfpga/core.h b/arch/arm/mach-socfpga/core.h
index 5935b2a..8fd51d7 100644
--- a/arch/arm/mach-socfpga/core.h
+++ b/arch/arm/mach-socfpga/core.h
@@ -34,6 +34,7 @@ extern void socfpga_init_clocks(void);
 extern char secondary_trampoline, secondary_trampoline_end;
 
 extern struct dw_mci_board sdmmc_platform_data;
+extern unsigned long cpu1start_addr;
 
 #define SOCFPGA_SCU_VIRT_BASE	0xfffec000
 #define SOCFPGA_SDMMC_BASE	0xff704000
diff --git a/arch/arm/mach-socfpga/platsmp.c b/arch/arm/mach-socfpga/platsmp.c
index ce936a6..22ce07f 100644
--- a/arch/arm/mach-socfpga/platsmp.c
+++ b/arch/arm/mach-socfpga/platsmp.c
@@ -47,7 +47,7 @@ static int __cpuinit socfpga_boot_secondary(unsigned int cpu, struct task_struct
 	memcpy(phys_to_virt(0), &secondary_trampoline, trampoline_size);
 
 	__raw_writel(virt_to_phys(secondary_startup),
-					(sys_manager_base_addr+0x10));
+					(sys_manager_base_addr+cpu1start_addr));
 
 	flush_cache_all();
 	smp_wmb();
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 4d78c41..caca2ab 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -32,6 +32,7 @@
 void __iomem *socfpga_scu_base_addr = ((void __iomem *)(SOCFPGA_SCU_VIRT_BASE));
 void __iomem *sys_manager_base_addr;
 void __iomem *rst_manager_base_addr;
+unsigned long	cpu1start_addr;
 
 static const struct of_dev_auxdata socfpga_auxdata_lookup[] __initconst = {
 #ifdef CONFIG_MMC_DW
@@ -71,6 +72,16 @@ static void __init socfpga_scu_map_io(void)
 	iotable_init(&scu_io_desc, 1);
 }
 
+static void __init init_socfpga_vt(void)
+{
+	cpu1start_addr = 0x10;
+}
+
+static void __init init_socfpga(void)
+{
+	cpu1start_addr = 0xc4;
+}
+
 static void __init enable_periphs(void)
 {
 	/* Release all peripherals from reset.*/
@@ -115,6 +126,11 @@ static void __init gic_init_irq(void)
 {
 	of_irq_init(irq_match);
 	socfpga_sysmgr_init();
+
+	if (of_machine_is_compatible("altr,socfpga-vt"))
+		init_socfpga_vt();
+	else
+		init_socfpga();
 }
 
 static void socfpga_cyclone5_restart(char mode, const char *cmd)
-- 
1.7.5.4

