From d928738ae2e4710774c0e2e0a35364951fad357d Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Tue, 11 Dec 2012 18:11:51 -0600
Subject: [PATCH 171/254] arm: socfpga: Enable SD/MMC driver for devkit

Upstream: git://git.rocketboards.org/linux-socfpga.git

Delete SDMMC clock entries because we don't want the MMC clock ever disabled.
Update the device tree entries to match the SD/MMC for v3.7.

/mach-socfpga part

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
(cherry picked from commit 8a6e3604ab434330893070f2c92292207e1f4141)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/boot/dts/socfpga.dtsi  |   23 +++---
 arch/arm/mach-socfpga/sdmmc.c   |  151 ---------------------------------------
 arch/arm/mach-socfpga/socfpga.c |    4 -
 drivers/clk/socfpga/clk.c       |    4 -
 4 files changed, 12 insertions(+), 170 deletions(-)
 delete mode 100644 arch/arm/mach-socfpga/sdmmc.c

diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index 2018af6..2f8907e 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -135,21 +135,22 @@
 			cache-level = <2>;
 		};
 
-		mmc: sdmmc@ff704000 {
-			compatible = "snps,dw-mmc";
+		mmc: dwmmc0@ff704000 {
+			compatible = "snps,dw-mshc";
 			reg = <0xff704000 0x1000>;
 			interrupts = <0 139 4>;
-			bus-hz = <50000000>; /*50MHz*/
+			bus-hz = <12500000>; /*12.5 MHz*/
+			#address-cells = <1>;
+			#size-cells = <0>;
 			num-slots = <1>;
-			bus-width = <8>;
-			fifo-depth = <1024>;
-			voltage-switch = <0>;	/* 0-No support */
-
-			/* First cell: smpl_sel, second cell: drv_sel*/
-			mmc-hs-timing = <7 4>;
-			sdr12-timing = <0 4>;
-			sdr25-timing = <7 3>;
+			supports-highspeed;
+			broken-cd;
+			fifo-depth = <0x400>;
+			slot@0 {
+				reg = <0>;
+				bus-width = <4>;
 			};
+		};
 
 		nand: nand@ff900000 {
 			#address-cells = <1>;
diff --git a/arch/arm/mach-socfpga/sdmmc.c b/arch/arm/mach-socfpga/sdmmc.c
deleted file mode 100644
index bb3a776..0000000
--- a/arch/arm/mach-socfpga/sdmmc.c
+++ /dev/null
@@ -1,151 +0,0 @@
-/*
- *  linux/arch/arm/mach-socfpga5xs1/sdmmc.c
- *
- *  Copyright (C) 2011 Altera Corporation
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation; either version 2 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- */
-
-#include <linux/platform_device.h>
-#include <linux/io.h>
-#include <linux/interrupt.h>
-#include <linux/mmc/dw_mmc.h>
-#include <linux/mmc/host.h>
-#include <linux/dma-mapping.h>
-#include <linux/of.h>
-#include <linux/of_address.h>
-#include <asm/errno.h>/* Clock Manager */
-
-#define PWREN		(0x4)
-
-#define mci_writel(base, value, reg)			 \
-	__raw_writel((value), base + reg)
-
-#define mci_readl(base, reg)				\
-	__raw_readl(base + reg)
-
-static void __iomem *sdmmc_base = 0;
-
-static void __iomem* sdmmc_get_base_addr(void)
-{
-	struct device_node *np;
-
-	np = of_find_compatible_node(NULL, NULL, "snps,dw-mmc");
-	if (np) {
-		return of_iomap(np, 0);
-	}
-
-	return NULL;
-}
-
-void sdmmc_setpower(unsigned int slot_id, unsigned int volt)
-{
-	unsigned int power;
-
-	if (sdmmc_base == NULL) {
-		sdmmc_base = sdmmc_get_base_addr();
-		if (!sdmmc_base)
-			return;
-	}
-
-	power = mci_readl(sdmmc_base, PWREN);
-
-	if (volt == 0) {
-		/* turn off */
-		power &= ~(1 << slot_id);
-	}
-	else {
-		/* turn on */
-		power |= (1 << slot_id);
-	}
-
-	mci_writel(sdmmc_base, power, PWREN);
-
-	return;
-}
-
-int sdmmc_get_bus_width(unsigned int slot_id)
-{
-	struct device_node *np;
-	unsigned int bus_width;
-
-	np = of_find_compatible_node(NULL, NULL, "snps,dw-mmc");
-	if (np) {
-		if (!(of_property_read_u32(np, "bus-width", &bus_width)))
-			return bus_width;
-	}
-
-	/* Default 1-bit */
-	return 1;
-}
-
-int sdmmc_get_ocr(unsigned int slot_id)
-{
-	struct device_node *np;
-	unsigned int voltages = MMC_VDD_32_33 | MMC_VDD_33_34;
-	unsigned int vol_switch;
-
-	np = of_find_compatible_node(NULL, NULL, "snps,dw-mmc");
-	if (np) {
-		if (!of_property_read_u32(np, "voltage-switch", &vol_switch) &&
-			vol_switch)
-			voltages |= MMC_VDD_165_195;
-	}
-
-	return voltages;
-}
-
-int sdmmc_init (unsigned int slot_id, irq_handler_t handler, void *p)
-{
-	return 0;
-}
-
-void sdmmc_exit(unsigned int slot_id)
-{
-	if (sdmmc_base) {
-		iounmap(sdmmc_base);
-		sdmmc_base = NULL;
-	}
-	return;
-}
-
-struct dw_mci_board sdmmc_platform_data = {
-	.quirks = 0,				/* Workaround / Quirk flags */
-	.caps = (MMC_CAP_MMC_HIGHSPEED |
-		 MMC_CAP_SD_HIGHSPEED),		/* Capabilities */
-
-	/* delay in ms before detecting cards after interrupt */
-	.detect_delay_ms = 25,
-
-	.init = sdmmc_init,
-	.get_ro = NULL,
-	.get_cd = NULL,
-	.get_ocr = sdmmc_get_ocr,
-	.get_bus_wd = sdmmc_get_bus_width,	/* Get bus width */
-	/*
-	 * Enable power to selected slot and set voltage to desired level.
-	 * Voltage levels are specified using MMC_VDD_xxx defines defined
-	 * in linux/mmc/host.h file.
-	 */
-	.setpower = sdmmc_setpower,
-	.exit = sdmmc_exit,
-	.select_slot = NULL,		/* Nothing to select, we only have one
-					   slot */
-
-	.dma_ops = NULL,		/* support IDMA only */
-	.data = NULL,
-	.blk_settings = NULL, 		/* Use default setting for IDMAC */
-
-};
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 19b1c6a..3fa1ca7 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -36,10 +36,6 @@ void __iomem *rst_manager_base_addr;
 unsigned long	cpu1start_addr;
 
 static const struct of_dev_auxdata socfpga_auxdata_lookup[] __initconst = {
-#ifdef CONFIG_MMC_DW
-	OF_DEV_AUXDATA("snps,dw-mmc", SOCFPGA_SDMMC_BASE, "snps,dw-mmc",
-		&sdmmc_platform_data),
-#endif
 	{ /* sentinel */ }
 };
 
diff --git a/drivers/clk/socfpga/clk.c b/drivers/clk/socfpga/clk.c
index f35079c..d76f044 100644
--- a/drivers/clk/socfpga/clk.c
+++ b/drivers/clk/socfpga/clk.c
@@ -93,10 +93,6 @@ void __init socfpga_init_clocks(void)
 
 	clk = clk_register_fixed_rate(NULL, "s2f_usr_clk", NULL, CLK_IS_ROOT, SOCFPGA_S2F_USR_CLK);
 	clk_register_clkdev(clk, "s2f_usr_clk", NULL);
-
-	clk = clk_register_gate(NULL, "mmc_clk", "main_nand_sdmmc_clk", 0, clk_mgr_base_addr + CLKMGR_PERPLLGRP_EN,
-			CLKMGR_SDMMC_CLK_EN, 0, &_lock);
-	clk_register_clkdev(clk, NULL, "ff704000.sdmmc");
 	
 	clk = clk_register_gate(NULL, "gmac_clk", "per_pll_clk", 0, clk_mgr_base_addr + CLKMGR_PERPLLGRP_EN,
 			CLKMGR_EMAC0_CLK_EN, 0, &_lock);
-- 
1.7.5.4

