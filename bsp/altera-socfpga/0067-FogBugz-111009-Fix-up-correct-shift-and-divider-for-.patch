From bcd2c6e716d9bf4b18ebcff22bd5955198dd407b Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Thu, 28 Mar 2013 16:08:24 -0500
Subject: [PATCH 067/248] FogBugz #111009: Fix up correct shift and divider for
 PLL clocks.

The PLL clock values were been incorrectly divided, and the
denominator shift was wrong.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 drivers/clk/socfpga/clk.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/clk/socfpga/clk.c b/drivers/clk/socfpga/clk.c
index 2a9a4bc..f9b948e 100644
--- a/drivers/clk/socfpga/clk.c
+++ b/drivers/clk/socfpga/clk.c
@@ -88,7 +88,7 @@ struct socfpga_clk {
 #define SOCFPGA_PLL_DIVF_MASK 0x0000FFF8
 #define SOCFPGA_PLL_DIVF_SHIFT 3
 #define SOCFPGA_PLL_DIVQ_MASK 0x003F0000
-#define SOCFPGA_PLL_DIVQ_SHIFT 15
+#define SOCFPGA_PLL_DIVQ_SHIFT 16
 
 extern void __iomem *clk_mgr_base_addr;
 
@@ -137,7 +137,7 @@ static unsigned long clk_pll_recalc_rate(struct clk_hw *hwclk,
 	divf = (reg & SOCFPGA_PLL_DIVF_MASK) >> SOCFPGA_PLL_DIVF_SHIFT;
 	divq = (reg & SOCFPGA_PLL_DIVQ_MASK) >> SOCFPGA_PLL_DIVQ_SHIFT;
 	vco_freq = parent_rate * (divf + 1);
-	return vco_freq / (1 << divq);
+	return vco_freq / (1 + divq);
 }
 
 
-- 
1.9.1

