From 6a8a1bc12543dc5744c8d4ccdea10fa6b82a481e Mon Sep 17 00:00:00 2001
From: Ley Foon Tan <lftan@altera.com>
Date: Fri, 10 Mar 2017 13:09:04 +0800
Subject: [PATCH 1/2] PCI: altera: Check TLP completion status

commit ea1d3795f65e14619642b5f67382800f58e43f3d upstream

Check TLP packet successful completion status.  This fix the issue when
accessing multi-function devices in enumeration process, TLP will return
error when accessing non-exist function number.  Returns PCI error code
instead of generic errno.

Tested on Ethernet adapter card with multi-functions.

[bhelgaas: simplify completion status checking code]
Signed-off-by: Ley Foon Tan <lftan@altera.com>
Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
Signed-off-by: Hu <yadi.hu@windriver.com>
---
 drivers/pci/host/pci-altera.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/drivers/pci/host/pci-altera.c b/drivers/pci/host/pci-altera.c
index 1202a29..5e02d9e 100644
--- a/drivers/pci/host/pci-altera.c
+++ b/drivers/pci/host/pci-altera.c
@@ -55,6 +55,7 @@
 #define TLP_READ_TAG       0x1D  /* statically define */
 #define TLP_WRITE_TAG      0x10  /* statically define */
 #define TLP_CFG_DW2(bus, devfn, offset) ((bus << 24) | (devfn << 16) | offset)
+#define TLP_COMP_STATUS(s) (((s) >> 12) & 7)
 
 /* Address translation table entry size */
 #define ATT_ENTRY_SIZE		8
@@ -113,6 +114,7 @@ static int tlp_read_packet(struct altera_pcie *pcie, u32 *value)
 	int err = PCIBIOS_SUCCESSFUL;
 	struct tlp_rp_regpair_t tlp_rp_regdata;
 	u8 loop;
+	u32 comp_status = 1;
 
 	/*
 	 * Detect RP_RXCPL_SOP is not require,
@@ -131,6 +133,10 @@ static int tlp_read_packet(struct altera_pcie *pcie, u32 *value)
 	if (loop == 0)
 		err = -ENOENT;
 
+	comp_status = TLP_COMP_STATUS(tlp_rp_regdata.rp_reg1);
+	if (comp_status)
+		return PCIBIOS_DEVICE_NOT_FOUND;
+
 	/* read data */
 	if (value)
 		*value = tlp_rp_regdata.rp_reg0;
-- 
1.7.5.4

