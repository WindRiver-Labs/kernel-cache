From 9e490d750d46f65be4990a6f1a3f1145fa7d3caf Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Fri, 30 Aug 2013 14:15:04 -0500
Subject: [PATCH 129/248] FogBugz #151649: Fix USB peripheral mode driver for
 v3.10 kernel

The gadget framework changed quite a bit for v3.10. Things such as
the register_device/unregister is no longer necessary for UDC
drivers.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 drivers/usb/otg/dwc/Kconfig    |  1 +
 drivers/usb/otg/dwc/pcd.c      | 13 +------------
 drivers/usb/otg/dwc/platform.c | 14 +-------------
 3 files changed, 3 insertions(+), 25 deletions(-)

diff --git a/drivers/usb/otg/dwc/Kconfig b/drivers/usb/otg/dwc/Kconfig
index b88c619..c5d71d0 100644
--- a/drivers/usb/otg/dwc/Kconfig
+++ b/drivers/usb/otg/dwc/Kconfig
@@ -43,6 +43,7 @@ config DWC_DEVICE_ONLY
 	select USB_GADGET_SELECTED
 	select USB_GADGET_DWC_HDRC
 	select USB_GADGET_DWC_OTG
+	select CONFIGFS_FS
 
 endchoice
 
diff --git a/drivers/usb/otg/dwc/pcd.c b/drivers/usb/otg/dwc/pcd.c
index 4cea9ef..ffa40f2 100644
--- a/drivers/usb/otg/dwc/pcd.c
+++ b/drivers/usb/otg/dwc/pcd.c
@@ -1621,16 +1621,10 @@ int dwc_otg_pcd_init(struct device *dev)
 /*	pcd->gadget.is_dualspeed = check_is_dual_speed(core_if);*/
 	pcd->gadget.is_otg = check_is_otg(core_if);
 
-	/* Register the gadget device */
-	retval = device_register(&pcd->gadget.dev);
-	if (retval)
-		goto unreg_device;
-
-
 	/* hook up the gadget*/
 	retval = usb_add_gadget_udc(dev, &pcd->gadget);
 	if (retval)
-		goto unreg_device;
+		goto err;
 
 	/* Initialized the Core for Device mode. */
 	if (dwc_otg_is_device_mode(core_if))
@@ -1666,9 +1660,6 @@ err_cleanup:
 	otg_dev->pcd = NULL;
 	s_pcd = NULL;
 
-unreg_device:
-	device_unregister(&pcd->gadget.dev);
-
 err:
 	return retval;
 }
@@ -1733,7 +1724,6 @@ static int dwc_gadget_start(struct usb_gadget *gadget,
 
 	/* hook up the driver */
 	s_pcd->driver = driver;
-	s_pcd->gadget.dev.driver = &driver->driver;
 
 	return 0;
 }
@@ -1756,7 +1746,6 @@ static int dwc_gadget_stop(struct usb_gadget *gadget,
 	otg_set_peripheral(core_if->xceiv->otg, NULL);
 
 	driver->unbind(&s_pcd->gadget);
-	s_pcd->driver = NULL;
 
 	return 0;
 }
diff --git a/drivers/usb/otg/dwc/platform.c b/drivers/usb/otg/dwc/platform.c
index 033d3f4..6631d58 100644
--- a/drivers/usb/otg/dwc/platform.c
+++ b/drivers/usb/otg/dwc/platform.c
@@ -399,19 +399,7 @@ static struct platform_driver dwc_otg_driver = {
 		},
 };
 
-static int __init dwc_otg_driver_init(void)
-{
-	return platform_driver_probe(&dwc_otg_driver, dwc_otg_driver_probe);
-}
-
-module_init(dwc_otg_driver_init);
-
-static void __exit dwc_otg_driver_cleanup(void)
-{
-	platform_driver_unregister(&dwc_otg_driver);
-}
-
-module_exit(dwc_otg_driver_cleanup);
+module_platform_driver_probe(dwc_otg_driver, dwc_otg_driver_probe);
 
 MODULE_DESCRIPTION(DWC_DRIVER_DESC);
 MODULE_AUTHOR("Mark Miesfeld <mmiesfeld@apm.com");
-- 
1.9.1

