From b5cd7e1c756a9a4ba9d7d296e7303b78a36d6da2 Mon Sep 17 00:00:00 2001
From: Thor Thayer <tthayer@altera.com>
Date: Tue, 17 Sep 2013 11:23:20 -0500
Subject: [PATCH 141/248] FogBugz #138919: Fixes for Linux CAN Support

The community C_CAN/D_CAN driver works with the SoCFPGA CycloneV board
but requires a few changes to the Altera SoCFPGA device tree.
Add changes to socfpga.dtsi :
- Update of IRQs (needed to add the CAN Message Object IRQ.
- Define the CAN clocks
- Leave CAN0 and CAN1 disabled.
- Correct CAN1 register offset to 0xFFC01000
Add changes to socfpga_cyclone5.dts
- Turn on CAN0 on Cyclone5 boards.
CAN should be compiled into kernel for Altera SoCFPGA.
- Configure CAN by default in socfpga_defconfig

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Thor Thayer <tthayer@altera.com>
---
 arch/arm/boot/dts/socfpga.dtsi          | 10 ++++++----
 arch/arm/boot/dts/socfpga_cyclone5.dtsi |  4 ++++
 arch/arm/configs/socfpga_defconfig      |  9 +++++++++
 3 files changed, 19 insertions(+), 4 deletions(-)

diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index aec90d7..3822f4b 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -444,14 +444,16 @@
 		dcan0: d_can@ffc00000 {
 			compatible = "bosch,d_can";
 			reg = <0xffc00000 0x1000>;
-			interrupts = <0 131 4>;
+			interrupts = <0 131 4>, <0 132 4>;
+			clocks = <&can0_clk>;
 			status = "disabled";
 		};
 
-		dcan1: d_can@ffc10000 {
+		dcan1: d_can@ffc01000 {
 			compatible = "bosch,d_can";
-			reg = <0xffc10000 0x1000>;
-			interrupts = <0 135 4>;
+			reg = <0xffc01000 0x1000>;
+			interrupts = <0 135 4>, <0 136 4>;
+			clocks = <&can1_clk>;
 			status = "disabled";
 		};
 
diff --git a/arch/arm/boot/dts/socfpga_cyclone5.dtsi b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
index 7aeb07b..62d7c51 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5.dtsi
+++ b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
@@ -48,6 +48,10 @@
 			};
 		};
 
+		dcan0: d_can@ffc00000 {
+			status = "okay";
+		};
+
 		dwmmc0@ff704000 {
 			num-slots = <1>;
 			supports-highspeed;
diff --git a/arch/arm/configs/socfpga_defconfig b/arch/arm/configs/socfpga_defconfig
index 9ddc1bd..e7d72b7 100644
--- a/arch/arm/configs/socfpga_defconfig
+++ b/arch/arm/configs/socfpga_defconfig
@@ -41,6 +41,15 @@ CONFIG_IP_PNP=y
 CONFIG_IP_PNP_DHCP=y
 CONFIG_IP_PNP_BOOTP=y
 CONFIG_IP_PNP_RARP=y
+CONFIG_CAN=y
+CONFIG_CAN_RAW=y
+CONFIG_CAN_BCM=y
+CONFIG_CAN_GW=y
+CONFIG_CAN_DEV=y
+CONFIG_CAN_CALC_BITTIMING=y
+CONFIG_CAN_C_CAN=y
+CONFIG_CAN_C_CAN_PLATFORM=y
+CONFIG_CAN_DEBUG_DEVICES=y
 CONFIG_UEVENT_HELPER_PATH="/sbin/hotplug"
 CONFIG_DEVTMPFS=y
 CONFIG_DEVTMPFS_MOUNT=y
-- 
1.9.1

