From a375afdb02de01a97faff600457dd5172d9d3ce2 Mon Sep 17 00:00:00 2001
From: Graham Moore <grmoore@altera.com>
Date: Fri, 24 Jan 2014 01:38:27 -0600
Subject: [PATCH 176/248] FogBugz #139359: Code changes for PL330 DMA driver to
 support socfpga CycloneV

Increased number of amba device irqs to support 8 DMA channels.
Fixed NULL pointer error.
Added check for aborted DMA transactions.
Added code to read copy-align parameter from device tree.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: graham <grmoore@altera.com>

V2:

Add #ifdef CONFIG_ARCH_SOCFPGA to include/linux/amba/bus.h so that
these changes do not affect other platforms

We tried integrating Lee Booi's code for 8-1 irq mapping, but were unable
to get it working in time for the code freeze.  We will file a FogBugz
immediately which flags this commit as an incorrect implemention.  Then we
will get Lee Booi's code working.

V3:

Added comment at line 1752 in pl330.c to explain need for id == -1 check.

Conflicts:

	drivers/dma/pl330.c
	include/linux/amba/bus.h
---
 drivers/dma/pl330.c      | 43 ++++++++++++-------------------------------
 include/linux/amba/bus.h |  4 ----
 2 files changed, 12 insertions(+), 35 deletions(-)

diff --git a/drivers/dma/pl330.c b/drivers/dma/pl330.c
index 257451d..a1b68ac 100755
--- a/drivers/dma/pl330.c
+++ b/drivers/dma/pl330.c
@@ -2929,27 +2929,24 @@ pl330_probe(struct amba_device *adev, const struct amba_id *id)
 
 	amba_set_drvdata(adev, pdmac);
 
-	for (i = 0; i < AMBA_NR_IRQS; i++) {
-		irq = adev->irq[i];
-		if (irq == 0)
-			break;
-		ret = request_irq(irq, pl330_irq_handler, 0,
-				dev_name(&adev->dev), pi);
-		if (ret)
-			goto probe_err1;
-	}
-
 	if (pdat && pdat->init) {
 		ret = pdat->init(adev);
 		if (ret)
 			return ret;
 	}
 
-	irq = adev->irq[0];
-	ret = request_irq(irq, pl330_irq_handler, 0,
-			dev_name(&adev->dev), pi);
-	if (ret)
-		return ret;
+	for (i = 0; i < AMBA_NR_IRQS; i++) {
+		irq = adev->irq[i];
+		if (irq) {
+			ret = devm_request_irq(&adev->dev, irq,
+					       pl330_irq_handler, 0,
+					       dev_name(&adev->dev), pi);
+			if (ret)
+				return ret;
+		} else {
+			break;
+		}
+	}
 
 	pi->pcfg.periph_id = adev->periphid;
 	ret = pl330_add(pi);
@@ -3078,13 +3075,6 @@ probe_err3:
 	}
 probe_err2:
 	pl330_del(pi);
-probe_err1:
-	for (i = 0; i < AMBA_NR_IRQS; i++) {
-		irq = adev->irq[i];
-		if (irq == 0)
-			break;
-		free_irq(irq, pi);
-	}
 
 	return ret;
 }
@@ -3094,8 +3084,6 @@ static int pl330_remove(struct amba_device *adev)
 	struct dma_pl330_dmac *pdmac = amba_get_drvdata(adev);
 	struct dma_pl330_chan *pch, *_p;
 	struct pl330_info *pi;
-	int irq;
-	int i;
 
 	if (!pdmac)
 		return 0;
@@ -3121,13 +3109,6 @@ static int pl330_remove(struct amba_device *adev)
 
 	pl330_del(pi);
 
-	for (i = 0; i < AMBA_NR_IRQS; i++) {
-		irq = adev->irq[i];
-		if (irq == 0)
-			break;
-		free_irq(irq, pi);
-	}
-
 	return 0;
 }
 
diff --git a/include/linux/amba/bus.h b/include/linux/amba/bus.h
index f47b8d7..682df0e 100644
--- a/include/linux/amba/bus.h
+++ b/include/linux/amba/bus.h
@@ -21,11 +21,7 @@
 #include <linux/resource.h>
 #include <linux/regulator/consumer.h>
 
-#ifdef CONFIG_ARCH_SOCFPGA
-#define AMBA_NR_IRQS	8
-#else
 #define AMBA_NR_IRQS	2
-#endif
 #define AMBA_CID	0xb105f00d
 
 struct clk;
-- 
1.9.1

