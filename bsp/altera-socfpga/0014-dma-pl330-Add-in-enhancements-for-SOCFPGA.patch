From d857e44fffae5724a1f50d37c72d9da6458beb07 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Wed, 17 Oct 2012 09:35:59 -0500
Subject: [PATCH 014/248] dma: pl330: Add in enhancements for SOCFPGA

-Add changes specific to socfpga.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 drivers/dma/pl330.c        | 9 ++++++++-
 include/linux/amba/pl330.h | 8 ++++++++
 2 files changed, 16 insertions(+), 1 deletion(-)
 mode change 100644 => 100755 drivers/dma/pl330.c

diff --git a/drivers/dma/pl330.c b/drivers/dma/pl330.c
old mode 100644
new mode 100755
index 73fa9b7..3d8e498
--- a/drivers/dma/pl330.c
+++ b/drivers/dma/pl330.c
@@ -2342,7 +2342,7 @@ static int pl330_alloc_chan_resources(struct dma_chan *chan)
 	pch->pl330_chid = pl330_request_channel(&pdmac->pif);
 	if (!pch->pl330_chid) {
 		spin_unlock_irqrestore(&pch->lock, flags);
-		return -ENOMEM;
+		return -EAGAIN;
 	}
 
 	tasklet_init(&pch->task, pl330_tasklet, (unsigned long) pch);
@@ -2936,6 +2936,12 @@ pl330_probe(struct amba_device *adev, const struct amba_id *id)
 		}
 	}
 
+	if (pdat->init) {
+		ret = pdat->init(adev);
+		if (ret)
+			goto probe_err3;
+	}
+
 	pi->pcfg.periph_id = adev->periphid;
 	ret = pl330_add(pi);
 	if (ret)
@@ -3063,6 +3069,7 @@ probe_err2:
 static int pl330_remove(struct amba_device *adev)
 {
 	struct dma_pl330_dmac *pdmac = amba_get_drvdata(adev);
+	struct dma_pl330_platdata *pdat = adev->dev.platform_data;
 	struct dma_pl330_chan *pch, *_p;
 	struct pl330_info *pi;
 
diff --git a/include/linux/amba/pl330.h b/include/linux/amba/pl330.h
index fe93758..e3408c6 100644
--- a/include/linux/amba/pl330.h
+++ b/include/linux/amba/pl330.h
@@ -29,6 +29,14 @@ struct dma_pl330_platdata {
 	dma_cap_mask_t cap_mask;
 	/* Bytes to allocate for MC buffer */
 	unsigned mcbuf_sz;
+	/* Start of IRQ numbers if support multiple IRQs */
+	int irq_start;
+	/* End of IRQ numbers if support multiple IRQs */
+	int irq_end;
+	/* Platform specific initialization function pointer*/
+	int (*init)(struct amba_device *adev);
+	/* Platform specific exit function pointer*/
+	void (*exit)(struct amba_device *adev);
 };
 
 extern bool pl330_filter(struct dma_chan *chan, void *param);
-- 
1.9.1

