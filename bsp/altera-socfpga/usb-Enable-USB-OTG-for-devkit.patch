From 3f24cdb592d7dffa9ac958a4fbd245f0d2ddf272 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Wed, 6 Mar 2013 14:23:38 -0600
Subject: [PATCH 207/254] usb: Enable USB OTG for devkit

Upstream: git://git.rocketboards.org/linux-socfpga.git

This enables Host Mode for the OTG port. This commit only enables initial
support for the OTG port with only Host mode and non-DMA.

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
(cherry picked from commit a6f8a7ca8a7b110e9ce6e2004d49a7bb7ce1909f)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/boot/dts/socfpga.dtsi         |   30 ++++++-------
 arch/arm/boot/dts/socfpga_cyclone5.dts |    8 ++++
 arch/arm/boot/dts/socfpga_ice.dts      |    8 ++++
 arch/arm/boot/dts/socfpga_vt.dts       |    8 ++++
 arch/arm/configs/socfpga_defconfig     |    4 +-
 drivers/usb/otg/dwc/cil.c              |    2 +-
 drivers/usb/otg/dwc/hcd.c              |   73 ++++++++++++++++++++------------
 drivers/usb/otg/dwc/platform.c         |    4 --
 8 files changed, 88 insertions(+), 49 deletions(-)

diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index 36e47a5..b8ab1b3 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -268,21 +268,6 @@
 			reg = <0xffd01000 0x1000>;
 		};
 
-		usb0: usb@ffb00000 {
-				compatible = "snps,dwc-otg";
-				reg = <0xffb00000 0xffff>;
-				interrupts = <0 125 4>;
-				dma-mask = <0xffffffff>;
-				ulpi-ddr = <0>;
-				host-rx-fifo-size = <512>;
-				dev-rx-fifo-size = <512>;
-				dev-nperio-tx-fifo-size = <4096>;
-				dev-perio-tx-fifo-size = <512 512 512 512 512 512
-					512 512 512 512 512 512 512 512 512>;
-				dev-tx-fifo-size = <512 512 512 512 512 512
-					512 512 512 512 512 512 512 512 512>;
-		};
-
 		uart0: serial0@ffc02000 {
 			compatible = "snps,dw-apb-uart";
 			reg = <0xffc02000 0x1000>;
@@ -299,12 +284,25 @@
 			reg-io-width = <4>;
 		};
 
+		usb0: usb@ffb00000 {
+				compatible = "snps,dwc-otg";
+				reg = <0xffb00000 0xffff>;
+				interrupts = <0 125 4>;
+				dma-mask = <0xffffffff>;
+				host-rx-fifo-size = <512>;
+				dev-rx-fifo-size = <512>;
+				dev-nperio-tx-fifo-size = <4096>;
+				dev-perio-tx-fifo-size = <512 512 512 512 512 512
+					512 512 512 512 512 512 512 512 512>;
+				dev-tx-fifo-size = <512 512 512 512 512 512
+					512 512 512 512 512 512 512 512 512>;
+		};
+
 		usb1: usb@ffb40000 {
 				compatible = "snps,dwc-otg";
 				reg = <0xffb40000 0xffff>;
 				interrupts = <0 128 4>;
 				dma-mask = <0xffffffff>;
-				ulpi-ddr = <1>;
 				host-rx-fifo-size = <512>;
 				dev-rx-fifo-size = <512>;
 				dev-nperio-tx-fifo-size = <4096>;
diff --git a/arch/arm/boot/dts/socfpga_cyclone5.dts b/arch/arm/boot/dts/socfpga_cyclone5.dts
index 0647e77..dd04f9f 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5.dts
+++ b/arch/arm/boot/dts/socfpga_cyclone5.dts
@@ -118,6 +118,14 @@
 			clock-frequency = <100000000>;
 		};
 
+		usb0: usb@ffb00000 {
+			status = "disabled";
+		};
+
+		usb1: usb@ffb40000 {
+			ulpi-ddr = <0>;
+		};
+
 		i2c0: i2c@ffc04000 {
 			speed-mode = <0>;
 		};
diff --git a/arch/arm/boot/dts/socfpga_ice.dts b/arch/arm/boot/dts/socfpga_ice.dts
index 7a60687..4522181 100644
--- a/arch/arm/boot/dts/socfpga_ice.dts
+++ b/arch/arm/boot/dts/socfpga_ice.dts
@@ -114,6 +114,14 @@
 			clock-frequency = <19290>;
 		};
 
+		usb0: usb@ffb00000 {
+                       ulpi-ddr = <0>;
+                };
+
+                usb1: usb@ffb40000 {
+                       ulpi-ddr = <0>;
+                };
+
 		serial0@ffc02000 {
 			clock-frequency = <77161>;
 		};
diff --git a/arch/arm/boot/dts/socfpga_vt.dts b/arch/arm/boot/dts/socfpga_vt.dts
index ecd0e45..04090c5 100644
--- a/arch/arm/boot/dts/socfpga_vt.dts
+++ b/arch/arm/boot/dts/socfpga_vt.dts
@@ -119,6 +119,14 @@
 			clock-frequency = <7000000>;
 		};
 
+		usb0: usb@ffb00000 {
+			ulpi-ddr = <0>;
+		};
+
+		usb1: usb@ffb40000 {
+			ulpi-ddr = <0>;
+		};
+
 		serial0@ffc02000 {
 			clock-frequency = <7372800>;
 		};
diff --git a/arch/arm/configs/socfpga_defconfig b/arch/arm/configs/socfpga_defconfig
index c0d8bf6..a7eaca5 100644
--- a/arch/arm/configs/socfpga_defconfig
+++ b/arch/arm/configs/socfpga_defconfig
@@ -71,7 +71,9 @@ CONFIG_SERIAL_8250_DW=y
 CONFIG_USB=y
 CONFIG_USB_STORAGE=y
 CONFIG_USB_GADGET=y
-CONFIG_DWC_OTG_MODE=y
+# CONFIG_DWC_OTG_MODE is not set
+CONFIG_DWC_HOST_ONLY=y
+CONFIG_DWC_SLAVE=y
 CONFIG_MMC=y
 CONFIG_MMC_DW=y
 CONFIG_MMC_DW_IDMAC=y
diff --git a/drivers/usb/otg/dwc/cil.c b/drivers/usb/otg/dwc/cil.c
index f8458d4..fa15a2e 100644
--- a/drivers/usb/otg/dwc/cil.c
+++ b/drivers/usb/otg/dwc/cil.c
@@ -226,7 +226,7 @@ void dwc_otg_enable_common_interrupts(struct core_if *core_if)
 void dwc_otg_core_init(struct core_if *core_if)
 {
 	u32 i;
-	ulong global_reg = core_if->core_global_regs;
+	u32 global_reg = core_if->core_global_regs;
 	struct device_if *dev_if = core_if->dev_if;
 	u32 ahbcfg = 0;
 	u32 gusbcfg;
diff --git a/drivers/usb/otg/dwc/hcd.c b/drivers/usb/otg/dwc/hcd.c
index 239c0a4..e51df24 100644
--- a/drivers/usb/otg/dwc/hcd.c
+++ b/drivers/usb/otg/dwc/hcd.c
@@ -115,6 +115,23 @@ static void dwc_otg_core_host_init(struct core_if *core_if)
 	/* Restart the Phy Clock */
 	dwc_reg_write(core_if->pcgcctl, 0, 0);
 
+	/* Power the PHY*/
+	hprt0 = dwc_otg_read_hprt0(core_if);
+	hprt0 = DWC_HPRT0_PRT_PWR_RW(hprt0, 1);
+	dwc_reg_write(core_if->host_if->hprt0, 0, hprt0);
+
+	/* Reset the PHY */
+	hprt0 = dwc_otg_read_hprt0(core_if);
+	hprt0 = DWC_HPRT0_PRT_RST_RW(hprt0, 1);
+	dwc_reg_write(core_if->host_if->hprt0, 0, hprt0);
+
+	msleep(1);
+
+	/* Release PHY from reset */
+	hprt0 = dwc_otg_read_hprt0(core_if);
+	hprt0 = DWC_HPRT0_PRT_RST_RW(hprt0, 0);
+	dwc_reg_write(core_if->host_if->hprt0, 0, hprt0);
+
 	/* Initialize Host Configuration Register */
 	init_fslspclksel(core_if);
 
@@ -155,37 +172,39 @@ static void dwc_otg_core_host_init(struct core_if *core_if)
 	dwc_otg_flush_tx_fifo(core_if, DWC_GRSTCTL_TXFNUM_ALL);
 	dwc_otg_flush_rx_fifo(core_if);
 
-	/* Flush out any leftover queued requests. */
-	num_channels = core_if->core_params->host_channels;
-	for (i = 0; i < num_channels; i++) {
-		hc_regs = core_if->host_if->hc_regs[i];
-		hcchar = dwc_reg_read(hc_regs, DWC_HCCHAR);
-		hcchar = DWC_HCCHAR_ENA_RW(hcchar, 0);
-		hcchar = DWC_HCCHAR_DIS_RW(hcchar, 1);
-		hcchar = DWC_HCCHAR_EPDIR_RW(hcchar, 0);
-		dwc_reg_write(hc_regs, DWC_HCCHAR, hcchar);
-	}
-
-	/* Halt all channels to put them into a known state. */
-	for (i = 0; i < num_channels; i++) {
-		int count = 0;
+	if (params->dma_enable) {
+		/* Flush out any leftover queued requests. */
+		num_channels = core_if->core_params->host_channels;
+		for (i = 0; i < num_channels; i++) {
+			hc_regs = core_if->host_if->hc_regs[i];
+			hcchar = dwc_reg_read(hc_regs, DWC_HCCHAR);
+			hcchar = DWC_HCCHAR_ENA_RW(hcchar, 0);
+			hcchar = DWC_HCCHAR_DIS_RW(hcchar, 1);
+			hcchar = DWC_HCCHAR_EPDIR_RW(hcchar, 0);
+			dwc_reg_write(hc_regs, DWC_HCCHAR, hcchar);
+		}
 
-		hc_regs = core_if->host_if->hc_regs[i];
-		hcchar = dwc_reg_read(hc_regs, DWC_HCCHAR);
-		hcchar = DWC_HCCHAR_ENA_RW(hcchar, 1);
-		hcchar = DWC_HCCHAR_DIS_RW(hcchar, 1);
-		hcchar = DWC_HCCHAR_EPDIR_RW(hcchar, 0);
-		dwc_reg_write(hc_regs, DWC_HCCHAR, hcchar);
+		/* Halt all channels to put them into a known state. */
+		for (i = 0; i < num_channels; i++) {
+			int count = 0;
 
-		do {
+			hc_regs = core_if->host_if->hc_regs[i];
 			hcchar = dwc_reg_read(hc_regs, DWC_HCCHAR);
-			if (++count > 200) {
-				pr_err("%s: Unable to clear halt on "
+			hcchar = DWC_HCCHAR_ENA_RW(hcchar, 1);
+			hcchar = DWC_HCCHAR_DIS_RW(hcchar, 1);
+			hcchar = DWC_HCCHAR_EPDIR_RW(hcchar, 0);
+			dwc_reg_write(hc_regs, DWC_HCCHAR, hcchar);
+
+			do {
+				hcchar = dwc_reg_read(hc_regs, DWC_HCCHAR);
+				if (++count > 200) {
+					pr_err("%s: Unable to clear halt on "
 				       "channel %d\n", __func__, i);
-				break;
-			}
-			udelay(100);
-		} while (DWC_HCCHAR_ENA_RD(hcchar));
+					break;
+				}
+				udelay(100);
+			} while (DWC_HCCHAR_ENA_RD(hcchar));
+		}
 	}
 
 	/* Turn on the vbus power. */
diff --git a/drivers/usb/otg/dwc/platform.c b/drivers/usb/otg/dwc/platform.c
index 71e2fb5..ebb3675 100644
--- a/drivers/usb/otg/dwc/platform.c
+++ b/drivers/usb/otg/dwc/platform.c
@@ -358,10 +358,6 @@ static int __devinit dwc_otg_driver_probe(struct platform_device *ofdev)
 	 */
 	dwc_otg_enable_global_interrupts(dwc_dev->core_if);
 
-	usbcfg = dwc_reg_read(gusbcfg_addr, 0);
-	usbcfg &= ~DWC_USBCFG_FRC_HST_MODE;
-	dwc_reg_write(gusbcfg_addr, 0, usbcfg);
-
 	return 0;
 fail_hcd:
 	free_irq(dwc_dev->irq, dwc_dev);
-- 
1.7.5.4

