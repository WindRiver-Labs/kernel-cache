From fadf417c66627033618e0272c8c5b3a0e4c60f64 Mon Sep 17 00:00:00 2001
From: Graham Moore <grmoore@altera.com>
Date: Fri, 24 Jan 2014 01:38:16 -0600
Subject: [PATCH 175/248] FogBugz #140538: Fix multiple interrupt
 implementation in pl330

Modify device tree for multiple interrupt parameters.
Add DMA files which combine multiple DMA irqs into one.
Add platform data structure.
Modify pl330 driver, less intrusive modifications for multiple IRQs.
Remove AMBA_NR_IRQS modification.
Document devicetree bindings.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Graham Moore <grmoore@altera.com>

Conflicts:

	drivers/dma/pl330.c
	include/linux/amba/bus.h
---
 drivers/dma/pl330.c      | 26 +++++++++++++++++++++++---
 include/linux/amba/bus.h |  4 ++++
 2 files changed, 27 insertions(+), 3 deletions(-)

diff --git a/drivers/dma/pl330.c b/drivers/dma/pl330.c
index 307dd39..257451d 100755
--- a/drivers/dma/pl330.c
+++ b/drivers/dma/pl330.c
@@ -2929,6 +2929,16 @@ pl330_probe(struct amba_device *adev, const struct amba_id *id)
 
 	amba_set_drvdata(adev, pdmac);
 
+	for (i = 0; i < AMBA_NR_IRQS; i++) {
+		irq = adev->irq[i];
+		if (irq == 0)
+			break;
+		ret = request_irq(irq, pl330_irq_handler, 0,
+				dev_name(&adev->dev), pi);
+		if (ret)
+			goto probe_err1;
+	}
+
 	if (pdat && pdat->init) {
 		ret = pdat->init(adev);
 		if (ret)
@@ -3069,7 +3079,12 @@ probe_err3:
 probe_err2:
 	pl330_del(pi);
 probe_err1:
-	free_irq(irq, pi);
+	for (i = 0; i < AMBA_NR_IRQS; i++) {
+		irq = adev->irq[i];
+		if (irq == 0)
+			break;
+		free_irq(irq, pi);
+	}
 
 	return ret;
 }
@@ -3080,6 +3095,7 @@ static int pl330_remove(struct amba_device *adev)
 	struct dma_pl330_chan *pch, *_p;
 	struct pl330_info *pi;
 	int irq;
+	int i;
 
 	if (!pdmac)
 		return 0;
@@ -3105,8 +3121,12 @@ static int pl330_remove(struct amba_device *adev)
 
 	pl330_del(pi);
 
-	irq = adev->irq[0];
-	free_irq(irq, pi);
+	for (i = 0; i < AMBA_NR_IRQS; i++) {
+		irq = adev->irq[i];
+		if (irq == 0)
+			break;
+		free_irq(irq, pi);
+	}
 
 	return 0;
 }
diff --git a/include/linux/amba/bus.h b/include/linux/amba/bus.h
index 682df0e..f47b8d7 100644
--- a/include/linux/amba/bus.h
+++ b/include/linux/amba/bus.h
@@ -21,7 +21,11 @@
 #include <linux/resource.h>
 #include <linux/regulator/consumer.h>
 
+#ifdef CONFIG_ARCH_SOCFPGA
+#define AMBA_NR_IRQS	8
+#else
 #define AMBA_NR_IRQS	2
+#endif
 #define AMBA_CID	0xb105f00d
 
 struct clk;
-- 
1.9.1

