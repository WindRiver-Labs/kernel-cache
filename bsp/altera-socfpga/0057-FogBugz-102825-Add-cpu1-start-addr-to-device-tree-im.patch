From 6efb59c4ac108756c3d97ba2384709c686592c13 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Tue, 26 Feb 2013 14:08:00 -0600
Subject: [PATCH 057/248] FogBugz #102825: Add cpu1-start-addr to device tree
 implementation

Convert the usage of CPU1 start address to a device tree implementation.
Also, clean up the unnecessary defines for multiple boards in the
altera_dt_match table.
"altr, socfpga" is all we need in the socfpga.c file.

Add documentation for the Altera's reset and system manager bindings.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 arch/arm/boot/dts/socfpga_cyclone5.dtsi |  3 +++
 arch/arm/boot/dts/socfpga_ice.dts       |  6 +++++-
 arch/arm/mach-socfpga/platsmp.c         |  4 ++--
 arch/arm/mach-socfpga/socfpga.c         | 20 +++++---------------
 4 files changed, 15 insertions(+), 18 deletions(-)

diff --git a/arch/arm/boot/dts/socfpga_cyclone5.dtsi b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
index b26052a..c7054f5 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5.dtsi
+++ b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
@@ -141,6 +141,9 @@
 						reg = <0x0 0x1000000>;
 					};
 				};
+
+		i2c0: i2c@ffc04000 {
+			speed-mode = <0>;
 		};
 
 		leds {
diff --git a/arch/arm/boot/dts/socfpga_ice.dts b/arch/arm/boot/dts/socfpga_ice.dts
index b7b9573..7a60687 100644
--- a/arch/arm/boot/dts/socfpga_ice.dts
+++ b/arch/arm/boot/dts/socfpga_ice.dts
@@ -20,7 +20,7 @@
 
 / {
 	model = "Altera SOCFPGA Emulator";
-	compatible = "altr,socfpga-ice";
+	compatible = "altr,socfpga-ice", "altr,socfpga";
 
 	chosen {
 		bootargs = "console=ttyS0,4800";
@@ -94,6 +94,10 @@
 				};
 			};
 
+		sysmgr@ffd08000 {
+			cpu1-start-addr = <0xffd080c4>;
+		};
+
 		timer0@ffc08000 {
 			clock-frequency = <77161>;
 		};
diff --git a/arch/arm/mach-socfpga/platsmp.c b/arch/arm/mach-socfpga/platsmp.c
index beac16c..c2f650b 100644
--- a/arch/arm/mach-socfpga/platsmp.c
+++ b/arch/arm/mach-socfpga/platsmp.c
@@ -46,8 +46,8 @@ static int socfpga_boot_secondary(unsigned int cpu, struct task_struct *idle)
 	if (cpu1start_addr) {
 		memcpy(phys_to_virt(0), &secondary_trampoline, trampoline_size);
 
-		__raw_writel(virt_to_phys(socfpga_secondary_startup),
-			(sys_manager_base_addr + (cpu1start_addr & 0x000000ff)));
+		__raw_writel(virt_to_phys(v7_secondary_startup),
+			(sys_manager_base_addr+(cpu1start_addr & 0x000000ff)));
 
 		flush_cache_all();
 		smp_wmb();
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 5eeada4..25dd5f1 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -93,16 +93,6 @@ static void __init socfpga_scu_map_io(void)
 	iotable_init(&scu_io_desc, 1);
 }
 
-static void __init init_socfpga_vt(void)
-{
-	cpu1start_addr = 0xffd08010;
-}
-
-static void __init init_socfpga(void)
-{
-	cpu1start_addr = 0xffd080c4;
-}
-
 static void __init enable_periphs(void)
 {
 	/* Release all peripherals from reset.*/
@@ -227,6 +217,11 @@ static void __init socfpga_sysmgr_init(void)
 	struct device_node *np;
 
 	np = of_find_compatible_node(NULL, NULL, "altr,sys-mgr");
+
+	if (of_property_read_u32(np, "cpu1-start-addr",
+			(u32 *) &cpu1start_addr))
+		pr_err("SMP: Need cpu1-start-addr in device tree.\n");
+
 	sys_manager_base_addr = of_iomap(np, 0);
 
 	np = of_find_compatible_node(NULL, NULL, "altr,rst-mgr");
@@ -264,11 +259,6 @@ static void __init socfpga_init_irq(void)
 	irqchip_init();
 	socfpga_sysmgr_init();
 
-	if (of_machine_is_compatible("altr,socfpga-vt"))
-		init_socfpga_vt();
-	else
-		init_socfpga();
-
 	socfpga_init_clocks();
 	twd_local_timer_of_register();
 }
-- 
1.9.1

