From bb9e907503a1c11c31cdc28be3ce615a9f15817f Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Thu, 25 Oct 2012 17:49:00 -0600
Subject: [PATCH 163/254] arm: socfpga: Clean up SMP for SOCFPGA

Upstream: git://git.rocketboards.org/linux-socfpga.git

The SMP implementation for SOCFPGA should not rely on a bootloader
to bring CPU1 out of reset. This aligns the SMP implementation that
is accepted by the Linux community for SOCFPGA.

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
(cherry picked from commit 68636ffd565a987bfd6231b432191971b8d63248)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-socfpga/core.h    |    5 +++++
 arch/arm/mach-socfpga/headsmp.S |   33 +++++++++------------------------
 arch/arm/mach-socfpga/platsmp.c |   11 ++++-------
 arch/arm/mach-socfpga/socfpga.c |    6 +-----
 4 files changed, 19 insertions(+), 36 deletions(-)

diff --git a/arch/arm/mach-socfpga/core.h b/arch/arm/mach-socfpga/core.h
index ba70c41..5935b2a 100644
--- a/arch/arm/mach-socfpga/core.h
+++ b/arch/arm/mach-socfpga/core.h
@@ -31,6 +31,11 @@ extern void socfpga_secondary_startup(void);
 extern void socfpga_cpu_die(unsigned int cpu);
 extern void socfpga_init_clocks(void);
 
+extern char secondary_trampoline, secondary_trampoline_end;
+
 extern struct dw_mci_board sdmmc_platform_data;
 
+#define SOCFPGA_SCU_VIRT_BASE	0xfffec000
+#define SOCFPGA_SDMMC_BASE	0xff704000
+
 #endif /* __CORE_H */
diff --git a/arch/arm/mach-socfpga/headsmp.S b/arch/arm/mach-socfpga/headsmp.S
index 952a648..164c42c 100644
--- a/arch/arm/mach-socfpga/headsmp.S
+++ b/arch/arm/mach-socfpga/headsmp.S
@@ -11,30 +11,15 @@
 #include <linux/init.h>
 
 	__INIT
+	.arch   armv7-a
 
-/*
- * Entry point for secondary CPUs.
- * This provides a "holding pen" into which all secondary cores are held
- * until we're ready for them to initialise.
- */
-ENTRY(socfpga_secondary_startup)
-	mrc	p15, 0, r0, c0, c0, 5
-	and	r0, r0, #15
-	adr	r4, 1f
-	ldmia	r4, {r5, r6}
-	sub	r4, r4, r5
-	add	r6, r6, r4
-pen:	ldr	r7, [r6]
-	cmp	r7, r0
-	bne	pen
+#define CPU1_START_ADDR 	        0xffd08010
+
+ENTRY(secondary_trampoline)
+	movw	r0, #:lower16:CPU1_START_ADDR
+	movt  r0, #:upper16:CPU1_START_ADDR
 
-	/*
-	 * we've been released from the holding pen: secondary_stack
-	 * should now contain the SVC stack for this core
-	 */
-	b	secondary_startup
+	ldr	r1, [r0]
+	bx	r1
 
-	.align
-1:	.long	.
-	.long	pen_release
-ENDPROC(socfpga_secondary_startup)
+ENTRY(secondary_trampoline_end)
diff --git a/arch/arm/mach-socfpga/platsmp.c b/arch/arm/mach-socfpga/platsmp.c
index 95bed9c..ce936a6 100644
--- a/arch/arm/mach-socfpga/platsmp.c
+++ b/arch/arm/mach-socfpga/platsmp.c
@@ -30,10 +30,6 @@
 
 #include "core.h"
 
-int pen_release = -1;
-
-static DEFINE_SPINLOCK(boot_lock);
-
 void __cpuinit platform_secondary_init(unsigned int cpu)
 {
 	/*
@@ -50,7 +46,8 @@ static int __cpuinit socfpga_boot_secondary(unsigned int cpu, struct task_struct
 
 	memcpy(phys_to_virt(0), &secondary_trampoline, trampoline_size);
 
-	__raw_writel(virt_to_phys(secondary_startup), (sys_manager_base_addr+0x10));
+	__raw_writel(virt_to_phys(secondary_startup),
+					(sys_manager_base_addr+0x10));
 
 	flush_cache_all();
 	smp_wmb();
@@ -77,8 +74,8 @@ static void __init socfpga_smp_init_cpus(void)
 
 	/* sanity check */
 	if (ncores > num_possible_cpus()) {
-		pr_warn("socfpga: no. of cores (%d) greater than configured"
-			"maximum of %d - clipping\n", ncores, num_possible_cpus());
+		pr_warn("# of cores (%d) greater maximum of %d\n",
+			ncores, num_possible_cpus());
 		ncores = num_possible_cpus();
 	}
 
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index e783618..7edd4f9 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -29,14 +29,10 @@
 
 #define SOCFPGA_NR_IRQS		512
 
+void __iomem *socfpga_scu_base_addr = ((void __iomem *)(SOCFPGA_SCU_VIRT_BASE));
 void __iomem *sys_manager_base_addr;
 void __iomem *rst_manager_base_addr;
 
-#define SOCFPGA_SCU_VIRT_BASE	0xfffec000
-#define SOCFPGA_SDMMC_BASE	0xff704000
-
-void __iomem *socfpga_scu_base_addr = ((void __iomem *)(SOCFPGA_SCU_VIRT_BASE));
-
 static const struct of_dev_auxdata socfpga_auxdata_lookup[] __initconst = {
 #ifdef CONFIG_MMC_DW
 	OF_DEV_AUXDATA("snps,dw-mmc", SOCFPGA_SDMMC_BASE, "snps,dw-mmc",
-- 
1.7.5.4

