From 27ac37a8d8f7cc78ba924b358f694757d1049bca Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Wed, 17 Oct 2012 07:37:01 -0500
Subject: [PATCH 013/248] i2c: designware: Add changes required for SOCFPGA

-Add changes needed for i2c-dw controller on socfpga.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 drivers/i2c/busses/i2c-designware-core.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/i2c/busses/i2c-designware-core.c b/drivers/i2c/busses/i2c-designware-core.c
index d95b930..fa77650 100644
--- a/drivers/i2c/busses/i2c-designware-core.c
+++ b/drivers/i2c/busses/i2c-designware-core.c
@@ -446,7 +446,6 @@ i2c_dw_xfer_msg(struct dw_i2c_dev *dev)
 	bool need_restart = false;
 
 	intr_mask = DW_IC_INTR_DEFAULT_MASK;
-
 	for (; dev->msg_write_idx < dev->msgs_num; dev->msg_write_idx++) {
 		/*
 		 * if target address has changed, we need to
@@ -754,8 +753,10 @@ irqreturn_t i2c_dw_isr(int this_irq, void *dev_id)
 	stat = dw_readl(dev, DW_IC_RAW_INTR_STAT);
 	dev_dbg(dev->dev, "%s:  %s enabled= 0x%x stat=0x%x\n", __func__,
 		dev->adapter.name, enabled, stat);
-	if (!enabled || !(stat & ~DW_IC_INTR_ACTIVITY))
+	if (!enabled || !(stat & ~DW_IC_INTR_ACTIVITY)) {
+		i2c_dw_read_clear_intrbits(dev);
 		return IRQ_NONE;
+	}
 
 	stat = i2c_dw_read_clear_intrbits(dev);
 
-- 
1.9.1

