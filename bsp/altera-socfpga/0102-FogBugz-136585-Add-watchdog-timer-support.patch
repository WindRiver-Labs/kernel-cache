From ba843dddfba4909fda20635f46100eb340f2889f Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Tue, 9 Jul 2013 17:42:42 -0500
Subject: [PATCH 102/248] FogBugz #136585: Add watchdog timer support

Enable device tree support in the Synopsys DW watchdog timer driver.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>

v2:
- Use of_match_ptr() so that the module does not depend on OF
- Enable watchdog support in the defconfig
---
 Documentation/devicetree/bindings/watchdog/dw_wdt.txt |  9 +++++++++
 arch/arm/boot/dts/socfpga.dtsi                        | 16 ++++++++++++++++
 arch/arm/boot/dts/socfpga_cyclone5.dtsi               |  4 ++++
 arch/arm/boot/dts/socfpga_ice.dts                     |  4 ++++
 arch/arm/boot/dts/socfpga_vt.dts                      |  4 ++++
 arch/arm/configs/socfpga_defconfig                    |  2 ++
 drivers/watchdog/dw_wdt.c                             |  1 +
 7 files changed, 40 insertions(+)

diff --git a/Documentation/devicetree/bindings/watchdog/dw_wdt.txt b/Documentation/devicetree/bindings/watchdog/dw_wdt.txt
index 08e16f6..baa8faf 100644
--- a/Documentation/devicetree/bindings/watchdog/dw_wdt.txt
+++ b/Documentation/devicetree/bindings/watchdog/dw_wdt.txt
@@ -2,6 +2,7 @@ Synopsys Designware Watchdog Timer
 
 Required Properties:
 
+<<<<<<< HEAD
 - compatible	: Should contain "snps,dw-wdt"
 - reg		: Base address and size of the watchdog timer registers.
 - clocks	: phandle + clock-specifier for the clock that drives the
@@ -10,6 +11,10 @@ Required Properties:
 Optional Properties:
 
 - interrupts	: The interrupt used for the watchdog timeout warning.
+=======
+- Compatiblity	: "snps,dw-wdt"
+- reg		: Base address of the watchdog timer register.
+>>>>>>> FogBugz #136585: Add watchdog timer support
 
 Example:
 
@@ -18,4 +23,8 @@ Example:
 		reg = <0xffd02000 0x1000>;
 		interrupts = <0 171 4>;
 		clocks = <&per_base_clk>;
+<<<<<<< HEAD
+=======
+		status = "okay";
+>>>>>>> FogBugz #136585: Add watchdog timer support
 	};
diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index a4b6df6..3e258fe 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -744,5 +744,21 @@
 				512 512 512 512 512 512 512 512 512>;
 			status = "disabled";
 		};
+
+		watchdog0: wd@ffd02000 {
+			compatible = "snps,dw-wdt";
+			reg = <0xffd02000 0x1000>;
+			interrupts = <0 171 4>;
+			clocks = <&per_base_clk>;
+			status = "disabled";
+		};
+
+		watchdog1: wd@ffd03000 {
+			compatible = "snps,dw-wdt";
+			reg = <0xffd03000 0x1000>;
+			interrupts = <0 172 4>;
+			clocks = <&per_base_clk>;
+			status = "disabled";
+		};
 	};
 };
diff --git a/arch/arm/boot/dts/socfpga_cyclone5.dtsi b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
index db1bfc9..6d90c62 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5.dtsi
+++ b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
@@ -146,6 +146,10 @@
 			status = "okay";
 		};
 
+		watchdog0: wd@ffd02000 {
+			status = "okay";
+		};
+
 		leds {
 			compatible = "gpio-leds";
 			hps0 {
diff --git a/arch/arm/boot/dts/socfpga_ice.dts b/arch/arm/boot/dts/socfpga_ice.dts
index 5b6cebe..34215921 100644
--- a/arch/arm/boot/dts/socfpga_ice.dts
+++ b/arch/arm/boot/dts/socfpga_ice.dts
@@ -129,5 +129,9 @@
 		serial1@ffc03000 {
 			clock-frequency = <77161>;
 		};
+
+		watchdog0: wd@ffd02000 {
+			status = "okay";
+		};
 	};
 };
diff --git a/arch/arm/boot/dts/socfpga_vt.dts b/arch/arm/boot/dts/socfpga_vt.dts
index 53684fc..827f79b 100644
--- a/arch/arm/boot/dts/socfpga_vt.dts
+++ b/arch/arm/boot/dts/socfpga_vt.dts
@@ -148,6 +148,10 @@
 			cpu1-start-addr = <0xffd08010>;
 		};
 
+		watchdog0: wd@ffd02000 {
+			status = "okay";
+		};
+
 		usb0: usb@ffb00000 {
 			ulpi-ddr = <0>;
 			status = "okay";
diff --git a/arch/arm/configs/socfpga_defconfig b/arch/arm/configs/socfpga_defconfig
index 42676d2..44d4d87 100644
--- a/arch/arm/configs/socfpga_defconfig
+++ b/arch/arm/configs/socfpga_defconfig
@@ -95,6 +95,8 @@ CONFIG_GPIO_SYSFS=y
 CONFIG_GPIO_DW=y
 CONFIG_GPIO_ALTERA=m
 # CONFIG_RTC_HCTOSYS is not set
+CONFIG_WATCHDOG=y
+CONFIG_DW_WATCHDOG=y
 CONFIG_EXT2_FS=y
 CONFIG_EXT2_FS_XATTR=y
 CONFIG_EXT2_FS_POSIX_ACL=y
diff --git a/drivers/watchdog/dw_wdt.c b/drivers/watchdog/dw_wdt.c
index ee4f86b..fabb4b0 100644
--- a/drivers/watchdog/dw_wdt.c
+++ b/drivers/watchdog/dw_wdt.c
@@ -31,6 +31,7 @@
 #include <linux/moduleparam.h>
 #include <linux/of.h>
 #include <linux/pm.h>
+#include <linux/of.h>
 #include <linux/platform_device.h>
 #include <linux/spinlock.h>
 #include <linux/timer.h>
-- 
1.9.1

