From da76c8eb560ede117468690d348c6d6b71a5c7d5 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Wed, 14 Aug 2013 10:01:24 -0500
Subject: [PATCH 130/248] FogBugz #152188: Switch to use DWC2 USB driver

Switch to use the latest USB driver from Synopsys, which is currently
in drivers/staging/dwc2. The driver currently only supports Host mode and DMA.

This patch enables the DWC2 driver for host mode and uses the 'old' driver
for peripheral mode.

By default, socfpga_defconfig will support Host mode. To enable Peripheral
mode, rebuild the kernel with CONFIG_USB_DWC_OTG=y.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 arch/arm/boot/dts/socfpga.dtsi     | 18 ++++++++++++------
 arch/arm/configs/socfpga_defconfig |  8 +++++---
 arch/arm/mach-socfpga/Kconfig      |  1 +
 drivers/usb/dwc2/Kconfig           |  1 +
 drivers/usb/dwc2/core.c            |  2 ++
 drivers/usb/dwc2/platform.c        |  1 +
 drivers/usb/otg/dwc/Kconfig        |  4 ++--
 include/linux/usb/dwc_otg.h        |  2 +-
 8 files changed, 25 insertions(+), 12 deletions(-)

diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index 51b6359..14a1e15 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -748,32 +748,38 @@
 		};
 
 		usb0: usb@ffb00000 {
-			compatible = "snps,dwc-otg";
+			compatible = "snps,dwc2";
 			reg = <0xffb00000 0xffff>;
 			interrupts = <0 125 4>;
-			dma-mask = <0xffffffff>;
-			host-rx-fifo-size = <512>;
 			dev-rx-fifo-size = <512>;
 			dev-nperio-tx-fifo-size = <4096>;
 			dev-perio-tx-fifo-size = <512 512 512 512 512 512
 				512 512 512 512 512 512 512 512 512>;
 			dev-tx-fifo-size = <512 512 512 512 512 512
 				512 512 512 512 512 512 512 512 512>;
+			enable-dynamic-fifo = <1>;
+			host-rx-fifo-size = <0xa00>;
+			host-perio-tx-fifo-size = <0xa00>;
+			host-nperio-tx-fifo-size = <0xa00>;
+			dma-desc-enable = <0>;
 			status = "disabled";
 		};
 
 		usb1: usb@ffb40000 {
-			compatible = "snps,dwc-otg";
+			compatible = "snps,dwc2";
 			reg = <0xffb40000 0xffff>;
 			interrupts = <0 128 4>;
-			dma-mask = <0xffffffff>;
-			host-rx-fifo-size = <512>;
 			dev-rx-fifo-size = <512>;
 			dev-nperio-tx-fifo-size = <4096>;
 			dev-perio-tx-fifo-size = <512 512 512 512 512 512
 				512 512 512 512 512 512 512 512 512>;
 			dev-tx-fifo-size = <512 512 512 512 512 512
 				512 512 512 512 512 512 512 512 512>;
+			enable-dynamic-fifo = <1>;
+			host-rx-fifo-size = <0xa00>;
+			host-perio-tx-fifo-size = <0xa00>;
+			host-nperio-tx-fifo-size = <0xa00>;
+			dma-desc-enable = <0>;
 			status = "disabled";
 		};
 
diff --git a/arch/arm/configs/socfpga_defconfig b/arch/arm/configs/socfpga_defconfig
index dab0039..5b8258e 100644
--- a/arch/arm/configs/socfpga_defconfig
+++ b/arch/arm/configs/socfpga_defconfig
@@ -73,14 +73,16 @@ CONFIG_SERIAL_8250_NR_UARTS=2
 CONFIG_SERIAL_8250_RUNTIME_UARTS=2
 CONFIG_SERIAL_8250_DW=y
 CONFIG_USB=y
+CONFIG_USB_ANNOUNCE_NEW_DEVICES=y
 CONFIG_USB_STORAGE=y
 CONFIG_USB_GADGET=y
 # CONFIG_DWC_OTG_MODE is not set
 CONFIG_USB_LIBCOMPOSITE=m
 CONFIG_USB_MASS_STORAGE=m
-CONFIG_DWC_HOST_ONLY=y
-CONFIG_USB_DWC_OTG=y
-CONFIG_DWC_SLAVE=y
+# CONFIG_USB_DWC_OTG is not set
+# CONFIG_DWC_HOST_ONLY is not set
+CONFIG_STAGING=y
+CONFIG_USB_DWC2=y
 CONFIG_MMC=y
 CONFIG_MMC_DW=y
 CONFIG_MMC_DW_IDMAC=y
diff --git a/arch/arm/mach-socfpga/Kconfig b/arch/arm/mach-socfpga/Kconfig
index 56ae9bd..b053dab 100644
--- a/arch/arm/mach-socfpga/Kconfig
+++ b/arch/arm/mach-socfpga/Kconfig
@@ -24,3 +24,4 @@ config ARCH_SOCFPGA
 	select PL310_ERRATA_727915
 	select PL310_ERRATA_753970
 	select PL310_ERRATA_769419
+	select VIRT_TO_BUS
diff --git a/drivers/usb/dwc2/Kconfig b/drivers/usb/dwc2/Kconfig
index be947d6..4bc6f2e 100644
--- a/drivers/usb/dwc2/Kconfig
+++ b/drivers/usb/dwc2/Kconfig
@@ -1,6 +1,7 @@
 config USB_DWC2
 	tristate "DesignWare USB2 DRD Core Support"
 	depends on USB
+	depends on !USB_DWC_OTG
 	help
 	  Say Y or M here if your system has a Dual Role HighSpeed
 	  USB controller based on the DesignWare HSOTG IP Core.
diff --git a/drivers/usb/dwc2/core.c b/drivers/usb/dwc2/core.c
index 1d12988..5bee748 100644
--- a/drivers/usb/dwc2/core.c
+++ b/drivers/usb/dwc2/core.c
@@ -2624,10 +2624,12 @@ int dwc2_get_hwparams(struct dwc2_hsotg *hsotg)
 
 	hptxfsiz = readl(hsotg->regs + HPTXFSIZ);
 	dev_dbg(hsotg->dev, "hptxfsiz=%08x\n", hptxfsiz);
+/*
 	gusbcfg = readl(hsotg->regs + GUSBCFG);
 	gusbcfg &= ~GUSBCFG_FORCEHOSTMODE;
 	writel(gusbcfg, hsotg->regs + GUSBCFG);
 	usleep_range(100000, 150000);
+*/
 
 	/* hwcfg2 */
 	hw->op_mode = (hwcfg2 & GHWCFG2_OP_MODE_MASK) >>
diff --git a/drivers/usb/dwc2/platform.c b/drivers/usb/dwc2/platform.c
index eaba547..5ab63b1 100644
--- a/drivers/usb/dwc2/platform.c
+++ b/drivers/usb/dwc2/platform.c
@@ -40,6 +40,7 @@
 #include <linux/device.h>
 #include <linux/dma-mapping.h>
 #include <linux/of_device.h>
+#include <linux/of_platform.h>
 #include <linux/platform_device.h>
 
 #include "core.h"
diff --git a/drivers/usb/otg/dwc/Kconfig b/drivers/usb/otg/dwc/Kconfig
index c5d71d0..8a2ec64 100644
--- a/drivers/usb/otg/dwc/Kconfig
+++ b/drivers/usb/otg/dwc/Kconfig
@@ -27,7 +27,7 @@ config DWC_DEBUG
 choice
 	prompt "DWC Mode Selection"
 	depends on USB_DWC_OTG
-	default DWC_HOST_ONLY
+	default DWC_DEVICE_ONLY
 	help
 	  Select the DWC Core in OTG, Host only, or Device only mode.
 
@@ -55,7 +55,7 @@ config USB_GADGET_DWC_HDRC
 choice
 	prompt "DWC DMA/SlaveMode Selection"
 	depends on USB_DWC_OTG
-	default DWC_DMA_MODE
+	default DWC_SLAVE
 	help
 	  Select the DWC DMA or Slave Mode.
 	  DMA mode uses the DWC core internal DMA engines.
diff --git a/include/linux/usb/dwc_otg.h b/include/linux/usb/dwc_otg.h
index d47da9b..15e114b 100644
--- a/include/linux/usb/dwc_otg.h
+++ b/include/linux/usb/dwc_otg.h
@@ -3,7 +3,7 @@
 
 #include <linux/platform_device.h>
 
-#define DWC_OTG_OF_COMPATIBLE	"snps,dwc-otg"
+#define DWC_OTG_OF_COMPATIBLE	"snps,dwc2"
 
 extern u64 dwc_otg_dmamask;
 
-- 
1.9.1

