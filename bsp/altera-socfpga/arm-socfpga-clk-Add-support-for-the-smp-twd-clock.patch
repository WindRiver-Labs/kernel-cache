From ba38d3cf87f71465c5dc89fdb7f9c8b62305185f Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Tue, 13 Nov 2012 08:26:40 -0600
Subject: [PATCH 168/254] arm: socfpga: clk: Add support for the smp-twd clock

Upstream: git://git.rocketboards.org/linux-socfpga.git

For SMP to work correctly, we need to register the smp-twd clock.

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
(cherry picked from commit 64aa24c9a2cdf126722d0213038ee9d77d9ffc96)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-socfpga/socfpga.c |    5 ++++-
 drivers/clk/socfpga/clk.c       |    3 +++
 2 files changed, 7 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 7df82be..19b1c6a 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -24,6 +24,7 @@
 #include <asm/hardware/gic.h>
 #include <asm/mach/arch.h>
 #include <asm/mach/map.h>
+#include <asm/smp_twd.h>
 
 #include "core.h"
 
@@ -131,6 +132,9 @@ static void __init gic_init_irq(void)
 		init_socfpga_vt();
 	else
 		init_socfpga();
+
+	socfpga_init_clocks();
+	twd_local_timer_of_register();
 }
 
 static void socfpga_cyclone5_restart(char mode, const char *cmd)
@@ -146,7 +150,6 @@ static void __init socfpga_cyclone5_init(void)
 	of_platform_populate(NULL, of_default_bus_match_table,
 		socfpga_auxdata_lookup, NULL);
 
-	socfpga_init_clocks();
 	enable_periphs();
 }
 
diff --git a/drivers/clk/socfpga/clk.c b/drivers/clk/socfpga/clk.c
index d496f45..f35079c 100644
--- a/drivers/clk/socfpga/clk.c
+++ b/drivers/clk/socfpga/clk.c
@@ -82,6 +82,9 @@ void __init socfpga_init_clocks(void)
 	clk = clk_register_fixed_rate(NULL, "dbg_base_clk", NULL, CLK_IS_ROOT, SOCFPGA_MPU_CLK/2);
 	clk_register_clkdev(clk, "dbg_base_clk", NULL);
 
+	clk = clk_register_fixed_rate(NULL, "smp_twd", NULL, CLK_IS_ROOT, SOCFPGA_MPU_CLK/2);
+	clk_register_clkdev(clk, NULL, "smp_twd");
+
 	clk = clk_register_fixed_rate(NULL, "main_qspi_clk", NULL, CLK_IS_ROOT, SOCFPGA_MAIN_QSPI_CLK);
 	clk_register_clkdev(clk, "main_qspi_clk", NULL);
 
-- 
1.7.5.4

