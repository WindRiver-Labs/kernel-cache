From 812f816bb3dbe314d4d67a4a6af4557f2b12b611 Mon Sep 17 00:00:00 2001
From: Yang Wei <Wei.Yang@windriver.com>
Date: Thu, 22 May 2014 17:12:06 +0800
Subject: [PATCH 6/6] pci/altera: add PCIE bus scan function

Add a bus scan function for socfpga platform and remove ops from hw_pci.
Additionally, we also provide kernel option for Altera PCIE.

Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 arch/arm/mach-socfpga/Kconfig |    8 ++++++++
 drivers/pci/host/pci-altera.c |    9 ++++++++-
 2 files changed, 16 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-socfpga/Kconfig b/arch/arm/mach-socfpga/Kconfig
index f15f95f..e2c2e30 100644
--- a/arch/arm/mach-socfpga/Kconfig
+++ b/arch/arm/mach-socfpga/Kconfig
@@ -26,6 +26,14 @@ config ARCH_SOCFPGA
 	select PL310_ERRATA_753970 if PL310
 	select PL310_ERRATA_769419
 
+config ALTERA_PCIE_RP
+        bool "Altera PCIe Root Port Driver"
+	select PCI
+	select PCIEPORTBUS
+	depends on ARCH_SOCFPGA
+	help
+	  The Altera PCI Express Root Port driver.
+
 config FPGADMA
 	tristate "FPGA DMA FIFO driver"
 	depends on DMA_ENGINE
diff --git a/drivers/pci/host/pci-altera.c b/drivers/pci/host/pci-altera.c
index 0039e37..1202a29 100644
--- a/drivers/pci/host/pci-altera.c
+++ b/drivers/pci/host/pci-altera.c
@@ -383,13 +383,20 @@ static int altera_pcie_map_irq(const struct pci_dev *pdev, u8 slot, u8 pin)
 	return pcie->hwirq;
 }
 
+/* hw_pci scan */
+static struct pci_bus *altera_pcie_scan_bus(int nr, struct pci_sys_data *sys)
+{
+	return pci_scan_root_bus(
+		NULL, 0, &altera_pcie_ops, sys, &sys->resources);
+}
+
 /* hw_pci */
 static struct hw_pci altera_pcie_hw __initdata = {
 #ifdef CONFIG_PCI_DOMAINS
 	.domain			= 0,
 #endif
+	.scan			= altera_pcie_scan_bus,
 	.nr_controllers		= 1,
-	.ops			= &altera_pcie_ops,
 	.setup			= altera_pcie_setup,
 	.map_irq		= altera_pcie_map_irq,
 };
-- 
1.7.5.4

