From e08e5ee2c3c99229c5620ce10a97eade6c3babd8 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Wed, 10 Oct 2012 12:51:26 -0500
Subject: [PATCH 001/248] mmc: dw_mmc: Enable device tree for dw-mmc driver

Enable the dw-mmc driver to be device tree capable.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 drivers/mmc/host/dw_mmc-pltfm.c |  1 +
 drivers/mmc/host/dw_mmc.c       | 30 ++++++++++++++++++++++++++++++
 2 files changed, 31 insertions(+)

diff --git a/drivers/mmc/host/dw_mmc-pltfm.c b/drivers/mmc/host/dw_mmc-pltfm.c
index 5c49656..8ed9d41 100644
--- a/drivers/mmc/host/dw_mmc-pltfm.c
+++ b/drivers/mmc/host/dw_mmc-pltfm.c
@@ -125,6 +125,7 @@ static struct platform_driver dw_mci_pltfm_driver = {
 		.name		= "dw_mmc",
 		.of_match_table	= of_match_ptr(dw_mci_pltfm_match),
 		.pm		= &dw_mci_pltfm_pmops,
+		.of_match_table = dw_mci_of_match,
 	},
 };
 
diff --git a/drivers/mmc/host/dw_mmc.c b/drivers/mmc/host/dw_mmc.c
index 55cd110..3f0f20a 100644
--- a/drivers/mmc/host/dw_mmc.c
+++ b/drivers/mmc/host/dw_mmc.c
@@ -2442,6 +2442,36 @@ int dw_mci_probe(struct dw_mci *host)
 		}
 	}
 
+#ifdef CONFIG_OF
+	if (of_property_read_u32(host->dev.of_node, "bus-hz", &prop)) {
+		dev_err(&host->dev, "couldn't determine bus-hz\n");
+		return -ENODEV;
+	}
+	host->pdata->bus_hz = prop;
+
+	if (of_property_read_u32(host->dev.of_node, "num-slots", &prop)) {
+		dev_err(&host->dev, "couldn't determine num-slots\n");
+		return -ENODEV;
+	}
+	host->pdata->num_slots = prop;
+
+	/* Optional parameter. */
+	if (!of_property_read_u32(host->dev.of_node, "fifo-depth", &prop)) {
+		host->pdata->fifo_depth = prop;
+	}
+
+	if (of_property_read_u32(host->dev.of_node, "bus-width", &prop)) {
+		dev_err(&host->dev, "couldn't determine bus-width\n");
+		return -ENODEV;
+	}
+
+	if (prop == 8)
+		host->pdata->caps |= (MMC_CAP_4_BIT_DATA |
+					MMC_CAP_8_BIT_DATA);
+	else if (prop == 4)
+		host->pdata->caps |= MMC_CAP_4_BIT_DATA;
+#endif
+
 	if (!host->pdata->select_slot && host->pdata->num_slots > 1) {
 		dev_err(host->dev,
 			"Platform data must supply select_slot function\n");
-- 
1.9.1

