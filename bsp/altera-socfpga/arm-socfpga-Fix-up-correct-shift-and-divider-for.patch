From f9e90987ada857ba1ad3cae5e9c2241bb8028af9 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Thu, 28 Mar 2013 16:08:24 -0500
Subject: [PATCH 212/254] arm: socfpga: Fix up correct shift and divider for

Upstream: git://git.rocketboards.org/linux-socfpga.git
 PLL clocks.

The PLL clock values were been incorrectly divided, and the
denominator shift was wrong.

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
(cherry picked from commit d2f36a8f8b08d8603adbd0db2189df43af87f3b7)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/clk/socfpga/clk.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/clk/socfpga/clk.c b/drivers/clk/socfpga/clk.c
index 648debb..e193431 100644
--- a/drivers/clk/socfpga/clk.c
+++ b/drivers/clk/socfpga/clk.c
@@ -55,7 +55,7 @@
 #define SOCFPGA_PLL_DIVF_MASK 0x0000FFF8
 #define SOCFPGA_PLL_DIVF_SHIFT 3
 #define SOCFPGA_PLL_DIVQ_MASK 0x003F0000
-#define SOCFPGA_PLL_DIVQ_SHIFT 15
+#define SOCFPGA_PLL_DIVQ_SHIFT 16
 
 extern void __iomem *clk_mgr_base_addr;
 
@@ -104,7 +104,7 @@ static unsigned long clk_pll_recalc_rate(struct clk_hw *hwclk,
 	divf = (reg & SOCFPGA_PLL_DIVF_MASK) >> SOCFPGA_PLL_DIVF_SHIFT;
 	divq = (reg & SOCFPGA_PLL_DIVQ_MASK) >> SOCFPGA_PLL_DIVQ_SHIFT;
 	vco_freq = parent_rate * (divf + 1);
-	return vco_freq / (1 << divq);
+	return vco_freq / (1 + divq);
 }
 
 
-- 
1.7.5.4

