From 1bdf27e716a7733069d8670d7bc429a9755e1617 Mon Sep 17 00:00:00 2001
From: Ley Foon Tan <lftan@altera.com>
Date: Thu, 14 Mar 2013 15:22:44 +0800
Subject: [PATCH 204/254] arm: socfpga: Use framework in drivers/base/soc.c

Upstream: git://git.rocketboards.org/linux-socfpga.git
 for system id

Open source committees recommend to use existing
framework in drivers/base/soc.c for system
properties like system id (soc_id).
See more detail in Documentation/ABI/testing/sysfs-devices-soc.

Usage:
cat /sys/devices/soc0/soc_id
cat /sys/devices/soc0/family
cat /sys/devices/soc0/machine
cat /sys/devices/soc0/revision

Signed-off-by: Ley Foon Tan <lftan@altera.com>
(cherry picked from commit 46c7ce960c1ea706a13d94ec4abcc30a10ef19b9)

Conflicts:
	arch/arm/mach-socfpga/Kconfig
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/Kconfig                |    1 +
 arch/arm/mach-socfpga/core.h    |    6 ++++
 arch/arm/mach-socfpga/socfpga.c |   62 +++++++++++++++++++++++++++++++++++----
 3 files changed, 63 insertions(+), 6 deletions(-)

diff --git a/arch/arm/Kconfig b/arch/arm/Kconfig
index 2d42f14..130c80e 100644
--- a/arch/arm/Kconfig
+++ b/arch/arm/Kconfig
@@ -295,6 +295,7 @@ config ARCH_SOCFPGA
 	select MIGHT_HAVE_CACHE_L2X0
 	select SPARSE_IRQ
 	select USE_OF
+	select SOC_BUS
 	help
 	  This enables support for Altera SOCFPGA Cyclone V platform
 
diff --git a/arch/arm/mach-socfpga/core.h b/arch/arm/mach-socfpga/core.h
index 5b2b91a..20e2a1a 100644
--- a/arch/arm/mach-socfpga/core.h
+++ b/arch/arm/mach-socfpga/core.h
@@ -20,6 +20,12 @@
 #ifndef __MACH_CORE_H
 #define __MACH_CORE_H
 
+#define SOCFPGA_SYSID_DEFAULT		0x1
+#define SOCFPGA_REVISION_DEFAULT	0x1
+
+/* Sysid register map */
+#define SYSID_ID_REG			0x0
+
 #define SOCFPGA_RSTMGR_CTRL	0x04
 #define SOCFPGA_RSTMGR_MODPERRST	0x14
 #define SOCFPGA_RSTMGR_BRGMODRST	0x1c
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 1150089..a6b8880 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -23,6 +23,7 @@
 #include <linux/stmmac.h>
 #include <linux/phy.h>
 #include <linux/micrel_phy.h>
+#include <linux/sys_soc.h>
 
 #include <asm/hardware/cache-l2x0.h>
 #include <asm/hardware/gic.h>
@@ -74,12 +75,59 @@ static struct map_desc scu_io_desc __initdata = {
 	.type		= MT_DEVICE,
 };
 
-static struct map_desc uart_io_desc __initdata = {
-	.virtual	= 0xfec02000,
-	.pfn		= __phys_to_pfn(0xffc02000),
-	.length		= SZ_8K,
-	.type		= MT_DEVICE,
-};
+static void __init socfpga_soc_device_init(void)
+{
+	struct device_node *root;
+	struct device_node *sysid_node;
+	struct soc_device *soc_dev;
+	struct soc_device_attribute *soc_dev_attr;
+	void __iomem *sysid_base;
+	const char *machine;
+	u32 id = SOCFPGA_SYSID_DEFAULT;
+	int err;
+
+	root = of_find_node_by_path("/");
+	if (!root)
+		return;
+
+	err = of_property_read_string(root, "model", &machine);
+	if (err)
+		return;
+
+	soc_dev_attr = kzalloc(sizeof(*soc_dev_attr), GFP_KERNEL);
+	if (!soc_dev_attr)
+		return;
+
+	sysid_node = of_find_compatible_node(root, NULL, "ALTR,sysid-1.0");
+	if (sysid_node) {
+		sysid_base = of_iomap(sysid_node, 0);
+		if (sysid_base) {
+			/* Use id from Sysid hardware. */
+			id = readl(sysid_base + SYSID_ID_REG);
+			iounmap(sysid_base);
+		}
+		of_node_put(sysid_node);
+	}
+
+	of_node_put(root);
+
+	soc_dev_attr->soc_id = kasprintf(GFP_KERNEL, "%u", id);
+	soc_dev_attr->revision = kasprintf(GFP_KERNEL, "%d",
+		SOCFPGA_REVISION_DEFAULT);
+	soc_dev_attr->machine = kasprintf(GFP_KERNEL, "%s", machine);
+	soc_dev_attr->family = "SOCFPGA";
+
+	soc_dev = soc_device_register(soc_dev_attr);
+	if (IS_ERR_OR_NULL(soc_dev)) {
+		kfree(soc_dev_attr->soc_id);
+		kfree(soc_dev_attr->machine);
+		kfree(soc_dev_attr->revision);
+		kfree(soc_dev_attr);
+		return;
+	}
+
+	return;
+}
 
 static void __init socfpga_scu_map_io(void)
 {
@@ -284,6 +332,8 @@ static void __init socfpga_cyclone5_init(void)
 		socfpga_auxdata_lookup, NULL);
 
 	enable_periphs();
+
+	socfpga_soc_device_init();
 }
 
 static const char *altera_dt_match[] = {
-- 
1.7.5.4

