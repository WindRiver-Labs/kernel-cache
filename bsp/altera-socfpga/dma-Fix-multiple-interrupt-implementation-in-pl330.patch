From ec9473a9e13dc46e6688e90d28f9ffa36824c134 Mon Sep 17 00:00:00 2001
From: Graham Moore <grmoore@altera.com>
Date: Fri, 24 Jan 2014 01:38:16 -0600
Subject: [PATCH 08/10] dma: Fix multiple interrupt implementation in pl330

commit f5906db147fa4ff543c316dd84114588bfb43ddb
git://git.rocketboards.org/linux-socfpga.git socfpga-3.13 branch

Modify device tree for multiple interrupt parameters.
Add DMA files which combine multiple DMA irqs into one.
Add platform data structure.
Modify pl330 driver, less intrusive modifications for multiple IRQs.
Remove AMBA_NR_IRQS modification.
Document devicetree bindings.

Signed-off-by: Graham Moore <grmoore@altera.com>

Conflicts:

	drivers/dma/pl330.c
	include/linux/amba/bus.h
[Just a minior modification to rebase to current context]
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/dma/pl330.c      |   30 +++++++++++++++++++++++++-----
 include/linux/amba/bus.h |    4 ++++
 2 files changed, 29 insertions(+), 5 deletions(-)

diff --git a/drivers/dma/pl330.c b/drivers/dma/pl330.c
index 1da7589..ee2b70f 100755
--- a/drivers/dma/pl330.c
+++ b/drivers/dma/pl330.c
@@ -2874,10 +2874,20 @@ pl330_probe(struct amba_device *adev, const struct amba_id *id)
 
 	amba_set_drvdata(adev, pdmac);
 
+	for (i = 0; i < AMBA_NR_IRQS; i++) {
+		irq = adev->irq[i];
+		if (irq == 0)
+			break;
+		ret = request_irq(irq, pl330_irq_handler, 0,
+				dev_name(&adev->dev), pi);
+		if (ret)
+			goto probe_err3;
+	}
+
 	if (pdat && pdat->init) {
 		ret = pdat->init(adev);
 		if (ret)
-			goto probe_err2;
+			goto probe_err3;
 	}
 
 	irq = adev->irq[0];
@@ -2972,7 +2982,12 @@ pl330_probe(struct amba_device *adev, const struct amba_id *id)
 probe_err4:
 	pl330_del(pi);
 probe_err3:
-	free_irq(irq, pi);
+	for (i = 0; i < AMBA_NR_IRQS; i++) {
+		irq = adev->irq[i];
+		if (irq == 0)
+			break;
+		free_irq(irq, pi);
+	}
 probe_err2:
 	iounmap(pi->base);
 probe_err1:
@@ -2990,6 +3005,7 @@ static int __devexit pl330_remove(struct amba_device *adev)
 	struct pl330_info *pi;
 	struct resource *res;
 	int irq;
+	int i;
 
 	if (!pdmac)
 		return 0;
@@ -3012,9 +3028,13 @@ static int __devexit pl330_remove(struct amba_device *adev)
 
 	pl330_del(pi);
 
-	irq = adev->irq[0];
-	free_irq(irq, pi);
-
+	for (i = 0; i < AMBA_NR_IRQS; i++) {
+		irq = adev->irq[i];
+		if (irq == 0)
+			break;
+		free_irq(irq, pi);
+	}
+ 
 	iounmap(pi->base);
 
 	res = &adev->res;
diff --git a/include/linux/amba/bus.h b/include/linux/amba/bus.h
index 8d54f79..2e520a1 100644
--- a/include/linux/amba/bus.h
+++ b/include/linux/amba/bus.h
@@ -21,7 +21,11 @@
 #include <linux/resource.h>
 #include <linux/regulator/consumer.h>
 
+#ifdef CONFIG_ARCH_SOCFPGA
+#define AMBA_NR_IRQS	8
+#else
 #define AMBA_NR_IRQS	2
+#endif
 #define AMBA_CID	0xb105f00d
 
 struct clk;
-- 
1.7.5.4

