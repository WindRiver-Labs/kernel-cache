From 1b0efd75bff03606cbd84930ef7601a56155e78e Mon Sep 17 00:00:00 2001
From: Yang Wei <Wei.Yang@windriver.com>
Date: Thu, 22 May 2014 17:12:06 +0800
Subject: [PATCH 4/7] pci/altera: backport PCIE for 3.4 kernel

3.4 kernel does not provide a default bus scan implementation,
so we have to provide a bus can function for socfpga platform
and remove ops filed of hw_pci structure. Additionally, we also
provde configuration option to decide whether is to enable PCIE or not.

Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 arch/arm/Kconfig              |    8 ++++++++
 drivers/pci/host/pci-altera.c |    8 +++++++-
 2 files changed, 15 insertions(+), 1 deletions(-)

diff --git a/arch/arm/Kconfig b/arch/arm/Kconfig
index d29f240..4bf8088 100644
--- a/arch/arm/Kconfig
+++ b/arch/arm/Kconfig
@@ -306,6 +306,14 @@ config ARCH_SOCFPGA
 	help
 	  This enables support for Altera SOCFPGA Cyclone V platform
 
+config ALTERA_PCIE_RP
+        bool "Altera PCIe Root Port Driver"
+	select PCI
+	select PCIEPORTBUS
+	depends on ARCH_SOCFPGA
+	help
+	  The Altera PCI Express Root Port driver.
+
 config FPGA_SDRAM
 	bool "Enables FPGA SDRAM"
 	depends on ARCH_SOCFPGA
diff --git a/drivers/pci/host/pci-altera.c b/drivers/pci/host/pci-altera.c
index 5fd0cc7..a806267 100644
--- a/drivers/pci/host/pci-altera.c
+++ b/drivers/pci/host/pci-altera.c
@@ -412,13 +412,19 @@ static int altera_pcie_map_irq(const struct pci_dev *pdev, u8 slot, u8 pin)
 	return pcie->hwirq;
 }
 
+/* hw_pci scan */
+static struct pci_bus * altera_pcie_scan_bus(int nr, struct pci_sys_data *sys)
+{
+	return pci_scan_root_bus(NULL, 0, &altera_pcie_ops, sys, &sys->resources);
+}
+
 /* hw_pci */
 static struct hw_pci altera_pcie_hw __initdata = {
 #ifdef CONFIG_PCI_DOMAINS
 	.domain			= 0,
 #endif
+	.scan			= altera_pcie_scan_bus,
 	.nr_controllers		= 1,
-	.ops			= &altera_pcie_ops,
 	.setup			= altera_pcie_setup,
 	.map_irq		= altera_pcie_map_irq,
 };
-- 
1.7.5.4

