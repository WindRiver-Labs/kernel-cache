From e86993ea964c081e8dbacd0c438fa1618c133d3b Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Mon, 17 Jun 2013 13:43:42 +0800
Subject: [PATCH 253/254] arm: socfpga: backport PCIE for 3.4.34 kernel

This patch is to cater for back-porting PCIe support
from 3.9, which has been verified by an IGB PCIe net
work card.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/Kconfig                    |    8 ++++++++
 arch/arm/mach-socfpga/altera_pcie.c |    8 +++++++-
 2 files changed, 15 insertions(+), 1 deletions(-)

diff --git a/arch/arm/Kconfig b/arch/arm/Kconfig
index 1135b48..2de3332 100644
--- a/arch/arm/Kconfig
+++ b/arch/arm/Kconfig
@@ -313,6 +313,14 @@ config FPGA_SDRAM
 	help
 		This enables the SDRAM controller that is connected to the FGPA.
 
+config ALTERA_PCIE_RP
+        bool "Altera PCIe Root Port Driver"
+	select PCI
+	select PCIEPORTBUS
+	depends on ARCH_SOCFPGA
+	help
+	  The Altera PCI Express Root Port driver.
+
 config ARCH_INTEGRATOR
 	bool "ARM Ltd. Integrator family"
 	select ARM_AMBA
diff --git a/arch/arm/mach-socfpga/altera_pcie.c b/arch/arm/mach-socfpga/altera_pcie.c
index 0e09d79..f52bae7 100644
--- a/arch/arm/mach-socfpga/altera_pcie.c
+++ b/arch/arm/mach-socfpga/altera_pcie.c
@@ -392,12 +392,18 @@ static int altrpcierp_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)
 	return altrpcierp_info.hwirq;
 }
 
+/* register pci hw read/write functions */
+struct pci_bus * __init altera_pcie_scan_bus(int nr, struct pci_sys_data *sys)
+{
+	return pci_scan_root_bus(NULL, 0, &altrpcierp_ops, sys, &sys->resources);
+}
+
 /* hw_pci */
 static struct hw_pci altrpcierp_hw __initdata = {
 #ifdef CONFIG_PCI_DOMAINS
 	.domain			= 0,
 #endif
-	.ops			= &altrpcierp_ops,
+	.scan			= altera_pcie_scan_bus,
 	.nr_controllers		= 1,
 	.setup			= altrpcierp_setup,
 	.map_irq		= altrpcierp_map_irq,
-- 
1.7.5.4

