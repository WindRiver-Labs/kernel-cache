From afca14c405d8c4eb2c907b969a2dfa36654c2454 Mon Sep 17 00:00:00 2001
From: Yang Wei <Wei.Yang@windriver.com>
Date: Fri, 25 Apr 2014 13:43:09 +0800
Subject: [PATCH 14/24] arm/dts: Update the USB DTS entry to use the s3c-hsotg
 driver

commit 90f8cbd243b41a04e4285093343fdd4169fe2476
git://git.rocketboards.org/linux-socfpga.git socfpga-3.13 branch

Add a "usb-nop-xceiv" PHY node that is needed to be used with the new
generic PHY driver that is from:

[1790d80: drivers: phy: add generic PHY framework]

Add a clock node for dwc2 usb dts entry, as the s3c-hsotg driver will need
to properly initialize. Remove dts bindings that were used by the old
dwc2 driver.

To enable USB peripheral mode on SOCFPGA, build the kernel with the following
defconfig:

    CONFIG_USB_PHY=y
    CONFIG_NOP_USB_XCEIV=y
    CONFIG_USB_S3C_HSOTG=y
    CONFIG_GENERIC_PHY=y
    CONFIG_CONFIGFS_FS=y

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 arch/arm/boot/dts/socfpga.dtsi         |   26 ++++++++++++++------------
 arch/arm/boot/dts/socfpga_arria5.dts   |    5 ++---
 arch/arm/boot/dts/socfpga_cyclone5.dts |    4 ----
 arch/arm/boot/dts/socfpga_vt.dts       |    4 ----
 include/linux/usb/dwc_otg.h            |    2 +-
 5 files changed, 17 insertions(+), 24 deletions(-)

diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index efb1505..153e498 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -714,16 +714,20 @@
 			reg-io-width = <4>;
 		};
 
+		usbphy0: usbphy@0 {
+			#phy-cells = <0>;
+			compatible = "usb-nop-xceiv";
+			status = "okay";
+		};
+
 		usb0: usb@ffb00000 {
 			compatible = "snps,dwc2";
 			reg = <0xffb00000 0xffff>;
 			interrupts = <0 125 4>;
-			dev-rx-fifo-size = <512>;
-			dev-nperio-tx-fifo-size = <4096>;
-			dev-perio-tx-fifo-size = <512 512 512 512 512 512
-				512 512 512 512 512 512 512 512 512>;
-			dev-tx-fifo-size = <512 512 512 512 512 512
-				512 512 512 512 512 512 512 512 512>;
+			clocks = <&usb_mp_clk>;
+			clock-names = "otg";
+			phys = <&usbphy0>;
+			phy-names = "usb2-phy";
 			enable-dynamic-fifo = <1>;
 			host-rx-fifo-size = <0xa00>;
 			host-perio-tx-fifo-size = <0xa00>;
@@ -735,12 +739,10 @@
 			compatible = "snps,dwc2";
 			reg = <0xffb40000 0xffff>;
 			interrupts = <0 128 4>;
-			dev-rx-fifo-size = <512>;
-			dev-nperio-tx-fifo-size = <4096>;
-			dev-perio-tx-fifo-size = <512 512 512 512 512 512
-				512 512 512 512 512 512 512 512 512>;
-			dev-tx-fifo-size = <512 512 512 512 512 512
-				512 512 512 512 512 512 512 512 512>;
+			clocks = <&usb_mp_clk>;
+			clock-names = "otg";
+			phys = <&usbphy0>;
+			phy-names = "usb2-phy";
 			enable-dynamic-fifo = <1>;
 			host-rx-fifo-size = <0xa00>;
 			host-perio-tx-fifo-size = <0xa00>;
diff --git a/arch/arm/boot/dts/socfpga_arria5.dts b/arch/arm/boot/dts/socfpga_arria5.dts
index 5398818..a243b80 100644
--- a/arch/arm/boot/dts/socfpga_arria5.dts
+++ b/arch/arm/boot/dts/socfpga_arria5.dts
@@ -147,9 +147,8 @@
 			cpu1-start-addr = <0xffd080c4>;
 		};
 
-		usb1: usb@ffb40000 {
-			ulpi-ddr = <0>;
-			status = "okay";
+		usb0: usb@ffb00000 {
+			status = "disabled";
 		};
 
 		leds {
diff --git a/arch/arm/boot/dts/socfpga_cyclone5.dts b/arch/arm/boot/dts/socfpga_cyclone5.dts
index ddcb76b..3d84d1b 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5.dts
+++ b/arch/arm/boot/dts/socfpga_cyclone5.dts
@@ -161,10 +161,6 @@
 			status = "disabled";
 		};
 
-		usb1: usb@ffb40000 {
-			ulpi-ddr = <0>;
-		};
-
 		i2c0: i2c@ffc04000 {
 			speed-mode = <0>;
 		};
diff --git a/arch/arm/boot/dts/socfpga_vt.dts b/arch/arm/boot/dts/socfpga_vt.dts
index d4744ca..05c6dbe 100644
--- a/arch/arm/boot/dts/socfpga_vt.dts
+++ b/arch/arm/boot/dts/socfpga_vt.dts
@@ -161,10 +161,6 @@
 			status = "okay";
 		};
 
-		usb0: usb@ffb00000 {
-			ulpi-ddr = <0>;
-		};
-
 		usb1: usb@ffb40000 {
 			ulpi-ddr = <0>;
 		};
diff --git a/include/linux/usb/dwc_otg.h b/include/linux/usb/dwc_otg.h
index d47da9b..15e114b 100644
--- a/include/linux/usb/dwc_otg.h
+++ b/include/linux/usb/dwc_otg.h
@@ -3,7 +3,7 @@
 
 #include <linux/platform_device.h>
 
-#define DWC_OTG_OF_COMPATIBLE	"snps,dwc-otg"
+#define DWC_OTG_OF_COMPATIBLE	"snps,dwc2"
 
 extern u64 dwc_otg_dmamask;
 
-- 
1.7.5.4

