From b2991de390b8fc3e5eb0ce828ec2baa03a5dc8e7 Mon Sep 17 00:00:00 2001
From: Ley Foon Tan <lftan@altera.com>
Date: Thu, 14 Mar 2013 15:22:44 +0800
Subject: [PATCH 058/248] FogBugz #106327: Use framework in drivers/base/soc.c
 for system id

Open source committees recommend to use existing
framework in drivers/base/soc.c for system
properties like system id (soc_id).
See more detail in Documentation/ABI/testing/sysfs-devices-soc.

Usage:
cat /sys/devices/soc0/soc_id
cat /sys/devices/soc0/family
cat /sys/devices/soc0/machine
cat /sys/devices/soc0/revision

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Ley Foon Tan <lftan@altera.com>
---
 arch/arm/mach-socfpga/Kconfig   |  1 +
 arch/arm/mach-socfpga/core.h    |  6 +++-
 arch/arm/mach-socfpga/socfpga.c | 62 +++++++++++++++++++++++++++++++++++++----
 3 files changed, 62 insertions(+), 7 deletions(-)

diff --git a/arch/arm/mach-socfpga/Kconfig b/arch/arm/mach-socfpga/Kconfig
index 10ff42f..35f33d6 100644
--- a/arch/arm/mach-socfpga/Kconfig
+++ b/arch/arm/mach-socfpga/Kconfig
@@ -16,6 +16,7 @@ config ARCH_SOCFPGA
 	select MIGHT_HAVE_CACHE_L2X0
 	select SPARSE_IRQ
 	select USE_OF
+	select SOC_BUS
 
 config FPGA_SDRAM
 	bool "Enables FPGA SDRAM"
diff --git a/arch/arm/mach-socfpga/core.h b/arch/arm/mach-socfpga/core.h
index ad766d3..1839a30 100644
--- a/arch/arm/mach-socfpga/core.h
+++ b/arch/arm/mach-socfpga/core.h
@@ -29,6 +29,11 @@
 #define RSTMGR_CTRL_SWWARMRSTREQ	0x2	/* Warm Reset */
 
 extern void socfpga_secondary_startup(void);
+#define SOCFPGA_SYSID_DEFAULT		0x1
+#define SOCFPGA_REVISION_DEFAULT	0x1
+
+/* Sysid register map */
+#define SYSID_ID_REG			0x0
 
 #define SOCFPGA_RSTMGR_CTRL	0x04
 #define SOCFPGA_RSTMGR_MODPERRST	0x14
@@ -52,7 +57,6 @@ extern void socfpga_secondary_startup(void);
 
 #define SYSMGR_EMACGRP_CTRL_PHYSEL_MASK 0x00000003
 
-extern void secondary_startup(void);
 extern void __iomem *socfpga_scu_base_addr;
 extern void __iomem *sys_manager_base_addr;
 extern void __iomem *rst_manager_base_addr;
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 25dd5f1..b8e3585 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -24,6 +24,7 @@
 #include <linux/stmmac.h>
 #include <linux/phy.h>
 #include <linux/micrel_phy.h>
+#include <linux/sys_soc.h>
 
 #include <asm/hardware/cache-l2x0.h>
 #include <asm/mach/arch.h>
@@ -75,12 +76,59 @@ static struct map_desc scu_io_desc __initdata = {
 	.type		= MT_DEVICE,
 };
 
-static struct map_desc uart_io_desc __initdata = {
-	.virtual	= 0xfec02000,
-	.pfn		= __phys_to_pfn(0xffc02000),
-	.length		= SZ_8K,
-	.type		= MT_DEVICE,
-};
+static void __init socfpga_soc_device_init(void)
+{
+	struct device_node *root;
+	struct device_node *sysid_node;
+	struct soc_device *soc_dev;
+	struct soc_device_attribute *soc_dev_attr;
+	void __iomem *sysid_base;
+	const char *machine;
+	u32 id = SOCFPGA_SYSID_DEFAULT;
+	int err;
+
+	root = of_find_node_by_path("/");
+	if (!root)
+		return;
+
+	err = of_property_read_string(root, "model", &machine);
+	if (err)
+		return;
+
+	soc_dev_attr = kzalloc(sizeof(*soc_dev_attr), GFP_KERNEL);
+	if (!soc_dev_attr)
+		return;
+
+	sysid_node = of_find_compatible_node(root, NULL, "ALTR,sysid-1.0");
+	if (sysid_node) {
+		sysid_base = of_iomap(sysid_node, 0);
+		if (sysid_base) {
+			/* Use id from Sysid hardware. */
+			id = readl(sysid_base + SYSID_ID_REG);
+			iounmap(sysid_base);
+		}
+		of_node_put(sysid_node);
+	}
+
+	of_node_put(root);
+
+	soc_dev_attr->soc_id = kasprintf(GFP_KERNEL, "%u", id);
+	soc_dev_attr->revision = kasprintf(GFP_KERNEL, "%d",
+		SOCFPGA_REVISION_DEFAULT);
+	soc_dev_attr->machine = kasprintf(GFP_KERNEL, "%s", machine);
+	soc_dev_attr->family = "SOCFPGA";
+
+	soc_dev = soc_device_register(soc_dev_attr);
+	if (IS_ERR_OR_NULL(soc_dev)) {
+		kfree(soc_dev_attr->soc_id);
+		kfree(soc_dev_attr->machine);
+		kfree(soc_dev_attr->revision);
+		kfree(soc_dev_attr);
+		return;
+	}
+
+	return;
+}
 
 static void __init socfpga_scu_map_io(void)
 {
@@ -288,6 +336,8 @@ static void __init socfpga_cyclone5_init(void)
 		socfpga_auxdata_lookup, NULL);
 	socfpga_init_clocks();
 	enable_periphs();
+
+	socfpga_soc_device_init();
 }
 
 static const char *altera_dt_match[] = {
-- 
1.9.1

