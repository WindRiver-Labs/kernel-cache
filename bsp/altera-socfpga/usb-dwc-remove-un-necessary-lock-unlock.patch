From d47b852dad2f689043206d07eb50431d8dba95a6 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Tue, 18 Jun 2013 15:55:05 +0800
Subject: [PATCH 254/254] usb: dwc: remove un-necessary lock/unlock

Too much lock/unlock dwc_hcd->lock is not necessary, we just
pass the flags to do_set_port_feature, and only unlock/lock
when needs.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/usb/otg/dwc/hcd.c |   11 ++---------
 1 files changed, 2 insertions(+), 9 deletions(-)

diff --git a/drivers/usb/otg/dwc/hcd.c b/drivers/usb/otg/dwc/hcd.c
index 0d5a3eb..3b70c68 100644
--- a/drivers/usb/otg/dwc/hcd.c
+++ b/drivers/usb/otg/dwc/hcd.c
@@ -987,16 +987,13 @@ static int do_clear_port_feature(struct dwc_hcd *hcd, u16 val)
 }
 
 /* Handles the hub class-specific SetPortFeature request.*/
-static int do_set_port_feature(struct usb_hcd *hcd, u16 val, u16 index)
+static int do_set_port_feature(struct usb_hcd *hcd, u16 val, u16 index, unsigned long flags)
 {
 	struct core_if *core_if = hcd_to_dwc_otg_hcd(hcd)->core_if;
 	u32 hprt0 = 0;
 	struct dwc_hcd *dwc_hcd = hcd_to_dwc_otg_hcd(hcd);
-	unsigned long flags;
 	u32 pcgcctl = 0;
 
-	spin_lock_irqsave(&dwc_hcd->lock, flags);
-
 	switch (val) {
 	case USB_PORT_FEAT_SUSPEND:
 		if (hcd->self.otg_port == index && hcd->self.b_hnp_enable) {
@@ -1054,10 +1051,8 @@ static int do_set_port_feature(struct usb_hcd *hcd, u16 val, u16 index)
 		pr_err("DWC OTG HCD - "
 		       "SetPortFeature request %xh "
 		       "unknown or unsupported\n", val);
-		spin_unlock_irqrestore(&dwc_hcd->lock, flags);
 		return -EINVAL;
 	}
-	spin_unlock_irqrestore(&dwc_hcd->lock, flags);
 	return 0;
 }
 
@@ -1179,9 +1174,7 @@ static int dwc_otg_hcd_hub_control(struct usb_hcd *hcd, u16 req_type, u16 val,
 			 */
 			break;
 		}
-		spin_unlock_irqrestore(&dwc_hcd->lock, flags);
-		retval = do_set_port_feature(hcd, val, index);
-		spin_lock_irqsave(&dwc_hcd->lock, flags);
+		retval = do_set_port_feature(hcd, val, index, flags);
 		break;
 	default:
 error:
-- 
1.7.5.4

