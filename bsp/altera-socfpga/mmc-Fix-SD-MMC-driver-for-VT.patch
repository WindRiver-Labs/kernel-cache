From a0ec499e4aee98a8fa107eed6be494d4585814e4 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Wed, 13 Feb 2013 18:21:25 -0600
Subject: [PATCH 193/254] mmc: Fix SD/MMC driver for VT

Upstream: git://git.rocketboards.org/linux-socfpga.git

For VT, need to enable the PWREN bit to enable power to the card.
Add device tree entries to determine which platform needs PWREN
bit.

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
(cherry picked from commit eafab529c5575005aa838a6b42aa1ac6779dfd5c)
(cherry picked from commit e421e843abd1c545b9b5a4ddb86754bd2eef09cb)

Conflicts:
	include/linux/mmc/dw_mmc.h
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 .../devicetree/bindings/mmc/synposis-dw-mshc.txt   |    2 ++
 arch/arm/boot/dts/socfpga_vt.dts                   |    4 ++++
 drivers/mmc/host/dw_mmc.c                          |    8 ++++++++
 include/linux/mmc/dw_mmc.h                         |    6 +++++-
 4 files changed, 19 insertions(+), 1 deletions(-)

diff --git a/Documentation/devicetree/bindings/mmc/synposis-dw-mshc.txt b/Documentation/devicetree/bindings/mmc/synposis-dw-mshc.txt
index 06cd32d08..51c17e3 100644
--- a/Documentation/devicetree/bindings/mmc/synposis-dw-mshc.txt
+++ b/Documentation/devicetree/bindings/mmc/synposis-dw-mshc.txt
@@ -47,6 +47,8 @@ Optional properties:
 
 * broken-cd: as documented in mmc core bindings.
 
+* pwr-en: Card needs power from controller. 0 or 1
+
 Aliases:
 
 - All the MSHC controller nodes should be represented in the aliases node using
diff --git a/arch/arm/boot/dts/socfpga_vt.dts b/arch/arm/boot/dts/socfpga_vt.dts
index 927c5b4..db896ef 100644
--- a/arch/arm/boot/dts/socfpga_vt.dts
+++ b/arch/arm/boot/dts/socfpga_vt.dts
@@ -27,6 +27,10 @@
 	};
 
 	soc {
+		dwmmc0@ff704000 {
+			pwr-en = <1>;
+		};
+
 		stmmac@ff700000 {
 			phy-mode = "gmii";
 		};
diff --git a/drivers/mmc/host/dw_mmc.c b/drivers/mmc/host/dw_mmc.c
index 12f17f7..d3d8913 100644
--- a/drivers/mmc/host/dw_mmc.c
+++ b/drivers/mmc/host/dw_mmc.c
@@ -2065,6 +2065,11 @@ static struct dw_mci_board *dw_mci_parse_dt(struct dw_mci *host)
 		pdata->bus_hz = 50000000;
 	}
 
+	if (of_property_read_u32(dev->of_node, "pwr-en", &pdata->pwr_en)) {
+		dev_info(dev, "couldn't determine pwr-en, assuming pwr-en = 0\n");
+		pdata->pwr_en = 0;
+	}
+
 	/* find out number of slots supported */
 	if (of_property_read_u32(dev->of_node, "num-slots",
 				&pdata->num_slots)) {
@@ -2215,6 +2220,9 @@ int dw_mci_probe(struct dw_mci *host)
 	mci_writel(host, RINTSTS, 0xFFFFFFFF);
 	mci_writel(host, INTMASK, 0); /* disable all mmc interrupt first */
 
+	/* Set PWREN bit */
+	mci_writel(host, PWREN, host->pdata->pwr_en);
+
 	/* Put in max timeout */
 	mci_writel(host, TMOUT, 0xFFFFFFFF);
 
diff --git a/include/linux/mmc/dw_mmc.h b/include/linux/mmc/dw_mmc.h
index ad1df48..a6df328 100644
--- a/include/linux/mmc/dw_mmc.h
+++ b/include/linux/mmc/dw_mmc.h
@@ -190,6 +190,8 @@ struct dw_mci {
 
 	/* Set to one for SDR12 and SDR25 */
 	unsigned int use_hold_reg;
+	/*Card needs power enable bit */
+	u32 pwr_en;
 };
 
 /* DMA ops for Internal/External DMAC interface */
@@ -230,7 +232,9 @@ struct dw_mci_board {
 	u32 num_slots;
 
 	u32 quirks; /* Workaround / Quirk flags */
-	unsigned int bus_hz; /* Bus speed */
+	unsigned int bus_hz; /* Clock speed at the cclk_in pad */
+	/*Card needs power enable bit */
+	u32 pwr_en;
 
 	unsigned int caps;	/* Capabilities */
 	unsigned int caps2;	/* More capabilities */
-- 
1.7.5.4

