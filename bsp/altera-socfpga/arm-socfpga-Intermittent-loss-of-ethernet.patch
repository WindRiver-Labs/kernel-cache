From 2cc46598176005256090988ee175993fb6c736ac Mon Sep 17 00:00:00 2001
From: Matthew Gerlach <mgerlach@altera.com>
Date: Fri, 5 Apr 2013 09:10:26 -0700
Subject: [PATCH 226/254] arm: socfpga: Intermittent loss of ethernet

Upstream: git://git.rocketboards.org/linux-socfpga.git
 transmission.

This bug does not really have anything to do with ethernet.
The problem was a memory coherency problem between the cpu
and a dma engine, in this case the ethernet mac.  In short,
while dma writes by the ethernet were not getting cached in L2,
they were getting cached in L1.  The good news is a single bit
change to the programming of the PL310 fixes the problem.

Signed-off-by: Matthew Gerlach <mgerlach@altera.com>
(cherry picked from commit 07a0de277eca4e6d57323db83cb7977916882a90)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-socfpga/socfpga.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 40e3f72..2f1cc9d 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -327,7 +327,8 @@ static void __init socfpga_cyclone5_init(void)
 {
 #ifdef CONFIG_CACHE_L2X0
 	u32 aux_ctrl = 0;
-	aux_ctrl |= (1 << L2X0_AUX_CTRL_DATA_PREFETCH_SHIFT) |
+	aux_ctrl |= (1 << L2X0_AUX_CTRL_SHARE_OVERRIDE_SHIFT) |
+			(1 << L2X0_AUX_CTRL_DATA_PREFETCH_SHIFT) |
 			(1 << L2X0_AUX_CTRL_INSTR_PREFETCH_SHIFT);
 	l2x0_of_init(aux_ctrl, ~0UL);
 #endif
-- 
1.7.5.4

