From c00d24589cdb2bfa2db00d874fe6ec48fe394f7b Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Tue, 16 Oct 2012 14:42:28 -0600
Subject: [PATCH 094/254] gpio-dw: socfpga: Enable gpio-dw driver for socfpga

Upstream: git://git.rocketboards.org/linux-socfpga.git

-Add gpio-dw device tree entries, socfpga_defconfig and clk entries
-Add nr_irqs for use with the GPIO driver using SPARSE_IRQ
-Add gpio.h under mach-socfpga - Can probably be removed with cleanup

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
(cherry picked from commit 2e3a3161a09670b2b648185f0a160e719a3cd2e8)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/boot/dts/socfpga.dtsi            |   39 +++++++++++++++++++++++++++++
 arch/arm/configs/socfpga_defconfig        |    3 ++
 arch/arm/mach-socfpga/include/mach/gpio.h |   11 ++++++++
 arch/arm/mach-socfpga/socfpga.c           |    1 +
 drivers/clk/socfpga/clk.c                 |   12 +++++++++
 5 files changed, 66 insertions(+), 0 deletions(-)
 create mode 100644 arch/arm/mach-socfpga/include/mach/gpio.h

diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index 708aed1..ba2dbbb 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -88,6 +88,45 @@
 			phy-mode = "gmii";
 		};
 
+		gpio0: gpio@ff708000 {
+			compatible = "snps,dw-gpio";
+			reg = <0xff708000 0x1000>;
+			interrupts = <0 164 4>;
+			porta_width = <29>;
+			bank_width = <29>;
+			virtual_irq_start = <257>;
+			interrupt-controller;
+			#interrupt-cells = <2>;
+			gpio-controller;
+			#gpio-cells = <2>;
+		};
+
+		gpio1: gpio@ff709000 {
+			compatible = "snps,dw-gpio";
+			reg = <0xff709000 0x1000>;
+			interrupts = <0 165 4>;
+			porta_width = <29>;
+			bank_width = <29>;
+			virtual_irq_start = <286>;
+			interrupt-controller;
+			#interrupt-cells = <2>;
+			gpio-controller;
+			#gpio-cells = <2>;
+		};
+
+		gpio2: gpio@ff70a000 {
+			compatible = "snps,dw-gpio";
+			reg = <0xff70a000 0x1000>;
+			interrupts = <0 166 4>;
+			porta_width = <27>;
+			bank_width = <27>;
+			virtual_irq_start = <315>;
+			interrupt-controller;
+			#interrupt-cells = <2>;
+			gpio-controller;
+			#gpio-cells = <2>;
+		};
+
 		L2: l2-cache@fffef000 {
 			compatible = "arm,pl310-cache";
 			reg = <0xfffef000 0x1000>;
diff --git a/arch/arm/configs/socfpga_defconfig b/arch/arm/configs/socfpga_defconfig
index 39d2f66..ff23e7f 100644
--- a/arch/arm/configs/socfpga_defconfig
+++ b/arch/arm/configs/socfpga_defconfig
@@ -81,6 +81,9 @@ CONFIG_SPI_DESIGNWARE=y
 CONFIG_SPI_DW_PL330_DMA=y
 CONFIG_SPI_DW_MMIO=y
 CONFIG_SPI_SPIDEV=y
+CONFIG_GPIOLIB=y
+CONFIG_GPIO_SYSFS=y
+CONFIG_GPIO_DW=y
 # CONFIG_RTC_HCTOSYS is not set
 CONFIG_EXT2_FS=y
 CONFIG_EXT2_FS_XATTR=y
diff --git a/arch/arm/mach-socfpga/include/mach/gpio.h b/arch/arm/mach-socfpga/include/mach/gpio.h
new file mode 100644
index 0000000..3c8d26d
--- /dev/null
+++ b/arch/arm/mach-socfpga/include/mach/gpio.h
@@ -0,0 +1,11 @@
+#ifndef __ASM_ARCH_MACH_GPIO_H
+#define __ASM_ARCH_MACH_GPIO_H
+
+#include <asm-generic/gpio.h>
+
+#define gpio_get_value	__gpio_get_value
+#define gpio_set_value	__gpio_set_value
+#define gpio_cansleep	__gpio_cansleep
+#define gpio_to_irq	__gpio_to_irq
+
+#endif /* __ASM_ARCH_MACH_GPIO_H */
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index be3e6b7..1d0de30 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -110,6 +110,7 @@ DT_MACHINE_START(SOCFPGA, "Altera SOCFPGA")
 	.init_irq	= gic_init_irq,
 	.handle_irq     = gic_handle_irq,
 	.timer		= &dw_apb_timer,
+	.nr_irqs		= SOCFPGA_NR_IRQS,
 	.init_machine	= socfpga_cyclone5_init,
 	.restart	= socfpga_cyclone5_restart,
 	.dt_compat	= altera_dt_match,
diff --git a/drivers/clk/socfpga/clk.c b/drivers/clk/socfpga/clk.c
index 9f04f69..d58639f 100644
--- a/drivers/clk/socfpga/clk.c
+++ b/drivers/clk/socfpga/clk.c
@@ -106,4 +106,16 @@ void __init socfpga_init_clocks(void)
 	clk = clk_register_gate(NULL, "spi1_clk", "per_pll_clk", 0, clk_mgr_base_addr + CLKMGR_PERPLLGRP_EN,
 			CLKMGR_SPI_M_CLK_EN, 0, &_lock);
 	clk_register_clkdev(clk, NULL, "fff01000.spi");
+
+	clk = clk_register_gate(NULL, "gpio0_clk", "per_pll_clk", 0, clk_mgr_base_addr + CLKMGR_PERPLLGRP_EN,
+			CLKMGR_GPIO_CLK_EN, 0, &_lock);
+	clk_register_clkdev(clk, NULL, "ff708000.gpio");
+
+	clk = clk_register_gate(NULL, "gpio1_clk", "per_pll_clk", 0, clk_mgr_base_addr + CLKMGR_PERPLLGRP_EN,
+			CLKMGR_GPIO_CLK_EN, 0, &_lock);
+	clk_register_clkdev(clk, NULL, "ff709000.gpio");
+
+	clk = clk_register_gate(NULL, "gpio2_clk", "per_pll_clk", 0, clk_mgr_base_addr + CLKMGR_PERPLLGRP_EN,
+			CLKMGR_GPIO_CLK_EN, 0, &_lock);
+	clk_register_clkdev(clk, NULL, "ff70a000.gpio");
 }
-- 
1.7.5.4

