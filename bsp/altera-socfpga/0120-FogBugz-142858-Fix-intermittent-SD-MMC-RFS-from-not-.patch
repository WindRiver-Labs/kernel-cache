From ec42b809a47d83f587e0550ba4d2ac7cfa7914ff Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Thu, 1 Aug 2013 22:21:55 -0500
Subject: [PATCH 120/248] FogBugz #142858: Fix intermittent SD/MMC RFS from not
 mounting

This bug was uncovered during a kernel upgrade to v3.10. The SD/MMC
Hardware Locked Write Error(HLE) was intermittently getting triggered.
The driver does not have any mechanism for handling this interrupt.

Clear the HLE interrupt when it gets triggered.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 drivers/mmc/host/dw_mmc.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/mmc/host/dw_mmc.c b/drivers/mmc/host/dw_mmc.c
index 8c2a3df..d8aff70 100644
--- a/drivers/mmc/host/dw_mmc.c
+++ b/drivers/mmc/host/dw_mmc.c
@@ -1892,6 +1892,9 @@ static irqreturn_t dw_mci_interrupt(int irq, void *dev_id)
 			queue_work(host->card_workqueue, &host->card_work);
 		}
 
+		if (pending & SDMMC_INT_HLE)
+			mci_writel(host, RINTSTS, SDMMC_INT_HLE);
+
 		/* Handle SDIO Interrupts */
 		for (i = 0; i < host->num_slots; i++) {
 			struct dw_mci_slot *slot = host->slot[i];
-- 
1.9.1

