From f955534a940ef2bed358603e2582a365f411878b Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Fri, 12 Apr 2013 14:37:09 -0500
Subject: [PATCH 086/248] FogBugz #113871: Add CIU clock in device tree entry
 for SD/MMC

This patch aligns the SD/MMC driver with the community version. We no
longer need to add "bus-hz" in the device tree entry and gets it correctly
from the ciu clock device tree entry.

Also adds dw_mmc-socfpga.c for platform specific functions such as
getting the CIU divider, setting for pwr-en, and USE_HOLD_REG setting.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>

v5:
- Fix up indentation/spacing
- Remove clock phase shift for socfpga_vt.dts

v4:
- Move setting of drvsel and smplsel to a one-time called function.
- Gate the SDMMC clock before setting drvsel and smplsel
- Remove set_ios functionality

v3:
- Add "altr,dw-mshc-ciu-div" for CIU clock divider value
- Add "altr,dw-mshc-sdr-timing" for drvsel and smplsel values for system
manager control register
- Sets the drvsel and smplsel bits in the system manager SDMMC group
- Add documentation for altr,dw-mshc device tree bindings
- Split out SOC and board specific bindings

v2:
- Read sysmgr sdmmc_ctrl group, if value > 0, use_hold_reg gets set
- Removed "bus-hz" from socfpga.dtsi
- Fixed divider of 4 for CIU clock
- Introduce global variable socfpga_sdmmc_use_hold_reg to use because its
more efficient than trying to check for use_hold_reg for every prepare_command.
---
 .../devicetree/bindings/mmc/socfpga-dw-mshc.txt    | 59 ++++++++++++++++++++++
 arch/arm/boot/dts/socfpga.dtsi                     | 52 ++++++++++---------
 arch/arm/boot/dts/socfpga_cyclone5.dtsi            | 15 ++++--
 arch/arm/boot/dts/socfpga_vt.dts                   | 16 ++++--
 arch/arm/configs/socfpga_defconfig                 |  1 +
 drivers/mmc/host/dw_mmc-socfpga.c                  | 11 ++--
 drivers/mmc/host/dw_mmc.c                          | 29 ++---------
 include/linux/mmc/dw_mmc.h                         |  7 ---
 8 files changed, 119 insertions(+), 71 deletions(-)
 create mode 100644 Documentation/devicetree/bindings/mmc/socfpga-dw-mshc.txt

diff --git a/Documentation/devicetree/bindings/mmc/socfpga-dw-mshc.txt b/Documentation/devicetree/bindings/mmc/socfpga-dw-mshc.txt
new file mode 100644
index 0000000..f4fda57
--- /dev/null
+++ b/Documentation/devicetree/bindings/mmc/socfpga-dw-mshc.txt
@@ -0,0 +1,59 @@
+* Altera SOCFPGA specific extensions to the Synopsis Designware Mobile
+  Storage Host Controller
+
+Required Properties:
+
+* compatible: should be
+	- "altr,socfpga-dw-mshc": for controllers with Altera SOCFPGA
+	  specific extentions.
+
+* altr,dw-mshc-ciu-div: Specifies the divider value for the card interface
+  unit (ciu) clock. For Altera's SOCFPGA, the divider value is fixed at 4.
+
+* altr,dw-mshc-sdr-timing: Specifies the value of CIU clock phase shift value
+  in transmit mode and CIU clock phase shift value in receive mode for single
+  data rate mode operation. Refer notes below for the order of the cells and the
+  valid values.
+
+  Notes for the sdr-timing values:
+
+    The order of the cells should be
+      - First Cell: CIU clock phase shift value for RX mode, smplsel bits in
+	the system manager SDMMC control group.
+      - Second Cell: CIU clock phase shift value for TX mode, drvsel bits in
+	the system manager SDMMC control group.
+
+    Valid values for SDR CIU clock timing for SOCFPGA:
+      - valid value for tx phase shift and rx phase shift is 0 to 7.
+
+Required properties for a slot:
+
+* bus-width: Data width for card slot. 4-bit or 8-bit data.
+
+Example:
+
+  The MSHC controller node can be split into two portions, SoC specific and
+  board specific portions as listed below.
+
+	dwmmc0@ff704000 {
+		compatible = "altr,socfpga-dw-mshc";
+		reg = <0xff704000 0x1000>;
+		interrupts = <0 139 4>;
+		#address-cells = <1>;
+		#size-cells = <0>;
+	};
+
+	dwmmc0@ff704000 {
+		num-slots = <1>;
+		supports-highspeed;
+		broken-cd;
+		fifo-depth = <0x400>;
+		altr,dw-mshc-ciu-div = <4>;
+      		altr,dw-mshc-sdr-timing = <0 3>;
+
+		slot@0 {
+			reg = <0>;
+			bus-width = <4>;
+		};
+	};
+
diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index 49dfbcf..dba2da8 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -80,7 +80,6 @@
 			level_trigger = <0>;
 		};
 
-
 		amba {
 			compatible = "arm,amba-bus";
 			#address-cells = <1>;
@@ -597,20 +596,14 @@
 		};
 
 		mmc: dwmmc0@ff704000 {
-			compatible = "snps,dw-mshc";
+			compatible = "altr,socfpga-dw-mshc";
 			reg = <0xff704000 0x1000>;
 			interrupts = <0 139 4>;
-			bus-hz = <12500000>; /*12.5 MHz*/
+			fifo-depth = <0x400>;
 			#address-cells = <1>;
 			#size-cells = <0>;
-			num-slots = <1>;
-			supports-highspeed;
-			broken-cd;
-			fifo-depth = <0x400>;
-			slot@0 {
-				reg = <0>;
-				bus-width = <4>;
-			};
+			clocks = <&l4_mp_clk>, <&sdmmc_clk>;
+			clock-names = "biu", "ciu";
 		};
 
 		nand: nand@ff900000 {
@@ -739,23 +732,32 @@
 			reg-io-width = <4>;
 		};
 
-		rstmgr@ffd05000 {
-			compatible = "altr,rst-mgr";
-			reg = <0xffd05000 0x1000>;
+		usb0: usb@ffb00000 {
+			compatible = "snps,dwc-otg";
+			reg = <0xffb00000 0xffff>;
+			interrupts = <0 125 4>;
+			dma-mask = <0xffffffff>;
+			host-rx-fifo-size = <512>;
+			dev-rx-fifo-size = <512>;
+			dev-nperio-tx-fifo-size = <4096>;
+			dev-perio-tx-fifo-size = <512 512 512 512 512 512
+				512 512 512 512 512 512 512 512 512>;
+			dev-tx-fifo-size = <512 512 512 512 512 512
+				512 512 512 512 512 512 512 512 512>;
 		};
 
 		usb1: usb@ffb40000 {
-				compatible = "snps,dwc-otg";
-				reg = <0xffb40000 0xffff>;
-				interrupts = <0 128 4>;
-				dma-mask = <0xffffffff>;
-				host-rx-fifo-size = <512>;
-				dev-rx-fifo-size = <512>;
-				dev-nperio-tx-fifo-size = <4096>;
-				dev-perio-tx-fifo-size = <512 512 512 512 512 512
-					512 512 512 512 512 512 512 512 512>;
-				dev-tx-fifo-size = <512 512 512 512 512 512
-					512 512 512 512 512 512 512 512 512>;
+			compatible = "snps,dwc-otg";
+			reg = <0xffb40000 0xffff>;
+			interrupts = <0 128 4>;
+			dma-mask = <0xffffffff>;
+			host-rx-fifo-size = <512>;
+			dev-rx-fifo-size = <512>;
+			dev-nperio-tx-fifo-size = <4096>;
+			dev-perio-tx-fifo-size = <512 512 512 512 512 512
+				512 512 512 512 512 512 512 512 512>;
+			dev-tx-fifo-size = <512 512 512 512 512 512
+				512 512 512 512 512 512 512 512 512>;
 		};
 	};
 };
diff --git a/arch/arm/boot/dts/socfpga_cyclone5.dtsi b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
index 3db475b..65f5913 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5.dtsi
+++ b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
@@ -48,10 +48,17 @@
 			};
 		};
 
-		ethernet@ff702000 {
-			phy-mode = "rgmii";
-			phy-addr = <0xffffffff>; /* probe for phy addr */
-			status = "okay";
+		dwmmc0@ff704000 {
+			num-slots = <1>;
+			supports-highspeed;
+			broken-cd;
+			altr,dw-mshc-ciu-div = <4>;
+			altr,dw-mshc-sdr-timing = <0 3>;
+
+			slot@0 {
+				reg = <0>;
+				bus-width = <4>;
+			};
 		};
 
 		timer0@ffc08000 {
diff --git a/arch/arm/boot/dts/socfpga_vt.dts b/arch/arm/boot/dts/socfpga_vt.dts
index 3e3ed2d..b5cbf68 100644
--- a/arch/arm/boot/dts/socfpga_vt.dts
+++ b/arch/arm/boot/dts/socfpga_vt.dts
@@ -41,10 +41,18 @@
 			};
 		};
 
-		ethernet@ff700000 {
-			phy-mode = "gmii";
-			status = "okay";
-		};
+		dwmmc0@ff704000 {
+			num-slots = <1>;
+			supports-highspeed;
+			broken-cd;
+			altr,dw-mshc-ciu-div = <3>;
+			altr,dw-mshc-sdr-timing = <0 3>;
+
+			slot@0 {
+				reg = <0>;
+				bus-width = <4>;
+			};
+		};		
 
 		timer0@ffc08000 {
 			clock-frequency = <7000000>;
diff --git a/arch/arm/configs/socfpga_defconfig b/arch/arm/configs/socfpga_defconfig
index 071ab56..3f3975a 100644
--- a/arch/arm/configs/socfpga_defconfig
+++ b/arch/arm/configs/socfpga_defconfig
@@ -79,6 +79,7 @@ CONFIG_DWC_SLAVE=y
 CONFIG_MMC=y
 CONFIG_MMC_DW=y
 CONFIG_MMC_DW_IDMAC=y
+CONFIG_MMC_DW_SOCFPGA=y
 CONFIG_SPI=y
 CONFIG_SPI_CADENCE_QSPI=y
 CONFIG_SPI_DESIGNWARE=y
diff --git a/drivers/mmc/host/dw_mmc-socfpga.c b/drivers/mmc/host/dw_mmc-socfpga.c
index 3e8e53a..d67fd7f 100644
--- a/drivers/mmc/host/dw_mmc-socfpga.c
+++ b/drivers/mmc/host/dw_mmc-socfpga.c
@@ -26,14 +26,15 @@
 
 #define SYSMGR_SDMMCGRP_CTRL_OFFSET		0x108
 #define DRV_CLK_PHASE_SHIFT_SEL_MASK	0x7
-#define SYSMGR_SDMMC_CTRL_SET(smplsel, drvsel)          \
-	((((smplsel) & 0x7) << 3) | (((drvsel) & 0x7) << 0))
+#define SYSMGR_SDMMC_CTRL_SET(smplsel, drvsel)		\
+	((((drvsel) << 0) & 0x7) | (((smplsel) << 3) & 0x38))
+
+extern void __iomem *sys_manager_base_addr;
 
 /* SOCFPGA implementation specific driver private data */
 struct dw_mci_socfpga_priv_data {
-	u8	ciu_div; /* card interface unit divisor */
-	u32	hs_timing; /* bitmask for CIU clock phase shift */
-	struct regmap   *sysreg; /* regmap for system manager register */
+	u8	ciu_div;
+	u32	hs_timing;
 };
 
 static int dw_mci_socfpga_priv_init(struct dw_mci *host)
diff --git a/drivers/mmc/host/dw_mmc.c b/drivers/mmc/host/dw_mmc.c
index a5ec039..8c2a3df 100644
--- a/drivers/mmc/host/dw_mmc.c
+++ b/drivers/mmc/host/dw_mmc.c
@@ -41,13 +41,9 @@
 #include "dw_mmc.h"
 
 /* Common flag combinations */
-
-/* According to Synopsys, the data starvation interrupt (HTO) should not treat
- * as error. Software should continue the data transfer. We have verified this
- * in Virtual Target. The same is applied to FIFO under/overrun (FRUN) as well.
- */
-#define DW_MCI_DATA_ERROR_FLAGS (SDMMC_INT_DTO | SDMMC_INT_DCRC | \
-				 SDMMC_INT_HTO | SDMMC_INT_FRUN | SDMMC_INT_SBE | SDMMC_INT_EBE)
+#define DW_MCI_DATA_ERROR_FLAGS	(SDMMC_INT_DRTO | SDMMC_INT_DCRC | \
+				 SDMMC_INT_HTO | SDMMC_INT_FRUN | \
+				 SDMMC_INT_SBE | SDMMC_INT_EBE)
 
 #define DW_MCI_CMD_ERROR_FLAGS	(SDMMC_INT_RTO | SDMMC_INT_RCRC | \
 				 SDMMC_INT_RESP_ERR)
@@ -288,9 +284,6 @@ static u32 dw_mci_prepare_command(struct mmc_host *mmc, struct mmc_command *cmd)
 	if (drv_data && drv_data->prepare_command)
 		drv_data->prepare_command(slot->host, &cmdr);
 
-	if (slot->host->use_hold_reg)
-		cmdr |= SDMMC_CMD_USE_HOLD_REG;
-
 	return cmdr;
 }
 
@@ -2379,16 +2372,6 @@ static struct dw_mci_board *dw_mci_parse_dt(struct dw_mci *host)
 		return ERR_PTR(-ENOMEM);
 	}
 
-	if (of_property_read_u32(dev->of_node, "bus-hz", &pdata->bus_hz)) {
-		dev_err(dev, "couldn't determine bus-hz\n");
-		pdata->bus_hz = 50000000;
-	}
-
-	if (of_property_read_u32(dev->of_node, "pwr-en", &pdata->pwr_en)) {
-		dev_info(dev, "couldn't determine pwr-en, assuming pwr-en = 0\n");
-		pdata->pwr_en = 0;
-	}
-
 	/* find out number of slots supported */
 	if (of_property_read_u32(dev->of_node, "num-slots",
 				&pdata->num_slots)) {
@@ -2572,9 +2555,6 @@ int dw_mci_probe(struct dw_mci *host)
 		host->data_shift = 2;
 	}
 
-	/* Get the USE_HOLD_REG */
-	host->use_hold_reg = mci_readl(host, CMD) & SDMMC_CMD_USE_HOLD_REG;
-
 	/* Reset all blocks */
 	if (!dw_mci_ctrl_all_reset(host))
 		return -ENODEV;
@@ -2586,9 +2566,6 @@ int dw_mci_probe(struct dw_mci *host)
 	mci_writel(host, RINTSTS, 0xFFFFFFFF);
 	mci_writel(host, INTMASK, 0); /* disable all mmc interrupt first */
 
-	/* Set PWREN bit */
-	mci_writel(host, PWREN, host->pdata->pwr_en);
-
 	/* Put in max timeout */
 	mci_writel(host, TMOUT, 0xFFFFFFFF);
 
diff --git a/include/linux/mmc/dw_mmc.h b/include/linux/mmc/dw_mmc.h
index f70e690..6ce7d2c 100644
--- a/include/linux/mmc/dw_mmc.h
+++ b/include/linux/mmc/dw_mmc.h
@@ -191,11 +191,6 @@ struct dw_mci {
 	struct regulator	*vmmc;	/* Power regulator */
 	unsigned long		irq_flags; /* IRQ flags */
 	int			irq;
-
-	/* Set to one for SDR12 and SDR25 */
-	unsigned int use_hold_reg;
-	/*Card needs power enable bit */
-	u32 pwr_en;
 };
 
 /* DMA ops for Internal/External DMAC interface */
@@ -239,8 +234,6 @@ struct dw_mci_board {
 
 	u32 quirks; /* Workaround / Quirk flags */
 	unsigned int bus_hz; /* Clock speed at the cclk_in pad */
-	/*Card needs power enable bit */
-	u32 pwr_en;
 
 	u32 caps;	/* Capabilities */
 	u32 caps2;	/* More capabilities */
-- 
1.9.1

