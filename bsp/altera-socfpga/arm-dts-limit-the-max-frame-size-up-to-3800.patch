From c514cd69cecf6f4b2551a479dd0a707fde42612f Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Tue, 29 Apr 2014 14:41:28 +0800
Subject: [PATCH] arm/dts: limit the max frame size up to 3800

Commit 0e899ace0777818e2fd8fd99d2c4449948ad375f
and    7850c5f50246d1e21f439bd6c8da8aec722ad563
>From http://rocketboards.org/gitweb/?p=linux-socfpga.git

Commit 0e899ace0777818e2fd8fd99d2c4449948ad375f create this
limitation as 4062 as below:

The valid range for the C5 SOC is 2000 through 4062, inclusive.

Commit 7850c5f50246d1e21f439bd6c8da8aec722ad563 shrink it to 3800:

The Synopsys EMAC will checksum jumbo transmit frames only up to a
certain size correctly, since the controller will start to egress
an outbound packet when it starts reaching the maximum size of the
transmit fifo. In the Altera configuration case, the PBL, or
programmed burst length is set to 64, the transmit fifo size is 4K,
and the bus datawidth is 32-bits. The equation to determine the
correct maximum MTU is FIFOSIZE-((PBL+3)*(BUSWIDTH/8)) ==
4096-(67*4) = 3828. Then we need to account for possible VLAN tags,
inner and outer, and then transform than number into an Ethernet
MTU, which gives us 3828-8-14-4 (8 bytes for two VLANs, 14 bytes
for the standard Ethernet header size, and another 4 bytes for
CRC). That gives us 3802. So we'll make it a maximum jumbo frame
size of 3800.

Signed-off-by: Vince Bridgers <vbridger@altera.com>
Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 arch/arm/boot/dts/socfpga_arria5.dts   |    1 +
 arch/arm/boot/dts/socfpga_cyclone5.dts |    1 +
 2 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/arch/arm/boot/dts/socfpga_arria5.dts b/arch/arm/boot/dts/socfpga_arria5.dts
index 5c596c4..5398818 100644
--- a/arch/arm/boot/dts/socfpga_arria5.dts
+++ b/arch/arm/boot/dts/socfpga_arria5.dts
@@ -63,6 +63,7 @@
 		ethernet@ff702000 {
 			phy-mode = "rgmii";
 			phy-addr = <0xffffffff>; /* probe for phy addr */
+			max-frame-size = <3800>;
 			status = "okay";
 		};
 
diff --git a/arch/arm/boot/dts/socfpga_cyclone5.dts b/arch/arm/boot/dts/socfpga_cyclone5.dts
index beb1a5e..ddcb76b 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5.dts
+++ b/arch/arm/boot/dts/socfpga_cyclone5.dts
@@ -72,6 +72,7 @@
 		ethernet@ff702000 {
 			phy-mode = "rgmii";
 			phy-addr = <0xffffffff>; /* probe for phy addr */
+			max-frame-size = <3800>;
 		};
 
 		i2c1: i2c@ffc05000 {
-- 
1.7.5.4

