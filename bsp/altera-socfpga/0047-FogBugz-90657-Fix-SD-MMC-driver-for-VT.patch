From bbe9db5c061b834e2fc58176a881656a4637eabe Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Wed, 13 Feb 2013 18:21:25 -0600
Subject: [PATCH 047/248] FogBugz #90657: Fix SD/MMC driver for VT

For VT, need to enable the PWREN bit to enable power to the card.
Add device tree entries to determine which platform needs PWREN
bit.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 drivers/mmc/host/dw_mmc.c  | 8 ++++++++
 include/linux/mmc/dw_mmc.h | 4 ++++
 2 files changed, 12 insertions(+)

diff --git a/drivers/mmc/host/dw_mmc.c b/drivers/mmc/host/dw_mmc.c
index ebb5492..a5ec039 100644
--- a/drivers/mmc/host/dw_mmc.c
+++ b/drivers/mmc/host/dw_mmc.c
@@ -2384,6 +2384,11 @@ static struct dw_mci_board *dw_mci_parse_dt(struct dw_mci *host)
 		pdata->bus_hz = 50000000;
 	}
 
+	if (of_property_read_u32(dev->of_node, "pwr-en", &pdata->pwr_en)) {
+		dev_info(dev, "couldn't determine pwr-en, assuming pwr-en = 0\n");
+		pdata->pwr_en = 0;
+	}
+
 	/* find out number of slots supported */
 	if (of_property_read_u32(dev->of_node, "num-slots",
 				&pdata->num_slots)) {
@@ -2581,6 +2586,9 @@ int dw_mci_probe(struct dw_mci *host)
 	mci_writel(host, RINTSTS, 0xFFFFFFFF);
 	mci_writel(host, INTMASK, 0); /* disable all mmc interrupt first */
 
+	/* Set PWREN bit */
+	mci_writel(host, PWREN, host->pdata->pwr_en);
+
 	/* Put in max timeout */
 	mci_writel(host, TMOUT, 0xFFFFFFFF);
 
diff --git a/include/linux/mmc/dw_mmc.h b/include/linux/mmc/dw_mmc.h
index c6787ce..f70e690 100644
--- a/include/linux/mmc/dw_mmc.h
+++ b/include/linux/mmc/dw_mmc.h
@@ -194,6 +194,8 @@ struct dw_mci {
 
 	/* Set to one for SDR12 and SDR25 */
 	unsigned int use_hold_reg;
+	/*Card needs power enable bit */
+	u32 pwr_en;
 };
 
 /* DMA ops for Internal/External DMAC interface */
@@ -237,6 +239,8 @@ struct dw_mci_board {
 
 	u32 quirks; /* Workaround / Quirk flags */
 	unsigned int bus_hz; /* Clock speed at the cclk_in pad */
+	/*Card needs power enable bit */
+	u32 pwr_en;
 
 	u32 caps;	/* Capabilities */
 	u32 caps2;	/* More capabilities */
-- 
1.9.1

