From fe48cc636fba498969d15b77eb531d0635c0b3c2 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Wed, 17 Oct 2012 09:35:59 -0500
Subject: [PATCH 154/254] dma: pl330: Add in enhancements for SOCFPGA

Upstream: git://git.rocketboards.org/linux-socfpga.git

-Add changes specific to socfpga.

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/dma/pl330.c        |   16 +++++++++++++++-
 include/linux/amba/pl330.h |    8 ++++++++
 2 files changed, 23 insertions(+), 1 deletions(-)
 mode change 100644 => 100755 drivers/dma/pl330.c

diff --git a/drivers/dma/pl330.c b/drivers/dma/pl330.c
old mode 100644
new mode 100755
index dcb88b0..5f8ba35
--- a/drivers/dma/pl330.c
+++ b/drivers/dma/pl330.c
@@ -2392,7 +2392,7 @@ static int pl330_alloc_chan_resources(struct dma_chan *chan)
 	pch->pl330_chid = pl330_request_channel(&pdmac->pif);
 	if (!pch->pl330_chid) {
 		spin_unlock_irqrestore(&pch->lock, flags);
-		return -ENOMEM;
+		return -EAGAIN;
 	}
 
 	tasklet_init(&pch->task, pl330_tasklet, (unsigned long) pch);
@@ -2894,6 +2894,12 @@ pl330_probe(struct amba_device *adev, const struct amba_id *id)
 	if (ret)
 		goto probe_err2;
 
+	if (pdat->init) {
+		ret = pdat->init(adev);
+		if (ret)
+			goto probe_err3;
+	}
+
 	ret = pl330_add(pi);
 	if (ret)
 		goto probe_err3;
@@ -2991,6 +2997,7 @@ probe_err1:
 static int __devexit pl330_remove(struct amba_device *adev)
 {
 	struct dma_pl330_dmac *pdmac = amba_get_drvdata(adev);
+	struct dma_pl330_platdata *pdat = adev->dev.platform_data;
 	struct dma_pl330_chan *pch, *_p;
 	struct pl330_info *pi;
 	struct resource *res;
@@ -3025,6 +3032,13 @@ static int __devexit pl330_remove(struct amba_device *adev)
 	res = &adev->res;
 	release_mem_region(res->start, resource_size(res));
 
+	if (pdat->exit)
+		pdat->exit(adev);
+
+#ifndef CONFIG_PM_RUNTIME
+	clk_disable(pdmac->clk);
+#endif
+
 	kfree(pdmac);
 
 	return 0;
diff --git a/include/linux/amba/pl330.h b/include/linux/amba/pl330.h
index fe93758..e3408c6 100644
--- a/include/linux/amba/pl330.h
+++ b/include/linux/amba/pl330.h
@@ -29,6 +29,14 @@ struct dma_pl330_platdata {
 	dma_cap_mask_t cap_mask;
 	/* Bytes to allocate for MC buffer */
 	unsigned mcbuf_sz;
+	/* Start of IRQ numbers if support multiple IRQs */
+	int irq_start;
+	/* End of IRQ numbers if support multiple IRQs */
+	int irq_end;
+	/* Platform specific initialization function pointer*/
+	int (*init)(struct amba_device *adev);
+	/* Platform specific exit function pointer*/
+	void (*exit)(struct amba_device *adev);
 };
 
 extern bool pl330_filter(struct dma_chan *chan, void *param);
-- 
1.7.5.4

