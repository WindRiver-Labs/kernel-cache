From c185800b867a1b22f734c2515778316ec51e202c Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Tue, 12 Nov 2013 14:47:59 -0600
Subject: [PATCH 157/248] FogBugz #167813-2: Update the USB DTS entry to use
 the s3c-hsotg driver

Add a "usb-nop-xceiv" PHY node that is needed to be used with the new
generic PHY driver that is from:

[1790d80: drivers: phy: add generic PHY framework]

Add a clock node for dwc2 usb dts entry, as the s3c-hsotg driver will need
to properly initialize. Remove dts bindings that were used by the old
dwc2 driver.

To enable USB peripheral mode on SOCFPGA, build the kernel with the following
defconfig:

CONFIG_USB_PHY=y
CONFIG_NOP_USB_XCEIV=y
CONFIG_USB_S3C_HSOTG=y
CONFIG_GENERIC_PHY=y
CONFIG_CONFIGFS_FS=y

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 arch/arm/boot/dts/socfpga.dtsi          | 26 ++++++++++++++------------
 arch/arm/boot/dts/socfpga_arria5.dts    |  1 -
 arch/arm/boot/dts/socfpga_cyclone5.dtsi |  1 -
 arch/arm/boot/dts/socfpga_vt.dts        |  1 -
 4 files changed, 14 insertions(+), 15 deletions(-)

diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index 0b6bee9..5ec468e 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -777,16 +777,20 @@
 			reg-io-width = <4>;
 		};
 
+		usbphy0: usbphy@0 {
+			#phy-cells = <0>;
+			compatible = "usb-nop-xceiv";
+			status = "okay";
+		};
+
 		usb0: usb@ffb00000 {
 			compatible = "snps,dwc2";
 			reg = <0xffb00000 0xffff>;
 			interrupts = <0 125 4>;
-			dev-rx-fifo-size = <512>;
-			dev-nperio-tx-fifo-size = <4096>;
-			dev-perio-tx-fifo-size = <512 512 512 512 512 512
-				512 512 512 512 512 512 512 512 512>;
-			dev-tx-fifo-size = <512 512 512 512 512 512
-				512 512 512 512 512 512 512 512 512>;
+			clocks = <&usb_mp_clk>;
+			clock-names = "otg";
+			phys = <&usbphy0>;
+			phy-names = "usb2-phy";
 			enable-dynamic-fifo = <1>;
 			host-rx-fifo-size = <0xa00>;
 			host-perio-tx-fifo-size = <0xa00>;
@@ -799,12 +803,10 @@
 			compatible = "snps,dwc2";
 			reg = <0xffb40000 0xffff>;
 			interrupts = <0 128 4>;
-			dev-rx-fifo-size = <512>;
-			dev-nperio-tx-fifo-size = <4096>;
-			dev-perio-tx-fifo-size = <512 512 512 512 512 512
-				512 512 512 512 512 512 512 512 512>;
-			dev-tx-fifo-size = <512 512 512 512 512 512
-				512 512 512 512 512 512 512 512 512>;
+			clocks = <&usb_mp_clk>;
+			clock-names = "otg";
+			phys = <&usbphy0>;
+			phy-names = "usb2-phy";
 			enable-dynamic-fifo = <1>;
 			host-rx-fifo-size = <0xa00>;
 			host-perio-tx-fifo-size = <0xa00>;
diff --git a/arch/arm/boot/dts/socfpga_arria5.dts b/arch/arm/boot/dts/socfpga_arria5.dts
index e62f34f..1c17acf 100644
--- a/arch/arm/boot/dts/socfpga_arria5.dts
+++ b/arch/arm/boot/dts/socfpga_arria5.dts
@@ -142,7 +142,6 @@
 		};
 
 		usb1: usb@ffb40000 {
-			ulpi-ddr = <0>;
 			status = "okay";
 		};
 
diff --git a/arch/arm/boot/dts/socfpga_cyclone5.dtsi b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
index 62d7c51..5b5cabc 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5.dtsi
+++ b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
@@ -140,7 +140,6 @@
 		};
 
 		usb1: usb@ffb40000 {
-			ulpi-ddr = <0>;
 			status = "okay";
 		};
 
diff --git a/arch/arm/boot/dts/socfpga_vt.dts b/arch/arm/boot/dts/socfpga_vt.dts
index 2635606..68b75f9 100644
--- a/arch/arm/boot/dts/socfpga_vt.dts
+++ b/arch/arm/boot/dts/socfpga_vt.dts
@@ -153,7 +153,6 @@
 		};
 
 		usb0: usb@ffb00000 {
-			ulpi-ddr = <0>;
 			status = "okay";
 		};
 	};
-- 
1.9.1

