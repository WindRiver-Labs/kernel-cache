From 72d81233c8a758c146ad8652803548b1e95979cd Mon Sep 17 00:00:00 2001
From: Graham Moore <grmoore@altera.com>
Date: Mon, 9 Sep 2013 10:02:43 -0500
Subject: [PATCH 149/248] FogBugz #152777: Fix out-of-order QSPI chip select
 configuration.

Set chip select value before using it as index into array.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Graham Moore <grmoore@altera.com>
---
 drivers/spi/spi-cadence-qspi-apb.c | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/drivers/spi/spi-cadence-qspi-apb.c b/drivers/spi/spi-cadence-qspi-apb.c
index 921d550..9a1488c 100644
--- a/drivers/spi/spi-cadence-qspi-apb.c
+++ b/drivers/spi/spi-cadence-qspi-apb.c
@@ -859,6 +859,12 @@ int cadence_qspi_apb_process_queue(struct struct_cqspi *cadence_qspi,
 		return -EINVAL;
 	}
 
+	/* Switch chip select. */
+	if (cadence_qspi->current_cs != spi->chip_select) {
+		cadence_qspi->current_cs = spi->chip_select;
+		cadence_qspi_switch_cs(cadence_qspi, spi->chip_select);
+	}
+
 	/* Setup baudrate divisor and delays */
 	f_pdata = &(pdata->f_pdata[cadence_qspi->current_cs]);
 	sclk = cmd_xfer->speed_hz ?
@@ -872,12 +878,6 @@ int cadence_qspi_apb_process_queue(struct struct_cqspi *cadence_qspi,
 		f_pdata->read_delay);
 	cadence_qspi_apb_controller_enable(iobase);
 
-	/* Switch chip select. */
-	if (cadence_qspi->current_cs != spi->chip_select) {
-		cadence_qspi->current_cs = spi->chip_select;
-		cadence_qspi_switch_cs(cadence_qspi, spi->chip_select);
-	}
-
 	/*
 	 * Use STIG command to send if the transfer length is less than
 	 * 4 or if only one transfer.
-- 
1.9.1

