From 38baebb3f6b297889869e581d74ae0ef88399a49 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Tue, 11 Mar 2014 15:35:03 -0500
Subject: [PATCH 196/248] FogBugz #189684-1: Enhance QSPI driver to use common
 clock framework

Modify the QSPI driver so that it can get the clock from the DTS entry and
use the clock driver to get the correct clock rate.

Also update the GPLv2 license.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 drivers/spi/spi-cadence-qspi.c | 35 +++++++++++++++++------------------
 drivers/spi/spi-cadence-qspi.h | 22 +++++++++++-----------
 2 files changed, 28 insertions(+), 29 deletions(-)

diff --git a/drivers/spi/spi-cadence-qspi.c b/drivers/spi/spi-cadence-qspi.c
index a2bc893..97d92ee 100644
--- a/drivers/spi/spi-cadence-qspi.c
+++ b/drivers/spi/spi-cadence-qspi.c
@@ -1,23 +1,21 @@
 /*
  * Driver for Cadence QSPI Controller
  *
- * Copyright (C) 2012 Altera Corporation
+ * Copyright Altera Corporation (C) 2012-2014. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation; either version 2 of the License, or
- * (at your option) any later version.
+ * it under the terms and conditions of the GNU General Public License,
+ * version 2, as published by the Free Software Foundation.
  *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
+ * This program is distributed in the hope it will be useful, but WITHOUT
+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
+ * more details.
  *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * You should have received a copy of the GNU General Public License along with
+ * this program.  If not, see <http://www.gnu.org/licenses/>.
  */
-
+#include <linux/clk.h>
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/interrupt.h>
@@ -244,12 +242,6 @@ static int cadence_qspi_of_get_pdata(struct platform_device *pdev)
 	}
 	pdata->num_chipselect = prop;
 
-	if (of_property_read_u32(np, "master-ref-clk", &prop)) {
-		dev_err(&pdev->dev, "couldn't determine master-ref-clk\n");
-		return -ENXIO;
-	}
-	pdata->master_ref_clk_hz = prop;
-
 	if (of_property_read_u32(np, "ext-decoder", &prop)) {
 		dev_err(&pdev->dev, "couldn't determine ext-decoder\n");
 		return -ENXIO;
@@ -505,6 +497,13 @@ static int cadence_qspi_probe(struct platform_device *pdev)
 	pdev->dev.platform_data = pdata;
 	pdata->qspi_ahb_phy = res_ahb->start;
 
+	cadence_qspi->clk = devm_clk_get(&pdev->dev, NULL);
+	if (IS_ERR(cadence_qspi->clk)) {
+		dev_err(&pdev->dev, "cannot get qspi clk\n");
+		return PTR_ERR(cadence_qspi->clk);
+	}
+	pdata->master_ref_clk_hz = clk_get_rate(cadence_qspi->clk);
+
 	status = cadence_qspi_of_get_pdata(pdev);
 	if (status) {
 		dev_err(&pdev->dev, "Get platform data failed.\n");
diff --git a/drivers/spi/spi-cadence-qspi.h b/drivers/spi/spi-cadence-qspi.h
index 29fd7d6..59acdd7 100644
--- a/drivers/spi/spi-cadence-qspi.h
+++ b/drivers/spi/spi-cadence-qspi.h
@@ -1,21 +1,19 @@
 /*
  * Driver for Cadence QSPI Controller
  *
- * Copyright (C) 2012 Altera Corporation
+ * Copyright Altera Corporation (C) 2012-2014. All rights reserved.
  *
  * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation; either version 2 of the License, or
- * (at your option) any later version.
+ * it under the terms and conditions of the GNU General Public License,
+ * version 2, as published by the Free Software Foundation.
  *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
+ * This program is distributed in the hope it will be useful, but WITHOUT
+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
+ * more details.
  *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ * You should have received a copy of the GNU General Public License along with
+ * this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
 #ifndef __CADENCE_QSPI_H__
@@ -57,6 +55,8 @@ struct struct_cqspi
 	struct list_head msg_queue;
 	struct platform_device *pdev;
 
+	struct clk *clk;
+
 	/* lock protects queue and registers */
 	spinlock_t lock;
 	/* Virtual base address of the controller */
-- 
1.9.1

