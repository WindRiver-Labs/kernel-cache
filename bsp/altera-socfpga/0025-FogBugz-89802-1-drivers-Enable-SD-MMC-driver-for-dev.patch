From 4d79d13f96d8454d1e8284ea753fe83426de9159 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Tue, 11 Dec 2012 18:10:36 -0600
Subject: [PATCH 025/248] FogBugz #89802-1: drivers: Enable SD/MMC driver for
 devkit

Update the SD/MMC driver to the mainline version(v3.7) which has
support for device tree.

/drivers part

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 drivers/mmc/host/dw_mmc-pltfm.c |  1 -
 drivers/mmc/host/dw_mmc.c       | 41 +++++++++++------------------------------
 include/linux/mmc/dw_mmc.h      |  3 +++
 3 files changed, 14 insertions(+), 31 deletions(-)

diff --git a/drivers/mmc/host/dw_mmc-pltfm.c b/drivers/mmc/host/dw_mmc-pltfm.c
index 8ed9d41..5c49656 100644
--- a/drivers/mmc/host/dw_mmc-pltfm.c
+++ b/drivers/mmc/host/dw_mmc-pltfm.c
@@ -125,7 +125,6 @@ static struct platform_driver dw_mci_pltfm_driver = {
 		.name		= "dw_mmc",
 		.of_match_table	= of_match_ptr(dw_mci_pltfm_match),
 		.pm		= &dw_mci_pltfm_pmops,
-		.of_match_table = dw_mci_of_match,
 	},
 };
 
diff --git a/drivers/mmc/host/dw_mmc.c b/drivers/mmc/host/dw_mmc.c
index 7f66059..1c3433d 100644
--- a/drivers/mmc/host/dw_mmc.c
+++ b/drivers/mmc/host/dw_mmc.c
@@ -295,6 +295,9 @@ static u32 dw_mci_prepare_command(struct mmc_host *mmc, struct mmc_command *cmd)
 	if (drv_data && drv_data->prepare_command)
 		drv_data->prepare_command(slot->host, &cmdr);
 
+	if (slot->host->use_hold_reg)
+		cmdr |= SDMMC_CMD_USE_HOLD_REG;
+
 	return cmdr;
 }
 
@@ -2383,6 +2386,11 @@ static struct dw_mci_board *dw_mci_parse_dt(struct dw_mci *host)
 		return ERR_PTR(-ENOMEM);
 	}
 
+	if (of_property_read_u32(dev->of_node, "bus-hz", &pdata->bus_hz)) {
+		dev_err(dev, "couldn't determine bus-hz\n");
+		pdata->bus_hz = 50000000;
+	}
+
 	/* find out number of slots supported */
 	if (of_property_read_u32(dev->of_node, "num-slots",
 				&pdata->num_slots)) {
@@ -2454,36 +2462,6 @@ int dw_mci_probe(struct dw_mci *host)
 		}
 	}
 
-#ifdef CONFIG_OF
-	if (of_property_read_u32(host->dev.of_node, "bus-hz", &prop)) {
-		dev_err(&host->dev, "couldn't determine bus-hz\n");
-		return -ENODEV;
-	}
-	host->pdata->bus_hz = prop;
-
-	if (of_property_read_u32(host->dev.of_node, "num-slots", &prop)) {
-		dev_err(&host->dev, "couldn't determine num-slots\n");
-		return -ENODEV;
-	}
-	host->pdata->num_slots = prop;
-
-	/* Optional parameter. */
-	if (!of_property_read_u32(host->dev.of_node, "fifo-depth", &prop)) {
-		host->pdata->fifo_depth = prop;
-	}
-
-	if (of_property_read_u32(host->dev.of_node, "bus-width", &prop)) {
-		dev_err(&host->dev, "couldn't determine bus-width\n");
-		return -ENODEV;
-	}
-
-	if (prop == 8)
-		host->pdata->caps |= (MMC_CAP_4_BIT_DATA |
-					MMC_CAP_8_BIT_DATA);
-	else if (prop == 4)
-		host->pdata->caps |= MMC_CAP_4_BIT_DATA;
-#endif
-
 	if (!host->pdata->select_slot && host->pdata->num_slots > 1) {
 		dev_err(host->dev,
 			"Platform data must supply select_slot function\n");
@@ -2596,6 +2574,9 @@ int dw_mci_probe(struct dw_mci *host)
 		host->data_shift = 2;
 	}
 
+	/* Get the USE_HOLD_REG */
+	host->use_hold_reg = mci_readl(host, CMD) & SDMMC_CMD_USE_HOLD_REG;
+
 	/* Reset all blocks */
 	if (!dw_mci_ctrl_all_reset(host))
 		return -ENODEV;
diff --git a/include/linux/mmc/dw_mmc.h b/include/linux/mmc/dw_mmc.h
index 6ce7d2c..c6787ce 100644
--- a/include/linux/mmc/dw_mmc.h
+++ b/include/linux/mmc/dw_mmc.h
@@ -191,6 +191,9 @@ struct dw_mci {
 	struct regulator	*vmmc;	/* Power regulator */
 	unsigned long		irq_flags; /* IRQ flags */
 	int			irq;
+
+	/* Set to one for SDR12 and SDR25 */
+	unsigned int use_hold_reg;
 };
 
 /* DMA ops for Internal/External DMAC interface */
-- 
1.9.1

