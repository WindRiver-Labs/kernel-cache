From 3b359707dfec092c97b004de04cbcbdf2edc91b2 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Tue, 12 Feb 2013 15:20:24 -0600
Subject: [PATCH 046/248] FogBugz #91445: Fix intermittent data starvation for
 DMA on SD/MMC

This issue is related to FB #13909. We can also safely ignore the
FIFO Under/Overrun error condition when the driver is using IDMAC.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 arch/arm/configs/socfpga_defconfig |  1 +
 drivers/mmc/host/dw_mmc.c          | 11 ++---------
 2 files changed, 3 insertions(+), 9 deletions(-)

diff --git a/arch/arm/configs/socfpga_defconfig b/arch/arm/configs/socfpga_defconfig
index feeab0a..896369e 100644
--- a/arch/arm/configs/socfpga_defconfig
+++ b/arch/arm/configs/socfpga_defconfig
@@ -74,6 +74,7 @@ CONFIG_USB_GADGET=y
 CONFIG_DWC_OTG_MODE=y
 CONFIG_MMC=y
 CONFIG_MMC_DW=y
+CONFIG_MMC_DW_IDMAC=y
 CONFIG_SPI=y
 CONFIG_SPI_CADENCE_QSPI=y
 CONFIG_SPI_DESIGNWARE=y
diff --git a/drivers/mmc/host/dw_mmc.c b/drivers/mmc/host/dw_mmc.c
index 1c3433d..ebb5492 100644
--- a/drivers/mmc/host/dw_mmc.c
+++ b/drivers/mmc/host/dw_mmc.c
@@ -44,17 +44,10 @@
 
 /* According to Synopsys, the data starvation interrupt (HTO) should not treat
  * as error. Software should continue the data transfer. We have verified this
- * in Virtual Target. Remove this fogbugz after verify this in actual
- * hardware.
+ * in Virtual Target. The same is applied to FIFO under/overrun (FRUN) as well.
  */
-#ifdef FOGBUGZ_13909
- #define DW_MCI_DATA_ERROR_FLAGS	(SDMMC_INT_DTO | SDMMC_INT_DCRC | \
- 				 SDMMC_INT_HTO | SDMMC_INT_SBE  | \
- 				 SDMMC_INT_EBE)
-#else
 #define DW_MCI_DATA_ERROR_FLAGS (SDMMC_INT_DTO | SDMMC_INT_DCRC | \
-				 SDMMC_INT_SBE | SDMMC_INT_EBE)
-#endif
+				 SDMMC_INT_HTO | SDMMC_INT_FRUN | SDMMC_INT_SBE | SDMMC_INT_EBE)
 
 #define DW_MCI_CMD_ERROR_FLAGS	(SDMMC_INT_RTO | SDMMC_INT_RCRC | \
 				 SDMMC_INT_RESP_ERR)
-- 
1.9.1

