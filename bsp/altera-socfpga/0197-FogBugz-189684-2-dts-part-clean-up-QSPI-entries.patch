From 36a3e6cb915e3e07ea48b173de71c3c173769b3b Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Tue, 11 Mar 2014 15:39:50 -0500
Subject: [PATCH 197/248] FogBugz #189684-2: dts part: clean up QSPI entries

Moves the base QSPI dts entry into socfpga.dtsi and add board specific QSPI
entry to the appropriate board file DTS files.

Removes the hard-coded clock frequency.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 .../devicetree/bindings/spi/spi-cadence-qspi.txt   |  3 +-
 arch/arm/boot/dts/socfpga.dtsi                     | 15 +++++++++
 arch/arm/boot/dts/socfpga_arria5.dtsi              | 12 +------
 arch/arm/boot/dts/socfpga_cyclone5.dtsi            | 39 +---------------------
 arch/arm/boot/dts/socfpga_cyclone5_socdk.dts       | 29 ++++++++++++++++
 arch/arm/boot/dts/socfpga_cyclone5_sockit.dts      | 30 +++++++++++++++++
 arch/arm/boot/dts/socfpga_ice.dts                  | 13 +-------
 arch/arm/boot/dts/socfpga_vt.dts                   | 13 +-------
 8 files changed, 79 insertions(+), 75 deletions(-)

diff --git a/Documentation/devicetree/bindings/spi/spi-cadence-qspi.txt b/Documentation/devicetree/bindings/spi/spi-cadence-qspi.txt
index 7d7678b..1bde040b 100644
--- a/Documentation/devicetree/bindings/spi/spi-cadence-qspi.txt
+++ b/Documentation/devicetree/bindings/spi/spi-cadence-qspi.txt
@@ -7,7 +7,6 @@ Required properties:
 	length of the controller register set.  The second entry is the
 	address and length of the QSPI Controller data area.
 - interrupts : Unit interrupt specifier for the controller interrupt.
-- master-ref-clk : Specifies the frequency of the controller input clock.
 - ext-decoder : Value of 0 means no external chipselect decoder is
 	connected, 1 means there is an external chipselect decoder connected.
 - num-chipselect : Number of chip select lines.
@@ -28,7 +27,7 @@ Example:
 		reg = <0xff705000 0x1000>,
 			<0xffa00000 0x1000>;
 		interrupts = <0 151 4>;
-		master-ref-clk = <400000000>;
+		clocks = <&qspi_clk>;
 		ext-decoder = <0>;
 		num-chipselect = <4>;
 		fifo-depth = <128>;
diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index f372532..eb01578 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -739,6 +739,21 @@
 			reg = <0xff800000 0x1000>;
 		};
 
+		qspi: spi@ff705000 {
+			compatible = "cadence,qspi";
+			#address-cells = <1>;
+			#size-cells = <0>;
+			reg = <0xff705000 0x1000>,
+				<0xffa00000 0x1000>;
+			interrupts = <0 151 4>;
+			clocks = <&qspi_clk>;
+			ext-decoder = <0>;  /* external decoder */
+			num-chipselect = <4>;
+			fifo-depth = <128>;
+			bus-num = <2>;
+			status = "disabled";
+		};
+
 		spi0: spi@fff00000 {
 			compatible = "snps,dw-spi-mmio";
 			#address-cells = <1>;
diff --git a/arch/arm/boot/dts/socfpga_arria5.dtsi b/arch/arm/boot/dts/socfpga_arria5.dtsi
index abf1a22..98bade3 100644
--- a/arch/arm/boot/dts/socfpga_arria5.dtsi
+++ b/arch/arm/boot/dts/socfpga_arria5.dtsi
@@ -38,17 +38,7 @@
 		};
 
 		qspi: spi@ff705000 {
-			compatible = "cadence,qspi";
-			#address-cells = <1>;
-			#size-cells = <0>;
-			reg = <0xff705000 0x1000>,
-				<0xffa00000 0x1000>;
-			interrupts = <0 151 4>;
-			master-ref-clk = <370000000>;
-			ext-decoder = <0>;  /* external decoder */
-			num-chipselect = <4>;
-			fifo-depth = <128>;
-			bus-num = <2>;
+			status = "okay";
 		};
 
 		serial0@ffc02000 {
diff --git a/arch/arm/boot/dts/socfpga_cyclone5.dtsi b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
index d7329fa..34edbea 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5.dtsi
+++ b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
@@ -70,44 +70,7 @@
 		};
 
 		qspi: spi@ff705000 {
-			compatible = "cadence,qspi";
-                        #address-cells = <1>;
-			#size-cells = <0>;
-			reg = <0xff705000 0x1000>,
-				<0xffa00000 0x1000>;
-			interrupts = <0 151 4>;
-			master-ref-clk = <400000000>;
-			ext-decoder = <0>;  /* external decoder */
-			num-chipselect = <4>;
-			fifo-depth = <128>;
-			bus-num = <2>;
-
-			flash0: n25q00@0 {
-				#address-cells = <1>;
-				#size-cells = <1>;
-				compatible = "n25q00";
-				reg = <0>;      /* chip select */
-				spi-max-frequency = <100000000>;
-				m25p,fast-read;
-				page-size = <256>;
-				block-size = <16>; /* 2^16, 64KB */
-				read-delay = <4>;  /* delay value in read data capture register */
-				tshsl-ns = <50>;
-				tsd2d-ns = <50>;
-				tchsh-ns = <4>;
-				tslch-ns = <4>;
-
-				partition@qspi-boot {
-					/* 8MB for raw data. */
-					label = "Flash 0 Raw Data";
-					reg = <0x0 0x800000>;
-				};
-				partition@qspi-rootfs {
-					/* 120MB for jffs2 data. */
-					label = "Flash 0 jffs2 Filesystem";
-					reg = <0x800000 0x7800000>;
-				};
-			};
+			status = "okay";
 		};
 
 		serial0@ffc02000 {
diff --git a/arch/arm/boot/dts/socfpga_cyclone5_socdk.dts b/arch/arm/boot/dts/socfpga_cyclone5_socdk.dts
index 8406fad..322df65 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5_socdk.dts
+++ b/arch/arm/boot/dts/socfpga_cyclone5_socdk.dts
@@ -37,3 +37,32 @@
 		ethernet0 = &gmac1;
 	};
 };
+
+&qspi {
+	flash0: n25q00@0 {
+		#address-cells = <1>;
+		#size-cells = <1>;
+		compatible = "n25q00";
+		reg = <0>;      /* chip select */
+		spi-max-frequency = <100000000>;
+		m25p,fast-read;
+		page-size = <256>;
+		block-size = <16>; /* 2^16, 64KB */
+		read-delay = <4>;  /* delay value in read data capture register */
+		tshsl-ns = <50>;
+		tsd2d-ns = <50>;
+		tchsh-ns = <4>;
+		tslch-ns = <4>;
+
+		partition@qspi-boot {
+			/* 8MB for raw data. */
+			label = "Flash 0 Raw Data";
+			reg = <0x0 0x800000>;
+		};
+		partition@qspi-rootfs {
+			/* 120MB for jffs2 data. */
+			label = "Flash 0 jffs2 Filesystem";
+			reg = <0x800000 0x7800000>;
+		};
+	};
+};
diff --git a/arch/arm/boot/dts/socfpga_cyclone5_sockit.dts b/arch/arm/boot/dts/socfpga_cyclone5_sockit.dts
index 50b99a2..c070cb0 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5_sockit.dts
+++ b/arch/arm/boot/dts/socfpga_cyclone5_sockit.dts
@@ -35,3 +35,33 @@
 &gmac1 {
 	status = "okay";
 };
+
+&qspi {
+	flash0: n25q00@0 {
+		#address-cells = <1>;
+		#size-cells = <1>;
+		compatible = "n25q00";
+		reg = <0>;      /* chip select */
+		spi-max-frequency = <100000000>;
+		m25p,fast-read;
+		page-size = <256>;
+		block-size = <16>; /* 2^16, 64KB */
+		read-delay = <4>;  /* delay value in read data capture register */
+		tshsl-ns = <50>;
+		tsd2d-ns = <50>;
+		tchsh-ns = <4>;
+		tslch-ns = <4>;
+
+		partition@qspi-boot {
+			/* 8MB for raw data. */
+			label = "Flash 0 Raw Data";
+			reg = <0x0 0x800000>;
+		};
+
+		partition@qspi-rootfs {
+			/* 120MB for jffs2 data. */
+			label = "Flash 0 jffs2 Filesystem";
+			reg = <0x800000 0x7800000>;
+		};
+	};
+};
diff --git a/arch/arm/boot/dts/socfpga_ice.dts b/arch/arm/boot/dts/socfpga_ice.dts
index d6138d9..e2ccaf2 100644
--- a/arch/arm/boot/dts/socfpga_ice.dts
+++ b/arch/arm/boot/dts/socfpga_ice.dts
@@ -41,18 +41,7 @@
 		};
 
 		qspi: spi@ff705000 {
-			compatible = "cadence,qspi";
-			#address-cells = <1>;
-			#size-cells = <0>;
-			reg = <0xff705000 0x1000>,
-				<0xffa00000 0x1000>;
-			interrupts = <0 151 4>;
-			master-ref-clk = <400000000>;
-			ext-decoder = <0>;  /* external decoder */
-			num-chipselect = <4>;
-			fifo-depth = <128>;
-			bus-num = <2>;
-
+			status = "okay";
 			flash0: n25q128@0 {
 				#address-cells = <1>;
 				#size-cells = <1>;
diff --git a/arch/arm/boot/dts/socfpga_vt.dts b/arch/arm/boot/dts/socfpga_vt.dts
index 105139e..462d359 100644
--- a/arch/arm/boot/dts/socfpga_vt.dts
+++ b/arch/arm/boot/dts/socfpga_vt.dts
@@ -59,18 +59,7 @@
 		};
 
 		qspi: spi@ff705000 {
-			compatible = "cadence,qspi";
-			#address-cells = <1>;
-			#size-cells = <0>;
-			reg = <0xff705000 0x1000>,
-				<0xffa00000 0x1000>;
-			interrupts = <0 151 4>;
-			master-ref-clk = <400000000>;
-			ext-decoder = <0>;  /* external decoder */
-			num-chipselect = <4>;
-			fifo-depth = <128>;
-			bus-num = <2>;
-
+			status = "okay";
 			flash0: n25q128@0 {
 				#address-cells = <1>;
 				#size-cells = <1>;
-- 
1.9.1

