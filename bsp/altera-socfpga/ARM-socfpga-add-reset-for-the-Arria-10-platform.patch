From 5d84fd6619485b34f17487c943cd0f08a9e9832c Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@opensource.altera.com>
Date: Mon, 20 Jul 2015 11:23:13 -0500
Subject: [PATCH 15/73] ARM: socfpga: add reset for the Arria 10 platform

commit cd871d517d46f26943f3c8f61c0d2ac6665da6a2 upstream

Since the Arria10's reset register offset is different from the Cyclone/Arria 5,
it's best to add a new DT_MACHINE_START() for the Arria10.

Signed-off-by: Dinh Nguyen <dinguyen@opensource.altera.com>
---
 arch/arm/mach-socfpga/socfpga.c |   37 +++++++++++++++++++++++++++++++++++++
 1 files changed, 37 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 76bb1df..582c77d3 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -202,6 +202,19 @@ static void socfpga_cyclone5_restart(enum reboot_mode mode, const char *cmd)
 	}
 }
 
+static void socfpga_arria10_restart(enum reboot_mode mode, const char *cmd)
+{
+	u32 temp;
+
+	temp = readl(rst_manager_base_addr + SOCFPGA_A10_RSTMGR_CTRL);
+
+	if (mode == REBOOT_HARD)
+		temp |= RSTMGR_CTRL_SWCOLDRSTREQ;
+	else
+		temp |= RSTMGR_CTRL_SWWARMRSTREQ;
+	writel(temp, rst_manager_base_addr + SOCFPGA_A10_RSTMGR_CTRL);
+}
+
 static void __init socfpga_cyclone5_init(void)
 {
 	of_platform_populate(NULL, of_default_bus_match_table,
@@ -212,6 +225,16 @@ static void __init socfpga_cyclone5_init(void)
 	socfpga_init_nand_ecc();
 }
 
+static void __init socfpga_arria10_init(void)
+{
+	of_platform_populate(NULL, of_default_bus_match_table,
+				socfpga_auxdata_lookup, NULL);
+	enable_periphs();
+	socfpga_soc_device_init();
+	socfpga_init_ocram_ecc();
+	socfpga_init_nand_ecc();
+}
+
 static const char *altera_dt_match[] = {
 	"altr,socfpga",
 	NULL
@@ -227,3 +250,17 @@ DT_MACHINE_START(SOCFPGA, "Altera SOCFPGA")
 	.restart	= socfpga_cyclone5_restart,
 	.dt_compat	= altera_dt_match,
 MACHINE_END
+
+static const char *altera_a10_dt_match[] = {
+	"altr,socfpga-arria10",
+	NULL
+};
+
+DT_MACHINE_START(SOCFPGA_A10, "Altera SOCFPGA Arria10")
+	.l2c_aux_val	= 0,
+	.l2c_aux_mask	= ~0,
+	.init_irq	= socfpga_init_irq,
+	.init_machine	= socfpga_arria10_init,
+	.restart	= socfpga_arria10_restart,
+	.dt_compat	= altera_a10_dt_match,
+MACHINE_END
-- 
1.7.5.4

