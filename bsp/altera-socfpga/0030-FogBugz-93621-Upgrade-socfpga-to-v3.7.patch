From b455803cf0ff2f5128545f8552ef69e2d4443323 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Mon, 7 Jan 2013 21:25:11 -0600
Subject: [PATCH 030/248] FogBugz #93621: Upgrade socfpga to v3.7

Biggest change in v3.7 is the usage of ARM multiplatform.

Because of multiplatform, the usage of Makefile.boot is gone and the
config AUTO_ZRELADDR is used. Since I don't have a 100% grasp of
a this concept, to make sure that your uImage has the correct entry
address, you need to run this:

'make uImage LOADADDR=0x8000'

Another side affect of v3.7 multiplatform is that this config option:
CONFIG_ARCH_VEXPRESS_CORTEX_A5_A9_ERRATA gets enabled when
socfpga_defconfig is used. This is perfectly acceptable on HW, but if
you would like to use VT, then CONFIG_ARCH_VEXPRESS_CORTEX_A5_A9_ERRATA
along with CONFIG_ARM_ERRATA_751472 needs to be disabled.

Also new in v3.7 is the conversion for platform SMP funtions to
use a unified smp_operations function.

A change in /arm/include/asm/io.h is generating alot of warnings from
the usage of __raw_writel() and __raw_readl() in the DWC OTG driver.
A fix for this will be done when the DWC OTG driver is rewritten.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 arch/arm/boot/dts/socfpga.dtsi     |  2 +-
 arch/arm/configs/socfpga_defconfig |  2 --
 arch/arm/mach-socfpga/core.h       | 10 ++++---
 arch/arm/mach-socfpga/hotplug.c    | 53 --------------------------------------
 arch/arm/mach-socfpga/platsmp.c    |  6 ++---
 arch/arm/mach-socfpga/socfpga.c    |  4 +--
 drivers/usb/otg/dwc/cil_intr.c     |  2 +-
 drivers/usb/otg/dwc/platform.c     |  1 +
 8 files changed, 14 insertions(+), 66 deletions(-)
 delete mode 100644 arch/arm/mach-socfpga/hotplug.c

diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index 23a0c7b..f81b3ea 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -526,7 +526,7 @@
 			compatible = "snps,dw-mshc";
 			reg = <0xff704000 0x1000>;
 			interrupts = <0 139 4>;
-			bus-hz = <12500000>; /*12.5 MHz*/
+			bus-hz = <50000000>; /*50 MHz*/
 			#address-cells = <1>;
 			#size-cells = <0>;
 			num-slots = <1>;
diff --git a/arch/arm/configs/socfpga_defconfig b/arch/arm/configs/socfpga_defconfig
index c543cf3..7949ce2 100644
--- a/arch/arm/configs/socfpga_defconfig
+++ b/arch/arm/configs/socfpga_defconfig
@@ -70,8 +70,6 @@ CONFIG_SERIAL_8250_DW=y
 CONFIG_USB=y
 CONFIG_USB_STORAGE=y
 CONFIG_USB_GADGET=y
-CONFIG_USB_GADGET_DWC_HDRC=y
-CONFIG_USB_MASS_STORAGE=y
 CONFIG_DWC_OTG_MODE=y
 CONFIG_MMC=y
 CONFIG_MMC_DW=y
diff --git a/arch/arm/mach-socfpga/core.h b/arch/arm/mach-socfpga/core.h
index 61b0181..c12ec5d 100644
--- a/arch/arm/mach-socfpga/core.h
+++ b/arch/arm/mach-socfpga/core.h
@@ -34,13 +34,15 @@ extern void __iomem *socfpga_scu_base_addr;
 extern void __iomem *sys_manager_base_addr;
 extern void __iomem *rst_manager_base_addr;
 
-extern void socfpga_secondary_startup(void);
-extern void socfpga_cpu_die(unsigned int cpu);
 extern void socfpga_init_clocks(void);
 
+extern void v7_secondary_startup(void);
+extern struct smp_operations socfpga_smp_ops;
+extern char secondary_trampoline, secondary_trampoline_end;
+
+extern struct dw_mci_board sdmmc_platform_data;
 extern unsigned long cpu1start_addr;
 
-#define SOCFPGA_SCU_VIRT_BASE	0xfffec000
-#define SOCFPGA_SDMMC_BASE	0xff704000
+#define SOCFPGA_SCU_VIRT_BASE   0xfffec000
 
 #endif /* __CORE_H */
diff --git a/arch/arm/mach-socfpga/hotplug.c b/arch/arm/mach-socfpga/hotplug.c
deleted file mode 100644
index e04dcca..0000000
--- a/arch/arm/mach-socfpga/hotplug.c
+++ /dev/null
@@ -1,53 +0,0 @@
-/*
- * Copyright 2011 Freescale Semiconductor, Inc.
- * Copyright 2011 Linaro Ltd.
- *
- * The code contained herein is licensed under the GNU General Public
- * License. You may obtain a copy of the GNU General Public License
- * Version 2 or later at the following locations:
- *
- * http://www.opensource.org/licenses/gpl-license.html
- * http://www.gnu.org/copyleft/gpl.html
- */
-
-#include <linux/errno.h>
-#include <asm/cacheflush.h>
-#include <asm/cp15.h>
-
-static inline void cpu_enter_lowpower(void)
-{
-}
-
-static inline void cpu_leave_lowpower(void)
-{
-}
-
-int platform_cpu_kill(unsigned int cpu)
-{
-	return 1;
-}
-
-/*
- * platform-specific code to shutdown a CPU
- *
- * Called with IRQs disabled
- */
-void __ref platform_cpu_die(unsigned int cpu)
-{
-	cpu_enter_lowpower();
-
-	cpu_do_idle();
-	cpu_leave_lowpower();
-
-	/* We should never return from idle */
-	panic("cpu %d unexpectedly exit from shutdown\n", cpu);
-}
-
-int platform_cpu_disable(unsigned int cpu)
-{
-	/*
-	 * CPU0 should not be shut down via hotplug.  cpu_idle can WFI
-	 * or a proper shutdown or hibernate should be used.
-	 */
-	return cpu == 0 ? -EPERM : 0;
-}
diff --git a/arch/arm/mach-socfpga/platsmp.c b/arch/arm/mach-socfpga/platsmp.c
index e4b567c..d7682e7 100644
--- a/arch/arm/mach-socfpga/platsmp.c
+++ b/arch/arm/mach-socfpga/platsmp.c
@@ -29,7 +29,7 @@
 
 #include "core.h"
 
-void __cpuinit platform_secondary_init(unsigned int cpu)
+static void __cpuinit socfpga_secondary_init(unsigned int cpu)
 {
 	/*
 	 * if any interrupts are already enabled for the primary
@@ -75,8 +75,8 @@ static void __init socfpga_smp_init_cpus(void)
 
 	/* sanity check */
 	if (ncores > num_possible_cpus()) {
-		pr_warn("# of cores (%d) greater maximum of %d\n",
-			ncores, num_possible_cpus());
+		pr_warn("socfpga: no. of cores (%d) greater than configured"
+			"maximum of %d - clipping\n", ncores, num_possible_cpus());
 		ncores = num_possible_cpus();
 	}
 
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 467f53d1..1a41e0b 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -72,12 +72,12 @@ static void __init socfpga_scu_map_io(void)
 
 static void __init init_socfpga_vt(void)
 {
-	cpu1start_addr = 0x10;
+	cpu1start_addr = 0xffd08010;
 }
 
 static void __init init_socfpga(void)
 {
-	cpu1start_addr = 0xc4;
+	cpu1start_addr = 0xffd080c4;
 }
 
 static void __init enable_periphs(void)
diff --git a/drivers/usb/otg/dwc/cil_intr.c b/drivers/usb/otg/dwc/cil_intr.c
index ec5b3a7..9406edd 100644
--- a/drivers/usb/otg/dwc/cil_intr.c
+++ b/drivers/usb/otg/dwc/cil_intr.c
@@ -296,7 +296,7 @@ static void port_otg_wqfunc(struct work_struct *work)
 	u32 count = 0;
 	u32 gotgctl;
 
-	pr_info("%s\n", __func__);
+	pr_debug("%s\n", __func__);
 
 	gotgctl = dwc_reg_read(global_regs, DWC_GOTGCTL);
 	if (gotgctl & DWC_GCTL_CONN_ID_STATUS) {
diff --git a/drivers/usb/otg/dwc/platform.c b/drivers/usb/otg/dwc/platform.c
index a050f2e..71e2fb5 100644
--- a/drivers/usb/otg/dwc/platform.c
+++ b/drivers/usb/otg/dwc/platform.c
@@ -52,6 +52,7 @@
  */
 
 #include <linux/usb/dwc_otg.h>
+#include <linux/usb/nop-usb-xceiv.h>
 #include <linux/platform_device.h>
 #include <linux/of_platform.h>
 
-- 
1.9.1

