From 993d977df192de6953ff0f9588a73c02623fe6df Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Thu, 4 Jul 2013 15:56:15 +0800
Subject: [PATCH] arm: socfpga: add early_printk support uart

Add a general support for lowel level debug for socfpga uart.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-socfpga/core.h    |    5 ++++-
 arch/arm/mach-socfpga/socfpga.c |   13 +++++++++++++
 2 files changed, 17 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-socfpga/core.h b/arch/arm/mach-socfpga/core.h
index bc97237..a64748a 100644
--- a/arch/arm/mach-socfpga/core.h
+++ b/arch/arm/mach-socfpga/core.h
@@ -62,7 +62,10 @@ extern char secondary_trampoline, secondary_trampoline_end;
 extern struct dw_mci_board sdmmc_platform_data;
 extern unsigned long cpu1start_addr;
 
-#define SOCFPGA_SCU_VIRT_BASE   0xfee00000
+#define SOCFPGA_SCU_VIRT_BASE	0xfee00000
+#define SOCFPGA_UART_VIRT_BASE	0xfec02000
+#define SOCFPGA_UART_BASE	0xffc02000
+
 #define SOCFPGA_IRQ_GIC_START	32
 
 #endif /* __CORE_H */
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 33e974b..eee02ad 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -67,6 +67,15 @@ static struct map_desc scu_io_desc __initdata = {
 	.type		= MT_DEVICE,
 };
 
+#ifdef CONFIG_DEBUG_LL
+static struct map_desc ll_uart_desc __initdata = {
+	.virtual	= SOCFPGA_UART_VIRT_BASE,
+	.pfn		= __phys_to_pfn(SOCFPGA_UART_BASE),
+	.length		= SZ_4K,
+	.type		= MT_DEVICE,
+};
+#endif
+
 static void __init socfpga_soc_device_init(void)
 {
 	struct device_node *root;
@@ -248,6 +257,10 @@ static void __init socfpga_sysmgr_init(void)
 static void __init socfpga_map_io(void)
 {
 	socfpga_scu_map_io();
+#ifdef CONFIG_DEBUG_LL
+	iotable_init(&ll_uart_desc, 1);
+	early_printk("Early printk initialized\n");
+#endif
 }
 
 static void __init gic_init_irq(void)
-- 
1.7.6

