From 31185addaff63a8840180b56ee55486ec598d82b Mon Sep 17 00:00:00 2001
From: Yang Wei <Wei.Yang@windriver.com>
Date: Mon, 26 May 2014 09:48:53 +0800
Subject: [PATCH] usb: drivers: dwc2: fix a warning of lockdep

We must invoke the spin_lock_init to initialize the
hsotg->lock before invoking dwc2_hcd_init. Otherwise,
the following call trace would be triggered.

INFO: trying to register non-static key.
the code is fine but needs lockdep annotation.
turning off the locking correctness validator.
[<80017aec>] (unwind_backtrace+0x0/0x104) from [<80619e08>] (dump_stack+0x20/0x24)
[<80619e08>] (dump_stack+0x20/0x24) from [<8007bfec>] (__lock_acquire.isra.23+0xc68/0xd04)
[<8007bfec>] (__lock_acquire.isra.23+0xc68/0xd04) from [<8007c794>] (lock_acquire+0x9c/0x150)
[<8007c794>] (lock_acquire+0x9c/0x150) from [<806247b0>] (_raw_spin_lock+0x50/0x60)
[<806247b0>] (_raw_spin_lock+0x50/0x60) from [<8062399c>] (rt_spin_lock_slowlock+0x40/0x2b0)
[<8062399c>] (rt_spin_lock_slowlock+0x40/0x2b0) from [<80623e24>] (rt_spin_lock+0x3c/0x6c)
[<80623e24>] (rt_spin_lock+0x3c/0x6c) from [<8045479c>] (_dwc2_hcd_start+0x2c/0x1c8)
[<8045479c>] (_dwc2_hcd_start+0x2c/0x1c8) from [<80440fac>] (usb_add_hcd+0x1fc/0x604)
[<80440fac>] (usb_add_hcd+0x1fc/0x604) from [<8045776c>] (dwc2_hcd_init+0x508/0x5c4)
[<8045776c>] (dwc2_hcd_init+0x508/0x5c4) from [<80461048>] (dwc2_driver_probe+0x158/0x24c)
[<80461048>] (dwc2_driver_probe+0x158/0x24c) from [<803d4e28>] (platform_drv_probe+0x28/0x2c)
[<803d4e28>] (platform_drv_probe+0x28/0x2c) from [<803d36e8>] (driver_probe_device+0x84/0x1f4)
[<803d36e8>] (driver_probe_device+0x84/0x1f4) from [<803d38f4>] (__driver_attach+0x9c/0xa0)
[<803d38f4>] (__driver_attach+0x9c/0xa0) from [<803d1b18>] (bus_for_each_dev+0x64/0x98)
[<803d1b18>] (bus_for_each_dev+0x64/0x98) from [<803d320c>] (driver_attach+0x2c/0x30)
[<803d320c>] (driver_attach+0x2c/0x30) from [<803d2e0c>] (bus_add_driver+0x214/0x2cc)
[<803d2e0c>] (bus_add_driver+0x214/0x2cc) from [<803d3e58>] (driver_register+0x88/0x16c)
[<803d3e58>] (driver_register+0x88/0x16c) from [<803d520c>] (platform_driver_register+0x64/0x68)
[<803d520c>] (platform_driver_register+0x64/0x68) from [<8086ebfc>] (dwc2_platform_driver_init+0x18/0x1c)
[<8086ebfc>] (dwc2_platform_driver_init+0x18/0x1c) from [<80008630>] (do_one_initcall+0x44/0x184)
[<80008630>] (do_one_initcall+0x44/0x184) from [<80852a7c>] (kernel_init+0x1b4/0x280)
[<80852a7c>] (kernel_init+0x1b4/0x280) from [<8000fb2c>] (kernel_thread_exit+0x0/0x8)

Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/usb/dwc2/platform.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/usb/dwc2/platform.c b/drivers/usb/dwc2/platform.c
index 27ca397..4e0caa0 100644
--- a/drivers/usb/dwc2/platform.c
+++ b/drivers/usb/dwc2/platform.c
@@ -158,6 +158,7 @@ static int dwc2_driver_probe(struct platform_device *dev)
 		params.dma_desc_enable = prop;
 	}
 
+	spin_lock_init(&hsotg->lock);
 	if (IS_ENABLED(CONFIG_USB_DWC2_HOST)) {
 		retval = dwc2_hcd_init(hsotg, irq, &params);
 		if (retval)
@@ -177,7 +178,6 @@ static int dwc2_driver_probe(struct platform_device *dev)
 		if (retval)
 			return retval;
 	}
-	spin_lock_init(&hsotg->lock);
 
 	platform_set_drvdata(dev, hsotg);
 	return retval;
-- 
1.7.5.4

