From 17e697dd1c3a78e65f8f8a76e4e65ef10563f565 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Wed, 11 Sep 2013 12:44:48 -0500
Subject: [PATCH 136/248] FogBugz #154216: Fix common clock driver for SOCFPGA

For clocks with a fixed-divider, the "reg" parameter is not necessary.
The mpu_periph_clk does not have a gate, so change it to the type
"altr,socfpga-perip-clk".

Set the proper clock for the smp_twd timer in the device tree entry.
By doing this, revert the fix in kernel/smp_twd.c to match kernel.org.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 arch/arm/kernel/smp_twd.c       |  5 +----
 arch/arm/mach-socfpga/socfpga.c |  1 -
 drivers/clk/socfpga/clk.c       | 18 +++---------------
 3 files changed, 4 insertions(+), 20 deletions(-)

diff --git a/arch/arm/kernel/smp_twd.c b/arch/arm/kernel/smp_twd.c
index 0887a8e..6591e26 100644
--- a/arch/arm/kernel/smp_twd.c
+++ b/arch/arm/kernel/smp_twd.c
@@ -246,10 +246,7 @@ static void twd_get_clock(struct device_node *np)
 
 	if (np)
 		twd_clk = of_clk_get(np, 0);
-
-	/* Some platforms do not register the smp_twd clock in the device */
-	/* node of the twd timer. */
-	if (IS_ERR(twd_clk))	
+	else
 		twd_clk = clk_get_sys("smp_twd", NULL);
 
 	if (IS_ERR(twd_clk)) {
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 32359a6..4c9b7d9 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -300,7 +300,6 @@ static void __init socfpga_init_irq(void)
 	socfpga_sysmgr_init();
 
 	of_clk_init(NULL);
-	socfpga_init_clocks();
 	clocksource_of_init();
 }
 
diff --git a/drivers/clk/socfpga/clk.c b/drivers/clk/socfpga/clk.c
index d5a7a3f..0a4c529 100644
--- a/drivers/clk/socfpga/clk.c
+++ b/drivers/clk/socfpga/clk.c
@@ -122,15 +122,14 @@ static __init struct clk *socfpga_clk_init(struct device_node *node,
 	int rc;
 	u32 fixed_div;
 
-	rc = of_property_read_u32(node, "reg", &reg);
-	if (WARN_ON(rc))
-		return NULL;
+	of_property_read_u32(node, "reg", &reg);
 
 	socfpga_clk = kzalloc(sizeof(*socfpga_clk), GFP_KERNEL);
 	if (WARN_ON(!socfpga_clk))
 		return NULL;
 
-	socfpga_clk->hw.reg = clk_mgr_base_addr + reg;
+	if (reg)
+		socfpga_clk->hw.reg = clk_mgr_base_addr + reg;
 
 	rc = of_property_read_u32(node, "fixed-divider", &fixed_div);
 	if (rc)
@@ -336,14 +335,3 @@ static void __init socfpga_gate_init(struct device_node *node)
 	socfpga_gate_clk_init(node, &gateclk_ops);
 }
 CLK_OF_DECLARE(socfpga_gate, "altr,socfpga-gate-clk", socfpga_gate_init);
-
-void __init socfpga_init_clocks(void)
-{
-	struct clk *clk;
-	int ret;
-
-	clk = clk_register_fixed_factor(NULL, "smp_twd", "mpuclk", 0, 1, 4);
-	ret = clk_register_clkdev(clk, NULL, "smp_twd");
-	if (ret)
-		pr_err("smp_twd alias not registered\n");
-}
-- 
1.9.1

