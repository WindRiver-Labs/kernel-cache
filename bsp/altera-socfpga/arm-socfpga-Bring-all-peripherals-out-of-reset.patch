From 3e5af33f9f0651fc93280eac480ca928668548ff Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Thu, 18 Oct 2012 13:39:04 -0600
Subject: [PATCH 155/254] arm: socfpga: Bring all peripherals out of reset

Upstream: git://git.rocketboards.org/linux-socfpga.git

Write a 0 to the PERMODRST register in the HPS reset manager. This
releases all of the HPS peripherals from reset.

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
(cherry picked from commit d7e8cb0fb1d2e19561a650b6ac1713371f268238)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-socfpga/core.h    |   14 +++++++-----
 arch/arm/mach-socfpga/platsmp.c |   12 ++--------
 arch/arm/mach-socfpga/socfpga.c |   42 +++++++++++++++++++++++++++++++++++++-
 3 files changed, 51 insertions(+), 17 deletions(-)

diff --git a/arch/arm/mach-socfpga/core.h b/arch/arm/mach-socfpga/core.h
index 9941caa..ba70c41 100644
--- a/arch/arm/mach-socfpga/core.h
+++ b/arch/arm/mach-socfpga/core.h
@@ -20,15 +20,17 @@
 #ifndef __MACH_CORE_H
 #define __MACH_CORE_H
 
+#define SOCFPGA_MODPERRST	0x14
+
 extern void secondary_startup(void);
 extern void __iomem *socfpga_scu_base_addr;
+extern void __iomem *sys_manager_base_addr;
+extern void __iomem *rst_manager_base_addr;
 
+extern void socfpga_secondary_startup(void);
+extern void socfpga_cpu_die(unsigned int cpu);
 extern void socfpga_init_clocks(void);
-extern void socfpga_sysmgr_init(void);
-
-extern struct smp_operations socfpga_smp_ops;
-extern char secondary_trampoline, secondary_trampoline_end;
 
-#define SOCFPGA_SCU_VIRT_BASE   0xfffec000
+extern struct dw_mci_board sdmmc_platform_data;
 
-#endif
+#endif /* __CORE_H */
diff --git a/arch/arm/mach-socfpga/platsmp.c b/arch/arm/mach-socfpga/platsmp.c
index 69a84d9..95bed9c 100644
--- a/arch/arm/mach-socfpga/platsmp.c
+++ b/arch/arm/mach-socfpga/platsmp.c
@@ -2,7 +2,7 @@
  * Copyright 2010-2011 Calxeda, Inc.
  * Copyright 2012 Pavel Machek <pavel@denx.de>
  * Based on platsmp.c, Copyright (C) 2002 ARM Ltd.
- * Copyright (C) 2012 Altera Corporation
+ * Copyright (C) 2012-2013 Altera Corporation
  *
  * This program is free software; you can redistribute it and/or modify it
  * under the terms and conditions of the GNU General Public License,
@@ -28,15 +28,9 @@
 #include <asm/smp_scu.h>
 #include <asm/smp_plat.h>
 
-volatile int pen_release = -1;
+#include "core.h"
 
-extern void secondary_startup(void);
-extern void __iomem *socfpga_scu_base_addr;
-static void __iomem *sys_manager_base_addr;
-static void __iomem *rst_manager_base_addr;
-
-extern void socfpga_secondary_startup(void);
-extern void socfpga_cpu_die(unsigned int cpu);
+int pen_release = -1;
 
 static DEFINE_SPINLOCK(boot_lock);
 
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 1d0de30..e783618 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2012 Altera Corporation
+ *  Copyright (C) 2012-2013 Altera Corporation
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
@@ -17,6 +17,7 @@
 #include <linux/dw_apb_timer.h>
 #include <linux/of_address.h>
 #include <linux/of_irq.h>
+#include <linux/of_address.h>
 #include <linux/of_platform.h>
 
 #include <asm/hardware/cache-l2x0.h>
@@ -26,10 +27,29 @@
 
 #include "core.h"
 
-void __iomem *socfpga_scu_base_addr = ((void __iomem *)(SOCFPGA_SCU_VIRT_BASE));
+#define SOCFPGA_NR_IRQS		512
+
 void __iomem *sys_manager_base_addr;
 void __iomem *rst_manager_base_addr;
 
+#define SOCFPGA_SCU_VIRT_BASE	0xfffec000
+#define SOCFPGA_SDMMC_BASE	0xff704000
+
+void __iomem *socfpga_scu_base_addr = ((void __iomem *)(SOCFPGA_SCU_VIRT_BASE));
+
+static const struct of_dev_auxdata socfpga_auxdata_lookup[] __initconst = {
+#ifdef CONFIG_MMC_DW
+	OF_DEV_AUXDATA("snps,dw-mmc", SOCFPGA_SDMMC_BASE, "snps,dw-mmc",
+		&sdmmc_platform_data),
+#endif
+	{ /* sentinel */ }
+};
+
+const static struct of_device_id irq_match[] = {
+	{ .compatible = "arm,cortex-a9-gic", .data = gic_of_init, },
+	{}
+};
+
 static struct map_desc scu_io_desc __initdata = {
 	.virtual	= SOCFPGA_SCU_VIRT_BASE,
 	.pfn		= 0, /* run-time */
@@ -55,6 +75,23 @@ static void __init socfpga_scu_map_io(void)
 	iotable_init(&scu_io_desc, 1);
 }
 
+static void __init enable_periphs(void)
+{
+	/* Release all peripherals from reset.*/
+	__raw_writel(0, rst_manager_base_addr + SOCFPGA_MODPERRST);
+}
+
+static void __init socfpga_sysmgr_init(void)
+{
+	struct device_node *np;
+
+	np = of_find_compatible_node(NULL, NULL, "altr,sys-mgr");
+	sys_manager_base_addr = of_iomap(np, 0);
+
+	np = of_find_compatible_node(NULL, NULL, "altr,rst-mgr");
+	rst_manager_base_addr = of_iomap(np, 0);
+}
+
 static void __init socfpga_map_io(void)
 {
 	socfpga_scu_map_io();
@@ -96,6 +133,7 @@ static void __init socfpga_cyclone5_init(void)
 		socfpga_auxdata_lookup, NULL);
 
 	socfpga_init_clocks();
+	enable_periphs();
 }
 
 static const char *altera_dt_match[] = {
-- 
1.7.5.4

