From e2a5289b07fc242ec26a3b8177faceab46f9f074 Mon Sep 17 00:00:00 2001
From: Ley Foon Tan <lftan@altera.com>
Date: Mon, 12 Aug 2013 11:09:10 +0800
Subject: [PATCH 127/248] FogBugz #143478: arch/arm: Move sysid from arch to
 drivers

Removed sysid from arch/arm and read silicon ID from
system manager for soc_id and revision.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Ley Foon Tan <lftan@altera.com>
---
 arch/arm/mach-socfpga/core.h    | 10 ++++++----
 arch/arm/mach-socfpga/socfpga.c | 29 +++++++++++++----------------
 2 files changed, 19 insertions(+), 20 deletions(-)

diff --git a/arch/arm/mach-socfpga/core.h b/arch/arm/mach-socfpga/core.h
index ecd00e3..15ba46e 100644
--- a/arch/arm/mach-socfpga/core.h
+++ b/arch/arm/mach-socfpga/core.h
@@ -29,12 +29,9 @@
 #define RSTMGR_CTRL_SWWARMRSTREQ	0x2	/* Warm Reset */
 
 extern void socfpga_secondary_startup(void);
-#define SOCFPGA_SYSID_DEFAULT		0x1
+#define SOCFPGA_ID_DEFAULT		0x1
 #define SOCFPGA_REVISION_DEFAULT	0x1
 
-/* Sysid register map */
-#define SYSID_ID_REG			0x0
-
 #define SOCFPGA_RSTMGR_CTRL	0x04
 #define SOCFPGA_RSTMGR_MODPERRST	0x14
 #define SOCFPGA_RSTMGR_BRGMODRST	0x1c
@@ -49,6 +46,11 @@ extern void socfpga_secondary_startup(void);
  #define RSTMGR_MPUMODRST_SCUPER	0x8	/*SCU and periphs reset*/
  #define RSTMGR_MPUMODRST_L2		0x10	/*L2 Cache reset*/
 
+#define SYSMGR_SILICON_ID1_OFFSET 0x0
+#define SYSMGR_SILICON_ID1_REV_SHIFT 0
+#define SYSMGR_SILICON_ID1_REV_MASK 0x0000FFFF
+#define SYSMGR_SILICON_ID1_ID_SHIFT 16
+#define SYSMGR_SILICON_ID1_ID_MASK 0xFFFF0000
 #define SYSMGR_EMACGRP_CTRL_OFFSET 0x60
 #define SYSMGR_EMACGRP_CTRL_PHYSEL_ENUM_GMII_MII 0x0
 #define SYSMGR_EMACGRP_CTRL_PHYSEL_ENUM_RGMII 0x1
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 401b69b..74c04ed 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -90,12 +90,11 @@ static struct map_desc uart_io_desc __initdata = {
 static void __init socfpga_soc_device_init(void)
 {
 	struct device_node *root;
-	struct device_node *sysid_node;
 	struct soc_device *soc_dev;
 	struct soc_device_attribute *soc_dev_attr;
-	void __iomem *sysid_base;
 	const char *machine;
-	u32 id = SOCFPGA_SYSID_DEFAULT;
+	u32 id = SOCFPGA_ID_DEFAULT;
+	u32 rev = SOCFPGA_REVISION_DEFAULT;
 	int err;
 
 	root = of_find_node_by_path("/");
@@ -106,26 +105,24 @@ static void __init socfpga_soc_device_init(void)
 	if (err)
 		return;
 
+	of_node_put(root);
+
 	soc_dev_attr = kzalloc(sizeof(*soc_dev_attr), GFP_KERNEL);
 	if (!soc_dev_attr)
 		return;
 
-	sysid_node = of_find_compatible_node(root, NULL, "ALTR,sysid-1.0");
-	if (sysid_node) {
-		sysid_base = of_iomap(sysid_node, 0);
-		if (sysid_base) {
-			/* Use id from Sysid hardware. */
-			id = readl(sysid_base + SYSID_ID_REG);
-			iounmap(sysid_base);
-		}
-		of_node_put(sysid_node);
+	/* Read Silicon ID from System manager */
+	if (sys_manager_base_addr) {
+		id =  __raw_readl(sys_manager_base_addr +
+			SYSMGR_SILICON_ID1_OFFSET);
+		rev = (id & SYSMGR_SILICON_ID1_REV_MASK)
+				>> SYSMGR_SILICON_ID1_REV_SHIFT;
+		id = (id & SYSMGR_SILICON_ID1_ID_MASK)
+				>> SYSMGR_SILICON_ID1_ID_SHIFT;
 	}
 
-	of_node_put(root);
-
 	soc_dev_attr->soc_id = kasprintf(GFP_KERNEL, "%u", id);
-	soc_dev_attr->revision = kasprintf(GFP_KERNEL, "%d",
-		SOCFPGA_REVISION_DEFAULT);
+	soc_dev_attr->revision = kasprintf(GFP_KERNEL, "%d", rev);
 	soc_dev_attr->machine = kasprintf(GFP_KERNEL, "%s", machine);
 	soc_dev_attr->family = "SOCFPGA";
 
-- 
1.9.1

