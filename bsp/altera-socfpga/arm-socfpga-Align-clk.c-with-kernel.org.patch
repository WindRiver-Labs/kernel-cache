From bd0ef41043a0a83d591e2c5d1ecae5c29541b47f Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Thu, 18 Apr 2013 17:52:41 -0500
Subject: [PATCH 229/254] arm: socfpga: Align clk.c with kernel.org

Upstream: git://git.rocketboards.org/linux-socfpga.git

Align the clk.c to kernel.org's version. This version is even simpler than
initial because it uses the common clk_gate structure for simple clock
gating.

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
(cherry picked from commit c6a7d691f9c9ba953b1a6d685bd3101103d93db1)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/clk/socfpga/clk.c |   84 ++++++++++++++------------------------------
 1 files changed, 27 insertions(+), 57 deletions(-)

diff --git a/drivers/clk/socfpga/clk.c b/drivers/clk/socfpga/clk.c
index e193431..ebb29ee 100644
--- a/drivers/clk/socfpga/clk.c
+++ b/drivers/clk/socfpga/clk.c
@@ -1,4 +1,5 @@
 /*
+ *  Copyright 2011-2012 Calxeda, Inc.
  *  Copyright (C) 2012-2013 Altera Corporation <www.altera.com>
  *
  * This program is free software; you can redistribute it and/or modify
@@ -23,23 +24,8 @@
 #include <linux/of.h>
 #include <linux/of_address.h>
 
-#define CLKMGR_PERPLLGRP_EN	0xA0
-
-#define CLKMGR_QSPI_CLK_EN				11
-#define CLKMGR_NAND_CLK_EN				10
-#define CLKMGR_NAND_X_CLK_EN			9
-#define CLKMGR_SDMMC_CLK_EN			8
-#define CLKMGR_S2FUSR_CLK_EN			7
-#define CLKMGR_GPIO_CLK_EN				6
-#define CLKMGR_CAN1_CLK_EN				5
-#define CLKMGR_CAN0_CLK_EN				4
-#define CLKMGR_SPI_M_CLK_EN			3
-#define CLKMGR_USB_MP_CLK_EN			2
-#define CLKMGR_EMAC1_CLK_EN			1
-#define CLKMGR_EMAC0_CLK_EN			0
-
 /* Clock Manager offsets */
-#define CLKMGR_CTRL	0x0
+#define CLKMGR_CTRL    0x0
 #define CLKMGR_BYPASS 0x4
 
 /* Clock bypass bits */
@@ -49,45 +35,23 @@
 #define PERPLL_BYPASS (1<<3)
 #define PERPLL_SRC_BYPASS (1<<4)
 
-#define SOCFPGA_PLL_BG_PWRDWN	0x00000001
-#define SOCFPGA_PLL_EXT_ENA	0x00000002
-#define SOCFPGA_PLL_PWR_DOWN	0x00000004
-#define SOCFPGA_PLL_DIVF_MASK 0x0000FFF8
-#define SOCFPGA_PLL_DIVF_SHIFT 3
-#define SOCFPGA_PLL_DIVQ_MASK 0x003F0000
-#define SOCFPGA_PLL_DIVQ_SHIFT 16
+#define SOCFPGA_PLL_BG_PWRDWN		0
+#define SOCFPGA_PLL_EXT_ENA		1
+#define SOCFPGA_PLL_PWR_DOWN		2
+#define SOCFPGA_PLL_DIVF_MASK		0x0000FFF8
+#define SOCFPGA_PLL_DIVF_SHIFT	3
+#define SOCFPGA_PLL_DIVQ_MASK		0x003F0000
+#define SOCFPGA_PLL_DIVQ_SHIFT	16
 
 extern void __iomem *clk_mgr_base_addr;
 
 struct socfpga_clk {
-	struct clk_hw hw;
-	void __iomem	*reg;
+	struct clk_gate hw;
 	char *parent_name;
+	char *clk_name;
 	u32 fixed_div;
 };
-#define to_socfpga_clk(p) container_of(p, struct socfpga_clk, hw)
-
-static int clk_pll_enable(struct clk_hw *hwclk)
-{
-	struct socfpga_clk *socfpgaclk = to_socfpga_clk(hwclk);
-	u32 reg;
-
-	reg = readl(socfpgaclk->reg);
-	reg |= SOCFPGA_PLL_EXT_ENA;
-	writel(reg, socfpgaclk->reg);
-
-	return 0;
-}
-
-static void clk_pll_disable(struct clk_hw *hwclk)
-{
-	struct socfpga_clk *socfpgaclk = to_socfpga_clk(hwclk);
-	u32 reg;
-
-	reg = readl(socfpgaclk->reg);
-	reg &= ~SOCFPGA_PLL_EXT_ENA;
-	writel(reg, socfpgaclk->reg);
-}
+#define to_socfpga_clk(p) container_of(p, struct socfpga_clk, hw.hw)
 
 static unsigned long clk_pll_recalc_rate(struct clk_hw *hwclk,
 					 unsigned long parent_rate)
@@ -96,7 +60,7 @@ static unsigned long clk_pll_recalc_rate(struct clk_hw *hwclk,
 	unsigned long divf, divq, vco_freq, reg;
 	unsigned long bypass;
 
-	reg = readl(socfpgaclk->reg);
+	reg = readl(socfpgaclk->hw.reg);
 	bypass = readl(clk_mgr_base_addr + CLKMGR_BYPASS);
 	if (bypass & MAINPLL_BYPASS)
 		return parent_rate;
@@ -108,9 +72,7 @@ static unsigned long clk_pll_recalc_rate(struct clk_hw *hwclk,
 }
 
 
-static const struct clk_ops clk_pll_ops = {
-	.enable = clk_pll_enable,
-	.disable = clk_pll_disable,
+static struct clk_ops clk_pll_ops = {
 	.recalc_rate = clk_pll_recalc_rate,
 };
 
@@ -123,7 +85,7 @@ static unsigned long clk_periclk_recalc_rate(struct clk_hw *hwclk,
 	if (socfpgaclk->fixed_div)
 		div = socfpgaclk->fixed_div;
 	else
-		div = ((readl(socfpgaclk->reg) & 0x1ff) + 1);
+		div = ((readl(socfpgaclk->hw.reg) & 0x1ff) + 1);
 
 	return parent_rate / div;
 }
@@ -132,7 +94,8 @@ static const struct clk_ops periclk_ops = {
 	.recalc_rate = clk_periclk_recalc_rate,
 };
 
-static __init struct clk *socfpga_clk_init(struct device_node *node, const struct clk_ops *ops)
+static __init struct clk *socfpga_clk_init(struct device_node *node,
+	const struct clk_ops *ops)
 {
 	u32 reg;
 	struct clk *clk;
@@ -151,7 +114,7 @@ static __init struct clk *socfpga_clk_init(struct device_node *node, const struc
 	if (WARN_ON(!socfpga_clk))
 		return NULL;
 
-	socfpga_clk->reg = clk_mgr_base_addr + reg;
+	socfpga_clk->hw.reg = clk_mgr_base_addr + reg;
 
 	rc = of_property_read_u32(node, "fixed-divider", &fixed_div);
 	if (rc)
@@ -168,9 +131,16 @@ static __init struct clk *socfpga_clk_init(struct device_node *node, const struc
 	init.parent_names = &parent_name;
 	init.num_parents = 1;
 
-	socfpga_clk->hw.init = &init;
+	socfpga_clk->hw.hw.init = &init;
+
+	if ((strcmp(clk_name, "main_pll") == 0) || (strcmp(clk_name, "periph_pll") == 0)||
+			(strcmp(clk_name, "sdram_pll") == 0))  {
+		socfpga_clk->hw.bit_idx = SOCFPGA_PLL_EXT_ENA;
+		clk_pll_ops.enable = clk_gate_ops.enable;
+		clk_pll_ops.disable = clk_gate_ops.disable;
+	}
 
-	clk = clk_register(NULL, &socfpga_clk->hw);
+	clk = clk_register(NULL, &socfpga_clk->hw.hw);
 	if (WARN_ON(IS_ERR(clk))) {
 		kfree(socfpga_clk);
 		return NULL;
-- 
1.7.5.4

