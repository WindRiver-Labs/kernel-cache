From 8a4342b75fa617f3ae0d3c26494f5a82154fb0ba Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Wed, 17 Oct 2012 07:37:01 -0500
Subject: [PATCH 145/254] i2c: designware: Add changes required for SOCFPGA

Upstream: git://git.rocketboards.org/linux-socfpga.git

-Add changes needed for i2c-dw controller on socfpga.

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
(cherry picked from commit 87e57c1c278c546e594b644c834a1b3343787b8d)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/i2c/busses/i2c-designware-core.c |   21 ++++++++++++++++-----
 1 files changed, 16 insertions(+), 5 deletions(-)

diff --git a/drivers/i2c/busses/i2c-designware-core.c b/drivers/i2c/busses/i2c-designware-core.c
index f5258c2..901c38a 100644
--- a/drivers/i2c/busses/i2c-designware-core.c
+++ b/drivers/i2c/busses/i2c-designware-core.c
@@ -382,7 +382,6 @@ i2c_dw_xfer_msg(struct dw_i2c_dev *dev)
 	u8 *buf = dev->tx_buf;
 
 	intr_mask = DW_IC_INTR_DEFAULT_MASK;
-
 	for (; dev->msg_write_idx < dev->msgs_num; dev->msg_write_idx++) {
 		/*
 		 * if target address has changed, we need to
@@ -413,11 +412,21 @@ i2c_dw_xfer_msg(struct dw_i2c_dev *dev)
 		rx_limit = dev->rx_fifo_depth - dw_readl(dev, DW_IC_RXFLR);
 
 		while (buf_len > 0 && tx_limit > 0 && rx_limit > 0) {
+			int msg_idx = dev->msg_write_idx + dev->msg_read_idx+1;
 			if (msgs[dev->msg_write_idx].flags & I2C_M_RD) {
-				dw_writel(dev, 0x100, DW_IC_DATA_CMD);
+				if(buf_len > 1 || msg_idx < dev->msgs_num)
+					dw_writel(dev, 0x100, DW_IC_DATA_CMD);
+				else
+					dw_writel(dev, 0x100|0x200,
+						DW_IC_DATA_CMD);
 				rx_limit--;
-			} else
-				dw_writel(dev, *buf++, DW_IC_DATA_CMD);
+			} else {
+				if(buf_len > 1 || msg_idx < dev->msgs_num)
+					dw_writel(dev, *buf++, DW_IC_DATA_CMD);
+				else
+					dw_writel(dev, *buf++|0x200,
+						DW_IC_DATA_CMD);
+			}
 			tx_limit--; buf_len--;
 		}
 
@@ -648,8 +657,10 @@ irqreturn_t i2c_dw_isr(int this_irq, void *dev_id)
 	stat = dw_readl(dev, DW_IC_RAW_INTR_STAT);
 	dev_dbg(dev->dev, "%s:  %s enabled= 0x%x stat=0x%x\n", __func__,
 		dev->adapter.name, enabled, stat);
-	if (!enabled || !(stat & ~DW_IC_INTR_ACTIVITY))
+	if (!enabled || !(stat & ~DW_IC_INTR_ACTIVITY)) {
+		i2c_dw_read_clear_intrbits(dev);
 		return IRQ_NONE;
+	}
 
 	stat = i2c_dw_read_clear_intrbits(dev);
 
-- 
1.7.5.4

