From ee3ebc816997f479e25f75d0bbd08a3967df9b03 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Wed, 22 May 2013 10:27:08 -0500
Subject: [PATCH 089/248] FogBugz #125555: Upgrade to v3.9

Upgrade the SoCFPGA Linux support to v3.9. Alignment with kernel.org's support
for SoCFPGA.

- status = "disabled" goes into dtsi files
- use the syscon driver for dw_mmc-socfpga.

[Original patch taken from
git://git.rocketboards.org/linux-socfpga.git socfpga-3.14]

Signed-off-by: Yanjiang Jin <yanjiang.jin@windriver.com>
Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
---
 .../devicetree/bindings/mmc/socfpga-dw-mshc.txt    |   3 +-
 arch/arm/boot/dts/socfpga.dtsi                     |   8 +-
 arch/arm/boot/dts/socfpga_cyclone5.dtsi            | 149 ++++++++++----------
 arch/arm/boot/dts/socfpga_ice.dts                  | 144 ++++++++------------
 arch/arm/boot/dts/socfpga_vt.dts                   | 151 ++++++++++-----------
 arch/arm/mach-socfpga/platsmp.c                    |   2 +-
 arch/arm/mach-socfpga/socfpga.c                    |  40 ++----
 drivers/mmc/host/dw_mmc-socfpga.c                  |   3 +-
 8 files changed, 212 insertions(+), 288 deletions(-)

diff --git a/Documentation/devicetree/bindings/mmc/socfpga-dw-mshc.txt b/Documentation/devicetree/bindings/mmc/socfpga-dw-mshc.txt
index f4fda57..c86dc07 100644
--- a/Documentation/devicetree/bindings/mmc/socfpga-dw-mshc.txt
+++ b/Documentation/devicetree/bindings/mmc/socfpga-dw-mshc.txt
@@ -8,7 +8,8 @@ Required Properties:
 	  specific extentions.
 
 * altr,dw-mshc-ciu-div: Specifies the divider value for the card interface
-  unit (ciu) clock. For Altera's SOCFPGA, the divider value is fixed at 4.
+  unit (ciu) clock. The value should be (n-1). For Altera's SOCFPGA,
+  the divider value is fixed at 3, which means parent_clock/4.
 
 * altr,dw-mshc-sdr-timing: Specifies the value of CIU clock phase shift value
   in transmit mode and CIU clock phase shift value in receive mode for single
diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index dba2da8..3b213c9 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -477,8 +477,6 @@
 			clocks = <&emac0_clk>;
 			clock-names = "stmmaceth";
 			status = "disabled";
-			clocks = <&emac0_clk>;
-			clock-names = "stmmaceth";
 		};
 
 		gmac1: ethernet@ff702000 {
@@ -490,8 +488,6 @@
 			clocks = <&emac1_clk>;
 			clock-names = "stmmaceth";
 			status = "disabled";
-			clocks = <&emac1_clk>;
-			clock-names = "stmmaceth";
 		};
 
 		gpio0: gpio@ff708000 {
@@ -680,7 +676,7 @@
 		};
 		
 		sysmgr@ffd08000 {
-			compatible = "altr,sys-mgr";
+			compatible = "altr,sys-mgr", "syscon";
 			reg = <0xffd08000 0x4000>;
 		};
 
@@ -744,6 +740,7 @@
 				512 512 512 512 512 512 512 512 512>;
 			dev-tx-fifo-size = <512 512 512 512 512 512
 				512 512 512 512 512 512 512 512 512>;
+			status = "disabled";
 		};
 
 		usb1: usb@ffb40000 {
@@ -758,6 +755,7 @@
 				512 512 512 512 512 512 512 512 512>;
 			dev-tx-fifo-size = <512 512 512 512 512 512
 				512 512 512 512 512 512 512 512 512>;
+			status = "disabled";
 		};
 	};
 };
diff --git a/arch/arm/boot/dts/socfpga_cyclone5.dtsi b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
index 65f5913..1f4731b 100644
--- a/arch/arm/boot/dts/socfpga_cyclone5.dtsi
+++ b/arch/arm/boot/dts/socfpga_cyclone5.dtsi
@@ -52,7 +52,7 @@
 			num-slots = <1>;
 			supports-highspeed;
 			broken-cd;
-			altr,dw-mshc-ciu-div = <4>;
+			altr,dw-mshc-ciu-div = <3>;
 			altr,dw-mshc-sdr-timing = <0 3>;
 
 			slot@0 {
@@ -61,6 +61,78 @@
 			};
 		};
 
+		ethernet@ff702000 {
+			phy-mode = "rgmii";
+			phy-addr = <0xffffffff>; /* probe for phy addr */
+			status = "okay";
+		};
+
+		i2c0: i2c@ffc04000 {
+			speed-mode = <0>;
+			status = "okay";
+		};
+
+		qspi: spi@ff705000 {
+			compatible = "cadence,qspi";
+                        #address-cells = <1>;
+			#size-cells = <0>;
+			reg = <0xff705000 0x1000>,
+				<0xffa00000 0x1000>;
+			interrupts = <0 151 4>;
+			master-ref-clk = <400000000>;
+			ext-decoder = <0>;  /* external decoder */
+			num-chipselect = <4>;
+			fifo-depth = <128>;
+			bus-num = <2>;
+
+			flash0: n25q00@0 {
+				#address-cells = <1>;
+				#size-cells = <1>;
+				compatible = "n25q00";
+				reg = <0>;      /* chip select */
+				spi-max-frequency = <100000000>;
+				page-size = <256>;
+				block-size = <16>; /* 2^16, 64KB */
+				quad = <1>;        /* 1-support quad */
+				tshsl-ns = <200>;
+				tsd2d-ns = <255>;
+				tchsh-ns = <20>;
+				tslch-ns = <20>;
+
+				partition@0 {
+					/* 8MB for raw data. */
+					label = "Flash 0 Raw Data";
+					reg = <0x0 0x800000>;
+				};
+				partition@800000 {
+					/* 8MB for jffs2 data. */
+					label = "Flash 0 jffs2 Filesystem";
+					reg = <0x800000 0x800000>;
+				};
+			};
+
+			flash1: n25q128@1 {
+				#address-cells = <1>;
+				#size-cells = <1>;
+				compatible = "n25q128";
+				reg = <1>;      /* chip select */
+				spi-max-frequency = <100000000>;
+				page-size = <256>;
+				block-size = <16>; /* 2^16, 64KB */
+				quad = <1>;
+				tshsl-ns = <200>;
+				tsd2d-ns = <255>;
+				tchsh-ns = <20>;
+				tslch-ns = <20>;
+
+				partition@0 {
+					/* 16MB for user data. */
+					label = "Flash 1 User Data";
+					reg = <0x0 0x1000000>;
+				};
+			};
+		};
+
 		timer0@ffc08000 {
 			clock-frequency = <100000000>;
 		};
@@ -89,83 +161,8 @@
 			cpu1-start-addr = <0xffd080c4>;
 		};
 
-		ethernet@ff702000 {
-			phy-mode = "rgmii";
-			phy-addr = <0xffffffff>; /* probe for phy addr */
-			status = "okay";
-		};
-
-		qspi: spi@ff705000 {
-				compatible = "cadence,qspi";
-				#address-cells = <1>;
-				#size-cells = <0>;
-				reg = <0xff705000 0x1000>,
-					<0xffa00000 0x1000>;
-				interrupts = <0 151 4>;
-				master-ref-clk = <400000000>;
-				ext-decoder = <0>;  /* external decoder */
-				num-chipselect = <4>;
-				fifo-depth = <128>;
-				bus-num = <2>;
-
-				flash0: n25q00@0 {
-					#address-cells = <1>;
-					#size-cells = <1>;
-					compatible = "n25q00";
-					reg = <0>;	/* chip select */
-					spi-max-frequency = <100000000>;
-					page-size = <256>;
-					block-size = <16>; /* 2^16, 64KB */
-					quad = <1>;	   /* 1-support quad */
-					tshsl-ns = <200>;
-					tsd2d-ns = <255>;
-					tchsh-ns = <20>;
-					tslch-ns = <20>;
-
-					partition@0 {
-						/* 8MB for raw data. */
-						label = "Flash 0 Raw Data";
-						reg = <0x0 0x800000>;
-					};
-					partition@800000 {
-						/* 8MB for jffs2 data. */
-						label = "Flash 0 jffs2 Filesystem";
-						reg = <0x800000 0x800000>;
-					};
-				};
-
-				flash1: n25q128@1 {
-					#address-cells = <1>;
-					#size-cells = <1>;
-					compatible = "n25q128";
-					reg = <1>;	/* chip select */
-					spi-max-frequency = <100000000>;
-					page-size = <256>;
-					block-size = <16>; /* 2^16, 64KB */
-					quad = <1>;
-					tshsl-ns = <200>;
-					tsd2d-ns = <255>;
-					tchsh-ns = <20>;
-					tslch-ns = <20>;
-
-					partition@0 {
-						/* 16MB for user data. */
-						label = "Flash 1 User Data";
-						reg = <0x0 0x1000000>;
-					};
-				};
-		};
-
-		usb0: usb@ffb00000 {
-			status = "disabled";
-		};
-
 		usb1: usb@ffb40000 {
 			ulpi-ddr = <0>;
-		};
-
-		i2c0: i2c@ffc04000 {
-			speed-mode = <0>;
 			status = "okay";
 		};
 
diff --git a/arch/arm/boot/dts/socfpga_ice.dts b/arch/arm/boot/dts/socfpga_ice.dts
index 7fededc..5b6cebe 100644
--- a/arch/arm/boot/dts/socfpga_ice.dts
+++ b/arch/arm/boot/dts/socfpga_ice.dts
@@ -41,94 +41,66 @@
 			};
 		};
 
-		dcan0: d_can@ffc00000 {
-			status = "disabled";
-		};
-
-		dcan1: d_can@ffc10000 {
-			status = "disabled";
-		};
-
-		ethernet@ff700000 {
-			status = "disabled";
-		};
-
-		ethernet@ff702000 {
-			status = "disabled";
-		};
-
-		i2c1: i2c@ffc05000 {
-			status = "disabled";
- 		};
-
-		i2c2: i2c@ffc06000 {
-			status = "disabled";
-		};
-
-		i2c3: i2c@ffc07000 {
-			status = "disabled";
-		};
-
 		qspi: spi@ff705000 {
-				compatible = "cadence,qspi";
+			compatible = "cadence,qspi";
+			#address-cells = <1>;
+			#size-cells = <0>;
+			reg = <0xff705000 0x1000>,
+				<0xffa00000 0x1000>;
+			interrupts = <0 151 4>;
+			master-ref-clk = <400000000>;
+			ext-decoder = <0>;  /* external decoder */
+			num-chipselect = <4>;
+			fifo-depth = <128>;
+			bus-num = <2>;
+
+			flash0: n25q128@0 {
 				#address-cells = <1>;
-				#size-cells = <0>;
-				reg = <0xff705000 0x1000>,
-					<0xffa00000 0x1000>;
-				interrupts = <0 151 4>;
-				master-ref-clk = <400000000>;
-				ext-decoder = <0>;  /* external decoder */
-				num-chipselect = <4>;
-				fifo-depth = <128>;
-				bus-num = <2>;
-
-				flash0: n25q128@0 {
-					#address-cells = <1>;
-					#size-cells = <1>;
-					compatible = "n25q128";
-					reg = <0>;	/* chip select */
-					spi-max-frequency = <100000000>;
-					page-size = <256>;
-					block-size = <16>; /* 2^16, 64KB */
-					quad = <1>;	   /* 1-support quad */
-					tshsl-ns = <200>;
-					tsd2d-ns = <255>;
-					tchsh-ns = <20>;
-					tslch-ns = <20>;
-
-					partition@0 {
-						/* 8MB for raw data. */
-						label = "Flash 0 Raw Data";
-						reg = <0x0 0x800000>;
-					};
-					partition@800000 {
-						/* 8MB for jffs2 data. */
-						label = "Flash 0 jffs2 Filesystem";
-						reg = <0x800000 0x800000>;
-					};
+				#size-cells = <1>;
+				compatible = "n25q128";
+				reg = <0>;	/* chip select */
+				spi-max-frequency = <100000000>;
+				page-size = <256>;
+				block-size = <16>; /* 2^16, 64KB */
+				quad = <1>;	   /* 1-support quad */
+				tshsl-ns = <200>;
+				tsd2d-ns = <255>;
+				tchsh-ns = <20>;
+				tslch-ns = <20>;
+
+				partition@0 {
+					/* 8MB for raw data. */
+					label = "Flash 0 Raw Data";
+					reg = <0x0 0x800000>;
 				};
+				partition@800000 {
+					/* 8MB for jffs2 data. */
+					label = "Flash 0 jffs2 Filesystem";
+					reg = <0x800000 0x800000>;
+				};
+			};
 
-				flash1: n25q128@1 {
-					#address-cells = <1>;
-					#size-cells = <1>;
-					compatible = "n25q128";
-					reg = <1>;	/* chip select */
-					spi-max-frequency = <100000000>;
-					page-size = <256>;
-					block-size = <16>; /* 2^16, 64KB */
-					quad = <1>;
-					tshsl-ns = <200>;
-					tsd2d-ns = <255>;
-					tchsh-ns = <20>;
-					tslch-ns = <20>;
-
-					partition@0 {
-						/* 16MB for user data. */
-						label = "Flash 1 User Data";
-						reg = <0x0 0x1000000>;
-					};
+			flash1: n25q128@1 {
+				#address-cells = <1>;
+				#size-cells = <1>;
+				compatible = "n25q128";
+				reg = <1>;	/* chip select */
+				spi-max-frequency = <100000000>;
+				page-size = <256>;
+				block-size = <16>; /* 2^16, 64KB */
+				quad = <1>;
+				tshsl-ns = <200>;
+				tsd2d-ns = <255>;
+				tchsh-ns = <20>;
+				tslch-ns = <20>;
+
+				partition@0 {
+					/* 16MB for user data. */
+					label = "Flash 1 User Data";
+					reg = <0x0 0x1000000>;
 				};
 			};
+		};
 
 		sysmgr@ffd08000 {
 			cpu1-start-addr = <0xffd080c4>;
@@ -150,14 +122,6 @@
 			clock-frequency = <19290>;
 		};
 
-		usb0: usb@ffb00000 {
-                       ulpi-ddr = <0>;
-                };
-
-                usb1: usb@ffb40000 {
-                       ulpi-ddr = <0>;
-                };
-
 		serial0@ffc02000 {
 			clock-frequency = <77161>;
 		};
diff --git a/arch/arm/boot/dts/socfpga_vt.dts b/arch/arm/boot/dts/socfpga_vt.dts
index b5cbf68..53684fc 100644
--- a/arch/arm/boot/dts/socfpga_vt.dts
+++ b/arch/arm/boot/dts/socfpga_vt.dts
@@ -52,7 +52,73 @@
 				reg = <0>;
 				bus-width = <4>;
 			};
-		};		
+		};
+
+		ethernet@ff700000 {
+			phy-mode = "gmii";
+			status = "okay";
+		};
+
+		qspi: spi@ff705000 {
+			compatible = "cadence,qspi";
+			#address-cells = <1>;
+			#size-cells = <0>;
+			reg = <0xff705000 0x1000>,
+				<0xffa00000 0x1000>;
+			interrupts = <0 151 4>;
+			master-ref-clk = <400000000>;
+			ext-decoder = <0>;  /* external decoder */
+			num-chipselect = <4>;
+			fifo-depth = <128>;
+			bus-num = <2>;
+
+			flash0: n25q128@0 {
+				#address-cells = <1>;
+				#size-cells = <1>;
+				compatible = "n25q128";
+				reg = <0>;      /* chip select */
+				spi-max-frequency = <100000000>;
+				page-size = <256>;
+				block-size = <16>; /* 2^16, 64KB */
+				quad = <1>;        /* 1-support quad */
+				tshsl-ns = <200>;
+				tsd2d-ns = <255>;
+				tchsh-ns = <20>;
+				tslch-ns = <20>;
+
+				partition@0 {
+					/* 8MB for raw data. */
+					label = "Flash 0 Raw Data";
+					reg = <0x0 0x800000>;
+				};
+				partition@800000 {
+					/* 8MB for jffs2 data. */
+					label = "Flash 0 jffs2 Filesystem";
+					reg = <0x800000 0x800000>;
+				};
+			};
+
+			flash1: n25q128@1 {
+				#address-cells = <1>;
+				#size-cells = <1>;
+				compatible = "n25q128";
+				reg = <1>;      /* chip select */
+				spi-max-frequency = <100000000>;
+				page-size = <256>;
+				block-size = <16>; /* 2^16, 64KB */
+				quad = <1>;
+				tshsl-ns = <200>;
+				tsd2d-ns = <255>;
+				tchsh-ns = <20>;
+				tslch-ns = <20>;
+
+				partition@0 {
+					/* 16MB for user data. */
+					label = "Flash 1 User Data";
+					reg = <0x0 0x1000000>;
+				};
+			};
+		};
 
 		timer0@ffc08000 {
 			clock-frequency = <7000000>;
@@ -82,86 +148,9 @@
 			cpu1-start-addr = <0xffd08010>;
 		};
 
-		ethernet@ff700000 {
-			phy-mode = "gmii";
+		usb0: usb@ffb00000 {
+			ulpi-ddr = <0>;
 			status = "okay";
 		};
-
-		ethernet@ff702000 {
-			status = "disabled";
-		};
-
-		i2c1: i2c@ffc05000 {
-			status = "disabled";
-		};
-
-		i2c2: i2c@ffc06000 {
-			status = "disabled";
-		};
-
-		i2c3: i2c@ffc07000 {
-			status = "disabled";
-		};
-
-		qspi: spi@ff705000 {
-				compatible = "cadence,qspi";
-				#address-cells = <1>;
-				#size-cells = <0>;
-				reg = <0xff705000 0x1000>,
-					<0xffa00000 0x1000>;
-				interrupts = <0 151 4>;
-				master-ref-clk = <400000000>;
-				ext-decoder = <0>;  /* external decoder */
-				num-chipselect = <4>;
-				fifo-depth = <128>;
-				bus-num = <2>;
-
-				flash0: n25q128@0 {
-					#address-cells = <1>;
-					#size-cells = <1>;
-					compatible = "n25q128";
-					reg = <0>;	/* chip select */
-					spi-max-frequency = <100000000>;
-					page-size = <256>;
-					block-size = <16>; /* 2^16, 64KB */
-					quad = <1>;	   /* 1-support quad */
-					tshsl-ns = <200>;
-					tsd2d-ns = <255>;
-					tchsh-ns = <20>;
-					tslch-ns = <20>;
-
-					partition@0 {
-						/* 8MB for raw data. */
-						label = "Flash 0 Raw Data";
-						reg = <0x0 0x800000>;
-					};
-					partition@800000 {
-						/* 8MB for jffs2 data. */
-						label = "Flash 0 jffs2 Filesystem";
-						reg = <0x800000 0x800000>;
-					};
-				};
-
-				flash1: n25q128@1 {
-					#address-cells = <1>;
-					#size-cells = <1>;
-					compatible = "n25q128";
-					reg = <1>;	/* chip select */
-					spi-max-frequency = <100000000>;
-					page-size = <256>;
-					block-size = <16>; /* 2^16, 64KB */
-					quad = <1>;
-					tshsl-ns = <200>;
-					tsd2d-ns = <255>;
-					tchsh-ns = <20>;
-					tslch-ns = <20>;
-
-					partition@0 {
-						/* 16MB for user data. */
-						label = "Flash 1 User Data";
-						reg = <0x0 0x1000000>;
-					};
-				};
-			};
-		};
+	};
 };
diff --git a/arch/arm/mach-socfpga/platsmp.c b/arch/arm/mach-socfpga/platsmp.c
index c2f650b..b29f2c1 100644
--- a/arch/arm/mach-socfpga/platsmp.c
+++ b/arch/arm/mach-socfpga/platsmp.c
@@ -46,7 +46,7 @@ static int socfpga_boot_secondary(unsigned int cpu, struct task_struct *idle)
 	if (cpu1start_addr) {
 		memcpy(phys_to_virt(0), &secondary_trampoline, trampoline_size);
 
-		__raw_writel(virt_to_phys(v7_secondary_startup),
+		__raw_writel(virt_to_phys(socfpga_secondary_startup),
 			(sys_manager_base_addr+(cpu1start_addr & 0x000000ff)));
 
 		flush_cache_all();
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 23bd910..4ed6736 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -77,11 +77,6 @@ static const struct of_dev_auxdata socfpga_auxdata_lookup[] __initconst = {
 	{ /* sentinel */ }
 };
 
-const static struct of_device_id irq_match[] = {
-	{ .compatible = "arm,cortex-a9-gic", .data = gic_of_init, },
-	{}
-};
-
 static struct map_desc scu_io_desc __initdata = {
 	.virtual	= SOCFPGA_SCU_VIRT_BASE,
 	.pfn		= 0, /* run-time */
@@ -273,6 +268,13 @@ static int stmmac_plat_init(struct platform_device *pdev)
 	return 0;
 }
 
+static void __init socfpga_map_io(void)
+{
+	socfpga_scu_map_io();
+	debug_ll_io_init();
+	early_printk("Early printk initialized\n");
+}
+
 static void __init socfpga_sysmgr_init(void)
 {
 	struct device_node *np;
@@ -309,33 +311,7 @@ static void __init socfpga_sysmgr_init(void)
 	WARN_ON(!clk_mgr_base_addr);
 }
 
-static void __init socfpga_map_io(void)
-{
-	socfpga_scu_map_io();
-	debug_ll_io_init();
-	early_printk("Early printk initialized\n");
-}
-
-void __init socfpga_sysmgr_init(void)
-{
-	struct device_node *np;
-
-	np = of_find_compatible_node(NULL, NULL, "altr,sys-mgr");
-
-	if (of_property_read_u32(np, "cpu1-start-addr",
-			(u32 *) &cpu1start_addr))
-		pr_err("SMP: Need cpu1-start-addr in device tree.\n");
-
-	sys_manager_base_addr = of_iomap(np, 0);
-
-	np = of_find_compatible_node(NULL, NULL, "altr,rst-mgr");
-	rst_manager_base_addr = of_iomap(np, 0);
-
-	np = of_find_compatible_node(NULL, NULL, "altr,clk-mgr");
-	clk_mgr_base_addr = of_iomap(np, 0);
-}
-
-static void __init gic_init_irq(void)
+static void __init socfpga_init_irq(void)
 {
 	irqchip_init();
 	socfpga_sysmgr_init();
diff --git a/drivers/mmc/host/dw_mmc-socfpga.c b/drivers/mmc/host/dw_mmc-socfpga.c
index d67fd7f..8cfb301 100644
--- a/drivers/mmc/host/dw_mmc-socfpga.c
+++ b/drivers/mmc/host/dw_mmc-socfpga.c
@@ -29,12 +29,11 @@
 #define SYSMGR_SDMMC_CTRL_SET(smplsel, drvsel)		\
 	((((drvsel) << 0) & 0x7) | (((smplsel) << 3) & 0x38))
 
-extern void __iomem *sys_manager_base_addr;
-
 /* SOCFPGA implementation specific driver private data */
 struct dw_mci_socfpga_priv_data {
 	u8	ciu_div;
 	u32	hs_timing;
+	struct regmap   *sysreg;
 };
 
 static int dw_mci_socfpga_priv_init(struct dw_mci *host)
-- 
1.9.1

