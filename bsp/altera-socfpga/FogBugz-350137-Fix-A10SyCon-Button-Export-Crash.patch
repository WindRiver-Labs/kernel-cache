From d9758d3491f7939a84b65b1def1693c3a51bd0bf Mon Sep 17 00:00:00 2001
From: Thor Thayer <tthayer@opensource.altera.com>
Date: Tue, 26 Jan 2016 13:27:07 -0600
Subject: [PATCH 47/73] FogBugz #350137: Fix A10SyCon Button Export Crash

Exporting the A10Sycon buttons would cause a kernel crash. The root
cause was that the interrupt was not mapped but was being accessed.
In part this was because the GPIO bank that handled the Button was
disabled but this should be handled gracefully.

Check for a valid IRQ each time and exit if not valid.

Signed-off-by: Thor Thayer <tthayer@opensource.altera.com>
[mli1:Original patch taken from
https://github.com/altera-opensource/linux-socfpga.git socfpga-4.1-ltsi]
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/mfd/a10sycon-irq.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/drivers/mfd/a10sycon-irq.c b/drivers/mfd/a10sycon-irq.c
index bffb6f5..a2bbadd 100644
--- a/drivers/mfd/a10sycon-irq.c
+++ b/drivers/mfd/a10sycon-irq.c
@@ -77,6 +77,10 @@ static struct regmap_irq_chip a10sycon_regmap_irq_chip = {
 
 int a10sycon_map_irq(struct a10sycon *a10sc, int irq)
 {
+	if (!a10sc->chip_irq) {
+		dev_err(a10sc->dev, "Chip IRQ not enabled.\n");
+		return -EINVAL;
+	}
 	return regmap_irq_get_virq(a10sc->irq_data, irq);
 }
 EXPORT_SYMBOL_GPL(a10sycon_map_irq);
@@ -144,6 +148,10 @@ int a10sycon_irq_init(struct a10sycon *a10sc)
 {
 	int ret;
 
+	if (!a10sc->chip_irq) {
+		dev_err(a10sc->dev, "Invalid Chip IRQ err\n");
+		return -ENODEV;
+	}
 	ret = regmap_add_irq_chip(a10sc->regmap, a10sc->chip_irq,
 				  IRQF_TRIGGER_LOW | IRQF_ONESHOT | IRQF_SHARED,
 				  -1, &a10sycon_regmap_irq_chip,
-- 
1.7.5.4

