From dbf73b2b84580e072e1a5a3a78cc132409032265 Mon Sep 17 00:00:00 2001
From: Yang Wei <Wei.Yang@windriver.com>
Date: Mon, 28 Apr 2014 16:44:38 +0800
Subject: [PATCH 23/24] usb/dwc2: register gadget device in s3c-hsotg

Since in 3.4 kernel udc core does not register udc device, so
we have to perform it in udc driver.

Signed-off-by: Yang Wei <Wei.Yang@windriver.com>
---
 drivers/usb/dwc2/s3c-hsotg.c |   13 +++++++++++++
 1 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/dwc2/s3c-hsotg.c b/drivers/usb/dwc2/s3c-hsotg.c
index 4b28d2e..da84bbc 100644
--- a/drivers/usb/dwc2/s3c-hsotg.c
+++ b/drivers/usb/dwc2/s3c-hsotg.c
@@ -3247,6 +3247,10 @@ int dwc2_gadget_init(struct dwc2_hsotg *dwc2, int irq)
 	dwc2->gadget.ops = &s3c_hsotg_gadget_ops;
 	dwc2->gadget.name = dev_name(dev);
 
+	dwc2->gadget.dev.parent = dev;
+	dwc2->gadget.dev.dma_mask = dev->dma_mask;
+
+
 	/* reset the system */
 
 	clk_prepare_enable(dwc2->s3c_hsotg->clk);
@@ -3325,6 +3329,15 @@ int dwc2_gadget_init(struct dwc2_hsotg *dwc2, int irq)
 
 	s3c_hsotg_phy_disable(dwc2);
 
+	dev_set_name(&dwc2->gadget.dev, "gadget");
+
+	ret = device_register(&dwc2->gadget.dev);
+	if (ret) {
+		dev_err(dev, "failed to register gadget devie\n");
+		put_device(&dwc2->gadget.dev);
+		goto err_ep_mem;
+	}
+
 	ret = usb_add_gadget_udc(dwc2->dev, &dwc2->gadget);
 	if (ret)
 		goto err_ep_mem;
-- 
1.7.5.4

