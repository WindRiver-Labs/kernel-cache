From 499b091f8bf203d3af7234b8e57b74d5499ca515 Mon Sep 17 00:00:00 2001
From: Dinh Nguyen <dinguyen@altera.com>
Date: Mon, 28 Jan 2013 17:42:37 -0600
Subject: [PATCH 182/254] arm: socfpga: Update L2 cache settings

Upstream: git://git.rocketboards.org/linux-socfpga.git

Add in the correct tag-latency and data-latency device tree
entries for L2 cache. Enable D and I prefetch per HW group's
recommendation. These changes drastically improve the
performance of the SDRAM.

Signed-off-by: Dinh Nguyen <dinguyen@altera.com>
(cherry picked from commit e46b5931050a5418fc1c0d4ec0e400bb3c14d0fb)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/boot/dts/socfpga.dtsi  |    2 ++
 arch/arm/mach-socfpga/socfpga.c |    5 ++++-
 2 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/arch/arm/boot/dts/socfpga.dtsi b/arch/arm/boot/dts/socfpga.dtsi
index 9bb6d7a..e30e145 100644
--- a/arch/arm/boot/dts/socfpga.dtsi
+++ b/arch/arm/boot/dts/socfpga.dtsi
@@ -156,6 +156,8 @@
 			interrupts = <0 38 0x04>;
 			cache-unified;
 			cache-level = <2>;
+			arm,tag-latency = <1 1 1>;
+			arm,data-latency = <2 1 1>;
 		};
 
 		mmc: dwmmc0@ff704000 {
diff --git a/arch/arm/mach-socfpga/socfpga.c b/arch/arm/mach-socfpga/socfpga.c
index 556e5e1..db4ed5b 100644
--- a/arch/arm/mach-socfpga/socfpga.c
+++ b/arch/arm/mach-socfpga/socfpga.c
@@ -285,7 +285,10 @@ static void socfpga_cyclone5_restart(char mode, const char *cmd)
 static void __init socfpga_cyclone5_init(void)
 {
 #ifdef CONFIG_CACHE_L2X0
-	l2x0_of_init(0, ~0UL);
+	u32 aux_ctrl = 0;
+	aux_ctrl |= (1 << L2X0_AUX_CTRL_DATA_PREFETCH_SHIFT) |
+			(1 << L2X0_AUX_CTRL_INSTR_PREFETCH_SHIFT);
+	l2x0_of_init(aux_ctrl, ~0UL);
 #endif
 	of_platform_populate(NULL, of_default_bus_match_table,
 		socfpga_auxdata_lookup, NULL);
-- 
1.7.5.4

