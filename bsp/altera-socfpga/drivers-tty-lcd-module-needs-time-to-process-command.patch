From 30bd2eace03abdd9457d6e289c7d6bfe860fc18a Mon Sep 17 00:00:00 2001
From: Alan Tull <atull@altera.com>
Date: Thu, 23 May 2013 09:41:16 -0500
Subject: [PATCH] drivers/tty: lcd module needs time to process commands.

commit def91b037c784f2fae13282ee9eeae5eb912d940
git://git.rocketboards.org/linux-socfpga.git socfpga-3.9-rel

It appears that the LCD module's controller needs a little time
to process commands before more text is sent to the module.
Otherwise a few characters of text gets dropped after some commands
such as the command to clear the display.

printf '\nhello you crazy\nlinux people' > /dev/ttyLCD0

Should display correctly with this workaround.

Signed-off-by: Alan Tull <atull@altera.com>
Signed-off-by: Li Zhanguo <zhanguo.li@windriver.com>
---
 drivers/tty/newhaven_lcd.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/tty/newhaven_lcd.c b/drivers/tty/newhaven_lcd.c
index 2fb2ab8..0cdc61d 100644
--- a/drivers/tty/newhaven_lcd.c
+++ b/drivers/tty/newhaven_lcd.c
@@ -27,6 +27,7 @@
 #include <linux/slab.h>
 #include <linux/stat.h>
 #include <linux/tty.h>
+#include <linux/delay.h>
 #include <linux/uaccess.h>
 #include <linux/proc_fs.h>
 
@@ -94,6 +95,7 @@ static int lcd_cmd_no_params(struct lcd *lcd_data, u8 cmd)
 		pr_err("%s: i2c_master_send returns %d\n", __func__, count);
 		return -1;
 	}
+	msleep(1);
 	return 0;
 }
 
@@ -107,6 +109,7 @@ static int lcd_cmd_one_param(struct lcd *lcd_data, u8 cmd, u8 param)
 		pr_err("%s: i2c_master_send returns %d\n", __func__, count);
 		return -1;
 	}
+	msleep(1);
 	return 0;
 }
 
-- 
1.7.5.4

