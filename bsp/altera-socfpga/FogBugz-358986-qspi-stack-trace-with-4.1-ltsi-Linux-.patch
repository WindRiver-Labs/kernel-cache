From a71117cdceacef98b38fffcfd9de8ee8a3f0b798 Mon Sep 17 00:00:00 2001
From: Graham Moore <grmoore@opensource.altera.com>
Date: Mon, 29 Feb 2016 04:36:29 -0600
Subject: [PATCH 69/73] FogBugz #358986: qspi stack trace with 4.1-ltsi Linux
 kernel

mtd: spi-nor: Use cond_resched() instead of cpu_relax() in cadence_quadspi
driver so that RCU stall checker can run.  A stack trace was observed
when using 'mtd_debug write' with a large file that took more than 21
seconds to program.

Signed-off-by: Graham Moore <grmoore@opensource.altera.com>
[mli1:Original patch taken from
https://github.com/altera-opensource/linux-socfpga.git socfpga-4.1-ltsi]
Signed-off-by: Meng Li <Meng.Li@windriver.com>
---
 drivers/mtd/spi-nor/cadence-quadspi.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/mtd/spi-nor/cadence-quadspi.c b/drivers/mtd/spi-nor/cadence-quadspi.c
index ca22e26..938917e 100644
--- a/drivers/mtd/spi-nor/cadence-quadspi.c
+++ b/drivers/mtd/spi-nor/cadence-quadspi.c
@@ -347,7 +347,7 @@ static unsigned int cqspi_wait_idle(struct cqspi_st *cqspi)
 		} else {
 			count = 0;
 		}
-		cpu_relax();
+		cond_resched();
 	}
 
 	/* Timeout, in busy mode. */
-- 
1.7.5.4

