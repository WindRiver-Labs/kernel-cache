From c988b8aaad5f289cb23d11bdbfda4a6f3e3aee56 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 19 Sep 2008 15:13:13 +0800
Subject: [PATCH] Fixed to support VPE loader

In order to support RP/AP we should reserve at least one VPE, so we really
don't enable VSMP (Use 1 TC on each available VPE for SMP) while running
VPE-loader. For running RP, we should better reserve some areas used by
building stack and heap space, and support correctly using that hiden memory.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/mips/Kconfig                  |    2 +-
 arch/mips/mti-malta/malta-memory.c |   13 +++++++++++++
 2 files changed, 14 insertions(+), 1 deletions(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index b537307..8eb2c4c 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -1447,7 +1447,7 @@ config MIPS_MT_FPAFF
 
 config MIPS_VPE_LOADER
 	bool "VPE loader support."
-	depends on SYS_SUPPORTS_MULTITHREADING
+	depends on MIPS_MT_DISABLED || MIPS_MT_SMTC
 	select CPU_MIPSR2_IRQ_VI
 	select CPU_MIPSR2_IRQ_EI
 	select MIPS_MT
diff --git a/arch/mips/mti-malta/malta-memory.c b/arch/mips/mti-malta/malta-memory.c
index 61888ff..d8c0834 100644
--- a/arch/mips/mti-malta/malta-memory.c
+++ b/arch/mips/mti-malta/malta-memory.c
@@ -87,6 +87,19 @@ static struct prom_pmemblock * __init prom_getmdesc(void)
 	else
 		memsize = physical_memsize;
 
+#ifdef CONFIG_MIPS_VPE_LOADER
+	/*
+         * The default DFLT_STACK_SIZE and DFLT_HEAP_SIZE will be known 
+         * from sde-kit. Actually it should define according to the different RP
+         * application. In the future we might want to improve it.
+         */
+#define DFLT_STACK_SIZE (65536)
+#define DFLT_HEAP_SIZE  (1048576) 
+        /* Reserve area used by building stack and heap for running RP. 
+         */
+        memsize -= (DFLT_HEAP_SIZE + DFLT_STACK_SIZE + PAGE_SIZE);
+#endif
+
 	memset(mdesc, 0, sizeof(mdesc));
 
 	mdesc[0].type = yamon_dontuse;
-- 
1.5.5.1

