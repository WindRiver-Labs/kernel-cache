From bb52546998f39630ad7ebdf3e7484e1b37fe73d0 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Mon, 9 May 2011 14:50:57 +0800
Subject: [PATCH 1/9] mxc/v4l2/cpature: add capture driver to support fsl_imx25pdk

Add capture driver for mxc platforms to support fsl_imx25pdk.

[Original code taken from L2.6.31_09.12.01_SDK.tar.gz BSP package:
http://www.freescale.com/webapp/sps/site/prod_summary.jsp?code=
IMX25PDK&fpsp=1&tab=Design_Tools_Tab]

Signed-off-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/media/video/Makefile                       |    1 +
 drivers/media/video/mxc/capture/Kconfig            |   10 ++++++++++
 drivers/media/video/mxc/capture/Makefile           |    5 +++++
 drivers/media/video/mxc/capture/mxc_v4l2_capture.h |   14 +++++++++++++-
 4 files changed, 29 insertions(+), 1 deletions(-)

diff --git a/drivers/media/video/Makefile b/drivers/media/video/Makefile
index c3d5cca..7bd1e69 100644
--- a/drivers/media/video/Makefile
+++ b/drivers/media/video/Makefile
@@ -99,6 +99,7 @@ obj-$(CONFIG_VIDEO_VINO) += vino.o
 obj-$(CONFIG_VIDEO_STRADIS) += stradis.o
 obj-$(CONFIG_VIDEO_MXC_IPU_CAMERA) += mxc/capture/
 obj-$(CONFIG_VIDEO_MXC_IPU_OUTPUT) += mxc/output/
+obj-$(CONFIG_VIDEO_MXC_CSI_CAMERA) += mxc/capture/
 obj-$(CONFIG_VIDEO_MXC_IPUV1_WVGA_OUTPUT) += mxc/output/
 obj-$(CONFIG_VIDEO_CPIA) += cpia.o
 obj-$(CONFIG_VIDEO_CPIA_PP) += cpia_pp.o
diff --git a/drivers/media/video/mxc/capture/Kconfig b/drivers/media/video/mxc/capture/Kconfig
index edfd6d9..7044647 100644
--- a/drivers/media/video/mxc/capture/Kconfig
+++ b/drivers/media/video/mxc/capture/Kconfig
@@ -6,6 +6,10 @@ config VIDEO_MXC_IPU_CAMERA
 	depends on VIDEO_MXC_CAMERA && MXC_IPU
 	default y
 
+config VIDEO_MXC_CSI_CAMERA
+        tristate "MX25 CSI camera support"
+        depends on !VIDEO_MXC_EMMA_CAMERA
+
 choice
 	prompt "Select Camera/TV Decoder"
 	default MXC_CAMERA_OV3640
@@ -36,6 +40,12 @@ config MXC_IPU_PRP_VF_ADC
 		displaying it on asynchronous display.
 		CSI -> IC (PRP VF) -> ADC2
 
+config MXC_CAMERA_OV2640
+        tristate "OmniVision ov2640 camera support"
+        depends on !VIDEO_MXC_EMMA_CAMERA
+        ---help---
+          If you plan to use the ov2640 Camera with your MXC system, say Y here.
+
 config MXC_IPU_PRP_ENC
 	tristate "Pre-processor Encoder library"
 	depends on VIDEO_MXC_IPU_CAMERA
diff --git a/drivers/media/video/mxc/capture/Makefile b/drivers/media/video/mxc/capture/Makefile
index 70094d5..9816959 100644
--- a/drivers/media/video/mxc/capture/Makefile
+++ b/drivers/media/video/mxc/capture/Makefile
@@ -5,3 +5,8 @@ ifeq ($(CONFIG_VIDEO_MXC_IPU_CAMERA),y)
 	obj-$(CONFIG_MXC_IPU_PRP_ENC) += ipu_prp_enc.o ipu_still.o
 	obj-$(CONFIG_MXC_IPU_CSI_ENC) += ipu_csi_enc.o ipu_still.o
 endif
+
+obj-$(CONFIG_VIDEO_MXC_CSI_CAMERA) += fsl_csi.o csi_v4l2_capture.o
+
+ov2640_camera-objs := ov2640.o sensor_clock.o
+obj-$(CONFIG_MXC_CAMERA_OV2640) += ov2640_camera.o
diff --git a/drivers/media/video/mxc/capture/mxc_v4l2_capture.h b/drivers/media/video/mxc/capture/mxc_v4l2_capture.h
index ef6d4a5..54940aa 100644
--- a/drivers/media/video/mxc/capture/mxc_v4l2_capture.h
+++ b/drivers/media/video/mxc/capture/mxc_v4l2_capture.h
@@ -50,6 +50,7 @@ struct mxc_v4l_frame {
 	struct v4l2_buffer buffer;
 	struct list_head queue;
 	int index;
+	int ipu_buf_num;
 };
 
 /* Only for old version.  Will go away soon. */
@@ -108,8 +109,14 @@ typedef struct _cam_data {
 	struct list_head done_q;
 	struct list_head working_q;
 	int ping_pong_csi;
+#ifdef CONFIG_ARCH_MX25
+	spinlock_t queue_int_lock;
+	spinlock_t dqueue_int_lock;
+#else
 	spinlock_t int_lock;
+#endif
 	struct mxc_v4l_frame frame[FRAME_NUM];
+	struct mxc_v4l_frame dummy_frame;
 	int skip_frame;
 	wait_queue_head_t enc_queue;
 	int enc_counter;
@@ -121,7 +128,7 @@ typedef struct _cam_data {
 	/* still image capture */
 	wait_queue_head_t still_queue;
 	int still_counter;
-	dma_addr_t still_buf;
+	dma_addr_t still_buf[2];
 	void *still_buf_vaddr;
 
 	/* overlay */
@@ -136,6 +143,7 @@ typedef struct _cam_data {
 	bool overlay_active;
 	int output;
 	struct fb_info *overlay_fb;
+	int fb_origin_std;
 
 	/* v4l2 format */
 	struct v4l2_format v2f;
@@ -166,11 +174,15 @@ typedef struct _cam_data {
 	int (*enc_update_eba) (dma_addr_t eba, int *bufferNum);
 	int (*enc_enable) (void *private);
 	int (*enc_disable) (void *private);
+	int (*enc_enable_csi) (void *private);
+	int (*enc_disable_csi) (void *private);
 	void (*enc_callback) (u32 mask, void *dev);
 	int (*vf_start_adc) (void *private);
 	int (*vf_stop_adc) (void *private);
 	int (*vf_start_sdc) (void *private);
 	int (*vf_stop_sdc) (void *private);
+	int (*vf_enable_csi) (void *private);
+	int (*vf_disable_csi) (void *private);
 	int (*csi_start) (void *private);
 	int (*csi_stop) (void *private);
 
-- 
1.7.0.4

