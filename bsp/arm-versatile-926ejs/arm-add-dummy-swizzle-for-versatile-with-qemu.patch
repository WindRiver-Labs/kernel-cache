From 351d133943b50a9dfeee07661d44254722a19f04 Mon Sep 17 00:00:00 2001
From: Paul Gortmaker <paul.gortmaker@windriver.com>
Date: Tue, 26 Feb 2013 15:35:22 -0500
Subject: [PATCH 2/2] arm: add dummy swizzle for versatile with qemu

Booting the ARM versatile in qemu fails with the SCSI controller
timing out as follows:

 ------------
 sym0: <895a> rev 0x0 at pci 0000:00:0d.0 irq 92
 sym0: SCSI BUS has been reset.
 scsi0 : sym-2.2.3
 [...]
 scsi 0:0:0:0: ABORT operation started
 scsi 0:0:0:0: ABORT operation timed-out.
 scsi 0:0:0:0: DEVICE RESET operation started
 scsi 0:0:0:0: DEVICE RESET operation timed-out.
 scsi 0:0:0:0: BUS RESET operation started
 scsi 0:0:0:0: BUS RESET operation timed-out.
 scsi 0:0:0:0: HOST RESET operation started
 sym0: SCSI BUS has been reset
 ------------

Bisecting gives commit 1bc39ac5dab265b76ce6e20d6c85f900539fd190
("ARM: PCI: versatile: fix PCI interrupt setup") -- specifically
the change to use common swizzle instead of NULL.  However, a
revert of that isn't sufficient, since another change in commit
daeb4c0c3bf2df72d0cd6e4330bad9e2e520552b ("ARM: PCI: get rid of
pci_std_swizzle()") makes a NULL swizzle implicitly mean to use
the common one.  So to effectively "revert" the behaviour of
commit 1bc39ac5d, we have to introduce a no-op swizzle for the
versatile platform.

It is unclear what the "real" hardware swizzle is for this
platform, if it actually has one.  If it doesn't, then it
really can't support PCI cards with their own bridge onboard.

Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 arch/arm/mach-versatile/pci.c |    6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/arch/arm/mach-versatile/pci.c b/arch/arm/mach-versatile/pci.c
index e92e5e0..03b679c 100644
--- a/arch/arm/mach-versatile/pci.c
+++ b/arch/arm/mach-versatile/pci.c
@@ -338,7 +338,13 @@ static int __init versatile_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)
 	return irq;
 }
 
+static u8 versatile_swizzle(struct pci_dev *dev, u8 *pinp)
+{
+	return 0;
+}
+
 static struct hw_pci versatile_pci __initdata = {
+	.swizzle		= versatile_swizzle,
 	.map_irq		= versatile_map_irq,
 	.nr_controllers		= 1,
 	.ops			= &pci_versatile_ops,
-- 
1.7.10.4

