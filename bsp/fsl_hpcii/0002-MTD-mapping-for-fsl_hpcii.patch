From ae3a255749c93d29da327bfd100033ed7b169c1f Mon Sep 17 00:00:00 2001
From: Thomas Tai <Thomas.Tai@windriver.com>
Date: Tue, 14 Oct 2008 16:37:06 -0400
Subject: [PATCH 2/3] MTD mapping for fsl_hpcii

Added support for flash physical memory map and partition
mapping based on OF description, also updated device tree
to include a cfi-flash device.

Signed-off-by: Thomas Tai <Thomas.Tai@windriver.com>
---
 arch/powerpc/boot/dts/mpc7448hpc2.dts             |   20 ++++++++++++++++++++
 arch/powerpc/platforms/embedded6xx/mpc7448_hpc2.c |   13 +++++++++++++
 2 files changed, 33 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/boot/dts/mpc7448hpc2.dts b/arch/powerpc/boot/dts/mpc7448hpc2.dts
index 2544f3e..c59ff74 100644
--- a/arch/powerpc/boot/dts/mpc7448hpc2.dts
+++ b/arch/powerpc/boot/dts/mpc7448hpc2.dts
@@ -51,6 +51,26 @@
 		       >;
 	};
 
+	localbus{
+		#address-cells = <2>;
+		#size-cells = <1>;
+		compatible = "simple-bus";
+		ranges = <0x0 0x0 0xff000000 0x800000>;
+
+		flash@0,0 {
+			#address-cells = <1>;
+			#size-cells = <1>;
+			compatible = "amd", "cfi-flash";
+			reg = <0x0 0x0 0x800000>;
+			bank-width = <1>;
+			partition@0x0 {
+				label = "boot";
+				reg = <0x0 0x800000>;
+				read-only;
+			};
+		};
+     };
+
   	tsi108@c0000000 {
 		#address-cells = <1>;
 		#size-cells = <1>;
diff --git a/arch/powerpc/platforms/embedded6xx/mpc7448_hpc2.c b/arch/powerpc/platforms/embedded6xx/mpc7448_hpc2.c
index 84e2d78..3db01d8 100644
--- a/arch/powerpc/platforms/embedded6xx/mpc7448_hpc2.c
+++ b/arch/powerpc/platforms/embedded6xx/mpc7448_hpc2.c
@@ -30,6 +30,7 @@
 #include <linux/serial.h>
 #include <linux/tty.h>
 #include <linux/serial_core.h>
+#include <linux/of_platform.h>
 
 #include <asm/system.h>
 #include <asm/time.h>
@@ -188,6 +189,18 @@ void mpc7448_hpc2_halt(void)
 	mpc7448_hpc2_power_off();
 }
 
+static struct of_device_id __initdata of_bus_ids[] = {
+	{ .compatible = "simple-bus", },
+	{},
+};
+
+static int __init declare_of_platform_devices(void)
+{
+	of_platform_bus_probe(NULL, of_bus_ids, NULL);
+	return 0;
+}
+machine_device_initcall(mpc7448_hpc2, declare_of_platform_devices);
+
 /*
  * Called very early, device-tree isn't unflattened
  */
-- 
1.6.0

