fsl_hpcii: Reset board using hardware register

Board restart function does not reset the board correctly.
According to HPC II User Guide, a hardware register is
available for resetting the board. Changes is made in
restart function to use the hardware reset register to
restart the board.

Signed-off-by: Thomas Tai <thomas.tai@windriver.com>
---
 arch/powerpc/platforms/embedded6xx/mpc7448_hpc2.c |   33 +++++++++++++++++++--
 1 files changed, 30 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/platforms/embedded6xx/mpc7448_hpc2.c b/arch/powerpc/platforms/embedded6xx/mpc7448_hpc2.c
index 84e2d78..c91750a 100644
--- a/arch/powerpc/platforms/embedded6xx/mpc7448_hpc2.c
+++ b/arch/powerpc/platforms/embedded6xx/mpc7448_hpc2.c
@@ -53,6 +53,25 @@
 
 #define MPC7448HPC2_PCI_CFG_PHYS 0xfb000000
 
+#define MPC7448HPC2_TICK_BASE     0xfd000000
+#define MPC7448HPC2_TICK_SIZE     0x48
+
+#define MPC7448HPC2_TSCR_REG      0x08   /* Status Control Register */
+#define MPC7448HPC2_TSCR_LED      (1<<0) /* internal LED buffers */
+#define MPC7448HPC2_TSCR_NOFAULT  (1<<4) /* self-fault */
+#define MPC7448HPC2_TSCR_RSTE     (1<<5) /* allowing board reset */
+#define MPC7448HPC2_TSCR_POE      (1<<6) /* power off enable */
+#define MPC7448HPC2_TSCR_LOCK     (1<<7) /* protected reset field */
+
+#define MPC7448HPC2_TRCR_REG      0x0c   /* Reset Control Register */
+#define MPC7448HPC2_TRCR_SRESET   (1<<0) /* SRESET to processor */
+#define MPC7448HPC2_TRCR_BRDRST   (1<<1) /* board reset */
+#define MPC7448HPC2_TRCR_MEMRST   (1<<3) /* memory reset */
+#define MPC7448HPC2_TRCR_PHYRST   (1<<6) /* ethernet PHY reset */
+#define MPC7448HPC2_TRCR_PBRSTDIS (1<<7) /* HRRESET to processor */
+
+static void __iomem *mpc7448hpc2_tick_base;
+
 int mpc7448_hpc2_exclude_device(struct pci_controller *hose,
 				u_char bus, u_char devfn)
 {
@@ -80,6 +99,11 @@ static void __init mpc7448_hpc2_setup_arch(void)
 		ppc_md.progress("tsi108: resources set", 0x100);
 #endif
 
+	/* ioremap Taiga Initializer/Controller/Keeper TICK address
+	 * which is needed by mpc7448_hpc2_restart()
+	 */
+	mpc7448hpc2_tick_base = ioremap(MPC7448HPC2_TICK_BASE,
+						MPC7448HPC2_TICK_SIZE);
 	printk(KERN_INFO "MPC7448HPC2 (TAIGA) Platform\n");
 	printk(KERN_INFO
 	       "Jointly ported by Freescale and Tundra Semiconductor\n");
@@ -171,9 +195,12 @@ void mpc7448_hpc2_restart(char *cmd)
 {
 	local_irq_disable();
 
-	/* Set exception prefix high - to the firmware */
-	_nmask_and_or_msr(0, MSR_IP);
-
+	/* enable board reset function */
+	writeb(MPC7448HPC2_TSCR_RSTE,
+		mpc7448hpc2_tick_base + MPC7448HPC2_TSCR_REG);
+	/* resetting board */
+	writeb(MPC7448HPC2_TRCR_BRDRST,
+		mpc7448hpc2_tick_base + MPC7448HPC2_TRCR_REG);
 	for (;;) ;		/* Spin until reset happens */
 }
 
-- 
1.6.0.4

