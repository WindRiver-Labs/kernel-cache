From 63dd268b6946bca56b5b5952b24d9d7ff2842fa8 Mon Sep 17 00:00:00 2001
From: Zhao Chenhui <chenhui.zhao@freescale.com>
Date: Fri, 23 Mar 2012 17:03:39 +0800
Subject: [PATCH 06/21] usb/fsl: enable USB wakeup

To enable USB wakeup feature,
 * Add a interrupt flag IRQF_NO_SUSPEND to avoid the USB interrupt
   disabled when suspending.
 * Set the USB module as a wakeup source.

Change-Id: I85b1b538175ded6e6f56f701d76f49da9884178f
Signed-off-by: Zhao Chenhui <chenhui.zhao@freescale.com>
Signed-off-by: Li Yang <leoli@freescale.com>
Reviewed-on: http://git.am.freescale.net:8181/1448
Reviewed-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
Tested-by: Fleming Andrew-AFLEMING <AFLEMING@freescale.com>
[Kevin: Original patch taken from FSL SDK V1.4. Just minor context
mod in order to port to our kernel.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/boot/dts/fsl/p1022si-post.dtsi |    2 ++
 arch/powerpc/boot/dts/fsl/pq3-power.dtsi    |    9 +++++++++
 drivers/usb/host/ehci-fsl.c                 |    5 +++++
 3 files changed, 16 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/boot/dts/fsl/p1022si-post.dtsi b/arch/powerpc/boot/dts/fsl/p1022si-post.dtsi
index 3f3fc1e..7bbf1e5 100644
--- a/arch/powerpc/boot/dts/fsl/p1022si-post.dtsi
+++ b/arch/powerpc/boot/dts/fsl/p1022si-post.dtsi
@@ -206,10 +206,12 @@
 /include/ "pq3-usb2-dr-0.dtsi"
 	usb@22000 {
 		compatible = "fsl-usb2-dr-v1.6", "fsl-usb2-dr";
+		fsl,pmc-handle = <&usb1_clk>;
 	};
 /include/ "pq3-usb2-dr-1.dtsi"
 	usb@23000 {
 		compatible = "fsl-usb2-dr-v1.6", "fsl-usb2-dr";
+		fsl,pmc-handle = <&usb2_clk>;
 	};
 
 /include/ "pq3-esdhc-0.dtsi"
diff --git a/arch/powerpc/boot/dts/fsl/pq3-power.dtsi b/arch/powerpc/boot/dts/fsl/pq3-power.dtsi
index 5aa854c..3acbd1f 100644
--- a/arch/powerpc/boot/dts/fsl/pq3-power.dtsi
+++ b/arch/powerpc/boot/dts/fsl/pq3-power.dtsi
@@ -36,6 +36,15 @@ power@e0070 {
 	compatible = "fsl,mpc8548-pmc";
 	reg = <0xe0070 0x20>;
 
+	usb1_clk: soc-clk@8 {
+		fsl,pmcdr-mask = <0x08000000>;
+	};
+	usb2_clk: soc-clk@9 {
+		fsl,pmcdr-mask = <0x04000000>;
+	};
+	usb3_clk: soc-clk@10 {
+		fsl,pmcdr-mask = <0x02000000>;
+	};
 	etsec1_clk: soc-clk@24 {
 		fsl,pmcdr-mask = <0x00000080>;
 	};
diff --git a/drivers/usb/host/ehci-fsl.c b/drivers/usb/host/ehci-fsl.c
index c68530f..c1824a1 100644
--- a/drivers/usb/host/ehci-fsl.c
+++ b/drivers/usb/host/ehci-fsl.c
@@ -29,6 +29,7 @@
 #include <linux/pm.h>
 #include <linux/platform_device.h>
 #include <linux/fsl_devices.h>
+#include <sysdev/fsl_soc.h>
 
 #include "ehci-fsl.h"
 
@@ -657,6 +658,8 @@ static int ehci_fsl_drv_suspend(struct device *dev)
 	}
 #endif
 
+	mpc85xx_pmc_set_wake(dev, true);
+
 	ehci_prepare_ports_for_controller_suspend(hcd_to_ehci(hcd),
 			device_may_wakeup(dev));
 	if (!fsl_deep_sleep())
@@ -692,6 +695,8 @@ static int ehci_fsl_drv_resume(struct device *dev)
 	}
 #endif
 
+	mpc85xx_pmc_set_wake(dev, false);
+
 	ehci_prepare_ports_for_controller_resume(ehci);
 	if (!fsl_deep_sleep())
 		return 0;
-- 
1.7.5.4

