From 1b1da776d63ea29e2b1f45fb05ee038019ca6003 Mon Sep 17 00:00:00 2001
From: Ying Xue <ying.xue@windriver.com>
Date: Thu, 24 Feb 2011 14:15:33 +0800
Subject: [PATCH] ARM: VEXPRESS: add default nor flash mtd parts

Create default MTD partition tables and fix the problem that without
partition the integrator map driver will fail to register mtd device.
Though the Nor flash is 128M, only 32M is allocated due to limited
vmalloc space.  Set jffs2 partition to 16M, and kernel partition to 8M,
to allow some room for expansion.

Signed-off-by: Xue Ying <ying.xue@windriver.com>
Signed-off-by: Junxiao Bi <junxiao.bi@windriver.com>
---
 arch/arm/mach-vexpress/v2m.c        |   41 ++++++++++++++++++++++++----------
 drivers/mtd/maps/integrator-flash.c |   13 ++++++----
 2 files changed, 37 insertions(+), 17 deletions(-)

diff --git a/arch/arm/mach-vexpress/v2m.c b/arch/arm/mach-vexpress/v2m.c
index d250711..a0382a5 100644
--- a/arch/arm/mach-vexpress/v2m.c
+++ b/arch/arm/mach-vexpress/v2m.c
@@ -7,6 +7,8 @@
 #include <linux/io.h>
 #include <linux/init.h>
 #include <linux/platform_device.h>
+#include <linux/mtd/mtd.h>
+#include <linux/mtd/partitions.h>
 #include <linux/smsc911x.h>
 #include <linux/spinlock.h>
 #include <linux/sysdev.h>
@@ -210,31 +212,46 @@ static void v2m_flash_set_vpp(int on)
 	writel(on != 0, MMIO_P2V(V2M_SYS_FLASH));
 }
 
+static struct mtd_partition v2m_flash_partitions[] = {
+	{ /* bootloader and params */
+		.name           = "bootloader",
+		.offset         = 0,
+		.size           = SZ_8M,
+		.mask_flags     = MTD_WRITEABLE,        /* force read-only */
+	}, {
+		.name           = "kernel",
+		.offset         = MTDPART_OFS_APPEND,
+		.size           = SZ_8M,
+		.mask_flags     = 0,
+	}, {
+		.name           = "jffs2",
+		.offset         = MTDPART_OFS_APPEND,
+		.size           = MTDPART_SIZ_FULL,
+		.mask_flags     = 0,
+	}
+};
+
 static struct flash_platform_data v2m_flash_data = {
 	.map_name	= "cfi_probe",
 	.width		= 4,
 	.init		= v2m_flash_init,
 	.exit		= v2m_flash_exit,
 	.set_vpp	= v2m_flash_set_vpp,
+	.parts		= v2m_flash_partitions,
+	.nr_parts	= ARRAY_SIZE(v2m_flash_partitions),
 };
 
-static struct resource v2m_flash_resources[] = {
-	{
-		.start	= V2M_NOR0,
-		.end	= V2M_NOR0 + SZ_64M - 1,
-		.flags	= IORESOURCE_MEM,
-	}, {
-		.start	= V2M_NOR1,
-		.end	= V2M_NOR1 + SZ_64M - 1,
-		.flags	= IORESOURCE_MEM,
-	},
+static struct resource v2m_flash_resources = {
+	.start	= V2M_NOR0,
+	.end	= V2M_NOR0 + SZ_32M - 1,
+	.flags	= IORESOURCE_MEM,
 };
 
 static struct platform_device v2m_flash_device = {
 	.name		= "armflash",
 	.id		= -1,
-	.resource	= v2m_flash_resources,
-	.num_resources	= ARRAY_SIZE(v2m_flash_resources),
+	.resource	= &v2m_flash_resources,
+	.num_resources	= 1,
 	.dev.platform_data = &v2m_flash_data,
 };
 
diff --git a/drivers/mtd/maps/integrator-flash.c b/drivers/mtd/maps/integrator-flash.c
index 2aac41b..11b9229 100644
--- a/drivers/mtd/maps/integrator-flash.c
+++ b/drivers/mtd/maps/integrator-flash.c
@@ -225,13 +225,16 @@ static int armflash_probe(struct platform_device *dev)
 	if (err < 0)
 		goto cleanup;
 
+#ifdef CONFIG_MTD_PARTITIONS
 	err = parse_mtd_partitions(info->mtd, probes, &info->parts, 0);
-	if (err > 0) {
+	if (err > 0)
 		err = add_mtd_partitions(info->mtd, info->parts, err);
-		if (err)
-			printk(KERN_ERR
-			       "mtd partition registration failed: %d\n", err);
-	}
+	else if (err <= 0 && plat->parts)
+		err = add_mtd_partitions(info->mtd, plat->parts,
+			plat->nr_parts);
+	else
+#endif
+		err = add_mtd_device(info->mtd);
 
 	if (err == 0) {
 		platform_set_drvdata(dev, info);
-- 
1.7.0.4

