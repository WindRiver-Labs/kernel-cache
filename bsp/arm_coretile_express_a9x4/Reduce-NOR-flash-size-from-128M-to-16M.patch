From fd25ab7a4694d39a5198f7099e096a1c2ee7d8ea Mon Sep 17 00:00:00 2001
From: Xue Ying <ying.xue@windriver.com>
Date: Fri, 4 Mar 2011 13:29:28 +0800
Subject: [PATCH 18/21] Reduce NOR flash size from 128M to 16M

In default, NOR flash would be mapped to vmalloc area by ioremap. But physical
memory size in CoreTile Express board reachs to 1G, it means vmalloc virtual
address area is just reserved to 120M when HIGHMEM is enabled. Therefore, it's
hard to map 128M NOR flash physical area to 120M vmalloc region. So we have to
reduce NOR flash size to 16M.

Signed-off-by: Xue Ying <ying.xue@windriver.com>
---
 arch/arm/mach-vexpress/v2m.c |   32 ++++++++------------------------
 1 files changed, 8 insertions(+), 24 deletions(-)

diff --git a/arch/arm/mach-vexpress/v2m.c b/arch/arm/mach-vexpress/v2m.c
index c101d22..8b91b3a 100644
--- a/arch/arm/mach-vexpress/v2m.c
+++ b/arch/arm/mach-vexpress/v2m.c
@@ -216,26 +216,16 @@ static struct mtd_partition v2m_flash_partitions[] = {
 	{ /* bootloader and params */
 		.name           = "bootloader",
 		.offset         = 0,
-		.size           = SZ_64M,
+		.size           = SZ_8M,
 		.mask_flags     = MTD_WRITEABLE,        /* force read-only */
 	}, {
 		.name           = "kernel",
 		.offset         = MTDPART_OFS_APPEND,
-		.size           = 0x400000,
+		.size           = 0x300000,
 		.mask_flags     = 0,
 	}, {
 		.name           = "jffs2",
 		.offset         = MTDPART_OFS_APPEND,
-		.size           = 0x700000,
-		.mask_flags     = 0,
-	}, {
-		.name           = "cramfs",
-		.offset         = MTDPART_OFS_APPEND,
-		.size           = 0x200000,
-		.mask_flags     = 0,
-	}, {
-		.name           = "user data",
-		.offset         = MTDPART_OFS_APPEND,
 		.size           = MTDPART_SIZ_FULL,
 		.mask_flags     = 0,
 	}
@@ -251,23 +241,17 @@ static struct flash_platform_data v2m_flash_data = {
 	.nr_parts	= ARRAY_SIZE(v2m_flash_partitions),
 };
 
-static struct resource v2m_flash_resources[] = {
-	{
-		.start	= V2M_NOR0,
-		.end	= V2M_NOR0 + SZ_64M - 1,
-		.flags	= IORESOURCE_MEM,
-	}, {
-		.start	= V2M_NOR1,
-		.end	= V2M_NOR1 + SZ_64M - 1,
-		.flags	= IORESOURCE_MEM,
-	},
+static struct resource v2m_flash_resources = {
+	.start	= V2M_NOR0,
+	.end	= V2M_NOR0 + SZ_16M - 1,
+	.flags	= IORESOURCE_MEM,
 };
 
 static struct platform_device v2m_flash_device = {
 	.name		= "armflash",
 	.id		= -1,
-	.resource	= v2m_flash_resources,
-	.num_resources	= ARRAY_SIZE(v2m_flash_resources),
+	.resource	= &v2m_flash_resources,
+	.num_resources	= 1,
 	.dev.platform_data = &v2m_flash_data,
 };
 
-- 
1.7.0.4

