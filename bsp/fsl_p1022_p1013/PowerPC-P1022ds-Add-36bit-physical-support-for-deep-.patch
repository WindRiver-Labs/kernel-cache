From b1309c89ed24c1eeee25ced643e2e04f404aad67 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Wed, 1 Dec 2010 13:51:58 +0800
Subject: [PATCH 1/6] PowerPC:P1022ds: Add 36bit physical support for deep sleep routine

Update suspend-asm.c to support deep sleep and resume with 36bit
physical address.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/platforms/85xx/suspend-asm.S |   41 ++++++++++++++++++++++-------
 1 files changed, 31 insertions(+), 10 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/suspend-asm.S b/arch/powerpc/platforms/85xx/suspend-asm.S
index 81fb93a..16a4053 100644
--- a/arch/powerpc/platforms/85xx/suspend-asm.S
+++ b/arch/powerpc/platforms/85xx/suspend-asm.S
@@ -42,6 +42,8 @@
 	.align	5
 mpc85xx_sleep_save_area:
 	.space	STATE_SAVE_SIZE
+ccsrbase_hi:
+	.long	0
 ccsrbase:
 	.long	0
 powmgtreq:
@@ -56,12 +58,22 @@ powmgtreq:
 	 *      JOG-0x00200000, deep sleep-0x00100000
 	 */
 _GLOBAL(mpc85xx_enter_deep_sleep)
-	lis	r5, ccsrbase@ha
-	stw	r3, ccsrbase@l(r5)
-
-	lis	r5, powmgtreq@ha
-	stw	r4, powmgtreq@l(r5)
-
+#ifdef CONFIG_PHYS_64BIT
+	lis	r6, ccsrbase_hi@ha
+	stw	r3, ccsrbase_hi@l(r6)
+
+	lis	r6, ccsrbase@ha
+	stw	r4, ccsrbase@l(r6)
+
+	lis	r6, powmgtreq@ha
+	stw	r5, powmgtreq@l(r6)
+#else
+	lis	r6, ccsrbase@ha
+	stw	r3, ccsrbase@l(r6)
+
+	lis	r6, powmgtreq@ha
+	stw	r4, powmgtreq@l(r6)
+#endif
 	lis	r10, mpc85xx_sleep_save_area@h
 	ori	r10, r10, mpc85xx_sleep_save_area@l
 
@@ -225,8 +237,9 @@ _GLOBAL(mpc85xx_enter_deep_sleep)
 	rlwinm	r4, r3, 0, 0xfffff000
 	ori	r4, r4, 0x0005
 	mtspr	SPRN_MAS3, r4
-	li	r4, 0
-	mtspr	SPRN_MAS7, r4
+	lis	r4, ccsrbase_hi@ha
+	lwz	r3, ccsrbase_hi@l(r4)
+	mtspr	SPRN_MAS7, r3
 	isync
 	tlbwe
 	isync
@@ -308,6 +321,13 @@ _GLOBAL(mpc85xx_enter_deep_sleep)
 2:	mfspr	r4, SPRN_PIR
 	andi.	r4, r4, 1
 99:	bne	99b
+#ifdef CONFIG_PHYS_64BIT
+	/* for 36-bit addressing */
+	lis	r6, 0x8000		/* enable machine check */
+	ori	r6,r6,0x0080		/* enable MAS7 updates */
+	mtspr	SPRN_HID0,r6
+#endif
+
 	/* Establish a temporary 64MB 0->0 mapping in TLB1[1]. */
 	lis	r4, 0x1001
 	mtspr	SPRN_MAS0, r4
@@ -374,8 +394,9 @@ mpc85xx_deep_resume:
 	rlwinm	r4, r3, 0, 0xfffff000
 	ori	r4, r4, 0x0005
 	mtspr	SPRN_MAS3, r4
-	li	r4, 0
-	mtspr	SPRN_MAS7, r4
+	lis	r4, ccsrbase_hi@ha
+	lwz	r3, ccsrbase_hi@l(r4)
+	mtspr	SPRN_MAS7, r3
 	isync
 	tlbwe
 	isync
-- 
1.6.5.2

