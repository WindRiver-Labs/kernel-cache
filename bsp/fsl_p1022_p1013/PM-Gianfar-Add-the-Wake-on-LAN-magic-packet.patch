From ce64f55c8f9247e7f753b7da8d5a79c147e82991 Mon Sep 17 00:00:00 2001
From: Yutaka Ando <r46913@freescale.com>
Date: Sun, 19 Sep 2010 13:41:26 +0800
Subject: [PATCH 13/14] PM: Gianfar: Add the Wake on LAN magic packet

Add Wake on LAN magic packet support for gianfar ethernet.

Extracted from the P1022DS_20100330-ltib.iso vendor drop.

Signed-off-by: Yutaka Ando <r46913@freescale.com>
Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/powerpc/boot/dts/p1022ds.dts |    2 ++
 drivers/net/gianfar.c             |    2 ++
 drivers/net/gianfar.h             |    4 ++++
 drivers/net/gianfar_ethtool.c     |    7 +++++++
 4 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/boot/dts/p1022ds.dts b/arch/powerpc/boot/dts/p1022ds.dts
index ea7d576..ab9e88e 100644
--- a/arch/powerpc/boot/dts/p1022ds.dts
+++ b/arch/powerpc/boot/dts/p1022ds.dts
@@ -370,6 +370,7 @@
 			compatible = "fsl,etsec2";
 			fsl,num_rx_queues = <0x8>;
 			fsl,num_tx_queues = <0x8>;
+			fsl,magic-packet;
 			local-mac-address = [ 00 00 00 00 00 00 ];
 			interrupt-parent = <&mpic>;
 			fixed-link = <1 1 1000 0 0>;
@@ -402,6 +403,7 @@
 			compatible = "fsl,etsec2";
 			fsl,num_rx_queues = <0x8>;
 			fsl,num_tx_queues = <0x8>;
+			fsl,magic-packet;
 			local-mac-address = [ 00 00 00 00 00 00 ];
 			interrupt-parent = <&mpic>;
 			fixed-link = <1 1 1000 0 0>;
diff --git a/drivers/net/gianfar.c b/drivers/net/gianfar.c
index 2aa98d3..2154ead 100644
--- a/drivers/net/gianfar.c
+++ b/drivers/net/gianfar.c
@@ -1201,6 +1201,7 @@ static int gfar_suspend(struct device *dev)
 	u32 tempval;
 
 	int magic_packet = priv->wol_en &&
+		(priv->wol_opts & GIANFAR_WOL_MAGIC) &&
 		(priv->device_flags & FSL_GIANFAR_DEV_HAS_MAGIC_PACKET);
 
 	netif_device_detach(ndev);
@@ -1253,6 +1254,7 @@ static int gfar_resume(struct device *dev)
 	unsigned long flags;
 	u32 tempval;
 	int magic_packet = priv->wol_en &&
+		(priv->wol_opts & GIANFAR_WOL_MAGIC) &&
 		(priv->device_flags & FSL_GIANFAR_DEV_HAS_MAGIC_PACKET);
 
 	if (!netif_running(ndev)) {
diff --git a/drivers/net/gianfar.h b/drivers/net/gianfar.h
index 9c23f12..ab12418 100644
--- a/drivers/net/gianfar.h
+++ b/drivers/net/gianfar.h
@@ -525,6 +525,8 @@ extern const char gfar_driver_version[];
 
 #define GFAR_INT_NAME_MAX	IFNAMSIZ + 4
 
+#define GIANFAR_WOL_MAGIC       (1 << 5)
+
 struct txbd8
 {
 	union {
@@ -1105,6 +1107,8 @@ struct gfar_private {
 
 	struct work_struct reset_task;
 
+	int wol_opts;
+
 	/* Network Statistics */
 	struct gfar_extra_stats extra_stats;
 };
diff --git a/drivers/net/gianfar_ethtool.c b/drivers/net/gianfar_ethtool.c
index ddab703..7a0ab46 100644
--- a/drivers/net/gianfar_ethtool.c
+++ b/drivers/net/gianfar_ethtool.c
@@ -637,6 +637,13 @@ static int gfar_set_wol(struct net_device *dev, struct ethtool_wolinfo *wol)
 
 	spin_lock_irqsave(&priv->bflock, flags);
 	priv->wol_en = wol->wolopts & WAKE_MAGIC ? 1 : 0;
+	if (wol->wolopts & WAKE_MAGIC) {
+		priv->wol_en = 1;
+		priv->wol_opts = GIANFAR_WOL_MAGIC;
+	} else {
+		priv->wol_en = 0;
+		priv->wol_opts = 0;
+	}
 	device_set_wakeup_enable(&dev->dev, priv->wol_en);
 	spin_unlock_irqrestore(&priv->bflock, flags);
 
-- 
1.6.5.2

