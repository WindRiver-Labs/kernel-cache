From 9cddaa2a2912ee8e02670e57b8bfb966a4f3a35d Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Mon, 24 Oct 2011 16:25:03 +0800
Subject: [PATCH 2/2] P1022ds:Extract pixis control FPGA address from dtb

The initial routine of P1022ds board needs adjust register of
pixis FPGA based on kernel configuration.

Since the base address is different between 32bit & 36bit environment.
The initial routine should extract address from device-tree instead of
hard-code.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/platforms/85xx/p1022_ds.c |   20 +++++++++++++++-----
 1 files changed, 15 insertions(+), 5 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/p1022_ds.c b/arch/powerpc/platforms/85xx/p1022_ds.c
index fcd7800..3fc5232 100644
--- a/arch/powerpc/platforms/85xx/p1022_ds.c
+++ b/arch/powerpc/platforms/85xx/p1022_ds.c
@@ -226,6 +226,8 @@ static void __init p1022_ds_setup_arch(void)
 	dma_addr_t max = 0xffffffff;
 
 	void __iomem *pixis;
+	struct device_node *np_pixis;
+	void __iomem *pixis_base;
 #if defined(CONFIG_FB_FSL_DIU) || defined(CONFIG_FB_FSL_DIU_MODULE)
 	void __iomem *pmuxcr;
 #endif
@@ -252,19 +254,26 @@ static void __init p1022_ds_setup_arch(void)
 
 #endif
 
-#define PIXIS_BASE	0xFFDF0000
 #define PX_BRDCFG0	0x8
 #define ELBC_SPI	0x80000000
 #define SDHC_PORT       0x04000000
 
 #define ELBC_DIU	0x02000000
 #define DVI_EN		0x00800000
+	np_pixis = of_find_compatible_node(NULL, NULL, "fsl,p1022ds-fpga-pixis");
+	if (!np_pixis) {
+		printk(KERN_ERR "Could not find p1022ds-fpga-pixis node\n");
+		return;
+	}
 
-
-	pixis = ioremap(PIXIS_BASE + PX_BRDCFG0, 4);
-	if (!pixis)
+	pixis_base = of_iomap(np_pixis, 0);
+	if (!pixis_base) {
+		printk(KERN_ERR "Failed to map pixis fpga register space\n");
+		of_node_put(np_pixis);
 		return;
+	}
 
+	pixis = pixis_base + PX_BRDCFG0;
 	out_be32(pixis, in_be32(pixis) | ELBC_SPI);
 	out_be32(pixis, in_be32(pixis) | SDHC_PORT);
 #if defined(CONFIG_FB_FSL_DIU) || defined(CONFIG_FB_FSL_DIU_MODULE)
@@ -272,7 +281,8 @@ static void __init p1022_ds_setup_arch(void)
 	out_be32(pixis, in_be32(pixis) | DVI_EN);
 	out_be32(pixis, in_be32(pixis) | ELBC_DIU);
 #endif	//#if defined(CONFIG_FB_FSL_DIU) || defined(CONFIG_FB_FSL_DIU_MODULE)
-	iounmap(pixis);
+	of_node_put(np_pixis);
+	iounmap(pixis_base);
 #if defined(CONFIG_FB_FSL_DIU) || defined(CONFIG_FB_FSL_DIU_MODULE)
 //Enable DVI use pin mutex with LBC
 	pmuxcr=ioremap(get_immrbase() + 0xe0060, 4);
-- 
1.7.0.4

