From 732e8aad3ddc58e5e7a670cb7f50ee4687fdc0ad Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Mon, 27 Sep 2010 14:00:37 +0800
Subject: [PATCH 07/14] mtd: Increase write delay to avoid software timeout

During MTD writting buffer, below error is raised frequently:

Writing superblocks and filesystem accounting information:
MTD do_write_buffer(): software timeout
end_request: I/O error, dev mtdblock4, sector 16384
Buffer I/O error on device mtdblock4, logical block 2048
lost page write due to I/O error on mtdblock4

Update the original 1us delay to 200us to avoid this issue.

Signed-off-by: Yang Shi <yang.shi@windriver.com>

[Jiang Lu:
Use "#ifdef CONFIG_P1022_DS" brace new added code to force them affect
P1022 platform only.]
Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/mtd/chips/cfi_cmdset_0002.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/mtd/chips/cfi_cmdset_0002.c b/drivers/mtd/chips/cfi_cmdset_0002.c
index f3600e8..9ef0bb4 100644
--- a/drivers/mtd/chips/cfi_cmdset_0002.c
+++ b/drivers/mtd/chips/cfi_cmdset_0002.c
@@ -1385,7 +1385,11 @@ static int __xipram do_write_buffer(struct map_info *map, struct flchip *chip,
 		}
 
 		/* Latency issues. Drop the lock, wait a while and retry */
+#ifdef CONFIG_P1022_DS		
+		UDELAY(map, chip, adr, 200);
+#else
 		UDELAY(map, chip, adr, 1);
+#endif		
 	}
 
 	/* reset on all failures. */
-- 
1.6.5.2

