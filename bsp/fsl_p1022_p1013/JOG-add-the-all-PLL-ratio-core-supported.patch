From 5dbf21c059f3179673f7d9128ffc6c2765a06cc2 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Wed, 13 Jul 2011 09:44:44 +0800
Subject: [PATCH 2/2] JOG: add the all PLL ratio core supported

The ratio CORE to CCB can be 1:1, 1.5:1, 2:1, 2.5:1, 3:1, 3.5:1 and 4:1.

Add missing ratios to cpufreq_frequency_table.

Signed-off-by: Jerry Huang <Chang-Ming.Huang@freescale.com>

[
1.Extracted from vendor drop QorIQ-NONDPAA-SDK-V1-20110429_ltib.iso
linux-2.6.35-qoriq-JOG-add-the-all-PLL-ratio-core-supporte.patch.

2.Add limitation to cpu frequency, for P1022 's core frequency can be up
to 1.2GHz.
]

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/platforms/85xx/cpufreq.c |   17 +++++++++++++++++
 1 files changed, 17 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/cpufreq.c b/arch/powerpc/platforms/85xx/cpufreq.c
index 9c5b4fd..6c75bce 100644
--- a/arch/powerpc/platforms/85xx/cpufreq.c
+++ b/arch/powerpc/platforms/85xx/cpufreq.c
@@ -60,10 +60,21 @@ static struct cpufreq_frequency_table mpc85xx_freqs[] = {
 	{2,	0},
 	{3,	0},
 	{4,	0},
+	{5,	0},
+	{6,	0},
+	{7,	0},
+	{8,	0},
 	{0,	CPUFREQ_TABLE_END},
 };
 
 /*
+ * Max core frequency allowed on processor
+ */
+#ifdef CONFIG_P1022_DS
+#define MAX_FREQ	(1200000)
+#endif
+
+/*
  * hardware specific functions
  */
 static int get_pll(int cpu)
@@ -117,6 +128,12 @@ static int mpc85xx_cpufreq_cpu_init(struct cpufreq_policy *policy)
 	/* initialize frequency table */
 	for (i = 0; mpc85xx_freqs[i].frequency != CPUFREQ_TABLE_END; i++) {
 		mpc85xx_freqs[i].frequency = (busfreq * mpc85xx_freqs[i].index) >> 1;
+
+#ifdef MAX_FREQ
+		if (mpc85xx_freqs[i].frequency >= MAX_FREQ)
+			mpc85xx_freqs[i].frequency = CPUFREQ_TABLE_END;
+		else
+#endif
 		printk("%d: %dkHz\n", i, mpc85xx_freqs[i].frequency);
 	}
 
-- 
1.7.0.4

