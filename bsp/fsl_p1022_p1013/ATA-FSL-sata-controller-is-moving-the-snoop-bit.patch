From 5781ea39452ad8685b661b369b5ecb9e3c6e70e7 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Mon, 27 Sep 2010 13:48:19 +0800
Subject: [PATCH 03/14] ATA: FSL sata controller is moving the snoop bit

Extracted from the P1022DS_20100330-ltib.iso vendor drop.

In P1022 SATA block, the snoop bit of PRDT Word3
description information is bit28, not bit22.

It is one dirty and quick hack, we will find the
better way to fix the issue.

Signed-off-by: Bill Mercer <r8aajn@freescale.com>
Signed-off-by: Travis Wheatley <travis.wheatley@freescale.com>
Signed-off-by: Srikanth Srinivasan <srikanth.srinivasan@freescale.com>
Signed-off-by: Dave Liu <daveliu@freescale.com>
Integrated-by: Yang Shi <yang.shi@windriver.com>

[Jiang Lu:
Use "#ifdef CONFIG_P1022_DS" brace new added code to force them affect
P1022 platform only.]

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/ata/sata_fsl.c |   15 ++++++++++++---
 1 files changed, 12 insertions(+), 3 deletions(-)

diff --git a/drivers/ata/sata_fsl.c b/drivers/ata/sata_fsl.c
index 2ed07fc..3f819a2 100644
--- a/drivers/ata/sata_fsl.c
+++ b/drivers/ata/sata_fsl.c
@@ -1226,7 +1226,11 @@ static int sata_fsl_init_controller(struct ata_host *host)
 	 * the CHBA, hence main controller initialization is done as
 	 * part of the port_start() callback
 	 */
-
+#ifdef CONFIG_P1022_DS
+	/* Changing P1022 sata controller to operate in enterprise mode */
+	temp = ioread32(hcr_base + HCONTROL);
+	iowrite32((temp & ~0x10000000), hcr_base + HCONTROL);
+#endif
 	/* ack. any pending IRQs for this controller/port */
 	temp = ioread32(hcr_base + HSTATUS);
 	if (temp & 0x3F)
@@ -1405,7 +1409,9 @@ static int sata_fsl_resume(struct of_device *op)
 	void __iomem *hcr_base = host_priv->hcr_base;
 	struct ata_port *ap = host->ports[0];
 	struct sata_fsl_port_priv *pp = ap->private_data;
-
+#ifdef CONFIG_P1022_DS
+	u32 temp;
+#endif
 	ret = sata_fsl_init_controller(host);
 	if (ret) {
 		dev_printk(KERN_ERR, &op->dev,
@@ -1415,7 +1421,10 @@ static int sata_fsl_resume(struct of_device *op)
 
 	/* Recovery the CHBA register in host controller cmd register set */
 	iowrite32(pp->cmdslot_paddr & 0xffffffff, hcr_base + CHBA);
-
+#ifdef CONFIG_P1022_DS
+	temp = ioread32(hcr_base + HCONTROL);
+	iowrite32(temp | 0x80000700, hcr_base+HCONTROL);
+#endif
 	ata_host_resume(host);
 	return 0;
 }
-- 
1.6.5.2

