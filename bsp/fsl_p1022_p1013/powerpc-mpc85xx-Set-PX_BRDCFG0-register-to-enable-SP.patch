From b769cc793db458102565c377dfccab2ce1bc6bea Mon Sep 17 00:00:00 2001
From: Yang Shi <yang.shi@windriver.com>
Date: Tue, 10 Aug 2010 13:29:45 +0800
Subject: [PATCH 09/14] powerpc: mpc85xx: Set PX_BRDCFG0 register to enable SPI CS for P1022DS

Since SPI CS[0:3] is multiplexed with ELBC LAD[28:31], so need
enable SPI CS via PX_BRDCFG0 register otherwise SPI Flash can't
be detected correctly.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
---
 arch/powerpc/platforms/85xx/p1022_ds.c |   14 ++++++++++++++
 1 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/p1022_ds.c b/arch/powerpc/platforms/85xx/p1022_ds.c
index 0d6bc86..7761a33 100644
--- a/arch/powerpc/platforms/85xx/p1022_ds.c
+++ b/arch/powerpc/platforms/85xx/p1022_ds.c
@@ -75,6 +75,8 @@ static void __init p1022_ds_setup_arch(void)
 #endif
 	dma_addr_t max = 0xffffffff;
 
+	void __iomem *pixis;
+
 	if (ppc_md.progress)
 		ppc_md.progress("p1022_ds_setup_arch()", 0);
 
@@ -98,6 +100,18 @@ static void __init p1022_ds_setup_arch(void)
 
 #endif
 
+#define PIXIS_BASE	0xFFDF0000
+#define PX_BRDCFG0	0x8
+#define ELBC_SPI	0x80000000
+
+	pixis = ioremap(PIXIS_BASE + PX_BRDCFG0, 4);
+	if (!pixis)
+		return;
+
+	out_be32(pixis, in_be32(pixis) | ELBC_SPI);
+
+	iounmap(pixis);
+
 #ifdef CONFIG_SMP
 	mpc85xx_smp_init();
 #endif
-- 
1.6.5.2

