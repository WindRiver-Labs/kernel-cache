From b01721e0a10f1586284e505cbb17805f5fa6d4e1 Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Mon, 11 May 2009 22:06:19 +0800
Subject: [PATCH] MUSB: Force idle by default

Change MUSB to enter force idle and force standby modes.
When the system initially boots, the device is configured this
way.  This configuration is repeated when the musb_hdrc module
is unloaded.

This change was extracted from
commit 7bf98e62295499fbb0c5e7d67713471de3bab0b5
of git://git.omapzoom.org/repo/omapkernel.git -- the parent
commit contained additional cleanups and changes that weren't
relevant to fixing the USB hot insertion/removal problem
being addressed here and so were dropped.

Signed-off-by: Stanley.Miao <stanley.miao@windriver.com>
---
 drivers/usb/musb/omap2430.c |   40 ++++++++++++++++++++++++++++++----------
 1 files changed, 30 insertions(+), 10 deletions(-)

diff --git a/drivers/usb/musb/omap2430.c b/drivers/usb/musb/omap2430.c
index 6de83b6..ed461cf 100644
--- a/drivers/usb/musb/omap2430.c
+++ b/drivers/usb/musb/omap2430.c
@@ -149,6 +149,33 @@ void musb_platform_try_idle(struct musb *musb, unsigned long timeout)
 	mod_timer(&musb_idle_timer, timeout);
 }
 
+void musb_platform_force_idle(struct musb *musb)
+{
+	long l;
+
+	/* in any role */
+	l = omap_readl(OTG_FORCESTDBY);
+	l &= ~ENABLEFORCE;		/* disable MSTANDBY */
+	omap_writel(l, OTG_FORCESTDBY);
+
+	l = omap_readl(OTG_SYSCONFIG);
+	l &= ~(SMARTSTDBY | NOSTDBY);	/* enable force standby */
+	omap_writel(l, OTG_SYSCONFIG);
+	l &= ~AUTOIDLE;			/* disable auto idle */
+	omap_writel(l, OTG_SYSCONFIG);
+
+	l &= ~(NOIDLE | SMARTIDLE);	/* enable force idle */
+	omap_writel(l, OTG_SYSCONFIG);
+
+	l = omap_readl(OTG_FORCESTDBY);
+	l |= ENABLEFORCE;		/* enable MSTANDBY */
+	omap_writel(l, OTG_FORCESTDBY);
+
+	l = omap_readl(OTG_SYSCONFIG);
+	l |= AUTOIDLE;			/* enable auto idle */
+	omap_writel(l, OTG_SYSCONFIG);
+}
+
 void musb_platform_enable(struct musb *musb)
 {
 }
@@ -269,19 +296,10 @@ int __init musb_platform_init(struct musb *musb)
 
 int musb_platform_suspend(struct musb *musb)
 {
-	u32 l;
-
 	if (!musb->clock)
 		return 0;
 
-	/* in any role */
-	l = omap_readl(OTG_FORCESTDBY);
-	l |= ENABLEFORCE;	/* enable MSTANDBY */
-	omap_writel(l, OTG_FORCESTDBY);
-
-	l = omap_readl(OTG_SYSCONFIG);
-	l |= ENABLEWAKEUP;	/* enable wakeup */
-	omap_writel(l, OTG_SYSCONFIG);
+	musb_platform_force_idle(musb);
 
 	if (musb->xceiv.set_suspend)
 		musb->xceiv.set_suspend(&musb->xceiv, 1);
@@ -332,6 +350,8 @@ int musb_platform_exit(struct musb *musb)
 
 	musb_platform_suspend(musb);
 
+	musb_platform_force_idle(musb);
+
 	clk_put(musb->clock);
 	musb->clock = 0;
 
-- 
1.6.0.4

