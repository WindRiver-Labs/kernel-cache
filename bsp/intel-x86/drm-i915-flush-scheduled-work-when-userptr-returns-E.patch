From 0b170d0fadc503c8a99566179e4a46f704ed7a16 Mon Sep 17 00:00:00 2001
From: Zhipeng Gong <zhipeng.gong@intel.com>
Date: Thu, 28 May 2015 13:35:16 +0800
Subject: [PATCH 10/14] drm/i915: flush scheduled work when userptr returns
 EAGAIN

It is for HSD 5753275.

[Original patch was taken from Intel MediaSDK]

Signed-off-by: Jacek Danecki <Jacek.Danecki@intel.com>
Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 drivers/gpu/drm/i915/i915_gem_execbuffer.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_gem_execbuffer.c b/drivers/gpu/drm/i915/i915_gem_execbuffer.c
index f51e988..a1e59c1 100644
--- a/drivers/gpu/drm/i915/i915_gem_execbuffer.c
+++ b/drivers/gpu/drm/i915/i915_gem_execbuffer.c
@@ -1420,8 +1420,9 @@ err:
 	/* the request owns the ref now */
 	i915_gem_context_unreference(ctx);
 	eb_destroy(eb);
-
 	mutex_unlock(&dev->struct_mutex);
+	if (ret == -EAGAIN)
+		flush_scheduled_work();
 
 pre_mutex_err:
 	/* intel_gpu_busy should also get a ref, so it will free when the device
-- 
1.7.5.4

