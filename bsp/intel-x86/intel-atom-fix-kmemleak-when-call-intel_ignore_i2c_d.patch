From 14deb4f3e71f2f8566af30a5c58db761046543f8 Mon Sep 17 00:00:00 2001
From: Liwei Song <liwei.song@windriver.com>
Date: Fri, 22 May 2015 17:23:37 +0800
Subject: [PATCH] intel-atom: fix kmemleak when call
 intel_ignore_i2c_device_register()

This commit will fix the following kmemleak
unreferenced object 0xffff88043dacc120 (size 96):
  comm "swapper/0", pid 1, jiffies 4294672141 (age 433.199s)
  hex dump (first 32 bytes):
    6d 74 39 6d 31 31 34 00 00 00 00 00 00 00 00 00  mt9m114.........
    00 00 00 00 00 00 48 00 80 88 e3 81 ff ff ff ff  ......H.........
  backtrace:
    [<ffffffff81977916>] kmemleak_alloc+0x26/0x50
    [<ffffffff81184b13>] kmem_cache_alloc_trace+0x173/0x370
    [<ffffffff8103df24>] intel_ignore_i2c_device_register.clone.0+0x74/0x220
    [<ffffffff81f2ca61>] platform_init+0x34/0x50
    [<ffffffff81000212>] do_one_initcall+0x42/0x170
    [<ffffffff81f159c8>] kernel_init_freeable+0x193/0x264
    [<ffffffff8197540e>] kernel_init+0xe/0xf0
    [<ffffffff81990a5c>] ret_from_fork+0x7c/0xb0
    [<ffffffffffffffff>] 0xffffffffffffffff

when call the function intel_ignore_i2c_device_register(), after use the
"info" param, the function did not free it, then kmemleak happen. To
fixing this is to free the param after use it.

Signed-off-by: Liwei Song <liwei.song@windriver.com>
---
 arch/x86/platform/intel-atom/platform_camera.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/arch/x86/platform/intel-atom/platform_camera.c b/arch/x86/platform/intel-atom/platform_camera.c
index 03a080e..d10926e 100644
--- a/arch/x86/platform/intel-atom/platform_camera.c
+++ b/arch/x86/platform/intel-atom/platform_camera.c
@@ -257,6 +257,7 @@ static void intel_ignore_i2c_device_register(int bus,
 	subdev_table[i].num_lanes = num_lanes;
 	
 	i++;
+	kfree(info);
 	return;
 }
 
-- 
1.7.5.4

