From fa6ae0bfe3b976a45945c99ea3ac10b3d02ea68e Mon Sep 17 00:00:00 2001
From: Maurice Petallo <mauricex.r.petallo@intel.com>
Date: Thu, 18 Aug 2016 11:23:25 +0800
Subject: [PATCH] serial: 8250_pci: mask UART TX completion intr in
 byt_set_termios

The code masking for TX completion interrupt was added as part
of enabling Intel Baytrail UART. At that time, this code executes
during initialization. Regression test on power management
suspend/resume reveals the need for this bit to be masked again
during controller resume. So, instead of doing the mask during
initialization, put it in byt_set_termios to make sure that the
bit is properly set even on the event of system suspend/resume.

Signed-off-by: Maurice Petallo <mauricex.r.petallo@intel.com>
Change-Id: I2518b8374b138b5bbae5d9fcdac7866591969eca
Reviewed-on: https://git-gar-1.devtools.intel.com/gerrit/3949
Reviewed-by: Kweh, Hock Leong <hock.leong.kweh@intel.com>
Reviewed-by: Wan Mohamad, Wan Ahmad Zainie <wan.ahmad.zainie.wan.mohamad@intel.com>
[Haiqing:Original patch taken from linux-yocto-3.10
         branch:origin/valleyisland-io-4.0
         commit c287aed0d235e69035fa1a00572934133902bf48]
Signed-off-by: Haiqing Bai <Haiqing.Bai@windriver.com>
---
 drivers/tty/serial/8250/8250_pci.c |    7 ++++---
 1 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/drivers/tty/serial/8250/8250_pci.c b/drivers/tty/serial/8250/8250_pci.c
index bb59d43..d441941 100644
--- a/drivers/tty/serial/8250/8250_pci.c
+++ b/drivers/tty/serial/8250/8250_pci.c
@@ -1390,6 +1390,10 @@ byt_set_termios(struct uart_port *p, struct ktermios *termios,
 	reg |= BYT_PRV_CLK_EN | BYT_PRV_CLK_UPDATE;
 	writel(reg, p->membase + BYT_PRV_CLK);
 
+	/* Disable Tx counter interrupts */
+	reg = readl(p->membase + BYT_TX_OVF_INT);
+	writel(reg | BYT_TX_OVF_INT_MASK, p->membase + BYT_TX_OVF_INT);
+
 	/*
 	 * If auto-handshake mechanism is not enabled,
 	 * disable rts_n override
@@ -1453,9 +1457,6 @@ byt_serial_setup(struct serial_private *priv,
 	port->dma = dma;
 	port->capabilities = UART_CAP_FIFO | UART_CAP_AFE;
 
-	/* Disable Tx counter interrupts */
-	writel(BYT_TX_OVF_INT_MASK, port->port.membase + BYT_TX_OVF_INT);
-
 	return ret;
 }
 
-- 
1.7.5.4

