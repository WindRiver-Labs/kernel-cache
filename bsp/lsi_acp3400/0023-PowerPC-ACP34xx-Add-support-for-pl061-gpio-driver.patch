From e05c9f15d1baaf36ae13d56a01e680aaf2bf40ed Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Mon, 18 Apr 2011 11:38:35 +0800
Subject: [PATCH 23/27] PowerPC:ACP34xx:Add support for pl061 gpio driver

ACP34xx GPIO block is consist of 2 ARM PrimeCell GPIO (PL061). Each
provide 8 gpio pins. The pins 4, 8, 11, 13(index starting from 0)
are reserved for some hardware.

The interrupt lines for each gpio (GPIOMIS[7:0]) are not connected
to PIC, it does not match the gpiolib framework's requirement.
As result, in dts for ACP34xx, the node for pl061 gpio should not
contain irq entry.

The driver update pl061 driver to use ACP34xx specific io routines,
and load init-pin map from device-tree to reserve certain pins for
hardware.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 drivers/gpio/pl061.c |   16 ++++++++++++++++
 1 files changed, 16 insertions(+), 0 deletions(-)

diff --git a/drivers/gpio/pl061.c b/drivers/gpio/pl061.c
index ec928b4..3300bec 100644
--- a/drivers/gpio/pl061.c
+++ b/drivers/gpio/pl061.c
@@ -31,6 +31,13 @@
 #include <linux/amba/pl061.h>
 #include <linux/slab.h>
 
+#ifdef CONFIG_ACPX1
+#define readb(addr) (char)readl(addr)
+#define writeb(b, addr) writel(b, addr)
+
+#define GPIO_AFSEL 0x420
+#endif
+
 #define GPIODIR 0x400
 #define GPIOIS  0x404
 #define GPIOIBE 0x408
@@ -398,6 +405,15 @@ static int __init pl061_of_probe(struct of_device *ofdev,
 
 	if (ret < 0)
 		return ret;
+
+#ifdef CONFIG_ACPX1
+	prop = of_get_property(ofdev->node, "pins-map", &len);
+	if (!prop || len < sizeof(*prop))
+		dev_warn(&ofdev->dev, "no 'pins-map' property\n");
+	else
+		writeb(*prop, chip->base + GPIO_AFSEL);
+#endif
+
 	return 0;
 }
 
-- 
1.7.0.5

