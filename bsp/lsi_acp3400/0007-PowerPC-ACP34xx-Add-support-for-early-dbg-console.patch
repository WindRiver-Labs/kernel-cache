From 606330ae01afe268cf2abd863d8364e62ccc6663 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Fri, 15 Apr 2011 19:48:15 +0800
Subject: [PATCH 07/27] PowerPC:ACP34xx:Add support for early dbg console.

This patch adds support for early dbg console support on LSI ACP34xx
board.

Fixed context to apply to Wind River kernel tree.
Extract from vendor drop patch lsi-patch 3.8.1.12.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/include/asm/udbg.h  |    3 +++
 arch/powerpc/kernel/udbg.c       |    4 ++++
 arch/powerpc/kernel/udbg_16550.c |   37 +++++++++++++++++++++++++++++++++++++
 3 files changed, 44 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/udbg.h b/arch/powerpc/include/asm/udbg.h
index 9d661d8..0014f32 100644
--- a/arch/powerpc/include/asm/udbg.h
+++ b/arch/powerpc/include/asm/udbg.h
@@ -49,6 +49,9 @@ extern void __init udbg_init_rtas_panel(void);
 extern void __init udbg_init_rtas_console(void);
 extern void __init udbg_init_debug_beat(void);
 extern void __init udbg_init_btext(void);
+#ifdef CONFIG_ACPX1
+extern void __init udbg_init_acp(void);
+#endif
 extern void __init udbg_init_44x_as1(void);
 extern void __init udbg_init_40x_realmode(void);
 extern void __init udbg_init_cpm(void);
diff --git a/arch/powerpc/kernel/udbg.c b/arch/powerpc/kernel/udbg.c
index 32934c0..3e9d918 100644
--- a/arch/powerpc/kernel/udbg.c
+++ b/arch/powerpc/kernel/udbg.c
@@ -54,7 +54,11 @@ void __init udbg_early_init(void)
 	udbg_init_btext();
 #elif defined(CONFIG_PPC_EARLY_DEBUG_44x)
 	/* PPC44x debug */
+#ifdef CONFIG_ACPX1
+	udbg_init_acp();
+#else
 	udbg_init_44x_as1();
+#endif
 #elif defined(CONFIG_PPC_EARLY_DEBUG_40x)
 	/* PPC40x debug */
 	udbg_init_40x_realmode();
diff --git a/arch/powerpc/kernel/udbg_16550.c b/arch/powerpc/kernel/udbg_16550.c
index 868c5f2..99ec964 100644
--- a/arch/powerpc/kernel/udbg_16550.c
+++ b/arch/powerpc/kernel/udbg_16550.c
@@ -7,6 +7,8 @@
  *      modify it under the terms of the GNU General Public License
  *      as published by the Free Software Foundation; either version
  *      2 of the License, or (at your option) any later version.
+ *
+ * These patches add ACP3400 support signed-off-by: john.jacques@lsi.com
  */
 #include <linux/types.h>
 #include <asm/udbg.h>
@@ -232,6 +234,41 @@ void udbg_init_pas_realmode(void)
 #endif /* CONFIG_PPC_MAPLE */
 
 #ifdef CONFIG_PPC_EARLY_DEBUG_44x
+#ifdef CONFIG_ACPX1
+#include <linux/amba/serial.h>
+
+#define UART0_BASE	(0xf0004000)
+static void *uart_base;
+
+static void acp_putc(char c)
+{
+	while (0 != (in_le32(uart_base + UART01x_FR) & UART01x_FR_TXFF))
+		;
+
+	if ('\n' == c) {
+		out_le32(uart_base + UART01x_DR, '\r');
+		while (0 != (in_le32(uart_base + UART01x_FR) & UART01x_FR_TXFF))
+			;
+	}
+
+	out_le32(uart_base + UART01x_DR, c);
+	return;
+}
+
+static int acp_getc(void)
+{
+	while (0 != (in_le32(uart_base + UART01x_FR) & UART01x_FR_RXFE))
+		;
+	return in_le32(uart_base + UART01x_DR);
+}
+
+void __init udbg_init_acp(void)
+{
+	uart_base = (void *)UART0_BASE;
+	udbg_putc = acp_putc;
+	udbg_getc = acp_getc;
+}
+#endif
 #include <platforms/44x/44x.h>
 
 static void udbg_44x_as1_flush(void)
-- 
1.7.0.5

