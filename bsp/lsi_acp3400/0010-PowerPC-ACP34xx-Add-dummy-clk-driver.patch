From 702fa5f0fba691d6351c37c2fe079d95e2c4dc6e Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Mon, 18 Apr 2011 09:40:32 +0800
Subject: [PATCH 10/27] PowerPC:ACP34xx:Add dummy clk driver

The ACP34xx board implements pl011 serial port & pl022 spi bus controller.
The drivers for pl011 & pl022 are designed for ARM AMBA bus, which
need a clk interface.
This patch add a dummy clock driver to satisfy AMBA implementation.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/platforms/44x/Kconfig    |    1 +
 arch/powerpc/platforms/44x/Makefile   |    2 +-
 arch/powerpc/platforms/44x/acpclock.c |   71 +++++++++++++++++++++++++++++++++
 arch/powerpc/platforms/44x/acpclock.h |    7 +++
 arch/powerpc/platforms/44x/acpx1.c    |    4 ++
 5 files changed, 84 insertions(+), 1 deletions(-)
 create mode 100644 arch/powerpc/platforms/44x/acpclock.c
 create mode 100644 arch/powerpc/platforms/44x/acpclock.h

diff --git a/arch/powerpc/platforms/44x/Kconfig b/arch/powerpc/platforms/44x/Kconfig
index 2f291f9..0d8e5a2 100644
--- a/arch/powerpc/platforms/44x/Kconfig
+++ b/arch/powerpc/platforms/44x/Kconfig
@@ -171,6 +171,7 @@ config ACPX1
 	bool "ACP on the X1 Platform"
 	depends on ACP
 	default n
+	select PPC_CLOCK
 	help
 	  This option enables support for the ACP on the X1 platform.
 
diff --git a/arch/powerpc/platforms/44x/Makefile b/arch/powerpc/platforms/44x/Makefile
index 969d447..4dde328 100644
--- a/arch/powerpc/platforms/44x/Makefile
+++ b/arch/powerpc/platforms/44x/Makefile
@@ -5,4 +5,4 @@ obj-$(CONFIG_SAM440EP) 	+= sam440ep.o
 obj-$(CONFIG_WARP)	+= warp.o
 obj-$(CONFIG_XILINX_VIRTEX_5_FXT) += virtex.o
 obj-$(CONFIG_XILINX_ML510) += virtex_ml510.o
-obj-$(CONFIG_ACPX1)	+= acpx1.o
+obj-$(CONFIG_ACPX1)	+= acpx1.o acpclock.o
diff --git a/arch/powerpc/platforms/44x/acpclock.c b/arch/powerpc/platforms/44x/acpclock.c
new file mode 100644
index 0000000..0a2c1a1
--- /dev/null
+++ b/arch/powerpc/platforms/44x/acpclock.c
@@ -0,0 +1,71 @@
+/*
+ * Copyright (C) 2010 Wind River Systems
+ *
+ * Some drivers like pl022 need clk interface. But now these drivers
+ * can work without it. So define a dummy clk driver for compile issue
+ * and future extend.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ */
+#include <linux/kernel.h>
+#include <linux/errno.h>
+#include <linux/err.h>
+#include <linux/clk.h>
+#include <linux/io.h>
+#include <asm/clk_interface.h>
+
+struct clk *acp_clk_get(struct device *dev, const char *id)
+{
+	return NULL;
+}
+
+void acp_clk_put(struct clk *clk)
+{
+	return;
+}
+
+int acp_clk_enable(struct clk *clk)
+{
+	return 0;
+}
+
+void acp_clk_disable(struct clk *clk)
+{
+	return;
+}
+
+unsigned long acp_clk_get_rate(struct clk *clk)
+{
+	return 0;
+}
+
+long acp_clk_round_rate(struct clk *clk, unsigned long rate)
+{
+	return 0;
+}
+
+int acp_clk_set_rate(struct clk *clk, unsigned long rate)
+{
+	return 0;
+}
+
+static struct clk_interface acp_clk_functions = {
+	.clk_get                = acp_clk_get,
+	.clk_enable             = acp_clk_enable,
+	.clk_disable            = acp_clk_disable,
+	.clk_get_rate           = acp_clk_get_rate,
+	.clk_put                = acp_clk_put,
+	.clk_round_rate         = acp_clk_round_rate,
+	.clk_set_rate           = acp_clk_set_rate,
+	.clk_set_parent         = NULL,
+	.clk_get_parent         = NULL,
+};
+
+int __init acp_clk_init(void)
+{
+	clk_functions = acp_clk_functions;
+	return 0;
+}
+EXPORT_SYMBOL(acp_clk_init);
diff --git a/arch/powerpc/platforms/44x/acpclock.h b/arch/powerpc/platforms/44x/acpclock.h
new file mode 100644
index 0000000..60b2b6c
--- /dev/null
+++ b/arch/powerpc/platforms/44x/acpclock.h
@@ -0,0 +1,7 @@
+#ifndef __ARCH_POWERPC_ACP_CLOCK_H
+#define __ARCH_POWERPC_ACP_CLOCK_H
+
+int acp_clk_init(void);
+
+#endif
+
diff --git a/arch/powerpc/platforms/44x/acpx1.c b/arch/powerpc/platforms/44x/acpx1.c
index 35e0488..4447da7 100644
--- a/arch/powerpc/platforms/44x/acpx1.c
+++ b/arch/powerpc/platforms/44x/acpx1.c
@@ -34,6 +34,8 @@
 #include <asm/mpic.h>
 #include <asm/mmu.h>
 
+#include "acpclock.h"
+
 static __initdata struct of_device_id acpx14xx_of_bus[] = {
 	{ .compatible = "ibm,plb4", },
 	{ .compatible = "ibm,plb6", },
@@ -44,6 +46,8 @@ static __initdata struct of_device_id acpx14xx_of_bus[] = {
 
 static int __init acpx14xx_device_probe(void)
 {
+	acp_clk_init();
+
 	of_platform_bus_probe(NULL, acpx14xx_of_bus, NULL);
 
 	return 0;
-- 
1.7.0.5

