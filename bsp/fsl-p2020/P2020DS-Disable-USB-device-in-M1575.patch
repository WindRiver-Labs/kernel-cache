From f07e0d345c78609a25dc097f7a750ffde96c4d66 Mon Sep 17 00:00:00 2001
From: yhe <yongli.he@windriver.com>
Date: Wed, 23 May 2012 15:00:33 +0800
Subject: [PATCH 05/23] P2020DS: Disable USB device in M1575

P2020ds pull USB CLK signal down. It is impossible to
access the deveice. we have to invalid it to un-classified device
to prevent access it.

Signed-off-by: Yongli He <yongli.he@windriver.com>
---
 arch/powerpc/sysdev/fsl_pci.c |   16 ++++++++++++++++
 include/linux/pci_ids.h       |    2 ++
 2 files changed, 18 insertions(+)

diff --git a/arch/powerpc/sysdev/fsl_pci.c b/arch/powerpc/sysdev/fsl_pci.c
index 6073288..c3f6563 100644
--- a/arch/powerpc/sysdev/fsl_pci.c
+++ b/arch/powerpc/sysdev/fsl_pci.c
@@ -54,6 +54,18 @@ static void __init quirk_fsl_pcie_header(struct pci_dev *dev)
 	return;
 }
 
+static void __init quirk_p2020ds_pci_header(struct pci_dev *dev)
+{
+
+	/* if we aren't p2020_ds don't bother */
+	if (!machine_is(p2020_ds))
+		return;
+	/* Disable Nvidia M1575 bridge on p2020_ds USB */
+	dev->device = 0xffff; /* be Illegal */
+	dev->class =  PCI_CLASS_OTHERS;
+	return;
+}
+
 static int __init fsl_pcie_check_link(struct pci_controller *hose)
 {
 	u32 val;
@@ -498,6 +510,10 @@ int __init fsl_add_bridge(struct device_node *dev, int is_primary)
 #endif /* CONFIG_FSL_SOC_BOOKE || CONFIG_PPC_86xx */
 
 DECLARE_PCI_FIXUP_HEADER(PCI_VENDOR_ID_FREESCALE, PCI_ANY_ID, quirk_fsl_pcie_header);
+/* P2020DS board pull USB clk signal to Ground, we must prevent PCI to acess USB device on the Nvidia M1575 */
+DECLARE_PCI_FIXUP_HEADER(PCI_VENDOR_ID_AL, PCI_DEVICE_ID_AL_M5237, quirk_p2020ds_pci_header);
+DECLARE_PCI_FIXUP_HEADER(PCI_VENDOR_ID_AL, PCI_DEVICE_ID_AL_M5239, quirk_p2020ds_pci_header);
+
 
 #if defined(CONFIG_PPC_83xx) || defined(CONFIG_PPC_MPC512x)
 struct mpc83xx_pcie_priv {
diff --git a/include/linux/pci_ids.h b/include/linux/pci_ids.h
index 3329965..6938b3b 100644
--- a/include/linux/pci_ids.h
+++ b/include/linux/pci_ids.h
@@ -1097,6 +1097,8 @@
 #define PCI_DEVICE_ID_AL_M5229		0x5229
 #define PCI_DEVICE_ID_AL_M5451		0x5451
 #define PCI_DEVICE_ID_AL_M7101		0x7101
+#define PCI_DEVICE_ID_AL_M5237		0x5237
+#define PCI_DEVICE_ID_AL_M5239		0x5239
 
 #define PCI_VENDOR_ID_NEOMAGIC		0x10c8
 #define PCI_DEVICE_ID_NEOMAGIC_NM256AV_AUDIO 0x8005
-- 
1.7.9.7

