From 8c4e36d9babd61edd4909518281b45d610b0f0ff Mon Sep 17 00:00:00 2001
From: Wei Yang <Wei.Yang@windriver.com>
Date: Thu, 25 Oct 2012 16:22:32 +0800
Subject: [PATCH 21/21] powerpc/smp: save each CPU's idle task structure

When enabling ftrace function profiling via the following command,

	 echo 1 >/sys/kernel/debug/tracing/function_profile_enabled

and then cycling CPU1 offline and online. the following warning call
trace is thrown by kernel.

WARNING: at kernel/trace/ftrace.c:4609

Modules linked in: loop jbd2 exportfs ext4 xfs jfs reiserfs squashfs
isofs cramfs jffs2 yaffs fat vfat msdos nls_cp437 nls_iso8859_1 tipc
[last unloaded: control_crash]
NIP: c00dbdec LR: c062a474 CTR: 00000000
REGS: ef8c5d60 TRAP: 0700   Tainted: G        W  O
(3.4.10-WR5.0.0.0_standard)
MSR: 00029000 <CE,EE,ME>  CR: 24042088  XER: 20000000
TASK = ef8d0e60[10] 'kworker/0:1' THREAD: ef8c4000 CPU: 0
GPR00: 00000001 ef8c5e10 ef8d0e60 eeac5640 00000001 80000000 00000000 a6290174
GPR08: 00f60000 00000000 ef8c4000 00f69000 24042082 00043382 00000000 3ff94374
GPR16: c0000a00 00000014 3fffffff 00ff6000 c08f0000 c08ef270 c08a5220 c08a5220
GPR24: ef8c4000 00000000 00029000 c180e240 00000000 00000004 00000001 eeac5640
NIP [c00dbdec] ftrace_graph_init_idle_task+0x58/0x10c
LR [c062a474] init_idle+0x164/0x194
Call Trace:
[ef8c5e10] [00000004] 0x4 (unreliable)
[ef8c5e30] [c062a474] init_idle+0x164/0x194
[ef8c5e50] [c0628ba4] fork_idle+0x90/0xa8
[ef8c5f20] [c06283d0] do_fork_idle+0x1c/0x3c
[ef8c5f30] [c0061308] process_one_work+0x15c/0x4b8
[ef8c5f70] [c0061ea8] worker_thread+0x198/0x370

When we successfully create idle task for each CPU, respectively,
we must invoke set_idle_for_cpu() to save the idle task structure to
the idle_thread_array variable for each CPU. The intention is to avoid
to recreate idle task when CPU is brought back online. If not, when CPU
is brought back online, the kernel will invoke fork_idle() to recreate
idle task, The function will eventually trigger trace_graph_init_task()
that allocate a return stack for newly created task. The new allocated
return stack must be not equal the idle_ret_stack variable. Hence,When
CPU is brought online, the WARNING is generated.

Signed-off-by: Wei Yang <Wei.Yang@windriver.com>
---
 arch/powerpc/kernel/smp.c |    1 +
 1 file changed, 1 insertion(+)

diff --git a/arch/powerpc/kernel/smp.c b/arch/powerpc/kernel/smp.c
index 8c0bd2f..eaa2f20 100644
--- a/arch/powerpc/kernel/smp.c
+++ b/arch/powerpc/kernel/smp.c
@@ -481,6 +481,7 @@ static int __cpuinit create_idle(unsigned int cpu)
 	if (!c_idle.idle) {
 		schedule_work(&c_idle.work);
 		wait_for_completion(&c_idle.done);
+		set_idle_for_cpu(cpu, c_idle.idle);
 	} else
 		init_idle(c_idle.idle, cpu);
 	if (IS_ERR(c_idle.idle)) {		
-- 
1.7.9.7

