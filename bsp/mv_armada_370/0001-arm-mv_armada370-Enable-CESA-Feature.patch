From 88a9dabbff8141bfedaa2d5b02c5d5839d79f7ce Mon Sep 17 00:00:00 2001
From: Aaron Ma <pengyu.ma@windriver.com>
Date: Fri, 27 Jul 2012 10:47:46 +0800
Subject: [PATCH 1/2] arm/mv_armada370: Enable CESA Feature

Fix cryptodev.h include to the OCF cryptodev.h location.
The CESA is the hw crypto engine and this driver is implemented as
OCF driver, the kernel should init OCF first, to achieve this, CESA
init is changed to a late initcall.
OCF should init independently not by CESA.

Signed-off-by: Pengyu Ma <pengyu.ma@windriver.com>
---
 .../mv_drivers_lsp/mv_cesa/cesa_ocf_drv.c          |   12 ++----------
 1 files changed, 2 insertions(+), 10 deletions(-)

diff --git a/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/cesa_ocf_drv.c b/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/cesa_ocf_drv.c
index 1cd83ce..78634e7 100644
--- a/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/cesa_ocf_drv.c
+++ b/arch/arm/plat-armada/mv_drivers_lsp/mv_cesa/cesa_ocf_drv.c
@@ -39,7 +39,7 @@ disclaimer.
 #include "ctrlEnv/mvCtrlEnvLib.h"
 #include "cesa/mvCesaIf.h" /* moved here before cryptodev.h due to include dependencies */
 #include "mvSysCesaApi.h"
-#include <cryptodev.h>
+#include <linux/cryptodev.h>
 #include <uio.h>
 
 #include "mvDebug.h"
@@ -1102,10 +1102,6 @@ cesa_ocf_freesession(device_t dev, u_int64_t tid)
         return 0;
 }
 
-#if (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,30))
-extern int crypto_init(void);
-#endif
-
 /*
  * our driver startup and shutdown routines
  */
@@ -1118,10 +1114,6 @@ cesa_ocf_init(void)
 	if (mvCtrlPwrClckGet(CESA_UNIT_ID, 0) == MV_FALSE)
 		return 0;
 
-#if (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,30))
-	crypto_init();
-#endif
-
 #if defined(CONFIG_MV78200) || defined(CONFIG_MV632X)
 	if (MV_FALSE == mvSocUnitIsMappedToThisCpu(CESA))
 	{
@@ -1227,7 +1219,7 @@ cesa_ocf_exit(void)
 	}
 }
 
-module_init(cesa_ocf_init);
+late_initcall(cesa_ocf_init);
 module_exit(cesa_ocf_exit);
 
 MODULE_LICENSE("Marvell/GPL");
-- 
1.7.3.4

