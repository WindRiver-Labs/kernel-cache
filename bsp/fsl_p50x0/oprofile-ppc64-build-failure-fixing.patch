From 80c2a1e6d4dccd7ea576f6487468eba737b0c295 Mon Sep 17 00:00:00 2001
From: Yongli He <yongli.he@windriver.com>
Date: Tue, 5 Jul 2011 13:20:16 +0800
Subject: [PATCH 2/8] oprofile ppc64 build failure fixing

mtmsrd only valid under PPC_BOOK3S_64, use mtmsr on e5500.

Signed-off-by: Yongli He <yongli.he@windriver.com>
---
 arch/powerpc/oprofile/op_model_power4.c |    8 ++++++++
 arch/powerpc/oprofile/op_model_rs64.c   |    9 +++++++++
 2 files changed, 17 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/oprofile/op_model_power4.c b/arch/powerpc/oprofile/op_model_power4.c
index 8077409..c092e62 100644
--- a/arch/powerpc/oprofile/op_model_power4.c
+++ b/arch/powerpc/oprofile/op_model_power4.c
@@ -130,7 +130,11 @@ static int power4_start(struct op_counter_config *ctr)
 	unsigned int mmcr0;
 
 	/* set the PMM bit (see comment below) */
+#ifdef CONFIG_PPC_BOOK3S_64
 	mtmsrd(mfmsr() | MSR_PMM);
+#else
+	mtmsr(mfmsr() | MSR_PMM);
+#endif
 
 	for (i = 0; i < cur_cpu_spec->num_pmcs; ++i) {
 		if (ctr[i].enabled) {
@@ -277,7 +281,11 @@ static void power4_handle_interrupt(struct pt_regs *regs,
 	is_kernel = get_kernel(pc, mmcra);
 
 	/* set the PMM bit (see comment below) */
+#ifdef CONFIG_PPC_BOOK3S_64
 	mtmsrd(mfmsr() | MSR_PMM);
+#else
+	mtmsr(mfmsr() | MSR_PMM);
+#endif
 
 	for (i = 0; i < cur_cpu_spec->num_pmcs; ++i) {
 		val = classic_ctr_read(i);
diff --git a/arch/powerpc/oprofile/op_model_rs64.c b/arch/powerpc/oprofile/op_model_rs64.c
index a20afe4..74c79c3 100644
--- a/arch/powerpc/oprofile/op_model_rs64.c
+++ b/arch/powerpc/oprofile/op_model_rs64.c
@@ -15,6 +15,7 @@
 #include <asm/processor.h>
 #include <asm/cputable.h>
 #include <asm/oprofile_impl.h>
+#include <asm/reg.h>
 
 #define dbg(args...)
 
@@ -136,7 +137,11 @@ static int rs64_start(struct op_counter_config *ctr)
 	unsigned int mmcr0;
 
 	/* set the PMM bit (see comment below) */
+#ifdef CONFIG_PPC_BOOK3S_64
 	mtmsrd(mfmsr() | MSR_PMM);
+#else
+	mtmsr(mfmsr() | MSR_PMM);
+#endif
 
 	for (i = 0; i < num_counters; ++i) {
 		if (ctr[i].enabled) {
@@ -187,7 +192,11 @@ static void rs64_handle_interrupt(struct pt_regs *regs,
 	is_kernel = is_kernel_addr(pc);
 
 	/* set the PMM bit (see comment below) */
+#ifdef CONFIG_PPC_BOOK3S_64
 	mtmsrd(mfmsr() | MSR_PMM);
+#else
+	mtmsr(mfmsr() | MSR_PMM);
+#endif
 
 	for (i = 0; i < num_counters; ++i) {
 		val = classic_ctr_read(i);
-- 
1.7.0.4

