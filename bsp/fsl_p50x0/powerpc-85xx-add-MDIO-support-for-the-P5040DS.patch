From fc104368ec895dbe17381aeeb340e593140fe47d Mon Sep 17 00:00:00 2001
From: Timur Tabi <timur@freescale.com>
Date: Mon, 16 Apr 2012 10:33:20 -0500
Subject: [PATCH 03/23] powerpc/85xx: add MDIO support for the P5040DS

Add support for the muxing MDIO buses on the P5040DS (Super Hydra).  This
includes MDIO and PHY nodes in the device tree, a virtual MDIO board
driver (superhydra_mdio.c), and miscellaneous other networking-related
device tree updates

The DTS contains virtual MDIO nodes for the RGMII ports and each slot that
can hold an SGMII or XAUI card.  U-Boot will update the phy-handle pointers.
The mux values are already correct in the DTS

Signed-off-by: Timur Tabi <timur@freescale.com>
Signed-off-by: Haiying Wang <Haiying.Wang@freescale.com>
[Kevin: Original patch taken from FSL
QorIQ-SDK-V1.2-SOURCE-20120614-yocto.iso ISO image.
Using monolithic dts for p5040ds.]
Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/boot/dts/p5040ds.dts        |  504 +++++++++++++++++++++++++-----
 arch/powerpc/platforms/85xx/corenet_ds.c |    3 +
 arch/powerpc/platforms/85xx/hydra_mdio.c |   20 +-
 3 files changed, 448 insertions(+), 79 deletions(-)

diff --git a/arch/powerpc/boot/dts/p5040ds.dts b/arch/powerpc/boot/dts/p5040ds.dts
index 0808157..6f6a709 100644
--- a/arch/powerpc/boot/dts/p5040ds.dts
+++ b/arch/powerpc/boot/dts/p5040ds.dts
@@ -81,29 +81,48 @@
 		bman = &bman;
 		qman = &qman;
 		fman0 = &fman0;
-
-		ethernet0 = &enet0;
-		ethernet1 = &enet1;
-		ethernet2 = &enet2;
-		ethernet3 = &enet3;
-		ethernet4 = &enet4;
-		ethernet5 = &enet5;
-		phy_rgmii_0 = &phy_rgmii_0;
-		phy_rgmii_1 = &phy_rgmii_1;
-/*		phy_sgmii_1c = &phy_sgmii_1c;
-		phy_sgmii_1d = &phy_sgmii_1d;
-		phy_sgmii_1e = &phy_sgmii_1e;
-		phy_sgmii_1f = &phy_sgmii_1f;
-		phy_xgmii_1 = &phy_xgmii_1;
-*/		phy_xgmii_2 = &phy_xgmii_slot_2;
-
-		emi1_rgmii = &hydra_rg;
-		emi1_sgmii_slot2 = &hydra_sg_slt2;
-		emi1_sgmii_slot3 = &hydra_sg_slt3;
-		emi1_sgmii_slot5 = &hydra_sg_slt5;
-		emi1_sgmii_slot6 = &hydra_sg_slt6;
-/*		emi2_xgmii_slot1 = &hydra_xg_slt1;*/
-		emi2_xgmii_slot2 = &hydra_xg_slt2;
+		fman1 = &fman1;
+
+		ethernet0 = &fm1dtsec1;
+		ethernet1 = &fm1dtsec2;
+		ethernet2 = &fm1dtsec3;
+		ethernet3 = &fm1dtsec4;
+		ethernet4 = &fm1dtsec5;
+		ethernet5 = &fm1tgec;
+		ethernet6 = &fm2dtsec1;
+		ethernet7 = &fm2dtsec2;
+		ethernet8 = &fm2dtsec3;
+		ethernet9 = &fm2dtsec4;
+		ethernet10 = &fm2dtsec5;
+		ethernet11 = &fm2tgec;
+
+		phy_sgmii_slot2_1c = &phy_sgmii_slot2_1c;
+		phy_sgmii_slot2_1d = &phy_sgmii_slot2_1d;
+		phy_sgmii_slot2_1e = &phy_sgmii_slot2_1e;
+		phy_sgmii_slot2_1f = &phy_sgmii_slot2_1f;
+
+		phy_sgmii_slot3_1c = &phy_sgmii_slot3_1c;
+		phy_sgmii_slot3_1d = &phy_sgmii_slot3_1d;
+		phy_sgmii_slot3_1e = &phy_sgmii_slot3_1e;
+		phy_sgmii_slot3_1f = &phy_sgmii_slot3_1f;
+
+		phy_sgmii_slot5_1c = &phy_sgmii_slot5_1c;
+		phy_sgmii_slot5_1d = &phy_sgmii_slot5_1d;
+		phy_sgmii_slot5_1e = &phy_sgmii_slot5_1e;
+		phy_sgmii_slot5_1f = &phy_sgmii_slot5_1f;
+
+		phy_sgmii_slot6_1c = &phy_sgmii_slot6_1c;
+		phy_sgmii_slot6_1d = &phy_sgmii_slot6_1d;
+		phy_sgmii_slot6_1e = &phy_sgmii_slot6_1e;
+		phy_sgmii_slot6_1f = &phy_sgmii_slot6_1f;
+
+		hydra_rg = &hydra_rg;
+		hydra_sg_slot2 = &hydra_sg_slot2;
+		hydra_sg_slot3 = &hydra_sg_slot3;
+		hydra_sg_slot5 = &hydra_sg_slot5;
+		hydra_sg_slot6 = &hydra_sg_slot6;
+		hydra_xg_slot1 = &hydra_xg_slot1;
+		hydra_xg_slot2 = &hydra_xg_slot2;
 	};
 
 	cpus {
@@ -1133,14 +1152,13 @@
 				fsl,qman-channel-id = <0x41>;
 			};
 
-			enet0: ethernet@e0000 {
+			fm1dtsec1: ethernet@e0000 {
 				cell-index = <0>;
 				compatible = "fsl,fman-1g-mac";
 				reg = <0xe0000 0x1000>;
 				fsl,port-handles = <&fman0_rx0 &fman0_tx0>;
 				ptimer-handle = <&ptp_timer0>;
 				tbi-handle = <&tbi0>;
-				//phy-handle = <&phy_sgmii_1c>;
 				phy-connection-type = "sgmii";
 			};
 
@@ -1166,8 +1184,8 @@
 					#size-cells = <0>;
 					compatible = "fsl,hydra-mdio";
 					fsl,mdio-handle = <&mdio0>;
-					fsl,hydra-mdio-mux-val = <0x00>;
-					fsl,hydra-mdio-mux-mask = <0x00>;
+					fsl,hydra-mdio-mux-val = <0x08>;
+					fsl,hydra-mdio-mux-mask = <0x70>;
 					status = "disabled";
 
 					phy_rgmii_0: ethernet-phy@0 {
@@ -1179,22 +1197,17 @@
 				};
 
 				/*
-				 * Virtual MDIO for the four-port SGMII card.
-				 * The fsl,hydra-mdio-muxval property will be
-				 * fixed-up by U-Boot based on the slot that
-				 * the SGMII card is in.
-				 *
-				 * Note: we do not support DTSEC5 connected to
-				 * SGMII, so this is the only SGMII node.
+				 * Virtual MDIO for the four-port SGMII cards.
 				 */
+
 				/* This for Slot 2 */
-				hydra_sg_slt2: hydra-sg-slt2 {
+				hydra_sg_slot2: hydra-sg-slot2 {
 					#address-cells = <1>;
 					#size-cells = <0>;
 					compatible = "fsl,hydra-mdio";
 					fsl,mdio-handle = <&mdio0>;
-					fsl,hydra-mdio-mux-val = <0x00>;
-					fsl,hydra-mdio-mux-mask = <0x00>;
+					fsl,hydra-mdio-mux-val = <0x28>;
+					fsl,hydra-mdio-mux-mask = <0x70>;
 					status = "disabled";
 
 					phy_sgmii_slot2_1c: ethernet-phy@1c {
@@ -1210,14 +1223,15 @@
 						reg = <0x1f>;
 					};
 				};
+
 				/* This for Slot 3 */
-				hydra_sg_slt3: hydra-sg-slt3 {
+				hydra_sg_slot3: hydra-sg-slot3 {
 					#address-cells = <1>;
 					#size-cells = <0>;
 					compatible = "fsl,hydra-mdio";
 					fsl,mdio-handle = <&mdio0>;
-					fsl,hydra-mdio-mux-val = <0x00>;
-					fsl,hydra-mdio-mux-mask = <0x00>;
+					fsl,hydra-mdio-mux-val = <0x68>;
+					fsl,hydra-mdio-mux-mask = <0x70>;
 					status = "disabled";
 
 					phy_sgmii_slot3_1c: ethernet-phy@1c {
@@ -1233,14 +1247,15 @@
 						reg = <0x1f>;
 					};
 				};
+
 				/* This for Slot 5 */
-				hydra_sg_slt5: hydra-sg-slt5 {
+				hydra_sg_slot5: hydra-sg-slot5 {
 					#address-cells = <1>;
 					#size-cells = <0>;
 					compatible = "fsl,hydra-mdio";
 					fsl,mdio-handle = <&mdio0>;
-					fsl,hydra-mdio-mux-val = <0x00>;
-					fsl,hydra-mdio-mux-mask = <0x00>;
+					fsl,hydra-mdio-mux-val = <0x38>;
+					fsl,hydra-mdio-mux-mask = <0x70>;
 					status = "disabled";
 
 					phy_sgmii_slot5_1c: ethernet-phy@1c {
@@ -1256,14 +1271,15 @@
 						reg = <0x1f>;
 					};
 				};
+
 				/* This for Slot 6 */
-				hydra_sg_slt6: hydra-sg-slt6 {
+				hydra_sg_slot6: hydra-sg-slot6 {
 					#address-cells = <1>;
 					#size-cells = <0>;
 					compatible = "fsl,hydra-mdio";
 					fsl,mdio-handle = <&mdio0>;
-					fsl,hydra-mdio-mux-val = <0x00>;
-					fsl,hydra-mdio-mux-mask = <0x00>;
+					fsl,hydra-mdio-mux-val = <0x48>;
+					fsl,hydra-mdio-mux-mask = <0x70>;
 					status = "disabled";
 
 					phy_sgmii_slot6_1c: ethernet-phy@1c {
@@ -1295,14 +1311,13 @@
 				fsl,qman-channel-id = <0x42>;
 			};
 
-			enet1: ethernet@e2000 {
+			fm1dtsec2: ethernet@e2000 {
 				cell-index = <1>;
 				compatible = "fsl,fman-1g-mac";
 				reg = <0xe2000 0x1000>;
 				fsl,port-handles = <&fman0_rx1 &fman0_tx1>;
 				ptimer-handle = <&ptp_timer0>;
 				tbi-handle = <&tbi1>;
-				//phy-handle = <&phy_sgmii_1d>;
 				phy-connection-type = "sgmii";
 			};
 
@@ -1332,14 +1347,13 @@
 				fsl,qman-channel-id = <0x43>;
 			};
 
-			enet2: ethernet@e4000 {
+			fm1dtsec3: ethernet@e4000 {
 				cell-index = <2>;
 				compatible = "fsl,fman-1g-mac";
 				reg = <0xe4000 0x1000>;
 				fsl,port-handles = <&fman0_rx2 &fman0_tx2>;
 				ptimer-handle = <&ptp_timer0>;
 				tbi-handle = <&tbi2>;
-				//phy-handle = <&phy_sgmii_1e>;
 				phy-connection-type = "sgmii";
 			};
 
@@ -1369,14 +1383,13 @@
 				fsl,qman-channel-id = <0x44>;
 			};
 
-			enet3: ethernet@e6000 {
+			fm1dtsec4: ethernet@e6000 {
 				cell-index = <3>;
 				compatible = "fsl,fman-1g-mac";
 				reg = <0xe6000 0x1000>;
 				fsl,port-handles = <&fman0_rx3 &fman0_tx3>;
 				ptimer-handle = <&ptp_timer0>;
 				tbi-handle = <&tbi3>;
-				//phy-handle = <&phy_sgmii_1f>;
 				phy-connection-type = "sgmii";
 			};
 
@@ -1406,14 +1419,13 @@
 				fsl,qman-channel-id = <0x45>;
 			};
 
-			enet4: ethernet@e8000 {
+			fm1dtsec5: ethernet@e8000 {
 				cell-index = <4>;
 				compatible = "fsl,fman-1g-mac";
 				reg = <0xe8000 0x1000>;
 				fsl,port-handles = <&fman0_rx4 &fman0_tx4>;
 				ptimer-handle = <&ptp_timer0>;
 				tbi-handle = <&tbi4>;
-				/* GETH1 on the board */
 				phy-handle = <&phy_rgmii_0>;
 				phy-connection-type = "rgmii";
 			};
@@ -1444,15 +1456,11 @@
 				fsl,qman-channel-id = <0x40>;
 			};
 
-			enet5: ethernet@f0000 {
+			fm1tgec: ethernet@f0000 {
 				cell-index = <0>;
 				compatible = "fsl,fman-10g-mac";
 				reg = <0xf0000 0x1000>;
 				fsl,port-handles = <&fman0_10g_rx0 &fman0_10g_tx0>;
-				/*
-				 * phy-handle will be updated by U-Boot to
-				 * reflect the actual slot the XAUI card is in.
-				 */
 				phy-handle = <&phy_xgmii_slot_2>;
 				phy-connection-type = "xgmii";
 			};
@@ -1465,7 +1473,6 @@
 			 * only one of the ethernet-phy nodes below will be
 			 * used.
 			 */
-			/* Adding parent xmdio node to add the 2nd mdio bus later */
 			xmdio0: mdio@f1000 {
 				#address-cells = <1>;
 				#size-cells = <0>;
@@ -1473,30 +1480,351 @@
 				reg = <0xf1000 0x1000>;
 				interrupts = <100 1 0 0>;
 
-				hydra_xg_slt2: hydra-xg-slt2 {
+				/* FM2 10GEC1 is always on slot 1 */
+				hydra_xg_slot1: hydra-xg-slot1 {
 					#address-cells = <1>;
 					#size-cells = <0>;
 					compatible = "fsl,hydra-xmdio";
 					fsl,mdio-handle = <&xmdio0>;
 					fsl,hydra-mdio-mux-val = <0x00>;
-					fsl,hydra-mdio-mux-mask = <0x00>;
+					fsl,hydra-mdio-mux-mask = <0x06>;
 					status = "disabled";
 
-					/* FM1 10GEC1 is always on slot 2 */
-					/* XAUI card in slot 1 */
-					/*phy_xgmii_1: ethernet-phy@4 {
-						reg = <0x4>;
+					phy_xgmii_slot_1: ethernet-phy@0 {
+						reg = <4>;
 					};
-					*/
-					/* XAUI card in slot 2 */
-					phy_xgmii_slot_2: ethernet-phy@0 {
-						reg = <0x0>;
+				};
+
+				/* FM1 10GEC1 is always on slot 2 */
+				hydra_xg_slot2: hydra-xg-slot2 {
+					#address-cells = <1>;
+					#size-cells = <0>;
+					compatible = "fsl,hydra-xmdio";
+					fsl,mdio-handle = <&xmdio0>;
+					fsl,hydra-mdio-mux-val = <0x02>;
+					fsl,hydra-mdio-mux-mask = <0x06>;
+					status = "disabled";
+
+					phy_xgmii_slot_2: ethernet-phy@4 {
+						reg = <0>;
 					};
 				};
 			};
 
 		};
 
+		fman1: fman@500000 {
+			#address-cells = <1>;
+			#size-cells = <1>;
+			cell-index = <1>;
+			compatible = "fsl,fman", "simple-bus";
+			ranges = <0 0x500000 0x100000>;
+			reg = <0x500000 0x100000>;
+			clock-frequency = <0>;
+			interrupts = <
+				97 2 0 0
+				16 2 1 0>;
+
+			cc {
+				compatible = "fsl,fman-cc";
+			};
+
+			muram@0 {
+				compatible = "fsl,fman-muram";
+				reg = <0x0 0x28000>;
+			};
+
+			bmi@80000 {
+				compatible = "fsl,fman-bmi";
+				reg = <0x80000 0x400>;
+			};
+
+			qmi@80400 {
+				compatible = "fsl,fman-qmi";
+				reg = <0x80400 0x400>;
+			};
+
+			fman1_oh0: port@81000 {
+				cell-index = <0>;
+				compatible = "fsl,fman-port-oh";
+				reg = <0x81000 0x1000>;
+				fsl,qman-channel-id = <0x66>;
+			};
+
+			fman1_oh1: port@82000 {
+				cell-index = <1>;
+				compatible = "fsl,fman-port-oh";
+				reg = <0x82000 0x1000>;
+				fsl,qman-channel-id = <0x67>;
+			};
+
+			fman1_oh2: port@83000 {
+				cell-index = <2>;
+				compatible = "fsl,fman-port-oh";
+				reg = <0x83000 0x1000>;
+				fsl,qman-channel-id = <0x68>;
+			};
+
+			fman1_oh3: port@84000 {
+				cell-index = <3>;
+				compatible = "fsl,fman-port-oh";
+				reg = <0x84000 0x1000>;
+				fsl,qman-channel-id = <0x69>;
+			};
+
+			fman1_oh4: port@85000 {
+				cell-index = <4>;
+				compatible = "fsl,fman-port-oh";
+				reg = <0x85000 0x1000>;
+				fsl,qman-channel-id = <0x6a>;
+			};
+
+			fman1_oh5: port@86000 {
+				cell-index = <5>;
+				compatible = "fsl,fman-port-oh";
+				reg = <0x86000 0x1000>;
+				fsl,qman-channel-id = <0x6b>;
+			};
+
+			fman1_oh6: port@87000 {
+				cell-index = <6>;
+				compatible = "fsl,fman-port-oh";
+				reg = <0x87000 0x1000>;
+			};
+
+			policer@c0000 {
+				compatible = "fsl,fman-policer";
+				reg = <0xc0000 0x1000>;
+			};
+
+			keygen@c1000 {
+				compatible = "fsl,fman-keygen";
+				reg = <0xc1000 0x1000>;
+			};
+
+			dma@c2000 {
+				compatible = "fsl,fman-dma";
+				reg = <0xc2000 0x1000>;
+			};
+
+			fpm@c3000 {
+				compatible = "fsl,fman-fpm";
+				reg = <0xc3000 0x1000>;
+			};
+
+			parser@c7000 {
+				compatible = "fsl,fman-parser";
+				reg = <0xc7000 0x1000>;
+			};
+
+			ptp_timer1: rtc@fe000 {
+				compatible = "fsl,fman-rtc";
+				reg = <0xfe000 0x1000>;
+			};
+
+			fman1_rx0: port@88000 {
+				cell-index = <0>;
+				compatible = "fsl,fman-port-1g-rx";
+				reg = <0x88000 0x1000>;
+			};
+
+			fman1_tx0: port@a8000 {
+				cell-index = <0>;
+				compatible = "fsl,fman-port-1g-tx";
+				reg = <0xa8000 0x1000>;
+				fsl,qman-channel-id = <0x61>;
+			};
+
+			fm2dtsec1: ethernet@e0000 {
+				cell-index = <0>;
+				compatible = "fsl,fman-1g-mac";
+				reg = <0xe0000 0x1000>;
+				fsl,port-handles = <&fman1_rx0 &fman1_tx0>;
+				ptimer-handle = <&ptp_timer1>;
+				tbi-handle = <&tbi5>;
+				phy-connection-type = "sgmii";
+			};
+
+			mdio@e1120 {
+				#address-cells = <1>;
+				#size-cells = <0>;
+				compatible = "fsl,fman-tbi";
+				reg = <0xe1120 0xee0>;
+				interrupts = <101 1 0 0>;
+
+				tbi5: tbi-phy@8 {
+					reg = <8>;
+					device_type = "tbi-phy";
+				};
+			};
+
+			fman1_rx1: port@89000 {
+				cell-index = <1>;
+				compatible = "fsl,fman-port-1g-rx";
+				reg = <0x89000 0x1000>;
+			};
+
+			fman1_tx1: port@a9000 {
+				cell-index = <1>;
+				compatible = "fsl,fman-port-1g-tx";
+				reg = <0xa9000 0x1000>;
+				fsl,qman-channel-id = <0x62>;
+			};
+
+			fm2dtsec2: ethernet@e2000 {
+				cell-index = <1>;
+				compatible = "fsl,fman-1g-mac";
+				reg = <0xe2000 0x1000>;
+				fsl,port-handles = <&fman1_rx1 &fman1_tx1>;
+				ptimer-handle = <&ptp_timer1>;
+				tbi-handle = <&tbi6>;
+				phy-connection-type = "sgmii";
+			};
+
+			mdio@e3120 {
+				#address-cells = <1>;
+				#size-cells = <0>;
+				compatible = "fsl,fman-tbi";
+				reg = <0xe3120 0xee0>;
+				interrupts = <101 1 0 0>;
+
+				tbi6: tbi-phy@8 {
+					reg = <8>;
+					device_type = "tbi-phy";
+				};
+			};
+
+			fman1_rx2: port@8a000 {
+				cell-index = <2>;
+				compatible = "fsl,fman-port-1g-rx";
+				reg = <0x8a000 0x1000>;
+			};
+
+			fman1_tx2: port@aa000 {
+				cell-index = <2>;
+				compatible = "fsl,fman-port-1g-tx";
+				reg = <0xaa000 0x1000>;
+				fsl,qman-channel-id = <0x63>;
+			};
+
+			fm2dtsec3: ethernet@e4000 {
+				cell-index = <2>;
+				compatible = "fsl,fman-1g-mac";
+				reg = <0xe4000 0x1000>;
+				fsl,port-handles = <&fman1_rx2 &fman1_tx2>;
+				ptimer-handle = <&ptp_timer1>;
+				tbi-handle = <&tbi7>;
+				phy-connection-type = "sgmii";
+			};
+
+			mdio@e5120 {
+				#address-cells = <1>;
+				#size-cells = <0>;
+				compatible = "fsl,fman-tbi";
+				reg = <0xe5120 0xee0>;
+				interrupts = <101 1 0 0>;
+
+				tbi7: tbi-phy@8 {
+					reg = <8>;
+					device_type = "tbi-phy";
+				};
+			};
+
+			fman1_rx3: port@8b000 {
+				cell-index = <3>;
+				compatible = "fsl,fman-port-1g-rx";
+				reg = <0x8b000 0x1000>;
+			};
+
+			fman1_tx3: port@ab000 {
+				cell-index = <3>;
+				compatible = "fsl,fman-port-1g-tx";
+				reg = <0xab000 0x1000>;
+				fsl,qman-channel-id = <0x64>;
+			};
+
+			fm2dtsec4: ethernet@e6000 {
+				cell-index = <3>;
+				compatible = "fsl,fman-1g-mac";
+				reg = <0xe6000 0x1000>;
+				fsl,port-handles = <&fman1_rx3 &fman1_tx3>;
+				ptimer-handle = <&ptp_timer1>;
+				tbi-handle = <&tbi8>;
+				phy-connection-type = "sgmii";
+			};
+
+			mdio@e7120 {
+				#address-cells = <1>;
+				#size-cells = <0>;
+				compatible = "fsl,fman-tbi";
+				reg = <0xe7120 0xee0>;
+				interrupts = <101 1 0 0>;
+
+				tbi8: tbi-phy@8 {
+					reg = <8>;
+					device_type = "tbi-phy";
+				};
+			};
+
+			fman1_rx4: port@8c000 {
+				cell-index = <4>;
+				compatible = "fsl,fman-port-1g-rx";
+				reg = <0x8c000 0x1000>;
+			};
+
+			fman1_tx4: port@ac000 {
+				cell-index = <4>;
+				compatible = "fsl,fman-port-1g-tx";
+				reg = <0xac000 0x1000>;
+				fsl,qman-channel-id = <0x65>;
+			};
+
+			fm2dtsec5: ethernet@e8000 {
+				cell-index = <4>;
+				compatible = "fsl,fman-1g-mac";
+				reg = <0xe8000 0x1000>;
+				fsl,port-handles = <&fman1_rx4 &fman1_tx4>;
+				ptimer-handle = <&ptp_timer1>;
+				tbi-handle = <&tbi9>;
+				phy-handle = <&phy_rgmii_1>;
+				phy-connection-type = "rgmii";
+			};
+
+			mdio@e9120 {
+				#address-cells = <1>;
+				#size-cells = <0>;
+				compatible = "fsl,fman-tbi";
+				reg = <0xe9120 0xee0>;
+				interrupts = <101 1 0 0>;
+				tbi9: tbi-phy@8 {
+					reg = <8>;
+					device_type = "tbi-phy";
+				};
+			};
+
+			fman1_10g_rx0: port@90000 {
+				cell-index = <0>;
+				compatible = "fsl,fman-port-10g-rx";
+				reg = <0x90000 0x1000>;
+			};
+
+			fman1_10g_tx0: port@b0000 {
+				cell-index = <0>;
+				compatible = "fsl,fman-port-10g-tx";
+				reg = <0xb0000 0x1000>;
+				fsl,qman-channel-id = <0x60>;
+			};
+
+			fm2tgec: ethernet@f0000 {
+				cell-index = <0>;
+				compatible = "fsl,fman-10g-mac";
+				reg = <0xf0000 0x1000>;
+				fsl,port-handles = <&fman1_10g_rx0 &fman1_10g_tx0>;
+				phy-handle = <&phy_xgmii_slot_1>;
+				phy-connection-type = "xgmii";
+			};
+		};
+
 		raideng: raideng@320000 {
 			compatible = "fsl,raideng-v1.0";
 			#address-cells = <1>;
@@ -1727,27 +2055,51 @@
 
 		ethernet@0 {
 			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet0>;
+			fsl,fman-mac = <&fm1dtsec1>;
 		};
 		ethernet@1 {
 			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet1>;
+			fsl,fman-mac = <&fm1dtsec2>;
 		};
 		ethernet@2 {
 			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet2>;
+			fsl,fman-mac = <&fm1dtsec3>;
 		};
 		ethernet@3 {
 			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet3>;
+			fsl,fman-mac = <&fm1dtsec4>;
 		};
 		ethernet@4 {
 			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet4>;
+			fsl,fman-mac = <&fm1dtsec5>;
 		};
 		ethernet@5 {
 			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
-			fsl,fman-mac = <&enet5>;
+			fsl,fman-mac = <&fm1tgec>;
+		};
+		ethernet@6 {
+			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,fman-mac = <&fm2dtsec1>;
+		};
+		ethernet@7 {
+			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,fman-mac = <&fm2dtsec2>;
+		};
+		ethernet@8 {
+			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,fman-mac = <&fm2dtsec3>;
+		};
+		ethernet@9 {
+			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,fman-mac = <&fm2dtsec4>;
+		};
+		ethernet@10 {
+			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,fman-mac = <&fm2dtsec5>;
+		};
+		ethernet@11 {
+			compatible = "fsl,p5040-dpa-ethernet", "fsl,dpa-ethernet";
+			fsl,fman-mac = <&fm2tgec>;
 		};
 	};
 };
diff --git a/arch/powerpc/platforms/85xx/corenet_ds.c b/arch/powerpc/platforms/85xx/corenet_ds.c
index 639a83a..644d1d9 100644
--- a/arch/powerpc/platforms/85xx/corenet_ds.c
+++ b/arch/powerpc/platforms/85xx/corenet_ds.c
@@ -166,6 +166,9 @@ int __init declare_of_platform_devices(void)
 		}
 	}
 
+	for_each_compatible_node(np, NULL, "fsl,hydra-xmdio")
+		of_platform_device_create(np, NULL, NULL);
+
 	return 0;
 }
 
diff --git a/arch/powerpc/platforms/85xx/hydra_mdio.c b/arch/powerpc/platforms/85xx/hydra_mdio.c
index cfdd50d..2b95521 100644
--- a/arch/powerpc/platforms/85xx/hydra_mdio.c
+++ b/arch/powerpc/platforms/85xx/hydra_mdio.c
@@ -186,17 +186,27 @@ static int __devinit hydra_mdio_probe(struct of_device *ofdev,
 		goto err_pixis_iomap;
 	}
 
-	iprop = of_get_property(np, "fsl,hydra-mdio-muxval", NULL);
+	/* Get the MDIO MUX mask and value */
+	iprop = of_get_property(np, "fsl,hydra-mdio-mux-val", NULL);
+	if (!iprop)
+		/* Older device trees used -muxval instead of -mux-val */
+		iprop = of_get_property(np, "fsl,hydra-mdio-muxval", NULL);
 	if (!iprop) {
 		dev_err(&ofdev->dev, "no MUX value found for %s\n",
 			np->full_name);
 		ret = -ENODEV;
 		goto err_get_muxval;
 	}
-
-	priv->mask = BRDCFG1_EMI1_SEL_MASK;
+	/* Note: some trees already have BRDCFG1_EMI1_EN in the value */
 	priv->value = BRDCFG1_EMI1_EN | be32_to_cpup(iprop);
 
+	iprop = of_get_property(np, "fsl,hydra-mdio-mux-mask", NULL);
+	if (iprop)
+		priv->mask = be32_to_cpup(iprop);
+	else
+		/* Older device trees assumed a hard-coded constant mask */
+		priv->mask = BRDCFG1_EMI1_SEL_MASK;
+
 	/* Finally, register our new bus */
 	ret = of_mdiobus_register(new_bus, np);
 	if (ret) {
@@ -246,6 +256,10 @@ static struct of_device_id hydra_mdio_match[] = {
 	{
 		.compatible = "fsl,hydra-mdio",
 	},
+	{
+		.compatible = "fsl,hydra-xmdio",
+	},
+	{}
 };
 MODULE_DEVICE_TABLE(of, mdio_match);
 
-- 
1.7.0

