From 4031e91d40c93d56a7fff995745d009e963d7532 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 3 Feb 2012 09:50:04 +0800
Subject: [PATCH 17/25] ppc64/book3e: Allocate DBG stack for each CPU

DBG stack should be dedicated to CPU PACA, so we should allocate that
for each CPU.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/paca.c |    8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/arch/powerpc/kernel/paca.c b/arch/powerpc/kernel/paca.c
index 3cf0a3c..e5623c3 100644
--- a/arch/powerpc/kernel/paca.c
+++ b/arch/powerpc/kernel/paca.c
@@ -80,7 +80,7 @@ EXPORT_SYMBOL(paca);
 
 struct paca_struct boot_paca;
 
-void *debug_kstack;
+static void *debug_kstack;
 static void allocate_dbg_kstack(unsigned long limit)
 {
 	debug_kstack = __va(lmb_alloc_base(STACK_INT_FRAME_SIZE, PAGE_SIZE, limit));
@@ -146,11 +146,11 @@ void __init allocate_pacas(void)
 	printk(KERN_DEBUG "Allocated %u bytes for %d pacas at %p\n",
 		paca_size, nr_cpus, paca);
 
-	allocate_dbg_kstack(limit);
-
 	/* Can't use for_each_*_cpu, as they aren't functional yet */
-	for (cpu = 0; cpu < nr_cpus; cpu++)
+	for (cpu = 0; cpu < nr_cpus; cpu++) {
+		allocate_dbg_kstack(limit);
 		initialise_paca(&paca[cpu], cpu);
+	}
 }
 
 void __init free_unused_pacas(void)
-- 
1.7.9.7

