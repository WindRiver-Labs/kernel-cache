From 97b4ecd019c0ebbb8d0d3598e6801c90d6e2d6f0 Mon Sep 17 00:00:00 2001
From: Yongli He <yongli.he@windriver.com>
Date: Mon, 23 May 2011 16:22:44 +0800
Subject: [PATCH] MMU:mmu no-hash conflict with preempt-rt

ppc64_tlb_batch should not be enabled with CONFIG_PPC_MMU_NOHASH.

Signed-off-by: Yongli He <yongli.he@windriver.com>
---
 arch/powerpc/kernel/process.c |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/kernel/process.c b/arch/powerpc/kernel/process.c
index 6164048..cb6f2e0 100644
--- a/arch/powerpc/kernel/process.c
+++ b/arch/powerpc/kernel/process.c
@@ -429,7 +429,7 @@ struct task_struct *__switch_to(struct task_struct *prev,
 	struct thread_struct *new_thread, *old_thread;
 	unsigned long flags;
 	struct task_struct *last;
-#if defined(CONFIG_PPC64) && defined (CONFIG_PREEMPT_RT)
+#if defined(CONFIG_PPC64) && defined (CONFIG_PREEMPT_RT) &&  (!defined (CONFIG_PPC_MMU_NOHASH))
 	struct ppc64_tlb_batch *batch;
 	int hadbatch;
 #endif
@@ -524,7 +524,7 @@ struct task_struct *__switch_to(struct task_struct *prev,
 		new_thread->start_tb = current_tb;
 	}
 
-#ifdef CONFIG_PREEMPT_RT
+#if defined(CONFIG_PREEMPT_RT)  && (!defined (CONFIG_PPC_MMU_NOHASH))
 	batch = &__get_cpu_var(ppc64_tlb_batch);
 	if (batch->active) {
 		hadbatch = 1;
@@ -552,7 +552,7 @@ struct task_struct *__switch_to(struct task_struct *prev,
 
 	local_irq_restore(flags);
 
-#if defined(CONFIG_PPC64) && defined(CONFIG_PREEMPT_RT)
+#if defined(CONFIG_PPC64) && defined(CONFIG_PREEMPT_RT) && (!defined (CONFIG_PPC_MMU_NOHASH))
 	if (hadbatch) {
 		batch = &__get_cpu_var(ppc64_tlb_batch);
 		batch->active = 1;
-- 
1.7.0.4

