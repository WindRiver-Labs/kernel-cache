From 47d13a2b3e0c71e8e1747f3cc650f685f123e9a7 Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Thu, 13 Oct 2011 15:50:11 +0800
Subject: [PATCH] PowerPC:P50x0:Fix compile error when enable CONFIG_WR_OCD_DEBUG

Signed-offbled CONFIG_WR_OCD_DEBUG option, it will enable
CONFIG_BDI_SWITCH by default, which will need a variable called
abatron_pteptrs to store current context.

The patch adds a global variable with name abatron_pteptrs to fix
compile error.-by: Jiang Lu <lu.jiang@windriver.com>

A TEMP COMMIT

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/kernel/head_64.S    |    8 ++++++++
 arch/powerpc/mm/tlb_nohash_low.S |    3 +--
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/kernel/head_64.S b/arch/powerpc/kernel/head_64.S
index b5b9e9e..f10d23b 100644
--- a/arch/powerpc/kernel/head_64.S
+++ b/arch/powerpc/kernel/head_64.S
@@ -784,3 +784,11 @@ empty_zero_page:
 	.globl	swapper_pg_dir
 swapper_pg_dir:
 	.space	PGD_TABLE_SIZE
+
+/*
+ * Room for two PTE pointers, usually the kernel and current user pointers
+ * to their respective root page table.
+ */
+	.globl abatron_pteptrs
+abatron_pteptrs:
+        .space  16
diff --git a/arch/powerpc/mm/tlb_nohash_low.S b/arch/powerpc/mm/tlb_nohash_low.S
index 40d44c7..4ac32ea 100644
--- a/arch/powerpc/mm/tlb_nohash_low.S
+++ b/arch/powerpc/mm/tlb_nohash_low.S
@@ -261,8 +261,7 @@ _GLOBAL(set_context)
 	/* Context switch the PTE pointer for the Abatron BDI2000.
 	 * The PGDIR is the second parameter.
 	 */
-	lis	r5, abatron_pteptrs@h
-	ori	r5, r5, abatron_pteptrs@l
+	LOAD_REG_IMMEDIATE(r5, abatron_pteptrs);
 	stw	r4, 0x4(r5)
 #endif
 	mtspr	SPRN_PID,r3
-- 
1.7.0.4

