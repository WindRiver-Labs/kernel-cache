From dcfcf6a1adba3d54ce2680ea81cc7f865ad0119b Mon Sep 17 00:00:00 2001
From: Jiang Lu <lu.jiang@windriver.com>
Date: Fri, 18 Nov 2011 13:52:45 +0800
Subject: [PATCH 01/25] oprofile: powerpc: Fix NULL-pointer in user_getsp()

The mm in task_struct could be NULL for kernel thread. The patch adds
NULL-pointer check for current->mm in user_getsp() routine.

Signed-off-by: Jiang Lu <lu.jiang@windriver.com>
---
 arch/powerpc/oprofile/backtrace.c |    6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/oprofile/backtrace.c b/arch/powerpc/oprofile/backtrace.c
index d524dd6..c4224da 100755
--- a/arch/powerpc/oprofile/backtrace.c
+++ b/arch/powerpc/oprofile/backtrace.c
@@ -54,7 +54,8 @@ static unsigned int user_getsp32(unsigned int sp, int is_first)
 
 	if (!is_first) {
 		unsigned long stack_lr = STACK_LR32(stack_frame);
-		unsigned long vdso_base = current->mm->context.vdso_base;
+		unsigned long vdso_base =
+			(current->mm) ? current->mm->context.vdso_base : 0;
 
 		if ( vdso_base && 
 		    ((stack_lr == vdso_base + vdso32_sigtramp) ||
@@ -88,7 +89,8 @@ static unsigned long user_getsp64(unsigned long sp, int is_first)
 
 	if (!is_first) {
 		unsigned long stack_lr = STACK_LR64(stack_frame);
-		unsigned long vdso_base = current->mm->context.vdso_base;
+		unsigned long vdso_base =
+			(current->mm) ? current->mm->context.vdso_base : 0;
 
 		if ( vdso_base &&
 		    ((stack_lr == vdso_base + vdso32_sigtramp) ||
-- 
1.7.9.7

