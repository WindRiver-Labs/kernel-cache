From b69b926fb45c62b54228618286f430e22121cc87 Mon Sep 17 00:00:00 2001
From: Felipe Balbi <balbi@ti.com>
Date: Mon, 28 Sep 2015 15:16:56 -0500
Subject: [PATCH 298/827] usb: dwc3: gadget: use Update Transfer from Xfer In Progress

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Instead of limiting __dwc3_gadget_kick_transfer() to
Xfer Complete, we can try to issue Update Transfer
command from Xfer In Progress too.

Signed-off-by: Felipe Balbi <balbi@ti.com>
(cherry picked from commit e6e709b7ab89a0d9ec0d803cb2f3b66902145ba0)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/usb/dwc3/gadget.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.c
index c6c6c71..26f1eea 100644
--- a/drivers/usb/dwc3/gadget.c
+++ b/drivers/usb/dwc3/gadget.c
@@ -2009,10 +2009,10 @@ static void dwc3_endpoint_transfer_complete(struct dwc3 *dwc,
 		dwc->u1u2 = 0;
 	}
 
-	if (is_xfer_complete && !usb_endpoint_xfer_isoc(dep->endpoint.desc)) {
+	if (!usb_endpoint_xfer_isoc(dep->endpoint.desc)) {
 		int ret;
 
-		ret = __dwc3_gadget_kick_transfer(dep, 0, 1);
+		ret = __dwc3_gadget_kick_transfer(dep, 0, is_xfer_complete);
 		if (!ret || ret == -EBUSY)
 			return;
 	}
-- 
2.9.3

