From 7dcf020b300c96fc9ab9e1e78ba9c6263b0986b1 Mon Sep 17 00:00:00 2001
From: VNSL Durga <vnsl.durga.challa@xilinx.com>
Date: Thu, 24 Mar 2016 22:45:04 +0530
Subject: [PATCH 014/827] dma: zynqmp: Requests are queued

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Supported queuing support for pending requests.
When DMA is in busy state, driver will accepts
new requests from user and they are queued till
DMA becomes idle state.

Signed-off-by: VNSL Durga <vnsldurg@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Acked-by: Punnaiah Choudary Kalluri <punnaia@xilinx.com>
(cherry picked from commit 8505b22fbcc516fb50648a433b03ec77430e0a39)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/dma/xilinx/zynqmp_dma.c | 20 +++++++++++++++++---
 1 file changed, 17 insertions(+), 3 deletions(-)

diff --git a/drivers/dma/xilinx/zynqmp_dma.c b/drivers/dma/xilinx/zynqmp_dma.c
index 4f34641..833de25 100644
--- a/drivers/dma/xilinx/zynqmp_dma.c
+++ b/drivers/dma/xilinx/zynqmp_dma.c
@@ -461,13 +461,27 @@ static void zynqmp_dma_init(struct zynqmp_dma_chan *chan)
 static dma_cookie_t zynqmp_dma_tx_submit(struct dma_async_tx_descriptor *tx)
 {
 	struct zynqmp_dma_chan *chan = to_chan(tx->chan);
-	struct zynqmp_dma_desc_sw *desc = tx_to_desc(tx);
+	struct zynqmp_dma_desc_sw *desc, *new;
 	dma_cookie_t cookie;
 	unsigned long flags;
 
-	cookie = dma_cookie_assign(tx);
+	new = tx_to_desc(tx);
 	spin_lock_irqsave(&chan->lock, flags);
-	list_add_tail(&desc->node, &chan->pending_list);
+	cookie = dma_cookie_assign(tx);
+
+	if (!list_empty(&chan->pending_list) && chan->has_sg) {
+		desc = list_last_entry(&chan->pending_list,
+				     struct zynqmp_dma_desc_sw, node);
+		if (!list_empty(&desc->tx_list))
+			desc = list_last_entry(&desc->tx_list,
+					       struct zynqmp_dma_desc_sw, node);
+		desc->src_v->nxtdscraddr = new->src_p;
+		desc->src_v->ctrl &= ~ZYNQMP_DMA_DESC_CTRL_STOP;
+		desc->dst_v->nxtdscraddr = new->dst_p;
+		desc->dst_v->ctrl &= ~ZYNQMP_DMA_DESC_CTRL_STOP;
+	}
+
+	list_add_tail(&new->node, &chan->pending_list);
 	spin_unlock_irqrestore(&chan->lock, flags);
 
 	return cookie;
-- 
2.9.3

