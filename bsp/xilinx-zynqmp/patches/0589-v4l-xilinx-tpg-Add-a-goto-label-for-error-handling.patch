From cb0f338bdb4ba9ccd378f9357f399b048f7e8f66 Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyun.kwon@xilinx.com>
Date: Tue, 24 Feb 2015 11:49:25 -0800
Subject: [PATCH 589/827] v4l: xilinx: tpg: Add a goto label for error handling

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Calling media_entity_cleanup() when subdev == NULL results in
kernel panic. Add a goto label for error handling with
subdev == NULL.

Signed-off-by: Hyun Kwon <hyun.kwon@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 62c635deec340050574aef0e8890d350f545e81e)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-tpg.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/media/platform/xilinx/xilinx-tpg.c b/drivers/media/platform/xilinx/xilinx-tpg.c
index b62321c..1cdedb0 100644
--- a/drivers/media/platform/xilinx/xilinx-tpg.c
+++ b/drivers/media/platform/xilinx/xilinx-tpg.c
@@ -782,7 +782,7 @@ static int xtpg_probe(struct platform_device *pdev)
 	xtpg->vtmux_gpio = devm_gpiod_get_index(&pdev->dev, "timing", 0);
 	if (PTR_ERR(xtpg->vtmux_gpio) == -EPROBE_DEFER) {
 		ret = -EPROBE_DEFER;
-		goto error;
+		goto error_resource;
 	}
 	if (!IS_ERR(xtpg->vtmux_gpio))
 		gpiod_direction_output(xtpg->vtmux_gpio, 1);
@@ -790,7 +790,7 @@ static int xtpg_probe(struct platform_device *pdev)
 	xtpg->vtc = xvtc_of_get(pdev->dev.of_node);
 	if (IS_ERR(xtpg->vtc)) {
 		ret = PTR_ERR(xtpg->vtc);
-		goto error;
+		goto error_resource;
 	}
 
 	/* Reset and initialize the core */
@@ -881,6 +881,7 @@ error:
 	v4l2_ctrl_handler_free(&xtpg->ctrl_handler);
 	media_entity_cleanup(&subdev->entity);
 	xvtc_put(xtpg->vtc);
+error_resource:
 	xvip_cleanup_resources(&xtpg->xvip);
 	return ret;
 }
-- 
2.9.3

