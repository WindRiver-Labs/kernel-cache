From d513fb79a4cf8572c1a0cf0c9c3d127c5816e56f Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date: Wed, 26 Mar 2014 15:46:25 +0100
Subject: [PATCH 528/827] media: xilinx: Add Video Timing Controller driver

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

The Video Timing Controller (VTC) includes a timing detector and/or a
timing generator. Only the generator is currently supported.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 145787f679661090ee479b3bf2ef6fa65f20058b)

Conflicts:
	drivers/media/platform/xilinx/xilinx-vtc.c
	drivers/media/platform/xilinx/xilinx-vtc.h
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 .../bindings/media/xilinx/xlnx,axi-vtc.txt         | 33 ++++++++++++++++++++++
 drivers/media/platform/xilinx/Kconfig              |  6 ++++
 drivers/media/platform/xilinx/Makefile             |  1 +
 drivers/media/platform/xilinx/xilinx-vtc.c         | 31 +++++++++++---------
 drivers/media/platform/xilinx/xilinx-vtc.h         |  9 ++----
 5 files changed, 60 insertions(+), 20 deletions(-)
 create mode 100644 Documentation/devicetree/bindings/media/xilinx/xlnx,axi-vtc.txt

diff --git a/Documentation/devicetree/bindings/media/xilinx/xlnx,axi-vtc.txt b/Documentation/devicetree/bindings/media/xilinx/xlnx,axi-vtc.txt
new file mode 100644
index 0000000..39fb517
--- /dev/null
+++ b/Documentation/devicetree/bindings/media/xilinx/xlnx,axi-vtc.txt
@@ -0,0 +1,33 @@
+Xilinx Video Timing Controller (VTC)
+------------------------------------
+
+The Video Timing Controller is a general purpose video timing generator and
+detector.
+
+Required properties:
+
+  - compatible: Must be "xlnx,axi-vtc-6.1".
+
+  - reg: Physical base address and length of the registers set for the device.
+
+  - clocks: Must contain a clock specifier for the VTC core and timing
+    interfaces clock.
+
+Optional properties:
+
+  - xlnx,detector: The VTC has a timing detector
+  - xlnx,generator: The VTC has a timing generator
+
+  At least one of the xlnx,detector and xlnx,generator properties must be
+  specified.
+
+
+Example:
+
+	vtc: vtc@43c40000 {
+		compatible = "xlnx,axi-vtc-6.1";
+		reg = <0x43c40000 0x10000>;
+
+		clocks = <&clkc 15>;
+		xlnx,generator;
+	};
diff --git a/drivers/media/platform/xilinx/Kconfig b/drivers/media/platform/xilinx/Kconfig
index 4191eef..5411771 100644
--- a/drivers/media/platform/xilinx/Kconfig
+++ b/drivers/media/platform/xilinx/Kconfig
@@ -49,4 +49,10 @@ config VIDEO_XILINX_TPG
 	---help---
 	   Driver for the Xilinx Video Test Pattern Generator
 
+config VIDEO_XILINX_VTC
+	tristate "Xilinx Video Timing Controller"
+	depends on VIDEO_XILINX
+	---help---
+	   Driver for the Xilinx Video Timing Controller
+
 endif #VIDEO_XILINX
diff --git a/drivers/media/platform/xilinx/Makefile b/drivers/media/platform/xilinx/Makefile
index 1680272..cf6fbcd 100644
--- a/drivers/media/platform/xilinx/Makefile
+++ b/drivers/media/platform/xilinx/Makefile
@@ -8,3 +8,4 @@ obj-$(CONFIG_VIDEO_XILINX_SCALER) += xilinx-scaler.o
 obj-$(CONFIG_VIDEO_XILINX_REMAPPER) += xilinx-remapper.o
 obj-$(CONFIG_VIDEO_XILINX_SWITCH) += xilinx-switch.o
 obj-$(CONFIG_VIDEO_XILINX_TPG) += xilinx-tpg.o
+obj-$(CONFIG_VIDEO_XILINX_VTC) += xilinx-vtc.o
diff --git a/drivers/media/platform/xilinx/xilinx-vtc.c b/drivers/media/platform/xilinx/xilinx-vtc.c
index 01c750e..83f6d53 100644
--- a/drivers/media/platform/xilinx/xilinx-vtc.c
+++ b/drivers/media/platform/xilinx/xilinx-vtc.c
@@ -1,11 +1,9 @@
 /*
  * Xilinx Video Timing Controller
  *
- * Copyright (C) 2013-2015 Ideas on Board
- * Copyright (C) 2013-2015 Xilinx, Inc.
+ * Copyright (C) 2014 Ideas on Board SPRL
  *
- * Contacts: Hyun Kwon <hyun.kwon@xilinx.com>
- *           Laurent Pinchart <laurent.pinchart@ideasonboard.com>
+ * Contacts: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 as
@@ -148,6 +146,7 @@
  * struct xvtc_device - Xilinx Video Timing Controller device structure
  * @xvip: Xilinx Video IP device
  * @list: entry in the global VTC list
+ * @clk: video clock
  * @has_detector: the VTC has a timing detector
  * @has_generator: the VTC has a timing generator
  * @config: generator timings configuration
@@ -155,6 +154,7 @@
 struct xvtc_device {
 	struct xvip_device xvip;
 	struct list_head list;
+	struct clk *clk;
 
 	bool has_detector;
 	bool has_generator;
@@ -182,7 +182,7 @@ int xvtc_generator_start(struct xvtc_device *xvtc,
 	if (!xvtc->has_generator)
 		return -ENXIO;
 
-	ret = clk_prepare_enable(xvtc->xvip.clk);
+	ret = clk_prepare_enable(xvtc->clk);
 	if (ret < 0)
 		return ret;
 
@@ -245,7 +245,7 @@ int xvtc_generator_stop(struct xvtc_device *xvtc)
 
 	xvip_write(&xvtc->xvip, XVIP_CTRL_CONTROL, 0);
 
-	clk_disable_unprepare(xvtc->xvip.clk);
+	clk_disable_unprepare(xvtc->clk);
 
 	return 0;
 }
@@ -322,6 +322,7 @@ static int xvtc_parse_of(struct xvtc_device *xvtc)
 static int xvtc_probe(struct platform_device *pdev)
 {
 	struct xvtc_device *xvtc;
+	struct resource *res;
 	int ret;
 
 	xvtc = devm_kzalloc(&pdev->dev, sizeof(*xvtc), GFP_KERNEL);
@@ -334,9 +335,14 @@ static int xvtc_probe(struct platform_device *pdev)
 	if (ret < 0)
 		return ret;
 
-	ret = xvip_init_resources(&xvtc->xvip);
-	if (ret < 0)
-		return ret;
+	res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
+	xvtc->xvip.iomem = devm_ioremap_resource(&pdev->dev, res);
+	if (IS_ERR(xvtc->xvip.iomem))
+		return PTR_ERR(xvtc->xvip.iomem);
+
+	xvtc->clk = devm_clk_get(&pdev->dev, NULL);
+	if (IS_ERR(xvtc->clk))
+		return PTR_ERR(xvtc->clk);
 
 	platform_set_drvdata(pdev, xvtc);
 
@@ -353,20 +359,19 @@ static int xvtc_remove(struct platform_device *pdev)
 
 	xvtc_unregister_device(xvtc);
 
-	xvip_cleanup_resources(&xvtc->xvip);
-
 	return 0;
 }
 
 static const struct of_device_id xvtc_of_id_table[] = {
-	{ .compatible = "xlnx,v-tc-6.1" },
+	{ .compatible = "xlnx,axi-vtc-6.1" },
 	{ }
 };
 MODULE_DEVICE_TABLE(of, xvtc_of_id_table);
 
 static struct platform_driver xvtc_driver = {
 	.driver = {
-		.name = "xilinx-vtc",
+		.owner = THIS_MODULE,
+		.name = "xilinx-axi-vtc",
 		.of_match_table = xvtc_of_id_table,
 	},
 	.probe = xvtc_probe,
diff --git a/drivers/media/platform/xilinx/xilinx-vtc.h b/drivers/media/platform/xilinx/xilinx-vtc.h
index e1bb2cf..969ac33 100644
--- a/drivers/media/platform/xilinx/xilinx-vtc.h
+++ b/drivers/media/platform/xilinx/xilinx-vtc.h
@@ -1,11 +1,9 @@
 /*
  * Xilinx Video Timing Controller
  *
- * Copyright (C) 2013-2015 Ideas on Board
- * Copyright (C) 2013-2015 Xilinx, Inc.
+ * Copyright (C) 2014 Ideas on Board SPRL
  *
- * Contacts: Hyun Kwon <hyun.kwon@xilinx.com>
- *           Laurent Pinchart <laurent.pinchart@ideasonboard.com>
+ * Contacts: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License version 2 as
@@ -18,9 +16,6 @@
 struct device_node;
 struct xvtc_device;
 
-#define XVTC_MAX_HSIZE			8191
-#define XVTC_MAX_VSIZE			8191
-
 struct xvtc_config {
 	unsigned int hblank_start;
 	unsigned int hsync_start;
-- 
2.9.3

