From 9e9fbba084ddc2ea8ffff264ddab9209cf08d1d2 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Tue, 27 Sep 2016 09:31:16 +0800
Subject: [PATCH 703/827] media: xilinx: fix some gaps

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

This patch is to merge all commits up to 6459d1f5

This gaps come from the big base differences.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/media-entity.c                     |  4 +--
 drivers/media/platform/xilinx/xilinx-cfa.c       |  2 +-
 drivers/media/platform/xilinx/xilinx-cresample.c |  2 +-
 drivers/media/platform/xilinx/xilinx-dma.c       |  2 +-
 drivers/media/platform/xilinx/xilinx-hls.c       | 32 +++++++++++++-----------
 drivers/media/platform/xilinx/xilinx-remapper.c  |  2 +-
 drivers/media/platform/xilinx/xilinx-rgb2yuv.c   |  2 +-
 drivers/media/platform/xilinx/xilinx-scaler.c    |  2 +-
 drivers/media/platform/xilinx/xilinx-tpg.c       |  2 +-
 include/media/media-entity.h                     |  2 +-
 10 files changed, 27 insertions(+), 25 deletions(-)

diff --git a/drivers/media/media-entity.c b/drivers/media/media-entity.c
index 372e983..5a91ab4 100644
--- a/drivers/media/media-entity.c
+++ b/drivers/media/media-entity.c
@@ -51,7 +51,7 @@
  * media_entity_init() where its pointer will be stored in the entity structure.
  */
 int
-media_entity_init(struct media_entity *entity, u16 num_pads,
+media_entity_pads_init(struct media_entity *entity, u16 num_pads,
 		  struct media_pad *pads, u16 extra_links)
 {
 	struct media_link *links;
@@ -77,7 +77,7 @@ media_entity_init(struct media_entity *entity, u16 num_pads,
 
 	return 0;
 }
-EXPORT_SYMBOL_GPL(media_entity_init);
+EXPORT_SYMBOL_GPL(media_entity_pads_init);
 
 void
 media_entity_cleanup(struct media_entity *entity)
diff --git a/drivers/media/platform/xilinx/xilinx-cfa.c b/drivers/media/platform/xilinx/xilinx-cfa.c
index 85805c9..37c3b30 100644
--- a/drivers/media/platform/xilinx/xilinx-cfa.c
+++ b/drivers/media/platform/xilinx/xilinx-cfa.c
@@ -335,7 +335,7 @@ static int xcfa_probe(struct platform_device *pdev)
 	xcfa->pads[XVIP_PAD_SINK].flags = MEDIA_PAD_FL_SINK;
 	xcfa->pads[XVIP_PAD_SOURCE].flags = MEDIA_PAD_FL_SOURCE;
 	subdev->entity.ops = &xcfa_media_ops;
-	ret = media_entity_init(&subdev->entity, 2, xcfa->pads, 0);
+	ret = media_entity_pads_init(&subdev->entity, 2, xcfa->pads, 0);
 	if (ret < 0)
 		goto error;
 
diff --git a/drivers/media/platform/xilinx/xilinx-cresample.c b/drivers/media/platform/xilinx/xilinx-cresample.c
index e160116..6b9268c 100644
--- a/drivers/media/platform/xilinx/xilinx-cresample.c
+++ b/drivers/media/platform/xilinx/xilinx-cresample.c
@@ -367,7 +367,7 @@ static int xcresample_probe(struct platform_device *pdev)
 	xcresample->pads[XVIP_PAD_SINK].flags = MEDIA_PAD_FL_SINK;
 	xcresample->pads[XVIP_PAD_SOURCE].flags = MEDIA_PAD_FL_SOURCE;
 	subdev->entity.ops = &xcresample_media_ops;
-	ret = media_entity_init(&subdev->entity, 2, xcresample->pads, 0);
+	ret = media_entity_pads_init(&subdev->entity, 2, xcresample->pads, 0);
 	if (ret < 0)
 		goto error;
 
diff --git a/drivers/media/platform/xilinx/xilinx-dma.c b/drivers/media/platform/xilinx/xilinx-dma.c
index e0f52b0..1912180 100644
--- a/drivers/media/platform/xilinx/xilinx-dma.c
+++ b/drivers/media/platform/xilinx/xilinx-dma.c
@@ -710,7 +710,7 @@ int xvip_dma_init(struct xvip_composite_device *xdev, struct xvip_dma *dma,
 	dma->pad.flags = type == V4L2_BUF_TYPE_VIDEO_CAPTURE
 		       ? MEDIA_PAD_FL_SINK : MEDIA_PAD_FL_SOURCE;
 
-	ret = media_entity_init(&dma->video.entity, 1, &dma->pad, 0);
+	ret = media_entity_pads_init(&dma->video.entity, 1, &dma->pad, 0);
 	if (ret < 0)
 		goto error;
 
diff --git a/drivers/media/platform/xilinx/xilinx-hls.c b/drivers/media/platform/xilinx/xilinx-hls.c
index 891bc4d..3a8ab93 100644
--- a/drivers/media/platform/xilinx/xilinx-hls.c
+++ b/drivers/media/platform/xilinx/xilinx-hls.c
@@ -191,12 +191,13 @@ static int xhls_s_stream(struct v4l2_subdev *subdev, int enable)
  */
 
 static struct v4l2_mbus_framefmt *
-__xhls_get_pad_format(struct xhls_device *xhls, struct v4l2_subdev_fh *fh,
+__xhls_get_pad_format(struct xhls_device *xhls,
+		      struct v4l2_subdev_pad_config *cfg,
 		      unsigned int pad, u32 which)
 {
 	switch (which) {
 	case V4L2_SUBDEV_FORMAT_TRY:
-		return v4l2_subdev_get_try_format(fh, pad);
+		return v4l2_subdev_get_try_format(&xhls->xvip.subdev, cfg, pad);
 	case V4L2_SUBDEV_FORMAT_ACTIVE:
 		return &xhls->formats[pad];
 	default:
@@ -205,38 +206,39 @@ __xhls_get_pad_format(struct xhls_device *xhls, struct v4l2_subdev_fh *fh,
 }
 
 static int xhls_get_format(struct v4l2_subdev *subdev,
-			   struct v4l2_subdev_fh *fh,
+			   struct v4l2_subdev_pad_config *cfg,
 			   struct v4l2_subdev_format *fmt)
 {
 	struct xhls_device *xhls = to_hls(subdev);
 
-	fmt->format = *__xhls_get_pad_format(xhls, fh, fmt->pad, fmt->which);
+	fmt->format = *__xhls_get_pad_format(xhls, cfg, fmt->pad, fmt->which);
 
 	return 0;
 }
 
 static int xhls_set_format(struct v4l2_subdev *subdev,
-			   struct v4l2_subdev_fh *fh,
+			   struct v4l2_subdev_pad_config *cfg,
 			   struct v4l2_subdev_format *fmt)
 {
 	struct xhls_device *xhls = to_hls(subdev);
-	struct v4l2_mbus_framefmt *__format;
+	struct v4l2_mbus_framefmt *format;
 
-	__format = __xhls_get_pad_format(xhls, fh, fmt->pad, fmt->which);
+	format = __xhls_get_pad_format(xhls, cfg, fmt->pad, fmt->which);
 
 	if (fmt->pad == XVIP_PAD_SOURCE) {
-		fmt->format = *__format;
+		fmt->format = *format;
 		return 0;
 	}
 
-	xvip_set_format_size(__format, fmt);
+	xvip_set_format_size(format, fmt);
 
-	fmt->format = *__format;
+	fmt->format = *format;
 
 	/* Propagate the format to the source pad. */
-	__format = __xhls_get_pad_format(xhls, fh, XVIP_PAD_SOURCE, fmt->which);
+	format = __xhls_get_pad_format(xhls, cfg, XVIP_PAD_SOURCE,
+					 fmt->which);
 
-	xvip_set_format_size(__format, fmt);
+	xvip_set_format_size(format, fmt);
 
 	return 0;
 }
@@ -251,10 +253,10 @@ static int xhls_open(struct v4l2_subdev *subdev, struct v4l2_subdev_fh *fh)
 	struct v4l2_mbus_framefmt *format;
 
 	/* Initialize with default formats */
-	format = v4l2_subdev_get_try_format(fh, XVIP_PAD_SINK);
+	format = v4l2_subdev_get_try_format(subdev, fh->pad, XVIP_PAD_SINK);
 	*format = xhls->default_formats[XVIP_PAD_SINK];
 
-	format = v4l2_subdev_get_try_format(fh, XVIP_PAD_SOURCE);
+	format = v4l2_subdev_get_try_format(subdev, fh->pad, XVIP_PAD_SOURCE);
 	*format = xhls->default_formats[XVIP_PAD_SOURCE];
 
 	return 0;
@@ -415,7 +417,7 @@ static int xhls_probe(struct platform_device *pdev)
 	xhls->pads[XVIP_PAD_SINK].flags = MEDIA_PAD_FL_SINK;
 	xhls->pads[XVIP_PAD_SOURCE].flags = MEDIA_PAD_FL_SOURCE;
 	subdev->entity.ops = &xhls_media_ops;
-	ret = media_entity_init(&subdev->entity, 2, xhls->pads, 0);
+	ret = media_entity_pads_init(&subdev->entity, 2, xhls->pads, 0);
 	if (ret < 0)
 		goto error;
 
diff --git a/drivers/media/platform/xilinx/xilinx-remapper.c b/drivers/media/platform/xilinx/xilinx-remapper.c
index acbc082..bc88ba4 100644
--- a/drivers/media/platform/xilinx/xilinx-remapper.c
+++ b/drivers/media/platform/xilinx/xilinx-remapper.c
@@ -489,7 +489,7 @@ static int xremap_probe(struct platform_device *pdev)
 	xremap->pads[XREMAP_PAD_SINK].flags = MEDIA_PAD_FL_SINK;
 	xremap->pads[XREMAP_PAD_SOURCE].flags = MEDIA_PAD_FL_SOURCE;
 	subdev->entity.ops = &xremap_media_ops;
-	ret = media_entity_init(&subdev->entity, 2, xremap->pads, 0);
+	ret = media_entity_pads_init(&subdev->entity, 2, xremap->pads, 0);
 	if (ret < 0)
 		goto error;
 
diff --git a/drivers/media/platform/xilinx/xilinx-rgb2yuv.c b/drivers/media/platform/xilinx/xilinx-rgb2yuv.c
index 9bd8d9f..a31eaf8f 100644
--- a/drivers/media/platform/xilinx/xilinx-rgb2yuv.c
+++ b/drivers/media/platform/xilinx/xilinx-rgb2yuv.c
@@ -488,7 +488,7 @@ static int xrgb2yuv_probe(struct platform_device *pdev)
 	xrgb2yuv->pads[XVIP_PAD_SINK].flags = MEDIA_PAD_FL_SINK;
 	xrgb2yuv->pads[XVIP_PAD_SOURCE].flags = MEDIA_PAD_FL_SOURCE;
 	subdev->entity.ops = &xrgb2yuv_media_ops;
-	ret = media_entity_init(&subdev->entity, 2, xrgb2yuv->pads, 0);
+	ret = media_entity_pads_init(&subdev->entity, 2, xrgb2yuv->pads, 0);
 	if (ret < 0)
 		goto error;
 
diff --git a/drivers/media/platform/xilinx/xilinx-scaler.c b/drivers/media/platform/xilinx/xilinx-scaler.c
index 99e5ab2..187b4e4 100644
--- a/drivers/media/platform/xilinx/xilinx-scaler.c
+++ b/drivers/media/platform/xilinx/xilinx-scaler.c
@@ -627,7 +627,7 @@ static int xscaler_probe(struct platform_device *pdev)
 	xscaler->pads[XVIP_PAD_SOURCE].flags = MEDIA_PAD_FL_SOURCE;
 	subdev->entity.ops = &xscaler_media_ops;
 
-	ret = media_entity_init(&subdev->entity, 2, xscaler->pads, 0);
+	ret = media_entity_pads_init(&subdev->entity, 2, xscaler->pads, 0);
 	if (ret < 0)
 		goto error;
 
diff --git a/drivers/media/platform/xilinx/xilinx-tpg.c b/drivers/media/platform/xilinx/xilinx-tpg.c
index 484001e..a9216e8 100644
--- a/drivers/media/platform/xilinx/xilinx-tpg.c
+++ b/drivers/media/platform/xilinx/xilinx-tpg.c
@@ -1042,7 +1042,7 @@ static int xtpg_probe(struct platform_device *pdev)
 	subdev->flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;
 	subdev->entity.ops = &xtpg_media_ops;
 
-	ret = media_entity_init(&subdev->entity, xtpg->npads, xtpg->pads, 0);
+	ret = media_entity_pads_init(&subdev->entity, xtpg->npads, xtpg->pads, 0);
 	if (ret < 0)
 		goto error;
 
diff --git a/include/media/media-entity.h b/include/media/media-entity.h
index a1eb400..794785eb1 100644
--- a/include/media/media-entity.h
+++ b/include/media/media-entity.h
@@ -131,7 +131,7 @@ struct media_entity_graph {
 	int top;
 };
 
-int media_entity_init(struct media_entity *entity, u16 num_pads,
+int media_entity_pads_init(struct media_entity *entity, u16 num_pads,
 		struct media_pad *pads, u16 extra_links);
 void media_entity_cleanup(struct media_entity *entity);
 
-- 
2.9.3

