From b6f22b12c39a74478675401b782ca5ec0c6ce722 Mon Sep 17 00:00:00 2001
From: Punnaiah Choudary Kalluri <punnaiah.choudary.kalluri@xilinx.com>
Date: Wed, 18 Nov 2015 09:21:15 +0530
Subject: [PATCH 806/827] net: macb: Add support for sgmii phy interface

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

This patch adds support for the sgmii phy interface.

Signed-off-by: Punnaiah Choudary Kalluri <punnaia@xilinx.com>
(cherry picked from commit b2a3b69c4c1c21dbeebaa2ee79805c1d01813cae)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/cadence/macb.c | 5 +++++
 drivers/net/ethernet/cadence/macb.h | 4 ++++
 2 files changed, 9 insertions(+)

diff --git a/drivers/net/ethernet/cadence/macb.c b/drivers/net/ethernet/cadence/macb.c
index 356369f..1223672 100644
--- a/drivers/net/ethernet/cadence/macb.c
+++ b/drivers/net/ethernet/cadence/macb.c
@@ -1925,6 +1925,8 @@ static void macb_init_hw(struct macb *bp)
 	macb_set_hwaddr(bp);
 
 	config = macb_mdc_clk_div(bp);
+	if (bp->phy_interface == PHY_INTERFACE_MODE_SGMII)
+		config |= GEM_BIT(SGMIIEN) | GEM_BIT(PCSSEL);
 	config |= macb_readl(bp, NCFGR) & (3 << 21);
 	config |= MACB_BF(RBOF, NET_IP_ALIGN);	/* Make eth data aligned */
 	config |= MACB_BIT(PAE);		/* PAuse Enable */
@@ -2852,6 +2854,9 @@ static int macb_probe(struct platform_device *pdev)
 #else
 		macb_or_gem_writel(bp, USRIO, 0);
 #endif
+	else if (bp->phy_interface == PHY_INTERFACE_MODE_SGMII)
+		macb_or_gem_writel(bp, NCFGR, gem_readl(bp, NCFGR) |
+				   GEM_BIT(SGMIIEN) | GEM_BIT(PCSSEL));
 	else
 #if defined(CONFIG_ARCH_AT91)
 		macb_or_gem_writel(bp, USRIO, MACB_BIT(CLKEN));
diff --git a/drivers/net/ethernet/cadence/macb.h b/drivers/net/ethernet/cadence/macb.h
index 893ea99..3078997 100644
--- a/drivers/net/ethernet/cadence/macb.h
+++ b/drivers/net/ethernet/cadence/macb.h
@@ -235,12 +235,16 @@
 /* GEM specific NCFGR bitfields. */
 #define GEM_GBE_OFFSET		10 /* Gigabit mode enable */
 #define GEM_GBE_SIZE		1
+#define GEM_PCSSEL_OFFSET	11
+#define GEM_PCSSEL_SIZE		1
 #define GEM_CLK_OFFSET		18 /* MDC clock division */
 #define GEM_CLK_SIZE		3
 #define GEM_DBW_OFFSET		21 /* Data bus width */
 #define GEM_DBW_SIZE		2
 #define GEM_RXCOEN_OFFSET	24
 #define GEM_RXCOEN_SIZE		1
+#define GEM_SGMIIEN_OFFSET	27
+#define GEM_SGMIIEN_SIZE	1
 
 /* Constants for data bus width. */
 #define GEM_DBW32		0 /* 32 bit AMBA AHB data bus width */
-- 
2.9.3

