From f48495b5c3c5ad67df10d5529238d38509a8bfd9 Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyunk@xilinx.com>
Date: Wed, 18 Dec 2013 17:44:39 -0800
Subject: [PATCH 551/827] media: xilinx: vip: Add xvip_init_formats()

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Add xvip_init_formats(), which initializes the formats of a subdevice.

Signed-off-by: Hyun Kwon <hyunk@xilinx.com>
(cherry picked from commit defd42cfecce97096d864cc11219d8cc62580b08)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-vip.c | 36 ++++++++++++++++++++++++++++++
 drivers/media/platform/xilinx/xilinx-vip.h |  1 +
 2 files changed, 37 insertions(+)

diff --git a/drivers/media/platform/xilinx/xilinx-vip.c b/drivers/media/platform/xilinx/xilinx-vip.c
index 1dad0ba..f8d1ce9 100644
--- a/drivers/media/platform/xilinx/xilinx-vip.c
+++ b/drivers/media/platform/xilinx/xilinx-vip.c
@@ -318,3 +318,39 @@ void xvip_set_format(struct v4l2_mbus_framefmt *format,
 			 XVIP_MIN_HEIGHT, XVIP_MAX_HEIGHT);
 }
 EXPORT_SYMBOL_GPL(xvip_set_format);
+
+/**
+ * xvip_init_formats - Initialize formats on all pads
+ * @subdev: V4L2 subdevice
+ * @fh: V4L2 subdev file handle
+ *
+ * Initialize all pad formats with default values. If fh is not NULL, try
+ * formats are initialized on the file handle. Otherwise active formats are
+ * initialized on the device.
+ */
+void xvip_init_formats(struct v4l2_subdev *subdev, struct v4l2_subdev_fh *fh)
+{
+	struct xvip_device *xvip = container_of(subdev, struct xvip_device,
+						subdev);
+	struct v4l2_subdev_format format;
+
+	memset(&format, 0, sizeof(format));
+
+	format.which = fh ? V4L2_SUBDEV_FORMAT_TRY : V4L2_SUBDEV_FORMAT_ACTIVE;
+	format.format.width = xvip_read(xvip, XVIP_ACTIVE_SIZE) &
+			      XVIP_ACTIVE_HSIZE_MASK;
+	format.format.height = (xvip_read(xvip, XVIP_ACTIVE_SIZE) &
+				XVIP_ACTIVE_VSIZE_MASK) >>
+			       XVIP_ACTIVE_VSIZE_SHIFT;
+	format.format.field = V4L2_FIELD_NONE;
+	format.format.colorspace = V4L2_COLORSPACE_SRGB;
+
+	format.pad = XVIP_PAD_SOURCE;
+
+	v4l2_subdev_call(subdev, pad, set_fmt, fh, &format);
+
+	format.pad = XVIP_PAD_SINK;
+
+	v4l2_subdev_call(subdev, pad, set_fmt, fh, &format);
+}
+EXPORT_SYMBOL_GPL(xvip_init_formats);
diff --git a/drivers/media/platform/xilinx/xilinx-vip.h b/drivers/media/platform/xilinx/xilinx-vip.h
index c55882e..8261818 100644
--- a/drivers/media/platform/xilinx/xilinx-vip.h
+++ b/drivers/media/platform/xilinx/xilinx-vip.h
@@ -131,6 +131,7 @@ xvip_get_pad_format(struct v4l2_subdev_fh *fh,
 void xvip_set_format(struct v4l2_mbus_framefmt *format,
 		     const struct xvip_video_format *vip_format,
 		     struct v4l2_subdev_format *fmt);
+void xvip_init_formats(struct v4l2_subdev *subdev, struct v4l2_subdev_fh *fh);
 
 static inline u32 xvip_read(struct xvip_device *xvip, u32 addr)
 {
-- 
2.9.3

