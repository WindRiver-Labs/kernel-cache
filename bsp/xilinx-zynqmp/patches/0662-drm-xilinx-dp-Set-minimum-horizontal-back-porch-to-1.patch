From 882c14153c05712e6cc7405c4dd325d0b5583354 Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyun.kwon@xilinx.com>
Date: Mon, 4 Jan 2016 17:39:46 -0800
Subject: [PATCH 662/827] drm: xilinx: dp: Set minimum horizontal back porch to 12

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

ZynqMP DP resets video FIFO at the end of each line, and requires
horizontal backporch to be 12 at least. Otherwise, a few pixels of
next line get reset incorrectly.

Signed-off-by: Hyun Kwon <hyun.kwon@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit e1c6b4577a1f6dc53bc97a623a82cdb1c9d179da)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpu/drm/xilinx/xilinx_drm_dp.c | 17 +++++++++++++++++
 1 file changed, 17 insertions(+)

diff --git a/drivers/gpu/drm/xilinx/xilinx_drm_dp.c b/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
index 505611f..9d3a41f 100644
--- a/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
+++ b/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
@@ -802,10 +802,27 @@ static void xilinx_drm_dp_restore(struct drm_encoder *encoder)
 	/* no op */
 }
 
+#define XILINX_DP_SUB_TX_MIN_H_BACKPORCH	12
+
 static bool xilinx_drm_dp_mode_fixup(struct drm_encoder *encoder,
 				     const struct drm_display_mode *mode,
 				     struct drm_display_mode *adjusted_mode)
 {
+	struct xilinx_drm_dp *dp = to_dp(encoder);
+	int diff = mode->htotal - mode->hsync_end;
+
+	/*
+	 * ZynqMP DP requires horizontal backporch to be greater than 12.
+	 * This limitation may conflict with the sink device.
+	 */
+	if (dp->dp_sub && diff < XILINX_DP_SUB_TX_MIN_H_BACKPORCH) {
+		diff = XILINX_DP_SUB_TX_MIN_H_BACKPORCH - diff;
+		adjusted_mode->htotal += diff;
+		adjusted_mode->clock = adjusted_mode->vtotal *
+				       adjusted_mode->htotal *
+				       adjusted_mode->vrefresh / 1000;
+	}
+
 	return true;
 }
 
-- 
2.9.3

