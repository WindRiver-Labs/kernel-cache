From 76627124ffcf67dfe61889229fac1dc2f9f40284 Mon Sep 17 00:00:00 2001
From: Kedareswara rao Appana <appana.durga.rao@xilinx.com>
Date: Wed, 23 Sep 2015 13:21:29 +0530
Subject: [PATCH 771/827] net: ethernet: xilinx: Update link state change properly in the driver

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

The last link state in the driver in adjust_link() was not being updated unless
There was the speed was set which could then cause the mac speed error message
Forever at a periodic rate.This patch fixes this issue.

Reported-by: John Linn <john.linn@xilinx.com>
Signed-off-by: Kedareswara rao Appana <appanad@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 332aa92529748c9ffae5fee8d6bc3ff2b1656d59)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/ethernet/xilinx/xilinx_axienet_main.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/xilinx/xilinx_axienet_main.c b/drivers/net/ethernet/xilinx/xilinx_axienet_main.c
index b2f19d2..2c421dc 100644
--- a/drivers/net/ethernet/xilinx/xilinx_axienet_main.c
+++ b/drivers/net/ethernet/xilinx/xilinx_axienet_main.c
@@ -581,12 +581,13 @@ static void axienet_adjust_link(struct net_device *ndev)
 			}
 
 			axienet_iow(lp, XAE_EMMC_OFFSET, emmc_reg);
-			lp->last_link = link_state;
 			phy_print_status(phy);
 		} else {
 			netdev_err(ndev,
 				   "Error setting Axi Ethernet mac speed\n");
 		}
+
+		lp->last_link = link_state;
 	}
 }
 
-- 
2.9.3

