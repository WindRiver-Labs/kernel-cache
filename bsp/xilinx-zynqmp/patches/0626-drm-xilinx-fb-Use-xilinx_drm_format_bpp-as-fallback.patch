From d98c361cdbdec57c7fce226bddf2b0c65f3e4944 Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyun.kwon@xilinx.com>
Date: Tue, 10 Mar 2015 18:04:24 -0700
Subject: [PATCH 626/827] drm: xilinx: fb: Use xilinx_drm_format_bpp() as fallback

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

drm_fb_get_bpp_depth() only supports RGB formats, and returns
depth and bits per pixel values as '0' for YUV formats. In that case,
use xilinx_drm_format_bpp() to get the 'bits per pixel' value for
YUV formats, as the value is required to cacluate the size of framebuffer
and DMA transaction.

Signed-off-by: Hyun Kwon <hyun.kwon@xilinx.com>
Reported-by: Christian Kohn <christian.kohn@xilinx.com>
Tested-by: Christian Kohn <christian.kohn@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 1f0843a5e442baee53fb4c45bd31f673026f87cf)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpu/drm/xilinx/xilinx_drm_fb.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/gpu/drm/xilinx/xilinx_drm_fb.c b/drivers/gpu/drm/xilinx/xilinx_drm_fb.c
index 522ec17..255598b 100644
--- a/drivers/gpu/drm/xilinx/xilinx_drm_fb.c
+++ b/drivers/gpu/drm/xilinx/xilinx_drm_fb.c
@@ -417,6 +417,9 @@ struct drm_framebuffer *xilinx_drm_fb_create(struct drm_device *drm,
 
 	drm_fb_get_bpp_depth(mode_cmd->pixel_format, &fb->base.depth,
 			     &fb->base.bits_per_pixel);
+	if (!fb->base.bits_per_pixel)
+		fb->base.bits_per_pixel =
+			xilinx_drm_format_bpp(mode_cmd->pixel_format);
 
 	return &fb->base;
 
-- 
2.9.3

