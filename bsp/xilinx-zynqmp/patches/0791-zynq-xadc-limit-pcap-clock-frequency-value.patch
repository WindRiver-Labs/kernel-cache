From 443df6a83e69e02441c65de9b0651b7b7eff2475 Mon Sep 17 00:00:00 2001
From: Ranjit Waghmode <ranjit.waghmode@xilinx.com>
Date: Fri, 8 Jan 2016 19:18:52 +0530
Subject: [PATCH 791/827] zynq: xadc: limit pcap clock frequency value

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

This patch limits the xadc pcap clock frequency value to be less than
200MHz.

This workaround is required to avoid the below issue:

When zynq is booted at higher frequency values, pcap crosses the maximum
limit of 200MHz(Fmax) as it is derived from IOPLL.
If this limit is crossed it is required to alter the WEDGE and REDGE
bits of XADC_CFG register to make timings better in the interface.
So to avoid alteration of these bits every time, the pcap value should
not cross the Fmax limit.

Signed-off-by: Ranjit Waghmode <ranjit.waghmode@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit a9c2542839c26fcfb6a80d627667b3ba7c0b5c17)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/iio/adc/xilinx-xadc-core.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/drivers/iio/adc/xilinx-xadc-core.c b/drivers/iio/adc/xilinx-xadc-core.c
index accd46e..d18274a 100644
--- a/drivers/iio/adc/xilinx-xadc-core.c
+++ b/drivers/iio/adc/xilinx-xadc-core.c
@@ -322,6 +322,7 @@ static irqreturn_t xadc_zynq_interrupt_handler(int irq, void *devid)
 
 #define XADC_ZYNQ_TCK_RATE_MAX 50000000
 #define XADC_ZYNQ_IGAP_DEFAULT 20
+#define XADC_ZYNQ_PCAP_RATE_MAX 200000000
 
 static int xadc_zynq_setup(struct platform_device *pdev,
 	struct iio_dev *indio_dev, int irq)
@@ -341,6 +342,10 @@ static int xadc_zynq_setup(struct platform_device *pdev,
 
 	pcap_rate = clk_get_rate(xadc->clk);
 
+	if (pcap_rate > XADC_ZYNQ_PCAP_RATE_MAX)
+		clk_set_rate(xadc->clk,
+			(unsigned long) XADC_ZYNQ_PCAP_RATE_MAX);
+
 	if (tck_rate > XADC_ZYNQ_TCK_RATE_MAX)
 		tck_rate = XADC_ZYNQ_TCK_RATE_MAX;
 	if (tck_rate > pcap_rate / 2) {
@@ -368,6 +373,9 @@ static int xadc_zynq_setup(struct platform_device *pdev,
 			XADC_ZYNQ_CFG_REDGE | XADC_ZYNQ_CFG_WEDGE |
 			tck_div | XADC_ZYNQ_CFG_IGAP(igap));
 
+	if (pcap_rate > XADC_ZYNQ_PCAP_RATE_MAX)
+		clk_set_rate(xadc->clk, pcap_rate);
+
 	return 0;
 }
 
-- 
2.9.3

