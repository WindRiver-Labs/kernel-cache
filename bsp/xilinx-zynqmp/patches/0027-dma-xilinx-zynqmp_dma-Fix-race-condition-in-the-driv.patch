From 9ab6e8a4b6d2a2d889592a87cc38f3541965841a Mon Sep 17 00:00:00 2001
From: Kedareswara rao Appana <appana.durga.rao@xilinx.com>
Date: Wed, 6 Jul 2016 18:34:24 +0530
Subject: [PATCH 027/827] dma: xilinx: zynqmp_dma: Fix race condition in the driver

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

In the driver software descriptor pools are allocated only when
SG is enabled in the driver. but we are freeing the desc polls in
Simple dma mode case also which is causing kernel crash when running
The dmatest client multiple times this patch fixes this issue.

Signed-off-by: Kedareswara rao Appana <appanad@xilinx.com>
Reviewed-by: Punnaiah Choudary Kalluri<punnaia@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 333ccab48c97fef9fcbef87079df5ec9c9c7fad4)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/dma/xilinx/zynqmp_dma.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/drivers/dma/xilinx/zynqmp_dma.c b/drivers/dma/xilinx/zynqmp_dma.c
index 09a7d20..328b1d8 100644
--- a/drivers/dma/xilinx/zynqmp_dma.c
+++ b/drivers/dma/xilinx/zynqmp_dma.c
@@ -734,6 +734,10 @@ static void zynqmp_dma_free_chan_resources(struct dma_chan *dchan)
 	zynqmp_dma_free_desc_list(chan, &chan->done_list);
 
 	spin_unlock_bh(&chan->lock);
+
+	if (!chan->has_sg)
+		return;
+
 	dma_free_coherent(chan->dev,
 		(2 * ZYNQMP_DMA_DESC_SIZE(chan) * ZYNQMP_DMA_NUM_DESCS),
 		chan->desc_pool_v, chan->desc_pool_p);
-- 
2.9.3

