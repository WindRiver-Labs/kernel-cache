From d179df21ff1d27e0826918e3f9274a76302ea27a Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyun.kwon@xilinx.com>
Date: Wed, 15 Jan 2014 16:29:14 -0800
Subject: [PATCH 419/827] drm: xilinx: drv: Use the returned bpp to initialize the cma fbdev

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

The bits per pixel  information is returned by crtc, and it is used to
initialize the cma fbdev and allocate the framebuffer in right format.

Signed-off-by: Hyun Kwon <hyunk@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 793417c9d4098d0e82d537dc2608498f40c877d6)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpu/drm/xilinx/xilinx_drm_drv.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/xilinx/xilinx_drm_drv.c b/drivers/gpu/drm/xilinx/xilinx_drm_drv.c
index 664c0ed..66c8b3e 100644
--- a/drivers/gpu/drm/xilinx/xilinx_drm_drv.c
+++ b/drivers/gpu/drm/xilinx/xilinx_drm_drv.c
@@ -197,6 +197,7 @@ static int xilinx_drm_load(struct drm_device *drm, unsigned long flags)
 {
 	struct xilinx_drm_private *private;
 	struct platform_device *pdev = drm->platformdev;
+	unsigned int bpp;
 	int ret;
 
 	private = devm_kzalloc(drm->dev, sizeof(*private), GFP_KERNEL);
@@ -242,7 +243,8 @@ static int xilinx_drm_load(struct drm_device *drm, unsigned long flags)
 	drm->vblank_disable_allowed = 1;
 
 	/* initialize xilinx cma framebuffer */
-	private->fbdev = drm_fbdev_cma_init(drm, 32, 1, 1);
+	bpp = xilinx_drm_format_bpp(xilinx_drm_crtc_get_format(private->crtc));
+	private->fbdev = drm_fbdev_cma_init(drm, bpp, 1, 1);
 	if (IS_ERR(private->fbdev)) {
 		DRM_ERROR("failed to initialize drm cma fbdev\n");
 		ret = PTR_ERR(private->fbdev);
-- 
2.9.3

