From 3af8a9906c74553ebf7e333fe15668aab7d51fe9 Mon Sep 17 00:00:00 2001
From: Radhey Shyam Pandey <radhey.shyam.pandey@xilinx.com>
Date: Mon, 26 May 2014 17:02:13 +0530
Subject: [PATCH 534/827] media: xilinx: Added DMA error handling

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Validate dma tx descriptor returned from
dmaengine_prep_slave_single() and reports
error if any.
Next dequeue operation fails with -ENODEV

Signed-off-by: Radhey Shyam Pandey <radheys@xilinx.com>
Acked-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 9fbec1a7ab89e622e5aaf56fa3a3f7a9cfaefeaf)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-dma.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/drivers/media/platform/xilinx/xilinx-dma.c b/drivers/media/platform/xilinx/xilinx-dma.c
index 855b723b..409aa69 100644
--- a/drivers/media/platform/xilinx/xilinx-dma.c
+++ b/drivers/media/platform/xilinx/xilinx-dma.c
@@ -387,6 +387,11 @@ static void xvip_dma_buffer_queue(struct vb2_buffer *vb)
 
 	desc = dmaengine_prep_slave_single(dma->dma, buf->addr, buf->length,
 					   dir, flags);
+	if (!desc) {
+		dev_err(dma->xdev->dev, "Failed to prepare DMA transfer\n");
+		vb2_buffer_done(&buf->buf, VB2_BUF_STATE_ERROR);
+		return;
+	}
 	desc->callback = xvip_dma_complete;
 	desc->callback_param = buf;
 
-- 
2.9.3

