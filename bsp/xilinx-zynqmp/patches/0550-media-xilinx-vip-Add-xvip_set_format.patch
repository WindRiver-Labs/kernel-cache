From 39ebef171b8ffed47a5ef09e7fe99210594e7747 Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyunk@xilinx.com>
Date: Wed, 18 Dec 2013 17:43:40 -0800
Subject: [PATCH 550/827] media: xilinx: vip: Add xvip_set_format()

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Add xvip_set_format() which set the format of a subdevice.

Signed-off-by: Hyun Kwon <hyunk@xilinx.com>
(cherry picked from commit d7365453a8acf436dc978406b6f7281a7116ae45)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-vip.c | 22 ++++++++++++++++++++++
 drivers/media/platform/xilinx/xilinx-vip.h |  3 +++
 2 files changed, 25 insertions(+)

diff --git a/drivers/media/platform/xilinx/xilinx-vip.c b/drivers/media/platform/xilinx/xilinx-vip.c
index a1d0c31..1dad0ba 100644
--- a/drivers/media/platform/xilinx/xilinx-vip.c
+++ b/drivers/media/platform/xilinx/xilinx-vip.c
@@ -296,3 +296,25 @@ xvip_get_pad_format(struct v4l2_subdev_fh *fh,
 	}
 }
 EXPORT_SYMBOL_GPL(xvip_get_pad_format);
+
+/**
+ * xvip_set_format - Set the subdevice format
+ * @format: V4L2 frame format on media bus
+ * @vip_format: Xilinx Video IP video format
+ * @fmt: media bus format
+ *
+ * Set the subdevice format. The format code is defined in vip_format,
+ * and width and height are defined in subdev format. The new format is stored
+ * in @format.
+ */
+void xvip_set_format(struct v4l2_mbus_framefmt *format,
+		     const struct xvip_video_format *vip_format,
+		     struct v4l2_subdev_format *fmt)
+{
+	format->code = vip_format->code;
+	format->width = clamp_t(unsigned int, fmt->format.width,
+				XVIP_MIN_WIDTH, XVIP_MAX_WIDTH);
+	format->height = clamp_t(unsigned int, fmt->format.height,
+			 XVIP_MIN_HEIGHT, XVIP_MAX_HEIGHT);
+}
+EXPORT_SYMBOL_GPL(xvip_set_format);
diff --git a/drivers/media/platform/xilinx/xilinx-vip.h b/drivers/media/platform/xilinx/xilinx-vip.h
index 0a0369f..c55882e 100644
--- a/drivers/media/platform/xilinx/xilinx-vip.h
+++ b/drivers/media/platform/xilinx/xilinx-vip.h
@@ -128,6 +128,9 @@ struct v4l2_mbus_framefmt *
 xvip_get_pad_format(struct v4l2_subdev_fh *fh,
 		    struct v4l2_mbus_framefmt *format,
 		    unsigned int pad, u32 which);
+void xvip_set_format(struct v4l2_mbus_framefmt *format,
+		     const struct xvip_video_format *vip_format,
+		     struct v4l2_subdev_format *fmt);
 
 static inline u32 xvip_read(struct xvip_device *xvip, u32 addr)
 {
-- 
2.9.3

