From f682fffe4969d23ade119e51aa6d743cb5c749f3 Mon Sep 17 00:00:00 2001
From: VNSL Durga <vnsl.durga.challa@xilinx.com>
Date: Thu, 24 Mar 2016 22:45:02 +0530
Subject: [PATCH 012/827] dma: zynqmp: Added zynqmp_dma_chan_is_idle

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Added zynqmp_dma_chan_is_idle function which returns
idle state of the channel.
Added necessary channel idle state checks and
modified channel idle state based on channel state.

Signed-off-by: VNSL Durga <vnsldurg@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Acked-by: Punnaiah Choudary Kalluri <punnaia@xilinx.com>
(cherry picked from commit 9adfaf3e98c1bd3f52b16fc2178a0d2b11b0b67b)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/dma/xilinx/zynqmp_dma.c | 15 ++++++++++++++-
 1 file changed, 14 insertions(+), 1 deletion(-)

diff --git a/drivers/dma/xilinx/zynqmp_dma.c b/drivers/dma/xilinx/zynqmp_dma.c
index 299dbe5..aea2d2c 100644
--- a/drivers/dma/xilinx/zynqmp_dma.c
+++ b/drivers/dma/xilinx/zynqmp_dma.c
@@ -271,6 +271,18 @@ struct zynqmp_dma_device {
 };
 
 /**
+ * zynqmp_dma_chan_is_idle - Provides the channel idle status
+ * @chan: ZynqMP DMA DMA channel pointer
+ *
+ * Return: 'true' if the channel is idle otherwise 'false'
+ */
+static inline bool zynqmp_dma_chan_is_idle(struct zynqmp_dma_chan *chan)
+{
+	return chan->idle;
+
+}
+
+/**
  * zynqmp_dma_update_desc_to_ctrlr - Updates descriptor to the controller
  * @chan: ZynqMP DMA DMA channel pointer
  * @desc: Transaction descriptor pointer
@@ -573,6 +585,7 @@ static void zynqmp_dma_start(struct zynqmp_dma_chan *chan)
 {
 	writel(ZYNQMP_DMA_INT_EN_DEFAULT_MASK, chan->regs + ZYNQMP_DMA_IER);
 	writel(0, chan->regs + ZYNQMP_DMA_TOTAL_BYTE);
+	chan->idle = false;
 	writel(ZYNQMP_DMA_ENABLE, chan->regs + ZYNQMP_DMA_CTRL2);
 }
 
@@ -606,7 +619,7 @@ static void zynqmp_dma_start_transfer(struct zynqmp_dma_chan *chan)
 	if (list_empty(&chan->pending_list))
 		return;
 
-	if (!chan->idle)
+	if (!zynqmp_dma_chan_is_idle(chan))
 		return;
 
 	desc = list_first_entry(&chan->pending_list,
-- 
2.9.3

