From 926424af201f649368a9cfb5d41147b3d20e2b25 Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyun.kwon@xilinx.com>
Date: Tue, 10 Jun 2014 17:40:35 -0700
Subject: [PATCH 451/827] drm: xilinx: dp: Use 'for' loop for PHY ready iteration

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Simplify the PHY ready function using the 'for' loop. This also removes
the unneccessary wait when PHY is ready right away.

Signed-off-by: Hyun Kwon <hyunk@xilinx.com>
Acked-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 501beced7cde537b710db234485eb1bf8ba6f751)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpu/drm/xilinx/xilinx_drm_dp.c | 21 +++++++++++----------
 1 file changed, 11 insertions(+), 10 deletions(-)

diff --git a/drivers/gpu/drm/xilinx/xilinx_drm_dp.c b/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
index 8f4c009..a72c994 100644
--- a/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
+++ b/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
@@ -482,21 +482,22 @@ static inline int xilinx_drm_dp_aux_read(struct xilinx_drm_dp *dp, u16 addr,
  */
 static int xilinx_drm_dp_phy_ready(struct xilinx_drm_dp *dp)
 {
-	u32 count = 100, reg;
+	u32 i, reg;
 
 	/* Wait for 100 * 1ms. This should be enough time for PHY to be ready */
-	do {
+	for (i = 0; ; i++) {
 		reg = xilinx_drm_readl(dp->iomem, XILINX_DP_TX_PHY_STATUS);
-		usleep_range(1000, 1100);
-	} while ((reg & XILINX_DP_TX_PHY_STATUS_READY_MASK) !=
-		 XILINX_DP_TX_PHY_STATUS_READY_MASK && --count > 0);
+		if ((reg & XILINX_DP_TX_PHY_STATUS_READY_MASK) ==
+		    XILINX_DP_TX_PHY_STATUS_READY_MASK)
+			return 0;
 
-	if (count == 0) {
-		dev_err(dp->dev, "PHY isn't ready\n");
-		return -ENODEV;
-	}
+		if (i == 100) {
+			dev_err(dp->dev, "PHY isn't ready\n");
+			return -ENODEV;
+		}
 
-	return 0;
+		usleep_range(1000, 1100);
+	}
 }
 
 /**
-- 
2.9.3

