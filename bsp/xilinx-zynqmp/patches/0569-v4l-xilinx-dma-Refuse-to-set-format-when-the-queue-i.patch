From 4b1ac4d4aa7c07ec3ebcae00628b5a92397e7d59 Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date: Sat, 1 Nov 2014 15:26:27 +0200
Subject: [PATCH 569/827] v4l: xilinx: dma: Refuse to set format when the queue is busy

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Setting the format must be rejected not only when the queue is streaming
but also just when buffers have been allocated. Fix it.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
(cherry picked from commit da032da3f4d23bf56605f2aa4d68a378be49f3b3)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-dma.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/media/platform/xilinx/xilinx-dma.c b/drivers/media/platform/xilinx/xilinx-dma.c
index 10bbaba..9be6345 100644
--- a/drivers/media/platform/xilinx/xilinx-dma.c
+++ b/drivers/media/platform/xilinx/xilinx-dma.c
@@ -650,7 +650,7 @@ xvip_dma_set_format(struct file *file, void *fh, struct v4l2_format *format)
 
 	mutex_lock(&dma->lock);
 
-	if (vb2_is_streaming(&dma->queue)) {
+	if (vb2_is_busy(&dma->queue)) {
 		ret = -EBUSY;
 		goto done;
 	}
-- 
2.9.3

