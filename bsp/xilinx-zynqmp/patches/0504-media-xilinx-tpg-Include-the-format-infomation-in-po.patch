From 0883c6622bbb629952f40b95131cc47b2340a0b6 Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyun.kwon@xilinx.com>
Date: Tue, 18 Mar 2014 09:19:00 -0700
Subject: [PATCH 504/827] media: xilinx: tpg: Include the format infomation in 'port' node

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Include the format information on each 'port' node in DT. This enables
to have different formats on each pad, and improves readability of
connectivity between IP cores in DTS.

Signed-off-by: Hyun Kwon <hyunk@xilinx.com>
Acked-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit dea7505999cb827dbdcd1e833062b31d77d53c58)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-tpg.c | 30 +++++++++++++++++++++---------
 1 file changed, 21 insertions(+), 9 deletions(-)

diff --git a/drivers/media/platform/xilinx/xilinx-tpg.c b/drivers/media/platform/xilinx/xilinx-tpg.c
index bd50944..827cde7 100644
--- a/drivers/media/platform/xilinx/xilinx-tpg.c
+++ b/drivers/media/platform/xilinx/xilinx-tpg.c
@@ -646,34 +646,46 @@ static int __maybe_unused xtpg_pm_resume(struct device *dev)
 
 static int xtpg_parse_of(struct xtpg_device *xtpg)
 {
+	struct device *dev = xtpg->xvip.dev;
 	struct device_node *node = xtpg->xvip.dev->of_node;
 	struct device_node *ports;
 	struct device_node *port;
 	unsigned int nports = 0;
 
-	/* Count the number of ports. */
 	ports = of_get_child_by_name(node, "ports");
 	if (ports == NULL)
 		ports = node;
 
 	for_each_child_of_node(ports, port) {
-		if (port->name && (of_node_cmp(port->name, "port") == 0))
+		if (port->name && (of_node_cmp(port->name, "port") == 0)) {
+			const struct xvip_video_format *vip_format;
+
+			vip_format = xvip_of_get_format(port);
+			if (IS_ERR(vip_format)) {
+				dev_err(dev, "invalid format in DT");
+				return PTR_ERR(vip_format);
+			}
+
+			/* Get and check the format description */
+			if (!xtpg->vip_format) {
+				xtpg->vip_format = vip_format;
+			} else if (xtpg->vip_format != vip_format) {
+				dev_err(dev, "in/out format mismatch in DT");
+				return -EINVAL;
+			}
+
+			/* Count the number of ports. */
 			nports++;
+		}
 	}
 
 	if (nports != 1 && nports != 2) {
-		dev_err(xtpg->xvip.dev, "invalid number of ports %u\n", nports);
+		dev_err(dev, "invalid number of ports %u\n", nports);
 		return -EINVAL;
 	}
 
 	xtpg->npads = nports;
 
-	xtpg->vip_format = xvip_of_get_format(node);
-	if (IS_ERR(xtpg->vip_format)) {
-		dev_err(xtpg->xvip.dev, "invalid format in DT\n");
-		return PTR_ERR(xtpg->vip_format);
-	}
-
 	return 0;
 }
 
-- 
2.9.3

