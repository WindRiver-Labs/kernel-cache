From 4a80ac0b715bcfe353086fddca4e5da6d9b8011b Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date: Thu, 27 Nov 2014 04:03:15 +0200
Subject: [PATCH 579/827] v4l: xilinx: tpg: Use xvip_init_resources()

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Replace the manual ioremap by a call to xvip_init_resources(), which
also handles the functional clock.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
(cherry picked from commit bcb4312080b515bd694cff9d242855264a8fd316)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-tpg.c | 26 +++++++++++++++-----------
 1 file changed, 15 insertions(+), 11 deletions(-)

diff --git a/drivers/media/platform/xilinx/xilinx-tpg.c b/drivers/media/platform/xilinx/xilinx-tpg.c
index 0b7d075..b62321c 100644
--- a/drivers/media/platform/xilinx/xilinx-tpg.c
+++ b/drivers/media/platform/xilinx/xilinx-tpg.c
@@ -762,7 +762,6 @@ static int xtpg_probe(struct platform_device *pdev)
 {
 	struct v4l2_subdev *subdev;
 	struct xtpg_device *xtpg;
-	struct resource *res;
 	u32 i, bayer_phase;
 	int ret;
 
@@ -776,20 +775,23 @@ static int xtpg_probe(struct platform_device *pdev)
 	if (ret < 0)
 		return ret;
 
-	res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
-	xtpg->xvip.iomem = devm_ioremap_resource(&pdev->dev, res);
-	if (IS_ERR(xtpg->xvip.iomem))
-		return PTR_ERR(xtpg->xvip.iomem);
+	ret = xvip_init_resources(&xtpg->xvip);
+	if (ret < 0)
+		return ret;
 
 	xtpg->vtmux_gpio = devm_gpiod_get_index(&pdev->dev, "timing", 0);
-	if (PTR_ERR(xtpg->vtmux_gpio) == -EPROBE_DEFER)
-		return -EPROBE_DEFER;
+	if (PTR_ERR(xtpg->vtmux_gpio) == -EPROBE_DEFER) {
+		ret = -EPROBE_DEFER;
+		goto error;
+	}
 	if (!IS_ERR(xtpg->vtmux_gpio))
 		gpiod_direction_output(xtpg->vtmux_gpio, 1);
 
 	xtpg->vtc = xvtc_of_get(pdev->dev.of_node);
-	if (IS_ERR(xtpg->vtc))
-		return PTR_ERR(xtpg->vtc);
+	if (IS_ERR(xtpg->vtc)) {
+		ret = PTR_ERR(xtpg->vtc);
+		goto error;
+	}
 
 	/* Reset and initialize the core */
 	xvip_reset(&xtpg->xvip);
@@ -830,7 +832,7 @@ static int xtpg_probe(struct platform_device *pdev)
 
 	ret = media_entity_init(&subdev->entity, xtpg->npads, xtpg->pads, 0);
 	if (ret < 0)
-		goto error_media_init;
+		goto error;
 
 	v4l2_ctrl_handler_init(&xtpg->ctrl_handler, 3 + ARRAY_SIZE(xtpg_ctrls));
 
@@ -878,8 +880,8 @@ static int xtpg_probe(struct platform_device *pdev)
 error:
 	v4l2_ctrl_handler_free(&xtpg->ctrl_handler);
 	media_entity_cleanup(&subdev->entity);
-error_media_init:
 	xvtc_put(xtpg->vtc);
+	xvip_cleanup_resources(&xtpg->xvip);
 	return ret;
 }
 
@@ -892,6 +894,8 @@ static int xtpg_remove(struct platform_device *pdev)
 	v4l2_ctrl_handler_free(&xtpg->ctrl_handler);
 	media_entity_cleanup(&subdev->entity);
 
+	xvip_cleanup_resources(&xtpg->xvip);
+
 	return 0;
 }
 
-- 
2.9.3

