From 52d2c8e1d0b1e245b32f80374ec110b48c9ed65c Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Fri, 30 Sep 2016 07:13:47 +0800
Subject: [PATCH 821/827] can: xilinx: add workaround for the possible dts mismatch

This patch is to workaround the wrong runtime issue due to dts
data mismatch.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/net/can/xilinx_can.c | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/drivers/net/can/xilinx_can.c b/drivers/net/can/xilinx_can.c
index a89f6ee..982b3c1 100644
--- a/drivers/net/can/xilinx_can.c
+++ b/drivers/net/can/xilinx_can.c
@@ -1208,12 +1208,14 @@ static int xcan_open(struct net_device *ndev)
 	struct xcan_priv *priv = netdev_priv(ndev);
 	int ret;
 
+#ifdef CONFIG_PM_AUTOSLEEP
 	ret = pm_runtime_get_sync(priv->dev);
 	if (ret < 0) {
 		netdev_err(ndev, "%s: pm_runtime_get failed(%d)\n",
 				__func__, ret);
 		return ret;
 	}
+#endif
 
 	ret = request_irq(ndev->irq, xcan_interrupt, priv->irq_flags,
 			ndev->name, ndev);
@@ -1251,7 +1253,9 @@ err_candev:
 err_irq:
 	free_irq(ndev->irq, ndev);
 err:
+#ifdef CONFIG_PM_AUTOSLEEP
 	pm_runtime_put(priv->dev);
+#endif
 
 	return ret;
 }
@@ -1273,7 +1277,9 @@ static int xcan_close(struct net_device *ndev)
 	close_candev(ndev);
 
 	can_led_event(ndev, CAN_LED_EVENT_STOP);
+#ifdef CONFIG_PM_AUTOSLEEP
 	pm_runtime_put(priv->dev);
+#endif
 
 	return 0;
 }
@@ -1290,6 +1296,7 @@ static int xcan_get_berr_counter(const struct net_device *ndev,
 					struct can_berr_counter *bec)
 {
 	struct xcan_priv *priv = netdev_priv(ndev);
+#ifdef CONFIG_PM_AUTOSLEEP
 	int ret;
 
 	ret = pm_runtime_get_sync(priv->dev);
@@ -1298,12 +1305,15 @@ static int xcan_get_berr_counter(const struct net_device *ndev,
 				__func__, ret);
 		return ret;
 	}
+#endif
 
 	bec->txerr = priv->read_reg(priv, XCAN_ECR_OFFSET) & XCAN_ECR_TEC_MASK;
 	bec->rxerr = ((priv->read_reg(priv, XCAN_ECR_OFFSET) &
 			XCAN_ECR_REC_MASK) >> XCAN_ESR_REC_SHIFT);
 
+#ifdef CONFIG_PM_AUTOSLEEP
 	pm_runtime_put(priv->dev);
+#endif
 
 	return 0;
 }
@@ -1568,7 +1578,7 @@ static int xcan_probe(struct platform_device *pdev)
 
 	pm_runtime_put(&pdev->dev);
 
-	netdev_dbg(ndev, "reg_base=0x%p irq=%d clock=%d, tx fifo depth:%d\n",
+	netdev_info(ndev, "reg_base=0x%p irq=%d clock=%d, tx fifo depth:%d\n",
 			priv->reg_base, ndev->irq, priv->can.clock.freq,
 			priv->tx_max);
 
-- 
2.9.3

