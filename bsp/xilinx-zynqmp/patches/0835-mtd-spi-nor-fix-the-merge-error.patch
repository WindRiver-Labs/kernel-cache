From cca383fcfa704616d7c6c7ab5fd48e496156d422 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Thu, 17 Nov 2016 10:21:49 +0800
Subject: [PATCH 835/844] mtd: spi-nor: fix the merge error

The related commit 5bf0e69b comes from:
  https://github.com/Xilinx/linux-xlnx.git

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/mtd/spi-nor/spi-nor.c | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/drivers/mtd/spi-nor/spi-nor.c b/drivers/mtd/spi-nor/spi-nor.c
index cac83e6..f8169a3 100644
--- a/drivers/mtd/spi-nor/spi-nor.c
+++ b/drivers/mtd/spi-nor/spi-nor.c
@@ -1767,7 +1767,14 @@ int spi_nor_scan(struct spi_nor *nor, const char *name, enum read_mode mode)
 	nor->sector_size = info->sector_size;
 
 	/* NOR protection support for STmicro/Micron chips and similar */
-	if (info->flags & SPI_NOR_FLASH_LOCK) {
+	if (JEDEC_MFR(info) == SNOR_MFR_MICRON ||
+			info->flags & SPI_NOR_HAS_LOCK) {
+		nor->flash_lock = stm_lock;
+		nor->flash_unlock = stm_unlock;
+		nor->flash_is_locked = stm_is_locked;
+	}
+
+	if (nor->flash_lock && nor->flash_unlock && nor->flash_is_locked) {
 		mtd->_lock = spi_nor_lock;
 		mtd->_unlock = spi_nor_unlock;
 		mtd->_is_locked = spi_nor_is_locked;
-- 
1.9.1

