From 5247a8c1521dd0d0813594d699018e1fa299e899 Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date: Thu, 25 Sep 2014 16:04:25 +0300
Subject: [PATCH 563/827] v4l: xilinx: tpg: Lock the control handler when modifying control range

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

__v4l2_ctrl_modify_range has to be called with the control handler lock
held, which isn't the case in all code paths. Fix them.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
(cherry picked from commit f1927bbd3337888af25f9890d230f9ca4c5b9a52)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-tpg.c | 14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

diff --git a/drivers/media/platform/xilinx/xilinx-tpg.c b/drivers/media/platform/xilinx/xilinx-tpg.c
index e59dad9..c8cb496 100644
--- a/drivers/media/platform/xilinx/xilinx-tpg.c
+++ b/drivers/media/platform/xilinx/xilinx-tpg.c
@@ -129,8 +129,8 @@ static u32 xtpg_get_bayer_phase(unsigned int code)
 	}
 }
 
-static void xtpg_update_pattern_control(struct xtpg_device *xtpg,
-					bool passthrough, bool pattern)
+static void __xtpg_update_pattern_control(struct xtpg_device *xtpg,
+					  bool passthrough, bool pattern)
 {
 	u32 pattern_mask = (1 << (xtpg->pattern->maximum + 1)) - 1;
 
@@ -153,6 +153,14 @@ static void xtpg_update_pattern_control(struct xtpg_device *xtpg,
 				 pattern_mask, pattern ? 9 : 0);
 }
 
+static void xtpg_update_pattern_control(struct xtpg_device *xtpg,
+					bool passthrough, bool pattern)
+{
+	mutex_lock(xtpg->ctrl_handler.lock);
+	__xtpg_update_pattern_control(xtpg, passthrough, pattern);
+	mutex_unlock(xtpg->ctrl_handler.lock);
+}
+
 /* -----------------------------------------------------------------------------
  * V4L2 Subdevice Video Operations
  */
@@ -216,7 +224,7 @@ static int xtpg_s_stream(struct v4l2_subdev *subdev, int enable)
 	 * allowed during streaming, update the control range accordingly.
 	 */
 	passthrough = xtpg->pattern->cur.val == 0;
-	xtpg_update_pattern_control(xtpg, passthrough, !passthrough);
+	__xtpg_update_pattern_control(xtpg, passthrough, !passthrough);
 
 	xtpg->streaming = true;
 
-- 
2.9.3

