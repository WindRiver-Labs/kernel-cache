From eba7006134997bce6a76a14512e02ffdee984131 Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyun.kwon@xilinx.com>
Date: Tue, 18 Mar 2014 09:19:07 -0700
Subject: [PATCH 511/827] media: xilinx: vipp: Add control to inherit subdevice controls

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Add a dummy control handler to inherit subdevices to the video node.

Signed-off-by: Hyun Kwon <hyunk@xilinx.com>
Acked-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 8394dc31aa843e2115018bc7df0785a93225eebc)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-vipp.c | 4 ++++
 drivers/media/platform/xilinx/xilinx-vipp.h | 4 ++++
 2 files changed, 8 insertions(+)

diff --git a/drivers/media/platform/xilinx/xilinx-vipp.c b/drivers/media/platform/xilinx/xilinx-vipp.c
index 02759f5..12319e9 100644
--- a/drivers/media/platform/xilinx/xilinx-vipp.c
+++ b/drivers/media/platform/xilinx/xilinx-vipp.c
@@ -516,6 +516,7 @@ done:
 
 static void xvipp_v4l2_cleanup(struct xvip_pipeline *xvipp)
 {
+	v4l2_ctrl_handler_free(&xvipp->ctrl_handler);
 	v4l2_device_unregister(&xvipp->v4l2_dev);
 	media_device_unregister(&xvipp->media_dev);
 }
@@ -545,6 +546,9 @@ static int xvipp_v4l2_init(struct xvip_pipeline *xvipp)
 		return ret;
 	}
 
+	v4l2_ctrl_handler_init(&xvipp->ctrl_handler, 0);
+	xvipp->v4l2_dev.ctrl_handler = &xvipp->ctrl_handler;
+
 	return 0;
 }
 
diff --git a/drivers/media/platform/xilinx/xilinx-vipp.h b/drivers/media/platform/xilinx/xilinx-vipp.h
index 7b2bc52..849ab67 100644
--- a/drivers/media/platform/xilinx/xilinx-vipp.h
+++ b/drivers/media/platform/xilinx/xilinx-vipp.h
@@ -17,6 +17,7 @@
 #include <linux/mutex.h>
 #include <media/media-device.h>
 #include <media/v4l2-async.h>
+#include <media/v4l2-ctrls.h>
 #include <media/v4l2-device.h>
 
 #include "xilinx-dma.h"
@@ -34,6 +35,7 @@
  * @num_dmas: number of DMA engines in the pipeline
  * @lock: protects the pipeline @stream_count
  * @stream_count: number of DMA engines currently streaming
+ * @ctrl_handler: control handler
  */
 struct xvip_pipeline {
 	struct v4l2_device v4l2_dev;
@@ -50,6 +52,8 @@ struct xvip_pipeline {
 
 	struct mutex lock;
 	unsigned int stream_count;
+
+	struct v4l2_ctrl_handler ctrl_handler;
 };
 
 int xvip_pipeline_set_stream(struct xvip_pipeline *xvipp, bool on);
-- 
2.9.3

