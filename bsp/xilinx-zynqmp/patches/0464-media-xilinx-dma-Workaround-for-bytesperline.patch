From 46d950c3ce6a515ea567822e5883ac0cc5e88af6 Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyun.kwon@xilinx.com>
Date: Tue, 18 Mar 2014 09:18:20 -0700
Subject: [PATCH 464/827] media: xilinx: dma: Workaround for bytesperline

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Workaround for bytesperline bug from mplayer. The mplayer (svn r34540)
that was installed in Ubuntu 12.10 and used for demo uses the bytes per
line value from V4L2 drivers without initialization. Since mplayer
doesn't change this value, mplayer could use the wrong bytes per line
value, for example, the default value (1920 * 4) for different
resolution (640x480).

The best way is to send a patch to the mplayer mailing list, and this
doesn't intend to be included in the kernel tree.

Signed-off-by: Hyun Kwon <hyunk@xilinx.com>
Acked-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit b4859c939e1febb638e23accc1c3a66b72e10ccc)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-dma.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/drivers/media/platform/xilinx/xilinx-dma.c b/drivers/media/platform/xilinx/xilinx-dma.c
index 98c2a49..03e4bbd 100644
--- a/drivers/media/platform/xilinx/xilinx-dma.c
+++ b/drivers/media/platform/xilinx/xilinx-dma.c
@@ -349,6 +349,10 @@ __xvip_dma_try_format(struct xvip_dma *dma, struct v4l2_pix_format *pix,
 	 */
 	min_bpl = pix->width * info->bpp;
 	max_bpl = rounddown(XVIP_DMA_MAX_WIDTH, dma->align);
+	/* HACK: mplayer (svn r32540) doesn't initialize the byteperline field,
+	 * so hardcode it to the minimum value.
+	 */
+	pix->bytesperline = min_bpl;
 	bpl = rounddown(pix->bytesperline, dma->align);
 
 	pix->bytesperline = clamp(bpl, min_bpl, max_bpl);
-- 
2.9.3

