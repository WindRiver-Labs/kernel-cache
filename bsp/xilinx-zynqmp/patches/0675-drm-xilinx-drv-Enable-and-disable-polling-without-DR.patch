From 3c608cb8e98e58977eed10e3f61fab7ad25e09e5 Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyun.kwon@xilinx.com>
Date: Fri, 25 Mar 2016 13:00:46 -0700
Subject: [PATCH 675/827] drm: xilinx: drv: Enable and disable polling without DRM locks

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

The mode_config lock is held by drm_modeset_lock_all(), so
the locked version of poll enable function must be used.
Also, disable the poll without holding locks.

Reported-by: SÃ¶ren Brinkmann <soren.brinkmann@xilinx.com>
Signed-off-by: Hyun Kwon <hyun.kwon@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 569b2e47c1caaa0b40d7775439b36dceb28d8128)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpu/drm/xilinx/xilinx_drm_drv.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/xilinx/xilinx_drm_drv.c b/drivers/gpu/drm/xilinx/xilinx_drm_drv.c
index 507f543..cd880cd 100644
--- a/drivers/gpu/drm/xilinx/xilinx_drm_drv.c
+++ b/drivers/gpu/drm/xilinx/xilinx_drm_drv.c
@@ -433,8 +433,8 @@ static int xilinx_drm_pm_suspend(struct device *dev)
 	struct drm_device *drm = private->drm;
 	struct drm_connector *connector;
 
-	drm_modeset_lock_all(drm);
 	drm_kms_helper_poll_disable(drm);
+	drm_modeset_lock_all(drm);
 	list_for_each_entry(connector, &drm->mode_config.connector_list, head) {
 		int old_dpms = connector->dpms;
 
@@ -465,7 +465,7 @@ static int xilinx_drm_pm_resume(struct device *dev)
 			connector->funcs->dpms(connector, dpms);
 		}
 	}
-	drm_kms_helper_poll_enable(drm);
+	drm_kms_helper_poll_enable_locked(drm);
 	drm_modeset_unlock_all(drm);
 
 	return 0;
-- 
2.9.3

