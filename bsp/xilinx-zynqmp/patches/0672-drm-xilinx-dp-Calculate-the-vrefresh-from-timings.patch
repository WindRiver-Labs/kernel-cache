From 77f59a5cc08106c782754f254cf9aa87de689287 Mon Sep 17 00:00:00 2001
From: Hyun Kwon <hyun.kwon@xilinx.com>
Date: Fri, 25 Mar 2016 13:00:43 -0700
Subject: [PATCH 672/827] drm: xilinx: dp: Calculate the vrefresh from timings

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

The vrefresh in the drm_display_mode is set to 0, which results in
wrong pixel clock frequency. Thus, calculate the vrefresh from
given timing information.

Signed-off-by: Hyun Kwon <hyun.kwon@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 4563f7f0bf37b656b00bf4b24dc34f2e7ab91e03)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/gpu/drm/xilinx/xilinx_drm_dp.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/xilinx/xilinx_drm_dp.c b/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
index cc85016..ef283f3 100644
--- a/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
+++ b/drivers/gpu/drm/xilinx/xilinx_drm_dp.c
@@ -816,11 +816,13 @@ static bool xilinx_drm_dp_mode_fixup(struct drm_encoder *encoder,
 	 * This limitation may conflict with the sink device.
 	 */
 	if (dp->dp_sub && diff < XILINX_DP_SUB_TX_MIN_H_BACKPORCH) {
+		int vrefresh = (adjusted_mode->clock * 1000) /
+			       (adjusted_mode->vtotal * adjusted_mode->htotal);
+
 		diff = XILINX_DP_SUB_TX_MIN_H_BACKPORCH - diff;
 		adjusted_mode->htotal += diff;
 		adjusted_mode->clock = adjusted_mode->vtotal *
-				       adjusted_mode->htotal *
-				       adjusted_mode->vrefresh / 1000;
+				       adjusted_mode->htotal * vrefresh / 1000;
 	}
 
 	return true;
-- 
2.9.3

