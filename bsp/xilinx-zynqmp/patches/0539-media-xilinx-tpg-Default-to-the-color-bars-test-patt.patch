From fa641af0ca5433004d406b1d890aea6f093fa806 Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <[laurent.pinchart@ideasonboard.com]>
Date: Mon, 16 Jun 2014 13:22:34 -0700
Subject: [PATCH 539/827] media: xilinx: tpg: Default to the color bars test pattern

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Accessing the TPG registers requires an external input clock, otherwise
an external abort exception will be triggered.

Defaulting to passthrough mode switches the timing mux to the external
clock at initialization time. If the external clock isn't provided (for
instance because the input hardware is disconnected), this results in a
kernel crash when the TPG is initialized.

Fix this by defaulting to a test pattern.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
(cherry picked from commit 887e5ae70707c99656ac3f137e53961cbac4d81f)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/media/platform/xilinx/xilinx-tpg.c | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/drivers/media/platform/xilinx/xilinx-tpg.c b/drivers/media/platform/xilinx/xilinx-tpg.c
index 89bd7f2..0eac77e 100644
--- a/drivers/media/platform/xilinx/xilinx-tpg.c
+++ b/drivers/media/platform/xilinx/xilinx-tpg.c
@@ -704,7 +704,7 @@ static int xtpg_probe(struct platform_device *pdev)
 	if (PTR_ERR(xtpg->vtmux_gpio) == -EPROBE_DEFER)
 		return -EPROBE_DEFER;
 	if (!IS_ERR(xtpg->vtmux_gpio))
-		gpiod_direction_output(xtpg->vtmux_gpio, 0);
+		gpiod_direction_output(xtpg->vtmux_gpio, 1);
 
 	xtpg->vtc = xvtc_of_get(pdev->dev.of_node);
 	if (IS_ERR(xtpg->vtc))
@@ -756,8 +756,7 @@ static int xtpg_probe(struct platform_device *pdev)
 	v4l2_ctrl_new_std_menu_items(&xtpg->ctrl_handler, &xtpg_ctrl_ops,
 				     V4L2_CID_TEST_PATTERN,
 				     ARRAY_SIZE(xtpg_pattern_strings) - 1,
-				     xtpg->npads == 2 ? 0 : 1,
-				     xtpg->npads == 2 ? 0 : 1,
+				     xtpg->npads == 2 ? 0 : 1, 9,
 				     xtpg_pattern_strings);
 
 	for (i = 0; i < ARRAY_SIZE(xtpg_ctrls); i++)
-- 
2.9.3

