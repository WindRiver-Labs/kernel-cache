From 2dca2c70d746ca52774b1c5014e6212aaeb9c70d Mon Sep 17 00:00:00 2001
From: "Edgar E. Iglesias" <edgar.iglesias@xilinx.com>
Date: Fri, 12 Jun 2015 15:22:00 +1000
Subject: [PATCH 354/827] virtio: Add __virtqueue_add_sgs

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

Add __virtqueue_add_sgs with an option to use DMA mapped
scatterlists. This option is only meant to be used in combination
with remoteproc/rpmsg.

Signed-off-by: Edgar E. Iglesias <edgar.iglesias@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 68cb682733a15c4cc1ce6c15a1d05637ee2f9954)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/virtio/virtio_ring.c | 27 ++++++++++++++++++++-------
 include/linux/virtio.h       |  8 ++++++++
 2 files changed, 28 insertions(+), 7 deletions(-)

diff --git a/drivers/virtio/virtio_ring.c b/drivers/virtio/virtio_ring.c
index 233f3c6..fb9f52d 100644
--- a/drivers/virtio/virtio_ring.c
+++ b/drivers/virtio/virtio_ring.c
@@ -275,18 +275,20 @@ static inline int virtqueue_add(struct virtqueue *_vq,
  * @in_num: the number of scatterlists which are writable (after readable ones)
  * @data: the token identifying the buffer.
  * @gfp: how to do memory allocations (if necessary).
+ * @dma: Use DMA mapped scatterlists. (Only for remoteproc/rpmsg).
  *
  * Caller must ensure we don't call this with other virtqueue operations
  * at the same time (except where noted).
  *
  * Returns zero or a negative error (ie. ENOSPC, ENOMEM, EIO).
  */
-int virtqueue_add_sgs(struct virtqueue *_vq,
-		      struct scatterlist *sgs[],
-		      unsigned int out_sgs,
-		      unsigned int in_sgs,
-		      void *data,
-		      gfp_t gfp)
+int __virtqueue_add_sgs(struct virtqueue *_vq,
+			struct scatterlist *sgs[],
+			unsigned int out_sgs,
+			unsigned int in_sgs,
+			void *data,
+			gfp_t gfp,
+			bool dma)
 {
 	unsigned int i, total_sg = 0;
 
@@ -297,7 +299,18 @@ int virtqueue_add_sgs(struct virtqueue *_vq,
 			total_sg++;
 	}
 	return virtqueue_add(_vq, sgs, total_sg, out_sgs, in_sgs, data, gfp,
-			     false);
+			     dma);
+}
+EXPORT_SYMBOL_GPL(__virtqueue_add_sgs);
+
+int virtqueue_add_sgs(struct virtqueue *_vq,
+		      struct scatterlist *sgs[],
+		      unsigned int out_sgs,
+		      unsigned int in_sgs,
+		      void *data,
+		      gfp_t gfp)
+{
+	return __virtqueue_add_sgs(_vq, sgs, out_sgs, in_sgs, data, gfp, false);
 }
 EXPORT_SYMBOL_GPL(virtqueue_add_sgs);
 
diff --git a/include/linux/virtio.h b/include/linux/virtio.h
index 8f4d4bf..82782ee 100644
--- a/include/linux/virtio.h
+++ b/include/linux/virtio.h
@@ -44,6 +44,14 @@ int virtqueue_add_inbuf(struct virtqueue *vq,
 			void *data,
 			gfp_t gfp);
 
+int __virtqueue_add_sgs(struct virtqueue *vq,
+			struct scatterlist *sgs[],
+			unsigned int out_sgs,
+			unsigned int in_sgs,
+			void *data,
+			gfp_t gfp,
+			bool dma);
+
 int virtqueue_add_sgs(struct virtqueue *vq,
 		      struct scatterlist *sgs[],
 		      unsigned int out_sgs,
-- 
2.9.3

