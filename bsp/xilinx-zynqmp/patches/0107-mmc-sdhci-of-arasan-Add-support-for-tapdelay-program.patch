From a2cb5634332a5dee2ca9145eb617d5cad11c16f6 Mon Sep 17 00:00:00 2001
From: Sai Krishna Potthuri <lakshmi.sai.krishna.potthuri@xilinx.com>
Date: Tue, 16 Aug 2016 14:41:32 +0530
Subject: [PATCH 107/827] mmc: sdhci-of-arasan: Add support for tapdelay programming

This patch comes from:
  https://github.com/Xilinx/linux-xlnx.git

This patch adds support for Tap delay programming accordingly
to different SD/eMMC operating modes.

Signed-off-by: Sai Krishna Potthuri <lakshmis@xilinx.com>
Signed-off-by: Michal Simek <michal.simek@xilinx.com>
(cherry picked from commit 0fb3161d0a607b4a443876692ac626e241a0b442)
Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/mmc/host/sdhci-of-arasan.c | 27 +++++++++++++++++++++++++++
 1 file changed, 27 insertions(+)

diff --git a/drivers/mmc/host/sdhci-of-arasan.c b/drivers/mmc/host/sdhci-of-arasan.c
index 5753e10..ccd2540 100644
--- a/drivers/mmc/host/sdhci-of-arasan.c
+++ b/drivers/mmc/host/sdhci-of-arasan.c
@@ -22,6 +22,7 @@
 #include <linux/module.h>
 #include <linux/of_device.h>
 #include <linux/phy/phy.h>
+#include <linux/soc/xilinx/zynqmp/tap_delays.h>
 #include "sdhci-pltfm.h"
 
 #define SDHCI_ARASAN_CLK_CTRL_OFFSET	0x2c
@@ -40,6 +41,8 @@
 struct sdhci_arasan_data {
 	struct clk	*clk_ahb;
 	struct phy	*phy;
+	u32 mio_bank;
+	u32 device_id;
 };
 
 static unsigned int sdhci_arasan_get_timeout_clock(struct sdhci_host *host)
@@ -87,6 +90,11 @@ static void sdhci_arasan_set_clock(struct sdhci_host *host, unsigned int clock)
 		(host->version >= SDHCI_SPEC_300)) {
 		if (clock == SD_CLK_25_MHZ)
 			clock = SD_CLK_19_MHZ;
+		if ((host->timing != MMC_TIMING_LEGACY) &&
+			(host->timing != MMC_TIMING_UHS_SDR12))
+			arasan_zynqmp_set_tap_delay(sdhci_arasan->device_id,
+						    host->timing,
+						    sdhci_arasan->mio_bank);
 	}
 
 	if (ctrl_phy) {
@@ -254,6 +262,25 @@ static int sdhci_arasan_probe(struct platform_device *pdev)
 					"arasan,sdhci-8.9a")) {
 		host->quirks |= SDHCI_QUIRK_MULTIBLOCK_READ_ACMD12;
 		host->quirks2 |= SDHCI_QUIRK2_CLOCK_STANDARD_25_BROKEN;
+		if (of_device_is_compatible(pdev->dev.of_node,
+					    "xlnx,zynqmp-8.9a")) {
+			ret = of_property_read_u32(pdev->dev.of_node,
+						   "xlnx,mio_bank",
+						   &sdhci_arasan->mio_bank);
+			if (ret < 0) {
+				dev_err(&pdev->dev,
+					"\"xlnx,mio_bank \" property is missing.\n");
+				goto clk_disable_all;
+			}
+			ret = of_property_read_u32(pdev->dev.of_node,
+						   "xlnx,device_id",
+						   &sdhci_arasan->device_id);
+			if (ret < 0) {
+				dev_err(&pdev->dev,
+					"\"xlnx,device_id \" property is missing.\n");
+				goto clk_disable_all;
+			}
+		}
 	}
 
 	sdhci_arasan->phy = ERR_PTR(-ENODEV);
-- 
2.9.3

