From 76e6633ea1a3097d9ae39529da90753a47c3c02b Mon Sep 17 00:00:00 2001
From: Hui Wang <Hui.Wang@windriver.com>
Date: Fri, 27 May 2011 13:24:27 +0800
Subject: [PATCH] mx5/clock: add clock definition for secure jtag

When we use jtag debugger to read the DDR ram on the MX51 board,
all feadback contents are zero.

From the chapter 7 "Debug Architecture" of the "MCIMX51 Multimedia
Applications Processor Reference Manual", we can see the sjtag is
a sub-device of the whole security system. From the chapter 14
"Multi-Layer AHB Crossbar Switch (MAX), we can see the security system
is connected to other AHB devices (like DDR RAM) through AHB MAX1, so
if we want sjtag to access other AHB devices, we should enable MAX1
clock first.

After enabling TMAX1 clock, the DDR RAM can be accessed correctly.

Signed-off-by: Hui Wang <Hui.Wang@windriver.com>
---
 arch/arm/mach-mx5/clock-mx51.c |   11 +++++++++++
 1 files changed, 11 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-mx5/clock-mx51.c b/arch/arm/mach-mx5/clock-mx51.c
index ff01dd8..ad5eef3 100644
--- a/arch/arm/mach-mx5/clock-mx51.c
+++ b/arch/arm/mach-mx5/clock-mx51.c
@@ -2667,6 +2667,14 @@ static struct clk tmax1_clk = {
 	 .disable = _clk_ccgr_disable,
 	 };
 
+/* This is a dummy clock structure for sjtag (secure jtag). We can't enable or
+ * disable gate clock for this device, we only want to enable its parent clock
+ * when use sjtag to debug.
+ */
+static struct clk sjtag_clk = {
+	 .id = 0,
+	 .parent = &tmax1_clk,
+	 };
 
 static struct clk sahara_clk[] = {
 	{
@@ -3109,6 +3117,9 @@ int __init mx51_clocks_init(unsigned long ckil, unsigned long osc,
 	clk_set_rate(&emi_enfc_clk, clk_round_rate(&emi_enfc_clk,
 			(clk_get_rate(&emi_slow_clk))/4));
 
+	if (unlikely(mxc_jtag_enabled))
+		clk_enable(&sjtag_clk);
+
 	/* System timer */
 	mxc_timer_init(&gpt_clk, MX51_IO_ADDRESS(MX51_GPT1_BASE_ADDR),
 		MX51_MXC_INT_GPT);
-- 
1.7.0.4

