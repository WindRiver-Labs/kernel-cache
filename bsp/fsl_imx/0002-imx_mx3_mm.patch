From 9954245da7a0fa37a7d0a684963d0ea8156f593b Mon Sep 17 00:00:00 2001
From: TonyLiu <Bo.Liu@windriver.com>
Date: Fri, 17 Oct 2008 15:11:19 +0800
Subject: [PATCH] imx_mx3_mm

MX3 arch mm configuration.

Signed-off-by: Tonyliu <Bo.Liu@windriver.com>
---
 arch/arm/mm/Kconfig   |    3 ++-
 arch/arm/mm/proc-v6.S |   15 +++++++++++++++
 2 files changed, 17 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mm/Kconfig b/arch/arm/mm/Kconfig
index 546d7e7..99d0a97 100644
--- a/arch/arm/mm/Kconfig
+++ b/arch/arm/mm/Kconfig
@@ -412,6 +412,7 @@ config CPU_V6
 	select CPU_HAS_ASID if MMU
 	select CPU_COPY_V6 if MMU
 	select CPU_TLB_V6 if MMU
+	select CACHE_L2X0 if ARCH_MX3
 
 # ARMv6k
 config CPU_32v6K
@@ -737,7 +738,7 @@ config CACHE_FEROCEON_L2
 
 config CACHE_L2X0
 	bool "Enable the L2x0 outer cache controller"
-	depends on REALVIEW_EB_ARM11MP || MACH_REALVIEW_PB11MP || MACH_REALVIEW_PB1176
+	depends on REALVIEW_EB_ARM11MP || MACH_REALVIEW_PB11MP || MACH_REALVIEW_PB1176 || ARCH_MX3
 	default y
 	select OUTER_CACHE
 	help
diff --git a/arch/arm/mm/proc-v6.S b/arch/arm/mm/proc-v6.S
index 5702ec5..dea549a 100644
--- a/arch/arm/mm/proc-v6.S
+++ b/arch/arm/mm/proc-v6.S
@@ -71,7 +71,22 @@ ENTRY(cpu_v6_reset)
  *	IRQs are already disabled.
  */
 ENTRY(cpu_v6_do_idle)
+#ifdef CONFIG_MX3_DOZE_DURING_IDLE
+   ldr r1, =(AIPS2_IO_ADDRESS(CCM_BASE_ADDR))
+   ldr r2, [r1]                     @ get CCMR
+   bic r2, r2, #(0x3 << 14)         @ LPM mask
+   orr r2, r2, #(1 << 14)           @ Doze mode
+   str r2, [r1]
+
+   mcr p15, 0, r1, c7, c0, 4        @ wait for interrupt
+   nop
+   nop
+   nop
+   nop
+   nop
+#else
 	mcr	p15, 0, r1, c7, c0, 4		@ wait for interrupt
+#endif
 	mov	pc, lr
 
 ENTRY(cpu_v6_dcache_clean_area)
-- 
1.6.0.3

