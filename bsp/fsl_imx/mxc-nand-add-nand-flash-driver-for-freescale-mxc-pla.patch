From 5aec487c6cb25179b8485dc0dba32df1fd483122 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Thu, 27 May 2010 18:43:47 +0800
Subject: [PATCH 6/7] mxc/nand: add nand flash driver for freescale mxc platform

Add nand flash driver for freescale mxc platform.

[Original code taken from L2.6.31_09.12.01_SDK.tar.gz BSP package:
http://www.freescale.com/webapp/sps/site/prod_summary.jsp?code=\
IMX35PDK&fpsp=1&tab=Design_Tools_Tab]

Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 drivers/mtd/nand/mxc_nand.c |   18 +++++++++---------
 1 files changed, 9 insertions(+), 9 deletions(-)

diff --git a/drivers/mtd/nand/mxc_nand.c b/drivers/mtd/nand/mxc_nand.c
index b2900d8..837c0c1 100644
--- a/drivers/mtd/nand/mxc_nand.c
+++ b/drivers/mtd/nand/mxc_nand.c
@@ -34,6 +34,7 @@
 #include <asm/mach/flash.h>
 #include <mach/mxc_nand.h>
 #include <mach/hardware.h>
+#include <mach/clock.h>
 
 #define DRIVER_NAME "mxc_nand"
 
@@ -677,6 +678,7 @@ static int __init mxcnd_probe(struct platform_device *pdev)
 	struct nand_chip *this;
 	struct mtd_info *mtd;
 	struct mxc_nand_platform_data *pdata = pdev->dev.platform_data;
+	struct flash_platform_data *flash_data = pdata->flash_data;
 	struct mxc_nand_host *host;
 	struct resource *res;
 	uint16_t tmp;
@@ -713,7 +715,7 @@ static int __init mxcnd_probe(struct platform_device *pdev)
 	this->read_buf = mxc_nand_read_buf;
 	this->verify_buf = mxc_nand_verify_buf;
 
-	host->clk = clk_get(&pdev->dev, "nfc");
+	host->clk = clk_get(&pdev->dev, "nfc_clk");
 	if (IS_ERR(host->clk)) {
 		err = PTR_ERR(host->clk);
 		goto eclk;
@@ -810,13 +812,6 @@ static int __init mxcnd_probe(struct platform_device *pdev)
 	if (pdata->width == 2)
 		this->options |= NAND_BUSWIDTH_16;
 
-	if (pdata->flash_bbt) {
-		this->bbt_td = &bbt_main_descr;
-		this->bbt_md = &bbt_mirror_descr;
-		/* update flash based bbt */
-		this->options |= NAND_USE_FLASH_BBT;
-	}
-
 	/* first scan to find the device and get the page size */
 	if (nand_scan_ident(mtd, 1)) {
 		err = -ENXIO;
@@ -838,6 +833,10 @@ static int __init mxcnd_probe(struct platform_device *pdev)
 	    parse_mtd_partitions(mtd, part_probes, &host->parts, 0);
 	if (nr_parts > 0)
 		add_mtd_partitions(mtd, host->parts, nr_parts);
+	else if (flash_data->nr_parts) {
+		add_mtd_partitions(mtd, flash_data->parts,
+					flash_data->nr_parts);
+	}
 	else
 #endif
 	{
@@ -889,7 +888,8 @@ static int mxcnd_suspend(struct platform_device *pdev, pm_message_t state)
 	if (mtd) {
 		ret = mtd->suspend(mtd);
 		/* Disable the NFC clock */
-		clk_disable(host->clk);
+		if (clk_get_usecount(host->clk) > 0)
+			clk_disable(host->clk);
 	}
 
 	return ret;
-- 
1.6.5.2

