From 86c9f73c9247f7e4433885a3ef3671e3e1d67d82 Mon Sep 17 00:00:00 2001
From: Zhong Hongbo <hongbo.zhong@windriver.com>
Date: Sat, 14 May 2011 12:36:34 +0800
Subject: [PATCH 05/11] net/fec: improve pm for better suspend/resume

commit: bcc67771ed8ee31cc1f2b1e033ae822b40c72ff9

The following commit made a fix to use fec_enet_open/fec_enet_close
over fec_enet_init/fec_stop for suspend/resume, because fec_enet_init
does not allow to have a working network interface at resume.

  e3fe8558c7fc182972c3d947d88744482111f304
  net/fec: fix pm to survive to suspend/resume

This fix works for i.mx/mxc fec controller, but fails on mx28 fec
which gets a different interrupt logic design. On i.mx fec, interrupt
can be triggered even bit ETHER_EN of ECR register is not set. But
on mx28 fec, ETHER_EN must be set to get interrupt work. Meanwhile,
MII interrupt is mandatory to resume the driver, because MDIO
read/write changed to interrupt mode by commit below.

  97b72e4320a9aaa4a7f1592ee7d2da7e2c9bd349
  fec: use interrupt for MDIO completion indication

fec_restart/fec_stop comes out as the solution working for both
cases.

Signed-off-by: Shawn Guo <shawn.guo@freescale.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Integrated-by: Zhong Hongbo <hongbo.zhong@windriver.com>
---
 drivers/net/fec.c |    8 ++++++--
 1 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/net/fec.c b/drivers/net/fec.c
index ebbb93e..31221a9 100644
--- a/drivers/net/fec.c
+++ b/drivers/net/fec.c
@@ -2000,9 +2000,10 @@ fec_suspend(struct platform_device *dev, pm_message_t state)
 	if (ndev) {
 		fep = netdev_priv(ndev);
 		if (netif_running(ndev)) {
-			netif_device_detach(ndev);
 			fec_stop(ndev);
+			netif_device_detach(ndev);
 		}
+		clk_disable(fep->clk);
 	}
 	return 0;
 }
@@ -2011,10 +2012,13 @@ static int
 fec_resume(struct platform_device *dev)
 {
 	struct net_device *ndev = platform_get_drvdata(dev);
+	struct fec_enet_private *fep;
 
 	if (ndev) {
+		fep = netdev_priv(ndev);
+		clk_enable(fep->clk);
 		if (netif_running(ndev)) {
-			fec_enet_init(ndev, 0);
+			fec_restart(ndev, fep->full_duplex);
 			netif_device_attach(ndev);
 		}
 	}
-- 
1.7.0.4

