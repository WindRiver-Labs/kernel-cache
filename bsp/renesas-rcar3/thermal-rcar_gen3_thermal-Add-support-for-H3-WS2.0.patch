From 21195d528b365df82f235c5dd4e9fd11947f4099 Mon Sep 17 00:00:00 2001
From: Hien Dang <hien.dang.eb@rvc.renesas.com>
Date: Wed, 16 Nov 2016 19:31:26 +0700
Subject: [PATCH 1310/2066] thermal: rcar_gen3_thermal: Add support for H3
 WS2.0

Signed-off-by: Hien Dang <hien.dang.eb@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/thermal/rcar_gen3_thermal.c |   58 ++++++++++++++++++----------------
 1 files changed, 31 insertions(+), 27 deletions(-)

diff --git a/drivers/thermal/rcar_gen3_thermal.c b/drivers/thermal/rcar_gen3_thermal.c
index def4d36..94df06f 100644
--- a/drivers/thermal/rcar_gen3_thermal.c
+++ b/drivers/thermal/rcar_gen3_thermal.c
@@ -331,33 +331,6 @@ static int rcar_gen3_thermal_get_temp(void *devdata, int *temp)
 	return 0;
 }
 
-static int rcar_gen3_r8a7795_thermal_init(struct rcar_thermal_priv *priv)
-{
-	unsigned long flags;
-
-	spin_lock_irqsave(&priv->lock, flags);
-
-	rcar_thermal_write(priv, REG_GEN3_CTSR,  THBGR);
-	rcar_thermal_write(priv, REG_GEN3_CTSR,  0x0);
-
-	udelay(1000);
-
-	rcar_thermal_write(priv, REG_GEN3_CTSR, PONM1);
-	rcar_thermal_write(priv, REG_GEN3_IRQCTL, 0x3F);
-	rcar_thermal_write(priv, REG_GEN3_IRQEN,
-			   IRQ_TEMP1_BIT | IRQ_TEMPD2_BIT);
-	rcar_thermal_write(priv, REG_GEN3_CTSR,
-			PONM1 | AOUT | THBGR | VMEN);
-	udelay(100);
-
-	rcar_thermal_write(priv, REG_GEN3_CTSR,
-			PONM1 | AOUT | THBGR | VMEN | VMST | THSST);
-
-	spin_unlock_irqrestore(&priv->lock, flags);
-
-	return 0;
-}
-
 static int rcar_gen3_r8a7796_thermal_init(struct rcar_thermal_priv *priv)
 {
 	unsigned long flags;
@@ -380,6 +353,37 @@ static int rcar_gen3_r8a7796_thermal_init(struct rcar_thermal_priv *priv)
 	return 0;
 }
 
+static int rcar_gen3_r8a7795_thermal_init(struct rcar_thermal_priv *priv)
+{
+	unsigned long flags;
+
+	if (soc_device_match(r8a7795es1)) {
+		spin_lock_irqsave(&priv->lock, flags);
+
+		rcar_thermal_write(priv, REG_GEN3_CTSR,  THBGR);
+		rcar_thermal_write(priv, REG_GEN3_CTSR,  0x0);
+
+		udelay(1000);
+
+		rcar_thermal_write(priv, REG_GEN3_CTSR, PONM1);
+		rcar_thermal_write(priv, REG_GEN3_IRQCTL, 0x3F);
+		rcar_thermal_write(priv, REG_GEN3_IRQEN,
+				   IRQ_TEMP1_BIT | IRQ_TEMPD2_BIT);
+		rcar_thermal_write(priv, REG_GEN3_CTSR,
+				PONM1 | AOUT | THBGR | VMEN);
+		udelay(100);
+
+		rcar_thermal_write(priv, REG_GEN3_CTSR,
+				PONM1 | AOUT | THBGR | VMEN | VMST | THSST);
+
+		spin_unlock_irqrestore(&priv->lock, flags);
+	} else
+		/* H3 WS2.0 has the same init flow with M3 WS1.0 */
+		rcar_gen3_r8a7796_thermal_init(priv);
+
+	return 0;
+}
+
 /*
  *		Interrupt
  */
-- 
1.7.5.4

