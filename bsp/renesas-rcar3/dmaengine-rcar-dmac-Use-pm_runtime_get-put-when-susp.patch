From 32eb0b1c50428f70b3c0a080e8127b2a9aafa4da Mon Sep 17 00:00:00 2001
From: Hien Dang <hien.dang.eb@renesas.com>
Date: Wed, 24 Aug 2016 15:55:16 +0700
Subject: [PATCH 1673/2066] dmaengine: rcar-dmac: Use pm_runtime_get/put when
 suspend

Due to the commit '39dd0f234fc37d ("PM / Domains: Allow runtime PM during
system PM phases")', runtime PM status might be suspended when back up
module registers. Therefore, it is necessary to ensure device is
on during suspend by using pm_runtime_get/put.

Signed-off-by: Hien Dang <hien.dang.eb@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/dma/sh/rcar-dmac.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/dma/sh/rcar-dmac.c b/drivers/dma/sh/rcar-dmac.c
index 8b629bc..5c9a30e 100644
--- a/drivers/dma/sh/rcar-dmac.c
+++ b/drivers/dma/sh/rcar-dmac.c
@@ -1589,7 +1589,9 @@ static int rcar_dmac_sleep_suspend(struct device *dev)
 			break;
 
 		spin_lock(&dmac->channels[i].lock);
+		pm_runtime_get_sync(dev);
 		rcar_dmac_chan_halt(&dmac->channels[i]);
+		pm_runtime_put(dev);
 		spin_unlock(&dmac->channels[i].lock);
 	}
 
-- 
1.7.5.4

