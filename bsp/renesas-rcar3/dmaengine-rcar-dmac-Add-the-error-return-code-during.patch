From 12b5f36aa72c5e2aa8595fa44a58085b532fb738 Mon Sep 17 00:00:00 2001
From: Gaku Inami <gaku.inami.xw@bp.renesas.com>
Date: Mon, 19 Dec 2016 12:00:03 +0900
Subject: [PATCH 1717/2066] dmaengine: rcar-dmac: Add the error return code
 during suspend

In suspend processing, the dma device should not be stopped under
dma transferring. This Add the error return as "-EBUSY" in suspend
function if if DMACHCR.TE and DMACHCR.DE are not set to "0".

Signed-off-by: Gaku Inami <gaku.inami.xw@bp.renesas.com>
Signed-off-by: Hiroyuki Yokoyama <hiroyuki.yokoyama.vx@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/dma/sh/rcar-dmac.c |    7 +++++++
 1 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/drivers/dma/sh/rcar-dmac.c b/drivers/dma/sh/rcar-dmac.c
index f621438..84511f7 100644
--- a/drivers/dma/sh/rcar-dmac.c
+++ b/drivers/dma/sh/rcar-dmac.c
@@ -1590,6 +1590,13 @@ static int rcar_dmac_sleep_suspend(struct device *dev)
 
 		spin_lock(&dmac->channels[i].lock);
 		pm_runtime_get_sync(dev);
+
+		if (rcar_dmac_chan_is_busy(&dmac->channels[i])) {
+			pm_runtime_put(dev);
+			spin_unlock(&dmac->channels[i].lock);
+			return -EBUSY;
+		}
+
 		rcar_dmac_chan_halt(&dmac->channels[i]);
 		pm_runtime_put(dev);
 		spin_unlock(&dmac->channels[i].lock);
-- 
1.7.5.4

