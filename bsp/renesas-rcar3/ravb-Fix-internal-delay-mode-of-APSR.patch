From 7a8e82d30391516b8a75fc2c55d374c06c232f89 Mon Sep 17 00:00:00 2001
From: Kazuya Mizuguchi <kazuya.mizuguchi.ks@renesas.com>
Date: Mon, 14 Nov 2016 12:35:39 +0900
Subject: [PATCH 1422/2066] ravb: Fix internal delay mode of APSR

This patch supports RGMII_TXID, RGMII_RXID and RGMII_ID.
The clock internal delay mode setting of EthernetAVB is changed as follows.

phy-mode    : before      : after
----------------------------------
"rgmii-id"  : tx delay    : tx and rx delay
"rgmii-rxid": not support : rx delay
"rgmii-txid": not support : tx delay

Signed-off-by: Kazuya Mizuguchi <kazuya.mizuguchi.ks@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/net/ethernet/renesas/ravb_main.c |   29 +++++++++++++++++++++++++----
 1 files changed, 25 insertions(+), 4 deletions(-)

diff --git a/drivers/net/ethernet/renesas/ravb_main.c b/drivers/net/ethernet/renesas/ravb_main.c
index 6516335..f27f3ac 100644
--- a/drivers/net/ethernet/renesas/ravb_main.c
+++ b/drivers/net/ethernet/renesas/ravb_main.c
@@ -1954,6 +1954,29 @@ static void ravb_set_config_mode(struct net_device *ndev)
 	}
 }
 
+static void ravb_set_delay_mode(struct net_device *ndev)
+{
+	struct ravb_private *priv = netdev_priv(ndev);
+
+	if (priv->chip_id != RCAR_GEN2) {
+		switch (priv->phy_interface) {
+		case PHY_INTERFACE_MODE_RGMII_ID:
+			ravb_modify(ndev, APSR, APSR_DM, APSR_DM_RDM |
+				   APSR_DM_TDM);
+			break;
+		case PHY_INTERFACE_MODE_RGMII_RXID:
+			ravb_modify(ndev, APSR, APSR_DM, APSR_DM_RDM);
+			break;
+		case PHY_INTERFACE_MODE_RGMII_TXID:
+			ravb_modify(ndev, APSR, APSR_DM, APSR_DM_TDM);
+			break;
+		default:
+			ravb_modify(ndev, APSR, APSR_DM, 0);
+			break;
+		}
+	}
+}
+
 static int ravb_probe(struct platform_device *pdev)
 {
 	struct device_node *np = pdev->dev.of_node;
@@ -2072,8 +2095,7 @@ static int ravb_probe(struct platform_device *pdev)
 	ravb_modify(ndev, GCCR, GCCR_LTI, GCCR_LTI);
 
 	/* Set APSR */
-	if (priv->phy_interface == PHY_INTERFACE_MODE_RGMII_ID)
-		ravb_modify(ndev, APSR, APSR_DM, APSR_DM_TDM);
+	ravb_set_delay_mode(ndev);
 
 	/* Allocate descriptor base address table */
 	priv->desc_bat_size = sizeof(struct ravb_desc) * DBAT_ENTRY_NUM;
@@ -2217,8 +2239,7 @@ static int __maybe_unused ravb_resume(struct device *dev)
 	ravb_modify(ndev, GCCR, GCCR_LTI, GCCR_LTI);
 
 	/* Set APSR */
-	if (priv->phy_interface == PHY_INTERFACE_MODE_RGMII_ID)
-		ravb_modify(ndev, APSR, APSR_DM, APSR_DM_TDM);
+	ravb_set_delay_mode(ndev);
 
 	/* Restore descriptor base address table */
 	ravb_write(ndev, priv->desc_bat_dma, DBAT);
-- 
1.7.5.4

