From 6ff1c8f581a6b1d567f34e563acb40b90f30042a Mon Sep 17 00:00:00 2001
From: Hien Dang <hien.dang.eb@renesas.com>
Date: Tue, 23 Aug 2016 10:35:12 +0700
Subject: [PATCH 1675/2066] i2c: sh_mobile: Use pm_runtime_get/put when resume

Due to the commit '39dd0f234fc37d ("PM / Domains: Allow runtime PM during
system PM phases")', runtime PM status might be suspended during system
suspend phase. Therefore, at system suspend phase, pm_runtime_get()/put()
are necessary invoked when accessing the hardware.

This modification,in system resume phase, is for symmetric with
above situation. Moreover, it enhances stability of system in case that
upstream kernel may update to enable device can change runtime suspend
state during system resume phase.

Signed-off-by: Hien Dang <hien.dang.eb@renesas.com>
---
 drivers/i2c/busses/i2c-sh_mobile.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/i2c/busses/i2c-sh_mobile.c b/drivers/i2c/busses/i2c-sh_mobile.c
index 4339d45..819dc57 100644
--- a/drivers/i2c/busses/i2c-sh_mobile.c
+++ b/drivers/i2c/busses/i2c-sh_mobile.c
@@ -1053,7 +1053,9 @@ static int sh_mobile_i2c_resume(struct device *dev)
 {
 	int ret = 0;
 #ifdef CONFIG_RCAR_DDR_BACKUP
+	pm_runtime_get_sync(dev);
 	ret = rcar_handle_registers(&i2c_dvfs_ip, DO_RESTORE);
+	pm_runtime_put(dev);
 #endif /* CONFIG_RCAR_DDR_BACKUP  */
 	return ret;
 }
-- 
1.7.5.4

