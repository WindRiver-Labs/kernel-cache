From 2ed93b432214e396ef698c7cfc76fa2b75612122 Mon Sep 17 00:00:00 2001
From: Dien Pham <dien.pham.ry@renesas.com>
Date: Thu, 15 Dec 2016 18:39:33 +0700
Subject: [PATCH 1255/2066] clk: renesas: rcar-gen3: Add PLL0, PLL2, PLL4
 clock errata workaround

This patch is workaround of the errata on which the PLL0, PLL2, PLL4
clock is not an expected value.

Signed-off-by: Dien Pham <dien.pham.ry@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/clk/renesas/rcar-gen3-cpg.c |   12 ++++++++++++
 1 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/drivers/clk/renesas/rcar-gen3-cpg.c b/drivers/clk/renesas/rcar-gen3-cpg.c
index 9f2ef58..d94d787 100644
--- a/drivers/clk/renesas/rcar-gen3-cpg.c
+++ b/drivers/clk/renesas/rcar-gen3-cpg.c
@@ -532,6 +532,10 @@ struct clk * __init rcar_gen3_cpg_clk_register(struct device *dev,
 		 */
 		value = readl(base + CPG_PLL0CR);
 		mult = (((value >> 24) & 0x7f) + 1) * 2;
+		/* Start clock issue W/A (for H3 WS1.0) */
+		if (soc_device_match(r8a7795es10))
+			mult *= 2; /* PLL0 output multiplied by 2 */
+		/* End clock issue W/A */
 		break;
 
 	case CLK_TYPE_GEN3_PLL1:
@@ -547,6 +551,10 @@ struct clk * __init rcar_gen3_cpg_clk_register(struct device *dev,
 		 */
 		value = readl(base + CPG_PLL2CR);
 		mult = (((value >> 24) & 0x7f) + 1) * 2;
+		/* Start clock issue W/A (for H3 WS1.0) */
+		if (soc_device_match(r8a7795es10))
+			mult *= 2; /* PLL0 output multiplied by 2 */
+		/* End clock issue W/A */
 		break;
 
 	case CLK_TYPE_GEN3_PLL3:
@@ -562,6 +570,10 @@ struct clk * __init rcar_gen3_cpg_clk_register(struct device *dev,
 		 */
 		value = readl(base + CPG_PLL4CR);
 		mult = (((value >> 24) & 0x7f) + 1) * 2;
+		/* Start clock issue W/A (for H3 WS1.0) */
+		if (soc_device_match(r8a7795es10))
+			mult *= 2; /* PLL0 output multiplied by 2 */
+		/* End clock issue W/A */
 		break;
 
 	case CLK_TYPE_GEN3_SD:
-- 
1.7.5.4

