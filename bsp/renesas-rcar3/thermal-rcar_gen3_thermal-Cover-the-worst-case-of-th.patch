From 7256369c6dddf4e5815b029e90aeb2e691c0a9e4 Mon Sep 17 00:00:00 2001
From: Hien Dang <hien.dang.eb@rvc.renesas.com>
Date: Thu, 17 Dec 2015 08:54:53 +0700
Subject: [PATCH 1270/2066] thermal: rcar_gen3_thermal: Cover the worst case
 of thermal irq

In the worst case, it takes several attempts to update next
interrupt condition. This patch extends waiting time to cover
such case in few boards.

Signed-off-by: Hien Dang <hien.dang.eb@rvc.renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/thermal/rcar_gen3_thermal.c |   11 ++++++++---
 1 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/drivers/thermal/rcar_gen3_thermal.c b/drivers/thermal/rcar_gen3_thermal.c
index c91add8..3832840 100644
--- a/drivers/thermal/rcar_gen3_thermal.c
+++ b/drivers/thermal/rcar_gen3_thermal.c
@@ -110,11 +110,16 @@ static int rcar_gen3_thermal_update_temp(struct rcar_thermal_priv *priv)
 
 	spin_lock_irqsave(&priv->lock, flags);
 
-	for (i = 0; i < 8; i++) {
-		udelay(300);
+	for (i = 0; i < 256; i++) {
 		ctemp = rcar_thermal_read(priv, REG_GEN3_TEMP) & CTEMP_MASK;
-		if (rcar_has_irq_support(priv))
+		if (rcar_has_irq_support(priv)) {
 			rcar_thermal_write(priv, reg, ctemp);
+			if (rcar_thermal_read(priv, REG_GEN3_IRQSTR) != 0)
+				break;
+		} else
+			break;
+
+		udelay(300);
 	}
 
 	priv->ctemp = round_temp(TEMP_CONVERT(ctemp));
-- 
1.7.5.4

