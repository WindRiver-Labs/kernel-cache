From ae609168f9bc26dc9d217b328e14391674da57b9 Mon Sep 17 00:00:00 2001
From: Hien Dang <hien.dang.eb@rvc.renesas.com>
Date: Wed, 24 Feb 2016 10:13:14 +0700
Subject: [PATCH 1287/2066] thermal: rcar_gen3_thermal: Adjust multiplication
 value to get decimal part

When quadratic expression is used to convert temp,
if coefficient a is zero then temp conversion will be incorrect.
This patch will increase multiplication value to get five digits
of decimal part for coefficient a to be meaningful.

Signed-off-by: Hien Dang <hien.dang.eb@rvc.renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/thermal/rcar_gen3_thermal.c |   10 +++++-----
 1 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/drivers/thermal/rcar_gen3_thermal.c b/drivers/thermal/rcar_gen3_thermal.c
index 3fcf696..ef97a41 100644
--- a/drivers/thermal/rcar_gen3_thermal.c
+++ b/drivers/thermal/rcar_gen3_thermal.c
@@ -253,9 +253,9 @@ static void _quadratic_coef_calc(struct rcar_thermal_priv *priv)
 	para_c3 = (TJ_L * b) / 1000;
 	c = para_c1 - para_c2 - para_c3;
 
-	priv->coef.a = DIV_ROUND_CLOSEST(a, 10);
-	priv->coef.b = DIV_ROUND_CLOSEST(b, 10);
-	priv->coef.c = DIV_ROUND_CLOSEST(c, 10);
+	priv->coef.a = a;
+	priv->coef.b = b;
+	priv->coef.c = c;
 }
 #else
 static void _linear_coef_calc(struct rcar_thermal_priv *priv)
@@ -306,8 +306,8 @@ int _quadratic_temp_converter(struct equation_coefs coef, int temp_code)
 	int temp, temp1, temp2;
 	long delta;
 
-	/* Multiply with 10000 to sync with coef a, coef b and coef c. */
-	delta = coef.b * coef.b - 4 * coef.a * (coef.c - 10000 * temp_code);
+	/* Multiply with 100000 to sync with coef a, coef b and coef c. */
+	delta = coef.b * coef.b - 4 * coef.a * (coef.c - 100000 * temp_code);
 
 	/* Multiply temp with 1000 to convert to Mili-Celsius */
 	temp1 = (CODETSD(-coef.b) + int_sqrt(1000000 * delta)) / 2;
-- 
1.7.5.4

