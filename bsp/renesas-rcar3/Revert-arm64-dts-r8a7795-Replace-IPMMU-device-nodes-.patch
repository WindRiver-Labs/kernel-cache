From fede7472acd7d538ed57c95e9e3a474259499e30 Mon Sep 17 00:00:00 2001
From: Takeshi Kihara <takeshi.kihara.df@renesas.com>
Date: Mon, 13 Feb 2017 16:55:36 +0900
Subject: [PATCH 1729/2066] Revert "arm64: dts: r8a7795: Replace IPMMU device
 nodes for Renesas R8A7795 ES2.0 SoC"

This reverts commit 77bfb4ddd0a0 ("arm64: dts: r8a7795: Replace IPMMU
device nodes for Renesas R8A7795 ES2.0 SoC").

In R8A7795 ES2.0, FCP-CS is hardwired to not only IPMMU-VC1 but also
IPMMU-VC0.

    FCP-CS --+--- IPMMU-VC0
             |
             +--- IPMMU-VC1

So the compatible string ipmmu-"pmb"-r8a7795 in ipmmu_vc0 is necessary
for PMB address translation in MMNGR.

NOTE: IPMMU-VC0 and IPMMU-VC1 share the same power domain (i.e. A3VC),
and A3VC would be turned on by IPMMU-VC1.
We still keep the string in ipmmu_vc0 explicitly, for sure.

Reported-by: Khiem Nguyen <khiem.nguyen.xt@renesas.com>
Reviewed-by: Tomoharu Fukawa <tomoharu.fukawa.eb@renesas.com>
Signed-off-by: Takeshi Kihara <takeshi.kihara.df@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 arch/arm64/boot/dts/renesas/r8a7795.dtsi |  109 ++++++++++++------------------
 1 files changed, 42 insertions(+), 67 deletions(-)

diff --git a/arch/arm64/boot/dts/renesas/r8a7795.dtsi b/arch/arm64/boot/dts/renesas/r8a7795.dtsi
index 3173ae2..eb03777 100644
--- a/arch/arm64/boot/dts/renesas/r8a7795.dtsi
+++ b/arch/arm64/boot/dts/renesas/r8a7795.dtsi
@@ -746,14 +746,14 @@
 			power-domains = <&sysc R8A7795_PD_ALWAYS_ON>;
 			#dma-cells = <1>;
 			dma-channels = <16>;
-			iommus = <&ipmmu_mp0 0>, <&ipmmu_mp0 1>,
-			       <&ipmmu_mp0 2>, <&ipmmu_mp0 3>,
-			       <&ipmmu_mp0 4>, <&ipmmu_mp0 5>,
-			       <&ipmmu_mp0 6>, <&ipmmu_mp0 7>,
-			       <&ipmmu_mp0 8>, <&ipmmu_mp0 9>,
-			       <&ipmmu_mp0 10>, <&ipmmu_mp0 11>,
-			       <&ipmmu_mp0 12>, <&ipmmu_mp0 13>,
-			       <&ipmmu_mp0 14>, <&ipmmu_mp0 15>;
+			iommus = <&ipmmu_mp1 0>, <&ipmmu_mp1 1>,
+			       <&ipmmu_mp1 2>, <&ipmmu_mp1 3>,
+			       <&ipmmu_mp1 4>, <&ipmmu_mp1 5>,
+			       <&ipmmu_mp1 6>, <&ipmmu_mp1 7>,
+			       <&ipmmu_mp1 8>, <&ipmmu_mp1 9>,
+			       <&ipmmu_mp1 10>, <&ipmmu_mp1 11>,
+			       <&ipmmu_mp1 12>, <&ipmmu_mp1 13>,
+			       <&ipmmu_mp1 14>, <&ipmmu_mp1 15>;
 		};
 
 		audma1: dma-controller@ec720000 {
@@ -787,14 +787,14 @@
 			power-domains = <&sysc R8A7795_PD_ALWAYS_ON>;
 			#dma-cells = <1>;
 			dma-channels = <16>;
-			iommus = <&ipmmu_mp0 16>, <&ipmmu_mp0 17>,
-			       <&ipmmu_mp0 18>, <&ipmmu_mp0 19>,
-			       <&ipmmu_mp0 20>, <&ipmmu_mp0 21>,
-			       <&ipmmu_mp0 22>, <&ipmmu_mp0 23>,
-			       <&ipmmu_mp0 24>, <&ipmmu_mp0 25>,
-			       <&ipmmu_mp0 26>, <&ipmmu_mp0 27>,
-			       <&ipmmu_mp0 28>, <&ipmmu_mp0 29>,
-			       <&ipmmu_mp0 30>, <&ipmmu_mp0 31>;
+			iommus = <&ipmmu_mp1 16>, <&ipmmu_mp1 17>,
+			       <&ipmmu_mp1 18>, <&ipmmu_mp1 19>,
+			       <&ipmmu_mp1 20>, <&ipmmu_mp1 21>,
+			       <&ipmmu_mp1 22>, <&ipmmu_mp1 23>,
+			       <&ipmmu_mp1 24>, <&ipmmu_mp1 25>,
+			       <&ipmmu_mp1 26>, <&ipmmu_mp1 27>,
+			       <&ipmmu_mp1 28>, <&ipmmu_mp1 29>,
+			       <&ipmmu_mp1 30>, <&ipmmu_mp1 31>;
 		};
 
 		mfis: mfis@e6260000 {
@@ -837,44 +837,27 @@
 			power-domains = <&sysc R8A7795_PD_ALWAYS_ON>;
 		};
 
-		ipmmu_vi0: mmu@febd0000 {
+		ipmmu_vi: mmu@febd0000 {
 			compatible = "renesas,ipmmu-r8a7795";
-			reg = <0 0xfebd0000 0 0x1000>; /* IPMMU-VI0 */
-			renesas,ipmmu-main = <&ipmmu_mm 14>;
+			reg = <0 0xfebd0000 0 0x1000>; /* IPMMU-VI */
+			renesas,ipmmu-main = <&ipmmu_mm 11>;
 			#iommu-cells = <1>;
 			status = "disabled";
 		};
 
-		ipmmu_vi1: mmu@febe0000 {
-			compatible = "renesas,ipmmu-r8a7795";
-			reg = <0 0xfebe0000 0 0x1000>; /* IPMMU-VI1 */
-			renesas,ipmmu-main = <&ipmmu_mm 15>;
-			#iommu-cells = <1>;
-			status = "disabled";
-		};
-
-		ipmmu_vp0: mmu@fe990000 {
-			compatible = "renesas,ipmmu-pmb-r8a7795";
-			reg = <0 0xfe990000 0 0x1000>; /* IPMMU-VP0 */
-			renesas,ipmmu-main = <&ipmmu_mm 16>;
-			#iommu-cells = <1>;
-			power-domains = <&sysc R8A7795_PD_A3VP>;
-			status = "disabled";
-		};
-
-		ipmmu_vp1: mmu@fe980000 {
+		ipmmu_vp: mmu@fe990000 {
 			compatible = "renesas,ipmmu-pmb-r8a7795";
-			reg = <0 0xfe980000 0 0x1000>; /* IPMMU-VP1 */
-			renesas,ipmmu-main = <&ipmmu_mm 17>;
+			reg = <0 0xfe990000 0 0x1000>; /* IPMMU-VP */
+			renesas,ipmmu-main = <&ipmmu_mm 12>;
 			#iommu-cells = <1>;
 			power-domains = <&sysc R8A7795_PD_A3VP>;
 			status = "disabled";
 		};
 
 		ipmmu_vc0: mmu@fe6b0000 {
-			compatible = "renesas,ipmmu-r8a7795";
+			compatible = "renesas,ipmmu-pmb-r8a7795";
 			reg = <0 0xfe6b0000 0 0x1000>; /* IPMMU-VC0 */
-			renesas,ipmmu-main = <&ipmmu_mm 12>;
+			renesas,ipmmu-main = <&ipmmu_mm 9>;
 			#iommu-cells = <1>;
 			power-domains = <&sysc R8A7795_PD_A3VC>;
 			status = "disabled";
@@ -883,7 +866,7 @@
 		ipmmu_vc1: mmu@fe6f0000 {
 			compatible = "renesas,ipmmu-pmb-r8a7795";
 			reg = <0 0xfe6f0000 0 0x1000>; /* IPMMU-VC1 */
-			renesas,ipmmu-main = <&ipmmu_mm 13>;
+			renesas,ipmmu-main = <&ipmmu_mm 10>;
 			#iommu-cells = <1>;
 			power-domains = <&sysc R8A7795_PD_A3VC>;
 			status = "disabled";
@@ -897,30 +880,6 @@
 			status = "disabled";
 		};
 
-		ipmmu_pv1: mmu@fd950000 {
-			compatible = "renesas,ipmmu-r8a7795";
-			reg = <0 0xfd950000 0 0x1000>; /* IPMMU-PV1 */
-			renesas,ipmmu-main = <&ipmmu_mm 7>;
-			#iommu-cells = <1>;
-			status = "disabled";
-		};
-
-		ipmmu_pv2: mmu@fd960000 {
-			compatible = "renesas,ipmmu-r8a7795";
-			reg = <0 0xfd960000 0 0x1000>; /* IPMMU-PV2 */
-			renesas,ipmmu-main = <&ipmmu_mm 8>;
-			#iommu-cells = <1>;
-			status = "disabled";
-		};
-
-		ipmmu_pv3: mmu@fd970000 {
-			compatible = "renesas,ipmmu-r8a7795";
-			reg = <0 0xfd970000 0 0x1000>; /* IPMMU-PV3 */
-			renesas,ipmmu-main = <&ipmmu_mm 9>;
-			#iommu-cells = <1>;
-			status = "disabled";
-		};
-
 		ipmmu_ir: mmu@ff8b0000 {
 			compatible = "renesas,ipmmu-r8a7795";
 			reg = <0 0xff8b0000 0 0x1000>; /* IPMMU-IR */
@@ -940,7 +899,7 @@
 		ipmmu_rt: mmu@ffc80000 {
 			compatible = "renesas,ipmmu-r8a7795";
 			reg = <0 0xffc80000 0 0x1000>; /* IPMMU-RT */
-			renesas,ipmmu-main = <&ipmmu_mm 10>;
+			renesas,ipmmu-main = <&ipmmu_mm 7>;
 			#iommu-cells = <1>;
 			status = "disabled";
 		};
@@ -953,6 +912,22 @@
 			status = "disabled";
 		};
 
+		ipmmu_mp1: mmu@ec680000 {
+			compatible = "renesas,ipmmu-r8a7795";
+			reg = <0 0xec680000 0 0x1000>; /* IPMMU-MP1 */
+			renesas,ipmmu-main = <&ipmmu_mm 5>;
+			#iommu-cells = <1>;
+			status = "disabled";
+		};
+
+		ipmmu_sy: mmu@e7730000 {
+			compatible = "renesas,ipmmu-r8a7795";
+			reg = <0 0xe7730000 0 0x1000>; /* IPMMU-SY */
+			renesas,ipmmu-main = <&ipmmu_mm 8>;
+			#iommu-cells = <1>;
+			status = "disabled";
+		};
+
 		ipmmu_ds0: mmu@e6740000 {
 			compatible = "renesas,ipmmu-r8a7795";
 			reg = <0 0xe6740000 0 0x1000>; /* IPMMU-DS0 */
-- 
1.7.5.4

