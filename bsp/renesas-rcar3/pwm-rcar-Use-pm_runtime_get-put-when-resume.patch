From 8802ebbc338fa4eb5888bb8f4ec2abc989055087 Mon Sep 17 00:00:00 2001
From: Hien Dang <hien.dang.eb@renesas.com>
Date: Tue, 23 Aug 2016 10:37:44 +0700
Subject: [PATCH 1677/2066] pwm: rcar: Use pm_runtime_get/put when resume

Due to the commit '39dd0f234fc37d ("PM / Domains: Allow runtime PM during
system PM phases")', runtime PM status might be suspended during system
suspend phase. Therefore, at system suspend phase, pm_runtime_get()/put()
are necessary invoked when accessing the hardware.

This modification,in system resume phase, is for symmetric with above
situation. Moreover, it enhances stability of system in case that
upstream kernel may update to enable device can change runtime suspend
state during system resume phase.

Signed-off-by: Hien Dang <hien.dang.eb@renesas.com>
---
 drivers/pwm/pwm-rcar.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/pwm/pwm-rcar.c b/drivers/pwm/pwm-rcar.c
index 1922512..fbca00a 100644
--- a/drivers/pwm/pwm-rcar.c
+++ b/drivers/pwm/pwm-rcar.c
@@ -410,9 +410,11 @@ static int rcar_pwm_resume(struct device *dev)
 	struct platform_device *pdev = to_platform_device(dev);
 	struct rcar_ip *ip = rcar_pwm_get_ip(pdev->name);
 
-	if (ip)
+	if (ip) {
+		pm_runtime_get_sync(dev);
 		ret = rcar_handle_registers(ip, DO_RESTORE);
-	else {
+		pm_runtime_put(dev);
+	} else {
 		pr_err("%s: Failed to find PWM device\n", __func__);
 		ret = -ENODEV;
 	}
-- 
1.7.5.4

