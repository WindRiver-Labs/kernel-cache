From 2ba5e0383dbf5096047560b524bc71007f8f619c Mon Sep 17 00:00:00 2001
From: zou cao <cao.zou@windriver.com>
Date: Wed, 12 Jul 2017 09:25:39 +0800
Subject: [PATCH 6/6] drm: rcar-du: do not disable plane on inactive CRTC

Do not disable plane on inactive CRTC, when disabling the CRTC, the vsp
pipe also will be free,  if you disable plane on inactiver CRTC, the free
vsp pipe will cause a  NULL pointer as follow:

	Unable to handle kernel NULL pointer dereference at virtual address 00000088
	pgd = ffff8006f18d2000
	[00000088] *pgd=000000073902f003, *pud=0000000739821003, *pmd=0000000000000000
	Internal error: Oops: 96000006 [#1] PREEMPT SMP
	Modules linked in: sch_fq_codel softdog
	CPU: 3 PID: 543 Comm: Xorg Not tainted 4.1.21-WR8.0.0.0_standard+ #733
	Hardware name: Renesas Salvator-X board based on r8a7795 (DT)
	task: ffff8006ef59a100 ti: ffff8006f11dc000 task.ti: ffff8006f11dc000
	PC is at bru_s_stream+0x7c/0x2e8
	LR is at bru_s_stream+0x78/0x2e8
	pc : [<ffff8000006751a0>] lr : [<ffff80000067519c>] pstate: 600001c5
	sp : ffff8006f11df810
	x29: ffff8006f11df810 x28: ffff8006f11df968
	x27: ffff80000095a2a8 x26: ffff8006f11dfa40
	x25: ffff8006f11dfa30 x24: ffff8006f1cdd418
	x23: ffff8006f1cecc18 x22: ffff8006f1ce3018
	x21: 0000000000000000 x20: 0000000000000005
	x19: ffff8006f1cecc70 x18: fffffffffffffe08
	x17: 0000ffff8640f570 x16: ffff8000001ea0e8
	x15: 0000000000402840 x14: 0000003c00000000
	x13: 0000000000000000 x12: 0000032600000309
	x11: 0000030300000326 x10: 0000030000000300
	x9 : 0000000000000000 x8 : 0000000000000000
	x7 : ffff8006f1cae108 x6 : 00000000000003ff
	x5 : 0000000000000001 x4 : ffff0000002dc000
	x3 : ffff0000002dc000 x2 : ffff8006f11dc000
	x1 : 0000000000000006 x0 : 0000000000000000
	Call trace:
	[<ffff8000006751a0>] bru_s_stream+0x7c/0x2e8
	[<ffff800000670ba8>] vsp1_drm_pipeline_run+0x90/0x110
	[<ffff800000670f18>] vsp1_du_setup_rpf+0x2f0/0x41c
	[<ffff80000055538c>] rcar_du_vsp_plane_atomic_update+0xf0/0x168
	[<ffff800000522e10>] drm_atomic_helper_commit_planes+0xf8/0x238
	[<ffff8000005521d4>] rcar_du_atomic_complete+0x50/0xc0
	[<ffff8000005524f4>] rcar_du_atomic_commit+0x2b0/0x2c0
	[<ffff80000054c630>] drm_atomic_commit+0x4c/0x78
	[<ffff800000524280>] drm_atomic_helper_connector_dpms+0x108/0x1b0
	[<ffff8000005277ec>] drm_fb_helper_dpms.isra.6+0xa8/0xf4
	[<ffff8000005278a0>] drm_fb_helper_blank+0x68/0xd4
	[<ffff80000049a4f4>] fb_blank+0x64/0xc4
	[<ffff80000049aca4>] do_fb_ioctl+0x218/0x5c0
	[<ffff80000049b0a0>] fb_ioctl+0x54/0x68
	[<ffff8000001e9e9c>] do_vfs_ioctl+0x388/0x5d4
	[<ffff8000001ea178>] SyS_ioctl+0x90/0xa4
---
 drivers/gpu/drm/rcar-du/rcar_du_kms.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/gpu/drm/rcar-du/rcar_du_kms.c b/drivers/gpu/drm/rcar-du/rcar_du_kms.c
index fc2f5de..e860244 100644
--- a/drivers/gpu/drm/rcar-du/rcar_du_kms.c
+++ b/drivers/gpu/drm/rcar-du/rcar_du_kms.c
@@ -280,7 +280,7 @@ static void rcar_du_atomic_complete(struct rcar_du_commit *commit)
 	/* Apply the atomic update. */
 	drm_atomic_helper_commit_modeset_disables(dev, old_state);
 	drm_atomic_helper_commit_modeset_enables(dev, old_state);
-	drm_atomic_helper_commit_planes(dev, old_state, false);
+	drm_atomic_helper_commit_planes(dev, old_state, true);
 
 	drm_atomic_helper_wait_for_vblanks(dev, old_state);
 
-- 
1.7.5.4

