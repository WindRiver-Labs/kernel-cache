From 4280160e0cefa0ef5d94728aa4c69c1cc598c3f8 Mon Sep 17 00:00:00 2001
From: Gaku Inami <gaku.inami.xw@bp.renesas.com>
Date: Mon, 19 Dec 2016 13:09:51 +0900
Subject: [PATCH 1718/2066] dmaengine: usb-dmac: Add the error return code
 during suspend

In suspend processing, the dma device should not be stopped under
dma transferring. This Add the error return as "-EBUSY" in suspend
function if DMACHCR.TE and DMACHCR.DE are not set to "0".

Signed-off-by: Gaku Inami <gaku.inami.xw@bp.renesas.com>
Signed-off-by: Hiroyuki Yokoyama <hiroyuki.yokoyama.vx@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/dma/sh/usb-dmac.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/dma/sh/usb-dmac.c b/drivers/dma/sh/usb-dmac.c
index bf70156..c574d15 100644
--- a/drivers/dma/sh/usb-dmac.c
+++ b/drivers/dma/sh/usb-dmac.c
@@ -685,6 +685,10 @@ static int usb_dmac_runtime_suspend(struct device *dev)
 	for (i = 0; i < dmac->n_channels; ++i) {
 		if (!dmac->channels[i].iomem)
 			break;
+
+		if (usb_dmac_chan_is_busy(&dmac->channels[i]))
+			return -EBUSY;
+
 		usb_dmac_chan_halt(&dmac->channels[i]);
 	}
 
-- 
1.7.5.4

