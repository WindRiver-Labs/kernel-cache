From 387bab165a54d7f1433d549f3f139fa07ac42678 Mon Sep 17 00:00:00 2001
From: Hien Dang <hien.dang.eb@rvc.renesas.com>
Date: Wed, 16 Nov 2016 20:40:12 +0700
Subject: [PATCH 1685/2066] PCI: rcar-pcie: Use memory mapping area of driver
 for backup/restore

Signed-off-by: Dien Pham <dien.pham.ry@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/pci/host/pcie-rcar.c |    7 +++++--
 1 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/drivers/pci/host/pcie-rcar.c b/drivers/pci/host/pcie-rcar.c
index eacf99e..5175da6 100644
--- a/drivers/pci/host/pcie-rcar.c
+++ b/drivers/pci/host/pcie-rcar.c
@@ -258,11 +258,14 @@ static struct rcar_ip *rcar_pcie_get_ip(const char *name)
 static int rcar_pcie_save_regs(struct device *dev)
 {
 	struct rcar_ip *ip = rcar_pcie_get_ip(dev_name(dev));
+	struct rcar_pcie *pcie = NULL;
 	int ret;
 
 	if (ip) {
-		if (!ip->virt_addr)
-			rcar_handle_registers(ip, DO_IOREMAP);
+		if (!ip->virt_addr) {
+			pcie = dev_get_drvdata(dev);
+			ip->virt_addr = pcie->base;
+		}
 
 		ret = rcar_handle_registers(ip, DO_BACKUP);
 		if (ret)
-- 
1.7.5.4

