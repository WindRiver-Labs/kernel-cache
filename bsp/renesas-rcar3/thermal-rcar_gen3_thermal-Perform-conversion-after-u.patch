From 65eb622cc3b596ccfa04237f5445beff91aeefa0 Mon Sep 17 00:00:00 2001
From: Hien Dang <hien.dang.eb@rvc.renesas.com>
Date: Thu, 17 Dec 2015 12:49:07 +0700
Subject: [PATCH 1276/2066] thermal: rcar_gen3_thermal: Perform conversion
 after updating temperature code

Update temperature code first then use it for converting
to real temperature instead of reading the code again.
Otherwise, the code stored in data structure is useless.

Signed-off-by: Hien Dang <hien.dang.eb@rvc.renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/thermal/rcar_gen3_thermal.c |   13 ++++++-------
 1 files changed, 6 insertions(+), 7 deletions(-)

diff --git a/drivers/thermal/rcar_gen3_thermal.c b/drivers/thermal/rcar_gen3_thermal.c
index b082430..a559ed6 100644
--- a/drivers/thermal/rcar_gen3_thermal.c
+++ b/drivers/thermal/rcar_gen3_thermal.c
@@ -366,18 +366,17 @@ static int rcar_gen3_thermal_update_temp(struct rcar_thermal_priv *priv)
 static int rcar_gen3_thermal_get_temp(void *devdata, int *temp)
 {
 	struct rcar_thermal_priv *priv = devdata;
-	u32 ctemp;
+	int ctemp;
 	unsigned long flags;
 
+	rcar_gen3_thermal_update_temp(priv);
+
 	spin_lock_irqsave(&priv->lock, flags);
-	/*
-	 * temp = (THCODE - 2536.7) / 7.468
-	 */
-	ctemp = rcar_thermal_read(priv, REG_GEN3_TEMP) & CTEMP_MASK;
-	*temp = thermal_temp_converter(priv->coef, ctemp);
-	priv->ctemp = ctemp;
+	ctemp = thermal_temp_converter(priv->coef, priv->ctemp);
 	spin_unlock_irqrestore(&priv->lock, flags);
 
+	*temp = ctemp;
+
 	return 0;
 }
 
-- 
1.7.5.4

