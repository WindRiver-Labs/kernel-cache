From 06b7558b35a884a50de0e921d967072b79448f2f Mon Sep 17 00:00:00 2001
From: Hien Dang <hien.dang.eb@renesas.com>
Date: Wed, 24 Aug 2016 14:12:01 +0700
Subject: [PATCH 1660/2066] clk: renesas: Use pre-mapped address for backup
 register in suspend

Signed-off-by: Hien Dang <hien.dang.eb@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/clk/renesas/renesas-cpg-mssr.c |   15 ++++++++-------
 1 files changed, 8 insertions(+), 7 deletions(-)

diff --git a/drivers/clk/renesas/renesas-cpg-mssr.c b/drivers/clk/renesas/renesas-cpg-mssr.c
index b8ebea3..9209f30 100644
--- a/drivers/clk/renesas/renesas-cpg-mssr.c
+++ b/drivers/clk/renesas/renesas-cpg-mssr.c
@@ -87,8 +87,6 @@ static struct hw_register cpg_ip_regs[] = {
 
 static struct rcar_ip cpg_ip = {
 	.ip_name   = "CPG",
-	.base_addr = 0xE6150000,
-	.size      = 0xAF8,
 	.reg_count = ARRAY_SIZE(cpg_ip_regs),
 	.ip_reg    = cpg_ip_regs,
 };
@@ -629,6 +627,7 @@ static int __init cpg_mssr_probe(struct platform_device *pdev)
 	priv->num_core_clks = info->num_total_core_clks;
 	priv->num_mod_clks = info->num_hw_mod_clks;
 	priv->last_dt_core_clk = info->last_dt_core_clk;
+	platform_set_drvdata(pdev, priv);
 
 	for (i = 0; i < nclks; i++)
 		clks[i] = ERR_PTR(-ENOENT);
@@ -662,12 +661,14 @@ static int cpg_mssr_suspend(struct device *dev)
 {
 	int ret = 0;
 #ifdef CONFIG_RCAR_DDR_BACKUP
+	struct cpg_mssr_priv *priv;
+
 	pr_debug("%s\n", __func__);
-	if (!cpg_ip.virt_addr) {
-		ret = rcar_handle_registers(&cpg_ip, DO_IOREMAP);
-		if (ret)
-			return ret;
-	}
+
+	priv = dev_get_drvdata(dev);
+
+	if (!cpg_ip.virt_addr)
+		cpg_ip.virt_addr = priv->base;
 
 	ret = rcar_handle_registers(&cpg_ip, DO_BACKUP);
 #endif /* CONFIG_RCAR_DDR_BACKUP */
-- 
1.7.5.4

