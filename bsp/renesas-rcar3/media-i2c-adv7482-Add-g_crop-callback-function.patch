From 471e835bba00c41de897874483d90c786f0ee867 Mon Sep 17 00:00:00 2001
From: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
Date: Tue, 27 Oct 2015 16:23:47 +0900
Subject: [PATCH 1893/2066] media: i2c: adv7482: Add g_crop callback function

Signed-off-by: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/media/i2c/adv7482.c |   42 ++++++++++++++++++++++++++++++++++++++++++
 1 files changed, 42 insertions(+), 0 deletions(-)

diff --git a/drivers/media/i2c/adv7482.c b/drivers/media/i2c/adv7482.c
index b452bd8..8893948 100644
--- a/drivers/media/i2c/adv7482.c
+++ b/drivers/media/i2c/adv7482.c
@@ -1170,6 +1170,47 @@ static int adv7482_cropcap(struct v4l2_subdev *sd, struct v4l2_cropcap *a)
 	return 0;
 }
 
+/*
+ * adv7482_g_crop() - V4L2 decoder i/f handler for g_crop
+ * @sd: pointer to standard V4L2 sub-device structure
+ * @a: pointer to standard V4L2 cropcap structure
+ *
+ * Gets current cropping rectangle.
+ */
+static int adv7482_g_crop(struct v4l2_subdev *sd, struct v4l2_crop *a)
+{
+	struct adv7482_state *state = to_state(sd);
+	u8 progressive;
+	u32 width;
+	u32 height;
+	int ret;
+
+	struct adv7482_link_config *config = &state->mipi_csi2_link[0];
+
+	a->c.left = 0;
+	a->c.top  = 0;
+
+	if (config->input_interface == DECODER_INPUT_INTERFACE_YCBCR422) {
+		a->c.width  = 720;
+		a->c.height = 480;
+	} else {
+		/* Get video information */
+		ret = adv7482_get_vid_info(sd, &progressive,
+						 &width, &height, NULL);
+		if (ret < 0) {
+			a->c.width  = ADV7482_MAX_WIDTH;
+			a->c.height = ADV7482_MAX_HEIGHT;
+		} else {
+			a->c.width  = width;
+			a->c.height = height;
+		}
+	}
+
+	a->type = V4L2_BUF_TYPE_VIDEO_CAPTURE;
+
+	return 0;
+}
+
 static int adv7482_set_field_mode(struct adv7482_state *state)
 {
 	/* FIXME */
@@ -1467,6 +1508,7 @@ static const struct v4l2_subdev_video_ops adv7482_video_ops = {
 	.querystd	= adv7482_querystd,
 	.g_input_status = adv7482_g_input_status,
 	.cropcap	= adv7482_cropcap,
+	.g_crop		= adv7482_g_crop,
 	.g_mbus_config	= adv7482_g_mbus_config,
 };
 
-- 
1.7.5.4

