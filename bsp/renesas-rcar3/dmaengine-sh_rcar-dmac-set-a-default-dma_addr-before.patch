From 13278300c71ea1ecd8456866ef0f88514297fd3b Mon Sep 17 00:00:00 2001
From: zou cao <cao.zou@windriver.com>
Date: Tue, 27 Jun 2017 08:53:21 +0800
Subject: [PATCH] dmaengine: sh_rcar-dmac: set a default dma_addr before
 dma_map_resource

dma map_resource is used for supporting the IPMMU, but it isn't always
enabled, when IPMMU is disabled,  the dma addr will not be initialized,
zero address will be transfered to dma control, it will cause dma error,
here we use normal dma operation when IPMMU is disabled, set the
map->addr as real dma physical addr in default.

Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/dma/sh/rcar-dmac.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/drivers/dma/sh/rcar-dmac.c b/drivers/dma/sh/rcar-dmac.c
index 6400874..829e391 100644
--- a/drivers/dma/sh/rcar-dmac.c
+++ b/drivers/dma/sh/rcar-dmac.c
@@ -1126,6 +1126,7 @@ static int rcar_dmac_map_slave_addr(struct dma_chan *chan,
 			ops->unmap_resource(chan->device->dev, map->addr,
 				   map->slave.xfer_size, map->dir, 0);
 	map->slave.xfer_size = 0;
+	map->addr = dev_addr;
 
 	/* Create new slave address map. */
 	if (ops->map_resource)
-- 
1.7.5.4

