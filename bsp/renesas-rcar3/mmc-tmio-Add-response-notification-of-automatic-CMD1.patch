From cb3d2670a0bae3175fa8d5cb3b6137a6ff71ab98 Mon Sep 17 00:00:00 2001
From: Masaharu Hayakawa <masaharu.hayakawa.ry@renesas.com>
Date: Fri, 20 Jan 2017 17:40:44 +0900
Subject: [PATCH 1385/2066] mmc: tmio: Add response notification of automatic
 CMD12

When using the automatic CMD12, response of automatic CMD12 stores
to stop->resp[0] at the access end of multiple block transfer.

Signed-off-by: Masaharu Hayakawa <masaharu.hayakawa.ry@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/mmc/host/tmio_mmc_pio.c |   11 +++++++++++
 1 files changed, 11 insertions(+), 0 deletions(-)

diff --git a/drivers/mmc/host/tmio_mmc_pio.c b/drivers/mmc/host/tmio_mmc_pio.c
index 05ec52e..18706f3 100644
--- a/drivers/mmc/host/tmio_mmc_pio.c
+++ b/drivers/mmc/host/tmio_mmc_pio.c
@@ -560,6 +560,17 @@ static void tmio_mmc_data_irq(struct tmio_mmc_host *host, unsigned int stat)
 	if (!data)
 		goto out;
 
+	/* The response of automatic CMD12 is stored */
+	if (host->pdata->flags & TMIO_MMC_MIN_RCAR2) {
+		if ((sd_ctrl_read16(host, CTL_SD_CMD) &
+			(TRANSFER_MULTI | NO_CMD12_ISSUE)) == TRANSFER_MULTI) {
+			if (data->stop) {
+				data->stop->resp[0] =
+					sd_ctrl_read16_and_16_as_32(host,
+							CTL_RESPONSE);
+			}
+		}
+	}
 	if (stat & TMIO_STAT_CRCFAIL || stat & TMIO_STAT_STOPBIT_ERR ||
 	    stat & TMIO_STAT_TXUNDERRUN)
 		data->error = -EILSEQ;
-- 
1.7.5.4

