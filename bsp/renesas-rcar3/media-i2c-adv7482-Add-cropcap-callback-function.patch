From eb89af691f739cc69c9100962149cd78b925de22 Mon Sep 17 00:00:00 2001
From: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
Date: Thu, 29 Oct 2015 19:00:39 +0900
Subject: [PATCH 1892/2066] media: i2c: adv7482: Add cropcap callback function

Signed-off-by: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/media/i2c/adv7482.c |   56 ++++++++++++++++++++++++++++++++++++-------
 1 files changed, 47 insertions(+), 9 deletions(-)

diff --git a/drivers/media/i2c/adv7482.c b/drivers/media/i2c/adv7482.c
index 7a4e030..b452bd8 100644
--- a/drivers/media/i2c/adv7482.c
+++ b/drivers/media/i2c/adv7482.c
@@ -1123,10 +1123,56 @@ static int adv7482_mbus_fmt(struct v4l2_subdev *sd,
 	return 0;
 }
 
+/*
+ * adv7482_cropcap() - V4L2 decoder i/f handler for cropcap
+ * @sd: pointer to standard V4L2 sub-device structure
+ * @a: pointer to standard V4L2 cropcap structure
+ *
+ * Gets cropping limits, default cropping rectangle and pixel aspect.
+ */
+static int adv7482_cropcap(struct v4l2_subdev *sd, struct v4l2_cropcap *a)
+{
+	struct adv7482_state *state = to_state(sd);
+	u8 progressive;
+	u32 width;
+	u32 height;
+	int ret;
+	struct adv7482_link_config *config = &state->mipi_csi2_link[0];
+
+	/* cropping limits */
+	a->bounds.left = 0;
+	a->bounds.top  = 0;
+
+	if (config->input_interface == DECODER_INPUT_INTERFACE_YCBCR422) {
+		a->bounds.width  = 720;
+		a->bounds.height = 480;
+	} else {
+		/* Get video information */
+		ret = adv7482_get_vid_info(sd, &progressive,
+						 &width, &height, NULL);
+		if (ret < 0) {
+			a->bounds.width  = ADV7482_MAX_WIDTH;
+			a->bounds.height = ADV7482_MAX_HEIGHT;
+		} else {
+			a->bounds.width  = width;
+			a->bounds.height = height;
+		}
+	}
+
+	/* default cropping rectangle */
+	a->defrect = a->bounds;
+
+	/* does not support scaling */
+	a->pixelaspect.numerator   = 1;
+	a->pixelaspect.denominator = 1;
+	a->type = V4L2_BUF_TYPE_VIDEO_CAPTURE;
+
+	return 0;
+}
+
 static int adv7482_set_field_mode(struct adv7482_state *state)
 {
 	/* FIXME */
-
 	return 0;
 }
 
@@ -1420,15 +1466,7 @@ static const struct v4l2_subdev_core_ops adv7482_core_ops = {
 static const struct v4l2_subdev_video_ops adv7482_video_ops = {
 	.querystd	= adv7482_querystd,
 	.g_input_status = adv7482_g_input_status,
-#if 0 /* FIXME */
-	.s_stream	= adv7482_s_stream,
 	.cropcap	= adv7482_cropcap,
-	.g_crop		= adv7482_g_crop,
-	.enum_mbus_fmt	= adv7482_enum_mbus_fmt,
-	.g_mbus_fmt	= adv7482_g_mbus_fmt,
-	.try_mbus_fmt	= adv7482_try_mbus_fmt,
-	.s_mbus_fmt	= adv7482_s_mbus_fmt,
-#endif
 	.g_mbus_config	= adv7482_g_mbus_config,
 };
 
-- 
1.7.5.4

