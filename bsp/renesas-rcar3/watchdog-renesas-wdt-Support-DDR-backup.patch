From 56508d33c625e39666c862cb5d40b35aec541372 Mon Sep 17 00:00:00 2001
From: Hien Dang <hien.dang.eb@rvc.renesas.com>
Date: Mon, 22 Feb 2016 14:47:50 +0700
Subject: [PATCH 1648/2066] watchdog: renesas-wdt: Support DDR backup

Signed-off-by: Hien Dang <hien.dang.eb@rvc.renesas.com>
Signed-off-by: Takeshi Kihara <takeshi.kihara.df@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/watchdog/renesas_wdt.c |   46 ++++++++++++++++++++++++++++++++++++++++
 1 files changed, 46 insertions(+), 0 deletions(-)

diff --git a/drivers/watchdog/renesas_wdt.c b/drivers/watchdog/renesas_wdt.c
index 83b513f..d14ac2c 100644
--- a/drivers/watchdog/renesas_wdt.c
+++ b/drivers/watchdog/renesas_wdt.c
@@ -16,6 +16,7 @@
 #include <linux/of.h>
 #include <linux/platform_device.h>
 #include <linux/pm_runtime.h>
+#include <linux/soc/renesas/s2ram_ddr_backup.h>
 #include <linux/watchdog.h>
 
 #define RWTCNT		0
@@ -26,6 +27,19 @@
 
 #define RWDT_DEFAULT_TIMEOUT 60U
 
+#ifdef CONFIG_RCAR_DDR_BACKUP
+static struct hw_register rwdt_ip_regs[] = {
+	{"RWTCNT",   0x00, 16, 0},
+	{"RWTCSRA",  0x04, 8, 0},
+};
+
+static struct rcar_ip rwdt_ip = {
+	.ip_name = "RWDT",
+	.reg_count = ARRAY_SIZE(rwdt_ip_regs),
+	.ip_reg = rwdt_ip_regs,
+};
+#endif /* CONFIG_RCAR_DDR_BACKUP*/
+
 static const unsigned int clk_divs[] = { 1, 4, 16, 32, 64, 128, 1024 };
 
 static bool nowayout = WATCHDOG_NOWAYOUT;
@@ -208,9 +222,41 @@ static const struct of_device_id rwdt_ids[] = {
 };
 MODULE_DEVICE_TABLE(of, rwdt_ids);
 
+#ifdef CONFIG_PM_SLEEP
+static int rwdt_suspend(struct device *dev)
+{
+	int ret = 0;
+#ifdef CONFIG_RCAR_DDR_BACKUP
+	struct rwdt_priv *priv = dev_get_drvdata(dev);
+
+	if (!rwdt_ip.virt_addr)
+		rwdt_ip.virt_addr = priv->base;
+
+	ret = handle_registers(&rwdt_ip, DO_BACKUP);
+#endif /* CONFIG_RCAR_DDR_BACKUP */
+	return ret;
+}
+
+static int rwdt_resume(struct device *dev)
+{
+	int ret = 0;
+#ifdef CONFIG_RCAR_DDR_BACKUP
+	ret = handle_registers(&rwdt_ip, DO_RESTORE);
+#endif /* CONFIG_RCAR_DDR_BACKUP */
+	return ret;
+}
+
+static SIMPLE_DEV_PM_OPS(rwdt_pm_ops,
+			rwdt_suspend, rwdt_resume);
+#define DEV_PM_OPS (&rwdt_pm_ops)
+#else
+#define DEV_PM_OPS NULL
+#endif /* CONFIG_PM_SLEEP */
+
 static struct platform_driver rwdt_driver = {
 	.driver = {
 		.name = "renesas_wdt",
+		.pm	= DEV_PM_OPS,
 		.of_match_table = rwdt_ids,
 	},
 	.probe = rwdt_probe,
-- 
1.7.5.4

