From 1dfa6d8036a9d417369459bb607a772e7ea29a37 Mon Sep 17 00:00:00 2001
From: Hien Dang <hien.dang.eb@renesas.com>
Date: Wed, 24 Aug 2016 16:00:07 +0700
Subject: [PATCH 1678/2066] dmaengine: rcar-dmac: Use pm_runtime_get/put when
 resume

Due to the commit '39dd0f234fc37d ("PM / Domains: Allow runtime PM during
system PM phases")', runtime PM status might be suspended during system
suspend phase. Therefore, at system suspend phase, pm_runtime_get()/put()
are necessary invoked when accessing the hardware.

This modification,in system resume phase, is for symmetric with above
situation. Moreover, it enhances stability of system in case that
upstream kernel may update to enable device can change runtime suspend
state during system resume phase.

Signed-off-by: Hien Dang <hien.dang.eb@renesas.com>
---
 drivers/dma/sh/rcar-dmac.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/drivers/dma/sh/rcar-dmac.c b/drivers/dma/sh/rcar-dmac.c
index 5c9a30e..58ec30c 100644
--- a/drivers/dma/sh/rcar-dmac.c
+++ b/drivers/dma/sh/rcar-dmac.c
@@ -1601,8 +1601,13 @@ static int rcar_dmac_sleep_suspend(struct device *dev)
 static int rcar_dmac_sleep_resume(struct device *dev)
 {
 	struct rcar_dmac *dmac = dev_get_drvdata(dev);
+	int ret;
 
-	return rcar_dmac_init(dmac);
+	pm_runtime_get_sync(dev);
+	ret = rcar_dmac_init(dmac);
+	pm_runtime_put(dev);
+
+	return ret;
 }
 #endif
 
-- 
1.7.5.4

