From cabb6579de85714301b4ee38a17d2c8af507288b Mon Sep 17 00:00:00 2001
From: Hien Dang <hien.dang.eb@renesas.com>
Date: Wed, 17 Aug 2016 17:08:49 +0700
Subject: [PATCH 1672/2066] pwm: rcar: Use pm_runtime_get/put when suspend

Due to the commit '39dd0f234fc37d ("PM / Domains: Allow runtime PM during
system PM phases")', runtime PM status might be suspended when back up
module registers. Therefore, it is necessary to ensure device is
on during suspend by using pm_runtime_get/put.

Signed-off-by: Hien Dang <hien.dang.eb@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/pwm/pwm-rcar.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/pwm/pwm-rcar.c b/drivers/pwm/pwm-rcar.c
index 9dced8d..1922512 100644
--- a/drivers/pwm/pwm-rcar.c
+++ b/drivers/pwm/pwm-rcar.c
@@ -392,8 +392,9 @@ static int rcar_pwm_suspend(struct device *dev)
 
 		if (!ip->virt_addr)
 			ip->virt_addr = pwm->base;
-
+		pm_runtime_get_sync(dev);
 		ret = rcar_handle_registers(ip, DO_BACKUP);
+		pm_runtime_put(dev);
 	} else {
 		pr_err("%s: Failed to find PWM device\n", __func__);
 		ret = -ENODEV;
-- 
1.7.5.4

