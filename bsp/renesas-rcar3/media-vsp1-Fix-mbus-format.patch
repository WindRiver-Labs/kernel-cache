From 9117f1edbb8faa2a53c4f5d3cced107b6e96080d Mon Sep 17 00:00:00 2001
From: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
Date: Wed, 9 Sep 2015 19:08:34 +0900
Subject: [PATCH 2048/2066] media: vsp1: Fix mbus format

Signed-off-by: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/media/platform/vsp1/vsp1_drm.c |   15 ++++++++++++---
 1 files changed, 12 insertions(+), 3 deletions(-)

diff --git a/drivers/media/platform/vsp1/vsp1_drm.c b/drivers/media/platform/vsp1/vsp1_drm.c
index 7ad2024..adf8337 100644
--- a/drivers/media/platform/vsp1/vsp1_drm.c
+++ b/drivers/media/platform/vsp1/vsp1_drm.c
@@ -360,7 +360,7 @@ int vsp1_du_setup_rpf(struct device *dev, unsigned int rpf_index,
 	format.pad = RWPF_PAD_SINK;
 	format.format.width = src->width + src->left;
 	format.format.height = src->height + src->top;
-	format.format.code = MEDIA_BUS_FMT_ARGB8888_1X32;
+	format.format.code = fmtinfo->mbus;
 	format.format.field = V4L2_FIELD_NONE;
 
 	ret = v4l2_subdev_call(&rpf->entity.subdev, pad, set_fmt, NULL,
@@ -389,6 +389,9 @@ int vsp1_du_setup_rpf(struct device *dev, unsigned int rpf_index,
 		__func__, sel.r.left, sel.r.top, sel.r.width, sel.r.height,
 		rpf->entity.index);
 
+	/* RPF source, hardcode the format to ARGB8888 to turn on format
+	 * conversion if needed.
+	 */
 	format.pad = RWPF_PAD_SOURCE;
 
 	ret = v4l2_subdev_call(&rpf->entity.subdev, pad, get_fmt, NULL,
@@ -401,14 +404,16 @@ int vsp1_du_setup_rpf(struct device *dev, unsigned int rpf_index,
 		__func__, format.format.width, format.format.height,
 		format.format.code, rpf->entity.index);
 
-	format.pad = rpf->entity.index;
-	format.format.code = fmtinfo->mbus;
+	format.format.code = MEDIA_BUS_FMT_ARGB8888_1X32;
 
 	ret = v4l2_subdev_call(&rpf->entity.subdev, pad, set_fmt, NULL,
 			       &format);
 	if (ret < 0)
 		return ret;
 
+	/* BRU sink, propagate the format from the RPF source. */
+	format.pad = rpf->entity.index;
+
 	ret = v4l2_subdev_call(&vsp1->bru->entity.subdev, pad, set_fmt, NULL,
 			       &format);
 	if (ret < 0)
@@ -475,6 +480,10 @@ int vsp1_drm_create_links(struct vsp1_device *vsp1)
 	unsigned int i;
 	int ret;
 
+	/* VSPD instances require a BRU to perform composition. */
+	if (!vsp1->bru)
+		return -ENXIO;
+
 	for (i = 0; i < vsp1->pdata.rpf_count; ++i) {
 		struct vsp1_rwpf *rpf = vsp1->rpf[i];
 
-- 
1.7.5.4

