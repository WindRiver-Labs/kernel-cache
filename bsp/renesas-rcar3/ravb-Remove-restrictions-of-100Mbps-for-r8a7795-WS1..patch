From 5803a6d8a4d54f611f6975235aa3f943ce3e180c Mon Sep 17 00:00:00 2001
From: Kazuya Mizuguchi <kazuya.mizuguchi.ks@renesas.com>
Date: Thu, 15 Dec 2016 12:36:51 +0900
Subject: [PATCH 1415/2066] ravb: Remove restrictions of 100Mbps for r8a7795
 WS1.1

r8a7795 WS1.0 is limited to 100Mbps.
R-Car Gen3 series after r8a7795 WS1.1 supports 1Gbps.

Signed-off-by: Kazuya Mizuguchi <kazuya.mizuguchi.ks@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/net/ethernet/renesas/ravb_main.c |   22 ++++++++++++++--------
 1 files changed, 14 insertions(+), 8 deletions(-)

diff --git a/drivers/net/ethernet/renesas/ravb_main.c b/drivers/net/ethernet/renesas/ravb_main.c
index 3f43d58..9bdd1ba 100644
--- a/drivers/net/ethernet/renesas/ravb_main.c
+++ b/drivers/net/ethernet/renesas/ravb_main.c
@@ -33,6 +33,7 @@
 #include <linux/spinlock.h>
 #include <linux/gpio.h>
 #include <linux/of_gpio.h>
+#include <linux/sys_soc.h>
 
 #include <asm/div64.h>
 
@@ -54,6 +55,11 @@ static const char *ravb_tx_irqs[NUM_TX_QUEUE] = {
 	"ch19", /* RAVB_NC */
 };
 
+static const struct soc_device_attribute r8a7795es10[] = {
+	{ .soc_id = "r8a7795", .revision = "ES1.0" },
+	{ /* sentinel */ }
+};
+
 int ravb_wait(struct net_device *ndev, enum ravb_reg reg, u32 mask, u32 value)
 {
 	int i;
@@ -1025,9 +1031,6 @@ static int ravb_phy_init(struct net_device *ndev)
 		return -ENOENT;
 	}
 
-	/* This driver only support 10/100Mbit speeds on Gen3
-	 * at this time.
-	 */
 	if (priv->chip_id == RCAR_GEN3) {
 		gpio = of_get_named_gpio_flags(np, "phy-int-gpio", 0, &flags);
 		if (gpio_is_valid(gpio)) {
@@ -1043,11 +1046,14 @@ static int ravb_phy_init(struct net_device *ndev)
 			}
 		}
 
-		err = phy_set_max_speed(phydev, SPEED_100);
-		if (err) {
-			netdev_err(ndev, "failed to limit PHY to 100Mbit/s\n");
-			phy_disconnect(phydev);
-			return err;
+		if (soc_device_match(r8a7795es10)) {
+			err = phy_set_max_speed(phydev, SPEED_100);
+			if (err) {
+				netdev_err(ndev, "failed to limit PHY to 100Mbit/s\n");
+				phy_disconnect(phydev);
+				return err;
+			}
+			netdev_info(ndev, "limited PHY to 100Mbit/s\n");
 		}
 
 		netdev_info(ndev, "limited PHY to 100Mbit/s\n");
-- 
1.7.5.4

