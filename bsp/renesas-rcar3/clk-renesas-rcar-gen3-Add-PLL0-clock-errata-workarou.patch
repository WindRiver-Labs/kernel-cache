From 678f0f14d6191b629419ce83b381f59a3ddd9990 Mon Sep 17 00:00:00 2001
From: Dien Pham <dien.pham.ry@renesas.com>
Date: Fri, 16 Dec 2016 11:14:40 +0700
Subject: [PATCH 1258/2066] clk: renesas: rcar-gen3: Add PLL0 clock errata
 workaround in PLL0 clk driver

The errata causes unexpected values of PLL0 clocks on H3 WS1.0.
This patch makes W/A to apply for only H3 WS1.0.

Signed-off-by: Dien Pham <dien.pham.ry@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/clk/renesas/rcar-gen3-cpg.c |   15 +++++++++++++++
 1 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/drivers/clk/renesas/rcar-gen3-cpg.c b/drivers/clk/renesas/rcar-gen3-cpg.c
index 9a27a41..31246ab 100644
--- a/drivers/clk/renesas/rcar-gen3-cpg.c
+++ b/drivers/clk/renesas/rcar-gen3-cpg.c
@@ -76,6 +76,11 @@ static int cpg_pll0_clk_set_rate(struct clk_hw *hw, unsigned long rate,
 	u32 val;
 	int i;
 
+	/* Start clock issue W/A (for H3 WS1.0) */
+	if (soc_device_match(r8a7795es10))
+		prate *= 2; /* PLL0 output multiplied by 2 */
+	/* End clock issue W/A */
+
 	stc_val = DIV_ROUND_CLOSEST(rate, prate);
 	stc_val = clamp(stc_val, 90U, 120U);/*Lowest value is 1.5G (stc == 90)*/
 	pr_debug("%s(): prate: %lu, rate: %lu, pll0-mult: %d\n",
@@ -108,6 +113,11 @@ static long cpg_pll0_clk_round_rate(struct clk_hw *hw, unsigned long rate,
 	if (rate < Z_CLK_MAX_THRESHOLD)
 		rate = Z_CLK_MAX_THRESHOLD; /* Set lowest value: 1.5GHz */
 
+	/* Start clock issue W/A (for H3 WS1.0) */
+	if (soc_device_match(r8a7795es10))
+		prate *= 2; /* PLL0 output multiplied by 2 */
+	/* End clock issue W/A */
+
 	mult = DIV_ROUND_CLOSEST(rate, prate);
 	mult = clamp(mult, 90U, 120U); /* 1.5G => (stc == 90)*/
 
@@ -132,6 +142,11 @@ static unsigned long cpg_pll0_clk_recalc_rate(struct clk_hw *hw,
 
 	rate = (u64)parent_rate * (val + 1);
 
+	/* Start clock issue W/A (for H3 WS1.0) */
+	if (soc_device_match(r8a7795es10))
+		rate *= 2; /* PLL0 output multiplied by 2 */
+	/* End clock issue W/A */
+
 	/* Round to closest value at 100MHz unit */
 	rate = 100000000 * DIV_ROUND_CLOSEST(rate, 100000000);
 	return rate;
-- 
1.7.5.4

