From 7ab7e0146e815ffc3426023f5588b71787f4b5b3 Mon Sep 17 00:00:00 2001
From: Kouei Abe <kouei.abe.cp@renesas.com>
Date: Tue, 27 Sep 2016 20:58:11 +0900
Subject: [PATCH 1378/2066] mmc: tmio: fix soft lockup on CMD12 for R-Car SDHI
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

For regular multi block transfers the driver will use the automatic
CMD12 of the hardware. It did dump all CMD12 requests, though, which
is not correct. This leads to a lock up of the driver because the CMD12
request is never completed.

This patch judges whether the h/w state is in a command sequence or not,
and selects CMD12 handling way for R-Car SDHI.

Signed-off-by: Jan Kl√∂tzke <jan.kloetzke@technisat.de>
Signed-off-by: Masaharu Hayakawa <masaharu.hayakawa.ry@renesas.com>
Signed-off-by: Kouei Abe <kouei.abe.cp@renesas.com>
[zou:Original patch taken from
git://git.kernel.org/pub/scm/linux/kernel/git/horms/renesas-bsp.git
 v4.9/rcar-3.5.1]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/mmc/host/tmio_mmc_pio.c |   15 ++++++++++++---
 1 files changed, 12 insertions(+), 3 deletions(-)

diff --git a/drivers/mmc/host/tmio_mmc_pio.c b/drivers/mmc/host/tmio_mmc_pio.c
index 8b08690..b219804 100644
--- a/drivers/mmc/host/tmio_mmc_pio.c
+++ b/drivers/mmc/host/tmio_mmc_pio.c
@@ -348,9 +348,18 @@ static int tmio_mmc_start_command(struct tmio_mmc_host *host, struct mmc_command
 	u32 irq_mask = TMIO_MASK_CMD;
 
 	/* CMD12 is handled by hardware */
-	if (cmd->opcode == MMC_STOP_TRANSMISSION && !cmd->arg) {
-		sd_ctrl_write16(host, CTL_STOP_INTERNAL_ACTION, 0x001);
-		return 0;
+	if (!(host->pdata->flags & TMIO_MMC_MIN_RCAR2)) {
+		if (cmd->opcode == MMC_STOP_TRANSMISSION && !cmd->arg) {
+			sd_ctrl_write16(host, CTL_STOP_INTERNAL_ACTION, 0x001);
+			return 0;
+		}
+	} else if (cmd->opcode == MMC_STOP_TRANSMISSION && !cmd->arg) {
+		u32 status = sd_ctrl_read16_and_16_as_32(host, CTL_STATUS);
+
+		if (status & TMIO_STAT_CMD_BUSY) {
+			sd_ctrl_write16(host, CTL_STOP_INTERNAL_ACTION, 0x001);
+			return 0;
+		}
 	}
 
 	switch (mmc_resp_type(cmd)) {
-- 
1.7.5.4

