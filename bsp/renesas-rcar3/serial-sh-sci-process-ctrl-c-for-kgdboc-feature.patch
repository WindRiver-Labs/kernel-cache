From 6cfcb6aa313ceaa61f536c0563adff8120f36f52 Mon Sep 17 00:00:00 2001
From: Cao Zou <cao.zou@windriver.com>
Date: Tue, 4 Jul 2017 13:44:19 +0800
Subject: [PATCH] serial: sh-sci: process ctrl+c for kgdboc feature

When run kgdboc, we can not stop debugging with ctrl+c.
So, add code to process ctrl+c with poll_rx_cb() callback
function.

Signed-off-by: Cao Zou <cao.zou@windriver.com>
---
 drivers/tty/serial/sh-sci.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/drivers/tty/serial/sh-sci.c b/drivers/tty/serial/sh-sci.c
index 77e0a9d..9a3e78b 100644
--- a/drivers/tty/serial/sh-sci.c
+++ b/drivers/tty/serial/sh-sci.c
@@ -1157,6 +1157,14 @@ static void sci_receive_chars(struct uart_port *port)
 
 		if (port->type == PORT_SCI) {
 			char c = serial_port_in(port, SCxRDR);
+
+#ifdef CONFIG_CONSOLE_POLL
+			if (port->poll_rx_cb && port->poll_rx_cb(c & 255)) {
+				serial_port_in(port, SCxSR); /* dummy read */
+				sci_clear_SCxSR(port, SCxSR_RDxF_CLEAR(port));
+				continue;
+			}
+#endif
 			if (uart_handle_sysrq_char(port, c) ||
 			    sci_port->break_flag)
 				count = 0;
-- 
1.7.5.4

