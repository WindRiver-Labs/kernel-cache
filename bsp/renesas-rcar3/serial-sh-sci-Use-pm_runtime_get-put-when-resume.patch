From 82630d65d9b38d96120bb2ccb12b39f63333eb4e Mon Sep 17 00:00:00 2001
From: Hien Dang <hien.dang.eb@renesas.com>
Date: Tue, 23 Aug 2016 10:33:19 +0700
Subject: [PATCH 1674/2066] serial: sh-sci: Use pm_runtime_get/put when resume

Due to the commit '39dd0f234fc37d ("PM / Domains: Allow runtime PM during
system PM phases")', runtime PM status might be suspended during system
suspend phase. Therefore, at system suspend phase, pm_runtime_get()/put()
are necessary invoked when accessing the hardware.

This modification,in system resume phase, is for symmetric with above
situation. Moreover, it enhances stability of system in case that
upstream kernel may update to enable device can change runtime suspend
state during system resume phase.

Signed-off-by: Hien Dang <hien.dang.eb@renesas.com>
---
 drivers/tty/serial/sh-sci.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/tty/serial/sh-sci.c b/drivers/tty/serial/sh-sci.c
index 5b817b4..9ac9001 100644
--- a/drivers/tty/serial/sh-sci.c
+++ b/drivers/tty/serial/sh-sci.c
@@ -3384,10 +3384,12 @@ static __maybe_unused int sci_resume(struct device *dev)
 	int ret = 0;
 
 	if (sport) {
+		pm_runtime_get_sync(sport->port.dev);
 #ifdef CONFIG_RCAR_DDR_BACKUP
 		ret = sci_restore_regs(dev);
 #endif /* CONFIG_RCAR_DDR_BACKUP */
 		uart_resume_port(&sci_uart_driver, &sport->port);
+		pm_runtime_put(sport->port.dev);
 	}
 
 	return ret;
-- 
1.7.5.4

