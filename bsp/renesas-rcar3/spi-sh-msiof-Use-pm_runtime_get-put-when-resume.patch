From 4ec8e2f96fe698c81c9fba5fa00ce1d55f43a6f8 Mon Sep 17 00:00:00 2001
From: Hien Dang <hien.dang.eb@renesas.com>
Date: Tue, 23 Aug 2016 10:36:50 +0700
Subject: [PATCH 1676/2066] spi: sh-msiof: Use pm_runtime_get/put when resume

Due to the commit '39dd0f234fc37d ("PM / Domains: Allow runtime PM during
system PM phases")', runtime PM status might be suspended during system
suspend phase. Therefore, at system suspend phase, pm_runtime_get()/put()
are necessary invoked when accessing the hardware.

This modification,in system resume phase, is for symmetric with above
situation. Moreover, it enhances stability of system in case that
upstream kernel may update to enable device can change runtime suspend
state during system resume phase.

Signed-off-by: Hien Dang <hien.dang.eb@renesas.com>
---
 drivers/spi/spi-sh-msiof.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/spi/spi-sh-msiof.c b/drivers/spi/spi-sh-msiof.c
index e488c2e..f43a60c 100644
--- a/drivers/spi/spi-sh-msiof.c
+++ b/drivers/spi/spi-sh-msiof.c
@@ -1586,7 +1586,9 @@ static int sh_msiof_spi_resume(struct device *dev)
 #ifdef CONFIG_RCAR_DDR_BACKUP
 	struct platform_device *pdev = to_platform_device(dev);
 
+	pm_runtime_get_sync(dev);
 	ret = msiof_restore_regs(pdev);
+	pm_runtime_put(dev);
 #endif /* CONFIG_RCAR_DDR_BACKUP */
 	return ret;
 }
-- 
1.7.5.4

