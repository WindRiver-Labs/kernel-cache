From 4661b1247912aef811d3baf00295bccbfca2b392 Mon Sep 17 00:00:00 2001
From: Eugeny S. Mints <eugeny.mints@embeddedalley.com>
Date: Sat, 7 Mar 2009 17:52:26 -0500
Subject: [PATCH] OMAP3: PM: Fix wrong sequence in suspend.

Powerdomain previous state is checked after restoring new
states in suspend. This patch fixes this problem.

Signed-off-by: Jouni Hogander <jouni.hogander@nokia.com>
Integrated-by: Eugeny S. Mints <eugeny.mints@embeddedalley.com>
Signed-off-by: Jim Somerville <Jim.Somerville@windriver.com>
---
 arch/arm/mach-omap2/pm34xx.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-omap2/pm34xx.c b/arch/arm/mach-omap2/pm34xx.c
index e4e846e..ca7005a 100644
--- a/arch/arm/mach-omap2/pm34xx.c
+++ b/arch/arm/mach-omap2/pm34xx.c
@@ -450,7 +450,6 @@ static int omap3_pm_suspend(void)
 restore:
 	/* Restore next_pwrsts */
 	list_for_each_entry(pwrst, &pwrst_list, node) {
-		set_pwrdm_state(pwrst->pwrdm, pwrst->saved_state);
 		state = pwrdm_read_prev_pwrst(pwrst->pwrdm);
 		if (state != pwrst->next_state) {
 			printk(KERN_INFO "Powerdomain (%s) didn't enter "
@@ -458,6 +457,7 @@ restore:
 			       pwrst->pwrdm->name, pwrst->next_state);
 			ret = -1;
 		}
+		set_pwrdm_state(pwrst->pwrdm, pwrst->saved_state);
 	}
 	if (ret)
 		printk(KERN_ERR "Could not enter target state in pm_suspend\n");
-- 
1.6.0.4

