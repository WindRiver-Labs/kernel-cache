From 4768fdf190b9d8e43144d4a278450d04c1fb762c Mon Sep 17 00:00:00 2001
From: Jim Somerville <Jim.Somerville@windriver.com>
Date: Mon, 9 Mar 2009 16:04:54 -0400
Subject: [PATCH] Fix lcd red tint problem.

Version ES2.1 of the TWL4030 hardware requires graphics power
to be set properly, else only limited colours will be seen
on the lcd display.  The net effect of this issue is a
red tint to everything on the display.

Detailed mechanics of the patch:
On LCD panel enable, this patch associates the voltage
regulator vpll2 device group with all groups.  It also sets
the output voltage to 1.8v from the default of 1.2v.  The
default is not enough to drive all colours on this board.
On LCD panel disable, this patch disconnects the dev
group from everything and sets the ldo to 0.7v and puts
it in off mode.

Signed-off-by: Jim Somerville <Jim.Somerville@windriver.com>
---
 drivers/video/omap/lcd_omap3evm.c |   14 ++++++++++++++
 1 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/drivers/video/omap/lcd_omap3evm.c b/drivers/video/omap/lcd_omap3evm.c
index a564ca5..821bafe 100644
--- a/drivers/video/omap/lcd_omap3evm.c
+++ b/drivers/video/omap/lcd_omap3evm.c
@@ -44,6 +44,8 @@
 #define ENABLE_VDAC_DEV_GRP	0x20
 #define ENABLE_VPLL2_DEDICATED	0x05
 #define ENABLE_VPLL2_DEV_GRP	0xE0
+#define TWL4030_VPLL2_DEV_GRP	0x33
+#define TWL4030_VPLL2_DEDICATED	0x36
 
 #define TWL_LED_LEDEN		0x00
 #define TWL_PWMA_PWMAON		0x00
@@ -86,12 +88,24 @@ static void omap3evm_panel_cleanup(struct lcd_panel *panel)
 
 static int omap3evm_panel_enable(struct lcd_panel *panel)
 {
+	if (system_rev > OMAP3430_REV_ES1_0) {
+		twl4030_i2c_write_u8(TWL4030_MODULE_PM_RECEIVER,
+			ENABLE_VPLL2_DEDICATED, TWL4030_VPLL2_DEDICATED);
+		twl4030_i2c_write_u8(TWL4030_MODULE_PM_RECEIVER,
+			ENABLE_VPLL2_DEV_GRP, TWL4030_VPLL2_DEV_GRP);
+	}
 	omap_set_gpio_dataout(LCD_PANEL_ENABLE_GPIO, 0);
 	return 0;
 }
 
 static void omap3evm_panel_disable(struct lcd_panel *panel)
 {
+	if (system_rev > OMAP3430_REV_ES1_0) {
+		twl4030_i2c_write_u8(TWL4030_MODULE_PM_RECEIVER, 0x0,
+			TWL4030_VPLL2_DEDICATED);
+		twl4030_i2c_write_u8(TWL4030_MODULE_PM_RECEIVER, 0x0,
+			TWL4030_VPLL2_DEV_GRP);
+	}
 	omap_set_gpio_dataout(LCD_PANEL_ENABLE_GPIO, 1);
 }
 
-- 
1.6.0.4

