From b678695577d71319725979f8245c7ae6923a4c62 Mon Sep 17 00:00:00 2001
From: Wang Hui <Hui.Wang@windriver.com>
Date: Fri, 18 Dec 2009 14:06:44 +0800
Subject: [PATCH 18/20] musb/omap3530: add otg mode change from a to b

On omap3 series platforms, the musb can't raise id pin change
detection interrupt, so we must change otg mode through sysfs
interface manually, current solution only support b to a change, now
add a to b change.
The process is like this, if the musb is in a mode, it will send an
end session request first, then it will follow original routine: start
a new session, during this session, it will identify whether a or b is
plugging in the socket,  then it will init controller to a or b state
according to its identification.

Signed-off-by: Wang Hui <Hui.Wang@windriver.com>
---
 drivers/usb/musb/omap2430.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/musb/omap2430.c b/drivers/usb/musb/omap2430.c
index 5fe93a6..397b22c 100644
--- a/drivers/usb/musb/omap2430.c
+++ b/drivers/usb/musb/omap2430.c
@@ -198,6 +198,11 @@ void musb_platform_set_mode(struct musb *musb, u8 musb_mode)
 {
 	u8	devctl = musb_readb(musb->mregs, MUSB_DEVCTL);
 
+	if ((devctl & MUSB_DEVCTL_BDEVICE) == 0x0) {
+		devctl &= ~MUSB_DEVCTL_SESSION;
+		musb_writeb(musb->mregs, MUSB_DEVCTL, devctl);
+	}
+
 	devctl |= MUSB_DEVCTL_SESSION;
 	musb_writeb(musb->mregs, MUSB_DEVCTL, devctl);
 }
-- 
1.6.5.2

