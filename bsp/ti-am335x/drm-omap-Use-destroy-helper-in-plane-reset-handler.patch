From 7c2e5362ba86b45bee35534b01cbc4db92baccd3 Mon Sep 17 00:00:00 2001
From: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Date: Mon, 10 Aug 2015 12:08:51 +0300
Subject: [PATCH 488/800] drm/omap: Use destroy helper in plane reset handler

Call __drm_atomic_helper_plane_destroy_state() in the plane reset
handler instead of open-coding it. This will avoid changes to the driver
if plane state later gets more fields that need to be reset.

Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ti.com>
Signed-off-by: Jyri Sarha <jsarha@ti.com>
[zou: Original patch taken from PROCESSOR-SDK-LINUX-AM335X 02_00_01_07]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/gpu/drm/omapdrm/omap_plane.c |    9 +++++----
 1 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/omapdrm/omap_plane.c b/drivers/gpu/drm/omapdrm/omap_plane.c
index ec29b1c..6a95dbf 100644
--- a/drivers/gpu/drm/omapdrm/omap_plane.c
+++ b/drivers/gpu/drm/omapdrm/omap_plane.c
@@ -194,11 +194,12 @@ static void omap_plane_reset(struct drm_plane *plane)
 	struct omap_plane *omap_plane = to_omap_plane(plane);
 	struct omap_plane_state *omap_state;
 
-	if (plane->state && plane->state->fb)
-		drm_framebuffer_unreference(plane->state->fb);
+	if (plane->state) {
+		__drm_atomic_helper_plane_destroy_state(plane, plane->state);
 
-	kfree(plane->state);
-	plane->state = NULL;
+		kfree(plane->state);
+		plane->state = NULL;
+	}
 
 	omap_state = kzalloc(sizeof(*omap_state), GFP_KERNEL);
 	if (omap_state == NULL)
-- 
1.7.5.4

