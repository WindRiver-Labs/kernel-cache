From ccdf01a8634fb7746d61c6ac1e8af13c9f47887c Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Mon, 31 Mar 2014 10:44:47 +0800
Subject: [PATCH 70/71] arm: omap2+: pm33xx: mailxbox without irq

use wkup_m3_ping_noirq rather than wkup_m3_ping to remove
unpredicted timeout warning calltrace since wkup_m3_txev
might be blocked due to timeout from interrupt-preemptable.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 arch/arm/mach-omap2/pm33xx.c |   18 ++----------------
 1 files changed, 2 insertions(+), 16 deletions(-)

diff --git a/arch/arm/mach-omap2/pm33xx.c b/arch/arm/mach-omap2/pm33xx.c
index 3ad4bd4..1762905 100644
--- a/arch/arm/mach-omap2/pm33xx.c
+++ b/arch/arm/mach-omap2/pm33xx.c
@@ -186,14 +186,7 @@ static void am33xx_m3_state_machine_reset(void)
 
 	am33xx_pm->state = M3_STATE_MSG_FOR_RESET;
 
-	if (!wkup_m3_ping()) {
-		i = wait_for_completion_timeout(&am33xx_pm_sync,
-					msecs_to_jiffies(500));
-		if (!i) {
-			WARN(1, "PM: MPU<->CM3 sync failure\n");
-			am33xx_pm->state = M3_STATE_UNKNOWN;
-		}
-	} else {
+	if (wkup_m3_ping_noirq()) {
 		pr_warn("PM: Unable to ping CM3\n");
 	}
 }
@@ -242,14 +235,7 @@ static int am33xx_pm_begin(suspend_state_t state)
 
 	am33xx_pm->state = M3_STATE_MSG_FOR_LP;
 
-	if (!wkup_m3_ping()) {
-		i = wait_for_completion_timeout(&am33xx_pm_sync,
-					msecs_to_jiffies(500));
-		if (!i) {
-			WARN(1, "PM: MPU<->CM3 sync failure\n");
-			return -1;
-		}
-	} else {
+	if (wkup_m3_ping_noirq()) {
 		pr_warn("PM: Unable to ping CM3\n");
 		return -1;
 	}
-- 
1.7.5.4

