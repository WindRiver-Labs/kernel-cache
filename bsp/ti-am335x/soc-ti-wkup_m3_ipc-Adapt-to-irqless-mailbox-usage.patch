From 2f814e7c6ccbb3922e2500bb607dcc98dbd31db6 Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Thu, 25 Jun 2015 12:36:10 -0500
Subject: [PATCH 204/800] soc: ti: wkup_m3_ipc: Adapt to irqless mailbox usage

Sometimes, like in cpuidle path on am33xx, wkup_m3_ipc must ping
the wkup_m3 from noirq context, so adapt the mailbox usage to avoid
using irqs.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
[zou: Original patch taken from PROCESSOR-SDK-LINUX-AM335X 02_00_01_07]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/soc/ti/wkup_m3_ipc.c |   12 ++----------
 1 files changed, 2 insertions(+), 10 deletions(-)

diff --git a/drivers/soc/ti/wkup_m3_ipc.c b/drivers/soc/ti/wkup_m3_ipc.c
index 6c600fe..a8e9bde 100644
--- a/drivers/soc/ti/wkup_m3_ipc.c
+++ b/drivers/soc/ti/wkup_m3_ipc.c
@@ -152,14 +152,6 @@ static irqreturn_t wkup_m3_txev_handler(int irq, void *ipc_data)
 	return IRQ_HANDLED;
 }
 
-static void wkup_m3_mbox_callback(struct mbox_client *client, void *data)
-{
-	struct wkup_m3_ipc *m3_ipc = container_of(client, struct wkup_m3_ipc,
-						  mbox_client);
-
-	omap_mbox_disable_irq(m3_ipc->mbox, IRQ_RX);
-}
-
 static int wkup_m3_ping(struct wkup_m3_ipc *m3_ipc)
 {
 	struct device *dev = m3_ipc->dev;
@@ -179,7 +171,6 @@ static int wkup_m3_ping(struct wkup_m3_ipc *m3_ipc)
 	 * the RX callback to avoid multiple interrupts being received
 	 * by the CM3.
 	 */
-	omap_mbox_enable_irq(m3_ipc->mbox, IRQ_RX);
 	ret = mbox_send_message(m3_ipc->mbox, &dummy_msg);
 	if (ret < 0) {
 		dev_err(dev, "%s: mbox_send_message() failed: %d\n",
@@ -195,6 +186,7 @@ static int wkup_m3_ping(struct wkup_m3_ipc *m3_ipc)
 		return -EIO;
 	}
 
+	mbox_client_txdone(m3_ipc->mbox, 0);
 	return 0;
 }
 
@@ -378,7 +370,7 @@ static int wkup_m3_ipc_probe(struct platform_device *pdev)
 
 	m3_ipc_state.mbox_client.dev = dev;
 	m3_ipc_state.mbox_client.tx_done = NULL;
-	m3_ipc_state.mbox_client.rx_callback = wkup_m3_mbox_callback;
+	m3_ipc_state.mbox_client.rx_callback = NULL;
 	m3_ipc_state.mbox_client.tx_block = false;
 	m3_ipc_state.mbox_client.knows_txdone = false;
 
-- 
1.7.5.4

