From 299a660ce4553451b67c0482dcdd2b5c45b1bc29 Mon Sep 17 00:00:00 2001
From: Peter Ujfalusi <peter.ujfalusi@ti.com>
Date: Tue, 11 Aug 2015 11:53:58 +0300
Subject: [PATCH 476/800] dmaengine: edma: HACK: Disable memcpy on DRA7xx
 family

DRA7xx family of SoCs have DMA crossbar on front of the eDMA (like with
sDMA). Due to the legacy in the eDMA driver stack when the crossbar is in
use we can not support MEMCPY operation via eDMA since it can breakm the
HW triggered channels.
The MEMCPY can be done via the sDMA.

Signed-off-by: Peter Ujfalusi <peter.ujfalusi@ti.com>
[zou: Original patch taken from PROCESSOR-SDK-LINUX-AM335X 02_00_01_07]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/dma/edma.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/dma/edma.c b/drivers/dma/edma.c
index 88853af..e2b4f7f 100644
--- a/drivers/dma/edma.c
+++ b/drivers/dma/edma.c
@@ -979,7 +979,8 @@ static void edma_dma_init(struct edma_cc *ecc, struct dma_device *dma,
 {
 	dma->device_prep_slave_sg = edma_prep_slave_sg;
 	dma->device_prep_dma_cyclic = edma_prep_dma_cyclic;
-	dma->device_prep_dma_memcpy = edma_prep_dma_memcpy;
+	if (!of_machine_is_compatible("ti,dra7"))
+		dma->device_prep_dma_memcpy = edma_prep_dma_memcpy;
 	dma->device_alloc_chan_resources = edma_alloc_chan_resources;
 	dma->device_free_chan_resources = edma_free_chan_resources;
 	dma->device_issue_pending = edma_issue_pending;
@@ -1030,7 +1031,8 @@ static int edma_probe(struct platform_device *pdev)
 	dma_cap_zero(ecc->dma_slave.cap_mask);
 	dma_cap_set(DMA_SLAVE, ecc->dma_slave.cap_mask);
 	dma_cap_set(DMA_CYCLIC, ecc->dma_slave.cap_mask);
-	dma_cap_set(DMA_MEMCPY, ecc->dma_slave.cap_mask);
+	if (!of_machine_is_compatible("ti,dra7"))
+		dma_cap_set(DMA_MEMCPY, ecc->dma_slave.cap_mask);
 
 	edma_dma_init(ecc, &ecc->dma_slave, &pdev->dev);
 
-- 
1.7.5.4

