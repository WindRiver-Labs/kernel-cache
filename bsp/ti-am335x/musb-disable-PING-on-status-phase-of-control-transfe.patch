From 5699453bc9dd9bf9c8eeba6212aeaf4f0eef32fd Mon Sep 17 00:00:00 2001
From: Ajay Kumar Gupta <ajay.gupta@ti.com>
Date: Fri, 31 Jan 2014 18:32:31 +0200
Subject: [PATCH 041/188] musb: disable PING on status phase of control
 transfer

This commit comes from branch ti-linux-3.12.y:

git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git

PING token is not mandatory in status phase of control transfer
so some high speed USB sticks doesn't support this. If such devices
are connected to MUSB then they would not respond to PING token
causing delayed or failed enumeration.

[Roger Q] This also fixes Enumeration issues with some Super-Speed USB hubs
e.g. Dlink DUB-1340

Fixes D-01330 - AM33XX: CONNECTIVITY: USB3.0 hubs do not numerate successfully

Signed-off-by: Ajay Kumar Gupta <ajay.gupta@ti.com>
Signed-off-by: Roger Quadros <rogerq@ti.com>
Acked-by: Felipe Balbi <balbi@ti.com>
(cherry picked from commit b4c27b745801366860c7ec678f79b66ceb9047a1)
---
 drivers/usb/musb/musb_host.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/musb/musb_host.c b/drivers/usb/musb/musb_host.c
index a738156..3b433f5 100644
--- a/drivers/usb/musb/musb_host.c
+++ b/drivers/usb/musb/musb_host.c
@@ -1184,6 +1184,9 @@ irqreturn_t musb_h_ep0_irq(struct musb *musb)
 				csr = MUSB_CSR0_H_STATUSPKT
 					| MUSB_CSR0_TXPKTRDY;
 
+			/* disable ping token in status phase */
+			csr |= MUSB_CSR0_H_DIS_PING;
+
 			/* flag status stage */
 			musb->ep0_stage = MUSB_EP0_STATUS;
 
-- 
1.7.5.4

