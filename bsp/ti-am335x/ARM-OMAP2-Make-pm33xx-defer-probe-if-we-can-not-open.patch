From af5f0c9badf37b42ef7150eedf0bfb93b4532b93 Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Thu, 27 Aug 2015 14:21:01 -0500
Subject: [PATCH 541/800] ARM: OMAP2+: Make pm33xx defer probe if we can not
 open rtc0

If rtc_class_open fails on rtc0, defer probe as the rtc device must not
yet be ready.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
[zou: Original patch taken from PROCESSOR-SDK-LINUX-AM335X 02_00_01_07]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 arch/arm/mach-omap2/pm33xx.c |   10 +++++++++-
 1 files changed, 9 insertions(+), 1 deletions(-)

diff --git a/arch/arm/mach-omap2/pm33xx.c b/arch/arm/mach-omap2/pm33xx.c
index d7019cc..e7ff42e 100644
--- a/arch/arm/mach-omap2/pm33xx.c
+++ b/arch/arm/mach-omap2/pm33xx.c
@@ -328,6 +328,11 @@ static int am33xx_pm_rtc_setup(void)
 
 	if (of_device_is_available(np)) {
 		omap_rtc = rtc_class_open("rtc0");
+		if (!omap_rtc) {
+			pr_warn("PM: rtc0 not available");
+			return -EPROBE_DEFER;
+		}
+
 		rtc_read_scratch(omap_rtc, RTC_SCRATCH_MAGIC_REG,
 				 &rtc_magic_val);
 
@@ -375,7 +380,10 @@ static int am33xx_pm_probe(struct platform_device *pdev)
 	if (ret)
 		return ret;
 
-	am33xx_pm_rtc_setup();
+	ret = am33xx_pm_rtc_setup();
+	if (ret)
+		return ret;
+
 	am33xx_push_sram_idle();
 
 	am33xx_pm_set_ipc_ops();
-- 
1.7.5.4

