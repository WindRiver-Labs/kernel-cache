From f05419c3baee2a62fd943c152b446069d99a33f3 Mon Sep 17 00:00:00 2001
From: Tomi Valkeinen <tomi.valkeinen@ti.com>
Date: Fri, 29 May 2015 11:06:07 +0300
Subject: [PATCH 090/800] drm: omapdrm: if omap_plane_atomic_update fails,
 disable plane

commit 794a65ffba77f63ecfc7d23ca6406cc23deab202 upstream

omap_plane_atomic_update() calls dispc_ovl_setup(), which can fail (but
shouldn't). To make the code a bit more robust, make sure the plane gets
disabled if dispc_ovl_setup() fails, as otherwise we might get illegal
HW configuration leading to error interrupts.

Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ti.com>
Acked-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
---
 drivers/gpu/drm/omapdrm/omap_plane.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

diff --git a/drivers/gpu/drm/omapdrm/omap_plane.c b/drivers/gpu/drm/omapdrm/omap_plane.c
index b13fb2f..cfa8276 100644
--- a/drivers/gpu/drm/omapdrm/omap_plane.c
+++ b/drivers/gpu/drm/omapdrm/omap_plane.c
@@ -132,8 +132,10 @@ static void omap_plane_atomic_update(struct drm_plane *plane,
 	/* and finally, update omapdss: */
 	ret = dispc_ovl_setup(omap_plane->id, &info, false,
 			      omap_crtc_timings(state->crtc), false);
-	if (WARN_ON(ret))
+	if (WARN_ON(ret)) {
+		dispc_ovl_enable(omap_plane->id, false);
 		return;
+	}
 
 	dispc_ovl_enable(omap_plane->id, true);
 }
-- 
1.7.5.4

