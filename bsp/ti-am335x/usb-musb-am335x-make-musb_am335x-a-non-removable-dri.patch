From fa057c6de15a7ce335a3c4c4045bd8af0ef8c78f Mon Sep 17 00:00:00 2001
From: Felipe Balbi <balbi@ti.com>
Date: Wed, 8 Jan 2014 18:00:09 -0600
Subject: [PATCH 034/188] usb: musb: am335x: make musb_am335x a non-removable
 driver

This commit comes from branch ti-linux-3.12.y:

git://git.ti.com/ti-linux-kernel/ti-linux-kernel.git

a following patch will allow us to enable musb_am335x
as a dynamically linked module in order to fix a bug
which exists since this driver was first written:

if musb_hdrc was selected as module, musb_am335x would
never be linked to the kernel image.

Now, because of a workaround to a known limitation
on omap_hwmod - namely, lack of reference counting - we
were forced add this "virtual" musb_am335x module just so
we had a single location where usb_otg_hs subsystem would
be enabled.

Because of that, PHYs and both MUSB instances are a child
of this virtual device. Because of that bogus parent
relationship, when we try to rmmod musb_am335x, it will
iterate over all its children and remove their struct
devices from driver core.

This would cause a problem because musb would try to
call usb_phy_shutdown() on a phy pointer which had long
ago being unregistered, since the PHY is a child of
musb_am335x.

In order to avoid this new regression (grrr) we are making
musb_am335x a non-removable module and everybody will be
happy.

Signed-off-by: Felipe Balbi <balbi@ti.com>
(cherry picked from commit 78e6f4e73238470903ad035394066270b7a53e8a)
---
 drivers/usb/musb/musb_am335x.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/drivers/usb/musb/musb_am335x.c b/drivers/usb/musb/musb_am335x.c
index 8be9b02..3c93d24 100644
--- a/drivers/usb/musb/musb_am335x.c
+++ b/drivers/usb/musb/musb_am335x.c
@@ -50,6 +50,10 @@ static struct platform_driver am335x_child_driver = {
 	},
 };
 
-module_platform_driver(am335x_child_driver);
+static int __init am335x_child_init(void)
+{
+	return platform_driver_register(&am335x_child_driver);
+}
+module_init(am335x_child_init);
 MODULE_DESCRIPTION("AM33xx child devices");
 MODULE_LICENSE("GPL v2");
-- 
1.7.5.4

