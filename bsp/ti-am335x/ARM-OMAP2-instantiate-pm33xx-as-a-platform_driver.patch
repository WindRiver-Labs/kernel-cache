From dd90f891160f3721c1b5dce8c90ee261c656750f Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Thu, 27 Aug 2015 14:21:02 -0500
Subject: [PATCH 542/800] ARM: OMAP2+: instantiate pm33xx as a platform_driver

Using a method similar to cpufreq, instantiate pm33xx as a platform
driver so we can properly probe automatically and defer if necessary.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
[zou: Original patch taken from PROCESSOR-SDK-LINUX-AM335X 02_00_01_07]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 arch/arm/mach-omap2/io.c |    2 ++
 arch/arm/mach-omap2/pm.c |    8 ++++++++
 arch/arm/mach-omap2/pm.h |    2 ++
 3 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-omap2/io.c b/arch/arm/mach-omap2/io.c
index 926b348..5ddaa1d 100644
--- a/arch/arm/mach-omap2/io.c
+++ b/arch/arm/mach-omap2/io.c
@@ -656,6 +656,7 @@ void __init am33xx_init_late(void)
 {
 	am33xx_opp_init();
 	omap_common_late_init();
+	amx3_common_pm_init();
 }
 #endif
 
@@ -681,6 +682,7 @@ void __init am43xx_init_late(void)
 	am43xx_opp_init();
 	omap_common_late_init();
 	omap2_clk_enable_autoidle_all();
+	amx3_common_pm_init();
 }
 #endif
 
diff --git a/arch/arm/mach-omap2/pm.c b/arch/arm/mach-omap2/pm.c
index a362953..d753d8f 100644
--- a/arch/arm/mach-omap2/pm.c
+++ b/arch/arm/mach-omap2/pm.c
@@ -286,6 +286,14 @@ static inline void omap_init_cpufreq(void)
 	platform_device_register_full(&devinfo);
 }
 
+void __init amx3_common_pm_init(void)
+{
+	struct platform_device_info devinfo = { };
+
+	devinfo.name = "pm33xx";
+	platform_device_register_full(&devinfo);
+}
+
 static int __init omap2_common_pm_init(void)
 {
 	if (!of_have_populated_dt())
diff --git a/arch/arm/mach-omap2/pm.h b/arch/arm/mach-omap2/pm.h
index 8d31e06..3600087 100644
--- a/arch/arm/mach-omap2/pm.h
+++ b/arch/arm/mach-omap2/pm.h
@@ -205,10 +205,12 @@ static inline int omap4_twl_init(void)
 extern void omap_pm_setup_oscillator(u32 tstart, u32 tshut);
 extern void omap_pm_get_oscillator(u32 *tstart, u32 *tshut);
 extern void omap_pm_setup_sr_i2c_pcb_length(u32 mm);
+void amx3_common_pm_init(void);
 #else
 static inline void omap_pm_setup_oscillator(u32 tstart, u32 tshut) { }
 static inline void omap_pm_get_oscillator(u32 *tstart, u32 *tshut) { *tstart = *tshut = 0; }
 static inline void omap_pm_setup_sr_i2c_pcb_length(u32 mm) { }
+static inline void amx3_common_pm_init(void) { }
 #endif
 
 #ifdef CONFIG_SUSPEND
-- 
1.7.5.4

