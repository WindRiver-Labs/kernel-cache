From cb12b39aab0bf4626cc369e62f329f9a5557cdbf Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Wed, 16 Sep 2015 11:13:00 -0500
Subject: [PATCH 566/800] rtc: omap: Always populate omap_rtc_power_off_rtc

Currently, certain functions inside rtc-omap, like omap_rtc_read_scratch,
depend on omap_rtc_power_off_rtc to be set, which currently only gets
set if the rtc has been labeled as system-power-controller. However,
some platforms, like am335x-evmsk, do not set this flag for the rtc, but
the PM code still calls omap_rtc_read_scratch to see if RTC modes are
supported.

Always populate omap_rtc_read_scratch to account for platforms like this
so that portions of PM can still properly be enabled even if the RTC is
not set up to control the PMIC.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
[zou: Original patch taken from PROCESSOR-SDK-LINUX-AM335X 02_00_01_07]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/rtc/rtc-omap.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/rtc/rtc-omap.c b/drivers/rtc/rtc-omap.c
index e275e5d..9c5bc34 100644
--- a/drivers/rtc/rtc-omap.c
+++ b/drivers/rtc/rtc-omap.c
@@ -727,9 +727,10 @@ static int omap_rtc_probe(struct platform_device *pdev)
 
 	device_init_wakeup(&pdev->dev, true);
 
+	omap_rtc_power_off_rtc = rtc;
+
 	if (rtc->is_pmic_controller) {
 		if (!pm_power_off) {
-			omap_rtc_power_off_rtc = rtc;
 			pm_power_off = omap_rtc_power_off;
 		}
 	}
-- 
1.7.5.4

