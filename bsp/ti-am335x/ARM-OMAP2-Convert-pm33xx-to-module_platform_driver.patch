From d15c30e446378e333e8093a482de268b2ca7e0c9 Mon Sep 17 00:00:00 2001
From: Dave Gerlach <d-gerlach@ti.com>
Date: Thu, 27 Aug 2015 14:21:00 -0500
Subject: [PATCH 540/800] ARM: OMAP2+: Convert pm33xx to
 module_platform_driver

Convert pm33xx to use module_platform_driver and give it a proper probe
function so we can have the module auto probe and also properly defer in
cases where modules we depend on have not yet loaded.

Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
[zou: Original patch taken from PROCESSOR-SDK-LINUX-AM335X 02_00_01_07]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 arch/arm/mach-omap2/pm33xx.c |   18 ++++++++++++++----
 1 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/arch/arm/mach-omap2/pm33xx.c b/arch/arm/mach-omap2/pm33xx.c
index c358ed6..d7019cc 100644
--- a/arch/arm/mach-omap2/pm33xx.c
+++ b/arch/arm/mach-omap2/pm33xx.c
@@ -22,6 +22,7 @@
 #include <linux/io.h>
 #include <linux/module.h>
 #include <linux/of.h>
+#include <linux/platform_device.h>
 #include <linux/sizes.h>
 #include <linux/suspend.h>
 #include <linux/ti-emif-sram.h>
@@ -344,7 +345,7 @@ static int am33xx_pm_rtc_setup(void)
 	return 0;
 }
 
-int am33xx_pm_init(void)
+static int am33xx_pm_probe(struct platform_device *pdev)
 {
 	int ret;
 
@@ -398,14 +399,23 @@ int am33xx_pm_init(void)
 	return 0;
 }
 
-void am33xx_pm_exit(void)
+static int am33xx_pm_remove(struct platform_device *pdev)
 {
 	suspend_set_ops(NULL);
 	gen_pool_free(sram_pool, ocmcram_location, *pm_sram->do_wfi_sz);
+	return 0;
 }
 
-late_initcall(am33xx_pm_init);
-module_exit(am33xx_pm_exit);
+static struct platform_driver am33xx_pm_driver = {
+	.driver = {
+		.name   = "pm33xx",
+	},
+	.probe = am33xx_pm_probe,
+	.remove = am33xx_pm_remove,
+};
+
+module_platform_driver(am33xx_pm_driver);
 
+MODULE_ALIAS("platform:pm33xx");
 MODULE_LICENSE("GPL v2");
 MODULE_DESCRIPTION("am33xx power management driver");
-- 
1.7.5.4

