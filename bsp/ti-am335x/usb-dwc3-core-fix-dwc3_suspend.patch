From dd03ef07f2bdd4a3e466b0b976555d8c1e256d06 Mon Sep 17 00:00:00 2001
From: Felipe Balbi <balbi@ti.com>
Date: Tue, 3 Nov 2015 14:36:36 -0600
Subject: [PATCH 631/800] usb: dwc3: core: fix dwc3_suspend()

during suspend (more specifically, dwc3_gadget_suspend()),
we will still issue commands that might generate an IRQ and,
consequently, try to write to our event buffers. Because
of that, we can't clear our event buffers before gadget
suspend returns.

Signed-off-by: Felipe Balbi <balbi@ti.com>
Signed-off-by: Sekhar Nori <nsekhar@ti.com>
[zou: Original patch taken from PROCESSOR-SDK-LINUX-AM335X 02_00_01_07]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/usb/dwc3/core.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/usb/dwc3/core.c b/drivers/usb/dwc3/core.c
index c843157..9728e3f 100644
--- a/drivers/usb/dwc3/core.c
+++ b/drivers/usb/dwc3/core.c
@@ -1647,8 +1647,6 @@ static int dwc3_suspend(struct device *dev)
 		dwc3_otg_mask_irq(dwc);
 	}
 
-	dwc3_event_buffers_cleanup(dwc);
-
 	dwc->gctl = dwc3_readl(dwc->regs, DWC3_GCTL);
 
 	switch (dwc->dr_mode) {
@@ -1674,6 +1672,8 @@ static int dwc3_suspend(struct device *dev)
 		/* nothing */
 		break;
 	}
+
+	dwc3_event_buffers_cleanup(dwc);
 	spin_unlock_irqrestore(&dwc->lock, flags);
 
 	usb_phy_shutdown(dwc->usb3_phy);
-- 
1.7.5.4

