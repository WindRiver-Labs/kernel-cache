From 1be527f2fa23b6fe06e7c413fa89010425d454a8 Mon Sep 17 00:00:00 2001
From: Kishon Vijay Abraham I <kishon@ti.com>
Date: Mon, 24 Aug 2015 15:45:17 +0530
Subject: [PATCH 512/800] mmc: core: sdio: claim host before power up or power
 off

mmc_sdio_runtime_resume and mmc_sdio_runtime_suspend does power up and
power off respectively but does so without claiming the host. Among other
things mmc_claim_host inovkes pm_runtime_get_sync to enable the clocks.
Invoke mmc_claim_host before mmc_power_up and mmc_power_off in
mmc_sdio_runtime_resume and mmc_sdio_runtime_suspend respectively.

This is required since certain platforms (like TI SoCs) access
the controller registers during power up.

Signed-off-by: Kishon Vijay Abraham I <kishon@ti.com>
Signed-off-by: Sekhar Nori <nsekhar@ti.com>
[zou: Original patch taken from PROCESSOR-SDK-LINUX-AM335X 02_00_01_07]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/mmc/core/sdio.c |   10 +++++++++-
 1 files changed, 9 insertions(+), 1 deletions(-)

diff --git a/drivers/mmc/core/sdio.c b/drivers/mmc/core/sdio.c
index 122cb34..5d34114 100644
--- a/drivers/mmc/core/sdio.c
+++ b/drivers/mmc/core/sdio.c
@@ -1023,16 +1023,24 @@ static int mmc_sdio_power_restore(struct mmc_host *host)
 
 static int mmc_sdio_runtime_suspend(struct mmc_host *host)
 {
+	mmc_claim_host(host);
 	/* No references to the card, cut the power to it. */
 	mmc_power_off(host);
+	mmc_release_host(host);
 	return 0;
 }
 
 static int mmc_sdio_runtime_resume(struct mmc_host *host)
 {
+	int ret;
+
+	mmc_claim_host(host);
 	/* Restore power and re-initialize. */
 	mmc_power_up(host, host->card->ocr);
-	return mmc_sdio_power_restore(host);
+	ret = _mmc_sdio_power_restore(host);
+	mmc_release_host(host);
+
+	return ret;
 }
 
 static const struct mmc_bus_ops mmc_sdio_ops = {
-- 
1.7.5.4

