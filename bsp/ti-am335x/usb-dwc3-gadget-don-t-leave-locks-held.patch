From fc41f734d26db35e48e95af0e9dde06f410c116b Mon Sep 17 00:00:00 2001
From: Felipe Balbi <balbi@ti.com>
Date: Tue, 25 Aug 2015 12:21:16 -0500
Subject: [PATCH 507/800] usb: dwc3: gadget: don't leave locks held

prevent a lock leak by making sure it's disabled
in the error path.

Signed-off-by: Felipe Balbi <balbi@ti.com>
Signed-off-by: Sekhar Nori <nsekhar@ti.com>
[zou: Original patch taken from PROCESSOR-SDK-LINUX-AM335X 02_00_01_07]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/usb/dwc3/gadget.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.c
index fc846be..556260b 100644
--- a/drivers/usb/dwc3/gadget.c
+++ b/drivers/usb/dwc3/gadget.c
@@ -1564,6 +1564,7 @@ try:
 		ret = dwc3_device_reinit(dwc);
 		if (ret) {
 			dev_err(dwc->dev, "device reinit failed\n");
+			spin_unlock_irqrestore(&dwc->lock, flags);
 			return ret;
 		}
 
@@ -1572,6 +1573,7 @@ try:
 		ret = dwc3_gadget_restart(dwc);
 		if (ret) {
 			dev_err(dwc->dev, "failed to re-init gadget\n");
+			spin_unlock_irqrestore(&dwc->lock, flags);
 			return ret;
 		}
 
-- 
1.7.5.4

