From c9eb970ed75e4f74d80ba58415e61bf033fb67a1 Mon Sep 17 00:00:00 2001
From: Felipe Balbi <balbi@ti.com>
Date: Tue, 3 Nov 2015 14:36:37 -0600
Subject: [PATCH 632/800] usb: dwc3: gadget: reinitialize endpoints on suspend

We know the controller will just loose all of its
context and completely forget about any pending transfers.

This means we can just reinitialize the endpoints
and on resume everything works as expected.

Signed-off-by: Felipe Balbi <balbi@ti.com>
Signed-off-by: Sekhar Nori <nsekhar@ti.com>
[zou: Original patch taken from PROCESSOR-SDK-LINUX-AM335X 02_00_01_07]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/usb/dwc3/gadget.c |   13 +++++++++++++
 1 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.c
index ace0951..615aa47 100644
--- a/drivers/usb/dwc3/gadget.c
+++ b/drivers/usb/dwc3/gadget.c
@@ -2936,6 +2936,9 @@ void dwc3_gadget_exit(struct dwc3 *dwc)
 
 int dwc3_gadget_suspend(struct dwc3 *dwc)
 {
+	int num_endpoints = dwc->num_in_eps + dwc->num_out_eps;
+	int i;
+
 	if (!dwc->gadget_driver)
 		return 0;
 
@@ -2944,6 +2947,16 @@ int dwc3_gadget_suspend(struct dwc3 *dwc)
 		dwc3_gadget_run_stop(dwc, true, true);
 	}
 
+	for (i = 0; i < num_endpoints; i++) {
+		struct dwc3_ep *dep = dwc->eps[i];
+
+		if (!dep)
+			continue;
+
+		dep->resource_index = 0;
+		dep->flags &= ~DWC3_EP_BUSY;
+	}
+
 	__dwc3_gadget_ep_disable(dwc->eps[0]);
 	__dwc3_gadget_ep_disable(dwc->eps[1]);
 
-- 
1.7.5.4

