From 0620e8bae323025bcd05f7d73520580a0f3a61ac Mon Sep 17 00:00:00 2001
From: Kishon Vijay Abraham I <kishon@ti.com>
Date: Mon, 30 Nov 2015 14:26:13 +0530
Subject: [PATCH 740/800] mmc: host: omap_hsmmc: increase the timeout value
 given for sw timeout

Increase the timeout value given for sw timeout to a high value
(3 times the value requested by card). During the experiments, it
was observed that the eMMC card on DRA72x EVM advertised 960ms as
timeout but the (worst case) transfer complete came after 2.6 seconds.

The additional delay is to account for the start time of the transfer,
IO timings and card advertising incorrect timeout values. Also add a
minimum timeout value of 20ms so that we don't timeout unnecessarily.

Signed-off-by: Kishon Vijay Abraham I <kishon@ti.com>
[nsekhar@ti.com: massage commit text]
Signed-off-by: Sekhar Nori <nsekhar@ti.com>
[zou: Original patch taken from PROCESSOR-SDK-LINUX-AM335X 02_00_01_07]
Signed-off-by: zou cao <cao.zou@windriver.com>
---
 drivers/mmc/host/omap_hsmmc.c |   15 +++++++++------
 1 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/drivers/mmc/host/omap_hsmmc.c b/drivers/mmc/host/omap_hsmmc.c
index 4cdb03e..09c9d00 100644
--- a/drivers/mmc/host/omap_hsmmc.c
+++ b/drivers/mmc/host/omap_hsmmc.c
@@ -168,7 +168,6 @@
 #define ACNE	(1 << 0)
 
 #define MMC_AUTOSUSPEND_DELAY	100
-#define MMC_SOFT_TIMER_SLACK	1000000		/* ns */
 #define MMC_TIMEOUT_MS		20		/* 20 mSec */
 #define MMC_TIMEOUT_US		20000		/* 20000 micro Sec */
 #define OMAP_MMC_MIN_CLOCK	400000
@@ -1621,12 +1620,16 @@ static void set_data_timeout(struct omap_hsmmc_host *host,
 
 		/*
 		 * We should really be using just timeout_ns + delta,
-		 * however we have no control over when DMA will
-		 * actually start transferring; due to that we will add
-		 * an extra slack to make sure we don't expire too
-		 * early.
+		 * however during the experiments observed that the transfer
+		 * complete happens after really long time (roughly 3 times
+		 * of the advertised timeout value). With the eMMC card in
+		 * DRA72 EVM, the card advertised 960ms but the (worst case)
+		 * transfer complete came after 2.6 seconds.
 		 */
-		host->data_timeout = timeout_ns + delta + MMC_SOFT_TIMER_SLACK;
+		host->data_timeout = 3 * (timeout_ns + delta);
+		if (host->data_timeout < MMC_TIMEOUT_MS)
+			host->data_timeout = MMC_TIMEOUT_MS;
+
 		return;
 	}
 
-- 
1.7.5.4

