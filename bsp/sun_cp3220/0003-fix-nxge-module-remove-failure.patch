From 421b8fec648cdaf50719c29709e4ed0a3dbff02c Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Fri, 31 Oct 2008 16:48:49 +0800
Subject: [PATCH] fix nxge module remove failure

When nxgep->statsp's memory space is released, nxgep->statsp's member
stats_size should be unavailable. Refering to the released memory is
incorrect. Generally there is no obvious phenomenon in standard kernel.
But in cgl kernel there is strict checking mechanism and when remove
module nxge.ko it trigger off memory checking and this make rmmod
failing.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
Signed-off-by: Fei Wu <fei.wu@windriver.com>
---
 drivers/net/nxge/nxge_main.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/drivers/net/nxge/nxge_main.c b/drivers/net/nxge/nxge_main.c
index 9a76a65..753780f 100644
--- a/drivers/net/nxge/nxge_main.c
+++ b/drivers/net/nxge/nxge_main.c
@@ -672,8 +672,8 @@ nxge_destroy_stats(p_nxge_t nxgep)
 	NXGE_DEBUG_MSG((nxgep, MOD_CTL, "==> nxge_destroy_stats"));
 
 	if (nxgep->statsp) {
-		KMEM_FREE(nxgep->statsp, nxgep->statsp->stats_size);
 		KMEM_FREE(nxgep->old_statsp, nxgep->statsp->stats_size);
+		KMEM_FREE(nxgep->statsp, nxgep->statsp->stats_size);
 	}
 	NXGE_DEBUG_MSG((nxgep, MOD_CTL, "<== nxge_destroy_stats"));
 }
-- 
1.6.0.90.g436ed

