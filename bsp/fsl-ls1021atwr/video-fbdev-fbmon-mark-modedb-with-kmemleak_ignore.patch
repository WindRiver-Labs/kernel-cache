From fb49f75e4e157a8f3d1f3ed8b35b350bf1cc5364 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Sat, 19 Aug 2017 13:13:49 +0800
Subject: [PATCH 3/3] video: fbdev: fbmon: mark modedb with kmemleak_ignore()

modedb will be freed in async mode by fb_destroy_modedb, so we mark
it as kmemleak_ignore here to avoid the following:

unreferenced object 0xbea3b800 (size 2048):
  comm "swapper/0", pid 1, jiffies 4294937795 (age 3427.650s)
  hex dump (first 32 bytes):
    00 00 00 00 3b 00 00 00 90 06 00 00 1a 04 00 00  ....;...........
    b5 1a 00 00 18 01 00 00 68 00 00 00 1e 00 00 00  ........h.......
  backtrace:
    [<801bce88>] __kmalloc+0x3c4/0x5e8
    [<804cc8ec>] fb_edid_add_monspecs+0x1d0/0x3cc
    [<804d217c>] sii902x_get_edid+0x1cc/0x1d8
    [<804d2570>] sii902x_probe+0x17c/0x330
    [<8062e790>] i2c_device_probe+0x108/0x150
    [<805235b4>] driver_probe_device+0x184/0x2c4
    [<805237e4>] __driver_attach+0x9c/0xa0
    [<805216f4>] bus_for_each_dev+0x78/0xac
    [<80522fbc>] driver_attach+0x2c/0x30
    [<80522c20>] bus_add_driver+0x15c/0x204
    [<80524a40>] driver_register+0x88/0x108
    [<8062f628>] i2c_register_driver+0x40/0x8c
    [<80c71b94>] sii902x_i2c_driver_init+0x1c/0x20
    [<800097c0>] do_one_initcall+0x9c/0x1e8
    [<80c3f020>] kernel_init_freeable+0x294/0x36c
    [<80910c48>] kernel_init+0x1c/0xf8

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/video/fbdev/core/fbmon.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/video/fbdev/core/fbmon.c b/drivers/video/fbdev/core/fbmon.c
index 01ef1b95..be842e5 100644
--- a/drivers/video/fbdev/core/fbmon.c
+++ b/drivers/video/fbdev/core/fbmon.c
@@ -1061,6 +1061,7 @@ void fb_edid_add_monspecs(unsigned char *edid, struct fb_monspecs *specs)
 	if (!m)
 		return;
 
+	kmemleak_ignore(m);
 	memcpy(m, specs->modedb, specs->modedb_len * sizeof(struct fb_videomode));
 
 	for (i = specs->modedb_len; i < specs->modedb_len + num; i++) {
-- 
2.9.3

