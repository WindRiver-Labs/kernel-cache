From 1ee6d41d6425d02792a1fca54fa2d538f4b50265 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Fri, 14 Jul 2017 11:19:19 +0800
Subject: [PATCH 4/5] fbdev: fsl-dcu-fb: fix memory leakage

fb_dealloc_cmap should release the memory when failure, so does
unmap_video_memory.

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/video/fbdev/fsl-dcu-fb.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/drivers/video/fbdev/fsl-dcu-fb.c b/drivers/video/fbdev/fsl-dcu-fb.c
index 5f6c061..a7f3d7a 100644
--- a/drivers/video/fbdev/fsl-dcu-fb.c
+++ b/drivers/video/fbdev/fsl-dcu-fb.c
@@ -867,13 +867,16 @@ static int install_framebuffer(struct fb_info *info)
 	info->flags = FBINFO_FLAG_DEFAULT;
 	info->pseudo_palette = &mfbi->pseudo_palette;
 
-	fb_alloc_cmap(&info->cmap, 16, 0);
+	if (ret = fb_alloc_cmap(&info->cmap, 16, 0))
+		return ret;
 
 	INIT_LIST_HEAD(&info->modelist);
 
 	ret = fsl_dcu_init_fbinfo(info);
-	if (ret)
+	if (ret) {
+		fb_dealloc_cmap(&info->cmap);
 		return ret;
+	}
 
 	modelist = list_first_entry(&info->modelist,
 			struct fb_modelist, list);
@@ -883,6 +886,8 @@ static int install_framebuffer(struct fb_info *info)
 	ret = register_framebuffer(info);
 	if (ret < 0) {
 		dev_err(dcufb->dev, "failed to register framebuffer device\n");
+		unmap_video_memory(info);
+		fb_dealloc_cmap(&info->cmap);
 		return ret;
 	}
 
-- 
2.9.3

