From befc0501be6f488d32885a9b32f0ba9111026167 Mon Sep 17 00:00:00 2001
From: Zumeng Chen <zumeng.chen@windriver.com>
Date: Fri, 14 Jul 2017 09:06:46 +0800
Subject: [PATCH 1/5] fb: sii902x: fix memory leakage

kfree(edid) needs to be done before return.

unreferenced object 0xbdb6d480 (size 128):
  comm "swapper/0", pid 1, jiffies 4294937793 (age 546.240s)
  hex dump (first 32 bytes):
    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
  backtrace:
    [<801bcdb0>] kmem_cache_alloc_trace+0x3c4/0x5bc
    [<804d1184>] sii902x_get_edid+0xd4/0x1dc
    [<804d1630>] sii902x_probe+0x17c/0x330
    [<8062d758>] i2c_device_probe+0x108/0x150
    [<8052257c>] driver_probe_device+0x184/0x2c4
    [<805227ac>] __driver_attach+0x9c/0xa0
    [<805206bc>] bus_for_each_dev+0x78/0xac
    [<80521f84>] driver_attach+0x2c/0x30
    [<80521be8>] bus_add_driver+0x15c/0x204
    [<80523a08>] driver_register+0x88/0x108
    [<8062e5f0>] i2c_register_driver+0x40/0x8c
    [<80c95f60>] sii902x_i2c_driver_init+0x1c/0x20
    [<800097c0>] do_one_initcall+0x9c/0x1e8
    [<80c63020>] kernel_init_freeable+0x294/0x36c
    [<8090fbb8>] kernel_init+0x1c/0xf8
    [<8000fe28>] ret_from_fork+0x14/0x2c

Signed-off-by: Zumeng Chen <zumeng.chen@windriver.com>
---
 drivers/video/fbdev/fsl-sii902x.c | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/drivers/video/fbdev/fsl-sii902x.c b/drivers/video/fbdev/fsl-sii902x.c
index 9375219..31be41b 100644
--- a/drivers/video/fbdev/fsl-sii902x.c
+++ b/drivers/video/fbdev/fsl-sii902x.c
@@ -204,7 +204,7 @@ static int __sii902x_get_edid(struct i2c_adapter *adp,
 
 	ret = __sii902x_read_edid(adp, edid, buf);
 	if (ret)
-		return ret;
+		goto free_edid;
 
 	/* edid first block parsing */
 	memset(&fbi->monspecs, 0, sizeof(fbi->monspecs));
@@ -216,13 +216,14 @@ static int __sii902x_get_edid(struct i2c_adapter *adp,
 		buf[0] = 0x80;
 		ret = __sii902x_read_edid(adp, edid, buf);
 		if (ret)
-			return ret;
+			goto free_edid;
 
 		fb_edid_add_monspecs(edid, &fbi->monspecs);
 	}
 
+free_edid:
 	kfree(edid);
-	return 0;
+	return ret;
 }
 static int sii902x_get_edid(struct fb_info *fbi)
 {
-- 
2.9.3

