From 20c860103ecb3b771b187e65c27bbd47822d0c90 Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Wed, 24 Mar 2010 15:52:22 +0800
Subject: [PATCH] Fix a bug of Comcerto100's sys_timer offset function

Use the systimer_mark to check if the current-count register was reloaded since
the last timer interrupt.

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 arch/arm/mach-comcerto/comcerto-100.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/arch/arm/mach-comcerto/comcerto-100.c b/arch/arm/mach-comcerto/comcerto-100.c
index b722e77..2404e63 100644
--- a/arch/arm/mach-comcerto/comcerto-100.c
+++ b/arch/arm/mach-comcerto/comcerto-100.c
@@ -521,6 +521,8 @@ unsigned long comcerto_gettimeoffset(void)
 	unsigned long delta;
 
 	delta = comcerto_timer1_get();
+	if(delta < systimer_mark)
+		delta += COMCERTO_KERNEL_TIMER_VALUE;
 	return machinecycles_to_usecs(delta);
 }
 
-- 
1.6.0.4

