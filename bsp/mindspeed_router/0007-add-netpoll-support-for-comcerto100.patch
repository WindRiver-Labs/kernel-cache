From 283e0eea0642c0ae80ac1afa6f6c3833b8f849d0 Mon Sep 17 00:00:00 2001
From: Stanley.Miao <stanley.miao@windriver.com>
Date: Thu, 30 Oct 2008 20:59:18 +0800
Subject: [PATCH] add netpoll support for comcerto100

Enable netpoll for the ethernet device so that it can function properly with
KGDBoE.

Signed-off-by: Stanley Miao <stanley.miao@windriver.com>
---
 drivers/net/comcerto/comcerto_eth.c |   15 +++++++++++++++
 1 files changed, 15 insertions(+), 0 deletions(-)

diff --git a/drivers/net/comcerto/comcerto_eth.c b/drivers/net/comcerto/comcerto_eth.c
index 8521835..9ce5e1b 100644
--- a/drivers/net/comcerto/comcerto_eth.c
+++ b/drivers/net/comcerto/comcerto_eth.c
@@ -90,6 +90,9 @@ extern void comcerto_emac_restart_tx(struct eth_priv *priv);
 extern irqreturn_t comcerto_gemac_interrupt(int irq, void *dev_id);
 extern void comcerto_gemac_setduplex(struct net_device *dev, int duplex);
 extern void comcerto_gemac_setspeed(struct net_device *dev, int speed);
+#ifdef CONFIG_NET_POLL_CONTROLLER
+static void comcerto_eth_poll_controller(struct net_device *dev);
+#endif
 
 extern void comcerto_init_sysfs(struct net_device *dev);
 
@@ -1552,6 +1555,14 @@ irqreturn_t comcerto_eth_interrupt(int irq, void *dev_id)
 	return IRQ_HANDLED;
 }
 
+#ifdef CONFIG_NET_POLL_CONTROLLER
+static void comcerto_eth_poll_controller(struct net_device *dev)
+{
+	disable_irq(dev->irq);
+	comcerto_eth_interrupt(dev->irq, dev);
+	enable_irq(dev->irq);
+}
+#endif
 
 static int comcerto_eth_probe(struct platform_device *pdev)
 {
@@ -1672,6 +1683,10 @@ static int comcerto_eth_probe(struct platform_device *pdev)
 	/* Enable most messages by default */
 	priv->msg_enable = (NETIF_MSG_IFUP << 1) - 1;
 
+#ifdef CONFIG_NET_POLL_CONTROLLER
+	dev->poll_controller = comcerto_eth_poll_controller;
+#endif
+
 	err = register_netdev(dev);
 
 	if (err) {
-- 
1.6.0.90.g436ed

