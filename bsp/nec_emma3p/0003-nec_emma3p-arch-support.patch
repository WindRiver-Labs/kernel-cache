From 490114dba3484e41850b4f5b68ecea18e7dc909a Mon Sep 17 00:00:00 2001
From: Chunbo Luo <chunbo.luo@windriver.com>
Date: Thu, 11 Sep 2008 15:34:58 +0800
Subject: [PATCH] nec_emma3p: arch support

Add MIPS R9721 support for nec_emma3p

Signed-off-by: Jack Tan <jack.tan@windriver.com>
Signed-off-by: Chunbo Luo <chunbo.luo@windriver.com>
---
 arch/mips/Kconfig            |   40 ++++++++++++++++++++++++++++++++++++++++
 arch/mips/Makefile           |   15 +++++++++++++++
 arch/mips/kernel/Makefile    |    1 +
 arch/mips/kernel/cpu-probe.c |    9 +++++++++
 arch/mips/kernel/traps.c     |   16 ++++++++++++++++
 arch/mips/lib/Makefile       |    1 +
 arch/mips/lib/dump_tlb.c     |    4 ++++
 arch/mips/mm/Makefile        |    1 +
 arch/mips/mm/c-r4k.c         |   14 ++++++++++++++
 arch/mips/mm/tlbex.c         |    1 +
 include/asm-mips/bootinfo.h  |    5 +++++
 include/asm-mips/cpu.h       |    3 ++-
 include/asm-mips/mipsregs.h  |    3 +++
 include/asm-mips/module.h    |    2 ++
 14 files changed, 114 insertions(+), 1 deletions(-)

diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index b537307..3cd01b3 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -312,6 +312,22 @@ config PMC_YOSEMITE
 	  Yosemite is an evaluation board for the RM9000x2 processor
 	  manufactured by PMC-Sierra.
 
+config ET10068
+	bool "Support for NEC EMMA3P ET10068"
+	select CEVT_R4K
+	select CSRC_R4K
+	select DMA_NONCOHERENT
+	select HW_HAS_PCI
+	select IRQ_CPU
+	select SYS_SUPPORTS_32BIT_KERNEL
+	select SYS_SUPPORTS_BIG_ENDIAN
+	select SYS_HAS_CPU_MIPS32_R1
+	select SYS_HAS_CPU_R9721
+	select SYS_R4K_CVET_HWTIMER
+	help
+	  This enables support for the R5432-based NEC ET10068
+	  boards with VR5500 CPU.
+
 config SGI_IP22
 	bool "SGI IP22 (Indy/Indigo2)"
 	select ARC
@@ -876,6 +892,16 @@ config EMMA2RH
 	depends on MARKEINS
 	default y
 
+config EMMA3P
+	bool
+	depends on ET10068
+	default y
+
+config EMMA_SUBCPU
+	bool "use SUB CPU(MIPS 4KEc)"
+	depends on ET10068 || CPU_MIPS32
+	default n
+
 config SERIAL_RM9000
 	bool
 
@@ -1127,6 +1153,13 @@ config CPU_R8000
 	  MIPS Technologies R8000 processors.  Note these processors are
 	  uncommon and the support for them is incomplete.
 
+config CPU_R9721
+	bool "R9721"
+	depends on SYS_HAS_CPU_R9721
+	select CPU_HAS_PREFETCH
+	select CPU_SUPPORTS_32BIT_KERNEL
+	select CPU_SUPPORTS_64BIT_KERNEL
+
 config CPU_R10000
 	bool "R10000"
 	depends on SYS_HAS_CPU_R10000
@@ -1216,6 +1249,9 @@ config SYS_HAS_CPU_NEVADA
 config SYS_HAS_CPU_R8000
 	bool
 
+config SYS_HAS_CPU_R9721
+	bool
+
 config SYS_HAS_CPU_R10000
 	bool
 
@@ -1365,6 +1401,10 @@ config RM7000_CPU_SCACHE
 	bool
 	select BOARD_SCACHE
 
+config R9721_CPU_SCACHE
+	bool
+	select BOARD_SCACHE
+
 config SIBYTE_DMA_PAGEOPS
 	bool "Use DMA to clear/copy pages"
 	depends on CPU_SB1
diff --git a/arch/mips/Makefile b/arch/mips/Makefile
index df2c7f4..f7a703d 100644
--- a/arch/mips/Makefile
+++ b/arch/mips/Makefile
@@ -131,6 +131,11 @@ cflags-$(CONFIG_CPU_MIPS64_R2)	+= $(call cc-option,-march=mips64r2,-mips64r2 -U_
 cflags-$(CONFIG_CPU_R5000)	+= -march=r5000 -Wa,--trap
 cflags-$(CONFIG_CPU_R5432)	+= $(call cc-option,-march=r5400,-march=r5000) \
 			-Wa,--trap
+
+cflags-$(CONFIG_CPU_R9721)	+= \
+			$(call set_gccflags,vr5500,mips4,r5000,mips4,mips2) \
+			-Wa,--trap
+
 cflags-$(CONFIG_CPU_NEVADA)	+= $(call cc-option,-march=rm5200,-march=r5000) \
 			-Wa,--trap
 cflags-$(CONFIG_CPU_RM7000)	+= $(call cc-option,-march=rm7000,-march=r5000) \
@@ -408,6 +413,16 @@ cflags-$(CONFIG_EMMA2RH)        += -Iinclude/asm-mips/mach-emma2rh
 core-$(CONFIG_MARKEINS)         += arch/mips/emma2rh/markeins/
 load-$(CONFIG_MARKEINS)         += 0xffffffff88100000
 
+# NEC EMMA3P boards
+#
+core-$(CONFIG_EMMA3P)		+= arch/mips/emma3p/common/
+cflags-$(CONFIG_EMMA3P)	+= -Iinclude/asm-mips/mach-emma3p
+
+# NEC EMMA3P ET10068
+core-$(CONFIG_ET10068)		+= arch/mips/emma3p/et10068/
+load-$(CONFIG_ET10068)		+= 0xffffffff80040000
+all-$(CONFIG_ET10068)		:= uImage
+
 #
 # SGI IP22 (Indy/Indigo2)
 #
diff --git a/arch/mips/kernel/Makefile b/arch/mips/kernel/Makefile
index d507f57..441b48d 100644
--- a/arch/mips/kernel/Makefile
+++ b/arch/mips/kernel/Makefile
@@ -33,6 +33,7 @@ obj-$(CONFIG_CPU_R5000)		+= r4k_fpu.o r4k_switch.o
 obj-$(CONFIG_CPU_R6000)		+= r6000_fpu.o r4k_switch.o
 obj-$(CONFIG_CPU_R5432)		+= r4k_fpu.o r4k_switch.o
 obj-$(CONFIG_CPU_R8000)		+= r4k_fpu.o r4k_switch.o
+obj-$(CONFIG_CPU_R9721)		+= r4k_fpu.o r4k_switch.o
 obj-$(CONFIG_CPU_RM7000)	+= r4k_fpu.o r4k_switch.o
 obj-$(CONFIG_CPU_RM9000)	+= r4k_fpu.o r4k_switch.o
 obj-$(CONFIG_CPU_NEVADA)	+= r4k_fpu.o r4k_switch.o
diff --git a/arch/mips/kernel/cpu-probe.c b/arch/mips/kernel/cpu-probe.c
index 335a6ae..8233a04 100644
--- a/arch/mips/kernel/cpu-probe.c
+++ b/arch/mips/kernel/cpu-probe.c
@@ -152,6 +152,7 @@ static inline void check_wait(void)
 	case CPU_R4650:
 	case CPU_R4700:
 	case CPU_R5000:
+	case CPU_R9721:
 	case CPU_NEVADA:
 	case CPU_4KC:
 	case CPU_4KEC:
@@ -455,6 +456,13 @@ static inline void cpu_probe_legacy(struct cpuinfo_mips *c)
 		             MIPS_CPU_WATCH | MIPS_CPU_LLSC;
 		c->tlbsize = 48;
 		break;
+	case PRID_IMP_R9721:
+		c->cputype = CPU_R9721;
+		c->isa_level = MIPS_CPU_ISA_IV;
+		c->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |
+		             MIPS_CPU_WATCH | MIPS_CPU_LLSC;
+		c->tlbsize = 64;
+		break;
 	case PRID_IMP_NEVADA:
 		c->cputype = CPU_NEVADA;
 		c->isa_level = MIPS_CPU_ISA_IV;
@@ -902,6 +910,7 @@ static __cpuinit const char *cpu_to_name(struct cpuinfo_mips *c)
 	case CPU_BCM4710:	name = "Broadcom BCM4710"; break;
 	case CPU_PR4450:	name = "Philips PR4450"; break;
 	case CPU_LOONGSON2:	name = "ICT Loongson-2"; break;
+	case CPU_R9721:		name = "R9721"; break;
 	default:
 		BUG();
 	}
diff --git a/arch/mips/kernel/traps.c b/arch/mips/kernel/traps.c
index 780d254..28411f7 100644
--- a/arch/mips/kernel/traps.c
+++ b/arch/mips/kernel/traps.c
@@ -840,6 +840,7 @@ asmlinkage void do_cpu(struct pt_regs *regs)
 	unsigned int opcode;
 	unsigned int cpid;
 	int status;
+	struct cpuinfo_mips *c = &current_cpu_data;
 
 	trace_mark(kernel_arch_trap_entry, "trap_id %lu ip #p%ld",
 		CAUSE_EXCCODE(regs->cp0_cause), instruction_pointer(regs));
@@ -901,6 +902,21 @@ asmlinkage void do_cpu(struct pt_regs *regs)
 
 	case 2:
 	case 3:
+		if (c->cputype == CPU_R9721) {
+			epc = (unsigned int __user *)exception_epc(regs);
+			opcode = 0;
+
+			if (unlikely(compute_return_epc(regs) < 0)) {
+				trace_mark(kernel_arch_trap_exit, MARK_NOARGS);
+				return;
+			}
+
+			if (unlikely(get_user(opcode, epc) < 0))
+				force_sig(SIGSEGV, current);
+
+ 			if (!simulate_rdhwr(regs, opcode))
+ 				return;
+		}
 		break;
 	}
 
diff --git a/arch/mips/lib/Makefile b/arch/mips/lib/Makefile
index 8810dfb..90005a2 100644
--- a/arch/mips/lib/Makefile
+++ b/arch/mips/lib/Makefile
@@ -20,6 +20,7 @@ obj-$(CONFIG_CPU_R5000)		+= dump_tlb.o
 obj-$(CONFIG_CPU_R5432)		+= dump_tlb.o
 obj-$(CONFIG_CPU_R6000)		+=
 obj-$(CONFIG_CPU_R8000)		+=
+obj-$(CONFIG_CPU_R9721)		+= dump_tlb.o
 obj-$(CONFIG_CPU_RM7000)	+= dump_tlb.o
 obj-$(CONFIG_CPU_RM9000)	+= dump_tlb.o
 obj-$(CONFIG_CPU_SB1)		+= dump_tlb.o
diff --git a/arch/mips/lib/dump_tlb.c b/arch/mips/lib/dump_tlb.c
index 465ff0e..b9c58a0 100644
--- a/arch/mips/lib/dump_tlb.c
+++ b/arch/mips/lib/dump_tlb.c
@@ -26,6 +26,10 @@ static inline const char *msk2str(unsigned int mask)
 	case PM_64M:	return "64Mb";
 	case PM_256M:	return "256Mb";
 #endif
+#ifdef CONFIG_CPU_R9721
+	case PM_1G:
+		return "1Gb";
+#endif
 	}
 	return "";
 }
diff --git a/arch/mips/mm/Makefile b/arch/mips/mm/Makefile
index 44e8dd8..b32bf7a 100644
--- a/arch/mips/mm/Makefile
+++ b/arch/mips/mm/Makefile
@@ -19,6 +19,7 @@ obj-$(CONFIG_CPU_R4300)		+= c-r4k.o cex-gen.o tlb-r4k.o
 obj-$(CONFIG_CPU_R4X00)		+= c-r4k.o cex-gen.o tlb-r4k.o
 obj-$(CONFIG_CPU_R5000)		+= c-r4k.o cex-gen.o tlb-r4k.o
 obj-$(CONFIG_CPU_R5432)		+= c-r4k.o cex-gen.o tlb-r4k.o
+obj-$(CONFIG_CPU_R9721)		+= c-r4k.o cex-gen.o pg-r4k.o tlb-r4k.o
 obj-$(CONFIG_CPU_R8000)		+= c-r4k.o cex-gen.o tlb-r8k.o
 obj-$(CONFIG_CPU_RM7000)	+= c-r4k.o cex-gen.o tlb-r4k.o
 obj-$(CONFIG_CPU_RM9000)	+= c-r4k.o cex-gen.o tlb-r4k.o
diff --git a/arch/mips/mm/c-r4k.c b/arch/mips/mm/c-r4k.c
index 6e99665..8f52ad4 100644
--- a/arch/mips/mm/c-r4k.c
+++ b/arch/mips/mm/c-r4k.c
@@ -763,6 +763,20 @@ static void __cpuinit probe_pcache(void)
 		c->options |= MIPS_CPU_CACHE_CDEX_P;
 		break;
 
+	case CPU_R9721:
+		icache_size = 1 << (12 + ((config & CONF_IC) >> 9));
+		c->icache.linesz = 16 << ((config & CONF_IB) >> 5);
+		c->icache.ways = 4;
+		c->icache.waybit = 0;
+
+		dcache_size = 1 << (12 + ((config & CONF_DC) >> 6));
+		c->dcache.linesz = 16 << ((config & CONF_DB) >> 4);
+		c->dcache.ways = 4;
+		c->dcache.waybit = 0;
+
+		c->options |= MIPS_CPU_CACHE_CDEX_P;
+		break;
+
 	case CPU_TX49XX:
 		icache_size = 1 << (12 + ((config & CONF_IC) >> 9));
 		c->icache.linesz = 16 << ((config & CONF_IB) >> 5);
diff --git a/arch/mips/mm/tlbex.c b/arch/mips/mm/tlbex.c
index 979cf91..79da5a0 100644
--- a/arch/mips/mm/tlbex.c
+++ b/arch/mips/mm/tlbex.c
@@ -307,6 +307,7 @@ static void __cpuinit build_tlb_write_entry(u32 **p, struct uasm_label **l,
 	case CPU_R10000:
 	case CPU_R12000:
 	case CPU_R14000:
+	case CPU_R9721:
 	case CPU_4KC:
 	case CPU_4KEC:
 	case CPU_SB1:
diff --git a/include/asm-mips/bootinfo.h b/include/asm-mips/bootinfo.h
index 610fe3a..93ca74a 100644
--- a/include/asm-mips/bootinfo.h
+++ b/include/asm-mips/bootinfo.h
@@ -41,6 +41,11 @@
 #define  MACH_DS5900		10	/* DECsystem 5900		*/
 
 /*
+ * Valid machtype for group NEC EMMA3P
+ */
+#define  MACH_NEC_ET10068	0		/* NEC EMMA3P ET10068	*/
+
+/*
  * Valid machtype for group PMC-MSP
  */
 #define MACH_MSP4200_EVAL       0	/* PMC-Sierra MSP4200 Evaluation */
diff --git a/include/asm-mips/cpu.h b/include/asm-mips/cpu.h
index 229a786..c6a640f 100644
--- a/include/asm-mips/cpu.h
+++ b/include/asm-mips/cpu.h
@@ -69,6 +69,7 @@
 #define PRID_IMP_LOONGSON1	0x4200
 #define PRID_IMP_R5432		0x5400
 #define PRID_IMP_R5500		0x5500
+#define PRID_IMP_R9721		0x5600
 #define PRID_IMP_LOONGSON2	0x6300
 
 #define PRID_IMP_UNKNOWN	0xff00
@@ -202,7 +203,7 @@ enum cpu_type_enum {
 	/*
 	 * MIPS64 class processors
 	 */
-	CPU_5KC, CPU_20KC, CPU_25KF, CPU_SB1, CPU_SB1A, CPU_LOONGSON2,
+	CPU_5KC, CPU_20KC, CPU_25KF, CPU_SB1, CPU_SB1A, CPU_LOONGSON2, CPU_R9721,
 
 	CPU_LAST
 };
diff --git a/include/asm-mips/mipsregs.h b/include/asm-mips/mipsregs.h
index ed76004..171b402 100644
--- a/include/asm-mips/mipsregs.h
+++ b/include/asm-mips/mipsregs.h
@@ -192,6 +192,9 @@
 #define PM_16M		0x01ffe000
 #define PM_64M		0x07ffe000
 #define PM_256M		0x1fffe000
+#ifdef CONFIG_CPU_R9721
+#define PM_1G		0x7FFFE000
+#endif
 
 #endif
 
diff --git a/include/asm-mips/module.h b/include/asm-mips/module.h
index de6d09e..578d8b0 100644
--- a/include/asm-mips/module.h
+++ b/include/asm-mips/module.h
@@ -104,6 +104,8 @@ search_module_dbetables(unsigned long addr)
 #define MODULE_PROC_FAMILY "NEVADA "
 #elif defined CONFIG_CPU_R8000
 #define MODULE_PROC_FAMILY "R8000 "
+#elif defined CONFIG_CPU_R9721
+#define MODULE_PROC_FAMILY "R9721"
 #elif defined CONFIG_CPU_R10000
 #define MODULE_PROC_FAMILY "R10000 "
 #elif defined CONFIG_CPU_RM7000
-- 
1.5.5.1

