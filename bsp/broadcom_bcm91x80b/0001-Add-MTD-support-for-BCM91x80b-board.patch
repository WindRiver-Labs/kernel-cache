From 1e0a2c391437bd915b02d760faa10c3d37566904 Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Fri, 12 Sep 2008 15:12:48 +0800
Subject: [PATCH] Add MTD support for BCM91x80b board

16MB boot flash exists on the board, so add MTD support.

Signed-off-by: Yang Shi <yang.shi@windriver.com>
Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/mips/sibyte/bcm1480/Makefile      |    1 +
 arch/mips/sibyte/bcm1480/bcm1480_mtd.c |   71 ++++++++++++++++++++++++++++++++
 2 files changed, 72 insertions(+), 0 deletions(-)
 create mode 100644 arch/mips/sibyte/bcm1480/bcm1480_mtd.c

diff --git a/arch/mips/sibyte/bcm1480/Makefile b/arch/mips/sibyte/bcm1480/Makefile
index 9b24415..5986540 100644
--- a/arch/mips/sibyte/bcm1480/Makefile
+++ b/arch/mips/sibyte/bcm1480/Makefile
@@ -1,5 +1,6 @@
 obj-y := setup.o irq.o time.o
 
 obj-$(CONFIG_SMP)			+= smp.o
+obj-$(CONFIG_MTD)			+= bcm1480_mtd.o
 
 #EXTRA_CFLAGS += -Werror
diff --git a/arch/mips/sibyte/bcm1480/bcm1480_mtd.c b/arch/mips/sibyte/bcm1480/bcm1480_mtd.c
new file mode 100644
index 0000000..00d9eec
--- /dev/null
+++ b/arch/mips/sibyte/bcm1480/bcm1480_mtd.c
@@ -0,0 +1,71 @@
+/*
+ * This file is subject to the terms and conditions of the GNU General Public
+ * License.  See the file "COPYING" in the main directory of this archive
+ * for more details.
+ *
+ * Copyright (C) 2007 Wind River Systems, Inc.
+ *     Written by Yang Shi <yang.shi@windriver.com>
+ */
+
+#include <linux/init.h>
+#include <linux/platform_device.h>
+#include <linux/mtd/partitions.h>
+#include <linux/mtd/physmap.h>
+#include <mtd/mtd-abi.h>
+#include <asm/sibyte/bcm1480_regs.h>
+#include <asm/sibyte/sb1250.h>
+
+/* The measure unit for x is MB */
+#define CS0_SIZE(x) (((x) << 4) - 1)
+
+static struct mtd_partition bcm1480_mtd_partitions[] = {
+	{
+		.name =		"bootloader",
+		.offset =	0x0,
+		.size =		0x400000,
+		.mask_flags =	MTD_WRITEABLE
+	},
+	{
+		.name =		"User FS",
+		.offset =	0x400000,
+		.size =		0xc00000
+	}
+};
+
+static struct physmap_flash_data bcm1480_flash_data = {
+	.width		= 1,
+	.nr_parts	= ARRAY_SIZE(bcm1480_mtd_partitions),
+	.parts		= bcm1480_mtd_partitions
+};
+
+static struct resource bcm1480_flash_resource = {
+	.start		= 0x1fc00000,
+	.end		= 0x20bfffff,
+	.flags		= IORESOURCE_MEM
+};
+
+static struct platform_device bcm1480_flash = {
+	.name		= "physmap-flash",
+	.id		= 0,
+	.dev		= {
+		.platform_data	= &bcm1480_flash_data,
+	},
+	.num_resources	= 1,
+	.resource	= &bcm1480_flash_resource,
+};
+
+static int __init bcm1480_mtd_init(void)
+{
+	u64 cs0_size_reg;
+
+	/* The original size of bank cs0 is limited to 4MB, so adjust
+	 * it to 16MB to make use of 16MB boot flash.
+	 */
+	cs0_size_reg = __raw_readq(IOADDR(A_IO_EXT_REG(0x100)));
+	cs0_size_reg = (cs0_size_reg & (~(u64)0x0fff)) | CS0_SIZE(16);
+	 __raw_writeq(cs0_size_reg, IOADDR(A_IO_EXT_REG(0x100)));
+	platform_device_register(&bcm1480_flash);
+	return 0;
+}
+
+module_init(bcm1480_mtd_init)
-- 
1.5.5.1

