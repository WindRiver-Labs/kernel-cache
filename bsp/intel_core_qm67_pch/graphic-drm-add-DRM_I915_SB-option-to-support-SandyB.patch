From 06724761028db2cf59fe7031de52a09dbe4d0990 Mon Sep 17 00:00:00 2001
From: Guoqing Jiang <Guoqing.Jiang@windriver.com>
Date: Sun, 23 Jan 2011 14:00:04 +0800
Subject: [PATCH 04/11] graphic/drm: add DRM_I915_SB option to support SandyBridge's graphic.

To avoid impacting other platforms, add DRM_I915_SB config
option for SandyBridge graphic support, use it to make
distinction between SandyBridge and other platforms, and
control compile target.

Signed-off-by: Guoqing Jiang <Guoqing.Jiang@windriver.com>
---
 drivers/gpu/drm/Kconfig  |    7 +++++++
 drivers/gpu/drm/Makefile |   20 ++++++++++++++++----
 2 files changed, 23 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/Kconfig b/drivers/gpu/drm/Kconfig
index 305c590..baeb17c 100644
--- a/drivers/gpu/drm/Kconfig
+++ b/drivers/gpu/drm/Kconfig
@@ -114,6 +114,13 @@ config DRM_I915
 	  XFree86 4.4 and above. If unsure, build this and i830 as modules and
 	  the X server will load the correct one.
 
+config DRM_I915_SB
+	tristate "i915 driver for SandyBridge"
+	depends on DRM_I915
+	default n
+	help
+	  Choose this option if you want to support intel's SandyBridge chip.
+
 config DRM_I915_KMS
 	bool "Enable modesetting on intel by default"
 	depends on DRM_I915
diff --git a/drivers/gpu/drm/Makefile b/drivers/gpu/drm/Makefile
index abe3f44..e3907d3 100644
--- a/drivers/gpu/drm/Makefile
+++ b/drivers/gpu/drm/Makefile
@@ -4,18 +4,30 @@
 
 ccflags-y := -Iinclude/drm
 
-drm-y       :=	drm_auth.o drm_buffer.o drm_bufs.o drm_cache.o \
+drm-core :=	drm_auth.o drm_buffer.o drm_bufs.o drm_cache.o \
 		drm_context.o drm_dma.o drm_drawable.o \
 		drm_drv.o drm_fops.o drm_gem.o drm_ioctl.o drm_irq.o \
 		drm_lock.o drm_memory.o drm_proc.o drm_stub.o drm_vm.o \
 		drm_agpsupport.o drm_scatter.o ati_pcigart.o drm_pci.o \
-		drm_sysfs.o drm_hashtab.o drm_sman.o drm_mm.o \
-		drm_crtc.o drm_modes.o drm_edid.o \
+		drm_sysfs.o drm_hashtab.o drm_sman.o \
+		drm_crtc.o drm_modes.o \
 		drm_info.o drm_debugfs.o drm_encoder_slave.o
 
+ifndef CONFIG_DRM_I915_SB
+drm-y := $(drm-core) drm_mm.o drm_edid.o
+else
+drm-y := $(drm-core) drm_mm_gen6.o drm_edid_gen6.o \
+	  drm_global.o drm_platform.o
+endif
+
 drm-$(CONFIG_COMPAT) += drm_ioc32.o
 
-drm_kms_helper-y := drm_fb_helper.o drm_crtc_helper.o drm_dp_i2c_helper.o
+drm_kms_helper-core := drm_crtc_helper.o drm_dp_i2c_helper.o
+ifndef CONFIG_DRM_I915_SB
+drm_kms_helper-y := $(drm_kms_helper-core) drm_fb_helper.o
+else
+drm_kms_helper-y := $(drm_kms_helper-core) drm_fb_helper_gen6.o
+endif
 
 obj-$(CONFIG_DRM_KMS_HELPER) += drm_kms_helper.o
 
-- 
1.6.5.2

