From 05432e80cb88ae2990b049ef2dcddc75c9b9a0d4 Mon Sep 17 00:00:00 2001
From: Andrei Dolnikov <adolnikov@embeddedalley.com>
Date: Wed, 3 Dec 2008 20:42:30 +0300
Subject: [PATCH] SPI flash (M25PXX) support for fsl_mpc8360e

Add platform specific code to properly initialize
SPI bus and SPI (M25PXX) flash.

Signed-off-by: Andrei Dolnikov <adolnikov@embeddedalley.com>
Signed-off-by: Bruce Ashfield <bruce.ashfield@windriver.com>
---
 arch/powerpc/boot/dts/mpc836x_mds.dts     |    4 +-
 arch/powerpc/platforms/83xx/mpc836x_mds.c |   61 +++++++++++++++++++++++++++++
 2 files changed, 63 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/boot/dts/mpc836x_mds.dts b/arch/powerpc/boot/dts/mpc836x_mds.dts
index 948ee22..10fb371 100644
--- a/arch/powerpc/boot/dts/mpc836x_mds.dts
+++ b/arch/powerpc/boot/dts/mpc836x_mds.dts
@@ -275,7 +275,7 @@
 			reg = <0x4c0 0x40>;
 			interrupts = <2>;
 			interrupt-parent = <&qeic>;
-			mode = "cpu";
+			mode = "cpu-qe";
 		};
 
 		spi@500 {
@@ -284,7 +284,7 @@
 			reg = <0x500 0x40>;
 			interrupts = <1>;
 			interrupt-parent = <&qeic>;
-			mode = "cpu";
+			mode = "cpu-qe";
 		};
 
 		usb@6c0 {
diff --git a/arch/powerpc/platforms/83xx/mpc836x_mds.c b/arch/powerpc/platforms/83xx/mpc836x_mds.c
index 9d46e5b..aaac63a 100644
--- a/arch/powerpc/platforms/83xx/mpc836x_mds.c
+++ b/arch/powerpc/platforms/83xx/mpc836x_mds.c
@@ -31,6 +31,9 @@
 #include <linux/initrd.h>
 #include <linux/of_platform.h>
 #include <linux/of_device.h>
+#include <linux/spi/spi.h>
+#include <linux/spi/flash.h>
+#include <linux/mtd/partitions.h>
 
 #include <asm/system.h>
 #include <asm/atomic.h>
@@ -57,6 +60,64 @@
 
 static u8 *bcsr_regs = NULL;
 
+#ifdef CONFIG_SPI
+static struct mtd_partition mpc836x_spi_flash_partitions[] = {
+	{
+		.name = "SPI Flash",
+		.size = MTDPART_SIZ_FULL,
+		.offset = 0,
+	},
+};
+
+static struct flash_platform_data mpc836x_spi_flash_data = {
+	.name = "m25p80",
+	.parts = mpc836x_spi_flash_partitions,
+	.nr_parts = ARRAY_SIZE(mpc836x_spi_flash_partitions),
+	.type = "m25p80",
+};
+
+static void mpc83xx_spi_activate_cs(u8 cs, u8 polarity)
+{
+	par_io_data_set(4, 31, polarity);
+}
+
+static void mpc83xx_spi_deactivate_cs(u8 cs, u8 polarity)
+{
+	par_io_data_set(4, 31, !polarity);
+}
+
+static struct spi_board_info mpc836x_spi_boardinfo[] = {
+	{
+		.bus_num = 0x4c0,
+		.chip_select = 0,
+		.max_speed_hz = 250000,
+		.modalias = "mpc83xx_spi",
+	},
+	{
+		.modalias = "m25p80",
+		.max_speed_hz = 250000,
+		.bus_num = 0x4c0,
+		.chip_select = 1,
+		.platform_data = &mpc836x_spi_flash_data,
+	},
+};
+
+static int __init mpc836x_spi_init(void)
+{
+	par_io_config_pin(4, 28, 3, 0, 3, 0); /* SPI1MOSI */
+	par_io_config_pin(4, 29, 3, 0, 3, 0); /* SPI1MISO */
+	par_io_config_pin(4, 30, 3, 0, 3, 0); /* SPI1CLK */
+	par_io_config_pin(4, 31, 1, 0, 0, 0); /* !SD_CS, O */
+
+	return fsl_spi_init(mpc836x_spi_boardinfo,
+			    ARRAY_SIZE(mpc836x_spi_boardinfo),
+			    mpc83xx_spi_activate_cs,
+			    mpc83xx_spi_deactivate_cs);
+}
+
+machine_device_initcall(mpc836x_mds, mpc836x_spi_init);
+#endif /* CONFIG_SPI */
+
 /* ************************************************************************
  *
  * Setup the architecture
-- 
1.6.0.2.GIT

