From 0de2e66d7d57ff0f020161dc9cd550820d4ccc62 Mon Sep 17 00:00:00 2001
From: Andrei Dolnikov <adolnikov@embeddedalley.com>
Date: Wed, 17 Dec 2008 20:13:55 +0300
Subject: [PATCH] usb/fsl_qe_udc: clear data toggle on clear halt request

link:	http://git.kernel.org/?p=linux/kernel/git/gregkh/usb-2.6.git;a=commit;h=15d5a9acb1df1e22a7ba60aaaad758d9d71e5ea7
git:	git://git.kernel.org/pub/scm/linux/kernel/git/gregkh/usb-2.6.git
commit id: 15d5a9acb1df1e22a7ba60aaaad758d9d71e5ea7

[
 Fix to comply with USB spec.

 Signed-off-by: Li Yang <leoli@freescale.com>
 Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
]

Integrated-by: Andrei Dolnikov <adolnikov@embeddedalley.com>
---
 drivers/usb/gadget/fsl_qe_udc.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/gadget/fsl_qe_udc.c b/drivers/usb/gadget/fsl_qe_udc.c
index d9aad68..1fe8b44 100644
--- a/drivers/usb/gadget/fsl_qe_udc.c
+++ b/drivers/usb/gadget/fsl_qe_udc.c
@@ -1815,6 +1815,10 @@ static int qe_ep_set_halt(struct usb_ep *_ep, int value)
 		udc->ep0_state = WAIT_FOR_SETUP;
 		udc->ep0_dir = 0;
 	}
+
+	/* set data toggle to DATA0 on clear halt */
+	if (value == 0)
+		ep->data01 = 0;
 out:
 	dev_vdbg(udc->dev, "%s %s halt stat %d\n", ep->ep.name,
 			value ?  "set" : "clear", status);
-- 
1.6.0.2.GIT

