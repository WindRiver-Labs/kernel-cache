From efe0723456f9e5ec9a368d92cadcce7a9e0240ab Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Thu, 14 Apr 2011 10:53:11 +0800
Subject: [PATCH 4/4] fsl_mpc8360e: fixed spinlock recursion issue

we can get the following spinlock bug report when we enable the
spinlock debug option:

BUG: spinlock recursion on CPU#0, irq/16-qe timer/299
 lock: cecd5b20, .magic: dead4ead, .owner: irq/16-qe timer/299, .owner_cpu: 0

Call Trace:
[cec91cb0] [c000891c] show_stack+0x50/0x160 (unreliable)
[cec91ce0] [c02e7a20] spin_bug+0x94/0xc8
[cec91d00] [c02e7cac] do_raw_spin_lock+0x12c/0x154
[cec91d30] [c04b83f8] _raw_spin_lock_irqsave+0x30/0x48
[cec91d40] [d317a8a8] fhci_irq+0x20/0x2c8 [fhci]
[cec91d60] [c03777e8] usb_hcd_irq+0x50/0xc8
[cec91d80] [c009c76c] handle_irq_action+0x80/0x94
[cec91da0] [c009c830] handle_IRQ_event+0xb0/0x304
[cec91df0] [c009f2e0] handle_level_irq+0xac/0x15c
[cec91e10] [c002f29c] qe_ic_cascade_low_ipic+0x3c/0x50
[cec91e20] [c0006510] native_do_IRQ+0x98/0xb4
[cec91e40] [c0005274] do_IRQ+0x10/0x20
[cec91e50] [c0015ba0] ret_from_except+0x0/0x14
---
 drivers/usb/host/fhci-hcd.c |    5 +++++
 1 files changed, 5 insertions(+), 0 deletions(-)

diff --git a/drivers/usb/host/fhci-hcd.c b/drivers/usb/host/fhci-hcd.c
index 15379c6..823e71c 100644
--- a/drivers/usb/host/fhci-hcd.c
+++ b/drivers/usb/host/fhci-hcd.c
@@ -686,8 +686,13 @@ static int __devinit of_fhci_probe(struct of_device *ofdev,
 		goto err_get_timer;
 	}
 
+#ifdef CONFIG_PREEMPT_HARDIRQS
+	ret = request_irq(fhci->timer->irq, fhci_frame_limit_timer_irq,
+			  IRQF_DISABLED | IRQF_NODELAY, "qe timer (usb)", hcd);
+#else
 	ret = request_irq(fhci->timer->irq, fhci_frame_limit_timer_irq,
 			  IRQF_DISABLED, "qe timer (usb)", hcd);
+#endif
 	if (ret) {
 		dev_err(dev, "failed to request timer irq");
 		goto err_timer_irq;
-- 
1.7.0.4

