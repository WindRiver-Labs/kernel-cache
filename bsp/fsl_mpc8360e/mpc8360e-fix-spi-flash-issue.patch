From 3bfd9c3cdc1d0823353a170900e8ce2a61ff4da6 Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Wed, 27 Jul 2011 16:25:32 +0800
Subject: [PATCH 3/4] mpc8360e: fix spi flash issue

add the spi flash dtb node and add the related support code.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/powerpc/boot/dts/mpc836x_mds.dts     |   15 +++++++++++++++
 arch/powerpc/platforms/83xx/mpc836x_mds.c |    3 +++
 drivers/of/base.c                         |    1 +
 drivers/spi/spi_fsl_spi.c                 |    6 +++++-
 4 files changed, 24 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/boot/dts/mpc836x_mds.dts b/arch/powerpc/boot/dts/mpc836x_mds.dts
index 5a298ff..29387b3 100644
--- a/arch/powerpc/boot/dts/mpc836x_mds.dts
+++ b/arch/powerpc/boot/dts/mpc836x_mds.dts
@@ -370,7 +370,22 @@
 			reg = <0x4c0 0x40>;
 			interrupts = <2>;
 			interrupt-parent = <&qeic>;
+			gpios = <&qe_pio_b 31 0>;
 			mode = "cpu-qe";
+
+			m25p80@0 {
+				compatible = "spi-flash";
+				modal = "m25p40";
+				reg = <0>;
+				spi-max-frequency = <250000>;
+
+								partition@0 {
+										/* 512KB partition */
+										reg = <0x0 0x00080000>;
+										label = "SPI flash";
+								};
+			};
+
 		};
 
 		spi@500 {
diff --git a/arch/powerpc/platforms/83xx/mpc836x_mds.c b/arch/powerpc/platforms/83xx/mpc836x_mds.c
index 78e532a..edff4b8 100644
--- a/arch/powerpc/platforms/83xx/mpc836x_mds.c
+++ b/arch/powerpc/platforms/83xx/mpc836x_mds.c
@@ -212,6 +212,9 @@ static int __init mpc836x_spi_init(void)
 	par_io_config_pin(4, 30, 3, 0, 3, 0); /* SPI1CLK */
 	par_io_config_pin(4, 31, 1, 0, 0, 0); /* !SD_CS, O */
 
+	if (of_find_compatible_node(NULL, NULL, "spi-flash"))
+		return 0;
+
 	return fsl_spi_init(mpc836x_spi_boardinfo,
 			    ARRAY_SIZE(mpc836x_spi_boardinfo),
 			    mpc836x_spi_cs_control);
diff --git a/drivers/of/base.c b/drivers/of/base.c
index 71d26a7..b260e80 100644
--- a/drivers/of/base.c
+++ b/drivers/of/base.c
@@ -571,6 +571,7 @@ static struct of_modalias_table of_modalias_table[] = {
 	{ "fsl,mcu-mpc8349emitx", "mcu-mpc8349emitx" },
 	{ "mmc-spi-slot", "mmc_spi" },
 	{ "fsl,espi-flash", "fsl_m25p80"},
+	{ "spi-flash", "m25p80"},
 };
 
 /**
diff --git a/drivers/spi/spi_fsl_spi.c b/drivers/spi/spi_fsl_spi.c
index 90ff4d3..03e02ca 100644
--- a/drivers/spi/spi_fsl_spi.c
+++ b/drivers/spi/spi_fsl_spi.c
@@ -901,6 +901,9 @@ err:
 
 static void fsl_spi_cs_control(struct spi_device *spi, bool on)
 {
+#ifdef CONFIG_MPC836x_MDS
+	par_io_data_set(4, 31, on);
+#else
 	struct device *dev = spi->dev.parent;
 	struct mpc8xxx_spi_probe_info *pinfo = to_of_pinfo(dev->platform_data);
 	u16 cs = spi->chip_select;
@@ -908,6 +911,7 @@ static void fsl_spi_cs_control(struct spi_device *spi, bool on)
 	bool alow = pinfo->alow_flags[cs];
 
 	gpio_set_value(gpio, on ^ alow);
+#endif
 }
 
 static int of_fsl_spi_get_chipselects(struct device *dev)
@@ -1076,7 +1080,7 @@ static struct of_platform_driver of_fsl_spi_driver = {
 	.remove		= __devexit_p(of_fsl_spi_remove),
 };
 
-#ifdef CONFIG_MPC832x_RDB
+#if defined(CONFIG_MPC832x_RDB) || defined(CONFIG_MPC836x_MDS)
 /*
  * XXX XXX XXX
  * This is "legacy" platform driver, was used by the MPC8323E-RDB boards
-- 
1.7.0.4

