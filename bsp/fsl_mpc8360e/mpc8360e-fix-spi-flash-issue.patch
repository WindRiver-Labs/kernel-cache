From 3bfd9c3cdc1d0823353a170900e8ce2a61ff4da6 Mon Sep 17 00:00:00 2001
From: Jack Tan <jack.tan@windriver.com>
Date: Thu, 14 Apr 2011 17:39:33 +0800
Subject: [PATCH 3/4] mpc8360e: fix spi flash issue

add the spi flash dtb node and add the related support code.

Signed-off-by: Jack Tan <jack.tan@windriver.com>
---
 arch/powerpc/boot/dts/mpc836x_mds.dts     |   15 +++++++++
 arch/powerpc/platforms/83xx/mpc836x_mds.c |    3 ++
 drivers/mtd/devices/m25p80.c              |   49 +++++++++++++++++++++++++++++
 drivers/of/base.c                         |    1 +
 drivers/spi/spi_mpc8xxx.c                 |    6 +++-
 5 files changed, 73 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/boot/dts/mpc836x_mds.dts b/arch/powerpc/boot/dts/mpc836x_mds.dts
index 5a298ff..29387b3 100644
--- a/arch/powerpc/boot/dts/mpc836x_mds.dts
+++ b/arch/powerpc/boot/dts/mpc836x_mds.dts
@@ -370,7 +370,22 @@
 			reg = <0x4c0 0x40>;
 			interrupts = <2>;
 			interrupt-parent = <&qeic>;
+			gpios = <&qe_pio_b 31 0>;
 			mode = "cpu-qe";
+
+			m25p80@0 {
+				compatible = "spi-flash";
+				modal = "m25p40";
+				reg = <0>;
+				spi-max-frequency = <250000>;
+
+								partition@0 {
+										/* 512KB partition */
+										reg = <0x0 0x00080000>;
+										label = "SPI flash";
+								};
+			};
+
 		};
 
 		spi@500 {
diff --git a/arch/powerpc/platforms/83xx/mpc836x_mds.c b/arch/powerpc/platforms/83xx/mpc836x_mds.c
index 78e532a..edff4b8 100644
--- a/arch/powerpc/platforms/83xx/mpc836x_mds.c
+++ b/arch/powerpc/platforms/83xx/mpc836x_mds.c
@@ -212,6 +212,9 @@ static int __init mpc836x_spi_init(void)
 	par_io_config_pin(4, 30, 3, 0, 3, 0); /* SPI1CLK */
 	par_io_config_pin(4, 31, 1, 0, 0, 0); /* !SD_CS, O */
 
+	if (of_find_compatible_node(NULL, NULL, "spi-flash"))
+		return 0;
+
 	return fsl_spi_init(mpc836x_spi_boardinfo,
 			    ARRAY_SIZE(mpc836x_spi_boardinfo),
 			    mpc836x_spi_cs_control);
diff --git a/drivers/mtd/devices/m25p80.c b/drivers/mtd/devices/m25p80.c
index a9d18b4..b110403 100644
--- a/drivers/mtd/devices/m25p80.c
+++ b/drivers/mtd/devices/m25p80.c
@@ -757,6 +757,51 @@ static const struct spi_device_id *__devinit jedec_probe(struct spi_device *spi)
 	return NULL;
 }
 
+/*
+ * parse_flash_partition - Parse the flash partition on the SPI bus
+ * @spi:		Pointer to spi_device device
+ */
+extern const void *of_get_property(const struct device_node *np, const char *name,
+			 int *lenp);
+
+void parse_flash_partition(struct spi_device *spi)
+{
+	struct mtd_partition *parts;
+	struct flash_platform_data *spi_pdata;
+	int nr_parts = 0;
+	static int num_flash;
+	struct device_node *np = spi->dev.archdata.of_node;
+
+	int len;
+	const char *flash_type;
+
+	nr_parts = of_mtd_parse_partitions(&spi->dev, np, &parts);
+	if (!nr_parts)
+		goto end;
+
+	spi_pdata = kzalloc(sizeof(*spi_pdata), GFP_KERNEL);
+	if (!spi_pdata)
+		goto end;
+	spi_pdata->name = kzalloc(10, GFP_KERNEL);
+	if (!spi_pdata->name)
+		goto free_flash;
+	snprintf(spi_pdata->name, 10, "SPIFLASH%d", num_flash++);
+
+	spi_pdata->parts = parts;
+	spi_pdata->nr_parts = nr_parts;
+
+	flash_type = of_get_property(np, "modal", &len);
+	spi_pdata->type = (char *)flash_type;
+
+	spi->dev.platform_data = spi_pdata;
+
+	return;
+
+free_flash:
+	kfree(spi_pdata);
+end:
+	return;
+}
 
 /*
  * board specific setup should have ensured the SPI clock used here
@@ -776,6 +821,10 @@ static int __devinit m25p_probe(struct spi_device *spi)
 	 * a chip ID, try the JEDEC id commands; they'll work for most
 	 * newer chips, even if we don't recognize the particular chip.
 	 */
+#ifdef CONFIG_MPC836x_MDS
+	/* Parse the flash partition */
+	parse_flash_partition(spi);
+#endif
 	data = spi->dev.platform_data;
 	if (data && data->type) {
 		const struct spi_device_id *plat_id;
diff --git a/drivers/of/base.c b/drivers/of/base.c
index 3d0c1c0..d003cd4 100644
--- a/drivers/of/base.c
+++ b/drivers/of/base.c
@@ -572,6 +572,7 @@ static struct of_modalias_table of_modalias_table[] = {
 	{ "fsl,mcu-mpc8349emitx", "mcu-mpc8349emitx" },
 	{ "mmc-spi-slot", "mmc_spi" },
 	{ "fsl,espi-flash", "fsl_m25p80"},
+	{ "spi-flash", "m25p80"},
 };
 
 /**
diff --git a/drivers/spi/spi_mpc8xxx.c b/drivers/spi/spi_mpc8xxx.c
index 2503d59..c5b5f9b 100644
--- a/drivers/spi/spi_mpc8xxx.c
+++ b/drivers/spi/spi_mpc8xxx.c
@@ -1090,6 +1090,9 @@ to_of_pinfo(struct fsl_spi_platform_data *pdata)
 
 static void mpc8xxx_spi_cs_control(struct spi_device *spi, bool on)
 {
+#ifdef CONFIG_MPC836x_MDS
+	par_io_data_set(4, 31, on);
+#else
 	struct device *dev = spi->dev.parent;
 	struct mpc8xxx_spi_probe_info *pinfo = to_of_pinfo(dev->platform_data);
 	u16 cs = spi->chip_select;
@@ -1097,6 +1100,7 @@ static void mpc8xxx_spi_cs_control(struct spi_device *spi, bool on)
 	bool alow = pinfo->alow_flags[cs];
 
 	gpio_set_value(gpio, on ^ alow);
+#endif
 }
 
 static int of_mpc8xxx_spi_get_chipselects(struct device *dev)
@@ -1296,7 +1300,7 @@ static struct of_platform_driver of_mpc8xxx_spi_driver = {
 	.remove		= __devexit_p(of_mpc8xxx_spi_remove),
 };
 
-#ifdef CONFIG_MPC832x_RDB
+#if defined(CONFIG_MPC832x_RDB) || defined(CONFIG_MPC836x_MDS)
 /*
  * 				XXX XXX XXX
  * This is "legacy" platform driver, was used by the MPC8323E-RDB boards
-- 
1.7.0.4

