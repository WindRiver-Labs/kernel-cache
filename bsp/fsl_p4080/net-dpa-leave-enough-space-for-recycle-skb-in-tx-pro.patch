From 6d651d560cfb5a84280d6e68a7c2d44cee756df3 Mon Sep 17 00:00:00 2001
From: Zhang Xiao <xiao.zhang@windriver.com>
Date: Thu, 5 Jan 2012 14:10:20 +0800
Subject: [PATCH] net/dpa: leave enough space for recycle skb in tx process

For skb maybe recycled, enough space should be left for rx frame. Count in the
cache_fudge offset to make it. Fix a little bug in DAM mapping.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 drivers/net/dpa/dpaa_eth.c |   10 +++++++---
 1 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/drivers/net/dpa/dpaa_eth.c b/drivers/net/dpa/dpaa_eth.c
index 3769ea3..35d9ffd 100644
--- a/drivers/net/dpa/dpaa_eth.c
+++ b/drivers/net/dpa/dpaa_eth.c
@@ -1218,6 +1218,7 @@ static int __hot dpa_tx(struct sk_buff *skb, struct net_device *net_dev)
 	int err;
 	int cache_fudge;
 	int needed_headroom;
+	int len;
 
 	priv = netdev_priv(net_dev);
 	percpu_priv = per_cpu_ptr(priv->percpu_priv, raw_smp_processor_id());
@@ -1270,7 +1271,9 @@ static int __hot dpa_tx(struct sk_buff *skb, struct net_device *net_dev)
 		goto l3_l4_csum_failed;
 	}
 
-	addr = dma_map_single(dpa_bp->dev, skbh, dpa_bp->size, DMA_TO_DEVICE);
+	/* Add tailroom for skb maybe recycled */
+	len = headroom - cache_fudge + skb->len + skb_tailroom(skb);
+	addr = dma_map_single(dpa_bp->dev, skbh, len, DMA_TO_DEVICE);
 	if (unlikely(addr == 0)) {
 		if (netif_msg_tx_err(priv)  && net_ratelimit())
 			cpu_netdev_err(net_dev, "dma_map_single() failed\n");
@@ -1288,7 +1291,8 @@ static int __hot dpa_tx(struct sk_buff *skb, struct net_device *net_dev)
 		fd.cmd |= FM_FD_CMD_UPD;
 #endif
 
-	if (likely(skb_is_recycleable(skb, dpa_bp->skb_size)
+	/* Count in cache_fudge to leave enough space for rx */
+	if (likely(skb_is_recycleable(skb, dpa_bp->skb_size + cache_fudge)
 			&& (*percpu_priv->dpa_bp_count + 1 <= dpa_bp->count))) {
 		fd.cmd |= FM_FD_CMD_FCO;
 		fd.bpid = dpa_bp->bpid;
@@ -1311,7 +1315,7 @@ static int __hot dpa_tx(struct sk_buff *skb, struct net_device *net_dev)
 	return NETDEV_TX_OK;
 
 xmit_failed:
-	dma_unmap_single(dev, addr, dpa_bp->size, DMA_TO_DEVICE);
+	dma_unmap_single(dev, addr, len, DMA_TO_DEVICE);
 l3_l4_csum_failed:
 dma_map_failed:
 	if (skb)
-- 
1.7.0.4

