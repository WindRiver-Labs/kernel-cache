From 179cde73e7e976b3c3f5623d734b1069570f69a9 Mon Sep 17 00:00:00 2001
From: Emil Medve <Emilian.Medve@Freescale.com>
Date: Thu, 24 Sep 2009 22:47:03 -0500
Subject: [PATCH] P4080/DPA: MAC-less interfaces don't have a PHY

This fixes a kernel panic for Ethernet interfaces without a MAC.

Signed-off-by: Emil Medve <Emilian.Medve@Freescale.com>
[Kevin: Original patch taken from Freescale p4080 SDK 2.0 ISO image.
Apply cleanly to kernel 2.6.27]
Integrated-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/dpa/dpa-ethtool.c |   30 ++++++++++++++++++++++++++++++
 1 files changed, 30 insertions(+), 0 deletions(-)

diff --git a/drivers/net/dpa/dpa-ethtool.c b/drivers/net/dpa/dpa-ethtool.c
index 598a738..a5cb87a 100644
--- a/drivers/net/dpa/dpa-ethtool.c
+++ b/drivers/net/dpa/dpa-ethtool.c
@@ -49,6 +49,12 @@ static int __cold dpa_get_settings(struct net_device *net_dev, struct ethtool_cm
 		return -ENODEV;
     }
 
+	if (priv->mac_dev == NULL) {
+		cpu_netdev_info(net_dev,
+				"%s:%hu:%s(): This is a MAC-less interface\n",
+				__file__, __LINE__, __func__);
+		return -ENODEV;
+	}
 	if (unlikely(priv->mac_dev->phy_dev == NULL)) {
 		cpu_netdev_err(net_dev, "%s:%hu:%s(): phy device not initialized\n",
 			       __file__, __LINE__, __func__);
@@ -80,6 +86,12 @@ static int __cold dpa_set_settings(struct net_device *net_dev, struct ethtool_cm
 		return -ENODEV;
     }
 
+	if (priv->mac_dev == NULL) {
+		cpu_netdev_info(net_dev,
+				"%s:%hu:%s(): This is a MAC-less interface\n",
+				__file__, __LINE__, __func__);
+		return -ENODEV;
+	}
 	if (unlikely(priv->mac_dev->phy_dev == NULL)) {
 		cpu_netdev_err(net_dev, "%s:%hu:%s(): phy device not initialized\n",
 			       __file__, __LINE__, __func__);
@@ -159,6 +171,12 @@ int __cold dpa_nway_reset(struct net_device *net_dev)
 		return -ENODEV;
     }
 
+	if (priv->mac_dev == NULL) {
+		cpu_netdev_info(net_dev,
+				"%s:%hu:%s(): This is a MAC-less interface\n",
+				__file__, __LINE__, __func__);
+		return -ENODEV;
+	}
 	if (unlikely(priv->mac_dev->phy_dev == NULL)) {
 		cpu_netdev_err(net_dev, "%s:%hu:%s(): phy device not initialized\n",
 			       __file__, __LINE__, __func__);
@@ -209,6 +227,12 @@ void __cold dpa_get_pauseparam(struct net_device *net_dev, struct ethtool_pausep
        return;
     }
 
+	if (priv->mac_dev == NULL) {
+		cpu_netdev_info(net_dev,
+				"%s:%hu:%s(): This is a MAC-less interface\n",
+				__file__, __LINE__, __func__);
+		return -ENODEV;
+	}
 	if (unlikely(priv->mac_dev->phy_dev == NULL)) {
 		cpu_netdev_err(net_dev, "%s:%hu:%s(): phy device not initialized\n",
 			       __file__, __LINE__, __func__);
@@ -234,6 +258,12 @@ int __cold dpa_set_pauseparam(struct net_device *net_dev, struct ethtool_pausepa
        return -ENODEV;
     }
 
+	if (priv->mac_dev == NULL) {
+		cpu_netdev_info(net_dev,
+				"%s:%hu:%s(): This is a MAC-less interface\n",
+				__file__, __LINE__, __func__);
+		return -ENODEV;
+	}
 	if (unlikely(priv->mac_dev->phy_dev == NULL)) {
 		cpu_netdev_err(net_dev, "%s:%hu:%s(): phy device not initialized\n",
 			       __file__, __LINE__, __func__);
-- 
1.6.0.4

