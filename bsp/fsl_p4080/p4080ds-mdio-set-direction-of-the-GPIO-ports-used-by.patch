From 2e9e7ec877c42fd867aa417c26310924604a3424 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Tue, 14 Dec 2010 14:50:52 +0800
Subject: [PATCH 2/5] p4080ds/mdio: set direction of the GPIO ports used by mdio multiplex

The GPIOs are used to control the MDIO bus multiplexers for both
SGMII and XAUI. In general the bootloader will set the direction
of the GPIO ports as output. We only need to set the correct value
to the GPDAT register when accessing the MDIO bus. But this is not
true for the bootrom. It only set the direction type for SGMII,
and leave the direction of the ports for XAUI uninitialized.
Here we just set the correct direction type for both SGMII and XAUI
no matter whether the bootloader already set it or not. It is no harm,
and would avoid the ugly ifdef.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/platforms/85xx/p4080ds_mdio.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/p4080ds_mdio.c b/arch/powerpc/platforms/85xx/p4080ds_mdio.c
index e789ef2..2af8a7e 100644
--- a/arch/powerpc/platforms/85xx/p4080ds_mdio.c
+++ b/arch/powerpc/platforms/85xx/p4080ds_mdio.c
@@ -89,6 +89,7 @@ static int p4080ds_mdio_reset(struct mii_bus *bus)
 
 
 #define GPIO_GPDAT_OFFSET	2
+#define GPIO_GPDIR_MDIO		0xf0000000
 
 static int p4080ds_mdio_probe(struct of_device *ofdev,
 		const struct of_device_id *match)
@@ -187,6 +188,9 @@ static int p4080ds_mdio_probe(struct of_device *ofdev,
 		goto err_ioremap;
 	}
 
+	/* Set the direction of the GPIO ports used by MDIO bus */
+	setbits32(priv->gpio_reg, GPIO_GPDIR_MDIO);
+
 	priv->gpio_reg += GPIO_GPDAT_OFFSET;
 
 	/* Grab the value to write to the GPIO */
-- 
1.7.0

