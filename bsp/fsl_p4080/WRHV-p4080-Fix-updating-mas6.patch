From f67e1e7acabc930020a80e1dd9275e548a9ba144 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Wed, 20 Jan 2010 03:00:29 -0800
Subject: [PATCH 1/3] WRHV/p4080: Fix updating mas6

On an E500mc platform, the AS bit should be filled of mas6 by
checking if we are kernel space or user space. We also must
keep the TID for searching TLB before calling tlbsx.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/head_wrhv.S |   29 +++++++++++++++++++----------
 1 files changed, 19 insertions(+), 10 deletions(-)

diff --git a/arch/powerpc/kernel/head_wrhv.S b/arch/powerpc/kernel/head_wrhv.S
index d7d3da8..e756909 100644
--- a/arch/powerpc/kernel/head_wrhv.S
+++ b/arch/powerpc/kernel/head_wrhv.S
@@ -358,23 +358,17 @@ interrupt_base:
 	slwi	r13, r13, 16
 	mtspr	SPRN_MAS6, r13
 #else
-	/* update search PID in MAS6, AS = 1 */
-	mfspr	r3,SPRN_MAS6
-	mfspr	r13, SPRN_PID0
-	rlwimi	r3,r13,16,8,15	
+	mflr    r10
+	bl update_mas6
+	mtlr    r10
 
-	ori	r3,r3,MAS6_AS1
-	mfsrr1	r13
-	rlwinm.	r13,r13,0,27,27	
-	bne	1f
-	andi.	r3,r3,MAS6_AS0
-1:	mtspr	SPRN_MAS6, r3
 #endif
 
 	/*  The HY will check which privileged instruction trap privileged 
 	 *  exception via r3. */
         lis     r3,TLBSX_CODE@h
         ori     r3,r3,TLBSX_CODE@l
+	mfspr	r10, SPRN_DEAR		/* Get faulting address */
 	tlbsx	0, r10
 
 #ifdef CONFIG_SMP
@@ -1356,6 +1350,21 @@ __secondary_reset_vector:
 
 #ifndef CONFIG_PPC85xx_VT_MODE
 #define	PGD_TABLE_SIZE 8192
+#else
+update_mas6:
+	/* update search PID in MAS6, AS = 1/0 */
+	mfspr   r3,SPRN_MAS6
+	mfspr   r13, SPRN_PID0
+	rlwimi  r3,r13,16,8,15
+	ori     r3,r3,MAS6_SAS
+	mfsrr1  r13
+	rlwinm. r13,r13,0,25,28
+	bne     1f
+	lis     r13,(~MAS6_SAS)@h
+	ori     r13,r13,(~MAS6_SAS)@l
+	and     r3,r3,r13
+1:	mtspr   SPRN_MAS6, r3
+	blr
 #endif
 
 /*
-- 
1.6.5.2

