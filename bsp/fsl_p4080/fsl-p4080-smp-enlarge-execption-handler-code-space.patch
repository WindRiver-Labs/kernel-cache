From faf6a5bf5fa59edc890768d525d913ef10a02ad3 Mon Sep 17 00:00:00 2001
From: Yongli He <yongli.he@windriver.com>
Date: Thu, 10 Dec 2009 21:35:29 -0800
Subject: [PATCH 5/7] fsl-p4080/smp: enlarge execption handler code space

SMP support requires more space than can be accomodated by the
default execption handler. This increases the size to allow for
SMP exeptions to be handled.

Signed-off-by: Yongli He <yongli.he@windriver.com>
---
 arch/powerpc/include/asm/arch_vbi.h |    2 ++
 arch/powerpc/kernel/head_wrhv.S     |    4 ++++
 arch/powerpc/kernel/head_wrhv.h     |   12 +++++++++---
 arch/powerpc/kernel/vbi/wrhv.c      |   31 +++++++++++++++++++++++++++++++
 4 files changed, 46 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/include/asm/arch_vbi.h b/arch/powerpc/include/asm/arch_vbi.h
index 4fbc504..0952666 100644
--- a/arch/powerpc/include/asm/arch_vbi.h
+++ b/arch/powerpc/include/asm/arch_vbi.h
@@ -459,6 +459,8 @@ typedef struct
 	uint32_t   dataVal;
 } VBI_BSP_MSG_REPLY;
 
+extern int vbi_set_exc_offset(VBI_EXC_OFFSETS_TABLE *excOffsetsTable);
+extern int vbi_get_exc_offset(VBI_EXC_OFFSETS_TABLE *excOffsetsTable);
 #else /*_ASMLANGUAGE */
 
 /*
diff --git a/arch/powerpc/kernel/head_wrhv.S b/arch/powerpc/kernel/head_wrhv.S
index 49062ed..d7d3da8 100644
--- a/arch/powerpc/kernel/head_wrhv.S
+++ b/arch/powerpc/kernel/head_wrhv.S
@@ -287,7 +287,11 @@ _ENTRY(__early_start)
  * We align on a 32 byte cache line boundary for good measure.
  */
 
+#ifdef CONFIG_SMP
+	.align 9
+#else
 	.align 8
+#endif
 interrupt_base:
 	/* Critical Input Interrupt */
 	CRITICAL_EXCEPTION(0x0100, CriticalInput, unknown_exception)
diff --git a/arch/powerpc/kernel/head_wrhv.h b/arch/powerpc/kernel/head_wrhv.h
index f28a229..6fce09e 100644
--- a/arch/powerpc/kernel/head_wrhv.h
+++ b/arch/powerpc/kernel/head_wrhv.h
@@ -93,10 +93,16 @@ label:									     \
 #else
 #ifdef CONFIG_WRHV
 #undef START_EXCEPTION
-#define        START_EXCEPTION(label)                                  \
-       .align 8;                                               \
+#ifdef CONFIG_SMP 	
+#define        START_EXCEPTION(label)				\
+       .align 9;						\
 label:
-#else
+#else 
+#define        START_EXCEPTION(label)				\
+       .align 8;						\
+label:
+#endif
+#else  /*CONFIG_WRHV*/
 #define        START_EXCEPTION(label)                                  \
        .align 5;                                               \
 label:
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index f8af2d7..07ea8e6 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -147,6 +147,7 @@ char wrhv_macaddr[6];
 #ifdef CONFIG_SMP
 #define IPI_IRQ_BASE_NAME "ipi0"
 int irq_base = 0xFFFF; /*init as invalid IRQ number*/
+VBI_EXC_OFFSETS_TABLE  exec_table;
 #endif
 
 static int __init wrhv_pci_devfn_setup(char *s)
@@ -621,6 +622,29 @@ void __init wrhv_MMU_init(void)
 	 */
 	vb_context_mmu_on(0, swapper_pg_dir, PAGE_SIZE, 0);
 #endif
+
+#ifdef CONFIG_SMP
+	{
+		int i;
+		vbi_get_exc_offset(&exec_table);
+#ifdef DEBUG
+		printk("****DUMP EXEC OFFSET***\n");
+		for(i=0;i<VBI_ARCH_MAX_EXC_OFFSETS;i++)
+			printk("execoffset:%d	----	0x%08x\n",i,exec_table.excOffset[i]);
+#endif 
+		for(i=0;i<VBI_ARCH_MAX_EXC_OFFSETS;i++)
+		if(exec_table.excOffset[i])
+			exec_table.excOffset[i]*=2; /*extend to 0x200, 9bits space*/
+		vbi_set_exc_offset(&exec_table);
+#ifdef DEBUG
+		printk("****DUMP EXEC OFFSET AFTER SET***\n");
+		vbi_get_exc_offset(&exec_table);
+		for(i=0;i<VBI_ARCH_MAX_EXC_OFFSETS;i++)
+			printk("execoffset:%d	----	0x%08x\n",i,exec_table.excOffset[i]);
+#endif
+	}
+#endif
+
 }
 
 
@@ -1300,6 +1324,13 @@ int __devinit wrhv_start_secondary(void *unused)
 #endif
 	vbi_set_exc_base((char*)0xC0000000);
 	wrhv_umask_IPIs_for_vcore();
+	vbi_set_exc_offset(&exec_table);
+#ifdef DEBUG
+	printk("****DUMP EXEC OFFSET AFTER SET***\n");
+	vbiExcOffsetsGet(&exec_table);
+	for(i=0;i<VBI_ARCH_MAX_EXC_OFFSETS;i++)
+		printk("execoffset:%d	----	0x%08x\n",i,exec_table.excOffset[i]);
+#endif
 
 	atomic_inc(&init_mm.mm_count);
 	current->active_mm = &init_mm;
-- 
1.6.5.2

