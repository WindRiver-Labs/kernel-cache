From c9b9ab21b4797e443b85114b4a7c5c4964d15612 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Wed, 20 Jan 2010 03:00:31 -0800
Subject: [PATCH 3/3] WRHV/p4080: Work around vb__flush_icache_range

vb__flush_icache_range will hang the kernel on boot, so we must
restore parts of the original implementation.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/vbi/util.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/util.c b/arch/powerpc/kernel/vbi/util.c
index 9c7ba61..1bdce55 100644
--- a/arch/powerpc/kernel/vbi/util.c
+++ b/arch/powerpc/kernel/vbi/util.c
@@ -128,7 +128,13 @@ void vb_flush_dcache_range(unsigned long start, unsigned long stop)
 
 void vb__flush_icache_range(unsigned long start, unsigned long stop)
 {
+#ifdef	CONFIG_WRHV_P4080DS 
+	/* FIXME: This works around on current hypervisor implementation.
+	 */
+	vbi_flush_icache((void *) start, (stop - start + 1));
+#else
 	vbi_update_text_cache((void *) start, (stop - start + 1));
+#endif
 }
 
 void vb__flush_dcache_icache_phys(unsigned long physaddr)
-- 
1.6.5.2

