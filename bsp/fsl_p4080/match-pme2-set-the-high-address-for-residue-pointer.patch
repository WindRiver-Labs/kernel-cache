From dfed31a02cb6fde0f2ca01657bd5e3725b960598 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Sat, 28 Aug 2010 22:59:52 -0700
Subject: [PATCH] match/pme2: set the high address for residue pointer

On p4080 the 36bit mode is enabled by default. This will
trigger a BUG_ON when querying or updating a pme flow
context. So fix this BUG_ON by setting the high address
for residue pointer.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/match/pme2_low.c |    7 ++-----
 1 files changed, 2 insertions(+), 5 deletions(-)

diff --git a/drivers/match/pme2_low.c b/drivers/match/pme2_low.c
index feeccb3..3d94244 100644
--- a/drivers/match/pme2_low.c
+++ b/drivers/match/pme2_low.c
@@ -225,11 +225,8 @@ void pme_fd_cmd_fcw(struct qm_fd *fd, u8 flags, struct pme_flow *flow,
 			rptr = residue_map(residue);
 			BUG_ON(!residue);
 			BUG_ON((unsigned long)residue & 63);
-			/* TODO: when this breaks, the obvious fix (set flow->rptr_hi
-			 * non-zero!) will no longer generate warnings. :-) */
-			BUG_ON(sizeof(dma_addr_t) > 4);
-			flow->rptr_hi = 0;
-			flow->rptr_lo = rptr;
+			flow->rptr_hi = (u16)((u64)rptr >> 32);
+			flow->rptr_lo = (u32)rptr;
 		} else {
 			flow->rptr_hi = 0;
 			flow->rptr_lo = 0;
-- 
1.6.5.2

