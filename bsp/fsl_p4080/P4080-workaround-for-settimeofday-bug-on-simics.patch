From d00dc93a4588bcd92098106ac2ecb0775566dd22 Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Thu, 21 Oct 2010 10:23:23 +0800
Subject: [PATCH 5/7] P4080 workaround for settimeofday bug on simics

This is a workaround to make sure p4080 BSP can work
on simics.

If not apply it, when sets time on simics, system can
sometimes hang.

Signed-off-by: Benjamin Walsh <benjamin.walsh@windriver.com>
Integrated-by: Kevin Hao <kexin.hao@windriver.com>
Integrated-by: Andrew Liu <shengping.liu@windriver.com>
---
 arch/powerpc/platforms/85xx/Kconfig |    5 +++++
 kernel/time/timekeeping.c           |    4 ++++
 2 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/Kconfig b/arch/powerpc/platforms/85xx/Kconfig
index 71ce241..dd375a9 100644
--- a/arch/powerpc/platforms/85xx/Kconfig
+++ b/arch/powerpc/platforms/85xx/Kconfig
@@ -71,6 +71,11 @@ config SOCRATES
 	help
 	  This option enables support for the Socrates board.
 
+config P4080_SIMICS
+	bool "Freescale P4080 SIMICS"
+	help
+	  This option enables support for the P4080 SIMICS
+
 config P4080_SIM
 	bool "Freescale P4080 SIM"
 	select DEFAULT_UIMAGE
diff --git a/kernel/time/timekeeping.c b/kernel/time/timekeeping.c
index 93daab9..051895e 100644
--- a/kernel/time/timekeeping.c
+++ b/kernel/time/timekeeping.c
@@ -340,6 +340,10 @@ int do_settimeofday(struct timespec *tv)
 
 	write_raw_sequnlock_irqrestore(&xtime_lock, flags);
 
+#if defined(CONFIG_P4080_DS) && defined(CONFIG_P4080_SIMICS)
+	udelay(100);
+#endif
+
 	/* signal hrtimers about time change */
 	clock_was_set();
 
-- 
1.6.5.2

