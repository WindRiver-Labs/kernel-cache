From f8df5ee64b7868105cee704ee9039acb332833f3 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 4 Dec 2009 22:58:30 -0800
Subject: [PATCH 72/77] WRHV/fsl_p4080: Jump AS1 space for kernel space

We should pass kernel to run AS = 1 since when exception occurs MSR[IS/DS]
should be set as '0' by the hardware. So it's convenient to cope with something
from kernel to exception. Ans this is also matched as the hypervisor design.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/head_wrhv.S |   16 ++++++++++++++++
 1 files changed, 16 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/head_wrhv.S b/arch/powerpc/kernel/head_wrhv.S
index 31cb892..e4df27d 100644
--- a/arch/powerpc/kernel/head_wrhv.S
+++ b/arch/powerpc/kernel/head_wrhv.S
@@ -103,6 +103,22 @@ _ENTRY(__early_start)
 	 * This is where the main kernel code starts.
  	 */
 
+#if defined(CONFIG_PPC85xx_VT_MODE)
+	/* Jump to KERNELBASE mapping on address space 1 */
+	lis     r3,(KERNELBASE & ~0xfff)@h
+	ori     r3,r3,(KERNELBASE & ~0xfff)@l
+	mfmsr   r4
+	ori     r4, r4, MSR_IS|MSR_DS
+	bl      1f                      /* Find our address */
+1:	mflr    r5
+	rlwimi  r3,r5,0,20,31
+	addi    r3,r3,(2f - 1b)
+	mtspr   SPRN_SRR0,r3
+	mtspr   SPRN_SRR1,r4
+	rfi                             
+2:     
+#endif
+
 #ifdef CONFIG_SMP
 	/* Check to see if we're the second processor, and jump
 	 * to the secondary_start code if so
-- 
1.6.5.2

