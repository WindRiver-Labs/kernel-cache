From 4b2fcdad1453ed5403e9c73823a2fcd6b580294d Mon Sep 17 00:00:00 2001
From: Emil Medve <Emilian.Medve@freescale.com>
Date: Fri, 12 Feb 2010 17:43:45 -0600
Subject: [PATCH] P4080/DPA: Add error checking to schedule_work() calls

Signed-off-by: Emil Medve <Emilian.Medve@Freescale.com>
Signed-off-by: Kumar Gala <galak@kernel.crashing.org>
[Kevin: Original patch taken from Freescale p4080 SDK 2.0.3 tar
package, apply cleanly to kernel 2.6.27]
Integrated-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/dpa/dpa.c |   21 +++++++++++++++++----
 1 files changed, 17 insertions(+), 4 deletions(-)

diff --git a/drivers/net/dpa/dpa.c b/drivers/net/dpa/dpa.c
index 4770c80..39c0d33 100644
--- a/drivers/net/dpa/dpa.c
+++ b/drivers/net/dpa/dpa.c
@@ -710,6 +710,7 @@ ingress_dqrr(struct qman_portal		*portal,
 	     uint8_t			 _rtx,
 	     uint8_t			 ed)
 {
+	int				 _errno;
 	const struct net_device		*net_dev;
 	const struct dpa_priv_s		*priv;
 	struct dpa_percpu_priv_s	*percpu_priv;
@@ -752,7 +753,12 @@ ingress_dqrr(struct qman_portal		*portal,
 					 percpu_priv->count[_rtx][ed]);
 #endif
 
-	schedule_work(&percpu_priv->fd_work);
+	_errno = schedule_work(&percpu_priv->fd_work);
+	if (unlikely(_errno < 0))
+		if (netif_msg_rx_err(priv))
+			cpu_netdev_crit(net_dev,
+					"%s:%hu:%s(): schedule_work() = %d\n",
+					__file__, __LINE__, __func__, _errno);
 
 _return:
 	if (netif_msg_intr(priv))
@@ -1597,7 +1603,7 @@ static void (*const _dpa_work[][2])(struct net_device		*net_dev,
 
 static void __hot dpa_work(struct work_struct *fd_work)
 {
-	int				 i, j;
+	int				 _errno, i, j;
 	struct net_device		*net_dev;
 	const struct dpa_priv_s		*priv;
 	struct dpa_percpu_priv_s	*percpu_priv;
@@ -1648,8 +1654,15 @@ static void __hot dpa_work(struct work_struct *fd_work)
 	}
 
 	/* Try again later if we're not done */
-	if (retry)
-		schedule_work(fd_work);
+	if (retry) {
+		_errno = schedule_work(fd_work);
+		if (unlikely(_errno < 0))
+			if (netif_msg_rx_err(priv))
+				cpu_netdev_crit(net_dev, "%s:%hu:%s(): "
+						"schedule_work() = %d\n",
+						__file__, __LINE__, __func__,
+						_errno);
+	}
 
 	if (netif_msg_intr(priv))
 		cpu_netdev_dbg(net_dev, "%s:%s() ->\n", __file__, __func__);
-- 
1.6.0.4

