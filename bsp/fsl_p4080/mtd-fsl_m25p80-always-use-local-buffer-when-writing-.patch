From 5e7ffc08abc5f8b9177f8f28f3d364937d6246c6 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Mon, 2 Aug 2010 15:10:06 +0800
Subject: [PATCH 3/3] mtd/fsl_m25p80: always use local buffer when writing data to flash

Currently we will use the buffer provide by file system to store the
write command if there is enough space before the current data.
But this will cause data corruption if the file system still use
that buffer.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/mtd/devices/fsl_m25p80.c |    8 ++------
 1 files changed, 2 insertions(+), 6 deletions(-)

diff --git a/drivers/mtd/devices/fsl_m25p80.c b/drivers/mtd/devices/fsl_m25p80.c
index e5fd701..3c81709 100644
--- a/drivers/mtd/devices/fsl_m25p80.c
+++ b/drivers/mtd/devices/fsl_m25p80.c
@@ -460,12 +460,8 @@ static int m25p80_write(struct mtd_info *mtd, loff_t to, size_t len,
 			if (page_size > flash->page_size)
 				page_size = flash->page_size;
 
-			if (likely(i >= CMD_SIZE))
-				tmp = buf + i - CMD_SIZE;
-			else {
-				tmp = local_buf;
-				memcpy(tmp + CMD_SIZE, buf + i, page_size);
-			}
+			tmp = local_buf;
+			memcpy(tmp + CMD_SIZE, buf + i, page_size);
 			tmp[0] = OPCODE_PP;
 			tmp[1] = ((to + i) >> 16) & 0xff;
 			tmp[2] = ((to + i) >> 8) & 0xff;
-- 
1.6.5.2

