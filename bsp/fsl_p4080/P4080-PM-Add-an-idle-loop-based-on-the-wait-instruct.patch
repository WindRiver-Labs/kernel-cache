From 9b314c0b6636f5351d46d7c8d44610cc471cf14b Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Thu, 19 Nov 2009 06:42:00 -0500
Subject: [PATCH 124/148] P4080/PM: Add an idle loop based on the wait instruction, and use it on e500mc.

e500mc cannot doze due to an erratum, but it has a "wait" instruction
that is similar.  It is implemented as a separate idle loop rather than
an inner-loop power_save() callback, because we don't want IRQs or
IRQ-off tracing disabled, and most of the rest of cpu_idle() is
unnecessary even if possibly harmless.

Note that on platforms that select this idle loop will not be able to use
nap-on-idle.

Signed-off-by: Scott Wood <scottwood@freescale.com>
[Cleanly applied the FSL SDK 2.0.3 patch:
"kernel-2.6.30-P4080-PM-Add-an-idle-loop-based-on-the-wait-instruc-2.patch".
Removed FSL hypervisor bits.]
Integrated-by: Yuri Nedel <Yuri.Nedel@windriver.com>
---
 arch/powerpc/include/asm/cputable.h    |    7 +++----
 arch/powerpc/include/asm/machdep.h     |    1 +
 arch/powerpc/kernel/idle.c             |   22 ++++++++++++++++++++++
 arch/powerpc/platforms/85xx/p4080_ds.c |    1 +
 4 files changed, 27 insertions(+), 4 deletions(-)

diff --git a/arch/powerpc/include/asm/cputable.h b/arch/powerpc/include/asm/cputable.h
index 5536a2c..2a9cac7 100644
--- a/arch/powerpc/include/asm/cputable.h
+++ b/arch/powerpc/include/asm/cputable.h
@@ -375,10 +375,9 @@ extern const char *powerpc_base_platform;
 #define CPU_FTRS_E500_2	(CPU_FTR_MAYBE_CAN_DOZE | CPU_FTR_USE_TB | \
 	    CPU_FTR_SPE_COMP | CPU_FTR_MAYBE_CAN_NAP | \
 	    CPU_FTR_NODSISRALIGN | CPU_FTR_NOEXECUTE)
-#define CPU_FTRS_E500MC	(CPU_FTR_MAYBE_CAN_DOZE | CPU_FTR_USE_TB | \
-	    CPU_FTR_MAYBE_CAN_NAP | CPU_FTR_NODSISRALIGN | \
-	    CPU_FTR_L2CSR | CPU_FTR_LWSYNC | CPU_FTR_NOEXECUTE | \
-	    CPU_FTR_DBELL)
+#define CPU_FTRS_E500MC	(CPU_FTR_USE_TB | CPU_FTR_MAYBE_CAN_NAP | \
+	    CPU_FTR_NODSISRALIGN | CPU_FTR_L2CSR | CPU_FTR_LWSYNC | \
+	    CPU_FTR_NOEXECUTE | CPU_FTR_DBELL)
 #define CPU_FTRS_GENERIC_32	(CPU_FTR_COMMON | CPU_FTR_NODSISRALIGN)
 
 /* 64-bit CPUs */
diff --git a/arch/powerpc/include/asm/machdep.h b/arch/powerpc/include/asm/machdep.h
index 9f0fc9e..09bb6b8 100644
--- a/arch/powerpc/include/asm/machdep.h
+++ b/arch/powerpc/include/asm/machdep.h
@@ -277,6 +277,7 @@ extern void e500_idle(void);
 extern void power4_idle(void);
 extern void power4_cpu_offline_powersave(void);
 extern void ppc6xx_idle(void);
+extern void wait_idle(void);
 
 /*
  * ppc_md contains a copy of the machine description structure for the
diff --git a/arch/powerpc/kernel/idle.c b/arch/powerpc/kernel/idle.c
index c29e7f5..2ef29f6 100644
--- a/arch/powerpc/kernel/idle.c
+++ b/arch/powerpc/kernel/idle.c
@@ -13,6 +13,8 @@
  *
  * 32-bit and 64-bit versions merged by Paul Mackerras <paulus@samba.org>
  *
+ * Portions Copyright 2009 Freescale Semiconductor, Inc.
+ *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
  * as published by the Free Software Foundation; either version
@@ -32,6 +34,7 @@
 #include <asm/time.h>
 #include <asm/machdep.h>
 #include <asm/smp.h>
+#include <asm/ppc-opcode.h>
 
 #ifdef CONFIG_HOTPLUG_CPU
 #define cpu_should_die()	cpu_is_offline(smp_processor_id())
@@ -105,6 +108,25 @@ void cpu_idle(void)
 	}
 }
 
+void wait_idle(void)
+{
+	while (1) {
+		tick_nohz_stop_sched_tick(1);
+
+		while (!need_resched() && !cpu_should_die())
+			asm volatile(PPC_WAIT(0));
+
+		tick_nohz_restart_sched_tick();
+
+		if (cpu_should_die())
+			cpu_die();
+
+		preempt_enable_no_resched();
+		schedule();
+		preempt_disable();
+	}
+}
+
 int powersave_nap;
 
 #ifdef CONFIG_SYSCTL
diff --git a/arch/powerpc/platforms/85xx/p4080_ds.c b/arch/powerpc/platforms/85xx/p4080_ds.c
index 446d5e9..730c3be 100644
--- a/arch/powerpc/platforms/85xx/p4080_ds.c
+++ b/arch/powerpc/platforms/85xx/p4080_ds.c
@@ -208,4 +208,5 @@ define_machine(p4080_ds) {
 	.calibrate_decr		= generic_calibrate_decr,
 	.progress		= udbg_progress,
 	.init_early		= p4080_init_early,
+	.idle_loop		= wait_idle,
 };
-- 
1.6.5.2

