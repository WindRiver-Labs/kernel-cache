From 7e719e33c6e6bb24583808c7f880035158cfde20 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 4 Dec 2009 22:58:33 -0800
Subject: [PATCH 75/77] WRHV/fsl_p4080: Use the native 32-PTE for find/load PTE

For E500mc we should use native PTE find/load function and swapper_pg_dir.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/head_wrhv.S |    8 ++++++--
 1 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/kernel/head_wrhv.S b/arch/powerpc/kernel/head_wrhv.S
index 29f1018..af28fda 100644
--- a/arch/powerpc/kernel/head_wrhv.S
+++ b/arch/powerpc/kernel/head_wrhv.S
@@ -212,7 +212,7 @@ _ENTRY(__early_start)
  *   r12 is pointer to the pte
  */
 
-#if defined(CONFIG_PTE_64BIT) || defined(CONFIG_WRHV)
+#if defined(CONFIG_PTE_64BIT) || defined(CONFIG_WRHV) && !defined(CONFIG_PPC85xx_VT_MODE)
 #  define FIND_PTE_ADDR \
 	rlwinm	r12, r10, 13, 19, 29;	/* Compute pgdir/pmd offset */	\
 	lwzx	r11, r12, r11;		/* Get pgd/pmd entry */		\
@@ -910,6 +910,10 @@ __secondary_reset_vector:
 #endif
 #endif
 
+#ifndef CONFIG_PPC85xx_VT_MODE
+#define	PGD_TABLE_SIZE 8192
+#endif
+
 /*
  * We put a few things here that have to be page-aligned. This stuff
  * goes at the beginning of the data segment, which is page-aligned.
@@ -923,7 +927,7 @@ empty_zero_page:
 	.space	4096
 	.globl	swapper_pg_dir
 swapper_pg_dir:
-	.space	8192
+	.space  PGD_TABLE_SIZE
 /*
  * We need a place to stwcx. to when we want to clear a reservation
  * without knowing where the original was.
-- 
1.6.5.2

