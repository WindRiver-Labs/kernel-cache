From 70f557e340c3c98c41a51b9ec41764a2413f8862 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Tue, 19 Jan 2010 21:41:43 -0800
Subject: [PATCH 3/5] WRHV/PPC: Get vb mdio bus

For P4080 The hypervisor needs to know which FMAN and which DTSEC you are
trying to access via the MDIO as the access functions need that information.
This information should be encoded into the "bus" element of the MDIO_MSG
struct.

fman 4 bits  0-1
dtsec 4 bits 0-3

0x000000<fman><dtsec>

For 8572ds only one mii bus exists.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/include/asm/machdep.h         |    1 +
 arch/powerpc/platforms/85xx/wrhv_p4080ds.c |   45 ++++++++++++++++++++++++++++
 2 files changed, 46 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/machdep.h b/arch/powerpc/include/asm/machdep.h
index 7d1f2dc..1308a43 100644
--- a/arch/powerpc/include/asm/machdep.h
+++ b/arch/powerpc/include/asm/machdep.h
@@ -268,6 +268,7 @@ struct machdep_calls {
 	int (*set_law_base)(int index, unsigned long long addr);
 	int (*set_law_attr)(int index, unsigned int attr);
 	int (*get_law_attr)(int index);
+	uint32_t (*get_mdio_bus)(struct device_node *np);
 #endif
 };
 
diff --git a/arch/powerpc/platforms/85xx/wrhv_p4080ds.c b/arch/powerpc/platforms/85xx/wrhv_p4080ds.c
index ea0b775..7119988 100644
--- a/arch/powerpc/platforms/85xx/wrhv_p4080ds.c
+++ b/arch/powerpc/platforms/85xx/wrhv_p4080ds.c
@@ -84,6 +84,50 @@ int wrhv_p4080_get_law_attr(int index)
 	return attr;
 }
 
+/*
+ * The hypervisor needs to know which FMAN and which DTSEC you 
+ * are trying to access via the MDIO as the access functions 
+ * need that information.
+ * This information should be encoded into the "bus" element 
+ * of the MDIO_MSG struct.
+ 
+ * fman 4 bits  0-1
+ * dtsec 4 bits 0-3
+ 
+ * 0x000000<fman><dtsec>
+ */
+uint32_t p4080_get_vb_mdio_bus(struct device_node *np)
+{
+	uint32_t bus = -1, i = 0;
+	char *mdio_bus[] = {
+			/*
+			 * dtsec0 ~ dtsec4 should be attached on @e1120
+			 * dtsec5 ~ dtsec9 should be attached on different
+			 * five mdio buses.
+			 */
+			"/soc@fe000000/fman@400000/mdio@e1120",
+			"/soc@fe000000/fman@500000/mdio@e1000",
+			"/soc@fe000000/fman@500000/mdio@e3000",
+			"/soc@fe000000/fman@500000/mdio@e5000",
+			"/soc@fe000000/fman@500000/mdio@f1000",
+	};
+
+	for_each_compatible_node(np, NULL, "fsl,fman-mdio") {
+		for (i=0;i<5;i++) {
+			if (!(strcmp(np->full_name,  mdio_bus[i]))) {
+				bus = i;
+				/*
+			 	 * mask fman1
+			 	 */
+				if (i)
+					bus |= 1 << 4;
+				break;
+			}
+		}
+	}
+	return bus;
+}
+
 static void __init mpc85xx_ds_setup_arch(void)
 {
 #ifdef CONFIG_PCI
@@ -209,4 +253,5 @@ define_machine(p4080_ds) {
 	.set_law_base		= wrhv_p4080_set_law_base,	
 	.set_law_attr		= wrhv_p4080_set_law_attr,
 	.get_law_attr		= wrhv_p4080_get_law_attr,
+	.get_mdio_bus		= p4080_get_vb_mdio_bus,
 };
-- 
1.6.5.2

