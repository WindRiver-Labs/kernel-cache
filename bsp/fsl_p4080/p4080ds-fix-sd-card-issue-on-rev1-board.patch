From ebdcd40cfaef6ffc50b7732b9fb592c1f88ea6fc Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Mon, 16 May 2011 17:12:24 +0800
Subject: [PATCH] p4080ds: fix sd card issue on rev1 board

Data timeout errors are reported sometimes on rev1 when we run some
sd card tests, and it will finally make sd card malfunctional:
.....
sdhci [sdhci_irq()]: *** mmc0 got interrupt: 0x00000001
sdhci [sdhci_irq()]: *** mmc0 got interrupt: 0x00100002
mmc0: req done (CMD25): 0: 00000900 00000000 00000000 00000000
mmc0:     0 bytes transferred: -110
mmc0: starting CMD13 arg 00020000 flags 00000195
sdhci [sdhci_irq()]: *** mmc0 got interrupt: 0x00000001
mmc0: req done (CMD13): 0: 00000d00 00000000 00000000 00000000
mmcblk0: error -110 transferring data, sector 1505258, nr 128, card status 0xd00
mmc0: starting CMD13 arg 00020000 flags 00000015
sdhci [sdhci_irq()]: *** mmc0 got interrupt: 0x00000001
mmc0: req done (CMD13): 0: 00000d00 00000000 00000000 00000000
mmc0: starting CMD55 arg 00020000 flags 00000095
sdhci [sdhci_irq()]: *** mmc0 got interrupt: 0x00000001
mmc0: req done (CMD55): 0: 00000c20 00000000 00000000 00000000
mmc0: starting CMD22 arg 00000000 flags 000000b5
mmc0:     blksz 4 blocks 1 flags 00000200 tsac 100 ms nsac 0
sdhci [sdhci_irq()]: *** mmc0 got interrupt: 0x00010003
mmc0: req done (CMD22): -110: 00000000 00000000 00000000 00000000
mmc0:     0 bytes transferred: 0
end_request: I/O error, dev mmcblk0, sector 1505258
end_request: I/O error, dev mmcblk0, sector 1505266
end_request: I/O error, dev mmcblk0, sector 1505274
...

A known sdhci errata exist:
ESDHC 11: Data Timeout counter (SYSCTL[DTOCV]) not reliable for values
of 0x4, 0x8 and 0xC

But the debugging result shows the errata still doesn't cover all potential
time out problem in Rev1 board, so here use quirk SDHCI_QUIRK_BROKEN_TIMEOUT_VAL
to handle it. so far so good.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 drivers/mmc/host/sdhci-of-core.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/drivers/mmc/host/sdhci-of-core.c b/drivers/mmc/host/sdhci-of-core.c
index df47169..da85563 100644
--- a/drivers/mmc/host/sdhci-of-core.c
+++ b/drivers/mmc/host/sdhci-of-core.c
@@ -161,6 +161,8 @@ static int __devinit sdhci_of_probe(struct of_device *ofdev,
 		host->quirks |= SDHCI_QUIRK_QORIQ_REG_WEIRD |
 			SDHCI_QUIRK_QORIQ_TIMEOUT_WEIRD;
 		host->quirks &= ~SDHCI_QUIRK_INVERTED_WRITE_PROTECT;
+		if ((mfspr(SPRN_SVR) & 0xff) == 0x10)
+			host->quirks |= SDHCI_QUIRK_BROKEN_TIMEOUT_VAL;
 	}
 
 	if (of_get_property(np, "sdhci,1-bit-only", NULL))
-- 
1.7.0.4

