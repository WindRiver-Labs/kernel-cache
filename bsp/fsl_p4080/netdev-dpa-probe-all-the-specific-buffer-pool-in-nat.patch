From 4ca2aad0caa3170321485829defba86c4110cac3 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Wed, 28 Mar 2012 14:16:49 +0800
Subject: [PATCH 4/4] netdev/dpa: probe all the specific buffer pool in native
 bsp

Currently the dpa driver only supports one kernel buffer pool
for all the Ethernet controllers. This works fine when all the
Ethernet use the pool allocated dynamically by the dpa driver
in kernel. But in order to support linux-linux guest os, we have
to use specific pool for each Ethernet. So we introduce a patch
(net/dpa: only use one buffer pool even when static buffer) to
only use one buffer pool even several specific pool are used
for Ethernet. But when an Ethernet is reserved for userspace
driver, we still need to setup the buffer pool for this Ethernet.
So add a check here to distinguish between these two cases.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/dpa/dpaa_eth.c |    6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/drivers/net/dpa/dpaa_eth.c b/drivers/net/dpa/dpaa_eth.c
index 981aff4..44e15b2 100644
--- a/drivers/net/dpa/dpaa_eth.c
+++ b/drivers/net/dpa/dpaa_eth.c
@@ -63,6 +63,10 @@
 
 #ifdef CONFIG_PPC85xx_VT_MODE
 #include <vbi/vbi.h>
+
+static inline int is_guest_os() { return 1; }
+#else
+static inline int is_guest_os() { return 0; }
 #endif
 
 #define ARRAY2_SIZE(arr)	(ARRAY_SIZE(arr) * ARRAY_SIZE((arr)[0]))
@@ -1750,7 +1754,7 @@ dpa_bp_probe(struct of_device *_of_dev, size_t *count)
 	phandle_prop = of_get_property(_of_dev->node,
 					"fsl,bman-buffer-pools", &lenp);
 
-	if (phandle_prop && !default_pool)
+	if (phandle_prop && (!default_pool || !is_guest_os()))
 		*count = lenp / sizeof(phandle);
 	else {
 		if (default_pool)
-- 
1.7.9.7

