From 2bb9aa3aa3451f10884f1f4b8fc1d1e7e494d56f Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Wed, 12 May 2010 16:39:48 +0800
Subject: [PATCH] WRHV/fsl_p4080: Divide kernel and exception space

For the hypervisor implementation the Linux kernel should run the space with
AS=1, exception handler should be as AS=0. So re-define MSR_KERNEL macro, and
make sure it's correct while enter/exit the exception handler.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/include/asm/reg_booke.h |   12 ++++++++++--
 arch/powerpc/kernel/entry_32.S       |   12 ++++++++++++
 2 files changed, 22 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/include/asm/reg_booke.h b/arch/powerpc/include/asm/reg_booke.h
index 8f341ca..88bb7b5 100644
--- a/arch/powerpc/include/asm/reg_booke.h
+++ b/arch/powerpc/include/asm/reg_booke.h
@@ -36,10 +36,18 @@
 #define MSR_USER	(MSR_KERNEL|MSR_PR|MSR_EE)
 #else				/* Comes here when defined CONFIG_BOOKE */
 #if defined(CONFIG_DEBUG_CW) || defined(CONFIG_WR_OCD_DEBUG)
-#define MSR_KERNEL      (MSR_ME|MSR_RI|MSR_CE|MSR_DE)
+#if defined(CONFIG_PPC85xx_VT_MODE)
+#define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_CE|MSR_DE|MSR_IR|MSR_DR)
 #else
-#define MSR_KERNEL     (MSR_ME|MSR_RI|MSR_CE)
+#define MSR_KERNEL     (MSR_ME|MSR_RI|MSR_CE|MSR_DE)
 #endif	/* OCD */
+#else
+#if defined(CONFIG_PPC85xx_VT_MODE)
+#define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_CE|MSR_IR|MSR_DR)
+#else
+#define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_CE)
+#endif
+#endif
 #define MSR_USER       (MSR_KERNEL|MSR_PR|MSR_EE)
 #endif
 
diff --git a/arch/powerpc/kernel/entry_32.S b/arch/powerpc/kernel/entry_32.S
index dd9cd39..7bea8e7 100644
--- a/arch/powerpc/kernel/entry_32.S
+++ b/arch/powerpc/kernel/entry_32.S
@@ -257,6 +257,10 @@ reenable_mmu:				/* re-enable mmu so we can */
 	bctr				/* jump to handler */
 #else /* CONFIG_TRACE_IRQFLAGS */
 	mtspr	SPRN_SRR0,r11
+#ifdef CONFIG_PPC85xx_VT_MODE
+	/* Guest Exception should be AS = 0 */
+	rlwinm	r10,r10,0,~(MSR_IR|MSR_DR)
+#endif
 	mtspr	SPRN_SRR1,r10
 	mtlr	r9
 	SYNC
@@ -976,7 +980,15 @@ exc_exit_restart:
 	lwz	r12,_NIP(r1)
 	FIX_SRR1(r9,r10)
 	mtspr	SPRN_SRR0,r12
+#ifdef	CONFIG_PPC85xx_VT_MODE
+	mr	r12,r9
+	ori	r9,r9,(MSR_IR|MSR_DR)
+#endif
 	mtspr	SPRN_SRR1,r9
+#ifdef	CONFIG_PPC85xx_VT_MODE
+	mr	r9,r12
+	lwz	r12,_NIP(r1)
+#endif
 	REST_4GPRS(9, r1)
 	lwz	r1,GPR1(r1)
 	.globl exc_exit_restart_end
-- 
1.6.0.3

