From 445d841ad18eaa5d7ebc60de40d992fddf7e4a78 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 4 Dec 2009 22:58:31 -0800
Subject: [PATCH 73/77] WRHV/fsl_p4080: Invalidate one unnecessary TLB entry

We should invalidate all unnecessary TLB entries passed by the hypervisor.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/head_wrhv.S |   13 +++++++++++++
 1 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/head_wrhv.S b/arch/powerpc/kernel/head_wrhv.S
index e4df27d..6654220 100644
--- a/arch/powerpc/kernel/head_wrhv.S
+++ b/arch/powerpc/kernel/head_wrhv.S
@@ -119,6 +119,19 @@ _ENTRY(__early_start)
 2:     
 #endif
 
+#if defined(CONFIG_PPC85xx_VT_MODE)
+	/* Invalid unnecessary TLB entries passed by the Hypervisor */
+	li      r0,0
+	li      r3,0
+	li      r4,0
+	ori     r4,r4,(MAS1_TSIZE(BOOKE_PAGESZ_256M))@l
+	mtspr   SPRN_MAS1,r4
+	isync
+	/* tlbilx with T = 3 */
+	.long   0x7c601824
+	TLBSYNC
+#endif
+
 #ifdef CONFIG_SMP
 	/* Check to see if we're the second processor, and jump
 	 * to the secondary_start code if so
-- 
1.6.5.2

