From e8bdb9477ab391084e5f9e822434378300263beb Mon Sep 17 00:00:00 2001
From: Li Yang <leoli@freescale.com>
Date: Wed, 4 Nov 2009 18:44:15 +0800
Subject: [PATCH] rionet: fix msg_rx_ring corruption issue

Adds lock to msg_rx_ring manipulating code to prevent corruption.
Also adds a debugging message useful to debug rx_ring problem.

Signed-off-by: Li Yang <leoli@freescale.com>
[Kevin: Original patch taken from Freescale p4080 SDK 2.0 ISO image.
Just some minor context changes in order to port to kernel 2.6.27]
Integrated-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/rionet.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/drivers/net/rionet.c b/drivers/net/rionet.c
index 44f2ef7..b79eb58 100644
--- a/drivers/net/rionet.c
+++ b/drivers/net/rionet.c
@@ -161,6 +161,7 @@ static int rionet_rx_clean(struct net_device *ndev)
 		if (!rnet->rx_skb[i])
 			continue;
 
+		pr_debug("RIONET: rionet_rx_clean slot %d\n", i);
 		if (!(data = rio_get_inb_message(rnet->mport, RIONET_MAILBOX)))
 			break;
 
@@ -573,6 +574,7 @@ static int rionet_open(struct net_device *ndev)
 	struct rionet_peer *peer, *tmp;
 	u32 pwdcsr;
 	struct rionet_private *rnet = ndev->priv;
+	unsigned long flags;
 
 	if (netif_msg_ifup(rnet))
 		printk(KERN_INFO "%s: open\n", DRV_NAME);
@@ -644,7 +646,9 @@ static int rionet_open(struct net_device *ndev)
 	for (i = 0; i < RIONET_RX_RING_SIZE; i++)
 		rnet->rx_skb[i] = NULL;
 	rnet->rx_slot = 0;
+	spin_lock_irqsave(&rnet->lock, flags);
 	rionet_rx_fill(ndev, 0);
+	spin_unlock_irqrestore(&rnet->lock, flags);
 
 	rnet->tx_slot = 0;
 	rnet->tx_cnt = 0;
-- 
1.6.0.4

