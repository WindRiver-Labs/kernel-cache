From 2d9091e6ea8b9a4dbe153cc825d95eceea86b730 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 4 Dec 2009 22:58:27 -0800
Subject: [PATCH 69/77] WRHV/fsl_p4080: Implement tlbia and tlbie

Use tlibilx to implement tlbia/tlbie since that is not privileged
instruction on E500mc.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/wrhv_misc_32.S |   57 ++++++++++++++++++++++++++++++++++++
 1 files changed, 57 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/wrhv_misc_32.S b/arch/powerpc/kernel/wrhv_misc_32.S
index 3f96eee..b9aeaa0 100644
--- a/arch/powerpc/kernel/wrhv_misc_32.S
+++ b/arch/powerpc/kernel/wrhv_misc_32.S
@@ -44,18 +44,75 @@ _GLOBAL(wrhv_int_unlock)
  * Flush MMU TLB
  */
 _GLOBAL(paravirt_tlbia)
+#ifndef	CONFIG_PPC85xx_VT_MODE
 	lis	r0, VBI_SYS_tlb_flush@h
 	ori	r0, r0, VBI_SYS_tlb_flush@l
 	sc
+#else
+#ifdef CONFIG_SMP
+        /* For mutual exclusion for invalidate */
+        mfmsr   r11
+        wrteei  0
+        lis     r8, ivax_lock@h
+        ori     r8, r8, ivax_lock@l
+11:     lwarx   r5, 0, r8
+        cmpwi   r5, 0
+        bne     11b
+        ori     r5,r5,1
+        stwcx.  r5, 0, r8
+        bne     11b
+#endif  /* CONFIG_SMP */
+
+	/* tlbilx with T = 0 */
+	.long   0x7c001824
+        msync
+	isync
+#ifdef CONFIG_SMP
+        li      r0, 0
+        stw     r0, 0(r8)
+        wrtee   r11
+#endif /* CONFIG_SMP */
+#endif
 	blr
 
 /*
  * Flush MMU TLB for a particular address
  */
 _GLOBAL(paravirt_tlbie)
+#ifndef	CONFIG_PPC85xx_VT_MODE
 	lis	r0, VBI_SYS_tlb_flush@h
 	ori	r0, r0, VBI_SYS_tlb_flush@l
 	sc
+#else
+#ifdef CONFIG_SMP
+	/* For mutual exclusion for invalidate */
+	mfmsr	r11
+	wrteei	0
+	lis	r8, ivax_lock@h
+	ori	r8, r8, ivax_lock@l
+11:	lwarx	r5, 0, r8
+	cmpwi	r5, 0
+	bne	11b
+	ori	r5,r5,1
+	stwcx.	r5, 0, r8
+	bne	11b
+#endif	/* CONFIG_SMP */
+
+	mfspr   r0,SPRN_MAS6
+	rlwimi  r0,r4,16,8,15
+	mtspr   SPRN_MAS6,r0
+
+	li	r0,0
+	/* tlbilx with T = 3 */
+        .long	0x7c601824
+	msync
+	isync
+#if defined(CONFIG_SMP)
+	li	r0, 0
+	stw	r0, 0(r8)
+	wrtee	r11
+#endif /* CONFIG_SMP */
+#endif
 	blr
 
 /*
-- 
1.6.5.2

