From 0db9a1ec023a6451a7ce66c6ae9d9c1e47795609 Mon Sep 17 00:00:00 2001
From: Timur Tabi <timur@freescale.com>
Date: Mon, 2 Nov 2009 16:26:30 -0600
Subject: [PATCH] e500mc: enable FP emulation to work around errata CPU12 and CPU13

Errata CPU12 and CPU13 mean that floating-point operations are broken, so we
need to enable FP emulation in the kernel.  However, e500mc has normal FP
support, so we need to modify the kernel to call the software FP emulation
handler instead of the normal FP handler.  To do this, we define a new
exception entry point called FloatingPointUnavailableErrata and set IVOR7 to
it.

This hack is not compatible with rev2 silicon.

Signed-off-by: Timur Tabi <timur@freescale.com>
[Kevin: Original patch taken from Freescale p4080 SDK 2.0 ISO image.
Apply cleanly to kernel 2.6.27]
Integrated-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/configs/p4080_ds_defconfig |    2 +-
 arch/powerpc/kernel/head_fsl_booke.S    |    4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/configs/p4080_ds_defconfig b/arch/powerpc/configs/p4080_ds_defconfig
index ad27b56..c36d9d7 100644
--- a/arch/powerpc/configs/p4080_ds_defconfig
+++ b/arch/powerpc/configs/p4080_ds_defconfig
@@ -246,7 +246,7 @@ CONFIG_BINFMT_ELF=y
 # CONFIG_CORE_DUMP_DEFAULT_ELF_HEADERS is not set
 # CONFIG_HAVE_AOUT is not set
 CONFIG_BINFMT_MISC=m
-# CONFIG_MATH_EMULATION is not set
+CONFIG_MATH_EMULATION=y
 # CONFIG_IOMMU_HELPER is not set
 CONFIG_ARCH_ENABLE_MEMORY_HOTPLUG=y
 CONFIG_ARCH_HAS_WALK_MEMORY=y
diff --git a/arch/powerpc/kernel/head_fsl_booke.S b/arch/powerpc/kernel/head_fsl_booke.S
index 7d74cf2..b818a21 100644
--- a/arch/powerpc/kernel/head_fsl_booke.S
+++ b/arch/powerpc/kernel/head_fsl_booke.S
@@ -318,7 +318,7 @@ skpinv:	addi	r6,r6,1				/* Increment */
 	SET_IVOR(4,  ExternalInput);
 	SET_IVOR(5,  Alignment);
 	SET_IVOR(6,  Program);
-	SET_IVOR(7,  FloatingPointUnavailable);
+	SET_IVOR(7,  FloatingPointUnavailableErrata);
 	SET_IVOR(8,  SystemCall);
 	SET_IVOR(9,  AuxillaryProcessorUnavailable);
 	SET_IVOR(10, Decrementer);
@@ -671,7 +671,7 @@ interrupt_base:
 
 	/* Floating Point Unavailable Interrupt */
 #ifdef CONFIG_PPC_FPU
-	FP_UNAVAILABLE_EXCEPTION
+	EXCEPTION(0x0800, FloatingPointUnavailableErrata, program_check_exception, EXC_XFER_EE)
 #else
 #ifdef CONFIG_E200
 	/* E200 treats 'normal' floating point instructions as FP Unavail exception */
-- 
1.6.0.4

