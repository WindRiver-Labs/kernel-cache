From eb5a7720524accbfa5ec3b0f28063d525aa84375 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Wed, 25 Aug 2010 00:08:00 -0700
Subject: [PATCH 3/3] wrhv/dpa: release the QMAN/BMAN resource when kernel restart

In guest OS, the QMAN/BMAN doesn't really be reset when the
kernel restart. So we should release the buffers in BMAN which are
created by dpa driver, and also destroy the FQs in QMAN which are
used for tx/rx queue. Otherwise after reboot the BMAN will include
stale buffers, and the FQ which is still in running state will be
initialized again.  This will make these FQs nonoperative.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/dpa/dpa.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/drivers/net/dpa/dpa.c b/drivers/net/dpa/dpa.c
index 3b3bdd1..9e785af 100644
--- a/drivers/net/dpa/dpa.c
+++ b/drivers/net/dpa/dpa.c
@@ -2413,6 +2413,9 @@ static struct of_platform_driver dpa_driver = {
 	.match_table	= dpa_match,
 	.owner		= THIS_MODULE,
 	.probe		= _dpa_probe,
+#ifdef CONFIG_PPC85xx_VT_MODE
+	.shutdown	= dpa_remove,
+#endif
 	.remove		= __devexit_p(dpa_remove)
 };
 
-- 
1.6.5.2

