From eefb5351071a5e4b21c6ff90f78e2247c9ffe8d4 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Mon, 21 Sep 2009 14:11:40 +0800
Subject: [PATCH 20/52] powerpc/85xx: restore the original value for PIR when wrloading

When linux is up, it will set a logic processor id to PIR register for
every core.  On E500MC, this logic id doesn't equal to the value at
reset. When we wrload another OS on the core, that OS may expect
the PIR register have the original value. So we have to restore
the original value to PIR register for that core.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/platforms/85xx/amp.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/amp.c b/arch/powerpc/platforms/85xx/amp.c
index c5984b0..79c291b 100755
--- a/arch/powerpc/platforms/85xx/amp.c
+++ b/arch/powerpc/platforms/85xx/amp.c
@@ -59,6 +59,9 @@ static void startcore(char *entryPt, int nr)
 	/* Map the spin table */
 	bptr_vaddr = ioremap(*cpu_rel_addr, SIZE_BOOT_ENTRY);
 
+#ifdef CONFIG_PPC_E500MC
+	nr <<= 5;
+#endif
 	out_be32(bptr_vaddr + BOOT_ENTRY_PIR, nr);
 	out_be32(bptr_vaddr + BOOT_ENTRY_ADDR_LOWER, (unsigned)entryPt);
 
-- 
1.6.3.3

