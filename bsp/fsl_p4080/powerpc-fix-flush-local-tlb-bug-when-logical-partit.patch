From d12fda7640055038d51f812e8643eee646dec4e9 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Fri, 14 May 2010 10:07:28 +0800
Subject: [PATCH] powerpc: fix flush local tlb bug when logical partition is enabled

MAS5 should be set explicitly to the logical partition id before
flush all the local tlb by using tlbilx. Otherwise the stale data
in MAS5 may cause some tlb entries not flushed by the tlbilx
instruction.

The opcode "0x7c001824" is equivalent to "tlbilx 0,0,r3". Since we
already set "T=0", the "r3" is useless, and change it to
"tlbilx 0,0,0"(0x7c000024). Also add a isync after the tlbilx.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/misc_32.S |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/kernel/misc_32.S b/arch/powerpc/kernel/misc_32.S
index 60dd8f1..318f9ed 100644
--- a/arch/powerpc/kernel/misc_32.S
+++ b/arch/powerpc/kernel/misc_32.S
@@ -279,8 +279,11 @@ ivax_lock:
 
 #ifdef CONFIG_LOGICAL_PARTITION
 _GLOBAL(local_tlbia)
-	.long 0x7c001824
+	li	r3,CONFIG_LOGICAL_PARTITION_ID@l
+	mtspr	SPRN_MAS5,r3
+	.long 	0x7c000024
 	msync
+	isync
 	blr
 #else
 /*
-- 
1.6.0.4

