From 24df7bf23119bb3191cc293f53480f09f1d431e6 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 4 Dec 2009 22:58:25 -0800
Subject: [PATCH 67/77] WRHV/fsl_p4080: Restore wrhv define function

Restore set_context, and drop vmmu and fix pvr for E500mc.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/head_wrhv.S |   16 ++++++++++++++++
 arch/powerpc/kernel/vbi/wrhv.c  |   17 ++++++++++++++---
 2 files changed, 30 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/kernel/head_wrhv.S b/arch/powerpc/kernel/head_wrhv.S
index 7958316..31cb892 100644
--- a/arch/powerpc/kernel/head_wrhv.S
+++ b/arch/powerpc/kernel/head_wrhv.S
@@ -660,6 +660,22 @@ _GLOBAL(abort)
 	mtspr	SPRN_DBCR0,r13
 	isync
 
+#if defined(CONFIG_PPC85xx_VT_MODE)
+_GLOBAL(set_context)
+
+#ifdef CONFIG_BDI_SWITCH
+	/* Context switch the PTE pointer for the Abatron BDI2000.
+	* The PGDIR is the second parameter.
+	*/
+	lis     r5, abatron_pteptrs@h
+	ori     r5, r5, abatron_pteptrs@l
+	stw     r4, 0x4(r5)
+#endif
+	mtspr   SPRN_PID,r3
+	isync                   /* Force context change */
+	blr
+#endif
+
 _GLOBAL(flush_dcache_L1)
 	mfspr	r3,SPRN_L1CFG0
 
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 2f8739b..e3d6cda 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -428,7 +428,11 @@ unsigned int wrhv_irq_of_parse_and_map(struct device_node *dev, int index)
 
 unsigned int wrhv_get_pvr(void)
 {
-       return 0x80200000;
+#ifdef CONFIG_PPC_E500MC
+	return 0x80230000;
+#else
+	return 0x80200000;
+#endif
 }
 
 
@@ -600,11 +604,13 @@ void __init wrhv_MMU_init(void)
 	btext_unmap();
 #endif
 
+#ifndef CONFIG_PPC85xx_VT_MODE
 	/*
 	 * we enable the mmu here without having to do this from the caller
-	 * (which is in assembly world)
+	  * (which is in assembly world)
 	 */
 	vb_context_mmu_on(0, swapper_pg_dir, PAGE_SIZE, 0);
+#endif
 }
 
 
@@ -820,8 +826,11 @@ void wrhv_update_mmu_cache(struct vm_area_struct *vma, unsigned long address,
 	}
 }
 
+void set_context(unsigned long contextid, pgd_t *pgd)
+        __attribute__((weak, alias("wrhv_set_context")));
+
 /* arch/powerpc/mm/mmu_context_32.c */
-void set_context(unsigned long contextId, pgd_t * pgd)
+void wrhv_set_context(unsigned long contextId, pgd_t * pgd)
 {
 
 	pgd_t * kpdStart, *kpdEnd, *updStart;
@@ -989,7 +998,9 @@ void wrhv_init(void)
 	pv_cpu_ops.ppc_proc_freq =
 		wrhv_ppc_cpu_freq;
 
+#ifndef CONFIG_PPC85xx_VT_MODE
 	pv_mmu_ops.vmmu_restore = wrhv_vmmu_restore;
+#endif
 	pv_mmu_ops.MMU_init_hw = wrhv_MMU_init_hw;
 	pv_mmu_ops.mmu_mapin_ram = wrhv_mmu_mapin_ram;
 	pv_mmu_ops.MMU_setup = wrhv_MMU_setup;
-- 
1.6.5.2

