From 6bf5b41d061fce9047aaec6b604a8d35809215dd Mon Sep 17 00:00:00 2001
From: Liang Li <liang.li@windriver.com>
Date: Mon, 26 Jul 2010 01:00:16 -0700
Subject: [PATCH] wrhv/p4080: make wrhv_p4080 support cpu hotplug

o add 'cpu_die' member to machine_ops to support cpu hotplug
o add 'power_save' member to support power saving
o some other naming cleanup to support wrload gos detection

Signed-off-by: Liang Li <liang.li@windriver.com>
---
 arch/powerpc/platforms/85xx/wrhv_p4080_ds.c |   19 ++++++++++++-------
 1 files changed, 12 insertions(+), 7 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c b/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
index fed49fc..401d001 100644
--- a/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
+++ b/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
@@ -132,7 +132,7 @@ uint32_t p4080_get_vb_mdio_bus(struct mii_bus *mii_bus, int addr)
 	return p4080_mdio_bus[addr];
 }
 
-static void __init mpc85xx_ds_setup_arch(void)
+static void __init wrhv_p4080_setup_arch(void)
 {
 #ifdef CONFIG_PCI
 	struct device_node *np;
@@ -141,7 +141,7 @@ static void __init mpc85xx_ds_setup_arch(void)
 	dma_addr_t max = 0xffffffff;
 
 	if (ppc_md.progress)
-		ppc_md.progress("mpc85xx_ds_setup_arch()", 0);
+		ppc_md.progress("wrhv_p4080_setup_arch()", 0);
 
 #ifdef CONFIG_SMP
 	wrhv_smp_init();
@@ -234,7 +234,7 @@ machine_device_initcall(p4080_ds, declare_of_platform_devices);
 /*
  * Called very early, device-tree isn't unflattened
  */
-static int __init p4080_ds_probe(void)
+static int __init wrhv_p4080_probe(void)
 {
 	unsigned long root = of_get_flat_dt_root();
 
@@ -276,6 +276,7 @@ void __init pme2_init_early(void);
 
 static __init void p4080_init_early(void)
 {
+	if (system_state != SYSTEM_RUNNING) {
 #ifdef CONFIG_FSL_QMAN_CONFIG
 	qman_init_early();
 #endif
@@ -285,12 +286,13 @@ static __init void p4080_init_early(void)
 #ifdef CONFIG_FSL_PME2_CTRL
 	pme2_init_early();
 #endif
+	}
 }
 
 define_machine(p4080_ds) {
-	.name			= "WRHV P4080 DS",
-	.probe			= p4080_ds_probe,
-	.setup_arch		= mpc85xx_ds_setup_arch,
+	.name			= "Wind River Hypervisor P4080 DS",
+	.probe			= wrhv_p4080_probe,
+	.setup_arch		= wrhv_p4080_setup_arch,
 	.init_IRQ		= wrhv_mpc85xx_pic_init,
 #ifdef CONFIG_PCI
 	.pcibios_fixup_bus	= fsl_pcibios_fixup_bus,
@@ -302,9 +304,12 @@ define_machine(p4080_ds) {
 	.calibrate_decr		= wrhv_calibrate_decr,
 	.progress		= udbg_progress,
 	.init_early		= p4080_init_early,
-	.idle_loop		= wait_idle,
+	.power_save		= wrhv_power_save,
 	.set_law_base		= wrhv_set_law_base,
 	.set_law_attr		= wrhv_set_law_attr,
 	.get_law_attr		= wrhv_get_law_attr,
 	.get_mdio_bus		= p4080_get_vb_mdio_bus,
+#ifdef CONFIG_HOTPLUG_CPU
+	.cpu_die		= cpu_die,
+#endif
 };
-- 
1.6.5.2

