From 72a7a302d677080ce3fe8b99be4c0188277195ab Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Tue, 19 Jan 2010 21:41:41 -0800
Subject: [PATCH 1/5] WRHV/PPC: Improve the implementation of bsp service handle

Dropped the original get_bsp_clock_freq implementation since actually
these codes are redundant for more PPC targets, and it's also convenient
to draw out bsp service handle for other necessary handle in the future.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/include/asm/wrhv.h            |    3 ++
 arch/powerpc/kernel/vbi/wrhv.c             |   45 ++++++++++++++++++++++++++++
 arch/powerpc/platforms/85xx/wrhv_8572ds.c  |   31 +------------------
 arch/powerpc/platforms/85xx/wrhv_p4080ds.c |   31 +------------------
 4 files changed, 50 insertions(+), 60 deletions(-)

diff --git a/arch/powerpc/include/asm/wrhv.h b/arch/powerpc/include/asm/wrhv.h
index 28f0e85..b45ff6a 100644
--- a/arch/powerpc/include/asm/wrhv.h
+++ b/arch/powerpc/include/asm/wrhv.h
@@ -43,5 +43,8 @@ extern void wrhv_request_ipis(void);
 
 extern unsigned long wrhv_cpu_freq;
 
+extern uint32_t service_handle;
+extern void get_hv_bsp_server_handle(void);
+extern int get_bsp_clock_freq(void);
 #endif /* CONFIG_WRHV */
 #endif /* __ASM_WRHV_H */
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 0666f8e..1c2e6bd 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -220,6 +220,51 @@ int __init wrhv_enable_pci_law(void)
 	return 0;
 }
 
+uint32_t service_handle;
+void get_hv_bsp_server_handle(void)
+{
+	int32_t	rc;
+
+	rc = vbi_ns_lookup ("bspServer", 0, &service_handle);
+
+	if (rc) 
+		printk ("bspServer lookup returned error code: %d\n", rc);
+}
+
+int bsp_service_handle(VBI_BSP_MSG *ask_msg, VBI_BSP_MSG_REPLY *reply_msg)
+{
+	int32_t	rc = -1;
+
+	if (!service_handle) {
+		printk(KERN_ERR "Can't get bsp service handle!\n");
+		return rc;
+	}
+
+	rc = vbi_send (service_handle, ask_msg, sizeof(VBI_BSP_MSG), 
+			reply_msg, sizeof(VBI_BSP_MSG_REPLY), NULL, NULL);
+	if (rc) 
+		printk("vbi_send to the bspServer returned error code: %d\n", rc);
+	
+	return rc;
+}
+
+uint32_t get_bsp_clock_freq(void)
+{
+	VBI_BSP_MSG clk_msg;
+	VBI_BSP_MSG_REPLY clk_reply;
+	uint16_t rc = -1;
+	
+	clk_msg.request = VBI_BSP_CLK_FREQ;
+
+	rc = bsp_service_handle(&clk_msg, &clk_reply);
+
+	if (rc) 
+		return rc;
+
+	return (clk_reply.dataVal);
+
+}
+
 void wrhv_mapping(void)
 {
 	/* map in vbConfig address */
diff --git a/arch/powerpc/platforms/85xx/wrhv_8572ds.c b/arch/powerpc/platforms/85xx/wrhv_8572ds.c
index 81a7fdc..a2f0dc6 100644
--- a/arch/powerpc/platforms/85xx/wrhv_8572ds.c
+++ b/arch/powerpc/platforms/85xx/wrhv_8572ds.c
@@ -67,36 +67,6 @@ static int mpc85xx_exclude_device(struct pci_controller *hose,
 }
 #endif /* CONFIG_PCI */
 
-static int get_bsp_clock_freq(void)
-{
-	VBI_BSP_MSG		clk_msg;
-	VBI_BSP_MSG_REPLY	clk_reply;
-	VBI_NS_HANDLE		serviceHandle;
-	int32_t			rc;
-
-	rc = vbi_ns_lookup ("bspServer", 0, &serviceHandle);
-
-	if (rc != 0) {
-		printk ("bspServer lookup returned error code: %d\n", rc);
-		return 0;
-	}
-
-	clk_msg.request = VBI_BSP_CLK_FREQ; /* read or write */
-
-	rc = vbi_send (serviceHandle, &clk_msg,
-		sizeof(clk_msg), &clk_reply, sizeof(clk_reply), NULL, NULL);
-
-	if (rc != 0) {
-		printk("vbi_send to the bspServer returned error code: %d\n",
-			rc);
-		return 0;
-	}
-
-	printk("bspServer replied clock freq value 0x%x\n",
-		 clk_reply.dataVal);
-	return clk_reply.dataVal;
-}
-
 int wrhv_8572ds_set_law_base(int index, unsigned long long addr)
 {
 	/* Set base address */
@@ -131,6 +101,7 @@ static void __init wrhv_8572ds_setup_arch(void)
 	if (ppc_md.progress)
 		ppc_md.progress("wrhv_8572ds_setup_arch()", 0);
 
+	get_hv_bsp_server_handle();
 	wrhv_cpu_freq = get_bsp_clock_freq();
 
 #ifdef CONFIG_PCI
diff --git a/arch/powerpc/platforms/85xx/wrhv_p4080ds.c b/arch/powerpc/platforms/85xx/wrhv_p4080ds.c
index a77f5a0..ea0b775 100644
--- a/arch/powerpc/platforms/85xx/wrhv_p4080ds.c
+++ b/arch/powerpc/platforms/85xx/wrhv_p4080ds.c
@@ -51,36 +51,6 @@ void cpu_die(void)
 static int primary_phb_addr;
 #endif
 
-static int get_bsp_clock_freq(void)
-{
-	VBI_BSP_MSG		clk_msg;
-	VBI_BSP_MSG_REPLY	clk_reply;
-	VBI_NS_HANDLE		serviceHandle;
-	int32_t			rc;
-
-	rc = vbi_ns_lookup ("bspServer", 0, &serviceHandle);
-
-	if (rc != 0) {
-		printk ("bspServer lookup returned error code: %d\n", rc);
-		return 0;
-	}
-
-	clk_msg.request = VBI_BSP_CLK_FREQ; /* read or write */
-
-	rc = vbi_send (serviceHandle, &clk_msg,
-		sizeof(clk_msg), &clk_reply, sizeof(clk_reply), NULL, NULL);
-
-	if (rc != 0) {
-		printk("vbi_send to the bspServer returned error code: %d\n",
-			rc);
-		return 0;
-	}
-
-	printk("bspServer replied clock freq value 0x%x\n",
-		 clk_reply.dataVal);
-	return clk_reply.dataVal;
-}
-
 /*
  * Setup the architecture
  */
@@ -127,6 +97,7 @@ static void __init mpc85xx_ds_setup_arch(void)
 	wrhv_smp_init();
 #endif
 
+	get_hv_bsp_server_handle();
 	wrhv_cpu_freq = get_bsp_clock_freq();
 
 #ifdef CONFIG_PCI
-- 
1.6.5.2

