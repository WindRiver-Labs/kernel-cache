From 6149c8ebb38c88d11161a2999a8c83891f3a96ad Mon Sep 17 00:00:00 2001
From: Yongli He <yongli.he@windriver.com>
Date: Thu, 10 Dec 2009 21:35:31 -0800
Subject: [PATCH 7/7] fsl-p4080/smp: use ipi irqchip

avoid ipi dropped by handle_fasteio_irq without handling.
void
handle_fasteoi_irq(unsigned int irq, struct irq_desc *desc)
{
.....
if (unlikely(desc->status & IRQ_INPROGRESS))
                goto out;
......
ipi  has chance of not being handled but just out.

Signed-off-by: Yongli He <yongli.he@windriver.com>
---
 arch/powerpc/kernel/vbi/wrhv.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 07ea8e6..6983abd 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -1136,6 +1136,9 @@ void wrhv_request_ipis(void)
 		panic("WRHV reslove irq for IPI failed.\n");
 
 	for (i = 0; i < 4; i++) {
+		set_irq_chip_and_handler_name(irq_base+i,
+			&wrhv_ipi_irq_chip, handle_percpu_irq, "per_cpu");
+
 		err = request_irq(irq_base+i, wrhv_ipi_action,
 				  IRQF_DISABLED|IRQF_PERCPU,
 				  ipi_names[i], (void *)i);
-- 
1.6.5.2

