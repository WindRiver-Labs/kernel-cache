From 0b5483fae9f53a6c4744294404ac29c31c344e5d Mon Sep 17 00:00:00 2001
From: Benjamin Walsh <benjamin.walsh@windriver.com>
Date: Fri, 17 Sep 2010 13:13:25 -0700
Subject: [PATCH 6/8] kexec/p4080: Coming from a kexec boot, override BMan FQDR BAR

We're coming from a kexec reboot, of course the register will have a
non-zero value in it, but we want to reallocate the memory from the
new kernel, not use the old memory, which might be used for something
else in the new kernel.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
Integrated-by: Benjamin Walsh <benjamin.walsh@windriver.com>
---
 drivers/hwalloc/bman_config.c |   18 +++++++++++++++++-
 1 files changed, 17 insertions(+), 1 deletions(-)

diff --git a/drivers/hwalloc/bman_config.c b/drivers/hwalloc/bman_config.c
index c53e2e3..12236dd 100644
--- a/drivers/hwalloc/bman_config.c
+++ b/drivers/hwalloc/bman_config.c
@@ -171,6 +171,22 @@ static void bm_set_pool(struct bman *bm, u8 pool, u32 swdet, u32 swdxt,
 	bm_out(POOL_HWDXT(pool), __generate_thresh(hwdxt, 1));
 }
 
+#ifdef CONFIG_KEXEC_POWERPC_SMP_BOOTABLE
+/* we're coming from a kexec reboot, of course the register will have a
+ * non-zero value in it, but we want to reallocate the memory from the
+ * new kernel, not use the old memory, which might be used for something
+ * else in the new kernel. */
+static u32 bm_get_fbpr_bar(struct bman* bm)
+{
+	return 0;
+}
+#else
+/* regular case */
+static u32 bm_get_fbpr_bar(struct bman* bm)
+{
+	return bm_in(FBPR_BAR);
+}
+#endif
 static void bm_set_memory(struct bman *bm, u16 eba, u32 ba, int prio, u32 size)
 {
 	u32 exp = ilog2(size);
@@ -182,7 +198,7 @@ static void bm_set_memory(struct bman *bm, u16 eba, u32 ba, int prio, u32 size)
 	/* We assume FBPR BAR is already configured correctly
 	 * if that value is nonzero.
 	 */
-	if ((bm_in(FBPR_BAR)) == 0) {
+	if (bm_get_fbpr_bar(bm) == 0) {
 		bm_out(FBPR_BARE, eba);
 		bm_out(FBPR_BAR, ba);
 		bm_out(FBPR_AR, (prio ? 0x40000000 : 0) | (exp - 1));
-- 
1.6.5.2

