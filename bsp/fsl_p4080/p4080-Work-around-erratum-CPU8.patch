From 8ba23ca4ca22868567e1e101e68b7f5ce49f4ee6 Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Tue, 10 Nov 2009 23:52:04 +0000
Subject: [PATCH] p4080: Work around erratum CPU8.

Writing to PID requires either two isyncs, or one non-isync context
synchronizing instruction.

Signed-off-by: Scott Wood <scottwood@freescale.com>
[Kevin: Original patch taken from Freescale p4080 SDK 2.0.1 ISO image.
Just some context changes in order to port to kernel 2.6.27]
Integrated-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/head_fsl_booke.S |    3 +++
 arch/powerpc/platforms/85xx/Kconfig  |    4 ++++
 2 files changed, 7 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/head_fsl_booke.S b/arch/powerpc/kernel/head_fsl_booke.S
index b818a21..8102a73 100644
--- a/arch/powerpc/kernel/head_fsl_booke.S
+++ b/arch/powerpc/kernel/head_fsl_booke.S
@@ -1348,6 +1348,9 @@ _GLOBAL(set_context)
 #endif
 	mtspr	SPRN_PID,r3
 	isync			/* Force context change */
+#ifdef CONFIG_P4080_ERRATUM_CPU8
+	isync
+#endif
 	blr
 
 _GLOBAL(flush_dcache_L1)
diff --git a/arch/powerpc/platforms/85xx/Kconfig b/arch/powerpc/platforms/85xx/Kconfig
index 76d639b..ec8d1a3 100644
--- a/arch/powerpc/platforms/85xx/Kconfig
+++ b/arch/powerpc/platforms/85xx/Kconfig
@@ -71,6 +71,10 @@ config P4080_ERRATUM_CPU6
 	bool "Work around P4080 rev 1 erratum cpu6"
 	default y if P4080_DS
 
+config P4080_ERRATUM_CPU8
+	bool "Work around P4080 rev 1 erratum CPU8"
+	default y if P4080_DS
+
 config KSI8560
         bool "Emerson KSI8560"
         select DEFAULT_UIMAGE
-- 
1.6.0.4

