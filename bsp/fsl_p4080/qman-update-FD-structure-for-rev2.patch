From 4648d28482268e64aec7f819e42be4667ed75243 Mon Sep 17 00:00:00 2001
From: Geoff Thorpe <Geoff.Thorpe@freescale.com>
Date: Thu, 21 Jan 2010 17:32:02 -0500
Subject: [PATCH 125/148] qman: update FD structure for rev2

The "pid" field is replaced with "liodn_offset" and the high-bits of the
address are reduced to 8-bit to make space for "eliodn_offset", all in
keeping with rev2 definitions. This should be backwards compatible with
rev1 code given that "pid" has no meaningful caller use and addresses with
more than 40 bits are pointless too.

Signed-off-by: Geoff Thorpe <Geoff.Thorpe@freescale.com>
[Cleanly applied the FSL SDK 2.0.3 patch:
"P4080-b2.0.2-qman-update-FD-structure-for-rev2.patch"]
Integrated-by: Yuri Nedel <Yuri.Nedel@windriver.com>
---
 drivers/hwqueue/qman_test_high.c |    4 ++--
 drivers/hwqueue/qman_test_low.c  |    7 ++++---
 drivers/match/pme2_high.c        |    4 ++--
 include/linux/fsl_qman.h         |   16 +++++++++-------
 4 files changed, 17 insertions(+), 14 deletions(-)

diff --git a/drivers/hwqueue/qman_test_high.c b/drivers/hwqueue/qman_test_high.c
index ce2584a..9ff8434 100644
--- a/drivers/hwqueue/qman_test_high.c
+++ b/drivers/hwqueue/qman_test_high.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2008, 2009 Freescale Semiconductor, Inc.
+/* Copyright (c) 2008-2010 Freescale Semiconductor, Inc.
  * All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
@@ -85,7 +85,7 @@ static int retire_complete, sdqcr_complete;
 /* Helpers for initialising and "incrementing" a frame descriptor */
 static void fd_init(struct qm_fd *__fd)
 {
-	__fd->addr_hi = 0xabba;		/* high 16-bits */
+	__fd->addr_hi = 0xab;		/* high 16-bits */
 	__fd->addr_lo = 0xdeadbeef;	/* low 32-bits */
 	__fd->format = qm_fd_contig_big;
 	__fd->length29 = 0x0000ffff;
diff --git a/drivers/hwqueue/qman_test_low.c b/drivers/hwqueue/qman_test_low.c
index e5d718d..230e5c4 100644
--- a/drivers/hwqueue/qman_test_low.c
+++ b/drivers/hwqueue/qman_test_low.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2008, 2009 Freescale Semiconductor, Inc.
+/* Copyright (c) 2008-2010 Freescale Semiconductor, Inc.
  * All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
@@ -104,7 +104,7 @@ static struct qm_fd fd, fd_dq;
 /* Helpers for initialising and "incrementing" a frame descriptor */
 static void fd_init(struct qm_fd *__fd)
 {
-	__fd->addr_hi = 0xabba;		/* high 16-bits */
+	__fd->addr_hi = 0xab;		/* high 16-bits */
 	__fd->addr_lo = 0xdeadbeef;	/* low 32-bits */
 	__fd->format = qm_fd_contig_big;
 	__fd->length29 = 0x0000ffff;
@@ -414,7 +414,8 @@ void qman_test_low(struct qm_portal *__p)
 		BUG_ON(dq->tok != TTOKEN);
 		BUG_ON(dq->fqid != fqid);
 		BUG_ON(dq->contextB != TCONTEXTB);
-		fd_dq.pid = dq->fd.pid;
+		fd_dq.liodn_offset = dq->fd.liodn_offset;
+		fd_dq.eliodn_offset = dq->fd.eliodn_offset;
 		BUG_ON(memcmp(&dq->fd, &fd_dq, sizeof(fd_dq)));
 		/* Modify the frame-descriptor for next time */
 		fd_inc(&fd_dq);
diff --git a/drivers/match/pme2_high.c b/drivers/match/pme2_high.c
index f28c486..33def3e 100644
--- a/drivers/match/pme2_high.c
+++ b/drivers/match/pme2_high.c
@@ -1,4 +1,4 @@
-/* Copyright (c) 2008, 2009, Freescale Semiconductor, Inc.
+/* Copyright (c) 2008-2010 Freescale Semiconductor, Inc.
  * All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
@@ -686,7 +686,7 @@ int pme_ctx_ctrl_nop(struct pme_ctx *ctx, u32 flags,
 	token->base_token.cmd_type = pme_cmd_nop;
 	/* enqueue the NOP command to PME */
 	memset(&fd, 0, sizeof(fd));
-	fd.addr_hi = 0xfeed;
+	fd.addr_hi = 0x00;
 	fd.addr_lo = (u32)token;
 	pme_fd_cmd_nop(&fd);
 	return do_work(ctx, flags, &fd, &token->base_token, NULL, 0);
diff --git a/include/linux/fsl_qman.h b/include/linux/fsl_qman.h
index b083216..10798dc 100644
--- a/include/linux/fsl_qman.h
+++ b/include/linux/fsl_qman.h
@@ -1,4 +1,4 @@
-/* Copyright (c) 2008, 2009 Freescale Semiconductor, Inc.
+/* Copyright (c) 2008-2010 Freescale Semiconductor, Inc.
  * All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
@@ -560,10 +560,12 @@ enum qm_fd_format {
 /* See 1.5.1.1: "Frame Descriptor (FD)" */
 struct qm_fd {
 	u8 dd:2;	/* dynamic debug */
-	u8 pid:6;	/* Partition ID */
+	u8 liodn_offset:6; /* aka. "Partition ID" in rev1.0 */
 	u8 bpid;	/* Buffer Pool ID */
-	u16 addr_hi;	/* high 16-bits of 48-bit address */
-	u32 addr_lo;	/* low 32-bits of 48-bit address */
+	u8 eliodn_offset:4;
+	u8 __reserved:4;
+	u8 addr_hi;	/* high 8-bits of 40-bit address */
+	u32 addr_lo;	/* low 32-bits of 40-bit address */
 	/* The 'format' field indicates the interpretation of the remaining 29
 	 * bits of the 32-bit word. For packing reasons, it is duplicated in the
 	 * other union elements. */
@@ -598,9 +600,9 @@ struct qm_fd {
 
 /* See 2.2.1.3 Multi-Core Datapath Acceleration Architecture */
 struct qm_sg_entry {
-	u16 __reserved1;
-	u16 addr_hi;		/* high 16-bits of 48-bit address */
-	u32 addr_lo;		/* low 32-bits of 48-bit address */
+	u8 __reserved1[3];
+	u8 addr_hi;		/* high 8-bits of 40-bit address */
+	u32 addr_lo;		/* low 32-bits of 40-bit address */
 	u32 extension:1; 	/* Extension bit */
 	u32 final:1; 		/* Final bit */
 	u32 length:30;
-- 
1.6.5.2

