From a682b00cbc29fa4c7740510a2a92f5189de08956 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Wed, 12 May 2010 16:39:51 +0800
Subject: [PATCH 12/15] WRHV/fsl_p4080: Support PCIE

1> Remove unsupported PCIE bus nodes on the dts file from the native dts.
And only add 'target-id' property for configuring LAW.

2> Provide some necessary functions to enable/setup PCIE Law

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/boot/dts/wrhv_p4080ds.dts      |   77 +--------------------------
 arch/powerpc/platforms/85xx/wrhv_p4080_ds.c |   32 +++++++++++
 2 files changed, 33 insertions(+), 76 deletions(-)

diff --git a/arch/powerpc/boot/dts/wrhv_p4080ds.dts b/arch/powerpc/boot/dts/wrhv_p4080ds.dts
index c357be7..9b26c0d 100644
--- a/arch/powerpc/boot/dts/wrhv_p4080ds.dts
+++ b/arch/powerpc/boot/dts/wrhv_p4080ds.dts
@@ -46,8 +46,6 @@
 		serial2 = &serial2;
 		serial3 = &serial3;
 		pci0 = &pci0;
-		pci1 = &pci1;
-		pci2 = &pci2;
 		usb0 = &usb0;
 		usb1 = &usb1;
 		dma0 = &dma0;
@@ -1746,6 +1744,7 @@
 	pci0: pcie@fe200000 {
 		compatible = "fsl,p4080-pcie";
 		device_type = "pci";
+		target-id = <0>;
 		#interrupt-cells = <1>;
 		#size-cells = <2>;
 		#address-cells = <3>;
@@ -1781,80 +1780,6 @@
 		};
 	};
 
-	pci1: pcie@fe201000 {
-		compatible = "fsl,p4080-pcie";
-		device_type = "pci";
-		#interrupt-cells = <1>;
-		#size-cells = <2>;
-		#address-cells = <3>;
-		reg = <0 0xfe201000 0 0x1000>;
-		bus-range = <0 0xff>;
-		ranges = <0x02000000 0x0 0xa0000000 0 0xa0000000 0x0 0x20000000
-			  0x01000000 0x0 0x00000000 0 0xf8010000 0x0 0x00010000>;
-		clock-frequency = <0x1fca055>;
-		fsl,msi = <&msi1>;
-		interrupt-parent = <&mpic>;
-		interrupts = <16 2>;
-		interrupt-map-mask = <0xf800 0 0 7>;
-		interrupt-map = <
-			/* IDSEL 0x0 */
-			0000 0 0 1 &mpic 41 1
-			0000 0 0 2 &mpic 5 1
-			0000 0 0 3 &mpic 6 1
-			0000 0 0 4 &mpic 7 1
-			>;
-		pcie@0 {
-			reg = <0 0 0 0 0>;
-			#size-cells = <2>;
-			#address-cells = <3>;
-			device_type = "pci";
-			ranges = <0x02000000 0 0x80000000
-				  0x02000000 0 0x80000000
-				  0 0x20000000
-
-				  0x01000000 0 0x00000000
-				  0x01000000 0 0x00000000
-				  0 0x00010000>;
-		};
-	};
-
-	pci2: pcie@fe202000 {
-		compatible = "fsl,p4080-pcie";
-		device_type = "pci";
-		#interrupt-cells = <1>;
-		#size-cells = <2>;
-		#address-cells = <3>;
-		reg = <0 0xfe202000 0 0x1000>;
-		bus-range = <0x0 0xff>;
-		ranges = <0x02000000 0 0xc0000000 0 0xc0000000 0 0x20000000
-			  0x01000000 0 0x00000000 0 0xf8020000 0 0x00010000>;
-		clock-frequency = <0x1fca055>;
-		fsl,msi = <&msi2>;
-		interrupt-parent = <&mpic>;
-		interrupts = <16 2>;
-		interrupt-map-mask = <0xf800 0 0 7>;
-		interrupt-map = <
-			/* IDSEL 0x0 */
-			0000 0 0 1 &mpic 42 1
-			0000 0 0 2 &mpic 9 1
-			0000 0 0 3 &mpic 10 1
-			0000 0 0 4 &mpic 11 1
-			>;
-		pcie@0 {
-			reg = <0 0 0 0 0>;
-			#size-cells = <2>;
-			#address-cells = <3>;
-			device_type = "pci";
-			ranges = <0x02000000 0 0x80000000
-				  0x02000000 0 0x80000000
-				  0 0x20000000
-
-				  0x01000000 0 0x00000000
-				  0x01000000 0 0x00000000
-				  0 0x00010000>;
-		};
-	};
-
 	fsl,dpaa {
 		compatible = "fsl,p4080-dpaa", "fsl,dpaa";
 
diff --git a/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c b/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
index 5958675..017bc87 100644
--- a/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
+++ b/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
@@ -53,6 +53,32 @@ static int primary_phb_addr;
 extern void __init wrhv_smp_init(void);
 #endif
 
+int wrhv_p4080_set_law_base(int index, unsigned long long addr)
+{
+	/* Set High base address */
+	out_be32((unsigned int *)(law_base + 0xc00 + index * 0x10), (addr >> 32) & 0xf);
+	/* Set Low base address */
+	out_be32((unsigned int *)(law_base + 0xc04 + index * 0x10), (unsigned int)addr);
+	return 0;
+} 
+
+int wrhv_p4080_set_law_attr(int index, unsigned int attr)
+{
+	/* Set Attributes */
+	out_be32((unsigned int *)(law_base + 0xc08 + index * 0x10), attr);
+
+	return 0;
+} 
+
+int wrhv_p4080_get_law_attr(int index)
+{
+	unsigned int attr = -1;
+
+	/* Get Attributes */
+	attr = in_be32((unsigned int *)(law_base + 0xc08 + index * 0x10));
+	return attr;
+}
+
 static void __init mpc85xx_ds_setup_arch(void)
 {
 #ifdef CONFIG_PCI
@@ -83,6 +109,8 @@ static void __init mpc85xx_ds_setup_arch(void)
 		hose = pci_find_hose_for_OF_device(np);
 		max = min(max, hose->dma_window_base_cur +
 				hose->dma_window_size);
+
+		ppc_setup_pci_law(np);
 	}
 #endif
 
@@ -213,6 +241,7 @@ define_machine(p4080_ds) {
 	.init_IRQ		= wrhv_mpc85xx_pic_init,
 #ifdef CONFIG_PCI
 	.pcibios_fixup_bus	= fsl_pcibios_fixup_bus,
+	.enable_pci_law 	= wrhv_enable_pci_law,
 #endif
 	.get_irq		= wrhv_vioapic_get_irq,
 	.restart		= wrhv_restart,
@@ -220,4 +249,7 @@ define_machine(p4080_ds) {
 	.progress		= udbg_progress,
 	.init_early		= p4080_init_early,
 	.idle_loop		= wait_idle,
+	.set_law_base		= wrhv_p4080_set_law_base,	
+	.set_law_attr		= wrhv_p4080_set_law_attr,
+	.get_law_attr		= wrhv_p4080_get_law_attr,
 };
-- 
1.6.5.2

