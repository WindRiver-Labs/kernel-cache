From 587222cc50f2efa8536dc238589a53963fff8fca Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 4 Dec 2009 22:58:21 -0800
Subject: [PATCH 64/77] WRHV/fsl_p4080: create one tlb to map uart

We have to map uart at the first boot phase since the HY dose not map devices
from XML on E500mc.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/boot/ns16550.c |   32 ++++++++++++++++++++++++++++++++
 1 files changed, 32 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/boot/ns16550.c b/arch/powerpc/boot/ns16550.c
index 8c9ead9..547de52 100644
--- a/arch/powerpc/boot/ns16550.c
+++ b/arch/powerpc/boot/ns16550.c
@@ -52,6 +52,34 @@ static u8 ns16550_tstc(void)
 	return ((in_8(reg_base + (UART_LSR << reg_shift)) & UART_LSR_DR) != 0);
 }
 
+#ifdef	CONFIG_WRHV
+#define TLBWE_CODE		0x7C0007A4
+#define MAS0_TLBSEL0_ENTRY0	0x0
+#define MAS1_VALID_4K_TSIZE	(0x80000000|((1 << 8) & 0x00000F00))
+#define MAS2_IG			0x0000000a
+#define MAS2_SXWR		0x00000015
+
+/* Here we have to create ont TLB0 entry to map uart since the Hypervisor dose
+ * not map this while pass the guest OS on E500mc. */
+static void wrhv_uart_tlb0_creat(void)
+{
+	/* Write MAS0/1/2/3 to create tlb0 to map uart. And note 
+	 * r3 should be privileged instruction code as the HY expect. */
+	__asm__ __volatile__(
+		"mtspr  0x270,%0\n"
+		"mtspr  0x271,%1\n"
+		"mtspr  0x272,%2\n"
+		"mtspr  0x273,%3\n"
+		"lis    3,%4@h\n"
+		"ori    3,3,%4@l\n"
+		"tlbwe\n"
+	:
+	:"r" (MAS0_TLBSEL0_ENTRY0), "r" (MAS1_VALID_4K_TSIZE),
+		"r" ((unsigned int)reg_base|MAS2_IG), "r" ((unsigned int)reg_base|MAS2_SXWR), "i" (TLBWE_CODE)
+	);
+}
+#endif
+
 int ns16550_console_init(void *devp, struct serial_console_data *scdp)
 {
 	int n;
@@ -68,6 +96,10 @@ int ns16550_console_init(void *devp, struct serial_console_data *scdp)
 	if (n != sizeof(reg_shift))
 		reg_shift = 0;
 
+#ifdef	CONFIG_WRHV
+	wrhv_uart_tlb0_creat();
+#endif
+
 	scdp->open = ns16550_open;
 	scdp->putc = ns16550_putc;
 	scdp->getc = ns16550_getc;
-- 
1.6.5.2

