From d3d9aa6b401a0083a19ce539acaf1945900918f5 Mon Sep 17 00:00:00 2001
From: Benjamin Walsh <benjamin.walsh@windriver.com>
Date: Thu, 16 Sep 2010 13:24:06 -0700
Subject: [PATCH 1/8] P4080: Fix invalid, unaligned 16-bit access on 32-bit reg

FM_IP_REV_1-FMan IP Block Revision 1 register can only be
accessed in 32-bit chunks. Compiler seems to get smart with

var = <register access> & 0xffff;

and produces a lhz instruction on the lower 16-bit instead
of a lwz on the full register.

This caused simics to stop twice while booting the kernel.

Signed-off-by: Benjamin Walsh <benjamin.walsh@windriver.com>
---
 .../kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c b/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c
index ba132a5..c553a5c 100644
--- a/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c
+++ b/drivers/net/dpa/NetCommSw/user/env/linux/kernel/2.6/wrappers/Peripherals/FM/lnxwrp_fm.c
@@ -659,7 +659,8 @@ typedef _Packed struct {
     uint8_t     physRxPortId[] = {0x8,0x9,0xa,0xb,0x10};
     uint8_t     physOhPortId[] = {0x1,0x2,0x3,0x4,0x5,0x6,0x7};
 
-    fmRev = (uint32_t)(*CAST_UINT64_TO_POINTER_TYPE(uint32_t, (p_LnxWrpFmDev->fmBaseAddr+FM_FPM_IP_REV_1_OFFSET)) & 0xffff);
+    fmRev = (uint32_t)(*CAST_UINT64_TO_POINTER_TYPE(uint32_t,
+			(p_LnxWrpFmDev->fmBaseAddr+FM_FPM_IP_REV_1_OFFSET)));
     p_Plr = CAST_UINT64_TO_POINTER_TYPE(t_Plr, (p_LnxWrpFmDev->fmBaseAddr+FM_DMA_PLR_OFFSET));
 #ifdef MODULE
     for (i=0;i<FM_MAX_NUM_OF_PARTITIONS/2;i++)
@@ -684,7 +685,7 @@ typedef _Packed struct {
         /* OH port #0 is host-command, don't need this workaround */
         if (i == 0)
             continue;
-        if (fmRev == 0x0100)
+        if ((fmRev & 0xffff) == 0x0100)
             p_LnxWrpFmDev->opPorts[i-1].settings.param.specificParams.nonRxParams.opPartitionId =
                 p_Ppids->fmbm_ppid[physOhPortId[i]-1];
     }
-- 
1.6.5.2

