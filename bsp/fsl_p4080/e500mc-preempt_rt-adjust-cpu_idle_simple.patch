From 01a91fe47504dca0b2cfe545e9175314bdd0391b Mon Sep 17 00:00:00 2001
From: Weiwei Wang <weiwei.wang@windriver.com>
Date: Fri, 29 Apr 2011 14:49:27 +0800
Subject: [PATCH] e500mc/preempt_rt: adjust cpu_idle_simple

e500mc can not doze due to an erratum, we use "wait" instruction
as ppc_md.power_save. And we can't disable irq when "wait" runs, so
delete irq operations here. 'if (!need_resched() && !cpu_should_die())'
is also replaced by 'while (!need_resched() && !cpu_should_die())' to
avoid calling schedule() when need_resched() is false.

Signed-off-by: Weiwei Wang <weiwei.wang@windriver.com>
---
 arch/powerpc/kernel/idle.c |    4 +---
 1 files changed, 1 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/kernel/idle.c b/arch/powerpc/kernel/idle.c
index 52641fc..204b037 100644
--- a/arch/powerpc/kernel/idle.c
+++ b/arch/powerpc/kernel/idle.c
@@ -115,14 +115,12 @@ void cpu_idle_simple(void)
 	while (1) {
 		tick_nohz_stop_sched_tick(1);
 
-		local_irq_disable();
 		stop_critical_timings();
 
-		if (!need_resched() && !cpu_should_die())
+		while (!need_resched() && !cpu_should_die())
 			ppc_md.power_save();
 
 		start_critical_timings();
-		local_irq_enable();
 
 		tick_nohz_restart_sched_tick();
 
-- 
1.7.0.4

