From b8fad0008c73fb5d7dbd09876eebbcc90f0f1381 Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Thu, 10 Dec 2009 17:50:59 -0600
Subject: [PATCH 109/148] dpa: Free scatter-gather blocks.

This patch resolves a memory leak I was seeing under sustained heavy traffic.

Tested with CONFIG_DEBUG_VM, no over-frees reported.

Signed-off-by: Scott Wood <scottwood@freescale.com>
[Applied the FSL SDK 2.0.3 patch
"kernel-2.6.30-dpa-Free-scatter-gather-blocks.patch"]
Integrated-by: Yuri Nedel <Yuri.Nedel@windriver.com>
---
 drivers/net/dpa/dpa.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/drivers/net/dpa/dpa.c b/drivers/net/dpa/dpa.c
index 800526a..df821ca 100644
--- a/drivers/net/dpa/dpa.c
+++ b/drivers/net/dpa/dpa.c
@@ -672,8 +672,10 @@ dpa_fd_release(const struct net_device *net_dev, const struct qm_fd *fd)
 			}
 		} while (!sgt[i-1].final);
 
-		if (_dpa_bp->kernel_pool)
+		if (_dpa_bp->kernel_pool) {
 			kunmap(page);
+			put_page(page);
+		}
 	}
 
 	if (!_dpa_bp->kernel_pool) {
@@ -1396,12 +1398,14 @@ static int dpa_process_sg(struct net_device *net_dev, struct sk_buff *skb,
 		goto err_pspb_pull_failed;
 	}
 	kunmap(page);
+	put_page(page);
 
 	return 0;
 
 err_pspb_pull_failed:
 err_bpid2pool_failed:
 	kunmap(page);
+	put_page(page);
 	/* Free all the buffers in the skb */
 	dev_kfree_skb(skb);
 	return err;
-- 
1.6.5.2

