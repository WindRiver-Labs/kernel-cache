From cad7cf5dabe60cfc07ae7762c1cb1dc8e0e3df06 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Mon, 30 Nov 2009 03:33:17 -0800
Subject: [PATCH 2/4] powerpc/85xx: reorder local_irq_save/restore function

The ioremap/iounmap can't be invoked with IRQ disabled.
So reorder local_irq_save/restore to fix this bug.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/platforms/85xx/amp.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/platforms/85xx/amp.c b/arch/powerpc/platforms/85xx/amp.c
index 46ba445..832d9fc 100755
--- a/arch/powerpc/platforms/85xx/amp.c
+++ b/arch/powerpc/platforms/85xx/amp.c
@@ -44,7 +44,6 @@ void startcore(u64 entryPt, int nr)
 	struct device_node *np;
 	__iomem u32 *bptr_vaddr;
 
-	local_irq_save(flags);
 
 	np = of_get_cpu_node(nr, NULL);
 	cpu_rel_addr = of_get_property(np, "cpu-release-addr", NULL);
@@ -62,6 +61,7 @@ void startcore(u64 entryPt, int nr)
 	if (bptr_vaddr == NULL)
 		return;
 
+	local_irq_save(flags);
 #ifdef CONFIG_PPC_E500MC
 	nr <<= 5;
 #endif
@@ -76,10 +76,10 @@ void startcore(u64 entryPt, int nr)
 	while (in_be32(bptr_vaddr + BOOT_ENTRY_ADDR_LOWER) != 3);
 
 	out_be32(bptr_vaddr + BOOT_ENTRY_ADDR_LOWER, 1);
+	local_irq_restore(flags);
 
 	iounmap(bptr_vaddr);
 
-	local_irq_restore(flags);
 	printk(KERN_DEBUG "CPU%d RELEASE at %llx\n", nr, *cpu_rel_addr);
 
 }
-- 
1.6.5.2

