From 6e2f27d2f948bc27880938376362952fd25c49d4 Mon Sep 17 00:00:00 2001
From: Emil Medve <Emilian.Medve@freescale.com>
Date: Thu, 22 Oct 2009 16:26:17 -0500
Subject: [PATCH] P4080/DPA: Use of_parse_phandle() to reduce code size

Signed-off-by: Emil Medve <Emilian.Medve@Freescale.com>
[Kevin: Original patch taken from Freescale p4080 SDK 2.0 ISO image.
Apply cleanly to kernel 2.6.27]
Integrated-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/net/dpa/dpa.c |   28 +++++-----------------------
 1 files changed, 5 insertions(+), 23 deletions(-)

diff --git a/drivers/net/dpa/dpa.c b/drivers/net/dpa/dpa.c
index bc694b5..0171aba 100644
--- a/drivers/net/dpa/dpa.c
+++ b/drivers/net/dpa/dpa.c
@@ -1792,7 +1792,7 @@ dpa_bp_probe(struct of_device *_of_dev, size_t *count)
 		dev_node = of_find_node_by_phandle(phandle_prop[i]);
 		if (unlikely(dev_node == NULL)) {
 			cpu_dev_err(dev,
-				"%s:%hu:%s(): of_find_node_by_phandle failed\n",
+			      "%s:%hu:%s(): of_find_node_by_phandle() failed\n",
 				__file__, __LINE__, __func__);
 			return ERR_PTR(-EFAULT);
 		}
@@ -1850,19 +1850,12 @@ dpa_mac_probe(struct of_device *_of_dev)
 	struct of_device	*of_dev;
 	struct mac_device	*mac_dev;
 
-	phandle_prop = (typeof(phandle_prop))of_get_property(_of_dev->node,
-				"fsl,fman-mac", &lenp);
-	if (phandle_prop == NULL)
-		return NULL;
-
-	BUG_ON(lenp != sizeof(phandle));
-
 	dpa_dev = &_of_dev->dev;
 
-	mac_node = of_find_node_by_phandle(*phandle_prop);
+	mac_node = of_parse_phandle(_of_dev->node, "fsl,fman-mac", 0);
 	if (unlikely(mac_node == NULL)) {
 		cpu_dev_err(dpa_dev,
-			"%s:%hu:%s(): of_find_node_by_phandle() failed\n",
+			"%s:%hu:%s(): of_parse_phandle() failed\n",
 			__file__, __LINE__, __func__);
 		return ERR_PTR(-EFAULT);
 	}
@@ -2339,22 +2332,11 @@ dpa_probe(struct of_device *_of_dev)
 
 	/* QM */
 
-	phandle_prop = (typeof(phandle_prop))of_get_property(dpa_node,
-				"fsl,qman-channel", &lenp);
-	if (unlikely(phandle_prop == NULL)) {
-		if (netif_msg_probe(priv))
-			cpu_dev_err(dev, "%s:%hu:%s(): of_get_property(%s, fsl,qman-channel) failed\n",
-				    __file__, __LINE__, __func__, dpa_node->full_name);
-		_errno = -EINVAL;
-		goto _return_dpa_bp_free;
-	}
-	BUG_ON(lenp != sizeof(phandle));
-
-	dev_node = of_find_node_by_phandle(*phandle_prop);
+	dev_node = of_parse_phandle(dpa_node, "fsl,qman-channel", 0);
 	if (unlikely(dev_node == NULL)) {
 		if (netif_msg_probe(priv))
 			cpu_dev_err(dev,
-				"%s:%hu:%s: of_find_node_by_phandle() failed\n",
+				"%s:%hu:%s: of_parse_phandle() failed\n",
 				__file__, __LINE__, __func__);
 		_errno = -EFAULT;
 		goto _return_dpa_bp_free;
-- 
1.6.0.4

