From c2ae50f4979c0209fe6d653bcf91d5f3b225696b Mon Sep 17 00:00:00 2001
From: Emil Medve <Emilian.Medve@Freescale.com>
Date: Thu, 15 Oct 2009 10:11:01 -0500
Subject: [PATCH 063/148] P4080/DPA: Don't free BPIDs we didn't allocate

This fixes the following assert/BUG_ON() in the BMan driver:

kernel BUG at drivers/hwalloc/bman_driver.c:180!
Oops: Exception in kernel mode, sig: 5 [#1]
PREEMPT SMP NR_CPUS=8 P4080 DS
Modules linked in:
NIP: c0315060 LR: c031501c CTR: c01ff7b8
REGS: ee87fc50 TRAP: 0700   Not tainted  (2.6.30-00036-gf3fd2fb)
MSR: 00029002 <EE,ME,CE>  CR: 22424024  XER: 20000000
TASK = ee87db60[1] 'swapper' THREAD: ee87e000 CPU: 0
GPR00: 00000001 ee87fd00 ee87db60 00000001 00037fff 00000000 c02002d0 00037fff
GPR08: 00000001 c062e1c4 00000080 00008000 22424022 d0860874 00001000 eea364d0
GPR16: ef932418 ef932404 ef932410 00000000 ef1eedc0 0000000c ef932000 ef932400
GPR24: 00000004 c040d7b0 c0546600 eea364c0 ee87e000 00000010 ef930bd0 ef930b90
NIP [c0315060] bm_pool_free+0x64/0xac
LR [c031501c] bm_pool_free+0x20/0xac
Call Trace:
[ee87fd00] [c031501c] bm_pool_free+0x20/0xac (unreliable)
[ee87fd20] [c040dab8] _dpa_bp_free+0xac/0xcc
[ee87fd40] [c04140fc] _dpa_probe+0x37c/0x168c
[ee87fe30] [c03141b8] of_platform_device_probe+0x60/0xa0
[ee87fe50] [c0208e60] driver_probe_device+0xa0/0x198
[ee87fe70] [c0209014] __driver_attach+0xbc/0xc0
[ee87fe90] [c02085fc] bus_for_each_dev+0x70/0xac
[ee87fec0] [c0208c8c] driver_attach+0x24/0x34
[ee87fed0] [c0207db8] bus_add_driver+0xb4/0x258
[ee87ff00] [c0209384] driver_register+0x80/0x168
[ee87ff20] [c031407c] of_register_driver+0x54/0x70
[ee87ff30] [c05667a0] dpa_load+0x4c/0xa4
[ee87ff50] [c0001bbc] do_one_initcall+0x34/0x1b0
[ee87ffc0] [c054c2fc] kernel_init+0x15c/0x1c8
[ee87fff0] [c000f860] kernel_thread+0x4c/0x68
Instruction dump:
57a8d97e 3d20c063 5500103a 3929e1c0 7d290214 80e90540 57bd06fe 3d608000
7d6bec30 7d603839 7c000026 54001ffe <0f000000> 3d20c063 3929e1c0 89490548
---[ end trace 2ac4d6d61e0329f9 ]---

Signed-off-by: Emil Medve <Emilian.Medve@Freescale.com>
[Applied FSL SDK 2.0.3 patch
"kernel-2.6.30-P4080-DPA-Don-t-free-BPIDs-we-didn-t-allocat.patch"]
Integrated-by: Yuri Nedel <Yuri.Nedel@windriver.com>
---
 drivers/net/dpa/dpa.c |    7 +------
 1 files changed, 1 insertions(+), 6 deletions(-)

diff --git a/drivers/net/dpa/dpa.c b/drivers/net/dpa/dpa.c
index c76b200..b9932a6 100644
--- a/drivers/net/dpa/dpa.c
+++ b/drivers/net/dpa/dpa.c
@@ -329,8 +329,7 @@ _dpa_bp_alloc(struct net_device *net_dev, struct list_head *list,
 		cpu_dev_err(net_dev->dev.parent,
 				"%s:%hu:%s(): bman_new_pool() failed\n",
 				__file__, __LINE__, __func__);
-		_errno = -ENOMEM;
-		goto _return_bm_pool_free;
+		return -ENODEV;
 	}
 
 	/* paddr is only set for pools that are shared between partitions */
@@ -376,9 +375,6 @@ _dpa_bp_alloc(struct net_device *net_dev, struct list_head *list,
 
 _return_bman_free_pool:
 	bman_free_pool(dpa_bp->pool);
-_return_bm_pool_free:
-	if (dpa_bp->bpid == 0)
-		bm_pool_free(bp_params.bpid);
 
 	return _errno;
 }
@@ -442,7 +438,6 @@ _dpa_bp_free(struct device *dev, struct dpa_bp *dpa_bp)
 	bpid = dpa_pool2bpid(dpa_bp);
 	bman_free_pool(dpa_bp->pool);
 	list_del(&dpa_bp->list);
-	bm_pool_free(bpid);
 }
 
 static void __cold __attribute__((nonnull))
-- 
1.6.5.2

