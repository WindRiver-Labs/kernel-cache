From 57d91701649798406ce2dded58442d00eea75444 Mon Sep 17 00:00:00 2001
From: Andrew Liu <shengping.liu@windriver.com>
Date: Wed, 18 Aug 2010 14:11:34 +0800
Subject: [PATCH 5/5] ftrace: Turn off timing irqsoff/preemptof measurements while waiting in idle.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

From FSL vendor SDK 2.x.

This fixes the bug where some measurements are off the charts,
since the time in idle is measured as a region with preemption
disabled which it obviously isn't.

Signed-off-by: Fredrik Markstr√∂m <fredrik.markstrom@gmail.com>
Integrated-by: Andrew Liu <shengping.liu@windriver.com>
---
 arch/powerpc/kernel/idle.c |    8 +++++++-
 1 files changed, 7 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/kernel/idle.c b/arch/powerpc/kernel/idle.c
index 883bb67..52641fc 100644
--- a/arch/powerpc/kernel/idle.c
+++ b/arch/powerpc/kernel/idle.c
@@ -115,9 +115,15 @@ void cpu_idle_simple(void)
 	while (1) {
 		tick_nohz_stop_sched_tick(1);
 
-		while (!need_resched() && !cpu_should_die())
+		local_irq_disable();
+		stop_critical_timings();
+
+		if (!need_resched() && !cpu_should_die())
 			ppc_md.power_save();
 
+		start_critical_timings();
+		local_irq_enable();
+
 		tick_nohz_restart_sched_tick();
 
 		if (cpu_should_die())
-- 
1.6.5.2

