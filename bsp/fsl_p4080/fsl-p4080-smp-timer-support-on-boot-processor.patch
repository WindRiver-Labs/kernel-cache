From 737fa234c1547ade95e3cc8fe0d0900076ee108e Mon Sep 17 00:00:00 2001
From: Yongli He <yongli.he@windriver.com>
Date: Thu, 10 Dec 2009 21:35:30 -0800
Subject: [PATCH 6/7] fsl-p4080/smp: timer support on boot processor

1. update walltime on only BP
2. add smp support to lost jiffies detection

Signed-off-by: Yongli He <yongli.he@windriver.com>
---
 kernel/vbi/wrhv.c |   11 +++++++----
 1 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/kernel/vbi/wrhv.c b/kernel/vbi/wrhv.c
index 59fa6a7..e605db7 100644
--- a/kernel/vbi/wrhv.c
+++ b/kernel/vbi/wrhv.c
@@ -147,18 +147,21 @@ unsigned long wrhv_calculate_cpu_khz(void)
 
 irqreturn_t __weak wrhv_timer_interrupt(int irq, void *dev_id)
 {
-	static long long mark_offset;
+	static DEFINE_PER_CPU(long long, mark_offset);
+	int cpu;
 	long long ticks;
 	int lost_jiffies = 0;
 	struct pt_regs *regs = get_irq_regs();
 
+	cpu = smp_processor_id();
 	ticks = wr_vb_status->tick_count;
-	ticks -= mark_offset;
+	ticks -= per_cpu(mark_offset,cpu);
 	lost_jiffies = ticks - 1;
-	mark_offset = wr_vb_status->tick_count;
+	per_cpu(mark_offset,cpu) = wr_vb_status->tick_count;
 
 	do {
-		do_timer(1);
+		if(!smp_processor_id())
+			do_timer(1);
 		update_process_times(user_mode(regs));
 		profile_tick(CPU_PROFILING);
 		if (lost_jiffies > (2*HZ)) {
-- 
1.6.5.2

