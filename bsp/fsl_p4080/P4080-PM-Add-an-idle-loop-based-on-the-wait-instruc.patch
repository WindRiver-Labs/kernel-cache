From 6c884c58ffad5ac3926aaa0b9b58f8ec04cf778c Mon Sep 17 00:00:00 2001
From: Scott Wood <scottwood@freescale.com>
Date: Thu, 19 Nov 2009 06:42:00 +0800
Subject: [PATCH] P4080/PM: Add an idle loop based on the wait instruction, and use it on e500mc.

e500mc cannot doze due to an erratum, but it has a "wait" instruction
that is similar.  It is implemented as a separate idle loop rather than
an inner-loop power_save() callback, because we don't want IRQs or
IRQ-off tracing disabled, and most of the rest of cpu_idle() is
unnecessary even if possibly harmless.

Note that on platforms that select this idle loop will not be able to use
nap-on-idle.

Signed-off-by: Scott Wood <scottwood@freescale.com>
[Kevin: Original patch taken from Freescale p4080 SDK 2.0.2 tar
package, remove the PPC_WIAT opcode definition since we already
have the support for wait instruction in our compiler, and some minor
context change in order to port to kernel
2.6.27. Ensure we have the CPU_FTR_BIG_PHYS for e500mc core otherwise
e500mc works incorrectly when accessing memory beyond 4G.]
Integrated-by: Kevin Hao <kexin@windriver.com>
---
 arch/powerpc/include/asm/cputable.h    |    6 +++---
 arch/powerpc/include/asm/machdep.h     |    1 +
 arch/powerpc/kernel/idle.c             |   21 +++++++++++++++++++++
 arch/powerpc/platforms/85xx/p4080_ds.c |    1 +
 4 files changed, 26 insertions(+), 3 deletions(-)

diff --git a/arch/powerpc/include/asm/cputable.h b/arch/powerpc/include/asm/cputable.h
index dbbed17..31913c8 100644
--- a/arch/powerpc/include/asm/cputable.h
+++ b/arch/powerpc/include/asm/cputable.h
@@ -376,9 +376,9 @@ extern const char *powerpc_base_platform;
 #define CPU_FTRS_E500_2	(CPU_FTR_MAYBE_CAN_DOZE | CPU_FTR_USE_TB | \
 	    CPU_FTR_SPE_COMP | CPU_FTR_MAYBE_CAN_NAP | CPU_FTR_BIG_PHYS | \
 	    CPU_FTR_NODSISRALIGN | CPU_FTR_NOEXECUTE)
-#define CPU_FTRS_E500MC	(CPU_FTR_MAYBE_CAN_DOZE | CPU_FTR_USE_TB | \
-	    CPU_FTR_MAYBE_CAN_NAP | CPU_FTR_BIG_PHYS | CPU_FTR_NODSISRALIGN | \
-	    CPU_FTR_L2CSR | CPU_FTR_LWSYNC | CPU_FTR_NOEXECUTE)
+#define CPU_FTRS_E500MC	(CPU_FTR_USE_TB | CPU_FTR_MAYBE_CAN_NAP | \
+	    CPU_FTR_NODSISRALIGN | CPU_FTR_L2CSR | CPU_FTR_LWSYNC | \
+	    CPU_FTR_NOEXECUTE | CPU_FTR_BIG_PHYS)
 #define CPU_FTRS_GENERIC_32	(CPU_FTR_COMMON | CPU_FTR_NODSISRALIGN)
 
 /* 64-bit CPUs */
diff --git a/arch/powerpc/include/asm/machdep.h b/arch/powerpc/include/asm/machdep.h
index 35c97dc..78128d7 100644
--- a/arch/powerpc/include/asm/machdep.h
+++ b/arch/powerpc/include/asm/machdep.h
@@ -275,6 +275,7 @@ extern void e500_idle(void);
 extern void power4_idle(void);
 extern void power4_cpu_offline_powersave(void);
 extern void ppc6xx_idle(void);
+extern void wait_idle(void);
 
 /*
  * ppc_md contains a copy of the machine description structure for the
diff --git a/arch/powerpc/kernel/idle.c b/arch/powerpc/kernel/idle.c
index 31982d0..57a6606 100644
--- a/arch/powerpc/kernel/idle.c
+++ b/arch/powerpc/kernel/idle.c
@@ -13,6 +13,8 @@
  *
  * 32-bit and 64-bit versions merged by Paul Mackerras <paulus@samba.org>
  *
+ * Portions Copyright 2009 Freescale Semiconductor, Inc.
+ *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
  * as published by the Free Software Foundation; either version
@@ -97,6 +99,25 @@ void cpu_idle(void)
 	}
 }
 
+void wait_idle(void)
+{
+	while (1) {
+		tick_nohz_stop_sched_tick(1);
+
+		while (!need_resched() && !cpu_should_die())
+			asm volatile("wait");
+
+		tick_nohz_restart_sched_tick();
+
+		if (cpu_should_die())
+			cpu_die();
+
+		preempt_enable_no_resched();
+		schedule();
+		preempt_disable();
+	}
+}
+
 int powersave_nap;
 
 #ifdef CONFIG_SYSCTL
diff --git a/arch/powerpc/platforms/85xx/p4080_ds.c b/arch/powerpc/platforms/85xx/p4080_ds.c
index 597d9df..4b38674 100644
--- a/arch/powerpc/platforms/85xx/p4080_ds.c
+++ b/arch/powerpc/platforms/85xx/p4080_ds.c
@@ -215,4 +215,5 @@ define_machine(p4080_ds) {
 	.calibrate_decr		= generic_calibrate_decr,
 	.progress		= udbg_progress,
 	.init_early		= p4080_init_early,
+	.idle_loop		= wait_idle,
 };
-- 
1.6.0.4

