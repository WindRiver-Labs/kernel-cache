From 235aac764d62800f563d082b589bed3b8e5bc5de Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 14 May 2010 18:07:11 +0800
Subject: [PATCH 10/15] WRHV/fsl_p4080: Export the real start address of VB

We should export the real start address of current VB for other necessary
usages. Here we get this by calling DMA VBI to map '0x0' on the VB.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/sysdev/fsl_pci.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/sysdev/fsl_pci.c b/arch/powerpc/sysdev/fsl_pci.c
index bd63dd7..91d0d76 100644
--- a/arch/powerpc/sysdev/fsl_pci.c
+++ b/arch/powerpc/sysdev/fsl_pci.c
@@ -98,6 +98,10 @@ static int __init setup_one_atmu(struct ccsr_pci __iomem *pci,
 	return i;
 }
 
+#ifdef CONFIG_WRHV
+u32 raddr;
+EXPORT_SYMBOL(raddr);
+#endif
 /* atmu setup for fsl pci/pcie controller */
 static void __init setup_pci_atmu(struct pci_controller *hose,
 				  struct resource *rsrc)
@@ -217,6 +221,8 @@ static void __init setup_pci_atmu(struct pci_controller *hose,
 			if (vbi_get_guest_dma_addr(0, &paddr) == 0) {
 				out_be32(&pci->piw[win_idx].pitar,  paddr >> 12);
 				out_be32(&pci->piw[win_idx].piwbar, paddr >> 12);
+				/*FIXME: only support 32b physical address.*/
+				raddr = (paddr << 32);
 				printk ("Real Memory Start @%llx.\n", paddr);
 			} else
 				printk ("%s: it's failed when calling dma VBI.\n", __func__);
-- 
1.6.5.2

