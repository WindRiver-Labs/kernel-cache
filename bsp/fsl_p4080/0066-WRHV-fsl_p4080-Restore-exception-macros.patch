From f2d690b64fa49de4d8e6a4885ee6b464d1e55e96 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 4 Dec 2009 22:58:24 -0800
Subject: [PATCH 66/77] WRHV/fsl_p4080: Restore exception macros

For E500mc restore native exceptions as the following:
1> NORMAL_EXCEPTION_PROLOG
2> INSTRUCTION_STORAGE_EXCEPTION
3> PROGRAM_EXCEPTION
And bakc to corresponding handler:
1> native_transfer_to_handler
2> native_ret_from_syscall
3> native_syscall_exit_work
4> native_restore
5> native_switch

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/kernel/Makefile    |    4 ++++
 arch/powerpc/kernel/entry_32.S  |    2 +-
 arch/powerpc/kernel/head_wrhv.h |    4 ++++
 3 files changed, 9 insertions(+), 1 deletions(-)

diff --git a/arch/powerpc/kernel/Makefile b/arch/powerpc/kernel/Makefile
index cdb149f..3dd4840 100644
--- a/arch/powerpc/kernel/Makefile
+++ b/arch/powerpc/kernel/Makefile
@@ -61,7 +61,11 @@ obj64-$(CONFIG_HIBERNATION)	+= swsusp_asm64.o
 obj-$(CONFIG_MODULES)		+= module.o module_$(CONFIG_WORD_SIZE).o
 
 ifeq ($(CONFIG_WRHV),y)
+ifeq ($(CONFIG_PPC85xx_VT_MODE),y)
+obj-$(CONFIG_WRHV)              += entry_32.o wrhv_misc_32.o paravirt_entry_32.o
+else
 obj-$(CONFIG_WRHV)              += wrhv_entry_32.o wrhv_misc_32.o
+endif
 else
 obj-$(CONFIG_PARAVIRT)          += paravirt_entry_32.o paravirt_misc_32.o
 endif
diff --git a/arch/powerpc/kernel/entry_32.S b/arch/powerpc/kernel/entry_32.S
index e504e8a..df4acc6 100644
--- a/arch/powerpc/kernel/entry_32.S
+++ b/arch/powerpc/kernel/entry_32.S
@@ -810,7 +810,7 @@ restore:
        b       paravirt_restore
 #endif
 
-native_restore:
+_GLOBAL(native_restore)
 #ifdef CONFIG_44x
 	lis	r4,icache_44x_need_flush@ha
 	lwz	r5,icache_44x_need_flush@l(r4)
diff --git a/arch/powerpc/kernel/head_wrhv.h b/arch/powerpc/kernel/head_wrhv.h
index cbb439f..f28a229 100644
--- a/arch/powerpc/kernel/head_wrhv.h
+++ b/arch/powerpc/kernel/head_wrhv.h
@@ -30,6 +30,7 @@
 	 * r10 is trashed and r11 pointer on interrupt frame. All other
 	 * registers contain their value before the system call was executed.
 	 */
+#ifndef CONFIG_PPC85xx_VT_MODE
 #undef NORMAL_EXCEPTION_PROLOG
 #define NORMAL_EXCEPTION_PROLOG						     \
         mr      r4,r1;                                                       \
@@ -75,6 +76,7 @@
         lwz     r3,VB_STATUS_R3(r4);                                         \
         mr      r10,r4;                                                      \
         lwz     r4,VB_STATUS_R4(r4)
+#endif
 
 
 /*
@@ -112,6 +114,7 @@ label:
 	/* EXC_XFER_STD(0x1000, DebugException)	*/		\
 	EXC_XFER_TEMPLATE(DebugException, 0x2008, (MSR_KERNEL & ~(MSR_ME|MSR_DE|MSR_CE)), NOCOPY, transfer_to_handler_full, ret_from_except_full)
 
+#ifndef	CONFIG_PPC85xx_VT_MODE
 #undef INSTRUCTION_STORAGE_EXCEPTION
 #define INSTRUCTION_STORAGE_EXCEPTION					      \
 	START_EXCEPTION(InstructionStorage)				      \
@@ -131,6 +134,7 @@ label:
 	stw	r5,_ESR(r11);						      \
 	addi	r3,r1,STACK_FRAME_OVERHEAD;				      \
 	EXC_XFER_STD(0x0700, program_check_exception)
+#endif
 
 #undef DECREMENTER_EXCEPTION
 #define DECREMENTER_EXCEPTION						      \
-- 
1.6.5.2

