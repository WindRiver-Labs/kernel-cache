From 7cc82cf0e085d5e1a5820e8b51db0603c4fe75d6 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Fri, 4 Dec 2009 22:58:26 -0800
Subject: [PATCH 68/77] WRHV/fsl_p4080: Divide kernel and exception space

For the hypervisor implementation the Linux kernel should run the space with
AS=1, exception handler should be as AS=0. So re-define MSR_KERNEL macro, and
make sure it's correct while enter/exit the exception handler.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/include/asm/reg_booke.h |    8 ++++++++
 arch/powerpc/kernel/entry_32.S       |   10 ++++++++++
 2 files changed, 18 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/reg_booke.h b/arch/powerpc/include/asm/reg_booke.h
index c83fdd9..baa3291 100644
--- a/arch/powerpc/include/asm/reg_booke.h
+++ b/arch/powerpc/include/asm/reg_booke.h
@@ -23,9 +23,17 @@
 #define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_IR|MSR_DR|MSR_CE)
 #elif defined(CONFIG_BOOKE)
 #ifdef CONFIG_WR_OCD_DEBUG
+#if defined(CONFIG_PPC85xx_VT_MODE)
+#define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_CE|MSR_DE|MSR_IR|MSR_DR)
+#else
 #define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_CE|MSR_DE)
+#endif
+#else
+#if defined(CONFIG_PPC85xx_VT_MODE)
+#define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_CE|MSR_IR|MSR_DR)
 #else
 #define MSR_KERNEL	(MSR_ME|MSR_RI|MSR_CE)
+#endif
 #endif	/* OCD */
 #endif
 
diff --git a/arch/powerpc/kernel/entry_32.S b/arch/powerpc/kernel/entry_32.S
index df4acc6..819e30f 100644
--- a/arch/powerpc/kernel/entry_32.S
+++ b/arch/powerpc/kernel/entry_32.S
@@ -217,6 +217,10 @@ transfer_to_handler_cont:
 	lwz	r11,0(r9)		/* virtual address of handler */
 	lwz	r9,4(r9)		/* where to go when done */
         mtspr   SPRN_SRR0,r11
+#if defined(CONFIG_PPC85xx_VT_MODE)
+	/* Guest Exception should be AS = 0 */
+	rlwinm	r10,r10,0,~(MSR_IR|MSR_DR)
+#endif
 	mtspr	SPRN_SRR1,r10
 	mtlr	r9
 	SYNC
@@ -892,7 +896,13 @@ exc_exit_restart:
 	lwz	r12,_MSR(r1)
 exc_exit_start:
 	mtspr	SPRN_SRR0,r11
+#if defined(CONFIG_PPC85xx_VT_MODE)
+	ori	r12,r12,(MSR_IR|MSR_DR)
+#endif
 	mtspr	SPRN_SRR1,r12
+#if defined(CONFIG_PPC85xx_VT_MODE)
+	lwz	r12,_MSR(r1)
+#endif
 	REST_2GPRS(11, r1)
 	lwz	r1,GPR1(r1)
 	.globl exc_exit_restart_end
-- 
1.6.5.2

