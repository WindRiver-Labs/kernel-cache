From ad8c12d6022204c9bf1174be27a0d93df5c07c36 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Mon, 11 Jan 2010 21:33:29 -0800
Subject: [PATCH 5/6] WRHV/PPC: Implement one PCIE argument

Pass the cmd line to check if we should configure LAW for PCIE, by
one argument, wrhv_pci_law.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/include/asm/machdep.h         |    1 +
 arch/powerpc/include/asm/wrhv.h            |    1 +
 arch/powerpc/kernel/setup_32.c             |    5 +++++
 arch/powerpc/kernel/vbi/wrhv.c             |   18 ++++++++++++++++++
 arch/powerpc/platforms/85xx/wrhv_8572ds.c  |    1 +
 arch/powerpc/platforms/85xx/wrhv_p4080ds.c |    1 +
 6 files changed, 27 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/machdep.h b/arch/powerpc/include/asm/machdep.h
index 7fc9cdd..66a6cb3 100644
--- a/arch/powerpc/include/asm/machdep.h
+++ b/arch/powerpc/include/asm/machdep.h
@@ -264,6 +264,7 @@ struct machdep_calls {
 
 #ifdef CONFIG_VIRTUALIZATION
 	int (*earlycon_setup)(void);
+	int (*enable_pci_law)(void);
 #endif
 };
 
diff --git a/arch/powerpc/include/asm/wrhv.h b/arch/powerpc/include/asm/wrhv.h
index 708ec14..d93d43d 100644
--- a/arch/powerpc/include/asm/wrhv.h
+++ b/arch/powerpc/include/asm/wrhv.h
@@ -28,6 +28,7 @@ extern int __init wrhv_earlycon_setup(void);
 #ifdef CONFIG_PCI
 extern int ppc_get_pci_intr_wrhv(struct pci_dev *dev);
 #endif
+extern int wrhv_enable_pci_law(void);
 
 extern int __init smp_wrhv_probe(void);
 extern void smp_wrhv_message_pass(int target, int msg);
diff --git a/arch/powerpc/kernel/setup_32.c b/arch/powerpc/kernel/setup_32.c
index ff98b08..148a532 100644
--- a/arch/powerpc/kernel/setup_32.c
+++ b/arch/powerpc/kernel/setup_32.c
@@ -309,6 +309,11 @@ void __init setup_arch(char **cmdline_p)
 	if (ppc_md.earlycon_setup)
 		ppc_md.earlycon_setup();
 
+#ifdef	CONFIG_PCI
+	if (ppc_md.enable_pci_law)
+		ppc_md.enable_pci_law();
+#endif
+
 	find_legacy_serial_ports();
 
 	smp_setup_cpu_maps();
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index 6c0570a..42d7742 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -202,6 +202,24 @@ static int __init wrhv_macaddr_setup(char *str)
 
 __setup("wrhv_macaddr=", wrhv_macaddr_setup);
 
+int wrhv_pci_law = 0;
+int __init wrhv_enable_pci_law(void)
+{
+	const char *opt;
+	opt = strstr(cmd_line, "wrhv_pci_law=");
+	if (opt) {
+		opt += 13;
+		while (*opt && *opt == ' ')
+			opt++;
+		if (!strncmp(opt, "on", 2))
+			wrhv_pci_law = 1;
+		else
+			wrhv_pci_law = 0;
+	}
+	
+	return 0;
+}
+
 void wrhv_mapping(void)
 {
 	/* map in vbConfig address */
diff --git a/arch/powerpc/platforms/85xx/wrhv_8572ds.c b/arch/powerpc/platforms/85xx/wrhv_8572ds.c
index 7e93a85..ed2fee5 100644
--- a/arch/powerpc/platforms/85xx/wrhv_8572ds.c
+++ b/arch/powerpc/platforms/85xx/wrhv_8572ds.c
@@ -187,6 +187,7 @@ define_machine(wrhv_8572ds) {
 	.init_IRQ = wrhv_85xx_pic_init,
 #ifdef CONFIG_PCI
 	.pcibios_fixup_bus = fsl_pcibios_fixup_bus,
+	.enable_pci_law = wrhv_enable_pci_law,
 #endif
 	.show_cpuinfo = wrhv_8572ds_show_cpuinfo,
 	.get_irq = wrhv_vioapic_get_irq,
diff --git a/arch/powerpc/platforms/85xx/wrhv_p4080ds.c b/arch/powerpc/platforms/85xx/wrhv_p4080ds.c
index e498ad3..8d77dd8 100644
--- a/arch/powerpc/platforms/85xx/wrhv_p4080ds.c
+++ b/arch/powerpc/platforms/85xx/wrhv_p4080ds.c
@@ -202,6 +202,7 @@ define_machine(p4080_ds) {
 	.init_IRQ		= wrhv_sbc85xx_pic_init,
 #ifdef CONFIG_PCI
 	.pcibios_fixup_bus	= fsl_pcibios_fixup_bus,
+	.enable_pci_law 	= wrhv_enable_pci_law,
 #endif
 	.get_irq 		= wrhv_vioapic_get_irq,
 	.restart 		= wrhv_restart,
-- 
1.6.5.2

