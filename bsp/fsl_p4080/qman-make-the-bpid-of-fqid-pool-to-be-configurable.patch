From 265322825308eb53de9a6b6a0d66af137d6535da Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Mon, 26 Jul 2010 01:54:53 -0700
Subject: [PATCH] qman: make the bpid of fqid pool to be configurable

By default we use bpid 0 as the bman pool for fqid alloc.
But in sAMP when two linux are running at the same time,
there will be a conflict. So we add a new property
"qman-fqalloc-bpid" for qman device node in order to
configure the bpid of fqid pool.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 drivers/hwqueue/qman_driver.c  |   13 +++++++++++--
 drivers/hwqueue/qman_fqalloc.c |    5 +++--
 drivers/hwqueue/qman_private.h |    2 +-
 3 files changed, 15 insertions(+), 5 deletions(-)

diff --git a/drivers/hwqueue/qman_driver.c b/drivers/hwqueue/qman_driver.c
index b01f61c..7828ec8 100644
--- a/drivers/hwqueue/qman_driver.c
+++ b/drivers/hwqueue/qman_driver.c
@@ -400,7 +400,7 @@ bad_cpu_ph:
 static __init int qman_init(void)
 {
 	struct device_node *dn;
-	int ret;
+	int ret, bpid = 0;
 	for_each_compatible_node(dn, NULL, "fsl,qman-pool-channel") {
 		ret = fsl_qman_pool_channel_init(dn);
 		if (ret)
@@ -424,7 +424,16 @@ static __init int qman_init(void)
 	}
 #endif
 #ifdef CONFIG_FSL_QMAN_FQALLOCATOR
-	ret = __fqalloc_init();
+	dn = of_find_compatible_node(NULL, NULL, "fsl,qman");
+	if (dn) {
+		uint32_t *prop;
+		int len;
+
+		prop = of_get_property(dn, "fsl,qman-fqalloc-bpid", &len);
+		if (prop)
+			bpid = *prop;
+	}
+	ret = __fqalloc_init(bpid);
 	if (ret)
 		return ret;
 #endif
diff --git a/drivers/hwqueue/qman_fqalloc.c b/drivers/hwqueue/qman_fqalloc.c
index 07b24b1..b91b344 100644
--- a/drivers/hwqueue/qman_fqalloc.c
+++ b/drivers/hwqueue/qman_fqalloc.c
@@ -41,10 +41,11 @@
 /****************/
 
 static struct bman_pool *fq_pool;
-static const struct bman_pool_params fq_pool_params;
+static struct bman_pool_params fq_pool_params;
 
-__init int __fqalloc_init(void)
+__init int __fqalloc_init(u32 bpid)
 {
+	fq_pool_params.bpid = bpid;
 	fq_pool = bman_new_pool(&fq_pool_params);
 	if (!fq_pool)
 		return -ENOMEM;
diff --git a/drivers/hwqueue/qman_private.h b/drivers/hwqueue/qman_private.h
index 176e65a..5997f78 100644
--- a/drivers/hwqueue/qman_private.h
+++ b/drivers/hwqueue/qman_private.h
@@ -132,7 +132,7 @@ void __qm_portal_unbind(struct qm_portal *portal, u8 iface);
 
 /* Hooks for driver initialisation */
 #ifdef CONFIG_FSL_QMAN_FQALLOCATOR
-__init int __fqalloc_init(void);
+__init int __fqalloc_init(u32 bpid);
 #endif
 
 /* Revision info (for errata and feature handling) */
-- 
1.6.5.2

