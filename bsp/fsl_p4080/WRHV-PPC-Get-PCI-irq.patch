From 5cb9c9d7c2bdd17b6eb5302e1f24b7378bdb059e Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Mon, 11 Jan 2010 21:33:25 -0800
Subject: [PATCH 1/6] WRHV/PPC: Get PCI irq

Modify the original 8572 implementation as a universal way
on the PPC including p4080.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/include/asm/wrhv.h |    2 +-
 arch/powerpc/kernel/paravirt.c  |    6 ++--
 arch/powerpc/kernel/vbi/wrhv.c  |   48 ++++++++++++++------------------------
 3 files changed, 22 insertions(+), 34 deletions(-)

diff --git a/arch/powerpc/include/asm/wrhv.h b/arch/powerpc/include/asm/wrhv.h
index 0e0a5c9..708ec14 100644
--- a/arch/powerpc/include/asm/wrhv.h
+++ b/arch/powerpc/include/asm/wrhv.h
@@ -26,7 +26,7 @@ extern void __init wrhv_calibrate_decr(void);
 extern void __init wrhv_time_init(void);
 extern int __init wrhv_earlycon_setup(void);
 #ifdef CONFIG_PCI
-extern int fsl8572_get_pci_intr_wrhv(struct pci_dev *dev);
+extern int ppc_get_pci_intr_wrhv(struct pci_dev *dev);
 #endif
 
 extern int __init smp_wrhv_probe(void);
diff --git a/arch/powerpc/kernel/paravirt.c b/arch/powerpc/kernel/paravirt.c
index 888418e..a908365 100644
--- a/arch/powerpc/kernel/paravirt.c
+++ b/arch/powerpc/kernel/paravirt.c
@@ -267,9 +267,9 @@ inline int paravirt_enabled(void)
 #ifdef CONFIG_PCI
 int paravirt_pci_read_irq_line(struct pci_dev *dev)
 {
-#ifdef CONFIG_WRHV_8572
-	return fsl8572_get_pci_intr_wrhv(dev);
-#endif /* CONFIG_WRHV_8572 */
+#if defined(CONFIG_WRHV)
+	return ppc_get_pci_intr_wrhv(dev);
+#endif /* CONFIG_WRHV */ 
 	return -1;
 }
 #endif
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index d2b069d..dcc8df7 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -1186,44 +1186,32 @@ void wrhv_init(void)
 
 }
 
-#if defined(CONFIG_WRHV_8572) && defined(CONFIG_PCI)
-int fsl8572_get_pci_intr_wrhv(struct pci_dev *dev)
+#if defined(CONFIG_PCI)
+#define VECTOR_NAME_SIZE	8
+int ppc_get_pci_intr_wrhv(struct pci_dev *dev)
 {
-	int irq;
-	u8  pin;
-	char VectorName[8];
+	int irq = -1;
+	u8  pin = 0;
+	char vector_name[VECTOR_NAME_SIZE];
+	static char line[4] = {'A', 'B', 'C', 'D'};
 
 	pci_read_config_byte(dev, PCI_INTERRUPT_PIN, &pin);
 
-	switch (dev->bus->number) {
-	case 0x01:
-		switch (pin) {
-		case 0x01:
-			sprintf(VectorName, "%s", "PCIe2_A");
-			break;
-		case 0x02:
-			sprintf(VectorName, "%s", "PCIe2_B");
-			break;
-		case 0x03:
-			sprintf(VectorName, "%s", "PCIe2_C");
-			break;
-		case 0x04:
-			sprintf(VectorName, "%s", "PCIe2_D");
-			break;
+	if (pin) {
+		snprintf(vector_name, VECTOR_NAME_SIZE, "PCIe%d_%c", 
+			(dev->bus->number+1), line[pin-1]);
+		irq = vbi_find_irq(vector_name, 1);
+		if (irq >= 0) {
+			dev->irq = irq;
+			printk("WRHV-PCI: BUS NO:%x CLASS:%x IRQ%d for %s\n", 
+				dev->bus->number, dev->class, dev->irq, vector_name);
+			return 0;
 		}
-		irq = vbi_find_irq(VectorName, 1);
-		break;
-	default:
-		break;
 	}
 
-	dev->irq = irq;
-	printk("WRHV-PCI: BUS NO:%x CLASS:%x IRQ%d\n",
-		dev->bus->number, dev->class, dev->irq);
-
-	return irq;
+	return -1;
 }
-#endif /* CONFIG_WRHV_8572 & CONFIG_PCI*/
+#endif /* CONFIG_PCI */
 
 #ifdef  CONFIG_SMP
 static irqreturn_t wrhv_ipi_action(int irq, void *data)
-- 
1.6.5.2

