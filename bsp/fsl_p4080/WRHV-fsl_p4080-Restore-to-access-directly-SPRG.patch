From fac0286ded6f3730cad9113a29de65fba7b2c7c1 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Wed, 12 May 2010 16:39:48 +0800
Subject: [PATCH 04/15] WRHV/fsl_p4080: Restore to access directly SPRG

For E500mc the guest OS can directly access some SPRGs.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/include/asm/reg_wrhv.h |   17 +++++++++++++++++
 1 files changed, 17 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/reg_wrhv.h b/arch/powerpc/include/asm/reg_wrhv.h
index 4d88f9e..4be1508 100644
--- a/arch/powerpc/include/asm/reg_wrhv.h
+++ b/arch/powerpc/include/asm/reg_wrhv.h
@@ -44,6 +44,21 @@
 .extern	var(wrhv_user)
 .extern var(wrhv_pir)
 
+#if defined(CONFIG_PPC85xx_VT_MODE)
+
+#define WRHV_MFSPRG3(rd)			\
+	mfspr   rd, SPRN_SPRG3
+
+#define WRHV_MTSPRG3(rs, tmpr)			\
+	mtspr   SPRN_SPRG3, rs
+
+#ifdef CONFIG_SMP
+#define WRHV_MFPIR(rd)				\
+	mfspr   rd, SPRN_PIR
+#endif
+
+#else
+
 #define WRHV_MFSPRG3(rd)                        \
 	lis	rd,wrhv_sprg3@ha;               \
 	lwz	rd,wrhv_sprg3@l(rd)
@@ -58,6 +73,8 @@
 	lwz	rd,wrhv_pir@l(rd);
 #endif
 
+#endif
+
 #define WRHV_INT_LOCK(tmpr1,tmpr2)                      \
 	li	tmpr2,-1;                               \
 	lis	tmpr1,wr_control@ha;                   \
-- 
1.6.5.2

