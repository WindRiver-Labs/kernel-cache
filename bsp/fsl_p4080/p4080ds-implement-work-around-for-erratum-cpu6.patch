From 13edbc0a453152ecdcb082dece2ab96736e9ceed Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Fri, 26 Feb 2010 14:09:20 +0800
Subject: [PATCH] p4080ds: implement work around for erratum cpu6

Erratum cpu6 says that ME, CE, DE and EE can't be enabled when
executing a tlbsync. So we have to disable ME, CE and DE besides
EE in _tlbia and _tlbie functions.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/misc_32.S       |   22 ++++++++++++++++++++++
 arch/powerpc/platforms/85xx/Kconfig |    4 ++++
 2 files changed, 26 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/misc_32.S b/arch/powerpc/kernel/misc_32.S
index 067535c..fe229da 100644
--- a/arch/powerpc/kernel/misc_32.S
+++ b/arch/powerpc/kernel/misc_32.S
@@ -309,7 +309,14 @@ _GLOBAL(_tlbia)
 #ifdef CONFIG_SMP
 	/* For mutual exclusion for invalidate */
 	mfmsr	r11
+#ifdef CONFIG_P4080_ERRATUM_CPU6
+	lis	r8,(MSR_ME | MSR_CE | MSR_DE | MSR_EE)@h
+	ori	r8, r8, (MSR_ME | MSR_CE | MSR_DE | MSR_EE)@l
+	andc	r5,r11,r8
+	mtmsr	r5
+#else
 	wrteei	0
+#endif
 	lis	r8, ivax_lock@h
 	ori	r8, r8, ivax_lock@l
 11:	lwarx	r5, 0, r8
@@ -331,7 +338,11 @@ _GLOBAL(_tlbia)
 #ifdef CONFIG_SMP
 	li	r0, 0
 	stw	r0, 0(r8)
+#ifdef CONFIG_P4080_ERRATUM_CPU6
+	mtmsr	r11
+#else
 	wrtee	r11
+#endif
 #endif /* CONFIG_SMP */
 #else /* !(CONFIG_40x || CONFIG_44x || CONFIG_FSL_BOOKE) */
 #if defined(CONFIG_SMP)
@@ -425,7 +436,14 @@ _GLOBAL(_tlbie)
 #ifdef CONFIG_SMP
 	/* For mutual exclusion for invalidate */
 	mfmsr	r11
+#ifdef CONFIG_P4080_ERRATUM_CPU6
+	lis	r8,(MSR_ME | MSR_CE | MSR_DE | MSR_EE)@h
+	ori	r8, r8, (MSR_ME | MSR_CE | MSR_DE | MSR_EE)@l
+	andc	r5, r11, r8
+	mtmsr	r5
+#else
 	wrteei	0
+#endif
 	lis	r8, ivax_lock@h
 	ori	r8, r8, ivax_lock@l
 11:	lwarx	r5, 0, r8
@@ -450,7 +468,11 @@ _GLOBAL(_tlbie)
 #if defined(CONFIG_SMP)
 	li	r0, 0
 	stw	r0, 0(r8)
+#ifdef CONFIG_P4080_ERRATUM_CPU6
+	mtmsr	r11
+#else
 	wrtee	r11
+#endif
 #endif /* CONFIG_SMP */
 #else /* !(CONFIG_40x || CONFIG_44x || CONFIG_FSL_BOOKE) */
 #if defined(CONFIG_SMP)
diff --git a/arch/powerpc/platforms/85xx/Kconfig b/arch/powerpc/platforms/85xx/Kconfig
index 62015f7..76d639b 100644
--- a/arch/powerpc/platforms/85xx/Kconfig
+++ b/arch/powerpc/platforms/85xx/Kconfig
@@ -67,6 +67,10 @@ config P4080_DS
 	help
 	  This option enables support for the P4080 DS board
 
+config P4080_ERRATUM_CPU6
+	bool "Work around P4080 rev 1 erratum cpu6"
+	default y if P4080_DS
+
 config KSI8560
         bool "Emerson KSI8560"
         select DEFAULT_UIMAGE
-- 
1.6.0.4

