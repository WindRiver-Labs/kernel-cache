From e80e05e5ce9589155f4247dacbd201d200c963ee Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Wed, 12 May 2010 16:39:51 +0800
Subject: [PATCH 13/15] WRHV/fsl_p4080: Add API to get irq on direct interrupt mode

Under direct interrupt mode we should get correct irq by readin GEPR.
So here we implement this corresponding API for P4080.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/include/asm/machdep.h          |    1 +
 arch/powerpc/include/asm/wrhv.h             |    1 +
 arch/powerpc/kernel/vbi/wrhv.c              |   10 ++++++++++
 arch/powerpc/platforms/85xx/wrhv_p4080_ds.c |    1 +
 4 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/machdep.h b/arch/powerpc/include/asm/machdep.h
index 97a16e1..e2e684b 100644
--- a/arch/powerpc/include/asm/machdep.h
+++ b/arch/powerpc/include/asm/machdep.h
@@ -278,6 +278,7 @@ struct machdep_calls {
 	int (*set_law_base)(int index, unsigned long long addr);
 	int (*set_law_attr)(int index, unsigned int attr);
 	int (*get_law_attr)(int index);
+	unsigned int (*get_direct_irq)(void);
 #endif
 };
 
diff --git a/arch/powerpc/include/asm/wrhv.h b/arch/powerpc/include/asm/wrhv.h
index 01ea5f7..83d8186 100644
--- a/arch/powerpc/include/asm/wrhv.h
+++ b/arch/powerpc/include/asm/wrhv.h
@@ -48,5 +48,6 @@ extern int ppc_get_pci_intr_wrhv(struct pci_dev *dev);
 extern int wrhv_enable_pci_law(void);
 #endif
 
+extern unsigned int wrhv_get_direct_irq(void);
 #endif /* CONFIG_WRHV */
 #endif /* __ASM_WRHV_H */
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index e0d7d78..61837dc 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -540,6 +540,16 @@ unsigned int wrhv_vioapic_get_irq(void)
 	return irq;
 }
 
+/* We get irw by reading EPR for handling direct interrupt. 
+ * Note the irq should be asked automatically by the hardware 
+ * once read EPR. 
+ */
+unsigned int wrhv_get_direct_irq(void)
+{
+	unsigned int irq = mfspr(SPRN_EPR);
+	return irq;
+}
+
 /* refer to native implementation in arch/powerpc/kernel/irq.c */
 extern inline void check_stack_overflow(void);
 extern inline void handle_one_irq(unsigned int irq);
diff --git a/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c b/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
index 017bc87..800259a 100644
--- a/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
+++ b/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
@@ -244,6 +244,7 @@ define_machine(p4080_ds) {
 	.enable_pci_law 	= wrhv_enable_pci_law,
 #endif
 	.get_irq		= wrhv_vioapic_get_irq,
+	.get_direct_irq		= wrhv_get_direct_irq,
 	.restart		= wrhv_restart,
 	.calibrate_decr		= wrhv_calibrate_decr,
 	.progress		= udbg_progress,
-- 
1.6.5.2

