From 7d5de6463104ead37bcd7ef6a8b59d4abe5c14f0 Mon Sep 17 00:00:00 2001
From: Tiejun Chen <tiejun.chen@windriver.com>
Date: Wed, 12 May 2010 16:39:51 +0800
Subject: [PATCH] WRHV/fsl_p4080: Add API to get irq on direct interrupt mode

Under direct interrupt mode we should get correct irq by readin GEPR.
So here we implement this corresponding API for P4080.

Signed-off-by: Tiejun Chen <tiejun.chen@windriver.com>
---
 arch/powerpc/include/asm/machdep.h          |    1 +
 arch/powerpc/include/asm/wrhv.h             |    2 ++
 arch/powerpc/kernel/vbi/wrhv.c              |   10 ++++++++++
 arch/powerpc/platforms/85xx/wrhv_p4080_ds.c |    1 +
 4 files changed, 14 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/include/asm/machdep.h b/arch/powerpc/include/asm/machdep.h
index dceb185..2f89699 100644
--- a/arch/powerpc/include/asm/machdep.h
+++ b/arch/powerpc/include/asm/machdep.h
@@ -284,6 +284,7 @@ struct machdep_calls {
 	int (*set_law_attr)(int index, unsigned int attr);
 	int (*get_law_attr)(int index);
 	uint32_t (*get_mdio_bus)(struct mii_bus *bus, int mii_id);
+	unsigned int (*get_direct_irq)(void);
 #endif
 };
 
diff --git a/arch/powerpc/include/asm/wrhv.h b/arch/powerpc/include/asm/wrhv.h
index 8208029..5434a7a 100644
--- a/arch/powerpc/include/asm/wrhv.h
+++ b/arch/powerpc/include/asm/wrhv.h
@@ -59,6 +59,8 @@ extern int ppc_get_pci_intr_wrhv(struct pci_dev *dev);
 extern int wrhv_enable_pci_law(void);
 #endif
 
+extern unsigned int wrhv_get_direct_irq(void);
+
 #endif /* __ASSEMBLY__ */
 #endif /* CONFIG_WRHV */
 #endif /* __ASM_WRHV_H */
diff --git a/arch/powerpc/kernel/vbi/wrhv.c b/arch/powerpc/kernel/vbi/wrhv.c
index e16ba74..58172de 100644
--- a/arch/powerpc/kernel/vbi/wrhv.c
+++ b/arch/powerpc/kernel/vbi/wrhv.c
@@ -620,6 +620,16 @@ unsigned int wrhv_vioapic_get_irq(void)
 	return irq;
 }
 
+/* We get irw by reading EPR for handling direct interrupt. 
+ * Note the irq should be asked automatically by the hardware 
+ * once read EPR. 
+ */
+unsigned int wrhv_get_direct_irq(void)
+{
+	unsigned int irq = mfspr(SPRN_EPR);
+	return irq;
+}
+
 /* refer to native implementation in arch/powerpc/kernel/irq.c */
 extern inline void check_stack_overflow(void);
 extern inline void handle_one_irq(unsigned int irq);
diff --git a/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c b/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
index 017bc87..800259a 100644
--- a/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
+++ b/arch/powerpc/platforms/85xx/wrhv_p4080_ds.c
@@ -244,6 +244,7 @@ define_machine(p4080_ds) {
 	.enable_pci_law 	= wrhv_enable_pci_law,
 #endif
 	.get_irq		= wrhv_vioapic_get_irq,
+	.get_direct_irq		= wrhv_get_direct_irq,
 	.restart		= wrhv_restart,
 	.calibrate_decr		= wrhv_calibrate_decr,
 	.progress		= udbg_progress,
-- 
1.6.0.3

