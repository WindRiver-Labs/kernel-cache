From e1f52c0ba023c57f04fe6e6606ea92a011554f81 Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Sat, 29 Sep 2012 10:52:05 +0800
Subject: [PATCH] SPEAr: Convert arm boot_lock to raw for preempt-rt

In git://git.kernel.org/pub/scm/linux/kernel/git/rt/linux-stable-rt.git
commit 615a38b7  preempt-rt: Convert arm boot_lock to raw

Converts arm boot_lock to raw to avoid deadlock while system booting.
Spear13xx also needs this patch to avoid system hang while booting.

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 arch/arm/mach-spear13xx/platsmp.c |   10 +++++-----
 1 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/arch/arm/mach-spear13xx/platsmp.c b/arch/arm/mach-spear13xx/platsmp.c
index 28504d8..6951a89 100644
--- a/arch/arm/mach-spear13xx/platsmp.c
+++ b/arch/arm/mach-spear13xx/platsmp.c
@@ -28,7 +28,7 @@
  * boot "holding pen"
  */
 volatile int __cpuinitdata pen_release = -1;
-static DEFINE_SPINLOCK(boot_lock);
+static DEFINE_RAW_SPINLOCK(boot_lock);
 
 static void __iomem *scu_base = IOMEM(IO_ADDRESS(SPEAR13XX_SCU_BASE));
 extern void spear13xx_secondary_startup(void);
@@ -52,8 +52,8 @@ void __cpuinit platform_secondary_init(unsigned int cpu)
 	/*
 	 * Synchronise with the boot thread.
 	 */
-	spin_lock(&boot_lock);
-	spin_unlock(&boot_lock);
+	raw_spin_lock(&boot_lock);
+	raw_spin_unlock(&boot_lock);
 }
 
 int __cpuinit boot_secondary(unsigned int cpu, struct task_struct *idle)
@@ -64,7 +64,7 @@ int __cpuinit boot_secondary(unsigned int cpu, struct task_struct *idle)
 	 * set synchronisation state between this boot processor
 	 * and the secondary one
 	 */
-	spin_lock(&boot_lock);
+	raw_spin_lock(&boot_lock);
 
 	/*
 	 * The secondary processor is waiting to be released from
@@ -91,7 +91,7 @@ int __cpuinit boot_secondary(unsigned int cpu, struct task_struct *idle)
 	 * now the secondary core is starting up let it run its
 	 * calibrations, then wait for it to finish
 	 */
-	spin_unlock(&boot_lock);
+	raw_spin_unlock(&boot_lock);
 
 	return pen_release != -1 ? -ENOSYS : 0;
 }
-- 
1.7.0.4

