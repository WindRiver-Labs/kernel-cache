From 6055d6b25e47570138ae8e0a4385b959b453069b Mon Sep 17 00:00:00 2001
From: Liming Wang <liming.wang@windriver.com>
Date: Fri, 9 Nov 2012 16:09:42 +0800
Subject: [PATCH] serial: PL011: Correct spin_lock and irqsave usage in
 pl011_console_write

When booting, the kernel will produce calltrace under RT kernel.

BUG: sleeping function called from invalid context at kernel/rtmutex.c:646
in_atomic(): 0, irqs_disabled(): 128, pid: 110, name: udevd
[<80017d5c>] (unwind_backtrace+0x0/0x104) from [<8063d460>] (dump_stack+0x20/0x24)
[<8063d460>] (dump_stack+0x20/0x24) from [<8006167c>] (__might_sleep+0xf4/0x108)
[<8006167c>] (__might_sleep+0xf4/0x108) from [<80646514>] (rt_spin_lock+0x2c/0x38)
[<80646514>] (rt_spin_lock+0x2c/0x38) from [<803ba40c>] (pl011_console_write+0x130/0x150)
[<803ba40c>] (pl011_console_write+0x130/0x150) from [<8002ed2c>] (__call_console_drivers+0xe0/0xf4)
[<8002ed2c>] (__call_console_drivers+0xe0/0xf4) from [<8002eefc>] (_call_console_drivers+0xb0/0x174)
[<8002eefc>] (_call_console_drivers+0xb0/0x174) from [<8002f990>] (console_unlock+0x130/0x284)
[<8002f990>] (console_unlock+0x130/0x284) from [<80030100>] (vprintk+0x4ac/0x720)
[<80030100>] (vprintk+0x4ac/0x720) from [<8063d864>] (printk+0xf0/0xf8)
[<8063d864>] (printk+0xf0/0xf8) from [<803bd950>] (kmsg_writev+0x220/0x22c)
[<803bd950>] (kmsg_writev+0x220/0x22c) from [<80132258>] (do_sync_write+0xb8/0xf8)
[<80132258>] (do_sync_write+0xb8/0xf8) from [<80132de4>] (vfs_write+0x140/0x148)
[<80132de4>] (vfs_write+0x140/0x148) from [<801330a4>] (sys_write+0x50/0x124)
[<801330a4>] (sys_write+0x50/0x124) from [<8000e760>] (ret_fast_syscall+0x0/0x30)

In RT kernel, spin_lock can't be used in the irq disabled. Replace local_irq_*
functions with _nort versions to not disable interrupt.

Signed-off-by: Liming Wang <liming.wang@windriver.com>
---
 drivers/tty/serial/amba-pl011.c |    4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/tty/serial/amba-pl011.c b/drivers/tty/serial/amba-pl011.c
index da614ca..3139b7d 100644
--- a/drivers/tty/serial/amba-pl011.c
+++ b/drivers/tty/serial/amba-pl011.c
@@ -1791,7 +1791,7 @@ pl011_console_write(struct console *co, const char *s, unsigned int count)
 
 	clk_enable(uap->clk);
 
-	local_irq_save(flags);
+	local_irq_save_nort(flags);
 	if (uap->port.sysrq)
 		locked = 0;
 	else if (oops_in_progress)
@@ -1820,7 +1820,7 @@ pl011_console_write(struct console *co, const char *s, unsigned int count)
 
 	if (locked)
 		spin_unlock(&uap->port.lock);
-	local_irq_restore(flags);
+	local_irq_restore_nort(flags);
 
 	clk_disable(uap->clk);
 }
-- 
1.7.9.7

