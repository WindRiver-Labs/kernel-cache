From 4684d38d03e2c81467ac80344bfefa796c84ea15 Mon Sep 17 00:00:00 2001
From: Kevin Hao <kexin.hao@windriver.com>
Date: Thu, 8 Aug 2013 15:17:03 +0800
Subject: [PATCH 8/9] powerpc: add the support to boot from core other than 0
 for 6xx

For a kdump kernel, we may boot from a core other than 0. So set the
cpu id explicitly in the boot process.

Signed-off-by: Kevin Hao <kexin.hao@windriver.com>
---
 arch/powerpc/kernel/head_32.S |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/arch/powerpc/kernel/head_32.S b/arch/powerpc/kernel/head_32.S
index 43885c4..be58a8f 100644
--- a/arch/powerpc/kernel/head_32.S
+++ b/arch/powerpc/kernel/head_32.S
@@ -976,6 +976,12 @@ start_here:
 	bl	__save_cpu_setup
 	bl	MMU_init
 
+	/* Maybe the boot cpu id is not 0, set it explicitly */
+	lis	r3,boot_cpuid@ha
+	lwz	r3,boot_cpuid@l(r3)
+	CURRENT_THREAD_INFO(r4, r1)
+	stw	r3,TI_CPU(r4)
+
 /*
  * Go back to running unmapped so we can load up new values
  * for SDR1 (hash table pointer) and the segment registers
-- 
1.7.5.4

